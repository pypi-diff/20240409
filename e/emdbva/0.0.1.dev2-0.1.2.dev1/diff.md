# Comparing `tmp/emdbva-0.0.1.dev2.tar.gz` & `tmp/emdbva-0.1.2.dev1.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "emdbva-0.0.1.dev2.tar", last modified: Tue Apr  9 17:08:16 2024, max compression
+gzip compressed data, was "emdbva-0.1.2.dev1.tar", last modified: Tue Mar 19 14:10:35 2024, max compression
```

## Comparing `emdbva-0.0.1.dev2.tar` & `emdbva-0.1.2.dev1.tar`

### file list

```diff
@@ -1,40 +1,38 @@
-drwxr-xr-x   0 zhe        (502) staff       (20)        0 2024-04-09 17:08:16.765876 emdbva-0.0.1.dev2/
--rw-r--r--   0 zhe        (502) staff       (20)    11338 2024-03-19 13:47:41.000000 emdbva-0.0.1.dev2/LICENSE
--rw-r--r--   0 zhe        (502) staff       (20)      487 2024-04-09 16:46:35.000000 emdbva-0.0.1.dev2/MANIFEST.in
--rw-r--r--   0 zhe        (502) staff       (20)     1014 2024-04-09 17:08:16.765683 emdbva-0.0.1.dev2/PKG-INFO
--rw-r--r--   0 zhe        (502) staff       (20)       37 2024-03-19 13:47:41.000000 emdbva-0.0.1.dev2/README.rst
-drwxr-xr-x   0 zhe        (502) staff       (20)        0 2024-04-09 17:08:16.765378 emdbva-0.0.1.dev2/emdbva.egg-info/
--rw-r--r--   0 zhe        (502) staff       (20)     1014 2024-04-09 17:08:16.000000 emdbva-0.0.1.dev2/emdbva.egg-info/PKG-INFO
--rw-r--r--   0 zhe        (502) staff       (20)      719 2024-04-09 17:08:16.000000 emdbva-0.0.1.dev2/emdbva.egg-info/SOURCES.txt
--rw-r--r--   0 zhe        (502) staff       (20)        1 2024-04-09 17:08:16.000000 emdbva-0.0.1.dev2/emdbva.egg-info/dependency_links.txt
--rw-r--r--   0 zhe        (502) staff       (20)       38 2024-04-09 17:08:16.000000 emdbva-0.0.1.dev2/emdbva.egg-info/entry_points.txt
--rw-r--r--   0 zhe        (502) staff       (20)      110 2024-04-09 17:08:16.000000 emdbva-0.0.1.dev2/emdbva.egg-info/requires.txt
--rw-r--r--   0 zhe        (502) staff       (20)        3 2024-04-09 17:08:16.000000 emdbva-0.0.1.dev2/emdbva.egg-info/top_level.txt
--rw-r--r--   0 zhe        (502) staff       (20)       38 2024-04-09 17:08:16.765923 emdbva-0.0.1.dev2/setup.cfg
--rwxr-xr-x   0 zhe        (502) staff       (20)     1829 2024-04-09 11:01:12.000000 emdbva-0.0.1.dev2/setup.py
-drwxr-xr-x   0 zhe        (502) staff       (20)        0 2024-04-09 17:08:16.760390 emdbva-0.0.1.dev2/va/
--rw-r--r--   0 zhe        (502) staff       (20)      268 2024-03-19 13:46:29.000000 emdbva-0.0.1.dev2/va/__init__.py
--rwxr-xr-x   0 zhe        (502) staff       (20)    10188 2024-04-08 10:27:47.000000 emdbva-0.0.1.dev2/va/mainva.py
-drwxr-xr-x   0 zhe        (502) staff       (20)        0 2024-04-09 17:08:16.764310 emdbva-0.0.1.dev2/va/metrics/
--rw-r--r--   0 zhe        (502) staff       (20)        0 2024-03-19 13:46:29.000000 emdbva-0.0.1.dev2/va/metrics/__init__.py
--rw-r--r--   0 zhe        (502) staff       (20)    11710 2024-03-25 20:19:06.000000 emdbva-0.0.1.dev2/va/metrics/bars.py
--rw-r--r--   0 zhe        (502) staff       (20)     5295 2024-04-08 11:00:13.000000 emdbva-0.0.1.dev2/va/metrics/contour_level_predicator.py
--rw-r--r--   0 zhe        (502) staff       (20)      417 2024-03-19 13:46:29.000000 emdbva-0.0.1.dev2/va/metrics/emda_mmcc.py
--rw-r--r--   0 zhe        (502) staff       (20)     1297 2024-03-19 13:46:29.000000 emdbva-0.0.1.dev2/va/metrics/emringer.py
--rw-r--r--   0 zhe        (502) staff       (20)    15167 2024-03-26 12:41:05.000000 emdbva-0.0.1.dev2/va/metrics/phaserandomization.py
--rw-r--r--   0 zhe        (502) staff       (20)     4406 2024-03-19 13:46:29.000000 emdbva-0.0.1.dev2/va/metrics/phenix_cc.py
--rw-r--r--   0 zhe        (502) staff       (20)     5916 2024-03-19 13:47:41.000000 emdbva-0.0.1.dev2/va/metrics/phenix_mm.py
--rw-r--r--   0 zhe        (502) staff       (20)    17004 2024-04-08 10:27:47.000000 emdbva-0.0.1.dev2/va/metrics/projections.py
--rw-r--r--   0 zhe        (502) staff       (20)        0 2024-03-19 13:46:29.000000 emdbva-0.0.1.dev2/va/metrics/qscore.py
--rw-r--r--   0 zhe        (502) staff       (20)    17951 2024-03-19 13:47:41.000000 emdbva-0.0.1.dev2/va/metrics/resmap.py
--rw-r--r--   0 zhe        (502) staff       (20)     3670 2024-03-25 21:13:59.000000 emdbva-0.0.1.dev2/va/metrics/smoc.py
--rw-r--r--   0 zhe        (502) staff       (20)     4674 2024-03-19 13:46:29.000000 emdbva-0.0.1.dev2/va/metrics/strudel.py
--rw-r--r--   0 zhe        (502) staff       (20)     1559 2024-03-19 13:46:29.000000 emdbva-0.0.1.dev2/va/metrics/threedfsc.py
--rw-r--r--   0 zhe        (502) staff       (20)    68512 2024-04-08 09:42:27.000000 emdbva-0.0.1.dev2/va/preparation.py
--rw-r--r--   0 zhe        (502) staff       (20)   902326 2024-03-19 13:47:41.000000 emdbva-0.0.1.dev2/va/qscores.csv
-drwxr-xr-x   0 zhe        (502) staff       (20)        0 2024-04-09 17:08:16.764865 emdbva-0.0.1.dev2/va/utils/
--rw-r--r--   0 zhe        (502) staff       (20)        0 2024-03-19 13:47:41.000000 emdbva-0.0.1.dev2/va/utils/__init__.py
--rw-r--r--   0 zhe        (502) staff       (20)     6753 2024-04-03 13:16:00.000000 emdbva-0.0.1.dev2/va/utils/misc.py
--rw-r--r--   0 zhe        (502) staff       (20)     5996 2024-03-19 13:47:41.000000 emdbva-0.0.1.dev2/va/utils/stars.py
--rw-r--r--   0 zhe        (502) staff       (20)   340055 2024-04-08 10:24:07.000000 emdbva-0.0.1.dev2/va/validationanalysis.py
--rw-r--r--   0 zhe        (502) staff       (20)      904 2024-04-08 10:54:35.000000 emdbva-0.0.1.dev2/va/version.py
+drwxr-xr-x   0 zhe        (502) staff       (20)        0 2024-03-19 14:10:35.251530 emdbva-0.1.2.dev1/
+-rw-r--r--   0 zhe        (502) staff       (20)    11338 2024-03-19 13:47:41.000000 emdbva-0.1.2.dev1/LICENSE
+-rw-r--r--   0 zhe        (502) staff       (20)      447 2024-03-19 13:47:41.000000 emdbva-0.1.2.dev1/MANIFEST.in
+-rw-r--r--   0 zhe        (502) staff       (20)      993 2024-03-19 14:10:35.251326 emdbva-0.1.2.dev1/PKG-INFO
+-rw-r--r--   0 zhe        (502) staff       (20)       37 2024-03-19 13:47:41.000000 emdbva-0.1.2.dev1/README.rst
+drwxr-xr-x   0 zhe        (502) staff       (20)        0 2024-03-19 14:10:35.251029 emdbva-0.1.2.dev1/emdbva.egg-info/
+-rw-r--r--   0 zhe        (502) staff       (20)      993 2024-03-19 14:10:35.000000 emdbva-0.1.2.dev1/emdbva.egg-info/PKG-INFO
+-rw-r--r--   0 zhe        (502) staff       (20)      654 2024-03-19 14:10:35.000000 emdbva-0.1.2.dev1/emdbva.egg-info/SOURCES.txt
+-rw-r--r--   0 zhe        (502) staff       (20)        1 2024-03-19 14:10:35.000000 emdbva-0.1.2.dev1/emdbva.egg-info/dependency_links.txt
+-rw-r--r--   0 zhe        (502) staff       (20)       38 2024-03-19 14:10:35.000000 emdbva-0.1.2.dev1/emdbva.egg-info/entry_points.txt
+-rw-r--r--   0 zhe        (502) staff       (20)      104 2024-03-19 14:10:35.000000 emdbva-0.1.2.dev1/emdbva.egg-info/requires.txt
+-rw-r--r--   0 zhe        (502) staff       (20)        3 2024-03-19 14:10:35.000000 emdbva-0.1.2.dev1/emdbva.egg-info/top_level.txt
+-rw-r--r--   0 zhe        (502) staff       (20)       38 2024-03-19 14:10:35.251576 emdbva-0.1.2.dev1/setup.cfg
+-rwxr-xr-x   0 zhe        (502) staff       (20)     1818 2024-03-19 14:10:32.000000 emdbva-0.1.2.dev1/setup.py
+drwxr-xr-x   0 zhe        (502) staff       (20)        0 2024-03-19 14:10:35.244214 emdbva-0.1.2.dev1/va/
+-rw-r--r--   0 zhe        (502) staff       (20)      268 2024-03-19 13:46:29.000000 emdbva-0.1.2.dev1/va/__init__.py
+-rwxr-xr-x   0 zhe        (502) staff       (20)    10026 2024-03-19 13:47:41.000000 emdbva-0.1.2.dev1/va/mainva.py
+drwxr-xr-x   0 zhe        (502) staff       (20)        0 2024-03-19 14:10:35.248209 emdbva-0.1.2.dev1/va/metrics/
+-rw-r--r--   0 zhe        (502) staff       (20)        0 2024-03-19 13:46:29.000000 emdbva-0.1.2.dev1/va/metrics/__init__.py
+-rw-r--r--   0 zhe        (502) staff       (20)    11730 2024-03-19 13:47:41.000000 emdbva-0.1.2.dev1/va/metrics/bars.py
+-rw-r--r--   0 zhe        (502) staff       (20)      417 2024-03-19 13:46:29.000000 emdbva-0.1.2.dev1/va/metrics/emda_mmcc.py
+-rw-r--r--   0 zhe        (502) staff       (20)     1297 2024-03-19 13:46:29.000000 emdbva-0.1.2.dev1/va/metrics/emringer.py
+-rw-r--r--   0 zhe        (502) staff       (20)    15167 2024-03-19 13:47:41.000000 emdbva-0.1.2.dev1/va/metrics/phaserandomization.py
+-rw-r--r--   0 zhe        (502) staff       (20)     4406 2024-03-19 13:46:29.000000 emdbva-0.1.2.dev1/va/metrics/phenix_cc.py
+-rw-r--r--   0 zhe        (502) staff       (20)     5916 2024-03-19 13:47:41.000000 emdbva-0.1.2.dev1/va/metrics/phenix_mm.py
+-rw-r--r--   0 zhe        (502) staff       (20)        0 2024-03-19 13:46:29.000000 emdbva-0.1.2.dev1/va/metrics/qscore.py
+-rw-r--r--   0 zhe        (502) staff       (20)    17951 2024-03-19 13:47:41.000000 emdbva-0.1.2.dev1/va/metrics/resmap.py
+-rw-r--r--   0 zhe        (502) staff       (20)     3176 2024-03-19 13:46:29.000000 emdbva-0.1.2.dev1/va/metrics/smoc.py
+-rw-r--r--   0 zhe        (502) staff       (20)     4674 2024-03-19 13:46:29.000000 emdbva-0.1.2.dev1/va/metrics/strudel.py
+-rw-r--r--   0 zhe        (502) staff       (20)     1559 2024-03-19 13:46:29.000000 emdbva-0.1.2.dev1/va/metrics/threedfsc.py
+-rw-r--r--   0 zhe        (502) staff       (20)    72467 2024-03-19 13:47:41.000000 emdbva-0.1.2.dev1/va/preparation.py
+-rw-r--r--   0 zhe        (502) staff       (20)   902326 2024-03-19 13:47:41.000000 emdbva-0.1.2.dev1/va/qscores.csv
+drwxr-xr-x   0 zhe        (502) staff       (20)        0 2024-03-19 14:10:35.250304 emdbva-0.1.2.dev1/va/utils/
+-rw-r--r--   0 zhe        (502) staff       (20)        0 2024-03-19 13:47:41.000000 emdbva-0.1.2.dev1/va/utils/__init__.py
+-rw-r--r--   0 zhe        (502) staff       (20)     5497 2024-03-19 13:47:41.000000 emdbva-0.1.2.dev1/va/utils/misc.py
+-rw-r--r--   0 zhe        (502) staff       (20)     5996 2024-03-19 13:47:41.000000 emdbva-0.1.2.dev1/va/utils/stars.py
+-rw-r--r--   0 zhe        (502) staff       (20)   344500 2024-03-19 13:47:41.000000 emdbva-0.1.2.dev1/va/validationanalysis.py
+-rw-r--r--   0 zhe        (502) staff       (20)      904 2024-03-19 13:47:41.000000 emdbva-0.1.2.dev1/va/version.py
```

### Comparing `emdbva-0.0.1.dev2/LICENSE` & `emdbva-0.1.2.dev1/LICENSE`

 * *Files identical despite different names*

### Comparing `emdbva-0.0.1.dev2/PKG-INFO` & `emdbva-0.1.2.dev1/PKG-INFO`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: emdbva
-Version: 0.0.1.dev2
+Version: 0.1.2.dev1
 Summary: CryoEM validation toolkit
 Home-page: https://test.pypi.org/project/va/
 Author: Zhe Wang
 Author-email: zhe@ebi.ac.uk
 License: Apache License
 Keywords: EMDB,Cryoem,Validation
 Classifier: Development Status :: 2 - Pre-Alpha
@@ -22,12 +22,11 @@
 Requires-Dist: scikit-learn
 Requires-Dist: Pillow
 Requires-Dist: memory-profiler
 Requires-Dist: matplotlib
 Requires-Dist: pandas
 Requires-Dist: biopython
 Requires-Dist: mrcfile
-Requires-Dist: torch
 Requires-Dist: opencv-python
 
 CryoEM validation analysis pipeline
```

### Comparing `emdbva-0.0.1.dev2/emdbva.egg-info/PKG-INFO` & `emdbva-0.1.2.dev1/emdbva.egg-info/PKG-INFO`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: emdbva
-Version: 0.0.1.dev2
+Version: 0.1.2.dev1
 Summary: CryoEM validation toolkit
 Home-page: https://test.pypi.org/project/va/
 Author: Zhe Wang
 Author-email: zhe@ebi.ac.uk
 License: Apache License
 Keywords: EMDB,Cryoem,Validation
 Classifier: Development Status :: 2 - Pre-Alpha
@@ -22,12 +22,11 @@
 Requires-Dist: scikit-learn
 Requires-Dist: Pillow
 Requires-Dist: memory-profiler
 Requires-Dist: matplotlib
 Requires-Dist: pandas
 Requires-Dist: biopython
 Requires-Dist: mrcfile
-Requires-Dist: torch
 Requires-Dist: opencv-python
 
 CryoEM validation analysis pipeline
```

### Comparing `emdbva-0.0.1.dev2/emdbva.egg-info/SOURCES.txt` & `emdbva-0.1.2.dev1/emdbva.egg-info/SOURCES.txt`

 * *Files 6% similar despite different names*

```diff
@@ -12,21 +12,19 @@
 va/mainva.py
 va/preparation.py
 va/qscores.csv
 va/validationanalysis.py
 va/version.py
 va/metrics/__init__.py
 va/metrics/bars.py
-va/metrics/contour_level_predicator.py
 va/metrics/emda_mmcc.py
 va/metrics/emringer.py
 va/metrics/phaserandomization.py
 va/metrics/phenix_cc.py
 va/metrics/phenix_mm.py
-va/metrics/projections.py
 va/metrics/qscore.py
 va/metrics/resmap.py
 va/metrics/smoc.py
 va/metrics/strudel.py
 va/metrics/threedfsc.py
 va/utils/__init__.py
 va/utils/misc.py
```

### Comparing `emdbva-0.0.1.dev2/setup.py` & `emdbva-0.1.2.dev1/setup.py`

 * *Files 10% similar despite different names*

```diff
@@ -1,27 +1,26 @@
 # -*- coding: utf-8 -*-
 # setup.py
 from setuptools import find_packages, setup
 import sys
-from va import __version__
 
 
 
 
 with open('README.rst') as f:
     long_description = f.read()
 
 if sys.version_info[0] == 2:
     cv = "opencv-python==4.2.0.32"
 else:
     cv = "opencv-python"
 
 setup(
     name="emdbva",
-    version=__version__,
+    version='0.1.2.dev01',
     packages=find_packages(),
     exclude_package_data={
         'va': ['test/*', 'va/onedepva.py', 'core/*', 'proc/*', 'validation/*', 'test_data/*'],
     },
     include_package_data=True,
     author="Zhe Wang",
     author_email="zhe@ebi.ac.uk",
@@ -44,15 +43,15 @@
         "scikit-learn",
         "Pillow",
         "memory-profiler",
         "matplotlib",
         "pandas",
         "biopython",
         "mrcfile",
-        "torch",
+        # "emda>=1.1.3.post3",
         cv,
     ],
     classifiers=[
         # maturity
         'Development Status :: 2 - Pre-Alpha',
         # environment
         'Environment :: Console',
```

### Comparing `emdbva-0.0.1.dev2/va/mainva.py` & `emdbva-0.1.2.dev1/va/mainva.py`

 * *Files 4% similar despite different names*

```diff
@@ -49,33 +49,26 @@
 
     :param validationobj: validation object from ValidationAnalysis module
     :param runs: list of string which represent each of the function
     :return: None
     """
 
     # Projections
-    # if 'projection':
-    #     validationobj.new_projection()
-
     if 'projection' in runs:
         validationobj.orthogonal_projections()
         validationobj.rawmap_projections()
         validationobj.orthogonal_max()
         validationobj.rawmap_max()
         validationobj.orthogonal_min()
         validationobj.rawmap_min()
         validationobj.orthogonal_median()
         validationobj.rawmap_median()
         validationobj.orthogonal_std()
         validationobj.rawmap_std()
 
-    # Predicated contour
-    if 'predictcontour' in runs:
-        validationobj.cl_prediction()
-
     # Central slice
     if 'central' in runs:
         validationobj.central_slice()
         validationobj.rawmap_central_slice()
 
     # Largest variance
     if 'largestvariance' in runs:
```

### Comparing `emdbva-0.0.1.dev2/va/metrics/bars.py` & `emdbva-0.1.2.dev1/va/metrics/bars.py`

 * *Files 1% similar despite different names*

```diff
@@ -7,16 +7,15 @@
 def load_score(input_file, new_entry, score_type):
     """
     Load score into dataframe
     """
 
     type_dict = {'id': str, 'resolution': float, 'name': str, score_type: float}
     df_nonew = pd.read_csv(input_file, dtype=type_dict)
-    new_entry_df = pd.DataFrame([new_entry])
-    df = pd.concat([df_nonew, new_entry_df], ignore_index=True)
+    df = df_nonew.append(new_entry, ignore_index=True)
     df_without_nan = df[~df.isnull().any(axis=1)].sort_values(by=score_type).reset_index()
     subsets = ['id', 'resolution', 'name', score_type]
     df_without_nan = df_without_nan.drop_duplicates(subsets)
 
     return df_without_nan
 
 
@@ -68,14 +67,15 @@
                 cdf['name'] == new_entry['name']) & (cdf[score_type] == new_entry[score_type])
     nearest_index = cdf[mask].index[0]
 
     # Get the 1000 rows centered around the nearest index
     start = max(nearest_index - n, 0)
     end = min(nearest_index + n, len(df))
     df_nearest = cdf.iloc[start:end + 1]
+    print(df_nearest.shape)
 
     return df_nearest
 
 
 def get_resolution_range(new_entry, df, score_type, resbin=1.):
     """
     Sort the df based on the resolution and then find the nearest +1-1 resoltuion df
@@ -90,14 +90,16 @@
                 cdf['name'] == new_entry['name']) & (cdf[score_type] == new_entry[score_type])
     nearest_index = cdf[mask].index
 
     # Get the 1000 rows centered around the nearest index
     start = float(new_entry['resolution']) - resbin if float(new_entry['resolution']) >= resbin else 0.
     end = float(new_entry['resolution']) + resbin
     df_resbin = cdf[(cdf['resolution'] >= start) & (cdf['resolution'] <= end)]
+    print('shape')
+    print(df_resbin.shape)
 
     return df_resbin
 
 
 def plot_bar_mat(a, b, qmin, qmax, qscore, work_dir, plot_name, score_type):
     """
     This function here using matplotlib to produce the Q-score bar image
```

### Comparing `emdbva-0.0.1.dev2/va/metrics/emringer.py` & `emdbva-0.1.2.dev1/va/metrics/emringer.py`

 * *Files identical despite different names*

### Comparing `emdbva-0.0.1.dev2/va/metrics/phaserandomization.py` & `emdbva-0.1.2.dev1/va/metrics/phaserandomization.py`

 * *Files identical despite different names*

### Comparing `emdbva-0.0.1.dev2/va/metrics/phenix_cc.py` & `emdbva-0.1.2.dev1/va/metrics/phenix_cc.py`

 * *Files identical despite different names*

### Comparing `emdbva-0.0.1.dev2/va/metrics/phenix_mm.py` & `emdbva-0.1.2.dev1/va/metrics/phenix_mm.py`

 * *Files identical despite different names*

### Comparing `emdbva-0.0.1.dev2/va/metrics/resmap.py` & `emdbva-0.1.2.dev1/va/metrics/resmap.py`

 * *Files identical despite different names*

### Comparing `emdbva-0.0.1.dev2/va/metrics/strudel.py` & `emdbva-0.1.2.dev1/va/metrics/strudel.py`

 * *Files identical despite different names*

### Comparing `emdbva-0.0.1.dev2/va/metrics/threedfsc.py` & `emdbva-0.1.2.dev1/va/metrics/threedfsc.py`

 * *Files identical despite different names*

### Comparing `emdbva-0.0.1.dev2/va/preparation.py` & `emdbva-0.1.2.dev1/va/preparation.py`

 * *Files 11% similar despite different names*

```diff
@@ -323,29 +323,29 @@
                     'inclusion', 'fsc', 'qscore']
                     # 'smoc', 'resccc', 'locres']
         else:
             resdict = {'all': False, 'projection': False, 'central': False, 'surface': False, 'density': False,
                        'volume': False, 'fsc': False, 'raps': False, 'mapmodel': False, 'inclusion': False,
                        'largestvariance': False, 'mask': False, 'symmetry': False, 'rmmcc': False, 'smoc': False,
                        'resccc': False, 'emringer': False, 'strudel': False, '3dfsc': False, 'locres': False,
-                       'phrand': False, 'predictcontour': False}
+                       'phrand': False}
             for key in resdict.keys():
                 if key in runs:
                     resdict[key] = True
             # If -run has arguments but do not fit with any above, set to all to True
             if True not in resdict.values():
                 resdict['all'] = False
 
             runlist = []
 
             # not for OneDep for now: mmfsc, symmetry, qscore, some projectioins
             if self.mapname is not None:
                 runlist.extend(['projection', 'central', 'surface', 'volume', 'density', 'raps', 'largestvariance',
                                 'mask', 'fsc', 'mmfsc', 'rmmcc', 'symmetry', 'qscore', 'strudel', 'emringer', '3dfsc',
-                                'smoc', 'resccc', 'locres', 'phrand', 'predictcontour',
+                                'smoc', 'resccc', 'locres', 'phrand'
                                 ])
 
             if self.masks is None:
                 runlist.remove('mask')
 
             if self.model is not None and self.contourlevel is not None:
                 runlist.extend(['inclusion'])
@@ -701,14 +701,127 @@
         if self.args.cl:
             return float(self.args.cl)
         else:
             # Todo: Add a estimated contour level function here
             return None
 
 
+    def swap_axes(self, header):
+        """
+
+            Swap the axes to make the data arranged as z, y, z by indices
+
+        :param header:
+        :return:
+        """
+        pass
+
+
+    # def frommrc_totempy(self, fullmapname):
+    #     """
+    #         Transfer the mrcfile map object to TEMPy map object
+    #
+    #     :param fullmapname:
+    #     :return: TEMPy map object
+    #     """
+    #
+    #     mrcmap = mrcfile.mmap(fullmapname, mode='r+')
+    #     mrcheader = mrcmap.header
+    #     # mapdata = mrcmap.data.astype('float')
+    #     mapdata = mrcmap.data
+    #     crs = (mrcheader.mapc, mrcheader.mapr, mrcheader.maps)
+    #     print('----original start------')
+    #     print(mrcheader)
+    #     print(mapdata.shape)
+    #     print('------------------')
+    #     reversecrs = crs[::-1]
+    #     nstarts = (mrcheader.nxstart, mrcheader.nystart, mrcheader.nzstart)
+    #     stdcrs = (3, 2, 1)
+    #     diffcrs = tuple(x-y for x, y in zip(reversecrs, stdcrs))
+    #     if diffcrs != (0, 0, 0):
+    #         if 1 in diffcrs and -1 in diffcrs:
+    #             mapdata = np.swapaxes(mapdata, diffcrs.index(-1), diffcrs.index(1))
+    #         if -2 in diffcrs and 2 in diffcrs:
+    #             mapdata = np.swapaxes(mapdata, diffcrs.index(-2), diffcrs.index(2))
+    #         if 1 in diffcrs and -2 in diffcrs:
+    #             mapdata = np.swapaxes(np.swapaxes(mapdata, 0, 1), 1, 2)
+    #         if -1 in diffcrs and 2 in diffcrs:
+    #             mapdata = np.swapaxes(np.swapaxes(mapdata, 1, 2), 0, 1)
+    #         # mapdata = np.swapaxes(mapdata, 0, 2)
+    #
+    #     print(mapdata.shape)
+    #     # mrcmap.set_data(mapdata)
+    #     # mrcmap.update_header_from_data()
+    #     # mapdata = np.swapaxes(np.swapaxes(mapdata, 0, 2), 1, 2)
+    #     tempyheader = MapParser.readMRCHeader(fullmapname)
+    #
+    #     # nx, ny, nz and nxstart, nystart, nzstart haver to be changed accordingly to the data
+    #     tempyheader = list(tempyheader)
+    #     tempyheader[0] = mapdata.shape[2]
+    #     tempyheader[1] = mapdata.shape[1]
+    #     tempyheader[2] = mapdata.shape[0]
+    #     tempyheader[3] = mrcheader.mode.item(0)
+    #     tempyheader[4] = nstarts[0].item(0)
+    #     tempyheader[5] = nstarts[1].item(0)
+    #     tempyheader[6] = nstarts[2].item(0)
+    #     tempyheader[7] = mrcheader.mx.item(0)
+    #     tempyheader[8] = mrcheader.my.item(0)
+    #     tempyheader[9] = mrcheader.mz.item(0)
+    #     tempyheader[10] = mrcheader.cella.x.item(0)
+    #     tempyheader[11] = mrcheader.cella.y.item(0)
+    #     tempyheader[12] = mrcheader.cella.z.item(0)
+    #     tempyheader[13:16] = mrcheader.cellb.tolist()
+    #     tempyheader[16] = crs[0].item(0)
+    #     tempyheader[17] = crs[1].item(0)
+    #     tempyheader[18] = crs[2].item(0)
+    #     tempyheader[19] = mrcheader.dmin.item(0)
+    #     tempyheader[20] = mrcheader.dmax.item(0)
+    #     tempyheader[21] = mrcheader.dmean.item(0)
+    #     tempyheader[22] = mrcheader.ispg.item(0)
+    #     tempyheader[23] = mrcheader.nsymbt.item(0)
+    #
+    #     # tempyheader[24] = mrcheader.extra1.item(0)
+    #     # tempyheader[25] = mrcheader.exttyp.item(0)
+    #     # tempyheader[26] = mrcheader.nversion.item(0)
+    #     # tempyheader[27] = mrcheader.extra2.item(0)
+    #
+    #     tempyheader[49] = mrcheader.origin.x.item(0)
+    #     tempyheader[50] = mrcheader.origin.y.item(0)
+    #     tempyheader[51] = mrcheader.origin.z.item(0)
+    #     tempyheader[52:55] = ['M', 'A', 'P']
+    #
+    #     tempyheader[56] = mrcheader.machst
+    #     tempyheader[57] = mrcheader.rms.item(0)
+    #     # tempyheader[58] = mrcheader.nlabl.item(0)
+    #     # tempyheader[59] = mrcheader.label.item(0)
+    #
+    #
+    #
+    #     # tempyheader[13] = mrcheader.cellb.x.item(0)
+    #     # tempyheader[14] = mrcheader.cellb.y.item(0)
+    #     # tempyheader[15] = mrcheader.cellb.z.item(0)
+    #     # here also keep the nstarts position according to original crs order as in __getindices it automaticlly
+    #     # adjust the calculation based on the
+    #     # tempyheader[4] = int(nstarts[crs.index(1)])
+    #     # tempyheader[5] = int(nstarts[crs.index(2)])
+    #     # tempyheader[6] = int(nstarts[crs.index(3)])
+    #     tempyheader = tuple(tempyheader)
+    #     origin = (float(mrcheader.origin.x), float(mrcheader.origin.y), float(mrcheader.origin.z))
+    #     apix = (mrcheader.cella.x/mrcheader.mx, mrcheader.cella.y/mrcheader.my, mrcheader.cella.z/mrcheader.mz)[0]
+    #
+    #     finalmap = Map(mapdata, origin, apix, fullmapname, header=tempyheader)
+    #     print(finalmap.box_size())
+    #     print('---box---')
+    #
+    #     # inputmap.fullMap = np.swapaxes(np.swapaxes(mrcfile.mmap(fullmapname).data, 0, 2), 1, 2)
+    #     # print(inputmap.fullMap.shape)
+    #     # print(inputmap.fullMap[1, 3, 66])
+    #
+    #     return finalmap
+
     # @profile
     def write_map(self, outmap_name, mapdata, nstarts, org_header):
         """
             When map axes permuted, make it normal and save the map
 
         :return:
         """
@@ -861,41 +974,28 @@
             print('Map does not exist or corrupted.')
             sys.stderr.write('Error: {} \n'.format(sys.exc_info()[1]))
             print('------------------------------------')
             exit()
 
     def remove_lines_after_match(self, input_file, output_file, match_text):
         try:
-            with open(input_file, 'r') as infile:
-                found_second_match = False
-                match_count = 0
-                content_before_second_match = []
-
-                for line in infile:
-                    if line.startswith(match_text):
-                        match_count += 1
-                        if match_count >= 2:
-                            found_second_match = True
-                            break
-                    content_before_second_match.append(line)
-
-            if found_second_match:
-                with open(output_file, 'w') as outfile:
-                    outfile.writelines(content_before_second_match)
-                return True
-            else:
-                print('Second match not found in the file.')
-                return False
+            with open(input_file, 'r') as input_file:
+                with open(output_file, 'w') as output_file:
+                    found_match = False
+
+                    for line in input_file:
+                        if match_text in line:
+                            found_match = True
 
+                        if not found_match:
+                            output_file.write(line)
         except FileNotFoundError:
-            print(f'Error: Input file "{input_file}" not found.')
-            return False
+            print('Input file not found.')
         except Exception as e:
             print(f'An error occurred: {str(e)}')
-            return False
 
     def hasdisorder_atom(self, structure):
 
         ress = structure.get_residues()
         disorder_flag = False
         for res in ress:
             if res.is_disordered() == 1:
@@ -914,19 +1014,19 @@
 
         p = MMCIFParser()
         io = MMCIFIO()
         orgfilename = curmodelname
         # structure = p.get_structure(pid, curmodelname)
 
         # multiple data block
-        # cur_model = open(curmodelname)
-        match_text = 'data_'
-        out_moderate_cif = curmodelname + '_moderated.cif'
-        match = self.remove_lines_after_match(curmodelname, out_moderate_cif, match_text)
-        if match:
+        cur_model = open(curmodelname)
+        match_text = 'data_comp_'
+        if match_text in cur_model.read():
+            out_moderate_cif = curmodelname + '_moderated.cif'
+            self.remove_lines_after_match(curmodelname, out_moderate_cif, match_text)
             structure = p.get_structure(pid, out_moderate_cif)
             curmodelname = out_moderate_cif
         else:
             structure = p.get_structure(pid, curmodelname)
 
         if len(structure.get_list()) > 1:
             orgmodel = curmodelname + '_org.cif'
@@ -1440,22 +1540,15 @@
 
     def merge_json_objects(self, obj1, obj2):
         merged_obj = {}
         for key in set(obj1.keys()) | set(obj2.keys()):
             if key in obj1 and key in obj2 and isinstance(obj1[key], dict) and isinstance(obj2[key], dict):
                 merged_obj[key] = self.merge_json_objects(obj1[key], obj2[key])
             elif key in obj1 and key in obj2:
-                if isinstance(obj1[key], dict) and isinstance(obj2[key], dict):
-                    merged_obj[key] = {**obj1[key], **obj2[key]}
-                elif isinstance(obj1[key], dict) and not isinstance(obj2[key], dict):
-                    merged_obj[key] = obj1[key]
-                elif not isinstance(obj1[key], dict) and isinstance(obj2[key], dict):
-                    merged_obj[key] = obj2[key]
-                else:
-                    merged_obj[key] = obj1[key]
+                merged_obj[key] = {**obj1[key], **obj2[key]}
             elif key in obj1:
                 merged_obj[key] = obj1[key]
             elif key in obj2:
                 merged_obj[key] = obj2[key]
 
         return merged_obj
```

### Comparing `emdbva-0.0.1.dev2/va/qscores.csv` & `emdbva-0.1.2.dev1/va/qscores.csv`

 * *Files identical despite different names*

### Comparing `emdbva-0.0.1.dev2/va/utils/misc.py` & `emdbva-0.1.2.dev1/va/utils/misc.py`

 * *Files 20% similar despite different names*

```diff
@@ -180,44 +180,7 @@
     """
 
     numlist = [-1 if i < 0 else i for i in numlist]
     rgbs = [[122, int(num * 255), int(num * 255)] if num >= 0 else [255, 0, 255] for num in numlist]
     resultlist = ['#%02X%02X%02X' % (rgb[0], rgb[1], rgb[2]) for rgb in rgbs]
 
     return resultlist
-
-
-def check_same_keys(dict1, dict2):
-    """
-    check if two dictionaries have the same keys at all levels
-    dict1: A dictionary
-    dict2: A dictionary
-    return True if all keys are same, else False
-    """
-
-    # Base case: if one of the inputs is not a dictionary, return False
-    if not isinstance(dict1, dict) or not isinstance(dict2, dict):
-        return False
-
-    # Get the keys of both dictionaries
-    keys1 = set(dict1.keys())
-    keys2 = set(dict2.keys())
-
-    # Check if the keys are different
-    if keys1 != keys2:
-        return False
-
-    # Recursively compare keys in nested dictionaries
-    for key in keys1:
-        if isinstance(dict1[key], dict) and isinstance(dict2[key], dict):
-            # If both values are dictionaries, recursively compare their keys
-            if not check_same_keys(dict1[key], dict2[key]):
-                return False
-        else:
-            # If one of the values is not a dictionary, don't compare the values
-            if not isinstance(dict1[key], dict) and not isinstance(dict2[key], dict):
-                continue
-            else:
-                return False  # If one value is a dictionary and the other is not, return False
-
-    # If all comparisons pass, return True
-    return True
```

### Comparing `emdbva-0.0.1.dev2/va/utils/stars.py` & `emdbva-0.1.2.dev1/va/utils/stars.py`

 * *Files identical despite different names*

### Comparing `emdbva-0.0.1.dev2/va/validationanalysis.py` & `emdbva-0.1.2.dev1/va/validationanalysis.py`

 * *Files 2% similar despite different names*

```diff
@@ -131,21124 +131,21402 @@
 00000820: 732e 6261 7273 2069 6d70 6f72 7420 2a0a  s.bars import *.
 00000830: 6672 6f6d 2076 612e 6d65 7472 6963 732e  from va.metrics.
 00000840: 7068 6173 6572 616e 646f 6d69 7a61 7469  phaserandomizati
 00000850: 6f6e 2069 6d70 6f72 7420 2a0a 6672 6f6d  on import *.from
 00000860: 2076 612e 7574 696c 732e 7374 6172 7320   va.utils.stars 
 00000870: 696d 706f 7274 202a 0a66 726f 6d20 7661  import *.from va
 00000880: 2e75 7469 6c73 2e6d 6973 6320 696d 706f  .utils.misc impo
-00000890: 7274 202a 0a66 726f 6d20 7661 2e6d 6574  rt *.from va.met
-000008a0: 7269 6373 2e63 6f6e 746f 7572 5f6c 6576  rics.contour_lev
-000008b0: 656c 5f70 7265 6469 6361 746f 7220 696d  el_predicator im
-000008c0: 706f 7274 202a 0a66 726f 6d20 7661 2e6d  port *.from va.m
-000008d0: 6574 7269 6373 2e70 726f 6a65 6374 696f  etrics.projectio
-000008e0: 6e73 2069 6d70 6f72 7420 2a0a 696d 706f  ns import *.impo
-000008f0: 7274 2076 610a 0a74 7279 3a0a 2020 2020  rt va..try:.    
-00000900: 6672 6f6d 2050 4154 4853 2069 6d70 6f72  from PATHS impor
-00000910: 7420 4d41 505f 5345 5256 4552 5f50 4154  t MAP_SERVER_PAT
-00000920: 480a 2020 2020 6672 6f6d 2050 4154 4853  H.    from PATHS
-00000930: 2069 6d70 6f72 7420 5052 4f53 4841 4445   import PROSHADE
-00000940: 5041 5448 0a20 2020 2066 726f 6d20 5041  PATH.    from PA
-00000950: 5448 5320 696d 706f 7274 204d 4553 484d  THS import MESHM
-00000960: 414b 4552 5041 5448 0a20 2020 2066 726f  AKERPATH.    fro
-00000970: 6d20 5041 5448 5320 696d 706f 7274 2043  m PATHS import C
-00000980: 4849 4d45 5241 0a20 2020 2066 726f 6d20  HIMERA.    from 
-00000990: 5041 5448 5320 696d 706f 7274 204f 4348  PATHS import OCH
-000009a0: 494d 4552 410a 2020 2020 6672 6f6d 2050  IMERA.    from P
-000009b0: 4154 4853 2069 6d70 6f72 7420 4c49 425f  ATHS import LIB_
-000009c0: 5354 5255 4445 4c5f 524f 4f54 0a20 2020  STRUDEL_ROOT.   
-000009d0: 2066 726f 6d20 5041 5448 5320 696d 706f   from PATHS impo
-000009e0: 7274 2052 4553 4d41 500a 6578 6365 7074  rt RESMAP.except
-000009f0: 2049 6d70 6f72 7445 7272 6f72 3a0a 2020   ImportError:.  
-00000a00: 2020 4d41 505f 5345 5256 4552 5f50 4154    MAP_SERVER_PAT
-00000a10: 4820 3d20 4e6f 6e65 0a20 2020 2050 524f  H = None.    PRO
-00000a20: 5348 4144 4550 4154 4820 3d20 4e6f 6e65  SHADEPATH = None
-00000a30: 0a20 2020 2043 4849 4d45 5241 203d 204e  .    CHIMERA = N
-00000a40: 6f6e 650a 2020 2020 4d45 5348 4d41 4b45  one.    MESHMAKE
-00000a50: 5250 4154 4820 3d20 4e6f 6e65 0a20 2020  RPATH = None.   
-00000a60: 204f 4348 494d 4552 4120 3d20 4e6f 6e65   OCHIMERA = None
-00000a70: 0a20 2020 204c 4942 5f53 5452 5544 454c  .    LIB_STRUDEL
-00000a80: 5f52 4f4f 5420 3d20 4e6f 6e65 0a20 2020  _ROOT = None.   
-00000a90: 2052 4553 4d41 5020 3d20 4e6f 6e65 0a0a   RESMAP = None..
-00000aa0: 7472 793a 0a20 2020 2069 6d70 6f72 7420  try:.    import 
-00000ab0: 7674 6b0a 6578 6365 7074 2049 6d70 6f72  vtk.except Impor
-00000ac0: 7445 7272 6f72 3a0a 2020 2020 7072 696e  tError:.    prin
-00000ad0: 7428 2743 6869 6d65 7261 5820 7769 6c6c  t('ChimeraX will
-00000ae0: 2062 6520 7573 6564 2074 6f20 7072 6f64   be used to prod
-00000af0: 7563 6520 666f 7220 7468 6520 7375 7266  uce for the surf
-00000b00: 6163 6520 7669 6577 2e27 290a 0a0a 2323  ace view.')...##
-00000b10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00000b20: 2323 2323 2323 2323 2323 2323 0a0a 2320  ############..# 
-00000b30: 6465 6620 7073 7375 6d28 692c 2064 6973  def pssum(i, dis
-00000b40: 742c 2069 6e64 6961 7869 732c 2069 6e64  t, indiaxis, ind
-00000b50: 6961 7869 7374 2c20 7073 6d61 7029 3a0a  iaxist, psmap):.
-00000b60: 2320 2020 2020 6966 2069 2021 3d20 6c65  #     if i != le
-00000b70: 6e28 696e 6469 6178 6973 2920 2d20 313a  n(indiaxis) - 1:
-00000b80: 0a23 2020 2020 2020 2020 2069 6e64 6963  .#         indic
-00000b90: 6573 203d 206e 702e 6172 6777 6865 7265  es = np.argwhere
-00000ba0: 2828 6469 7374 203e 2069 6e64 6961 7869  ((dist > indiaxi
-00000bb0: 7374 5b69 5d29 2026 2028 6469 7374 203c  st[i]) & (dist <
-00000bc0: 3d20 696e 6469 6178 6973 745b 6920 2b20  = indiaxist[i + 
-00000bd0: 315d 2929 0a23 0a23 2020 2020 2020 2020  1])).#.#        
-00000be0: 2070 7375 6d20 3d20 6c6f 6731 3028 7073   psum = log10(ps
-00000bf0: 6d61 702e 6675 6c6c 4d61 705b 7475 706c  map.fullMap[tupl
-00000c00: 6528 696e 6469 6365 732e 5429 5d2e 7375  e(indices.T)].su
-00000c10: 6d28 2920 2f20 6c65 6e28 696e 6469 6365  m() / len(indice
-00000c20: 7329 290a 2320 2020 2020 2020 2020 7265  s)).#         re
-00000c30: 7475 726e 2070 7375 6d0a 0a0a 2320 7465  turn psum...# te
-00000c40: 7374 2033 0a0a 6465 6620 7073 7375 6d28  st 3..def pssum(
-00000c50: 612c 2069 6e64 6961 7869 732c 2069 6e64  a, indiaxis, ind
-00000c60: 6961 7869 7374 2c20 7368 6172 6564 5f61  iaxist, shared_a
-00000c70: 7272 6179 293a 0a20 2020 2072 6573 203d  rray):.    res =
-00000c80: 205b 5d0a 2020 2020 666f 7220 6920 696e   [].    for i in
-00000c90: 2061 3a0a 2020 2020 2020 2020 6966 2069   a:.        if i
-00000ca0: 2021 3d20 6c65 6e28 696e 6469 6178 6973   != len(indiaxis
-00000cb0: 2920 2d20 313a 0a20 2020 2020 2020 2020  ) - 1:.         
-00000cc0: 2020 2069 6e64 6963 6573 203d 206e 702e     indices = np.
-00000cd0: 6172 6777 6865 7265 2828 7368 6172 6564  argwhere((shared
-00000ce0: 5f61 7272 6179 203e 2069 6e64 6961 7869  _array > indiaxi
-00000cf0: 7374 5b69 5d29 2026 2028 7368 6172 6564  st[i]) & (shared
-00000d00: 5f61 7272 6179 203c 3d20 696e 6469 6178  _array <= indiax
-00000d10: 6973 745b 6920 2b20 315d 2929 0a20 2020  ist[i + 1])).   
-00000d20: 2020 2020 2020 2020 2069 6620 6920 3d3d           if i ==
-00000d30: 2030 206f 7220 6920 3d3d 2031 3a0a 2020   0 or i == 1:.  
-00000d40: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-00000d50: 696e 7428 6e70 2e6e 6461 7272 6179 2e74  int(np.ndarray.t
-00000d60: 6f6c 6973 7428 696e 6469 6365 7329 290a  olist(indices)).
-00000d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000d80: 7072 696e 7428 6c65 6e28 696e 6469 6365  print(len(indice
-00000d90: 735b 305d 2929 0a20 2020 2020 2020 2020  s[0])).         
-00000da0: 2020 2020 2020 2070 7269 6e74 2827 696e         print('in
-00000db0: 6469 6178 6973 745b 7b7d 5d3d 7b7d 2c20  diaxist[{}]={}, 
-00000dc0: 696e 6469 6178 6973 745b 7b7d 2b31 5d27  indiaxist[{}+1]'
-00000dd0: 2e66 6f72 6d61 7428 692c 2069 6e64 6961  .format(i, india
-00000de0: 7869 7374 5b69 5d2c 2069 6e64 6961 7869  xist[i], indiaxi
-00000df0: 7374 5b69 2b31 5d20 2929 0a20 2020 2020  st[i+1] )).     
-00000e00: 2020 2020 2020 2072 6573 2e61 7070 656e         res.appen
-00000e10: 6428 696e 6469 6365 7329 0a20 2020 2072  d(indices).    r
-00000e20: 6574 7572 6e20 7265 730a 0a0a 2320 6465  eturn res...# de
-00000e30: 6620 7063 616c 2861 2c20 696e 6469 6178  f pcal(a, indiax
+00000890: 7274 202a 0a69 6d70 6f72 7420 7661 0a0a  rt *.import va..
+000008a0: 7472 793a 0a20 2020 2066 726f 6d20 5041  try:.    from PA
+000008b0: 5448 5320 696d 706f 7274 204d 4150 5f53  THS import MAP_S
+000008c0: 4552 5645 525f 5041 5448 0a20 2020 2066  ERVER_PATH.    f
+000008d0: 726f 6d20 5041 5448 5320 696d 706f 7274  rom PATHS import
+000008e0: 2050 524f 5348 4144 4550 4154 480a 2020   PROSHADEPATH.  
+000008f0: 2020 6672 6f6d 2050 4154 4853 2069 6d70    from PATHS imp
+00000900: 6f72 7420 4d45 5348 4d41 4b45 5250 4154  ort MESHMAKERPAT
+00000910: 480a 2020 2020 6672 6f6d 2050 4154 4853  H.    from PATHS
+00000920: 2069 6d70 6f72 7420 4348 494d 4552 410a   import CHIMERA.
+00000930: 2020 2020 6672 6f6d 2050 4154 4853 2069      from PATHS i
+00000940: 6d70 6f72 7420 4f43 4849 4d45 5241 0a20  mport OCHIMERA. 
+00000950: 2020 2066 726f 6d20 5041 5448 5320 696d     from PATHS im
+00000960: 706f 7274 204c 4942 5f53 5452 5544 454c  port LIB_STRUDEL
+00000970: 5f52 4f4f 540a 2020 2020 6672 6f6d 2050  _ROOT.    from P
+00000980: 4154 4853 2069 6d70 6f72 7420 5245 534d  ATHS import RESM
+00000990: 4150 0a65 7863 6570 7420 496d 706f 7274  AP.except Import
+000009a0: 4572 726f 723a 0a20 2020 204d 4150 5f53  Error:.    MAP_S
+000009b0: 4552 5645 525f 5041 5448 203d 204e 6f6e  ERVER_PATH = Non
+000009c0: 650a 2020 2020 5052 4f53 4841 4445 5041  e.    PROSHADEPA
+000009d0: 5448 203d 204e 6f6e 650a 2020 2020 4348  TH = None.    CH
+000009e0: 494d 4552 4120 3d20 4e6f 6e65 0a20 2020  IMERA = None.   
+000009f0: 204d 4553 484d 414b 4552 5041 5448 203d   MESHMAKERPATH =
+00000a00: 204e 6f6e 650a 2020 2020 4f43 4849 4d45   None.    OCHIME
+00000a10: 5241 203d 204e 6f6e 650a 2020 2020 4c49  RA = None.    LI
+00000a20: 425f 5354 5255 4445 4c5f 524f 4f54 203d  B_STRUDEL_ROOT =
+00000a30: 204e 6f6e 650a 2020 2020 5245 534d 4150   None.    RESMAP
+00000a40: 203d 204e 6f6e 650a 0a74 7279 3a0a 2020   = None..try:.  
+00000a50: 2020 696d 706f 7274 2076 746b 0a65 7863    import vtk.exc
+00000a60: 6570 7420 496d 706f 7274 4572 726f 723a  ept ImportError:
+00000a70: 0a20 2020 2070 7269 6e74 2827 4368 696d  .    print('Chim
+00000a80: 6572 6158 2077 696c 6c20 6265 2075 7365  eraX will be use
+00000a90: 6420 746f 2070 726f 6475 6365 2066 6f72  d to produce for
+00000aa0: 2074 6865 2073 7572 6661 6365 2076 6965   the surface vie
+00000ab0: 772e 2729 0a0a 0a23 2323 2323 2323 2323  w.')...#########
+00000ac0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00000ad0: 2323 2323 230a 0a23 2064 6566 2070 7373  #####..# def pss
+00000ae0: 756d 2869 2c20 6469 7374 2c20 696e 6469  um(i, dist, indi
+00000af0: 6178 6973 2c20 696e 6469 6178 6973 742c  axis, indiaxist,
+00000b00: 2070 736d 6170 293a 0a23 2020 2020 2069   psmap):.#     i
+00000b10: 6620 6920 213d 206c 656e 2869 6e64 6961  f i != len(india
+00000b20: 7869 7329 202d 2031 3a0a 2320 2020 2020  xis) - 1:.#     
+00000b30: 2020 2020 696e 6469 6365 7320 3d20 6e70      indices = np
+00000b40: 2e61 7267 7768 6572 6528 2864 6973 7420  .argwhere((dist 
+00000b50: 3e20 696e 6469 6178 6973 745b 695d 2920  > indiaxist[i]) 
+00000b60: 2620 2864 6973 7420 3c3d 2069 6e64 6961  & (dist <= india
+00000b70: 7869 7374 5b69 202b 2031 5d29 290a 230a  xist[i + 1])).#.
+00000b80: 2320 2020 2020 2020 2020 7073 756d 203d  #         psum =
+00000b90: 206c 6f67 3130 2870 736d 6170 2e66 756c   log10(psmap.ful
+00000ba0: 6c4d 6170 5b74 7570 6c65 2869 6e64 6963  lMap[tuple(indic
+00000bb0: 6573 2e54 295d 2e73 756d 2829 202f 206c  es.T)].sum() / l
+00000bc0: 656e 2869 6e64 6963 6573 2929 0a23 2020  en(indices)).#  
+00000bd0: 2020 2020 2020 2072 6574 7572 6e20 7073         return ps
+00000be0: 756d 0a0a 0a23 2074 6573 7420 330a 0a64  um...# test 3..d
+00000bf0: 6566 2070 7373 756d 2861 2c20 696e 6469  ef pssum(a, indi
+00000c00: 6178 6973 2c20 696e 6469 6178 6973 742c  axis, indiaxist,
+00000c10: 2073 6861 7265 645f 6172 7261 7929 3a0a   shared_array):.
+00000c20: 2020 2020 7265 7320 3d20 5b5d 0a20 2020      res = [].   
+00000c30: 2066 6f72 2069 2069 6e20 613a 0a20 2020   for i in a:.   
+00000c40: 2020 2020 2069 6620 6920 213d 206c 656e       if i != len
+00000c50: 2869 6e64 6961 7869 7329 202d 2031 3a0a  (indiaxis) - 1:.
+00000c60: 2020 2020 2020 2020 2020 2020 696e 6469              indi
+00000c70: 6365 7320 3d20 6e70 2e61 7267 7768 6572  ces = np.argwher
+00000c80: 6528 2873 6861 7265 645f 6172 7261 7920  e((shared_array 
+00000c90: 3e20 696e 6469 6178 6973 745b 695d 2920  > indiaxist[i]) 
+00000ca0: 2620 2873 6861 7265 645f 6172 7261 7920  & (shared_array 
+00000cb0: 3c3d 2069 6e64 6961 7869 7374 5b69 202b  <= indiaxist[i +
+00000cc0: 2031 5d29 290a 2020 2020 2020 2020 2020   1])).          
+00000cd0: 2020 6966 2069 203d 3d20 3020 6f72 2069    if i == 0 or i
+00000ce0: 203d 3d20 313a 0a20 2020 2020 2020 2020   == 1:.         
+00000cf0: 2020 2020 2020 2070 7269 6e74 286e 702e         print(np.
+00000d00: 6e64 6172 7261 792e 746f 6c69 7374 2869  ndarray.tolist(i
+00000d10: 6e64 6963 6573 2929 0a20 2020 2020 2020  ndices)).       
+00000d20: 2020 2020 2020 2020 2070 7269 6e74 286c           print(l
+00000d30: 656e 2869 6e64 6963 6573 5b30 5d29 290a  en(indices[0])).
+00000d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000d50: 7072 696e 7428 2769 6e64 6961 7869 7374  print('indiaxist
+00000d60: 5b7b 7d5d 3d7b 7d2c 2069 6e64 6961 7869  [{}]={}, indiaxi
+00000d70: 7374 5b7b 7d2b 315d 272e 666f 726d 6174  st[{}+1]'.format
+00000d80: 2869 2c20 696e 6469 6178 6973 745b 695d  (i, indiaxist[i]
+00000d90: 2c20 696e 6469 6178 6973 745b 692b 315d  , indiaxist[i+1]
+00000da0: 2029 290a 2020 2020 2020 2020 2020 2020   )).            
+00000db0: 7265 732e 6170 7065 6e64 2869 6e64 6963  res.append(indic
+00000dc0: 6573 290a 2020 2020 7265 7475 726e 2072  es).    return r
+00000dd0: 6573 0a0a 0a23 2064 6566 2070 6361 6c28  es...# def pcal(
+00000de0: 612c 2069 6e64 6961 7869 732c 2064 6973  a, indiaxis, dis
+00000df0: 742c 2069 6e64 6961 7869 7374 293a 0a23  t, indiaxist):.#
+00000e00: 2020 2020 2062 203d 205b 5d0a 2320 2020       b = [].#   
+00000e10: 2020 666f 7220 6920 696e 2061 3a0a 2320    for i in a:.# 
+00000e20: 2020 2020 2020 2020 622e 6170 7065 6e64          b.append
+00000e30: 2870 7373 756d 2869 2c20 696e 6469 6178  (pssum(i, indiax
 00000e40: 6973 2c20 6469 7374 2c20 696e 6469 6178  is, dist, indiax
-00000e50: 6973 7429 3a0a 2320 2020 2020 6220 3d20  ist):.#     b = 
-00000e60: 5b5d 0a23 2020 2020 2066 6f72 2069 2069  [].#     for i i
-00000e70: 6e20 613a 0a23 2020 2020 2020 2020 2062  n a:.#         b
-00000e80: 2e61 7070 656e 6428 7073 7375 6d28 692c  .append(pssum(i,
-00000e90: 2069 6e64 6961 7869 732c 2064 6973 742c   indiaxis, dist,
-00000ea0: 2069 6e64 6961 7869 7374 2929 0a23 2020   indiaxist)).#  
-00000eb0: 2020 2072 6574 7572 6e20 620a 0a23 2064     return b..# d
-00000ec0: 6566 2070 7373 756d 286c 656e 696e 642c  ef pssum(lenind,
-00000ed0: 2070 736d 6170 293a 0a23 2020 2020 2070   psmap):.#     p
-00000ee0: 7375 6d20 3d20 6c6f 6731 3028 7073 6d61  sum = log10(psma
-00000ef0: 702e 7375 6d28 2920 2f20 6c65 6e28 6c65  p.sum() / len(le
-00000f00: 6e69 6e64 2929 0a23 2020 2020 2072 6574  nind)).#     ret
-00000f10: 7572 6e20 7073 756d 0a23 0a23 2064 6566  urn psum.#.# def
-00000f20: 2070 6361 6c28 612c 2061 6c6c 696e 6469   pcal(a, allindi
-00000f30: 6365 732c 2061 6c6c 7073 6d61 7029 3a0a  ces, allpsmap):.
-00000f40: 2320 2020 2020 6220 3d20 5b5d 0a23 2020  #     b = [].#  
-00000f50: 2020 2070 7269 6e74 2827 696e 6473 6964     print('indsid
-00000f60: 6520 7063 616c 2729 0a23 2020 2020 2070  e pcal').#     p
-00000f70: 7269 6e74 286c 656e 2861 6c6c 696e 6469  rint(len(allindi
-00000f80: 6365 7329 290a 2320 2020 2020 666f 7220  ces)).#     for 
-00000f90: 6920 696e 2061 3a0a 230a 2320 2020 2020  i in a:.#.#     
-00000fa0: 2020 2020 6c65 6e69 6e64 203d 2061 6c6c      lenind = all
-00000fb0: 696e 6469 6365 735b 695d 0a23 2020 2020  indices[i].#    
-00000fc0: 2020 2020 2070 736d 6170 203d 2061 6c6c       psmap = all
-00000fd0: 7073 6d61 705b 695d 0a23 0a23 2020 2020  psmap[i].#.#    
-00000fe0: 2020 2020 2062 2e61 7070 656e 6428 7073       b.append(ps
-00000ff0: 7375 6d28 6c65 6e69 6e64 2c20 7073 6d61  sum(lenind, psma
-00001000: 7029 290a 2320 2020 2020 7265 7475 726e  p)).#     return
-00001010: 2062 0a0a 0a0a 0a23 2323 2323 2323 2323   b.....#########
-00001020: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00001030: 2323 230a 0a63 6c61 7373 2056 616c 6964  ###..class Valid
-00001040: 6174 696f 6e41 6e61 6c79 7369 733a 0a20  ationAnalysis:. 
-00001050: 2020 2022 2222 0a20 2020 2056 616c 6964     """.    Valid
-00001060: 6174 696f 6e20 416e 616c 7973 6973 2063  ation Analysis c
-00001070: 6c61 7373 0a0a 2020 2020 2222 220a 0a20  lass..    """.. 
-00001080: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
-00001090: 7365 6c66 2c20 6d61 703d 4e6f 6e65 2c20  self, map=None, 
-000010a0: 6d6f 6465 6c3d 4e6f 6e65 2c20 7069 643d  model=None, pid=
-000010b0: 4e6f 6e65 2c20 6861 6c66 6576 656e 3d4e  None, halfeven=N
-000010c0: 6f6e 652c 2068 616c 666f 6464 3d4e 6f6e  one, halfodd=Non
-000010d0: 652c 2072 6177 6d61 703d 4e6f 6e65 2c20  e, rawmap=None, 
-000010e0: 636f 6e74 6f75 726c 6576 656c 3d4e 6f6e  contourlevel=Non
-000010f0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00001100: 2020 2020 656d 6469 643d 4e6f 6e65 2c20      emdid=None, 
-00001110: 6469 723d 4e6f 6e65 2c20 6d65 743d 4e6f  dir=None, met=No
-00001120: 6e65 2c20 7265 736f 6c75 7469 6f6e 3d4e  ne, resolution=N
-00001130: 6f6e 652c 2066 7363 6669 6c65 3d4e 6f6e  one, fscfile=Non
-00001140: 652c 206d 6173 6b73 3d4e 6f6e 652c 206d  e, masks=None, m
-00001150: 6f64 656c 736d 6170 733d 4e6f 6e65 2c0a  odelsmaps=None,.
-00001160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001170: 206f 6e6c 7962 6172 3d46 616c 7365 2c20   onlybar=False, 
-00001180: 7374 7275 6465 6c6c 6962 3d4e 6f6e 652c  strudellib=None,
-00001190: 2074 6872 6565 6466 7363 6469 723d 4e6f   threedfscdir=No
-000011a0: 6e65 2c20 706c 6174 666f 726d 3d4e 6f6e  ne, platform=Non
-000011b0: 6529 3a0a 2020 2020 2020 2020 2222 220a  e):.        """.
-000011c0: 0a20 2020 2020 2020 2020 2020 2043 6f6e  .            Con
-000011d0: 7374 7275 6374 6f72 2066 756e 6374 696f  structor functio
-000011e0: 6e20 6f66 2056 616c 6964 6174 696f 6e41  n of ValidationA
-000011f0: 6e61 6c79 7369 7320 636c 6173 730a 0a20  nalysis class.. 
-00001200: 2020 2020 2020 203a 7061 7261 6d20 6d61         :param ma
-00001210: 703a 204d 6170 2069 6e73 7461 6e63 6520  p: Map instance 
-00001220: 6672 6f6d 2054 454d 5079 2070 6163 6b61  from TEMPy packa
-00001230: 6765 0a20 2020 2020 2020 203a 7061 7261  ge.        :para
-00001240: 6d20 6d6f 6465 6c3a 204d 6f64 656c 2069  m model: Model i
-00001250: 6e73 7461 6e63 6520 6672 6f6d 2054 454d  nstance from TEM
-00001260: 5079 2043 4946 2066 696c 6520 7061 7273  Py CIF file pars
-00001270: 6572 0a20 2020 2020 2020 203a 7061 7261  er.        :para
-00001280: 6d20 7069 643a 2073 7472 7563 7475 7265  m pid: structure
-00001290: 2069 640a 2020 2020 2020 2020 3a70 6172   id.        :par
-000012a0: 616d 2068 616c 666d 6170 3a20 4d61 7020  am halfmap: Map 
-000012b0: 696e 7374 616e 6365 2066 6f72 2046 5343  instance for FSC
-000012c0: 2063 616c 6375 6c61 7469 6f6e 0a20 2020   calculation.   
-000012d0: 2020 2020 203a 7061 7261 6d20 636f 6e74       :param cont
-000012e0: 6f75 726c 6576 656c 3a20 466c 6f61 7420  ourlevel: Float 
-000012f0: 7661 6c75 6520 7768 6963 6820 7265 636f  value which reco
-00001300: 6d6d 656e 6465 6420 6279 2074 6865 2061  mmended by the a
-00001310: 7574 686f 7220 6f72 2045 4d44 420a 0a20  uthor or EMDB.. 
-00001320: 2020 2020 2020 2022 2222 0a0a 2020 2020         """..    
-00001330: 2020 2020 7365 6c66 2e6d 6f64 656c 7320      self.models 
-00001340: 3d20 6d6f 6465 6c0a 2020 2020 2020 2020  = model.        
-00001350: 7365 6c66 2e6d 6170 203d 206d 6170 0a20  self.map = map. 
-00001360: 2020 2020 2020 2073 656c 662e 6d61 706e         self.mapn
-00001370: 616d 6520 3d20 6f73 2e70 6174 682e 6261  ame = os.path.ba
-00001380: 7365 6e61 6d65 286d 6170 2e66 756c 6c6e  sename(map.fulln
-00001390: 616d 6529 0a20 2020 2020 2020 2073 656c  ame).        sel
-000013a0: 662e 7069 6420 3d20 7069 640a 2020 2020  f.pid = pid.    
-000013b0: 2020 2020 7365 6c66 2e65 6d64 6964 203d      self.emdid =
-000013c0: 2065 6d64 6964 0a20 2020 2020 2020 2073   emdid.        s
-000013d0: 656c 662e 686d 6576 656e 203d 2068 616c  elf.hmeven = hal
-000013e0: 6665 7665 6e0a 2020 2020 2020 2020 7365  feven.        se
-000013f0: 6c66 2e68 6d6f 6464 203d 2068 616c 666f  lf.hmodd = halfo
-00001400: 6464 0a20 2020 2020 2020 2073 656c 662e  dd.        self.
-00001410: 7261 776d 6170 203d 2072 6177 6d61 700a  rawmap = rawmap.
-00001420: 2020 2020 2020 2020 7365 6c66 2e6d 6574          self.met
-00001430: 203d 206d 6574 0a20 2020 2020 2020 2073   = met.        s
-00001440: 656c 662e 7265 736f 6c75 7469 6f6e 203d  elf.resolution =
-00001450: 2072 6573 6f6c 7574 696f 6e0a 2020 2020   resolution.    
-00001460: 2020 2020 7365 6c66 2e66 7363 6669 6c65      self.fscfile
-00001470: 203d 2066 7363 6669 6c65 0a20 2020 2020   = fscfile.     
-00001480: 2020 2073 656c 662e 616c 6c6d 6173 6b73     self.allmasks
-00001490: 203d 206d 6173 6b73 0a20 2020 2020 2020   = masks.       
-000014a0: 2073 656c 662e 6d6f 6465 6c73 6d61 7073   self.modelsmaps
-000014b0: 203d 206d 6f64 656c 736d 6170 730a 2020   = modelsmaps.  
-000014c0: 2020 2020 2020 7365 6c66 2e6f 6e6c 7962        self.onlyb
-000014d0: 6172 203d 206f 6e6c 7962 6172 0a20 2020  ar = onlybar.   
-000014e0: 2020 2020 2073 656c 662e 7374 7275 6465       self.strude
-000014f0: 6c6c 6962 203d 2073 7472 7564 656c 6c69  llib = strudelli
-00001500: 620a 2020 2020 2020 2020 7365 6c66 2e74  b.        self.t
-00001510: 6872 6565 6466 7363 6469 7220 3d20 7468  hreedfscdir = th
-00001520: 7265 6564 6673 6364 6972 0a20 2020 2020  reedfscdir.     
-00001530: 2020 2073 656c 662e 706c 6174 666f 726d     self.platform
-00001540: 203d 2070 6c61 7466 6f72 6d0a 2020 2020   = platform.    
-00001550: 2020 2020 6966 2063 6f6e 746f 7572 6c65      if contourle
-00001560: 7665 6c20 6973 206e 6f74 204e 6f6e 653a  vel is not None:
-00001570: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00001580: 662e 636c 203d 2066 6c6f 6174 2863 6f6e  f.cl = float(con
-00001590: 746f 7572 6c65 7665 6c29 0a20 2020 2020  tourlevel).     
-000015a0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000015b0: 2020 2020 2073 656c 662e 636c 203d 2063       self.cl = c
-000015c0: 6f6e 746f 7572 6c65 7665 6c0a 2020 2020  ontourlevel.    
-000015d0: 2020 2020 6966 2073 656c 662e 656d 6469      if self.emdi
-000015e0: 643a 0a20 2020 2020 2020 2020 2020 2064  d:.            d
-000015f0: 6967 6974 7320 3d20 5b69 2066 6f72 2069  igits = [i for i
-00001600: 2069 6e20 7374 7228 7365 6c66 2e65 6d64   in str(self.emd
-00001610: 6964 295d 0a20 2020 2020 2020 2020 2020  id)].           
-00001620: 2069 6620 6c65 6e28 6469 6769 7473 2920   if len(digits) 
-00001630: 3d3d 2034 3a0a 2020 2020 2020 2020 2020  == 4:.          
-00001640: 2020 2020 2020 7375 6264 6972 203d 2027        subdir = '
-00001650: 7b7d 2f7b 7d2f 272e 666f 726d 6174 2864  {}/{}/'.format(d
-00001660: 6967 6974 735b 305d 202b 2064 6967 6974  igits[0] + digit
-00001670: 735b 315d 2c20 7365 6c66 2e65 6d64 6964  s[1], self.emdid
-00001680: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00001690: 2020 7365 6c66 2e77 6f72 6b64 6972 203d    self.workdir =
-000016a0: 204d 4150 5f53 4552 5645 525f 5041 5448   MAP_SERVER_PATH
-000016b0: 202b 2073 7562 6469 7220 2b20 2776 612f   + subdir + 'va/
-000016c0: 270a 2020 2020 2020 2020 2020 2020 656c  '.            el
-000016d0: 6966 206c 656e 2864 6967 6974 7329 203d  if len(digits) =
-000016e0: 3d20 353a 0a20 2020 2020 2020 2020 2020  = 5:.           
-000016f0: 2020 2020 2073 7562 6469 7220 3d20 277b       subdir = '{
-00001700: 7d2f 7b7d 2f7b 7d2f 272e 666f 726d 6174  }/{}/{}/'.format
-00001710: 2864 6967 6974 735b 305d 202b 2064 6967  (digits[0] + dig
-00001720: 6974 735b 315d 2c20 6469 6769 7473 5b32  its[1], digits[2
-00001730: 5d2c 2073 656c 662e 656d 6469 6429 0a20  ], self.emdid). 
-00001740: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00001750: 656c 662e 776f 726b 6469 7220 3d20 4d41  elf.workdir = MA
-00001760: 505f 5345 5256 4552 5f50 4154 4820 2b20  P_SERVER_PATH + 
-00001770: 7375 6264 6972 202b 2027 7661 2f27 0a20  subdir + 'va/'. 
-00001780: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00001790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000017a0: 2070 6173 730a 2020 2020 2020 2020 656c   pass.        el
-000017b0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000017c0: 7365 6c66 2e77 6f72 6b64 6972 203d 2064  self.workdir = d
-000017d0: 6972 0a20 2020 2020 2020 2073 656c 662e  ir.        self.
-000017e0: 6765 745f 7265 736f 6c75 7469 6f6e 2829  get_resolution()
-000017f0: 0a0a 2020 2020 6465 6620 6765 745f 7265  ..    def get_re
-00001800: 736f 6c75 7469 6f6e 2873 656c 6629 3a0a  solution(self):.
-00001810: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00001820: 2020 2020 2020 2020 4765 7420 7468 6520          Get the 
-00001830: 696e 7075 7420 7265 736f 6c75 7469 6f6e  input resolution
-00001840: 2074 6f20 7468 6520 6f75 7470 7574 204a   to the output J
-00001850: 534f 4e20 6669 6c65 0a20 2020 2020 2020  SON file.       
-00001860: 203a 7265 7475 726e 3a20 4a53 4f4e 2066   :return: JSON f
-00001870: 696c 6520 6e61 6d65 0a20 2020 2020 2020  ile name.       
-00001880: 2022 2222 0a0a 2020 2020 2020 2020 6966   """..        if
-00001890: 2073 656c 662e 7265 736f 6c75 7469 6f6e   self.resolution
-000018a0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-000018b0: 735f 6469 6374 203d 207b 2772 6573 6f6c  s_dict = {'resol
-000018c0: 7574 696f 6e27 3a20 7b27 7661 6c75 6527  ution': {'value'
-000018d0: 3a20 7365 6c66 2e72 6573 6f6c 7574 696f  : self.resolutio
-000018e0: 6e7d 7d0a 2020 2020 2020 2020 2020 2020  n}}.            
-000018f0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00001900: 2020 2020 2077 6974 6820 636f 6465 6373       with codecs
-00001910: 2e6f 7065 6e28 7365 6c66 2e77 6f72 6b64  .open(self.workd
-00001920: 6972 202b 2073 656c 662e 6d61 706e 616d  ir + self.mapnam
-00001930: 6520 2b20 275f 7265 736f 6c75 7469 6f6e  e + '_resolution
-00001940: 2e6a 736f 6e27 2c20 2777 272c 0a20 2020  .json', 'w',.   
-00001950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001960: 2020 2020 2020 2020 2020 2020 2020 656e                en
-00001970: 636f 6469 6e67 3d27 7574 662d 3827 2920  coding='utf-8') 
-00001980: 6173 2066 3a0a 2020 2020 2020 2020 2020  as f:.          
-00001990: 2020 2020 2020 2020 2020 6a73 6f6e 2e64            json.d
-000019a0: 756d 7028 7265 735f 6469 6374 2c20 6629  ump(res_dict, f)
-000019b0: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-000019c0: 6570 7420 494f 4572 726f 7220 6173 2069  ept IOError as i
-000019d0: 6f65 7272 3a0a 2020 2020 2020 2020 2020  oerr:.          
-000019e0: 2020 2020 2020 6a73 6f6e 6572 7220 3d20        jsonerr = 
-000019f0: 2753 6176 696e 6720 7265 736f 6c75 7469  'Saving resoluti
-00001a00: 6f6e 2069 6e74 6f20 6a73 6f6e 2065 7272  on into json err
-00001a10: 6f72 3a20 7b7d 272e 666f 726d 6174 2869  or: {}'.format(i
-00001a20: 6f65 7272 290a 2020 2020 2020 2020 2020  oerr).          
-00001a30: 2020 2020 2020 7379 732e 7374 6465 7272        sys.stderr
-00001a40: 2e77 7269 7465 286a 736f 6e65 7272 202b  .write(jsonerr +
-00001a50: 2027 5c6e 2729 0a20 2020 2020 2020 2065   '\n').        e
-00001a60: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00001a70: 2070 7269 6e74 2827 5468 6572 6520 6973   print('There is
-00001a80: 206e 6f20 7265 736f 6c75 7469 6f6e 2073   no resolution s
-00001a90: 6176 6564 2021 2121 2729 0a0a 0a20 2020  aved !!!')...   
-00001aa0: 2023 2047 6c6f 7720 4c55 5420 666f 7220   # Glow LUT for 
-00001ab0: 636f 6c6f 7220 696d 6167 650a 2020 2020  color image.    
-00001ac0: 6465 6620 676c 6f77 696d 6167 6528 7365  def glowimage(se
-00001ad0: 6c66 2c20 696d 5f67 7261 7929 3a0a 2020  lf, im_gray):.  
-00001ae0: 2020 2020 2020 2222 2241 7070 6c69 6573        """Applies
-00001af0: 2061 2067 6c6f 7720 636f 6c6f 7220 6d61   a glow color ma
-00001b00: 7020 7573 696e 6720 6376 322e 6170 706c  p using cv2.appl
-00001b10: 7943 6f6c 6f72 4d61 7028 2922 2222 0a0a  yColorMap()"""..
-00001b20: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
-00001b30: 2074 6865 204c 5554 3a0a 2020 2020 2020   the LUT:.      
-00001b40: 2020 6c75 7420 3d20 6e70 2e7a 6572 6f73    lut = np.zeros
-00001b50: 2828 3235 362c 2031 2c20 3329 2c20 6474  ((256, 1, 3), dt
-00001b60: 7970 653d 6e70 2e75 696e 7438 290a 2020  ype=np.uint8).  
-00001b70: 2020 2020 2020 6c75 745b 3a2c 2030 2c20        lut[:, 0, 
-00001b80: 325d 203d 205b 302c 2031 2c20 312c 2032  2] = [0, 1, 1, 2
-00001b90: 2c20 322c 2033 2c20 342c 2036 2c20 382c  , 2, 3, 4, 6, 8,
-00001ba0: 2031 312c 2031 332c 2031 352c 2031 382c   11, 13, 15, 18,
-00001bb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00001bc0: 2020 2020 2020 2020 2032 312c 2032 332c           21, 23,
-00001bd0: 2032 342c 2032 372c 2033 302c 2033 312c   24, 27, 30, 31,
-00001be0: 2033 332c 2033 362c 2033 372c 2034 302c   33, 36, 37, 40,
-00001bf0: 2034 322c 2034 352c 2034 362c 0a20 2020   42, 45, 46,.   
-00001c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001c10: 2020 2020 2034 392c 2035 312c 2035 332c       49, 51, 53,
-00001c20: 2035 362c 2035 382c 2036 302c 2036 322c   56, 58, 60, 62,
-00001c30: 2036 352c 2036 382c 2037 302c 2037 322c   65, 68, 70, 72,
-00001c40: 2037 342c 2037 382c 0a20 2020 2020 2020   74, 78,.       
-00001c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001c60: 2038 302c 2038 322c 2038 342c 2038 362c   80, 82, 84, 86,
-00001c70: 2038 392c 2039 312c 2039 332c 2039 362c   89, 91, 93, 96,
-00001c80: 2039 382c 2031 3030 2c20 3130 322c 2031   98, 100, 102, 1
-00001c90: 3034 2c20 3130 362c 0a20 2020 2020 2020  04, 106,.       
+00000e50: 6973 7429 290a 2320 2020 2020 7265 7475  ist)).#     retu
+00000e60: 726e 2062 0a0a 2320 6465 6620 7073 7375  rn b..# def pssu
+00000e70: 6d28 6c65 6e69 6e64 2c20 7073 6d61 7029  m(lenind, psmap)
+00000e80: 3a0a 2320 2020 2020 7073 756d 203d 206c  :.#     psum = l
+00000e90: 6f67 3130 2870 736d 6170 2e73 756d 2829  og10(psmap.sum()
+00000ea0: 202f 206c 656e 286c 656e 696e 6429 290a   / len(lenind)).
+00000eb0: 2320 2020 2020 7265 7475 726e 2070 7375  #     return psu
+00000ec0: 6d0a 230a 2320 6465 6620 7063 616c 2861  m.#.# def pcal(a
+00000ed0: 2c20 616c 6c69 6e64 6963 6573 2c20 616c  , allindices, al
+00000ee0: 6c70 736d 6170 293a 0a23 2020 2020 2062  lpsmap):.#     b
+00000ef0: 203d 205b 5d0a 2320 2020 2020 7072 696e   = [].#     prin
+00000f00: 7428 2769 6e64 7369 6465 2070 6361 6c27  t('indside pcal'
+00000f10: 290a 2320 2020 2020 7072 696e 7428 6c65  ).#     print(le
+00000f20: 6e28 616c 6c69 6e64 6963 6573 2929 0a23  n(allindices)).#
+00000f30: 2020 2020 2066 6f72 2069 2069 6e20 613a       for i in a:
+00000f40: 0a23 0a23 2020 2020 2020 2020 206c 656e  .#.#         len
+00000f50: 696e 6420 3d20 616c 6c69 6e64 6963 6573  ind = allindices
+00000f60: 5b69 5d0a 2320 2020 2020 2020 2020 7073  [i].#         ps
+00000f70: 6d61 7020 3d20 616c 6c70 736d 6170 5b69  map = allpsmap[i
+00000f80: 5d0a 230a 2320 2020 2020 2020 2020 622e  ].#.#         b.
+00000f90: 6170 7065 6e64 2870 7373 756d 286c 656e  append(pssum(len
+00000fa0: 696e 642c 2070 736d 6170 2929 0a23 2020  ind, psmap)).#  
+00000fb0: 2020 2072 6574 7572 6e20 620a 0a0a 0a0a     return b.....
+00000fc0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00000fd0: 2323 2323 2323 2323 2323 2323 0a0a 636c  ############..cl
+00000fe0: 6173 7320 5661 6c69 6461 7469 6f6e 416e  ass ValidationAn
+00000ff0: 616c 7973 6973 3a0a 2020 2020 2222 220a  alysis:.    """.
+00001000: 2020 2020 5661 6c69 6461 7469 6f6e 2041      Validation A
+00001010: 6e61 6c79 7369 7320 636c 6173 730a 0a20  nalysis class.. 
+00001020: 2020 2022 2222 0a0a 2020 2020 6465 6620     """..    def 
+00001030: 5f5f 696e 6974 5f5f 2873 656c 662c 206d  __init__(self, m
+00001040: 6170 3d4e 6f6e 652c 206d 6f64 656c 3d4e  ap=None, model=N
+00001050: 6f6e 652c 2070 6964 3d4e 6f6e 652c 2068  one, pid=None, h
+00001060: 616c 6665 7665 6e3d 4e6f 6e65 2c20 6861  alfeven=None, ha
+00001070: 6c66 6f64 643d 4e6f 6e65 2c20 7261 776d  lfodd=None, rawm
+00001080: 6170 3d4e 6f6e 652c 2063 6f6e 746f 7572  ap=None, contour
+00001090: 6c65 7665 6c3d 4e6f 6e65 2c0a 2020 2020  level=None,.    
+000010a0: 2020 2020 2020 2020 2020 2020 2065 6d64               emd
+000010b0: 6964 3d4e 6f6e 652c 2064 6972 3d4e 6f6e  id=None, dir=Non
+000010c0: 652c 206d 6574 3d4e 6f6e 652c 2072 6573  e, met=None, res
+000010d0: 6f6c 7574 696f 6e3d 4e6f 6e65 2c20 6673  olution=None, fs
+000010e0: 6366 696c 653d 4e6f 6e65 2c20 6d61 736b  cfile=None, mask
+000010f0: 733d 4e6f 6e65 2c20 6d6f 6465 6c73 6d61  s=None, modelsma
+00001100: 7073 3d4e 6f6e 652c 0a20 2020 2020 2020  ps=None,.       
+00001110: 2020 2020 2020 2020 2020 6f6e 6c79 6261            onlyba
+00001120: 723d 4661 6c73 652c 2073 7472 7564 656c  r=False, strudel
+00001130: 6c69 623d 4e6f 6e65 2c20 7468 7265 6564  lib=None, threed
+00001140: 6673 6364 6972 3d4e 6f6e 652c 2070 6c61  fscdir=None, pla
+00001150: 7466 6f72 6d3d 4e6f 6e65 293a 0a20 2020  tform=None):.   
+00001160: 2020 2020 2022 2222 0a0a 2020 2020 2020       """..      
+00001170: 2020 2020 2020 436f 6e73 7472 7563 746f        Constructo
+00001180: 7220 6675 6e63 7469 6f6e 206f 6620 5661  r function of Va
+00001190: 6c69 6461 7469 6f6e 416e 616c 7973 6973  lidationAnalysis
+000011a0: 2063 6c61 7373 0a0a 2020 2020 2020 2020   class..        
+000011b0: 3a70 6172 616d 206d 6170 3a20 4d61 7020  :param map: Map 
+000011c0: 696e 7374 616e 6365 2066 726f 6d20 5445  instance from TE
+000011d0: 4d50 7920 7061 636b 6167 650a 2020 2020  MPy package.    
+000011e0: 2020 2020 3a70 6172 616d 206d 6f64 656c      :param model
+000011f0: 3a20 4d6f 6465 6c20 696e 7374 616e 6365  : Model instance
+00001200: 2066 726f 6d20 5445 4d50 7920 4349 4620   from TEMPy CIF 
+00001210: 6669 6c65 2070 6172 7365 720a 2020 2020  file parser.    
+00001220: 2020 2020 3a70 6172 616d 2070 6964 3a20      :param pid: 
+00001230: 7374 7275 6374 7572 6520 6964 0a20 2020  structure id.   
+00001240: 2020 2020 203a 7061 7261 6d20 6861 6c66       :param half
+00001250: 6d61 703a 204d 6170 2069 6e73 7461 6e63  map: Map instanc
+00001260: 6520 666f 7220 4653 4320 6361 6c63 756c  e for FSC calcul
+00001270: 6174 696f 6e0a 2020 2020 2020 2020 3a70  ation.        :p
+00001280: 6172 616d 2063 6f6e 746f 7572 6c65 7665  aram contourleve
+00001290: 6c3a 2046 6c6f 6174 2076 616c 7565 2077  l: Float value w
+000012a0: 6869 6368 2072 6563 6f6d 6d65 6e64 6564  hich recommended
+000012b0: 2062 7920 7468 6520 6175 7468 6f72 206f   by the author o
+000012c0: 7220 454d 4442 0a0a 2020 2020 2020 2020  r EMDB..        
+000012d0: 2222 220a 0a20 2020 2020 2020 2073 656c  """..        sel
+000012e0: 662e 6d6f 6465 6c73 203d 206d 6f64 656c  f.models = model
+000012f0: 0a20 2020 2020 2020 2073 656c 662e 6d61  .        self.ma
+00001300: 7020 3d20 6d61 700a 2020 2020 2020 2020  p = map.        
+00001310: 7365 6c66 2e6d 6170 6e61 6d65 203d 206f  self.mapname = o
+00001320: 732e 7061 7468 2e62 6173 656e 616d 6528  s.path.basename(
+00001330: 6d61 702e 6675 6c6c 6e61 6d65 290a 2020  map.fullname).  
+00001340: 2020 2020 2020 7365 6c66 2e70 6964 203d        self.pid =
+00001350: 2070 6964 0a20 2020 2020 2020 2073 656c   pid.        sel
+00001360: 662e 656d 6469 6420 3d20 656d 6469 640a  f.emdid = emdid.
+00001370: 2020 2020 2020 2020 7365 6c66 2e68 6d65          self.hme
+00001380: 7665 6e20 3d20 6861 6c66 6576 656e 0a20  ven = halfeven. 
+00001390: 2020 2020 2020 2073 656c 662e 686d 6f64         self.hmod
+000013a0: 6420 3d20 6861 6c66 6f64 640a 2020 2020  d = halfodd.    
+000013b0: 2020 2020 7365 6c66 2e72 6177 6d61 7020      self.rawmap 
+000013c0: 3d20 7261 776d 6170 0a20 2020 2020 2020  = rawmap.       
+000013d0: 2073 656c 662e 6d65 7420 3d20 6d65 740a   self.met = met.
+000013e0: 2020 2020 2020 2020 7365 6c66 2e72 6573          self.res
+000013f0: 6f6c 7574 696f 6e20 3d20 7265 736f 6c75  olution = resolu
+00001400: 7469 6f6e 0a20 2020 2020 2020 2073 656c  tion.        sel
+00001410: 662e 6673 6366 696c 6520 3d20 6673 6366  f.fscfile = fscf
+00001420: 696c 650a 2020 2020 2020 2020 7365 6c66  ile.        self
+00001430: 2e61 6c6c 6d61 736b 7320 3d20 6d61 736b  .allmasks = mask
+00001440: 730a 2020 2020 2020 2020 7365 6c66 2e6d  s.        self.m
+00001450: 6f64 656c 736d 6170 7320 3d20 6d6f 6465  odelsmaps = mode
+00001460: 6c73 6d61 7073 0a20 2020 2020 2020 2073  lsmaps.        s
+00001470: 656c 662e 6f6e 6c79 6261 7220 3d20 6f6e  elf.onlybar = on
+00001480: 6c79 6261 720a 2020 2020 2020 2020 7365  lybar.        se
+00001490: 6c66 2e73 7472 7564 656c 6c69 6220 3d20  lf.strudellib = 
+000014a0: 7374 7275 6465 6c6c 6962 0a20 2020 2020  strudellib.     
+000014b0: 2020 2073 656c 662e 7468 7265 6564 6673     self.threedfs
+000014c0: 6364 6972 203d 2074 6872 6565 6466 7363  cdir = threedfsc
+000014d0: 6469 720a 2020 2020 2020 2020 7365 6c66  dir.        self
+000014e0: 2e70 6c61 7466 6f72 6d20 3d20 706c 6174  .platform = plat
+000014f0: 666f 726d 0a20 2020 2020 2020 2069 6620  form.        if 
+00001500: 636f 6e74 6f75 726c 6576 656c 2069 7320  contourlevel is 
+00001510: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+00001520: 2020 2020 2020 7365 6c66 2e63 6c20 3d20        self.cl = 
+00001530: 666c 6f61 7428 636f 6e74 6f75 726c 6576  float(contourlev
+00001540: 656c 290a 2020 2020 2020 2020 656c 7365  el).        else
+00001550: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00001560: 6c66 2e63 6c20 3d20 636f 6e74 6f75 726c  lf.cl = contourl
+00001570: 6576 656c 0a20 2020 2020 2020 2069 6620  evel.        if 
+00001580: 7365 6c66 2e65 6d64 6964 3a0a 2020 2020  self.emdid:.    
+00001590: 2020 2020 2020 2020 6469 6769 7473 203d          digits =
+000015a0: 205b 6920 666f 7220 6920 696e 2073 7472   [i for i in str
+000015b0: 2873 656c 662e 656d 6469 6429 5d0a 2020  (self.emdid)].  
+000015c0: 2020 2020 2020 2020 2020 6966 206c 656e            if len
+000015d0: 2864 6967 6974 7329 203d 3d20 343a 0a20  (digits) == 4:. 
+000015e0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000015f0: 7562 6469 7220 3d20 277b 7d2f 7b7d 2f27  ubdir = '{}/{}/'
+00001600: 2e66 6f72 6d61 7428 6469 6769 7473 5b30  .format(digits[0
+00001610: 5d20 2b20 6469 6769 7473 5b31 5d2c 2073  ] + digits[1], s
+00001620: 656c 662e 656d 6469 6429 0a20 2020 2020  elf.emdid).     
+00001630: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00001640: 776f 726b 6469 7220 3d20 4d41 505f 5345  workdir = MAP_SE
+00001650: 5256 4552 5f50 4154 4820 2b20 7375 6264  RVER_PATH + subd
+00001660: 6972 202b 2027 7661 2f27 0a20 2020 2020  ir + 'va/'.     
+00001670: 2020 2020 2020 2065 6c69 6620 6c65 6e28         elif len(
+00001680: 6469 6769 7473 2920 3d3d 2035 3a0a 2020  digits) == 5:.  
+00001690: 2020 2020 2020 2020 2020 2020 2020 7375                su
+000016a0: 6264 6972 203d 2027 7b7d 2f7b 7d2f 7b7d  bdir = '{}/{}/{}
+000016b0: 2f27 2e66 6f72 6d61 7428 6469 6769 7473  /'.format(digits
+000016c0: 5b30 5d20 2b20 6469 6769 7473 5b31 5d2c  [0] + digits[1],
+000016d0: 2064 6967 6974 735b 325d 2c20 7365 6c66   digits[2], self
+000016e0: 2e65 6d64 6964 290a 2020 2020 2020 2020  .emdid).        
+000016f0: 2020 2020 2020 2020 7365 6c66 2e77 6f72          self.wor
+00001700: 6b64 6972 203d 204d 4150 5f53 4552 5645  kdir = MAP_SERVE
+00001710: 525f 5041 5448 202b 2073 7562 6469 7220  R_PATH + subdir 
+00001720: 2b20 2776 612f 270a 2020 2020 2020 2020  + 'va/'.        
+00001730: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00001740: 2020 2020 2020 2020 2020 7061 7373 0a20            pass. 
+00001750: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00001760: 2020 2020 2020 2020 2073 656c 662e 776f           self.wo
+00001770: 726b 6469 7220 3d20 6469 720a 2020 2020  rkdir = dir.    
+00001780: 2020 2020 7365 6c66 2e67 6574 5f72 6573      self.get_res
+00001790: 6f6c 7574 696f 6e28 290a 0a20 2020 2064  olution()..    d
+000017a0: 6566 2067 6574 5f72 6573 6f6c 7574 696f  ef get_resolutio
+000017b0: 6e28 7365 6c66 293a 0a20 2020 2020 2020  n(self):.       
+000017c0: 2022 2222 0a20 2020 2020 2020 2020 2020   """.           
+000017d0: 2047 6574 2074 6865 2069 6e70 7574 2072   Get the input r
+000017e0: 6573 6f6c 7574 696f 6e20 746f 2074 6865  esolution to the
+000017f0: 206f 7574 7075 7420 4a53 4f4e 2066 696c   output JSON fil
+00001800: 650a 2020 2020 2020 2020 3a72 6574 7572  e.        :retur
+00001810: 6e3a 204a 534f 4e20 6669 6c65 206e 616d  n: JSON file nam
+00001820: 650a 2020 2020 2020 2020 2222 220a 0a20  e.        """.. 
+00001830: 2020 2020 2020 2069 6620 7365 6c66 2e72         if self.r
+00001840: 6573 6f6c 7574 696f 6e3a 0a20 2020 2020  esolution:.     
+00001850: 2020 2020 2020 2072 6573 5f64 6963 7420         res_dict 
+00001860: 3d20 7b27 7265 736f 6c75 7469 6f6e 273a  = {'resolution':
+00001870: 207b 2776 616c 7565 273a 2073 656c 662e   {'value': self.
+00001880: 7265 736f 6c75 7469 6f6e 7d7d 0a20 2020  resolution}}.   
+00001890: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+000018a0: 2020 2020 2020 2020 2020 2020 2020 7769                wi
+000018b0: 7468 2063 6f64 6563 732e 6f70 656e 2873  th codecs.open(s
+000018c0: 656c 662e 776f 726b 6469 7220 2b20 7365  elf.workdir + se
+000018d0: 6c66 2e6d 6170 6e61 6d65 202b 2027 5f72  lf.mapname + '_r
+000018e0: 6573 6f6c 7574 696f 6e2e 6a73 6f6e 272c  esolution.json',
+000018f0: 2027 7727 2c0a 2020 2020 2020 2020 2020   'w',.          
+00001900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001910: 2020 2020 2020 2065 6e63 6f64 696e 673d         encoding=
+00001920: 2775 7466 2d38 2729 2061 7320 663a 0a20  'utf-8') as f:. 
+00001930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001940: 2020 206a 736f 6e2e 6475 6d70 2872 6573     json.dump(res
+00001950: 5f64 6963 742c 2066 290a 2020 2020 2020  _dict, f).      
+00001960: 2020 2020 2020 6578 6365 7074 2049 4f45        except IOE
+00001970: 7272 6f72 2061 7320 696f 6572 723a 0a20  rror as ioerr:. 
+00001980: 2020 2020 2020 2020 2020 2020 2020 206a                 j
+00001990: 736f 6e65 7272 203d 2027 5361 7669 6e67  sonerr = 'Saving
+000019a0: 2072 6573 6f6c 7574 696f 6e20 696e 746f   resolution into
+000019b0: 206a 736f 6e20 6572 726f 723a 207b 7d27   json error: {}'
+000019c0: 2e66 6f72 6d61 7428 696f 6572 7229 0a20  .format(ioerr). 
+000019d0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000019e0: 7973 2e73 7464 6572 722e 7772 6974 6528  ys.stderr.write(
+000019f0: 6a73 6f6e 6572 7220 2b20 275c 6e27 290a  jsonerr + '\n').
+00001a00: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00001a10: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+00001a20: 2754 6865 7265 2069 7320 6e6f 2072 6573  'There is no res
+00001a30: 6f6c 7574 696f 6e20 7361 7665 6420 2121  olution saved !!
+00001a40: 2127 290a 0a0a 2020 2020 2320 476c 6f77  !')...    # Glow
+00001a50: 204c 5554 2066 6f72 2063 6f6c 6f72 2069   LUT for color i
+00001a60: 6d61 6765 0a20 2020 2064 6566 2067 6c6f  mage.    def glo
+00001a70: 7769 6d61 6765 2873 656c 662c 2069 6d5f  wimage(self, im_
+00001a80: 6772 6179 293a 0a20 2020 2020 2020 2022  gray):.        "
+00001a90: 2222 4170 706c 6965 7320 6120 676c 6f77  ""Applies a glow
+00001aa0: 2063 6f6c 6f72 206d 6170 2075 7369 6e67   color map using
+00001ab0: 2063 7632 2e61 7070 6c79 436f 6c6f 724d   cv2.applyColorM
+00001ac0: 6170 2829 2222 220a 0a20 2020 2020 2020  ap()"""..       
+00001ad0: 2023 2043 7265 6174 6520 7468 6520 4c55   # Create the LU
+00001ae0: 543a 0a20 2020 2020 2020 206c 7574 203d  T:.        lut =
+00001af0: 206e 702e 7a65 726f 7328 2832 3536 2c20   np.zeros((256, 
+00001b00: 312c 2033 292c 2064 7479 7065 3d6e 702e  1, 3), dtype=np.
+00001b10: 7569 6e74 3829 0a20 2020 2020 2020 206c  uint8).        l
+00001b20: 7574 5b3a 2c20 302c 2032 5d20 3d20 5b30  ut[:, 0, 2] = [0
+00001b30: 2c20 312c 2031 2c20 322c 2032 2c20 332c  , 1, 1, 2, 2, 3,
+00001b40: 2034 2c20 362c 2038 2c20 3131 2c20 3133   4, 6, 8, 11, 13
+00001b50: 2c20 3135 2c20 3138 2c0a 2020 2020 2020  , 15, 18,.      
+00001b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001b70: 2020 3231 2c20 3233 2c20 3234 2c20 3237    21, 23, 24, 27
+00001b80: 2c20 3330 2c20 3331 2c20 3333 2c20 3336  , 30, 31, 33, 36
+00001b90: 2c20 3337 2c20 3430 2c20 3432 2c20 3435  , 37, 40, 42, 45
+00001ba0: 2c20 3436 2c0a 2020 2020 2020 2020 2020  , 46,.          
+00001bb0: 2020 2020 2020 2020 2020 2020 2020 3439                49
+00001bc0: 2c20 3531 2c20 3533 2c20 3536 2c20 3538  , 51, 53, 56, 58
+00001bd0: 2c20 3630 2c20 3632 2c20 3635 2c20 3638  , 60, 62, 65, 68
+00001be0: 2c20 3730 2c20 3732 2c20 3734 2c20 3738  , 70, 72, 74, 78
+00001bf0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00001c00: 2020 2020 2020 2020 2020 3830 2c20 3832            80, 82
+00001c10: 2c20 3834 2c20 3836 2c20 3839 2c20 3931  , 84, 86, 89, 91
+00001c20: 2c20 3933 2c20 3936 2c20 3938 2c20 3130  , 93, 96, 98, 10
+00001c30: 302c 2031 3032 2c20 3130 342c 2031 3036  0, 102, 104, 106
+00001c40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00001c50: 2020 2020 2020 2020 2020 3130 382c 2031            108, 1
+00001c60: 3130 2c20 3131 332c 2031 3135 2c20 3131  10, 113, 115, 11
+00001c70: 372c 2031 3139 2c20 3132 322c 2031 3235  7, 119, 122, 125
+00001c80: 2c20 3132 372c 2031 3239 2c20 3133 322c  , 127, 129, 132,
+00001c90: 2031 3335 2c20 3133 352c 0a20 2020 2020   135, 135,.     
 00001ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001cb0: 2031 3038 2c20 3131 302c 2031 3133 2c20   108, 110, 113, 
-00001cc0: 3131 352c 2031 3137 2c20 3131 392c 2031  115, 117, 119, 1
-00001cd0: 3232 2c20 3132 352c 2031 3237 2c20 3132  22, 125, 127, 12
-00001ce0: 392c 2031 3332 2c20 3133 352c 2031 3335  9, 132, 135, 135
-00001cf0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00001d00: 2020 2020 2020 2020 2020 3133 372c 2031            137, 1
-00001d10: 3430 2c20 3134 312c 2031 3432 2c20 3134  40, 141, 142, 14
-00001d20: 352c 2031 3438 2c20 3134 392c 2031 3532  5, 148, 149, 152
-00001d30: 2c20 3135 342c 2031 3536 2c20 3135 372c  , 154, 156, 157,
-00001d40: 2031 3538 2c20 3136 302c 0a20 2020 2020   158, 160,.     
+00001cb0: 2020 2031 3337 2c20 3134 302c 2031 3431     137, 140, 141
+00001cc0: 2c20 3134 322c 2031 3435 2c20 3134 382c  , 142, 145, 148,
+00001cd0: 2031 3439 2c20 3135 322c 2031 3534 2c20   149, 152, 154, 
+00001ce0: 3135 362c 2031 3537 2c20 3135 382c 2031  156, 157, 158, 1
+00001cf0: 3630 2c0a 2020 2020 2020 2020 2020 2020  60,.            
+00001d00: 2020 2020 2020 2020 2020 2020 3136 322c              162,
+00001d10: 2031 3634 2c20 3136 362c 2031 3638 2c20   164, 166, 168, 
+00001d20: 3137 302c 2031 3731 2c20 3137 332c 2031  170, 171, 173, 1
+00001d30: 3734 2c20 3137 362c 2031 3738 2c20 3137  74, 176, 178, 17
+00001d40: 392c 2031 3830 2c20 3138 322c 0a20 2020  9, 180, 182,.   
 00001d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001d60: 2020 2031 3632 2c20 3136 342c 2031 3636     162, 164, 166
-00001d70: 2c20 3136 382c 2031 3730 2c20 3137 312c  , 168, 170, 171,
-00001d80: 2031 3733 2c20 3137 342c 2031 3736 2c20   173, 174, 176, 
-00001d90: 3137 382c 2031 3739 2c20 3138 302c 2031  178, 179, 180, 1
-00001da0: 3832 2c0a 2020 2020 2020 2020 2020 2020  82,.            
-00001db0: 2020 2020 2020 2020 2020 2020 3138 332c              183,
-00001dc0: 2031 3835 2c20 3138 362c 2031 3839 2c20   185, 186, 189, 
-00001dd0: 3139 322c 2031 3933 2c20 3139 332c 2031  192, 193, 193, 1
-00001de0: 3934 2c20 3139 352c 2031 3935 2c20 3139  94, 195, 195, 19
-00001df0: 362c 2031 3938 2c20 3139 392c 0a20 2020  6, 198, 199,.   
+00001d60: 2020 2020 2031 3833 2c20 3138 352c 2031       183, 185, 1
+00001d70: 3836 2c20 3138 392c 2031 3932 2c20 3139  86, 189, 192, 19
+00001d80: 332c 2031 3933 2c20 3139 342c 2031 3935  3, 193, 194, 195
+00001d90: 2c20 3139 352c 2031 3936 2c20 3139 382c  , 195, 196, 198,
+00001da0: 2031 3939 2c0a 2020 2020 2020 2020 2020   199,.          
+00001db0: 2020 2020 2020 2020 2020 2020 2020 3230                20
+00001dc0: 312c 2032 3033 2c20 3230 342c 2032 3034  1, 203, 204, 204
+00001dd0: 2c20 3230 352c 2032 3036 2c20 3230 372c  , 205, 206, 207,
+00001de0: 2032 3039 2c20 3231 312c 2032 3131 2c20   209, 211, 211, 
+00001df0: 3231 312c 2032 3131 2c20 3231 332c 0a20  211, 211, 213,. 
 00001e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001e10: 2020 2020 2032 3031 2c20 3230 332c 2032       201, 203, 2
-00001e20: 3034 2c20 3230 342c 2032 3035 2c20 3230  04, 204, 205, 20
-00001e30: 362c 2032 3037 2c20 3230 392c 2032 3131  6, 207, 209, 211
-00001e40: 2c20 3231 312c 2032 3131 2c20 3231 312c  , 211, 211, 211,
-00001e50: 2032 3133 2c0a 2020 2020 2020 2020 2020   213,.          
-00001e60: 2020 2020 2020 2020 2020 2020 2020 3231                21
-00001e70: 352c 2032 3136 2c20 3231 362c 2032 3136  5, 216, 216, 216
-00001e80: 2c20 3231 362c 2032 3138 2c20 3231 392c  , 216, 218, 219,
-00001e90: 2032 3139 2c20 3231 392c 2032 3230 2c20   219, 219, 220, 
-00001ea0: 3232 322c 2032 3233 2c20 3232 332c 0a20  222, 223, 223,. 
-00001eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001ec0: 2020 2020 2020 2032 3233 2c20 3232 332c         223, 223,
-00001ed0: 2032 3234 2c20 3232 342c 2032 3236 2c20   224, 224, 226, 
-00001ee0: 3232 372c 2032 3237 2c20 3232 372c 2032  227, 227, 227, 2
-00001ef0: 3237 2c20 3232 382c 2032 3239 2c20 3233  27, 228, 229, 23
-00001f00: 312c 2032 3331 2c0a 2020 2020 2020 2020  1, 231,.        
+00001e10: 2020 2020 2020 2032 3135 2c20 3231 362c         215, 216,
+00001e20: 2032 3136 2c20 3231 362c 2032 3136 2c20   216, 216, 216, 
+00001e30: 3231 382c 2032 3139 2c20 3231 392c 2032  218, 219, 219, 2
+00001e40: 3139 2c20 3232 302c 2032 3232 2c20 3232  19, 220, 222, 22
+00001e50: 332c 2032 3233 2c0a 2020 2020 2020 2020  3, 223,.        
+00001e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001e70: 3232 332c 2032 3233 2c20 3232 342c 2032  223, 223, 224, 2
+00001e80: 3234 2c20 3232 362c 2032 3237 2c20 3232  24, 226, 227, 22
+00001e90: 372c 2032 3237 2c20 3232 372c 2032 3238  7, 227, 227, 228
+00001ea0: 2c20 3232 392c 2032 3331 2c20 3233 312c  , 229, 231, 231,
+00001eb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00001ec0: 2020 2020 2020 2020 2032 3331 2c20 3233           231, 23
+00001ed0: 312c 2032 3331 2c20 3233 312c 2032 3331  1, 231, 231, 231
+00001ee0: 2c20 3233 322c 2032 3333 2c20 3233 342c  , 232, 233, 234,
+00001ef0: 2032 3334 2c20 3233 342c 2032 3334 2c20   234, 234, 234, 
+00001f00: 3233 342c 2032 3334 2c0a 2020 2020 2020  234, 234,.      
 00001f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001f20: 3233 312c 2032 3331 2c20 3233 312c 2032  231, 231, 231, 2
-00001f30: 3331 2c20 3233 312c 2032 3332 2c20 3233  31, 231, 232, 23
-00001f40: 332c 2032 3334 2c20 3233 342c 2032 3334  3, 234, 234, 234
-00001f50: 2c20 3233 342c 2032 3334 2c20 3233 342c  , 234, 234, 234,
-00001f60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00001f70: 2020 2020 2020 2020 2032 3335 2c20 3233           235, 23
-00001f80: 372c 2032 3338 2c20 3233 382c 2032 3338  7, 238, 238, 238
-00001f90: 2c20 3233 382c 2032 3338 2c20 3233 382c  , 238, 238, 238,
-00001fa0: 2032 3338 2c20 3233 382c 2032 3339 2c20   238, 238, 239, 
-00001fb0: 3234 302c 2032 3432 2c0a 2020 2020 2020  240, 242,.      
+00001f20: 2020 3233 352c 2032 3337 2c20 3233 382c    235, 237, 238,
+00001f30: 2032 3338 2c20 3233 382c 2032 3338 2c20   238, 238, 238, 
+00001f40: 3233 382c 2032 3338 2c20 3233 382c 2032  238, 238, 238, 2
+00001f50: 3338 2c20 3233 392c 2032 3430 2c20 3234  38, 239, 240, 24
+00001f60: 322c 0a20 2020 2020 2020 2020 2020 2020  2,.             
+00001f70: 2020 2020 2020 2020 2020 2032 3432 2c20             242, 
+00001f80: 3234 322c 2032 3432 2c20 3234 322c 2032  242, 242, 242, 2
+00001f90: 3432 2c20 3234 322c 2032 3432 2c20 3234  42, 242, 242, 24
+00001fa0: 322c 2032 3433 2c20 3234 352c 2032 3436  2, 243, 245, 246
+00001fb0: 2c20 3234 362c 2032 3436 2c0a 2020 2020  , 246, 246,.    
 00001fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001fd0: 2020 3234 322c 2032 3432 2c20 3234 322c    242, 242, 242,
-00001fe0: 2032 3432 2c20 3234 322c 2032 3432 2c20   242, 242, 242, 
-00001ff0: 3234 322c 2032 3432 2c20 3234 332c 2032  242, 242, 243, 2
-00002000: 3435 2c20 3234 362c 2032 3436 2c20 3234  45, 246, 246, 24
-00002010: 362c 0a20 2020 2020 2020 2020 2020 2020  6,.             
-00002020: 2020 2020 2020 2020 2020 2032 3436 2c20             246, 
-00002030: 3234 352c 2032 3435 2c20 3234 352c 2032  245, 245, 245, 2
-00002040: 3435 2c20 3234 352c 2032 3435 2c20 3234  45, 245, 245, 24
-00002050: 352c 2032 3437 2c20 3234 382c 2032 3439  5, 247, 248, 249
-00002060: 2c20 3234 392c 2032 3439 2c0a 2020 2020  , 249, 249,.    
+00001fd0: 2020 2020 3234 362c 2032 3435 2c20 3234      246, 245, 24
+00001fe0: 352c 2032 3435 2c20 3234 352c 2032 3435  5, 245, 245, 245
+00001ff0: 2c20 3234 352c 2032 3435 2c20 3234 372c  , 245, 245, 247,
+00002000: 2032 3438 2c20 3234 392c 2032 3439 2c20   248, 249, 249, 
+00002010: 3234 392c 0a20 2020 2020 2020 2020 2020  249,.           
+00002020: 2020 2020 2020 2020 2020 2020 2032 3439               249
+00002030: 2c20 3234 392c 2032 3439 2c20 3234 392c  , 249, 249, 249,
+00002040: 2032 3439 2c20 3234 392c 2032 3439 2c20   249, 249, 249, 
+00002050: 3234 392c 2032 3439 2c20 3234 392c 2032  249, 249, 249, 2
+00002060: 3439 2c20 3234 392c 2032 3439 2c0a 2020  49, 249, 249,.  
 00002070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002080: 2020 2020 3234 392c 2032 3439 2c20 3234      249, 249, 24
-00002090: 392c 2032 3439 2c20 3234 392c 2032 3439  9, 249, 249, 249
-000020a0: 2c20 3234 392c 2032 3439 2c20 3234 392c  , 249, 249, 249,
-000020b0: 2032 3439 2c20 3234 392c 2032 3439 2c20   249, 249, 249, 
-000020c0: 3234 392c 0a20 2020 2020 2020 2020 2020  249,.           
-000020d0: 2020 2020 2020 2020 2020 2020 2032 3439               249
-000020e0: 2c20 3235 302c 2032 3532 2c20 3235 332c  , 250, 252, 253,
-000020f0: 2032 3533 2c20 3235 332c 2032 3533 2c20   253, 253, 253, 
-00002100: 3235 332c 2032 3533 2c20 3235 332c 2032  253, 253, 253, 2
-00002110: 3533 2c20 3235 332c 2032 3533 2c0a 2020  53, 253, 253,.  
+00002080: 2020 2020 2020 3234 392c 2032 3530 2c20        249, 250, 
+00002090: 3235 322c 2032 3533 2c20 3235 332c 2032  252, 253, 253, 2
+000020a0: 3533 2c20 3235 332c 2032 3533 2c20 3235  53, 253, 253, 25
+000020b0: 332c 2032 3533 2c20 3235 332c 2032 3533  3, 253, 253, 253
+000020c0: 2c20 3235 332c 0a20 2020 2020 2020 2020  , 253,.         
+000020d0: 2020 2020 2020 2020 2020 2020 2020 2032                 2
+000020e0: 3533 2c20 3235 332c 2032 3533 2c20 3235  53, 253, 253, 25
+000020f0: 332c 2032 3533 2c20 3235 332c 2032 3533  3, 253, 253, 253
+00002100: 2c20 3235 332c 2032 3533 2c20 3235 332c  , 253, 253, 253,
+00002110: 2032 3533 2c20 3235 332c 2032 3533 2c0a   253, 253, 253,.
 00002120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002130: 2020 2020 2020 3235 332c 2032 3533 2c20        253, 253, 
-00002140: 3235 332c 2032 3533 2c20 3235 332c 2032  253, 253, 253, 2
-00002150: 3533 2c20 3235 332c 2032 3533 2c20 3235  53, 253, 253, 25
-00002160: 332c 2032 3533 2c20 3235 332c 2032 3533  3, 253, 253, 253
-00002170: 2c20 3235 332c 0a20 2020 2020 2020 2020  , 253,.         
-00002180: 2020 2020 2020 2020 2020 2020 2020 2032                 2
-00002190: 3533 2c20 3235 332c 2032 3533 2c20 3235  53, 253, 253, 25
-000021a0: 332c 2032 3533 2c20 3235 332c 2032 3533  3, 253, 253, 253
-000021b0: 2c20 3235 332c 2032 3533 2c20 3235 332c  , 253, 253, 253,
-000021c0: 2032 3533 2c20 3235 332c 2032 3533 2c0a   253, 253, 253,.
-000021d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000021e0: 2020 2020 2020 2020 3235 332c 2032 3533          253, 253
-000021f0: 2c20 3235 332c 2032 3533 2c20 3235 332c  , 253, 253, 253,
-00002200: 2032 3533 2c20 3235 332c 2032 3533 2c20   253, 253, 253, 
-00002210: 305d 0a0a 2020 2020 2020 2020 6c75 745b  0]..        lut[
-00002220: 3a2c 2030 2c20 315d 203d 205b 3133 382c  :, 0, 1] = [138,
-00002230: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-00002240: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
-00002250: 2c20 302c 0a20 2020 2020 2020 2020 2020  , 0,.           
-00002260: 2020 2020 2020 2020 2020 2020 2031 2c20               1, 
-00002270: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
-00002280: 2c20 312c 2031 2c20 322c 2032 2c20 322c  , 1, 1, 2, 2, 2,
-00002290: 2032 2c0a 2020 2020 2020 2020 2020 2020   2,.            
-000022a0: 2020 2020 2020 2020 2020 2020 322c 2032              2, 2
-000022b0: 2c20 322c 2032 2c20 332c 2033 2c20 332c  , 2, 2, 3, 3, 3,
-000022c0: 2033 2c20 342c 2035 2c20 352c 2035 2c20   3, 4, 5, 5, 5, 
-000022d0: 352c 0a20 2020 2020 2020 2020 2020 2020  5,.             
-000022e0: 2020 2020 2020 2020 2020 2036 2c20 362c             6, 6,
-000022f0: 2036 2c20 372c 2037 2c20 382c 2039 2c20   6, 7, 7, 8, 9, 
-00002300: 392c 2039 2c20 392c 2031 302c 2031 302c  9, 9, 9, 10, 10,
-00002310: 2031 312c 0a20 2020 2020 2020 2020 2020   11,.           
-00002320: 2020 2020 2020 2020 2020 2020 2031 322c               12,
-00002330: 2031 332c 2031 342c 2031 342c 2031 342c   13, 14, 14, 14,
-00002340: 2031 342c 2031 352c 2031 362c 2031 362c   14, 15, 16, 16,
-00002350: 2031 372c 2031 382c 2031 392c 2031 392c   17, 18, 19, 19,
-00002360: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002370: 2020 2020 2020 2020 2031 392c 2032 302c           19, 20,
-00002380: 2032 312c 2032 322c 2032 332c 2032 342c   21, 22, 23, 24,
-00002390: 2032 342c 2032 352c 2032 372c 2032 382c   24, 25, 27, 28,
-000023a0: 2032 382c 2032 382c 2032 392c 0a20 2020   28, 28, 29,.   
-000023b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000023c0: 2020 2020 2033 312c 2033 322c 2033 322c       31, 32, 32,
-000023d0: 2033 332c 2033 352c 2033 362c 2033 362c   33, 35, 36, 36,
-000023e0: 2033 372c 2033 392c 2034 302c 2034 302c   37, 39, 40, 40,
-000023f0: 2034 312c 2034 322c 0a20 2020 2020 2020   41, 42,.       
-00002400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002410: 2034 332c 2034 352c 2034 362c 2034 372c   43, 45, 46, 47,
-00002420: 2034 382c 2035 302c 2035 312c 2035 322c   48, 50, 51, 52,
-00002430: 2035 342c 2035 352c 2035 362c 2035 372c   54, 55, 56, 57,
-00002440: 2035 392c 0a20 2020 2020 2020 2020 2020   59,.           
-00002450: 2020 2020 2020 2020 2020 2020 2036 322c               62,
-00002460: 2036 332c 2036 352c 2036 362c 2036 382c   63, 65, 66, 68,
-00002470: 2037 302c 2037 312c 2037 332c 2037 342c   70, 71, 73, 74,
-00002480: 2037 352c 2037 372c 2037 392c 2038 312c   75, 77, 79, 81,
-00002490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000024a0: 2020 2020 2020 2020 2038 332c 2038 352c           83, 85,
-000024b0: 2038 372c 2038 392c 2039 322c 2039 332c   87, 89, 92, 93,
-000024c0: 2039 362c 2039 382c 2039 392c 2031 3030   96, 98, 99, 100
-000024d0: 2c20 3130 332c 2031 3035 2c20 3130 372c  , 103, 105, 107,
-000024e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000024f0: 2020 2020 2020 2020 2031 3039 2c20 3131           109, 11
-00002500: 312c 2031 3133 2c20 3131 362c 2031 3137  1, 113, 116, 117
-00002510: 2c20 3131 392c 2031 3231 2c20 3132 332c  , 119, 121, 123,
-00002520: 2031 3235 2c20 3132 362c 2031 3238 2c20   125, 126, 128, 
-00002530: 3133 302c 2031 3332 2c0a 2020 2020 2020  130, 132,.      
+00002130: 2020 2020 2020 2020 3235 332c 2032 3533          253, 253
+00002140: 2c20 3235 332c 2032 3533 2c20 3235 332c  , 253, 253, 253,
+00002150: 2032 3533 2c20 3235 332c 2032 3533 2c20   253, 253, 253, 
+00002160: 3235 332c 2032 3533 2c20 3235 332c 2032  253, 253, 253, 2
+00002170: 3533 2c20 3235 332c 0a20 2020 2020 2020  53, 253,.       
+00002180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002190: 2032 3533 2c20 3235 332c 2032 3533 2c20   253, 253, 253, 
+000021a0: 3235 332c 2032 3533 2c20 3235 332c 2032  253, 253, 253, 2
+000021b0: 3533 2c20 3235 332c 2030 5d0a 0a20 2020  53, 253, 0]..   
+000021c0: 2020 2020 206c 7574 5b3a 2c20 302c 2031       lut[:, 0, 1
+000021d0: 5d20 3d20 5b31 3338 2c20 302c 2030 2c20  ] = [138, 0, 0, 
+000021e0: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+000021f0: 2c20 302c 2030 2c20 302c 2030 2c0a 2020  , 0, 0, 0, 0,.  
+00002200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002210: 2020 2020 2020 312c 2031 2c20 312c 2031        1, 1, 1, 1
+00002220: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
+00002230: 2032 2c20 322c 2032 2c20 322c 0a20 2020   2, 2, 2, 2,.   
+00002240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002250: 2020 2020 2032 2c20 322c 2032 2c20 322c       2, 2, 2, 2,
+00002260: 2033 2c20 332c 2033 2c20 332c 2034 2c20   3, 3, 3, 3, 4, 
+00002270: 352c 2035 2c20 352c 2035 2c0a 2020 2020  5, 5, 5, 5,.    
+00002280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002290: 2020 2020 362c 2036 2c20 362c 2037 2c20      6, 6, 6, 7, 
+000022a0: 372c 2038 2c20 392c 2039 2c20 392c 2039  7, 8, 9, 9, 9, 9
+000022b0: 2c20 3130 2c20 3130 2c20 3131 2c0a 2020  , 10, 10, 11,.  
+000022c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000022d0: 2020 2020 2020 3132 2c20 3133 2c20 3134        12, 13, 14
+000022e0: 2c20 3134 2c20 3134 2c20 3134 2c20 3135  , 14, 14, 14, 15
+000022f0: 2c20 3136 2c20 3136 2c20 3137 2c20 3138  , 16, 16, 17, 18
+00002300: 2c20 3139 2c20 3139 2c0a 2020 2020 2020  , 19, 19,.      
+00002310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002320: 2020 3139 2c20 3230 2c20 3231 2c20 3232    19, 20, 21, 22
+00002330: 2c20 3233 2c20 3234 2c20 3234 2c20 3235  , 23, 24, 24, 25
+00002340: 2c20 3237 2c20 3238 2c20 3238 2c20 3238  , 27, 28, 28, 28
+00002350: 2c20 3239 2c0a 2020 2020 2020 2020 2020  , 29,.          
+00002360: 2020 2020 2020 2020 2020 2020 2020 3331                31
+00002370: 2c20 3332 2c20 3332 2c20 3333 2c20 3335  , 32, 32, 33, 35
+00002380: 2c20 3336 2c20 3336 2c20 3337 2c20 3339  , 36, 36, 37, 39
+00002390: 2c20 3430 2c20 3430 2c20 3431 2c20 3432  , 40, 40, 41, 42
+000023a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000023b0: 2020 2020 2020 2020 2020 3433 2c20 3435            43, 45
+000023c0: 2c20 3436 2c20 3437 2c20 3438 2c20 3530  , 46, 47, 48, 50
+000023d0: 2c20 3531 2c20 3532 2c20 3534 2c20 3535  , 51, 52, 54, 55
+000023e0: 2c20 3536 2c20 3537 2c20 3539 2c0a 2020  , 56, 57, 59,.  
+000023f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002400: 2020 2020 2020 3632 2c20 3633 2c20 3635        62, 63, 65
+00002410: 2c20 3636 2c20 3638 2c20 3730 2c20 3731  , 66, 68, 70, 71
+00002420: 2c20 3733 2c20 3734 2c20 3735 2c20 3737  , 73, 74, 75, 77
+00002430: 2c20 3739 2c20 3831 2c0a 2020 2020 2020  , 79, 81,.      
+00002440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002450: 2020 3833 2c20 3835 2c20 3837 2c20 3839    83, 85, 87, 89
+00002460: 2c20 3932 2c20 3933 2c20 3936 2c20 3938  , 92, 93, 96, 98
+00002470: 2c20 3939 2c20 3130 302c 2031 3033 2c20  , 99, 100, 103, 
+00002480: 3130 352c 2031 3037 2c0a 2020 2020 2020  105, 107,.      
+00002490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000024a0: 2020 3130 392c 2031 3131 2c20 3131 332c    109, 111, 113,
+000024b0: 2031 3136 2c20 3131 372c 2031 3139 2c20   116, 117, 119, 
+000024c0: 3132 312c 2031 3233 2c20 3132 352c 2031  121, 123, 125, 1
+000024d0: 3236 2c20 3132 382c 2031 3330 2c20 3133  26, 128, 130, 13
+000024e0: 322c 0a20 2020 2020 2020 2020 2020 2020  2,.             
+000024f0: 2020 2020 2020 2020 2020 2031 3335 2c20             135, 
+00002500: 3133 372c 2031 3339 2c20 3134 302c 2031  137, 139, 140, 1
+00002510: 3432 2c20 3134 342c 2031 3435 2c20 3134  42, 144, 145, 14
+00002520: 372c 2031 3438 2c20 3135 302c 2031 3532  7, 148, 150, 152
+00002530: 2c20 3135 342c 2031 3536 2c0a 2020 2020  , 154, 156,.    
 00002540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002550: 2020 3133 352c 2031 3337 2c20 3133 392c    135, 137, 139,
-00002560: 2031 3430 2c20 3134 322c 2031 3434 2c20   140, 142, 144, 
-00002570: 3134 352c 2031 3437 2c20 3134 382c 2031  145, 147, 148, 1
-00002580: 3530 2c20 3135 322c 2031 3534 2c20 3135  50, 152, 154, 15
-00002590: 362c 0a20 2020 2020 2020 2020 2020 2020  6,.             
-000025a0: 2020 2020 2020 2020 2020 2031 3538 2c20             158, 
-000025b0: 3136 302c 2031 3631 2c20 3136 322c 2031  160, 161, 162, 1
-000025c0: 3634 2c20 3136 362c 2031 3638 2c20 3137  64, 166, 168, 17
-000025d0: 312c 2031 3732 2c20 3137 322c 2031 3734  1, 172, 172, 174
-000025e0: 2c20 3137 362c 2031 3737 2c0a 2020 2020  , 176, 177,.    
+00002550: 2020 2020 3135 382c 2031 3630 2c20 3136      158, 160, 16
+00002560: 312c 2031 3632 2c20 3136 342c 2031 3636  1, 162, 164, 166
+00002570: 2c20 3136 382c 2031 3731 2c20 3137 322c  , 168, 171, 172,
+00002580: 2031 3732 2c20 3137 342c 2031 3736 2c20   172, 174, 176, 
+00002590: 3137 372c 0a20 2020 2020 2020 2020 2020  177,.           
+000025a0: 2020 2020 2020 2020 2020 2020 2031 3739               179
+000025b0: 2c20 3138 302c 2031 3832 2c20 3138 332c  , 180, 182, 183,
+000025c0: 2031 3835 2c20 3138 372c 2031 3838 2c20   185, 187, 188, 
+000025d0: 3138 392c 2031 3931 2c20 3139 322c 2031  189, 191, 192, 1
+000025e0: 3932 2c20 3139 322c 2031 3936 2c0a 2020  92, 192, 196,.  
 000025f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002600: 2020 2020 3137 392c 2031 3830 2c20 3138      179, 180, 18
-00002610: 322c 2031 3833 2c20 3138 352c 2031 3837  2, 183, 185, 187
-00002620: 2c20 3138 382c 2031 3839 2c20 3139 312c  , 188, 189, 191,
-00002630: 2031 3932 2c20 3139 322c 2031 3932 2c20   192, 192, 192, 
-00002640: 3139 362c 0a20 2020 2020 2020 2020 2020  196,.           
-00002650: 2020 2020 2020 2020 2020 2020 2032 3030               200
-00002660: 2c20 3230 312c 2032 3031 2c20 3230 322c  , 201, 201, 202,
-00002670: 2032 3033 2c20 3230 342c 2032 3036 2c20   203, 204, 206, 
-00002680: 3230 382c 2032 3130 2c20 3231 322c 2032  208, 210, 212, 2
-00002690: 3133 2c20 3231 332c 2032 3134 2c0a 2020  13, 213, 214,.  
+00002600: 2020 2020 2020 3230 302c 2032 3031 2c20        200, 201, 
+00002610: 3230 312c 2032 3032 2c20 3230 332c 2032  201, 202, 203, 2
+00002620: 3034 2c20 3230 362c 2032 3038 2c20 3231  04, 206, 208, 21
+00002630: 302c 2032 3132 2c20 3231 332c 2032 3133  0, 212, 213, 213
+00002640: 2c20 3231 342c 0a20 2020 2020 2020 2020  , 214,.         
+00002650: 2020 2020 2020 2020 2020 2020 2020 2032                 2
+00002660: 3135 2c20 3231 372c 2032 3138 2c20 3232  15, 217, 218, 22
+00002670: 302c 2032 3231 2c20 3232 322c 2032 3233  0, 221, 222, 223
+00002680: 2c20 3232 342c 2032 3235 2c20 3232 362c  , 224, 225, 226,
+00002690: 2032 3236 2c20 3232 372c 2032 3238 2c0a   226, 227, 228,.
 000026a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000026b0: 2020 2020 2020 3231 352c 2032 3137 2c20        215, 217, 
-000026c0: 3231 382c 2032 3230 2c20 3232 312c 2032  218, 220, 221, 2
-000026d0: 3232 2c20 3232 332c 2032 3234 2c20 3232  22, 223, 224, 22
-000026e0: 352c 2032 3236 2c20 3232 362c 2032 3237  5, 226, 226, 227
-000026f0: 2c20 3232 382c 0a20 2020 2020 2020 2020  , 228,.         
-00002700: 2020 2020 2020 2020 2020 2020 2020 2032                 2
-00002710: 3239 2c20 3233 312c 2032 3332 2c20 3233  29, 231, 232, 23
-00002720: 332c 2032 3334 2c20 3233 352c 2032 3336  3, 234, 235, 236
-00002730: 2c20 3233 372c 2032 3338 2c20 3233 392c  , 237, 238, 239,
-00002740: 2032 3339 2c20 3233 392c 2032 3339 2c0a   239, 239, 239,.
-00002750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002760: 2020 2020 2020 2020 3234 312c 2032 3432          241, 242
-00002770: 2c20 3234 332c 2032 3433 2c20 3234 332c  , 243, 243, 243,
-00002780: 2032 3434 2c20 3234 352c 2032 3437 2c20   244, 245, 247, 
-00002790: 3234 372c 2032 3437 2c20 3234 372c 2032  247, 247, 247, 2
-000027a0: 3437 2c20 3234 372c 0a20 2020 2020 2020  47, 247,.       
+000026b0: 2020 2020 2020 2020 3232 392c 2032 3331          229, 231
+000026c0: 2c20 3233 322c 2032 3333 2c20 3233 342c  , 232, 233, 234,
+000026d0: 2032 3335 2c20 3233 362c 2032 3337 2c20   235, 236, 237, 
+000026e0: 3233 382c 2032 3339 2c20 3233 392c 2032  238, 239, 239, 2
+000026f0: 3339 2c20 3233 392c 0a20 2020 2020 2020  39, 239,.       
+00002700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002710: 2032 3431 2c20 3234 322c 2032 3433 2c20   241, 242, 243, 
+00002720: 3234 332c 2032 3433 2c20 3234 342c 2032  243, 243, 244, 2
+00002730: 3435 2c20 3234 372c 2032 3437 2c20 3234  45, 247, 247, 24
+00002740: 372c 2032 3437 2c20 3234 372c 2032 3437  7, 247, 247, 247
+00002750: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00002760: 2020 2020 2020 2020 2020 3234 382c 2032            248, 2
+00002770: 3439 2c20 3235 302c 2032 3531 2c20 3235  49, 250, 251, 25
+00002780: 312c 2032 3531 2c20 3235 322c 2032 3532  1, 251, 252, 252
+00002790: 2c20 3235 322c 2032 3532 2c20 3235 322c  , 252, 252, 252,
+000027a0: 2032 3532 2c20 3235 322c 0a20 2020 2020   252, 252,.     
 000027b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000027c0: 2032 3438 2c20 3234 392c 2032 3530 2c20   248, 249, 250, 
-000027d0: 3235 312c 2032 3531 2c20 3235 312c 2032  251, 251, 251, 2
-000027e0: 3532 2c20 3235 322c 2032 3532 2c20 3235  52, 252, 252, 25
-000027f0: 322c 2032 3532 2c20 3235 322c 2032 3532  2, 252, 252, 252
-00002800: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00002810: 2020 2020 2020 2020 2020 3235 322c 2032            252, 2
-00002820: 3532 2c20 3235 322c 2032 3532 2c20 3235  52, 252, 252, 25
-00002830: 322c 2032 3532 2c20 3235 332c 2032 3533  2, 252, 253, 253
-00002840: 2c20 305d 0a0a 2020 2020 2020 2020 6c75  , 0]..        lu
-00002850: 745b 3a2c 2030 2c20 305d 203d 205b 302c  t[:, 0, 0] = [0,
-00002860: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-00002870: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
-00002880: 2c20 302c 0a20 2020 2020 2020 2020 2020  , 0,.           
-00002890: 2020 2020 2020 2020 2020 2020 2031 2c20               1, 
-000028a0: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
-000028b0: 2c20 312c 2031 2c20 312c 2033 2c20 342c  , 1, 1, 1, 3, 4,
-000028c0: 2034 2c0a 2020 2020 2020 2020 2020 2020   4,.            
-000028d0: 2020 2020 2020 2020 2020 2020 342c 2034              4, 4
-000028e0: 2c20 342c 2034 2c20 332c 2033 2c20 332c  , 4, 4, 3, 3, 3,
-000028f0: 2033 2c20 342c 2036 2c20 362c 2036 2c20   3, 4, 6, 6, 6, 
-00002900: 362c 0a20 2020 2020 2020 2020 2020 2020  6,.             
-00002910: 2020 2020 2020 2020 2020 2036 2c20 362c             6, 6,
-00002920: 2036 2c20 362c 2036 2c20 362c 2036 2c20   6, 6, 6, 6, 6, 
-00002930: 362c 2036 2c20 362c 2036 2c20 362c 2036  6, 6, 6, 6, 6, 6
-00002940: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00002950: 2020 2020 2020 2020 2020 362c 2036 2c20            6, 6, 
-00002960: 362c 2036 2c20 362c 2036 2c20 362c 2036  6, 6, 6, 6, 6, 6
-00002970: 2c20 352c 2035 2c20 372c 2039 2c20 3130  , 5, 5, 7, 9, 10
-00002980: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00002990: 2020 2020 2020 2020 2020 3130 2c20 3130            10, 10
-000029a0: 2c20 3130 2c20 3130 2c20 3130 2c20 3130  , 10, 10, 10, 10
-000029b0: 2c20 3130 2c20 3130 2c20 3130 2c20 3130  , 10, 10, 10, 10
-000029c0: 2c20 3130 2c20 3130 2c20 3130 2c0a 2020  , 10, 10, 10,.  
-000029d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000029e0: 2020 2020 2020 3130 2c20 3130 2c20 3130        10, 10, 10
-000029f0: 2c20 392c 2039 2c20 392c 2039 2c20 392c  , 9, 9, 9, 9, 9,
-00002a00: 2039 2c20 392c 2039 2c20 392c 2039 2c0a   9, 9, 9, 9, 9,.
-00002a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002a20: 2020 2020 2020 2020 392c 2039 2c20 392c          9, 9, 9,
-00002a30: 2039 2c20 382c 2038 2c20 382c 2038 2c20   9, 8, 8, 8, 8, 
-00002a40: 382c 2038 2c20 382c 2038 2c20 382c 0a20  8, 8, 8, 8, 8,. 
-00002a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002a60: 2020 2020 2020 2038 2c20 382c 2038 2c20         8, 8, 8, 
-00002a70: 382c 2038 2c20 382c 2038 2c20 382c 2037  8, 8, 8, 8, 8, 7
-00002a80: 2c20 372c 2037 2c20 372c 2037 2c0a 2020  , 7, 7, 7, 7,.  
-00002a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002aa0: 2020 2020 2020 372c 2037 2c20 372c 2037        7, 7, 7, 7
-00002ab0: 2c20 372c 2037 2c20 372c 2037 2c20 372c  , 7, 7, 7, 7, 7,
-00002ac0: 2037 2c20 362c 2036 2c20 362c 0a20 2020   7, 6, 6, 6,.   
-00002ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002ae0: 2020 2020 2036 2c20 362c 2036 2c20 362c       6, 6, 6, 6,
-00002af0: 2037 2c20 3130 2c20 3132 2c20 3132 2c20   7, 10, 12, 12, 
-00002b00: 3132 2c20 3132 2c20 3132 2c20 3132 2c20  12, 12, 12, 12, 
-00002b10: 3133 2c0a 2020 2020 2020 2020 2020 2020  13,.            
-00002b20: 2020 2020 2020 2020 2020 2020 3135 2c20              15, 
-00002b30: 3137 2c20 3138 2c20 3138 2c20 3139 2c20  17, 18, 18, 19, 
-00002b40: 3230 2c20 3232 2c20 3233 2c20 3233 2c20  20, 22, 23, 23, 
-00002b50: 3234 2c20 3236 2c20 3237 2c20 3237 2c0a  24, 26, 27, 27,.
-00002b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002b70: 2020 2020 2020 2020 3238 2c20 3330 2c20          28, 30, 
-00002b80: 3332 2c20 3333 2c20 3334 2c20 3335 2c20  32, 33, 34, 35, 
-00002b90: 3337 2c20 3339 2c20 3430 2c20 3431 2c20  37, 39, 40, 41, 
-00002ba0: 3433 2c20 3435 2c20 3436 2c0a 2020 2020  43, 45, 46,.    
-00002bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002bc0: 2020 2020 3438 2c20 3530 2c20 3532 2c20      48, 50, 52, 
-00002bd0: 3534 2c20 3535 2c20 3537 2c20 3538 2c20  54, 55, 57, 58, 
-00002be0: 3631 2c20 3633 2c20 3635 2c20 3637 2c20  61, 63, 65, 67, 
-00002bf0: 3730 2c20 3732 2c0a 2020 2020 2020 2020  70, 72,.        
-00002c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002c10: 3733 2c20 3736 2c20 3739 2c20 3830 2c20  73, 76, 79, 80, 
-00002c20: 3833 2c20 3836 2c20 3838 2c20 3839 2c20  83, 86, 88, 89, 
-00002c30: 3932 2c20 3935 2c20 3936 2c20 3939 2c20  92, 95, 96, 99, 
-00002c40: 3130 322c 0a20 2020 2020 2020 2020 2020  102,.           
-00002c50: 2020 2020 2020 2020 2020 2020 2031 3034               104
-00002c60: 2c20 3130 372c 2031 3038 2c20 3131 302c  , 107, 108, 110,
-00002c70: 2031 3133 2c20 3131 362c 2031 3230 2c20   113, 116, 120, 
-00002c80: 3132 312c 2031 3233 2c20 3132 352c 2031  121, 123, 125, 1
-00002c90: 3237 2c20 3132 392c 2031 3332 2c0a 2020  27, 129, 132,.  
+000027c0: 2020 2032 3532 2c20 3235 322c 2032 3532     252, 252, 252
+000027d0: 2c20 3235 322c 2032 3532 2c20 3235 322c  , 252, 252, 252,
+000027e0: 2032 3533 2c20 3235 332c 2030 5d0a 0a20   253, 253, 0].. 
+000027f0: 2020 2020 2020 206c 7574 5b3a 2c20 302c         lut[:, 0,
+00002800: 2030 5d20 3d20 5b30 2c20 302c 2030 2c20   0] = [0, 0, 0, 
+00002810: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+00002820: 2c20 302c 2030 2c20 302c 2030 2c0a 2020  , 0, 0, 0, 0,.  
+00002830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002840: 2020 2020 2020 312c 2031 2c20 312c 2031        1, 1, 1, 1
+00002850: 2c20 312c 2031 2c20 312c 2031 2c20 312c  , 1, 1, 1, 1, 1,
+00002860: 2031 2c20 332c 2034 2c20 342c 0a20 2020   1, 3, 4, 4,.   
+00002870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002880: 2020 2020 2034 2c20 342c 2034 2c20 342c       4, 4, 4, 4,
+00002890: 2033 2c20 332c 2033 2c20 332c 2034 2c20   3, 3, 3, 3, 4, 
+000028a0: 362c 2036 2c20 362c 2036 2c0a 2020 2020  6, 6, 6, 6,.    
+000028b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000028c0: 2020 2020 362c 2036 2c20 362c 2036 2c20      6, 6, 6, 6, 
+000028d0: 362c 2036 2c20 362c 2036 2c20 362c 2036  6, 6, 6, 6, 6, 6
+000028e0: 2c20 362c 2036 2c20 362c 0a20 2020 2020  , 6, 6, 6,.     
+000028f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002900: 2020 2036 2c20 362c 2036 2c20 362c 2036     6, 6, 6, 6, 6
+00002910: 2c20 362c 2036 2c20 362c 2035 2c20 352c  , 6, 6, 6, 5, 5,
+00002920: 2037 2c20 392c 2031 302c 0a20 2020 2020   7, 9, 10,.     
+00002930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002940: 2020 2031 302c 2031 302c 2031 302c 2031     10, 10, 10, 1
+00002950: 302c 2031 302c 2031 302c 2031 302c 2031  0, 10, 10, 10, 1
+00002960: 302c 2031 302c 2031 302c 2031 302c 2031  0, 10, 10, 10, 1
+00002970: 302c 2031 302c 0a20 2020 2020 2020 2020  0, 10,.         
+00002980: 2020 2020 2020 2020 2020 2020 2020 2031                 1
+00002990: 302c 2031 302c 2031 302c 2039 2c20 392c  0, 10, 10, 9, 9,
+000029a0: 2039 2c20 392c 2039 2c20 392c 2039 2c20   9, 9, 9, 9, 9, 
+000029b0: 392c 2039 2c20 392c 0a20 2020 2020 2020  9, 9, 9,.       
+000029c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000029d0: 2039 2c20 392c 2039 2c20 392c 2038 2c20   9, 9, 9, 9, 8, 
+000029e0: 382c 2038 2c20 382c 2038 2c20 382c 2038  8, 8, 8, 8, 8, 8
+000029f0: 2c20 382c 2038 2c0a 2020 2020 2020 2020  , 8, 8,.        
+00002a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002a10: 382c 2038 2c20 382c 2038 2c20 382c 2038  8, 8, 8, 8, 8, 8
+00002a20: 2c20 382c 2038 2c20 372c 2037 2c20 372c  , 8, 8, 7, 7, 7,
+00002a30: 2037 2c20 372c 0a20 2020 2020 2020 2020   7, 7,.         
+00002a40: 2020 2020 2020 2020 2020 2020 2020 2037                 7
+00002a50: 2c20 372c 2037 2c20 372c 2037 2c20 372c  , 7, 7, 7, 7, 7,
+00002a60: 2037 2c20 372c 2037 2c20 372c 2036 2c20   7, 7, 7, 7, 6, 
+00002a70: 362c 2036 2c0a 2020 2020 2020 2020 2020  6, 6,.          
+00002a80: 2020 2020 2020 2020 2020 2020 2020 362c                6,
+00002a90: 2036 2c20 362c 2036 2c20 372c 2031 302c   6, 6, 6, 7, 10,
+00002aa0: 2031 322c 2031 322c 2031 322c 2031 322c   12, 12, 12, 12,
+00002ab0: 2031 322c 2031 322c 2031 332c 0a20 2020   12, 12, 13,.   
+00002ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002ad0: 2020 2020 2031 352c 2031 372c 2031 382c       15, 17, 18,
+00002ae0: 2031 382c 2031 392c 2032 302c 2032 322c   18, 19, 20, 22,
+00002af0: 2032 332c 2032 332c 2032 342c 2032 362c   23, 23, 24, 26,
+00002b00: 2032 372c 2032 372c 0a20 2020 2020 2020   27, 27,.       
+00002b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002b20: 2032 382c 2033 302c 2033 322c 2033 332c   28, 30, 32, 33,
+00002b30: 2033 342c 2033 352c 2033 372c 2033 392c   34, 35, 37, 39,
+00002b40: 2034 302c 2034 312c 2034 332c 2034 352c   40, 41, 43, 45,
+00002b50: 2034 362c 0a20 2020 2020 2020 2020 2020   46,.           
+00002b60: 2020 2020 2020 2020 2020 2020 2034 382c               48,
+00002b70: 2035 302c 2035 322c 2035 342c 2035 352c   50, 52, 54, 55,
+00002b80: 2035 372c 2035 382c 2036 312c 2036 332c   57, 58, 61, 63,
+00002b90: 2036 352c 2036 372c 2037 302c 2037 322c   65, 67, 70, 72,
+00002ba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00002bb0: 2020 2020 2020 2020 2037 332c 2037 362c           73, 76,
+00002bc0: 2037 392c 2038 302c 2038 332c 2038 362c   79, 80, 83, 86,
+00002bd0: 2038 382c 2038 392c 2039 322c 2039 352c   88, 89, 92, 95,
+00002be0: 2039 362c 2039 392c 2031 3032 2c0a 2020   96, 99, 102,.  
+00002bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002c00: 2020 2020 2020 3130 342c 2031 3037 2c20        104, 107, 
+00002c10: 3130 382c 2031 3130 2c20 3131 332c 2031  108, 110, 113, 1
+00002c20: 3136 2c20 3132 302c 2031 3231 2c20 3132  16, 120, 121, 12
+00002c30: 332c 2031 3235 2c20 3132 372c 2031 3239  3, 125, 127, 129
+00002c40: 2c20 3133 322c 0a20 2020 2020 2020 2020  , 132,.         
+00002c50: 2020 2020 2020 2020 2020 2020 2020 2031                 1
+00002c60: 3335 2c20 3133 372c 2031 3430 2c20 3134  35, 137, 140, 14
+00002c70: 332c 2031 3436 2c20 3134 392c 2031 3530  3, 146, 149, 150
+00002c80: 2c20 3135 332c 2031 3535 2c20 3135 382c  , 153, 155, 158,
+00002c90: 2031 3630 2c20 3136 322c 2031 3635 2c0a   160, 162, 165,.
 00002ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002cb0: 2020 2020 2020 3133 352c 2031 3337 2c20        135, 137, 
-00002cc0: 3134 302c 2031 3433 2c20 3134 362c 2031  140, 143, 146, 1
-00002cd0: 3439 2c20 3135 302c 2031 3533 2c20 3135  49, 150, 153, 15
-00002ce0: 352c 2031 3538 2c20 3136 302c 2031 3632  5, 158, 160, 162
-00002cf0: 2c20 3136 352c 0a20 2020 2020 2020 2020  , 165,.         
-00002d00: 2020 2020 2020 2020 2020 2020 2020 2031                 1
-00002d10: 3638 2c20 3137 312c 2031 3733 2c20 3137  68, 171, 173, 17
-00002d20: 352c 2031 3738 2c20 3138 302c 2031 3833  5, 178, 180, 183
-00002d30: 2c20 3138 362c 2031 3838 2c20 3139 312c  , 186, 188, 191,
-00002d40: 2031 3932 2c20 3139 352c 2031 3938 2c0a   192, 195, 198,.
-00002d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002d60: 2020 2020 2020 2020 3230 312c 2032 3033          201, 203
-00002d70: 2c20 3230 362c 2032 3039 2c20 3231 302c  , 206, 209, 210,
-00002d80: 2032 3133 2c20 3231 352c 2032 3138 2c20   213, 215, 218, 
-00002d90: 3232 312c 2032 3233 2c20 3232 352c 2032  221, 223, 225, 2
-00002da0: 3238 2c20 3233 312c 0a20 2020 2020 2020  28, 231,.       
-00002db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002dc0: 2032 3333 2c20 3233 362c 2032 3338 2c20   233, 236, 238, 
-00002dd0: 3234 312c 2032 3434 2c20 3234 362c 2032  241, 244, 246, 2
-00002de0: 3530 2c20 3235 322c 2032 3535 5d0a 0a20  50, 252, 255].. 
-00002df0: 2020 2020 2020 2069 6d5f 636f 6c6f 7220         im_color 
-00002e00: 3d20 6376 322e 6170 706c 7943 6f6c 6f72  = cv2.applyColor
-00002e10: 4d61 7028 696d 5f67 7261 792c 206c 7574  Map(im_gray, lut
-00002e20: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00002e30: 2069 6d5f 636f 6c6f 720a 0a20 2020 2064   im_color..    d
-00002e40: 6566 206d 6f64 7265 6468 6f74 2873 656c  ef modredhot(sel
-00002e50: 662c 2069 6d5f 6772 6179 293a 0a20 2020  f, im_gray):.   
-00002e60: 2020 2020 2022 2222 0a0a 2020 2020 2020       """..      
-00002e70: 2020 2020 2020 4170 706c 7920 6d6f 6469        Apply modi
-00002e80: 6669 6564 2875 7365 2067 6c6f 7720 4c55  fied(use glow LU
-00002e90: 5420 6669 7273 7420 616e 6420 6c61 7374  T first and last
-00002ea0: 2076 616c 7565 2074 6f20 7265 706c 6163   value to replac
-00002eb0: 6520 7468 6520 6f72 6967 696e 616c 2072  e the original r
-00002ec0: 6829 2072 6564 2d68 6f74 204c 5554 2074  h) red-hot LUT t
-00002ed0: 6f20 7468 6520 6772 6179 2069 6d61 6765  o the gray image
-00002ee0: 0a20 2020 2020 2020 2020 2020 2063 6861  .            cha
-00002ef0: 6e6e 656c 2032 2d20 7265 643b 2063 6861  nnel 2- red; cha
-00002f00: 6e6e 656c 2031 2d67 7265 656e 3b20 6368  nnel 1-green; ch
-00002f10: 616e 6e65 6c20 3020 2d20 626c 7565 0a20  annel 0 - blue. 
-00002f20: 2020 2020 2020 203a 7061 7261 6d20 696d         :param im
-00002f30: 5f67 7261 793a 0a20 2020 2020 2020 203a  _gray:.        :
-00002f40: 7265 7475 726e 3a0a 2020 2020 2020 2020  return:.        
-00002f50: 2222 220a 0a20 2020 2020 2020 2023 2043  """..        # C
-00002f60: 7265 6174 6520 7468 6520 4c55 543a 0a20  reate the LUT:. 
-00002f70: 2020 2020 2020 206c 7574 203d 206e 702e         lut = np.
-00002f80: 7a65 726f 7328 2832 3536 2c20 312c 2033  zeros((256, 1, 3
-00002f90: 292c 2064 7479 7065 3d6e 702e 7569 6e74  ), dtype=np.uint
-00002fa0: 3829 0a20 2020 2020 2020 206c 7574 5b3a  8).        lut[:
-00002fb0: 2c20 302c 2032 5d20 3d20 5b30 2c20 302c  , 0, 2] = [0, 0,
-00002fc0: 2030 2c20 302c 2031 2c20 312c 2031 2c20   0, 0, 1, 1, 1, 
-00002fd0: 312c 2031 2c20 342c 2037 2c20 3130 2c20  1, 1, 4, 7, 10, 
-00002fe0: 3133 2c0a 2020 2020 2020 2020 2020 2020  13,.            
-00002ff0: 2020 2020 2020 2020 2020 2020 3136 2c20              16, 
-00003000: 3230 2c20 3233 2c20 3237 2c20 3330 2c20  20, 23, 27, 30, 
-00003010: 3333 2c20 3336 2c20 3339 2c20 3432 2c20  33, 36, 39, 42, 
-00003020: 3435 2c20 3438 2c20 3532 2c20 3535 2c0a  45, 48, 52, 55,.
-00003030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003040: 2020 2020 2020 2020 3538 2c20 3631 2c20          58, 61, 
-00003050: 3635 2c20 3638 2c20 3731 2c20 3734 2c20  65, 68, 71, 74, 
-00003060: 3738 2c20 3831 2c20 3834 2c20 3837 2c20  78, 81, 84, 87, 
-00003070: 3930 2c20 3933 2c20 3936 2c0a 2020 2020  90, 93, 96,.    
-00003080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003090: 2020 2020 3939 2c20 3130 332c 2031 3036      99, 103, 106
-000030a0: 2c20 3131 302c 2031 3133 2c20 3131 372c  , 110, 113, 117,
-000030b0: 2031 3230 2c20 3132 332c 2031 3236 2c20   120, 123, 126, 
-000030c0: 3133 302c 2031 3333 2c20 3133 362c 2031  130, 133, 136, 1
-000030d0: 3339 2c0a 2020 2020 2020 2020 2020 2020  39,.            
-000030e0: 2020 2020 2020 2020 2020 2020 3134 322c              142,
-000030f0: 2031 3435 2c20 3134 382c 2031 3531 2c20   145, 148, 151, 
-00003100: 3135 352c 2031 3538 2c20 3136 312c 2031  155, 158, 161, 1
-00003110: 3634 2c20 3136 382c 2031 3731 2c20 3137  64, 168, 171, 17
-00003120: 342c 2031 3737 2c20 3138 312c 0a20 2020  4, 177, 181,.   
-00003130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003140: 2020 2020 2031 3834 2c20 3138 372c 2031       184, 187, 1
-00003150: 3930 2c20 3139 332c 2031 3936 2c20 3230  90, 193, 196, 20
-00003160: 302c 2032 3033 2c20 3230 372c 2032 3130  0, 203, 207, 210
-00003170: 2c20 3231 332c 2032 3136 2c20 3232 302c  , 213, 216, 220,
-00003180: 2032 3233 2c0a 2020 2020 2020 2020 2020   223,.          
-00003190: 2020 2020 2020 2020 2020 2020 2020 3232                22
-000031a0: 362c 2032 3239 2c20 3233 332c 2032 3336  6, 229, 233, 236
-000031b0: 2c20 3233 392c 2032 3432 2c20 3234 352c  , 239, 242, 245,
-000031c0: 2032 3437 2c20 3235 302c 2032 3532 2c20   247, 250, 252, 
-000031d0: 3235 352c 2032 3535 2c20 3235 352c 0a20  255, 255, 255,. 
-000031e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000031f0: 2020 2020 2020 2032 3535 2c20 3235 352c         255, 255,
-00003200: 2032 3535 2c20 3235 352c 2032 3535 2c20   255, 255, 255, 
-00003210: 3235 352c 2032 3535 2c20 3235 352c 2032  255, 255, 255, 2
-00003220: 3535 2c20 3235 352c 2032 3535 2c20 3235  55, 255, 255, 25
-00003230: 352c 2032 3535 2c0a 2020 2020 2020 2020  5, 255,.        
-00003240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003250: 3235 352c 2032 3535 2c20 3235 352c 2032  255, 255, 255, 2
-00003260: 3535 2c20 3235 352c 2032 3535 2c20 3235  55, 255, 255, 25
-00003270: 352c 2032 3535 2c20 3235 352c 2032 3535  5, 255, 255, 255
-00003280: 2c20 3235 352c 2032 3535 2c20 3235 352c  , 255, 255, 255,
-00003290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000032a0: 2020 2020 2020 2020 2032 3535 2c20 3235           255, 25
-000032b0: 352c 2032 3535 2c20 3235 352c 2032 3535  5, 255, 255, 255
-000032c0: 2c20 3235 352c 2032 3535 2c20 3235 352c  , 255, 255, 255,
-000032d0: 2032 3535 2c20 3235 352c 2032 3535 2c20   255, 255, 255, 
-000032e0: 3235 352c 2032 3535 2c0a 2020 2020 2020  255, 255,.      
-000032f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003300: 2020 3235 352c 2032 3535 2c20 3235 352c    255, 255, 255,
-00003310: 2032 3535 2c20 3235 352c 2032 3535 2c20   255, 255, 255, 
-00003320: 3235 352c 2032 3535 2c20 3235 352c 2032  255, 255, 255, 2
-00003330: 3535 2c20 3235 352c 2032 3535 2c20 3235  55, 255, 255, 25
-00003340: 352c 0a20 2020 2020 2020 2020 2020 2020  5,.             
-00003350: 2020 2020 2020 2020 2020 2032 3535 2c20             255, 
-00003360: 3235 352c 2032 3535 2c20 3235 352c 2032  255, 255, 255, 2
-00003370: 3535 2c20 3235 352c 2032 3535 2c20 3235  55, 255, 255, 25
-00003380: 352c 2032 3535 2c20 3235 352c 2032 3535  5, 255, 255, 255
-00003390: 2c20 3235 352c 2032 3535 2c0a 2020 2020  , 255, 255,.    
-000033a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000033b0: 2020 2020 3235 352c 2032 3535 2c20 3235      255, 255, 25
-000033c0: 352c 2032 3535 2c20 3235 352c 2032 3535  5, 255, 255, 255
-000033d0: 2c20 3235 352c 2032 3535 2c20 3235 352c  , 255, 255, 255,
-000033e0: 2032 3535 2c20 3235 352c 2032 3535 2c20   255, 255, 255, 
-000033f0: 3235 352c 0a20 2020 2020 2020 2020 2020  255,.           
-00003400: 2020 2020 2020 2020 2020 2020 2032 3535               255
-00003410: 2c20 3235 352c 2032 3535 2c20 3235 352c  , 255, 255, 255,
-00003420: 2032 3535 2c20 3235 352c 2032 3535 2c20   255, 255, 255, 
-00003430: 3235 352c 2032 3535 2c20 3235 352c 2032  255, 255, 255, 2
-00003440: 3535 2c20 3235 352c 2032 3535 2c0a 2020  55, 255, 255,.  
-00003450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003460: 2020 2020 2020 3235 352c 2032 3535 2c20        255, 255, 
-00003470: 3235 352c 2032 3535 2c20 3235 352c 2032  255, 255, 255, 2
-00003480: 3535 2c20 3235 352c 2032 3535 2c20 3235  55, 255, 255, 25
-00003490: 352c 2032 3535 2c20 3235 352c 2032 3535  5, 255, 255, 255
-000034a0: 2c20 3235 352c 0a20 2020 2020 2020 2020  , 255,.         
-000034b0: 2020 2020 2020 2020 2020 2020 2020 2032                 2
-000034c0: 3535 2c20 3235 352c 2032 3535 2c20 3235  55, 255, 255, 25
-000034d0: 352c 2032 3535 2c20 3235 352c 2032 3535  5, 255, 255, 255
-000034e0: 2c20 3235 352c 2032 3535 2c20 3235 352c  , 255, 255, 255,
-000034f0: 2032 3535 2c20 3235 352c 2032 3535 2c0a   255, 255, 255,.
-00003500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003510: 2020 2020 2020 2020 3235 352c 2032 3535          255, 255
-00003520: 2c20 3235 352c 2032 3535 2c20 3235 352c  , 255, 255, 255,
-00003530: 2032 3535 2c20 3235 352c 2032 3535 2c20   255, 255, 255, 
-00003540: 3235 352c 2032 3535 2c20 3235 352c 2032  255, 255, 255, 2
-00003550: 3535 2c20 3235 352c 0a20 2020 2020 2020  55, 255,.       
-00003560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003570: 2032 3535 2c20 3235 352c 2032 3535 2c20   255, 255, 255, 
-00003580: 3235 352c 2032 3535 2c20 3235 352c 2032  255, 255, 255, 2
-00003590: 3535 2c20 3235 352c 2032 3535 2c20 3235  55, 255, 255, 25
-000035a0: 352c 2032 3535 2c20 3235 352c 2032 3535  5, 255, 255, 255
-000035b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000035c0: 2020 2020 2020 2020 2020 3235 352c 2032            255, 2
-000035d0: 3535 2c20 3235 352c 2032 3535 2c20 3235  55, 255, 255, 25
-000035e0: 352c 2032 3535 2c20 3235 352c 2032 3535  5, 255, 255, 255
-000035f0: 2c20 3235 352c 2032 3535 2c20 3235 352c  , 255, 255, 255,
-00003600: 2032 3535 2c20 3235 352c 0a20 2020 2020   255, 255,.     
-00003610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003620: 2020 2032 3535 2c20 3235 352c 2032 3535     255, 255, 255
-00003630: 2c20 3235 352c 2032 3535 2c20 3235 352c  , 255, 255, 255,
-00003640: 2032 3535 2c20 3235 352c 2030 0a20 2020   255, 255, 0.   
-00003650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003660: 2020 2020 205d 0a0a 2020 2020 2020 2020       ]..        
-00003670: 6c75 745b 3a2c 2030 2c20 315d 203d 205b  lut[:, 0, 1] = [
-00003680: 3133 382c 2030 2c20 302c 2030 2c20 312c  138, 0, 0, 0, 1,
-00003690: 2031 2c20 312c 2031 2c20 312c 2030 2c20   1, 1, 1, 1, 0, 
-000036a0: 302c 2030 2c20 302c 0a20 2020 2020 2020  0, 0, 0,.       
-000036b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000036c0: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-000036d0: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
-000036e0: 2c20 302c 2030 2c0a 2020 2020 2020 2020  , 0, 0,.        
-000036f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003700: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
-00003710: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-00003720: 2030 2c20 302c 0a20 2020 2020 2020 2020   0, 0,.         
-00003730: 2020 2020 2020 2020 2020 2020 2020 2030                 0
-00003740: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-00003750: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-00003760: 302c 2030 2c0a 2020 2020 2020 2020 2020  0, 0,.          
-00003770: 2020 2020 2020 2020 2020 2020 2020 302c                0,
-00003780: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-00003790: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
-000037a0: 2c20 302c 0a20 2020 2020 2020 2020 2020  , 0,.           
-000037b0: 2020 2020 2020 2020 2020 2020 2030 2c20               0, 
-000037c0: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
-000037d0: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-000037e0: 2030 2c0a 2020 2020 2020 2020 2020 2020   0,.            
-000037f0: 2020 2020 2020 2020 2020 2020 302c 2030              0, 0
-00003800: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-00003810: 2030 2c20 312c 2032 2c20 332c 2036 2c20   0, 1, 2, 3, 6, 
-00003820: 392c 0a20 2020 2020 2020 2020 2020 2020  9,.             
-00003830: 2020 2020 2020 2020 2020 2031 322c 2031             12, 1
-00003840: 362c 2031 392c 2032 322c 2032 352c 2032  6, 19, 22, 25, 2
-00003850: 392c 2033 322c 2033 352c 2033 382c 2034  9, 32, 35, 38, 4
-00003860: 322c 2034 352c 2034 382c 2035 312c 0a20  2, 45, 48, 51,. 
-00003870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003880: 2020 2020 2020 2035 352c 2035 382c 2036         55, 58, 6
-00003890: 312c 2036 342c 2036 382c 2037 312c 2037  1, 64, 68, 71, 7
-000038a0: 342c 2037 372c 2038 312c 2038 342c 2038  4, 77, 81, 84, 8
-000038b0: 372c 2039 302c 2039 342c 0a20 2020 2020  7, 90, 94,.     
-000038c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000038d0: 2020 2039 372c 2031 3030 2c20 3130 332c     97, 100, 103,
-000038e0: 2031 3036 2c20 3130 392c 2031 3132 2c20   106, 109, 112, 
-000038f0: 3131 352c 2031 3139 2c20 3132 322c 2031  115, 119, 122, 1
-00003900: 3236 2c20 3132 392c 2031 3333 2c20 3133  26, 129, 133, 13
-00003910: 362c 0a20 2020 2020 2020 2020 2020 2020  6,.             
-00003920: 2020 2020 2020 2020 2020 2031 3339 2c20             139, 
-00003930: 3134 322c 2031 3435 2c20 3134 382c 2031  142, 145, 148, 1
-00003940: 3531 2c20 3135 342c 2031 3538 2c20 3136  51, 154, 158, 16
-00003950: 312c 2031 3634 2c20 3136 372c 2031 3731  1, 164, 167, 171
-00003960: 2c20 3137 342c 2031 3737 2c0a 2020 2020  , 174, 177,.    
-00003970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003980: 2020 2020 3138 302c 2031 3834 2c20 3138      180, 184, 18
-00003990: 372c 2031 3930 2c20 3139 332c 2031 3937  7, 190, 193, 197
-000039a0: 2c20 3230 302c 2032 3033 2c20 3230 362c  , 200, 203, 206,
-000039b0: 2032 3039 2c20 3231 322c 2032 3136 2c20   209, 212, 216, 
-000039c0: 3231 392c 0a20 2020 2020 2020 2020 2020  219,.           
-000039d0: 2020 2020 2020 2020 2020 2020 2032 3233               223
-000039e0: 2c20 3232 362c 2032 3239 2c20 3233 322c  , 226, 229, 232,
-000039f0: 2032 3336 2c20 3233 392c 2032 3432 2c20   236, 239, 242, 
-00003a00: 3234 352c 2032 3439 2c20 3235 302c 2032  245, 249, 250, 2
-00003a10: 3532 2c20 3235 332c 2032 3535 2c0a 2020  52, 253, 255,.  
-00003a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003a30: 2020 2020 2020 3235 352c 2032 3535 2c20        255, 255, 
-00003a40: 3235 352c 2032 3535 2c20 3235 352c 2032  255, 255, 255, 2
-00003a50: 3535 2c20 3235 352c 2032 3535 2c20 3235  55, 255, 255, 25
-00003a60: 352c 2032 3535 2c20 3235 352c 2032 3535  5, 255, 255, 255
-00003a70: 2c20 3235 352c 0a20 2020 2020 2020 2020  , 255,.         
-00003a80: 2020 2020 2020 2020 2020 2020 2020 2032                 2
-00003a90: 3535 2c20 3235 352c 2032 3535 2c20 3235  55, 255, 255, 25
-00003aa0: 352c 2032 3535 2c20 3235 352c 2032 3535  5, 255, 255, 255
-00003ab0: 2c20 3235 352c 2032 3535 2c20 3235 352c  , 255, 255, 255,
-00003ac0: 2032 3535 2c20 3235 352c 2032 3535 2c0a   255, 255, 255,.
-00003ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003ae0: 2020 2020 2020 2020 3235 352c 2032 3535          255, 255
-00003af0: 2c20 3235 352c 2032 3535 2c20 3235 352c  , 255, 255, 255,
-00003b00: 2032 3535 2c20 3235 352c 2032 3535 2c20   255, 255, 255, 
-00003b10: 3235 352c 2032 3535 2c20 3235 352c 2032  255, 255, 255, 2
-00003b20: 3535 2c20 3235 352c 0a20 2020 2020 2020  55, 255,.       
-00003b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003b40: 2032 3535 2c20 3235 352c 2032 3535 2c20   255, 255, 255, 
-00003b50: 3235 352c 2032 3535 2c20 3235 352c 2032  255, 255, 255, 2
-00003b60: 3535 2c20 3235 352c 2032 3535 2c20 3235  55, 255, 255, 25
-00003b70: 352c 2032 3535 2c20 3235 352c 2032 3535  5, 255, 255, 255
-00003b80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00003b90: 2020 2020 2020 2020 2020 3235 352c 2032            255, 2
-00003ba0: 3535 2c20 3235 352c 2032 3535 2c20 3235  55, 255, 255, 25
-00003bb0: 352c 2032 3535 2c20 3235 352c 2032 3535  5, 255, 255, 255
-00003bc0: 2c20 3235 352c 2032 3535 2c20 3235 352c  , 255, 255, 255,
-00003bd0: 2032 3535 2c20 3235 352c 0a20 2020 2020   255, 255,.     
-00003be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003bf0: 2020 2032 3535 2c20 3235 352c 2032 3535     255, 255, 255
-00003c00: 2c20 3235 352c 2032 3535 2c20 3235 352c  , 255, 255, 255,
-00003c10: 2032 3535 2c20 3235 352c 2032 3535 2c20   255, 255, 255, 
-00003c20: 3235 352c 2032 3535 2c20 3235 352c 2032  255, 255, 255, 2
-00003c30: 3535 2c0a 2020 2020 2020 2020 2020 2020  55,.            
-00003c40: 2020 2020 2020 2020 2020 2020 3235 352c              255,
-00003c50: 2032 3535 2c20 3235 352c 2032 3535 2c20   255, 255, 255, 
-00003c60: 3235 352c 2032 3535 2c20 3235 352c 2032  255, 255, 255, 2
-00003c70: 3535 2c20 305d 0a0a 2020 2020 2020 2020  55, 0]..        
-00003c80: 6c75 745b 3a2c 2030 2c20 305d 203d 205b  lut[:, 0, 0] = [
-00003c90: 302c 2030 2c20 302c 2030 2c20 312c 2031  0, 0, 0, 0, 1, 1
-00003ca0: 2c20 312c 2031 2c20 312c 2030 2c20 302c  , 1, 1, 1, 0, 0,
-00003cb0: 2030 2c20 302c 0a20 2020 2020 2020 2020   0, 0,.         
-00003cc0: 2020 2020 2020 2020 2020 2020 2020 2030                 0
-00003cd0: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-00003ce0: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-00003cf0: 302c 2030 2c0a 2020 2020 2020 2020 2020  0, 0,.          
-00003d00: 2020 2020 2020 2020 2020 2020 2020 302c                0,
-00003d10: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-00003d20: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
-00003d30: 2c20 302c 0a20 2020 2020 2020 2020 2020  , 0,.           
-00003d40: 2020 2020 2020 2020 2020 2020 2030 2c20               0, 
-00003d50: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
-00003d60: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-00003d70: 2030 2c0a 2020 2020 2020 2020 2020 2020   0,.            
-00003d80: 2020 2020 2020 2020 2020 2020 302c 2030              0, 0
-00003d90: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-00003da0: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-00003db0: 302c 0a20 2020 2020 2020 2020 2020 2020  0,.             
-00003dc0: 2020 2020 2020 2020 2020 2030 2c20 302c             0, 0,
-00003dd0: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-00003de0: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
-00003df0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00003e00: 2020 2020 2020 2020 2020 302c 2030 2c20            0, 0, 
-00003e10: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
-00003e20: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-00003e30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00003e40: 2020 2020 2020 2020 2030 2c20 302c 2030           0, 0, 0
-00003e50: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-00003e60: 2030 2c20 302c 2030 2c20 302c 2030 2c0a   0, 0, 0, 0, 0,.
-00003e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003e80: 2020 2020 2020 2020 302c 2030 2c20 302c          0, 0, 0,
-00003e90: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-00003ea0: 302c 2030 2c20 302c 2030 2c20 302c 0a20  0, 0, 0, 0, 0,. 
+00002cb0: 2020 2020 2020 2020 3136 382c 2031 3731          168, 171
+00002cc0: 2c20 3137 332c 2031 3735 2c20 3137 382c  , 173, 175, 178,
+00002cd0: 2031 3830 2c20 3138 332c 2031 3836 2c20   180, 183, 186, 
+00002ce0: 3138 382c 2031 3931 2c20 3139 322c 2031  188, 191, 192, 1
+00002cf0: 3935 2c20 3139 382c 0a20 2020 2020 2020  95, 198,.       
+00002d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002d10: 2032 3031 2c20 3230 332c 2032 3036 2c20   201, 203, 206, 
+00002d20: 3230 392c 2032 3130 2c20 3231 332c 2032  209, 210, 213, 2
+00002d30: 3135 2c20 3231 382c 2032 3231 2c20 3232  15, 218, 221, 22
+00002d40: 332c 2032 3235 2c20 3232 382c 2032 3331  3, 225, 228, 231
+00002d50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00002d60: 2020 2020 2020 2020 2020 3233 332c 2032            233, 2
+00002d70: 3336 2c20 3233 382c 2032 3431 2c20 3234  36, 238, 241, 24
+00002d80: 342c 2032 3436 2c20 3235 302c 2032 3532  4, 246, 250, 252
+00002d90: 2c20 3235 355d 0a0a 2020 2020 2020 2020  , 255]..        
+00002da0: 2320 4d6f 6469 6669 6564 2047 6c6f 7720  # Modified Glow 
+00002db0: 4c55 5420 7768 6963 6820 6d61 6b65 2074  LUT which make t
+00002dc0: 6865 2066 6972 7374 2066 6f75 7220 736d  he first four sm
+00002dd0: 616c 6c65 7374 2076 616c 7565 2061 7320  allest value as 
+00002de0: 6772 6565 6e0a 2020 2020 2020 2020 2320  green.        # 
+00002df0: 6c75 745b 3a2c 2030 2c20 325d 203d 205b  lut[:, 0, 2] = [
+00002e00: 302c 2030 2c20 302c 2030 2c20 322c 2033  0, 0, 0, 0, 2, 3
+00002e10: 2c20 342c 2036 2c20 382c 2031 312c 2031  , 4, 6, 8, 11, 1
+00002e20: 332c 2031 352c 2031 382c 0a20 2020 2020  3, 15, 18,.     
+00002e30: 2020 2023 2020 2020 2020 2020 2020 2020     #            
+00002e40: 2020 2020 2032 312c 2032 332c 2032 342c       21, 23, 24,
+00002e50: 2032 372c 2033 302c 2033 312c 2033 332c   27, 30, 31, 33,
+00002e60: 2033 362c 2033 372c 2034 302c 2034 322c   36, 37, 40, 42,
+00002e70: 2034 352c 2034 362c 0a20 2020 2020 2020   45, 46,.       
+00002e80: 2023 2020 2020 2020 2020 2020 2020 2020   #              
+00002e90: 2020 2034 392c 2035 312c 2035 332c 2035     49, 51, 53, 5
+00002ea0: 362c 2035 382c 2036 302c 2036 322c 2036  6, 58, 60, 62, 6
+00002eb0: 352c 2036 382c 2037 302c 2037 322c 2037  5, 68, 70, 72, 7
+00002ec0: 342c 2037 382c 0a20 2020 2020 2020 2023  4, 78,.        #
+00002ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002ee0: 2038 302c 2038 322c 2038 342c 2038 362c   80, 82, 84, 86,
+00002ef0: 2038 392c 2039 312c 2039 332c 2039 362c   89, 91, 93, 96,
+00002f00: 2039 382c 2031 3030 2c20 3130 322c 2031   98, 100, 102, 1
+00002f10: 3034 2c20 3130 362c 0a20 2020 2020 2020  04, 106,.       
+00002f20: 2023 2020 2020 2020 2020 2020 2020 2020   #              
+00002f30: 2020 2031 3038 2c20 3131 302c 2031 3133     108, 110, 113
+00002f40: 2c20 3131 352c 2031 3137 2c20 3131 392c  , 115, 117, 119,
+00002f50: 2031 3232 2c20 3132 352c 2031 3237 2c20   122, 125, 127, 
+00002f60: 3132 392c 2031 3332 2c20 3133 352c 2031  129, 132, 135, 1
+00002f70: 3335 2c0a 2020 2020 2020 2020 2320 2020  35,.        #   
+00002f80: 2020 2020 2020 2020 2020 2020 2020 3133                13
+00002f90: 372c 2031 3430 2c20 3134 312c 2031 3432  7, 140, 141, 142
+00002fa0: 2c20 3134 352c 2031 3438 2c20 3134 392c  , 145, 148, 149,
+00002fb0: 2031 3532 2c20 3135 342c 2031 3536 2c20   152, 154, 156, 
+00002fc0: 3135 372c 2031 3538 2c20 3136 302c 0a20  157, 158, 160,. 
+00002fd0: 2020 2020 2020 2023 2020 2020 2020 2020         #        
+00002fe0: 2020 2020 2020 2020 2031 3632 2c20 3136           162, 16
+00002ff0: 342c 2031 3636 2c20 3136 382c 2031 3730  4, 166, 168, 170
+00003000: 2c20 3137 312c 2031 3733 2c20 3137 342c  , 171, 173, 174,
+00003010: 2031 3736 2c20 3137 382c 2031 3739 2c20   176, 178, 179, 
+00003020: 3138 302c 2031 3832 2c0a 2020 2020 2020  180, 182,.      
+00003030: 2020 2320 2020 2020 2020 2020 2020 2020    #             
+00003040: 2020 2020 3138 332c 2031 3835 2c20 3138      183, 185, 18
+00003050: 362c 2031 3839 2c20 3139 322c 2031 3933  6, 189, 192, 193
+00003060: 2c20 3139 332c 2031 3934 2c20 3139 352c  , 193, 194, 195,
+00003070: 2031 3935 2c20 3139 362c 2031 3938 2c20   195, 196, 198, 
+00003080: 3139 392c 0a20 2020 2020 2020 2023 2020  199,.        #  
+00003090: 2020 2020 2020 2020 2020 2020 2020 2032                 2
+000030a0: 3031 2c20 3230 332c 2032 3034 2c20 3230  01, 203, 204, 20
+000030b0: 342c 2032 3035 2c20 3230 362c 2032 3037  4, 205, 206, 207
+000030c0: 2c20 3230 392c 2032 3131 2c20 3231 312c  , 209, 211, 211,
+000030d0: 2032 3131 2c20 3231 312c 2032 3133 2c0a   211, 211, 213,.
+000030e0: 2020 2020 2020 2020 2320 2020 2020 2020          #       
+000030f0: 2020 2020 2020 2020 2020 3231 352c 2032            215, 2
+00003100: 3136 2c20 3231 362c 2032 3136 2c20 3231  16, 216, 216, 21
+00003110: 362c 2032 3138 2c20 3231 392c 2032 3139  6, 218, 219, 219
+00003120: 2c20 3231 392c 2032 3230 2c20 3232 322c  , 219, 220, 222,
+00003130: 2032 3233 2c20 3232 332c 0a20 2020 2020   223, 223,.     
+00003140: 2020 2023 2020 2020 2020 2020 2020 2020     #            
+00003150: 2020 2020 2032 3233 2c20 3232 332c 2032       223, 223, 2
+00003160: 3234 2c20 3232 342c 2032 3236 2c20 3232  24, 224, 226, 22
+00003170: 372c 2032 3237 2c20 3232 372c 2032 3237  7, 227, 227, 227
+00003180: 2c20 3232 382c 2032 3239 2c20 3233 312c  , 228, 229, 231,
+00003190: 2032 3331 2c0a 2020 2020 2020 2020 2320   231,.        # 
+000031a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000031b0: 3233 312c 2032 3331 2c20 3233 312c 2032  231, 231, 231, 2
+000031c0: 3331 2c20 3233 312c 2032 3332 2c20 3233  31, 231, 232, 23
+000031d0: 332c 2032 3334 2c20 3233 342c 2032 3334  3, 234, 234, 234
+000031e0: 2c20 3233 342c 2032 3334 2c20 3233 342c  , 234, 234, 234,
+000031f0: 0a20 2020 2020 2020 2023 2020 2020 2020  .        #      
+00003200: 2020 2020 2020 2020 2020 2032 3335 2c20             235, 
+00003210: 3233 372c 2032 3338 2c20 3233 382c 2032  237, 238, 238, 2
+00003220: 3338 2c20 3233 382c 2032 3338 2c20 3233  38, 238, 238, 23
+00003230: 382c 2032 3338 2c20 3233 382c 2032 3339  8, 238, 238, 239
+00003240: 2c20 3234 302c 2032 3432 2c0a 2020 2020  , 240, 242,.    
+00003250: 2020 2020 2320 2020 2020 2020 2020 2020      #           
+00003260: 2020 2020 2020 3234 322c 2032 3432 2c20        242, 242, 
+00003270: 3234 322c 2032 3432 2c20 3234 322c 2032  242, 242, 242, 2
+00003280: 3432 2c20 3234 322c 2032 3432 2c20 3234  42, 242, 242, 24
+00003290: 332c 2032 3435 2c20 3234 362c 2032 3436  3, 245, 246, 246
+000032a0: 2c20 3234 362c 0a20 2020 2020 2020 2023  , 246,.        #
+000032b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000032c0: 2032 3436 2c20 3234 352c 2032 3435 2c20   246, 245, 245, 
+000032d0: 3234 352c 2032 3435 2c20 3234 352c 2032  245, 245, 245, 2
+000032e0: 3435 2c20 3234 352c 2032 3437 2c20 3234  45, 245, 247, 24
+000032f0: 382c 2032 3439 2c20 3234 392c 2032 3439  8, 249, 249, 249
+00003300: 2c0a 2020 2020 2020 2020 2320 2020 2020  ,.        #     
+00003310: 2020 2020 2020 2020 2020 2020 3234 392c              249,
+00003320: 2032 3439 2c20 3234 392c 2032 3439 2c20   249, 249, 249, 
+00003330: 3234 392c 2032 3439 2c20 3234 392c 2032  249, 249, 249, 2
+00003340: 3439 2c20 3234 392c 2032 3439 2c20 3234  49, 249, 249, 24
+00003350: 392c 2032 3439 2c20 3234 392c 0a20 2020  9, 249, 249,.   
+00003360: 2020 2020 2023 2020 2020 2020 2020 2020       #          
+00003370: 2020 2020 2020 2032 3439 2c20 3235 302c         249, 250,
+00003380: 2032 3532 2c20 3235 332c 2032 3533 2c20   252, 253, 253, 
+00003390: 3235 332c 2032 3533 2c20 3235 332c 2032  253, 253, 253, 2
+000033a0: 3533 2c20 3235 332c 2032 3533 2c20 3235  53, 253, 253, 25
+000033b0: 332c 2032 3533 2c0a 2020 2020 2020 2020  3, 253,.        
+000033c0: 2320 2020 2020 2020 2020 2020 2020 2020  #               
+000033d0: 2020 3235 332c 2032 3533 2c20 3235 332c    253, 253, 253,
+000033e0: 2032 3533 2c20 3235 332c 2032 3533 2c20   253, 253, 253, 
+000033f0: 3235 332c 2032 3533 2c20 3235 332c 2032  253, 253, 253, 2
+00003400: 3533 2c20 3235 332c 2032 3533 2c20 3235  53, 253, 253, 25
+00003410: 332c 0a20 2020 2020 2020 2023 2020 2020  3,.        #    
+00003420: 2020 2020 2020 2020 2020 2020 2032 3533               253
+00003430: 2c20 3235 332c 2032 3533 2c20 3235 332c  , 253, 253, 253,
+00003440: 2032 3533 2c20 3235 332c 2032 3533 2c20   253, 253, 253, 
+00003450: 3235 332c 2032 3533 2c20 3235 332c 2032  253, 253, 253, 2
+00003460: 3533 2c20 3235 332c 2032 3533 2c0a 2020  53, 253, 253,.  
+00003470: 2020 2020 2020 2320 2020 2020 2020 2020        #         
+00003480: 2020 2020 2020 2020 3235 332c 2032 3533          253, 253
+00003490: 2c20 3235 332c 2032 3533 2c20 3235 332c  , 253, 253, 253,
+000034a0: 2032 3533 2c20 3235 332c 2032 3533 2c20   253, 253, 253, 
+000034b0: 305d 0a20 2020 2020 2020 2023 0a20 2020  0].        #.   
+000034c0: 2020 2020 2023 206c 7574 5b3a 2c20 302c       # lut[:, 0,
+000034d0: 2031 5d20 3d20 5b31 3338 2c20 3133 382c   1] = [138, 138,
+000034e0: 2031 3338 2c20 3133 382c 2030 2c20 302c   138, 138, 0, 0,
+000034f0: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
+00003500: 302c 2030 2c0a 2020 2020 2020 2020 2320  0, 0,.        # 
+00003510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003520: 312c 2031 2c20 312c 2031 2c20 312c 2031  1, 1, 1, 1, 1, 1
+00003530: 2c20 312c 2031 2c20 312c 2032 2c20 322c  , 1, 1, 1, 2, 2,
+00003540: 2032 2c20 322c 0a20 2020 2020 2020 2023   2, 2,.        #
+00003550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003560: 2032 2c20 322c 2032 2c20 322c 2033 2c20   2, 2, 2, 2, 3, 
+00003570: 332c 2033 2c20 332c 2034 2c20 352c 2035  3, 3, 3, 4, 5, 5
+00003580: 2c20 352c 2035 2c0a 2020 2020 2020 2020  , 5, 5,.        
+00003590: 2320 2020 2020 2020 2020 2020 2020 2020  #               
+000035a0: 2020 362c 2036 2c20 362c 2037 2c20 372c    6, 6, 6, 7, 7,
+000035b0: 2038 2c20 392c 2039 2c20 392c 2039 2c20   8, 9, 9, 9, 9, 
+000035c0: 3130 2c20 3130 2c20 3131 2c0a 2020 2020  10, 10, 11,.    
+000035d0: 2020 2020 2320 2020 2020 2020 2020 2020      #           
+000035e0: 2020 2020 2020 3132 2c20 3133 2c20 3134        12, 13, 14
+000035f0: 2c20 3134 2c20 3134 2c20 3134 2c20 3135  , 14, 14, 14, 15
+00003600: 2c20 3136 2c20 3136 2c20 3137 2c20 3138  , 16, 16, 17, 18
+00003610: 2c20 3139 2c20 3139 2c0a 2020 2020 2020  , 19, 19,.      
+00003620: 2020 2320 2020 2020 2020 2020 2020 2020    #             
+00003630: 2020 2020 3139 2c20 3230 2c20 3231 2c20      19, 20, 21, 
+00003640: 3232 2c20 3233 2c20 3234 2c20 3234 2c20  22, 23, 24, 24, 
+00003650: 3235 2c20 3237 2c20 3238 2c20 3238 2c20  25, 27, 28, 28, 
+00003660: 3238 2c20 3239 2c0a 2020 2020 2020 2020  28, 29,.        
+00003670: 2320 2020 2020 2020 2020 2020 2020 2020  #               
+00003680: 2020 3331 2c20 3332 2c20 3332 2c20 3333    31, 32, 32, 33
+00003690: 2c20 3335 2c20 3336 2c20 3336 2c20 3337  , 35, 36, 36, 37
+000036a0: 2c20 3339 2c20 3430 2c20 3430 2c20 3431  , 39, 40, 40, 41
+000036b0: 2c20 3432 2c0a 2020 2020 2020 2020 2320  , 42,.        # 
+000036c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000036d0: 3433 2c20 3435 2c20 3436 2c20 3437 2c20  43, 45, 46, 47, 
+000036e0: 3438 2c20 3530 2c20 3531 2c20 3532 2c20  48, 50, 51, 52, 
+000036f0: 3534 2c20 3535 2c20 3536 2c20 3537 2c20  54, 55, 56, 57, 
+00003700: 3539 2c0a 2020 2020 2020 2020 2320 2020  59,.        #   
+00003710: 2020 2020 2020 2020 2020 2020 2020 3632                62
+00003720: 2c20 3633 2c20 3635 2c20 3636 2c20 3638  , 63, 65, 66, 68
+00003730: 2c20 3730 2c20 3731 2c20 3733 2c20 3734  , 70, 71, 73, 74
+00003740: 2c20 3735 2c20 3737 2c20 3739 2c20 3831  , 75, 77, 79, 81
+00003750: 2c0a 2020 2020 2020 2020 2320 2020 2020  ,.        #     
+00003760: 2020 2020 2020 2020 2020 2020 3833 2c20              83, 
+00003770: 3835 2c20 3837 2c20 3839 2c20 3932 2c20  85, 87, 89, 92, 
+00003780: 3933 2c20 3936 2c20 3938 2c20 3939 2c20  93, 96, 98, 99, 
+00003790: 3130 302c 2031 3033 2c20 3130 352c 2031  100, 103, 105, 1
+000037a0: 3037 2c0a 2020 2020 2020 2020 2320 2020  07,.        #   
+000037b0: 2020 2020 2020 2020 2020 2020 2020 3130                10
+000037c0: 392c 2031 3131 2c20 3131 332c 2031 3136  9, 111, 113, 116
+000037d0: 2c20 3131 372c 2031 3139 2c20 3132 312c  , 117, 119, 121,
+000037e0: 2031 3233 2c20 3132 352c 2031 3236 2c20   123, 125, 126, 
+000037f0: 3132 382c 2031 3330 2c20 3133 322c 0a20  128, 130, 132,. 
+00003800: 2020 2020 2020 2023 2020 2020 2020 2020         #        
+00003810: 2020 2020 2020 2020 2031 3335 2c20 3133           135, 13
+00003820: 372c 2031 3339 2c20 3134 302c 2031 3432  7, 139, 140, 142
+00003830: 2c20 3134 342c 2031 3435 2c20 3134 372c  , 144, 145, 147,
+00003840: 2031 3438 2c20 3135 302c 2031 3532 2c20   148, 150, 152, 
+00003850: 3135 342c 2031 3536 2c0a 2020 2020 2020  154, 156,.      
+00003860: 2020 2320 2020 2020 2020 2020 2020 2020    #             
+00003870: 2020 2020 3135 382c 2031 3630 2c20 3136      158, 160, 16
+00003880: 312c 2031 3632 2c20 3136 342c 2031 3636  1, 162, 164, 166
+00003890: 2c20 3136 382c 2031 3731 2c20 3137 322c  , 168, 171, 172,
+000038a0: 2031 3732 2c20 3137 342c 2031 3736 2c20   172, 174, 176, 
+000038b0: 3137 372c 0a20 2020 2020 2020 2023 2020  177,.        #  
+000038c0: 2020 2020 2020 2020 2020 2020 2020 2031                 1
+000038d0: 3739 2c20 3138 302c 2031 3832 2c20 3138  79, 180, 182, 18
+000038e0: 332c 2031 3835 2c20 3138 372c 2031 3838  3, 185, 187, 188
+000038f0: 2c20 3138 392c 2031 3931 2c20 3139 322c  , 189, 191, 192,
+00003900: 2031 3932 2c20 3139 322c 2031 3936 2c0a   192, 192, 196,.
+00003910: 2020 2020 2020 2020 2320 2020 2020 2020          #       
+00003920: 2020 2020 2020 2020 2020 3230 302c 2032            200, 2
+00003930: 3031 2c20 3230 312c 2032 3032 2c20 3230  01, 201, 202, 20
+00003940: 332c 2032 3034 2c20 3230 362c 2032 3038  3, 204, 206, 208
+00003950: 2c20 3231 302c 2032 3132 2c20 3231 332c  , 210, 212, 213,
+00003960: 2032 3133 2c20 3231 342c 0a20 2020 2020   213, 214,.     
+00003970: 2020 2023 2020 2020 2020 2020 2020 2020     #            
+00003980: 2020 2020 2032 3135 2c20 3231 372c 2032       215, 217, 2
+00003990: 3138 2c20 3232 302c 2032 3231 2c20 3232  18, 220, 221, 22
+000039a0: 322c 2032 3233 2c20 3232 342c 2032 3235  2, 223, 224, 225
+000039b0: 2c20 3232 362c 2032 3236 2c20 3232 372c  , 226, 226, 227,
+000039c0: 2032 3238 2c0a 2020 2020 2020 2020 2320   228,.        # 
+000039d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000039e0: 3232 392c 2032 3331 2c20 3233 322c 2032  229, 231, 232, 2
+000039f0: 3333 2c20 3233 342c 2032 3335 2c20 3233  33, 234, 235, 23
+00003a00: 362c 2032 3337 2c20 3233 382c 2032 3339  6, 237, 238, 239
+00003a10: 2c20 3233 392c 2032 3339 2c20 3233 392c  , 239, 239, 239,
+00003a20: 0a20 2020 2020 2020 2023 2020 2020 2020  .        #      
+00003a30: 2020 2020 2020 2020 2020 2032 3431 2c20             241, 
+00003a40: 3234 322c 2032 3433 2c20 3234 332c 2032  242, 243, 243, 2
+00003a50: 3433 2c20 3234 342c 2032 3435 2c20 3234  43, 244, 245, 24
+00003a60: 372c 2032 3437 2c20 3234 372c 2032 3437  7, 247, 247, 247
+00003a70: 2c20 3234 372c 2032 3437 2c0a 2020 2020  , 247, 247,.    
+00003a80: 2020 2020 2320 2020 2020 2020 2020 2020      #           
+00003a90: 2020 2020 2020 3234 382c 2032 3439 2c20        248, 249, 
+00003aa0: 3235 302c 2032 3531 2c20 3235 312c 2032  250, 251, 251, 2
+00003ab0: 3531 2c20 3235 322c 2032 3532 2c20 3235  51, 252, 252, 25
+00003ac0: 322c 2032 3532 2c20 3235 322c 2032 3532  2, 252, 252, 252
+00003ad0: 2c20 3235 322c 0a20 2020 2020 2020 2023  , 252,.        #
+00003ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003af0: 2032 3532 2c20 3235 322c 2032 3532 2c20   252, 252, 252, 
+00003b00: 3235 322c 2032 3532 2c20 3235 322c 2032  252, 252, 252, 2
+00003b10: 3533 2c20 3235 332c 2030 5d0a 2020 2020  53, 253, 0].    
+00003b20: 2020 2020 230a 2020 2020 2020 2020 2320      #.        # 
+00003b30: 6c75 745b 3a2c 2030 2c20 305d 203d 205b  lut[:, 0, 0] = [
+00003b40: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+00003b50: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
+00003b60: 2030 2c20 302c 0a20 2020 2020 2020 2023   0, 0,.        #
+00003b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003b80: 2031 2c20 312c 2031 2c20 312c 2031 2c20   1, 1, 1, 1, 1, 
+00003b90: 312c 2031 2c20 312c 2031 2c20 312c 2033  1, 1, 1, 1, 1, 3
+00003ba0: 2c20 342c 2034 2c0a 2020 2020 2020 2020  , 4, 4,.        
+00003bb0: 2320 2020 2020 2020 2020 2020 2020 2020  #               
+00003bc0: 2020 342c 2034 2c20 342c 2034 2c20 332c    4, 4, 4, 4, 3,
+00003bd0: 2033 2c20 332c 2033 2c20 342c 2036 2c20   3, 3, 3, 4, 6, 
+00003be0: 362c 2036 2c20 362c 0a20 2020 2020 2020  6, 6, 6,.       
+00003bf0: 2023 2020 2020 2020 2020 2020 2020 2020   #              
+00003c00: 2020 2036 2c20 362c 2036 2c20 362c 2036     6, 6, 6, 6, 6
+00003c10: 2c20 362c 2036 2c20 362c 2036 2c20 362c  , 6, 6, 6, 6, 6,
+00003c20: 2036 2c20 362c 2036 2c0a 2020 2020 2020   6, 6, 6,.      
+00003c30: 2020 2320 2020 2020 2020 2020 2020 2020    #             
+00003c40: 2020 2020 362c 2036 2c20 362c 2036 2c20      6, 6, 6, 6, 
+00003c50: 362c 2036 2c20 362c 2036 2c20 352c 2035  6, 6, 6, 6, 5, 5
+00003c60: 2c20 372c 2039 2c20 3130 2c0a 2020 2020  , 7, 9, 10,.    
+00003c70: 2020 2020 2320 2020 2020 2020 2020 2020      #           
+00003c80: 2020 2020 2020 3130 2c20 3130 2c20 3130        10, 10, 10
+00003c90: 2c20 3130 2c20 3130 2c20 3130 2c20 3130  , 10, 10, 10, 10
+00003ca0: 2c20 3130 2c20 3130 2c20 3130 2c20 3130  , 10, 10, 10, 10
+00003cb0: 2c20 3130 2c20 3130 2c0a 2020 2020 2020  , 10, 10,.      
+00003cc0: 2020 2320 2020 2020 2020 2020 2020 2020    #             
+00003cd0: 2020 2020 3130 2c20 3130 2c20 3130 2c20      10, 10, 10, 
+00003ce0: 392c 2039 2c20 392c 2039 2c20 392c 2039  9, 9, 9, 9, 9, 9
+00003cf0: 2c20 392c 2039 2c20 392c 2039 2c0a 2020  , 9, 9, 9, 9,.  
+00003d00: 2020 2020 2020 2320 2020 2020 2020 2020        #         
+00003d10: 2020 2020 2020 2020 392c 2039 2c20 392c          9, 9, 9,
+00003d20: 2039 2c20 382c 2038 2c20 382c 2038 2c20   9, 8, 8, 8, 8, 
+00003d30: 382c 2038 2c20 382c 2038 2c20 382c 0a20  8, 8, 8, 8, 8,. 
+00003d40: 2020 2020 2020 2023 2020 2020 2020 2020         #        
+00003d50: 2020 2020 2020 2020 2038 2c20 382c 2038           8, 8, 8
+00003d60: 2c20 382c 2038 2c20 382c 2038 2c20 382c  , 8, 8, 8, 8, 8,
+00003d70: 2037 2c20 372c 2037 2c20 372c 2037 2c0a   7, 7, 7, 7, 7,.
+00003d80: 2020 2020 2020 2020 2320 2020 2020 2020          #       
+00003d90: 2020 2020 2020 2020 2020 372c 2037 2c20            7, 7, 
+00003da0: 372c 2037 2c20 372c 2037 2c20 372c 2037  7, 7, 7, 7, 7, 7
+00003db0: 2c20 372c 2037 2c20 362c 2036 2c20 362c  , 7, 7, 6, 6, 6,
+00003dc0: 0a20 2020 2020 2020 2023 2020 2020 2020  .        #      
+00003dd0: 2020 2020 2020 2020 2020 2036 2c20 362c             6, 6,
+00003de0: 2036 2c20 362c 2037 2c20 3130 2c20 3132   6, 6, 7, 10, 12
+00003df0: 2c20 3132 2c20 3132 2c20 3132 2c20 3132  , 12, 12, 12, 12
+00003e00: 2c20 3132 2c20 3133 2c0a 2020 2020 2020  , 12, 13,.      
+00003e10: 2020 2320 2020 2020 2020 2020 2020 2020    #             
+00003e20: 2020 2020 3135 2c20 3137 2c20 3138 2c20      15, 17, 18, 
+00003e30: 3138 2c20 3139 2c20 3230 2c20 3232 2c20  18, 19, 20, 22, 
+00003e40: 3233 2c20 3233 2c20 3234 2c20 3236 2c20  23, 23, 24, 26, 
+00003e50: 3237 2c20 3237 2c0a 2020 2020 2020 2020  27, 27,.        
+00003e60: 2320 2020 2020 2020 2020 2020 2020 2020  #               
+00003e70: 2020 3238 2c20 3330 2c20 3332 2c20 3333    28, 30, 32, 33
+00003e80: 2c20 3334 2c20 3335 2c20 3337 2c20 3339  , 34, 35, 37, 39
+00003e90: 2c20 3430 2c20 3431 2c20 3433 2c20 3435  , 40, 41, 43, 45
+00003ea0: 2c20 3436 2c0a 2020 2020 2020 2020 2320  , 46,.        # 
 00003eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003ec0: 2020 2020 2020 2030 2c20 302c 2030 2c20         0, 0, 0, 
-00003ed0: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
-00003ee0: 2c20 302c 2030 2c20 302c 2030 2c0a 2020  , 0, 0, 0, 0,.  
-00003ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003f00: 2020 2020 2020 302c 2030 2c20 302c 2030        0, 0, 0, 0
-00003f10: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
-00003f20: 2030 2c20 302c 2030 2c20 302c 0a20 2020   0, 0, 0, 0,.   
-00003f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003f40: 2020 2020 2030 2c20 302c 2030 2c20 302c       0, 0, 0, 0,
-00003f50: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
-00003f60: 302c 2030 2c20 302c 2030 2c0a 2020 2020  0, 0, 0, 0,.    
-00003f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003f80: 2020 2020 302c 2030 2c20 302c 2030 2c20      0, 0, 0, 0, 
-00003f90: 302c 2030 2c20 302c 2030 2c20 302c 2031  0, 0, 0, 0, 0, 1
-00003fa0: 2c20 332c 2034 2c20 362c 0a20 2020 2020  , 3, 4, 6,.     
-00003fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003fc0: 2020 2039 2c20 3132 2c20 3135 2c20 3139     9, 12, 15, 19
-00003fd0: 2c20 3232 2c20 3235 2c20 3238 2c20 3332  , 22, 25, 28, 32
-00003fe0: 2c20 3335 2c20 3338 2c20 3431 2c20 3435  , 35, 38, 41, 45
-00003ff0: 2c20 3438 2c0a 2020 2020 2020 2020 2020  , 48,.          
-00004000: 2020 2020 2020 2020 2020 2020 2020 3531                51
-00004010: 2c20 3534 2c20 3538 2c20 3631 2c20 3634  , 54, 58, 61, 64
-00004020: 2c20 3637 2c20 3731 2c20 3734 2c20 3737  , 67, 71, 74, 77
-00004030: 2c20 3830 2c20 3834 2c20 3837 2c20 3930  , 80, 84, 87, 90
-00004040: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00004050: 2020 2020 2020 2020 2020 3933 2c20 3937            93, 97
-00004060: 2c20 3130 302c 2031 3033 2c20 3130 362c  , 100, 103, 106,
-00004070: 2031 3130 2c20 3131 332c 2031 3136 2c20   110, 113, 116, 
-00004080: 3131 392c 2031 3232 2c20 3132 352c 2031  119, 122, 125, 1
-00004090: 3238 2c20 3133 312c 0a20 2020 2020 2020  28, 131,.       
-000040a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000040b0: 2031 3335 2c20 3133 382c 2031 3432 2c20   135, 138, 142, 
-000040c0: 3134 352c 2031 3439 2c20 3135 322c 2031  145, 149, 152, 1
-000040d0: 3535 2c20 3135 382c 2031 3631 2c20 3136  55, 158, 161, 16
-000040e0: 342c 2031 3637 2c20 3137 302c 2031 3734  4, 167, 170, 174
-000040f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00004100: 2020 2020 2020 2020 2020 3137 372c 2031            177, 1
-00004110: 3830 2c20 3138 332c 2031 3837 2c20 3139  80, 183, 187, 19
-00004120: 302c 2031 3933 2c20 3139 362c 2032 3030  0, 193, 196, 200
-00004130: 2c20 3230 332c 2032 3036 2c20 3230 392c  , 203, 206, 209,
-00004140: 2032 3133 2c20 3231 362c 0a20 2020 2020   213, 216,.     
-00004150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00004160: 2020 2032 3139 2c20 3232 322c 2032 3235     219, 222, 225
-00004170: 2c20 3232 382c 2032 3332 2c20 3233 352c  , 228, 232, 235,
-00004180: 2032 3339 2c20 3234 322c 2032 3435 2c20   239, 242, 245, 
-00004190: 3234 382c 2032 3532 2c20 3235 322c 2032  248, 252, 252, 2
-000041a0: 3533 2c0a 2020 2020 2020 2020 2020 2020  53,.            
-000041b0: 2020 2020 2020 2020 2020 2020 3235 342c              254,
-000041c0: 2032 3535 2c20 3235 352c 2032 3535 2c20   255, 255, 255, 
-000041d0: 3235 352c 2032 3535 2c20 3235 352c 2032  255, 255, 255, 2
-000041e0: 3535 2c20 3235 355d 0a0a 2020 2020 2020  55, 255]..      
-000041f0: 2020 2320 4170 706c 7920 636f 6c6f 7220    # Apply color 
-00004200: 6d61 7020 7573 696e 6720 6376 322e 6170  map using cv2.ap
-00004210: 706c 7943 6f6c 6f72 4d61 7028 290a 2020  plyColorMap().  
-00004220: 2020 2020 2020 696d 5f63 6f6c 6f72 203d        im_color =
-00004230: 2063 7632 2e61 7070 6c79 436f 6c6f 724d   cv2.applyColorM
-00004240: 6170 2869 6d5f 6772 6179 2c20 6c75 7429  ap(im_gray, lut)
-00004250: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00004260: 696d 5f63 6f6c 6f72 0a0a 0a20 2020 2064  im_color...    d
-00004270: 6566 206e 6577 5f70 726f 6a65 6374 696f  ef new_projectio
-00004280: 6e28 7365 6c66 2c20 7479 7065 3d4e 6f6e  n(self, type=Non
-00004290: 6529 3a0a 2020 2020 2020 2020 6f70 203d  e):.        op =
-000042a0: 2050 726f 6a65 6374 696f 6e73 2873 656c   Projections(sel
-000042b0: 662e 6d61 702c 2073 656c 662e 7261 776d  f.map, self.rawm
-000042c0: 6170 2c20 7365 6c66 2e77 6f72 6b64 6972  ap, self.workdir
-000042d0: 2c20 7365 6c66 2e70 6c61 7466 6f72 6d29  , self.platform)
-000042e0: 0a20 2020 2020 2020 206f 702e 6f72 7468  .        op.orth
-000042f0: 6f67 6f6e 616c 5f70 726f 6a65 6374 696f  ogonal_projectio
-00004300: 6e73 2873 656c 662e 6d61 702c 2073 656c  ns(self.map, sel
-00004310: 662e 776f 726b 6469 722c 2074 7970 6529  f.workdir, type)
-00004320: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00004330: 2e72 6177 6d61 703a 0a20 2020 2020 2020  .rawmap:.       
-00004340: 2020 2020 206f 702e 6f72 7468 6f67 6f6e       op.orthogon
-00004350: 616c 5f70 726f 6a65 6374 696f 6e73 2873  al_projections(s
-00004360: 656c 662e 7261 776d 6170 2c20 7365 6c66  elf.rawmap, self
-00004370: 2e77 6f72 6b64 6972 2c20 7479 7065 2c20  .workdir, type, 
-00004380: 2772 6177 6d61 705f 2729 0a0a 2020 2020  'rawmap_')..    
-00004390: 6465 6620 6d61 7069 6e63 6865 636b 2873  def mapincheck(s
-000043a0: 656c 662c 206d 6170 696e 2c20 776f 726b  elf, mapin, work
-000043b0: 6469 7269 6e29 3a0a 0a20 2020 2020 2020  dirin):..       
-000043c0: 2069 6d70 6f72 7420 696e 7370 6563 740a   import inspect.
-000043d0: 2020 2020 2020 2020 6672 6f6d 206d 7263          from mrc
-000043e0: 6669 6c65 2e6d 7263 6669 6c65 2069 6d70  file.mrcfile imp
-000043f0: 6f72 7420 4d72 6346 696c 650a 0a20 2020  ort MrcFile..   
-00004400: 2020 2020 2066 7261 6d65 203d 2069 6e73       frame = ins
-00004410: 7065 6374 2e63 7572 7265 6e74 6672 616d  pect.currentfram
-00004420: 6528 290a 2020 2020 2020 2020 6675 6e63  e().        func
-00004430: 203d 2069 6e73 7065 6374 2e67 6574 6672   = inspect.getfr
-00004440: 616d 6569 6e66 6f28 6672 616d 652e 665f  ameinfo(frame.f_
-00004450: 6261 636b 292e 6675 6e63 7469 6f6e 0a20  back).function. 
-00004460: 2020 2020 2020 2069 6620 6d61 7069 6e20         if mapin 
-00004470: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00004480: 2020 2020 2020 2020 2069 6620 2874 7970           if (typ
-00004490: 6528 6d61 7069 6e29 2069 7320 7374 7229  e(mapin) is str)
-000044a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000044b0: 2020 6966 2028 6f73 2e70 6174 682e 6973    if (os.path.is
-000044c0: 6669 6c65 286d 6170 696e 2929 3a0a 2020  file(mapin)):.  
-000044d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000044e0: 2020 2320 6d61 7020 3d20 4d61 7050 6172    # map = MapPar
-000044f0: 7365 722e 7265 6164 4d52 4328 6d61 7069  ser.readMRC(mapi
-00004500: 6e29 0a20 2020 2020 2020 2020 2020 2020  n).             
-00004510: 2020 2020 2020 206d 6170 203d 206d 7263         map = mrc
-00004520: 6669 6c65 2e6d 6d61 7028 6d61 7069 6e2c  file.mmap(mapin,
-00004530: 206d 6f64 653d 2772 2729 0a20 2020 2020   mode='r').     
-00004540: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00004550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00004560: 2020 2020 2070 7269 6e74 2827 4d61 7020       print('Map 
-00004570: 646f 6573 206e 6f74 2065 7869 7374 2e27  does not exist.'
-00004580: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00004590: 2020 2020 2020 6d61 7020 3d20 4e6f 6e65        map = None
-000045a0: 0a20 2020 2020 2020 2020 2020 2023 2065  .            # e
-000045b0: 6c69 6628 6973 696e 7374 616e 6365 286d  lif(isinstance(m
-000045c0: 6170 696e 2c20 4d61 7029 293a 0a20 2020  apin, Map)):.   
-000045d0: 2020 2020 2020 2020 2065 6c69 6620 2869           elif (i
-000045e0: 7369 6e73 7461 6e63 6528 6d61 7069 6e2c  sinstance(mapin,
-000045f0: 204d 7263 4669 6c65 2929 3a0a 2020 2020   MrcFile)):.    
-00004600: 2020 2020 2020 2020 2020 2020 6d61 7020              map 
-00004610: 3d20 6d61 7069 6e0a 2020 2020 2020 2020  = mapin.        
-00004620: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00004630: 2020 2020 2020 2020 2020 6d61 7020 3d20            map = 
-00004640: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-00004650: 2020 2020 2070 7269 6e74 2827 4675 6e63       print('Func
-00004660: 7469 6f6e 3a7b 7d20 6f6e 6c79 2061 6363  tion:{} only acc
-00004670: 6570 7420 6120 7374 7269 6e67 206f 6620  ept a string of 
-00004680: 6675 6c6c 206d 6170 206e 616d 6520 6f72  full map name or
-00004690: 2061 2054 454d 5079 204d 6170 206f 626a   a TEMPy Map obj
-000046a0: 6563 7420 6173 2069 6e70 7574 2e27 2e66  ect as input.'.f
-000046b0: 6f72 6d61 7428 6675 6e63 2929 0a20 2020  ormat(func)).   
-000046c0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-000046d0: 2020 2020 2020 206d 6170 203d 2073 656c         map = sel
-000046e0: 662e 6d61 700a 0a20 2020 2020 2020 2069  f.map..        i
-000046f0: 6620 776f 726b 6469 7269 6e20 6973 206e  f workdirin is n
-00004700: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00004710: 2020 2020 2069 6620 2874 7970 6528 776f       if (type(wo
-00004720: 726b 6469 7269 6e29 2069 7320 7374 7229  rkdirin) is str)
-00004730: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00004740: 2020 6966 2028 6f73 2e70 6174 682e 6973    if (os.path.is
-00004750: 6469 7228 776f 726b 6469 7269 6e29 293a  dir(workdirin)):
-00004760: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00004770: 2020 2020 2077 6f72 6b64 6972 203d 2077       workdir = w
-00004780: 6f72 6b64 6972 696e 0a20 2020 2020 2020  orkdirin.       
-00004790: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-000047a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000047b0: 2020 2070 7269 6e74 2827 4f75 7470 7574     print('Output
-000047c0: 2064 6972 6563 746f 7279 2064 6f65 7320   directory does 
-000047d0: 6e6f 7420 6578 6973 742e 2729 0a20 2020  not exist.').   
-000047e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000047f0: 2077 6f72 6b64 6972 203d 204e 6f6e 650a   workdir = None.
-00004800: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00004810: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00004820: 2020 776f 726b 6469 7220 3d20 4e6f 6e65    workdir = None
-00004830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00004840: 2070 7269 6e74 2827 4675 6e63 7469 6f6e   print('Function
-00004850: 3a7b 7d20 6f6e 6c79 2061 6363 6570 7420  :{} only accept 
-00004860: 6120 7374 7269 6e67 2061 7320 7468 6520  a string as the 
-00004870: 6469 7265 6374 6f72 7920 7061 7261 6d65  directory parame
-00004880: 7465 722e 272e 666f 726d 6174 2866 756e  ter.'.format(fun
-00004890: 6329 290a 2020 2020 2020 2020 656c 7365  c)).        else
-000048a0: 3a0a 2020 2020 2020 2020 2020 2020 776f  :.            wo
-000048b0: 726b 6469 7220 3d20 7365 6c66 2e77 6f72  rkdir = self.wor
-000048c0: 6b64 6972 0a0a 2020 2020 2020 2020 7265  kdir..        re
-000048d0: 7475 726e 206d 6170 2c20 776f 726b 6469  turn map, workdi
-000048e0: 720a 0a20 2020 2023 2040 7072 6f66 696c  r..    # @profil
-000048f0: 650a 2020 2020 6465 6620 7265 7369 7a65  e.    def resize
-00004900: 5f69 6d67 2873 656c 662c 2069 6e70 7574  _img(self, input
-00004910: 5f61 7272 2c20 6f75 7470 7574 5f69 6d67  _arr, output_img
-00004920: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
-00004930: 2020 2020 2020 2020 2020 2072 6573 6361             resca
-00004940: 6c65 2069 6d61 6765 2074 6f20 3330 3058  le image to 300X
-00004950: 3330 302c 2069 6620 7468 6520 696e 7075  300, if the inpu
-00004960: 7420 6973 206e 6f74 2073 7175 6172 652c  t is not square,
-00004970: 2073 6361 6c65 2074 6865 206c 6f6e 6765   scale the longe
-00004980: 7220 6f6e 6520 746f 2033 3030 2061 6e64  r one to 300 and
-00004990: 2074 6865 206f 7468 6572 206f 6e65 0a20   the other one. 
-000049a0: 2020 2020 2020 2020 2020 2061 6363 6f72             accor
-000049b0: 6469 6e67 6c79 0a0a 2020 2020 2020 2020  dingly..        
-000049c0: 3a70 6172 616d 2069 6e70 7574 5f61 7272  :param input_arr
-000049d0: 3a20 6e75 6d70 7920 6172 7261 790a 2020  : numpy array.  
-000049e0: 2020 2020 2020 3a70 6172 616d 206f 7574        :param out
-000049f0: 7075 745f 696d 673a 2074 6865 206e 616d  put_img: the nam
-00004a00: 6520 7769 7468 2066 756c 6c20 7061 7468  e with full path
-00004a10: 206f 6620 7468 6520 6f75 7470 7574 2069   of the output i
-00004a20: 6d61 6765 0a20 2020 2020 2020 203a 7265  mage.        :re
-00004a30: 7475 726e 3a20 4e6f 6e65 0a20 2020 2020  turn: None.     
-00004a40: 2020 2022 2222 0a0a 2020 2020 2020 2020     """..        
-00004a50: 6865 6967 6874 2c20 7769 6474 6820 3d20  height, width = 
-00004a60: 696e 7075 745f 6172 722e 7368 6170 655b  input_arr.shape[
-00004a70: 303a 325d 0a20 2020 2020 2020 2069 6620  0:2].        if 
-00004a80: 7769 6474 6820 3e3d 2068 6569 6768 743a  width >= height:
-00004a90: 0a20 2020 2020 2020 2020 2020 206c 6172  .            lar
-00004aa0: 6765 7273 6361 6c65 7220 3d20 3330 302e  gerscaler = 300.
-00004ab0: 202f 2077 6964 7468 0a20 2020 2020 2020   / width.       
-00004ac0: 2020 2020 206e 6577 6865 6967 6874 203d       newheight =
-00004ad0: 2069 6e74 2863 6569 6c28 6c61 7267 6572   int(ceil(larger
-00004ae0: 7363 616c 6572 202a 2068 6569 6768 7429  scaler * height)
-00004af0: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-00004b00: 7369 7a65 645f 696d 6720 3d20 6376 322e  sized_img = cv2.
-00004b10: 7265 7369 7a65 2869 6e70 7574 5f61 7272  resize(input_arr
-00004b20: 2c20 2833 3030 2c20 6e65 7768 6569 6768  , (300, newheigh
-00004b30: 7429 2c20 696e 7465 7270 6f6c 6174 696f  t), interpolatio
-00004b40: 6e3d 6376 322e 494e 5445 525f 4c41 4e43  n=cv2.INTER_LANC
-00004b50: 5a4f 5334 290a 2020 2020 2020 2020 656c  ZOS4).        el
-00004b60: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00004b70: 6c61 7267 6572 7363 616c 6572 203d 2033  largerscaler = 3
-00004b80: 3030 2e20 2f20 6865 6967 6874 0a20 2020  00. / height.   
-00004b90: 2020 2020 2020 2020 206e 6577 7769 6474           newwidt
-00004ba0: 6820 3d20 696e 7428 6365 696c 286c 6172  h = int(ceil(lar
-00004bb0: 6765 7273 6361 6c65 7220 2a20 7769 6474  gerscaler * widt
-00004bc0: 6829 290a 2020 2020 2020 2020 2020 2020  h)).            
-00004bd0: 7265 7369 7a65 645f 696d 6720 3d20 6376  resized_img = cv
-00004be0: 322e 7265 7369 7a65 2869 6e70 7574 5f61  2.resize(input_a
-00004bf0: 7272 2c20 286e 6577 7769 6474 682c 2033  rr, (newwidth, 3
-00004c00: 3030 292c 2069 6e74 6572 706f 6c61 7469  00), interpolati
-00004c10: 6f6e 3d63 7632 2e49 4e54 4552 5f4c 414e  on=cv2.INTER_LAN
-00004c20: 435a 4f53 3429 0a0a 2020 2020 2020 2020  CZOS4)..        
-00004c30: 6376 322e 696d 7772 6974 6528 6f75 7470  cv2.imwrite(outp
-00004c40: 7574 5f69 6d67 2c20 7265 7369 7a65 645f  ut_img, resized_
-00004c50: 696d 6729 0a0a 2020 2020 2020 2020 7265  img)..        re
-00004c60: 7475 726e 204e 6f6e 650a 0a20 2020 2064  turn None..    d
-00004c70: 6566 2073 6361 6c65 5f69 6d67 2873 656c  ef scale_img(sel
-00004c80: 662c 2070 726f 6a65 6374 696f 6e29 3a0a  f, projection):.
-00004c90: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00004ca0: 2020 2020 2020 2020 4769 7665 2074 6865          Give the
-00004cb0: 2070 726f 6a65 6374 696f 6e20 6173 2061   projection as a
-00004cc0: 2032 4420 6e75 6d70 7920 6172 7261 7920   2D numpy array 
-00004cd0: 7265 7475 726e 2074 6865 2073 6361 6c65  return the scale
-00004ce0: 6420 7072 6f6a 6563 7469 6f6e 0a20 2020  d projection.   
-00004cf0: 2020 2020 203a 7061 7261 6d20 7072 6f6a       :param proj
-00004d00: 6563 7469 6f6e 3a0a 2020 2020 2020 2020  ection:.        
-00004d10: 3a72 6574 7572 6e3a 0a20 2020 2020 2020  :return:.       
-00004d20: 2022 2222 0a0a 2020 2020 2020 2020 6f6e   """..        on
-00004d30: 6576 616c 7565 203d 2054 7275 6520 6966  evalue = True if
-00004d40: 2070 726f 6a65 6374 696f 6e2e 6d69 6e28   projection.min(
-00004d50: 2920 3d3d 2070 726f 6a65 6374 696f 6e2e  ) == projection.
-00004d60: 6d61 7828 2920 656c 7365 2046 616c 7365  max() else False
-00004d70: 0a20 2020 2020 2020 2069 6620 6f6e 6576  .        if onev
-00004d80: 616c 7565 3a0a 2020 2020 2020 2020 2020  alue:.          
-00004d90: 2020 7265 7363 616c 6564 203d 206e 702e    rescaled = np.
-00004da0: 6675 6c6c 2828 7072 6f6a 6563 7469 6f6e  full((projection
-00004db0: 2e73 6861 7065 292c 2030 2e30 292e 6173  .shape), 0.0).as
-00004dc0: 7479 7065 2827 7569 6e74 3827 290a 2020  type('uint8').  
-00004dd0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00004de0: 2020 2020 2020 2020 7265 7363 616c 6564          rescaled
-00004df0: 203d 2028 2828 7072 6f6a 6563 7469 6f6e   = (((projection
-00004e00: 202d 2070 726f 6a65 6374 696f 6e2e 6d69   - projection.mi
-00004e10: 6e28 2929 202a 2032 3535 2e30 2920 2f20  n()) * 255.0) / 
-00004e20: 2870 726f 6a65 6374 696f 6e2e 6d61 7828  (projection.max(
-00004e30: 2920 2d20 7072 6f6a 6563 7469 6f6e 2e6d  ) - projection.m
-00004e40: 696e 2829 2929 2e61 7374 7970 6528 0a20  in())).astype(. 
-00004e50: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00004e60: 7569 6e74 3827 290a 0a20 2020 2020 2020  uint8')..       
-00004e70: 2072 6574 7572 6e20 7265 7363 616c 6564   return rescaled
-00004e80: 0a0a 2020 2020 6465 6620 6765 745f 7072  ..    def get_pr
-00004e90: 6f6a 6563 7469 6f6e 2873 656c 662c 206d  ojection(self, m
-00004ea0: 6170 2c20 7479 7065 2c20 6178 6973 293a  ap, type, axis):
-00004eb0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00004ec0: 2020 2020 2020 2020 2047 6976 6520 6d61           Give ma
-00004ed0: 7020 616e 6420 7479 7065 2c20 6675 6e63  p and type, func
-00004ee0: 7469 6f6e 2070 726f 6475 6365 2064 6966  tion produce dif
-00004ef0: 6665 7265 6e74 2070 726f 6a65 6374 696f  ferent projectio
-00004f00: 6e0a 2020 2020 2020 2020 3a70 6172 616d  n.        :param
-00004f10: 206d 6170 3a20 6d72 6366 696c 6520 6d61   map: mrcfile ma
-00004f20: 7020 6f62 6a63 6574 0a20 2020 2020 2020  p objcet.       
-00004f30: 203a 7061 7261 6d20 7479 7065 3a20 7374   :param type: st
-00004f40: 7269 6e67 206f 6620 6e6f 726d 616c 2c20  ring of normal, 
-00004f50: 6d61 782c 206d 696e 2c20 7374 642c 206d  max, min, std, m
-00004f60: 6564 6961 6e2c 2063 656e 7472 616c 2c20  edian, central, 
-00004f70: 6c61 7267 6576 6172 0a20 2020 2020 2020  largevar.       
-00004f80: 203a 7061 7261 6d20 6178 6973 3a20 322d   :param axis: 2-
-00004f90: 3e78 2c20 302d 3e7a 2c20 312d 3e79 0a20  >x, 0->z, 1->y. 
-00004fa0: 2020 2020 2020 203a 7265 7475 726e 3a20         :return: 
-00004fb0: 6e75 6d70 7920 6172 7261 7920 6f72 204e  numpy array or N
-00004fc0: 6f6e 6520 666f 7220 7072 6f6a 6563 7469  one for projecti
-00004fd0: 6f6e 0a20 2020 2020 2020 2022 2222 0a0a  on.        """..
-00004fe0: 2020 2020 2020 2020 6d61 7064 6174 6120          mapdata 
-00004ff0: 3d20 6d61 702e 6461 7461 0a20 2020 2020  = map.data.     
-00005000: 2020 2069 6620 7479 7065 203d 3d20 2770     if type == 'p
-00005010: 726f 6a65 6374 696f 6e27 3a0a 2020 2020  rojection':.    
-00005020: 2020 2020 2020 2020 7072 6f6a 6563 7469          projecti
-00005030: 6f6e 203d 206e 702e 7375 6d28 6d61 7064  on = np.sum(mapd
-00005040: 6174 612c 2061 7869 733d 6178 6973 290a  ata, axis=axis).
-00005050: 2020 2020 2020 2020 656c 6966 2074 7970          elif typ
-00005060: 6520 3d3d 2027 6d61 7827 3a0a 2020 2020  e == 'max':.    
-00005070: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00005080: 6d65 7420 213d 2027 746f 6d6f 273a 0a20  met != 'tomo':. 
-00005090: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-000050a0: 726f 6a65 6374 696f 6e20 3d20 6e70 2e61  rojection = np.a
-000050b0: 6d61 7828 6d61 7064 6174 612c 2061 7869  max(mapdata, axi
-000050c0: 733d 6178 6973 290a 2020 2020 2020 2020  s=axis).        
-000050d0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000050e0: 2020 2020 2020 2020 2020 2320 746f 6d6f            # tomo
-000050f0: 6772 616d 7320 7573 6520 6d69 6e20 6f74  grams use min ot
-00005100: 6865 7273 2075 7365 206d 6178 0a20 2020  hers use max.   
-00005110: 2020 2020 2020 2020 2020 2020 2070 726f               pro
-00005120: 6a65 6374 696f 6e20 3d20 6e70 2e61 6d69  jection = np.ami
-00005130: 6e28 6d61 7064 6174 612c 2061 7869 733d  n(mapdata, axis=
-00005140: 6178 6973 290a 2020 2020 2020 2020 656c  axis).        el
-00005150: 6966 2074 7970 6520 3d3d 2027 6d69 6e27  if type == 'min'
-00005160: 3a0a 2020 2020 2020 2020 2020 2020 7072  :.            pr
-00005170: 6f6a 6563 7469 6f6e 203d 206e 702e 616d  ojection = np.am
-00005180: 696e 286d 6170 6461 7461 2c20 6178 6973  in(mapdata, axis
-00005190: 3d61 7869 7329 0a20 2020 2020 2020 2065  =axis).        e
-000051a0: 6c69 6620 7479 7065 203d 3d20 2773 7464  lif type == 'std
-000051b0: 273a 0a20 2020 2020 2020 2020 2020 2070  ':.            p
-000051c0: 726f 6a65 6374 696f 6e20 3d20 6e70 2e73  rojection = np.s
-000051d0: 7464 286d 6170 6461 7461 2c20 6178 6973  td(mapdata, axis
-000051e0: 3d61 7869 7329 0a20 2020 2020 2020 2065  =axis).        e
-000051f0: 6c69 6620 7479 7065 203d 3d20 276d 6564  lif type == 'med
-00005200: 6961 6e27 3a0a 2020 2020 2020 2020 2020  ian':.          
-00005210: 2020 7072 6f6a 6563 7469 6f6e 203d 206e    projection = n
-00005220: 702e 6d65 6469 616e 286d 6170 6461 7461  p.median(mapdata
-00005230: 2c20 6178 6973 3d61 7869 7329 0a20 2020  , axis=axis).   
-00005240: 2020 2020 2065 6c69 6620 7479 7065 203d       elif type =
-00005250: 3d20 2763 656e 7472 616c 273a 0a20 2020  = 'central':.   
-00005260: 2020 2020 2020 2020 2069 6620 6178 6973           if axis
-00005270: 203d 3d20 323a 0a20 2020 2020 2020 2020   == 2:.         
-00005280: 2020 2020 2020 2078 6d69 6420 3d20 696e         xmid = in
-00005290: 7428 666c 6f61 7428 6d61 702e 6865 6164  t(float(map.head
-000052a0: 6572 2e6e 7829 202f 2032 290a 2020 2020  er.nx) / 2).    
-000052b0: 2020 2020 2020 2020 2020 2020 7072 6f6a              proj
-000052c0: 6563 7469 6f6e 203d 206d 6170 2e64 6174  ection = map.dat
-000052d0: 615b 3a2c 203a 2c20 786d 6964 5d0a 2020  a[:, :, xmid].  
-000052e0: 2020 2020 2020 2020 2020 656c 6966 2061            elif a
-000052f0: 7869 7320 3d3d 2031 3a0a 2020 2020 2020  xis == 1:.      
-00005300: 2020 2020 2020 2020 2020 796d 6964 203d            ymid =
-00005310: 2069 6e74 2866 6c6f 6174 286d 6170 2e68   int(float(map.h
-00005320: 6561 6465 722e 6e79 2920 2f20 3229 0a20  eader.ny) / 2). 
-00005330: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00005340: 726f 6a65 6374 696f 6e20 3d20 6d61 702e  rojection = map.
-00005350: 6461 7461 5b3a 2c20 796d 6964 2c20 3a5d  data[:, ymid, :]
-00005360: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
-00005370: 6620 6178 6973 203d 3d20 303a 0a20 2020  f axis == 0:.   
-00005380: 2020 2020 2020 2020 2020 2020 207a 6d69               zmi
-00005390: 6420 3d20 696e 7428 666c 6f61 7428 6d61  d = int(float(ma
-000053a0: 702e 6865 6164 6572 2e6e 7a29 202f 2032  p.header.nz) / 2
-000053b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000053c0: 2020 7072 6f6a 6563 7469 6f6e 203d 206d    projection = m
-000053d0: 6170 2e64 6174 615b 7a6d 6964 2c20 3a2c  ap.data[zmid, :,
-000053e0: 203a 5d0a 2020 2020 2020 2020 2020 2020   :].            
-000053f0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00005400: 2020 2020 2020 7072 6f6a 6563 7469 6f6e        projection
-00005410: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-00005420: 2020 2020 2020 2020 7072 696e 7428 2757          print('W
-00005430: 726f 6e67 2061 7869 7320 696e 6465 7820  rong axis index 
-00005440: 2830 2c20 312c 2032 292e 2729 0a20 2020  (0, 1, 2).').   
-00005450: 2020 2020 2065 6c69 6620 7479 7065 203d       elif type =
-00005460: 3d20 276c 6172 6765 7374 7661 7269 616e  = 'largestvarian
-00005470: 6365 273a 0a20 2020 2020 2020 2020 2020  ce':.           
-00005480: 207a 6c69 6d2c 2079 6c69 6d2c 2078 6c69   zlim, ylim, xli
-00005490: 6d20 3d20 6d61 702e 6461 7461 2e73 6861  m = map.data.sha
-000054a0: 7065 0a20 2020 2020 2020 2020 2020 2069  pe.            i
-000054b0: 6620 6178 6973 203d 3d20 323a 0a20 2020  f axis == 2:.   
-000054c0: 2020 2020 2020 2020 2020 2020 2078 7661               xva
-000054d0: 7220 3d20 5b6e 6469 6d61 6765 2e76 6172  r = [ndimage.var
-000054e0: 6961 6e63 6528 6d61 702e 6461 7461 5b3a  iance(map.data[:
-000054f0: 2c20 3a2c 2069 5d29 2066 6f72 2069 2069  , :, i]) for i i
-00005500: 6e20 7261 6e67 6528 302c 2078 6c69 6d29  n range(0, xlim)
-00005510: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00005520: 2020 786c 6172 6765 696e 6420 3d20 696e    xlargeind = in
-00005530: 7428 6e70 2e61 7267 6d61 7828 7876 6172  t(np.argmax(xvar
-00005540: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-00005550: 2020 2070 726f 6a65 6374 696f 6e20 3d20     projection = 
-00005560: 6d61 702e 6461 7461 5b3a 2c20 3a2c 2078  map.data[:, :, x
-00005570: 6c61 7267 6569 6e64 5d0a 2020 2020 2020  largeind].      
-00005580: 2020 2020 2020 656c 6966 2061 7869 7320        elif axis 
-00005590: 3d3d 2031 3a0a 2020 2020 2020 2020 2020  == 1:.          
-000055a0: 2020 2020 2020 7976 6172 203d 205b 6e64        yvar = [nd
-000055b0: 696d 6167 652e 7661 7269 616e 6365 286d  image.variance(m
-000055c0: 6170 2e64 6174 615b 3a2c 2069 2c20 3a5d  ap.data[:, i, :]
-000055d0: 2920 666f 7220 6920 696e 2072 616e 6765  ) for i in range
-000055e0: 2830 2c20 796c 696d 295d 0a20 2020 2020  (0, ylim)].     
-000055f0: 2020 2020 2020 2020 2020 2079 6c61 7267             ylarg
-00005600: 6569 6e64 203d 2069 6e74 286e 702e 6172  eind = int(np.ar
-00005610: 676d 6178 2879 7661 7229 290a 2020 2020  gmax(yvar)).    
-00005620: 2020 2020 2020 2020 2020 2020 7072 6f6a              proj
-00005630: 6563 7469 6f6e 203d 206d 6170 2e64 6174  ection = map.dat
-00005640: 615b 3a2c 2079 6c61 7267 6569 6e64 2c20  a[:, ylargeind, 
-00005650: 3a5d 0a20 2020 2020 2020 2020 2020 2065  :].            e
-00005660: 6c69 6620 6178 6973 203d 3d20 303a 0a20  lif axis == 0:. 
-00005670: 2020 2020 2020 2020 2020 2020 2020 207a                 z
-00005680: 7661 7220 3d20 5b6e 6469 6d61 6765 2e76  var = [ndimage.v
-00005690: 6172 6961 6e63 6528 6d61 702e 6461 7461  ariance(map.data
-000056a0: 5b69 2c20 3a2c 203a 5d29 2066 6f72 2069  [i, :, :]) for i
-000056b0: 2069 6e20 7261 6e67 6528 302c 207a 6c69   in range(0, zli
-000056c0: 6d29 5d0a 2020 2020 2020 2020 2020 2020  m)].            
-000056d0: 2020 2020 7a6c 6172 6765 696e 6420 3d20      zlargeind = 
-000056e0: 696e 7428 6e70 2e61 7267 6d61 7828 7a76  int(np.argmax(zv
-000056f0: 6172 2929 0a20 2020 2020 2020 2020 2020  ar)).           
-00005700: 2020 2020 2070 726f 6a65 6374 696f 6e20       projection 
-00005710: 3d20 6d61 702e 6461 7461 5b7a 6c61 7267  = map.data[zlarg
-00005720: 6569 6e64 2c20 3a2c 203a 5d0a 2020 2020  eind, :, :].    
-00005730: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00005740: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-00005750: 6f6a 6563 7469 6f6e 203d 204e 6f6e 650a  ojection = None.
-00005760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005770: 7072 696e 7428 2757 726f 6e67 2061 7869  print('Wrong axi
-00005780: 7320 696e 6465 7820 2830 2c20 312c 2032  s index (0, 1, 2
-00005790: 292e 2729 0a20 2020 2020 2020 2065 6c73  ).').        els
-000057a0: 653a 0a20 2020 2020 2020 2020 2020 2070  e:.            p
-000057b0: 7269 6e74 2827 5772 6f6e 6720 7479 7065  rint('Wrong type
-000057c0: 2e20 5573 6520 6f6e 6520 6f66 3a20 7072  . Use one of: pr
-000057d0: 6f6a 6563 7469 6f6e 2c20 6d61 782c 206d  ojection, max, m
-000057e0: 696e 2c20 7374 642c 206d 6564 6961 6e2c  in, std, median,
-000057f0: 2063 656e 7472 616c 2c20 6c61 7267 6573   central, larges
-00005800: 7476 6172 6961 6e63 652e 2729 0a20 2020  tvariance.').   
-00005810: 2020 2020 2020 2020 2070 726f 6a65 6374           project
-00005820: 696f 6e20 3d20 4e6f 6e65 0a0a 2020 2020  ion = None..    
-00005830: 2020 2020 7265 7475 726e 2070 726f 6a65      return proje
-00005840: 6374 696f 6e0a 0a20 2020 2064 6566 2073  ction..    def s
-00005850: 6176 655f 7363 616c 6528 7365 6c66 2c20  ave_scale(self, 
-00005860: 7265 706f 7369 7469 6f6e 2c20 6178 6973  reposition, axis
-00005870: 5f6c 6574 7465 722c 206d 6170 6e61 6d65  _letter, mapname
-00005880: 2c20 7479 7065 2c20 6572 726c 6973 742c  , type, errlist,
-00005890: 2070 726f 635f 6675 6e3d 4e6f 6e65 293a   proc_fun=None):
-000058a0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-000058b0: 2020 2020 2020 2020 2066 756e 6374 696f           functio
-000058c0: 6e20 7361 7665 2074 6865 2069 6d61 6765  n save the image
-000058d0: 2061 6e64 2069 7420 7363 616c 6564 2069   and it scaled i
-000058e0: 6d61 6765 0a20 2020 2020 2020 203a 7061  mage.        :pa
-000058f0: 7261 6d20 7265 706f 7369 7469 6f6e 3a20  ram reposition: 
-00005900: 6e75 6d70 7920 6172 7261 7920 6f66 2074  numpy array of t
-00005910: 6865 2069 6d61 6765 0a20 2020 2020 2020  he image.       
-00005920: 203a 7061 7261 6d20 6178 6973 5f6c 6574   :param axis_let
-00005930: 7465 723a 2027 7827 2c20 2779 2720 6f72  ter: 'x', 'y' or
-00005940: 2027 7a27 0a20 2020 2020 2020 203a 7061   'z'.        :pa
-00005950: 7261 6d20 6d61 706e 616d 653a 2073 7472  ram mapname: str
-00005960: 696e 6720 6f66 2074 6865 206d 6170 206e  ing of the map n
-00005970: 616d 650a 2020 2020 2020 2020 3a70 6172  ame.        :par
-00005980: 616d 2074 7970 653a 206f 6e65 2073 7472  am type: one str
-00005990: 696e 6720 6f66 2070 726f 6a65 6374 696f  ing of projectio
-000059a0: 6e2c 206d 6178 2c20 6d69 6e2c 2073 7464  n, max, min, std
-000059b0: 2c20 6d65 6469 616e 2c20 6365 6e74 7261  , median, centra
-000059c0: 6c2c 206c 6172 6765 7374 7661 7269 616e  l, largestvarian
-000059d0: 6365 0a20 2020 2020 2020 203a 7061 7261  ce.        :para
-000059e0: 6d20 6572 726c 6973 743a 206c 6973 7420  m errlist: list 
-000059f0: 636f 6e74 6169 6e73 2065 7272 6f72 2073  contains error s
-00005a00: 7472 696e 670a 2020 2020 2020 2020 3a70  tring.        :p
-00005a10: 6172 616d 2070 726f 635f 6675 6e3a 2061  aram proc_fun: a
-00005a20: 2069 6d61 6765 2070 726f 6365 7373 696e   image processin
-00005a30: 6720 6675 6e63 7469 6f6e 2077 6869 6368  g function which
-00005a40: 2061 7070 6c69 6564 2074 6f20 7072 6f6a   applied to proj
-00005a50: 6563 7469 6f6e 2065 2e67 2e2c 2073 656c  ection e.g., sel
-00005a60: 662e 676c 6f77 696d 6167 6528 292c 0a20  f.glowimage(),. 
-00005a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005a80: 2020 2020 2020 2063 7632 2e61 7070 6c79         cv2.apply
-00005a90: 436f 6c6f 724d 6170 2878 666c 6970 7065  ColorMap(xflippe
-00005aa0: 642c 2063 7632 2e43 4f4c 4f52 4d41 505f  d, cv2.COLORMAP_
-00005ab0: 484f 5429 2872 6829 2c20 7365 6c66 2e6d  HOT)(rh), self.m
-00005ac0: 6f64 7265 6468 6f74 2879 726f 7461 7465  odredhot(yrotate
-00005ad0: 2928 6d6f 6472 6829 0a20 2020 2020 2020  )(modrh).       
-00005ae0: 203a 7265 7475 726e 3a20 4e6f 6e65 0a20   :return: None. 
-00005af0: 2020 2020 2020 2022 2222 0a0a 2020 2020         """..    
-00005b00: 2020 2020 6966 2070 726f 635f 6675 6e20      if proc_fun 
-00005b10: 3d3d 2073 656c 662e 676c 6f77 696d 6167  == self.glowimag
-00005b20: 653a 0a20 2020 2020 2020 2020 2020 2070  e:.            p
-00005b30: 726f 6a5f 696d 675f 6e61 6d65 203d 2027  roj_img_name = '
-00005b40: 7b7d 7b7d 5f67 6c6f 775f 7b7d 7b7d 2e6a  {}{}_glow_{}{}.j
-00005b50: 7065 6727 2e66 6f72 6d61 7428 7365 6c66  peg'.format(self
-00005b60: 2e77 6f72 6b64 6972 2c20 6d61 706e 616d  .workdir, mapnam
-00005b70: 652c 2061 7869 735f 6c65 7474 6572 2c20  e, axis_letter, 
-00005b80: 7479 7065 290a 2020 2020 2020 2020 2020  type).          
-00005b90: 2020 7363 616c 6564 5f70 726f 6a5f 696d    scaled_proj_im
-00005ba0: 675f 6e61 6d65 203d 2027 7b7d 7b7d 5f73  g_name = '{}{}_s
-00005bb0: 6361 6c65 645f 676c 6f77 5f7b 7d7b 7d2e  caled_glow_{}{}.
-00005bc0: 6a70 6567 272e 666f 726d 6174 2873 656c  jpeg'.format(sel
-00005bd0: 662e 776f 726b 6469 722c 206d 6170 6e61  f.workdir, mapna
-00005be0: 6d65 2c20 6178 6973 5f6c 6574 7465 722c  me, axis_letter,
-00005bf0: 2074 7970 6529 0a20 2020 2020 2020 2065   type).        e
-00005c00: 6c69 6620 7479 7065 203d 3d20 2763 656e  lif type == 'cen
-00005c10: 7472 616c 2720 6f72 2074 7970 6520 3d3d  tral' or type ==
-00005c20: 2027 6c61 7267 6573 7476 6172 6961 6e63   'largestvarianc
-00005c30: 6527 3a0a 2020 2020 2020 2020 2020 2020  e':.            
-00005c40: 7072 6f6a 5f69 6d67 5f6e 616d 6520 3d20  proj_img_name = 
-00005c50: 277b 7d7b 7d5f 7b7d 7b7d 5f73 6c69 6365  '{}{}_{}{}_slice
-00005c60: 2e6a 7065 6727 2e66 6f72 6d61 7428 7365  .jpeg'.format(se
-00005c70: 6c66 2e77 6f72 6b64 6972 2c20 6d61 706e  lf.workdir, mapn
-00005c80: 616d 652c 2061 7869 735f 6c65 7474 6572  ame, axis_letter
-00005c90: 2c20 7479 7065 290a 2020 2020 2020 2020  , type).        
-00005ca0: 2020 2020 7363 616c 6564 5f70 726f 6a5f      scaled_proj_
-00005cb0: 696d 675f 6e61 6d65 203d 2027 7b7d 7b7d  img_name = '{}{}
-00005cc0: 5f73 6361 6c65 645f 7b7d 7b7d 5f73 6c69  _scaled_{}{}_sli
-00005cd0: 6365 2e6a 7065 6727 2e66 6f72 6d61 7428  ce.jpeg'.format(
-00005ce0: 7365 6c66 2e77 6f72 6b64 6972 2c20 6d61  self.workdir, ma
-00005cf0: 706e 616d 652c 2061 7869 735f 6c65 7474  pname, axis_lett
-00005d00: 6572 2c20 7479 7065 290a 2020 2020 2020  er, type).      
-00005d10: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00005d20: 2020 2020 7072 6f6a 5f69 6d67 5f6e 616d      proj_img_nam
-00005d30: 6520 3d20 277b 7d7b 7d5f 7b7d 7b7d 2e6a  e = '{}{}_{}{}.j
-00005d40: 7065 6727 2e66 6f72 6d61 7428 7365 6c66  peg'.format(self
-00005d50: 2e77 6f72 6b64 6972 2c20 6d61 706e 616d  .workdir, mapnam
-00005d60: 652c 2061 7869 735f 6c65 7474 6572 2c20  e, axis_letter, 
-00005d70: 7479 7065 290a 2020 2020 2020 2020 2020  type).          
-00005d80: 2020 7363 616c 6564 5f70 726f 6a5f 696d    scaled_proj_im
-00005d90: 675f 6e61 6d65 203d 2027 7b7d 7b7d 5f73  g_name = '{}{}_s
-00005da0: 6361 6c65 645f 7b7d 7b7d 2e6a 7065 6727  caled_{}{}.jpeg'
-00005db0: 2e66 6f72 6d61 7428 7365 6c66 2e77 6f72  .format(self.wor
-00005dc0: 6b64 6972 2c20 6d61 706e 616d 652c 2061  kdir, mapname, a
-00005dd0: 7869 735f 6c65 7474 6572 2c20 7479 7065  xis_letter, type
-00005de0: 290a 0a0a 2020 2020 2020 2020 7472 793a  )...        try:
-00005df0: 0a20 2020 2020 2020 2020 2020 2063 7632  .            cv2
-00005e00: 2e69 6d77 7269 7465 2870 726f 6a5f 696d  .imwrite(proj_im
-00005e10: 675f 6e61 6d65 2c20 7265 706f 7369 7469  g_name, repositi
-00005e20: 6f6e 290a 2020 2020 2020 2020 6578 6365  on).        exce
-00005e30: 7074 2049 4f45 7272 6f72 2061 7320 696f  pt IOError as io
-00005e40: 6572 723a 0a20 2020 2020 2020 2020 2020  err:.           
-00005e50: 2069 6620 7072 6f63 5f66 756e 203d 3d20   if proc_fun == 
-00005e60: 7365 6c66 2e67 6c6f 7769 6d61 6765 3a0a  self.glowimage:.
-00005e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005e80: 6572 7220 3d20 2753 6176 696e 6720 7b7d  err = 'Saving {}
-00005e90: 7b7d 2067 6c6f 7720 7072 6f6a 6563 7469  {} glow projecti
-00005ea0: 6f6e 2065 7272 3a7b 7d27 2e66 6f72 6d61  on err:{}'.forma
-00005eb0: 7428 6178 6973 5f6c 6574 7465 722c 2074  t(axis_letter, t
-00005ec0: 7970 652c 2069 6f65 7272 290a 2020 2020  ype, ioerr).    
-00005ed0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00005ee0: 2020 2020 2020 2020 2020 2020 2020 6572                er
-00005ef0: 7220 3d20 2753 6176 696e 6720 6f72 6967  r = 'Saving orig
-00005f00: 696e 616c 207b 7d7b 7d20 6572 723a 7b7d  inal {}{} err:{}
-00005f10: 272e 666f 726d 6174 2861 7869 735f 6c65  '.format(axis_le
-00005f20: 7474 6572 2c20 7479 7065 2c20 696f 6572  tter, type, ioer
-00005f30: 7229 0a20 2020 2020 2020 2020 2020 2065  r).            e
-00005f40: 7272 6c69 7374 2e61 7070 656e 6428 6572  rrlist.append(er
-00005f50: 7229 0a20 2020 2020 2020 2020 2020 2073  r).            s
-00005f60: 7973 2e73 7464 6572 722e 7772 6974 6528  ys.stderr.write(
-00005f70: 6572 7220 2b20 275c 6e27 290a 0a20 2020  err + '\n')..   
-00005f80: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00005f90: 2020 2020 2020 7365 6c66 2e72 6573 697a        self.resiz
-00005fa0: 655f 696d 6728 7265 706f 7369 7469 6f6e  e_img(reposition
-00005fb0: 2c20 7363 616c 6564 5f70 726f 6a5f 696d  , scaled_proj_im
-00005fc0: 675f 6e61 6d65 290a 2020 2020 2020 2020  g_name).        
-00005fd0: 6578 6365 7074 3a0a 2020 2020 2020 2020  except:.        
-00005fe0: 2020 2020 6966 2070 726f 635f 6675 6e20      if proc_fun 
-00005ff0: 3d3d 2073 656c 662e 676c 6f77 696d 6167  == self.glowimag
-00006000: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00006010: 2020 2065 7272 203d 2027 5361 7669 6e67     err = 'Saving
-00006020: 2073 6361 6c65 6420 676c 6f77 2069 6d61   scaled glow ima
-00006030: 6765 207b 7d7b 7d20 6572 723a 7b7d 272e  ge {}{} err:{}'.
-00006040: 666f 726d 6174 2861 7869 735f 6c65 7474  format(axis_lett
-00006050: 6572 2c20 7479 7065 2c20 7379 732e 6578  er, type, sys.ex
-00006060: 635f 696e 666f 2829 5b31 5d29 0a20 2020  c_info()[1]).   
-00006070: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00006080: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00006090: 7272 203d 2027 5361 7669 6e67 2073 6361  rr = 'Saving sca
-000060a0: 6c65 6420 7b7d 207b 7d20 6572 723a 7b7d  led {} {} err:{}
-000060b0: 272e 666f 726d 6174 2861 7869 735f 6c65  '.format(axis_le
-000060c0: 7474 6572 2c20 7479 7065 2c20 7379 732e  tter, type, sys.
-000060d0: 6578 635f 696e 666f 2829 5b31 5d29 0a20  exc_info()[1]). 
-000060e0: 2020 2020 2020 2020 2020 2065 7272 6c69             errli
-000060f0: 7374 2e61 7070 656e 6428 6572 7229 0a20  st.append(err). 
-00006100: 2020 2020 2020 2020 2020 2073 7973 2e73             sys.s
-00006110: 7464 6572 722e 7772 6974 6528 6572 7220  tderr.write(err 
-00006120: 2b20 275c 6e27 290a 0a20 2020 2020 2020  + '\n')..       
-00006130: 2072 6574 7572 6e20 4e6f 6e65 0a0a 2020   return None..  
-00006140: 2020 6465 6620 6d61 705f 746f 5f69 6d67    def map_to_img
-00006150: 2873 656c 662c 206d 6170 2c20 6178 6973  (self, map, axis
-00006160: 2c20 7479 7065 2c20 6572 726c 6973 742c  , type, errlist,
-00006170: 2070 726f 635f 6675 6e3d 4e6f 6e65 293a   proc_fun=None):
-00006180: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00006190: 2020 2020 2020 2020 2047 6976 6520 7468           Give th
-000061a0: 6520 6d61 7064 6174 612c 206f 7574 7075  e mapdata, outpu
-000061b0: 7420 6669 6c65 206e 616d 652c 2064 696d  t file name, dim
-000061c0: 656e 7369 6f6e 2061 6e64 2065 7272 6c69  ension and errli
-000061d0: 7374 2069 7420 7072 6f64 7563 6520 7468  st it produce th
-000061e0: 6520 636f 7272 6573 706f 646e 696e 6720  e correspodning 
-000061f0: 7072 6f6a 6563 7469 6f6e 0a20 2020 2020  projection.     
-00006200: 2020 203a 7061 7261 6d20 6d61 703a 206d     :param map: m
-00006210: 7263 6669 6c65 206f 626a 6563 740a 2020  rcfile object.  
-00006220: 2020 2020 2020 3a70 6172 616d 2061 7869        :param axi
-00006230: 733a 2032 2d3e 782c 2030 2d3e 7a2c 2031  s: 2->x, 0->z, 1
-00006240: 2d3e 790a 2020 2020 2020 2020 3a70 6172  ->y.        :par
-00006250: 616d 206f 7574 7075 745f 6e61 6d65 3a20  am output_name: 
-00006260: 7374 7269 6e67 206f 6620 6f75 7470 7574  string of output
-00006270: 2066 696c 6520 6e61 6d65 0a20 2020 2020   file name.     
-00006280: 2020 203a 7061 7261 6d20 6572 726c 6973     :param errlis
-00006290: 743a 206c 6973 7420 666f 7220 6572 726f  t: list for erro
-000062a0: 7220 7374 7269 6e67 0a20 2020 2020 2020  r string.       
-000062b0: 203a 7061 7261 6d20 7072 6f63 5f66 756e   :param proc_fun
-000062c0: 3a20 6120 696d 6167 6520 7072 6f63 6573  : a image proces
-000062d0: 7369 6e67 2066 756e 6374 696f 6e20 7768  sing function wh
-000062e0: 6963 6820 6170 706c 6965 6420 746f 2070  ich applied to p
-000062f0: 726f 6a65 6374 696f 6e20 652e 672e 2c20  rojection e.g., 
-00006300: 7365 6c66 2e67 6c6f 7769 6d61 6765 2829  self.glowimage()
-00006310: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00006320: 2020 2020 2020 2020 2020 6376 322e 6170            cv2.ap
-00006330: 706c 7943 6f6c 6f72 4d61 7028 7866 6c69  plyColorMap(xfli
-00006340: 7070 6564 2c20 6376 322e 434f 4c4f 524d  pped, cv2.COLORM
-00006350: 4150 5f48 4f54 2928 7268 292c 2073 656c  AP_HOT)(rh), sel
-00006360: 662e 6d6f 6472 6564 686f 7428 7972 6f74  f.modredhot(yrot
-00006370: 6174 6529 286d 6f64 7268 290a 2020 2020  ate)(modrh).    
-00006380: 2020 2020 3a72 6574 7572 6e3a 204e 6f6e      :return: Non
-00006390: 650a 2020 2020 2020 2020 2222 220a 0a20  e.        """.. 
-000063a0: 2020 2020 2020 2070 726f 6a65 6374 696f         projectio
-000063b0: 6e20 3d20 7365 6c66 2e67 6574 5f70 726f  n = self.get_pro
-000063c0: 6a65 6374 696f 6e28 6d61 702c 2074 7970  jection(map, typ
-000063d0: 652c 2061 7869 7329 0a20 2020 2020 2020  e, axis).       
-000063e0: 2072 6573 6361 6c65 6420 3d20 7365 6c66   rescaled = self
-000063f0: 2e73 6361 6c65 5f69 6d67 2870 726f 6a65  .scale_img(proje
-00006400: 6374 696f 6e29 0a20 2020 2020 2020 2069  ction).        i
-00006410: 6620 6178 6973 203d 3d20 323a 0a20 2020  f axis == 2:.   
-00006420: 2020 2020 2020 2020 2072 6570 6f73 6974           reposit
-00006430: 696f 6e20 3d20 6e70 2e66 6c69 7075 6428  ion = np.flipud(
-00006440: 7265 7363 616c 6564 290a 2020 2020 2020  rescaled).      
-00006450: 2020 2020 2020 6178 6973 5f6c 6574 7465        axis_lette
-00006460: 7220 3d20 2778 270a 2020 2020 2020 2020  r = 'x'.        
-00006470: 656c 6966 2061 7869 7320 3d3d 2031 3a0a  elif axis == 1:.
-00006480: 2020 2020 2020 2020 2020 2020 7265 706f              repo
-00006490: 7369 7469 6f6e 203d 206e 702e 726f 7439  sition = np.rot9
-000064a0: 3028 7265 7363 616c 6564 290a 2020 2020  0(rescaled).    
-000064b0: 2020 2020 2020 2020 6178 6973 5f6c 6574          axis_let
-000064c0: 7465 7220 3d20 2779 270a 2020 2020 2020  ter = 'y'.      
-000064d0: 2020 656c 6966 2061 7869 7320 3d3d 2030    elif axis == 0
-000064e0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-000064f0: 706f 7369 7469 6f6e 203d 206e 702e 666c  position = np.fl
-00006500: 6970 7564 2872 6573 6361 6c65 6429 0a20  ipud(rescaled). 
-00006510: 2020 2020 2020 2020 2020 2061 7869 735f             axis_
-00006520: 6c65 7474 6572 203d 2027 7a27 0a20 2020  letter = 'z'.   
-00006530: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00006540: 2020 2020 2020 2072 6570 6f73 6974 696f         repositio
-00006550: 6e20 3d20 4e6f 6e65 0a20 2020 2020 2020  n = None.       
-00006560: 2020 2020 2061 7869 735f 6c65 7474 6572       axis_letter
-00006570: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-00006580: 2020 2020 7072 696e 7428 2761 7869 7320      print('axis 
-00006590: 7368 6f75 6c64 2062 6520 302c 2031 2c20  should be 0, 1, 
-000065a0: 3220 7265 7072 6573 656e 7420 7a2c 2079  2 represent z, y
-000065b0: 2c20 782e 2729 0a0a 2020 2020 2020 2020  , x.')..        
-000065c0: 6966 2072 6570 6f73 6974 696f 6e20 6973  if reposition is
-000065d0: 206e 6f74 204e 6f6e 6520 616e 6420 6178   not None and ax
-000065e0: 6973 5f6c 6574 7465 7220 6973 206e 6f74  is_letter is not
-000065f0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00006600: 2020 206d 6170 6e61 6d65 203d 206f 732e     mapname = os.
-00006610: 7061 7468 2e62 6173 656e 616d 6528 6d61  path.basename(ma
-00006620: 702e 6675 6c6c 6e61 6d65 290a 2020 2020  p.fullname).    
-00006630: 2020 2020 2020 2020 7365 6c66 2e73 6176          self.sav
-00006640: 655f 7363 616c 6528 7265 706f 7369 7469  e_scale(repositi
-00006650: 6f6e 2c20 6178 6973 5f6c 6574 7465 722c  on, axis_letter,
-00006660: 206d 6170 6e61 6d65 2c20 7479 7065 2c20   mapname, type, 
-00006670: 6572 726c 6973 7429 0a20 2020 2020 2020  errlist).       
-00006680: 2020 2020 2069 6620 7072 6f63 5f66 756e       if proc_fun
-00006690: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000066a0: 2020 676c 6f77 696d 6167 6520 3d20 7072    glowimage = pr
-000066b0: 6f63 5f66 756e 2872 6570 6f73 6974 696f  oc_fun(repositio
-000066c0: 6e29 0a20 2020 2020 2020 2020 2020 2020  n).             
-000066d0: 2020 2073 656c 662e 7361 7665 5f73 6361     self.save_sca
-000066e0: 6c65 2867 6c6f 7769 6d61 6765 2c20 6178  le(glowimage, ax
-000066f0: 6973 5f6c 6574 7465 722c 206d 6170 6e61  is_letter, mapna
-00006700: 6d65 2c20 7479 7065 2c20 6572 726c 6973  me, type, errlis
-00006710: 742c 2070 726f 635f 6675 6e29 0a0a 2020  t, proc_fun)..  
-00006720: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
-00006730: 650a 0a20 2020 2023 2040 7072 6f66 696c  e..    # @profil
-00006740: 650a 2020 2020 6465 6620 6f72 7468 6f67  e.    def orthog
-00006750: 6f6e 616c 5f70 726f 6a65 6374 696f 6e73  onal_projections
-00006760: 2873 656c 662c 206d 6170 696e 3d4e 6f6e  (self, mapin=Non
-00006770: 652c 2077 6f72 6b64 6972 3d4e 6f6e 652c  e, workdir=None,
-00006780: 206c 6162 656c 3d27 2729 3a0a 2020 2020   label=''):.    
-00006790: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-000067a0: 2020 2020 2053 7464 2070 726f 6a65 6374       Std project
-000067b0: 696f 6e20 616e 6420 6974 2067 6c6f 7720  ion and it glow 
-000067c0: 696d 6167 650a 2020 2020 2020 2020 3a70  image.        :p
-000067d0: 6172 616d 206d 6170 696e 3a20 496e 7075  aram mapin: Inpu
-000067e0: 7420 6d61 7020 6569 7468 6572 206d 7263  t map either mrc
-000067f0: 6669 6c65 206f 7220 6669 6c65 6e61 6d65  file or filename
-00006800: 2073 7472 696e 670a 2020 2020 2020 2020   string.        
-00006810: 3a70 6172 616d 2077 6f72 6b64 6972 3a20  :param workdir: 
-00006820: 5374 7269 6e67 206f 6620 7468 6520 6675  String of the fu
-00006830: 6c6c 2077 6f72 6b20 7061 7468 0a20 2020  ll work path.   
-00006840: 2020 2020 203a 7061 7261 6d20 6c61 6265       :param labe
-00006850: 6c3a 2066 6f72 2072 6177 206d 6170 2075  l: for raw map u
-00006860: 7365 2027 7261 775f 270a 2020 2020 2020  se 'raw_'.      
-00006870: 2020 3a72 6574 7572 6e3a 204e 6f6e 650a    :return: None.
-00006880: 2020 2020 2020 2020 2222 220a 0a20 2020          """..   
-00006890: 2020 2020 206d 6170 2c20 776f 726b 6469       map, workdi
-000068a0: 7220 3d20 7365 6c66 2e6d 6170 696e 6368  r = self.mapinch
-000068b0: 6563 6b28 6d61 7069 6e2c 2077 6f72 6b64  eck(mapin, workd
-000068c0: 6972 290a 2020 2020 2020 2020 6d61 706e  ir).        mapn
-000068d0: 616d 6520 3d20 6f73 2e70 6174 682e 6261  ame = os.path.ba
-000068e0: 7365 6e61 6d65 286d 6170 2e66 756c 6c6e  sename(map.fulln
-000068f0: 616d 6529 2069 6620 6d61 7020 656c 7365  ame) if map else
-00006900: 204e 6f6e 650a 2020 2020 2020 2020 6966   None.        if
-00006910: 206d 6170 2069 7320 6e6f 7420 4e6f 6e65   map is not None
-00006920: 2061 6e64 2077 6f72 6b64 6972 2069 7320   and workdir is 
-00006930: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00006940: 2020 2020 2020 7374 6172 7420 3d20 7469        start = ti
-00006950: 6d65 6974 2e64 6566 6175 6c74 5f74 696d  meit.default_tim
-00006960: 6572 2829 0a20 2020 2020 2020 2020 2020  er().           
-00006970: 2065 7272 6c69 7374 203d 205b 5d0a 2020   errlist = [].  
-00006980: 2020 2020 2020 2020 2020 7479 7065 203d            type =
-00006990: 2027 7072 6f6a 6563 7469 6f6e 270a 0a20   'projection'.. 
-000069a0: 2020 2020 2020 2020 2020 2078 7072 6f6a             xproj
-000069b0: 6563 7469 6f6e 6e61 6d65 203d 2077 6f72  ectionname = wor
-000069c0: 6b64 6972 202b 206d 6170 6e61 6d65 202b  kdir + mapname +
-000069d0: 2027 5f78 7072 6f6a 6563 7469 6f6e 2e6a   '_xprojection.j
-000069e0: 7065 6727 0a20 2020 2020 2020 2020 2020  peg'.           
-000069f0: 2078 7363 616c 656e 616d 6520 3d20 776f   xscalename = wo
-00006a00: 726b 6469 7220 2b20 6d61 706e 616d 6520  rkdir + mapname 
-00006a10: 2b20 275f 7363 616c 6564 5f78 7072 6f6a  + '_scaled_xproj
-00006a20: 6563 7469 6f6e 2e6a 7065 6727 0a20 2020  ection.jpeg'.   
-00006a30: 2020 2020 2020 2020 2067 6c6f 7778 7072           glowxpr
-00006a40: 6f6a 6563 7469 6f6e 6e61 6d65 203d 2077  ojectionname = w
-00006a50: 6f72 6b64 6972 202b 206d 6170 6e61 6d65  orkdir + mapname
-00006a60: 202b 2027 5f67 6c6f 775f 7870 726f 6a65   + '_glow_xproje
-00006a70: 6374 696f 6e2e 6a70 6567 270a 2020 2020  ction.jpeg'.    
-00006a80: 2020 2020 2020 2020 676c 6f77 7873 6361          glowxsca
-00006a90: 6c65 6e61 6d65 203d 2077 6f72 6b64 6972  lename = workdir
-00006aa0: 202b 206d 6170 6e61 6d65 202b 2027 5f73   + mapname + '_s
-00006ab0: 6361 6c65 645f 676c 6f77 5f78 7072 6f6a  caled_glow_xproj
-00006ac0: 6563 7469 6f6e 2e6a 7065 6727 0a20 2020  ection.jpeg'.   
-00006ad0: 2020 2020 2020 2020 2073 656c 662e 6d61           self.ma
-00006ae0: 705f 746f 5f69 6d67 286d 6170 2c20 322c  p_to_img(map, 2,
-00006af0: 2074 7970 652c 2065 7272 6c69 7374 2c20   type, errlist, 
-00006b00: 7365 6c66 2e67 6c6f 7769 6d61 6765 290a  self.glowimage).
-00006b10: 0a20 2020 2020 2020 2020 2020 2079 7072  .            ypr
-00006b20: 6f6a 6563 7469 6f6e 6e61 6d65 203d 2077  ojectionname = w
-00006b30: 6f72 6b64 6972 202b 206d 6170 6e61 6d65  orkdir + mapname
-00006b40: 202b 2027 5f79 7072 6f6a 6563 7469 6f6e   + '_yprojection
-00006b50: 2e6a 7065 6727 0a20 2020 2020 2020 2020  .jpeg'.         
-00006b60: 2020 2079 7363 616c 656e 616d 6520 3d20     yscalename = 
-00006b70: 776f 726b 6469 7220 2b20 6d61 706e 616d  workdir + mapnam
-00006b80: 6520 2b20 275f 7363 616c 6564 5f79 7072  e + '_scaled_ypr
-00006b90: 6f6a 6563 7469 6f6e 2e6a 7065 6727 0a20  ojection.jpeg'. 
-00006ba0: 2020 2020 2020 2020 2020 2067 6c6f 7779             glowy
-00006bb0: 7072 6f6a 6563 7469 6f6e 6e61 6d65 203d  projectionname =
-00006bc0: 2077 6f72 6b64 6972 202b 206d 6170 6e61   workdir + mapna
-00006bd0: 6d65 202b 2027 5f67 6c6f 775f 7970 726f  me + '_glow_ypro
-00006be0: 6a65 6374 696f 6e2e 6a70 6567 270a 2020  jection.jpeg'.  
-00006bf0: 2020 2020 2020 2020 2020 676c 6f77 7973            glowys
-00006c00: 6361 6c65 6e61 6d65 203d 2077 6f72 6b64  calename = workd
-00006c10: 6972 202b 206d 6170 6e61 6d65 202b 2027  ir + mapname + '
-00006c20: 5f73 6361 6c65 645f 676c 6f77 5f79 7072  _scaled_glow_ypr
-00006c30: 6f6a 6563 7469 6f6e 2e6a 7065 6727 0a20  ojection.jpeg'. 
-00006c40: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00006c50: 6d61 705f 746f 5f69 6d67 286d 6170 2c20  map_to_img(map, 
-00006c60: 312c 2074 7970 652c 2065 7272 6c69 7374  1, type, errlist
-00006c70: 2c20 7365 6c66 2e67 6c6f 7769 6d61 6765  , self.glowimage
-00006c80: 290a 0a20 2020 2020 2020 2020 2020 207a  )..            z
-00006c90: 7072 6f6a 6563 7469 6f6e 6e61 6d65 203d  projectionname =
-00006ca0: 2077 6f72 6b64 6972 202b 206d 6170 6e61   workdir + mapna
-00006cb0: 6d65 202b 2027 5f7a 7072 6f6a 6563 7469  me + '_zprojecti
-00006cc0: 6f6e 2e6a 7065 6727 0a20 2020 2020 2020  on.jpeg'.       
-00006cd0: 2020 2020 207a 7363 616c 656e 616d 6520       zscalename 
-00006ce0: 3d20 776f 726b 6469 7220 2b20 6d61 706e  = workdir + mapn
-00006cf0: 616d 6520 2b20 275f 7363 616c 6564 5f7a  ame + '_scaled_z
-00006d00: 7072 6f6a 6563 7469 6f6e 2e6a 7065 6727  projection.jpeg'
-00006d10: 0a20 2020 2020 2020 2020 2020 2067 6c6f  .            glo
-00006d20: 777a 7072 6f6a 6563 7469 6f6e 6e61 6d65  wzprojectionname
-00006d30: 203d 2077 6f72 6b64 6972 202b 206d 6170   = workdir + map
-00006d40: 6e61 6d65 202b 2027 5f67 6c6f 775f 7a70  name + '_glow_zp
-00006d50: 726f 6a65 6374 696f 6e2e 6a70 6567 270a  rojection.jpeg'.
-00006d60: 2020 2020 2020 2020 2020 2020 676c 6f77              glow
-00006d70: 7a73 6361 6c65 6e61 6d65 203d 2077 6f72  zscalename = wor
-00006d80: 6b64 6972 202b 206d 6170 6e61 6d65 202b  kdir + mapname +
-00006d90: 2027 5f73 6361 6c65 645f 676c 6f77 5f7a   '_scaled_glow_z
-00006da0: 7072 6f6a 6563 7469 6f6e 2e6a 7065 6727  projection.jpeg'
-00006db0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00006dc0: 662e 6d61 705f 746f 5f69 6d67 286d 6170  f.map_to_img(map
-00006dd0: 2c20 302c 2074 7970 652c 2065 7272 6c69  , 0, type, errli
-00006de0: 7374 2c20 7365 6c66 2e67 6c6f 7769 6d61  st, self.glowima
-00006df0: 6765 290a 0a20 2020 2020 2020 2020 2020  ge)..           
-00006e00: 2062 6f74 686a 736f 6e20 3d20 6469 6374   bothjson = dict
-00006e10: 2829 0a20 2020 2020 2020 2020 2020 2070  ().            p
-00006e20: 726f 6a65 6374 696f 6e6a 736f 6e20 3d20  rojectionjson = 
-00006e30: 6469 6374 2829 0a20 2020 2020 2020 2020  dict().         
-00006e40: 2020 206f 7267 7072 6f6a 6563 7469 6f6e     orgprojection
-00006e50: 6a73 6f6e 203d 2064 6963 7428 290a 0a20  json = dict().. 
-00006e60: 2020 2020 2020 2020 2020 2070 726f 6a65             proje
-00006e70: 6374 696f 6e6a 736f 6e5b 2778 275d 203d  ctionjson['x'] =
-00006e80: 206f 732e 7061 7468 2e62 6173 656e 616d   os.path.basenam
-00006e90: 6528 7873 6361 6c65 6e61 6d65 2920 6966  e(xscalename) if
-00006ea0: 206f 732e 7061 7468 2e69 7366 696c 6528   os.path.isfile(
-00006eb0: 7873 6361 6c65 6e61 6d65 2920 656c 7365  xscalename) else
-00006ec0: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
-00006ed0: 2020 7072 6f6a 6563 7469 6f6e 6a73 6f6e    projectionjson
-00006ee0: 5b27 7927 5d20 3d20 6f73 2e70 6174 682e  ['y'] = os.path.
-00006ef0: 6261 7365 6e61 6d65 2879 7363 616c 656e  basename(yscalen
-00006f00: 616d 6529 2069 6620 6f73 2e70 6174 682e  ame) if os.path.
-00006f10: 6973 6669 6c65 2879 7363 616c 656e 616d  isfile(yscalenam
-00006f20: 6529 2065 6c73 6520 4e6f 6e65 0a20 2020  e) else None.   
-00006f30: 2020 2020 2020 2020 2070 726f 6a65 6374           project
-00006f40: 696f 6e6a 736f 6e5b 277a 275d 203d 206f  ionjson['z'] = o
-00006f50: 732e 7061 7468 2e62 6173 656e 616d 6528  s.path.basename(
-00006f60: 7a73 6361 6c65 6e61 6d65 2920 6966 206f  zscalename) if o
-00006f70: 732e 7061 7468 2e69 7366 696c 6528 7a73  s.path.isfile(zs
-00006f80: 6361 6c65 6e61 6d65 2920 656c 7365 204e  calename) else N
-00006f90: 6f6e 650a 0a20 2020 2020 2020 2020 2020  one..           
-00006fa0: 206f 7267 7072 6f6a 6563 7469 6f6e 6a73   orgprojectionjs
-00006fb0: 6f6e 5b27 7827 5d20 3d20 6f73 2e70 6174  on['x'] = os.pat
-00006fc0: 682e 6261 7365 6e61 6d65 2878 7072 6f6a  h.basename(xproj
-00006fd0: 6563 7469 6f6e 6e61 6d65 2920 6966 206f  ectionname) if o
-00006fe0: 732e 7061 7468 2e69 7366 696c 6528 7870  s.path.isfile(xp
-00006ff0: 726f 6a65 6374 696f 6e6e 616d 6529 2065  rojectionname) e
-00007000: 6c73 6520 4e6f 6e65 0a20 2020 2020 2020  lse None.       
-00007010: 2020 2020 206f 7267 7072 6f6a 6563 7469       orgprojecti
-00007020: 6f6e 6a73 6f6e 5b27 7927 5d20 3d20 6f73  onjson['y'] = os
-00007030: 2e70 6174 682e 6261 7365 6e61 6d65 2879  .path.basename(y
-00007040: 7072 6f6a 6563 7469 6f6e 6e61 6d65 2920  projectionname) 
-00007050: 6966 206f 732e 7061 7468 2e69 7366 696c  if os.path.isfil
-00007060: 6528 7970 726f 6a65 6374 696f 6e6e 616d  e(yprojectionnam
-00007070: 6529 2065 6c73 6520 4e6f 6e65 0a20 2020  e) else None.   
-00007080: 2020 2020 2020 2020 206f 7267 7072 6f6a           orgproj
-00007090: 6563 7469 6f6e 6a73 6f6e 5b27 7a27 5d20  ectionjson['z'] 
-000070a0: 3d20 6f73 2e70 6174 682e 6261 7365 6e61  = os.path.basena
-000070b0: 6d65 287a 7072 6f6a 6563 7469 6f6e 6e61  me(zprojectionna
-000070c0: 6d65 2920 6966 206f 732e 7061 7468 2e69  me) if os.path.i
-000070d0: 7366 696c 6528 7a70 726f 6a65 6374 696f  sfile(zprojectio
-000070e0: 6e6e 616d 6529 2065 6c73 6520 4e6f 6e65  nname) else None
-000070f0: 0a20 2020 2020 2020 2020 2020 2062 6f74  .            bot
-00007100: 686a 736f 6e5b 276f 7269 6769 6e61 6c27  hjson['original'
-00007110: 5d20 3d20 6f72 6770 726f 6a65 6374 696f  ] = orgprojectio
-00007120: 6e6a 736f 6e0a 2020 2020 2020 2020 2020  njson.          
-00007130: 2020 626f 7468 6a73 6f6e 5b27 7363 616c    bothjson['scal
-00007140: 6564 275d 203d 2070 726f 6a65 6374 696f  ed'] = projectio
-00007150: 6e6a 736f 6e0a 0a20 2020 2020 2020 2020  njson..         
-00007160: 2020 2069 6620 6572 726c 6973 743a 0a20     if errlist:. 
-00007170: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-00007180: 6f74 686a 736f 6e5b 2765 7272 275d 203d  othjson['err'] =
-00007190: 207b 276f 7274 686f 676f 6e61 6c5f 7072   {'orthogonal_pr
-000071a0: 6f6a 6563 7469 6f6e 5f65 7272 273a 2065  ojection_err': e
-000071b0: 7272 6c69 7374 7d0a 2020 2020 2020 2020  rrlist}.        
-000071c0: 2020 2020 6669 6e61 6c64 6963 7420 3d20      finaldict = 
-000071d0: 7b6c 6162 656c 202b 2027 6f72 7468 6f67  {label + 'orthog
-000071e0: 6f6e 616c 5f70 726f 6a65 6374 696f 6e27  onal_projection'
-000071f0: 3a20 626f 7468 6a73 6f6e 7d0a 0a20 2020  : bothjson}..   
-00007200: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-00007210: 2020 2020 2020 2020 2020 2020 2020 7769                wi
-00007220: 7468 2063 6f64 6563 732e 6f70 656e 2877  th codecs.open(w
-00007230: 6f72 6b64 6972 202b 206d 6170 6e61 6d65  orkdir + mapname
-00007240: 202b 2027 5f70 726f 6a65 6374 696f 6e2e   + '_projection.
-00007250: 6a73 6f6e 272c 2027 7727 2c0a 2020 2020  json', 'w',.    
-00007260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007270: 2020 2020 2020 2020 2020 2020 2065 6e63               enc
-00007280: 6f64 696e 673d 2775 7466 2d38 2729 2061  oding='utf-8') a
-00007290: 7320 663a 0a20 2020 2020 2020 2020 2020  s f:.           
-000072a0: 2020 2020 2020 2020 206a 736f 6e2e 6475           json.du
-000072b0: 6d70 2866 696e 616c 6469 6374 2c20 6629  mp(finaldict, f)
-000072c0: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-000072d0: 6570 7420 494f 4572 726f 7220 6173 2069  ept IOError as i
-000072e0: 6f65 7272 3a0a 2020 2020 2020 2020 2020  oerr:.          
-000072f0: 2020 2020 2020 6a73 6f6e 6572 7220 3d20        jsonerr = 
-00007300: 2753 6176 696e 6720 7072 6f6a 6563 7469  'Saving projecti
-00007310: 6f6e 2069 6e74 6f20 6a73 6f6e 2065 7272  on into json err
-00007320: 6f72 3a20 7b7d 272e 666f 726d 6174 2869  or: {}'.format(i
-00007330: 6f65 7272 290a 2020 2020 2020 2020 2020  oerr).          
-00007340: 2020 2020 2020 7379 732e 7374 6465 7272        sys.stderr
-00007350: 2e77 7269 7465 286a 736f 6e65 7272 202b  .write(jsonerr +
-00007360: 2027 5c6e 2729 0a0a 0a20 2020 2020 2020   '\n')...       
-00007370: 2020 2020 2067 6c6f 7762 6f74 686a 736f       glowbothjso
-00007380: 6e20 3d20 6469 6374 2829 0a20 2020 2020  n = dict().     
-00007390: 2020 2020 2020 2067 6c6f 7770 726f 6a65         glowproje
-000073a0: 6374 696f 6e6a 736f 6e20 3d20 6469 6374  ctionjson = dict
-000073b0: 2829 0a20 2020 2020 2020 2020 2020 2067  ().            g
-000073c0: 6c6f 776f 7267 7072 6f6a 6563 7469 6f6e  loworgprojection
-000073d0: 6a73 6f6e 203d 2064 6963 7428 290a 0a20  json = dict().. 
-000073e0: 2020 2020 2020 2020 2020 2067 6c6f 7770             glowp
-000073f0: 726f 6a65 6374 696f 6e6a 736f 6e5b 2778  rojectionjson['x
-00007400: 275d 203d 206f 732e 7061 7468 2e62 6173  '] = os.path.bas
-00007410: 656e 616d 6528 676c 6f77 7873 6361 6c65  ename(glowxscale
-00007420: 6e61 6d65 2920 6966 206f 732e 7061 7468  name) if os.path
-00007430: 2e69 7366 696c 6528 676c 6f77 7873 6361  .isfile(glowxsca
-00007440: 6c65 6e61 6d65 2920 656c 7365 204e 6f6e  lename) else Non
-00007450: 650a 2020 2020 2020 2020 2020 2020 676c  e.            gl
-00007460: 6f77 7072 6f6a 6563 7469 6f6e 6a73 6f6e  owprojectionjson
-00007470: 5b27 7927 5d20 3d20 6f73 2e70 6174 682e  ['y'] = os.path.
-00007480: 6261 7365 6e61 6d65 2867 6c6f 7779 7363  basename(glowysc
-00007490: 616c 656e 616d 6529 2069 6620 6f73 2e70  alename) if os.p
-000074a0: 6174 682e 6973 6669 6c65 2867 6c6f 7779  ath.isfile(glowy
-000074b0: 7363 616c 656e 616d 6529 2065 6c73 6520  scalename) else 
-000074c0: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-000074d0: 2067 6c6f 7770 726f 6a65 6374 696f 6e6a   glowprojectionj
-000074e0: 736f 6e5b 277a 275d 203d 206f 732e 7061  son['z'] = os.pa
-000074f0: 7468 2e62 6173 656e 616d 6528 676c 6f77  th.basename(glow
-00007500: 7a73 6361 6c65 6e61 6d65 2920 6966 206f  zscalename) if o
-00007510: 732e 7061 7468 2e69 7366 696c 6528 676c  s.path.isfile(gl
-00007520: 6f77 7a73 6361 6c65 6e61 6d65 2920 656c  owzscalename) el
-00007530: 7365 204e 6f6e 650a 0a20 2020 2020 2020  se None..       
-00007540: 2020 2020 2067 6c6f 776f 7267 7072 6f6a       gloworgproj
-00007550: 6563 7469 6f6e 6a73 6f6e 5b27 7827 5d20  ectionjson['x'] 
-00007560: 3d20 6f73 2e70 6174 682e 6261 7365 6e61  = os.path.basena
-00007570: 6d65 2867 6c6f 7778 7072 6f6a 6563 7469  me(glowxprojecti
-00007580: 6f6e 6e61 6d65 2920 6966 206f 732e 7061  onname) if os.pa
-00007590: 7468 2e69 7366 696c 6528 676c 6f77 7870  th.isfile(glowxp
-000075a0: 726f 6a65 6374 696f 6e6e 616d 6529 2065  rojectionname) e
-000075b0: 6c73 6520 4e6f 6e65 0a20 2020 2020 2020  lse None.       
-000075c0: 2020 2020 2067 6c6f 776f 7267 7072 6f6a       gloworgproj
-000075d0: 6563 7469 6f6e 6a73 6f6e 5b27 7927 5d20  ectionjson['y'] 
-000075e0: 3d20 6f73 2e70 6174 682e 6261 7365 6e61  = os.path.basena
-000075f0: 6d65 2867 6c6f 7779 7072 6f6a 6563 7469  me(glowyprojecti
-00007600: 6f6e 6e61 6d65 2920 6966 206f 732e 7061  onname) if os.pa
-00007610: 7468 2e69 7366 696c 6528 676c 6f77 7970  th.isfile(glowyp
-00007620: 726f 6a65 6374 696f 6e6e 616d 6529 2065  rojectionname) e
-00007630: 6c73 6520 4e6f 6e65 0a20 2020 2020 2020  lse None.       
-00007640: 2020 2020 2067 6c6f 776f 7267 7072 6f6a       gloworgproj
-00007650: 6563 7469 6f6e 6a73 6f6e 5b27 7a27 5d20  ectionjson['z'] 
-00007660: 3d20 6f73 2e70 6174 682e 6261 7365 6e61  = os.path.basena
-00007670: 6d65 2867 6c6f 777a 7072 6f6a 6563 7469  me(glowzprojecti
-00007680: 6f6e 6e61 6d65 2920 6966 206f 732e 7061  onname) if os.pa
-00007690: 7468 2e69 7366 696c 6528 676c 6f77 7a70  th.isfile(glowzp
-000076a0: 726f 6a65 6374 696f 6e6e 616d 6529 2065  rojectionname) e
-000076b0: 6c73 6520 4e6f 6e65 0a20 2020 2020 2020  lse None.       
-000076c0: 2020 2020 2067 6c6f 7762 6f74 686a 736f       glowbothjso
-000076d0: 6e5b 276f 7269 6769 6e61 6c27 5d20 3d20  n['original'] = 
-000076e0: 676c 6f77 6f72 6770 726f 6a65 6374 696f  gloworgprojectio
-000076f0: 6e6a 736f 6e0a 2020 2020 2020 2020 2020  njson.          
-00007700: 2020 676c 6f77 626f 7468 6a73 6f6e 5b27    glowbothjson['
-00007710: 7363 616c 6564 275d 203d 2067 6c6f 7770  scaled'] = glowp
-00007720: 726f 6a65 6374 696f 6e6a 736f 6e0a 0a20  rojectionjson.. 
-00007730: 2020 2020 2020 2020 2020 2069 6620 6572             if er
-00007740: 726c 6973 743a 0a20 2020 2020 2020 2020  rlist:.         
-00007750: 2020 2020 2020 2067 6c6f 7762 6f74 686a         glowbothj
-00007760: 736f 6e5b 2765 7272 275d 203d 207b 276f  son['err'] = {'o
-00007770: 7274 686f 676f 6e61 6c5f 676c 6f77 5f70  rthogonal_glow_p
-00007780: 726f 6a65 6374 696f 6e5f 6572 7227 3a20  rojection_err': 
-00007790: 6572 726c 6973 747d 0a20 2020 2020 2020  errlist}.       
-000077a0: 2020 2020 2067 6c6f 7766 696e 616c 6469       glowfinaldi
-000077b0: 6374 203d 207b 6c61 6265 6c20 2b20 276f  ct = {label + 'o
-000077c0: 7274 686f 676f 6e61 6c5f 676c 6f77 5f70  rthogonal_glow_p
-000077d0: 726f 6a65 6374 696f 6e27 3a20 676c 6f77  rojection': glow
-000077e0: 626f 7468 6a73 6f6e 7d0a 0a20 2020 2020  bothjson}..     
-000077f0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00007800: 2020 2020 2020 2020 2020 2020 7769 7468              with
-00007810: 2063 6f64 6563 732e 6f70 656e 2877 6f72   codecs.open(wor
-00007820: 6b64 6972 202b 206d 6170 6e61 6d65 202b  kdir + mapname +
-00007830: 2027 5f67 6c6f 775f 7072 6f6a 6563 7469   '_glow_projecti
-00007840: 6f6e 2e6a 736f 6e27 2c20 2777 272c 0a20  on.json', 'w',. 
-00007850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007870: 656e 636f 6469 6e67 3d27 7574 662d 3827  encoding='utf-8'
-00007880: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
-00007890: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
-000078a0: 2e64 756d 7028 676c 6f77 6669 6e61 6c64  .dump(glowfinald
-000078b0: 6963 742c 2066 290a 2020 2020 2020 2020  ict, f).        
-000078c0: 2020 2020 6578 6365 7074 2049 4f45 7272      except IOErr
-000078d0: 6f72 2061 7320 696f 6572 723a 0a20 2020  or as ioerr:.   
-000078e0: 2020 2020 2020 2020 2020 2020 206a 736f               jso
-000078f0: 6e65 7272 203d 2027 5361 7669 6e67 2067  nerr = 'Saving g
-00007900: 6c6f 7720 7072 6f6a 6563 7469 6f6e 2069  low projection i
-00007910: 6e74 6f20 6a73 6f6e 2065 7272 6f72 3a20  nto json error: 
-00007920: 7b7d 272e 666f 726d 6174 2869 6f65 7272  {}'.format(ioerr
-00007930: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00007940: 2020 7379 732e 7374 6465 7272 2e77 7269    sys.stderr.wri
-00007950: 7465 286a 736f 6e65 7272 202b 2027 5c6e  te(jsonerr + '\n
-00007960: 2729 0a0a 2020 2020 2020 2020 2020 2020  ')..            
-00007970: 656e 6420 3d20 7469 6d65 6974 2e64 6566  end = timeit.def
-00007980: 6175 6c74 5f74 696d 6572 2829 0a20 2020  ault_timer().   
-00007990: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
-000079a0: 5072 6f6a 6563 7469 6f6e 7320 616e 6420  Projections and 
-000079b0: 6974 7320 676c 6f77 2070 726f 6a65 6374  its glow project
-000079c0: 696f 6e73 2074 696d 6520 666f 7220 2573  ions time for %s
-000079d0: 3a20 2573 2720 2520 286d 6170 6e61 6d65  : %s' % (mapname
-000079e0: 2c20 656e 6420 2d20 7374 6172 7429 290a  , end - start)).
-000079f0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-00007a00: 7428 272d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  t('-------------
-00007a10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00007a20: 2d2d 2d2d 2d2d 2d27 290a 0a20 2020 2020  -------')..     
-00007a30: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00007a40: 2020 2020 2070 7269 6e74 2827 4e6f 206f       print('No o
-00007a50: 7274 686f 676f 6e61 6c20 7072 6f6a 6563  rthogonal projec
-00007a60: 7469 6f6e 7320 7769 7468 6f75 7420 7072  tions without pr
-00007a70: 6f70 6572 206d 6170 2069 6e70 7574 2061  oper map input a
-00007a80: 6e64 2074 6865 206f 7574 7075 7420 6469  nd the output di
-00007a90: 7265 6374 6f72 7920 696e 666f 726d 6174  rectory informat
-00007aa0: 696f 6e2e 2729 0a0a 2020 2020 2020 2020  ion.')..        
-00007ab0: 7265 7475 726e 204e 6f6e 650a 0a20 2020  return None..   
-00007ac0: 2023 2040 7072 6f66 696c 650a 2020 2020   # @profile.    
-00007ad0: 6465 6620 7261 776d 6170 5f70 726f 6a65  def rawmap_proje
-00007ae0: 6374 696f 6e73 2873 656c 6629 3a0a 0a20  ctions(self):.. 
-00007af0: 2020 2020 2020 2072 6177 6d61 7020 3d20         rawmap = 
-00007b00: 7365 6c66 2e72 6177 6d61 700a 2020 2020  self.rawmap.    
-00007b10: 2020 2020 6966 2072 6177 6d61 7020 6973      if rawmap is
-00007b20: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-00007b30: 2020 2020 2020 2064 6972 203d 2073 656c         dir = sel
-00007b40: 662e 776f 726b 6469 720a 2020 2020 2020  f.workdir.      
-00007b50: 2020 2020 2020 6c61 6265 6c20 3d20 2772        label = 'r
-00007b60: 6177 6d61 705f 270a 2020 2020 2020 2020  awmap_'.        
-00007b70: 2020 2020 7365 6c66 2e6f 7274 686f 676f      self.orthogo
-00007b80: 6e61 6c5f 7072 6f6a 6563 7469 6f6e 7328  nal_projections(
-00007b90: 7261 776d 6170 2c20 6469 722c 206c 6162  rawmap, dir, lab
-00007ba0: 656c 290a 2020 2020 2020 2020 656c 7365  el).        else
-00007bb0: 3a0a 2020 2020 2020 2020 2020 2020 7072  :.            pr
-00007bc0: 696e 7428 274e 6f20 7261 7720 6d61 7020  int('No raw map 
-00007bd0: 746f 2063 616c 6375 6c61 7465 206f 7274  to calculate ort
-00007be0: 686f 676f 6e61 6c20 7072 6f6a 6563 7469  hogonal projecti
-00007bf0: 6f6e 732e 2729 0a0a 2020 2020 2020 2020  ons.')..        
-00007c00: 7265 7475 726e 204e 6f6e 650a 0a20 2020  return None..   
-00007c10: 2023 2040 7072 6f66 696c 650a 2020 2020   # @profile.    
-00007c20: 6465 6620 6f72 7468 6f67 6f6e 616c 5f6d  def orthogonal_m
-00007c30: 6564 6961 6e28 7365 6c66 2c20 6d61 7069  edian(self, mapi
-00007c40: 6e3d 4e6f 6e65 2c20 776f 726b 6469 723d  n=None, workdir=
-00007c50: 4e6f 6e65 2c20 6c61 6265 6c3d 2727 293a  None, label=''):
-00007c60: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00007c70: 2020 2020 2020 2020 204d 6564 6961 6e20           Median 
-00007c80: 7072 6f6a 6563 7469 6f6e 0a20 2020 2020  projection.     
-00007c90: 2020 203a 7061 7261 6d20 6d61 7069 6e3a     :param mapin:
-00007ca0: 2049 6e70 7574 206d 6170 2065 6974 6865   Input map eithe
-00007cb0: 7220 6d72 6366 696c 6520 6f72 2066 696c  r mrcfile or fil
-00007cc0: 656e 616d 6520 7374 7269 6e67 0a20 2020  ename string.   
-00007cd0: 2020 2020 203a 7061 7261 6d20 776f 726b       :param work
-00007ce0: 6469 723a 2053 7472 696e 6720 6f66 2074  dir: String of t
-00007cf0: 6865 2066 756c 6c20 776f 726b 2070 6174  he full work pat
-00007d00: 680a 2020 2020 2020 2020 3a70 6172 616d  h.        :param
-00007d10: 206c 6162 656c 3a20 666f 7220 7261 7720   label: for raw 
-00007d20: 6d61 7020 7573 6520 2772 6177 5f27 0a20  map use 'raw_'. 
-00007d30: 2020 2020 2020 203a 7265 7475 726e 3a20         :return: 
-00007d40: 4e6f 6e65 0a20 2020 2020 2020 2022 2222  None.        """
-00007d50: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
-00007d60: 662e 706c 6174 666f 726d 203d 3d20 2765  f.platform == 'e
-00007d70: 6d64 6227 3a0a 2020 2020 2020 2020 2020  mdb':.          
-00007d80: 2020 6d61 702c 2077 6f72 6b64 6972 203d    map, workdir =
-00007d90: 2073 656c 662e 6d61 7069 6e63 6865 636b   self.mapincheck
-00007da0: 286d 6170 696e 2c20 776f 726b 6469 7229  (mapin, workdir)
-00007db0: 0a20 2020 2020 2020 2020 2020 206d 6170  .            map
-00007dc0: 6e61 6d65 203d 206f 732e 7061 7468 2e62  name = os.path.b
-00007dd0: 6173 656e 616d 6528 6d61 702e 6675 6c6c  asename(map.full
-00007de0: 6e61 6d65 2920 6966 206d 6170 2065 6c73  name) if map els
-00007df0: 6520 4e6f 6e65 0a20 2020 2020 2020 2020  e None.         
-00007e00: 2020 2069 6620 6d61 7020 6973 206e 6f74     if map is not
-00007e10: 204e 6f6e 6520 616e 6420 776f 726b 6469   None and workdi
-00007e20: 7220 6973 206e 6f74 204e 6f6e 653a 0a20  r is not None:. 
-00007e30: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00007e40: 7461 7274 203d 2074 696d 6569 742e 6465  tart = timeit.de
-00007e50: 6661 756c 745f 7469 6d65 7228 290a 2020  fault_timer().  
-00007e60: 2020 2020 2020 2020 2020 2020 2020 6572                er
-00007e70: 726c 6973 7420 3d20 5b5d 0a20 2020 2020  rlist = [].     
-00007e80: 2020 2020 2020 2020 2020 2074 7970 6520             type 
-00007e90: 3d20 276d 6564 6961 6e27 0a0a 2020 2020  = 'median'..    
-00007ea0: 2020 2020 2020 2020 2020 2020 7870 726f              xpro
-00007eb0: 6a65 6374 696f 6e6e 616d 6520 3d20 776f  jectionname = wo
-00007ec0: 726b 6469 7220 2b20 6d61 706e 616d 6520  rkdir + mapname 
-00007ed0: 2b20 275f 786d 6564 6961 6e2e 6a70 6567  + '_xmedian.jpeg
-00007ee0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00007ef0: 2020 7873 6361 6c65 6e61 6d65 203d 2077    xscalename = w
-00007f00: 6f72 6b64 6972 202b 206d 6170 6e61 6d65  orkdir + mapname
-00007f10: 202b 2027 5f73 6361 6c65 645f 786d 6564   + '_scaled_xmed
-00007f20: 6961 6e2e 6a70 6567 270a 2020 2020 2020  ian.jpeg'.      
-00007f30: 2020 2020 2020 2020 2020 7365 6c66 2e6d            self.m
-00007f40: 6170 5f74 6f5f 696d 6728 6d61 702c 2032  ap_to_img(map, 2
-00007f50: 2c20 7479 7065 2c20 6572 726c 6973 7429  , type, errlist)
-00007f60: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00007f70: 2020 7970 726f 6a65 6374 696f 6e6e 616d    yprojectionnam
-00007f80: 6520 3d20 776f 726b 6469 7220 2b20 6d61  e = workdir + ma
-00007f90: 706e 616d 6520 2b20 275f 796d 6564 6961  pname + '_ymedia
-00007fa0: 6e2e 6a70 6567 270a 2020 2020 2020 2020  n.jpeg'.        
-00007fb0: 2020 2020 2020 2020 7973 6361 6c65 6e61          yscalena
-00007fc0: 6d65 203d 2077 6f72 6b64 6972 202b 206d  me = workdir + m
-00007fd0: 6170 6e61 6d65 202b 2027 5f73 6361 6c65  apname + '_scale
-00007fe0: 645f 796d 6564 6961 6e2e 6a70 6567 270a  d_ymedian.jpeg'.
-00007ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008000: 7365 6c66 2e6d 6170 5f74 6f5f 696d 6728  self.map_to_img(
-00008010: 6d61 702c 2031 2c20 7479 7065 2c20 6572  map, 1, type, er
-00008020: 726c 6973 7429 0a0a 2020 2020 2020 2020  rlist)..        
-00008030: 2020 2020 2020 2020 7a70 726f 6a65 6374          zproject
-00008040: 696f 6e6e 616d 6520 3d20 776f 726b 6469  ionname = workdi
-00008050: 7220 2b20 6d61 706e 616d 6520 2b20 275f  r + mapname + '_
-00008060: 7a6d 6564 6961 6e2e 6a70 6567 270a 2020  zmedian.jpeg'.  
-00008070: 2020 2020 2020 2020 2020 2020 2020 7a73                zs
-00008080: 6361 6c65 6e61 6d65 203d 2077 6f72 6b64  calename = workd
-00008090: 6972 202b 206d 6170 6e61 6d65 202b 2027  ir + mapname + '
-000080a0: 5f73 6361 6c65 645f 7a6d 6564 6961 6e2e  _scaled_zmedian.
-000080b0: 6a70 6567 270a 2020 2020 2020 2020 2020  jpeg'.          
-000080c0: 2020 2020 2020 7365 6c66 2e6d 6170 5f74        self.map_t
-000080d0: 6f5f 696d 6728 6d61 702c 2030 2c20 7479  o_img(map, 0, ty
-000080e0: 7065 2c20 6572 726c 6973 7429 0a0a 2020  pe, errlist)..  
-000080f0: 2020 2020 2020 2020 2020 2020 2020 626f                bo
-00008100: 7468 6a73 6f6e 203d 2064 6963 7428 290a  thjson = dict().
-00008110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008120: 7072 6f6a 6563 7469 6f6e 6a73 6f6e 203d  projectionjson =
-00008130: 2064 6963 7428 290a 2020 2020 2020 2020   dict().        
-00008140: 2020 2020 2020 2020 6f72 6770 726f 6a65          orgproje
-00008150: 6374 696f 6e6a 736f 6e20 3d20 6469 6374  ctionjson = dict
-00008160: 2829 0a0a 2020 2020 2020 2020 2020 2020  ()..            
-00008170: 2020 2020 7072 6f6a 6563 7469 6f6e 6a73      projectionjs
-00008180: 6f6e 5b27 7827 5d20 3d20 6f73 2e70 6174  on['x'] = os.pat
-00008190: 682e 6261 7365 6e61 6d65 2878 7363 616c  h.basename(xscal
-000081a0: 656e 616d 6529 2069 6620 6f73 2e70 6174  ename) if os.pat
-000081b0: 682e 6973 6669 6c65 2878 7363 616c 656e  h.isfile(xscalen
-000081c0: 616d 6529 2065 6c73 6520 4e6f 6e65 0a20  ame) else None. 
-000081d0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-000081e0: 726f 6a65 6374 696f 6e6a 736f 6e5b 2779  rojectionjson['y
-000081f0: 275d 203d 206f 732e 7061 7468 2e62 6173  '] = os.path.bas
-00008200: 656e 616d 6528 7973 6361 6c65 6e61 6d65  ename(yscalename
-00008210: 2920 6966 206f 732e 7061 7468 2e69 7366  ) if os.path.isf
-00008220: 696c 6528 7973 6361 6c65 6e61 6d65 2920  ile(yscalename) 
-00008230: 656c 7365 204e 6f6e 650a 2020 2020 2020  else None.      
-00008240: 2020 2020 2020 2020 2020 7072 6f6a 6563            projec
-00008250: 7469 6f6e 6a73 6f6e 5b27 7a27 5d20 3d20  tionjson['z'] = 
-00008260: 6f73 2e70 6174 682e 6261 7365 6e61 6d65  os.path.basename
-00008270: 287a 7363 616c 656e 616d 6529 2069 6620  (zscalename) if 
-00008280: 6f73 2e70 6174 682e 6973 6669 6c65 287a  os.path.isfile(z
-00008290: 7363 616c 656e 616d 6529 2065 6c73 6520  scalename) else 
-000082a0: 4e6f 6e65 0a0a 2020 2020 2020 2020 2020  None..          
-000082b0: 2020 2020 2020 6f72 6770 726f 6a65 6374        orgproject
-000082c0: 696f 6e6a 736f 6e5b 2778 275d 203d 206f  ionjson['x'] = o
-000082d0: 732e 7061 7468 2e62 6173 656e 616d 6528  s.path.basename(
-000082e0: 7870 726f 6a65 6374 696f 6e6e 616d 6529  xprojectionname)
-000082f0: 2069 6620 6f73 2e70 6174 682e 6973 6669   if os.path.isfi
-00008300: 6c65 2878 7072 6f6a 6563 7469 6f6e 6e61  le(xprojectionna
-00008310: 6d65 2920 656c 7365 204e 6f6e 650a 2020  me) else None.  
-00008320: 2020 2020 2020 2020 2020 2020 2020 6f72                or
-00008330: 6770 726f 6a65 6374 696f 6e6a 736f 6e5b  gprojectionjson[
-00008340: 2779 275d 203d 206f 732e 7061 7468 2e62  'y'] = os.path.b
-00008350: 6173 656e 616d 6528 7970 726f 6a65 6374  asename(yproject
-00008360: 696f 6e6e 616d 6529 2069 6620 6f73 2e70  ionname) if os.p
-00008370: 6174 682e 6973 6669 6c65 2879 7072 6f6a  ath.isfile(yproj
-00008380: 6563 7469 6f6e 6e61 6d65 2920 656c 7365  ectionname) else
-00008390: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
-000083a0: 2020 2020 2020 6f72 6770 726f 6a65 6374        orgproject
-000083b0: 696f 6e6a 736f 6e5b 277a 275d 203d 206f  ionjson['z'] = o
-000083c0: 732e 7061 7468 2e62 6173 656e 616d 6528  s.path.basename(
-000083d0: 7a70 726f 6a65 6374 696f 6e6e 616d 6529  zprojectionname)
-000083e0: 2069 6620 6f73 2e70 6174 682e 6973 6669   if os.path.isfi
-000083f0: 6c65 287a 7072 6f6a 6563 7469 6f6e 6e61  le(zprojectionna
-00008400: 6d65 2920 656c 7365 204e 6f6e 650a 0a20  me) else None.. 
-00008410: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-00008420: 6f74 686a 736f 6e5b 276f 7269 6769 6e61  othjson['origina
-00008430: 6c27 5d20 3d20 6f72 6770 726f 6a65 6374  l'] = orgproject
-00008440: 696f 6e6a 736f 6e0a 2020 2020 2020 2020  ionjson.        
-00008450: 2020 2020 2020 2020 626f 7468 6a73 6f6e          bothjson
-00008460: 5b27 7363 616c 6564 275d 203d 2070 726f  ['scaled'] = pro
-00008470: 6a65 6374 696f 6e6a 736f 6e0a 0a20 2020  jectionjson..   
-00008480: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00008490: 6572 726c 6973 743a 0a20 2020 2020 2020  errlist:.       
-000084a0: 2020 2020 2020 2020 2020 2020 2062 6f74               bot
-000084b0: 686a 736f 6e5b 2765 7272 275d 203d 207b  hjson['err'] = {
-000084c0: 276f 7274 686f 676f 6e61 6c5f 6d65 6469  'orthogonal_medi
-000084d0: 616e 5f65 7272 273a 2065 7272 6c69 7374  an_err': errlist
-000084e0: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-000084f0: 2020 6669 6e61 6c64 6963 7420 3d20 7b6c    finaldict = {l
-00008500: 6162 656c 202b 2027 6f72 7468 6f67 6f6e  abel + 'orthogon
-00008510: 616c 5f6d 6564 6961 6e27 3a20 626f 7468  al_median': both
-00008520: 6a73 6f6e 7d0a 0a20 2020 2020 2020 2020  json}..         
-00008530: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00008540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008550: 7769 7468 2063 6f64 6563 732e 6f70 656e  with codecs.open
-00008560: 2877 6f72 6b64 6972 202b 206d 6170 6e61  (workdir + mapna
-00008570: 6d65 202b 2027 5f6d 6564 6961 6e2e 6a73  me + '_median.js
-00008580: 6f6e 272c 2027 7727 2c20 656e 636f 6469  on', 'w', encodi
-00008590: 6e67 3d27 7574 662d 3827 2920 6173 2066  ng='utf-8') as f
-000085a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000085b0: 2020 2020 2020 2020 2020 6a73 6f6e 2e64            json.d
-000085c0: 756d 7028 6669 6e61 6c64 6963 742c 2066  ump(finaldict, f
-000085d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000085e0: 2020 6578 6365 7074 2049 4f45 7272 6f72    except IOError
-000085f0: 2061 7320 696f 6572 723a 0a20 2020 2020   as ioerr:.     
-00008600: 2020 2020 2020 2020 2020 2020 2020 206a                 j
-00008610: 736f 6e65 7272 203d 2027 5361 7669 6e67  sonerr = 'Saving
-00008620: 206d 6564 6961 6e20 7072 6f6a 6563 7469   median projecti
-00008630: 6f6e 2069 6e74 6f20 6a73 6f6e 2065 7272  on into json err
-00008640: 6f72 3a20 7b7d 272e 666f 726d 6174 2869  or: {}'.format(i
-00008650: 6f65 7272 290a 2020 2020 2020 2020 2020  oerr).          
-00008660: 2020 2020 2020 2020 2020 7379 732e 7374            sys.st
-00008670: 6465 7272 2e77 7269 7465 286a 736f 6e65  derr.write(jsone
-00008680: 7272 202b 2027 5c6e 2729 0a0a 2020 2020  rr + '\n')..    
-00008690: 2020 2020 2020 2020 2020 2020 656e 6420              end 
-000086a0: 3d20 7469 6d65 6974 2e64 6566 6175 6c74  = timeit.default
-000086b0: 5f74 696d 6572 2829 0a20 2020 2020 2020  _timer().       
-000086c0: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
-000086d0: 4d65 6469 616e 2070 726f 6a65 6374 696f  Median projectio
-000086e0: 6e73 2074 696d 6520 666f 7220 2573 3a20  ns time for %s: 
-000086f0: 2573 2720 2520 286d 6170 6e61 6d65 2c20  %s' % (mapname, 
-00008700: 656e 6420 2d20 7374 6172 7429 290a 2020  end - start)).  
-00008710: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-00008720: 696e 7428 272d 2d2d 2d2d 2d2d 2d2d 2d2d  int('-----------
-00008730: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00008740: 2d2d 2d2d 2d2d 2d2d 2d27 290a 0a20 2020  ---------')..   
-00008750: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00008760: 7572 6e20 4e6f 6e65 0a20 2020 2020 2020  urn None.       
-00008770: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00008780: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00008790: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-000087a0: 2020 2020 2020 274e 6f20 6f72 7468 6f67        'No orthog
-000087b0: 6f6e 616c 206d 6564 6961 6e20 7072 6f6a  onal median proj
-000087c0: 6563 7469 6f6e 7320 7769 7468 6f75 7420  ections without 
-000087d0: 7072 6f70 6572 206d 6170 2069 6e70 7574  proper map input
-000087e0: 2061 6e64 2074 6865 206f 7574 7075 7420   and the output 
-000087f0: 6469 7265 6374 6f72 7920 696e 666f 726d  directory inform
-00008800: 6174 696f 6e2e 2729 0a0a 2020 2020 2020  ation.')..      
-00008810: 2020 7265 7475 726e 204e 6f6e 650a 0a20    return None.. 
-00008820: 2020 2023 2040 7072 6f66 696c 650a 2020     # @profile.  
-00008830: 2020 6465 6620 7261 776d 6170 5f6d 6564    def rawmap_med
-00008840: 6961 6e28 7365 6c66 293a 0a0a 2020 2020  ian(self):..    
-00008850: 2020 2020 7261 776d 6170 203d 2073 656c      rawmap = sel
-00008860: 662e 7261 776d 6170 0a20 2020 2020 2020  f.rawmap.       
-00008870: 2069 6620 7261 776d 6170 2069 7320 6e6f   if rawmap is no
-00008880: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-00008890: 2020 2020 6469 7220 3d20 7365 6c66 2e77      dir = self.w
-000088a0: 6f72 6b64 6972 0a20 2020 2020 2020 2020  orkdir.         
-000088b0: 2020 206c 6162 656c 203d 2027 7261 776d     label = 'rawm
-000088c0: 6170 5f27 0a20 2020 2020 2020 2020 2020  ap_'.           
-000088d0: 2073 656c 662e 6f72 7468 6f67 6f6e 616c   self.orthogonal
-000088e0: 5f6d 6564 6961 6e28 7261 776d 6170 2c20  _median(rawmap, 
-000088f0: 6469 722c 206c 6162 656c 290a 2020 2020  dir, label).    
-00008900: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00008910: 2020 2020 2020 7072 696e 7428 274e 6f20        print('No 
-00008920: 7261 7720 6d61 7020 746f 2063 616c 6375  raw map to calcu
-00008930: 6c61 7465 206f 7274 686f 676f 6e61 6c20  late orthogonal 
-00008940: 6d61 7820 7072 6f6a 6563 7469 6f6e 732e  max projections.
-00008950: 2729 0a0a 0a20 2020 2023 2040 7072 6f66  ')...    # @prof
-00008960: 696c 650a 2020 2020 6465 6620 6f72 7468  ile.    def orth
-00008970: 6f67 6f6e 616c 5f6d 696e 2873 656c 662c  ogonal_min(self,
-00008980: 206d 6170 696e 3d4e 6f6e 652c 2077 6f72   mapin=None, wor
-00008990: 6b64 6972 3d4e 6f6e 652c 206c 6162 656c  kdir=None, label
-000089a0: 3d27 2729 3a0a 2020 2020 2020 2020 2222  =''):.        ""
-000089b0: 220a 2020 2020 2020 2020 2020 2020 204d  ".             M
-000089c0: 696e 696d 616c 2070 726f 6a65 6374 696f  inimal projectio
-000089d0: 6e0a 2020 2020 2020 2020 3a70 6172 616d  n.        :param
-000089e0: 206d 6170 696e 3a20 496e 7075 7420 6d61   mapin: Input ma
-000089f0: 7020 6569 7468 6572 206d 7263 6669 6c65  p either mrcfile
-00008a00: 206f 7220 6669 6c65 6e61 6d65 2073 7472   or filename str
-00008a10: 696e 670a 2020 2020 2020 2020 3a70 6172  ing.        :par
-00008a20: 616d 2077 6f72 6b64 6972 3a20 5374 7269  am workdir: Stri
-00008a30: 6e67 206f 6620 7468 6520 6675 6c6c 2077  ng of the full w
-00008a40: 6f72 6b20 7061 7468 0a20 2020 2020 2020  ork path.       
-00008a50: 203a 7061 7261 6d20 6c61 6265 6c3a 2066   :param label: f
-00008a60: 6f72 2072 6177 206d 6170 2075 7365 2027  or raw map use '
-00008a70: 7261 775f 270a 2020 2020 2020 2020 3a72  raw_'.        :r
-00008a80: 6574 7572 6e3a 204e 6f6e 650a 2020 2020  eturn: None.    
-00008a90: 2020 2020 2222 220a 0a20 2020 2020 2020      """..       
-00008aa0: 2069 6620 7365 6c66 2e70 6c61 7466 6f72   if self.platfor
-00008ab0: 6d20 3d3d 2027 656d 6462 273a 0a20 2020  m == 'emdb':.   
-00008ac0: 2020 2020 2020 2020 206d 6170 2c20 776f           map, wo
-00008ad0: 726b 6469 7220 3d20 7365 6c66 2e6d 6170  rkdir = self.map
-00008ae0: 696e 6368 6563 6b28 6d61 7069 6e2c 2077  incheck(mapin, w
-00008af0: 6f72 6b64 6972 290a 2020 2020 2020 2020  orkdir).        
-00008b00: 2020 2020 6d61 706e 616d 6520 3d20 6f73      mapname = os
-00008b10: 2e70 6174 682e 6261 7365 6e61 6d65 286d  .path.basename(m
-00008b20: 6170 2e66 756c 6c6e 616d 6529 2069 6620  ap.fullname) if 
-00008b30: 6d61 7020 656c 7365 204e 6f6e 650a 2020  map else None.  
-00008b40: 2020 2020 2020 2020 2020 6966 206d 6170            if map
-00008b50: 2069 7320 6e6f 7420 4e6f 6e65 2061 6e64   is not None and
-00008b60: 2077 6f72 6b64 6972 2069 7320 6e6f 7420   workdir is not 
-00008b70: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-00008b80: 2020 2020 2020 7374 6172 7420 3d20 7469        start = ti
-00008b90: 6d65 6974 2e64 6566 6175 6c74 5f74 696d  meit.default_tim
-00008ba0: 6572 2829 0a20 2020 2020 2020 2020 2020  er().           
-00008bb0: 2020 2020 2065 7272 6c69 7374 203d 205b       errlist = [
-00008bc0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00008bd0: 2020 7479 7065 203d 2027 6d69 6e27 0a0a    type = 'min'..
-00008be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008bf0: 7870 726f 6a65 6374 696f 6e6e 616d 6520  xprojectionname 
-00008c00: 3d20 776f 726b 6469 7220 2b20 6d61 706e  = workdir + mapn
-00008c10: 616d 6520 2b20 275f 786d 696e 2e6a 7065  ame + '_xmin.jpe
-00008c20: 6727 0a20 2020 2020 2020 2020 2020 2020  g'.             
-00008c30: 2020 2078 7363 616c 656e 616d 6520 3d20     xscalename = 
-00008c40: 776f 726b 6469 7220 2b20 6d61 706e 616d  workdir + mapnam
-00008c50: 6520 2b20 275f 7363 616c 6564 5f78 6d69  e + '_scaled_xmi
-00008c60: 6e2e 6a70 6567 270a 2020 2020 2020 2020  n.jpeg'.        
-00008c70: 2020 2020 2020 2020 7365 6c66 2e6d 6170          self.map
-00008c80: 5f74 6f5f 696d 6728 6d61 702c 2032 2c20  _to_img(map, 2, 
-00008c90: 7479 7065 2c20 6572 726c 6973 7429 0a0a  type, errlist)..
-00008ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008cb0: 7970 726f 6a65 6374 696f 6e6e 616d 6520  yprojectionname 
-00008cc0: 3d20 776f 726b 6469 7220 2b20 6d61 706e  = workdir + mapn
-00008cd0: 616d 6520 2b20 275f 796d 696e 2e6a 7065  ame + '_ymin.jpe
-00008ce0: 6727 0a20 2020 2020 2020 2020 2020 2020  g'.             
-00008cf0: 2020 2079 7363 616c 656e 616d 6520 3d20     yscalename = 
-00008d00: 776f 726b 6469 7220 2b20 6d61 706e 616d  workdir + mapnam
-00008d10: 6520 2b20 275f 7363 616c 6564 5f79 6d69  e + '_scaled_ymi
-00008d20: 6e2e 6a70 6567 270a 2020 2020 2020 2020  n.jpeg'.        
-00008d30: 2020 2020 2020 2020 7365 6c66 2e6d 6170          self.map
-00008d40: 5f74 6f5f 696d 6728 6d61 702c 2031 2c20  _to_img(map, 1, 
-00008d50: 7479 7065 2c20 6572 726c 6973 7429 0a0a  type, errlist)..
-00008d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008d70: 7a70 726f 6a65 6374 696f 6e6e 616d 6520  zprojectionname 
-00008d80: 3d20 776f 726b 6469 7220 2b20 6d61 706e  = workdir + mapn
-00008d90: 616d 6520 2b20 275f 7a6d 696e 2e6a 7065  ame + '_zmin.jpe
-00008da0: 6727 0a20 2020 2020 2020 2020 2020 2020  g'.             
-00008db0: 2020 207a 7363 616c 656e 616d 6520 3d20     zscalename = 
-00008dc0: 776f 726b 6469 7220 2b20 6d61 706e 616d  workdir + mapnam
-00008dd0: 6520 2b20 275f 7363 616c 6564 5f7a 6d69  e + '_scaled_zmi
-00008de0: 6e2e 6a70 6567 270a 2020 2020 2020 2020  n.jpeg'.        
-00008df0: 2020 2020 2020 2020 7365 6c66 2e6d 6170          self.map
-00008e00: 5f74 6f5f 696d 6728 6d61 702c 2030 2c20  _to_img(map, 0, 
-00008e10: 7479 7065 2c20 6572 726c 6973 7429 0a0a  type, errlist)..
-00008e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008e30: 626f 7468 6a73 6f6e 203d 2064 6963 7428  bothjson = dict(
-00008e40: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00008e50: 2020 7072 6f6a 6563 7469 6f6e 6a73 6f6e    projectionjson
-00008e60: 203d 2064 6963 7428 290a 2020 2020 2020   = dict().      
-00008e70: 2020 2020 2020 2020 2020 6f72 6770 726f            orgpro
-00008e80: 6a65 6374 696f 6e6a 736f 6e20 3d20 6469  jectionjson = di
-00008e90: 6374 2829 0a0a 2020 2020 2020 2020 2020  ct()..          
-00008ea0: 2020 2020 2020 7072 6f6a 6563 7469 6f6e        projection
-00008eb0: 6a73 6f6e 5b27 7827 5d20 3d20 6f73 2e70  json['x'] = os.p
-00008ec0: 6174 682e 6261 7365 6e61 6d65 2878 7363  ath.basename(xsc
-00008ed0: 616c 656e 616d 6529 2069 6620 6f73 2e70  alename) if os.p
-00008ee0: 6174 682e 6973 6669 6c65 2878 7363 616c  ath.isfile(xscal
-00008ef0: 656e 616d 6529 2065 6c73 6520 4e6f 6e65  ename) else None
-00008f00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008f10: 2070 726f 6a65 6374 696f 6e6a 736f 6e5b   projectionjson[
-00008f20: 2779 275d 203d 206f 732e 7061 7468 2e62  'y'] = os.path.b
-00008f30: 6173 656e 616d 6528 7973 6361 6c65 6e61  asename(yscalena
-00008f40: 6d65 2920 6966 206f 732e 7061 7468 2e69  me) if os.path.i
-00008f50: 7366 696c 6528 7973 6361 6c65 6e61 6d65  sfile(yscalename
-00008f60: 2920 656c 7365 204e 6f6e 650a 2020 2020  ) else None.    
-00008f70: 2020 2020 2020 2020 2020 2020 7072 6f6a              proj
-00008f80: 6563 7469 6f6e 6a73 6f6e 5b27 7a27 5d20  ectionjson['z'] 
-00008f90: 3d20 6f73 2e70 6174 682e 6261 7365 6e61  = os.path.basena
-00008fa0: 6d65 287a 7363 616c 656e 616d 6529 2069  me(zscalename) i
-00008fb0: 6620 6f73 2e70 6174 682e 6973 6669 6c65  f os.path.isfile
-00008fc0: 287a 7363 616c 656e 616d 6529 2065 6c73  (zscalename) els
-00008fd0: 6520 4e6f 6e65 0a0a 2020 2020 2020 2020  e None..        
-00008fe0: 2020 2020 2020 2020 6f72 6770 726f 6a65          orgproje
-00008ff0: 6374 696f 6e6a 736f 6e5b 2778 275d 203d  ctionjson['x'] =
-00009000: 206f 732e 7061 7468 2e62 6173 656e 616d   os.path.basenam
-00009010: 6528 7870 726f 6a65 6374 696f 6e6e 616d  e(xprojectionnam
-00009020: 6529 2069 6620 6f73 2e70 6174 682e 6973  e) if os.path.is
-00009030: 6669 6c65 2878 7072 6f6a 6563 7469 6f6e  file(xprojection
-00009040: 6e61 6d65 2920 656c 7365 204e 6f6e 650a  name) else None.
-00009050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009060: 6f72 6770 726f 6a65 6374 696f 6e6a 736f  orgprojectionjso
-00009070: 6e5b 2779 275d 203d 206f 732e 7061 7468  n['y'] = os.path
-00009080: 2e62 6173 656e 616d 6528 7970 726f 6a65  .basename(yproje
-00009090: 6374 696f 6e6e 616d 6529 2069 6620 6f73  ctionname) if os
-000090a0: 2e70 6174 682e 6973 6669 6c65 2879 7072  .path.isfile(ypr
-000090b0: 6f6a 6563 7469 6f6e 6e61 6d65 2920 656c  ojectionname) el
-000090c0: 7365 204e 6f6e 650a 2020 2020 2020 2020  se None.        
-000090d0: 2020 2020 2020 2020 6f72 6770 726f 6a65          orgproje
-000090e0: 6374 696f 6e6a 736f 6e5b 277a 275d 203d  ctionjson['z'] =
-000090f0: 206f 732e 7061 7468 2e62 6173 656e 616d   os.path.basenam
-00009100: 6528 7a70 726f 6a65 6374 696f 6e6e 616d  e(zprojectionnam
-00009110: 6529 2069 6620 6f73 2e70 6174 682e 6973  e) if os.path.is
-00009120: 6669 6c65 287a 7072 6f6a 6563 7469 6f6e  file(zprojection
-00009130: 6e61 6d65 2920 656c 7365 204e 6f6e 650a  name) else None.
-00009140: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009150: 2062 6f74 686a 736f 6e5b 276f 7269 6769   bothjson['origi
-00009160: 6e61 6c27 5d20 3d20 6f72 6770 726f 6a65  nal'] = orgproje
-00009170: 6374 696f 6e6a 736f 6e0a 2020 2020 2020  ctionjson.      
-00009180: 2020 2020 2020 2020 2020 626f 7468 6a73            bothjs
-00009190: 6f6e 5b27 7363 616c 6564 275d 203d 2070  on['scaled'] = p
-000091a0: 726f 6a65 6374 696f 6e6a 736f 6e0a 0a20  rojectionjson.. 
-000091b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000091c0: 6620 6572 726c 6973 743a 0a20 2020 2020  f errlist:.     
-000091d0: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-000091e0: 6f74 686a 736f 6e5b 2765 7272 275d 203d  othjson['err'] =
-000091f0: 207b 276f 7274 686f 676f 6e61 6c5f 6d69   {'orthogonal_mi
-00009200: 6e5f 6572 7227 3a20 6572 726c 6973 747d  n_err': errlist}
-00009210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00009220: 2066 696e 616c 6469 6374 203d 207b 6c61   finaldict = {la
-00009230: 6265 6c20 2b20 276f 7274 686f 676f 6e61  bel + 'orthogona
-00009240: 6c5f 6d69 6e27 3a20 626f 7468 6a73 6f6e  l_min': bothjson
-00009250: 7d0a 0a20 2020 2020 2020 2020 2020 2020  }..             
-00009260: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00009270: 2020 2020 2020 2020 2020 2020 7769 7468              with
-00009280: 2063 6f64 6563 732e 6f70 656e 2877 6f72   codecs.open(wor
-00009290: 6b64 6972 202b 206d 6170 6e61 6d65 202b  kdir + mapname +
-000092a0: 2027 5f6d 696e 2e6a 736f 6e27 2c20 2777   '_min.json', 'w
-000092b0: 272c 2065 6e63 6f64 696e 673d 2775 7466  ', encoding='utf
-000092c0: 2d38 2729 2061 7320 663a 0a20 2020 2020  -8') as f:.     
+00003ec0: 3438 2c20 3530 2c20 3532 2c20 3534 2c20  48, 50, 52, 54, 
+00003ed0: 3535 2c20 3537 2c20 3538 2c20 3631 2c20  55, 57, 58, 61, 
+00003ee0: 3633 2c20 3635 2c20 3637 2c20 3730 2c20  63, 65, 67, 70, 
+00003ef0: 3732 2c0a 2020 2020 2020 2020 2320 2020  72,.        #   
+00003f00: 2020 2020 2020 2020 2020 2020 2020 3733                73
+00003f10: 2c20 3736 2c20 3739 2c20 3830 2c20 3833  , 76, 79, 80, 83
+00003f20: 2c20 3836 2c20 3838 2c20 3839 2c20 3932  , 86, 88, 89, 92
+00003f30: 2c20 3935 2c20 3936 2c20 3939 2c20 3130  , 95, 96, 99, 10
+00003f40: 322c 0a20 2020 2020 2020 2023 2020 2020  2,.        #    
+00003f50: 2020 2020 2020 2020 2020 2020 2031 3034               104
+00003f60: 2c20 3130 372c 2031 3038 2c20 3131 302c  , 107, 108, 110,
+00003f70: 2031 3133 2c20 3131 362c 2031 3230 2c20   113, 116, 120, 
+00003f80: 3132 312c 2031 3233 2c20 3132 352c 2031  121, 123, 125, 1
+00003f90: 3237 2c20 3132 392c 2031 3332 2c0a 2020  27, 129, 132,.  
+00003fa0: 2020 2020 2020 2320 2020 2020 2020 2020        #         
+00003fb0: 2020 2020 2020 2020 3133 352c 2031 3337          135, 137
+00003fc0: 2c20 3134 302c 2031 3433 2c20 3134 362c  , 140, 143, 146,
+00003fd0: 2031 3439 2c20 3135 302c 2031 3533 2c20   149, 150, 153, 
+00003fe0: 3135 352c 2031 3538 2c20 3136 302c 2031  155, 158, 160, 1
+00003ff0: 3632 2c20 3136 352c 0a20 2020 2020 2020  62, 165,.       
+00004000: 2023 2020 2020 2020 2020 2020 2020 2020   #              
+00004010: 2020 2031 3638 2c20 3137 312c 2031 3733     168, 171, 173
+00004020: 2c20 3137 352c 2031 3738 2c20 3138 302c  , 175, 178, 180,
+00004030: 2031 3833 2c20 3138 362c 2031 3838 2c20   183, 186, 188, 
+00004040: 3139 312c 2031 3932 2c20 3139 352c 2031  191, 192, 195, 1
+00004050: 3938 2c0a 2020 2020 2020 2020 2320 2020  98,.        #   
+00004060: 2020 2020 2020 2020 2020 2020 2020 3230                20
+00004070: 312c 2032 3033 2c20 3230 362c 2032 3039  1, 203, 206, 209
+00004080: 2c20 3231 302c 2032 3133 2c20 3231 352c  , 210, 213, 215,
+00004090: 2032 3138 2c20 3232 312c 2032 3233 2c20   218, 221, 223, 
+000040a0: 3232 352c 2032 3238 2c20 3233 312c 0a20  225, 228, 231,. 
+000040b0: 2020 2020 2020 2023 2020 2020 2020 2020         #        
+000040c0: 2020 2020 2020 2020 2032 3333 2c20 3233           233, 23
+000040d0: 362c 2032 3338 2c20 3234 312c 2032 3434  6, 238, 241, 244
+000040e0: 2c20 3234 362c 2032 3530 2c20 3235 322c  , 246, 250, 252,
+000040f0: 2032 3535 5d0a 0a20 2020 2020 2020 2023   255]..        #
+00004100: 2041 7070 6c79 2063 6f6c 6f72 206d 6170   Apply color map
+00004110: 2075 7369 6e67 2063 7632 2e61 7070 6c79   using cv2.apply
+00004120: 436f 6c6f 724d 6170 2829 0a20 2020 2020  ColorMap().     
+00004130: 2020 2069 6d5f 636f 6c6f 7220 3d20 6376     im_color = cv
+00004140: 322e 6170 706c 7943 6f6c 6f72 4d61 7028  2.applyColorMap(
+00004150: 696d 5f67 7261 792c 206c 7574 290a 2020  im_gray, lut).  
+00004160: 2020 2020 2020 7265 7475 726e 2069 6d5f        return im_
+00004170: 636f 6c6f 720a 0a20 2020 2064 6566 206d  color..    def m
+00004180: 6f64 7265 6468 6f74 2873 656c 662c 2069  odredhot(self, i
+00004190: 6d5f 6772 6179 293a 0a20 2020 2020 2020  m_gray):.       
+000041a0: 2022 2222 0a0a 2020 2020 2020 2020 2020   """..          
+000041b0: 2020 4170 706c 7920 6d6f 6469 6669 6564    Apply modified
+000041c0: 2875 7365 2067 6c6f 7720 4c55 5420 6669  (use glow LUT fi
+000041d0: 7273 7420 616e 6420 6c61 7374 2076 616c  rst and last val
+000041e0: 7565 2074 6f20 7265 706c 6163 6520 7468  ue to replace th
+000041f0: 6520 6f72 6967 696e 616c 2072 6829 2072  e original rh) r
+00004200: 6564 2d68 6f74 204c 5554 2074 6f20 7468  ed-hot LUT to th
+00004210: 6520 6772 6179 2069 6d61 6765 0a20 2020  e gray image.   
+00004220: 2020 2020 2020 2020 2063 6861 6e6e 656c           channel
+00004230: 2032 2d20 7265 643b 2063 6861 6e6e 656c   2- red; channel
+00004240: 2031 2d67 7265 656e 3b20 6368 616e 6e65   1-green; channe
+00004250: 6c20 3020 2d20 626c 7565 0a20 2020 2020  l 0 - blue.     
+00004260: 2020 203a 7061 7261 6d20 696d 5f67 7261     :param im_gra
+00004270: 793a 0a20 2020 2020 2020 203a 7265 7475  y:.        :retu
+00004280: 726e 3a0a 2020 2020 2020 2020 2222 220a  rn:.        """.
+00004290: 0a20 2020 2020 2020 2023 2043 7265 6174  .        # Creat
+000042a0: 6520 7468 6520 4c55 543a 0a20 2020 2020  e the LUT:.     
+000042b0: 2020 206c 7574 203d 206e 702e 7a65 726f     lut = np.zero
+000042c0: 7328 2832 3536 2c20 312c 2033 292c 2064  s((256, 1, 3), d
+000042d0: 7479 7065 3d6e 702e 7569 6e74 3829 0a20  type=np.uint8). 
+000042e0: 2020 2020 2020 206c 7574 5b3a 2c20 302c         lut[:, 0,
+000042f0: 2032 5d20 3d20 5b30 2c20 302c 2030 2c20   2] = [0, 0, 0, 
+00004300: 302c 2031 2c20 312c 2031 2c20 312c 2031  0, 1, 1, 1, 1, 1
+00004310: 2c20 342c 2037 2c20 3130 2c20 3133 2c0a  , 4, 7, 10, 13,.
+00004320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004330: 2020 2020 2020 2020 3136 2c20 3230 2c20          16, 20, 
+00004340: 3233 2c20 3237 2c20 3330 2c20 3333 2c20  23, 27, 30, 33, 
+00004350: 3336 2c20 3339 2c20 3432 2c20 3435 2c20  36, 39, 42, 45, 
+00004360: 3438 2c20 3532 2c20 3535 2c0a 2020 2020  48, 52, 55,.    
+00004370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004380: 2020 2020 3538 2c20 3631 2c20 3635 2c20      58, 61, 65, 
+00004390: 3638 2c20 3731 2c20 3734 2c20 3738 2c20  68, 71, 74, 78, 
+000043a0: 3831 2c20 3834 2c20 3837 2c20 3930 2c20  81, 84, 87, 90, 
+000043b0: 3933 2c20 3936 2c0a 2020 2020 2020 2020  93, 96,.        
+000043c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000043d0: 3939 2c20 3130 332c 2031 3036 2c20 3131  99, 103, 106, 11
+000043e0: 302c 2031 3133 2c20 3131 372c 2031 3230  0, 113, 117, 120
+000043f0: 2c20 3132 332c 2031 3236 2c20 3133 302c  , 123, 126, 130,
+00004400: 2031 3333 2c20 3133 362c 2031 3339 2c0a   133, 136, 139,.
+00004410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004420: 2020 2020 2020 2020 3134 322c 2031 3435          142, 145
+00004430: 2c20 3134 382c 2031 3531 2c20 3135 352c  , 148, 151, 155,
+00004440: 2031 3538 2c20 3136 312c 2031 3634 2c20   158, 161, 164, 
+00004450: 3136 382c 2031 3731 2c20 3137 342c 2031  168, 171, 174, 1
+00004460: 3737 2c20 3138 312c 0a20 2020 2020 2020  77, 181,.       
+00004470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004480: 2031 3834 2c20 3138 372c 2031 3930 2c20   184, 187, 190, 
+00004490: 3139 332c 2031 3936 2c20 3230 302c 2032  193, 196, 200, 2
+000044a0: 3033 2c20 3230 372c 2032 3130 2c20 3231  03, 207, 210, 21
+000044b0: 332c 2032 3136 2c20 3232 302c 2032 3233  3, 216, 220, 223
+000044c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000044d0: 2020 2020 2020 2020 2020 3232 362c 2032            226, 2
+000044e0: 3239 2c20 3233 332c 2032 3336 2c20 3233  29, 233, 236, 23
+000044f0: 392c 2032 3432 2c20 3234 352c 2032 3437  9, 242, 245, 247
+00004500: 2c20 3235 302c 2032 3532 2c20 3235 352c  , 250, 252, 255,
+00004510: 2032 3535 2c20 3235 352c 0a20 2020 2020   255, 255,.     
+00004520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004530: 2020 2032 3535 2c20 3235 352c 2032 3535     255, 255, 255
+00004540: 2c20 3235 352c 2032 3535 2c20 3235 352c  , 255, 255, 255,
+00004550: 2032 3535 2c20 3235 352c 2032 3535 2c20   255, 255, 255, 
+00004560: 3235 352c 2032 3535 2c20 3235 352c 2032  255, 255, 255, 2
+00004570: 3535 2c0a 2020 2020 2020 2020 2020 2020  55,.            
+00004580: 2020 2020 2020 2020 2020 2020 3235 352c              255,
+00004590: 2032 3535 2c20 3235 352c 2032 3535 2c20   255, 255, 255, 
+000045a0: 3235 352c 2032 3535 2c20 3235 352c 2032  255, 255, 255, 2
+000045b0: 3535 2c20 3235 352c 2032 3535 2c20 3235  55, 255, 255, 25
+000045c0: 352c 2032 3535 2c20 3235 352c 0a20 2020  5, 255, 255,.   
+000045d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000045e0: 2020 2020 2032 3535 2c20 3235 352c 2032       255, 255, 2
+000045f0: 3535 2c20 3235 352c 2032 3535 2c20 3235  55, 255, 255, 25
+00004600: 352c 2032 3535 2c20 3235 352c 2032 3535  5, 255, 255, 255
+00004610: 2c20 3235 352c 2032 3535 2c20 3235 352c  , 255, 255, 255,
+00004620: 2032 3535 2c0a 2020 2020 2020 2020 2020   255,.          
+00004630: 2020 2020 2020 2020 2020 2020 2020 3235                25
+00004640: 352c 2032 3535 2c20 3235 352c 2032 3535  5, 255, 255, 255
+00004650: 2c20 3235 352c 2032 3535 2c20 3235 352c  , 255, 255, 255,
+00004660: 2032 3535 2c20 3235 352c 2032 3535 2c20   255, 255, 255, 
+00004670: 3235 352c 2032 3535 2c20 3235 352c 0a20  255, 255, 255,. 
+00004680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004690: 2020 2020 2020 2032 3535 2c20 3235 352c         255, 255,
+000046a0: 2032 3535 2c20 3235 352c 2032 3535 2c20   255, 255, 255, 
+000046b0: 3235 352c 2032 3535 2c20 3235 352c 2032  255, 255, 255, 2
+000046c0: 3535 2c20 3235 352c 2032 3535 2c20 3235  55, 255, 255, 25
+000046d0: 352c 2032 3535 2c0a 2020 2020 2020 2020  5, 255,.        
+000046e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000046f0: 3235 352c 2032 3535 2c20 3235 352c 2032  255, 255, 255, 2
+00004700: 3535 2c20 3235 352c 2032 3535 2c20 3235  55, 255, 255, 25
+00004710: 352c 2032 3535 2c20 3235 352c 2032 3535  5, 255, 255, 255
+00004720: 2c20 3235 352c 2032 3535 2c20 3235 352c  , 255, 255, 255,
+00004730: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00004740: 2020 2020 2020 2020 2032 3535 2c20 3235           255, 25
+00004750: 352c 2032 3535 2c20 3235 352c 2032 3535  5, 255, 255, 255
+00004760: 2c20 3235 352c 2032 3535 2c20 3235 352c  , 255, 255, 255,
+00004770: 2032 3535 2c20 3235 352c 2032 3535 2c20   255, 255, 255, 
+00004780: 3235 352c 2032 3535 2c0a 2020 2020 2020  255, 255,.      
+00004790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000047a0: 2020 3235 352c 2032 3535 2c20 3235 352c    255, 255, 255,
+000047b0: 2032 3535 2c20 3235 352c 2032 3535 2c20   255, 255, 255, 
+000047c0: 3235 352c 2032 3535 2c20 3235 352c 2032  255, 255, 255, 2
+000047d0: 3535 2c20 3235 352c 2032 3535 2c20 3235  55, 255, 255, 25
+000047e0: 352c 0a20 2020 2020 2020 2020 2020 2020  5,.             
+000047f0: 2020 2020 2020 2020 2020 2032 3535 2c20             255, 
+00004800: 3235 352c 2032 3535 2c20 3235 352c 2032  255, 255, 255, 2
+00004810: 3535 2c20 3235 352c 2032 3535 2c20 3235  55, 255, 255, 25
+00004820: 352c 2032 3535 2c20 3235 352c 2032 3535  5, 255, 255, 255
+00004830: 2c20 3235 352c 2032 3535 2c0a 2020 2020  , 255, 255,.    
+00004840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004850: 2020 2020 3235 352c 2032 3535 2c20 3235      255, 255, 25
+00004860: 352c 2032 3535 2c20 3235 352c 2032 3535  5, 255, 255, 255
+00004870: 2c20 3235 352c 2032 3535 2c20 3235 352c  , 255, 255, 255,
+00004880: 2032 3535 2c20 3235 352c 2032 3535 2c20   255, 255, 255, 
+00004890: 3235 352c 0a20 2020 2020 2020 2020 2020  255,.           
+000048a0: 2020 2020 2020 2020 2020 2020 2032 3535               255
+000048b0: 2c20 3235 352c 2032 3535 2c20 3235 352c  , 255, 255, 255,
+000048c0: 2032 3535 2c20 3235 352c 2032 3535 2c20   255, 255, 255, 
+000048d0: 3235 352c 2032 3535 2c20 3235 352c 2032  255, 255, 255, 2
+000048e0: 3535 2c20 3235 352c 2032 3535 2c0a 2020  55, 255, 255,.  
+000048f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004900: 2020 2020 2020 3235 352c 2032 3535 2c20        255, 255, 
+00004910: 3235 352c 2032 3535 2c20 3235 352c 2032  255, 255, 255, 2
+00004920: 3535 2c20 3235 352c 2032 3535 2c20 3235  55, 255, 255, 25
+00004930: 352c 2032 3535 2c20 3235 352c 2032 3535  5, 255, 255, 255
+00004940: 2c20 3235 352c 0a20 2020 2020 2020 2020  , 255,.         
+00004950: 2020 2020 2020 2020 2020 2020 2020 2032                 2
+00004960: 3535 2c20 3235 352c 2032 3535 2c20 3235  55, 255, 255, 25
+00004970: 352c 2032 3535 2c20 3235 352c 2032 3535  5, 255, 255, 255
+00004980: 2c20 3235 352c 2030 0a20 2020 2020 2020  , 255, 0.       
+00004990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000049a0: 205d 0a0a 2020 2020 2020 2020 6c75 745b   ]..        lut[
+000049b0: 3a2c 2030 2c20 315d 203d 205b 3133 382c  :, 0, 1] = [138,
+000049c0: 2030 2c20 302c 2030 2c20 312c 2031 2c20   0, 0, 0, 1, 1, 
+000049d0: 312c 2031 2c20 312c 2030 2c20 302c 2030  1, 1, 1, 0, 0, 0
+000049e0: 2c20 302c 0a20 2020 2020 2020 2020 2020  , 0,.           
+000049f0: 2020 2020 2020 2020 2020 2020 2030 2c20               0, 
+00004a00: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+00004a10: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
+00004a20: 2030 2c0a 2020 2020 2020 2020 2020 2020   0,.            
+00004a30: 2020 2020 2020 2020 2020 2020 302c 2030              0, 0
+00004a40: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
+00004a50: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
+00004a60: 302c 0a20 2020 2020 2020 2020 2020 2020  0,.             
+00004a70: 2020 2020 2020 2020 2020 2030 2c20 302c             0, 0,
+00004a80: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
+00004a90: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+00004aa0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00004ab0: 2020 2020 2020 2020 2020 302c 2030 2c20            0, 0, 
+00004ac0: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+00004ad0: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
+00004ae0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00004af0: 2020 2020 2020 2020 2030 2c20 302c 2030           0, 0, 0
+00004b00: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
+00004b10: 2030 2c20 302c 2030 2c20 302c 2030 2c0a   0, 0, 0, 0, 0,.
+00004b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004b30: 2020 2020 2020 2020 302c 2030 2c20 302c          0, 0, 0,
+00004b40: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
+00004b50: 312c 2032 2c20 332c 2036 2c20 392c 0a20  1, 2, 3, 6, 9,. 
+00004b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004b70: 2020 2020 2020 2031 322c 2031 362c 2031         12, 16, 1
+00004b80: 392c 2032 322c 2032 352c 2032 392c 2033  9, 22, 25, 29, 3
+00004b90: 322c 2033 352c 2033 382c 2034 322c 2034  2, 35, 38, 42, 4
+00004ba0: 352c 2034 382c 2035 312c 0a20 2020 2020  5, 48, 51,.     
+00004bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004bc0: 2020 2035 352c 2035 382c 2036 312c 2036     55, 58, 61, 6
+00004bd0: 342c 2036 382c 2037 312c 2037 342c 2037  4, 68, 71, 74, 7
+00004be0: 372c 2038 312c 2038 342c 2038 372c 2039  7, 81, 84, 87, 9
+00004bf0: 302c 2039 342c 0a20 2020 2020 2020 2020  0, 94,.         
+00004c00: 2020 2020 2020 2020 2020 2020 2020 2039                 9
+00004c10: 372c 2031 3030 2c20 3130 332c 2031 3036  7, 100, 103, 106
+00004c20: 2c20 3130 392c 2031 3132 2c20 3131 352c  , 109, 112, 115,
+00004c30: 2031 3139 2c20 3132 322c 2031 3236 2c20   119, 122, 126, 
+00004c40: 3132 392c 2031 3333 2c20 3133 362c 0a20  129, 133, 136,. 
+00004c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004c60: 2020 2020 2020 2031 3339 2c20 3134 322c         139, 142,
+00004c70: 2031 3435 2c20 3134 382c 2031 3531 2c20   145, 148, 151, 
+00004c80: 3135 342c 2031 3538 2c20 3136 312c 2031  154, 158, 161, 1
+00004c90: 3634 2c20 3136 372c 2031 3731 2c20 3137  64, 167, 171, 17
+00004ca0: 342c 2031 3737 2c0a 2020 2020 2020 2020  4, 177,.        
+00004cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004cc0: 3138 302c 2031 3834 2c20 3138 372c 2031  180, 184, 187, 1
+00004cd0: 3930 2c20 3139 332c 2031 3937 2c20 3230  90, 193, 197, 20
+00004ce0: 302c 2032 3033 2c20 3230 362c 2032 3039  0, 203, 206, 209
+00004cf0: 2c20 3231 322c 2032 3136 2c20 3231 392c  , 212, 216, 219,
+00004d00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00004d10: 2020 2020 2020 2020 2032 3233 2c20 3232           223, 22
+00004d20: 362c 2032 3239 2c20 3233 322c 2032 3336  6, 229, 232, 236
+00004d30: 2c20 3233 392c 2032 3432 2c20 3234 352c  , 239, 242, 245,
+00004d40: 2032 3439 2c20 3235 302c 2032 3532 2c20   249, 250, 252, 
+00004d50: 3235 332c 2032 3535 2c0a 2020 2020 2020  253, 255,.      
+00004d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004d70: 2020 3235 352c 2032 3535 2c20 3235 352c    255, 255, 255,
+00004d80: 2032 3535 2c20 3235 352c 2032 3535 2c20   255, 255, 255, 
+00004d90: 3235 352c 2032 3535 2c20 3235 352c 2032  255, 255, 255, 2
+00004da0: 3535 2c20 3235 352c 2032 3535 2c20 3235  55, 255, 255, 25
+00004db0: 352c 0a20 2020 2020 2020 2020 2020 2020  5,.             
+00004dc0: 2020 2020 2020 2020 2020 2032 3535 2c20             255, 
+00004dd0: 3235 352c 2032 3535 2c20 3235 352c 2032  255, 255, 255, 2
+00004de0: 3535 2c20 3235 352c 2032 3535 2c20 3235  55, 255, 255, 25
+00004df0: 352c 2032 3535 2c20 3235 352c 2032 3535  5, 255, 255, 255
+00004e00: 2c20 3235 352c 2032 3535 2c0a 2020 2020  , 255, 255,.    
+00004e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004e20: 2020 2020 3235 352c 2032 3535 2c20 3235      255, 255, 25
+00004e30: 352c 2032 3535 2c20 3235 352c 2032 3535  5, 255, 255, 255
+00004e40: 2c20 3235 352c 2032 3535 2c20 3235 352c  , 255, 255, 255,
+00004e50: 2032 3535 2c20 3235 352c 2032 3535 2c20   255, 255, 255, 
+00004e60: 3235 352c 0a20 2020 2020 2020 2020 2020  255,.           
+00004e70: 2020 2020 2020 2020 2020 2020 2032 3535               255
+00004e80: 2c20 3235 352c 2032 3535 2c20 3235 352c  , 255, 255, 255,
+00004e90: 2032 3535 2c20 3235 352c 2032 3535 2c20   255, 255, 255, 
+00004ea0: 3235 352c 2032 3535 2c20 3235 352c 2032  255, 255, 255, 2
+00004eb0: 3535 2c20 3235 352c 2032 3535 2c0a 2020  55, 255, 255,.  
+00004ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004ed0: 2020 2020 2020 3235 352c 2032 3535 2c20        255, 255, 
+00004ee0: 3235 352c 2032 3535 2c20 3235 352c 2032  255, 255, 255, 2
+00004ef0: 3535 2c20 3235 352c 2032 3535 2c20 3235  55, 255, 255, 25
+00004f00: 352c 2032 3535 2c20 3235 352c 2032 3535  5, 255, 255, 255
+00004f10: 2c20 3235 352c 0a20 2020 2020 2020 2020  , 255,.         
+00004f20: 2020 2020 2020 2020 2020 2020 2020 2032                 2
+00004f30: 3535 2c20 3235 352c 2032 3535 2c20 3235  55, 255, 255, 25
+00004f40: 352c 2032 3535 2c20 3235 352c 2032 3535  5, 255, 255, 255
+00004f50: 2c20 3235 352c 2032 3535 2c20 3235 352c  , 255, 255, 255,
+00004f60: 2032 3535 2c20 3235 352c 2032 3535 2c0a   255, 255, 255,.
+00004f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004f80: 2020 2020 2020 2020 3235 352c 2032 3535          255, 255
+00004f90: 2c20 3235 352c 2032 3535 2c20 3235 352c  , 255, 255, 255,
+00004fa0: 2032 3535 2c20 3235 352c 2032 3535 2c20   255, 255, 255, 
+00004fb0: 305d 0a0a 2020 2020 2020 2020 6c75 745b  0]..        lut[
+00004fc0: 3a2c 2030 2c20 305d 203d 205b 302c 2030  :, 0, 0] = [0, 0
+00004fd0: 2c20 302c 2030 2c20 312c 2031 2c20 312c  , 0, 0, 1, 1, 1,
+00004fe0: 2031 2c20 312c 2030 2c20 302c 2030 2c20   1, 1, 0, 0, 0, 
+00004ff0: 302c 0a20 2020 2020 2020 2020 2020 2020  0,.             
+00005000: 2020 2020 2020 2020 2020 2030 2c20 302c             0, 0,
+00005010: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
+00005020: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+00005030: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00005040: 2020 2020 2020 2020 2020 302c 2030 2c20            0, 0, 
+00005050: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+00005060: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
+00005070: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005080: 2020 2020 2020 2020 2030 2c20 302c 2030           0, 0, 0
+00005090: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
+000050a0: 2030 2c20 302c 2030 2c20 302c 2030 2c0a   0, 0, 0, 0, 0,.
+000050b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000050c0: 2020 2020 2020 2020 302c 2030 2c20 302c          0, 0, 0,
+000050d0: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
+000050e0: 302c 2030 2c20 302c 2030 2c20 302c 0a20  0, 0, 0, 0, 0,. 
+000050f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005100: 2020 2020 2020 2030 2c20 302c 2030 2c20         0, 0, 0, 
+00005110: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+00005120: 2c20 302c 2030 2c20 302c 2030 2c0a 2020  , 0, 0, 0, 0,.  
+00005130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005140: 2020 2020 2020 302c 2030 2c20 302c 2030        0, 0, 0, 0
+00005150: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
+00005160: 2030 2c20 302c 2030 2c20 302c 0a20 2020   0, 0, 0, 0,.   
+00005170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005180: 2020 2020 2030 2c20 302c 2030 2c20 302c       0, 0, 0, 0,
+00005190: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
+000051a0: 302c 2030 2c20 302c 2030 2c0a 2020 2020  0, 0, 0, 0,.    
+000051b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000051c0: 2020 2020 302c 2030 2c20 302c 2030 2c20      0, 0, 0, 0, 
+000051d0: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+000051e0: 2c20 302c 2030 2c20 302c 0a20 2020 2020  , 0, 0, 0,.     
+000051f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005200: 2020 2030 2c20 302c 2030 2c20 302c 2030     0, 0, 0, 0, 0
+00005210: 2c20 302c 2030 2c20 302c 2030 2c20 302c  , 0, 0, 0, 0, 0,
+00005220: 2030 2c20 302c 2030 2c0a 2020 2020 2020   0, 0, 0,.      
+00005230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005240: 2020 302c 2030 2c20 302c 2030 2c20 302c    0, 0, 0, 0, 0,
+00005250: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
+00005260: 302c 2030 2c20 302c 0a20 2020 2020 2020  0, 0, 0,.       
+00005270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005280: 2030 2c20 302c 2030 2c20 302c 2030 2c20   0, 0, 0, 0, 0, 
+00005290: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+000052a0: 2c20 302c 2030 2c0a 2020 2020 2020 2020  , 0, 0,.        
+000052b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000052c0: 302c 2030 2c20 302c 2030 2c20 302c 2030  0, 0, 0, 0, 0, 0
+000052d0: 2c20 302c 2030 2c20 302c 2031 2c20 332c  , 0, 0, 0, 1, 3,
+000052e0: 2034 2c20 362c 0a20 2020 2020 2020 2020   4, 6,.         
+000052f0: 2020 2020 2020 2020 2020 2020 2020 2039                 9
+00005300: 2c20 3132 2c20 3135 2c20 3139 2c20 3232  , 12, 15, 19, 22
+00005310: 2c20 3235 2c20 3238 2c20 3332 2c20 3335  , 25, 28, 32, 35
+00005320: 2c20 3338 2c20 3431 2c20 3435 2c20 3438  , 38, 41, 45, 48
+00005330: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00005340: 2020 2020 2020 2020 2020 3531 2c20 3534            51, 54
+00005350: 2c20 3538 2c20 3631 2c20 3634 2c20 3637  , 58, 61, 64, 67
+00005360: 2c20 3731 2c20 3734 2c20 3737 2c20 3830  , 71, 74, 77, 80
+00005370: 2c20 3834 2c20 3837 2c20 3930 2c0a 2020  , 84, 87, 90,.  
+00005380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005390: 2020 2020 2020 3933 2c20 3937 2c20 3130        93, 97, 10
+000053a0: 302c 2031 3033 2c20 3130 362c 2031 3130  0, 103, 106, 110
+000053b0: 2c20 3131 332c 2031 3136 2c20 3131 392c  , 113, 116, 119,
+000053c0: 2031 3232 2c20 3132 352c 2031 3238 2c20   122, 125, 128, 
+000053d0: 3133 312c 0a20 2020 2020 2020 2020 2020  131,.           
+000053e0: 2020 2020 2020 2020 2020 2020 2031 3335               135
+000053f0: 2c20 3133 382c 2031 3432 2c20 3134 352c  , 138, 142, 145,
+00005400: 2031 3439 2c20 3135 322c 2031 3535 2c20   149, 152, 155, 
+00005410: 3135 382c 2031 3631 2c20 3136 342c 2031  158, 161, 164, 1
+00005420: 3637 2c20 3137 302c 2031 3734 2c0a 2020  67, 170, 174,.  
+00005430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005440: 2020 2020 2020 3137 372c 2031 3830 2c20        177, 180, 
+00005450: 3138 332c 2031 3837 2c20 3139 302c 2031  183, 187, 190, 1
+00005460: 3933 2c20 3139 362c 2032 3030 2c20 3230  93, 196, 200, 20
+00005470: 332c 2032 3036 2c20 3230 392c 2032 3133  3, 206, 209, 213
+00005480: 2c20 3231 362c 0a20 2020 2020 2020 2020  , 216,.         
+00005490: 2020 2020 2020 2020 2020 2020 2020 2032                 2
+000054a0: 3139 2c20 3232 322c 2032 3235 2c20 3232  19, 222, 225, 22
+000054b0: 382c 2032 3332 2c20 3233 352c 2032 3339  8, 232, 235, 239
+000054c0: 2c20 3234 322c 2032 3435 2c20 3234 382c  , 242, 245, 248,
+000054d0: 2032 3532 2c20 3235 322c 2032 3533 2c0a   252, 252, 253,.
+000054e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000054f0: 2020 2020 2020 2020 3235 342c 2032 3535          254, 255
+00005500: 2c20 3235 352c 2032 3535 2c20 3235 352c  , 255, 255, 255,
+00005510: 2032 3535 2c20 3235 352c 2032 3535 2c20   255, 255, 255, 
+00005520: 3235 355d 0a0a 2020 2020 2020 2020 2320  255]..        # 
+00005530: 4170 706c 7920 636f 6c6f 7220 6d61 7020  Apply color map 
+00005540: 7573 696e 6720 6376 322e 6170 706c 7943  using cv2.applyC
+00005550: 6f6c 6f72 4d61 7028 290a 2020 2020 2020  olorMap().      
+00005560: 2020 696d 5f63 6f6c 6f72 203d 2063 7632    im_color = cv2
+00005570: 2e61 7070 6c79 436f 6c6f 724d 6170 2869  .applyColorMap(i
+00005580: 6d5f 6772 6179 2c20 6c75 7429 0a20 2020  m_gray, lut).   
+00005590: 2020 2020 2072 6574 7572 6e20 696d 5f63       return im_c
+000055a0: 6f6c 6f72 0a0a 2020 2020 6465 6620 6d61  olor..    def ma
+000055b0: 7069 6e63 6865 636b 2873 656c 662c 206d  pincheck(self, m
+000055c0: 6170 696e 2c20 776f 726b 6469 7269 6e29  apin, workdirin)
+000055d0: 3a0a 0a20 2020 2020 2020 2069 6d70 6f72  :..        impor
+000055e0: 7420 696e 7370 6563 740a 2020 2020 2020  t inspect.      
+000055f0: 2020 6672 6f6d 206d 7263 6669 6c65 2e6d    from mrcfile.m
+00005600: 7263 6669 6c65 2069 6d70 6f72 7420 4d72  rcfile import Mr
+00005610: 6346 696c 650a 0a20 2020 2020 2020 2066  cFile..        f
+00005620: 7261 6d65 203d 2069 6e73 7065 6374 2e63  rame = inspect.c
+00005630: 7572 7265 6e74 6672 616d 6528 290a 2020  urrentframe().  
+00005640: 2020 2020 2020 6675 6e63 203d 2069 6e73        func = ins
+00005650: 7065 6374 2e67 6574 6672 616d 6569 6e66  pect.getframeinf
+00005660: 6f28 6672 616d 652e 665f 6261 636b 292e  o(frame.f_back).
+00005670: 6675 6e63 7469 6f6e 0a20 2020 2020 2020  function.       
+00005680: 2069 6620 6d61 7069 6e20 6973 206e 6f74   if mapin is not
+00005690: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+000056a0: 2020 2069 6620 2874 7970 6528 6d61 7069     if (type(mapi
+000056b0: 6e29 2069 7320 7374 7229 3a0a 2020 2020  n) is str):.    
+000056c0: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+000056d0: 6f73 2e70 6174 682e 6973 6669 6c65 286d  os.path.isfile(m
+000056e0: 6170 696e 2929 3a0a 2020 2020 2020 2020  apin)):.        
+000056f0: 2020 2020 2020 2020 2020 2020 2320 6d61              # ma
+00005700: 7020 3d20 4d61 7050 6172 7365 722e 7265  p = MapParser.re
+00005710: 6164 4d52 4328 6d61 7069 6e29 0a20 2020  adMRC(mapin).   
+00005720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005730: 206d 6170 203d 206d 7263 6669 6c65 2e6d   map = mrcfile.m
+00005740: 6d61 7028 6d61 7069 6e2c 206d 6f64 653d  map(mapin, mode=
+00005750: 2772 2729 0a20 2020 2020 2020 2020 2020  'r').           
+00005760: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00005770: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00005780: 7269 6e74 2827 4d61 7020 646f 6573 206e  rint('Map does n
+00005790: 6f74 2065 7869 7374 2e27 290a 2020 2020  ot exist.').    
+000057a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000057b0: 6d61 7020 3d20 4e6f 6e65 0a20 2020 2020  map = None.     
+000057c0: 2020 2020 2020 2023 2065 6c69 6628 6973         # elif(is
+000057d0: 696e 7374 616e 6365 286d 6170 696e 2c20  instance(mapin, 
+000057e0: 4d61 7029 293a 0a20 2020 2020 2020 2020  Map)):.         
+000057f0: 2020 2065 6c69 6620 2869 7369 6e73 7461     elif (isinsta
+00005800: 6e63 6528 6d61 7069 6e2c 204d 7263 4669  nce(mapin, MrcFi
+00005810: 6c65 2929 3a0a 2020 2020 2020 2020 2020  le)):.          
+00005820: 2020 2020 2020 6d61 7020 3d20 6d61 7069        map = mapi
+00005830: 6e0a 2020 2020 2020 2020 2020 2020 656c  n.            el
+00005840: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00005850: 2020 2020 6d61 7020 3d20 4e6f 6e65 0a20      map = None. 
+00005860: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00005870: 7269 6e74 2827 4675 6e63 7469 6f6e 3a7b  rint('Function:{
+00005880: 7d20 6f6e 6c79 2061 6363 6570 7420 6120  } only accept a 
+00005890: 7374 7269 6e67 206f 6620 6675 6c6c 206d  string of full m
+000058a0: 6170 206e 616d 6520 6f72 2061 2054 454d  ap name or a TEM
+000058b0: 5079 204d 6170 206f 626a 6563 7420 6173  Py Map object as
+000058c0: 2069 6e70 7574 2e27 2e66 6f72 6d61 7428   input.'.format(
+000058d0: 6675 6e63 2929 0a20 2020 2020 2020 2065  func)).        e
+000058e0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+000058f0: 206d 6170 203d 2073 656c 662e 6d61 700a   map = self.map.
+00005900: 0a20 2020 2020 2020 2069 6620 776f 726b  .        if work
+00005910: 6469 7269 6e20 6973 206e 6f74 204e 6f6e  dirin is not Non
+00005920: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
+00005930: 6620 2874 7970 6528 776f 726b 6469 7269  f (type(workdiri
+00005940: 6e29 2069 7320 7374 7229 3a0a 2020 2020  n) is str):.    
+00005950: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+00005960: 6f73 2e70 6174 682e 6973 6469 7228 776f  os.path.isdir(wo
+00005970: 726b 6469 7269 6e29 293a 0a20 2020 2020  rkdirin)):.     
+00005980: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+00005990: 6f72 6b64 6972 203d 2077 6f72 6b64 6972  orkdir = workdir
+000059a0: 696e 0a20 2020 2020 2020 2020 2020 2020  in.             
+000059b0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000059c0: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+000059d0: 6e74 2827 4f75 7470 7574 2064 6972 6563  nt('Output direc
+000059e0: 746f 7279 2064 6f65 7320 6e6f 7420 6578  tory does not ex
+000059f0: 6973 742e 2729 0a20 2020 2020 2020 2020  ist.').         
+00005a00: 2020 2020 2020 2020 2020 2077 6f72 6b64             workd
+00005a10: 6972 203d 204e 6f6e 650a 2020 2020 2020  ir = None.      
+00005a20: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00005a30: 2020 2020 2020 2020 2020 2020 776f 726b              work
+00005a40: 6469 7220 3d20 4e6f 6e65 0a20 2020 2020  dir = None.     
+00005a50: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+00005a60: 2827 4675 6e63 7469 6f6e 3a7b 7d20 6f6e  ('Function:{} on
+00005a70: 6c79 2061 6363 6570 7420 6120 7374 7269  ly accept a stri
+00005a80: 6e67 2061 7320 7468 6520 6469 7265 6374  ng as the direct
+00005a90: 6f72 7920 7061 7261 6d65 7465 722e 272e  ory parameter.'.
+00005aa0: 666f 726d 6174 2866 756e 6329 290a 2020  format(func)).  
+00005ab0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00005ac0: 2020 2020 2020 2020 776f 726b 6469 7220          workdir 
+00005ad0: 3d20 7365 6c66 2e77 6f72 6b64 6972 0a0a  = self.workdir..
+00005ae0: 2020 2020 2020 2020 7265 7475 726e 206d          return m
+00005af0: 6170 2c20 776f 726b 6469 720a 0a20 2020  ap, workdir..   
+00005b00: 2023 2040 7072 6f66 696c 650a 2020 2020   # @profile.    
+00005b10: 6465 6620 7265 7369 7a65 5f69 6d67 2873  def resize_img(s
+00005b20: 656c 662c 2069 6e70 7574 5f61 7272 2c20  elf, input_arr, 
+00005b30: 6f75 7470 7574 5f69 6d67 293a 0a20 2020  output_img):.   
+00005b40: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00005b50: 2020 2020 2072 6573 6361 6c65 2069 6d61       rescale ima
+00005b60: 6765 2074 6f20 3330 3058 3330 302c 2069  ge to 300X300, i
+00005b70: 6620 7468 6520 696e 7075 7420 6973 206e  f the input is n
+00005b80: 6f74 2073 7175 6172 652c 2073 6361 6c65  ot square, scale
+00005b90: 2074 6865 206c 6f6e 6765 7220 6f6e 6520   the longer one 
+00005ba0: 746f 2033 3030 2061 6e64 2074 6865 206f  to 300 and the o
+00005bb0: 7468 6572 206f 6e65 0a20 2020 2020 2020  ther one.       
+00005bc0: 2020 2020 2061 6363 6f72 6469 6e67 6c79       accordingly
+00005bd0: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
+00005be0: 2069 6e70 7574 5f61 7272 3a20 6e75 6d70   input_arr: nump
+00005bf0: 7920 6172 7261 790a 2020 2020 2020 2020  y array.        
+00005c00: 3a70 6172 616d 206f 7574 7075 745f 696d  :param output_im
+00005c10: 673a 2074 6865 206e 616d 6520 7769 7468  g: the name with
+00005c20: 2066 756c 6c20 7061 7468 206f 6620 7468   full path of th
+00005c30: 6520 6f75 7470 7574 2069 6d61 6765 0a20  e output image. 
+00005c40: 2020 2020 2020 203a 7265 7475 726e 3a20         :return: 
+00005c50: 4e6f 6e65 0a20 2020 2020 2020 2022 2222  None.        """
+00005c60: 0a0a 2020 2020 2020 2020 6865 6967 6874  ..        height
+00005c70: 2c20 7769 6474 6820 3d20 696e 7075 745f  , width = input_
+00005c80: 6172 722e 7368 6170 655b 303a 325d 0a20  arr.shape[0:2]. 
+00005c90: 2020 2020 2020 2069 6620 7769 6474 6820         if width 
+00005ca0: 3e3d 2068 6569 6768 743a 0a20 2020 2020  >= height:.     
+00005cb0: 2020 2020 2020 206c 6172 6765 7273 6361         largersca
+00005cc0: 6c65 7220 3d20 3330 302e 202f 2077 6964  ler = 300. / wid
+00005cd0: 7468 0a20 2020 2020 2020 2020 2020 206e  th.            n
+00005ce0: 6577 6865 6967 6874 203d 2069 6e74 2863  ewheight = int(c
+00005cf0: 6569 6c28 6c61 7267 6572 7363 616c 6572  eil(largerscaler
+00005d00: 202a 2068 6569 6768 7429 290a 2020 2020   * height)).    
+00005d10: 2020 2020 2020 2020 7265 7369 7a65 645f          resized_
+00005d20: 696d 6720 3d20 6376 322e 7265 7369 7a65  img = cv2.resize
+00005d30: 2869 6e70 7574 5f61 7272 2c20 2833 3030  (input_arr, (300
+00005d40: 2c20 6e65 7768 6569 6768 7429 2c20 696e  , newheight), in
+00005d50: 7465 7270 6f6c 6174 696f 6e3d 6376 322e  terpolation=cv2.
+00005d60: 494e 5445 525f 4c41 4e43 5a4f 5334 290a  INTER_LANCZOS4).
+00005d70: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00005d80: 2020 2020 2020 2020 2020 6c61 7267 6572            larger
+00005d90: 7363 616c 6572 203d 2033 3030 2e20 2f20  scaler = 300. / 
+00005da0: 6865 6967 6874 0a20 2020 2020 2020 2020  height.         
+00005db0: 2020 206e 6577 7769 6474 6820 3d20 696e     newwidth = in
+00005dc0: 7428 6365 696c 286c 6172 6765 7273 6361  t(ceil(largersca
+00005dd0: 6c65 7220 2a20 7769 6474 6829 290a 2020  ler * width)).  
+00005de0: 2020 2020 2020 2020 2020 7265 7369 7a65            resize
+00005df0: 645f 696d 6720 3d20 6376 322e 7265 7369  d_img = cv2.resi
+00005e00: 7a65 2869 6e70 7574 5f61 7272 2c20 286e  ze(input_arr, (n
+00005e10: 6577 7769 6474 682c 2033 3030 292c 2069  ewwidth, 300), i
+00005e20: 6e74 6572 706f 6c61 7469 6f6e 3d63 7632  nterpolation=cv2
+00005e30: 2e49 4e54 4552 5f4c 414e 435a 4f53 3429  .INTER_LANCZOS4)
+00005e40: 0a0a 2020 2020 2020 2020 6376 322e 696d  ..        cv2.im
+00005e50: 7772 6974 6528 6f75 7470 7574 5f69 6d67  write(output_img
+00005e60: 2c20 7265 7369 7a65 645f 696d 6729 0a0a  , resized_img)..
+00005e70: 2020 2020 2020 2020 7265 7475 726e 204e          return N
+00005e80: 6f6e 650a 0a20 2020 2064 6566 2073 6361  one..    def sca
+00005e90: 6c65 5f69 6d67 2873 656c 662c 2070 726f  le_img(self, pro
+00005ea0: 6a65 6374 696f 6e29 3a0a 2020 2020 2020  jection):.      
+00005eb0: 2020 2222 220a 2020 2020 2020 2020 2020    """.          
+00005ec0: 2020 4769 7665 2074 6865 2070 726f 6a65    Give the proje
+00005ed0: 6374 696f 6e20 6173 2061 2032 4420 6e75  ction as a 2D nu
+00005ee0: 6d70 7920 6172 7261 7920 7265 7475 726e  mpy array return
+00005ef0: 2074 6865 2073 6361 6c65 6420 7072 6f6a   the scaled proj
+00005f00: 6563 7469 6f6e 0a20 2020 2020 2020 203a  ection.        :
+00005f10: 7061 7261 6d20 7072 6f6a 6563 7469 6f6e  param projection
+00005f20: 3a0a 2020 2020 2020 2020 3a72 6574 7572  :.        :retur
+00005f30: 6e3a 0a20 2020 2020 2020 2022 2222 0a0a  n:.        """..
+00005f40: 2020 2020 2020 2020 6f6e 6576 616c 7565          onevalue
+00005f50: 203d 2054 7275 6520 6966 2070 726f 6a65   = True if proje
+00005f60: 6374 696f 6e2e 6d69 6e28 2920 3d3d 2070  ction.min() == p
+00005f70: 726f 6a65 6374 696f 6e2e 6d61 7828 2920  rojection.max() 
+00005f80: 656c 7365 2046 616c 7365 0a20 2020 2020  else False.     
+00005f90: 2020 2069 6620 6f6e 6576 616c 7565 3a0a     if onevalue:.
+00005fa0: 2020 2020 2020 2020 2020 2020 7265 7363              resc
+00005fb0: 616c 6564 203d 206e 702e 6675 6c6c 2828  aled = np.full((
+00005fc0: 7072 6f6a 6563 7469 6f6e 2e73 6861 7065  projection.shape
+00005fd0: 292c 2030 2e30 292e 6173 7479 7065 2827  ), 0.0).astype('
+00005fe0: 7569 6e74 3827 290a 2020 2020 2020 2020  uint8').        
+00005ff0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00006000: 2020 7265 7363 616c 6564 203d 2028 2828    rescaled = (((
+00006010: 7072 6f6a 6563 7469 6f6e 202d 2070 726f  projection - pro
+00006020: 6a65 6374 696f 6e2e 6d69 6e28 2929 202a  jection.min()) *
+00006030: 2032 3535 2e30 2920 2f20 2870 726f 6a65   255.0) / (proje
+00006040: 6374 696f 6e2e 6d61 7828 2920 2d20 7072  ction.max() - pr
+00006050: 6f6a 6563 7469 6f6e 2e6d 696e 2829 2929  ojection.min()))
+00006060: 2e61 7374 7970 6528 0a20 2020 2020 2020  .astype(.       
+00006070: 2020 2020 2020 2020 2027 7569 6e74 3827           'uint8'
+00006080: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+00006090: 6e20 7265 7363 616c 6564 0a0a 2020 2020  n rescaled..    
+000060a0: 6465 6620 6765 745f 7072 6f6a 6563 7469  def get_projecti
+000060b0: 6f6e 2873 656c 662c 206d 6170 2c20 7479  on(self, map, ty
+000060c0: 7065 2c20 6178 6973 293a 0a20 2020 2020  pe, axis):.     
+000060d0: 2020 2022 2222 0a20 2020 2020 2020 2020     """.         
+000060e0: 2020 2047 6976 6520 6d61 7020 616e 6420     Give map and 
+000060f0: 7479 7065 2c20 6675 6e63 7469 6f6e 2070  type, function p
+00006100: 726f 6475 6365 2064 6966 6665 7265 6e74  roduce different
+00006110: 2070 726f 6a65 6374 696f 6e0a 2020 2020   projection.    
+00006120: 2020 2020 3a70 6172 616d 206d 6170 3a20      :param map: 
+00006130: 6d72 6366 696c 6520 6d61 7020 6f62 6a63  mrcfile map objc
+00006140: 6574 0a20 2020 2020 2020 203a 7061 7261  et.        :para
+00006150: 6d20 7479 7065 3a20 7374 7269 6e67 206f  m type: string o
+00006160: 6620 6e6f 726d 616c 2c20 6d61 782c 206d  f normal, max, m
+00006170: 696e 2c20 7374 642c 206d 6564 6961 6e2c  in, std, median,
+00006180: 2063 656e 7472 616c 2c20 6c61 7267 6576   central, largev
+00006190: 6172 0a20 2020 2020 2020 203a 7061 7261  ar.        :para
+000061a0: 6d20 6178 6973 3a20 322d 3e78 2c20 302d  m axis: 2->x, 0-
+000061b0: 3e7a 2c20 312d 3e79 0a20 2020 2020 2020  >z, 1->y.       
+000061c0: 203a 7265 7475 726e 3a20 6e75 6d70 7920   :return: numpy 
+000061d0: 6172 7261 7920 6f72 204e 6f6e 6520 666f  array or None fo
+000061e0: 7220 7072 6f6a 6563 7469 6f6e 0a20 2020  r projection.   
+000061f0: 2020 2020 2022 2222 0a0a 2020 2020 2020       """..      
+00006200: 2020 6d61 7064 6174 6120 3d20 6d61 702e    mapdata = map.
+00006210: 6461 7461 0a20 2020 2020 2020 2069 6620  data.        if 
+00006220: 7479 7065 203d 3d20 2770 726f 6a65 6374  type == 'project
+00006230: 696f 6e27 3a0a 2020 2020 2020 2020 2020  ion':.          
+00006240: 2020 7072 6f6a 6563 7469 6f6e 203d 206e    projection = n
+00006250: 702e 7375 6d28 6d61 7064 6174 612c 2061  p.sum(mapdata, a
+00006260: 7869 733d 6178 6973 290a 2020 2020 2020  xis=axis).      
+00006270: 2020 656c 6966 2074 7970 6520 3d3d 2027    elif type == '
+00006280: 6d61 7827 3a0a 2020 2020 2020 2020 2020  max':.          
+00006290: 2020 6966 2073 656c 662e 6d65 7420 213d    if self.met !=
+000062a0: 2027 746f 6d6f 273a 0a20 2020 2020 2020   'tomo':.       
+000062b0: 2020 2020 2020 2020 2070 726f 6a65 6374           project
+000062c0: 696f 6e20 3d20 6e70 2e61 6d61 7828 6d61  ion = np.amax(ma
+000062d0: 7064 6174 612c 2061 7869 733d 6178 6973  pdata, axis=axis
+000062e0: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+000062f0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00006300: 2020 2020 2320 746f 6d6f 6772 616d 7320      # tomograms 
+00006310: 7573 6520 6d69 6e20 6f74 6865 7273 2075  use min others u
+00006320: 7365 206d 6178 0a20 2020 2020 2020 2020  se max.         
+00006330: 2020 2020 2020 2070 726f 6a65 6374 696f         projectio
+00006340: 6e20 3d20 6e70 2e61 6d69 6e28 6d61 7064  n = np.amin(mapd
+00006350: 6174 612c 2061 7869 733d 6178 6973 290a  ata, axis=axis).
+00006360: 2020 2020 2020 2020 656c 6966 2074 7970          elif typ
+00006370: 6520 3d3d 2027 6d69 6e27 3a0a 2020 2020  e == 'min':.    
+00006380: 2020 2020 2020 2020 7072 6f6a 6563 7469          projecti
+00006390: 6f6e 203d 206e 702e 616d 696e 286d 6170  on = np.amin(map
+000063a0: 6461 7461 2c20 6178 6973 3d61 7869 7329  data, axis=axis)
+000063b0: 0a20 2020 2020 2020 2065 6c69 6620 7479  .        elif ty
+000063c0: 7065 203d 3d20 2773 7464 273a 0a20 2020  pe == 'std':.   
+000063d0: 2020 2020 2020 2020 2070 726f 6a65 6374           project
+000063e0: 696f 6e20 3d20 6e70 2e73 7464 286d 6170  ion = np.std(map
+000063f0: 6461 7461 2c20 6178 6973 3d61 7869 7329  data, axis=axis)
+00006400: 0a20 2020 2020 2020 2065 6c69 6620 7479  .        elif ty
+00006410: 7065 203d 3d20 276d 6564 6961 6e27 3a0a  pe == 'median':.
+00006420: 2020 2020 2020 2020 2020 2020 7072 6f6a              proj
+00006430: 6563 7469 6f6e 203d 206e 702e 6d65 6469  ection = np.medi
+00006440: 616e 286d 6170 6461 7461 2c20 6178 6973  an(mapdata, axis
+00006450: 3d61 7869 7329 0a20 2020 2020 2020 2065  =axis).        e
+00006460: 6c69 6620 7479 7065 203d 3d20 2763 656e  lif type == 'cen
+00006470: 7472 616c 273a 0a20 2020 2020 2020 2020  tral':.         
+00006480: 2020 2069 6620 6178 6973 203d 3d20 323a     if axis == 2:
+00006490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000064a0: 2078 6d69 6420 3d20 696e 7428 666c 6f61   xmid = int(floa
+000064b0: 7428 6d61 702e 6865 6164 6572 2e6e 7829  t(map.header.nx)
+000064c0: 202f 2032 290a 2020 2020 2020 2020 2020   / 2).          
+000064d0: 2020 2020 2020 7072 6f6a 6563 7469 6f6e        projection
+000064e0: 203d 206d 6170 2e64 6174 615b 3a2c 203a   = map.data[:, :
+000064f0: 2c20 786d 6964 5d0a 2020 2020 2020 2020  , xmid].        
+00006500: 2020 2020 656c 6966 2061 7869 7320 3d3d      elif axis ==
+00006510: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
+00006520: 2020 2020 796d 6964 203d 2069 6e74 2866      ymid = int(f
+00006530: 6c6f 6174 286d 6170 2e68 6561 6465 722e  loat(map.header.
+00006540: 6e79 2920 2f20 3229 0a20 2020 2020 2020  ny) / 2).       
+00006550: 2020 2020 2020 2020 2070 726f 6a65 6374           project
+00006560: 696f 6e20 3d20 6d61 702e 6461 7461 5b3a  ion = map.data[:
+00006570: 2c20 796d 6964 2c20 3a5d 0a20 2020 2020  , ymid, :].     
+00006580: 2020 2020 2020 2065 6c69 6620 6178 6973         elif axis
+00006590: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
+000065a0: 2020 2020 2020 207a 6d69 6420 3d20 696e         zmid = in
+000065b0: 7428 666c 6f61 7428 6d61 702e 6865 6164  t(float(map.head
+000065c0: 6572 2e6e 7a29 202f 2032 290a 2020 2020  er.nz) / 2).    
+000065d0: 2020 2020 2020 2020 2020 2020 7072 6f6a              proj
+000065e0: 6563 7469 6f6e 203d 206d 6170 2e64 6174  ection = map.dat
+000065f0: 615b 7a6d 6964 2c20 3a2c 203a 5d0a 2020  a[zmid, :, :].  
+00006600: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00006610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006620: 7072 6f6a 6563 7469 6f6e 203d 204e 6f6e  projection = Non
+00006630: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00006640: 2020 7072 696e 7428 2757 726f 6e67 2061    print('Wrong a
+00006650: 7869 7320 696e 6465 7820 2830 2c20 312c  xis index (0, 1,
+00006660: 2032 292e 2729 0a20 2020 2020 2020 2065   2).').        e
+00006670: 6c69 6620 7479 7065 203d 3d20 276c 6172  lif type == 'lar
+00006680: 6765 7374 7661 7269 616e 6365 273a 0a20  gestvariance':. 
+00006690: 2020 2020 2020 2020 2020 207a 6c69 6d2c             zlim,
+000066a0: 2079 6c69 6d2c 2078 6c69 6d20 3d20 6d61   ylim, xlim = ma
+000066b0: 702e 6461 7461 2e73 6861 7065 0a20 2020  p.data.shape.   
+000066c0: 2020 2020 2020 2020 2069 6620 6178 6973           if axis
+000066d0: 203d 3d20 323a 0a20 2020 2020 2020 2020   == 2:.         
+000066e0: 2020 2020 2020 2078 7661 7220 3d20 5b6e         xvar = [n
+000066f0: 6469 6d61 6765 2e76 6172 6961 6e63 6528  dimage.variance(
+00006700: 6d61 702e 6461 7461 5b3a 2c20 3a2c 2069  map.data[:, :, i
+00006710: 5d29 2066 6f72 2069 2069 6e20 7261 6e67  ]) for i in rang
+00006720: 6528 302c 2078 6c69 6d29 5d0a 2020 2020  e(0, xlim)].    
+00006730: 2020 2020 2020 2020 2020 2020 786c 6172              xlar
+00006740: 6765 696e 6420 3d20 696e 7428 6e70 2e61  geind = int(np.a
+00006750: 7267 6d61 7828 7876 6172 2929 0a20 2020  rgmax(xvar)).   
+00006760: 2020 2020 2020 2020 2020 2020 2070 726f               pro
+00006770: 6a65 6374 696f 6e20 3d20 6d61 702e 6461  jection = map.da
+00006780: 7461 5b3a 2c20 3a2c 2078 6c61 7267 6569  ta[:, :, xlargei
+00006790: 6e64 5d0a 2020 2020 2020 2020 2020 2020  nd].            
+000067a0: 656c 6966 2061 7869 7320 3d3d 2031 3a0a  elif axis == 1:.
+000067b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000067c0: 7976 6172 203d 205b 6e64 696d 6167 652e  yvar = [ndimage.
+000067d0: 7661 7269 616e 6365 286d 6170 2e64 6174  variance(map.dat
+000067e0: 615b 3a2c 2069 2c20 3a5d 2920 666f 7220  a[:, i, :]) for 
+000067f0: 6920 696e 2072 616e 6765 2830 2c20 796c  i in range(0, yl
+00006800: 696d 295d 0a20 2020 2020 2020 2020 2020  im)].           
+00006810: 2020 2020 2079 6c61 7267 6569 6e64 203d       ylargeind =
+00006820: 2069 6e74 286e 702e 6172 676d 6178 2879   int(np.argmax(y
+00006830: 7661 7229 290a 2020 2020 2020 2020 2020  var)).          
+00006840: 2020 2020 2020 7072 6f6a 6563 7469 6f6e        projection
+00006850: 203d 206d 6170 2e64 6174 615b 3a2c 2079   = map.data[:, y
+00006860: 6c61 7267 6569 6e64 2c20 3a5d 0a20 2020  largeind, :].   
+00006870: 2020 2020 2020 2020 2065 6c69 6620 6178           elif ax
+00006880: 6973 203d 3d20 303a 0a20 2020 2020 2020  is == 0:.       
+00006890: 2020 2020 2020 2020 207a 7661 7220 3d20           zvar = 
+000068a0: 5b6e 6469 6d61 6765 2e76 6172 6961 6e63  [ndimage.varianc
+000068b0: 6528 6d61 702e 6461 7461 5b69 2c20 3a2c  e(map.data[i, :,
+000068c0: 203a 5d29 2066 6f72 2069 2069 6e20 7261   :]) for i in ra
+000068d0: 6e67 6528 302c 207a 6c69 6d29 5d0a 2020  nge(0, zlim)].  
+000068e0: 2020 2020 2020 2020 2020 2020 2020 7a6c                zl
+000068f0: 6172 6765 696e 6420 3d20 696e 7428 6e70  argeind = int(np
+00006900: 2e61 7267 6d61 7828 7a76 6172 2929 0a20  .argmax(zvar)). 
+00006910: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00006920: 726f 6a65 6374 696f 6e20 3d20 6d61 702e  rojection = map.
+00006930: 6461 7461 5b7a 6c61 7267 6569 6e64 2c20  data[zlargeind, 
+00006940: 3a2c 203a 5d0a 2020 2020 2020 2020 2020  :, :].          
+00006950: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00006960: 2020 2020 2020 2020 7072 6f6a 6563 7469          projecti
+00006970: 6f6e 203d 204e 6f6e 650a 2020 2020 2020  on = None.      
+00006980: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+00006990: 2757 726f 6e67 2061 7869 7320 696e 6465  'Wrong axis inde
+000069a0: 7820 2830 2c20 312c 2032 292e 2729 0a20  x (0, 1, 2).'). 
+000069b0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000069c0: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
+000069d0: 5772 6f6e 6720 7479 7065 2e20 5573 6520  Wrong type. Use 
+000069e0: 6f6e 6520 6f66 3a20 7072 6f6a 6563 7469  one of: projecti
+000069f0: 6f6e 2c20 6d61 782c 206d 696e 2c20 7374  on, max, min, st
+00006a00: 642c 206d 6564 6961 6e2c 2063 656e 7472  d, median, centr
+00006a10: 616c 2c20 6c61 7267 6573 7476 6172 6961  al, largestvaria
+00006a20: 6e63 652e 2729 0a20 2020 2020 2020 2020  nce.').         
+00006a30: 2020 2070 726f 6a65 6374 696f 6e20 3d20     projection = 
+00006a40: 4e6f 6e65 0a0a 2020 2020 2020 2020 7265  None..        re
+00006a50: 7475 726e 2070 726f 6a65 6374 696f 6e0a  turn projection.
+00006a60: 0a20 2020 2064 6566 2073 6176 655f 7363  .    def save_sc
+00006a70: 616c 6528 7365 6c66 2c20 7265 706f 7369  ale(self, reposi
+00006a80: 7469 6f6e 2c20 6178 6973 5f6c 6574 7465  tion, axis_lette
+00006a90: 722c 206d 6170 6e61 6d65 2c20 7479 7065  r, mapname, type
+00006aa0: 2c20 6572 726c 6973 742c 2070 726f 635f  , errlist, proc_
+00006ab0: 6675 6e3d 4e6f 6e65 293a 0a20 2020 2020  fun=None):.     
+00006ac0: 2020 2022 2222 0a20 2020 2020 2020 2020     """.         
+00006ad0: 2020 2066 756e 6374 696f 6e20 7361 7665     function save
+00006ae0: 2074 6865 2069 6d61 6765 2061 6e64 2069   the image and i
+00006af0: 7420 7363 616c 6564 2069 6d61 6765 0a20  t scaled image. 
+00006b00: 2020 2020 2020 203a 7061 7261 6d20 7265         :param re
+00006b10: 706f 7369 7469 6f6e 3a20 6e75 6d70 7920  position: numpy 
+00006b20: 6172 7261 7920 6f66 2074 6865 2069 6d61  array of the ima
+00006b30: 6765 0a20 2020 2020 2020 203a 7061 7261  ge.        :para
+00006b40: 6d20 6178 6973 5f6c 6574 7465 723a 2027  m axis_letter: '
+00006b50: 7827 2c20 2779 2720 6f72 2027 7a27 0a20  x', 'y' or 'z'. 
+00006b60: 2020 2020 2020 203a 7061 7261 6d20 6d61         :param ma
+00006b70: 706e 616d 653a 2073 7472 696e 6720 6f66  pname: string of
+00006b80: 2074 6865 206d 6170 206e 616d 650a 2020   the map name.  
+00006b90: 2020 2020 2020 3a70 6172 616d 2074 7970        :param typ
+00006ba0: 653a 206f 6e65 2073 7472 696e 6720 6f66  e: one string of
+00006bb0: 2070 726f 6a65 6374 696f 6e2c 206d 6178   projection, max
+00006bc0: 2c20 6d69 6e2c 2073 7464 2c20 6d65 6469  , min, std, medi
+00006bd0: 616e 2c20 6365 6e74 7261 6c2c 206c 6172  an, central, lar
+00006be0: 6765 7374 7661 7269 616e 6365 0a20 2020  gestvariance.   
+00006bf0: 2020 2020 203a 7061 7261 6d20 6572 726c       :param errl
+00006c00: 6973 743a 206c 6973 7420 636f 6e74 6169  ist: list contai
+00006c10: 6e73 2065 7272 6f72 2073 7472 696e 670a  ns error string.
+00006c20: 2020 2020 2020 2020 3a70 6172 616d 2070          :param p
+00006c30: 726f 635f 6675 6e3a 2061 2069 6d61 6765  roc_fun: a image
+00006c40: 2070 726f 6365 7373 696e 6720 6675 6e63   processing func
+00006c50: 7469 6f6e 2077 6869 6368 2061 7070 6c69  tion which appli
+00006c60: 6564 2074 6f20 7072 6f6a 6563 7469 6f6e  ed to projection
+00006c70: 2065 2e67 2e2c 2073 656c 662e 676c 6f77   e.g., self.glow
+00006c80: 696d 6167 6528 292c 0a20 2020 2020 2020  image(),.       
+00006c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006ca0: 2063 7632 2e61 7070 6c79 436f 6c6f 724d   cv2.applyColorM
+00006cb0: 6170 2878 666c 6970 7065 642c 2063 7632  ap(xflipped, cv2
+00006cc0: 2e43 4f4c 4f52 4d41 505f 484f 5429 2872  .COLORMAP_HOT)(r
+00006cd0: 6829 2c20 7365 6c66 2e6d 6f64 7265 6468  h), self.modredh
+00006ce0: 6f74 2879 726f 7461 7465 2928 6d6f 6472  ot(yrotate)(modr
+00006cf0: 6829 0a20 2020 2020 2020 203a 7265 7475  h).        :retu
+00006d00: 726e 3a20 4e6f 6e65 0a20 2020 2020 2020  rn: None.       
+00006d10: 2022 2222 0a0a 2020 2020 2020 2020 6966   """..        if
+00006d20: 2070 726f 635f 6675 6e20 3d3d 2073 656c   proc_fun == sel
+00006d30: 662e 676c 6f77 696d 6167 653a 0a20 2020  f.glowimage:.   
+00006d40: 2020 2020 2020 2020 2070 726f 6a5f 696d           proj_im
+00006d50: 675f 6e61 6d65 203d 2027 7b7d 7b7d 5f67  g_name = '{}{}_g
+00006d60: 6c6f 775f 7b7d 7b7d 2e6a 7065 6727 2e66  low_{}{}.jpeg'.f
+00006d70: 6f72 6d61 7428 7365 6c66 2e77 6f72 6b64  ormat(self.workd
+00006d80: 6972 2c20 6d61 706e 616d 652c 2061 7869  ir, mapname, axi
+00006d90: 735f 6c65 7474 6572 2c20 7479 7065 290a  s_letter, type).
+00006da0: 2020 2020 2020 2020 2020 2020 7363 616c              scal
+00006db0: 6564 5f70 726f 6a5f 696d 675f 6e61 6d65  ed_proj_img_name
+00006dc0: 203d 2027 7b7d 7b7d 5f73 6361 6c65 645f   = '{}{}_scaled_
+00006dd0: 676c 6f77 5f7b 7d7b 7d2e 6a70 6567 272e  glow_{}{}.jpeg'.
+00006de0: 666f 726d 6174 2873 656c 662e 776f 726b  format(self.work
+00006df0: 6469 722c 206d 6170 6e61 6d65 2c20 6178  dir, mapname, ax
+00006e00: 6973 5f6c 6574 7465 722c 2074 7970 6529  is_letter, type)
+00006e10: 0a20 2020 2020 2020 2065 6c69 6620 7479  .        elif ty
+00006e20: 7065 203d 3d20 2763 656e 7472 616c 2720  pe == 'central' 
+00006e30: 6f72 2074 7970 6520 3d3d 2027 6c61 7267  or type == 'larg
+00006e40: 6573 7476 6172 6961 6e63 6527 3a0a 2020  estvariance':.  
+00006e50: 2020 2020 2020 2020 2020 7072 6f6a 5f69            proj_i
+00006e60: 6d67 5f6e 616d 6520 3d20 277b 7d7b 7d5f  mg_name = '{}{}_
+00006e70: 7b7d 7b7d 5f73 6c69 6365 2e6a 7065 6727  {}{}_slice.jpeg'
+00006e80: 2e66 6f72 6d61 7428 7365 6c66 2e77 6f72  .format(self.wor
+00006e90: 6b64 6972 2c20 6d61 706e 616d 652c 2061  kdir, mapname, a
+00006ea0: 7869 735f 6c65 7474 6572 2c20 7479 7065  xis_letter, type
+00006eb0: 290a 2020 2020 2020 2020 2020 2020 7363  ).            sc
+00006ec0: 616c 6564 5f70 726f 6a5f 696d 675f 6e61  aled_proj_img_na
+00006ed0: 6d65 203d 2027 7b7d 7b7d 5f73 6361 6c65  me = '{}{}_scale
+00006ee0: 645f 7b7d 7b7d 5f73 6c69 6365 2e6a 7065  d_{}{}_slice.jpe
+00006ef0: 6727 2e66 6f72 6d61 7428 7365 6c66 2e77  g'.format(self.w
+00006f00: 6f72 6b64 6972 2c20 6d61 706e 616d 652c  orkdir, mapname,
+00006f10: 2061 7869 735f 6c65 7474 6572 2c20 7479   axis_letter, ty
+00006f20: 7065 290a 2020 2020 2020 2020 656c 7365  pe).        else
+00006f30: 3a0a 2020 2020 2020 2020 2020 2020 7072  :.            pr
+00006f40: 6f6a 5f69 6d67 5f6e 616d 6520 3d20 277b  oj_img_name = '{
+00006f50: 7d7b 7d5f 7b7d 7b7d 2e6a 7065 6727 2e66  }{}_{}{}.jpeg'.f
+00006f60: 6f72 6d61 7428 7365 6c66 2e77 6f72 6b64  ormat(self.workd
+00006f70: 6972 2c20 6d61 706e 616d 652c 2061 7869  ir, mapname, axi
+00006f80: 735f 6c65 7474 6572 2c20 7479 7065 290a  s_letter, type).
+00006f90: 2020 2020 2020 2020 2020 2020 7363 616c              scal
+00006fa0: 6564 5f70 726f 6a5f 696d 675f 6e61 6d65  ed_proj_img_name
+00006fb0: 203d 2027 7b7d 7b7d 5f73 6361 6c65 645f   = '{}{}_scaled_
+00006fc0: 7b7d 7b7d 2e6a 7065 6727 2e66 6f72 6d61  {}{}.jpeg'.forma
+00006fd0: 7428 7365 6c66 2e77 6f72 6b64 6972 2c20  t(self.workdir, 
+00006fe0: 6d61 706e 616d 652c 2061 7869 735f 6c65  mapname, axis_le
+00006ff0: 7474 6572 2c20 7479 7065 290a 0a0a 2020  tter, type)...  
+00007000: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00007010: 2020 2020 2020 2063 7632 2e69 6d77 7269         cv2.imwri
+00007020: 7465 2870 726f 6a5f 696d 675f 6e61 6d65  te(proj_img_name
+00007030: 2c20 7265 706f 7369 7469 6f6e 290a 2020  , reposition).  
+00007040: 2020 2020 2020 6578 6365 7074 2049 4f45        except IOE
+00007050: 7272 6f72 2061 7320 696f 6572 723a 0a20  rror as ioerr:. 
+00007060: 2020 2020 2020 2020 2020 2069 6620 7072             if pr
+00007070: 6f63 5f66 756e 203d 3d20 7365 6c66 2e67  oc_fun == self.g
+00007080: 6c6f 7769 6d61 6765 3a0a 2020 2020 2020  lowimage:.      
+00007090: 2020 2020 2020 2020 2020 6572 7220 3d20            err = 
+000070a0: 2753 6176 696e 6720 7b7d 7b7d 2067 6c6f  'Saving {}{} glo
+000070b0: 7720 7072 6f6a 6563 7469 6f6e 2065 7272  w projection err
+000070c0: 3a7b 7d27 2e66 6f72 6d61 7428 6178 6973  :{}'.format(axis
+000070d0: 5f6c 6574 7465 722c 2074 7970 652c 2069  _letter, type, i
+000070e0: 6f65 7272 290a 2020 2020 2020 2020 2020  oerr).          
+000070f0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00007100: 2020 2020 2020 2020 6572 7220 3d20 2753          err = 'S
+00007110: 6176 696e 6720 6f72 6967 696e 616c 207b  aving original {
+00007120: 7d7b 7d20 6572 723a 7b7d 272e 666f 726d  }{} err:{}'.form
+00007130: 6174 2861 7869 735f 6c65 7474 6572 2c20  at(axis_letter, 
+00007140: 7479 7065 2c20 696f 6572 7229 0a20 2020  type, ioerr).   
+00007150: 2020 2020 2020 2020 2065 7272 6c69 7374           errlist
+00007160: 2e61 7070 656e 6428 6572 7229 0a20 2020  .append(err).   
+00007170: 2020 2020 2020 2020 2073 7973 2e73 7464           sys.std
+00007180: 6572 722e 7772 6974 6528 6572 7220 2b20  err.write(err + 
+00007190: 275c 6e27 290a 0a20 2020 2020 2020 2074  '\n')..        t
+000071a0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+000071b0: 7365 6c66 2e72 6573 697a 655f 696d 6728  self.resize_img(
+000071c0: 7265 706f 7369 7469 6f6e 2c20 7363 616c  reposition, scal
+000071d0: 6564 5f70 726f 6a5f 696d 675f 6e61 6d65  ed_proj_img_name
+000071e0: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
+000071f0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00007200: 2070 726f 635f 6675 6e20 3d3d 2073 656c   proc_fun == sel
+00007210: 662e 676c 6f77 696d 6167 653a 0a20 2020  f.glowimage:.   
+00007220: 2020 2020 2020 2020 2020 2020 2065 7272               err
+00007230: 203d 2027 5361 7669 6e67 2073 6361 6c65   = 'Saving scale
+00007240: 6420 676c 6f77 2069 6d61 6765 207b 7d7b  d glow image {}{
+00007250: 7d20 6572 723a 7b7d 272e 666f 726d 6174  } err:{}'.format
+00007260: 2861 7869 735f 6c65 7474 6572 2c20 7479  (axis_letter, ty
+00007270: 7065 2c20 7379 732e 6578 635f 696e 666f  pe, sys.exc_info
+00007280: 2829 5b31 5d29 0a20 2020 2020 2020 2020  ()[1]).         
+00007290: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000072a0: 2020 2020 2020 2020 2065 7272 203d 2027           err = '
+000072b0: 5361 7669 6e67 2073 6361 6c65 6420 7b7d  Saving scaled {}
+000072c0: 207b 7d20 6572 723a 7b7d 272e 666f 726d   {} err:{}'.form
+000072d0: 6174 2861 7869 735f 6c65 7474 6572 2c20  at(axis_letter, 
+000072e0: 7479 7065 2c20 7379 732e 6578 635f 696e  type, sys.exc_in
+000072f0: 666f 2829 5b31 5d29 0a20 2020 2020 2020  fo()[1]).       
+00007300: 2020 2020 2065 7272 6c69 7374 2e61 7070       errlist.app
+00007310: 656e 6428 6572 7229 0a20 2020 2020 2020  end(err).       
+00007320: 2020 2020 2073 7973 2e73 7464 6572 722e       sys.stderr.
+00007330: 7772 6974 6528 6572 7220 2b20 275c 6e27  write(err + '\n'
+00007340: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+00007350: 6e20 4e6f 6e65 0a0a 2020 2020 6465 6620  n None..    def 
+00007360: 6d61 705f 746f 5f69 6d67 2873 656c 662c  map_to_img(self,
+00007370: 206d 6170 2c20 6178 6973 2c20 7479 7065   map, axis, type
+00007380: 2c20 6572 726c 6973 742c 2070 726f 635f  , errlist, proc_
+00007390: 6675 6e3d 4e6f 6e65 293a 0a20 2020 2020  fun=None):.     
+000073a0: 2020 2022 2222 0a20 2020 2020 2020 2020     """.         
+000073b0: 2020 2047 6976 6520 7468 6520 6d61 7064     Give the mapd
+000073c0: 6174 612c 206f 7574 7075 7420 6669 6c65  ata, output file
+000073d0: 206e 616d 652c 2064 696d 656e 7369 6f6e   name, dimension
+000073e0: 2061 6e64 2065 7272 6c69 7374 2069 7420   and errlist it 
+000073f0: 7072 6f64 7563 6520 7468 6520 636f 7272  produce the corr
+00007400: 6573 706f 646e 696e 6720 7072 6f6a 6563  espodning projec
+00007410: 7469 6f6e 0a20 2020 2020 2020 203a 7061  tion.        :pa
+00007420: 7261 6d20 6d61 703a 206d 7263 6669 6c65  ram map: mrcfile
+00007430: 206f 626a 6563 740a 2020 2020 2020 2020   object.        
+00007440: 3a70 6172 616d 2061 7869 733a 2032 2d3e  :param axis: 2->
+00007450: 782c 2030 2d3e 7a2c 2031 2d3e 790a 2020  x, 0->z, 1->y.  
+00007460: 2020 2020 2020 3a70 6172 616d 206f 7574        :param out
+00007470: 7075 745f 6e61 6d65 3a20 7374 7269 6e67  put_name: string
+00007480: 206f 6620 6f75 7470 7574 2066 696c 6520   of output file 
+00007490: 6e61 6d65 0a20 2020 2020 2020 203a 7061  name.        :pa
+000074a0: 7261 6d20 6572 726c 6973 743a 206c 6973  ram errlist: lis
+000074b0: 7420 666f 7220 6572 726f 7220 7374 7269  t for error stri
+000074c0: 6e67 0a20 2020 2020 2020 203a 7061 7261  ng.        :para
+000074d0: 6d20 7072 6f63 5f66 756e 3a20 6120 696d  m proc_fun: a im
+000074e0: 6167 6520 7072 6f63 6573 7369 6e67 2066  age processing f
+000074f0: 756e 6374 696f 6e20 7768 6963 6820 6170  unction which ap
+00007500: 706c 6965 6420 746f 2070 726f 6a65 6374  plied to project
+00007510: 696f 6e20 652e 672e 2c20 7365 6c66 2e67  ion e.g., self.g
+00007520: 6c6f 7769 6d61 6765 2829 2c0a 2020 2020  lowimage(),.    
+00007530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007540: 2020 2020 6376 322e 6170 706c 7943 6f6c      cv2.applyCol
+00007550: 6f72 4d61 7028 7866 6c69 7070 6564 2c20  orMap(xflipped, 
+00007560: 6376 322e 434f 4c4f 524d 4150 5f48 4f54  cv2.COLORMAP_HOT
+00007570: 2928 7268 292c 2073 656c 662e 6d6f 6472  )(rh), self.modr
+00007580: 6564 686f 7428 7972 6f74 6174 6529 286d  edhot(yrotate)(m
+00007590: 6f64 7268 290a 2020 2020 2020 2020 3a72  odrh).        :r
+000075a0: 6574 7572 6e3a 204e 6f6e 650a 2020 2020  eturn: None.    
+000075b0: 2020 2020 2222 220a 0a20 2020 2020 2020      """..       
+000075c0: 2070 726f 6a65 6374 696f 6e20 3d20 7365   projection = se
+000075d0: 6c66 2e67 6574 5f70 726f 6a65 6374 696f  lf.get_projectio
+000075e0: 6e28 6d61 702c 2074 7970 652c 2061 7869  n(map, type, axi
+000075f0: 7329 0a20 2020 2020 2020 2072 6573 6361  s).        resca
+00007600: 6c65 6420 3d20 7365 6c66 2e73 6361 6c65  led = self.scale
+00007610: 5f69 6d67 2870 726f 6a65 6374 696f 6e29  _img(projection)
+00007620: 0a20 2020 2020 2020 2069 6620 6178 6973  .        if axis
+00007630: 203d 3d20 323a 0a20 2020 2020 2020 2020   == 2:.         
+00007640: 2020 2072 6570 6f73 6974 696f 6e20 3d20     reposition = 
+00007650: 6e70 2e66 6c69 7075 6428 7265 7363 616c  np.flipud(rescal
+00007660: 6564 290a 2020 2020 2020 2020 2020 2020  ed).            
+00007670: 6178 6973 5f6c 6574 7465 7220 3d20 2778  axis_letter = 'x
+00007680: 270a 2020 2020 2020 2020 656c 6966 2061  '.        elif a
+00007690: 7869 7320 3d3d 2031 3a0a 2020 2020 2020  xis == 1:.      
+000076a0: 2020 2020 2020 7265 706f 7369 7469 6f6e        reposition
+000076b0: 203d 206e 702e 726f 7439 3028 7265 7363   = np.rot90(resc
+000076c0: 616c 6564 290a 2020 2020 2020 2020 2020  aled).          
+000076d0: 2020 6178 6973 5f6c 6574 7465 7220 3d20    axis_letter = 
+000076e0: 2779 270a 2020 2020 2020 2020 656c 6966  'y'.        elif
+000076f0: 2061 7869 7320 3d3d 2030 3a0a 2020 2020   axis == 0:.    
+00007700: 2020 2020 2020 2020 7265 706f 7369 7469          repositi
+00007710: 6f6e 203d 206e 702e 666c 6970 7564 2872  on = np.flipud(r
+00007720: 6573 6361 6c65 6429 0a20 2020 2020 2020  escaled).       
+00007730: 2020 2020 2061 7869 735f 6c65 7474 6572       axis_letter
+00007740: 203d 2027 7a27 0a20 2020 2020 2020 2065   = 'z'.        e
+00007750: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00007760: 2072 6570 6f73 6974 696f 6e20 3d20 4e6f   reposition = No
+00007770: 6e65 0a20 2020 2020 2020 2020 2020 2061  ne.            a
+00007780: 7869 735f 6c65 7474 6572 203d 204e 6f6e  xis_letter = Non
+00007790: 650a 2020 2020 2020 2020 2020 2020 7072  e.            pr
+000077a0: 696e 7428 2761 7869 7320 7368 6f75 6c64  int('axis should
+000077b0: 2062 6520 302c 2031 2c20 3220 7265 7072   be 0, 1, 2 repr
+000077c0: 6573 656e 7420 7a2c 2079 2c20 782e 2729  esent z, y, x.')
+000077d0: 0a0a 2020 2020 2020 2020 6966 2072 6570  ..        if rep
+000077e0: 6f73 6974 696f 6e20 6973 206e 6f74 204e  osition is not N
+000077f0: 6f6e 6520 616e 6420 6178 6973 5f6c 6574  one and axis_let
+00007800: 7465 7220 6973 206e 6f74 204e 6f6e 653a  ter is not None:
+00007810: 0a20 2020 2020 2020 2020 2020 206d 6170  .            map
+00007820: 6e61 6d65 203d 206f 732e 7061 7468 2e62  name = os.path.b
+00007830: 6173 656e 616d 6528 6d61 702e 6675 6c6c  asename(map.full
+00007840: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
+00007850: 2020 7365 6c66 2e73 6176 655f 7363 616c    self.save_scal
+00007860: 6528 7265 706f 7369 7469 6f6e 2c20 6178  e(reposition, ax
+00007870: 6973 5f6c 6574 7465 722c 206d 6170 6e61  is_letter, mapna
+00007880: 6d65 2c20 7479 7065 2c20 6572 726c 6973  me, type, errlis
+00007890: 7429 0a20 2020 2020 2020 2020 2020 2069  t).            i
+000078a0: 6620 7072 6f63 5f66 756e 3a0a 2020 2020  f proc_fun:.    
+000078b0: 2020 2020 2020 2020 2020 2020 676c 6f77              glow
+000078c0: 696d 6167 6520 3d20 7072 6f63 5f66 756e  image = proc_fun
+000078d0: 2872 6570 6f73 6974 696f 6e29 0a20 2020  (reposition).   
+000078e0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+000078f0: 662e 7361 7665 5f73 6361 6c65 2867 6c6f  f.save_scale(glo
+00007900: 7769 6d61 6765 2c20 6178 6973 5f6c 6574  wimage, axis_let
+00007910: 7465 722c 206d 6170 6e61 6d65 2c20 7479  ter, mapname, ty
+00007920: 7065 2c20 6572 726c 6973 742c 2070 726f  pe, errlist, pro
+00007930: 635f 6675 6e29 0a0a 2020 2020 2020 2020  c_fun)..        
+00007940: 7265 7475 726e 204e 6f6e 650a 0a20 2020  return None..   
+00007950: 2023 2040 7072 6f66 696c 650a 2020 2020   # @profile.    
+00007960: 6465 6620 6f72 7468 6f67 6f6e 616c 5f70  def orthogonal_p
+00007970: 726f 6a65 6374 696f 6e73 2873 656c 662c  rojections(self,
+00007980: 206d 6170 696e 3d4e 6f6e 652c 2077 6f72   mapin=None, wor
+00007990: 6b64 6972 3d4e 6f6e 652c 206c 6162 656c  kdir=None, label
+000079a0: 3d27 2729 3a0a 2020 2020 2020 2020 2222  =''):.        ""
+000079b0: 220a 2020 2020 2020 2020 2020 2020 2053  ".             S
+000079c0: 7464 2070 726f 6a65 6374 696f 6e20 616e  td projection an
+000079d0: 6420 6974 2067 6c6f 7720 696d 6167 650a  d it glow image.
+000079e0: 2020 2020 2020 2020 3a70 6172 616d 206d          :param m
+000079f0: 6170 696e 3a20 496e 7075 7420 6d61 7020  apin: Input map 
+00007a00: 6569 7468 6572 206d 7263 6669 6c65 206f  either mrcfile o
+00007a10: 7220 6669 6c65 6e61 6d65 2073 7472 696e  r filename strin
+00007a20: 670a 2020 2020 2020 2020 3a70 6172 616d  g.        :param
+00007a30: 2077 6f72 6b64 6972 3a20 5374 7269 6e67   workdir: String
+00007a40: 206f 6620 7468 6520 6675 6c6c 2077 6f72   of the full wor
+00007a50: 6b20 7061 7468 0a20 2020 2020 2020 203a  k path.        :
+00007a60: 7061 7261 6d20 6c61 6265 6c3a 2066 6f72  param label: for
+00007a70: 2072 6177 206d 6170 2075 7365 2027 7261   raw map use 'ra
+00007a80: 775f 270a 2020 2020 2020 2020 3a72 6574  w_'.        :ret
+00007a90: 7572 6e3a 204e 6f6e 650a 2020 2020 2020  urn: None.      
+00007aa0: 2020 2222 220a 0a20 2020 2020 2020 206d    """..        m
+00007ab0: 6170 2c20 776f 726b 6469 7220 3d20 7365  ap, workdir = se
+00007ac0: 6c66 2e6d 6170 696e 6368 6563 6b28 6d61  lf.mapincheck(ma
+00007ad0: 7069 6e2c 2077 6f72 6b64 6972 290a 2020  pin, workdir).  
+00007ae0: 2020 2020 2020 6d61 706e 616d 6520 3d20        mapname = 
+00007af0: 6f73 2e70 6174 682e 6261 7365 6e61 6d65  os.path.basename
+00007b00: 286d 6170 2e66 756c 6c6e 616d 6529 2069  (map.fullname) i
+00007b10: 6620 6d61 7020 656c 7365 204e 6f6e 650a  f map else None.
+00007b20: 2020 2020 2020 2020 6966 206d 6170 2069          if map i
+00007b30: 7320 6e6f 7420 4e6f 6e65 2061 6e64 2077  s not None and w
+00007b40: 6f72 6b64 6972 2069 7320 6e6f 7420 4e6f  orkdir is not No
+00007b50: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00007b60: 7374 6172 7420 3d20 7469 6d65 6974 2e64  start = timeit.d
+00007b70: 6566 6175 6c74 5f74 696d 6572 2829 0a20  efault_timer(). 
+00007b80: 2020 2020 2020 2020 2020 2065 7272 6c69             errli
+00007b90: 7374 203d 205b 5d0a 2020 2020 2020 2020  st = [].        
+00007ba0: 2020 2020 7479 7065 203d 2027 7072 6f6a      type = 'proj
+00007bb0: 6563 7469 6f6e 270a 0a20 2020 2020 2020  ection'..       
+00007bc0: 2020 2020 2078 7072 6f6a 6563 7469 6f6e       xprojection
+00007bd0: 6e61 6d65 203d 2077 6f72 6b64 6972 202b  name = workdir +
+00007be0: 206d 6170 6e61 6d65 202b 2027 5f78 7072   mapname + '_xpr
+00007bf0: 6f6a 6563 7469 6f6e 2e6a 7065 6727 0a20  ojection.jpeg'. 
+00007c00: 2020 2020 2020 2020 2020 2078 7363 616c             xscal
+00007c10: 656e 616d 6520 3d20 776f 726b 6469 7220  ename = workdir 
+00007c20: 2b20 6d61 706e 616d 6520 2b20 275f 7363  + mapname + '_sc
+00007c30: 616c 6564 5f78 7072 6f6a 6563 7469 6f6e  aled_xprojection
+00007c40: 2e6a 7065 6727 0a20 2020 2020 2020 2020  .jpeg'.         
+00007c50: 2020 2067 6c6f 7778 7072 6f6a 6563 7469     glowxprojecti
+00007c60: 6f6e 6e61 6d65 203d 2077 6f72 6b64 6972  onname = workdir
+00007c70: 202b 206d 6170 6e61 6d65 202b 2027 5f67   + mapname + '_g
+00007c80: 6c6f 775f 7870 726f 6a65 6374 696f 6e2e  low_xprojection.
+00007c90: 6a70 6567 270a 2020 2020 2020 2020 2020  jpeg'.          
+00007ca0: 2020 676c 6f77 7873 6361 6c65 6e61 6d65    glowxscalename
+00007cb0: 203d 2077 6f72 6b64 6972 202b 206d 6170   = workdir + map
+00007cc0: 6e61 6d65 202b 2027 5f73 6361 6c65 645f  name + '_scaled_
+00007cd0: 676c 6f77 5f78 7072 6f6a 6563 7469 6f6e  glow_xprojection
+00007ce0: 2e6a 7065 6727 0a20 2020 2020 2020 2020  .jpeg'.         
+00007cf0: 2020 2073 656c 662e 6d61 705f 746f 5f69     self.map_to_i
+00007d00: 6d67 286d 6170 2c20 322c 2074 7970 652c  mg(map, 2, type,
+00007d10: 2065 7272 6c69 7374 2c20 7365 6c66 2e67   errlist, self.g
+00007d20: 6c6f 7769 6d61 6765 290a 0a20 2020 2020  lowimage)..     
+00007d30: 2020 2020 2020 2079 7072 6f6a 6563 7469         yprojecti
+00007d40: 6f6e 6e61 6d65 203d 2077 6f72 6b64 6972  onname = workdir
+00007d50: 202b 206d 6170 6e61 6d65 202b 2027 5f79   + mapname + '_y
+00007d60: 7072 6f6a 6563 7469 6f6e 2e6a 7065 6727  projection.jpeg'
+00007d70: 0a20 2020 2020 2020 2020 2020 2079 7363  .            ysc
+00007d80: 616c 656e 616d 6520 3d20 776f 726b 6469  alename = workdi
+00007d90: 7220 2b20 6d61 706e 616d 6520 2b20 275f  r + mapname + '_
+00007da0: 7363 616c 6564 5f79 7072 6f6a 6563 7469  scaled_yprojecti
+00007db0: 6f6e 2e6a 7065 6727 0a20 2020 2020 2020  on.jpeg'.       
+00007dc0: 2020 2020 2067 6c6f 7779 7072 6f6a 6563       glowyprojec
+00007dd0: 7469 6f6e 6e61 6d65 203d 2077 6f72 6b64  tionname = workd
+00007de0: 6972 202b 206d 6170 6e61 6d65 202b 2027  ir + mapname + '
+00007df0: 5f67 6c6f 775f 7970 726f 6a65 6374 696f  _glow_yprojectio
+00007e00: 6e2e 6a70 6567 270a 2020 2020 2020 2020  n.jpeg'.        
+00007e10: 2020 2020 676c 6f77 7973 6361 6c65 6e61      glowyscalena
+00007e20: 6d65 203d 2077 6f72 6b64 6972 202b 206d  me = workdir + m
+00007e30: 6170 6e61 6d65 202b 2027 5f73 6361 6c65  apname + '_scale
+00007e40: 645f 676c 6f77 5f79 7072 6f6a 6563 7469  d_glow_yprojecti
+00007e50: 6f6e 2e6a 7065 6727 0a20 2020 2020 2020  on.jpeg'.       
+00007e60: 2020 2020 2073 656c 662e 6d61 705f 746f       self.map_to
+00007e70: 5f69 6d67 286d 6170 2c20 312c 2074 7970  _img(map, 1, typ
+00007e80: 652c 2065 7272 6c69 7374 2c20 7365 6c66  e, errlist, self
+00007e90: 2e67 6c6f 7769 6d61 6765 290a 0a20 2020  .glowimage)..   
+00007ea0: 2020 2020 2020 2020 207a 7072 6f6a 6563           zprojec
+00007eb0: 7469 6f6e 6e61 6d65 203d 2077 6f72 6b64  tionname = workd
+00007ec0: 6972 202b 206d 6170 6e61 6d65 202b 2027  ir + mapname + '
+00007ed0: 5f7a 7072 6f6a 6563 7469 6f6e 2e6a 7065  _zprojection.jpe
+00007ee0: 6727 0a20 2020 2020 2020 2020 2020 207a  g'.            z
+00007ef0: 7363 616c 656e 616d 6520 3d20 776f 726b  scalename = work
+00007f00: 6469 7220 2b20 6d61 706e 616d 6520 2b20  dir + mapname + 
+00007f10: 275f 7363 616c 6564 5f7a 7072 6f6a 6563  '_scaled_zprojec
+00007f20: 7469 6f6e 2e6a 7065 6727 0a20 2020 2020  tion.jpeg'.     
+00007f30: 2020 2020 2020 2067 6c6f 777a 7072 6f6a         glowzproj
+00007f40: 6563 7469 6f6e 6e61 6d65 203d 2077 6f72  ectionname = wor
+00007f50: 6b64 6972 202b 206d 6170 6e61 6d65 202b  kdir + mapname +
+00007f60: 2027 5f67 6c6f 775f 7a70 726f 6a65 6374   '_glow_zproject
+00007f70: 696f 6e2e 6a70 6567 270a 2020 2020 2020  ion.jpeg'.      
+00007f80: 2020 2020 2020 676c 6f77 7a73 6361 6c65        glowzscale
+00007f90: 6e61 6d65 203d 2077 6f72 6b64 6972 202b  name = workdir +
+00007fa0: 206d 6170 6e61 6d65 202b 2027 5f73 6361   mapname + '_sca
+00007fb0: 6c65 645f 676c 6f77 5f7a 7072 6f6a 6563  led_glow_zprojec
+00007fc0: 7469 6f6e 2e6a 7065 6727 0a20 2020 2020  tion.jpeg'.     
+00007fd0: 2020 2020 2020 2073 656c 662e 6d61 705f         self.map_
+00007fe0: 746f 5f69 6d67 286d 6170 2c20 302c 2074  to_img(map, 0, t
+00007ff0: 7970 652c 2065 7272 6c69 7374 2c20 7365  ype, errlist, se
+00008000: 6c66 2e67 6c6f 7769 6d61 6765 290a 0a20  lf.glowimage).. 
+00008010: 2020 2020 2020 2020 2020 2062 6f74 686a             bothj
+00008020: 736f 6e20 3d20 6469 6374 2829 0a20 2020  son = dict().   
+00008030: 2020 2020 2020 2020 2070 726f 6a65 6374           project
+00008040: 696f 6e6a 736f 6e20 3d20 6469 6374 2829  ionjson = dict()
+00008050: 0a20 2020 2020 2020 2020 2020 206f 7267  .            org
+00008060: 7072 6f6a 6563 7469 6f6e 6a73 6f6e 203d  projectionjson =
+00008070: 2064 6963 7428 290a 0a20 2020 2020 2020   dict()..       
+00008080: 2020 2020 2070 726f 6a65 6374 696f 6e6a       projectionj
+00008090: 736f 6e5b 2778 275d 203d 206f 732e 7061  son['x'] = os.pa
+000080a0: 7468 2e62 6173 656e 616d 6528 7873 6361  th.basename(xsca
+000080b0: 6c65 6e61 6d65 2920 6966 206f 732e 7061  lename) if os.pa
+000080c0: 7468 2e69 7366 696c 6528 7873 6361 6c65  th.isfile(xscale
+000080d0: 6e61 6d65 2920 656c 7365 204e 6f6e 650a  name) else None.
+000080e0: 2020 2020 2020 2020 2020 2020 7072 6f6a              proj
+000080f0: 6563 7469 6f6e 6a73 6f6e 5b27 7927 5d20  ectionjson['y'] 
+00008100: 3d20 6f73 2e70 6174 682e 6261 7365 6e61  = os.path.basena
+00008110: 6d65 2879 7363 616c 656e 616d 6529 2069  me(yscalename) i
+00008120: 6620 6f73 2e70 6174 682e 6973 6669 6c65  f os.path.isfile
+00008130: 2879 7363 616c 656e 616d 6529 2065 6c73  (yscalename) els
+00008140: 6520 4e6f 6e65 0a20 2020 2020 2020 2020  e None.         
+00008150: 2020 2070 726f 6a65 6374 696f 6e6a 736f     projectionjso
+00008160: 6e5b 277a 275d 203d 206f 732e 7061 7468  n['z'] = os.path
+00008170: 2e62 6173 656e 616d 6528 7a73 6361 6c65  .basename(zscale
+00008180: 6e61 6d65 2920 6966 206f 732e 7061 7468  name) if os.path
+00008190: 2e69 7366 696c 6528 7a73 6361 6c65 6e61  .isfile(zscalena
+000081a0: 6d65 2920 656c 7365 204e 6f6e 650a 0a20  me) else None.. 
+000081b0: 2020 2020 2020 2020 2020 206f 7267 7072             orgpr
+000081c0: 6f6a 6563 7469 6f6e 6a73 6f6e 5b27 7827  ojectionjson['x'
+000081d0: 5d20 3d20 6f73 2e70 6174 682e 6261 7365  ] = os.path.base
+000081e0: 6e61 6d65 2878 7072 6f6a 6563 7469 6f6e  name(xprojection
+000081f0: 6e61 6d65 2920 6966 206f 732e 7061 7468  name) if os.path
+00008200: 2e69 7366 696c 6528 7870 726f 6a65 6374  .isfile(xproject
+00008210: 696f 6e6e 616d 6529 2065 6c73 6520 4e6f  ionname) else No
+00008220: 6e65 0a20 2020 2020 2020 2020 2020 206f  ne.            o
+00008230: 7267 7072 6f6a 6563 7469 6f6e 6a73 6f6e  rgprojectionjson
+00008240: 5b27 7927 5d20 3d20 6f73 2e70 6174 682e  ['y'] = os.path.
+00008250: 6261 7365 6e61 6d65 2879 7072 6f6a 6563  basename(yprojec
+00008260: 7469 6f6e 6e61 6d65 2920 6966 206f 732e  tionname) if os.
+00008270: 7061 7468 2e69 7366 696c 6528 7970 726f  path.isfile(ypro
+00008280: 6a65 6374 696f 6e6e 616d 6529 2065 6c73  jectionname) els
+00008290: 6520 4e6f 6e65 0a20 2020 2020 2020 2020  e None.         
+000082a0: 2020 206f 7267 7072 6f6a 6563 7469 6f6e     orgprojection
+000082b0: 6a73 6f6e 5b27 7a27 5d20 3d20 6f73 2e70  json['z'] = os.p
+000082c0: 6174 682e 6261 7365 6e61 6d65 287a 7072  ath.basename(zpr
+000082d0: 6f6a 6563 7469 6f6e 6e61 6d65 2920 6966  ojectionname) if
+000082e0: 206f 732e 7061 7468 2e69 7366 696c 6528   os.path.isfile(
+000082f0: 7a70 726f 6a65 6374 696f 6e6e 616d 6529  zprojectionname)
+00008300: 2065 6c73 6520 4e6f 6e65 0a20 2020 2020   else None.     
+00008310: 2020 2020 2020 2062 6f74 686a 736f 6e5b         bothjson[
+00008320: 276f 7269 6769 6e61 6c27 5d20 3d20 6f72  'original'] = or
+00008330: 6770 726f 6a65 6374 696f 6e6a 736f 6e0a  gprojectionjson.
+00008340: 2020 2020 2020 2020 2020 2020 626f 7468              both
+00008350: 6a73 6f6e 5b27 7363 616c 6564 275d 203d  json['scaled'] =
+00008360: 2070 726f 6a65 6374 696f 6e6a 736f 6e0a   projectionjson.
+00008370: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00008380: 6572 726c 6973 743a 0a20 2020 2020 2020  errlist:.       
+00008390: 2020 2020 2020 2020 2062 6f74 686a 736f           bothjso
+000083a0: 6e5b 2765 7272 275d 203d 207b 276f 7274  n['err'] = {'ort
+000083b0: 686f 676f 6e61 6c5f 7072 6f6a 6563 7469  hogonal_projecti
+000083c0: 6f6e 5f65 7272 273a 2065 7272 6c69 7374  on_err': errlist
+000083d0: 7d0a 2020 2020 2020 2020 2020 2020 6669  }.            fi
+000083e0: 6e61 6c64 6963 7420 3d20 7b6c 6162 656c  naldict = {label
+000083f0: 202b 2027 6f72 7468 6f67 6f6e 616c 5f70   + 'orthogonal_p
+00008400: 726f 6a65 6374 696f 6e27 3a20 626f 7468  rojection': both
+00008410: 6a73 6f6e 7d0a 0a20 2020 2020 2020 2020  json}..         
+00008420: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00008430: 2020 2020 2020 2020 7769 7468 2063 6f64          with cod
+00008440: 6563 732e 6f70 656e 2877 6f72 6b64 6972  ecs.open(workdir
+00008450: 202b 206d 6170 6e61 6d65 202b 2027 5f70   + mapname + '_p
+00008460: 726f 6a65 6374 696f 6e2e 6a73 6f6e 272c  rojection.json',
+00008470: 2027 7727 2c0a 2020 2020 2020 2020 2020   'w',.          
+00008480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008490: 2020 2020 2020 2065 6e63 6f64 696e 673d         encoding=
+000084a0: 2775 7466 2d38 2729 2061 7320 663a 0a20  'utf-8') as f:. 
+000084b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000084c0: 2020 206a 736f 6e2e 6475 6d70 2866 696e     json.dump(fin
+000084d0: 616c 6469 6374 2c20 6629 0a20 2020 2020  aldict, f).     
+000084e0: 2020 2020 2020 2065 7863 6570 7420 494f         except IO
+000084f0: 4572 726f 7220 6173 2069 6f65 7272 3a0a  Error as ioerr:.
+00008500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008510: 6a73 6f6e 6572 7220 3d20 2753 6176 696e  jsonerr = 'Savin
+00008520: 6720 7072 6f6a 6563 7469 6f6e 2069 6e74  g projection int
+00008530: 6f20 6a73 6f6e 2065 7272 6f72 3a20 7b7d  o json error: {}
+00008540: 272e 666f 726d 6174 2869 6f65 7272 290a  '.format(ioerr).
+00008550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008560: 7379 732e 7374 6465 7272 2e77 7269 7465  sys.stderr.write
+00008570: 286a 736f 6e65 7272 202b 2027 5c6e 2729  (jsonerr + '\n')
+00008580: 0a0a 0a20 2020 2020 2020 2020 2020 2067  ...            g
+00008590: 6c6f 7762 6f74 686a 736f 6e20 3d20 6469  lowbothjson = di
+000085a0: 6374 2829 0a20 2020 2020 2020 2020 2020  ct().           
+000085b0: 2067 6c6f 7770 726f 6a65 6374 696f 6e6a   glowprojectionj
+000085c0: 736f 6e20 3d20 6469 6374 2829 0a20 2020  son = dict().   
+000085d0: 2020 2020 2020 2020 2067 6c6f 776f 7267           gloworg
+000085e0: 7072 6f6a 6563 7469 6f6e 6a73 6f6e 203d  projectionjson =
+000085f0: 2064 6963 7428 290a 0a20 2020 2020 2020   dict()..       
+00008600: 2020 2020 2067 6c6f 7770 726f 6a65 6374       glowproject
+00008610: 696f 6e6a 736f 6e5b 2778 275d 203d 206f  ionjson['x'] = o
+00008620: 732e 7061 7468 2e62 6173 656e 616d 6528  s.path.basename(
+00008630: 676c 6f77 7873 6361 6c65 6e61 6d65 2920  glowxscalename) 
+00008640: 6966 206f 732e 7061 7468 2e69 7366 696c  if os.path.isfil
+00008650: 6528 676c 6f77 7873 6361 6c65 6e61 6d65  e(glowxscalename
+00008660: 2920 656c 7365 204e 6f6e 650a 2020 2020  ) else None.    
+00008670: 2020 2020 2020 2020 676c 6f77 7072 6f6a          glowproj
+00008680: 6563 7469 6f6e 6a73 6f6e 5b27 7927 5d20  ectionjson['y'] 
+00008690: 3d20 6f73 2e70 6174 682e 6261 7365 6e61  = os.path.basena
+000086a0: 6d65 2867 6c6f 7779 7363 616c 656e 616d  me(glowyscalenam
+000086b0: 6529 2069 6620 6f73 2e70 6174 682e 6973  e) if os.path.is
+000086c0: 6669 6c65 2867 6c6f 7779 7363 616c 656e  file(glowyscalen
+000086d0: 616d 6529 2065 6c73 6520 4e6f 6e65 0a20  ame) else None. 
+000086e0: 2020 2020 2020 2020 2020 2067 6c6f 7770             glowp
+000086f0: 726f 6a65 6374 696f 6e6a 736f 6e5b 277a  rojectionjson['z
+00008700: 275d 203d 206f 732e 7061 7468 2e62 6173  '] = os.path.bas
+00008710: 656e 616d 6528 676c 6f77 7a73 6361 6c65  ename(glowzscale
+00008720: 6e61 6d65 2920 6966 206f 732e 7061 7468  name) if os.path
+00008730: 2e69 7366 696c 6528 676c 6f77 7a73 6361  .isfile(glowzsca
+00008740: 6c65 6e61 6d65 2920 656c 7365 204e 6f6e  lename) else Non
+00008750: 650a 0a20 2020 2020 2020 2020 2020 2067  e..            g
+00008760: 6c6f 776f 7267 7072 6f6a 6563 7469 6f6e  loworgprojection
+00008770: 6a73 6f6e 5b27 7827 5d20 3d20 6f73 2e70  json['x'] = os.p
+00008780: 6174 682e 6261 7365 6e61 6d65 2867 6c6f  ath.basename(glo
+00008790: 7778 7072 6f6a 6563 7469 6f6e 6e61 6d65  wxprojectionname
+000087a0: 2920 6966 206f 732e 7061 7468 2e69 7366  ) if os.path.isf
+000087b0: 696c 6528 676c 6f77 7870 726f 6a65 6374  ile(glowxproject
+000087c0: 696f 6e6e 616d 6529 2065 6c73 6520 4e6f  ionname) else No
+000087d0: 6e65 0a20 2020 2020 2020 2020 2020 2067  ne.            g
+000087e0: 6c6f 776f 7267 7072 6f6a 6563 7469 6f6e  loworgprojection
+000087f0: 6a73 6f6e 5b27 7927 5d20 3d20 6f73 2e70  json['y'] = os.p
+00008800: 6174 682e 6261 7365 6e61 6d65 2867 6c6f  ath.basename(glo
+00008810: 7779 7072 6f6a 6563 7469 6f6e 6e61 6d65  wyprojectionname
+00008820: 2920 6966 206f 732e 7061 7468 2e69 7366  ) if os.path.isf
+00008830: 696c 6528 676c 6f77 7970 726f 6a65 6374  ile(glowyproject
+00008840: 696f 6e6e 616d 6529 2065 6c73 6520 4e6f  ionname) else No
+00008850: 6e65 0a20 2020 2020 2020 2020 2020 2067  ne.            g
+00008860: 6c6f 776f 7267 7072 6f6a 6563 7469 6f6e  loworgprojection
+00008870: 6a73 6f6e 5b27 7a27 5d20 3d20 6f73 2e70  json['z'] = os.p
+00008880: 6174 682e 6261 7365 6e61 6d65 2867 6c6f  ath.basename(glo
+00008890: 777a 7072 6f6a 6563 7469 6f6e 6e61 6d65  wzprojectionname
+000088a0: 2920 6966 206f 732e 7061 7468 2e69 7366  ) if os.path.isf
+000088b0: 696c 6528 676c 6f77 7a70 726f 6a65 6374  ile(glowzproject
+000088c0: 696f 6e6e 616d 6529 2065 6c73 6520 4e6f  ionname) else No
+000088d0: 6e65 0a20 2020 2020 2020 2020 2020 2067  ne.            g
+000088e0: 6c6f 7762 6f74 686a 736f 6e5b 276f 7269  lowbothjson['ori
+000088f0: 6769 6e61 6c27 5d20 3d20 676c 6f77 6f72  ginal'] = glowor
+00008900: 6770 726f 6a65 6374 696f 6e6a 736f 6e0a  gprojectionjson.
+00008910: 2020 2020 2020 2020 2020 2020 676c 6f77              glow
+00008920: 626f 7468 6a73 6f6e 5b27 7363 616c 6564  bothjson['scaled
+00008930: 275d 203d 2067 6c6f 7770 726f 6a65 6374  '] = glowproject
+00008940: 696f 6e6a 736f 6e0a 0a20 2020 2020 2020  ionjson..       
+00008950: 2020 2020 2069 6620 6572 726c 6973 743a       if errlist:
+00008960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008970: 2067 6c6f 7762 6f74 686a 736f 6e5b 2765   glowbothjson['e
+00008980: 7272 275d 203d 207b 276f 7274 686f 676f  rr'] = {'orthogo
+00008990: 6e61 6c5f 676c 6f77 5f70 726f 6a65 6374  nal_glow_project
+000089a0: 696f 6e5f 6572 7227 3a20 6572 726c 6973  ion_err': errlis
+000089b0: 747d 0a20 2020 2020 2020 2020 2020 2067  t}.            g
+000089c0: 6c6f 7766 696e 616c 6469 6374 203d 207b  lowfinaldict = {
+000089d0: 6c61 6265 6c20 2b20 276f 7274 686f 676f  label + 'orthogo
+000089e0: 6e61 6c5f 676c 6f77 5f70 726f 6a65 6374  nal_glow_project
+000089f0: 696f 6e27 3a20 676c 6f77 626f 7468 6a73  ion': glowbothjs
+00008a00: 6f6e 7d0a 0a20 2020 2020 2020 2020 2020  on}..           
+00008a10: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+00008a20: 2020 2020 2020 7769 7468 2063 6f64 6563        with codec
+00008a30: 732e 6f70 656e 2877 6f72 6b64 6972 202b  s.open(workdir +
+00008a40: 206d 6170 6e61 6d65 202b 2027 5f67 6c6f   mapname + '_glo
+00008a50: 775f 7072 6f6a 6563 7469 6f6e 2e6a 736f  w_projection.jso
+00008a60: 6e27 2c20 2777 272c 0a20 2020 2020 2020  n', 'w',.       
+00008a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008a80: 2020 2020 2020 2020 2020 656e 636f 6469            encodi
+00008a90: 6e67 3d27 7574 662d 3827 2920 6173 2066  ng='utf-8') as f
+00008aa0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00008ab0: 2020 2020 2020 6a73 6f6e 2e64 756d 7028        json.dump(
+00008ac0: 676c 6f77 6669 6e61 6c64 6963 742c 2066  glowfinaldict, f
+00008ad0: 290a 2020 2020 2020 2020 2020 2020 6578  ).            ex
+00008ae0: 6365 7074 2049 4f45 7272 6f72 2061 7320  cept IOError as 
+00008af0: 696f 6572 723a 0a20 2020 2020 2020 2020  ioerr:.         
+00008b00: 2020 2020 2020 206a 736f 6e65 7272 203d         jsonerr =
+00008b10: 2027 5361 7669 6e67 2067 6c6f 7720 7072   'Saving glow pr
+00008b20: 6f6a 6563 7469 6f6e 2069 6e74 6f20 6a73  ojection into js
+00008b30: 6f6e 2065 7272 6f72 3a20 7b7d 272e 666f  on error: {}'.fo
+00008b40: 726d 6174 2869 6f65 7272 290a 2020 2020  rmat(ioerr).    
+00008b50: 2020 2020 2020 2020 2020 2020 7379 732e              sys.
+00008b60: 7374 6465 7272 2e77 7269 7465 286a 736f  stderr.write(jso
+00008b70: 6e65 7272 202b 2027 5c6e 2729 0a0a 2020  nerr + '\n')..  
+00008b80: 2020 2020 2020 2020 2020 656e 6420 3d20            end = 
+00008b90: 7469 6d65 6974 2e64 6566 6175 6c74 5f74  timeit.default_t
+00008ba0: 696d 6572 2829 0a20 2020 2020 2020 2020  imer().         
+00008bb0: 2020 2070 7269 6e74 2827 5072 6f6a 6563     print('Projec
+00008bc0: 7469 6f6e 7320 616e 6420 6974 7320 676c  tions and its gl
+00008bd0: 6f77 2070 726f 6a65 6374 696f 6e73 2074  ow projections t
+00008be0: 696d 6520 666f 7220 2573 3a20 2573 2720  ime for %s: %s' 
+00008bf0: 2520 286d 6170 6e61 6d65 2c20 656e 6420  % (mapname, end 
+00008c00: 2d20 7374 6172 7429 290a 2020 2020 2020  - start)).      
+00008c10: 2020 2020 2020 7072 696e 7428 272d 2d2d        print('---
+00008c20: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008c30: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00008c40: 2d27 290a 0a20 2020 2020 2020 2065 6c73  -')..        els
+00008c50: 653a 0a20 2020 2020 2020 2020 2020 2070  e:.            p
+00008c60: 7269 6e74 2827 4e6f 206f 7274 686f 676f  rint('No orthogo
+00008c70: 6e61 6c20 7072 6f6a 6563 7469 6f6e 7320  nal projections 
+00008c80: 7769 7468 6f75 7420 7072 6f70 6572 206d  without proper m
+00008c90: 6170 2069 6e70 7574 2061 6e64 2074 6865  ap input and the
+00008ca0: 206f 7574 7075 7420 6469 7265 6374 6f72   output director
+00008cb0: 7920 696e 666f 726d 6174 696f 6e2e 2729  y information.')
+00008cc0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00008cd0: 204e 6f6e 650a 0a20 2020 2023 2040 7072   None..    # @pr
+00008ce0: 6f66 696c 650a 2020 2020 6465 6620 7261  ofile.    def ra
+00008cf0: 776d 6170 5f70 726f 6a65 6374 696f 6e73  wmap_projections
+00008d00: 2873 656c 6629 3a0a 0a20 2020 2020 2020  (self):..       
+00008d10: 2072 6177 6d61 7020 3d20 7365 6c66 2e72   rawmap = self.r
+00008d20: 6177 6d61 700a 2020 2020 2020 2020 6966  awmap.        if
+00008d30: 2072 6177 6d61 7020 6973 206e 6f74 204e   rawmap is not N
+00008d40: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00008d50: 2064 6972 203d 2073 656c 662e 776f 726b   dir = self.work
+00008d60: 6469 720a 2020 2020 2020 2020 2020 2020  dir.            
+00008d70: 6c61 6265 6c20 3d20 2772 6177 6d61 705f  label = 'rawmap_
+00008d80: 270a 2020 2020 2020 2020 2020 2020 7365  '.            se
+00008d90: 6c66 2e6f 7274 686f 676f 6e61 6c5f 7072  lf.orthogonal_pr
+00008da0: 6f6a 6563 7469 6f6e 7328 7261 776d 6170  ojections(rawmap
+00008db0: 2c20 6469 722c 206c 6162 656c 290a 2020  , dir, label).  
+00008dc0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00008dd0: 2020 2020 2020 2020 7072 696e 7428 274e          print('N
+00008de0: 6f20 7261 7720 6d61 7020 746f 2063 616c  o raw map to cal
+00008df0: 6375 6c61 7465 206f 7274 686f 676f 6e61  culate orthogona
+00008e00: 6c20 7072 6f6a 6563 7469 6f6e 732e 2729  l projections.')
+00008e10: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00008e20: 204e 6f6e 650a 0a20 2020 2023 2040 7072   None..    # @pr
+00008e30: 6f66 696c 650a 2020 2020 6465 6620 6f72  ofile.    def or
+00008e40: 7468 6f67 6f6e 616c 5f6d 6564 6961 6e28  thogonal_median(
+00008e50: 7365 6c66 2c20 6d61 7069 6e3d 4e6f 6e65  self, mapin=None
+00008e60: 2c20 776f 726b 6469 723d 4e6f 6e65 2c20  , workdir=None, 
+00008e70: 6c61 6265 6c3d 2727 293a 0a20 2020 2020  label=''):.     
+00008e80: 2020 2022 2222 0a20 2020 2020 2020 2020     """.         
+00008e90: 2020 204d 6564 6961 6e20 7072 6f6a 6563     Median projec
+00008ea0: 7469 6f6e 0a20 2020 2020 2020 203a 7061  tion.        :pa
+00008eb0: 7261 6d20 6d61 7069 6e3a 2049 6e70 7574  ram mapin: Input
+00008ec0: 206d 6170 2065 6974 6865 7220 6d72 6366   map either mrcf
+00008ed0: 696c 6520 6f72 2066 696c 656e 616d 6520  ile or filename 
+00008ee0: 7374 7269 6e67 0a20 2020 2020 2020 203a  string.        :
+00008ef0: 7061 7261 6d20 776f 726b 6469 723a 2053  param workdir: S
+00008f00: 7472 696e 6720 6f66 2074 6865 2066 756c  tring of the ful
+00008f10: 6c20 776f 726b 2070 6174 680a 2020 2020  l work path.    
+00008f20: 2020 2020 3a70 6172 616d 206c 6162 656c      :param label
+00008f30: 3a20 666f 7220 7261 7720 6d61 7020 7573  : for raw map us
+00008f40: 6520 2772 6177 5f27 0a20 2020 2020 2020  e 'raw_'.       
+00008f50: 203a 7265 7475 726e 3a20 4e6f 6e65 0a20   :return: None. 
+00008f60: 2020 2020 2020 2022 2222 0a0a 2020 2020         """..    
+00008f70: 2020 2020 6966 2073 656c 662e 706c 6174      if self.plat
+00008f80: 666f 726d 203d 3d20 2765 6d64 6227 3a0a  form == 'emdb':.
+00008f90: 2020 2020 2020 2020 2020 2020 6d61 702c              map,
+00008fa0: 2077 6f72 6b64 6972 203d 2073 656c 662e   workdir = self.
+00008fb0: 6d61 7069 6e63 6865 636b 286d 6170 696e  mapincheck(mapin
+00008fc0: 2c20 776f 726b 6469 7229 0a20 2020 2020  , workdir).     
+00008fd0: 2020 2020 2020 206d 6170 6e61 6d65 203d         mapname =
+00008fe0: 206f 732e 7061 7468 2e62 6173 656e 616d   os.path.basenam
+00008ff0: 6528 6d61 702e 6675 6c6c 6e61 6d65 2920  e(map.fullname) 
+00009000: 6966 206d 6170 2065 6c73 6520 4e6f 6e65  if map else None
+00009010: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00009020: 6d61 7020 6973 206e 6f74 204e 6f6e 6520  map is not None 
+00009030: 616e 6420 776f 726b 6469 7220 6973 206e  and workdir is n
+00009040: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00009050: 2020 2020 2020 2020 2073 7461 7274 203d           start =
+00009060: 2074 696d 6569 742e 6465 6661 756c 745f   timeit.default_
+00009070: 7469 6d65 7228 290a 2020 2020 2020 2020  timer().        
+00009080: 2020 2020 2020 2020 6572 726c 6973 7420          errlist 
+00009090: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
+000090a0: 2020 2020 2074 7970 6520 3d20 276d 6564       type = 'med
+000090b0: 6961 6e27 0a0a 2020 2020 2020 2020 2020  ian'..          
+000090c0: 2020 2020 2020 7870 726f 6a65 6374 696f        xprojectio
+000090d0: 6e6e 616d 6520 3d20 776f 726b 6469 7220  nname = workdir 
+000090e0: 2b20 6d61 706e 616d 6520 2b20 275f 786d  + mapname + '_xm
+000090f0: 6564 6961 6e2e 6a70 6567 270a 2020 2020  edian.jpeg'.    
+00009100: 2020 2020 2020 2020 2020 2020 7873 6361              xsca
+00009110: 6c65 6e61 6d65 203d 2077 6f72 6b64 6972  lename = workdir
+00009120: 202b 206d 6170 6e61 6d65 202b 2027 5f73   + mapname + '_s
+00009130: 6361 6c65 645f 786d 6564 6961 6e2e 6a70  caled_xmedian.jp
+00009140: 6567 270a 2020 2020 2020 2020 2020 2020  eg'.            
+00009150: 2020 2020 7365 6c66 2e6d 6170 5f74 6f5f      self.map_to_
+00009160: 696d 6728 6d61 702c 2032 2c20 7479 7065  img(map, 2, type
+00009170: 2c20 6572 726c 6973 7429 0a0a 2020 2020  , errlist)..    
+00009180: 2020 2020 2020 2020 2020 2020 7970 726f              ypro
+00009190: 6a65 6374 696f 6e6e 616d 6520 3d20 776f  jectionname = wo
+000091a0: 726b 6469 7220 2b20 6d61 706e 616d 6520  rkdir + mapname 
+000091b0: 2b20 275f 796d 6564 6961 6e2e 6a70 6567  + '_ymedian.jpeg
+000091c0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+000091d0: 2020 7973 6361 6c65 6e61 6d65 203d 2077    yscalename = w
+000091e0: 6f72 6b64 6972 202b 206d 6170 6e61 6d65  orkdir + mapname
+000091f0: 202b 2027 5f73 6361 6c65 645f 796d 6564   + '_scaled_ymed
+00009200: 6961 6e2e 6a70 6567 270a 2020 2020 2020  ian.jpeg'.      
+00009210: 2020 2020 2020 2020 2020 7365 6c66 2e6d            self.m
+00009220: 6170 5f74 6f5f 696d 6728 6d61 702c 2031  ap_to_img(map, 1
+00009230: 2c20 7479 7065 2c20 6572 726c 6973 7429  , type, errlist)
+00009240: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00009250: 2020 7a70 726f 6a65 6374 696f 6e6e 616d    zprojectionnam
+00009260: 6520 3d20 776f 726b 6469 7220 2b20 6d61  e = workdir + ma
+00009270: 706e 616d 6520 2b20 275f 7a6d 6564 6961  pname + '_zmedia
+00009280: 6e2e 6a70 6567 270a 2020 2020 2020 2020  n.jpeg'.        
+00009290: 2020 2020 2020 2020 7a73 6361 6c65 6e61          zscalena
+000092a0: 6d65 203d 2077 6f72 6b64 6972 202b 206d  me = workdir + m
+000092b0: 6170 6e61 6d65 202b 2027 5f73 6361 6c65  apname + '_scale
+000092c0: 645f 7a6d 6564 6961 6e2e 6a70 6567 270a  d_zmedian.jpeg'.
 000092d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000092e0: 2020 206a 736f 6e2e 6475 6d70 2866 696e     json.dump(fin
-000092f0: 616c 6469 6374 2c20 6629 0a20 2020 2020  aldict, f).     
-00009300: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-00009310: 7420 494f 4572 726f 7220 6173 2069 6f65  t IOError as ioe
-00009320: 7272 3a0a 2020 2020 2020 2020 2020 2020  rr:.            
-00009330: 2020 2020 2020 2020 6a73 6f6e 6572 7220          jsonerr 
-00009340: 3d20 2753 6176 696e 6720 6d69 6e69 6d61  = 'Saving minima
-00009350: 6c20 7072 6f6a 6563 7469 6f6e 2069 6e74  l projection int
-00009360: 6f20 6a73 6f6e 2065 7272 6f72 3a20 7b7d  o json error: {}
-00009370: 272e 666f 726d 6174 2869 6f65 7272 290a  '.format(ioerr).
-00009380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009390: 2020 2020 7379 732e 7374 6465 7272 2e77      sys.stderr.w
-000093a0: 7269 7465 286a 736f 6e65 7272 202b 2027  rite(jsonerr + '
-000093b0: 5c6e 2729 0a0a 2020 2020 2020 2020 2020  \n')..          
-000093c0: 2020 2020 2020 656e 6420 3d20 7469 6d65        end = time
-000093d0: 6974 2e64 6566 6175 6c74 5f74 696d 6572  it.default_timer
-000093e0: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
-000093f0: 2020 2070 7269 6e74 2827 4d69 6e69 6d61     print('Minima
-00009400: 6c20 7072 6f6a 6563 7469 6f6e 7320 7469  l projections ti
-00009410: 6d65 2066 6f72 2025 733a 2025 7327 2025  me for %s: %s' %
-00009420: 2028 6d61 706e 616d 652c 2065 6e64 202d   (mapname, end -
-00009430: 2073 7461 7274 2929 0a20 2020 2020 2020   start)).       
-00009440: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
-00009450: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00009460: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00009470: 2d2d 2d2d 2729 0a0a 2020 2020 2020 2020  ----')..        
-00009480: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00009490: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-000094a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000094b0: 2020 2020 2027 4e6f 206f 7274 686f 676f       'No orthogo
-000094c0: 6e61 6c20 6d69 6e69 6d61 6c20 7072 6f6a  nal minimal proj
-000094d0: 6563 7469 6f6e 7320 7769 7468 6f75 7420  ections without 
-000094e0: 7072 6f70 6572 206d 6170 2069 6e70 7574  proper map input
-000094f0: 2061 6e64 2074 6865 206f 7574 7075 7420   and the output 
-00009500: 6469 7265 6374 6f72 7920 696e 666f 726d  directory inform
-00009510: 6174 696f 6e2e 2729 0a0a 2020 2020 2020  ation.')..      
-00009520: 2020 7265 7475 726e 204e 6f6e 650a 0a20    return None.. 
-00009530: 2020 2023 2040 7072 6f66 696c 650a 2020     # @profile.  
-00009540: 2020 6465 6620 7261 776d 6170 5f6d 696e    def rawmap_min
-00009550: 2873 656c 6629 3a0a 0a20 2020 2020 2020  (self):..       
-00009560: 2072 6177 6d61 7020 3d20 7365 6c66 2e72   rawmap = self.r
-00009570: 6177 6d61 700a 2020 2020 2020 2020 6966  awmap.        if
-00009580: 2072 6177 6d61 7020 6973 206e 6f74 204e   rawmap is not N
-00009590: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-000095a0: 2064 6972 203d 2073 656c 662e 776f 726b   dir = self.work
-000095b0: 6469 720a 2020 2020 2020 2020 2020 2020  dir.            
-000095c0: 6c61 6265 6c20 3d20 2772 6177 6d61 705f  label = 'rawmap_
-000095d0: 270a 2020 2020 2020 2020 2020 2020 7365  '.            se
-000095e0: 6c66 2e6f 7274 686f 676f 6e61 6c5f 6d69  lf.orthogonal_mi
-000095f0: 6e28 7261 776d 6170 2c20 6469 722c 206c  n(rawmap, dir, l
-00009600: 6162 656c 290a 2020 2020 2020 2020 656c  abel).        el
-00009610: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00009620: 7072 696e 7428 274e 6f20 7261 7720 6d61  print('No raw ma
-00009630: 7020 746f 2063 616c 6375 6c61 7465 206f  p to calculate o
-00009640: 7274 686f 676f 6e61 6c20 6d69 6e20 7072  rthogonal min pr
-00009650: 6f6a 6563 7469 6f6e 732e 2729 0a0a 2020  ojections.')..  
-00009660: 2020 2320 4070 726f 6669 6c65 0a20 2020    # @profile.   
-00009670: 2064 6566 206f 7274 686f 676f 6e61 6c5f   def orthogonal_
-00009680: 6d61 7828 7365 6c66 2c20 6d61 7069 6e3d  max(self, mapin=
-00009690: 4e6f 6e65 2c20 776f 726b 6469 723d 4e6f  None, workdir=No
-000096a0: 6e65 2c20 6c61 6265 6c3d 2727 293a 0a20  ne, label=''):. 
-000096b0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-000096c0: 2020 2020 2020 2020 4d61 7869 6d61 6c20          Maximal 
-000096d0: 7072 6f6a 6563 7469 6f6e 2061 6e64 2069  projection and i
-000096e0: 7420 676c 6f77 2069 6d61 6765 0a20 2020  t glow image.   
-000096f0: 2020 2020 203a 7061 7261 6d20 6d61 7069       :param mapi
-00009700: 6e3a 2049 6e70 7574 206d 6170 2065 6974  n: Input map eit
-00009710: 6865 7220 6d72 6366 696c 6520 6f72 2066  her mrcfile or f
-00009720: 696c 656e 616d 6520 7374 7269 6e67 0a20  ilename string. 
-00009730: 2020 2020 2020 203a 7061 7261 6d20 776f         :param wo
-00009740: 726b 6469 723a 2053 7472 696e 6720 6f66  rkdir: String of
-00009750: 2074 6865 2066 756c 6c20 776f 726b 2070   the full work p
-00009760: 6174 680a 2020 2020 2020 2020 3a70 6172  ath.        :par
-00009770: 616d 206c 6162 656c 3a20 666f 7220 7261  am label: for ra
-00009780: 7720 6d61 7020 7573 6520 2772 6177 5f27  w map use 'raw_'
-00009790: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-000097a0: 3a20 4e6f 6e65 0a20 2020 2020 2020 2022  : None.        "
-000097b0: 2222 0a0a 2020 2020 2020 2020 6d61 702c  ""..        map,
-000097c0: 2077 6f72 6b64 6972 203d 2073 656c 662e   workdir = self.
-000097d0: 6d61 7069 6e63 6865 636b 286d 6170 696e  mapincheck(mapin
-000097e0: 2c20 776f 726b 6469 7229 0a20 2020 2020  , workdir).     
-000097f0: 2020 206d 6170 6e61 6d65 203d 206f 732e     mapname = os.
-00009800: 7061 7468 2e62 6173 656e 616d 6528 6d61  path.basename(ma
-00009810: 702e 6675 6c6c 6e61 6d65 2920 6966 206d  p.fullname) if m
-00009820: 6170 2065 6c73 6520 4e6f 6e65 0a20 2020  ap else None.   
-00009830: 2020 2020 2069 6620 6d61 7020 6973 206e       if map is n
-00009840: 6f74 204e 6f6e 6520 616e 6420 776f 726b  ot None and work
-00009850: 6469 7220 6973 206e 6f74 204e 6f6e 653a  dir is not None:
-00009860: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
-00009870: 7274 203d 2074 696d 6569 742e 6465 6661  rt = timeit.defa
-00009880: 756c 745f 7469 6d65 7228 290a 2020 2020  ult_timer().    
-00009890: 2020 2020 2020 2020 6572 726c 6973 7420          errlist 
-000098a0: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
-000098b0: 2074 7970 6520 3d20 276d 6178 270a 0a20   type = 'max'.. 
-000098c0: 2020 2020 2020 2020 2020 2078 7072 6f6a             xproj
-000098d0: 6563 7469 6f6e 6e61 6d65 203d 2077 6f72  ectionname = wor
-000098e0: 6b64 6972 202b 206d 6170 6e61 6d65 202b  kdir + mapname +
-000098f0: 2027 5f78 6d61 782e 6a70 6567 270a 2020   '_xmax.jpeg'.  
-00009900: 2020 2020 2020 2020 2020 7873 6361 6c65            xscale
-00009910: 6e61 6d65 203d 2077 6f72 6b64 6972 202b  name = workdir +
-00009920: 206d 6170 6e61 6d65 202b 2027 5f73 6361   mapname + '_sca
-00009930: 6c65 645f 786d 6178 2e6a 7065 6727 0a20  led_xmax.jpeg'. 
-00009940: 2020 2020 2020 2020 2020 2067 6c6f 7778             glowx
-00009950: 7072 6f6a 6563 7469 6f6e 6e61 6d65 203d  projectionname =
-00009960: 2077 6f72 6b64 6972 202b 206d 6170 6e61   workdir + mapna
-00009970: 6d65 202b 2027 5f67 6c6f 775f 786d 6178  me + '_glow_xmax
-00009980: 2e6a 7065 6727 0a20 2020 2020 2020 2020  .jpeg'.         
-00009990: 2020 2067 6c6f 7778 7363 616c 656e 616d     glowxscalenam
-000099a0: 6520 3d20 776f 726b 6469 7220 2b20 6d61  e = workdir + ma
-000099b0: 706e 616d 6520 2b20 275f 7363 616c 6564  pname + '_scaled
-000099c0: 5f67 6c6f 775f 786d 6178 2e6a 7065 6727  _glow_xmax.jpeg'
-000099d0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000099e0: 662e 6d61 705f 746f 5f69 6d67 286d 6170  f.map_to_img(map
-000099f0: 2c20 322c 2074 7970 652c 2065 7272 6c69  , 2, type, errli
-00009a00: 7374 2c20 7365 6c66 2e67 6c6f 7769 6d61  st, self.glowima
-00009a10: 6765 290a 0a20 2020 2020 2020 2020 2020  ge)..           
-00009a20: 2079 7072 6f6a 6563 7469 6f6e 6e61 6d65   yprojectionname
-00009a30: 203d 2077 6f72 6b64 6972 202b 206d 6170   = workdir + map
-00009a40: 6e61 6d65 202b 2027 5f79 6d61 782e 6a70  name + '_ymax.jp
-00009a50: 6567 270a 2020 2020 2020 2020 2020 2020  eg'.            
-00009a60: 7973 6361 6c65 6e61 6d65 203d 2077 6f72  yscalename = wor
-00009a70: 6b64 6972 202b 206d 6170 6e61 6d65 202b  kdir + mapname +
-00009a80: 2027 5f73 6361 6c65 645f 796d 6178 2e6a   '_scaled_ymax.j
-00009a90: 7065 6727 0a20 2020 2020 2020 2020 2020  peg'.           
-00009aa0: 2067 6c6f 7779 7072 6f6a 6563 7469 6f6e   glowyprojection
-00009ab0: 6e61 6d65 203d 2077 6f72 6b64 6972 202b  name = workdir +
-00009ac0: 206d 6170 6e61 6d65 202b 2027 5f67 6c6f   mapname + '_glo
-00009ad0: 775f 796d 6178 2e6a 7065 6727 0a20 2020  w_ymax.jpeg'.   
-00009ae0: 2020 2020 2020 2020 2067 6c6f 7779 7363           glowysc
-00009af0: 616c 656e 616d 6520 3d20 776f 726b 6469  alename = workdi
-00009b00: 7220 2b20 6d61 706e 616d 6520 2b20 275f  r + mapname + '_
-00009b10: 7363 616c 6564 5f67 6c6f 775f 796d 6178  scaled_glow_ymax
-00009b20: 2e6a 7065 6727 0a20 2020 2020 2020 2020  .jpeg'.         
-00009b30: 2020 2073 656c 662e 6d61 705f 746f 5f69     self.map_to_i
-00009b40: 6d67 286d 6170 2c20 312c 2074 7970 652c  mg(map, 1, type,
-00009b50: 2065 7272 6c69 7374 2c20 7365 6c66 2e67   errlist, self.g
-00009b60: 6c6f 7769 6d61 6765 290a 0a20 2020 2020  lowimage)..     
-00009b70: 2020 2020 2020 207a 7072 6f6a 6563 7469         zprojecti
-00009b80: 6f6e 6e61 6d65 203d 2077 6f72 6b64 6972  onname = workdir
-00009b90: 202b 206d 6170 6e61 6d65 202b 2027 5f7a   + mapname + '_z
-00009ba0: 6d61 782e 6a70 6567 270a 2020 2020 2020  max.jpeg'.      
-00009bb0: 2020 2020 2020 7a73 6361 6c65 6e61 6d65        zscalename
-00009bc0: 203d 2077 6f72 6b64 6972 202b 206d 6170   = workdir + map
-00009bd0: 6e61 6d65 202b 2027 5f73 6361 6c65 645f  name + '_scaled_
-00009be0: 7a6d 6178 2e6a 7065 6727 0a20 2020 2020  zmax.jpeg'.     
-00009bf0: 2020 2020 2020 2067 6c6f 777a 7072 6f6a         glowzproj
-00009c00: 6563 7469 6f6e 6e61 6d65 203d 2077 6f72  ectionname = wor
-00009c10: 6b64 6972 202b 206d 6170 6e61 6d65 202b  kdir + mapname +
-00009c20: 2027 5f67 6c6f 775f 7a6d 6178 2e6a 7065   '_glow_zmax.jpe
-00009c30: 6727 0a20 2020 2020 2020 2020 2020 2067  g'.            g
-00009c40: 6c6f 777a 7363 616c 656e 616d 6520 3d20  lowzscalename = 
-00009c50: 776f 726b 6469 7220 2b20 6d61 706e 616d  workdir + mapnam
-00009c60: 6520 2b20 275f 7363 616c 6564 5f67 6c6f  e + '_scaled_glo
-00009c70: 775f 7a6d 6178 2e6a 7065 6727 0a20 2020  w_zmax.jpeg'.   
-00009c80: 2020 2020 2020 2020 2073 656c 662e 6d61           self.ma
-00009c90: 705f 746f 5f69 6d67 286d 6170 2c20 302c  p_to_img(map, 0,
-00009ca0: 2074 7970 652c 2065 7272 6c69 7374 2c20   type, errlist, 
-00009cb0: 7365 6c66 2e67 6c6f 7769 6d61 6765 290a  self.glowimage).
-00009cc0: 0a20 2020 2020 2020 2020 2020 2062 6f74  .            bot
-00009cd0: 686a 736f 6e20 3d20 6469 6374 2829 0a20  hjson = dict(). 
-00009ce0: 2020 2020 2020 2020 2020 2070 726f 6a65             proje
-00009cf0: 6374 696f 6e6a 736f 6e20 3d20 6469 6374  ctionjson = dict
-00009d00: 2829 0a20 2020 2020 2020 2020 2020 206f  ().            o
-00009d10: 7267 7072 6f6a 6563 7469 6f6e 6a73 6f6e  rgprojectionjson
-00009d20: 203d 2064 6963 7428 290a 0a20 2020 2020   = dict()..     
-00009d30: 2020 2020 2020 2070 726f 6a65 6374 696f         projectio
-00009d40: 6e6a 736f 6e5b 2778 275d 203d 206f 732e  njson['x'] = os.
-00009d50: 7061 7468 2e62 6173 656e 616d 6528 7873  path.basename(xs
-00009d60: 6361 6c65 6e61 6d65 2920 6966 206f 732e  calename) if os.
-00009d70: 7061 7468 2e69 7366 696c 6528 7873 6361  path.isfile(xsca
-00009d80: 6c65 6e61 6d65 2920 656c 7365 204e 6f6e  lename) else Non
-00009d90: 650a 2020 2020 2020 2020 2020 2020 7072  e.            pr
-00009da0: 6f6a 6563 7469 6f6e 6a73 6f6e 5b27 7927  ojectionjson['y'
-00009db0: 5d20 3d20 6f73 2e70 6174 682e 6261 7365  ] = os.path.base
-00009dc0: 6e61 6d65 2879 7363 616c 656e 616d 6529  name(yscalename)
-00009dd0: 2069 6620 6f73 2e70 6174 682e 6973 6669   if os.path.isfi
-00009de0: 6c65 2879 7363 616c 656e 616d 6529 2065  le(yscalename) e
-00009df0: 6c73 6520 4e6f 6e65 0a20 2020 2020 2020  lse None.       
-00009e00: 2020 2020 2070 726f 6a65 6374 696f 6e6a       projectionj
-00009e10: 736f 6e5b 277a 275d 203d 206f 732e 7061  son['z'] = os.pa
-00009e20: 7468 2e62 6173 656e 616d 6528 7a73 6361  th.basename(zsca
-00009e30: 6c65 6e61 6d65 2920 6966 206f 732e 7061  lename) if os.pa
-00009e40: 7468 2e69 7366 696c 6528 7a73 6361 6c65  th.isfile(zscale
-00009e50: 6e61 6d65 2920 656c 7365 204e 6f6e 650a  name) else None.
-00009e60: 0a20 2020 2020 2020 2020 2020 206f 7267  .            org
-00009e70: 7072 6f6a 6563 7469 6f6e 6a73 6f6e 5b27  projectionjson['
-00009e80: 7827 5d20 3d20 6f73 2e70 6174 682e 6261  x'] = os.path.ba
-00009e90: 7365 6e61 6d65 2878 7072 6f6a 6563 7469  sename(xprojecti
-00009ea0: 6f6e 6e61 6d65 2920 6966 206f 732e 7061  onname) if os.pa
-00009eb0: 7468 2e69 7366 696c 6528 7870 726f 6a65  th.isfile(xproje
-00009ec0: 6374 696f 6e6e 616d 6529 2065 6c73 6520  ctionname) else 
-00009ed0: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-00009ee0: 206f 7267 7072 6f6a 6563 7469 6f6e 6a73   orgprojectionjs
-00009ef0: 6f6e 5b27 7927 5d20 3d20 6f73 2e70 6174  on['y'] = os.pat
-00009f00: 682e 6261 7365 6e61 6d65 2879 7072 6f6a  h.basename(yproj
-00009f10: 6563 7469 6f6e 6e61 6d65 2920 6966 206f  ectionname) if o
-00009f20: 732e 7061 7468 2e69 7366 696c 6528 7970  s.path.isfile(yp
-00009f30: 726f 6a65 6374 696f 6e6e 616d 6529 2065  rojectionname) e
-00009f40: 6c73 6520 4e6f 6e65 0a20 2020 2020 2020  lse None.       
-00009f50: 2020 2020 206f 7267 7072 6f6a 6563 7469       orgprojecti
-00009f60: 6f6e 6a73 6f6e 5b27 7a27 5d20 3d20 6f73  onjson['z'] = os
-00009f70: 2e70 6174 682e 6261 7365 6e61 6d65 287a  .path.basename(z
-00009f80: 7072 6f6a 6563 7469 6f6e 6e61 6d65 2920  projectionname) 
-00009f90: 6966 206f 732e 7061 7468 2e69 7366 696c  if os.path.isfil
-00009fa0: 6528 7a70 726f 6a65 6374 696f 6e6e 616d  e(zprojectionnam
-00009fb0: 6529 2065 6c73 6520 4e6f 6e65 0a20 2020  e) else None.   
-00009fc0: 2020 2020 2020 2020 2062 6f74 686a 736f           bothjso
-00009fd0: 6e5b 276f 7269 6769 6e61 6c27 5d20 3d20  n['original'] = 
-00009fe0: 6f72 6770 726f 6a65 6374 696f 6e6a 736f  orgprojectionjso
-00009ff0: 6e0a 2020 2020 2020 2020 2020 2020 626f  n.            bo
-0000a000: 7468 6a73 6f6e 5b27 7363 616c 6564 275d  thjson['scaled']
-0000a010: 203d 2070 726f 6a65 6374 696f 6e6a 736f   = projectionjso
-0000a020: 6e0a 0a20 2020 2020 2020 2020 2020 2069  n..            i
-0000a030: 6620 6572 726c 6973 743a 0a20 2020 2020  f errlist:.     
-0000a040: 2020 2020 2020 2020 2020 2062 6f74 686a             bothj
-0000a050: 736f 6e5b 2765 7272 275d 203d 207b 276f  son['err'] = {'o
-0000a060: 7274 686f 676f 6e61 6c5f 6d61 785f 6572  rthogonal_max_er
-0000a070: 7227 3a20 6572 726c 6973 747d 0a20 2020  r': errlist}.   
-0000a080: 2020 2020 2020 2020 2066 696e 616c 6469           finaldi
-0000a090: 6374 203d 207b 6c61 6265 6c20 2b20 276f  ct = {label + 'o
-0000a0a0: 7274 686f 676f 6e61 6c5f 6d61 7827 3a20  rthogonal_max': 
-0000a0b0: 626f 7468 6a73 6f6e 7d0a 0a20 2020 2020  bothjson}..     
-0000a0c0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-0000a0d0: 2020 2020 2020 2020 2020 2020 7769 7468              with
-0000a0e0: 2063 6f64 6563 732e 6f70 656e 2877 6f72   codecs.open(wor
-0000a0f0: 6b64 6972 202b 206d 6170 6e61 6d65 202b  kdir + mapname +
-0000a100: 2027 5f6d 6178 2e6a 736f 6e27 2c20 2777   '_max.json', 'w
-0000a110: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-0000a120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a130: 2020 2020 656e 636f 6469 6e67 3d27 7574      encoding='ut
-0000a140: 662d 3827 2920 6173 2066 3a0a 2020 2020  f-8') as f:.    
-0000a150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a160: 6a73 6f6e 2e64 756d 7028 6669 6e61 6c64  json.dump(finald
-0000a170: 6963 742c 2066 290a 2020 2020 2020 2020  ict, f).        
-0000a180: 2020 2020 6578 6365 7074 2049 4f45 7272      except IOErr
-0000a190: 6f72 2061 7320 696f 6572 723a 0a20 2020  or as ioerr:.   
-0000a1a0: 2020 2020 2020 2020 2020 2020 206a 736f               jso
-0000a1b0: 6e65 7272 203d 2027 5361 7669 6e67 206d  nerr = 'Saving m
-0000a1c0: 6178 2070 726f 6a65 6374 696f 6e20 696e  ax projection in
-0000a1d0: 746f 206a 736f 6e20 6572 726f 723a 207b  to json error: {
-0000a1e0: 7d27 2e66 6f72 6d61 7428 696f 6572 7229  }'.format(ioerr)
-0000a1f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a200: 2073 7973 2e73 7464 6572 722e 7772 6974   sys.stderr.writ
-0000a210: 6528 6a73 6f6e 6572 7220 2b20 275c 6e27  e(jsonerr + '\n'
-0000a220: 290a 0a0a 2020 2020 2020 2020 2020 2020  )...            
-0000a230: 676c 6f77 626f 7468 6a73 6f6e 203d 2064  glowbothjson = d
-0000a240: 6963 7428 290a 2020 2020 2020 2020 2020  ict().          
-0000a250: 2020 676c 6f77 7072 6f6a 6563 7469 6f6e    glowprojection
-0000a260: 6a73 6f6e 203d 2064 6963 7428 290a 2020  json = dict().  
-0000a270: 2020 2020 2020 2020 2020 676c 6f77 6f72            glowor
-0000a280: 6770 726f 6a65 6374 696f 6e6a 736f 6e20  gprojectionjson 
-0000a290: 3d20 6469 6374 2829 0a0a 2020 2020 2020  = dict()..      
-0000a2a0: 2020 2020 2020 676c 6f77 7072 6f6a 6563        glowprojec
-0000a2b0: 7469 6f6e 6a73 6f6e 5b27 7827 5d20 3d20  tionjson['x'] = 
-0000a2c0: 6f73 2e70 6174 682e 6261 7365 6e61 6d65  os.path.basename
-0000a2d0: 2867 6c6f 7778 7363 616c 656e 616d 6529  (glowxscalename)
-0000a2e0: 2069 6620 6f73 2e70 6174 682e 6973 6669   if os.path.isfi
-0000a2f0: 6c65 2867 6c6f 7778 7363 616c 656e 616d  le(glowxscalenam
-0000a300: 6529 2065 6c73 6520 4e6f 6e65 0a20 2020  e) else None.   
-0000a310: 2020 2020 2020 2020 2067 6c6f 7770 726f           glowpro
-0000a320: 6a65 6374 696f 6e6a 736f 6e5b 2779 275d  jectionjson['y']
-0000a330: 203d 206f 732e 7061 7468 2e62 6173 656e   = os.path.basen
-0000a340: 616d 6528 676c 6f77 7973 6361 6c65 6e61  ame(glowyscalena
-0000a350: 6d65 2920 6966 206f 732e 7061 7468 2e69  me) if os.path.i
-0000a360: 7366 696c 6528 676c 6f77 7973 6361 6c65  sfile(glowyscale
-0000a370: 6e61 6d65 2920 656c 7365 204e 6f6e 650a  name) else None.
-0000a380: 2020 2020 2020 2020 2020 2020 676c 6f77              glow
-0000a390: 7072 6f6a 6563 7469 6f6e 6a73 6f6e 5b27  projectionjson['
-0000a3a0: 7a27 5d20 3d20 6f73 2e70 6174 682e 6261  z'] = os.path.ba
-0000a3b0: 7365 6e61 6d65 2867 6c6f 777a 7363 616c  sename(glowzscal
-0000a3c0: 656e 616d 6529 2069 6620 6f73 2e70 6174  ename) if os.pat
-0000a3d0: 682e 6973 6669 6c65 2867 6c6f 777a 7363  h.isfile(glowzsc
-0000a3e0: 616c 656e 616d 6529 2065 6c73 6520 4e6f  alename) else No
-0000a3f0: 6e65 0a0a 2020 2020 2020 2020 2020 2020  ne..            
-0000a400: 676c 6f77 6f72 6770 726f 6a65 6374 696f  gloworgprojectio
-0000a410: 6e6a 736f 6e5b 2778 275d 203d 206f 732e  njson['x'] = os.
-0000a420: 7061 7468 2e62 6173 656e 616d 6528 676c  path.basename(gl
-0000a430: 6f77 7870 726f 6a65 6374 696f 6e6e 616d  owxprojectionnam
-0000a440: 6529 2069 6620 6f73 2e70 6174 682e 6973  e) if os.path.is
-0000a450: 6669 6c65 2867 6c6f 7778 7072 6f6a 6563  file(glowxprojec
-0000a460: 7469 6f6e 6e61 6d65 2920 656c 7365 204e  tionname) else N
-0000a470: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
-0000a480: 676c 6f77 6f72 6770 726f 6a65 6374 696f  gloworgprojectio
-0000a490: 6e6a 736f 6e5b 2779 275d 203d 206f 732e  njson['y'] = os.
-0000a4a0: 7061 7468 2e62 6173 656e 616d 6528 676c  path.basename(gl
-0000a4b0: 6f77 7970 726f 6a65 6374 696f 6e6e 616d  owyprojectionnam
-0000a4c0: 6529 2069 6620 6f73 2e70 6174 682e 6973  e) if os.path.is
-0000a4d0: 6669 6c65 2867 6c6f 7779 7072 6f6a 6563  file(glowyprojec
-0000a4e0: 7469 6f6e 6e61 6d65 2920 656c 7365 204e  tionname) else N
-0000a4f0: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
-0000a500: 676c 6f77 6f72 6770 726f 6a65 6374 696f  gloworgprojectio
-0000a510: 6e6a 736f 6e5b 277a 275d 203d 206f 732e  njson['z'] = os.
-0000a520: 7061 7468 2e62 6173 656e 616d 6528 676c  path.basename(gl
-0000a530: 6f77 7a70 726f 6a65 6374 696f 6e6e 616d  owzprojectionnam
-0000a540: 6529 2069 6620 6f73 2e70 6174 682e 6973  e) if os.path.is
-0000a550: 6669 6c65 2867 6c6f 777a 7072 6f6a 6563  file(glowzprojec
-0000a560: 7469 6f6e 6e61 6d65 2920 656c 7365 204e  tionname) else N
-0000a570: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
-0000a580: 676c 6f77 626f 7468 6a73 6f6e 5b27 6f72  glowbothjson['or
-0000a590: 6967 696e 616c 275d 203d 2067 6c6f 776f  iginal'] = glowo
-0000a5a0: 7267 7072 6f6a 6563 7469 6f6e 6a73 6f6e  rgprojectionjson
-0000a5b0: 0a20 2020 2020 2020 2020 2020 2067 6c6f  .            glo
-0000a5c0: 7762 6f74 686a 736f 6e5b 2773 6361 6c65  wbothjson['scale
-0000a5d0: 6427 5d20 3d20 676c 6f77 7072 6f6a 6563  d'] = glowprojec
-0000a5e0: 7469 6f6e 6a73 6f6e 0a0a 2020 2020 2020  tionjson..      
-0000a5f0: 2020 2020 2020 6966 2065 7272 6c69 7374        if errlist
-0000a600: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000a610: 2020 676c 6f77 626f 7468 6a73 6f6e 5b27    glowbothjson['
-0000a620: 6572 7227 5d20 3d20 7b27 6f72 7468 6f67  err'] = {'orthog
-0000a630: 6f6e 616c 5f67 6c6f 775f 6d61 785f 6572  onal_glow_max_er
-0000a640: 7227 3a20 6572 726c 6973 747d 0a20 2020  r': errlist}.   
-0000a650: 2020 2020 2020 2020 2067 6c6f 7766 696e           glowfin
-0000a660: 616c 6469 6374 203d 207b 6c61 6265 6c20  aldict = {label 
-0000a670: 2b20 276f 7274 686f 676f 6e61 6c5f 676c  + 'orthogonal_gl
-0000a680: 6f77 5f6d 6178 273a 2067 6c6f 7762 6f74  ow_max': glowbot
-0000a690: 686a 736f 6e7d 0a0a 2020 2020 2020 2020  hjson}..        
-0000a6a0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-0000a6b0: 2020 2020 2020 2020 2077 6974 6820 636f           with co
-0000a6c0: 6465 6373 2e6f 7065 6e28 776f 726b 6469  decs.open(workdi
-0000a6d0: 7220 2b20 6d61 706e 616d 6520 2b20 275f  r + mapname + '_
-0000a6e0: 676c 6f77 5f6d 6178 2e6a 736f 6e27 2c20  glow_max.json', 
-0000a6f0: 2777 272c 0a20 2020 2020 2020 2020 2020  'w',.           
-0000a700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a710: 2020 2020 2020 656e 636f 6469 6e67 3d27        encoding='
-0000a720: 7574 662d 3827 2920 6173 2066 3a0a 2020  utf-8') as f:.  
-0000a730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a740: 2020 6a73 6f6e 2e64 756d 7028 676c 6f77    json.dump(glow
-0000a750: 6669 6e61 6c64 6963 742c 2066 290a 2020  finaldict, f).  
-0000a760: 2020 2020 2020 2020 2020 6578 6365 7074            except
-0000a770: 2049 4f45 7272 6f72 2061 7320 696f 6572   IOError as ioer
-0000a780: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
-0000a790: 2020 206a 736f 6e65 7272 203d 2027 5361     jsonerr = 'Sa
-0000a7a0: 7669 6e67 2067 6c6f 7720 6d61 7820 7072  ving glow max pr
-0000a7b0: 6f6a 6563 7469 6f6e 2069 6e74 6f20 6a73  ojection into js
-0000a7c0: 6f6e 2065 7272 6f72 3a20 7b7d 272e 666f  on error: {}'.fo
-0000a7d0: 726d 6174 2869 6f65 7272 290a 2020 2020  rmat(ioerr).    
-0000a7e0: 2020 2020 2020 2020 2020 2020 7379 732e              sys.
-0000a7f0: 7374 6465 7272 2e77 7269 7465 286a 736f  stderr.write(jso
-0000a800: 6e65 7272 202b 2027 5c6e 2729 0a0a 2020  nerr + '\n')..  
-0000a810: 2020 2020 2020 2020 2020 656e 6420 3d20            end = 
-0000a820: 7469 6d65 6974 2e64 6566 6175 6c74 5f74  timeit.default_t
-0000a830: 696d 6572 2829 0a20 2020 2020 2020 2020  imer().         
-0000a840: 2020 2070 7269 6e74 2827 4d61 7820 616e     print('Max an
-0000a850: 6420 6974 7320 676c 6f77 2070 726f 6a65  d its glow proje
-0000a860: 6374 696f 6e73 2074 696d 6520 666f 7220  ctions time for 
-0000a870: 2573 3a20 2573 2720 2520 286d 6170 6e61  %s: %s' % (mapna
-0000a880: 6d65 2c20 656e 6420 2d20 7374 6172 7429  me, end - start)
-0000a890: 290a 2020 2020 2020 2020 2020 2020 7072  ).            pr
-0000a8a0: 696e 7428 272d 2d2d 2d2d 2d2d 2d2d 2d2d  int('-----------
-0000a8b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0000a8c0: 2d2d 2d2d 2d2d 2d2d 2d27 290a 0a20 2020  ---------')..   
-0000a8d0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0000a8e0: 2020 2020 2020 2070 7269 6e74 2827 4e6f         print('No
-0000a8f0: 206f 7274 686f 676f 6e61 6c20 6d61 7869   orthogonal maxi
-0000a900: 6d75 6d20 7072 6f6a 6563 7469 6f6e 7320  mum projections 
-0000a910: 616e 6420 6974 2067 6c6f 7720 7072 6f6a  and it glow proj
-0000a920: 6563 7469 6f6e 7320 270a 2020 2020 2020  ections '.      
-0000a930: 2020 2020 2020 2020 2020 2020 2777 6974              'wit
-0000a940: 686f 7574 2070 726f 7065 7220 6d61 7020  hout proper map 
-0000a950: 696e 7075 7420 616e 6420 7468 6520 6f75  input and the ou
-0000a960: 7470 7574 2064 6972 6563 746f 7279 2069  tput directory i
-0000a970: 6e66 6f72 6d61 7469 6f6e 2e27 290a 0a20  nformation.').. 
-0000a980: 2020 2020 2020 2072 6574 7572 6e20 4e6f         return No
-0000a990: 6e65 0a0a 2020 2020 2320 4070 726f 6669  ne..    # @profi
-0000a9a0: 6c65 0a20 2020 2064 6566 2072 6177 6d61  le.    def rawma
-0000a9b0: 705f 6d61 7828 7365 6c66 293a 0a0a 2020  p_max(self):..  
-0000a9c0: 2020 2020 2020 7261 776d 6170 203d 2073        rawmap = s
-0000a9d0: 656c 662e 7261 776d 6170 0a20 2020 2020  elf.rawmap.     
-0000a9e0: 2020 2069 6620 7261 776d 6170 2069 7320     if rawmap is 
-0000a9f0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-0000aa00: 2020 2020 2020 6469 7220 3d20 7365 6c66        dir = self
-0000aa10: 2e77 6f72 6b64 6972 0a20 2020 2020 2020  .workdir.       
-0000aa20: 2020 2020 206c 6162 656c 203d 2027 7261       label = 'ra
-0000aa30: 776d 6170 5f27 0a20 2020 2020 2020 2020  wmap_'.         
-0000aa40: 2020 2073 656c 662e 6f72 7468 6f67 6f6e     self.orthogon
-0000aa50: 616c 5f6d 6178 2872 6177 6d61 702c 2064  al_max(rawmap, d
-0000aa60: 6972 2c20 6c61 6265 6c29 0a20 2020 2020  ir, label).     
-0000aa70: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000aa80: 2020 2020 2070 7269 6e74 2827 4e6f 2072       print('No r
-0000aa90: 6177 206d 6170 2074 6f20 6361 6c63 756c  aw map to calcul
-0000aaa0: 6174 6520 6f72 7468 6f67 6f6e 616c 206d  ate orthogonal m
-0000aab0: 6178 2070 726f 6a65 6374 696f 6e73 2e27  ax projections.'
-0000aac0: 290a 0a20 2020 2023 2040 7072 6f66 696c  )..    # @profil
-0000aad0: 650a 2020 2020 6465 6620 6f72 7468 6f67  e.    def orthog
-0000aae0: 6f6e 616c 5f73 7464 2873 656c 662c 206d  onal_std(self, m
-0000aaf0: 6170 696e 3d4e 6f6e 652c 2077 6f72 6b64  apin=None, workd
-0000ab00: 6972 3d4e 6f6e 652c 206c 6162 656c 3d27  ir=None, label='
-0000ab10: 2729 3a0a 2020 2020 2020 2020 2222 220a  '):.        """.
-0000ab20: 2020 2020 2020 2020 2020 2020 2053 7464               Std
-0000ab30: 2070 726f 6a65 6374 696f 6e20 616e 6420   projection and 
-0000ab40: 6974 2067 6c6f 7720 696d 6167 650a 2020  it glow image.  
-0000ab50: 2020 2020 2020 3a70 6172 616d 206d 6170        :param map
-0000ab60: 696e 3a20 496e 7075 7420 6d61 7020 6569  in: Input map ei
-0000ab70: 7468 6572 206d 7263 6669 6c65 206f 7220  ther mrcfile or 
-0000ab80: 6669 6c65 6e61 6d65 2073 7472 696e 670a  filename string.
-0000ab90: 2020 2020 2020 2020 3a70 6172 616d 2077          :param w
-0000aba0: 6f72 6b64 6972 3a20 5374 7269 6e67 206f  orkdir: String o
-0000abb0: 6620 7468 6520 6675 6c6c 2077 6f72 6b20  f the full work 
-0000abc0: 7061 7468 0a20 2020 2020 2020 203a 7061  path.        :pa
-0000abd0: 7261 6d20 6c61 6265 6c3a 2066 6f72 2072  ram label: for r
-0000abe0: 6177 206d 6170 2075 7365 2027 7261 775f  aw map use 'raw_
-0000abf0: 270a 2020 2020 2020 2020 3a72 6574 7572  '.        :retur
-0000ac00: 6e3a 204e 6f6e 650a 2020 2020 2020 2020  n: None.        
-0000ac10: 2222 220a 0a20 2020 2020 2020 206d 6170  """..        map
-0000ac20: 2c20 776f 726b 6469 7220 3d20 7365 6c66  , workdir = self
-0000ac30: 2e6d 6170 696e 6368 6563 6b28 6d61 7069  .mapincheck(mapi
-0000ac40: 6e2c 2077 6f72 6b64 6972 290a 2020 2020  n, workdir).    
-0000ac50: 2020 2020 6d61 706e 616d 6520 3d20 6f73      mapname = os
-0000ac60: 2e70 6174 682e 6261 7365 6e61 6d65 286d  .path.basename(m
-0000ac70: 6170 2e66 756c 6c6e 616d 6529 2069 6620  ap.fullname) if 
-0000ac80: 6d61 7020 656c 7365 204e 6f6e 650a 2020  map else None.  
-0000ac90: 2020 2020 2020 6966 206d 6170 2069 7320        if map is 
-0000aca0: 6e6f 7420 4e6f 6e65 2061 6e64 2077 6f72  not None and wor
-0000acb0: 6b64 6972 2069 7320 6e6f 7420 4e6f 6e65  kdir is not None
-0000acc0: 3a0a 2020 2020 2020 2020 2020 2020 7374  :.            st
-0000acd0: 6172 7420 3d20 7469 6d65 6974 2e64 6566  art = timeit.def
-0000ace0: 6175 6c74 5f74 696d 6572 2829 0a20 2020  ault_timer().   
-0000acf0: 2020 2020 2020 2020 2065 7272 6c69 7374           errlist
-0000ad00: 203d 205b 5d0a 0a20 2020 2020 2020 2020   = []..         
-0000ad10: 2020 2074 7970 6520 3d20 2773 7464 270a     type = 'std'.
-0000ad20: 0a20 2020 2020 2020 2020 2020 2078 7072  .            xpr
-0000ad30: 6f6a 6563 7469 6f6e 6e61 6d65 203d 2077  ojectionname = w
-0000ad40: 6f72 6b64 6972 202b 206d 6170 6e61 6d65  orkdir + mapname
-0000ad50: 202b 2027 5f78 7374 642e 6a70 6567 270a   + '_xstd.jpeg'.
-0000ad60: 2020 2020 2020 2020 2020 2020 7873 6361              xsca
-0000ad70: 6c65 6e61 6d65 203d 2077 6f72 6b64 6972  lename = workdir
-0000ad80: 202b 206d 6170 6e61 6d65 202b 2027 5f73   + mapname + '_s
-0000ad90: 6361 6c65 645f 7873 7464 2e6a 7065 6727  caled_xstd.jpeg'
-0000ada0: 0a20 2020 2020 2020 2020 2020 2067 6c6f  .            glo
-0000adb0: 7778 7072 6f6a 6563 7469 6f6e 6e61 6d65  wxprojectionname
-0000adc0: 203d 2077 6f72 6b64 6972 202b 206d 6170   = workdir + map
-0000add0: 6e61 6d65 202b 2027 5f67 6c6f 775f 7873  name + '_glow_xs
-0000ade0: 7464 2e6a 7065 6727 0a20 2020 2020 2020  td.jpeg'.       
-0000adf0: 2020 2020 2067 6c6f 7778 7363 616c 656e       glowxscalen
-0000ae00: 616d 6520 3d20 776f 726b 6469 7220 2b20  ame = workdir + 
-0000ae10: 6d61 706e 616d 6520 2b20 275f 7363 616c  mapname + '_scal
-0000ae20: 6564 5f67 6c6f 775f 7873 7464 2e6a 7065  ed_glow_xstd.jpe
-0000ae30: 6727 0a20 2020 2020 2020 2020 2020 2073  g'.            s
-0000ae40: 656c 662e 6d61 705f 746f 5f69 6d67 286d  elf.map_to_img(m
-0000ae50: 6170 2c20 322c 2074 7970 652c 2065 7272  ap, 2, type, err
-0000ae60: 6c69 7374 2c20 7365 6c66 2e67 6c6f 7769  list, self.glowi
-0000ae70: 6d61 6765 290a 0a20 2020 2020 2020 2020  mage)..         
-0000ae80: 2020 2079 7072 6f6a 6563 7469 6f6e 6e61     yprojectionna
-0000ae90: 6d65 203d 2077 6f72 6b64 6972 202b 206d  me = workdir + m
-0000aea0: 6170 6e61 6d65 202b 2027 5f79 7374 642e  apname + '_ystd.
-0000aeb0: 6a70 6567 270a 2020 2020 2020 2020 2020  jpeg'.          
-0000aec0: 2020 7973 6361 6c65 6e61 6d65 203d 2077    yscalename = w
-0000aed0: 6f72 6b64 6972 202b 206d 6170 6e61 6d65  orkdir + mapname
-0000aee0: 202b 2027 5f73 6361 6c65 645f 7973 7464   + '_scaled_ystd
-0000aef0: 2e6a 7065 6727 0a20 2020 2020 2020 2020  .jpeg'.         
-0000af00: 2020 2067 6c6f 7779 7072 6f6a 6563 7469     glowyprojecti
-0000af10: 6f6e 6e61 6d65 203d 2077 6f72 6b64 6972  onname = workdir
-0000af20: 202b 206d 6170 6e61 6d65 202b 2027 5f67   + mapname + '_g
-0000af30: 6c6f 775f 7973 7464 2e6a 7065 6727 0a20  low_ystd.jpeg'. 
-0000af40: 2020 2020 2020 2020 2020 2067 6c6f 7779             glowy
-0000af50: 7363 616c 656e 616d 6520 3d20 776f 726b  scalename = work
-0000af60: 6469 7220 2b20 6d61 706e 616d 6520 2b20  dir + mapname + 
-0000af70: 275f 7363 616c 6564 5f67 6c6f 775f 7973  '_scaled_glow_ys
-0000af80: 7464 2e6a 7065 6727 0a20 2020 2020 2020  td.jpeg'.       
-0000af90: 2020 2020 2073 656c 662e 6d61 705f 746f       self.map_to
-0000afa0: 5f69 6d67 286d 6170 2c20 312c 2074 7970  _img(map, 1, typ
-0000afb0: 652c 2065 7272 6c69 7374 2c20 7365 6c66  e, errlist, self
-0000afc0: 2e67 6c6f 7769 6d61 6765 290a 0a20 2020  .glowimage)..   
-0000afd0: 2020 2020 2020 2020 207a 7072 6f6a 6563           zprojec
-0000afe0: 7469 6f6e 6e61 6d65 203d 2077 6f72 6b64  tionname = workd
-0000aff0: 6972 202b 206d 6170 6e61 6d65 202b 2027  ir + mapname + '
-0000b000: 5f7a 7374 642e 6a70 6567 270a 2020 2020  _zstd.jpeg'.    
-0000b010: 2020 2020 2020 2020 7a73 6361 6c65 6e61          zscalena
-0000b020: 6d65 203d 2077 6f72 6b64 6972 202b 206d  me = workdir + m
-0000b030: 6170 6e61 6d65 202b 2027 5f73 6361 6c65  apname + '_scale
-0000b040: 645f 7a73 7464 2e6a 7065 6727 0a20 2020  d_zstd.jpeg'.   
-0000b050: 2020 2020 2020 2020 2067 6c6f 777a 7072           glowzpr
-0000b060: 6f6a 6563 7469 6f6e 6e61 6d65 203d 2077  ojectionname = w
-0000b070: 6f72 6b64 6972 202b 206d 6170 6e61 6d65  orkdir + mapname
-0000b080: 202b 2027 5f67 6c6f 775f 7a73 7464 2e6a   + '_glow_zstd.j
-0000b090: 7065 6727 0a20 2020 2020 2020 2020 2020  peg'.           
-0000b0a0: 2067 6c6f 777a 7363 616c 656e 616d 6520   glowzscalename 
-0000b0b0: 3d20 776f 726b 6469 7220 2b20 6d61 706e  = workdir + mapn
-0000b0c0: 616d 6520 2b20 275f 7363 616c 6564 5f67  ame + '_scaled_g
-0000b0d0: 6c6f 775f 7a73 7464 2e6a 7065 6727 0a20  low_zstd.jpeg'. 
-0000b0e0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000b0f0: 6d61 705f 746f 5f69 6d67 286d 6170 2c20  map_to_img(map, 
-0000b100: 302c 2074 7970 652c 2065 7272 6c69 7374  0, type, errlist
-0000b110: 2c20 7365 6c66 2e67 6c6f 7769 6d61 6765  , self.glowimage
-0000b120: 290a 0a20 2020 2020 2020 2020 2020 2062  )..            b
-0000b130: 6f74 686a 736f 6e20 3d20 6469 6374 2829  othjson = dict()
-0000b140: 0a20 2020 2020 2020 2020 2020 2070 726f  .            pro
-0000b150: 6a65 6374 696f 6e6a 736f 6e20 3d20 6469  jectionjson = di
-0000b160: 6374 2829 0a20 2020 2020 2020 2020 2020  ct().           
-0000b170: 206f 7267 7072 6f6a 6563 7469 6f6e 6a73   orgprojectionjs
-0000b180: 6f6e 203d 2064 6963 7428 290a 0a20 2020  on = dict()..   
-0000b190: 2020 2020 2020 2020 2070 726f 6a65 6374           project
-0000b1a0: 696f 6e6a 736f 6e5b 2778 275d 203d 206f  ionjson['x'] = o
-0000b1b0: 732e 7061 7468 2e62 6173 656e 616d 6528  s.path.basename(
-0000b1c0: 7873 6361 6c65 6e61 6d65 2920 6966 206f  xscalename) if o
-0000b1d0: 732e 7061 7468 2e69 7366 696c 6528 7873  s.path.isfile(xs
-0000b1e0: 6361 6c65 6e61 6d65 2920 656c 7365 204e  calename) else N
-0000b1f0: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
-0000b200: 7072 6f6a 6563 7469 6f6e 6a73 6f6e 5b27  projectionjson['
-0000b210: 7927 5d20 3d20 6f73 2e70 6174 682e 6261  y'] = os.path.ba
-0000b220: 7365 6e61 6d65 2879 7363 616c 656e 616d  sename(yscalenam
-0000b230: 6529 2069 6620 6f73 2e70 6174 682e 6973  e) if os.path.is
-0000b240: 6669 6c65 2879 7363 616c 656e 616d 6529  file(yscalename)
-0000b250: 2065 6c73 6520 4e6f 6e65 0a20 2020 2020   else None.     
-0000b260: 2020 2020 2020 2070 726f 6a65 6374 696f         projectio
-0000b270: 6e6a 736f 6e5b 277a 275d 203d 206f 732e  njson['z'] = os.
-0000b280: 7061 7468 2e62 6173 656e 616d 6528 7a73  path.basename(zs
-0000b290: 6361 6c65 6e61 6d65 2920 6966 206f 732e  calename) if os.
-0000b2a0: 7061 7468 2e69 7366 696c 6528 7a73 6361  path.isfile(zsca
-0000b2b0: 6c65 6e61 6d65 2920 656c 7365 204e 6f6e  lename) else Non
-0000b2c0: 650a 0a20 2020 2020 2020 2020 2020 206f  e..            o
-0000b2d0: 7267 7072 6f6a 6563 7469 6f6e 6a73 6f6e  rgprojectionjson
-0000b2e0: 5b27 7827 5d20 3d20 6f73 2e70 6174 682e  ['x'] = os.path.
-0000b2f0: 6261 7365 6e61 6d65 2878 7072 6f6a 6563  basename(xprojec
-0000b300: 7469 6f6e 6e61 6d65 2920 6966 206f 732e  tionname) if os.
-0000b310: 7061 7468 2e69 7366 696c 6528 7870 726f  path.isfile(xpro
-0000b320: 6a65 6374 696f 6e6e 616d 6529 2065 6c73  jectionname) els
-0000b330: 6520 4e6f 6e65 0a20 2020 2020 2020 2020  e None.         
-0000b340: 2020 206f 7267 7072 6f6a 6563 7469 6f6e     orgprojection
-0000b350: 6a73 6f6e 5b27 7927 5d20 3d20 6f73 2e70  json['y'] = os.p
-0000b360: 6174 682e 6261 7365 6e61 6d65 2879 7072  ath.basename(ypr
-0000b370: 6f6a 6563 7469 6f6e 6e61 6d65 2920 6966  ojectionname) if
-0000b380: 206f 732e 7061 7468 2e69 7366 696c 6528   os.path.isfile(
-0000b390: 7970 726f 6a65 6374 696f 6e6e 616d 6529  yprojectionname)
-0000b3a0: 2065 6c73 6520 4e6f 6e65 0a20 2020 2020   else None.     
-0000b3b0: 2020 2020 2020 206f 7267 7072 6f6a 6563         orgprojec
-0000b3c0: 7469 6f6e 6a73 6f6e 5b27 7a27 5d20 3d20  tionjson['z'] = 
-0000b3d0: 6f73 2e70 6174 682e 6261 7365 6e61 6d65  os.path.basename
-0000b3e0: 287a 7072 6f6a 6563 7469 6f6e 6e61 6d65  (zprojectionname
-0000b3f0: 2920 6966 206f 732e 7061 7468 2e69 7366  ) if os.path.isf
-0000b400: 696c 6528 7a70 726f 6a65 6374 696f 6e6e  ile(zprojectionn
-0000b410: 616d 6529 2065 6c73 6520 4e6f 6e65 0a20  ame) else None. 
-0000b420: 2020 2020 2020 2020 2020 2062 6f74 686a             bothj
-0000b430: 736f 6e5b 276f 7269 6769 6e61 6c27 5d20  son['original'] 
-0000b440: 3d20 6f72 6770 726f 6a65 6374 696f 6e6a  = orgprojectionj
-0000b450: 736f 6e0a 2020 2020 2020 2020 2020 2020  son.            
-0000b460: 626f 7468 6a73 6f6e 5b27 7363 616c 6564  bothjson['scaled
-0000b470: 275d 203d 2070 726f 6a65 6374 696f 6e6a  '] = projectionj
-0000b480: 736f 6e0a 0a20 2020 2020 2020 2020 2020  son..           
-0000b490: 2069 6620 6572 726c 6973 743a 0a20 2020   if errlist:.   
-0000b4a0: 2020 2020 2020 2020 2020 2020 2062 6f74               bot
-0000b4b0: 686a 736f 6e5b 2765 7272 275d 203d 207b  hjson['err'] = {
-0000b4c0: 276f 7274 686f 676f 6e61 6c5f 7374 645f  'orthogonal_std_
-0000b4d0: 6572 7227 3a20 6572 726c 6973 747d 0a20  err': errlist}. 
-0000b4e0: 2020 2020 2020 2020 2020 2066 696e 616c             final
-0000b4f0: 6469 6374 203d 207b 6c61 6265 6c20 2b20  dict = {label + 
-0000b500: 276f 7274 686f 676f 6e61 6c5f 7374 6427  'orthogonal_std'
-0000b510: 3a20 626f 7468 6a73 6f6e 7d0a 0a20 2020  : bothjson}..   
-0000b520: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-0000b530: 2020 2020 2020 2020 2020 2020 2020 7769                wi
-0000b540: 7468 2063 6f64 6563 732e 6f70 656e 2877  th codecs.open(w
-0000b550: 6f72 6b64 6972 202b 206d 6170 6e61 6d65  orkdir + mapname
-0000b560: 202b 2027 5f73 7464 2e6a 736f 6e27 2c20   + '_std.json', 
-0000b570: 2777 272c 0a20 2020 2020 2020 2020 2020  'w',.           
-0000b580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b590: 2020 2020 2020 656e 636f 6469 6e67 3d27        encoding='
-0000b5a0: 7574 662d 3827 2920 6173 2066 3a0a 2020  utf-8') as f:.  
-0000b5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b5c0: 2020 6a73 6f6e 2e64 756d 7028 6669 6e61    json.dump(fina
-0000b5d0: 6c64 6963 742c 2066 290a 2020 2020 2020  ldict, f).      
-0000b5e0: 2020 2020 2020 6578 6365 7074 2049 4f45        except IOE
-0000b5f0: 7272 6f72 2061 7320 696f 6572 723a 0a20  rror as ioerr:. 
-0000b600: 2020 2020 2020 2020 2020 2020 2020 206a                 j
-0000b610: 736f 6e65 7272 203d 2027 5361 7669 6e67  sonerr = 'Saving
-0000b620: 2073 7464 2070 726f 6a65 6374 696f 6e20   std projection 
-0000b630: 696e 746f 206a 736f 6e20 6572 726f 723a  into json error:
-0000b640: 207b 7d27 2e66 6f72 6d61 7428 696f 6572   {}'.format(ioer
-0000b650: 7229 0a20 2020 2020 2020 2020 2020 2020  r).             
-0000b660: 2020 2073 7973 2e73 7464 6572 722e 7772     sys.stderr.wr
-0000b670: 6974 6528 6a73 6f6e 6572 7220 2b20 275c  ite(jsonerr + '\
-0000b680: 6e27 290a 0a20 2020 2020 2020 2020 2020  n')..           
-0000b690: 2067 6c6f 7762 6f74 686a 736f 6e20 3d20   glowbothjson = 
-0000b6a0: 6469 6374 2829 0a20 2020 2020 2020 2020  dict().         
-0000b6b0: 2020 2067 6c6f 7770 726f 6a65 6374 696f     glowprojectio
-0000b6c0: 6e6a 736f 6e20 3d20 6469 6374 2829 0a20  njson = dict(). 
-0000b6d0: 2020 2020 2020 2020 2020 2067 6c6f 776f             glowo
-0000b6e0: 7267 7072 6f6a 6563 7469 6f6e 6a73 6f6e  rgprojectionjson
-0000b6f0: 203d 2064 6963 7428 290a 0a20 2020 2020   = dict()..     
-0000b700: 2020 2020 2020 2067 6c6f 7770 726f 6a65         glowproje
-0000b710: 6374 696f 6e6a 736f 6e5b 2778 275d 203d  ctionjson['x'] =
-0000b720: 206f 732e 7061 7468 2e62 6173 656e 616d   os.path.basenam
-0000b730: 6528 676c 6f77 7873 6361 6c65 6e61 6d65  e(glowxscalename
-0000b740: 2920 6966 206f 732e 7061 7468 2e69 7366  ) if os.path.isf
-0000b750: 696c 6528 676c 6f77 7873 6361 6c65 6e61  ile(glowxscalena
-0000b760: 6d65 2920 656c 7365 204e 6f6e 650a 2020  me) else None.  
-0000b770: 2020 2020 2020 2020 2020 676c 6f77 7072            glowpr
-0000b780: 6f6a 6563 7469 6f6e 6a73 6f6e 5b27 7927  ojectionjson['y'
-0000b790: 5d20 3d20 6f73 2e70 6174 682e 6261 7365  ] = os.path.base
-0000b7a0: 6e61 6d65 2867 6c6f 7779 7363 616c 656e  name(glowyscalen
-0000b7b0: 616d 6529 2069 6620 6f73 2e70 6174 682e  ame) if os.path.
-0000b7c0: 6973 6669 6c65 2867 6c6f 7779 7363 616c  isfile(glowyscal
-0000b7d0: 656e 616d 6529 2065 6c73 6520 4e6f 6e65  ename) else None
-0000b7e0: 0a20 2020 2020 2020 2020 2020 2067 6c6f  .            glo
-0000b7f0: 7770 726f 6a65 6374 696f 6e6a 736f 6e5b  wprojectionjson[
-0000b800: 277a 275d 203d 206f 732e 7061 7468 2e62  'z'] = os.path.b
-0000b810: 6173 656e 616d 6528 676c 6f77 7a73 6361  asename(glowzsca
-0000b820: 6c65 6e61 6d65 2920 6966 206f 732e 7061  lename) if os.pa
-0000b830: 7468 2e69 7366 696c 6528 676c 6f77 7a73  th.isfile(glowzs
-0000b840: 6361 6c65 6e61 6d65 2920 656c 7365 204e  calename) else N
-0000b850: 6f6e 650a 0a20 2020 2020 2020 2020 2020  one..           
-0000b860: 2067 6c6f 776f 7267 7072 6f6a 6563 7469   gloworgprojecti
-0000b870: 6f6e 6a73 6f6e 5b27 7827 5d20 3d20 6f73  onjson['x'] = os
-0000b880: 2e70 6174 682e 6261 7365 6e61 6d65 2867  .path.basename(g
-0000b890: 6c6f 7778 7072 6f6a 6563 7469 6f6e 6e61  lowxprojectionna
-0000b8a0: 6d65 2920 6966 206f 732e 7061 7468 2e69  me) if os.path.i
-0000b8b0: 7366 696c 6528 676c 6f77 7870 726f 6a65  sfile(glowxproje
-0000b8c0: 6374 696f 6e6e 616d 6529 2065 6c73 6520  ctionname) else 
-0000b8d0: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-0000b8e0: 2067 6c6f 776f 7267 7072 6f6a 6563 7469   gloworgprojecti
-0000b8f0: 6f6e 6a73 6f6e 5b27 7927 5d20 3d20 6f73  onjson['y'] = os
-0000b900: 2e70 6174 682e 6261 7365 6e61 6d65 2867  .path.basename(g
-0000b910: 6c6f 7779 7072 6f6a 6563 7469 6f6e 6e61  lowyprojectionna
-0000b920: 6d65 2920 6966 206f 732e 7061 7468 2e69  me) if os.path.i
-0000b930: 7366 696c 6528 676c 6f77 7970 726f 6a65  sfile(glowyproje
-0000b940: 6374 696f 6e6e 616d 6529 2065 6c73 6520  ctionname) else 
-0000b950: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-0000b960: 2067 6c6f 776f 7267 7072 6f6a 6563 7469   gloworgprojecti
-0000b970: 6f6e 6a73 6f6e 5b27 7a27 5d20 3d20 6f73  onjson['z'] = os
-0000b980: 2e70 6174 682e 6261 7365 6e61 6d65 2867  .path.basename(g
-0000b990: 6c6f 777a 7072 6f6a 6563 7469 6f6e 6e61  lowzprojectionna
-0000b9a0: 6d65 2920 6966 206f 732e 7061 7468 2e69  me) if os.path.i
-0000b9b0: 7366 696c 6528 676c 6f77 7a70 726f 6a65  sfile(glowzproje
-0000b9c0: 6374 696f 6e6e 616d 6529 2065 6c73 6520  ctionname) else 
-0000b9d0: 4e6f 6e65 0a0a 2020 2020 2020 2020 2020  None..          
-0000b9e0: 2020 676c 6f77 626f 7468 6a73 6f6e 5b27    glowbothjson['
-0000b9f0: 6f72 6967 696e 616c 275d 203d 2067 6c6f  original'] = glo
-0000ba00: 776f 7267 7072 6f6a 6563 7469 6f6e 6a73  worgprojectionjs
-0000ba10: 6f6e 0a20 2020 2020 2020 2020 2020 2067  on.            g
-0000ba20: 6c6f 7762 6f74 686a 736f 6e5b 2773 6361  lowbothjson['sca
-0000ba30: 6c65 6427 5d20 3d20 676c 6f77 7072 6f6a  led'] = glowproj
-0000ba40: 6563 7469 6f6e 6a73 6f6e 0a0a 2020 2020  ectionjson..    
-0000ba50: 2020 2020 2020 2020 6966 2065 7272 6c69          if errli
-0000ba60: 7374 3a0a 2020 2020 2020 2020 2020 2020  st:.            
-0000ba70: 2020 2020 676c 6f77 626f 7468 6a73 6f6e      glowbothjson
-0000ba80: 5b27 6572 7227 5d20 3d20 7b27 6f72 7468  ['err'] = {'orth
-0000ba90: 6f67 6f6e 616c 5f67 6c6f 775f 7374 645f  ogonal_glow_std_
-0000baa0: 6572 7227 3a20 6572 726c 6973 747d 0a20  err': errlist}. 
-0000bab0: 2020 2020 2020 2020 2020 2067 6c6f 7766             glowf
-0000bac0: 696e 616c 6469 6374 203d 207b 6c61 6265  inaldict = {labe
-0000bad0: 6c20 2b20 276f 7274 686f 676f 6e61 6c5f  l + 'orthogonal_
-0000bae0: 676c 6f77 5f73 7464 273a 2067 6c6f 7762  glow_std': glowb
-0000baf0: 6f74 686a 736f 6e7d 0a0a 2020 2020 2020  othjson}..      
-0000bb00: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0000bb10: 2020 2020 2020 2020 2020 2077 6974 6820             with 
-0000bb20: 636f 6465 6373 2e6f 7065 6e28 776f 726b  codecs.open(work
-0000bb30: 6469 7220 2b20 6d61 706e 616d 6520 2b20  dir + mapname + 
-0000bb40: 275f 676c 6f77 5f73 7464 2e6a 736f 6e27  '_glow_std.json'
-0000bb50: 2c20 2777 272c 0a20 2020 2020 2020 2020  , 'w',.         
-0000bb60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bb70: 2020 2020 2020 2020 656e 636f 6469 6e67          encoding
-0000bb80: 3d27 7574 662d 3827 2920 6173 2066 3a0a  ='utf-8') as f:.
-0000bb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bba0: 2020 2020 6a73 6f6e 2e64 756d 7028 676c      json.dump(gl
-0000bbb0: 6f77 6669 6e61 6c64 6963 742c 2066 290a  owfinaldict, f).
-0000bbc0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-0000bbd0: 7074 2049 4f45 7272 6f72 2061 7320 696f  pt IOError as io
-0000bbe0: 6572 723a 0a20 2020 2020 2020 2020 2020  err:.           
-0000bbf0: 2020 2020 206a 736f 6e65 7272 203d 2027       jsonerr = '
-0000bc00: 5361 7669 6e67 2067 6c6f 7720 7374 6420  Saving glow std 
-0000bc10: 7072 6f6a 6563 7469 6f6e 2069 6e74 6f20  projection into 
-0000bc20: 6a73 6f6e 2065 7272 6f72 3a20 7b7d 272e  json error: {}'.
-0000bc30: 666f 726d 6174 2869 6f65 7272 290a 2020  format(ioerr).  
-0000bc40: 2020 2020 2020 2020 2020 2020 2020 7379                sy
-0000bc50: 732e 7374 6465 7272 2e77 7269 7465 286a  s.stderr.write(j
-0000bc60: 736f 6e65 7272 202b 2027 5c6e 2729 0a0a  sonerr + '\n')..
-0000bc70: 2020 2020 2020 2020 2020 2020 656e 6420              end 
-0000bc80: 3d20 7469 6d65 6974 2e64 6566 6175 6c74  = timeit.default
-0000bc90: 5f74 696d 6572 2829 0a20 2020 2020 2020  _timer().       
-0000bca0: 2020 2020 2070 7269 6e74 2827 476c 6f77       print('Glow
-0000bcb0: 2061 6e64 2073 7464 2070 726f 6a65 6374   and std project
-0000bcc0: 696f 6e73 2074 696d 6520 666f 7220 2573  ions time for %s
-0000bcd0: 3a20 2573 2720 2520 286d 6170 6e61 6d65  : %s' % (mapname
-0000bce0: 2c20 656e 6420 2d20 7374 6172 7429 290a  , end - start)).
-0000bcf0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0000bd00: 7428 272d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  t('-------------
-0000bd10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0000bd20: 2d2d 2d2d 2d2d 2d27 290a 0a20 2020 2020  -------')..     
-0000bd30: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000bd40: 2020 2020 2070 7269 6e74 2827 4e6f 2067       print('No g
-0000bd50: 6c6f 7720 616e 6420 7374 6420 7072 6f6a  low and std proj
-0000bd60: 6563 7469 6f6e 7320 7769 7468 6f75 7420  ections without 
-0000bd70: 7072 6f70 6572 206d 6170 2069 6e70 7574  proper map input
-0000bd80: 2061 6e64 2074 6865 206f 7574 7075 7420   and the output 
-0000bd90: 6469 7265 6374 6f72 7920 696e 666f 726d  directory inform
-0000bda0: 6174 696f 6e2e 2729 0a0a 2020 2020 2020  ation.')..      
-0000bdb0: 2020 7265 7475 726e 204e 6f6e 650a 0a0a    return None...
-0000bdc0: 2020 2020 2320 4070 726f 6669 6c65 0a20      # @profile. 
-0000bdd0: 2020 2064 6566 2072 6177 6d61 705f 7374     def rawmap_st
-0000bde0: 6428 7365 6c66 293a 0a0a 2020 2020 2020  d(self):..      
-0000bdf0: 2020 7261 776d 6170 203d 2073 656c 662e    rawmap = self.
-0000be00: 7261 776d 6170 0a20 2020 2020 2020 2069  rawmap.        i
-0000be10: 6620 7261 776d 6170 2069 7320 6e6f 7420  f rawmap is not 
-0000be20: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0000be30: 2020 6469 7220 3d20 7365 6c66 2e77 6f72    dir = self.wor
-0000be40: 6b64 6972 0a20 2020 2020 2020 2020 2020  kdir.           
-0000be50: 206c 6162 656c 203d 2027 7261 776d 6170   label = 'rawmap
-0000be60: 5f27 0a20 2020 2020 2020 2020 2020 2073  _'.            s
-0000be70: 656c 662e 6f72 7468 6f67 6f6e 616c 5f73  elf.orthogonal_s
-0000be80: 7464 2872 6177 6d61 702c 2064 6972 2c20  td(rawmap, dir, 
-0000be90: 6c61 6265 6c29 0a20 2020 2020 2020 2065  label).        e
-0000bea0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000beb0: 2070 7269 6e74 2827 4e6f 2072 6177 206d   print('No raw m
-0000bec0: 6170 2074 6f20 6361 6c63 756c 6174 6520  ap to calculate 
-0000bed0: 6f72 7468 6f67 6f6e 616c 2073 7464 2070  orthogonal std p
-0000bee0: 726f 6a65 6374 696f 6e73 2e27 290a 0a20  rojections.').. 
-0000bef0: 2020 2023 2043 656e 7472 616c 2073 6c69     # Central sli
-0000bf00: 6365 730a 0a20 2020 2023 2040 7072 6f66  ces..    # @prof
-0000bf10: 696c 650a 2020 2020 6465 6620 6365 6e74  ile.    def cent
-0000bf20: 7261 6c5f 736c 6963 6528 7365 6c66 2c20  ral_slice(self, 
-0000bf30: 6d61 7069 6e3d 4e6f 6e65 2c20 776f 726b  mapin=None, work
-0000bf40: 6469 723d 4e6f 6e65 2c20 6c61 6265 6c3d  dir=None, label=
-0000bf50: 2727 293a 0a20 2020 2020 2020 2022 2222  ''):.        """
-0000bf60: 0a20 2020 2020 2020 2020 2020 2020 5374  .             St
-0000bf70: 6420 7072 6f6a 6563 7469 6f6e 2061 6e64  d projection and
-0000bf80: 2069 7420 676c 6f77 2069 6d61 6765 0a20   it glow image. 
-0000bf90: 2020 2020 2020 203a 7061 7261 6d20 6d61         :param ma
-0000bfa0: 7069 6e3a 2049 6e70 7574 206d 6170 2065  pin: Input map e
-0000bfb0: 6974 6865 7220 6d72 6366 696c 6520 6f72  ither mrcfile or
-0000bfc0: 2066 696c 656e 616d 6520 7374 7269 6e67   filename string
-0000bfd0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-0000bfe0: 776f 726b 6469 723a 2053 7472 696e 6720  workdir: String 
-0000bff0: 6f66 2074 6865 2066 756c 6c20 776f 726b  of the full work
-0000c000: 2070 6174 680a 2020 2020 2020 2020 3a70   path.        :p
-0000c010: 6172 616d 206c 6162 656c 3a20 666f 7220  aram label: for 
-0000c020: 7261 7720 6d61 7020 7573 6520 2772 6177  raw map use 'raw
-0000c030: 5f27 0a20 2020 2020 2020 203a 7265 7475  _'.        :retu
-0000c040: 726e 3a20 4e6f 6e65 0a20 2020 2020 2020  rn: None.       
-0000c050: 2022 2222 0a0a 2020 2020 2020 2020 6d61   """..        ma
-0000c060: 702c 2077 6f72 6b64 6972 203d 2073 656c  p, workdir = sel
-0000c070: 662e 6d61 7069 6e63 6865 636b 286d 6170  f.mapincheck(map
-0000c080: 696e 2c20 776f 726b 6469 7229 0a20 2020  in, workdir).   
-0000c090: 2020 2020 206d 6170 6e61 6d65 203d 206f       mapname = o
-0000c0a0: 732e 7061 7468 2e62 6173 656e 616d 6528  s.path.basename(
-0000c0b0: 6d61 702e 6675 6c6c 6e61 6d65 2920 6966  map.fullname) if
-0000c0c0: 206d 6170 2065 6c73 6520 4e6f 6e65 0a20   map else None. 
-0000c0d0: 2020 2020 2020 2069 6620 6d61 7020 6973         if map is
-0000c0e0: 206e 6f74 204e 6f6e 6520 616e 6420 776f   not None and wo
-0000c0f0: 726b 6469 7220 6973 206e 6f74 204e 6f6e  rkdir is not Non
-0000c100: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
-0000c110: 7461 7274 203d 2074 696d 6569 742e 6465  tart = timeit.de
-0000c120: 6661 756c 745f 7469 6d65 7228 290a 2020  fault_timer().  
-0000c130: 2020 2020 2020 2020 2020 6572 726c 6973            errlis
-0000c140: 7420 3d20 5b5d 0a0a 2020 2020 2020 2020  t = []..        
-0000c150: 2020 2020 7870 726f 6a65 6374 696f 6e6e      xprojectionn
-0000c160: 616d 6520 3d20 776f 726b 6469 7220 2b20  ame = workdir + 
-0000c170: 6d61 706e 616d 6520 2b20 275f 7863 656e  mapname + '_xcen
-0000c180: 7472 616c 5f73 6c69 6365 2e6a 7065 6727  tral_slice.jpeg'
-0000c190: 0a20 2020 2020 2020 2020 2020 2078 7363  .            xsc
-0000c1a0: 616c 656e 616d 6520 3d20 776f 726b 6469  alename = workdi
-0000c1b0: 7220 2b20 6d61 706e 616d 6520 2b20 275f  r + mapname + '_
-0000c1c0: 7363 616c 6564 5f78 6365 6e74 7261 6c5f  scaled_xcentral_
-0000c1d0: 736c 6963 652e 6a70 6567 270a 2020 2020  slice.jpeg'.    
-0000c1e0: 2020 2020 2020 2020 7479 7065 203d 2027          type = '
-0000c1f0: 6365 6e74 7261 6c27 0a20 2020 2020 2020  central'.       
-0000c200: 2020 2020 2073 656c 662e 6d61 705f 746f       self.map_to
-0000c210: 5f69 6d67 286d 6170 2c20 322c 2074 7970  _img(map, 2, typ
-0000c220: 652c 2065 7272 6c69 7374 290a 0a20 2020  e, errlist)..   
-0000c230: 2020 2020 2020 2020 2079 7072 6f6a 6563           yprojec
-0000c240: 7469 6f6e 6e61 6d65 203d 2077 6f72 6b64  tionname = workd
-0000c250: 6972 202b 206d 6170 6e61 6d65 202b 2027  ir + mapname + '
-0000c260: 5f79 6365 6e74 7261 6c5f 736c 6963 652e  _ycentral_slice.
-0000c270: 6a70 6567 270a 2020 2020 2020 2020 2020  jpeg'.          
-0000c280: 2020 7973 6361 6c65 6e61 6d65 203d 2077    yscalename = w
-0000c290: 6f72 6b64 6972 202b 206d 6170 6e61 6d65  orkdir + mapname
-0000c2a0: 202b 2027 5f73 6361 6c65 645f 7963 656e   + '_scaled_ycen
-0000c2b0: 7472 616c 5f73 6c69 6365 2e6a 7065 6727  tral_slice.jpeg'
-0000c2c0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000c2d0: 662e 6d61 705f 746f 5f69 6d67 286d 6170  f.map_to_img(map
-0000c2e0: 2c20 312c 2074 7970 652c 2065 7272 6c69  , 1, type, errli
-0000c2f0: 7374 290a 0a20 2020 2020 2020 2020 2020  st)..           
-0000c300: 207a 7072 6f6a 6563 7469 6f6e 6e61 6d65   zprojectionname
-0000c310: 203d 2077 6f72 6b64 6972 202b 206d 6170   = workdir + map
-0000c320: 6e61 6d65 202b 2027 5f7a 6365 6e74 7261  name + '_zcentra
-0000c330: 6c5f 736c 6963 652e 6a70 6567 270a 2020  l_slice.jpeg'.  
-0000c340: 2020 2020 2020 2020 2020 7a73 6361 6c65            zscale
-0000c350: 6e61 6d65 203d 2077 6f72 6b64 6972 202b  name = workdir +
-0000c360: 206d 6170 6e61 6d65 202b 2027 5f73 6361   mapname + '_sca
-0000c370: 6c65 645f 7a63 656e 7472 616c 5f73 6c69  led_zcentral_sli
-0000c380: 6365 2e6a 7065 6727 0a20 2020 2020 2020  ce.jpeg'.       
-0000c390: 2020 2020 2073 656c 662e 6d61 705f 746f       self.map_to
-0000c3a0: 5f69 6d67 286d 6170 2c20 302c 2074 7970  _img(map, 0, typ
-0000c3b0: 652c 2065 7272 6c69 7374 290a 0a20 2020  e, errlist)..   
-0000c3c0: 2020 2020 2020 2020 2078 6d69 6420 3d20           xmid = 
-0000c3d0: 696e 7428 666c 6f61 7428 6d61 702e 6865  int(float(map.he
-0000c3e0: 6164 6572 2e6e 7829 202f 2032 290a 2020  ader.nx) / 2).  
-0000c3f0: 2020 2020 2020 2020 2020 796d 6964 203d            ymid =
-0000c400: 2069 6e74 2866 6c6f 6174 286d 6170 2e68   int(float(map.h
-0000c410: 6561 6465 722e 6e79 2920 2f20 3229 0a20  eader.ny) / 2). 
-0000c420: 2020 2020 2020 2020 2020 207a 6d69 6420             zmid 
-0000c430: 3d20 696e 7428 666c 6f61 7428 6d61 702e  = int(float(map.
-0000c440: 6865 6164 6572 2e6e 7a29 202f 2032 290a  header.nz) / 2).
-0000c450: 2020 2020 2020 2020 2020 2020 696e 6469              indi
-0000c460: 6365 7320 3d20 7b27 7827 3a20 786d 6964  ces = {'x': xmid
-0000c470: 2c20 2779 273a 2079 6d69 642c 2027 7a27  , 'y': ymid, 'z'
-0000c480: 3a20 7a6d 6964 7d0a 0a20 2020 2020 2020  : zmid}..       
-0000c490: 2020 2020 2062 6f74 686a 736f 6e20 3d20       bothjson = 
-0000c4a0: 6469 6374 2829 0a20 2020 2020 2020 2020  dict().         
-0000c4b0: 2020 2070 726f 6a65 6374 696f 6e6a 736f     projectionjso
-0000c4c0: 6e20 3d20 6469 6374 2829 0a20 2020 2020  n = dict().     
-0000c4d0: 2020 2020 2020 206f 7267 7072 6f6a 6563         orgprojec
-0000c4e0: 7469 6f6e 6a73 6f6e 203d 2064 6963 7428  tionjson = dict(
-0000c4f0: 290a 0a20 2020 2020 2020 2020 2020 2070  )..            p
-0000c500: 726f 6a65 6374 696f 6e6a 736f 6e5b 2778  rojectionjson['x
-0000c510: 275d 203d 206f 732e 7061 7468 2e62 6173  '] = os.path.bas
-0000c520: 656e 616d 6528 7873 6361 6c65 6e61 6d65  ename(xscalename
-0000c530: 2920 6966 206f 732e 7061 7468 2e69 7366  ) if os.path.isf
-0000c540: 696c 6528 7873 6361 6c65 6e61 6d65 2920  ile(xscalename) 
-0000c550: 656c 7365 204e 6f6e 650a 2020 2020 2020  else None.      
-0000c560: 2020 2020 2020 7072 6f6a 6563 7469 6f6e        projection
-0000c570: 6a73 6f6e 5b27 7927 5d20 3d20 6f73 2e70  json['y'] = os.p
-0000c580: 6174 682e 6261 7365 6e61 6d65 2879 7363  ath.basename(ysc
-0000c590: 616c 656e 616d 6529 2069 6620 6f73 2e70  alename) if os.p
-0000c5a0: 6174 682e 6973 6669 6c65 2879 7363 616c  ath.isfile(yscal
-0000c5b0: 656e 616d 6529 2065 6c73 6520 4e6f 6e65  ename) else None
-0000c5c0: 0a20 2020 2020 2020 2020 2020 2070 726f  .            pro
-0000c5d0: 6a65 6374 696f 6e6a 736f 6e5b 277a 275d  jectionjson['z']
-0000c5e0: 203d 206f 732e 7061 7468 2e62 6173 656e   = os.path.basen
-0000c5f0: 616d 6528 7a73 6361 6c65 6e61 6d65 2920  ame(zscalename) 
-0000c600: 6966 206f 732e 7061 7468 2e69 7366 696c  if os.path.isfil
-0000c610: 6528 7a73 6361 6c65 6e61 6d65 2920 656c  e(zscalename) el
-0000c620: 7365 204e 6f6e 650a 0a20 2020 2020 2020  se None..       
-0000c630: 2020 2020 206f 7267 7072 6f6a 6563 7469       orgprojecti
-0000c640: 6f6e 6a73 6f6e 5b27 7827 5d20 3d20 6f73  onjson['x'] = os
-0000c650: 2e70 6174 682e 6261 7365 6e61 6d65 2878  .path.basename(x
-0000c660: 7072 6f6a 6563 7469 6f6e 6e61 6d65 2920  projectionname) 
-0000c670: 6966 206f 732e 7061 7468 2e69 7366 696c  if os.path.isfil
-0000c680: 6528 7870 726f 6a65 6374 696f 6e6e 616d  e(xprojectionnam
-0000c690: 6529 2065 6c73 6520 4e6f 6e65 0a20 2020  e) else None.   
-0000c6a0: 2020 2020 2020 2020 206f 7267 7072 6f6a           orgproj
-0000c6b0: 6563 7469 6f6e 6a73 6f6e 5b27 7927 5d20  ectionjson['y'] 
-0000c6c0: 3d20 6f73 2e70 6174 682e 6261 7365 6e61  = os.path.basena
-0000c6d0: 6d65 2879 7072 6f6a 6563 7469 6f6e 6e61  me(yprojectionna
-0000c6e0: 6d65 2920 6966 206f 732e 7061 7468 2e69  me) if os.path.i
-0000c6f0: 7366 696c 6528 7970 726f 6a65 6374 696f  sfile(yprojectio
-0000c700: 6e6e 616d 6529 2065 6c73 6520 4e6f 6e65  nname) else None
-0000c710: 0a20 2020 2020 2020 2020 2020 206f 7267  .            org
-0000c720: 7072 6f6a 6563 7469 6f6e 6a73 6f6e 5b27  projectionjson['
-0000c730: 7a27 5d20 3d20 6f73 2e70 6174 682e 6261  z'] = os.path.ba
-0000c740: 7365 6e61 6d65 287a 7072 6f6a 6563 7469  sename(zprojecti
-0000c750: 6f6e 6e61 6d65 2920 6966 206f 732e 7061  onname) if os.pa
-0000c760: 7468 2e69 7366 696c 6528 7a70 726f 6a65  th.isfile(zproje
-0000c770: 6374 696f 6e6e 616d 6529 2065 6c73 6520  ctionname) else 
-0000c780: 4e6f 6e65 0a0a 2020 2020 2020 2020 2020  None..          
-0000c790: 2020 626f 7468 6a73 6f6e 5b27 6f72 6967    bothjson['orig
-0000c7a0: 696e 616c 275d 203d 206f 7267 7072 6f6a  inal'] = orgproj
-0000c7b0: 6563 7469 6f6e 6a73 6f6e 0a20 2020 2020  ectionjson.     
-0000c7c0: 2020 2020 2020 2062 6f74 686a 736f 6e5b         bothjson[
-0000c7d0: 2773 6361 6c65 6427 5d20 3d20 7072 6f6a  'scaled'] = proj
-0000c7e0: 6563 7469 6f6e 6a73 6f6e 0a20 2020 2020  ectionjson.     
-0000c7f0: 2020 2020 2020 2062 6f74 686a 736f 6e5b         bothjson[
-0000c800: 2769 6e64 6963 6573 275d 203d 2069 6e64  'indices'] = ind
-0000c810: 6963 6573 0a0a 2020 2020 2020 2020 2020  ices..          
-0000c820: 2020 6966 2065 7272 6c69 7374 3a0a 2020    if errlist:.  
-0000c830: 2020 2020 2020 2020 2020 2020 2020 626f                bo
-0000c840: 7468 6a73 6f6e 5b27 6572 7227 5d20 3d20  thjson['err'] = 
-0000c850: 7b27 6365 6e74 7261 6c5f 736c 6963 655f  {'central_slice_
-0000c860: 6572 7227 3a20 6572 726c 6973 747d 0a20  err': errlist}. 
-0000c870: 2020 2020 2020 2020 2020 2066 696e 616c             final
-0000c880: 6469 6374 203d 207b 6c61 6265 6c20 2b20  dict = {label + 
-0000c890: 2763 656e 7472 616c 5f73 6c69 6365 273a  'central_slice':
-0000c8a0: 2062 6f74 686a 736f 6e7d 0a0a 2020 2020   bothjson}..    
-0000c8b0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0000c8c0: 2020 2020 2020 2020 2020 2020 2077 6974               wit
-0000c8d0: 6820 636f 6465 6373 2e6f 7065 6e28 776f  h codecs.open(wo
-0000c8e0: 726b 6469 7220 2b20 6d61 706e 616d 6520  rkdir + mapname 
-0000c8f0: 2b20 275f 6365 6e74 7261 6c73 6c69 6365  + '_centralslice
-0000c900: 2e6a 736f 6e27 2c20 2777 272c 2065 6e63  .json', 'w', enc
-0000c910: 6f64 696e 673d 2775 7466 2d38 2729 2061  oding='utf-8') a
-0000c920: 7320 663a 0a20 2020 2020 2020 2020 2020  s f:.           
-0000c930: 2020 2020 2020 2020 206a 736f 6e2e 6475           json.du
-0000c940: 6d70 2866 696e 616c 6469 6374 2c20 6629  mp(finaldict, f)
-0000c950: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-0000c960: 6570 7420 494f 4572 726f 7220 6173 2069  ept IOError as i
-0000c970: 6f65 7272 3a0a 2020 2020 2020 2020 2020  oerr:.          
-0000c980: 2020 2020 2020 6a73 6f6e 6572 7220 3d20        jsonerr = 
-0000c990: 2753 6176 696e 6720 6365 6e74 7261 6c20  'Saving central 
-0000c9a0: 736c 6963 6520 696e 746f 206a 736f 6e20  slice into json 
-0000c9b0: 6572 726f 723a 207b 7d27 2e66 6f72 6d61  error: {}'.forma
-0000c9c0: 7428 696f 6572 7229 0a20 2020 2020 2020  t(ioerr).       
-0000c9d0: 2020 2020 2020 2020 2073 7973 2e73 7464           sys.std
-0000c9e0: 6572 722e 7772 6974 6528 6a73 6f6e 6572  err.write(jsoner
-0000c9f0: 7220 2b20 275c 6e27 290a 0a20 2020 2020  r + '\n')..     
-0000ca00: 2020 2020 2020 2065 6e64 203d 2074 696d         end = tim
-0000ca10: 6569 742e 6465 6661 756c 745f 7469 6d65  eit.default_time
-0000ca20: 7228 290a 2020 2020 2020 2020 2020 2020  r().            
-0000ca30: 7072 696e 7428 2743 656e 7472 616c 2073  print('Central s
-0000ca40: 6c69 6365 2074 696d 6520 666f 7220 2573  lice time for %s
-0000ca50: 3a20 2573 2720 2520 286d 6170 6e61 6d65  : %s' % (mapname
-0000ca60: 2c20 656e 6420 2d20 7374 6172 7429 290a  , end - start)).
-0000ca70: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0000ca80: 7428 272d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  t('-------------
-0000ca90: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0000caa0: 2d2d 2d2d 2d2d 2d27 290a 0a20 2020 2020  -------')..     
-0000cab0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000cac0: 2020 2020 2070 7269 6e74 280a 2020 2020       print(.    
-0000cad0: 2020 2020 2020 2020 2020 2020 274e 6f20              'No 
-0000cae0: 6365 6e74 7261 6c20 736c 6963 6520 7769  central slice wi
-0000caf0: 7468 6f75 7420 7072 6f70 6572 206d 6170  thout proper map
-0000cb00: 2069 6e70 7574 2061 6e64 2074 6865 206f   input and the o
-0000cb10: 7574 7075 7420 6469 7265 6374 6f72 7920  utput directory 
-0000cb20: 696e 666f 726d 6174 696f 6e2e 2729 0a0a  information.')..
-0000cb30: 2020 2020 2020 2020 7265 7475 726e 204e          return N
-0000cb40: 6f6e 650a 0a20 2020 2064 6566 2072 6177  one..    def raw
-0000cb50: 6d61 705f 6365 6e74 7261 6c5f 736c 6963  map_central_slic
-0000cb60: 6528 7365 6c66 293a 0a0a 2020 2020 2020  e(self):..      
-0000cb70: 2020 7261 776d 6170 203d 2073 656c 662e    rawmap = self.
-0000cb80: 7261 776d 6170 0a20 2020 2020 2020 2069  rawmap.        i
-0000cb90: 6620 7261 776d 6170 2069 7320 6e6f 7420  f rawmap is not 
-0000cba0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0000cbb0: 2020 6469 7220 3d20 7365 6c66 2e77 6f72    dir = self.wor
-0000cbc0: 6b64 6972 0a20 2020 2020 2020 2020 2020  kdir.           
-0000cbd0: 206c 6162 656c 203d 2027 7261 776d 6170   label = 'rawmap
-0000cbe0: 5f27 0a20 2020 2020 2020 2020 2020 2073  _'.            s
-0000cbf0: 656c 662e 6365 6e74 7261 6c5f 736c 6963  elf.central_slic
-0000cc00: 6528 7261 776d 6170 2c20 6469 722c 206c  e(rawmap, dir, l
-0000cc10: 6162 656c 290a 2020 2020 2020 2020 656c  abel).        el
-0000cc20: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0000cc30: 7072 696e 7428 274e 6f20 7261 7720 6d61  print('No raw ma
-0000cc40: 7020 746f 2063 616c 6375 6c61 7465 2063  p to calculate c
-0000cc50: 656e 7472 616c 2073 6c69 6365 2e27 290a  entral slice.').
-0000cc60: 0a20 2020 2023 2040 7072 6f66 696c 650a  .    # @profile.
-0000cc70: 2020 2020 6465 6620 7261 776d 6170 5f6c      def rawmap_l
-0000cc80: 6172 6765 7374 5f76 6172 6961 6e63 6528  argest_variance(
-0000cc90: 7365 6c66 293a 0a0a 2020 2020 2020 2020  self):..        
-0000cca0: 7261 776d 6170 203d 2073 656c 662e 7261  rawmap = self.ra
-0000ccb0: 776d 6170 0a20 2020 2020 2020 2069 6620  wmap.        if 
-0000ccc0: 7261 776d 6170 2069 7320 6e6f 7420 4e6f  rawmap is not No
-0000ccd0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0000cce0: 6469 7220 3d20 7365 6c66 2e77 6f72 6b64  dir = self.workd
-0000ccf0: 6972 0a20 2020 2020 2020 2020 2020 206c  ir.            l
-0000cd00: 6162 656c 203d 2022 7261 776d 6170 5f22  abel = "rawmap_"
-0000cd10: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000cd20: 662e 6c61 7267 6573 745f 7661 7269 616e  f.largest_varian
-0000cd30: 6365 2872 6177 6d61 702c 2064 6972 2c20  ce(rawmap, dir, 
-0000cd40: 6c61 6265 6c29 0a20 2020 2020 2020 2065  label).        e
-0000cd50: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0000cd60: 2070 7269 6e74 2827 4e6f 2072 6177 206d   print('No raw m
-0000cd70: 6170 2074 6f20 6361 6c63 756c 6174 6520  ap to calculate 
-0000cd80: 6c61 7267 6573 7420 7661 7269 616e 6365  largest variance
-0000cd90: 2e27 290a 0a20 2020 2020 2020 2072 6574  .')..        ret
-0000cda0: 7572 6e20 4e6f 6e65 0a0a 2020 2020 2320  urn None..    # 
-0000cdb0: 4070 726f 6669 6c65 0a20 2020 2064 6566  @profile.    def
-0000cdc0: 206c 6172 6765 7374 5f76 6172 6961 6e63   largest_varianc
-0000cdd0: 6528 7365 6c66 2c20 6d61 7069 6e3d 4e6f  e(self, mapin=No
-0000cde0: 6e65 2c20 776f 726b 6469 723d 4e6f 6e65  ne, workdir=None
-0000cdf0: 2c20 6c61 6265 6c3d 2727 293a 0a20 2020  , label=''):.   
-0000ce00: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-0000ce10: 2020 2020 2020 4c61 7267 6573 7420 7661        Largest va
-0000ce20: 7269 616e 6365 0a20 2020 2020 2020 203a  riance.        :
-0000ce30: 7061 7261 6d20 6d61 7069 6e3a 2049 6e70  param mapin: Inp
-0000ce40: 7574 206d 6170 2065 6974 6865 7220 6d72  ut map either mr
-0000ce50: 6366 696c 6520 6f72 2066 696c 656e 616d  cfile or filenam
-0000ce60: 6520 7374 7269 6e67 0a20 2020 2020 2020  e string.       
-0000ce70: 203a 7061 7261 6d20 776f 726b 6469 723a   :param workdir:
-0000ce80: 2053 7472 696e 6720 6f66 2074 6865 2066   String of the f
-0000ce90: 756c 6c20 776f 726b 2070 6174 680a 2020  ull work path.  
-0000cea0: 2020 2020 2020 3a70 6172 616d 206c 6162        :param lab
-0000ceb0: 656c 3a20 666f 7220 7261 7720 6d61 7020  el: for raw map 
-0000cec0: 7573 6520 2772 6177 5f27 0a20 2020 2020  use 'raw_'.     
-0000ced0: 2020 203a 7265 7475 726e 3a20 4e6f 6e65     :return: None
-0000cee0: 0a20 2020 2020 2020 2022 2222 0a0a 2020  .        """..  
-0000cef0: 2020 2020 2020 6d61 702c 2077 6f72 6b64        map, workd
-0000cf00: 6972 203d 2073 656c 662e 6d61 7069 6e63  ir = self.mapinc
-0000cf10: 6865 636b 286d 6170 696e 2c20 776f 726b  heck(mapin, work
-0000cf20: 6469 7229 0a20 2020 2020 2020 206d 6170  dir).        map
-0000cf30: 6e61 6d65 203d 206f 732e 7061 7468 2e62  name = os.path.b
-0000cf40: 6173 656e 616d 6528 6d61 702e 6675 6c6c  asename(map.full
-0000cf50: 6e61 6d65 2920 6966 206d 6170 2065 6c73  name) if map els
-0000cf60: 6520 4e6f 6e65 0a20 2020 2020 2020 2069  e None.        i
-0000cf70: 6620 6d61 7020 6973 206e 6f74 204e 6f6e  f map is not Non
-0000cf80: 6520 616e 6420 776f 726b 6469 7220 6973  e and workdir is
-0000cf90: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-0000cfa0: 2020 2020 2020 207a 6c69 6d2c 2079 6c69         zlim, yli
-0000cfb0: 6d2c 2078 6c69 6d20 3d20 6d61 702e 6461  m, xlim = map.da
-0000cfc0: 7461 2e73 6861 7065 0a20 2020 2020 2020  ta.shape.       
-0000cfd0: 2020 2020 2073 7461 7274 203d 2074 696d       start = tim
-0000cfe0: 6569 742e 6465 6661 756c 745f 7469 6d65  eit.default_time
-0000cff0: 7228 290a 2020 2020 2020 2020 2020 2020  r().            
-0000d000: 6572 726c 6973 7420 3d20 5b5d 0a20 2020  errlist = [].   
-0000d010: 2020 2020 2020 2020 2074 7970 6520 3d20           type = 
-0000d020: 276c 6172 6765 7374 7661 7269 616e 6365  'largestvariance
-0000d030: 270a 0a20 2020 2020 2020 2020 2020 2078  '..            x
-0000d040: 7072 6f6a 6563 7469 6f6e 6e61 6d65 203d  projectionname =
-0000d050: 2077 6f72 6b64 6972 202b 206d 6170 6e61   workdir + mapna
-0000d060: 6d65 202b 2027 5f78 6c61 7267 6573 7476  me + '_xlargestv
-0000d070: 6172 6961 6e63 655f 736c 6963 652e 6a70  ariance_slice.jp
-0000d080: 6567 270a 2020 2020 2020 2020 2020 2020  eg'.            
-0000d090: 7873 6361 6c65 6e61 6d65 203d 2077 6f72  xscalename = wor
-0000d0a0: 6b64 6972 202b 206d 6170 6e61 6d65 202b  kdir + mapname +
-0000d0b0: 2027 5f73 6361 6c65 645f 786c 6172 6765   '_scaled_xlarge
-0000d0c0: 7374 7661 7269 616e 6365 5f73 6c69 6365  stvariance_slice
-0000d0d0: 2e6a 7065 6727 0a20 2020 2020 2020 2020  .jpeg'.         
-0000d0e0: 2020 2073 656c 662e 6d61 705f 746f 5f69     self.map_to_i
-0000d0f0: 6d67 286d 6170 2c20 322c 2074 7970 652c  mg(map, 2, type,
-0000d100: 2065 7272 6c69 7374 290a 0a20 2020 2020   errlist)..     
-0000d110: 2020 2020 2020 2079 7072 6f6a 6563 7469         yprojecti
-0000d120: 6f6e 6e61 6d65 203d 2077 6f72 6b64 6972  onname = workdir
-0000d130: 202b 206d 6170 6e61 6d65 202b 2027 5f79   + mapname + '_y
-0000d140: 6c61 7267 6573 7476 6172 6961 6e63 655f  largestvariance_
-0000d150: 736c 6963 652e 6a70 6567 270a 2020 2020  slice.jpeg'.    
-0000d160: 2020 2020 2020 2020 7973 6361 6c65 6e61          yscalena
-0000d170: 6d65 203d 2077 6f72 6b64 6972 202b 206d  me = workdir + m
-0000d180: 6170 6e61 6d65 202b 2027 5f73 6361 6c65  apname + '_scale
-0000d190: 645f 796c 6172 6765 7374 7661 7269 616e  d_ylargestvarian
-0000d1a0: 6365 5f73 6c69 6365 2e6a 7065 6727 0a20  ce_slice.jpeg'. 
-0000d1b0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000d1c0: 6d61 705f 746f 5f69 6d67 286d 6170 2c20  map_to_img(map, 
-0000d1d0: 312c 2074 7970 652c 2065 7272 6c69 7374  1, type, errlist
-0000d1e0: 290a 0a20 2020 2020 2020 2020 2020 207a  )..            z
-0000d1f0: 7072 6f6a 6563 7469 6f6e 6e61 6d65 203d  projectionname =
-0000d200: 2077 6f72 6b64 6972 202b 206d 6170 6e61   workdir + mapna
-0000d210: 6d65 202b 2027 5f7a 6c61 7267 6573 7476  me + '_zlargestv
-0000d220: 6172 6961 6e63 655f 736c 6963 652e 6a70  ariance_slice.jp
-0000d230: 6567 270a 2020 2020 2020 2020 2020 2020  eg'.            
-0000d240: 7a73 6361 6c65 6e61 6d65 203d 2077 6f72  zscalename = wor
-0000d250: 6b64 6972 202b 206d 6170 6e61 6d65 202b  kdir + mapname +
-0000d260: 2027 5f73 6361 6c65 645f 7a6c 6172 6765   '_scaled_zlarge
-0000d270: 7374 7661 7269 616e 6365 5f73 6c69 6365  stvariance_slice
-0000d280: 2e6a 7065 6727 0a20 2020 2020 2020 2020  .jpeg'.         
-0000d290: 2020 2073 656c 662e 6d61 705f 746f 5f69     self.map_to_i
-0000d2a0: 6d67 286d 6170 2c20 302c 2074 7970 652c  mg(map, 0, type,
-0000d2b0: 2065 7272 6c69 7374 290a 0a20 2020 2020   errlist)..     
-0000d2c0: 2020 2020 2020 2078 7661 7220 3d20 5b6e         xvar = [n
-0000d2d0: 6469 6d61 6765 2e76 6172 6961 6e63 6528  dimage.variance(
-0000d2e0: 6d61 702e 6461 7461 5b3a 2c20 3a2c 2069  map.data[:, :, i
-0000d2f0: 5d29 2066 6f72 2069 2069 6e20 7261 6e67  ]) for i in rang
-0000d300: 6528 302c 2078 6c69 6d29 5d0a 2020 2020  e(0, xlim)].    
-0000d310: 2020 2020 2020 2020 7976 6172 203d 205b          yvar = [
-0000d320: 6e64 696d 6167 652e 7661 7269 616e 6365  ndimage.variance
-0000d330: 286d 6170 2e64 6174 615b 3a2c 2069 2c20  (map.data[:, i, 
-0000d340: 3a5d 2920 666f 7220 6920 696e 2072 616e  :]) for i in ran
-0000d350: 6765 2830 2c20 796c 696d 295d 0a20 2020  ge(0, ylim)].   
-0000d360: 2020 2020 2020 2020 207a 7661 7220 3d20           zvar = 
-0000d370: 5b6e 6469 6d61 6765 2e76 6172 6961 6e63  [ndimage.varianc
-0000d380: 6528 6d61 702e 6461 7461 5b69 2c20 3a2c  e(map.data[i, :,
-0000d390: 203a 5d29 2066 6f72 2069 2069 6e20 7261   :]) for i in ra
-0000d3a0: 6e67 6528 302c 207a 6c69 6d29 5d0a 2020  nge(0, zlim)].  
-0000d3b0: 2020 2020 2020 2020 2020 786c 6172 6765            xlarge
-0000d3c0: 696e 6420 3d20 696e 7428 6e70 2e61 7267  ind = int(np.arg
-0000d3d0: 6d61 7828 7876 6172 2929 0a20 2020 2020  max(xvar)).     
-0000d3e0: 2020 2020 2020 2079 6c61 7267 6569 6e64         ylargeind
-0000d3f0: 203d 2069 6e74 286e 702e 6172 676d 6178   = int(np.argmax
-0000d400: 2879 7661 7229 290a 2020 2020 2020 2020  (yvar)).        
-0000d410: 2020 2020 7a6c 6172 6765 696e 6420 3d20      zlargeind = 
-0000d420: 696e 7428 6e70 2e61 7267 6d61 7828 7a76  int(np.argmax(zv
-0000d430: 6172 2929 0a0a 2020 2020 2020 2020 2020  ar))..          
-0000d440: 2020 626f 7468 6a73 6f6e 203d 2064 6963    bothjson = dic
-0000d450: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
-0000d460: 7072 6f6a 6563 7469 6f6e 6a73 6f6e 203d  projectionjson =
-0000d470: 2064 6963 7428 290a 2020 2020 2020 2020   dict().        
-0000d480: 2020 2020 6f72 6770 726f 6a65 6374 696f      orgprojectio
-0000d490: 6e6a 736f 6e20 3d20 6469 6374 2829 0a0a  njson = dict()..
-0000d4a0: 2020 2020 2020 2020 2020 2020 7072 6f6a              proj
-0000d4b0: 6563 7469 6f6e 6a73 6f6e 5b27 7827 5d20  ectionjson['x'] 
-0000d4c0: 3d20 6f73 2e70 6174 682e 6261 7365 6e61  = os.path.basena
-0000d4d0: 6d65 2878 7363 616c 656e 616d 6529 2069  me(xscalename) i
-0000d4e0: 6620 6f73 2e70 6174 682e 6973 6669 6c65  f os.path.isfile
-0000d4f0: 2878 7363 616c 656e 616d 6529 2065 6c73  (xscalename) els
-0000d500: 6520 4e6f 6e65 0a20 2020 2020 2020 2020  e None.         
-0000d510: 2020 2070 726f 6a65 6374 696f 6e6a 736f     projectionjso
-0000d520: 6e5b 2779 275d 203d 206f 732e 7061 7468  n['y'] = os.path
-0000d530: 2e62 6173 656e 616d 6528 7973 6361 6c65  .basename(yscale
-0000d540: 6e61 6d65 2920 6966 206f 732e 7061 7468  name) if os.path
-0000d550: 2e69 7366 696c 6528 7973 6361 6c65 6e61  .isfile(yscalena
-0000d560: 6d65 2920 656c 7365 204e 6f6e 650a 2020  me) else None.  
-0000d570: 2020 2020 2020 2020 2020 7072 6f6a 6563            projec
-0000d580: 7469 6f6e 6a73 6f6e 5b27 7a27 5d20 3d20  tionjson['z'] = 
-0000d590: 6f73 2e70 6174 682e 6261 7365 6e61 6d65  os.path.basename
-0000d5a0: 287a 7363 616c 656e 616d 6529 2069 6620  (zscalename) if 
-0000d5b0: 6f73 2e70 6174 682e 6973 6669 6c65 287a  os.path.isfile(z
-0000d5c0: 7363 616c 656e 616d 6529 2065 6c73 6520  scalename) else 
-0000d5d0: 4e6f 6e65 0a0a 2020 2020 2020 2020 2020  None..          
-0000d5e0: 2020 6f72 6770 726f 6a65 6374 696f 6e6a    orgprojectionj
-0000d5f0: 736f 6e5b 2778 275d 203d 206f 732e 7061  son['x'] = os.pa
-0000d600: 7468 2e62 6173 656e 616d 6528 7870 726f  th.basename(xpro
-0000d610: 6a65 6374 696f 6e6e 616d 6529 2069 6620  jectionname) if 
-0000d620: 6f73 2e70 6174 682e 6973 6669 6c65 2878  os.path.isfile(x
-0000d630: 7072 6f6a 6563 7469 6f6e 6e61 6d65 2920  projectionname) 
-0000d640: 656c 7365 204e 6f6e 650a 2020 2020 2020  else None.      
-0000d650: 2020 2020 2020 6f72 6770 726f 6a65 6374        orgproject
-0000d660: 696f 6e6a 736f 6e5b 2779 275d 203d 206f  ionjson['y'] = o
-0000d670: 732e 7061 7468 2e62 6173 656e 616d 6528  s.path.basename(
-0000d680: 7970 726f 6a65 6374 696f 6e6e 616d 6529  yprojectionname)
-0000d690: 2069 6620 6f73 2e70 6174 682e 6973 6669   if os.path.isfi
-0000d6a0: 6c65 2879 7072 6f6a 6563 7469 6f6e 6e61  le(yprojectionna
-0000d6b0: 6d65 2920 656c 7365 204e 6f6e 650a 2020  me) else None.  
-0000d6c0: 2020 2020 2020 2020 2020 6f72 6770 726f            orgpro
-0000d6d0: 6a65 6374 696f 6e6a 736f 6e5b 277a 275d  jectionjson['z']
-0000d6e0: 203d 206f 732e 7061 7468 2e62 6173 656e   = os.path.basen
-0000d6f0: 616d 6528 7a70 726f 6a65 6374 696f 6e6e  ame(zprojectionn
-0000d700: 616d 6529 2069 6620 6f73 2e70 6174 682e  ame) if os.path.
-0000d710: 6973 6669 6c65 287a 7072 6f6a 6563 7469  isfile(zprojecti
-0000d720: 6f6e 6e61 6d65 2920 656c 7365 204e 6f6e  onname) else Non
-0000d730: 650a 0a20 2020 2020 2020 2020 2020 2062  e..            b
-0000d740: 6f74 686a 736f 6e5b 276f 7269 6769 6e61  othjson['origina
-0000d750: 6c27 5d20 3d20 6f72 6770 726f 6a65 6374  l'] = orgproject
-0000d760: 696f 6e6a 736f 6e0a 2020 2020 2020 2020  ionjson.        
-0000d770: 2020 2020 626f 7468 6a73 6f6e 5b27 7363      bothjson['sc
-0000d780: 616c 6564 275d 203d 2070 726f 6a65 6374  aled'] = project
-0000d790: 696f 6e6a 736f 6e0a 2020 2020 2020 2020  ionjson.        
-0000d7a0: 2020 2020 626f 7468 6a73 6f6e 5b27 696e      bothjson['in
-0000d7b0: 6469 6365 7327 5d20 3d20 7b27 7827 3a20  dices'] = {'x': 
-0000d7c0: 786c 6172 6765 696e 642c 2027 7927 3a20  xlargeind, 'y': 
-0000d7d0: 796c 6172 6765 696e 642c 2027 7a27 3a20  ylargeind, 'z': 
-0000d7e0: 7a6c 6172 6765 696e 647d 0a0a 2020 2020  zlargeind}..    
-0000d7f0: 2020 2020 2020 2020 6966 2065 7272 6c69          if errli
-0000d800: 7374 3a0a 2020 2020 2020 2020 2020 2020  st:.            
-0000d810: 2020 2020 626f 7468 6a73 6f6e 5b27 6572      bothjson['er
-0000d820: 7227 5d20 3d20 7b27 6c61 7267 6573 745f  r'] = {'largest_
-0000d830: 7661 7269 616e 6365 5f65 7272 273a 2065  variance_err': e
-0000d840: 7272 6c69 7374 7d0a 2020 2020 2020 2020  rrlist}.        
-0000d850: 2020 2020 6669 6e61 6c64 6963 7420 3d20      finaldict = 
-0000d860: 7b6c 6162 656c 202b 2027 6c61 7267 6573  {label + 'larges
-0000d870: 745f 7661 7269 616e 6365 5f73 6c69 6365  t_variance_slice
-0000d880: 273a 2062 6f74 686a 736f 6e7d 0a0a 2020  ': bothjson}..  
-0000d890: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-0000d8a0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-0000d8b0: 6974 6820 636f 6465 6373 2e6f 7065 6e28  ith codecs.open(
-0000d8c0: 776f 726b 6469 7220 2b20 6d61 706e 616d  workdir + mapnam
-0000d8d0: 6520 2b20 275f 6c61 7267 6573 7476 6172  e + '_largestvar
-0000d8e0: 6961 6e63 652e 6a73 6f6e 272c 2027 7727  iance.json', 'w'
-0000d8f0: 2c20 656e 636f 6469 6e67 3d27 7574 662d  , encoding='utf-
-0000d900: 3827 2920 6173 2066 3a0a 2020 2020 2020  8') as f:.      
-0000d910: 2020 2020 2020 2020 2020 2020 2020 6a73                js
-0000d920: 6f6e 2e64 756d 7028 6669 6e61 6c64 6963  on.dump(finaldic
-0000d930: 742c 2066 290a 2020 2020 2020 2020 2020  t, f).          
-0000d940: 2020 6578 6365 7074 2049 4f45 7272 6f72    except IOError
-0000d950: 2061 7320 696f 6572 723a 0a20 2020 2020   as ioerr:.     
-0000d960: 2020 2020 2020 2020 2020 206a 736f 6e65             jsone
-0000d970: 7272 203d 2027 5361 7669 6e67 206c 6172  rr = 'Saving lar
-0000d980: 6765 7374 2076 6172 6961 6e63 6520 696e  gest variance in
-0000d990: 746f 206a 736f 6e20 6572 726f 723a 207b  to json error: {
-0000d9a0: 7d27 2e66 6f72 6d61 7428 696f 6572 7229  }'.format(ioerr)
-0000d9b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d9c0: 2073 7973 2e73 7464 6572 722e 7772 6974   sys.stderr.writ
-0000d9d0: 6528 6a73 6f6e 6572 7220 2b20 275c 6e27  e(jsonerr + '\n'
-0000d9e0: 290a 0a20 2020 2020 2020 2020 2020 2065  )..            e
-0000d9f0: 6e64 203d 2074 696d 6569 742e 6465 6661  nd = timeit.defa
-0000da00: 756c 745f 7469 6d65 7228 290a 2020 2020  ult_timer().    
-0000da10: 2020 2020 2020 2020 7072 696e 7428 274c          print('L
-0000da20: 6172 6765 7374 2076 6172 6961 6e63 6520  argest variance 
-0000da30: 7469 6d65 2066 6f72 2025 733a 2025 7327  time for %s: %s'
-0000da40: 2025 2028 6d61 706e 616d 652c 2065 6e64   % (mapname, end
-0000da50: 202d 2073 7461 7274 2929 0a20 2020 2020   - start)).     
-0000da60: 2020 2020 2020 2070 7269 6e74 2827 2d2d         print('--
-0000da70: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0000da80: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0000da90: 2d2d 2729 0a0a 2020 2020 2020 2020 656c  --')..        el
-0000daa0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0000dab0: 7072 696e 7428 0a20 2020 2020 2020 2020  print(.         
-0000dac0: 2020 2020 2020 2027 4e6f 206c 6172 6765         'No large
-0000dad0: 7374 2076 6172 6961 6e63 6520 7769 7468  st variance with
-0000dae0: 6f75 7420 7072 6f70 6572 206d 6170 2069  out proper map i
-0000daf0: 6e70 7574 2061 6e64 2074 6865 206f 7574  nput and the out
-0000db00: 7075 7420 6469 7265 6374 6f72 7920 696e  put directory in
-0000db10: 666f 726d 6174 696f 6e2e 2729 0a0a 2020  formation.')..  
-0000db20: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
-0000db30: 650a 0a20 2020 2023 2040 7072 6f66 696c  e..    # @profil
-0000db40: 650a 2020 2020 6465 6620 7375 7266 6163  e.    def surfac
-0000db50: 6573 2873 656c 6629 3a0a 2020 2020 2020  es(self):.      
-0000db60: 2020 2222 220a 0a20 2020 2020 2020 2020    """..         
-0000db70: 2020 2050 726f 7564 696e 6720 616c 6c20     Prouding all 
-0000db80: 7468 6520 7375 7266 6163 6520 7265 6c61  the surface rela
-0000db90: 7465 6420 696d 6167 6573 2068 6572 650a  ted images here.
-0000dba0: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-0000dbb0: 3a0a 2020 2020 2020 2020 2222 220a 0a20  :.        """.. 
-0000dbc0: 2020 2020 2020 2076 746b 7061 636b 2c20         vtkpack, 
-0000dbd0: 6368 696d 6572 6161 7070 203d 2073 656c  chimeraapp = sel
-0000dbe0: 662e 7375 7266 6163 655f 656e 7663 6865  f.surface_envche
-0000dbf0: 636b 2829 0a20 2020 2020 2020 2069 6620  ck().        if 
-0000dc00: 7365 6c66 2e6d 6f64 656c 7320 6973 206e  self.models is n
-0000dc10: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-0000dc20: 2020 2020 2073 7566 6368 6563 6b20 3d20       sufcheck = 
-0000dc30: 5b46 616c 7365 2069 6620 6d6f 6465 6c2e  [False if model.
-0000dc40: 6669 6c65 6e61 6d65 2e65 6e64 7377 6974  filename.endswit
-0000dc50: 6828 272e 7064 6227 2920 656c 7365 2054  h('.pdb') else T
-0000dc60: 7275 6520 666f 7220 6d6f 6465 6c20 696e  rue for model in
-0000dc70: 2073 656c 662e 6d6f 6465 6c73 5d0a 2020   self.models].  
-0000dc80: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0000dc90: 2020 2020 2020 2020 7375 6663 6865 636b          sufcheck
-0000dca0: 203d 205b 5472 7565 5d0a 2020 2020 2020   = [True].      
-0000dcb0: 2020 2320 4164 6420 6966 206d 6f64 656c    # Add if model
-0000dcc0: 2069 7320 6369 6620 7573 696e 6720 6368   is cif using ch
-0000dcd0: 696d 6572 6120 666f 7220 6e6f 770a 2020  imera for now.  
-0000dce0: 2020 2020 2020 6966 2073 656c 662e 636c        if self.cl
-0000dcf0: 2069 7320 6e6f 7420 4e6f 6e65 2061 6e64   is not None and
-0000dd00: 2073 656c 662e 6d65 7420 213d 2027 746f   self.met != 'to
-0000dd10: 6d6f 273a 0a20 2020 2020 2020 2020 2020  mo':.           
-0000dd20: 2069 6620 7674 6b70 6163 6b20 616e 6420   if vtkpack and 
-0000dd30: 4661 6c73 6520 696e 2073 7566 6368 6563  False in sufchec
-0000dd40: 6b3a 0a20 2020 2020 2020 2020 2020 2020  k:.             
-0000dd50: 2020 2073 656c 662e 7375 7266 6163 6576     self.surfacev
-0000dd60: 6965 7728 290a 2020 2020 2020 2020 2020  iew().          
-0000dd70: 2020 656c 6966 2063 6869 6d65 7261 6170    elif chimeraap
-0000dd80: 703a 0a20 2020 2020 2020 2020 2020 2020  p:.             
-0000dd90: 2020 2073 656c 662e 7375 7266 6163 6576     self.surfacev
-0000dda0: 6965 775f 6368 696d 6572 6128 6368 696d  iew_chimera(chim
-0000ddb0: 6572 6161 7070 290a 2020 2020 2020 2020  eraapp).        
-0000ddc0: 2020 2020 2020 2020 7365 6c66 2e72 6177          self.raw
-0000ddd0: 6d61 7073 7572 6661 6365 5f63 6869 6d65  mapsurface_chime
-0000dde0: 7261 2863 6869 6d65 7261 6170 7029 0a20  ra(chimeraapp). 
-0000ddf0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0000de00: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0000de10: 2020 2020 2020 2020 7365 6c66 2e6d 6f64          self.mod
-0000de20: 656c 6669 7473 7572 6661 6365 2863 6869  elfitsurface(chi
-0000de30: 6d65 7261 6170 7029 0a20 2020 2020 2020  meraapp).       
-0000de40: 2020 2020 2020 2020 2065 7863 6570 743a           except:
-0000de50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000de60: 2020 2020 2070 7269 6e74 2827 4e6f 206d       print('No m
-0000de70: 6f64 656c 2066 6974 2073 7572 6661 6365  odel fit surface
-0000de80: 2076 6965 7720 666f 7220 7777 7064 6220   view for wwpdb 
-0000de90: 706c 6174 666f 726d 2e27 290a 2020 2020  platform.').    
-0000dea0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0000deb0: 2020 2020 2020 2020 2020 2020 2020 7379                sy
-0000dec0: 732e 7374 6465 7272 2e77 7269 7465 2827  s.stderr.write('
-0000ded0: 4e6f 2070 726f 7065 7220 5654 4b20 6f72  No proper VTK or
-0000dee0: 2043 6869 6d65 7261 2063 616e 2062 6520   Chimera can be 
-0000def0: 7573 6564 2066 6f72 2070 726f 6475 6369  used for produci
-0000df00: 6e67 2073 7572 6661 6365 2076 6965 772e  ng surface view.
-0000df10: 2050 6c65 6173 6520 6368 6563 6b2e 5c6e   Please check.\n
-0000df20: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
-0000df30: 2020 2070 7269 6e74 2827 2d2d 2d2d 2d2d     print('------
-0000df40: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0000df50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2729  --------------')
+000092e0: 7365 6c66 2e6d 6170 5f74 6f5f 696d 6728  self.map_to_img(
+000092f0: 6d61 702c 2030 2c20 7479 7065 2c20 6572  map, 0, type, er
+00009300: 726c 6973 7429 0a0a 2020 2020 2020 2020  rlist)..        
+00009310: 2020 2020 2020 2020 626f 7468 6a73 6f6e          bothjson
+00009320: 203d 2064 6963 7428 290a 2020 2020 2020   = dict().      
+00009330: 2020 2020 2020 2020 2020 7072 6f6a 6563            projec
+00009340: 7469 6f6e 6a73 6f6e 203d 2064 6963 7428  tionjson = dict(
+00009350: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00009360: 2020 6f72 6770 726f 6a65 6374 696f 6e6a    orgprojectionj
+00009370: 736f 6e20 3d20 6469 6374 2829 0a0a 2020  son = dict()..  
+00009380: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+00009390: 6f6a 6563 7469 6f6e 6a73 6f6e 5b27 7827  ojectionjson['x'
+000093a0: 5d20 3d20 6f73 2e70 6174 682e 6261 7365  ] = os.path.base
+000093b0: 6e61 6d65 2878 7363 616c 656e 616d 6529  name(xscalename)
+000093c0: 2069 6620 6f73 2e70 6174 682e 6973 6669   if os.path.isfi
+000093d0: 6c65 2878 7363 616c 656e 616d 6529 2065  le(xscalename) e
+000093e0: 6c73 6520 4e6f 6e65 0a20 2020 2020 2020  lse None.       
+000093f0: 2020 2020 2020 2020 2070 726f 6a65 6374           project
+00009400: 696f 6e6a 736f 6e5b 2779 275d 203d 206f  ionjson['y'] = o
+00009410: 732e 7061 7468 2e62 6173 656e 616d 6528  s.path.basename(
+00009420: 7973 6361 6c65 6e61 6d65 2920 6966 206f  yscalename) if o
+00009430: 732e 7061 7468 2e69 7366 696c 6528 7973  s.path.isfile(ys
+00009440: 6361 6c65 6e61 6d65 2920 656c 7365 204e  calename) else N
+00009450: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+00009460: 2020 2020 7072 6f6a 6563 7469 6f6e 6a73      projectionjs
+00009470: 6f6e 5b27 7a27 5d20 3d20 6f73 2e70 6174  on['z'] = os.pat
+00009480: 682e 6261 7365 6e61 6d65 287a 7363 616c  h.basename(zscal
+00009490: 656e 616d 6529 2069 6620 6f73 2e70 6174  ename) if os.pat
+000094a0: 682e 6973 6669 6c65 287a 7363 616c 656e  h.isfile(zscalen
+000094b0: 616d 6529 2065 6c73 6520 4e6f 6e65 0a0a  ame) else None..
+000094c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000094d0: 6f72 6770 726f 6a65 6374 696f 6e6a 736f  orgprojectionjso
+000094e0: 6e5b 2778 275d 203d 206f 732e 7061 7468  n['x'] = os.path
+000094f0: 2e62 6173 656e 616d 6528 7870 726f 6a65  .basename(xproje
+00009500: 6374 696f 6e6e 616d 6529 2069 6620 6f73  ctionname) if os
+00009510: 2e70 6174 682e 6973 6669 6c65 2878 7072  .path.isfile(xpr
+00009520: 6f6a 6563 7469 6f6e 6e61 6d65 2920 656c  ojectionname) el
+00009530: 7365 204e 6f6e 650a 2020 2020 2020 2020  se None.        
+00009540: 2020 2020 2020 2020 6f72 6770 726f 6a65          orgproje
+00009550: 6374 696f 6e6a 736f 6e5b 2779 275d 203d  ctionjson['y'] =
+00009560: 206f 732e 7061 7468 2e62 6173 656e 616d   os.path.basenam
+00009570: 6528 7970 726f 6a65 6374 696f 6e6e 616d  e(yprojectionnam
+00009580: 6529 2069 6620 6f73 2e70 6174 682e 6973  e) if os.path.is
+00009590: 6669 6c65 2879 7072 6f6a 6563 7469 6f6e  file(yprojection
+000095a0: 6e61 6d65 2920 656c 7365 204e 6f6e 650a  name) else None.
+000095b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000095c0: 6f72 6770 726f 6a65 6374 696f 6e6a 736f  orgprojectionjso
+000095d0: 6e5b 277a 275d 203d 206f 732e 7061 7468  n['z'] = os.path
+000095e0: 2e62 6173 656e 616d 6528 7a70 726f 6a65  .basename(zproje
+000095f0: 6374 696f 6e6e 616d 6529 2069 6620 6f73  ctionname) if os
+00009600: 2e70 6174 682e 6973 6669 6c65 287a 7072  .path.isfile(zpr
+00009610: 6f6a 6563 7469 6f6e 6e61 6d65 2920 656c  ojectionname) el
+00009620: 7365 204e 6f6e 650a 0a20 2020 2020 2020  se None..       
+00009630: 2020 2020 2020 2020 2062 6f74 686a 736f           bothjso
+00009640: 6e5b 276f 7269 6769 6e61 6c27 5d20 3d20  n['original'] = 
+00009650: 6f72 6770 726f 6a65 6374 696f 6e6a 736f  orgprojectionjso
+00009660: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
+00009670: 2020 626f 7468 6a73 6f6e 5b27 7363 616c    bothjson['scal
+00009680: 6564 275d 203d 2070 726f 6a65 6374 696f  ed'] = projectio
+00009690: 6e6a 736f 6e0a 0a20 2020 2020 2020 2020  njson..         
+000096a0: 2020 2020 2020 2069 6620 6572 726c 6973         if errlis
+000096b0: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+000096c0: 2020 2020 2020 2062 6f74 686a 736f 6e5b         bothjson[
+000096d0: 2765 7272 275d 203d 207b 276f 7274 686f  'err'] = {'ortho
+000096e0: 676f 6e61 6c5f 6d65 6469 616e 5f65 7272  gonal_median_err
+000096f0: 273a 2065 7272 6c69 7374 7d0a 2020 2020  ': errlist}.    
+00009700: 2020 2020 2020 2020 2020 2020 6669 6e61              fina
+00009710: 6c64 6963 7420 3d20 7b6c 6162 656c 202b  ldict = {label +
+00009720: 2027 6f72 7468 6f67 6f6e 616c 5f6d 6564   'orthogonal_med
+00009730: 6961 6e27 3a20 626f 7468 6a73 6f6e 7d0a  ian': bothjson}.
+00009740: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009750: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+00009760: 2020 2020 2020 2020 2020 7769 7468 2063            with c
+00009770: 6f64 6563 732e 6f70 656e 2877 6f72 6b64  odecs.open(workd
+00009780: 6972 202b 206d 6170 6e61 6d65 202b 2027  ir + mapname + '
+00009790: 5f6d 6564 6961 6e2e 6a73 6f6e 272c 2027  _median.json', '
+000097a0: 7727 2c20 656e 636f 6469 6e67 3d27 7574  w', encoding='ut
+000097b0: 662d 3827 2920 6173 2066 3a0a 2020 2020  f-8') as f:.    
+000097c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000097d0: 2020 2020 6a73 6f6e 2e64 756d 7028 6669      json.dump(fi
+000097e0: 6e61 6c64 6963 742c 2066 290a 2020 2020  naldict, f).    
+000097f0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+00009800: 7074 2049 4f45 7272 6f72 2061 7320 696f  pt IOError as io
+00009810: 6572 723a 0a20 2020 2020 2020 2020 2020  err:.           
+00009820: 2020 2020 2020 2020 206a 736f 6e65 7272           jsonerr
+00009830: 203d 2027 5361 7669 6e67 206d 6564 6961   = 'Saving media
+00009840: 6e20 7072 6f6a 6563 7469 6f6e 2069 6e74  n projection int
+00009850: 6f20 6a73 6f6e 2065 7272 6f72 3a20 7b7d  o json error: {}
+00009860: 272e 666f 726d 6174 2869 6f65 7272 290a  '.format(ioerr).
+00009870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009880: 2020 2020 7379 732e 7374 6465 7272 2e77      sys.stderr.w
+00009890: 7269 7465 286a 736f 6e65 7272 202b 2027  rite(jsonerr + '
+000098a0: 5c6e 2729 0a0a 2020 2020 2020 2020 2020  \n')..          
+000098b0: 2020 2020 2020 656e 6420 3d20 7469 6d65        end = time
+000098c0: 6974 2e64 6566 6175 6c74 5f74 696d 6572  it.default_timer
+000098d0: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+000098e0: 2020 2070 7269 6e74 2827 4d65 6469 616e     print('Median
+000098f0: 2070 726f 6a65 6374 696f 6e73 2074 696d   projections tim
+00009900: 6520 666f 7220 2573 3a20 2573 2720 2520  e for %s: %s' % 
+00009910: 286d 6170 6e61 6d65 2c20 656e 6420 2d20  (mapname, end - 
+00009920: 7374 6172 7429 290a 2020 2020 2020 2020  start)).        
+00009930: 2020 2020 2020 2020 7072 696e 7428 272d          print('-
+00009940: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009950: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00009960: 2d2d 2d27 290a 0a20 2020 2020 2020 2020  ---')..         
+00009970: 2020 2020 2020 2072 6574 7572 6e20 4e6f         return No
+00009980: 6e65 0a20 2020 2020 2020 2020 2020 2065  ne.            e
+00009990: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+000099a0: 2020 2020 2070 7269 6e74 280a 2020 2020       print(.    
+000099b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000099c0: 274e 6f20 6f72 7468 6f67 6f6e 616c 206d  'No orthogonal m
+000099d0: 6564 6961 6e20 7072 6f6a 6563 7469 6f6e  edian projection
+000099e0: 7320 7769 7468 6f75 7420 7072 6f70 6572  s without proper
+000099f0: 206d 6170 2069 6e70 7574 2061 6e64 2074   map input and t
+00009a00: 6865 206f 7574 7075 7420 6469 7265 6374  he output direct
+00009a10: 6f72 7920 696e 666f 726d 6174 696f 6e2e  ory information.
+00009a20: 2729 0a0a 2020 2020 2020 2020 7265 7475  ')..        retu
+00009a30: 726e 204e 6f6e 650a 0a20 2020 2023 2040  rn None..    # @
+00009a40: 7072 6f66 696c 650a 2020 2020 6465 6620  profile.    def 
+00009a50: 7261 776d 6170 5f6d 6564 6961 6e28 7365  rawmap_median(se
+00009a60: 6c66 293a 0a0a 2020 2020 2020 2020 7261  lf):..        ra
+00009a70: 776d 6170 203d 2073 656c 662e 7261 776d  wmap = self.rawm
+00009a80: 6170 0a20 2020 2020 2020 2069 6620 7261  ap.        if ra
+00009a90: 776d 6170 2069 7320 6e6f 7420 4e6f 6e65  wmap is not None
+00009aa0: 3a0a 2020 2020 2020 2020 2020 2020 6469  :.            di
+00009ab0: 7220 3d20 7365 6c66 2e77 6f72 6b64 6972  r = self.workdir
+00009ac0: 0a20 2020 2020 2020 2020 2020 206c 6162  .            lab
+00009ad0: 656c 203d 2027 7261 776d 6170 5f27 0a20  el = 'rawmap_'. 
+00009ae0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00009af0: 6f72 7468 6f67 6f6e 616c 5f6d 6564 6961  orthogonal_media
+00009b00: 6e28 7261 776d 6170 2c20 6469 722c 206c  n(rawmap, dir, l
+00009b10: 6162 656c 290a 2020 2020 2020 2020 656c  abel).        el
+00009b20: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00009b30: 7072 696e 7428 274e 6f20 7261 7720 6d61  print('No raw ma
+00009b40: 7020 746f 2063 616c 6375 6c61 7465 206f  p to calculate o
+00009b50: 7274 686f 676f 6e61 6c20 6d61 7820 7072  rthogonal max pr
+00009b60: 6f6a 6563 7469 6f6e 732e 2729 0a0a 0a20  ojections.')... 
+00009b70: 2020 2023 2040 7072 6f66 696c 650a 2020     # @profile.  
+00009b80: 2020 6465 6620 6f72 7468 6f67 6f6e 616c    def orthogonal
+00009b90: 5f6d 696e 2873 656c 662c 206d 6170 696e  _min(self, mapin
+00009ba0: 3d4e 6f6e 652c 2077 6f72 6b64 6972 3d4e  =None, workdir=N
+00009bb0: 6f6e 652c 206c 6162 656c 3d27 2729 3a0a  one, label=''):.
+00009bc0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00009bd0: 2020 2020 2020 2020 204d 696e 696d 616c           Minimal
+00009be0: 2070 726f 6a65 6374 696f 6e0a 2020 2020   projection.    
+00009bf0: 2020 2020 3a70 6172 616d 206d 6170 696e      :param mapin
+00009c00: 3a20 496e 7075 7420 6d61 7020 6569 7468  : Input map eith
+00009c10: 6572 206d 7263 6669 6c65 206f 7220 6669  er mrcfile or fi
+00009c20: 6c65 6e61 6d65 2073 7472 696e 670a 2020  lename string.  
+00009c30: 2020 2020 2020 3a70 6172 616d 2077 6f72        :param wor
+00009c40: 6b64 6972 3a20 5374 7269 6e67 206f 6620  kdir: String of 
+00009c50: 7468 6520 6675 6c6c 2077 6f72 6b20 7061  the full work pa
+00009c60: 7468 0a20 2020 2020 2020 203a 7061 7261  th.        :para
+00009c70: 6d20 6c61 6265 6c3a 2066 6f72 2072 6177  m label: for raw
+00009c80: 206d 6170 2075 7365 2027 7261 775f 270a   map use 'raw_'.
+00009c90: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
+00009ca0: 204e 6f6e 650a 2020 2020 2020 2020 2222   None.        ""
+00009cb0: 220a 0a20 2020 2020 2020 2069 6620 7365  "..        if se
+00009cc0: 6c66 2e70 6c61 7466 6f72 6d20 3d3d 2027  lf.platform == '
+00009cd0: 656d 6462 273a 0a20 2020 2020 2020 2020  emdb':.         
+00009ce0: 2020 206d 6170 2c20 776f 726b 6469 7220     map, workdir 
+00009cf0: 3d20 7365 6c66 2e6d 6170 696e 6368 6563  = self.mapinchec
+00009d00: 6b28 6d61 7069 6e2c 2077 6f72 6b64 6972  k(mapin, workdir
+00009d10: 290a 2020 2020 2020 2020 2020 2020 6d61  ).            ma
+00009d20: 706e 616d 6520 3d20 6f73 2e70 6174 682e  pname = os.path.
+00009d30: 6261 7365 6e61 6d65 286d 6170 2e66 756c  basename(map.ful
+00009d40: 6c6e 616d 6529 2069 6620 6d61 7020 656c  lname) if map el
+00009d50: 7365 204e 6f6e 650a 2020 2020 2020 2020  se None.        
+00009d60: 2020 2020 6966 206d 6170 2069 7320 6e6f      if map is no
+00009d70: 7420 4e6f 6e65 2061 6e64 2077 6f72 6b64  t None and workd
+00009d80: 6972 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ir is not None:.
+00009d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009da0: 7374 6172 7420 3d20 7469 6d65 6974 2e64  start = timeit.d
+00009db0: 6566 6175 6c74 5f74 696d 6572 2829 0a20  efault_timer(). 
+00009dc0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00009dd0: 7272 6c69 7374 203d 205b 5d0a 2020 2020  rrlist = [].    
+00009de0: 2020 2020 2020 2020 2020 2020 7479 7065              type
+00009df0: 203d 2027 6d69 6e27 0a0a 2020 2020 2020   = 'min'..      
+00009e00: 2020 2020 2020 2020 2020 7870 726f 6a65            xproje
+00009e10: 6374 696f 6e6e 616d 6520 3d20 776f 726b  ctionname = work
+00009e20: 6469 7220 2b20 6d61 706e 616d 6520 2b20  dir + mapname + 
+00009e30: 275f 786d 696e 2e6a 7065 6727 0a20 2020  '_xmin.jpeg'.   
+00009e40: 2020 2020 2020 2020 2020 2020 2078 7363               xsc
+00009e50: 616c 656e 616d 6520 3d20 776f 726b 6469  alename = workdi
+00009e60: 7220 2b20 6d61 706e 616d 6520 2b20 275f  r + mapname + '_
+00009e70: 7363 616c 6564 5f78 6d69 6e2e 6a70 6567  scaled_xmin.jpeg
+00009e80: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00009e90: 2020 7365 6c66 2e6d 6170 5f74 6f5f 696d    self.map_to_im
+00009ea0: 6728 6d61 702c 2032 2c20 7479 7065 2c20  g(map, 2, type, 
+00009eb0: 6572 726c 6973 7429 0a0a 2020 2020 2020  errlist)..      
+00009ec0: 2020 2020 2020 2020 2020 7970 726f 6a65            yproje
+00009ed0: 6374 696f 6e6e 616d 6520 3d20 776f 726b  ctionname = work
+00009ee0: 6469 7220 2b20 6d61 706e 616d 6520 2b20  dir + mapname + 
+00009ef0: 275f 796d 696e 2e6a 7065 6727 0a20 2020  '_ymin.jpeg'.   
+00009f00: 2020 2020 2020 2020 2020 2020 2079 7363               ysc
+00009f10: 616c 656e 616d 6520 3d20 776f 726b 6469  alename = workdi
+00009f20: 7220 2b20 6d61 706e 616d 6520 2b20 275f  r + mapname + '_
+00009f30: 7363 616c 6564 5f79 6d69 6e2e 6a70 6567  scaled_ymin.jpeg
+00009f40: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00009f50: 2020 7365 6c66 2e6d 6170 5f74 6f5f 696d    self.map_to_im
+00009f60: 6728 6d61 702c 2031 2c20 7479 7065 2c20  g(map, 1, type, 
+00009f70: 6572 726c 6973 7429 0a0a 2020 2020 2020  errlist)..      
+00009f80: 2020 2020 2020 2020 2020 7a70 726f 6a65            zproje
+00009f90: 6374 696f 6e6e 616d 6520 3d20 776f 726b  ctionname = work
+00009fa0: 6469 7220 2b20 6d61 706e 616d 6520 2b20  dir + mapname + 
+00009fb0: 275f 7a6d 696e 2e6a 7065 6727 0a20 2020  '_zmin.jpeg'.   
+00009fc0: 2020 2020 2020 2020 2020 2020 207a 7363               zsc
+00009fd0: 616c 656e 616d 6520 3d20 776f 726b 6469  alename = workdi
+00009fe0: 7220 2b20 6d61 706e 616d 6520 2b20 275f  r + mapname + '_
+00009ff0: 7363 616c 6564 5f7a 6d69 6e2e 6a70 6567  scaled_zmin.jpeg
+0000a000: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0000a010: 2020 7365 6c66 2e6d 6170 5f74 6f5f 696d    self.map_to_im
+0000a020: 6728 6d61 702c 2030 2c20 7479 7065 2c20  g(map, 0, type, 
+0000a030: 6572 726c 6973 7429 0a0a 2020 2020 2020  errlist)..      
+0000a040: 2020 2020 2020 2020 2020 626f 7468 6a73            bothjs
+0000a050: 6f6e 203d 2064 6963 7428 290a 2020 2020  on = dict().    
+0000a060: 2020 2020 2020 2020 2020 2020 7072 6f6a              proj
+0000a070: 6563 7469 6f6e 6a73 6f6e 203d 2064 6963  ectionjson = dic
+0000a080: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
+0000a090: 2020 2020 6f72 6770 726f 6a65 6374 696f      orgprojectio
+0000a0a0: 6e6a 736f 6e20 3d20 6469 6374 2829 0a0a  njson = dict()..
+0000a0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a0c0: 7072 6f6a 6563 7469 6f6e 6a73 6f6e 5b27  projectionjson['
+0000a0d0: 7827 5d20 3d20 6f73 2e70 6174 682e 6261  x'] = os.path.ba
+0000a0e0: 7365 6e61 6d65 2878 7363 616c 656e 616d  sename(xscalenam
+0000a0f0: 6529 2069 6620 6f73 2e70 6174 682e 6973  e) if os.path.is
+0000a100: 6669 6c65 2878 7363 616c 656e 616d 6529  file(xscalename)
+0000a110: 2065 6c73 6520 4e6f 6e65 0a20 2020 2020   else None.     
+0000a120: 2020 2020 2020 2020 2020 2070 726f 6a65             proje
+0000a130: 6374 696f 6e6a 736f 6e5b 2779 275d 203d  ctionjson['y'] =
+0000a140: 206f 732e 7061 7468 2e62 6173 656e 616d   os.path.basenam
+0000a150: 6528 7973 6361 6c65 6e61 6d65 2920 6966  e(yscalename) if
+0000a160: 206f 732e 7061 7468 2e69 7366 696c 6528   os.path.isfile(
+0000a170: 7973 6361 6c65 6e61 6d65 2920 656c 7365  yscalename) else
+0000a180: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
+0000a190: 2020 2020 2020 7072 6f6a 6563 7469 6f6e        projection
+0000a1a0: 6a73 6f6e 5b27 7a27 5d20 3d20 6f73 2e70  json['z'] = os.p
+0000a1b0: 6174 682e 6261 7365 6e61 6d65 287a 7363  ath.basename(zsc
+0000a1c0: 616c 656e 616d 6529 2069 6620 6f73 2e70  alename) if os.p
+0000a1d0: 6174 682e 6973 6669 6c65 287a 7363 616c  ath.isfile(zscal
+0000a1e0: 656e 616d 6529 2065 6c73 6520 4e6f 6e65  ename) else None
+0000a1f0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000a200: 2020 6f72 6770 726f 6a65 6374 696f 6e6a    orgprojectionj
+0000a210: 736f 6e5b 2778 275d 203d 206f 732e 7061  son['x'] = os.pa
+0000a220: 7468 2e62 6173 656e 616d 6528 7870 726f  th.basename(xpro
+0000a230: 6a65 6374 696f 6e6e 616d 6529 2069 6620  jectionname) if 
+0000a240: 6f73 2e70 6174 682e 6973 6669 6c65 2878  os.path.isfile(x
+0000a250: 7072 6f6a 6563 7469 6f6e 6e61 6d65 2920  projectionname) 
+0000a260: 656c 7365 204e 6f6e 650a 2020 2020 2020  else None.      
+0000a270: 2020 2020 2020 2020 2020 6f72 6770 726f            orgpro
+0000a280: 6a65 6374 696f 6e6a 736f 6e5b 2779 275d  jectionjson['y']
+0000a290: 203d 206f 732e 7061 7468 2e62 6173 656e   = os.path.basen
+0000a2a0: 616d 6528 7970 726f 6a65 6374 696f 6e6e  ame(yprojectionn
+0000a2b0: 616d 6529 2069 6620 6f73 2e70 6174 682e  ame) if os.path.
+0000a2c0: 6973 6669 6c65 2879 7072 6f6a 6563 7469  isfile(yprojecti
+0000a2d0: 6f6e 6e61 6d65 2920 656c 7365 204e 6f6e  onname) else Non
+0000a2e0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+0000a2f0: 2020 6f72 6770 726f 6a65 6374 696f 6e6a    orgprojectionj
+0000a300: 736f 6e5b 277a 275d 203d 206f 732e 7061  son['z'] = os.pa
+0000a310: 7468 2e62 6173 656e 616d 6528 7a70 726f  th.basename(zpro
+0000a320: 6a65 6374 696f 6e6e 616d 6529 2069 6620  jectionname) if 
+0000a330: 6f73 2e70 6174 682e 6973 6669 6c65 287a  os.path.isfile(z
+0000a340: 7072 6f6a 6563 7469 6f6e 6e61 6d65 2920  projectionname) 
+0000a350: 656c 7365 204e 6f6e 650a 0a20 2020 2020  else None..     
+0000a360: 2020 2020 2020 2020 2020 2062 6f74 686a             bothj
+0000a370: 736f 6e5b 276f 7269 6769 6e61 6c27 5d20  son['original'] 
+0000a380: 3d20 6f72 6770 726f 6a65 6374 696f 6e6a  = orgprojectionj
+0000a390: 736f 6e0a 2020 2020 2020 2020 2020 2020  son.            
+0000a3a0: 2020 2020 626f 7468 6a73 6f6e 5b27 7363      bothjson['sc
+0000a3b0: 616c 6564 275d 203d 2070 726f 6a65 6374  aled'] = project
+0000a3c0: 696f 6e6a 736f 6e0a 0a20 2020 2020 2020  ionjson..       
+0000a3d0: 2020 2020 2020 2020 2069 6620 6572 726c           if errl
+0000a3e0: 6973 743a 0a20 2020 2020 2020 2020 2020  ist:.           
+0000a3f0: 2020 2020 2020 2020 2062 6f74 686a 736f           bothjso
+0000a400: 6e5b 2765 7272 275d 203d 207b 276f 7274  n['err'] = {'ort
+0000a410: 686f 676f 6e61 6c5f 6d69 6e5f 6572 7227  hogonal_min_err'
+0000a420: 3a20 6572 726c 6973 747d 0a20 2020 2020  : errlist}.     
+0000a430: 2020 2020 2020 2020 2020 2066 696e 616c             final
+0000a440: 6469 6374 203d 207b 6c61 6265 6c20 2b20  dict = {label + 
+0000a450: 276f 7274 686f 676f 6e61 6c5f 6d69 6e27  'orthogonal_min'
+0000a460: 3a20 626f 7468 6a73 6f6e 7d0a 0a20 2020  : bothjson}..   
+0000a470: 2020 2020 2020 2020 2020 2020 2074 7279               try
+0000a480: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000a490: 2020 2020 2020 7769 7468 2063 6f64 6563        with codec
+0000a4a0: 732e 6f70 656e 2877 6f72 6b64 6972 202b  s.open(workdir +
+0000a4b0: 206d 6170 6e61 6d65 202b 2027 5f6d 696e   mapname + '_min
+0000a4c0: 2e6a 736f 6e27 2c20 2777 272c 2065 6e63  .json', 'w', enc
+0000a4d0: 6f64 696e 673d 2775 7466 2d38 2729 2061  oding='utf-8') a
+0000a4e0: 7320 663a 0a20 2020 2020 2020 2020 2020  s f:.           
+0000a4f0: 2020 2020 2020 2020 2020 2020 206a 736f               jso
+0000a500: 6e2e 6475 6d70 2866 696e 616c 6469 6374  n.dump(finaldict
+0000a510: 2c20 6629 0a20 2020 2020 2020 2020 2020  , f).           
+0000a520: 2020 2020 2065 7863 6570 7420 494f 4572       except IOEr
+0000a530: 726f 7220 6173 2069 6f65 7272 3a0a 2020  ror as ioerr:.  
+0000a540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a550: 2020 6a73 6f6e 6572 7220 3d20 2753 6176    jsonerr = 'Sav
+0000a560: 696e 6720 6d69 6e69 6d61 6c20 7072 6f6a  ing minimal proj
+0000a570: 6563 7469 6f6e 2069 6e74 6f20 6a73 6f6e  ection into json
+0000a580: 2065 7272 6f72 3a20 7b7d 272e 666f 726d   error: {}'.form
+0000a590: 6174 2869 6f65 7272 290a 2020 2020 2020  at(ioerr).      
+0000a5a0: 2020 2020 2020 2020 2020 2020 2020 7379                sy
+0000a5b0: 732e 7374 6465 7272 2e77 7269 7465 286a  s.stderr.write(j
+0000a5c0: 736f 6e65 7272 202b 2027 5c6e 2729 0a0a  sonerr + '\n')..
+0000a5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a5e0: 656e 6420 3d20 7469 6d65 6974 2e64 6566  end = timeit.def
+0000a5f0: 6175 6c74 5f74 696d 6572 2829 0a20 2020  ault_timer().   
+0000a600: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+0000a610: 6e74 2827 4d69 6e69 6d61 6c20 7072 6f6a  nt('Minimal proj
+0000a620: 6563 7469 6f6e 7320 7469 6d65 2066 6f72  ections time for
+0000a630: 2025 733a 2025 7327 2025 2028 6d61 706e   %s: %s' % (mapn
+0000a640: 616d 652c 2065 6e64 202d 2073 7461 7274  ame, end - start
+0000a650: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+0000a660: 2020 2070 7269 6e74 2827 2d2d 2d2d 2d2d     print('------
+0000a670: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000a680: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2729  --------------')
+0000a690: 0a0a 2020 2020 2020 2020 2020 2020 656c  ..            el
+0000a6a0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0000a6b0: 2020 2020 7072 696e 7428 0a20 2020 2020      print(.     
+0000a6c0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0000a6d0: 4e6f 206f 7274 686f 676f 6e61 6c20 6d69  No orthogonal mi
+0000a6e0: 6e69 6d61 6c20 7072 6f6a 6563 7469 6f6e  nimal projection
+0000a6f0: 7320 7769 7468 6f75 7420 7072 6f70 6572  s without proper
+0000a700: 206d 6170 2069 6e70 7574 2061 6e64 2074   map input and t
+0000a710: 6865 206f 7574 7075 7420 6469 7265 6374  he output direct
+0000a720: 6f72 7920 696e 666f 726d 6174 696f 6e2e  ory information.
+0000a730: 2729 0a0a 2020 2020 2020 2020 7265 7475  ')..        retu
+0000a740: 726e 204e 6f6e 650a 0a20 2020 2023 2040  rn None..    # @
+0000a750: 7072 6f66 696c 650a 2020 2020 6465 6620  profile.    def 
+0000a760: 7261 776d 6170 5f6d 696e 2873 656c 6629  rawmap_min(self)
+0000a770: 3a0a 0a20 2020 2020 2020 2072 6177 6d61  :..        rawma
+0000a780: 7020 3d20 7365 6c66 2e72 6177 6d61 700a  p = self.rawmap.
+0000a790: 2020 2020 2020 2020 6966 2072 6177 6d61          if rawma
+0000a7a0: 7020 6973 206e 6f74 204e 6f6e 653a 0a20  p is not None:. 
+0000a7b0: 2020 2020 2020 2020 2020 2064 6972 203d             dir =
+0000a7c0: 2073 656c 662e 776f 726b 6469 720a 2020   self.workdir.  
+0000a7d0: 2020 2020 2020 2020 2020 6c61 6265 6c20            label 
+0000a7e0: 3d20 2772 6177 6d61 705f 270a 2020 2020  = 'rawmap_'.    
+0000a7f0: 2020 2020 2020 2020 7365 6c66 2e6f 7274          self.ort
+0000a800: 686f 676f 6e61 6c5f 6d69 6e28 7261 776d  hogonal_min(rawm
+0000a810: 6170 2c20 6469 722c 206c 6162 656c 290a  ap, dir, label).
+0000a820: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0000a830: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0000a840: 274e 6f20 7261 7720 6d61 7020 746f 2063  'No raw map to c
+0000a850: 616c 6375 6c61 7465 206f 7274 686f 676f  alculate orthogo
+0000a860: 6e61 6c20 6d69 6e20 7072 6f6a 6563 7469  nal min projecti
+0000a870: 6f6e 732e 2729 0a0a 2020 2020 2320 4070  ons.')..    # @p
+0000a880: 726f 6669 6c65 0a20 2020 2064 6566 206f  rofile.    def o
+0000a890: 7274 686f 676f 6e61 6c5f 6d61 7828 7365  rthogonal_max(se
+0000a8a0: 6c66 2c20 6d61 7069 6e3d 4e6f 6e65 2c20  lf, mapin=None, 
+0000a8b0: 776f 726b 6469 723d 4e6f 6e65 2c20 6c61  workdir=None, la
+0000a8c0: 6265 6c3d 2727 293a 0a20 2020 2020 2020  bel=''):.       
+0000a8d0: 2022 2222 0a20 2020 2020 2020 2020 2020   """.           
+0000a8e0: 2020 4d61 7869 6d61 6c20 7072 6f6a 6563    Maximal projec
+0000a8f0: 7469 6f6e 2061 6e64 2069 7420 676c 6f77  tion and it glow
+0000a900: 2069 6d61 6765 0a20 2020 2020 2020 203a   image.        :
+0000a910: 7061 7261 6d20 6d61 7069 6e3a 2049 6e70  param mapin: Inp
+0000a920: 7574 206d 6170 2065 6974 6865 7220 6d72  ut map either mr
+0000a930: 6366 696c 6520 6f72 2066 696c 656e 616d  cfile or filenam
+0000a940: 6520 7374 7269 6e67 0a20 2020 2020 2020  e string.       
+0000a950: 203a 7061 7261 6d20 776f 726b 6469 723a   :param workdir:
+0000a960: 2053 7472 696e 6720 6f66 2074 6865 2066   String of the f
+0000a970: 756c 6c20 776f 726b 2070 6174 680a 2020  ull work path.  
+0000a980: 2020 2020 2020 3a70 6172 616d 206c 6162        :param lab
+0000a990: 656c 3a20 666f 7220 7261 7720 6d61 7020  el: for raw map 
+0000a9a0: 7573 6520 2772 6177 5f27 0a20 2020 2020  use 'raw_'.     
+0000a9b0: 2020 203a 7265 7475 726e 3a20 4e6f 6e65     :return: None
+0000a9c0: 0a20 2020 2020 2020 2022 2222 0a0a 2020  .        """..  
+0000a9d0: 2020 2020 2020 6d61 702c 2077 6f72 6b64        map, workd
+0000a9e0: 6972 203d 2073 656c 662e 6d61 7069 6e63  ir = self.mapinc
+0000a9f0: 6865 636b 286d 6170 696e 2c20 776f 726b  heck(mapin, work
+0000aa00: 6469 7229 0a20 2020 2020 2020 206d 6170  dir).        map
+0000aa10: 6e61 6d65 203d 206f 732e 7061 7468 2e62  name = os.path.b
+0000aa20: 6173 656e 616d 6528 6d61 702e 6675 6c6c  asename(map.full
+0000aa30: 6e61 6d65 2920 6966 206d 6170 2065 6c73  name) if map els
+0000aa40: 6520 4e6f 6e65 0a20 2020 2020 2020 2069  e None.        i
+0000aa50: 6620 6d61 7020 6973 206e 6f74 204e 6f6e  f map is not Non
+0000aa60: 6520 616e 6420 776f 726b 6469 7220 6973  e and workdir is
+0000aa70: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+0000aa80: 2020 2020 2020 2073 7461 7274 203d 2074         start = t
+0000aa90: 696d 6569 742e 6465 6661 756c 745f 7469  imeit.default_ti
+0000aaa0: 6d65 7228 290a 2020 2020 2020 2020 2020  mer().          
+0000aab0: 2020 6572 726c 6973 7420 3d20 5b5d 0a20    errlist = []. 
+0000aac0: 2020 2020 2020 2020 2020 2074 7970 6520             type 
+0000aad0: 3d20 276d 6178 270a 0a20 2020 2020 2020  = 'max'..       
+0000aae0: 2020 2020 2078 7072 6f6a 6563 7469 6f6e       xprojection
+0000aaf0: 6e61 6d65 203d 2077 6f72 6b64 6972 202b  name = workdir +
+0000ab00: 206d 6170 6e61 6d65 202b 2027 5f78 6d61   mapname + '_xma
+0000ab10: 782e 6a70 6567 270a 2020 2020 2020 2020  x.jpeg'.        
+0000ab20: 2020 2020 7873 6361 6c65 6e61 6d65 203d      xscalename =
+0000ab30: 2077 6f72 6b64 6972 202b 206d 6170 6e61   workdir + mapna
+0000ab40: 6d65 202b 2027 5f73 6361 6c65 645f 786d  me + '_scaled_xm
+0000ab50: 6178 2e6a 7065 6727 0a20 2020 2020 2020  ax.jpeg'.       
+0000ab60: 2020 2020 2067 6c6f 7778 7072 6f6a 6563       glowxprojec
+0000ab70: 7469 6f6e 6e61 6d65 203d 2077 6f72 6b64  tionname = workd
+0000ab80: 6972 202b 206d 6170 6e61 6d65 202b 2027  ir + mapname + '
+0000ab90: 5f67 6c6f 775f 786d 6178 2e6a 7065 6727  _glow_xmax.jpeg'
+0000aba0: 0a20 2020 2020 2020 2020 2020 2067 6c6f  .            glo
+0000abb0: 7778 7363 616c 656e 616d 6520 3d20 776f  wxscalename = wo
+0000abc0: 726b 6469 7220 2b20 6d61 706e 616d 6520  rkdir + mapname 
+0000abd0: 2b20 275f 7363 616c 6564 5f67 6c6f 775f  + '_scaled_glow_
+0000abe0: 786d 6178 2e6a 7065 6727 0a20 2020 2020  xmax.jpeg'.     
+0000abf0: 2020 2020 2020 2073 656c 662e 6d61 705f         self.map_
+0000ac00: 746f 5f69 6d67 286d 6170 2c20 322c 2074  to_img(map, 2, t
+0000ac10: 7970 652c 2065 7272 6c69 7374 2c20 7365  ype, errlist, se
+0000ac20: 6c66 2e67 6c6f 7769 6d61 6765 290a 0a20  lf.glowimage).. 
+0000ac30: 2020 2020 2020 2020 2020 2079 7072 6f6a             yproj
+0000ac40: 6563 7469 6f6e 6e61 6d65 203d 2077 6f72  ectionname = wor
+0000ac50: 6b64 6972 202b 206d 6170 6e61 6d65 202b  kdir + mapname +
+0000ac60: 2027 5f79 6d61 782e 6a70 6567 270a 2020   '_ymax.jpeg'.  
+0000ac70: 2020 2020 2020 2020 2020 7973 6361 6c65            yscale
+0000ac80: 6e61 6d65 203d 2077 6f72 6b64 6972 202b  name = workdir +
+0000ac90: 206d 6170 6e61 6d65 202b 2027 5f73 6361   mapname + '_sca
+0000aca0: 6c65 645f 796d 6178 2e6a 7065 6727 0a20  led_ymax.jpeg'. 
+0000acb0: 2020 2020 2020 2020 2020 2067 6c6f 7779             glowy
+0000acc0: 7072 6f6a 6563 7469 6f6e 6e61 6d65 203d  projectionname =
+0000acd0: 2077 6f72 6b64 6972 202b 206d 6170 6e61   workdir + mapna
+0000ace0: 6d65 202b 2027 5f67 6c6f 775f 796d 6178  me + '_glow_ymax
+0000acf0: 2e6a 7065 6727 0a20 2020 2020 2020 2020  .jpeg'.         
+0000ad00: 2020 2067 6c6f 7779 7363 616c 656e 616d     glowyscalenam
+0000ad10: 6520 3d20 776f 726b 6469 7220 2b20 6d61  e = workdir + ma
+0000ad20: 706e 616d 6520 2b20 275f 7363 616c 6564  pname + '_scaled
+0000ad30: 5f67 6c6f 775f 796d 6178 2e6a 7065 6727  _glow_ymax.jpeg'
+0000ad40: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0000ad50: 662e 6d61 705f 746f 5f69 6d67 286d 6170  f.map_to_img(map
+0000ad60: 2c20 312c 2074 7970 652c 2065 7272 6c69  , 1, type, errli
+0000ad70: 7374 2c20 7365 6c66 2e67 6c6f 7769 6d61  st, self.glowima
+0000ad80: 6765 290a 0a20 2020 2020 2020 2020 2020  ge)..           
+0000ad90: 207a 7072 6f6a 6563 7469 6f6e 6e61 6d65   zprojectionname
+0000ada0: 203d 2077 6f72 6b64 6972 202b 206d 6170   = workdir + map
+0000adb0: 6e61 6d65 202b 2027 5f7a 6d61 782e 6a70  name + '_zmax.jp
+0000adc0: 6567 270a 2020 2020 2020 2020 2020 2020  eg'.            
+0000add0: 7a73 6361 6c65 6e61 6d65 203d 2077 6f72  zscalename = wor
+0000ade0: 6b64 6972 202b 206d 6170 6e61 6d65 202b  kdir + mapname +
+0000adf0: 2027 5f73 6361 6c65 645f 7a6d 6178 2e6a   '_scaled_zmax.j
+0000ae00: 7065 6727 0a20 2020 2020 2020 2020 2020  peg'.           
+0000ae10: 2067 6c6f 777a 7072 6f6a 6563 7469 6f6e   glowzprojection
+0000ae20: 6e61 6d65 203d 2077 6f72 6b64 6972 202b  name = workdir +
+0000ae30: 206d 6170 6e61 6d65 202b 2027 5f67 6c6f   mapname + '_glo
+0000ae40: 775f 7a6d 6178 2e6a 7065 6727 0a20 2020  w_zmax.jpeg'.   
+0000ae50: 2020 2020 2020 2020 2067 6c6f 777a 7363           glowzsc
+0000ae60: 616c 656e 616d 6520 3d20 776f 726b 6469  alename = workdi
+0000ae70: 7220 2b20 6d61 706e 616d 6520 2b20 275f  r + mapname + '_
+0000ae80: 7363 616c 6564 5f67 6c6f 775f 7a6d 6178  scaled_glow_zmax
+0000ae90: 2e6a 7065 6727 0a20 2020 2020 2020 2020  .jpeg'.         
+0000aea0: 2020 2073 656c 662e 6d61 705f 746f 5f69     self.map_to_i
+0000aeb0: 6d67 286d 6170 2c20 302c 2074 7970 652c  mg(map, 0, type,
+0000aec0: 2065 7272 6c69 7374 2c20 7365 6c66 2e67   errlist, self.g
+0000aed0: 6c6f 7769 6d61 6765 290a 0a20 2020 2020  lowimage)..     
+0000aee0: 2020 2020 2020 2062 6f74 686a 736f 6e20         bothjson 
+0000aef0: 3d20 6469 6374 2829 0a20 2020 2020 2020  = dict().       
+0000af00: 2020 2020 2070 726f 6a65 6374 696f 6e6a       projectionj
+0000af10: 736f 6e20 3d20 6469 6374 2829 0a20 2020  son = dict().   
+0000af20: 2020 2020 2020 2020 206f 7267 7072 6f6a           orgproj
+0000af30: 6563 7469 6f6e 6a73 6f6e 203d 2064 6963  ectionjson = dic
+0000af40: 7428 290a 0a20 2020 2020 2020 2020 2020  t()..           
+0000af50: 2070 726f 6a65 6374 696f 6e6a 736f 6e5b   projectionjson[
+0000af60: 2778 275d 203d 206f 732e 7061 7468 2e62  'x'] = os.path.b
+0000af70: 6173 656e 616d 6528 7873 6361 6c65 6e61  asename(xscalena
+0000af80: 6d65 2920 6966 206f 732e 7061 7468 2e69  me) if os.path.i
+0000af90: 7366 696c 6528 7873 6361 6c65 6e61 6d65  sfile(xscalename
+0000afa0: 2920 656c 7365 204e 6f6e 650a 2020 2020  ) else None.    
+0000afb0: 2020 2020 2020 2020 7072 6f6a 6563 7469          projecti
+0000afc0: 6f6e 6a73 6f6e 5b27 7927 5d20 3d20 6f73  onjson['y'] = os
+0000afd0: 2e70 6174 682e 6261 7365 6e61 6d65 2879  .path.basename(y
+0000afe0: 7363 616c 656e 616d 6529 2069 6620 6f73  scalename) if os
+0000aff0: 2e70 6174 682e 6973 6669 6c65 2879 7363  .path.isfile(ysc
+0000b000: 616c 656e 616d 6529 2065 6c73 6520 4e6f  alename) else No
+0000b010: 6e65 0a20 2020 2020 2020 2020 2020 2070  ne.            p
+0000b020: 726f 6a65 6374 696f 6e6a 736f 6e5b 277a  rojectionjson['z
+0000b030: 275d 203d 206f 732e 7061 7468 2e62 6173  '] = os.path.bas
+0000b040: 656e 616d 6528 7a73 6361 6c65 6e61 6d65  ename(zscalename
+0000b050: 2920 6966 206f 732e 7061 7468 2e69 7366  ) if os.path.isf
+0000b060: 696c 6528 7a73 6361 6c65 6e61 6d65 2920  ile(zscalename) 
+0000b070: 656c 7365 204e 6f6e 650a 0a20 2020 2020  else None..     
+0000b080: 2020 2020 2020 206f 7267 7072 6f6a 6563         orgprojec
+0000b090: 7469 6f6e 6a73 6f6e 5b27 7827 5d20 3d20  tionjson['x'] = 
+0000b0a0: 6f73 2e70 6174 682e 6261 7365 6e61 6d65  os.path.basename
+0000b0b0: 2878 7072 6f6a 6563 7469 6f6e 6e61 6d65  (xprojectionname
+0000b0c0: 2920 6966 206f 732e 7061 7468 2e69 7366  ) if os.path.isf
+0000b0d0: 696c 6528 7870 726f 6a65 6374 696f 6e6e  ile(xprojectionn
+0000b0e0: 616d 6529 2065 6c73 6520 4e6f 6e65 0a20  ame) else None. 
+0000b0f0: 2020 2020 2020 2020 2020 206f 7267 7072             orgpr
+0000b100: 6f6a 6563 7469 6f6e 6a73 6f6e 5b27 7927  ojectionjson['y'
+0000b110: 5d20 3d20 6f73 2e70 6174 682e 6261 7365  ] = os.path.base
+0000b120: 6e61 6d65 2879 7072 6f6a 6563 7469 6f6e  name(yprojection
+0000b130: 6e61 6d65 2920 6966 206f 732e 7061 7468  name) if os.path
+0000b140: 2e69 7366 696c 6528 7970 726f 6a65 6374  .isfile(yproject
+0000b150: 696f 6e6e 616d 6529 2065 6c73 6520 4e6f  ionname) else No
+0000b160: 6e65 0a20 2020 2020 2020 2020 2020 206f  ne.            o
+0000b170: 7267 7072 6f6a 6563 7469 6f6e 6a73 6f6e  rgprojectionjson
+0000b180: 5b27 7a27 5d20 3d20 6f73 2e70 6174 682e  ['z'] = os.path.
+0000b190: 6261 7365 6e61 6d65 287a 7072 6f6a 6563  basename(zprojec
+0000b1a0: 7469 6f6e 6e61 6d65 2920 6966 206f 732e  tionname) if os.
+0000b1b0: 7061 7468 2e69 7366 696c 6528 7a70 726f  path.isfile(zpro
+0000b1c0: 6a65 6374 696f 6e6e 616d 6529 2065 6c73  jectionname) els
+0000b1d0: 6520 4e6f 6e65 0a20 2020 2020 2020 2020  e None.         
+0000b1e0: 2020 2062 6f74 686a 736f 6e5b 276f 7269     bothjson['ori
+0000b1f0: 6769 6e61 6c27 5d20 3d20 6f72 6770 726f  ginal'] = orgpro
+0000b200: 6a65 6374 696f 6e6a 736f 6e0a 2020 2020  jectionjson.    
+0000b210: 2020 2020 2020 2020 626f 7468 6a73 6f6e          bothjson
+0000b220: 5b27 7363 616c 6564 275d 203d 2070 726f  ['scaled'] = pro
+0000b230: 6a65 6374 696f 6e6a 736f 6e0a 0a20 2020  jectionjson..   
+0000b240: 2020 2020 2020 2020 2069 6620 6572 726c           if errl
+0000b250: 6973 743a 0a20 2020 2020 2020 2020 2020  ist:.           
+0000b260: 2020 2020 2062 6f74 686a 736f 6e5b 2765       bothjson['e
+0000b270: 7272 275d 203d 207b 276f 7274 686f 676f  rr'] = {'orthogo
+0000b280: 6e61 6c5f 6d61 785f 6572 7227 3a20 6572  nal_max_err': er
+0000b290: 726c 6973 747d 0a20 2020 2020 2020 2020  rlist}.         
+0000b2a0: 2020 2066 696e 616c 6469 6374 203d 207b     finaldict = {
+0000b2b0: 6c61 6265 6c20 2b20 276f 7274 686f 676f  label + 'orthogo
+0000b2c0: 6e61 6c5f 6d61 7827 3a20 626f 7468 6a73  nal_max': bothjs
+0000b2d0: 6f6e 7d0a 0a20 2020 2020 2020 2020 2020  on}..           
+0000b2e0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+0000b2f0: 2020 2020 2020 7769 7468 2063 6f64 6563        with codec
+0000b300: 732e 6f70 656e 2877 6f72 6b64 6972 202b  s.open(workdir +
+0000b310: 206d 6170 6e61 6d65 202b 2027 5f6d 6178   mapname + '_max
+0000b320: 2e6a 736f 6e27 2c20 2777 272c 0a20 2020  .json', 'w',.   
+0000b330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b340: 2020 2020 2020 2020 2020 2020 2020 656e                en
+0000b350: 636f 6469 6e67 3d27 7574 662d 3827 2920  coding='utf-8') 
+0000b360: 6173 2066 3a0a 2020 2020 2020 2020 2020  as f:.          
+0000b370: 2020 2020 2020 2020 2020 6a73 6f6e 2e64            json.d
+0000b380: 756d 7028 6669 6e61 6c64 6963 742c 2066  ump(finaldict, f
+0000b390: 290a 2020 2020 2020 2020 2020 2020 6578  ).            ex
+0000b3a0: 6365 7074 2049 4f45 7272 6f72 2061 7320  cept IOError as 
+0000b3b0: 696f 6572 723a 0a20 2020 2020 2020 2020  ioerr:.         
+0000b3c0: 2020 2020 2020 206a 736f 6e65 7272 203d         jsonerr =
+0000b3d0: 2027 5361 7669 6e67 206d 6178 2070 726f   'Saving max pro
+0000b3e0: 6a65 6374 696f 6e20 696e 746f 206a 736f  jection into jso
+0000b3f0: 6e20 6572 726f 723a 207b 7d27 2e66 6f72  n error: {}'.for
+0000b400: 6d61 7428 696f 6572 7229 0a20 2020 2020  mat(ioerr).     
+0000b410: 2020 2020 2020 2020 2020 2073 7973 2e73             sys.s
+0000b420: 7464 6572 722e 7772 6974 6528 6a73 6f6e  tderr.write(json
+0000b430: 6572 7220 2b20 275c 6e27 290a 0a0a 2020  err + '\n')...  
+0000b440: 2020 2020 2020 2020 2020 676c 6f77 626f            glowbo
+0000b450: 7468 6a73 6f6e 203d 2064 6963 7428 290a  thjson = dict().
+0000b460: 2020 2020 2020 2020 2020 2020 676c 6f77              glow
+0000b470: 7072 6f6a 6563 7469 6f6e 6a73 6f6e 203d  projectionjson =
+0000b480: 2064 6963 7428 290a 2020 2020 2020 2020   dict().        
+0000b490: 2020 2020 676c 6f77 6f72 6770 726f 6a65      gloworgproje
+0000b4a0: 6374 696f 6e6a 736f 6e20 3d20 6469 6374  ctionjson = dict
+0000b4b0: 2829 0a0a 2020 2020 2020 2020 2020 2020  ()..            
+0000b4c0: 676c 6f77 7072 6f6a 6563 7469 6f6e 6a73  glowprojectionjs
+0000b4d0: 6f6e 5b27 7827 5d20 3d20 6f73 2e70 6174  on['x'] = os.pat
+0000b4e0: 682e 6261 7365 6e61 6d65 2867 6c6f 7778  h.basename(glowx
+0000b4f0: 7363 616c 656e 616d 6529 2069 6620 6f73  scalename) if os
+0000b500: 2e70 6174 682e 6973 6669 6c65 2867 6c6f  .path.isfile(glo
+0000b510: 7778 7363 616c 656e 616d 6529 2065 6c73  wxscalename) els
+0000b520: 6520 4e6f 6e65 0a20 2020 2020 2020 2020  e None.         
+0000b530: 2020 2067 6c6f 7770 726f 6a65 6374 696f     glowprojectio
+0000b540: 6e6a 736f 6e5b 2779 275d 203d 206f 732e  njson['y'] = os.
+0000b550: 7061 7468 2e62 6173 656e 616d 6528 676c  path.basename(gl
+0000b560: 6f77 7973 6361 6c65 6e61 6d65 2920 6966  owyscalename) if
+0000b570: 206f 732e 7061 7468 2e69 7366 696c 6528   os.path.isfile(
+0000b580: 676c 6f77 7973 6361 6c65 6e61 6d65 2920  glowyscalename) 
+0000b590: 656c 7365 204e 6f6e 650a 2020 2020 2020  else None.      
+0000b5a0: 2020 2020 2020 676c 6f77 7072 6f6a 6563        glowprojec
+0000b5b0: 7469 6f6e 6a73 6f6e 5b27 7a27 5d20 3d20  tionjson['z'] = 
+0000b5c0: 6f73 2e70 6174 682e 6261 7365 6e61 6d65  os.path.basename
+0000b5d0: 2867 6c6f 777a 7363 616c 656e 616d 6529  (glowzscalename)
+0000b5e0: 2069 6620 6f73 2e70 6174 682e 6973 6669   if os.path.isfi
+0000b5f0: 6c65 2867 6c6f 777a 7363 616c 656e 616d  le(glowzscalenam
+0000b600: 6529 2065 6c73 6520 4e6f 6e65 0a0a 2020  e) else None..  
+0000b610: 2020 2020 2020 2020 2020 676c 6f77 6f72            glowor
+0000b620: 6770 726f 6a65 6374 696f 6e6a 736f 6e5b  gprojectionjson[
+0000b630: 2778 275d 203d 206f 732e 7061 7468 2e62  'x'] = os.path.b
+0000b640: 6173 656e 616d 6528 676c 6f77 7870 726f  asename(glowxpro
+0000b650: 6a65 6374 696f 6e6e 616d 6529 2069 6620  jectionname) if 
+0000b660: 6f73 2e70 6174 682e 6973 6669 6c65 2867  os.path.isfile(g
+0000b670: 6c6f 7778 7072 6f6a 6563 7469 6f6e 6e61  lowxprojectionna
+0000b680: 6d65 2920 656c 7365 204e 6f6e 650a 2020  me) else None.  
+0000b690: 2020 2020 2020 2020 2020 676c 6f77 6f72            glowor
+0000b6a0: 6770 726f 6a65 6374 696f 6e6a 736f 6e5b  gprojectionjson[
+0000b6b0: 2779 275d 203d 206f 732e 7061 7468 2e62  'y'] = os.path.b
+0000b6c0: 6173 656e 616d 6528 676c 6f77 7970 726f  asename(glowypro
+0000b6d0: 6a65 6374 696f 6e6e 616d 6529 2069 6620  jectionname) if 
+0000b6e0: 6f73 2e70 6174 682e 6973 6669 6c65 2867  os.path.isfile(g
+0000b6f0: 6c6f 7779 7072 6f6a 6563 7469 6f6e 6e61  lowyprojectionna
+0000b700: 6d65 2920 656c 7365 204e 6f6e 650a 2020  me) else None.  
+0000b710: 2020 2020 2020 2020 2020 676c 6f77 6f72            glowor
+0000b720: 6770 726f 6a65 6374 696f 6e6a 736f 6e5b  gprojectionjson[
+0000b730: 277a 275d 203d 206f 732e 7061 7468 2e62  'z'] = os.path.b
+0000b740: 6173 656e 616d 6528 676c 6f77 7a70 726f  asename(glowzpro
+0000b750: 6a65 6374 696f 6e6e 616d 6529 2069 6620  jectionname) if 
+0000b760: 6f73 2e70 6174 682e 6973 6669 6c65 2867  os.path.isfile(g
+0000b770: 6c6f 777a 7072 6f6a 6563 7469 6f6e 6e61  lowzprojectionna
+0000b780: 6d65 2920 656c 7365 204e 6f6e 650a 2020  me) else None.  
+0000b790: 2020 2020 2020 2020 2020 676c 6f77 626f            glowbo
+0000b7a0: 7468 6a73 6f6e 5b27 6f72 6967 696e 616c  thjson['original
+0000b7b0: 275d 203d 2067 6c6f 776f 7267 7072 6f6a  '] = gloworgproj
+0000b7c0: 6563 7469 6f6e 6a73 6f6e 0a20 2020 2020  ectionjson.     
+0000b7d0: 2020 2020 2020 2067 6c6f 7762 6f74 686a         glowbothj
+0000b7e0: 736f 6e5b 2773 6361 6c65 6427 5d20 3d20  son['scaled'] = 
+0000b7f0: 676c 6f77 7072 6f6a 6563 7469 6f6e 6a73  glowprojectionjs
+0000b800: 6f6e 0a0a 2020 2020 2020 2020 2020 2020  on..            
+0000b810: 6966 2065 7272 6c69 7374 3a0a 2020 2020  if errlist:.    
+0000b820: 2020 2020 2020 2020 2020 2020 676c 6f77              glow
+0000b830: 626f 7468 6a73 6f6e 5b27 6572 7227 5d20  bothjson['err'] 
+0000b840: 3d20 7b27 6f72 7468 6f67 6f6e 616c 5f67  = {'orthogonal_g
+0000b850: 6c6f 775f 6d61 785f 6572 7227 3a20 6572  low_max_err': er
+0000b860: 726c 6973 747d 0a20 2020 2020 2020 2020  rlist}.         
+0000b870: 2020 2067 6c6f 7766 696e 616c 6469 6374     glowfinaldict
+0000b880: 203d 207b 6c61 6265 6c20 2b20 276f 7274   = {label + 'ort
+0000b890: 686f 676f 6e61 6c5f 676c 6f77 5f6d 6178  hogonal_glow_max
+0000b8a0: 273a 2067 6c6f 7762 6f74 686a 736f 6e7d  ': glowbothjson}
+0000b8b0: 0a0a 2020 2020 2020 2020 2020 2020 7472  ..            tr
+0000b8c0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+0000b8d0: 2020 2077 6974 6820 636f 6465 6373 2e6f     with codecs.o
+0000b8e0: 7065 6e28 776f 726b 6469 7220 2b20 6d61  pen(workdir + ma
+0000b8f0: 706e 616d 6520 2b20 275f 676c 6f77 5f6d  pname + '_glow_m
+0000b900: 6178 2e6a 736f 6e27 2c20 2777 272c 0a20  ax.json', 'w',. 
+0000b910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b930: 656e 636f 6469 6e67 3d27 7574 662d 3827  encoding='utf-8'
+0000b940: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
+0000b950: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
+0000b960: 2e64 756d 7028 676c 6f77 6669 6e61 6c64  .dump(glowfinald
+0000b970: 6963 742c 2066 290a 2020 2020 2020 2020  ict, f).        
+0000b980: 2020 2020 6578 6365 7074 2049 4f45 7272      except IOErr
+0000b990: 6f72 2061 7320 696f 6572 723a 0a20 2020  or as ioerr:.   
+0000b9a0: 2020 2020 2020 2020 2020 2020 206a 736f               jso
+0000b9b0: 6e65 7272 203d 2027 5361 7669 6e67 2067  nerr = 'Saving g
+0000b9c0: 6c6f 7720 6d61 7820 7072 6f6a 6563 7469  low max projecti
+0000b9d0: 6f6e 2069 6e74 6f20 6a73 6f6e 2065 7272  on into json err
+0000b9e0: 6f72 3a20 7b7d 272e 666f 726d 6174 2869  or: {}'.format(i
+0000b9f0: 6f65 7272 290a 2020 2020 2020 2020 2020  oerr).          
+0000ba00: 2020 2020 2020 7379 732e 7374 6465 7272        sys.stderr
+0000ba10: 2e77 7269 7465 286a 736f 6e65 7272 202b  .write(jsonerr +
+0000ba20: 2027 5c6e 2729 0a0a 2020 2020 2020 2020   '\n')..        
+0000ba30: 2020 2020 656e 6420 3d20 7469 6d65 6974      end = timeit
+0000ba40: 2e64 6566 6175 6c74 5f74 696d 6572 2829  .default_timer()
+0000ba50: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
+0000ba60: 6e74 2827 4d61 7820 616e 6420 6974 7320  nt('Max and its 
+0000ba70: 676c 6f77 2070 726f 6a65 6374 696f 6e73  glow projections
+0000ba80: 2074 696d 6520 666f 7220 2573 3a20 2573   time for %s: %s
+0000ba90: 2720 2520 286d 6170 6e61 6d65 2c20 656e  ' % (mapname, en
+0000baa0: 6420 2d20 7374 6172 7429 290a 2020 2020  d - start)).    
+0000bab0: 2020 2020 2020 2020 7072 696e 7428 272d          print('-
+0000bac0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000bad0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000bae0: 2d2d 2d27 290a 0a20 2020 2020 2020 2065  ---')..        e
+0000baf0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0000bb00: 2070 7269 6e74 2827 4e6f 206f 7274 686f   print('No ortho
+0000bb10: 676f 6e61 6c20 6d61 7869 6d75 6d20 7072  gonal maximum pr
+0000bb20: 6f6a 6563 7469 6f6e 7320 616e 6420 6974  ojections and it
+0000bb30: 2067 6c6f 7720 7072 6f6a 6563 7469 6f6e   glow projection
+0000bb40: 7320 270a 2020 2020 2020 2020 2020 2020  s '.            
+0000bb50: 2020 2020 2020 2777 6974 686f 7574 2070        'without p
+0000bb60: 726f 7065 7220 6d61 7020 696e 7075 7420  roper map input 
+0000bb70: 616e 6420 7468 6520 6f75 7470 7574 2064  and the output d
+0000bb80: 6972 6563 746f 7279 2069 6e66 6f72 6d61  irectory informa
+0000bb90: 7469 6f6e 2e27 290a 0a20 2020 2020 2020  tion.')..       
+0000bba0: 2072 6574 7572 6e20 4e6f 6e65 0a0a 2020   return None..  
+0000bbb0: 2020 2320 4070 726f 6669 6c65 0a20 2020    # @profile.   
+0000bbc0: 2064 6566 2072 6177 6d61 705f 6d61 7828   def rawmap_max(
+0000bbd0: 7365 6c66 293a 0a0a 2020 2020 2020 2020  self):..        
+0000bbe0: 7261 776d 6170 203d 2073 656c 662e 7261  rawmap = self.ra
+0000bbf0: 776d 6170 0a20 2020 2020 2020 2069 6620  wmap.        if 
+0000bc00: 7261 776d 6170 2069 7320 6e6f 7420 4e6f  rawmap is not No
+0000bc10: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0000bc20: 6469 7220 3d20 7365 6c66 2e77 6f72 6b64  dir = self.workd
+0000bc30: 6972 0a20 2020 2020 2020 2020 2020 206c  ir.            l
+0000bc40: 6162 656c 203d 2027 7261 776d 6170 5f27  abel = 'rawmap_'
+0000bc50: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0000bc60: 662e 6f72 7468 6f67 6f6e 616c 5f6d 6178  f.orthogonal_max
+0000bc70: 2872 6177 6d61 702c 2064 6972 2c20 6c61  (rawmap, dir, la
+0000bc80: 6265 6c29 0a20 2020 2020 2020 2065 6c73  bel).        els
+0000bc90: 653a 0a20 2020 2020 2020 2020 2020 2070  e:.            p
+0000bca0: 7269 6e74 2827 4e6f 2072 6177 206d 6170  rint('No raw map
+0000bcb0: 2074 6f20 6361 6c63 756c 6174 6520 6f72   to calculate or
+0000bcc0: 7468 6f67 6f6e 616c 206d 6178 2070 726f  thogonal max pro
+0000bcd0: 6a65 6374 696f 6e73 2e27 290a 0a20 2020  jections.')..   
+0000bce0: 2023 2040 7072 6f66 696c 650a 2020 2020   # @profile.    
+0000bcf0: 6465 6620 6f72 7468 6f67 6f6e 616c 5f73  def orthogonal_s
+0000bd00: 7464 2873 656c 662c 206d 6170 696e 3d4e  td(self, mapin=N
+0000bd10: 6f6e 652c 2077 6f72 6b64 6972 3d4e 6f6e  one, workdir=Non
+0000bd20: 652c 206c 6162 656c 3d27 2729 3a0a 2020  e, label=''):.  
+0000bd30: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0000bd40: 2020 2020 2020 2053 7464 2070 726f 6a65         Std proje
+0000bd50: 6374 696f 6e20 616e 6420 6974 2067 6c6f  ction and it glo
+0000bd60: 7720 696d 6167 650a 2020 2020 2020 2020  w image.        
+0000bd70: 3a70 6172 616d 206d 6170 696e 3a20 496e  :param mapin: In
+0000bd80: 7075 7420 6d61 7020 6569 7468 6572 206d  put map either m
+0000bd90: 7263 6669 6c65 206f 7220 6669 6c65 6e61  rcfile or filena
+0000bda0: 6d65 2073 7472 696e 670a 2020 2020 2020  me string.      
+0000bdb0: 2020 3a70 6172 616d 2077 6f72 6b64 6972    :param workdir
+0000bdc0: 3a20 5374 7269 6e67 206f 6620 7468 6520  : String of the 
+0000bdd0: 6675 6c6c 2077 6f72 6b20 7061 7468 0a20  full work path. 
+0000bde0: 2020 2020 2020 203a 7061 7261 6d20 6c61         :param la
+0000bdf0: 6265 6c3a 2066 6f72 2072 6177 206d 6170  bel: for raw map
+0000be00: 2075 7365 2027 7261 775f 270a 2020 2020   use 'raw_'.    
+0000be10: 2020 2020 3a72 6574 7572 6e3a 204e 6f6e      :return: Non
+0000be20: 650a 2020 2020 2020 2020 2222 220a 0a20  e.        """.. 
+0000be30: 2020 2020 2020 206d 6170 2c20 776f 726b         map, work
+0000be40: 6469 7220 3d20 7365 6c66 2e6d 6170 696e  dir = self.mapin
+0000be50: 6368 6563 6b28 6d61 7069 6e2c 2077 6f72  check(mapin, wor
+0000be60: 6b64 6972 290a 2020 2020 2020 2020 6d61  kdir).        ma
+0000be70: 706e 616d 6520 3d20 6f73 2e70 6174 682e  pname = os.path.
+0000be80: 6261 7365 6e61 6d65 286d 6170 2e66 756c  basename(map.ful
+0000be90: 6c6e 616d 6529 2069 6620 6d61 7020 656c  lname) if map el
+0000bea0: 7365 204e 6f6e 650a 2020 2020 2020 2020  se None.        
+0000beb0: 6966 206d 6170 2069 7320 6e6f 7420 4e6f  if map is not No
+0000bec0: 6e65 2061 6e64 2077 6f72 6b64 6972 2069  ne and workdir i
+0000bed0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+0000bee0: 2020 2020 2020 2020 7374 6172 7420 3d20          start = 
+0000bef0: 7469 6d65 6974 2e64 6566 6175 6c74 5f74  timeit.default_t
+0000bf00: 696d 6572 2829 0a20 2020 2020 2020 2020  imer().         
+0000bf10: 2020 2065 7272 6c69 7374 203d 205b 5d0a     errlist = [].
+0000bf20: 0a20 2020 2020 2020 2020 2020 2074 7970  .            typ
+0000bf30: 6520 3d20 2773 7464 270a 0a20 2020 2020  e = 'std'..     
+0000bf40: 2020 2020 2020 2078 7072 6f6a 6563 7469         xprojecti
+0000bf50: 6f6e 6e61 6d65 203d 2077 6f72 6b64 6972  onname = workdir
+0000bf60: 202b 206d 6170 6e61 6d65 202b 2027 5f78   + mapname + '_x
+0000bf70: 7374 642e 6a70 6567 270a 2020 2020 2020  std.jpeg'.      
+0000bf80: 2020 2020 2020 7873 6361 6c65 6e61 6d65        xscalename
+0000bf90: 203d 2077 6f72 6b64 6972 202b 206d 6170   = workdir + map
+0000bfa0: 6e61 6d65 202b 2027 5f73 6361 6c65 645f  name + '_scaled_
+0000bfb0: 7873 7464 2e6a 7065 6727 0a20 2020 2020  xstd.jpeg'.     
+0000bfc0: 2020 2020 2020 2067 6c6f 7778 7072 6f6a         glowxproj
+0000bfd0: 6563 7469 6f6e 6e61 6d65 203d 2077 6f72  ectionname = wor
+0000bfe0: 6b64 6972 202b 206d 6170 6e61 6d65 202b  kdir + mapname +
+0000bff0: 2027 5f67 6c6f 775f 7873 7464 2e6a 7065   '_glow_xstd.jpe
+0000c000: 6727 0a20 2020 2020 2020 2020 2020 2067  g'.            g
+0000c010: 6c6f 7778 7363 616c 656e 616d 6520 3d20  lowxscalename = 
+0000c020: 776f 726b 6469 7220 2b20 6d61 706e 616d  workdir + mapnam
+0000c030: 6520 2b20 275f 7363 616c 6564 5f67 6c6f  e + '_scaled_glo
+0000c040: 775f 7873 7464 2e6a 7065 6727 0a20 2020  w_xstd.jpeg'.   
+0000c050: 2020 2020 2020 2020 2073 656c 662e 6d61           self.ma
+0000c060: 705f 746f 5f69 6d67 286d 6170 2c20 322c  p_to_img(map, 2,
+0000c070: 2074 7970 652c 2065 7272 6c69 7374 2c20   type, errlist, 
+0000c080: 7365 6c66 2e67 6c6f 7769 6d61 6765 290a  self.glowimage).
+0000c090: 0a20 2020 2020 2020 2020 2020 2079 7072  .            ypr
+0000c0a0: 6f6a 6563 7469 6f6e 6e61 6d65 203d 2077  ojectionname = w
+0000c0b0: 6f72 6b64 6972 202b 206d 6170 6e61 6d65  orkdir + mapname
+0000c0c0: 202b 2027 5f79 7374 642e 6a70 6567 270a   + '_ystd.jpeg'.
+0000c0d0: 2020 2020 2020 2020 2020 2020 7973 6361              ysca
+0000c0e0: 6c65 6e61 6d65 203d 2077 6f72 6b64 6972  lename = workdir
+0000c0f0: 202b 206d 6170 6e61 6d65 202b 2027 5f73   + mapname + '_s
+0000c100: 6361 6c65 645f 7973 7464 2e6a 7065 6727  caled_ystd.jpeg'
+0000c110: 0a20 2020 2020 2020 2020 2020 2067 6c6f  .            glo
+0000c120: 7779 7072 6f6a 6563 7469 6f6e 6e61 6d65  wyprojectionname
+0000c130: 203d 2077 6f72 6b64 6972 202b 206d 6170   = workdir + map
+0000c140: 6e61 6d65 202b 2027 5f67 6c6f 775f 7973  name + '_glow_ys
+0000c150: 7464 2e6a 7065 6727 0a20 2020 2020 2020  td.jpeg'.       
+0000c160: 2020 2020 2067 6c6f 7779 7363 616c 656e       glowyscalen
+0000c170: 616d 6520 3d20 776f 726b 6469 7220 2b20  ame = workdir + 
+0000c180: 6d61 706e 616d 6520 2b20 275f 7363 616c  mapname + '_scal
+0000c190: 6564 5f67 6c6f 775f 7973 7464 2e6a 7065  ed_glow_ystd.jpe
+0000c1a0: 6727 0a20 2020 2020 2020 2020 2020 2073  g'.            s
+0000c1b0: 656c 662e 6d61 705f 746f 5f69 6d67 286d  elf.map_to_img(m
+0000c1c0: 6170 2c20 312c 2074 7970 652c 2065 7272  ap, 1, type, err
+0000c1d0: 6c69 7374 2c20 7365 6c66 2e67 6c6f 7769  list, self.glowi
+0000c1e0: 6d61 6765 290a 0a20 2020 2020 2020 2020  mage)..         
+0000c1f0: 2020 207a 7072 6f6a 6563 7469 6f6e 6e61     zprojectionna
+0000c200: 6d65 203d 2077 6f72 6b64 6972 202b 206d  me = workdir + m
+0000c210: 6170 6e61 6d65 202b 2027 5f7a 7374 642e  apname + '_zstd.
+0000c220: 6a70 6567 270a 2020 2020 2020 2020 2020  jpeg'.          
+0000c230: 2020 7a73 6361 6c65 6e61 6d65 203d 2077    zscalename = w
+0000c240: 6f72 6b64 6972 202b 206d 6170 6e61 6d65  orkdir + mapname
+0000c250: 202b 2027 5f73 6361 6c65 645f 7a73 7464   + '_scaled_zstd
+0000c260: 2e6a 7065 6727 0a20 2020 2020 2020 2020  .jpeg'.         
+0000c270: 2020 2067 6c6f 777a 7072 6f6a 6563 7469     glowzprojecti
+0000c280: 6f6e 6e61 6d65 203d 2077 6f72 6b64 6972  onname = workdir
+0000c290: 202b 206d 6170 6e61 6d65 202b 2027 5f67   + mapname + '_g
+0000c2a0: 6c6f 775f 7a73 7464 2e6a 7065 6727 0a20  low_zstd.jpeg'. 
+0000c2b0: 2020 2020 2020 2020 2020 2067 6c6f 777a             glowz
+0000c2c0: 7363 616c 656e 616d 6520 3d20 776f 726b  scalename = work
+0000c2d0: 6469 7220 2b20 6d61 706e 616d 6520 2b20  dir + mapname + 
+0000c2e0: 275f 7363 616c 6564 5f67 6c6f 775f 7a73  '_scaled_glow_zs
+0000c2f0: 7464 2e6a 7065 6727 0a20 2020 2020 2020  td.jpeg'.       
+0000c300: 2020 2020 2073 656c 662e 6d61 705f 746f       self.map_to
+0000c310: 5f69 6d67 286d 6170 2c20 302c 2074 7970  _img(map, 0, typ
+0000c320: 652c 2065 7272 6c69 7374 2c20 7365 6c66  e, errlist, self
+0000c330: 2e67 6c6f 7769 6d61 6765 290a 0a20 2020  .glowimage)..   
+0000c340: 2020 2020 2020 2020 2062 6f74 686a 736f           bothjso
+0000c350: 6e20 3d20 6469 6374 2829 0a20 2020 2020  n = dict().     
+0000c360: 2020 2020 2020 2070 726f 6a65 6374 696f         projectio
+0000c370: 6e6a 736f 6e20 3d20 6469 6374 2829 0a20  njson = dict(). 
+0000c380: 2020 2020 2020 2020 2020 206f 7267 7072             orgpr
+0000c390: 6f6a 6563 7469 6f6e 6a73 6f6e 203d 2064  ojectionjson = d
+0000c3a0: 6963 7428 290a 0a20 2020 2020 2020 2020  ict()..         
+0000c3b0: 2020 2070 726f 6a65 6374 696f 6e6a 736f     projectionjso
+0000c3c0: 6e5b 2778 275d 203d 206f 732e 7061 7468  n['x'] = os.path
+0000c3d0: 2e62 6173 656e 616d 6528 7873 6361 6c65  .basename(xscale
+0000c3e0: 6e61 6d65 2920 6966 206f 732e 7061 7468  name) if os.path
+0000c3f0: 2e69 7366 696c 6528 7873 6361 6c65 6e61  .isfile(xscalena
+0000c400: 6d65 2920 656c 7365 204e 6f6e 650a 2020  me) else None.  
+0000c410: 2020 2020 2020 2020 2020 7072 6f6a 6563            projec
+0000c420: 7469 6f6e 6a73 6f6e 5b27 7927 5d20 3d20  tionjson['y'] = 
+0000c430: 6f73 2e70 6174 682e 6261 7365 6e61 6d65  os.path.basename
+0000c440: 2879 7363 616c 656e 616d 6529 2069 6620  (yscalename) if 
+0000c450: 6f73 2e70 6174 682e 6973 6669 6c65 2879  os.path.isfile(y
+0000c460: 7363 616c 656e 616d 6529 2065 6c73 6520  scalename) else 
+0000c470: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+0000c480: 2070 726f 6a65 6374 696f 6e6a 736f 6e5b   projectionjson[
+0000c490: 277a 275d 203d 206f 732e 7061 7468 2e62  'z'] = os.path.b
+0000c4a0: 6173 656e 616d 6528 7a73 6361 6c65 6e61  asename(zscalena
+0000c4b0: 6d65 2920 6966 206f 732e 7061 7468 2e69  me) if os.path.i
+0000c4c0: 7366 696c 6528 7a73 6361 6c65 6e61 6d65  sfile(zscalename
+0000c4d0: 2920 656c 7365 204e 6f6e 650a 0a20 2020  ) else None..   
+0000c4e0: 2020 2020 2020 2020 206f 7267 7072 6f6a           orgproj
+0000c4f0: 6563 7469 6f6e 6a73 6f6e 5b27 7827 5d20  ectionjson['x'] 
+0000c500: 3d20 6f73 2e70 6174 682e 6261 7365 6e61  = os.path.basena
+0000c510: 6d65 2878 7072 6f6a 6563 7469 6f6e 6e61  me(xprojectionna
+0000c520: 6d65 2920 6966 206f 732e 7061 7468 2e69  me) if os.path.i
+0000c530: 7366 696c 6528 7870 726f 6a65 6374 696f  sfile(xprojectio
+0000c540: 6e6e 616d 6529 2065 6c73 6520 4e6f 6e65  nname) else None
+0000c550: 0a20 2020 2020 2020 2020 2020 206f 7267  .            org
+0000c560: 7072 6f6a 6563 7469 6f6e 6a73 6f6e 5b27  projectionjson['
+0000c570: 7927 5d20 3d20 6f73 2e70 6174 682e 6261  y'] = os.path.ba
+0000c580: 7365 6e61 6d65 2879 7072 6f6a 6563 7469  sename(yprojecti
+0000c590: 6f6e 6e61 6d65 2920 6966 206f 732e 7061  onname) if os.pa
+0000c5a0: 7468 2e69 7366 696c 6528 7970 726f 6a65  th.isfile(yproje
+0000c5b0: 6374 696f 6e6e 616d 6529 2065 6c73 6520  ctionname) else 
+0000c5c0: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+0000c5d0: 206f 7267 7072 6f6a 6563 7469 6f6e 6a73   orgprojectionjs
+0000c5e0: 6f6e 5b27 7a27 5d20 3d20 6f73 2e70 6174  on['z'] = os.pat
+0000c5f0: 682e 6261 7365 6e61 6d65 287a 7072 6f6a  h.basename(zproj
+0000c600: 6563 7469 6f6e 6e61 6d65 2920 6966 206f  ectionname) if o
+0000c610: 732e 7061 7468 2e69 7366 696c 6528 7a70  s.path.isfile(zp
+0000c620: 726f 6a65 6374 696f 6e6e 616d 6529 2065  rojectionname) e
+0000c630: 6c73 6520 4e6f 6e65 0a20 2020 2020 2020  lse None.       
+0000c640: 2020 2020 2062 6f74 686a 736f 6e5b 276f       bothjson['o
+0000c650: 7269 6769 6e61 6c27 5d20 3d20 6f72 6770  riginal'] = orgp
+0000c660: 726f 6a65 6374 696f 6e6a 736f 6e0a 2020  rojectionjson.  
+0000c670: 2020 2020 2020 2020 2020 626f 7468 6a73            bothjs
+0000c680: 6f6e 5b27 7363 616c 6564 275d 203d 2070  on['scaled'] = p
+0000c690: 726f 6a65 6374 696f 6e6a 736f 6e0a 0a20  rojectionjson.. 
+0000c6a0: 2020 2020 2020 2020 2020 2069 6620 6572             if er
+0000c6b0: 726c 6973 743a 0a20 2020 2020 2020 2020  rlist:.         
+0000c6c0: 2020 2020 2020 2062 6f74 686a 736f 6e5b         bothjson[
+0000c6d0: 2765 7272 275d 203d 207b 276f 7274 686f  'err'] = {'ortho
+0000c6e0: 676f 6e61 6c5f 7374 645f 6572 7227 3a20  gonal_std_err': 
+0000c6f0: 6572 726c 6973 747d 0a20 2020 2020 2020  errlist}.       
+0000c700: 2020 2020 2066 696e 616c 6469 6374 203d       finaldict =
+0000c710: 207b 6c61 6265 6c20 2b20 276f 7274 686f   {label + 'ortho
+0000c720: 676f 6e61 6c5f 7374 6427 3a20 626f 7468  gonal_std': both
+0000c730: 6a73 6f6e 7d0a 0a20 2020 2020 2020 2020  json}..         
+0000c740: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0000c750: 2020 2020 2020 2020 7769 7468 2063 6f64          with cod
+0000c760: 6563 732e 6f70 656e 2877 6f72 6b64 6972  ecs.open(workdir
+0000c770: 202b 206d 6170 6e61 6d65 202b 2027 5f73   + mapname + '_s
+0000c780: 7464 2e6a 736f 6e27 2c20 2777 272c 0a20  td.json', 'w',. 
+0000c790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c7b0: 656e 636f 6469 6e67 3d27 7574 662d 3827  encoding='utf-8'
+0000c7c0: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
+0000c7d0: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
+0000c7e0: 2e64 756d 7028 6669 6e61 6c64 6963 742c  .dump(finaldict,
+0000c7f0: 2066 290a 2020 2020 2020 2020 2020 2020   f).            
+0000c800: 6578 6365 7074 2049 4f45 7272 6f72 2061  except IOError a
+0000c810: 7320 696f 6572 723a 0a20 2020 2020 2020  s ioerr:.       
+0000c820: 2020 2020 2020 2020 206a 736f 6e65 7272           jsonerr
+0000c830: 203d 2027 5361 7669 6e67 2073 7464 2070   = 'Saving std p
+0000c840: 726f 6a65 6374 696f 6e20 696e 746f 206a  rojection into j
+0000c850: 736f 6e20 6572 726f 723a 207b 7d27 2e66  son error: {}'.f
+0000c860: 6f72 6d61 7428 696f 6572 7229 0a20 2020  ormat(ioerr).   
+0000c870: 2020 2020 2020 2020 2020 2020 2073 7973               sys
+0000c880: 2e73 7464 6572 722e 7772 6974 6528 6a73  .stderr.write(js
+0000c890: 6f6e 6572 7220 2b20 275c 6e27 290a 0a20  onerr + '\n').. 
+0000c8a0: 2020 2020 2020 2020 2020 2067 6c6f 7762             glowb
+0000c8b0: 6f74 686a 736f 6e20 3d20 6469 6374 2829  othjson = dict()
+0000c8c0: 0a20 2020 2020 2020 2020 2020 2067 6c6f  .            glo
+0000c8d0: 7770 726f 6a65 6374 696f 6e6a 736f 6e20  wprojectionjson 
+0000c8e0: 3d20 6469 6374 2829 0a20 2020 2020 2020  = dict().       
+0000c8f0: 2020 2020 2067 6c6f 776f 7267 7072 6f6a       gloworgproj
+0000c900: 6563 7469 6f6e 6a73 6f6e 203d 2064 6963  ectionjson = dic
+0000c910: 7428 290a 0a20 2020 2020 2020 2020 2020  t()..           
+0000c920: 2067 6c6f 7770 726f 6a65 6374 696f 6e6a   glowprojectionj
+0000c930: 736f 6e5b 2778 275d 203d 206f 732e 7061  son['x'] = os.pa
+0000c940: 7468 2e62 6173 656e 616d 6528 676c 6f77  th.basename(glow
+0000c950: 7873 6361 6c65 6e61 6d65 2920 6966 206f  xscalename) if o
+0000c960: 732e 7061 7468 2e69 7366 696c 6528 676c  s.path.isfile(gl
+0000c970: 6f77 7873 6361 6c65 6e61 6d65 2920 656c  owxscalename) el
+0000c980: 7365 204e 6f6e 650a 2020 2020 2020 2020  se None.        
+0000c990: 2020 2020 676c 6f77 7072 6f6a 6563 7469      glowprojecti
+0000c9a0: 6f6e 6a73 6f6e 5b27 7927 5d20 3d20 6f73  onjson['y'] = os
+0000c9b0: 2e70 6174 682e 6261 7365 6e61 6d65 2867  .path.basename(g
+0000c9c0: 6c6f 7779 7363 616c 656e 616d 6529 2069  lowyscalename) i
+0000c9d0: 6620 6f73 2e70 6174 682e 6973 6669 6c65  f os.path.isfile
+0000c9e0: 2867 6c6f 7779 7363 616c 656e 616d 6529  (glowyscalename)
+0000c9f0: 2065 6c73 6520 4e6f 6e65 0a20 2020 2020   else None.     
+0000ca00: 2020 2020 2020 2067 6c6f 7770 726f 6a65         glowproje
+0000ca10: 6374 696f 6e6a 736f 6e5b 277a 275d 203d  ctionjson['z'] =
+0000ca20: 206f 732e 7061 7468 2e62 6173 656e 616d   os.path.basenam
+0000ca30: 6528 676c 6f77 7a73 6361 6c65 6e61 6d65  e(glowzscalename
+0000ca40: 2920 6966 206f 732e 7061 7468 2e69 7366  ) if os.path.isf
+0000ca50: 696c 6528 676c 6f77 7a73 6361 6c65 6e61  ile(glowzscalena
+0000ca60: 6d65 2920 656c 7365 204e 6f6e 650a 0a20  me) else None.. 
+0000ca70: 2020 2020 2020 2020 2020 2067 6c6f 776f             glowo
+0000ca80: 7267 7072 6f6a 6563 7469 6f6e 6a73 6f6e  rgprojectionjson
+0000ca90: 5b27 7827 5d20 3d20 6f73 2e70 6174 682e  ['x'] = os.path.
+0000caa0: 6261 7365 6e61 6d65 2867 6c6f 7778 7072  basename(glowxpr
+0000cab0: 6f6a 6563 7469 6f6e 6e61 6d65 2920 6966  ojectionname) if
+0000cac0: 206f 732e 7061 7468 2e69 7366 696c 6528   os.path.isfile(
+0000cad0: 676c 6f77 7870 726f 6a65 6374 696f 6e6e  glowxprojectionn
+0000cae0: 616d 6529 2065 6c73 6520 4e6f 6e65 0a20  ame) else None. 
+0000caf0: 2020 2020 2020 2020 2020 2067 6c6f 776f             glowo
+0000cb00: 7267 7072 6f6a 6563 7469 6f6e 6a73 6f6e  rgprojectionjson
+0000cb10: 5b27 7927 5d20 3d20 6f73 2e70 6174 682e  ['y'] = os.path.
+0000cb20: 6261 7365 6e61 6d65 2867 6c6f 7779 7072  basename(glowypr
+0000cb30: 6f6a 6563 7469 6f6e 6e61 6d65 2920 6966  ojectionname) if
+0000cb40: 206f 732e 7061 7468 2e69 7366 696c 6528   os.path.isfile(
+0000cb50: 676c 6f77 7970 726f 6a65 6374 696f 6e6e  glowyprojectionn
+0000cb60: 616d 6529 2065 6c73 6520 4e6f 6e65 0a20  ame) else None. 
+0000cb70: 2020 2020 2020 2020 2020 2067 6c6f 776f             glowo
+0000cb80: 7267 7072 6f6a 6563 7469 6f6e 6a73 6f6e  rgprojectionjson
+0000cb90: 5b27 7a27 5d20 3d20 6f73 2e70 6174 682e  ['z'] = os.path.
+0000cba0: 6261 7365 6e61 6d65 2867 6c6f 777a 7072  basename(glowzpr
+0000cbb0: 6f6a 6563 7469 6f6e 6e61 6d65 2920 6966  ojectionname) if
+0000cbc0: 206f 732e 7061 7468 2e69 7366 696c 6528   os.path.isfile(
+0000cbd0: 676c 6f77 7a70 726f 6a65 6374 696f 6e6e  glowzprojectionn
+0000cbe0: 616d 6529 2065 6c73 6520 4e6f 6e65 0a0a  ame) else None..
+0000cbf0: 2020 2020 2020 2020 2020 2020 676c 6f77              glow
+0000cc00: 626f 7468 6a73 6f6e 5b27 6f72 6967 696e  bothjson['origin
+0000cc10: 616c 275d 203d 2067 6c6f 776f 7267 7072  al'] = gloworgpr
+0000cc20: 6f6a 6563 7469 6f6e 6a73 6f6e 0a20 2020  ojectionjson.   
+0000cc30: 2020 2020 2020 2020 2067 6c6f 7762 6f74           glowbot
+0000cc40: 686a 736f 6e5b 2773 6361 6c65 6427 5d20  hjson['scaled'] 
+0000cc50: 3d20 676c 6f77 7072 6f6a 6563 7469 6f6e  = glowprojection
+0000cc60: 6a73 6f6e 0a0a 2020 2020 2020 2020 2020  json..          
+0000cc70: 2020 6966 2065 7272 6c69 7374 3a0a 2020    if errlist:.  
+0000cc80: 2020 2020 2020 2020 2020 2020 2020 676c                gl
+0000cc90: 6f77 626f 7468 6a73 6f6e 5b27 6572 7227  owbothjson['err'
+0000cca0: 5d20 3d20 7b27 6f72 7468 6f67 6f6e 616c  ] = {'orthogonal
+0000ccb0: 5f67 6c6f 775f 7374 645f 6572 7227 3a20  _glow_std_err': 
+0000ccc0: 6572 726c 6973 747d 0a20 2020 2020 2020  errlist}.       
+0000ccd0: 2020 2020 2067 6c6f 7766 696e 616c 6469       glowfinaldi
+0000cce0: 6374 203d 207b 6c61 6265 6c20 2b20 276f  ct = {label + 'o
+0000ccf0: 7274 686f 676f 6e61 6c5f 676c 6f77 5f73  rthogonal_glow_s
+0000cd00: 7464 273a 2067 6c6f 7762 6f74 686a 736f  td': glowbothjso
+0000cd10: 6e7d 0a0a 2020 2020 2020 2020 2020 2020  n}..            
+0000cd20: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0000cd30: 2020 2020 2077 6974 6820 636f 6465 6373       with codecs
+0000cd40: 2e6f 7065 6e28 776f 726b 6469 7220 2b20  .open(workdir + 
+0000cd50: 6d61 706e 616d 6520 2b20 275f 676c 6f77  mapname + '_glow
+0000cd60: 5f73 7464 2e6a 736f 6e27 2c20 2777 272c  _std.json', 'w',
+0000cd70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000cd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cd90: 2020 656e 636f 6469 6e67 3d27 7574 662d    encoding='utf-
+0000cda0: 3827 2920 6173 2066 3a0a 2020 2020 2020  8') as f:.      
+0000cdb0: 2020 2020 2020 2020 2020 2020 2020 6a73                js
+0000cdc0: 6f6e 2e64 756d 7028 676c 6f77 6669 6e61  on.dump(glowfina
+0000cdd0: 6c64 6963 742c 2066 290a 2020 2020 2020  ldict, f).      
+0000cde0: 2020 2020 2020 6578 6365 7074 2049 4f45        except IOE
+0000cdf0: 7272 6f72 2061 7320 696f 6572 723a 0a20  rror as ioerr:. 
+0000ce00: 2020 2020 2020 2020 2020 2020 2020 206a                 j
+0000ce10: 736f 6e65 7272 203d 2027 5361 7669 6e67  sonerr = 'Saving
+0000ce20: 2067 6c6f 7720 7374 6420 7072 6f6a 6563   glow std projec
+0000ce30: 7469 6f6e 2069 6e74 6f20 6a73 6f6e 2065  tion into json e
+0000ce40: 7272 6f72 3a20 7b7d 272e 666f 726d 6174  rror: {}'.format
+0000ce50: 2869 6f65 7272 290a 2020 2020 2020 2020  (ioerr).        
+0000ce60: 2020 2020 2020 2020 7379 732e 7374 6465          sys.stde
+0000ce70: 7272 2e77 7269 7465 286a 736f 6e65 7272  rr.write(jsonerr
+0000ce80: 202b 2027 5c6e 2729 0a0a 2020 2020 2020   + '\n')..      
+0000ce90: 2020 2020 2020 656e 6420 3d20 7469 6d65        end = time
+0000cea0: 6974 2e64 6566 6175 6c74 5f74 696d 6572  it.default_timer
+0000ceb0: 2829 0a20 2020 2020 2020 2020 2020 2070  ().            p
+0000cec0: 7269 6e74 2827 476c 6f77 2061 6e64 2073  rint('Glow and s
+0000ced0: 7464 2070 726f 6a65 6374 696f 6e73 2074  td projections t
+0000cee0: 696d 6520 666f 7220 2573 3a20 2573 2720  ime for %s: %s' 
+0000cef0: 2520 286d 6170 6e61 6d65 2c20 656e 6420  % (mapname, end 
+0000cf00: 2d20 7374 6172 7429 290a 2020 2020 2020  - start)).      
+0000cf10: 2020 2020 2020 7072 696e 7428 272d 2d2d        print('---
+0000cf20: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000cf30: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000cf40: 2d27 290a 0a20 2020 2020 2020 2065 6c73  -')..        els
+0000cf50: 653a 0a20 2020 2020 2020 2020 2020 2070  e:.            p
+0000cf60: 7269 6e74 2827 4e6f 2067 6c6f 7720 616e  rint('No glow an
+0000cf70: 6420 7374 6420 7072 6f6a 6563 7469 6f6e  d std projection
+0000cf80: 7320 7769 7468 6f75 7420 7072 6f70 6572  s without proper
+0000cf90: 206d 6170 2069 6e70 7574 2061 6e64 2074   map input and t
+0000cfa0: 6865 206f 7574 7075 7420 6469 7265 6374  he output direct
+0000cfb0: 6f72 7920 696e 666f 726d 6174 696f 6e2e  ory information.
+0000cfc0: 2729 0a0a 2020 2020 2020 2020 7265 7475  ')..        retu
+0000cfd0: 726e 204e 6f6e 650a 0a0a 2020 2020 2320  rn None...    # 
+0000cfe0: 4070 726f 6669 6c65 0a20 2020 2064 6566  @profile.    def
+0000cff0: 2072 6177 6d61 705f 7374 6428 7365 6c66   rawmap_std(self
+0000d000: 293a 0a0a 2020 2020 2020 2020 7261 776d  ):..        rawm
+0000d010: 6170 203d 2073 656c 662e 7261 776d 6170  ap = self.rawmap
+0000d020: 0a20 2020 2020 2020 2069 6620 7261 776d  .        if rawm
+0000d030: 6170 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ap is not None:.
+0000d040: 2020 2020 2020 2020 2020 2020 6469 7220              dir 
+0000d050: 3d20 7365 6c66 2e77 6f72 6b64 6972 0a20  = self.workdir. 
+0000d060: 2020 2020 2020 2020 2020 206c 6162 656c             label
+0000d070: 203d 2027 7261 776d 6170 5f27 0a20 2020   = 'rawmap_'.   
+0000d080: 2020 2020 2020 2020 2073 656c 662e 6f72           self.or
+0000d090: 7468 6f67 6f6e 616c 5f73 7464 2872 6177  thogonal_std(raw
+0000d0a0: 6d61 702c 2064 6972 2c20 6c61 6265 6c29  map, dir, label)
+0000d0b0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0000d0c0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0000d0d0: 2827 4e6f 2072 6177 206d 6170 2074 6f20  ('No raw map to 
+0000d0e0: 6361 6c63 756c 6174 6520 6f72 7468 6f67  calculate orthog
+0000d0f0: 6f6e 616c 2073 7464 2070 726f 6a65 6374  onal std project
+0000d100: 696f 6e73 2e27 290a 0a20 2020 2023 2043  ions.')..    # C
+0000d110: 656e 7472 616c 2073 6c69 6365 730a 0a20  entral slices.. 
+0000d120: 2020 2023 2040 7072 6f66 696c 650a 2020     # @profile.  
+0000d130: 2020 6465 6620 6365 6e74 7261 6c5f 736c    def central_sl
+0000d140: 6963 6528 7365 6c66 2c20 6d61 7069 6e3d  ice(self, mapin=
+0000d150: 4e6f 6e65 2c20 776f 726b 6469 723d 4e6f  None, workdir=No
+0000d160: 6e65 2c20 6c61 6265 6c3d 2727 293a 0a20  ne, label=''):. 
+0000d170: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0000d180: 2020 2020 2020 2020 5374 6420 7072 6f6a          Std proj
+0000d190: 6563 7469 6f6e 2061 6e64 2069 7420 676c  ection and it gl
+0000d1a0: 6f77 2069 6d61 6765 0a20 2020 2020 2020  ow image.       
+0000d1b0: 203a 7061 7261 6d20 6d61 7069 6e3a 2049   :param mapin: I
+0000d1c0: 6e70 7574 206d 6170 2065 6974 6865 7220  nput map either 
+0000d1d0: 6d72 6366 696c 6520 6f72 2066 696c 656e  mrcfile or filen
+0000d1e0: 616d 6520 7374 7269 6e67 0a20 2020 2020  ame string.     
+0000d1f0: 2020 203a 7061 7261 6d20 776f 726b 6469     :param workdi
+0000d200: 723a 2053 7472 696e 6720 6f66 2074 6865  r: String of the
+0000d210: 2066 756c 6c20 776f 726b 2070 6174 680a   full work path.
+0000d220: 2020 2020 2020 2020 3a70 6172 616d 206c          :param l
+0000d230: 6162 656c 3a20 666f 7220 7261 7720 6d61  abel: for raw ma
+0000d240: 7020 7573 6520 2772 6177 5f27 0a20 2020  p use 'raw_'.   
+0000d250: 2020 2020 203a 7265 7475 726e 3a20 4e6f       :return: No
+0000d260: 6e65 0a20 2020 2020 2020 2022 2222 0a0a  ne.        """..
+0000d270: 2020 2020 2020 2020 6d61 702c 2077 6f72          map, wor
+0000d280: 6b64 6972 203d 2073 656c 662e 6d61 7069  kdir = self.mapi
+0000d290: 6e63 6865 636b 286d 6170 696e 2c20 776f  ncheck(mapin, wo
+0000d2a0: 726b 6469 7229 0a20 2020 2020 2020 206d  rkdir).        m
+0000d2b0: 6170 6e61 6d65 203d 206f 732e 7061 7468  apname = os.path
+0000d2c0: 2e62 6173 656e 616d 6528 6d61 702e 6675  .basename(map.fu
+0000d2d0: 6c6c 6e61 6d65 2920 6966 206d 6170 2065  llname) if map e
+0000d2e0: 6c73 6520 4e6f 6e65 0a20 2020 2020 2020  lse None.       
+0000d2f0: 2069 6620 6d61 7020 6973 206e 6f74 204e   if map is not N
+0000d300: 6f6e 6520 616e 6420 776f 726b 6469 7220  one and workdir 
+0000d310: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+0000d320: 2020 2020 2020 2020 2073 7461 7274 203d           start =
+0000d330: 2074 696d 6569 742e 6465 6661 756c 745f   timeit.default_
+0000d340: 7469 6d65 7228 290a 2020 2020 2020 2020  timer().        
+0000d350: 2020 2020 6572 726c 6973 7420 3d20 5b5d      errlist = []
+0000d360: 0a0a 2020 2020 2020 2020 2020 2020 7870  ..            xp
+0000d370: 726f 6a65 6374 696f 6e6e 616d 6520 3d20  rojectionname = 
+0000d380: 776f 726b 6469 7220 2b20 6d61 706e 616d  workdir + mapnam
+0000d390: 6520 2b20 275f 7863 656e 7472 616c 5f73  e + '_xcentral_s
+0000d3a0: 6c69 6365 2e6a 7065 6727 0a20 2020 2020  lice.jpeg'.     
+0000d3b0: 2020 2020 2020 2078 7363 616c 656e 616d         xscalenam
+0000d3c0: 6520 3d20 776f 726b 6469 7220 2b20 6d61  e = workdir + ma
+0000d3d0: 706e 616d 6520 2b20 275f 7363 616c 6564  pname + '_scaled
+0000d3e0: 5f78 6365 6e74 7261 6c5f 736c 6963 652e  _xcentral_slice.
+0000d3f0: 6a70 6567 270a 2020 2020 2020 2020 2020  jpeg'.          
+0000d400: 2020 7479 7065 203d 2027 6365 6e74 7261    type = 'centra
+0000d410: 6c27 0a20 2020 2020 2020 2020 2020 2073  l'.            s
+0000d420: 656c 662e 6d61 705f 746f 5f69 6d67 286d  elf.map_to_img(m
+0000d430: 6170 2c20 322c 2074 7970 652c 2065 7272  ap, 2, type, err
+0000d440: 6c69 7374 290a 0a20 2020 2020 2020 2020  list)..         
+0000d450: 2020 2079 7072 6f6a 6563 7469 6f6e 6e61     yprojectionna
+0000d460: 6d65 203d 2077 6f72 6b64 6972 202b 206d  me = workdir + m
+0000d470: 6170 6e61 6d65 202b 2027 5f79 6365 6e74  apname + '_ycent
+0000d480: 7261 6c5f 736c 6963 652e 6a70 6567 270a  ral_slice.jpeg'.
+0000d490: 2020 2020 2020 2020 2020 2020 7973 6361              ysca
+0000d4a0: 6c65 6e61 6d65 203d 2077 6f72 6b64 6972  lename = workdir
+0000d4b0: 202b 206d 6170 6e61 6d65 202b 2027 5f73   + mapname + '_s
+0000d4c0: 6361 6c65 645f 7963 656e 7472 616c 5f73  caled_ycentral_s
+0000d4d0: 6c69 6365 2e6a 7065 6727 0a20 2020 2020  lice.jpeg'.     
+0000d4e0: 2020 2020 2020 2073 656c 662e 6d61 705f         self.map_
+0000d4f0: 746f 5f69 6d67 286d 6170 2c20 312c 2074  to_img(map, 1, t
+0000d500: 7970 652c 2065 7272 6c69 7374 290a 0a20  ype, errlist).. 
+0000d510: 2020 2020 2020 2020 2020 207a 7072 6f6a             zproj
+0000d520: 6563 7469 6f6e 6e61 6d65 203d 2077 6f72  ectionname = wor
+0000d530: 6b64 6972 202b 206d 6170 6e61 6d65 202b  kdir + mapname +
+0000d540: 2027 5f7a 6365 6e74 7261 6c5f 736c 6963   '_zcentral_slic
+0000d550: 652e 6a70 6567 270a 2020 2020 2020 2020  e.jpeg'.        
+0000d560: 2020 2020 7a73 6361 6c65 6e61 6d65 203d      zscalename =
+0000d570: 2077 6f72 6b64 6972 202b 206d 6170 6e61   workdir + mapna
+0000d580: 6d65 202b 2027 5f73 6361 6c65 645f 7a63  me + '_scaled_zc
+0000d590: 656e 7472 616c 5f73 6c69 6365 2e6a 7065  entral_slice.jpe
+0000d5a0: 6727 0a20 2020 2020 2020 2020 2020 2073  g'.            s
+0000d5b0: 656c 662e 6d61 705f 746f 5f69 6d67 286d  elf.map_to_img(m
+0000d5c0: 6170 2c20 302c 2074 7970 652c 2065 7272  ap, 0, type, err
+0000d5d0: 6c69 7374 290a 0a20 2020 2020 2020 2020  list)..         
+0000d5e0: 2020 2078 6d69 6420 3d20 696e 7428 666c     xmid = int(fl
+0000d5f0: 6f61 7428 6d61 702e 6865 6164 6572 2e6e  oat(map.header.n
+0000d600: 7829 202f 2032 290a 2020 2020 2020 2020  x) / 2).        
+0000d610: 2020 2020 796d 6964 203d 2069 6e74 2866      ymid = int(f
+0000d620: 6c6f 6174 286d 6170 2e68 6561 6465 722e  loat(map.header.
+0000d630: 6e79 2920 2f20 3229 0a20 2020 2020 2020  ny) / 2).       
+0000d640: 2020 2020 207a 6d69 6420 3d20 696e 7428       zmid = int(
+0000d650: 666c 6f61 7428 6d61 702e 6865 6164 6572  float(map.header
+0000d660: 2e6e 7a29 202f 2032 290a 2020 2020 2020  .nz) / 2).      
+0000d670: 2020 2020 2020 696e 6469 6365 7320 3d20        indices = 
+0000d680: 7b27 7827 3a20 786d 6964 2c20 2779 273a  {'x': xmid, 'y':
+0000d690: 2079 6d69 642c 2027 7a27 3a20 7a6d 6964   ymid, 'z': zmid
+0000d6a0: 7d0a 0a20 2020 2020 2020 2020 2020 2062  }..            b
+0000d6b0: 6f74 686a 736f 6e20 3d20 6469 6374 2829  othjson = dict()
+0000d6c0: 0a20 2020 2020 2020 2020 2020 2070 726f  .            pro
+0000d6d0: 6a65 6374 696f 6e6a 736f 6e20 3d20 6469  jectionjson = di
+0000d6e0: 6374 2829 0a20 2020 2020 2020 2020 2020  ct().           
+0000d6f0: 206f 7267 7072 6f6a 6563 7469 6f6e 6a73   orgprojectionjs
+0000d700: 6f6e 203d 2064 6963 7428 290a 0a20 2020  on = dict()..   
+0000d710: 2020 2020 2020 2020 2070 726f 6a65 6374           project
+0000d720: 696f 6e6a 736f 6e5b 2778 275d 203d 206f  ionjson['x'] = o
+0000d730: 732e 7061 7468 2e62 6173 656e 616d 6528  s.path.basename(
+0000d740: 7873 6361 6c65 6e61 6d65 2920 6966 206f  xscalename) if o
+0000d750: 732e 7061 7468 2e69 7366 696c 6528 7873  s.path.isfile(xs
+0000d760: 6361 6c65 6e61 6d65 2920 656c 7365 204e  calename) else N
+0000d770: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+0000d780: 7072 6f6a 6563 7469 6f6e 6a73 6f6e 5b27  projectionjson['
+0000d790: 7927 5d20 3d20 6f73 2e70 6174 682e 6261  y'] = os.path.ba
+0000d7a0: 7365 6e61 6d65 2879 7363 616c 656e 616d  sename(yscalenam
+0000d7b0: 6529 2069 6620 6f73 2e70 6174 682e 6973  e) if os.path.is
+0000d7c0: 6669 6c65 2879 7363 616c 656e 616d 6529  file(yscalename)
+0000d7d0: 2065 6c73 6520 4e6f 6e65 0a20 2020 2020   else None.     
+0000d7e0: 2020 2020 2020 2070 726f 6a65 6374 696f         projectio
+0000d7f0: 6e6a 736f 6e5b 277a 275d 203d 206f 732e  njson['z'] = os.
+0000d800: 7061 7468 2e62 6173 656e 616d 6528 7a73  path.basename(zs
+0000d810: 6361 6c65 6e61 6d65 2920 6966 206f 732e  calename) if os.
+0000d820: 7061 7468 2e69 7366 696c 6528 7a73 6361  path.isfile(zsca
+0000d830: 6c65 6e61 6d65 2920 656c 7365 204e 6f6e  lename) else Non
+0000d840: 650a 0a20 2020 2020 2020 2020 2020 206f  e..            o
+0000d850: 7267 7072 6f6a 6563 7469 6f6e 6a73 6f6e  rgprojectionjson
+0000d860: 5b27 7827 5d20 3d20 6f73 2e70 6174 682e  ['x'] = os.path.
+0000d870: 6261 7365 6e61 6d65 2878 7072 6f6a 6563  basename(xprojec
+0000d880: 7469 6f6e 6e61 6d65 2920 6966 206f 732e  tionname) if os.
+0000d890: 7061 7468 2e69 7366 696c 6528 7870 726f  path.isfile(xpro
+0000d8a0: 6a65 6374 696f 6e6e 616d 6529 2065 6c73  jectionname) els
+0000d8b0: 6520 4e6f 6e65 0a20 2020 2020 2020 2020  e None.         
+0000d8c0: 2020 206f 7267 7072 6f6a 6563 7469 6f6e     orgprojection
+0000d8d0: 6a73 6f6e 5b27 7927 5d20 3d20 6f73 2e70  json['y'] = os.p
+0000d8e0: 6174 682e 6261 7365 6e61 6d65 2879 7072  ath.basename(ypr
+0000d8f0: 6f6a 6563 7469 6f6e 6e61 6d65 2920 6966  ojectionname) if
+0000d900: 206f 732e 7061 7468 2e69 7366 696c 6528   os.path.isfile(
+0000d910: 7970 726f 6a65 6374 696f 6e6e 616d 6529  yprojectionname)
+0000d920: 2065 6c73 6520 4e6f 6e65 0a20 2020 2020   else None.     
+0000d930: 2020 2020 2020 206f 7267 7072 6f6a 6563         orgprojec
+0000d940: 7469 6f6e 6a73 6f6e 5b27 7a27 5d20 3d20  tionjson['z'] = 
+0000d950: 6f73 2e70 6174 682e 6261 7365 6e61 6d65  os.path.basename
+0000d960: 287a 7072 6f6a 6563 7469 6f6e 6e61 6d65  (zprojectionname
+0000d970: 2920 6966 206f 732e 7061 7468 2e69 7366  ) if os.path.isf
+0000d980: 696c 6528 7a70 726f 6a65 6374 696f 6e6e  ile(zprojectionn
+0000d990: 616d 6529 2065 6c73 6520 4e6f 6e65 0a0a  ame) else None..
+0000d9a0: 2020 2020 2020 2020 2020 2020 626f 7468              both
+0000d9b0: 6a73 6f6e 5b27 6f72 6967 696e 616c 275d  json['original']
+0000d9c0: 203d 206f 7267 7072 6f6a 6563 7469 6f6e   = orgprojection
+0000d9d0: 6a73 6f6e 0a20 2020 2020 2020 2020 2020  json.           
+0000d9e0: 2062 6f74 686a 736f 6e5b 2773 6361 6c65   bothjson['scale
+0000d9f0: 6427 5d20 3d20 7072 6f6a 6563 7469 6f6e  d'] = projection
+0000da00: 6a73 6f6e 0a20 2020 2020 2020 2020 2020  json.           
+0000da10: 2062 6f74 686a 736f 6e5b 2769 6e64 6963   bothjson['indic
+0000da20: 6573 275d 203d 2069 6e64 6963 6573 0a0a  es'] = indices..
+0000da30: 2020 2020 2020 2020 2020 2020 6966 2065              if e
+0000da40: 7272 6c69 7374 3a0a 2020 2020 2020 2020  rrlist:.        
+0000da50: 2020 2020 2020 2020 626f 7468 6a73 6f6e          bothjson
+0000da60: 5b27 6572 7227 5d20 3d20 7b27 6365 6e74  ['err'] = {'cent
+0000da70: 7261 6c5f 736c 6963 655f 6572 7227 3a20  ral_slice_err': 
+0000da80: 6572 726c 6973 747d 0a20 2020 2020 2020  errlist}.       
+0000da90: 2020 2020 2066 696e 616c 6469 6374 203d       finaldict =
+0000daa0: 207b 6c61 6265 6c20 2b20 2763 656e 7472   {label + 'centr
+0000dab0: 616c 5f73 6c69 6365 273a 2062 6f74 686a  al_slice': bothj
+0000dac0: 736f 6e7d 0a0a 2020 2020 2020 2020 2020  son}..          
+0000dad0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+0000dae0: 2020 2020 2020 2077 6974 6820 636f 6465         with code
+0000daf0: 6373 2e6f 7065 6e28 776f 726b 6469 7220  cs.open(workdir 
+0000db00: 2b20 6d61 706e 616d 6520 2b20 275f 6365  + mapname + '_ce
+0000db10: 6e74 7261 6c73 6c69 6365 2e6a 736f 6e27  ntralslice.json'
+0000db20: 2c20 2777 272c 2065 6e63 6f64 696e 673d  , 'w', encoding=
+0000db30: 2775 7466 2d38 2729 2061 7320 663a 0a20  'utf-8') as f:. 
+0000db40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000db50: 2020 206a 736f 6e2e 6475 6d70 2866 696e     json.dump(fin
+0000db60: 616c 6469 6374 2c20 6629 0a20 2020 2020  aldict, f).     
+0000db70: 2020 2020 2020 2065 7863 6570 7420 494f         except IO
+0000db80: 4572 726f 7220 6173 2069 6f65 7272 3a0a  Error as ioerr:.
+0000db90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dba0: 6a73 6f6e 6572 7220 3d20 2753 6176 696e  jsonerr = 'Savin
+0000dbb0: 6720 6365 6e74 7261 6c20 736c 6963 6520  g central slice 
+0000dbc0: 696e 746f 206a 736f 6e20 6572 726f 723a  into json error:
+0000dbd0: 207b 7d27 2e66 6f72 6d61 7428 696f 6572   {}'.format(ioer
+0000dbe0: 7229 0a20 2020 2020 2020 2020 2020 2020  r).             
+0000dbf0: 2020 2073 7973 2e73 7464 6572 722e 7772     sys.stderr.wr
+0000dc00: 6974 6528 6a73 6f6e 6572 7220 2b20 275c  ite(jsonerr + '\
+0000dc10: 6e27 290a 0a20 2020 2020 2020 2020 2020  n')..           
+0000dc20: 2065 6e64 203d 2074 696d 6569 742e 6465   end = timeit.de
+0000dc30: 6661 756c 745f 7469 6d65 7228 290a 2020  fault_timer().  
+0000dc40: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0000dc50: 2743 656e 7472 616c 2073 6c69 6365 2074  'Central slice t
+0000dc60: 696d 6520 666f 7220 2573 3a20 2573 2720  ime for %s: %s' 
+0000dc70: 2520 286d 6170 6e61 6d65 2c20 656e 6420  % (mapname, end 
+0000dc80: 2d20 7374 6172 7429 290a 2020 2020 2020  - start)).      
+0000dc90: 2020 2020 2020 7072 696e 7428 272d 2d2d        print('---
+0000dca0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000dcb0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000dcc0: 2d27 290a 0a20 2020 2020 2020 2065 6c73  -')..        els
+0000dcd0: 653a 0a20 2020 2020 2020 2020 2020 2070  e:.            p
+0000dce0: 7269 6e74 280a 2020 2020 2020 2020 2020  rint(.          
+0000dcf0: 2020 2020 2020 274e 6f20 6365 6e74 7261        'No centra
+0000dd00: 6c20 736c 6963 6520 7769 7468 6f75 7420  l slice without 
+0000dd10: 7072 6f70 6572 206d 6170 2069 6e70 7574  proper map input
+0000dd20: 2061 6e64 2074 6865 206f 7574 7075 7420   and the output 
+0000dd30: 6469 7265 6374 6f72 7920 696e 666f 726d  directory inform
+0000dd40: 6174 696f 6e2e 2729 0a0a 2020 2020 2020  ation.')..      
+0000dd50: 2020 7265 7475 726e 204e 6f6e 650a 0a20    return None.. 
+0000dd60: 2020 2064 6566 2072 6177 6d61 705f 6365     def rawmap_ce
+0000dd70: 6e74 7261 6c5f 736c 6963 6528 7365 6c66  ntral_slice(self
+0000dd80: 293a 0a0a 2020 2020 2020 2020 7261 776d  ):..        rawm
+0000dd90: 6170 203d 2073 656c 662e 7261 776d 6170  ap = self.rawmap
+0000dda0: 0a20 2020 2020 2020 2069 6620 7261 776d  .        if rawm
+0000ddb0: 6170 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ap is not None:.
+0000ddc0: 2020 2020 2020 2020 2020 2020 6469 7220              dir 
+0000ddd0: 3d20 7365 6c66 2e77 6f72 6b64 6972 0a20  = self.workdir. 
+0000dde0: 2020 2020 2020 2020 2020 206c 6162 656c             label
+0000ddf0: 203d 2027 7261 776d 6170 5f27 0a20 2020   = 'rawmap_'.   
+0000de00: 2020 2020 2020 2020 2073 656c 662e 6365           self.ce
+0000de10: 6e74 7261 6c5f 736c 6963 6528 7261 776d  ntral_slice(rawm
+0000de20: 6170 2c20 6469 722c 206c 6162 656c 290a  ap, dir, label).
+0000de30: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0000de40: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0000de50: 274e 6f20 7261 7720 6d61 7020 746f 2063  'No raw map to c
+0000de60: 616c 6375 6c61 7465 2063 656e 7472 616c  alculate central
+0000de70: 2073 6c69 6365 2e27 290a 0a20 2020 2023   slice.')..    #
+0000de80: 2040 7072 6f66 696c 650a 2020 2020 6465   @profile.    de
+0000de90: 6620 7261 776d 6170 5f6c 6172 6765 7374  f rawmap_largest
+0000dea0: 5f76 6172 6961 6e63 6528 7365 6c66 293a  _variance(self):
+0000deb0: 0a0a 2020 2020 2020 2020 7261 776d 6170  ..        rawmap
+0000dec0: 203d 2073 656c 662e 7261 776d 6170 0a20   = self.rawmap. 
+0000ded0: 2020 2020 2020 2069 6620 7261 776d 6170         if rawmap
+0000dee0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+0000def0: 2020 2020 2020 2020 2020 6469 7220 3d20            dir = 
+0000df00: 7365 6c66 2e77 6f72 6b64 6972 0a20 2020  self.workdir.   
+0000df10: 2020 2020 2020 2020 206c 6162 656c 203d           label =
+0000df20: 2022 7261 776d 6170 5f22 0a20 2020 2020   "rawmap_".     
+0000df30: 2020 2020 2020 2073 656c 662e 6c61 7267         self.larg
+0000df40: 6573 745f 7661 7269 616e 6365 2872 6177  est_variance(raw
+0000df50: 6d61 702c 2064 6972 2c20 6c61 6265 6c29  map, dir, label)
 0000df60: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
 0000df70: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-0000df80: 2827 4e6f 2063 6f6e 746f 7572 206c 6576  ('No contour lev
-0000df90: 656c 2c20 6e6f 2073 7572 6661 6365 2076  el, no surface v
-0000dfa0: 6965 772e 2729 0a20 2020 2020 2020 2020  iew.').         
-0000dfb0: 2020 2070 7269 6e74 2827 2d2d 2d2d 2d2d     print('------
-0000dfc0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0000dfd0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2729  --------------')
-0000dfe0: 0a0a 2020 2020 2320 5375 7266 6163 6520  ..    # Surface 
-0000dff0: 7669 6577 2056 544b 2077 6179 0a20 2020  view VTK way.   
-0000e000: 2064 6566 2073 7572 6661 6365 7669 6577   def surfaceview
-0000e010: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0000e020: 2222 220a 0a20 2020 2020 2020 2020 2020  """..           
-0000e030: 2050 726f 6475 6365 2073 7572 6661 6365   Produce surface
-0000e040: 2076 6965 7773 2066 726f 6d20 582c 2079   views from X, y
-0000e050: 2c20 5a20 6469 7265 6374 696f 6e73 2e20  , Z directions. 
-0000e060: 5768 656e 206d 6f64 656c 2069 7320 7468  When model is th
-0000e070: 6572 652c 0a20 2020 2020 2020 2020 2020  ere,.           
-0000e080: 206d 6f64 656c 2061 6e64 206d 6170 2073   model and map s
-0000e090: 7572 6661 6365 2076 6965 7773 2066 6f72  urface views for
-0000e0a0: 2078 2c20 792c 207a 2064 6972 6563 7469   x, y, z directi
-0000e0b0: 6f6e 7320 7765 7265 2070 726f 6475 6365  ons were produce
-0000e0c0: 642e 0a20 2020 2020 2020 2020 2020 2054  d..            T
-0000e0d0: 6869 7320 6973 206f 6e6c 7920 706f 7373  his is only poss
-0000e0e0: 6962 6c65 2077 6865 6e20 7765 2072 756e  ible when we run
-0000e0f0: 206f 6e20 7468 6520 7365 7276 6572 2073   on the server s
-0000e100: 6964 6520 6173 2069 7420 6e65 6564 730a  ide as it needs.
-0000e110: 2020 2020 2020 2020 2020 2020 7674 7020              vtp 
-0000e120: 6669 6c65 732e 2054 6861 7420 6d65 616e  files. That mean
-0000e130: 7320 6974 2061 6c73 6f20 6e65 6564 2074  s it also need t
-0000e140: 6865 2065 6d64 6964 2074 6f20 7072 6f64  he emdid to prod
-0000e150: 7563 6520 7468 650a 2020 2020 2020 2020  uce the.        
-0000e160: 2020 2020 7375 7266 6163 6520 7669 6577      surface view
-0000e170: 732e 0a0a 0a20 2020 2020 2020 203a 7265  s....        :re
-0000e180: 7475 726e 3a20 4e6f 6e65 0a20 2020 2020  turn: None.     
-0000e190: 2020 2022 2222 0a20 2020 2020 2020 2073     """.        s
-0000e1a0: 7461 7274 203d 2074 696d 6569 742e 6465  tart = timeit.de
-0000e1b0: 6661 756c 745f 7469 6d65 7228 290a 0a20  fault_timer().. 
-0000e1c0: 2020 2020 2020 206f 7574 6d61 7078 696d         outmapxim
-0000e1d0: 6167 6520 3d20 6f75 746d 6170 7969 6d61  age = outmapyima
-0000e1e0: 6765 203d 206f 7574 6d61 707a 696d 6167  ge = outmapzimag
-0000e1f0: 6520 3d20 4e6f 6e65 0a20 2020 2020 2020  e = None.       
-0000e200: 2069 6620 7365 6c66 2e65 6d64 6964 2069   if self.emdid i
-0000e210: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-0000e220: 2020 2020 2020 2020 7674 7072 6f6f 7420          vtproot 
-0000e230: 3d20 4d41 505f 5345 5256 4552 5f50 4154  = MAP_SERVER_PAT
-0000e240: 480a 2020 2020 2020 2020 2020 2020 6469  H.            di
-0000e250: 6769 7473 203d 205b 6920 666f 7220 6920  gits = [i for i 
-0000e260: 696e 2073 7472 2873 656c 662e 656d 6469  in str(self.emdi
-0000e270: 6429 5d0a 2020 2020 2020 2020 2020 2020  d)].            
-0000e280: 6966 206c 656e 2864 6967 6974 7329 203d  if len(digits) =
-0000e290: 3d20 343a 0a20 2020 2020 2020 2020 2020  = 4:.           
-0000e2a0: 2020 2020 2076 7470 4669 6c65 203d 2027       vtpFile = '
-0000e2b0: 7b7d 2f7b 7d2f 7b7d 2f76 612f 656d 645f  {}/{}/{}/va/emd_
-0000e2c0: 7b7d 5f7b 7d2e 7674 7027 2e66 6f72 6d61  {}_{}.vtp'.forma
-0000e2d0: 7428 7674 7072 6f6f 742c 2064 6967 6974  t(vtproot, digit
-0000e2e0: 735b 305d 202b 2064 6967 6974 735b 315d  s[0] + digits[1]
-0000e2f0: 2c20 7365 6c66 2e65 6d64 6964 2c20 7365  , self.emdid, se
-0000e300: 6c66 2e65 6d64 6964 2c0a 2020 2020 2020  lf.emdid,.      
-0000e310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e340: 2020 2020 2020 2073 656c 662e 636c 290a         self.cl).
-0000e350: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-0000e360: 206c 656e 2864 6967 6974 7329 203d 3d20   len(digits) == 
-0000e370: 353a 0a20 2020 2020 2020 2020 2020 2020  5:.             
-0000e380: 2020 2076 7470 4669 6c65 203d 2027 7b7d     vtpFile = '{}
-0000e390: 2f7b 7d2f 7b7d 2f7b 7d2f 7661 2f65 6d64  /{}/{}/{}/va/emd
-0000e3a0: 5f7b 7d5f 7b7d 2e76 7470 272e 666f 726d  _{}_{}.vtp'.form
-0000e3b0: 6174 2876 7470 726f 6f74 2c20 6469 6769  at(vtproot, digi
-0000e3c0: 7473 5b30 5d20 2b20 6469 6769 7473 5b31  ts[0] + digits[1
-0000e3d0: 5d2c 2064 6967 6974 735b 325d 2c20 7365  ], digits[2], se
-0000e3e0: 6c66 2e65 6d64 6964 2c0a 2020 2020 2020  lf.emdid,.      
-0000e3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e420: 2020 2020 2020 2020 2020 7365 6c66 2e65            self.e
-0000e430: 6d64 6964 2c0a 2020 2020 2020 2020 2020  mdid,.          
-0000e440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e470: 2020 2020 2020 7365 6c66 2e63 6c29 0a20        self.cl). 
-0000e480: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0000e490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e4a0: 2070 6173 730a 2020 2020 2020 2020 2020   pass.          
-0000e4b0: 2020 6966 206e 6f74 206f 732e 7061 7468    if not os.path
-0000e4c0: 2e69 7366 696c 6528 7674 7046 696c 6529  .isfile(vtpFile)
-0000e4d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000e4e0: 2020 7072 696e 7428 2756 5450 2066 696c    print('VTP fil
-0000e4f0: 6520 6f66 2074 6865 206d 6170 2064 6f65  e of the map doe
-0000e500: 7320 6e6f 7420 6578 6973 742e 2729 0a20  s not exist.'). 
-0000e510: 2020 2020 2020 2020 2020 2020 2020 2076                 v
-0000e520: 7470 4669 6c65 203d 2073 656c 662e 6765  tpFile = self.ge
-0000e530: 6e76 7470 2873 656c 662e 6d61 702e 6669  nvtp(self.map.fi
-0000e540: 6c65 6e61 6d65 290a 2020 2020 2020 2020  lename).        
-0000e550: 2020 2020 2020 2020 7072 696e 7428 2741          print('A
-0000e560: 2076 7470 2066 696c 6520 636f 7272 6573   vtp file corres
-0000e570: 706f 6e64 2074 6f20 6465 6e73 6974 7920  pond to density 
-0000e580: 6d61 7020 6973 2067 656e 6572 6174 6564  map is generated
-0000e590: 2e27 290a 0a0a 2020 2020 2020 2020 2020  .')...          
-0000e5a0: 2020 6661 6374 4772 6170 6869 6373 203d    factGraphics =
-0000e5b0: 2076 746b 2e76 746b 4772 6170 6869 6373   vtk.vtkGraphics
-0000e5c0: 4661 6374 6f72 7928 290a 2020 2020 2020  Factory().      
-0000e5d0: 2020 2020 2020 6661 6374 4772 6170 6869        factGraphi
-0000e5e0: 6373 2e53 6574 4f66 6653 6372 6565 6e4f  cs.SetOffScreenO
-0000e5f0: 6e6c 794d 6f64 6528 3129 0a20 2020 2020  nlyMode(1).     
-0000e600: 2020 2020 2020 2066 6163 7447 7261 7068         factGraph
-0000e610: 6963 732e 5365 7455 7365 4d65 7361 436c  ics.SetUseMesaCl
-0000e620: 6173 7365 7328 3129 0a20 2020 2020 2020  asses(1).       
-0000e630: 2020 2020 2072 6561 6465 7220 3d20 7674       reader = vt
-0000e640: 6b2e 7674 6b58 4d4c 506f 6c79 4461 7461  k.vtkXMLPolyData
-0000e650: 5265 6164 6572 2829 0a20 2020 2020 2020  Reader().       
-0000e660: 2020 2020 2072 6561 6465 722e 5365 7446       reader.SetF
-0000e670: 696c 654e 616d 6528 7674 7046 696c 6529  ileName(vtpFile)
-0000e680: 0a20 2020 2020 2020 2020 2020 2072 6561  .            rea
-0000e690: 6465 722e 5570 6461 7465 2829 0a0a 2020  der.Update()..  
-0000e6a0: 2020 2020 2020 2020 2020 6d61 7070 6572            mapper
-0000e6b0: 203d 2076 746b 2e76 746b 506f 6c79 4461   = vtk.vtkPolyDa
-0000e6c0: 7461 4d61 7070 6572 2829 0a20 2020 2020  taMapper().     
-0000e6d0: 2020 2020 2020 206d 6170 7065 722e 5363         mapper.Sc
-0000e6e0: 616c 6172 5669 7369 6269 6c69 7479 4f66  alarVisibilityOf
-0000e6f0: 6628 290a 2020 2020 2020 2020 2020 2020  f().            
-0000e700: 6d61 7070 6572 2e53 6574 496e 7075 7443  mapper.SetInputC
-0000e710: 6f6e 6e65 6374 696f 6e28 7265 6164 6572  onnection(reader
-0000e720: 2e47 6574 4f75 7470 7574 506f 7274 2829  .GetOutputPort()
-0000e730: 290a 0a20 2020 2020 2020 2020 2020 2061  )..            a
-0000e740: 6374 6f72 203d 2076 746b 2e76 746b 4163  ctor = vtk.vtkAc
-0000e750: 746f 7228 290a 2020 2020 2020 2020 2020  tor().          
-0000e760: 2020 6163 746f 722e 5365 744d 6170 7065    actor.SetMappe
-0000e770: 7228 6d61 7070 6572 290a 2020 2020 2020  r(mapper).      
-0000e780: 2020 2020 2020 6163 746f 722e 4765 7450        actor.GetP
-0000e790: 726f 7065 7274 7928 292e 5365 7443 6f6c  roperty().SetCol
-0000e7a0: 6f72 2831 2e30 2c20 302e 382c 2030 2e31  or(1.0, 0.8, 0.1
-0000e7b0: 290a 2020 2020 2020 2020 2020 2020 6163  ).            ac
-0000e7c0: 746f 722e 4765 7450 726f 7065 7274 7928  tor.GetProperty(
-0000e7d0: 292e 5365 7449 6e74 6572 706f 6c61 7469  ).SetInterpolati
-0000e7e0: 6f6e 546f 5068 6f6e 6728 290a 2020 2020  onToPhong().    
-0000e7f0: 2020 2020 2020 2020 6163 746f 722e 4765          actor.Ge
-0000e800: 7450 726f 7065 7274 7928 292e 5365 7444  tProperty().SetD
-0000e810: 6966 6675 7365 2830 2e39 290a 2020 2020  iffuse(0.9).    
-0000e820: 2020 2020 2020 2020 6163 746f 722e 4765          actor.Ge
-0000e830: 7450 726f 7065 7274 7928 292e 5365 7453  tProperty().SetS
-0000e840: 7065 6375 6c61 7228 302e 3629 0a20 2020  pecular(0.6).   
-0000e850: 2020 2020 2020 2020 2061 6374 6f72 2e47           actor.G
-0000e860: 6574 5072 6f70 6572 7479 2829 2e53 6574  etProperty().Set
-0000e870: 5370 6563 756c 6172 506f 7765 7228 3330  SpecularPower(30
-0000e880: 290a 2020 2020 2020 2020 2020 2020 6163  ).            ac
-0000e890: 746f 722e 4765 7450 726f 7065 7274 7928  tor.GetProperty(
-0000e8a0: 292e 4261 636b 6661 6365 4375 6c6c 696e  ).BackfaceCullin
-0000e8b0: 674f 6e28 290a 2020 2020 2020 2020 2020  gOn().          
-0000e8c0: 2020 6163 746f 722e 4765 7450 726f 7065    actor.GetPrope
-0000e8d0: 7274 7928 292e 4672 6f6e 7466 6163 6543  rty().FrontfaceC
-0000e8e0: 756c 6c69 6e67 4f6e 2829 0a0a 2020 2020  ullingOn()..    
-0000e8f0: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
-0000e900: 2074 6865 2067 7261 7068 6963 7320 7374   the graphics st
-0000e910: 7275 6374 7572 652e 2054 6865 2072 656e  ructure. The ren
-0000e920: 6465 7265 7220 7265 6e64 6572 7320 696e  derer renders in
-0000e930: 746f 2074 6865 2072 656e 6465 720a 2020  to the render.  
-0000e940: 2020 2020 2020 2020 2020 2320 7769 6e64            # wind
-0000e950: 6f77 2e20 5468 6520 7265 6e64 6572 2077  ow. The render w
-0000e960: 696e 646f 7720 696e 7465 7261 6374 6f72  indow interactor
-0000e970: 2063 6170 7475 7265 7320 6d6f 7573 6520   captures mouse 
-0000e980: 6576 656e 7473 2061 6e64 2077 696c 6c0a  events and will.
-0000e990: 2020 2020 2020 2020 2020 2020 2320 7065              # pe
-0000e9a0: 7266 6f72 6d20 6170 7072 6f70 7269 6174  rform appropriat
-0000e9b0: 6520 6361 6d65 7261 206f 7220 6163 746f  e camera or acto
-0000e9c0: 7220 6d61 6e69 7075 6c61 7469 6f6e 2064  r manipulation d
-0000e9d0: 6570 656e 6469 6e67 206f 6e20 7468 650a  epending on the.
-0000e9e0: 2020 2020 2020 2020 2020 2020 2320 6e61              # na
-0000e9f0: 7475 7265 206f 6620 7468 6520 6576 656e  ture of the even
-0000ea00: 7473 2e0a 0a20 2020 2020 2020 2020 2020  ts...           
-0000ea10: 2072 656e 203d 2076 746b 2e76 746b 5265   ren = vtk.vtkRe
-0000ea20: 6e64 6572 6572 2829 0a20 2020 2020 2020  nderer().       
-0000ea30: 2020 2020 2072 656e 5769 6e20 3d20 7674       renWin = vt
-0000ea40: 6b2e 7674 6b52 656e 6465 7257 696e 646f  k.vtkRenderWindo
-0000ea50: 7728 290a 2020 2020 2020 2020 2020 2020  w().            
-0000ea60: 7265 6e57 696e 2e53 6574 4f66 6653 6372  renWin.SetOffScr
-0000ea70: 6565 6e52 656e 6465 7269 6e67 2831 290a  eenRendering(1).
-0000ea80: 2020 2020 2020 2020 2020 2020 7265 6e57              renW
-0000ea90: 696e 2e53 6574 5369 7a65 2833 3030 302c  in.SetSize(3000,
-0000eaa0: 2033 3030 3029 0a20 2020 2020 2020 2020   3000).         
-0000eab0: 2020 2072 656e 5769 6e2e 4164 6452 656e     renWin.AddRen
-0000eac0: 6465 7265 7228 7265 6e29 0a0a 2020 2020  derer(ren)..    
-0000ead0: 2020 2020 2020 2020 2320 4164 6420 7468          # Add th
-0000eae0: 6520 6163 746f 7273 2074 6f20 7468 6520  e actors to the 
-0000eaf0: 7265 6e64 6572 6572 2c20 7365 7420 7468  renderer, set th
-0000eb00: 6520 6261 636b 6772 6f75 6e64 2061 6e64  e background and
-0000eb10: 2073 697a 650a 2020 2020 2020 2020 2020   size.          
-0000eb20: 2020 2320 6163 746f 722e 526f 7461 7465    # actor.Rotate
-0000eb30: 5928 3930 290a 2020 2020 2020 2020 2020  Y(90).          
-0000eb40: 2020 7265 6e2e 4164 6441 6374 6f72 2861    ren.AddActor(a
-0000eb50: 6374 6f72 290a 2020 2020 2020 2020 2020  ctor).          
-0000eb60: 2020 7265 6e2e 5365 7442 6163 6b67 726f    ren.SetBackgro
-0000eb70: 756e 6428 302e 392c 2030 2e39 2c20 302e  und(0.9, 0.9, 0.
-0000eb80: 3929 0a20 2020 2020 2020 2020 2020 2072  9).            r
-0000eb90: 656e 2e47 6574 4163 7469 7665 4361 6d65  en.GetActiveCame
-0000eba0: 7261 2829 2e53 6574 5061 7261 6c6c 656c  ra().SetParallel
-0000ebb0: 5072 6f6a 6563 7469 6f6e 2831 290a 2020  Projection(1).  
-0000ebc0: 2020 2020 2020 2020 2020 7265 6e57 696e            renWin
-0000ebd0: 2e52 656e 6465 7228 290a 0a20 2020 2020  .Render()..     
-0000ebe0: 2020 2020 2020 2023 204f 7574 7075 7420         # Output 
-0000ebf0: 6d61 7073 2069 6d61 6765 7320 6f6e 6c79  maps images only
-0000ec00: 0a20 2020 2020 2020 2020 2020 2072 656e  .            ren
-0000ec10: 2e52 6573 6574 4361 6d65 7261 2829 0a20  .ResetCamera(). 
-0000ec20: 2020 2020 2020 2020 2020 2072 656e 2e47             ren.G
-0000ec30: 6574 4163 7469 7665 4361 6d65 7261 2829  etActiveCamera()
-0000ec40: 2e5a 6f6f 6d28 312e 3330 290a 2020 2020  .Zoom(1.30).    
-0000ec50: 2020 2020 2020 2020 6f75 746d 6170 7a69          outmapzi
-0000ec60: 6d61 6765 203d 2027 7b7d 656d 645f 7b7d  mage = '{}emd_{}
-0000ec70: 5f7a 7375 7266 6163 652e 6a70 6567 272e  _zsurface.jpeg'.
-0000ec80: 666f 726d 6174 2873 656c 662e 776f 726b  format(self.work
-0000ec90: 6469 722c 2073 656c 662e 656d 6469 6429  dir, self.emdid)
-0000eca0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000ecb0: 662e 7772 6974 655f 696d 6167 6528 6f75  f.write_image(ou
-0000ecc0: 746d 6170 7a69 6d61 6765 2c20 7265 6e57  tmapzimage, renW
-0000ecd0: 696e 290a 0a20 2020 2020 2020 2020 2020  in)..           
-0000ece0: 2061 6374 6f72 2e52 6f74 6174 6558 2839   actor.RotateX(9
-0000ecf0: 3029 0a20 2020 2020 2020 2020 2020 2061  0).            a
-0000ed00: 6374 6f72 2e52 6f74 6174 6559 2839 3029  ctor.RotateY(90)
-0000ed10: 0a20 2020 2020 2020 2020 2020 2023 2072  .            # r
-0000ed20: 656e 2e52 6573 6574 4361 6d65 7261 2829  en.ResetCamera()
-0000ed30: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
-0000ed40: 6d61 7079 696d 6167 6520 3d20 277b 7d65  mapyimage = '{}e
-0000ed50: 6d64 5f7b 7d5f 7973 7572 6661 6365 2e6a  md_{}_ysurface.j
-0000ed60: 7065 6727 2e66 6f72 6d61 7428 7365 6c66  peg'.format(self
-0000ed70: 2e77 6f72 6b64 6972 2c20 7365 6c66 2e65  .workdir, self.e
-0000ed80: 6d64 6964 290a 2020 2020 2020 2020 2020  mdid).          
-0000ed90: 2020 7365 6c66 2e77 7269 7465 5f69 6d61    self.write_ima
-0000eda0: 6765 286f 7574 6d61 7079 696d 6167 652c  ge(outmapyimage,
-0000edb0: 2072 656e 5769 6e29 0a0a 2020 2020 2020   renWin)..      
-0000edc0: 2020 2020 2020 6163 746f 722e 526f 7461        actor.Rota
-0000edd0: 7465 5a28 3930 290a 2020 2020 2020 2020  teZ(90).        
-0000ede0: 2020 2020 6163 746f 722e 526f 7461 7465      actor.Rotate
-0000edf0: 5828 3930 290a 2020 2020 2020 2020 2020  X(90).          
-0000ee00: 2020 2320 7265 6e2e 5265 7365 7443 616d    # ren.ResetCam
-0000ee10: 6572 6128 290a 2020 2020 2020 2020 2020  era().          
-0000ee20: 2020 6f75 746d 6170 7869 6d61 6765 203d    outmapximage =
-0000ee30: 2027 7b7d 656d 645f 7b7d 5f78 7375 7266   '{}emd_{}_xsurf
-0000ee40: 6163 652e 6a70 6567 272e 666f 726d 6174  ace.jpeg'.format
-0000ee50: 2873 656c 662e 776f 726b 6469 722c 2073  (self.workdir, s
-0000ee60: 656c 662e 656d 6469 6429 0a20 2020 2020  elf.emdid).     
-0000ee70: 2020 2020 2020 2073 656c 662e 7772 6974         self.writ
-0000ee80: 655f 696d 6167 6528 6f75 746d 6170 7869  e_image(outmapxi
-0000ee90: 6d61 6765 2c20 7265 6e57 696e 290a 0a20  mage, renWin).. 
-0000eea0: 2020 2020 2020 2020 2020 2023 204d 6f64             # Mod
-0000eeb0: 656c 2065 7869 7374 0a20 2020 2020 2020  el exist.       
-0000eec0: 2020 2020 2069 6620 7365 6c66 2e6d 6f64       if self.mod
-0000eed0: 656c 733a 0a20 2020 2020 2020 2020 2020  els:.           
-0000eee0: 2020 2020 2066 6f72 206d 6f64 656c 2069       for model i
-0000eef0: 6e20 7365 6c66 2e6d 6f64 656c 733a 0a20  n self.models:. 
-0000ef00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ef10: 2020 2070 6462 6964 203d 206d 6f64 656c     pdbid = model
-0000ef20: 2e66 696c 656e 616d 652e 7370 6c69 7428  .filename.split(
-0000ef30: 272f 2729 5b2d 315d 2e73 706c 6974 2827  '/')[-1].split('
-0000ef40: 2e27 295b 305d 0a20 2020 2020 2020 2020  .')[0].         
-0000ef50: 2020 2020 2020 2020 2020 2023 2054 6f64             # Tod
-0000ef60: 6f3a 2070 7574 2074 6865 2066 696e 616c  o: put the final
-0000ef70: 2064 6563 6964 6564 2070 6174 6820 6865   decided path he
-0000ef80: 7265 2061 7320 666f 7220 7468 6520 7064  re as for the pd
-0000ef90: 6220 6f72 2065 6e74 2066 696c 650a 2020  b or ent file.  
-0000efa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000efb0: 2020 2320 2a2a 2a2a 3a20 6861 7320 746f    # ****: has to
-0000efc0: 2075 7365 202e 7064 6220 6f72 202e 656e   use .pdb or .en
-0000efd0: 7420 666f 7220 7468 6520 6d6f 6465 6c20  t for the model 
-0000efe0: 6e65 6564 2074 6f20 6265 2063 6861 6e67  need to be chang
-0000eff0: 6564 2074 6f20 6369 6620 6669 6c65 0a20  ed to cif file. 
-0000f000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f010: 2020 2023 2070 6462 726f 6f74 203d 2027     # pdbroot = '
-0000f020: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0000f030: 2020 2020 2020 656e 7472 6f6f 7420 3d20        entroot = 
-0000f040: 4d41 505f 5345 5256 4552 5f50 4154 480a  MAP_SERVER_PATH.
-0000f050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f060: 2020 2020 6966 206c 656e 2864 6967 6974      if len(digit
-0000f070: 7329 203d 3d20 343a 0a20 2020 2020 2020  s) == 4:.       
-0000f080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f090: 2065 6e74 4669 6c65 203d 2027 7b7d 7b7d   entFile = '{}{}
-0000f0a0: 2f7b 7d2f 7661 2f27 2e66 6f72 6d61 7428  /{}/va/'.format(
-0000f0b0: 656e 7472 6f6f 742c 2064 6967 6974 735b  entroot, digits[
-0000f0c0: 305d 202b 2064 6967 6974 735b 315d 2c20  0] + digits[1], 
-0000f0d0: 7365 6c66 2e65 6d64 6964 290a 2020 2020  self.emdid).    
-0000f0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f0f0: 656c 6966 206c 656e 2864 6967 6974 7329  elif len(digits)
-0000f100: 203d 3d20 353a 0a20 2020 2020 2020 2020   == 5:.         
-0000f110: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0000f120: 6e74 4669 6c65 203d 2027 7b7d 7b7d 2f7b  ntFile = '{}{}/{
-0000f130: 7d2f 7b7d 2f76 612f 272e 666f 726d 6174  }/{}/va/'.format
-0000f140: 2865 6e74 726f 6f74 2c20 6469 6769 7473  (entroot, digits
-0000f150: 5b30 5d20 2b20 6469 6769 7473 5b31 5d2c  [0] + digits[1],
-0000f160: 2064 6967 6974 735b 325d 2c20 7365 6c66   digits[2], self
-0000f170: 2e65 6d64 6964 290a 2020 2020 2020 2020  .emdid).        
-0000f180: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0000f190: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000f1a0: 2020 2020 2020 2020 2020 7061 7373 0a20            pass. 
-0000f1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f1c0: 2020 206d 6f64 656c 203d 2027 7b7d 7064     model = '{}pd
-0000f1d0: 627b 7d2e 656e 7427 2e66 6f72 6d61 7428  b{}.ent'.format(
-0000f1e0: 656e 7446 696c 652c 2070 6462 6964 290a  entFile, pdbid).
-0000f1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f200: 2020 2020 6966 206e 6f74 206f 732e 7061      if not os.pa
-0000f210: 7468 2e69 7366 696c 6528 6d6f 6465 6c29  th.isfile(model)
-0000f220: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000f230: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-0000f240: 274d 6f64 656c 3a20 2573 2069 7320 6e6f  'Model: %s is no
-0000f250: 7420 696e 2074 6865 2077 6f72 6b69 6e67  t in the working
-0000f260: 2066 6f6c 6465 7220 666f 7220 6d6f 6465   folder for mode
-0000f270: 6c20 6d61 7020 7669 6577 2c20 706c 6561  l map view, plea
-0000f280: 7365 2063 6865 636b 2e27 2025 206d 6f64  se check.' % mod
-0000f290: 656c 290a 2020 2020 2020 2020 2020 2020  el).            
-0000f2a0: 2020 2020 2020 2020 2320 4368 616e 6765          # Change
-0000f2b0: 2074 6865 2076 6965 7720 6261 636b 0a20   the view back. 
-0000f2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f2d0: 2020 2061 6374 6f72 2e52 6f74 6174 6558     actor.RotateX
-0000f2e0: 282d 3930 290a 2020 2020 2020 2020 2020  (-90).          
-0000f2f0: 2020 2020 2020 2020 2020 6163 746f 722e            actor.
-0000f300: 526f 7461 7465 5a28 2d39 3029 0a20 2020  RotateZ(-90).   
-0000f310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f320: 2061 6374 6f72 2e52 6f74 6174 6559 282d   actor.RotateY(-
-0000f330: 3930 290a 2020 2020 2020 2020 2020 2020  90).            
-0000f340: 2020 2020 2020 2020 6163 746f 722e 526f          actor.Ro
-0000f350: 7461 7465 5828 2d39 3029 0a20 2020 2020  tateX(-90).     
-0000f360: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0000f370: 656e 2e52 6573 6574 4361 6d65 7261 2829  en.ResetCamera()
-0000f380: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000f390: 2020 2020 2020 6163 746f 722e 4765 7450        actor.GetP
-0000f3a0: 726f 7065 7274 7928 292e 5365 744f 7061  roperty().SetOpa
-0000f3b0: 6369 7479 2830 2e35 290a 2020 2020 2020  city(0.5).      
-0000f3c0: 2020 2020 2020 2020 2020 2020 2020 7064                pd
-0000f3d0: 625f 7265 6164 6572 203d 2076 746b 2e76  b_reader = vtk.v
-0000f3e0: 746b 5044 4252 6561 6465 7228 290a 2020  tkPDBReader().  
-0000f3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f400: 2020 6d6f 6465 6c5f 6d61 7070 6572 203d    model_mapper =
-0000f410: 2076 746b 2e76 746b 506f 6c79 4461 7461   vtk.vtkPolyData
-0000f420: 4d61 7070 6572 2829 0a20 2020 2020 2020  Mapper().       
-0000f430: 2020 2020 2020 2020 2020 2020 206d 6f64               mod
-0000f440: 656c 5f61 6374 6f72 203d 2076 746b 2e76  el_actor = vtk.v
-0000f450: 746b 4163 746f 7228 290a 2020 2020 2020  tkActor().      
-0000f460: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
-0000f470: 6465 6c5f 6163 746f 722e 4765 7450 726f  del_actor.GetPro
-0000f480: 7065 7274 7928 292e 5365 744c 696e 6557  perty().SetLineW
-0000f490: 6964 7468 2836 290a 2020 2020 2020 2020  idth(6).        
-0000f4a0: 2020 2020 2020 2020 2020 2020 7064 625f              pdb_
-0000f4b0: 7265 6164 6572 2e53 6574 4669 6c65 4e61  reader.SetFileNa
-0000f4c0: 6d65 286d 6f64 656c 290a 0a20 2020 2020  me(model)..     
-0000f4d0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0000f4e0: 2054 6573 7420 6f66 2062 6163 6b62 6f6e   Test of backbon
-0000f4f0: 6520 7374 7275 6374 7572 650a 2020 2020  e structure.    
-0000f500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f510: 2320 7365 7475 7020 7269 6262 6f6e 2066  # setup ribbon f
-0000f520: 696c 7465 720a 2020 2020 2020 2020 2020  ilter.          
-0000f530: 2020 2020 2020 2020 2020 7269 6262 6f6e            ribbon
-0000f540: 4669 6c74 6572 203d 2076 746b 2e76 746b  Filter = vtk.vtk
-0000f550: 5072 6f74 6569 6e52 6962 626f 6e46 696c  ProteinRibbonFil
-0000f560: 7465 7228 290a 2020 2020 2020 2020 2020  ter().          
-0000f570: 2020 2020 2020 2020 2020 7269 6262 6f6e            ribbon
-0000f580: 4669 6c74 6572 2e53 6574 496e 7075 7443  Filter.SetInputC
-0000f590: 6f6e 6e65 6374 696f 6e28 7064 625f 7265  onnection(pdb_re
-0000f5a0: 6164 6572 2e47 6574 4f75 7470 7574 506f  ader.GetOutputPo
-0000f5b0: 7274 2829 290a 2020 2020 2020 2020 2020  rt()).          
-0000f5c0: 2020 2020 2020 2020 2020 7269 6262 6f6e            ribbon
-0000f5d0: 4669 6c74 6572 2e55 7064 6174 6528 290a  Filter.Update().
-0000f5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f5f0: 2020 2020 6d6f 6465 6c5f 6d61 7070 6572      model_mapper
-0000f600: 2e53 6574 496e 7075 7444 6174 6128 7269  .SetInputData(ri
-0000f610: 6262 6f6e 4669 6c74 6572 2e47 6574 4f75  bbonFilter.GetOu
-0000f620: 7470 7574 2829 290a 2020 2020 2020 2020  tput()).        
-0000f630: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
-0000f640: 6c5f 6d61 7070 6572 2e55 7064 6174 6528  l_mapper.Update(
-0000f650: 290a 0a0a 2020 2020 2020 2020 2020 2020  )...            
-0000f660: 2020 2020 2020 2020 2320 6d6f 6465 6c5f          # model_
-0000f670: 6d61 7070 6572 2e53 6574 496e 7075 7443  mapper.SetInputC
-0000f680: 6f6e 6e65 6374 696f 6e28 7064 625f 7265  onnection(pdb_re
-0000f690: 6164 6572 2e47 6574 4f75 7470 7574 506f  ader.GetOutputPo
-0000f6a0: 7274 2829 290a 2020 2020 2020 2020 2020  rt()).          
-0000f6b0: 2020 2020 2020 2020 2020 6d6f 6465 6c5f            model_
-0000f6c0: 6163 746f 722e 5365 744d 6170 7065 7228  actor.SetMapper(
-0000f6d0: 6d6f 6465 6c5f 6d61 7070 6572 290a 2020  model_mapper).  
-0000f6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f6f0: 2020 7265 6e2e 4164 6441 6374 6f72 286d    ren.AddActor(m
-0000f700: 6f64 656c 5f61 6374 6f72 290a 2020 2020  odel_actor).    
-0000f710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f720: 7265 6e2e 5265 7365 7443 616d 6572 6128  ren.ResetCamera(
-0000f730: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000f740: 2020 2020 2020 7265 6e2e 4765 7441 6374        ren.GetAct
-0000f750: 6976 6543 616d 6572 6128 292e 5a6f 6f6d  iveCamera().Zoom
-0000f760: 2831 2e33 3029 0a20 2020 2020 2020 2020  (1.30).         
-0000f770: 2020 2020 2020 2020 2020 2072 656e 5769             renWi
-0000f780: 6e2e 5265 6e64 6572 2829 0a0a 2020 2020  n.Render()..    
-0000f790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f7a0: 2320 4f75 7470 7574 206d 6f64 656c 2061  # Output model a
-0000f7b0: 6e64 206d 6170 7320 6f76 6572 6c61 7920  nd maps overlay 
-0000f7c0: 696d 6167 6573 0a20 2020 2020 2020 2020  images.         
-0000f7d0: 2020 2020 2020 2020 2020 206f 7574 7a69             outzi
-0000f7e0: 6d61 6765 203d 2027 7b7d 7b7d 5f65 6d64  mage = '{}{}_emd
-0000f7f0: 5f7b 7d5f 7a73 7572 6661 6365 2e6a 7065  _{}_zsurface.jpe
-0000f800: 6727 2e66 6f72 6d61 7428 7365 6c66 2e77  g'.format(self.w
-0000f810: 6f72 6b64 6972 2c20 7064 6269 642c 2073  orkdir, pdbid, s
-0000f820: 656c 662e 656d 6469 6429 0a20 2020 2020  elf.emdid).     
-0000f830: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000f840: 656c 662e 7772 6974 655f 696d 6167 6528  elf.write_image(
-0000f850: 6f75 747a 696d 6167 652c 2072 656e 5769  outzimage, renWi
-0000f860: 6e29 0a0a 2020 2020 2020 2020 2020 2020  n)..            
-0000f870: 2020 2020 2020 2020 6163 746f 722e 526f          actor.Ro
-0000f880: 7461 7465 5828 3930 290a 2020 2020 2020  tateX(90).      
-0000f890: 2020 2020 2020 2020 2020 2020 2020 6163                ac
-0000f8a0: 746f 722e 526f 7461 7465 5928 3930 290a  tor.RotateY(90).
-0000f8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f8c0: 2020 2020 6d6f 6465 6c5f 6163 746f 722e      model_actor.
-0000f8d0: 526f 7461 7465 5828 3930 290a 2020 2020  RotateX(90).    
-0000f8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f8f0: 6d6f 6465 6c5f 6163 746f 722e 526f 7461  model_actor.Rota
-0000f900: 7465 5928 3930 290a 2020 2020 2020 2020  teY(90).        
-0000f910: 2020 2020 2020 2020 2020 2020 2320 7265              # re
-0000f920: 6e2e 5265 7365 7443 616d 6572 6128 290a  n.ResetCamera().
-0000f930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f940: 2020 2020 6f75 7479 696d 6167 6520 3d20      outyimage = 
-0000f950: 277b 7d7b 7d5f 656d 645f 7b7d 5f79 7375  '{}{}_emd_{}_ysu
-0000f960: 7266 6163 652e 6a70 6567 272e 666f 726d  rface.jpeg'.form
-0000f970: 6174 2873 656c 662e 776f 726b 6469 722c  at(self.workdir,
-0000f980: 2070 6462 6964 2c20 7365 6c66 2e65 6d64   pdbid, self.emd
-0000f990: 6964 290a 2020 2020 2020 2020 2020 2020  id).            
-0000f9a0: 2020 2020 2020 2020 7365 6c66 2e77 7269          self.wri
-0000f9b0: 7465 5f69 6d61 6765 286f 7574 7969 6d61  te_image(outyima
-0000f9c0: 6765 2c20 7265 6e57 696e 290a 0a20 2020  ge, renWin)..   
-0000f9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f9e0: 2061 6374 6f72 2e52 6f74 6174 655a 2839   actor.RotateZ(9
-0000f9f0: 3029 0a20 2020 2020 2020 2020 2020 2020  0).             
-0000fa00: 2020 2020 2020 2061 6374 6f72 2e52 6f74         actor.Rot
-0000fa10: 6174 6558 2839 3029 0a20 2020 2020 2020  ateX(90).       
-0000fa20: 2020 2020 2020 2020 2020 2020 206d 6f64               mod
-0000fa30: 656c 5f61 6374 6f72 2e52 6f74 6174 655a  el_actor.RotateZ
-0000fa40: 2839 3029 0a20 2020 2020 2020 2020 2020  (90).           
-0000fa50: 2020 2020 2020 2020 206d 6f64 656c 5f61           model_a
-0000fa60: 6374 6f72 2e52 6f74 6174 6558 2839 3029  ctor.RotateX(90)
-0000fa70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000fa80: 2020 2020 2023 2072 656e 2e52 6573 6574       # ren.Reset
-0000fa90: 4361 6d65 7261 2829 0a20 2020 2020 2020  Camera().       
-0000faa0: 2020 2020 2020 2020 2020 2020 206f 7574               out
-0000fab0: 7869 6d61 6765 203d 2027 7b7d 7b7d 5f65  ximage = '{}{}_e
-0000fac0: 6d64 5f7b 7d5f 7873 7572 6661 6365 2e6a  md_{}_xsurface.j
-0000fad0: 7065 6727 2e66 6f72 6d61 7428 7365 6c66  peg'.format(self
-0000fae0: 2e77 6f72 6b64 6972 2c20 7064 6269 642c  .workdir, pdbid,
-0000faf0: 2073 656c 662e 656d 6469 6429 0a20 2020   self.emdid).   
-0000fb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fb10: 2073 656c 662e 7772 6974 655f 696d 6167   self.write_imag
-0000fb20: 6528 6f75 7478 696d 6167 652c 2072 656e  e(outximage, ren
-0000fb30: 5769 6e29 0a20 2020 2020 2020 2020 2020  Win).           
-0000fb40: 2070 7269 6e74 2827 5375 7266 6163 6520   print('Surface 
-0000fb50: 7669 6577 7320 7765 7265 2067 656e 6572  views were gener
-0000fb60: 6174 6564 2062 7920 5654 4b20 6d65 7468  ated by VTK meth
-0000fb70: 6f64 2e27 290a 0a20 2020 2020 2020 2020  od.')..         
-0000fb80: 2020 2023 2065 6c73 653a 0a20 2020 2020     # else:.     
-0000fb90: 2020 2020 2020 2023 2020 2020 2320 4f75         #    # Ou
-0000fba0: 7075 7420 6d61 7073 2069 6d61 6765 7320  put maps images 
-0000fbb0: 6f6e 6c79 0a20 2020 2020 2020 2020 2020  only.           
-0000fbc0: 2023 2020 2020 7265 6e2e 5265 7365 7443   #    ren.ResetC
-0000fbd0: 616d 6572 6128 290a 2020 2020 2020 2020  amera().        
-0000fbe0: 2020 2020 2320 2020 2072 656e 2e47 6574      #    ren.Get
-0000fbf0: 4163 7469 7665 4361 6d65 7261 2829 2e5a  ActiveCamera().Z
-0000fc00: 6f6f 6d28 302e 3535 290a 2020 2020 2020  oom(0.55).      
-0000fc10: 2020 2020 2020 2320 2020 206f 7574 7a69        #    outzi
-0000fc20: 6d61 6765 203d 2027 7b7d 7b7d 5f65 6d64  mage = '{}{}_emd
-0000fc30: 5f7b 7d5f 7a73 7572 6661 6365 2e6a 7065  _{}_zsurface.jpe
-0000fc40: 6727 2e66 6f72 6d61 7428 7365 6c66 2e77  g'.format(self.w
-0000fc50: 6f72 6b64 6972 2c20 7064 6269 642c 2073  orkdir, pdbid, s
-0000fc60: 656c 662e 656d 6469 6420 290a 2020 2020  elf.emdid ).    
-0000fc70: 2020 2020 2020 2020 2320 2020 2077 7269          #    wri
-0000fc80: 7465 5f69 6d61 6765 286f 7574 7a69 6d61  te_image(outzima
-0000fc90: 6765 2c20 7265 6e57 696e 290a 0a20 2020  ge, renWin)..   
-0000fca0: 2020 2020 2020 2020 2023 2020 2020 6163           #    ac
-0000fcb0: 746f 722e 526f 7461 7465 5828 3930 290a  tor.RotateX(90).
-0000fcc0: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-0000fcd0: 2061 6374 6f72 2e52 6f74 6174 6559 2839   actor.RotateY(9
-0000fce0: 3029 0a20 2020 2020 2020 2020 2020 2023  0).            #
-0000fcf0: 2020 2020 2372 656e 2e52 6573 6574 4361      #ren.ResetCa
-0000fd00: 6d65 7261 2829 0a20 2020 2020 2020 2020  mera().         
-0000fd10: 2020 2023 2020 2020 6f75 7479 696d 6167     #    outyimag
-0000fd20: 6520 3d20 277b 7d7b 7d5f 656d 645f 7b7d  e = '{}{}_emd_{}
-0000fd30: 5f79 7375 7266 6163 652e 6a70 6567 272e  _ysurface.jpeg'.
-0000fd40: 666f 726d 6174 2873 656c 662e 776f 726b  format(self.work
-0000fd50: 6469 722c 2070 6462 6964 2c20 7365 6c66  dir, pdbid, self
-0000fd60: 2e65 6d64 6964 2029 0a20 2020 2020 2020  .emdid ).       
-0000fd70: 2020 2020 2023 2020 2020 7365 6c66 2e77       #    self.w
-0000fd80: 7269 7465 5f69 6d61 6765 286f 7574 7969  rite_image(outyi
-0000fd90: 6d61 6765 2c20 7265 6e57 696e 290a 0a20  mage, renWin).. 
-0000fda0: 2020 2020 2020 2020 2020 2023 2020 2020             #    
-0000fdb0: 6163 746f 722e 526f 7461 7465 5a28 3930  actor.RotateZ(90
-0000fdc0: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
-0000fdd0: 2020 2061 6374 6f72 2e52 6f74 6174 6558     actor.RotateX
-0000fde0: 2839 3029 0a20 2020 2020 2020 2020 2020  (90).           
-0000fdf0: 2023 2020 2020 2372 656e 2e52 6573 6574   #    #ren.Reset
-0000fe00: 4361 6d65 7261 2829 0a20 2020 2020 2020  Camera().       
-0000fe10: 2020 2020 2023 2020 2020 6f75 7478 696d       #    outxim
-0000fe20: 6167 6520 3d20 277b 7d7b 7d5f 656d 645f  age = '{}{}_emd_
-0000fe30: 7b7d 5f78 7375 7266 6163 652e 6a70 6567  {}_xsurface.jpeg
-0000fe40: 272e 666f 726d 6174 2873 656c 662e 776f  '.format(self.wo
-0000fe50: 726b 6469 722c 2070 6462 6964 2c20 7365  rkdir, pdbid, se
-0000fe60: 6c66 2e65 6d64 6964 2029 0a20 2020 2020  lf.emdid ).     
-0000fe70: 2020 2020 2020 2023 2020 2020 7365 6c66         #    self
-0000fe80: 2e77 7269 7465 5f69 6d61 6765 286f 7574  .write_image(out
-0000fe90: 7869 6d61 6765 2c20 7265 6e57 696e 290a  ximage, renWin).
-0000fea0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0000feb0: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-0000fec0: 6c66 2e6d 6170 2069 7320 6e6f 7420 4e6f  lf.map is not No
-0000fed0: 6e65 2061 6e64 2073 656c 662e 636c 2069  ne and self.cl i
-0000fee0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-0000fef0: 2020 2020 2020 2020 2020 2020 6368 6563              chec
-0000ff00: 6b76 7470 7265 7375 6c74 203d 2073 656c  kvtpresult = sel
-0000ff10: 662e 6368 6563 6b76 7470 2829 0a20 2020  f.checkvtp().   
-0000ff20: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0000ff30: 6368 6563 6b76 7470 7265 7375 6c74 3a0a  checkvtpresult:.
-0000ff40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ff50: 2020 2020 7674 7046 696c 6520 3d20 6368      vtpFile = ch
-0000ff60: 6563 6b76 7470 7265 7375 6c74 0a20 2020  eckvtpresult.   
-0000ff70: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-0000ff80: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0000ff90: 2020 2020 2020 2023 2046 6972 7374 2066         # First f
-0000ffa0: 756e 6374 696f 6e20 6865 7265 2070 726f  unction here pro
-0000ffb0: 6475 6365 2076 7470 2066 696c 6520 6261  duce vtp file ba
-0000ffc0: 7365 6420 6f6e 206d 6170 2077 6974 6820  sed on map with 
-0000ffd0: 7468 6520 636c 0a20 2020 2020 2020 2020  the cl.         
-0000ffe0: 2020 2020 2020 2020 2020 2076 7470 4669             vtpFi
-0000fff0: 6c65 203d 2073 656c 662e 6765 6e76 7470  le = self.genvtp
-00010000: 2873 656c 662e 6d61 702e 6669 6c65 6e61  (self.map.filena
-00010010: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
-00010020: 2020 2020 2020 2020 7072 696e 7428 2741          print('A
-00010030: 2076 7470 2066 696c 6520 636f 7272 6573   vtp file corres
-00010040: 706f 6e64 2074 6f20 6465 6e73 6974 7920  pond to density 
-00010050: 6d61 7020 6973 2067 656e 6572 6174 6564  map is generated
-00010060: 2e27 290a 0a20 2020 2020 2020 2020 2020  .')..           
-00010070: 2020 2020 2066 6163 7447 7261 7068 6963       factGraphic
-00010080: 7320 3d20 7674 6b2e 7674 6b47 7261 7068  s = vtk.vtkGraph
-00010090: 6963 7346 6163 746f 7279 2829 0a20 2020  icsFactory().   
-000100a0: 2020 2020 2020 2020 2020 2020 2066 6163               fac
-000100b0: 7447 7261 7068 6963 732e 5365 744f 6666  tGraphics.SetOff
-000100c0: 5363 7265 656e 4f6e 6c79 4d6f 6465 2831  ScreenOnlyMode(1
-000100d0: 293b 0a20 2020 2020 2020 2020 2020 2020  );.             
-000100e0: 2020 2066 6163 7447 7261 7068 6963 732e     factGraphics.
-000100f0: 5365 7455 7365 4d65 7361 436c 6173 7365  SetUseMesaClasse
-00010100: 7328 3129 0a20 2020 2020 2020 2020 2020  s(1).           
-00010110: 2020 2020 2072 6561 6465 7220 3d20 7674       reader = vt
-00010120: 6b2e 7674 6b58 4d4c 506f 6c79 4461 7461  k.vtkXMLPolyData
-00010130: 5265 6164 6572 2829 0a20 2020 2020 2020  Reader().       
-00010140: 2020 2020 2020 2020 2072 6561 6465 722e           reader.
-00010150: 5365 7446 696c 654e 616d 6528 7674 7046  SetFileName(vtpF
-00010160: 696c 6529 0a20 2020 2020 2020 2020 2020  ile).           
-00010170: 2020 2020 2072 6561 6465 722e 5570 6461       reader.Upda
-00010180: 7465 2829 0a0a 2020 2020 2020 2020 2020  te()..          
-00010190: 2020 2020 2020 6d61 7070 6572 203d 2076        mapper = v
-000101a0: 746b 2e76 746b 506f 6c79 4461 7461 4d61  tk.vtkPolyDataMa
-000101b0: 7070 6572 2829 0a20 2020 2020 2020 2020  pper().         
-000101c0: 2020 2020 2020 206d 6170 7065 722e 5363         mapper.Sc
-000101d0: 616c 6172 5669 7369 6269 6c69 7479 4f66  alarVisibilityOf
-000101e0: 6628 290a 2020 2020 2020 2020 2020 2020  f().            
-000101f0: 2020 2020 6d61 7070 6572 2e53 6574 496e      mapper.SetIn
-00010200: 7075 7443 6f6e 6e65 6374 696f 6e28 7265  putConnection(re
-00010210: 6164 6572 2e47 6574 4f75 7470 7574 506f  ader.GetOutputPo
-00010220: 7274 2829 290a 0a20 2020 2020 2020 2020  rt())..         
-00010230: 2020 2020 2020 2061 6374 6f72 203d 2076         actor = v
-00010240: 746b 2e76 746b 4163 746f 7228 290a 2020  tk.vtkActor().  
-00010250: 2020 2020 2020 2020 2020 2020 2020 6163                ac
-00010260: 746f 722e 5365 744d 6170 7065 7228 6d61  tor.SetMapper(ma
-00010270: 7070 6572 290a 2020 2020 2020 2020 2020  pper).          
-00010280: 2020 2020 2020 6163 746f 722e 4765 7450        actor.GetP
-00010290: 726f 7065 7274 7928 292e 5365 7443 6f6c  roperty().SetCol
-000102a0: 6f72 2831 2e30 2c20 302e 382c 2030 2e31  or(1.0, 0.8, 0.1
-000102b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000102c0: 2020 6163 746f 722e 4765 7450 726f 7065    actor.GetPrope
-000102d0: 7274 7928 292e 5365 7449 6e74 6572 706f  rty().SetInterpo
-000102e0: 6c61 7469 6f6e 546f 5068 6f6e 6728 290a  lationToPhong().
-000102f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010300: 6163 746f 722e 4765 7450 726f 7065 7274  actor.GetPropert
-00010310: 7928 292e 5365 7444 6966 6675 7365 2830  y().SetDiffuse(0
-00010320: 2e39 290a 2020 2020 2020 2020 2020 2020  .9).            
-00010330: 2020 2020 6163 746f 722e 4765 7450 726f      actor.GetPro
-00010340: 7065 7274 7928 292e 5365 7453 7065 6375  perty().SetSpecu
-00010350: 6c61 7228 302e 3629 0a20 2020 2020 2020  lar(0.6).       
-00010360: 2020 2020 2020 2020 2061 6374 6f72 2e47           actor.G
-00010370: 6574 5072 6f70 6572 7479 2829 2e53 6574  etProperty().Set
-00010380: 5370 6563 756c 6172 506f 7765 7228 3330  SpecularPower(30
+0000df80: 2827 4e6f 2072 6177 206d 6170 2074 6f20  ('No raw map to 
+0000df90: 6361 6c63 756c 6174 6520 6c61 7267 6573  calculate larges
+0000dfa0: 7420 7661 7269 616e 6365 2e27 290a 0a20  t variance.').. 
+0000dfb0: 2020 2020 2020 2072 6574 7572 6e20 4e6f         return No
+0000dfc0: 6e65 0a0a 2020 2020 2320 4070 726f 6669  ne..    # @profi
+0000dfd0: 6c65 0a20 2020 2064 6566 206c 6172 6765  le.    def large
+0000dfe0: 7374 5f76 6172 6961 6e63 6528 7365 6c66  st_variance(self
+0000dff0: 2c20 6d61 7069 6e3d 4e6f 6e65 2c20 776f  , mapin=None, wo
+0000e000: 726b 6469 723d 4e6f 6e65 2c20 6c61 6265  rkdir=None, labe
+0000e010: 6c3d 2727 293a 0a20 2020 2020 2020 2022  l=''):.        "
+0000e020: 2222 0a20 2020 2020 2020 2020 2020 2020  "".             
+0000e030: 4c61 7267 6573 7420 7661 7269 616e 6365  Largest variance
+0000e040: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+0000e050: 6d61 7069 6e3a 2049 6e70 7574 206d 6170  mapin: Input map
+0000e060: 2065 6974 6865 7220 6d72 6366 696c 6520   either mrcfile 
+0000e070: 6f72 2066 696c 656e 616d 6520 7374 7269  or filename stri
+0000e080: 6e67 0a20 2020 2020 2020 203a 7061 7261  ng.        :para
+0000e090: 6d20 776f 726b 6469 723a 2053 7472 696e  m workdir: Strin
+0000e0a0: 6720 6f66 2074 6865 2066 756c 6c20 776f  g of the full wo
+0000e0b0: 726b 2070 6174 680a 2020 2020 2020 2020  rk path.        
+0000e0c0: 3a70 6172 616d 206c 6162 656c 3a20 666f  :param label: fo
+0000e0d0: 7220 7261 7720 6d61 7020 7573 6520 2772  r raw map use 'r
+0000e0e0: 6177 5f27 0a20 2020 2020 2020 203a 7265  aw_'.        :re
+0000e0f0: 7475 726e 3a20 4e6f 6e65 0a20 2020 2020  turn: None.     
+0000e100: 2020 2022 2222 0a0a 2020 2020 2020 2020     """..        
+0000e110: 6d61 702c 2077 6f72 6b64 6972 203d 2073  map, workdir = s
+0000e120: 656c 662e 6d61 7069 6e63 6865 636b 286d  elf.mapincheck(m
+0000e130: 6170 696e 2c20 776f 726b 6469 7229 0a20  apin, workdir). 
+0000e140: 2020 2020 2020 206d 6170 6e61 6d65 203d         mapname =
+0000e150: 206f 732e 7061 7468 2e62 6173 656e 616d   os.path.basenam
+0000e160: 6528 6d61 702e 6675 6c6c 6e61 6d65 2920  e(map.fullname) 
+0000e170: 6966 206d 6170 2065 6c73 6520 4e6f 6e65  if map else None
+0000e180: 0a20 2020 2020 2020 2069 6620 6d61 7020  .        if map 
+0000e190: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
+0000e1a0: 776f 726b 6469 7220 6973 206e 6f74 204e  workdir is not N
+0000e1b0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0000e1c0: 207a 6c69 6d2c 2079 6c69 6d2c 2078 6c69   zlim, ylim, xli
+0000e1d0: 6d20 3d20 6d61 702e 6461 7461 2e73 6861  m = map.data.sha
+0000e1e0: 7065 0a20 2020 2020 2020 2020 2020 2073  pe.            s
+0000e1f0: 7461 7274 203d 2074 696d 6569 742e 6465  tart = timeit.de
+0000e200: 6661 756c 745f 7469 6d65 7228 290a 2020  fault_timer().  
+0000e210: 2020 2020 2020 2020 2020 6572 726c 6973            errlis
+0000e220: 7420 3d20 5b5d 0a20 2020 2020 2020 2020  t = [].         
+0000e230: 2020 2074 7970 6520 3d20 276c 6172 6765     type = 'large
+0000e240: 7374 7661 7269 616e 6365 270a 0a20 2020  stvariance'..   
+0000e250: 2020 2020 2020 2020 2078 7072 6f6a 6563           xprojec
+0000e260: 7469 6f6e 6e61 6d65 203d 2077 6f72 6b64  tionname = workd
+0000e270: 6972 202b 206d 6170 6e61 6d65 202b 2027  ir + mapname + '
+0000e280: 5f78 6c61 7267 6573 7476 6172 6961 6e63  _xlargestvarianc
+0000e290: 655f 736c 6963 652e 6a70 6567 270a 2020  e_slice.jpeg'.  
+0000e2a0: 2020 2020 2020 2020 2020 7873 6361 6c65            xscale
+0000e2b0: 6e61 6d65 203d 2077 6f72 6b64 6972 202b  name = workdir +
+0000e2c0: 206d 6170 6e61 6d65 202b 2027 5f73 6361   mapname + '_sca
+0000e2d0: 6c65 645f 786c 6172 6765 7374 7661 7269  led_xlargestvari
+0000e2e0: 616e 6365 5f73 6c69 6365 2e6a 7065 6727  ance_slice.jpeg'
+0000e2f0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0000e300: 662e 6d61 705f 746f 5f69 6d67 286d 6170  f.map_to_img(map
+0000e310: 2c20 322c 2074 7970 652c 2065 7272 6c69  , 2, type, errli
+0000e320: 7374 290a 0a20 2020 2020 2020 2020 2020  st)..           
+0000e330: 2079 7072 6f6a 6563 7469 6f6e 6e61 6d65   yprojectionname
+0000e340: 203d 2077 6f72 6b64 6972 202b 206d 6170   = workdir + map
+0000e350: 6e61 6d65 202b 2027 5f79 6c61 7267 6573  name + '_ylarges
+0000e360: 7476 6172 6961 6e63 655f 736c 6963 652e  tvariance_slice.
+0000e370: 6a70 6567 270a 2020 2020 2020 2020 2020  jpeg'.          
+0000e380: 2020 7973 6361 6c65 6e61 6d65 203d 2077    yscalename = w
+0000e390: 6f72 6b64 6972 202b 206d 6170 6e61 6d65  orkdir + mapname
+0000e3a0: 202b 2027 5f73 6361 6c65 645f 796c 6172   + '_scaled_ylar
+0000e3b0: 6765 7374 7661 7269 616e 6365 5f73 6c69  gestvariance_sli
+0000e3c0: 6365 2e6a 7065 6727 0a20 2020 2020 2020  ce.jpeg'.       
+0000e3d0: 2020 2020 2073 656c 662e 6d61 705f 746f       self.map_to
+0000e3e0: 5f69 6d67 286d 6170 2c20 312c 2074 7970  _img(map, 1, typ
+0000e3f0: 652c 2065 7272 6c69 7374 290a 0a20 2020  e, errlist)..   
+0000e400: 2020 2020 2020 2020 207a 7072 6f6a 6563           zprojec
+0000e410: 7469 6f6e 6e61 6d65 203d 2077 6f72 6b64  tionname = workd
+0000e420: 6972 202b 206d 6170 6e61 6d65 202b 2027  ir + mapname + '
+0000e430: 5f7a 6c61 7267 6573 7476 6172 6961 6e63  _zlargestvarianc
+0000e440: 655f 736c 6963 652e 6a70 6567 270a 2020  e_slice.jpeg'.  
+0000e450: 2020 2020 2020 2020 2020 7a73 6361 6c65            zscale
+0000e460: 6e61 6d65 203d 2077 6f72 6b64 6972 202b  name = workdir +
+0000e470: 206d 6170 6e61 6d65 202b 2027 5f73 6361   mapname + '_sca
+0000e480: 6c65 645f 7a6c 6172 6765 7374 7661 7269  led_zlargestvari
+0000e490: 616e 6365 5f73 6c69 6365 2e6a 7065 6727  ance_slice.jpeg'
+0000e4a0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0000e4b0: 662e 6d61 705f 746f 5f69 6d67 286d 6170  f.map_to_img(map
+0000e4c0: 2c20 302c 2074 7970 652c 2065 7272 6c69  , 0, type, errli
+0000e4d0: 7374 290a 0a20 2020 2020 2020 2020 2020  st)..           
+0000e4e0: 2078 7661 7220 3d20 5b6e 6469 6d61 6765   xvar = [ndimage
+0000e4f0: 2e76 6172 6961 6e63 6528 6d61 702e 6461  .variance(map.da
+0000e500: 7461 5b3a 2c20 3a2c 2069 5d29 2066 6f72  ta[:, :, i]) for
+0000e510: 2069 2069 6e20 7261 6e67 6528 302c 2078   i in range(0, x
+0000e520: 6c69 6d29 5d0a 2020 2020 2020 2020 2020  lim)].          
+0000e530: 2020 7976 6172 203d 205b 6e64 696d 6167    yvar = [ndimag
+0000e540: 652e 7661 7269 616e 6365 286d 6170 2e64  e.variance(map.d
+0000e550: 6174 615b 3a2c 2069 2c20 3a5d 2920 666f  ata[:, i, :]) fo
+0000e560: 7220 6920 696e 2072 616e 6765 2830 2c20  r i in range(0, 
+0000e570: 796c 696d 295d 0a20 2020 2020 2020 2020  ylim)].         
+0000e580: 2020 207a 7661 7220 3d20 5b6e 6469 6d61     zvar = [ndima
+0000e590: 6765 2e76 6172 6961 6e63 6528 6d61 702e  ge.variance(map.
+0000e5a0: 6461 7461 5b69 2c20 3a2c 203a 5d29 2066  data[i, :, :]) f
+0000e5b0: 6f72 2069 2069 6e20 7261 6e67 6528 302c  or i in range(0,
+0000e5c0: 207a 6c69 6d29 5d0a 2020 2020 2020 2020   zlim)].        
+0000e5d0: 2020 2020 786c 6172 6765 696e 6420 3d20      xlargeind = 
+0000e5e0: 696e 7428 6e70 2e61 7267 6d61 7828 7876  int(np.argmax(xv
+0000e5f0: 6172 2929 0a20 2020 2020 2020 2020 2020  ar)).           
+0000e600: 2079 6c61 7267 6569 6e64 203d 2069 6e74   ylargeind = int
+0000e610: 286e 702e 6172 676d 6178 2879 7661 7229  (np.argmax(yvar)
+0000e620: 290a 2020 2020 2020 2020 2020 2020 7a6c  ).            zl
+0000e630: 6172 6765 696e 6420 3d20 696e 7428 6e70  argeind = int(np
+0000e640: 2e61 7267 6d61 7828 7a76 6172 2929 0a0a  .argmax(zvar))..
+0000e650: 2020 2020 2020 2020 2020 2020 626f 7468              both
+0000e660: 6a73 6f6e 203d 2064 6963 7428 290a 2020  json = dict().  
+0000e670: 2020 2020 2020 2020 2020 7072 6f6a 6563            projec
+0000e680: 7469 6f6e 6a73 6f6e 203d 2064 6963 7428  tionjson = dict(
+0000e690: 290a 2020 2020 2020 2020 2020 2020 6f72  ).            or
+0000e6a0: 6770 726f 6a65 6374 696f 6e6a 736f 6e20  gprojectionjson 
+0000e6b0: 3d20 6469 6374 2829 0a0a 2020 2020 2020  = dict()..      
+0000e6c0: 2020 2020 2020 7072 6f6a 6563 7469 6f6e        projection
+0000e6d0: 6a73 6f6e 5b27 7827 5d20 3d20 6f73 2e70  json['x'] = os.p
+0000e6e0: 6174 682e 6261 7365 6e61 6d65 2878 7363  ath.basename(xsc
+0000e6f0: 616c 656e 616d 6529 2069 6620 6f73 2e70  alename) if os.p
+0000e700: 6174 682e 6973 6669 6c65 2878 7363 616c  ath.isfile(xscal
+0000e710: 656e 616d 6529 2065 6c73 6520 4e6f 6e65  ename) else None
+0000e720: 0a20 2020 2020 2020 2020 2020 2070 726f  .            pro
+0000e730: 6a65 6374 696f 6e6a 736f 6e5b 2779 275d  jectionjson['y']
+0000e740: 203d 206f 732e 7061 7468 2e62 6173 656e   = os.path.basen
+0000e750: 616d 6528 7973 6361 6c65 6e61 6d65 2920  ame(yscalename) 
+0000e760: 6966 206f 732e 7061 7468 2e69 7366 696c  if os.path.isfil
+0000e770: 6528 7973 6361 6c65 6e61 6d65 2920 656c  e(yscalename) el
+0000e780: 7365 204e 6f6e 650a 2020 2020 2020 2020  se None.        
+0000e790: 2020 2020 7072 6f6a 6563 7469 6f6e 6a73      projectionjs
+0000e7a0: 6f6e 5b27 7a27 5d20 3d20 6f73 2e70 6174  on['z'] = os.pat
+0000e7b0: 682e 6261 7365 6e61 6d65 287a 7363 616c  h.basename(zscal
+0000e7c0: 656e 616d 6529 2069 6620 6f73 2e70 6174  ename) if os.pat
+0000e7d0: 682e 6973 6669 6c65 287a 7363 616c 656e  h.isfile(zscalen
+0000e7e0: 616d 6529 2065 6c73 6520 4e6f 6e65 0a0a  ame) else None..
+0000e7f0: 2020 2020 2020 2020 2020 2020 6f72 6770              orgp
+0000e800: 726f 6a65 6374 696f 6e6a 736f 6e5b 2778  rojectionjson['x
+0000e810: 275d 203d 206f 732e 7061 7468 2e62 6173  '] = os.path.bas
+0000e820: 656e 616d 6528 7870 726f 6a65 6374 696f  ename(xprojectio
+0000e830: 6e6e 616d 6529 2069 6620 6f73 2e70 6174  nname) if os.pat
+0000e840: 682e 6973 6669 6c65 2878 7072 6f6a 6563  h.isfile(xprojec
+0000e850: 7469 6f6e 6e61 6d65 2920 656c 7365 204e  tionname) else N
+0000e860: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+0000e870: 6f72 6770 726f 6a65 6374 696f 6e6a 736f  orgprojectionjso
+0000e880: 6e5b 2779 275d 203d 206f 732e 7061 7468  n['y'] = os.path
+0000e890: 2e62 6173 656e 616d 6528 7970 726f 6a65  .basename(yproje
+0000e8a0: 6374 696f 6e6e 616d 6529 2069 6620 6f73  ctionname) if os
+0000e8b0: 2e70 6174 682e 6973 6669 6c65 2879 7072  .path.isfile(ypr
+0000e8c0: 6f6a 6563 7469 6f6e 6e61 6d65 2920 656c  ojectionname) el
+0000e8d0: 7365 204e 6f6e 650a 2020 2020 2020 2020  se None.        
+0000e8e0: 2020 2020 6f72 6770 726f 6a65 6374 696f      orgprojectio
+0000e8f0: 6e6a 736f 6e5b 277a 275d 203d 206f 732e  njson['z'] = os.
+0000e900: 7061 7468 2e62 6173 656e 616d 6528 7a70  path.basename(zp
+0000e910: 726f 6a65 6374 696f 6e6e 616d 6529 2069  rojectionname) i
+0000e920: 6620 6f73 2e70 6174 682e 6973 6669 6c65  f os.path.isfile
+0000e930: 287a 7072 6f6a 6563 7469 6f6e 6e61 6d65  (zprojectionname
+0000e940: 2920 656c 7365 204e 6f6e 650a 0a20 2020  ) else None..   
+0000e950: 2020 2020 2020 2020 2062 6f74 686a 736f           bothjso
+0000e960: 6e5b 276f 7269 6769 6e61 6c27 5d20 3d20  n['original'] = 
+0000e970: 6f72 6770 726f 6a65 6374 696f 6e6a 736f  orgprojectionjso
+0000e980: 6e0a 2020 2020 2020 2020 2020 2020 626f  n.            bo
+0000e990: 7468 6a73 6f6e 5b27 7363 616c 6564 275d  thjson['scaled']
+0000e9a0: 203d 2070 726f 6a65 6374 696f 6e6a 736f   = projectionjso
+0000e9b0: 6e0a 2020 2020 2020 2020 2020 2020 626f  n.            bo
+0000e9c0: 7468 6a73 6f6e 5b27 696e 6469 6365 7327  thjson['indices'
+0000e9d0: 5d20 3d20 7b27 7827 3a20 786c 6172 6765  ] = {'x': xlarge
+0000e9e0: 696e 642c 2027 7927 3a20 796c 6172 6765  ind, 'y': ylarge
+0000e9f0: 696e 642c 2027 7a27 3a20 7a6c 6172 6765  ind, 'z': zlarge
+0000ea00: 696e 647d 0a0a 2020 2020 2020 2020 2020  ind}..          
+0000ea10: 2020 6966 2065 7272 6c69 7374 3a0a 2020    if errlist:.  
+0000ea20: 2020 2020 2020 2020 2020 2020 2020 626f                bo
+0000ea30: 7468 6a73 6f6e 5b27 6572 7227 5d20 3d20  thjson['err'] = 
+0000ea40: 7b27 6c61 7267 6573 745f 7661 7269 616e  {'largest_varian
+0000ea50: 6365 5f65 7272 273a 2065 7272 6c69 7374  ce_err': errlist
+0000ea60: 7d0a 2020 2020 2020 2020 2020 2020 6669  }.            fi
+0000ea70: 6e61 6c64 6963 7420 3d20 7b6c 6162 656c  naldict = {label
+0000ea80: 202b 2027 6c61 7267 6573 745f 7661 7269   + 'largest_vari
+0000ea90: 616e 6365 5f73 6c69 6365 273a 2062 6f74  ance_slice': bot
+0000eaa0: 686a 736f 6e7d 0a0a 2020 2020 2020 2020  hjson}..        
+0000eab0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0000eac0: 2020 2020 2020 2020 2077 6974 6820 636f           with co
+0000ead0: 6465 6373 2e6f 7065 6e28 776f 726b 6469  decs.open(workdi
+0000eae0: 7220 2b20 6d61 706e 616d 6520 2b20 275f  r + mapname + '_
+0000eaf0: 6c61 7267 6573 7476 6172 6961 6e63 652e  largestvariance.
+0000eb00: 6a73 6f6e 272c 2027 7727 2c20 656e 636f  json', 'w', enco
+0000eb10: 6469 6e67 3d27 7574 662d 3827 2920 6173  ding='utf-8') as
+0000eb20: 2066 3a0a 2020 2020 2020 2020 2020 2020   f:.            
+0000eb30: 2020 2020 2020 2020 6a73 6f6e 2e64 756d          json.dum
+0000eb40: 7028 6669 6e61 6c64 6963 742c 2066 290a  p(finaldict, f).
+0000eb50: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+0000eb60: 7074 2049 4f45 7272 6f72 2061 7320 696f  pt IOError as io
+0000eb70: 6572 723a 0a20 2020 2020 2020 2020 2020  err:.           
+0000eb80: 2020 2020 206a 736f 6e65 7272 203d 2027       jsonerr = '
+0000eb90: 5361 7669 6e67 206c 6172 6765 7374 2076  Saving largest v
+0000eba0: 6172 6961 6e63 6520 696e 746f 206a 736f  ariance into jso
+0000ebb0: 6e20 6572 726f 723a 207b 7d27 2e66 6f72  n error: {}'.for
+0000ebc0: 6d61 7428 696f 6572 7229 0a20 2020 2020  mat(ioerr).     
+0000ebd0: 2020 2020 2020 2020 2020 2073 7973 2e73             sys.s
+0000ebe0: 7464 6572 722e 7772 6974 6528 6a73 6f6e  tderr.write(json
+0000ebf0: 6572 7220 2b20 275c 6e27 290a 0a20 2020  err + '\n')..   
+0000ec00: 2020 2020 2020 2020 2065 6e64 203d 2074           end = t
+0000ec10: 696d 6569 742e 6465 6661 756c 745f 7469  imeit.default_ti
+0000ec20: 6d65 7228 290a 2020 2020 2020 2020 2020  mer().          
+0000ec30: 2020 7072 696e 7428 274c 6172 6765 7374    print('Largest
+0000ec40: 2076 6172 6961 6e63 6520 7469 6d65 2066   variance time f
+0000ec50: 6f72 2025 733a 2025 7327 2025 2028 6d61  or %s: %s' % (ma
+0000ec60: 706e 616d 652c 2065 6e64 202d 2073 7461  pname, end - sta
+0000ec70: 7274 2929 0a20 2020 2020 2020 2020 2020  rt)).           
+0000ec80: 2070 7269 6e74 2827 2d2d 2d2d 2d2d 2d2d   print('--------
+0000ec90: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000eca0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2729 0a0a  ------------')..
+0000ecb0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0000ecc0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0000ecd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ece0: 2027 4e6f 206c 6172 6765 7374 2076 6172   'No largest var
+0000ecf0: 6961 6e63 6520 7769 7468 6f75 7420 7072  iance without pr
+0000ed00: 6f70 6572 206d 6170 2069 6e70 7574 2061  oper map input a
+0000ed10: 6e64 2074 6865 206f 7574 7075 7420 6469  nd the output di
+0000ed20: 7265 6374 6f72 7920 696e 666f 726d 6174  rectory informat
+0000ed30: 696f 6e2e 2729 0a0a 2020 2020 2020 2020  ion.')..        
+0000ed40: 7265 7475 726e 204e 6f6e 650a 0a20 2020  return None..   
+0000ed50: 2023 2040 7072 6f66 696c 650a 2020 2020   # @profile.    
+0000ed60: 6465 6620 7375 7266 6163 6573 2873 656c  def surfaces(sel
+0000ed70: 6629 3a0a 2020 2020 2020 2020 2222 220a  f):.        """.
+0000ed80: 0a20 2020 2020 2020 2020 2020 2050 726f  .            Pro
+0000ed90: 7564 696e 6720 616c 6c20 7468 6520 7375  uding all the su
+0000eda0: 7266 6163 6520 7265 6c61 7465 6420 696d  rface related im
+0000edb0: 6167 6573 2068 6572 650a 0a20 2020 2020  ages here..     
+0000edc0: 2020 203a 7265 7475 726e 3a0a 2020 2020     :return:.    
+0000edd0: 2020 2020 2222 220a 0a20 2020 2020 2020      """..       
+0000ede0: 2076 746b 7061 636b 2c20 6368 696d 6572   vtkpack, chimer
+0000edf0: 6161 7070 203d 2073 656c 662e 7375 7266  aapp = self.surf
+0000ee00: 6163 655f 656e 7663 6865 636b 2829 0a20  ace_envcheck(). 
+0000ee10: 2020 2020 2020 2069 6620 7365 6c66 2e6d         if self.m
+0000ee20: 6f64 656c 7320 6973 206e 6f74 204e 6f6e  odels is not Non
+0000ee30: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
+0000ee40: 7566 6368 6563 6b20 3d20 5b46 616c 7365  ufcheck = [False
+0000ee50: 2069 6620 6d6f 6465 6c2e 6669 6c65 6e61   if model.filena
+0000ee60: 6d65 2e65 6e64 7377 6974 6828 272e 7064  me.endswith('.pd
+0000ee70: 6227 2920 656c 7365 2054 7275 6520 666f  b') else True fo
+0000ee80: 7220 6d6f 6465 6c20 696e 2073 656c 662e  r model in self.
+0000ee90: 6d6f 6465 6c73 5d0a 2020 2020 2020 2020  models].        
+0000eea0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0000eeb0: 2020 7375 6663 6865 636b 203d 205b 5472    sufcheck = [Tr
+0000eec0: 7565 5d0a 2020 2020 2020 2020 2320 4164  ue].        # Ad
+0000eed0: 6420 6966 206d 6f64 656c 2069 7320 6369  d if model is ci
+0000eee0: 6620 7573 696e 6720 6368 696d 6572 6120  f using chimera 
+0000eef0: 666f 7220 6e6f 770a 2020 2020 2020 2020  for now.        
+0000ef00: 6966 2073 656c 662e 636c 2069 7320 6e6f  if self.cl is no
+0000ef10: 7420 4e6f 6e65 2061 6e64 2073 656c 662e  t None and self.
+0000ef20: 6d65 7420 213d 2027 746f 6d6f 273a 0a20  met != 'tomo':. 
+0000ef30: 2020 2020 2020 2020 2020 2069 6620 7674             if vt
+0000ef40: 6b70 6163 6b20 616e 6420 4661 6c73 6520  kpack and False 
+0000ef50: 696e 2073 7566 6368 6563 6b3a 0a20 2020  in sufcheck:.   
+0000ef60: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0000ef70: 662e 7375 7266 6163 6576 6965 7728 290a  f.surfaceview().
+0000ef80: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+0000ef90: 2063 6869 6d65 7261 6170 703a 0a20 2020   chimeraapp:.   
+0000efa0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0000efb0: 662e 7375 7266 6163 6576 6965 775f 6368  f.surfaceview_ch
+0000efc0: 696d 6572 6128 6368 696d 6572 6161 7070  imera(chimeraapp
+0000efd0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000efe0: 2020 7365 6c66 2e72 6177 6d61 7073 7572    self.rawmapsur
+0000eff0: 6661 6365 5f63 6869 6d65 7261 2863 6869  face_chimera(chi
+0000f000: 6d65 7261 6170 7029 0a20 2020 2020 2020  meraapp).       
+0000f010: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+0000f020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f030: 2020 7365 6c66 2e6d 6f64 656c 6669 7473    self.modelfits
+0000f040: 7572 6661 6365 2863 6869 6d65 7261 6170  urface(chimeraap
+0000f050: 7029 0a20 2020 2020 2020 2020 2020 2020  p).             
+0000f060: 2020 2065 7863 6570 743a 0a20 2020 2020     except:.     
+0000f070: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0000f080: 7269 6e74 2827 4e6f 206d 6f64 656c 2066  rint('No model f
+0000f090: 6974 2073 7572 6661 6365 2076 6965 7720  it surface view 
+0000f0a0: 666f 7220 7777 7064 6220 706c 6174 666f  for wwpdb platfo
+0000f0b0: 726d 2e27 290a 2020 2020 2020 2020 2020  rm.').          
+0000f0c0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0000f0d0: 2020 2020 2020 2020 7379 732e 7374 6465          sys.stde
+0000f0e0: 7272 2e77 7269 7465 2827 4e6f 2070 726f  rr.write('No pro
+0000f0f0: 7065 7220 5654 4b20 6f72 2043 6869 6d65  per VTK or Chime
+0000f100: 7261 2063 616e 2062 6520 7573 6564 2066  ra can be used f
+0000f110: 6f72 2070 726f 6475 6369 6e67 2073 7572  or producing sur
+0000f120: 6661 6365 2076 6965 772e 2050 6c65 6173  face view. Pleas
+0000f130: 6520 6368 6563 6b2e 5c6e 2729 0a20 2020  e check.\n').   
+0000f140: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+0000f150: 6e74 2827 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  nt('------------
+0000f160: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000f170: 2d2d 2d2d 2d2d 2d2d 2729 0a20 2020 2020  --------').     
+0000f180: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0000f190: 2020 2020 2070 7269 6e74 2827 4e6f 2063       print('No c
+0000f1a0: 6f6e 746f 7572 206c 6576 656c 2c20 6e6f  ontour level, no
+0000f1b0: 2073 7572 6661 6365 2076 6965 772e 2729   surface view.')
+0000f1c0: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
+0000f1d0: 6e74 2827 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  nt('------------
+0000f1e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0000f1f0: 2d2d 2d2d 2d2d 2d2d 2729 0a0a 2020 2020  --------')..    
+0000f200: 2320 5375 7266 6163 6520 7669 6577 2056  # Surface view V
+0000f210: 544b 2077 6179 0a20 2020 2064 6566 2073  TK way.    def s
+0000f220: 7572 6661 6365 7669 6577 2873 656c 6629  urfaceview(self)
+0000f230: 3a0a 2020 2020 2020 2020 2222 220a 0a20  :.        """.. 
+0000f240: 2020 2020 2020 2020 2020 2050 726f 6475             Produ
+0000f250: 6365 2073 7572 6661 6365 2076 6965 7773  ce surface views
+0000f260: 2066 726f 6d20 582c 2079 2c20 5a20 6469   from X, y, Z di
+0000f270: 7265 6374 696f 6e73 2e20 5768 656e 206d  rections. When m
+0000f280: 6f64 656c 2069 7320 7468 6572 652c 0a20  odel is there,. 
+0000f290: 2020 2020 2020 2020 2020 206d 6f64 656c             model
+0000f2a0: 2061 6e64 206d 6170 2073 7572 6661 6365   and map surface
+0000f2b0: 2076 6965 7773 2066 6f72 2078 2c20 792c   views for x, y,
+0000f2c0: 207a 2064 6972 6563 7469 6f6e 7320 7765   z directions we
+0000f2d0: 7265 2070 726f 6475 6365 642e 0a20 2020  re produced..   
+0000f2e0: 2020 2020 2020 2020 2054 6869 7320 6973           This is
+0000f2f0: 206f 6e6c 7920 706f 7373 6962 6c65 2077   only possible w
+0000f300: 6865 6e20 7765 2072 756e 206f 6e20 7468  hen we run on th
+0000f310: 6520 7365 7276 6572 2073 6964 6520 6173  e server side as
+0000f320: 2069 7420 6e65 6564 730a 2020 2020 2020   it needs.      
+0000f330: 2020 2020 2020 7674 7020 6669 6c65 732e        vtp files.
+0000f340: 2054 6861 7420 6d65 616e 7320 6974 2061   That means it a
+0000f350: 6c73 6f20 6e65 6564 2074 6865 2065 6d64  lso need the emd
+0000f360: 6964 2074 6f20 7072 6f64 7563 6520 7468  id to produce th
+0000f370: 650a 2020 2020 2020 2020 2020 2020 7375  e.            su
+0000f380: 7266 6163 6520 7669 6577 732e 0a0a 0a20  rface views.... 
+0000f390: 2020 2020 2020 203a 7265 7475 726e 3a20         :return: 
+0000f3a0: 4e6f 6e65 0a20 2020 2020 2020 2022 2222  None.        """
+0000f3b0: 0a20 2020 2020 2020 2073 7461 7274 203d  .        start =
+0000f3c0: 2074 696d 6569 742e 6465 6661 756c 745f   timeit.default_
+0000f3d0: 7469 6d65 7228 290a 0a20 2020 2020 2020  timer()..       
+0000f3e0: 206f 7574 6d61 7078 696d 6167 6520 3d20   outmapximage = 
+0000f3f0: 6f75 746d 6170 7969 6d61 6765 203d 206f  outmapyimage = o
+0000f400: 7574 6d61 707a 696d 6167 6520 3d20 4e6f  utmapzimage = No
+0000f410: 6e65 0a20 2020 2020 2020 2069 6620 7365  ne.        if se
+0000f420: 6c66 2e65 6d64 6964 2069 7320 6e6f 7420  lf.emdid is not 
+0000f430: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0000f440: 2020 7674 7072 6f6f 7420 3d20 4d41 505f    vtproot = MAP_
+0000f450: 5345 5256 4552 5f50 4154 480a 2020 2020  SERVER_PATH.    
+0000f460: 2020 2020 2020 2020 6469 6769 7473 203d          digits =
+0000f470: 205b 6920 666f 7220 6920 696e 2073 7472   [i for i in str
+0000f480: 2873 656c 662e 656d 6469 6429 5d0a 2020  (self.emdid)].  
+0000f490: 2020 2020 2020 2020 2020 6966 206c 656e            if len
+0000f4a0: 2864 6967 6974 7329 203d 3d20 343a 0a20  (digits) == 4:. 
+0000f4b0: 2020 2020 2020 2020 2020 2020 2020 2076                 v
+0000f4c0: 7470 4669 6c65 203d 2027 7b7d 2f7b 7d2f  tpFile = '{}/{}/
+0000f4d0: 7b7d 2f76 612f 656d 645f 7b7d 5f7b 7d2e  {}/va/emd_{}_{}.
+0000f4e0: 7674 7027 2e66 6f72 6d61 7428 7674 7072  vtp'.format(vtpr
+0000f4f0: 6f6f 742c 2064 6967 6974 735b 305d 202b  oot, digits[0] +
+0000f500: 2064 6967 6974 735b 315d 2c20 7365 6c66   digits[1], self
+0000f510: 2e65 6d64 6964 2c20 7365 6c66 2e65 6d64  .emdid, self.emd
+0000f520: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
+0000f530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f560: 2073 656c 662e 636c 290a 2020 2020 2020   self.cl).      
+0000f570: 2020 2020 2020 656c 6966 206c 656e 2864        elif len(d
+0000f580: 6967 6974 7329 203d 3d20 353a 0a20 2020  igits) == 5:.   
+0000f590: 2020 2020 2020 2020 2020 2020 2076 7470               vtp
+0000f5a0: 4669 6c65 203d 2027 7b7d 2f7b 7d2f 7b7d  File = '{}/{}/{}
+0000f5b0: 2f7b 7d2f 7661 2f65 6d64 5f7b 7d5f 7b7d  /{}/va/emd_{}_{}
+0000f5c0: 2e76 7470 272e 666f 726d 6174 2876 7470  .vtp'.format(vtp
+0000f5d0: 726f 6f74 2c20 6469 6769 7473 5b30 5d20  root, digits[0] 
+0000f5e0: 2b20 6469 6769 7473 5b31 5d2c 2064 6967  + digits[1], dig
+0000f5f0: 6974 735b 325d 2c20 7365 6c66 2e65 6d64  its[2], self.emd
+0000f600: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
+0000f610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f640: 2020 2020 7365 6c66 2e65 6d64 6964 2c0a      self.emdid,.
+0000f650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f690: 7365 6c66 2e63 6c29 0a20 2020 2020 2020  self.cl).       
+0000f6a0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0000f6b0: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
+0000f6c0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+0000f6d0: 6f74 206f 732e 7061 7468 2e69 7366 696c  ot os.path.isfil
+0000f6e0: 6528 7674 7046 696c 6529 3a0a 2020 2020  e(vtpFile):.    
+0000f6f0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0000f700: 7428 2756 5450 2066 696c 6520 6f66 2074  t('VTP file of t
+0000f710: 6865 206d 6170 2064 6f65 7320 6e6f 7420  he map does not 
+0000f720: 6578 6973 742e 2729 0a20 2020 2020 2020  exist.').       
+0000f730: 2020 2020 2020 2020 2076 7470 4669 6c65           vtpFile
+0000f740: 203d 2073 656c 662e 6765 6e76 7470 2873   = self.genvtp(s
+0000f750: 656c 662e 6d61 702e 6669 6c65 6e61 6d65  elf.map.filename
+0000f760: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000f770: 2020 7072 696e 7428 2741 2076 7470 2066    print('A vtp f
+0000f780: 696c 6520 636f 7272 6573 706f 6e64 2074  ile correspond t
+0000f790: 6f20 6465 6e73 6974 7920 6d61 7020 6973  o density map is
+0000f7a0: 2067 656e 6572 6174 6564 2e27 290a 0a0a   generated.')...
+0000f7b0: 2020 2020 2020 2020 2020 2020 6661 6374              fact
+0000f7c0: 4772 6170 6869 6373 203d 2076 746b 2e76  Graphics = vtk.v
+0000f7d0: 746b 4772 6170 6869 6373 4661 6374 6f72  tkGraphicsFactor
+0000f7e0: 7928 290a 2020 2020 2020 2020 2020 2020  y().            
+0000f7f0: 6661 6374 4772 6170 6869 6373 2e53 6574  factGraphics.Set
+0000f800: 4f66 6653 6372 6565 6e4f 6e6c 794d 6f64  OffScreenOnlyMod
+0000f810: 6528 3129 0a20 2020 2020 2020 2020 2020  e(1).           
+0000f820: 2066 6163 7447 7261 7068 6963 732e 5365   factGraphics.Se
+0000f830: 7455 7365 4d65 7361 436c 6173 7365 7328  tUseMesaClasses(
+0000f840: 3129 0a20 2020 2020 2020 2020 2020 2072  1).            r
+0000f850: 6561 6465 7220 3d20 7674 6b2e 7674 6b58  eader = vtk.vtkX
+0000f860: 4d4c 506f 6c79 4461 7461 5265 6164 6572  MLPolyDataReader
+0000f870: 2829 0a20 2020 2020 2020 2020 2020 2072  ().            r
+0000f880: 6561 6465 722e 5365 7446 696c 654e 616d  eader.SetFileNam
+0000f890: 6528 7674 7046 696c 6529 0a20 2020 2020  e(vtpFile).     
+0000f8a0: 2020 2020 2020 2072 6561 6465 722e 5570         reader.Up
+0000f8b0: 6461 7465 2829 0a0a 2020 2020 2020 2020  date()..        
+0000f8c0: 2020 2020 6d61 7070 6572 203d 2076 746b      mapper = vtk
+0000f8d0: 2e76 746b 506f 6c79 4461 7461 4d61 7070  .vtkPolyDataMapp
+0000f8e0: 6572 2829 0a20 2020 2020 2020 2020 2020  er().           
+0000f8f0: 206d 6170 7065 722e 5363 616c 6172 5669   mapper.ScalarVi
+0000f900: 7369 6269 6c69 7479 4f66 6628 290a 2020  sibilityOff().  
+0000f910: 2020 2020 2020 2020 2020 6d61 7070 6572            mapper
+0000f920: 2e53 6574 496e 7075 7443 6f6e 6e65 6374  .SetInputConnect
+0000f930: 696f 6e28 7265 6164 6572 2e47 6574 4f75  ion(reader.GetOu
+0000f940: 7470 7574 506f 7274 2829 290a 0a20 2020  tputPort())..   
+0000f950: 2020 2020 2020 2020 2061 6374 6f72 203d           actor =
+0000f960: 2076 746b 2e76 746b 4163 746f 7228 290a   vtk.vtkActor().
+0000f970: 2020 2020 2020 2020 2020 2020 6163 746f              acto
+0000f980: 722e 5365 744d 6170 7065 7228 6d61 7070  r.SetMapper(mapp
+0000f990: 6572 290a 2020 2020 2020 2020 2020 2020  er).            
+0000f9a0: 6163 746f 722e 4765 7450 726f 7065 7274  actor.GetPropert
+0000f9b0: 7928 292e 5365 7443 6f6c 6f72 2831 2e30  y().SetColor(1.0
+0000f9c0: 2c20 302e 382c 2030 2e31 290a 2020 2020  , 0.8, 0.1).    
+0000f9d0: 2020 2020 2020 2020 6163 746f 722e 4765          actor.Ge
+0000f9e0: 7450 726f 7065 7274 7928 292e 5365 7449  tProperty().SetI
+0000f9f0: 6e74 6572 706f 6c61 7469 6f6e 546f 5068  nterpolationToPh
+0000fa00: 6f6e 6728 290a 2020 2020 2020 2020 2020  ong().          
+0000fa10: 2020 6163 746f 722e 4765 7450 726f 7065    actor.GetPrope
+0000fa20: 7274 7928 292e 5365 7444 6966 6675 7365  rty().SetDiffuse
+0000fa30: 2830 2e39 290a 2020 2020 2020 2020 2020  (0.9).          
+0000fa40: 2020 6163 746f 722e 4765 7450 726f 7065    actor.GetPrope
+0000fa50: 7274 7928 292e 5365 7453 7065 6375 6c61  rty().SetSpecula
+0000fa60: 7228 302e 3629 0a20 2020 2020 2020 2020  r(0.6).         
+0000fa70: 2020 2061 6374 6f72 2e47 6574 5072 6f70     actor.GetProp
+0000fa80: 6572 7479 2829 2e53 6574 5370 6563 756c  erty().SetSpecul
+0000fa90: 6172 506f 7765 7228 3330 290a 2020 2020  arPower(30).    
+0000faa0: 2020 2020 2020 2020 6163 746f 722e 4765          actor.Ge
+0000fab0: 7450 726f 7065 7274 7928 292e 4261 636b  tProperty().Back
+0000fac0: 6661 6365 4375 6c6c 696e 674f 6e28 290a  faceCullingOn().
+0000fad0: 2020 2020 2020 2020 2020 2020 6163 746f              acto
+0000fae0: 722e 4765 7450 726f 7065 7274 7928 292e  r.GetProperty().
+0000faf0: 4672 6f6e 7466 6163 6543 756c 6c69 6e67  FrontfaceCulling
+0000fb00: 4f6e 2829 0a0a 2020 2020 2020 2020 2020  On()..          
+0000fb10: 2020 2320 4372 6561 7465 2074 6865 2067    # Create the g
+0000fb20: 7261 7068 6963 7320 7374 7275 6374 7572  raphics structur
+0000fb30: 652e 2054 6865 2072 656e 6465 7265 7220  e. The renderer 
+0000fb40: 7265 6e64 6572 7320 696e 746f 2074 6865  renders into the
+0000fb50: 2072 656e 6465 720a 2020 2020 2020 2020   render.        
+0000fb60: 2020 2020 2320 7769 6e64 6f77 2e20 5468      # window. Th
+0000fb70: 6520 7265 6e64 6572 2077 696e 646f 7720  e render window 
+0000fb80: 696e 7465 7261 6374 6f72 2063 6170 7475  interactor captu
+0000fb90: 7265 7320 6d6f 7573 6520 6576 656e 7473  res mouse events
+0000fba0: 2061 6e64 2077 696c 6c0a 2020 2020 2020   and will.      
+0000fbb0: 2020 2020 2020 2320 7065 7266 6f72 6d20        # perform 
+0000fbc0: 6170 7072 6f70 7269 6174 6520 6361 6d65  appropriate came
+0000fbd0: 7261 206f 7220 6163 746f 7220 6d61 6e69  ra or actor mani
+0000fbe0: 7075 6c61 7469 6f6e 2064 6570 656e 6469  pulation dependi
+0000fbf0: 6e67 206f 6e20 7468 650a 2020 2020 2020  ng on the.      
+0000fc00: 2020 2020 2020 2320 6e61 7475 7265 206f        # nature o
+0000fc10: 6620 7468 6520 6576 656e 7473 2e0a 0a20  f the events... 
+0000fc20: 2020 2020 2020 2020 2020 2072 656e 203d             ren =
+0000fc30: 2076 746b 2e76 746b 5265 6e64 6572 6572   vtk.vtkRenderer
+0000fc40: 2829 0a20 2020 2020 2020 2020 2020 2072  ().            r
+0000fc50: 656e 5769 6e20 3d20 7674 6b2e 7674 6b52  enWin = vtk.vtkR
+0000fc60: 656e 6465 7257 696e 646f 7728 290a 2020  enderWindow().  
+0000fc70: 2020 2020 2020 2020 2020 7265 6e57 696e            renWin
+0000fc80: 2e53 6574 4f66 6653 6372 6565 6e52 656e  .SetOffScreenRen
+0000fc90: 6465 7269 6e67 2831 290a 2020 2020 2020  dering(1).      
+0000fca0: 2020 2020 2020 7265 6e57 696e 2e53 6574        renWin.Set
+0000fcb0: 5369 7a65 2833 3030 302c 2033 3030 3029  Size(3000, 3000)
+0000fcc0: 0a20 2020 2020 2020 2020 2020 2072 656e  .            ren
+0000fcd0: 5769 6e2e 4164 6452 656e 6465 7265 7228  Win.AddRenderer(
+0000fce0: 7265 6e29 0a0a 2020 2020 2020 2020 2020  ren)..          
+0000fcf0: 2020 2320 4164 6420 7468 6520 6163 746f    # Add the acto
+0000fd00: 7273 2074 6f20 7468 6520 7265 6e64 6572  rs to the render
+0000fd10: 6572 2c20 7365 7420 7468 6520 6261 636b  er, set the back
+0000fd20: 6772 6f75 6e64 2061 6e64 2073 697a 650a  ground and size.
+0000fd30: 2020 2020 2020 2020 2020 2020 2320 6163              # ac
+0000fd40: 746f 722e 526f 7461 7465 5928 3930 290a  tor.RotateY(90).
+0000fd50: 2020 2020 2020 2020 2020 2020 7265 6e2e              ren.
+0000fd60: 4164 6441 6374 6f72 2861 6374 6f72 290a  AddActor(actor).
+0000fd70: 2020 2020 2020 2020 2020 2020 7265 6e2e              ren.
+0000fd80: 5365 7442 6163 6b67 726f 756e 6428 302e  SetBackground(0.
+0000fd90: 392c 2030 2e39 2c20 302e 3929 0a20 2020  9, 0.9, 0.9).   
+0000fda0: 2020 2020 2020 2020 2072 656e 2e47 6574           ren.Get
+0000fdb0: 4163 7469 7665 4361 6d65 7261 2829 2e53  ActiveCamera().S
+0000fdc0: 6574 5061 7261 6c6c 656c 5072 6f6a 6563  etParallelProjec
+0000fdd0: 7469 6f6e 2831 290a 2020 2020 2020 2020  tion(1).        
+0000fde0: 2020 2020 7265 6e57 696e 2e52 656e 6465      renWin.Rende
+0000fdf0: 7228 290a 0a20 2020 2020 2020 2020 2020  r()..           
+0000fe00: 2023 204f 7574 7075 7420 6d61 7073 2069   # Output maps i
+0000fe10: 6d61 6765 7320 6f6e 6c79 0a20 2020 2020  mages only.     
+0000fe20: 2020 2020 2020 2072 656e 2e52 6573 6574         ren.Reset
+0000fe30: 4361 6d65 7261 2829 0a20 2020 2020 2020  Camera().       
+0000fe40: 2020 2020 2072 656e 2e47 6574 4163 7469       ren.GetActi
+0000fe50: 7665 4361 6d65 7261 2829 2e5a 6f6f 6d28  veCamera().Zoom(
+0000fe60: 312e 3330 290a 2020 2020 2020 2020 2020  1.30).          
+0000fe70: 2020 6f75 746d 6170 7a69 6d61 6765 203d    outmapzimage =
+0000fe80: 2027 7b7d 656d 645f 7b7d 5f7a 7375 7266   '{}emd_{}_zsurf
+0000fe90: 6163 652e 6a70 6567 272e 666f 726d 6174  ace.jpeg'.format
+0000fea0: 2873 656c 662e 776f 726b 6469 722c 2073  (self.workdir, s
+0000feb0: 656c 662e 656d 6469 6429 0a20 2020 2020  elf.emdid).     
+0000fec0: 2020 2020 2020 2073 656c 662e 7772 6974         self.writ
+0000fed0: 655f 696d 6167 6528 6f75 746d 6170 7a69  e_image(outmapzi
+0000fee0: 6d61 6765 2c20 7265 6e57 696e 290a 0a20  mage, renWin).. 
+0000fef0: 2020 2020 2020 2020 2020 2061 6374 6f72             actor
+0000ff00: 2e52 6f74 6174 6558 2839 3029 0a20 2020  .RotateX(90).   
+0000ff10: 2020 2020 2020 2020 2061 6374 6f72 2e52           actor.R
+0000ff20: 6f74 6174 6559 2839 3029 0a20 2020 2020  otateY(90).     
+0000ff30: 2020 2020 2020 2023 2072 656e 2e52 6573         # ren.Res
+0000ff40: 6574 4361 6d65 7261 2829 0a20 2020 2020  etCamera().     
+0000ff50: 2020 2020 2020 206f 7574 6d61 7079 696d         outmapyim
+0000ff60: 6167 6520 3d20 277b 7d65 6d64 5f7b 7d5f  age = '{}emd_{}_
+0000ff70: 7973 7572 6661 6365 2e6a 7065 6727 2e66  ysurface.jpeg'.f
+0000ff80: 6f72 6d61 7428 7365 6c66 2e77 6f72 6b64  ormat(self.workd
+0000ff90: 6972 2c20 7365 6c66 2e65 6d64 6964 290a  ir, self.emdid).
+0000ffa0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000ffb0: 2e77 7269 7465 5f69 6d61 6765 286f 7574  .write_image(out
+0000ffc0: 6d61 7079 696d 6167 652c 2072 656e 5769  mapyimage, renWi
+0000ffd0: 6e29 0a0a 2020 2020 2020 2020 2020 2020  n)..            
+0000ffe0: 6163 746f 722e 526f 7461 7465 5a28 3930  actor.RotateZ(90
+0000fff0: 290a 2020 2020 2020 2020 2020 2020 6163  ).            ac
+00010000: 746f 722e 526f 7461 7465 5828 3930 290a  tor.RotateX(90).
+00010010: 2020 2020 2020 2020 2020 2020 2320 7265              # re
+00010020: 6e2e 5265 7365 7443 616d 6572 6128 290a  n.ResetCamera().
+00010030: 2020 2020 2020 2020 2020 2020 6f75 746d              outm
+00010040: 6170 7869 6d61 6765 203d 2027 7b7d 656d  apximage = '{}em
+00010050: 645f 7b7d 5f78 7375 7266 6163 652e 6a70  d_{}_xsurface.jp
+00010060: 6567 272e 666f 726d 6174 2873 656c 662e  eg'.format(self.
+00010070: 776f 726b 6469 722c 2073 656c 662e 656d  workdir, self.em
+00010080: 6469 6429 0a20 2020 2020 2020 2020 2020  did).           
+00010090: 2073 656c 662e 7772 6974 655f 696d 6167   self.write_imag
+000100a0: 6528 6f75 746d 6170 7869 6d61 6765 2c20  e(outmapximage, 
+000100b0: 7265 6e57 696e 290a 0a20 2020 2020 2020  renWin)..       
+000100c0: 2020 2020 2023 204d 6f64 656c 2065 7869       # Model exi
+000100d0: 7374 0a20 2020 2020 2020 2020 2020 2069  st.            i
+000100e0: 6620 7365 6c66 2e6d 6f64 656c 733a 0a20  f self.models:. 
+000100f0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00010100: 6f72 206d 6f64 656c 2069 6e20 7365 6c66  or model in self
+00010110: 2e6d 6f64 656c 733a 0a20 2020 2020 2020  .models:.       
+00010120: 2020 2020 2020 2020 2020 2020 2070 6462               pdb
+00010130: 6964 203d 206d 6f64 656c 2e66 696c 656e  id = model.filen
+00010140: 616d 652e 7370 6c69 7428 272f 2729 5b2d  ame.split('/')[-
+00010150: 315d 2e73 706c 6974 2827 2e27 295b 305d  1].split('.')[0]
+00010160: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010170: 2020 2020 2023 2054 6f64 6f3a 2070 7574       # Todo: put
+00010180: 2074 6865 2066 696e 616c 2064 6563 6964   the final decid
+00010190: 6564 2070 6174 6820 6865 7265 2061 7320  ed path here as 
+000101a0: 666f 7220 7468 6520 7064 6220 6f72 2065  for the pdb or e
+000101b0: 6e74 2066 696c 650a 2020 2020 2020 2020  nt file.        
+000101c0: 2020 2020 2020 2020 2020 2020 2320 2a2a              # **
+000101d0: 2a2a 3a20 6861 7320 746f 2075 7365 202e  **: has to use .
+000101e0: 7064 6220 6f72 202e 656e 7420 666f 7220  pdb or .ent for 
+000101f0: 7468 6520 6d6f 6465 6c20 6e65 6564 2074  the model need t
+00010200: 6f20 6265 2063 6861 6e67 6564 2074 6f20  o be changed to 
+00010210: 6369 6620 6669 6c65 0a20 2020 2020 2020  cif file.       
+00010220: 2020 2020 2020 2020 2020 2020 2023 2070               # p
+00010230: 6462 726f 6f74 203d 2027 270a 2020 2020  dbroot = ''.    
+00010240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010250: 656e 7472 6f6f 7420 3d20 4d41 505f 5345  entroot = MAP_SE
+00010260: 5256 4552 5f50 4154 480a 2020 2020 2020  RVER_PATH.      
+00010270: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00010280: 206c 656e 2864 6967 6974 7329 203d 3d20   len(digits) == 
+00010290: 343a 0a20 2020 2020 2020 2020 2020 2020  4:.             
+000102a0: 2020 2020 2020 2020 2020 2065 6e74 4669             entFi
+000102b0: 6c65 203d 2027 7b7d 7b7d 2f7b 7d2f 7661  le = '{}{}/{}/va
+000102c0: 2f27 2e66 6f72 6d61 7428 656e 7472 6f6f  /'.format(entroo
+000102d0: 742c 2064 6967 6974 735b 305d 202b 2064  t, digits[0] + d
+000102e0: 6967 6974 735b 315d 2c20 7365 6c66 2e65  igits[1], self.e
+000102f0: 6d64 6964 290a 2020 2020 2020 2020 2020  mdid).          
+00010300: 2020 2020 2020 2020 2020 656c 6966 206c            elif l
+00010310: 656e 2864 6967 6974 7329 203d 3d20 353a  en(digits) == 5:
+00010320: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010330: 2020 2020 2020 2020 2065 6e74 4669 6c65           entFile
+00010340: 203d 2027 7b7d 7b7d 2f7b 7d2f 7b7d 2f76   = '{}{}/{}/{}/v
+00010350: 612f 272e 666f 726d 6174 2865 6e74 726f  a/'.format(entro
+00010360: 6f74 2c20 6469 6769 7473 5b30 5d20 2b20  ot, digits[0] + 
+00010370: 6469 6769 7473 5b31 5d2c 2064 6967 6974  digits[1], digit
+00010380: 735b 325d 2c20 7365 6c66 2e65 6d64 6964  s[2], self.emdid
 00010390: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000103a0: 2020 6163 746f 722e 4765 7450 726f 7065    actor.GetPrope
-000103b0: 7274 7928 292e 4261 636b 6661 6365 4375  rty().BackfaceCu
-000103c0: 6c6c 696e 674f 6e28 290a 2020 2020 2020  llingOn().      
-000103d0: 2020 2020 2020 2020 2020 6163 746f 722e            actor.
-000103e0: 4765 7450 726f 7065 7274 7928 292e 4672  GetProperty().Fr
-000103f0: 6f6e 7466 6163 6543 756c 6c69 6e67 4f6e  ontfaceCullingOn
-00010400: 2829 0a0a 2020 2020 2020 2020 2020 2020  ()..            
-00010410: 2020 2020 2320 4372 6561 7465 2074 6865      # Create the
-00010420: 2067 7261 7068 6963 7320 7374 7275 6374   graphics struct
-00010430: 7572 652e 2054 6865 2072 656e 6465 7265  ure. The rendere
-00010440: 7220 7265 6e64 6572 7320 696e 746f 2074  r renders into t
-00010450: 6865 2072 656e 6465 720a 2020 2020 2020  he render.      
-00010460: 2020 2020 2020 2020 2020 2320 7769 6e64            # wind
-00010470: 6f77 2e20 5468 6520 7265 6e64 6572 2077  ow. The render w
-00010480: 696e 646f 7720 696e 7465 7261 6374 6f72  indow interactor
-00010490: 2063 6170 7475 7265 7320 6d6f 7573 6520   captures mouse 
-000104a0: 6576 656e 7473 2061 6e64 2077 696c 6c0a  events and will.
+000103a0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000103b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000103c0: 2020 2020 7061 7373 0a20 2020 2020 2020      pass.       
+000103d0: 2020 2020 2020 2020 2020 2020 206d 6f64               mod
+000103e0: 656c 203d 2027 7b7d 7064 627b 7d2e 656e  el = '{}pdb{}.en
+000103f0: 7427 2e66 6f72 6d61 7428 656e 7446 696c  t'.format(entFil
+00010400: 652c 2070 6462 6964 290a 2020 2020 2020  e, pdbid).      
+00010410: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00010420: 206e 6f74 206f 732e 7061 7468 2e69 7366   not os.path.isf
+00010430: 696c 6528 6d6f 6465 6c29 3a0a 2020 2020  ile(model):.    
+00010440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010450: 2020 2020 7072 696e 7428 274d 6f64 656c      print('Model
+00010460: 3a20 2573 2069 7320 6e6f 7420 696e 2074  : %s is not in t
+00010470: 6865 2077 6f72 6b69 6e67 2066 6f6c 6465  he working folde
+00010480: 7220 666f 7220 6d6f 6465 6c20 6d61 7020  r for model map 
+00010490: 7669 6577 2c20 706c 6561 7365 2063 6865  view, please che
+000104a0: 636b 2e27 2025 206d 6f64 656c 290a 2020  ck.' % model).  
 000104b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000104c0: 2320 7065 7266 6f72 6d20 6170 7072 6f70  # perform approp
-000104d0: 7269 6174 6520 6361 6d65 7261 206f 7220  riate camera or 
-000104e0: 6163 746f 7220 6d61 6e69 7075 6c61 7469  actor manipulati
-000104f0: 6f6e 2064 6570 656e 6469 6e67 206f 6e20  on depending on 
-00010500: 7468 650a 2020 2020 2020 2020 2020 2020  the.            
-00010510: 2020 2020 2320 6e61 7475 7265 206f 6620      # nature of 
-00010520: 7468 6520 6576 656e 7473 2e0a 0a20 2020  the events...   
-00010530: 2020 2020 2020 2020 2020 2020 2072 656e               ren
-00010540: 203d 2076 746b 2e76 746b 5265 6e64 6572   = vtk.vtkRender
-00010550: 6572 2829 0a20 2020 2020 2020 2020 2020  er().           
-00010560: 2020 2020 2072 656e 5769 6e20 3d20 7674       renWin = vt
-00010570: 6b2e 7674 6b52 656e 6465 7257 696e 646f  k.vtkRenderWindo
-00010580: 7728 290a 2020 2020 2020 2020 2020 2020  w().            
-00010590: 2020 2020 7265 6e57 696e 2e53 6574 4f66      renWin.SetOf
-000105a0: 6653 6372 6565 6e52 656e 6465 7269 6e67  fScreenRendering
-000105b0: 2831 290a 2020 2020 2020 2020 2020 2020  (1).            
-000105c0: 2020 2020 7265 6e57 696e 2e53 6574 5369      renWin.SetSi
-000105d0: 7a65 2833 3030 302c 2033 3030 3029 0a20  ze(3000, 3000). 
-000105e0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-000105f0: 656e 5769 6e2e 4164 6452 656e 6465 7265  enWin.AddRendere
-00010600: 7228 7265 6e29 0a0a 2020 2020 2020 2020  r(ren)..        
-00010610: 2020 2020 2020 2020 2320 4164 6420 7468          # Add th
-00010620: 6520 6163 746f 7273 2074 6f20 7468 6520  e actors to the 
-00010630: 7265 6e64 6572 6572 2c20 7365 7420 7468  renderer, set th
-00010640: 6520 6261 636b 6772 6f75 6e64 2061 6e64  e background and
-00010650: 2073 697a 650a 2020 2020 2020 2020 2020   size.          
-00010660: 2020 2020 2020 2320 6163 746f 722e 526f        # actor.Ro
-00010670: 7461 7465 5928 3930 290a 2020 2020 2020  tateY(90).      
-00010680: 2020 2020 2020 2020 2020 7265 6e2e 4164            ren.Ad
-00010690: 6441 6374 6f72 2861 6374 6f72 290a 2020  dActor(actor).  
-000106a0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-000106b0: 6e2e 5365 7442 6163 6b67 726f 756e 6428  n.SetBackground(
-000106c0: 302e 392c 2030 2e39 2c20 302e 3929 0a20  0.9, 0.9, 0.9). 
-000106d0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-000106e0: 656e 2e47 6574 4163 7469 7665 4361 6d65  en.GetActiveCame
-000106f0: 7261 2829 2e53 6574 5061 7261 6c6c 656c  ra().SetParallel
-00010700: 5072 6f6a 6563 7469 6f6e 2831 290a 2020  Projection(1).  
-00010710: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00010720: 6e57 696e 2e52 656e 6465 7228 290a 0a20  nWin.Render().. 
-00010730: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00010740: 204f 7570 7574 206d 6170 7320 696d 6167   Ouput maps imag
-00010750: 6573 206f 6e6c 790a 2020 2020 2020 2020  es only.        
-00010760: 2020 2020 2020 2020 7265 6e2e 5265 7365          ren.Rese
-00010770: 7443 616d 6572 6128 290a 2020 2020 2020  tCamera().      
-00010780: 2020 2020 2020 2020 2020 7265 6e2e 4765            ren.Ge
-00010790: 7441 6374 6976 6543 616d 6572 6128 292e  tActiveCamera().
-000107a0: 5a6f 6f6d 2831 2e33 3029 0a20 2020 2020  Zoom(1.30).     
-000107b0: 2020 2020 2020 2020 2020 206f 7574 6d61             outma
-000107c0: 707a 696d 6167 6520 3d20 277b 7d7b 7d5f  pzimage = '{}{}_
-000107d0: 7a73 7572 6661 6365 2e6a 7065 6727 2e66  zsurface.jpeg'.f
-000107e0: 6f72 6d61 7428 7365 6c66 2e77 6f72 6b64  ormat(self.workd
-000107f0: 6972 2c20 7365 6c66 2e6d 6170 6e61 6d65  ir, self.mapname
-00010800: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00010810: 2020 7365 6c66 2e77 7269 7465 5f69 6d61    self.write_ima
-00010820: 6765 286f 7574 6d61 707a 696d 6167 652c  ge(outmapzimage,
-00010830: 2072 656e 5769 6e29 0a0a 2020 2020 2020   renWin)..      
-00010840: 2020 2020 2020 2020 2020 6163 746f 722e            actor.
-00010850: 526f 7461 7465 5828 3930 290a 2020 2020  RotateX(90).    
-00010860: 2020 2020 2020 2020 2020 2020 6163 746f              acto
-00010870: 722e 526f 7461 7465 5928 3930 290a 2020  r.RotateY(90).  
-00010880: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00010890: 7265 6e2e 5265 7365 7443 616d 6572 6128  ren.ResetCamera(
-000108a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000108b0: 2020 6f75 746d 6170 7969 6d61 6765 203d    outmapyimage =
-000108c0: 2027 7b7d 7b7d 5f79 7375 7266 6163 652e   '{}{}_ysurface.
-000108d0: 6a70 6567 272e 666f 726d 6174 2873 656c  jpeg'.format(sel
-000108e0: 662e 776f 726b 6469 722c 2073 656c 662e  f.workdir, self.
-000108f0: 6d61 706e 616d 6529 0a20 2020 2020 2020  mapname).       
-00010900: 2020 2020 2020 2020 2073 656c 662e 7772           self.wr
-00010910: 6974 655f 696d 6167 6528 6f75 746d 6170  ite_image(outmap
-00010920: 7969 6d61 6765 2c20 7265 6e57 696e 290a  yimage, renWin).
-00010930: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010940: 2061 6374 6f72 2e52 6f74 6174 655a 2839   actor.RotateZ(9
-00010950: 3029 0a20 2020 2020 2020 2020 2020 2020  0).             
-00010960: 2020 2061 6374 6f72 2e52 6f74 6174 6558     actor.RotateX
-00010970: 2839 3029 0a20 2020 2020 2020 2020 2020  (90).           
-00010980: 2020 2020 2023 2072 656e 2e52 6573 6574       # ren.Reset
-00010990: 4361 6d65 7261 2829 0a20 2020 2020 2020  Camera().       
-000109a0: 2020 2020 2020 2020 206f 7574 6d61 7078           outmapx
-000109b0: 696d 6167 6520 3d20 277b 7d7b 7d5f 7873  image = '{}{}_xs
-000109c0: 7572 6661 6365 2e6a 7065 6727 2e66 6f72  urface.jpeg'.for
-000109d0: 6d61 7428 7365 6c66 2e77 6f72 6b64 6972  mat(self.workdir
-000109e0: 2c20 7365 6c66 2e6d 6170 6e61 6d65 290a  , self.mapname).
-000109f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010a00: 7365 6c66 2e77 7269 7465 5f69 6d61 6765  self.write_image
-00010a10: 286f 7574 6d61 7078 696d 6167 652c 2072  (outmapximage, r
-00010a20: 656e 5769 6e29 0a0a 2020 2020 2020 2020  enWin)..        
-00010a30: 2020 2020 2020 2020 2320 4d6f 6465 6c20          # Model 
-00010a40: 6578 6973 740a 2020 2020 2020 2020 2020  exist.          
-00010a50: 2020 2020 2020 6966 2073 656c 662e 6d6f        if self.mo
-00010a60: 6465 6c73 3a0a 2020 2020 2020 2020 2020  dels:.          
-00010a70: 2020 2020 2020 2020 2020 2320 7072 696e            # prin
-00010a80: 7420 2273 656c 662e 6d6f 6465 6c73 3a25  t "self.models:%
-00010a90: 7322 2025 2073 656c 662e 6d6f 6465 6c73  s" % self.models
-00010aa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010ab0: 2020 2020 2066 6f72 206d 6f64 656c 2069       for model i
-00010ac0: 6e20 7365 6c66 2e6d 6f64 656c 733a 0a20  n self.models:. 
-00010ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010ae0: 2020 2020 2020 2070 6462 6964 203d 206d         pdbid = m
-00010af0: 6f64 656c 2e66 696c 656e 616d 652e 7370  odel.filename.sp
-00010b00: 6c69 7428 272f 2729 5b2d 315d 2e73 706c  lit('/')[-1].spl
-00010b10: 6974 2827 2e27 295b 305d 0a20 2020 2020  it('.')[0].     
-00010b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010b30: 2020 2070 6462 726f 6f74 203d 2073 656c     pdbroot = sel
-00010b40: 662e 776f 726b 6469 720a 2020 2020 2020  f.workdir.      
-00010b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010b60: 2020 6d6f 6465 6c20 3d20 277b 7d70 6462    model = '{}pdb
-00010b70: 7b7d 2e65 6e74 272e 666f 726d 6174 2870  {}.ent'.format(p
-00010b80: 6462 726f 6f74 2c20 7064 6269 6429 0a20  dbroot, pdbid). 
-00010b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010ba0: 2020 2020 2020 2023 2043 6861 6e67 6520         # Change 
-00010bb0: 7468 6520 7669 6577 2062 6163 6b0a 2020  the view back.  
-00010bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010bd0: 2020 2020 2020 6163 746f 722e 526f 7461        actor.Rota
-00010be0: 7465 5828 2d39 3029 0a20 2020 2020 2020  teX(-90).       
-00010bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010c00: 2061 6374 6f72 2e52 6f74 6174 655a 282d   actor.RotateZ(-
-00010c10: 3930 290a 2020 2020 2020 2020 2020 2020  90).            
-00010c20: 2020 2020 2020 2020 2020 2020 6163 746f              acto
-00010c30: 722e 526f 7461 7465 5928 2d39 3029 0a20  r.RotateY(-90). 
-00010c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010c50: 2020 2020 2020 2061 6374 6f72 2e52 6f74         actor.Rot
-00010c60: 6174 6558 282d 3930 290a 2020 2020 2020  ateX(-90).      
-00010c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010c80: 2020 7265 6e2e 5265 7365 7443 616d 6572    ren.ResetCamer
-00010c90: 6128 290a 0a20 2020 2020 2020 2020 2020  a()..           
-00010ca0: 2020 2020 2020 2020 2020 2020 2061 6374               act
-00010cb0: 6f72 2e47 6574 5072 6f70 6572 7479 2829  or.GetProperty()
-00010cc0: 2e53 6574 4f70 6163 6974 7928 302e 3529  .SetOpacity(0.5)
-00010cd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010ce0: 2020 2020 2020 2020 2070 6462 5f72 6561           pdb_rea
-00010cf0: 6465 7220 3d20 7674 6b2e 7674 6b50 4442  der = vtk.vtkPDB
-00010d00: 5265 6164 6572 2829 0a20 2020 2020 2020  Reader().       
-00010d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010d20: 206d 6f64 656c 5f6d 6170 7065 7220 3d20   model_mapper = 
-00010d30: 7674 6b2e 7674 6b50 6f6c 7944 6174 614d  vtk.vtkPolyDataM
-00010d40: 6170 7065 7228 290a 2020 2020 2020 2020  apper().        
-00010d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010d60: 6d6f 6465 6c5f 6163 746f 7220 3d20 7674  model_actor = vt
-00010d70: 6b2e 7674 6b41 6374 6f72 2829 0a20 2020  k.vtkActor().   
-00010d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010d90: 2020 2020 206d 6f64 656c 5f61 6374 6f72       model_actor
-00010da0: 2e47 6574 5072 6f70 6572 7479 2829 2e53  .GetProperty().S
-00010db0: 6574 4c69 6e65 5769 6474 6828 3629 0a20  etLineWidth(6). 
-00010dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010dd0: 2020 2020 2020 2070 6462 5f72 6561 6465         pdb_reade
-00010de0: 722e 5365 7446 696c 654e 616d 6528 6d6f  r.SetFileName(mo
-00010df0: 6465 6c29 0a0a 2020 2020 2020 2020 2020  del)..          
-00010e00: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
-00010e10: 6465 6c5f 6d61 7070 6572 2e53 6574 496e  del_mapper.SetIn
-00010e20: 7075 7443 6f6e 6e65 6374 696f 6e28 7064  putConnection(pd
-00010e30: 625f 7265 6164 6572 2e47 6574 4f75 7470  b_reader.GetOutp
-00010e40: 7574 506f 7274 2829 290a 2020 2020 2020  utPort()).      
-00010e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010e60: 2020 6d6f 6465 6c5f 6163 746f 722e 5365    model_actor.Se
-00010e70: 744d 6170 7065 7228 6d6f 6465 6c5f 6d61  tMapper(model_ma
-00010e80: 7070 6572 290a 2020 2020 2020 2020 2020  pper).          
-00010e90: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00010ea0: 6e2e 4164 6441 6374 6f72 286d 6f64 656c  n.AddActor(model
-00010eb0: 5f61 6374 6f72 290a 2020 2020 2020 2020  _actor).        
-00010ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010ed0: 7265 6e2e 5265 7365 7443 616d 6572 6128  ren.ResetCamera(
-00010ee0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00010ef0: 2020 2020 2020 2020 2020 7265 6e2e 4765            ren.Ge
-00010f00: 7441 6374 6976 6543 616d 6572 6128 292e  tActiveCamera().
-00010f10: 5a6f 6f6d 2831 2e35 3029 0a20 2020 2020  Zoom(1.50).     
-00010f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010f30: 2020 2072 656e 5769 6e2e 5265 6e64 6572     renWin.Render
-00010f40: 2829 0a0a 2020 2020 2020 2020 2020 2020  ()..            
-00010f50: 2020 2020 2020 2020 2020 2020 2320 4f75              # Ou
-00010f60: 7470 7574 206d 6f64 656c 2061 6e64 206d  tput model and m
-00010f70: 6170 7320 6f76 6572 6c61 7920 696d 6167  aps overlay imag
-00010f80: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
-00010f90: 2020 2020 2020 2020 2020 206f 7574 7a69             outzi
-00010fa0: 6d61 6765 203d 2027 7b7d 7b7d 5f65 6d64  mage = '{}{}_emd
-00010fb0: 5f7b 7d5f 7a73 7572 6661 6365 2e6a 7065  _{}_zsurface.jpe
-00010fc0: 6727 2e66 6f72 6d61 7428 7365 6c66 2e77  g'.format(self.w
-00010fd0: 6f72 6b64 6972 2c20 7064 6269 642c 2073  orkdir, pdbid, s
-00010fe0: 656c 662e 6d61 706e 616d 6529 0a20 2020  elf.mapname).   
-00010ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011000: 2020 2020 2073 656c 662e 7772 6974 655f       self.write_
-00011010: 696d 6167 6528 6f75 747a 696d 6167 652c  image(outzimage,
-00011020: 2072 656e 5769 6e29 0a0a 2020 2020 2020   renWin)..      
-00011030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011040: 2020 6163 746f 722e 526f 7461 7465 5828    actor.RotateX(
-00011050: 3930 290a 2020 2020 2020 2020 2020 2020  90).            
-00011060: 2020 2020 2020 2020 2020 2020 6163 746f              acto
-00011070: 722e 526f 7461 7465 5928 3930 290a 2020  r.RotateY(90).  
-00011080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011090: 2020 2020 2020 6d6f 6465 6c5f 6163 746f        model_acto
-000110a0: 722e 526f 7461 7465 5828 3930 290a 2020  r.RotateX(90).  
-000110b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000110c0: 2020 2020 2020 6d6f 6465 6c5f 6163 746f        model_acto
-000110d0: 722e 526f 7461 7465 5928 3930 290a 2020  r.RotateY(90).  
-000110e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000110f0: 2020 2020 2020 2320 7265 6e2e 5265 7365        # ren.Rese
-00011100: 7443 616d 6572 6128 290a 2020 2020 2020  tCamera().      
-00011110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011120: 2020 6f75 7479 696d 6167 6520 3d20 277b    outyimage = '{
-00011130: 7d7b 7d5f 656d 645f 7b7d 5f79 7375 7266  }{}_emd_{}_ysurf
-00011140: 6163 652e 6a70 6567 272e 666f 726d 6174  ace.jpeg'.format
-00011150: 2873 656c 662e 776f 726b 6469 722c 2070  (self.workdir, p
-00011160: 6462 6964 2c20 7365 6c66 2e6d 6170 6e61  dbid, self.mapna
-00011170: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
-00011180: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00011190: 2e77 7269 7465 5f69 6d61 6765 286f 7574  .write_image(out
-000111a0: 7969 6d61 6765 2c20 7265 6e57 696e 290a  yimage, renWin).
-000111b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000111c0: 2020 2020 2020 2020 2061 6374 6f72 2e52           actor.R
-000111d0: 6f74 6174 655a 2839 3029 0a20 2020 2020  otateZ(90).     
-000111e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000111f0: 2020 2061 6374 6f72 2e52 6f74 6174 6558     actor.RotateX
-00011200: 2839 3029 0a20 2020 2020 2020 2020 2020  (90).           
-00011210: 2020 2020 2020 2020 2020 2020 206d 6f64               mod
-00011220: 656c 5f61 6374 6f72 2e52 6f74 6174 655a  el_actor.RotateZ
-00011230: 2839 3029 0a20 2020 2020 2020 2020 2020  (90).           
-00011240: 2020 2020 2020 2020 2020 2020 206d 6f64               mod
-00011250: 656c 5f61 6374 6f72 2e52 6f74 6174 6558  el_actor.RotateX
-00011260: 2839 3029 0a20 2020 2020 2020 2020 2020  (90).           
-00011270: 2020 2020 2020 2020 2020 2020 2023 2072               # r
-00011280: 656e 2e52 6573 6574 4361 6d65 7261 2829  en.ResetCamera()
-00011290: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000112a0: 2020 2020 2020 2020 206f 7574 7869 6d61           outxima
-000112b0: 6765 203d 2027 7b7d 7b7d 5f65 6d64 5f7b  ge = '{}{}_emd_{
-000112c0: 7d5f 7873 7572 6661 6365 2e6a 7065 6727  }_xsurface.jpeg'
-000112d0: 2e66 6f72 6d61 7428 7365 6c66 2e77 6f72  .format(self.wor
-000112e0: 6b64 6972 2c20 7064 6269 642c 2073 656c  kdir, pdbid, sel
-000112f0: 662e 6d61 706e 616d 6529 0a20 2020 2020  f.mapname).     
-00011300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011310: 2020 2073 656c 662e 7772 6974 655f 696d     self.write_im
-00011320: 6167 6528 6f75 7478 696d 6167 652c 2072  age(outximage, r
-00011330: 656e 5769 6e29 0a20 2020 2020 2020 2020  enWin).         
-00011340: 2020 2020 2020 2070 7269 6e74 2827 5375         print('Su
-00011350: 7266 6163 6520 7669 6577 7320 7765 7265  rface views were
-00011360: 2067 656e 6572 6174 6564 2062 7920 5654   generated by VT
-00011370: 4b20 6d65 7468 6f64 2729 0a20 2020 2020  K method').     
-00011380: 2020 2020 2020 2065 6c69 6620 7365 6c66         elif self
-00011390: 2e63 6c20 6973 204e 6f6e 653a 0a20 2020  .cl is None:.   
-000113a0: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-000113b0: 6e74 2827 5769 7468 6f75 7420 636f 6e74  nt('Without cont
-000113c0: 6f75 7220 6c65 7665 6c20 6e6f 2073 7572  our level no sur
-000113d0: 6661 6365 2076 6965 7720 7769 6c6c 2062  face view will b
-000113e0: 6520 7072 6f64 7563 6564 2e27 290a 0a20  e produced.').. 
-000113f0: 2020 2020 2020 2073 656c 662e 7363 616c         self.scal
-00011400: 655f 7375 7266 6163 6576 6965 7728 290a  e_surfaceview().
-00011410: 0a20 2020 2020 2020 206f 7574 7a69 6d61  .        outzima
-00011420: 6765 203d 2027 7b7d 656d 645f 7b7d 5f7a  ge = '{}emd_{}_z
-00011430: 7375 7266 6163 652e 6a70 6567 272e 666f  surface.jpeg'.fo
-00011440: 726d 6174 2873 656c 662e 776f 726b 6469  rmat(self.workdi
-00011450: 722c 2073 656c 662e 656d 6469 6429 0a0a  r, self.emdid)..
-00011460: 2020 2020 2020 2020 7375 7266 6163 6576          surfacev
-00011470: 6965 776a 736f 6e20 3d20 6469 6374 2829  iewjson = dict()
-00011480: 0a20 2020 2020 2020 2069 6620 6f75 746d  .        if outm
-00011490: 6170 7869 6d61 6765 3a0a 2020 2020 2020  apximage:.      
-000114a0: 2020 2020 2020 6d61 7078 6c69 7374 203d        mapxlist =
-000114b0: 206f 7574 6d61 7078 696d 6167 652e 7370   outmapximage.sp
-000114c0: 6c69 7428 275f 2729 0a20 2020 2020 2020  lit('_').       
-000114d0: 2020 2020 206d 6170 7873 6361 6c65 696d       mapxscaleim
-000114e0: 6167 6520 3d20 275f 272e 6a6f 696e 286d  age = '_'.join(m
-000114f0: 6170 786c 6973 745b 3a2d 315d 2920 2b20  apxlist[:-1]) + 
-00011500: 275f 7363 616c 6564 5f27 202b 206d 6170  '_scaled_' + map
-00011510: 786c 6973 745b 2d31 5d0a 2020 2020 2020  xlist[-1].      
-00011520: 2020 2020 2020 7375 7266 6163 6576 6965        surfacevie
-00011530: 776a 736f 6e5b 2778 275d 203d 206f 732e  wjson['x'] = os.
-00011540: 7061 7468 2e62 6173 656e 616d 6528 6d61  path.basename(ma
-00011550: 7078 7363 616c 6569 6d61 6765 2920 6966  pxscaleimage) if
-00011560: 206f 732e 7061 7468 2e69 7366 696c 6528   os.path.isfile(
-00011570: 6d61 7078 7363 616c 6569 6d61 6765 2920  mapxscaleimage) 
-00011580: 656c 7365 204e 6f6e 650a 2020 2020 2020  else None.      
-00011590: 2020 6966 206f 7574 6d61 7079 696d 6167    if outmapyimag
-000115a0: 653a 0a20 2020 2020 2020 2020 2020 206d  e:.            m
-000115b0: 6170 796c 6973 7420 3d20 6f75 746d 6170  apylist = outmap
-000115c0: 7969 6d61 6765 2e73 706c 6974 2827 5f27  yimage.split('_'
-000115d0: 290a 2020 2020 2020 2020 2020 2020 6d61  ).            ma
-000115e0: 7079 7363 616c 6569 6d61 6765 203d 2027  pyscaleimage = '
-000115f0: 5f27 2e6a 6f69 6e28 6d61 7079 6c69 7374  _'.join(mapylist
-00011600: 5b3a 2d31 5d29 202b 2027 5f73 6361 6c65  [:-1]) + '_scale
-00011610: 645f 2720 2b20 6d61 7079 6c69 7374 5b2d  d_' + mapylist[-
-00011620: 315d 0a20 2020 2020 2020 2020 2020 2073  1].            s
-00011630: 7572 6661 6365 7669 6577 6a73 6f6e 5b27  urfaceviewjson['
-00011640: 7927 5d20 3d20 6f73 2e70 6174 682e 6261  y'] = os.path.ba
-00011650: 7365 6e61 6d65 286d 6170 7973 6361 6c65  sename(mapyscale
-00011660: 696d 6167 6529 2069 6620 6f73 2e70 6174  image) if os.pat
-00011670: 682e 6973 6669 6c65 286d 6170 7973 6361  h.isfile(mapysca
-00011680: 6c65 696d 6167 6529 2065 6c73 6520 4e6f  leimage) else No
-00011690: 6e65 0a20 2020 2020 2020 2069 6620 6f75  ne.        if ou
-000116a0: 746d 6170 7a69 6d61 6765 3a0a 2020 2020  tmapzimage:.    
-000116b0: 2020 2020 2020 2020 6d61 707a 6c69 7374          mapzlist
-000116c0: 203d 206f 7574 6d61 707a 696d 6167 652e   = outmapzimage.
-000116d0: 7370 6c69 7428 275f 2729 0a20 2020 2020  split('_').     
-000116e0: 2020 2020 2020 206d 6170 7a73 6361 6c65         mapzscale
-000116f0: 696d 6167 6520 3d20 275f 272e 6a6f 696e  image = '_'.join
-00011700: 286d 6170 7a6c 6973 745b 3a2d 315d 2920  (mapzlist[:-1]) 
-00011710: 2b20 275f 7363 616c 6564 5f27 202b 206d  + '_scaled_' + m
-00011720: 6170 7a6c 6973 745b 2d31 5d0a 2020 2020  apzlist[-1].    
-00011730: 2020 2020 2020 2020 7375 7266 6163 6576          surfacev
-00011740: 6965 776a 736f 6e5b 277a 275d 203d 206f  iewjson['z'] = o
-00011750: 732e 7061 7468 2e62 6173 656e 616d 6528  s.path.basename(
-00011760: 6d61 707a 7363 616c 6569 6d61 6765 2920  mapzscaleimage) 
-00011770: 6966 206f 732e 7061 7468 2e69 7366 696c  if os.path.isfil
-00011780: 6528 6d61 707a 7363 616c 6569 6d61 6765  e(mapzscaleimage
-00011790: 2920 656c 7365 204e 6f6e 650a 2020 2020  ) else None.    
-000117a0: 2020 2020 6669 6e61 6c64 6963 7420 3d20      finaldict = 
-000117b0: 7b27 6d61 705f 7375 7266 6163 6527 3a20  {'map_surface': 
-000117c0: 7375 7266 6163 6576 6965 776a 736f 6e7d  surfaceviewjson}
-000117d0: 0a0a 2020 2020 2020 2020 7769 7468 2063  ..        with c
-000117e0: 6f64 6563 732e 6f70 656e 2873 656c 662e  odecs.open(self.
-000117f0: 776f 726b 6469 7220 2b20 7365 6c66 2e6d  workdir + self.m
-00011800: 6170 6e61 6d65 202b 2027 5f6d 6170 7375  apname + '_mapsu
-00011810: 7266 6163 6576 6965 772e 6a73 6f6e 272c  rfaceview.json',
-00011820: 2027 7727 2c0a 2020 2020 2020 2020 2020   'w',.          
-00011830: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00011840: 6e63 6f64 696e 673d 2775 7466 2d38 2729  ncoding='utf-8')
-00011850: 2061 7320 663a 0a20 2020 2020 2020 2020   as f:.         
-00011860: 2020 206a 736f 6e2e 6475 6d70 2866 696e     json.dump(fin
-00011870: 616c 6469 6374 2c20 6629 0a0a 2020 2020  aldict, f)..    
-00011880: 2020 2020 6a70 6567 7320 3d20 676c 6f62      jpegs = glob
-00011890: 2e67 6c6f 6228 7365 6c66 2e77 6f72 6b64  .glob(self.workd
-000118a0: 6972 202b 2027 2f2a 7375 7266 6163 652e  ir + '/*surface.
-000118b0: 6a70 6567 2729 0a20 2020 2020 2020 206d  jpeg').        m
-000118c0: 6f64 656c 7375 7266 203d 2064 6963 7428  odelsurf = dict(
-000118d0: 290a 2020 2020 2020 2020 6669 6e61 6c6d  ).        finalm
-000118e0: 6d64 6963 7420 3d20 6469 6374 2829 0a20  mdict = dict(). 
-000118f0: 2020 2020 2020 2069 6620 7365 6c66 2e6d         if self.m
-00011900: 6f64 656c 733a 0a20 2020 2020 2020 2020  odels:.         
-00011910: 2020 2023 2070 7269 6e74 2022 7365 6c66     # print "self
-00011920: 2e6d 6f64 656c 733a 2573 2220 2520 7365  .models:%s" % se
-00011930: 6c66 2e6d 6f64 656c 730a 2020 2020 2020  lf.models.      
-00011940: 2020 2020 2020 666f 7220 6d6f 6465 6c20        for model 
-00011950: 696e 2073 656c 662e 6d6f 6465 6c73 3a0a  in self.models:.
-00011960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011970: 6d6f 6465 6c6e 616d 6520 3d20 6d6f 6465  modelname = mode
-00011980: 6c2e 6669 6c65 6e61 6d65 2e73 706c 6974  l.filename.split
-00011990: 2827 2f27 295b 2d31 5d2e 7370 6c69 7428  ('/')[-1].split(
-000119a0: 272e 2729 5b30 5d0a 2020 2020 2020 2020  '.')[0].        
-000119b0: 2020 2020 2020 2020 6d6f 6465 6c6d 6170          modelmap
-000119c0: 7375 7266 6163 6520 3d20 6469 6374 2829  surface = dict()
-000119d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000119e0: 2066 6f72 206a 7065 6720 696e 206a 7065   for jpeg in jpe
-000119f0: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
-00011a00: 2020 2020 2020 2020 6966 206d 6f64 656c          if model
-00011a10: 6e61 6d65 2069 6e20 6a70 6567 2061 6e64  name in jpeg and
-00011a20: 2027 7873 7572 6661 6365 2720 696e 206a   'xsurface' in j
-00011a30: 7065 673a 0a20 2020 2020 2020 2020 2020  peg:.           
-00011a40: 2020 2020 2020 2020 2020 2020 206d 6f64               mod
-00011a50: 656c 6d61 7073 7572 6661 6365 5b27 7827  elmapsurface['x'
-00011a60: 5d20 3d20 6d6f 6465 6c6e 616d 6520 2b20  ] = modelname + 
-00011a70: 275f 656d 645f 2720 2b20 7365 6c66 2e6d  '_emd_' + self.m
-00011a80: 6170 6e61 6d65 202b 2027 5f73 6361 6c65  apname + '_scale
-00011a90: 645f 7873 7572 6661 6365 2e6a 7065 6727  d_xsurface.jpeg'
-00011aa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011ab0: 2020 2020 2069 6620 6d6f 6465 6c6e 616d       if modelnam
-00011ac0: 6520 696e 206a 7065 6720 616e 6420 2779  e in jpeg and 'y
-00011ad0: 7375 7266 6163 6527 2069 6e20 6a70 6567  surface' in jpeg
-00011ae0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00011af0: 2020 2020 2020 2020 2020 6d6f 6465 6c6d            modelm
-00011b00: 6170 7375 7266 6163 655b 2779 275d 203d  apsurface['y'] =
-00011b10: 206d 6f64 656c 6e61 6d65 202b 2027 5f65   modelname + '_e
-00011b20: 6d64 5f27 202b 2073 656c 662e 6d61 706e  md_' + self.mapn
-00011b30: 616d 6520 2b20 275f 7363 616c 6564 5f79  ame + '_scaled_y
-00011b40: 7375 7266 6163 652e 6a70 6567 270a 2020  surface.jpeg'.  
-00011b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011b60: 2020 6966 206d 6f64 656c 6e61 6d65 2069    if modelname i
-00011b70: 6e20 6a70 6567 2061 6e64 2027 7a73 7572  n jpeg and 'zsur
-00011b80: 6661 6365 2720 696e 206a 7065 673a 0a20  face' in jpeg:. 
-00011b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011ba0: 2020 2020 2020 206d 6f64 656c 6d61 7073         modelmaps
-00011bb0: 7572 6661 6365 5b27 7a27 5d20 3d20 6d6f  urface['z'] = mo
-00011bc0: 6465 6c6e 616d 6520 2b20 275f 656d 645f  delname + '_emd_
-00011bd0: 2720 2b20 7365 6c66 2e6d 6170 6e61 6d65  ' + self.mapname
-00011be0: 202b 2027 5f73 6361 6c65 645f 7a73 7572   + '_scaled_zsur
-00011bf0: 6661 6365 2e6a 7065 6727 0a20 2020 2020  face.jpeg'.     
-00011c00: 2020 2020 2020 2020 2020 206d 6f64 656c             model
-00011c10: 7375 7266 5b6d 6f64 656c 6e61 6d65 5d20  surf[modelname] 
-00011c20: 3d20 6d6f 6465 6c6d 6170 7375 7266 6163  = modelmapsurfac
-00011c30: 650a 2020 2020 2020 2020 2020 2020 6669  e.            fi
-00011c40: 6e61 6c6d 6d64 6963 745b 276d 6170 6d6f  nalmmdict['mapmo
-00011c50: 6465 6c5f 7375 7266 6163 6527 5d20 3d20  del_surface'] = 
-00011c60: 6d6f 6465 6c73 7572 660a 0a20 2020 2020  modelsurf..     
-00011c70: 2020 2020 2020 2077 6974 6820 636f 6465         with code
-00011c80: 6373 2e6f 7065 6e28 7365 6c66 2e77 6f72  cs.open(self.wor
-00011c90: 6b64 6972 202b 2073 656c 662e 6d61 706e  kdir + self.mapn
-00011ca0: 616d 6520 2b20 275f 6d61 706d 6f64 656c  ame + '_mapmodel
-00011cb0: 7375 7266 6163 6576 6965 772e 6a73 6f6e  surfaceview.json
-00011cc0: 272c 2027 7727 2c0a 2020 2020 2020 2020  ', 'w',.        
-00011cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011ce0: 2020 2020 2065 6e63 6f64 696e 673d 2775       encoding='u
-00011cf0: 7466 2d38 2729 2061 7320 663a 0a20 2020  tf-8') as f:.   
-00011d00: 2020 2020 2020 2020 2020 2020 206a 736f               jso
-00011d10: 6e2e 6475 6d70 2866 696e 616c 6d6d 6469  n.dump(finalmmdi
-00011d20: 6374 2c20 6629 0a0a 0a20 2020 2020 2020  ct, f)...       
-00011d30: 2065 6e64 203d 2074 696d 6569 742e 6465   end = timeit.de
-00011d40: 6661 756c 745f 7469 6d65 7228 290a 2020  fault_timer().  
-00011d50: 2020 2020 2020 7072 696e 7428 2753 7572        print('Sur
-00011d60: 6661 6365 7669 6577 2074 696d 653a 207b  faceview time: {
-00011d70: 7d27 2e66 6f72 6d61 7428 656e 642d 7374  }'.format(end-st
-00011d80: 6172 7429 290a 2020 2020 2020 2020 7072  art)).        pr
-00011d90: 696e 7428 272d 2d2d 2d2d 2d2d 2d2d 2d2d  int('-----------
-00011da0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00011db0: 2d2d 2d2d 2d2d 2d2d 2d27 290a 0a20 2020  ---------')..   
-00011dc0: 2020 2020 2072 6574 7572 6e20 4e6f 6e65       return None
-00011dd0: 0a0a 2020 2020 2320 466f 7220 6d61 736b  ..    # For mask
-00011de0: 2076 6965 7773 2061 6e64 2063 656e 7472   views and centr
-00011df0: 616c 2073 6c69 6365 206f 6620 6d61 736b  al slice of mask
-00011e00: 730a 2020 2020 2320 4070 726f 6669 6c65  s.    # @profile
-00011e10: 0a20 2020 2064 6566 206d 6173 6b73 2873  .    def masks(s
-00011e20: 656c 6629 3a0a 2020 2020 2020 2020 2222  elf):.        ""
-00011e30: 220a 0a0a 2020 2020 2020 2020 3a72 6574  "...        :ret
-00011e40: 7572 6e3a 0a20 2020 2020 2020 2022 2222  urn:.        """
-00011e50: 0a0a 2020 2020 2020 2020 7674 6b70 6163  ..        vtkpac
-00011e60: 6b2c 2063 6869 6d65 7261 6170 7020 3d20  k, chimeraapp = 
-00011e70: 7365 6c66 2e73 7572 6661 6365 5f65 6e76  self.surface_env
-00011e80: 6368 6563 6b28 290a 2020 2020 2020 2020  check().        
-00011e90: 6966 2073 656c 662e 616c 6c6d 6173 6b73  if self.allmasks
-00011ea0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-00011eb0: 5768 656e 206d 6173 6b73 2064 6174 6128  When masks data(
-00011ec0: 6e6f 7420 7365 676d 656e 7461 7469 6f6e  not segmentation
-00011ed0: 2920 6172 6520 7265 6164 792c 2073 7769  ) are ready, swi
-00011ee0: 7463 6820 7468 6973 206f 6e20 746f 2070  tch this on to p
-00011ef0: 726f 6475 6365 2070 726f 7065 7220 6365  roduce proper ce
-00011f00: 6e74 7261 6c20 736c 6963 6520 6f66 206d  ntral slice of m
-00011f10: 6173 6b73 0a20 2020 2020 2020 2020 2020  asks.           
-00011f20: 2073 656c 662e 6365 6e74 7261 6c4d 6173   self.centralMas
-00011f30: 6b73 2829 0a20 2020 2020 2020 2020 2020  ks().           
-00011f40: 2069 6620 6368 696d 6572 6161 7070 3a0a   if chimeraapp:.
-00011f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011f60: 7365 6c66 2e6d 6173 6b76 6965 7763 6869  self.maskviewchi
-00011f70: 6d65 7261 2863 6869 6d65 7261 6170 7029  mera(chimeraapp)
-00011f80: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
-00011f90: 6620 7674 6b70 6163 6b3a 0a20 2020 2020  f vtkpack:.     
-00011fa0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00011fb0: 6d61 736b 7669 6577 7328 290a 2020 2020  maskviews().    
-00011fc0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00011fd0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00011fe0: 7072 696e 7428 274e 6f20 7072 6f70 6572  print('No proper
-00011ff0: 2056 544b 206f 7220 4368 696d 6572 6120   VTK or Chimera 
-00012000: 6361 6e20 6265 2075 7365 6420 666f 7220  can be used for 
-00012010: 7072 6f64 7563 696e 6720 6d61 736b 2076  producing mask v
-00012020: 6965 772e 2050 6c65 6173 6520 6368 6563  iew. Please chec
-00012030: 6b2e 272c 2066 696c 653d 7379 732e 7374  k.', file=sys.st
-00012040: 6465 7272 290a 2020 2020 2020 2020 2020  derr).          
-00012050: 2020 2020 2020 7379 732e 7374 6465 7272        sys.stderr
-00012060: 2e77 7269 7465 2827 4e6f 2070 726f 7065  .write('No prope
-00012070: 7220 5654 4b20 6f72 2043 6869 6d65 7261  r VTK or Chimera
-00012080: 5820 6361 6e20 6265 2075 7365 6420 666f  X can be used fo
-00012090: 7220 7072 6f64 7563 696e 6720 6d61 736b  r producing mask
-000120a0: 2076 6965 772e 2050 6c65 6173 6520 6368   view. Please ch
-000120b0: 6563 6b2e 5c6e 2729 0a20 2020 2020 2020  eck.\n').       
-000120c0: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
-000120d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000120e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000120f0: 2d2d 2d2d 2729 0a20 2020 2020 2020 2065  ----').        e
-00012100: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00012110: 2070 7269 6e74 2827 4e6f 206d 6173 6b73   print('No masks
-00012120: 2066 6f72 2074 6869 7320 656e 7472 7921   for this entry!
-00012130: 2729 0a20 2020 2020 2020 2020 2020 2070  ').            p
-00012140: 7269 6e74 2827 2d2d 2d2d 2d2d 2d2d 2d2d  rint('----------
-00012150: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00012160: 2d2d 2d2d 2d2d 2d2d 2d2d 2729 0a0a 2020  ----------')..  
-00012170: 2020 6465 6620 6d61 736b 7376 7470 2873    def masksvtp(s
-00012180: 656c 662c 206d 6173 6b72 6573 756c 7429  elf, maskresult)
-00012190: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-000121a0: 2020 2020 2020 2020 2050 726f 6475 6365           Produce
-000121b0: 2076 7470 2066 696c 6573 2066 6f72 2074   vtp files for t
-000121c0: 686f 7365 2077 6869 6368 2064 6f65 7320  hose which does 
-000121d0: 6e6f 7420 6861 7665 2061 2076 7470 2066  not have a vtp f
-000121e0: 696c 6520 6265 666f 7265 0a20 2020 2020  ile before.     
-000121f0: 2020 2020 2020 746f 646f 3a20 6e65 6564        todo: need
-00012200: 2074 6f20 6265 2063 6861 6e67 6564 2077   to be changed w
-00012210: 6865 6e20 6d61 736b 7265 7375 6c74 2072  hen maskresult r
-00012220: 6574 7572 6e65 6420 6973 2061 2064 6963  eturned is a dic
-00012230: 7469 6f6e 6172 790a 0a20 2020 2020 2020  tionary..       
-00012240: 203a 7061 7261 6d20 6d61 736b 733a 0a20   :param masks:. 
-00012250: 2020 2020 2020 203a 7265 7475 726e 3a0a         :return:.
-00012260: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00012270: 2020 2020 6d61 736b 7320 3d20 5b5d 0a0a      masks = []..
-00012280: 2020 2020 2020 2020 6d65 7368 6d61 6b65          meshmake
-00012290: 7220 3d20 4661 6c73 650a 2020 2020 2020  r = False.      
-000122a0: 2020 6966 204d 4553 484d 414b 4552 5041    if MESHMAKERPA
-000122b0: 5448 2069 7320 6e6f 7420 4e6f 6e65 3a0a  TH is not None:.
-000122c0: 2020 2020 2020 2020 2020 2020 6d65 7368              mesh
-000122d0: 6d61 6b65 7220 3d20 5472 7565 0a20 2020  maker = True.   
-000122e0: 2020 2020 2020 2020 206d 6573 686d 616b           meshmak
-000122f0: 6572 7061 7468 203d 204d 4553 484d 414b  erpath = MESHMAK
-00012300: 4552 5041 5448 0a20 2020 2020 2020 2065  ERPATH.        e
-00012310: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00012320: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-00012330: 2020 2020 2020 6173 7365 7274 2066 696e        assert fin
-00012340: 645f 6578 6563 7574 6162 6c65 2827 6d65  d_executable('me
-00012350: 7368 6d61 6b65 7227 2920 6973 206e 6f74  shmaker') is not
-00012360: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
-00012370: 2020 2020 2020 6d65 7368 6d61 6b65 7270        meshmakerp
-00012380: 6174 6820 3d20 6669 6e64 5f65 7865 6375  ath = find_execu
-00012390: 7461 626c 6528 276d 6573 686d 616b 6572  table('meshmaker
-000123a0: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
-000123b0: 2020 206d 6573 686d 616b 6572 203d 2054     meshmaker = T
-000123c0: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
-000123d0: 6578 6365 7074 2041 7373 6572 7469 6f6e  except Assertion
-000123e0: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
-000123f0: 2020 2020 2020 2023 2070 7269 6e74 2827         # print('
-00012400: 6d65 7368 6d61 6b65 7220 6578 6563 7574  meshmaker execut
-00012410: 6162 6c65 2069 7320 6e6f 7420 7468 6572  able is not ther
-00012420: 652e 272c 2066 696c 653d 7379 732e 7374  e.', file=sys.st
-00012430: 6465 7272 290a 2020 2020 2020 2020 2020  derr).          
-00012440: 2020 2020 2020 7379 732e 7374 6465 7272        sys.stderr
-00012450: 2e77 7269 7465 2827 6d65 7368 6d61 6b65  .write('meshmake
-00012460: 7220 6578 6563 7574 6162 6c65 2069 7320  r executable is 
-00012470: 6e6f 7420 7468 6572 652e 5c6e 2729 0a20  not there.\n'). 
-00012480: 2020 2020 2020 2020 2020 2073 7973 2e73             sys.s
-00012490: 7464 6572 722e 7772 6974 6528 274e 6f20  tderr.write('No 
-000124a0: 7072 6f70 6572 2056 544b 206f 7220 4368  proper VTK or Ch
-000124b0: 696d 6572 6158 2063 616e 2062 6520 7573  imeraX can be us
-000124c0: 6564 2066 6f72 2070 726f 6475 6369 6e67  ed for producing
-000124d0: 206d 6173 6b20 7669 6577 2e20 506c 6561   mask view. Plea
-000124e0: 7365 2063 6865 636b 2e5c 6e27 290a 0a20  se check.\n').. 
-000124f0: 2020 2020 2020 2069 6620 6e6f 7420 6d61         if not ma
-00012500: 736b 7265 7375 6c74 3a0a 2020 2020 2020  skresult:.      
-00012510: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
-00012520: 650a 2020 2020 2020 2020 656c 7365 3a0a  e.        else:.
-00012530: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00012540: 6d61 736b 2069 6e20 6d61 736b 7265 7375  mask in maskresu
-00012550: 6c74 3a0a 2020 2020 2020 2020 2020 2020  lt:.            
-00012560: 2020 2020 2320 6966 206d 6173 6b2e 656e      # if mask.en
-00012570: 6473 7769 7468 2827 2e6d 6170 2729 3a0a  dswith('.map'):.
-00012580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012590: 6966 206d 6173 6b3a 0a20 2020 2020 2020  if mask:.       
-000125a0: 2020 2020 2020 2020 2020 2020 2023 206d               # m
-000125b0: 6173 6b6e 616d 6520 3d20 6d61 736b 5b3a  askname = mask[:
-000125c0: 2d34 5d0a 2020 2020 2020 2020 2020 2020  -4].            
-000125d0: 2020 2020 2020 2020 2320 6d61 736b 7674          # maskvt
-000125e0: 7020 3d20 6d61 736b 6e61 6d65 202b 2027  p = maskname + '
-000125f0: 2e76 7470 270a 2020 2020 2020 2020 2020  .vtp'.          
-00012600: 2020 2020 2020 2020 2020 6d61 736b 7674            maskvt
-00012610: 7020 3d20 6d61 736b 202b 2027 2e76 7470  p = mask + '.vtp
-00012620: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00012630: 2020 6966 206f 732e 7061 7468 2e69 7366    if os.path.isf
-00012640: 696c 6528 6d61 736b 7674 7029 3a0a 2020  ile(maskvtp):.  
-00012650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012660: 2020 6d61 736b 732e 6170 7065 6e64 286d    masks.append(m
-00012670: 6173 6b76 7470 290a 2020 2020 2020 2020  askvtp).        
-00012680: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-00012690: 7428 2756 7470 2066 696c 6520 666f 7220  t('Vtp file for 
-000126a0: 6d61 736b 3a20 2573 2065 7869 7374 2e27  mask: %s exist.'
-000126b0: 2025 206d 6173 6b76 7470 290a 2020 2020   % maskvtp).    
-000126c0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-000126d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000126e0: 2020 2020 2020 6d61 736b 732e 6170 7065        masks.appe
-000126f0: 6e64 286d 6173 6b76 7470 290a 2020 2020  nd(maskvtp).    
-00012700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012710: 2320 546f 646f 3a43 6f6e 746f 7572 206c  # Todo:Contour l
-00012720: 6576 656c 2066 6f72 206d 6173 6b73 2075  evel for masks u
-00012730: 7365 2031 2e30 2066 6f72 206e 6f77 2061  se 1.0 for now a
-00012740: 6e64 2077 696c 6c20 6265 206c 6f61 6465  nd will be loade
-00012750: 6420 6672 6f6d 206d 6d63 6966 2066 696c  d from mmcif fil
-00012760: 6520 6c61 7465 720a 2020 2020 2020 2020  e later.        
-00012770: 2020 2020 2020 2020 2020 2020 636d 6420              cmd 
-00012780: 3d20 6d65 7368 6d61 6b65 7270 6174 6820  = meshmakerpath 
-00012790: 2b20 2720 2720 2b20 6d61 736b 202b 2027  + ' ' + mask + '
-000127a0: 202d 6320 2720 2b20 2731 2e30 2720 2b20   -c ' + '1.0' + 
-000127b0: 2720 2d6f 2027 202b 206d 6173 6b6e 616d  ' -o ' + masknam
-000127c0: 6520 2b20 2720 2d44 202d 7627 0a20 2020  e + ' -D -v'.   
-000127d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000127e0: 2070 7269 6e74 2863 6d64 290a 2020 2020   print(cmd).    
-000127f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012800: 2320 6966 2073 656c 662e 656d 6469 643a  # if self.emdid:
-00012810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012820: 2020 2020 2023 2020 2020 2063 6d64 203d       #     cmd =
-00012830: 2027 736f 7572 6365 2027 202b 2043 4f4e   'source ' + CON
-00012840: 4441 5041 5448 202b 2027 3b73 6f75 7263  DAPATH + ';sourc
-00012850: 6520 6163 7469 7661 7465 206d 6573 686d  e activate meshm
-00012860: 616b 6572 3b20 6d65 7368 6d61 6b65 7220  aker; meshmaker 
-00012870: 2720 2b20 6d61 736b 202b 2027 202d 6320  ' + mask + ' -c 
-00012880: 2720 5c0a 2020 2020 2020 2020 2020 2020  ' \.            
-00012890: 2020 2020 2020 2020 2320 2020 2020 2020          #       
-000128a0: 2020 2020 2b20 2731 2e30 2720 2b20 2720      + '1.0' + ' 
-000128b0: 2d6f 2027 202b 206d 6173 6b6e 616d 6520  -o ' + maskname 
-000128c0: 2b20 2720 2d44 202d 7627 0a20 2020 2020  + ' -D -v'.     
-000128d0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000128e0: 2020 2020 2070 7269 6e74 2063 6d64 0a20       print cmd. 
-000128f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012900: 2020 2023 2065 6c73 653a 0a20 2020 2020     # else:.     
-00012910: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00012920: 2020 2020 2063 6d64 203d 2027 736f 7572       cmd = 'sour
-00012930: 6365 2061 6374 6976 6174 6520 6d65 7368  ce activate mesh
-00012940: 6d61 6b65 723b 206d 6573 686d 616b 6572  maker; meshmaker
-00012950: 2027 202b 206d 6173 6b20 2b20 2720 2d63   ' + mask + ' -c
-00012960: 2027 205c 0a20 2020 2020 2020 2020 2020   ' \.           
-00012970: 2020 2020 2020 2020 2023 2020 2020 2020           #      
-00012980: 2020 2020 202b 2027 312e 3027 202b 2027       + '1.0' + '
-00012990: 2d6f 2027 202b 206d 6173 6b6e 616d 6520  -o ' + maskname 
-000129a0: 2b20 2720 2d44 202d 7627 0a20 2020 2020  + ' -D -v'.     
-000129b0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000129c0: 7072 6f63 6573 7320 3d20 7375 6270 726f  process = subpro
-000129d0: 6365 7373 2e50 6f70 656e 2863 6d64 2c20  cess.Popen(cmd, 
-000129e0: 7374 646f 7574 3d73 7562 7072 6f63 6573  stdout=subproces
-000129f0: 732e 5049 5045 2c20 7374 6465 7272 3d73  s.PIPE, stderr=s
-00012a00: 7562 7072 6f63 6573 732e 5049 5045 290a  ubprocess.PIPE).
-00012a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012a20: 2020 2020 7072 6f63 6573 7320 3d20 7375      process = su
-00012a30: 6270 726f 6365 7373 2e50 6f70 656e 2863  bprocess.Popen(c
-00012a40: 6d64 2c20 7368 656c 6c3d 5472 7565 2c20  md, shell=True, 
-00012a50: 6578 6563 7574 6162 6c65 3d27 2f62 696e  executable='/bin
-00012a60: 2f62 6173 6827 2c20 6377 643d 7365 6c66  /bash', cwd=self
-00012a70: 2e77 6f72 6b64 6972 290a 2020 2020 2020  .workdir).      
-00012a80: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00012a90: 636f 6465 203d 2070 726f 6365 7373 2e77  code = process.w
-00012aa0: 6169 7428 290a 2020 2020 2020 2020 2020  ait().          
-00012ab0: 2020 2020 2020 2020 2020 636f 6465 2c20            code, 
-00012ac0: 6572 726f 7220 3d20 7072 6f63 6573 732e  error = process.
-00012ad0: 636f 6d6d 756e 6963 6174 6528 290a 2020  communicate().  
-00012ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012af0: 2020 6966 2072 6563 6f64 6520 3d3d 2030    if recode == 0
-00012b00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00012b10: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-00012b20: 2750 726f 6475 6365 2066 696c 653a 2025  'Produce file: %
-00012b30: 7320 7375 6363 6573 7366 756c 6c79 2720  s successfully' 
-00012b40: 2520 6d61 736b 7674 7029 0a20 2020 2020  % maskvtp).     
-00012b50: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00012b60: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00012b70: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-00012b80: 6e74 2863 6f64 652c 2065 7272 6f72 290a  nt(code, error).
-00012b90: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00012ba0: 726e 206d 6173 6b73 0a0a 2020 2020 6465  rn masks..    de
-00012bb0: 6620 6d61 736b 7669 6577 7328 7365 6c66  f maskviews(self
-00012bc0: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
-00012bd0: 2020 2020 2020 2020 2020 2047 656e 6572             Gener
-00012be0: 6174 6520 6d61 736b 2076 6965 7773 2062  ate mask views b
-00012bf0: 7920 7573 696e 6720 7674 6b20 6d65 7468  y using vtk meth
-00012c00: 6f64 0a0a 2020 2020 2020 2020 3a72 6574  od..        :ret
-00012c10: 7572 6e3a 0a20 2020 2020 2020 2022 2222  urn:.        """
-00012c20: 0a0a 2020 2020 2020 2020 6d61 736b 7265  ..        maskre
-00012c30: 7375 6c74 203d 205b 6974 656d 2066 6f72  sult = [item for
-00012c40: 2069 7465 6d20 696e 2073 656c 662e 616c   item in self.al
-00012c50: 6c6d 6173 6b73 2069 6620 6f73 2e70 6174  lmasks if os.pat
-00012c60: 682e 6973 6669 6c65 2869 7465 6d29 5d0a  h.isfile(item)].
-00012c70: 2020 2020 2020 2020 6d61 736b 7364 6963          masksdic
-00012c80: 7420 3d20 6469 6374 2829 0a20 2020 2020  t = dict().     
-00012c90: 2020 2069 6620 6e6f 7420 6d61 736b 7265     if not maskre
-00012ca0: 7375 6c74 3a0a 2020 2020 2020 2020 2020  sult:.          
-00012cb0: 2020 7072 696e 7428 2754 6865 7265 2069    print('There i
-00012cc0: 7320 6e6f 206d 6173 6b73 206f 6666 6572  s no masks offer
-00012cd0: 6564 2066 6f72 2074 6869 7320 6d61 702e  ed for this map.
-00012ce0: 2729 0a20 2020 2020 2020 2020 2020 2070  ').            p
-00012cf0: 7269 6e74 2827 2d2d 2d2d 2d2d 2d2d 2d2d  rint('----------
-00012d00: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00012d10: 2d2d 2d2d 2d2d 2d2d 2d2d 2729 0a20 2020  ----------').   
-00012d20: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00012d30: 2020 2020 2020 206d 6173 6b73 203d 2073         masks = s
-00012d40: 656c 662e 6d61 736b 7376 7470 286d 6173  elf.masksvtp(mas
-00012d50: 6b72 6573 756c 7429 0a20 2020 2020 2020  kresult).       
-00012d60: 2020 2020 2069 6620 6d61 736b 733a 0a20       if masks:. 
-00012d70: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00012d80: 6f6f 7420 3d20 6f73 2e70 6174 682e 6469  oot = os.path.di
-00012d90: 726e 616d 6528 6d61 736b 735b 305d 290a  rname(masks[0]).
-00012da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012db0: 6d61 7076 7470 203d 2027 7b7d 2f7b 7d5f  mapvtp = '{}/{}_
-00012dc0: 7b7d 2e76 7470 272e 666f 726d 6174 2873  {}.vtp'.format(s
-00012dd0: 656c 662e 776f 726b 6469 722c 2073 656c  elf.workdir, sel
-00012de0: 662e 6d61 706e 616d 652c 2073 7472 2873  f.mapname, str(s
-00012df0: 656c 662e 636c 2929 0a20 2020 2020 2020  elf.cl)).       
-00012e00: 2020 2020 2066 6f72 206d 6173 6b20 696e       for mask in
-00012e10: 206d 6173 6b73 3a0a 2020 2020 2020 2020   masks:.        
-00012e20: 2020 2020 2020 2020 6d61 736b 7364 6963          masksdic
-00012e30: 745b 6d61 736b 5d20 3d20 7365 6c66 2e6d  t[mask] = self.m
-00012e40: 6173 6b76 6965 7773 5f76 746b 286d 6170  askviews_vtk(map
-00012e50: 7674 702c 206d 6173 6b29 0a20 2020 2020  vtp, mask).     
-00012e60: 2020 2020 2020 2077 6974 6820 636f 6465         with code
-00012e70: 6373 2e6f 7065 6e28 7365 6c66 2e77 6f72  cs.open(self.wor
-00012e80: 6b64 6972 202b 2073 656c 662e 6d61 706e  kdir + self.mapn
-00012e90: 616d 6520 2b20 275f 6d61 706d 6173 6b76  ame + '_mapmaskv
-00012ea0: 6965 772e 6a73 6f6e 272c 2027 7727 2c0a  iew.json', 'w',.
-00012eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012ec0: 2020 2020 2020 2020 2020 2020 2065 6e63               enc
-00012ed0: 6f64 696e 673d 2775 7466 2d38 2729 2061  oding='utf-8') a
-00012ee0: 7320 663a 0a20 2020 2020 2020 2020 2020  s f:.           
-00012ef0: 2020 2020 206a 736f 6e2e 6475 6d70 286d       json.dump(m
-00012f00: 6173 6b73 6469 6374 2c20 6629 0a0a 2020  asksdict, f)..  
-00012f10: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-00012f20: 274d 6173 6b73 2076 6965 7720 6279 2075  'Masks view by u
-00012f30: 7369 6e67 2056 544b 206d 6574 686f 642e  sing VTK method.
-00012f40: 2729 0a20 2020 2020 2020 2072 6574 7572  ').        retur
-00012f50: 6e20 4e6f 6e65 0a0a 2020 2020 6465 6620  n None..    def 
-00012f60: 6d61 736b 7669 6577 6368 696d 6572 6128  maskviewchimera(
-00012f70: 7365 6c66 2c20 6368 696d 6572 6161 7070  self, chimeraapp
-00012f80: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
-00012f90: 2020 2020 2020 2020 2020 2047 656e 6572             Gener
-00012fa0: 6174 6520 6d61 736b 2076 6965 7773 2062  ate mask views b
-00012fb0: 7920 7573 696e 6720 6368 696d 6572 6120  y using chimera 
-00012fc0: 6d65 7468 6f64 0a20 2020 2020 2020 203a  method.        :
-00012fd0: 7265 7475 726e 3a0a 2020 2020 2020 2020  return:.        
-00012fe0: 2222 220a 0a20 2020 2020 2020 2073 7461  """..        sta
-00012ff0: 7274 203d 2074 696d 6569 742e 6465 6661  rt = timeit.defa
-00013000: 756c 745f 7469 6d65 7228 290a 2020 2020  ult_timer().    
-00013010: 2020 2020 6572 726c 6973 7420 3d20 5b5d      errlist = []
-00013020: 0a20 2020 2020 2020 206d 6173 6b72 6573  .        maskres
-00013030: 756c 7473 203d 205b 6974 656d 2066 6f72  ults = [item for
-00013040: 2069 7465 6d20 696e 2073 656c 662e 616c   item in self.al
-00013050: 6c6d 6173 6b73 2069 6620 6f73 2e70 6174  lmasks if os.pat
-00013060: 682e 6973 6669 6c65 2873 656c 662e 776f  h.isfile(self.wo
-00013070: 726b 6469 7220 2b20 6f73 2e70 6174 682e  rkdir + os.path.
-00013080: 6261 7365 6e61 6d65 2869 7465 6d29 295d  basename(item))]
-00013090: 0a20 2020 2020 2020 206d 6173 6b73 6469  .        masksdi
-000130a0: 6374 203d 2064 6963 7428 290a 2020 2020  ct = dict().    
-000130b0: 2020 2020 6669 6e61 6c64 6963 7420 3d20      finaldict = 
-000130c0: 6469 6374 2829 0a20 2020 2020 2020 2069  dict().        i
-000130d0: 6620 6e6f 7420 6d61 736b 7265 7375 6c74  f not maskresult
-000130e0: 733a 0a20 2020 2020 2020 2020 2020 2070  s:.            p
-000130f0: 7269 6e74 2827 5468 6572 6520 6973 206e  rint('There is n
-00013100: 6f20 6d61 736b 7320 6f66 6665 7265 6420  o masks offered 
-00013110: 666f 7220 7468 6973 206d 6170 2e27 290a  for this map.').
-00013120: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00013130: 2020 2020 2020 2020 2020 2320 666f 7220            # for 
-00013140: 6d61 736b 2069 6e20 6d61 736b 7265 7375  mask in maskresu
-00013150: 6c74 733a 0a20 2020 2020 2020 2020 2020  lts:.           
-00013160: 2066 6f72 206d 6173 6b20 696e 2073 656c   for mask in sel
-00013170: 662e 616c 6c6d 6173 6b73 3a0a 2020 2020  f.allmasks:.    
-00013180: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-00013190: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000131a0: 2020 2020 206d 6173 6b73 6469 6374 5b6f       masksdict[o
-000131b0: 732e 7061 7468 2e62 6173 656e 616d 6528  s.path.basename(
-000131c0: 6d61 736b 295d 203d 2073 656c 662e 6d61  mask)] = self.ma
-000131d0: 736b 7669 6577 735f 6368 696d 6572 6128  skviews_chimera(
-000131e0: 6d61 736b 2c20 6368 696d 6572 6161 7070  mask, chimeraapp
-000131f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00013200: 2020 6578 6365 7074 3a0a 2020 2020 2020    except:.      
-00013210: 2020 2020 2020 2020 2020 2020 2020 6572                er
-00013220: 7220 3d20 2753 6176 696e 6720 6d61 736b  r = 'Saving mask
-00013230: 207b 7d20 7669 6577 7320 6572 726f 723a   {} views error:
-00013240: 207b 7d2e 272e 666f 726d 6174 286d 6173   {}.'.format(mas
-00013250: 6b2c 2073 7973 2e65 7863 5f69 6e66 6f28  k, sys.exc_info(
-00013260: 295b 315d 290a 2020 2020 2020 2020 2020  )[1]).          
-00013270: 2020 2020 2020 2020 2020 6572 726c 6973            errlis
-00013280: 742e 6170 7065 6e64 2865 7272 290a 2020  t.append(err).  
-00013290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000132a0: 2020 7379 732e 7374 6465 7272 2e77 7269    sys.stderr.wri
-000132b0: 7465 2865 7272 202b 2027 5c6e 2729 0a20  te(err + '\n'). 
-000132c0: 2020 2020 2020 2020 2020 2069 6620 6572             if er
-000132d0: 726c 6973 743a 0a20 2020 2020 2020 2020  rlist:.         
-000132e0: 2020 2020 2020 206d 6173 6b73 6469 6374         masksdict
-000132f0: 5b27 6572 7227 5d20 3d20 7b27 6d61 736b  ['err'] = {'mask
-00013300: 5f76 6965 775f 6572 7227 3a20 6572 726c  _view_err': errl
-00013310: 6973 747d 0a20 2020 2020 2020 2020 2020  ist}.           
-00013320: 2066 696e 616c 6469 6374 5b27 6d61 736b   finaldict['mask
-00013330: 7327 5d20 3d20 6d61 736b 7364 6963 740a  s'] = masksdict.
-00013340: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-00013350: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013360: 2077 6974 6820 636f 6465 6373 2e6f 7065   with codecs.ope
-00013370: 6e28 7365 6c66 2e77 6f72 6b64 6972 202b  n(self.workdir +
-00013380: 2073 656c 662e 6d61 706e 616d 6520 2b20   self.mapname + 
-00013390: 275f 6d61 706d 6173 6b76 6965 772e 6a73  '_mapmaskview.js
-000133a0: 6f6e 272c 2027 7727 2c0a 2020 2020 2020  on', 'w',.      
-000133b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000133c0: 2020 2020 2020 2020 2020 2065 6e63 6f64             encod
-000133d0: 696e 673d 2775 7466 2d38 2729 2061 7320  ing='utf-8') as 
-000133e0: 663a 0a20 2020 2020 2020 2020 2020 2020  f:.             
-000133f0: 2020 2020 2020 206a 736f 6e2e 6475 6d70         json.dump
-00013400: 2866 696e 616c 6469 6374 2c20 6629 0a20  (finaldict, f). 
-00013410: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00013420: 7269 6e74 2827 4d61 736b 7320 7669 6577  rint('Masks view
-00013430: 2062 7920 7573 696e 6720 4368 696d 6572   by using Chimer
-00013440: 6158 206d 6574 686f 642e 2729 0a20 2020  aX method.').   
-00013450: 2020 2020 2020 2020 2065 7863 6570 743a           except:
-00013460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013470: 2073 7973 2e73 7464 6572 722e 7772 6974   sys.stderr.writ
-00013480: 6528 2753 6176 696e 6720 6d61 736b 7320  e('Saving masks 
-00013490: 746f 206a 736f 6e20 6572 726f 723a 207b  to json error: {
-000134a0: 7d2e 5c6e 272e 666f 726d 6174 2873 7973  }.\n'.format(sys
-000134b0: 2e65 7863 5f69 6e66 6f28 295b 315d 2929  .exc_info()[1]))
-000134c0: 0a0a 2020 2020 2020 2020 656e 6420 3d20  ..        end = 
-000134d0: 7469 6d65 6974 2e64 6566 6175 6c74 5f74  timeit.default_t
-000134e0: 696d 6572 2829 0a20 2020 2020 2020 2070  imer().        p
-000134f0: 7269 6e74 2827 4d61 736b 7669 6577 2074  rint('Maskview t
-00013500: 696d 653a 207b 7d27 2e66 6f72 6d61 7428  ime: {}'.format(
-00013510: 656e 642d 7374 6172 7429 290a 2020 2020  end-start)).    
-00013520: 2020 2020 7072 696e 7428 272d 2d2d 2d2d      print('-----
-00013530: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00013540: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d27  ---------------'
-00013550: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-00013560: 204e 6f6e 650a 0a20 2020 2064 6566 206d   None..    def m
-00013570: 6173 6b76 6965 7773 5f76 746b 2873 656c  askviews_vtk(sel
-00013580: 662c 206d 6170 7674 702c 206d 6173 6b76  f, mapvtp, maskv
-00013590: 7470 293a 0a20 2020 2020 2020 2022 2222  tp):.        """
-000135a0: 0a20 2020 2020 2020 2020 2020 2055 7369  .            Usi
-000135b0: 6e67 2074 6865 2076 746b 206d 6574 686f  ng the vtk metho
-000135c0: 6420 746f 2067 656e 6572 6174 6520 6d61  d to generate ma
-000135d0: 736b 2076 6965 7773 0a0a 2020 2020 2020  sk views..      
-000135e0: 2020 3a72 6574 7572 6e3a 0a20 2020 2020    :return:.     
-000135f0: 2020 2022 2222 0a0a 2020 2020 2020 2020     """..        
-00013600: 726f 6f74 203d 206f 732e 7061 7468 2e64  root = os.path.d
-00013610: 6972 6e61 6d65 286d 6173 6b76 7470 290a  irname(maskvtp).
-00013620: 2020 2020 2020 2020 6d61 736b 7674 7066          maskvtpf
-00013630: 696c 6520 3d20 6d61 736b 7674 705b 3a2d  ile = maskvtp[:-
-00013640: 345d 2e73 706c 6974 2827 2f27 295b 2d31  4].split('/')[-1
-00013650: 5d0a 2020 2020 2020 2020 6d61 7076 7470  ].        mapvtp
-00013660: 203d 2072 6f6f 7420 2b20 272f 2720 2b20   = root + '/' + 
-00013670: 7365 6c66 2e6d 6170 6e61 6d65 202b 2027  self.mapname + '
-00013680: 5f27 202b 2073 7472 2873 656c 662e 636c  _' + str(self.cl
-00013690: 2920 2b20 272e 7674 7027 0a0a 0a20 2020  ) + '.vtp'...   
-000136a0: 2020 2020 2066 6163 7447 7261 7068 6963       factGraphic
-000136b0: 7320 3d20 7674 6b2e 7674 6b47 7261 7068  s = vtk.vtkGraph
-000136c0: 6963 7346 6163 746f 7279 2829 0a20 2020  icsFactory().   
-000136d0: 2020 2020 2066 6163 7447 7261 7068 6963       factGraphic
-000136e0: 732e 5365 744f 6666 5363 7265 656e 4f6e  s.SetOffScreenOn
-000136f0: 6c79 4d6f 6465 2831 290a 2020 2020 2020  lyMode(1).      
-00013700: 2020 6661 6374 4772 6170 6869 6373 2e53    factGraphics.S
-00013710: 6574 5573 654d 6573 6143 6c61 7373 6573  etUseMesaClasses
-00013720: 2831 290a 2020 2020 2020 2020 7265 6164  (1).        read
-00013730: 6572 203d 2076 746b 2e76 746b 584d 4c50  er = vtk.vtkXMLP
-00013740: 6f6c 7944 6174 6152 6561 6465 7228 290a  olyDataReader().
-00013750: 2020 2020 2020 2020 7265 6164 6572 2e53          reader.S
-00013760: 6574 4669 6c65 4e61 6d65 286d 6170 7674  etFileName(mapvt
-00013770: 7029 0a20 2020 2020 2020 2072 6561 6465  p).        reade
-00013780: 722e 5570 6461 7465 2829 0a0a 2020 2020  r.Update()..    
-00013790: 2020 2020 2320 6164 6420 6d61 7020 7674      # add map vt
-000137a0: 7020 696e 746f 2069 740a 2020 2020 2020  p into it.      
-000137b0: 2020 6d61 705f 7265 6164 6572 203d 2076    map_reader = v
-000137c0: 746b 2e76 746b 584d 4c50 6f6c 7944 6174  tk.vtkXMLPolyDat
-000137d0: 6152 6561 6465 7228 290a 2020 2020 2020  aReader().      
-000137e0: 2020 6d61 705f 7265 6164 6572 2e53 6574    map_reader.Set
-000137f0: 4669 6c65 4e61 6d65 286d 6173 6b76 7470  FileName(maskvtp
-00013800: 290a 2020 2020 2020 2020 6d61 705f 6d61  ).        map_ma
-00013810: 7070 6572 203d 2076 746b 2e76 746b 506f  pper = vtk.vtkPo
-00013820: 6c79 4461 7461 4d61 7070 6572 2829 0a20  lyDataMapper(). 
-00013830: 2020 2020 2020 206d 6170 5f6d 6170 7065         map_mappe
-00013840: 722e 5363 616c 6172 5669 7369 6269 6c69  r.ScalarVisibili
-00013850: 7479 4f66 6628 290a 2020 2020 2020 2020  tyOff().        
-00013860: 6d61 705f 6d61 7070 6572 2e53 6574 496e  map_mapper.SetIn
-00013870: 7075 7443 6f6e 6e65 6374 696f 6e28 6d61  putConnection(ma
-00013880: 705f 7265 6164 6572 2e47 6574 4f75 7470  p_reader.GetOutp
-00013890: 7574 506f 7274 2829 290a 2020 2020 2020  utPort()).      
-000138a0: 2020 6d61 705f 6163 746f 7220 3d20 7674    map_actor = vt
-000138b0: 6b2e 7674 6b41 6374 6f72 2829 0a20 2020  k.vtkActor().   
-000138c0: 2020 2020 206d 6170 5f61 6374 6f72 2e53       map_actor.S
-000138d0: 6574 4d61 7070 6572 286d 6170 5f6d 6170  etMapper(map_map
-000138e0: 7065 7229 0a0a 2020 2020 2020 2020 6d61  per)..        ma
-000138f0: 705f 6163 746f 722e 4765 7450 726f 7065  p_actor.GetPrope
-00013900: 7274 7928 292e 5365 7443 6f6c 6f72 2830  rty().SetColor(0
-00013910: 2e30 2c20 302e 302c 2031 2e30 290a 2020  .0, 0.0, 1.0).  
-00013920: 2020 2020 2020 6d61 705f 6163 746f 722e        map_actor.
-00013930: 4765 7450 726f 7065 7274 7928 292e 5365  GetProperty().Se
-00013940: 7449 6e74 6572 706f 6c61 7469 6f6e 546f  tInterpolationTo
-00013950: 5068 6f6e 6728 290a 2020 2020 2020 2020  Phong().        
-00013960: 6d61 705f 6163 746f 722e 4765 7450 726f  map_actor.GetPro
-00013970: 7065 7274 7928 292e 5365 7444 6966 6675  perty().SetDiffu
-00013980: 7365 2830 2e39 290a 2020 2020 2020 2020  se(0.9).        
-00013990: 6d61 705f 6163 746f 722e 4765 7450 726f  map_actor.GetPro
-000139a0: 7065 7274 7928 292e 5365 7453 7065 6375  perty().SetSpecu
-000139b0: 6c61 7228 302e 3629 0a20 2020 2020 2020  lar(0.6).       
-000139c0: 206d 6170 5f61 6374 6f72 2e47 6574 5072   map_actor.GetPr
-000139d0: 6f70 6572 7479 2829 2e53 6574 5370 6563  operty().SetSpec
-000139e0: 756c 6172 506f 7765 7228 3330 290a 2020  ularPower(30).  
-000139f0: 2020 2020 2020 6d61 705f 6163 746f 722e        map_actor.
-00013a00: 4765 7450 726f 7065 7274 7928 292e 4261  GetProperty().Ba
-00013a10: 636b 6661 6365 4375 6c6c 696e 674f 6e28  ckfaceCullingOn(
-00013a20: 290a 2020 2020 2020 2020 6d61 705f 6163  ).        map_ac
-00013a30: 746f 722e 4765 7450 726f 7065 7274 7928  tor.GetProperty(
-00013a40: 292e 4672 6f6e 7466 6163 6543 756c 6c69  ).FrontfaceCulli
-00013a50: 6e67 4f6e 2829 0a20 2020 2020 2020 2023  ngOn().        #
-00013a60: 2323 2323 2323 2323 2323 230a 0a20 2020  ###########..   
-00013a70: 2020 2020 206d 6170 7065 7220 3d20 7674       mapper = vt
-00013a80: 6b2e 7674 6b50 6f6c 7944 6174 614d 6170  k.vtkPolyDataMap
-00013a90: 7065 7228 290a 2020 2020 2020 2020 6d61  per().        ma
-00013aa0: 7070 6572 2e53 6361 6c61 7256 6973 6962  pper.ScalarVisib
-00013ab0: 696c 6974 794f 6666 2829 0a20 2020 2020  ilityOff().     
-00013ac0: 2020 206d 6170 7065 722e 5365 7449 6e70     mapper.SetInp
-00013ad0: 7574 436f 6e6e 6563 7469 6f6e 2872 6561  utConnection(rea
-00013ae0: 6465 722e 4765 744f 7574 7075 7450 6f72  der.GetOutputPor
-00013af0: 7428 2929 0a0a 2020 2020 2020 2020 6163  t())..        ac
-00013b00: 746f 7220 3d20 7674 6b2e 7674 6b41 6374  tor = vtk.vtkAct
-00013b10: 6f72 2829 0a20 2020 2020 2020 2061 6374  or().        act
-00013b20: 6f72 2e53 6574 4d61 7070 6572 286d 6170  or.SetMapper(map
-00013b30: 7065 7229 0a20 2020 2020 2020 2061 6374  per).        act
-00013b40: 6f72 2e47 6574 5072 6f70 6572 7479 2829  or.GetProperty()
-00013b50: 2e53 6574 436f 6c6f 7228 312e 302c 2030  .SetColor(1.0, 0
-00013b60: 2e38 2c20 302e 3129 0a20 2020 2020 2020  .8, 0.1).       
-00013b70: 2061 6374 6f72 2e47 6574 5072 6f70 6572   actor.GetProper
-00013b80: 7479 2829 2e53 6574 496e 7465 7270 6f6c  ty().SetInterpol
-00013b90: 6174 696f 6e54 6f50 686f 6e67 2829 0a20  ationToPhong(). 
-00013ba0: 2020 2020 2020 2061 6374 6f72 2e47 6574         actor.Get
-00013bb0: 5072 6f70 6572 7479 2829 2e53 6574 4469  Property().SetDi
-00013bc0: 6666 7573 6528 302e 3929 0a20 2020 2020  ffuse(0.9).     
-00013bd0: 2020 2061 6374 6f72 2e47 6574 5072 6f70     actor.GetProp
-00013be0: 6572 7479 2829 2e53 6574 5370 6563 756c  erty().SetSpecul
-00013bf0: 6172 2830 2e36 290a 2020 2020 2020 2020  ar(0.6).        
-00013c00: 6163 746f 722e 4765 7450 726f 7065 7274  actor.GetPropert
-00013c10: 7928 292e 5365 7453 7065 6375 6c61 7250  y().SetSpecularP
-00013c20: 6f77 6572 2833 3029 0a20 2020 2020 2020  ower(30).       
-00013c30: 2061 6374 6f72 2e47 6574 5072 6f70 6572   actor.GetProper
-00013c40: 7479 2829 2e42 6163 6b66 6163 6543 756c  ty().BackfaceCul
-00013c50: 6c69 6e67 4f6e 2829 0a20 2020 2020 2020  lingOn().       
-00013c60: 2061 6374 6f72 2e47 6574 5072 6f70 6572   actor.GetProper
-00013c70: 7479 2829 2e46 726f 6e74 6661 6365 4375  ty().FrontfaceCu
-00013c80: 6c6c 696e 674f 6e28 290a 2020 2020 2020  llingOn().      
-00013c90: 2020 6163 746f 722e 4765 7450 726f 7065    actor.GetPrope
-00013ca0: 7274 7928 292e 5365 744f 7061 6369 7479  rty().SetOpacity
-00013cb0: 2830 2e35 290a 0a20 2020 2020 2020 2023  (0.5)..        #
-00013cc0: 2043 7265 6174 6520 7468 6520 6772 6170   Create the grap
-00013cd0: 6869 6373 2073 7472 7563 7475 7265 2e20  hics structure. 
-00013ce0: 5468 6520 7265 6e64 6572 6572 2072 656e  The renderer ren
-00013cf0: 6465 7273 2069 6e74 6f20 7468 6520 7265  ders into the re
-00013d00: 6e64 6572 0a20 2020 2020 2020 2023 2077  nder.        # w
-00013d10: 696e 646f 772e 2054 6865 2072 656e 6465  indow. The rende
-00013d20: 7220 7769 6e64 6f77 2069 6e74 6572 6163  r window interac
-00013d30: 746f 7220 6361 7074 7572 6573 206d 6f75  tor captures mou
-00013d40: 7365 2065 7665 6e74 7320 616e 6420 7769  se events and wi
-00013d50: 6c6c 0a20 2020 2020 2020 2023 2070 6572  ll.        # per
-00013d60: 666f 726d 2061 7070 726f 7072 6961 7465  form appropriate
-00013d70: 2063 616d 6572 6120 6f72 2061 6374 6f72   camera or actor
-00013d80: 206d 616e 6970 756c 6174 696f 6e20 6465   manipulation de
-00013d90: 7065 6e64 696e 6720 6f6e 2074 6865 0a20  pending on the. 
-00013da0: 2020 2020 2020 2023 206e 6174 7572 6520         # nature 
-00013db0: 6f66 2074 6865 2065 7665 6e74 732e 0a0a  of the events...
-00013dc0: 2020 2020 2020 2020 7265 6e20 3d20 7674          ren = vt
-00013dd0: 6b2e 7674 6b52 656e 6465 7265 7228 290a  k.vtkRenderer().
-00013de0: 2020 2020 2020 2020 7265 6e57 696e 203d          renWin =
-00013df0: 2076 746b 2e76 746b 5265 6e64 6572 5769   vtk.vtkRenderWi
-00013e00: 6e64 6f77 2829 0a20 2020 2020 2020 2072  ndow().        r
-00013e10: 656e 5769 6e2e 5365 744f 6666 5363 7265  enWin.SetOffScre
-00013e20: 656e 5265 6e64 6572 696e 6728 3129 0a20  enRendering(1). 
-00013e30: 2020 2020 2020 2072 656e 5769 6e2e 5365         renWin.Se
-00013e40: 7453 697a 6528 3330 3030 2c20 3330 3030  tSize(3000, 3000
-00013e50: 290a 2020 2020 2020 2020 7265 6e57 696e  ).        renWin
-00013e60: 2e41 6464 5265 6e64 6572 6572 2872 656e  .AddRenderer(ren
-00013e70: 290a 0a20 2020 2020 2020 2023 2041 6464  )..        # Add
-00013e80: 2074 6865 2061 6374 6f72 7320 746f 2074   the actors to t
-00013e90: 6865 2072 656e 6465 7265 722c 2073 6574  he renderer, set
-00013ea0: 2074 6865 2062 6163 6b67 726f 756e 6420   the background 
-00013eb0: 616e 6420 7369 7a65 0a20 2020 2020 2020  and size.       
-00013ec0: 2023 2061 6374 6f72 2e52 6f74 6174 6559   # actor.RotateY
-00013ed0: 2839 3029 0a20 2020 2020 2020 2072 656e  (90).        ren
-00013ee0: 2e41 6464 4163 746f 7228 6163 746f 7229  .AddActor(actor)
-00013ef0: 0a20 2020 2020 2020 2072 656e 2e41 6464  .        ren.Add
-00013f00: 4163 746f 7228 6d61 705f 6163 746f 7229  Actor(map_actor)
-00013f10: 0a20 2020 2020 2020 2072 656e 2e53 6574  .        ren.Set
-00013f20: 4261 636b 6772 6f75 6e64 2830 2e39 2c20  Background(0.9, 
-00013f30: 302e 392c 2030 2e39 290a 2020 2020 2020  0.9, 0.9).      
-00013f40: 2020 7265 6e2e 4765 7441 6374 6976 6543    ren.GetActiveC
-00013f50: 616d 6572 6128 292e 5365 7450 6172 616c  amera().SetParal
-00013f60: 6c65 6c50 726f 6a65 6374 696f 6e28 3129  lelProjection(1)
-00013f70: 0a20 2020 2020 2020 2072 656e 5769 6e2e  .        renWin.
-00013f80: 5265 6e64 6572 2829 0a0a 2020 2020 2020  Render()..      
-00013f90: 2020 2320 4f75 7470 7574 206d 6170 7320    # Output maps 
-00013fa0: 696d 6167 6573 206f 6e6c 790a 2020 2020  images only.    
-00013fb0: 2020 2020 7265 6e2e 5265 7365 7443 616d      ren.ResetCam
-00013fc0: 6572 6128 290a 2020 2020 2020 2020 7265  era().        re
-00013fd0: 6e2e 4765 7441 6374 6976 6543 616d 6572  n.GetActiveCamer
-00013fe0: 6128 292e 5a6f 6f6d 2831 2e33 3029 0a20  a().Zoom(1.30). 
-00013ff0: 2020 2020 2020 206f 7574 7a69 6d61 6765         outzimage
-00014000: 203d 2027 7b7d 7b7d 5f7a 6d61 736b 2e6a   = '{}{}_zmask.j
-00014010: 7065 6727 2e66 6f72 6d61 7428 7365 6c66  peg'.format(self
-00014020: 2e77 6f72 6b64 6972 2c20 6d61 736b 7674  .workdir, maskvt
-00014030: 7066 696c 6529 0a20 2020 2020 2020 2073  pfile).        s
-00014040: 656c 662e 7772 6974 655f 696d 6167 6528  elf.write_image(
-00014050: 6f75 747a 696d 6167 652c 2072 656e 5769  outzimage, renWi
-00014060: 6e29 0a0a 2020 2020 2020 2020 6163 746f  n)..        acto
-00014070: 722e 526f 7461 7465 5828 3930 290a 2020  r.RotateX(90).  
-00014080: 2020 2020 2020 6163 746f 722e 526f 7461        actor.Rota
-00014090: 7465 5928 3930 290a 2020 2020 2020 2020  teY(90).        
-000140a0: 6d61 705f 6163 746f 722e 526f 7461 7465  map_actor.Rotate
-000140b0: 5828 3930 290a 2020 2020 2020 2020 6d61  X(90).        ma
-000140c0: 705f 6163 746f 722e 526f 7461 7465 5928  p_actor.RotateY(
-000140d0: 3930 290a 2020 2020 2020 2020 2320 7265  90).        # re
-000140e0: 6e2e 5265 7365 7443 616d 6572 6128 290a  n.ResetCamera().
-000140f0: 2020 2020 2020 2020 6f75 7479 696d 6167          outyimag
-00014100: 6520 3d20 277b 7d7b 7d5f 796d 6173 6b2e  e = '{}{}_ymask.
-00014110: 6a70 6567 272e 666f 726d 6174 2873 656c  jpeg'.format(sel
-00014120: 662e 776f 726b 6469 722c 206d 6173 6b76  f.workdir, maskv
-00014130: 7470 6669 6c65 290a 2020 2020 2020 2020  tpfile).        
-00014140: 7365 6c66 2e77 7269 7465 5f69 6d61 6765  self.write_image
-00014150: 286f 7574 7969 6d61 6765 2c20 7265 6e57  (outyimage, renW
-00014160: 696e 290a 0a20 2020 2020 2020 2061 6374  in)..        act
-00014170: 6f72 2e52 6f74 6174 655a 2839 3029 0a20  or.RotateZ(90). 
-00014180: 2020 2020 2020 2061 6374 6f72 2e52 6f74         actor.Rot
-00014190: 6174 6558 2839 3029 0a20 2020 2020 2020  ateX(90).       
-000141a0: 206d 6170 5f61 6374 6f72 2e52 6f74 6174   map_actor.Rotat
-000141b0: 655a 2839 3029 0a20 2020 2020 2020 206d  eZ(90).        m
-000141c0: 6170 5f61 6374 6f72 2e52 6f74 6174 6558  ap_actor.RotateX
-000141d0: 2839 3029 0a20 2020 2020 2020 2023 2072  (90).        # r
-000141e0: 656e 2e52 6573 6574 4361 6d65 7261 2829  en.ResetCamera()
-000141f0: 0a20 2020 2020 2020 206f 7574 7869 6d61  .        outxima
-00014200: 6765 203d 2027 7b7d 7b7d 5f78 6d61 736b  ge = '{}{}_xmask
-00014210: 2e6a 7065 6727 2e66 6f72 6d61 7428 7365  .jpeg'.format(se
-00014220: 6c66 2e77 6f72 6b64 6972 2c20 6d61 736b  lf.workdir, mask
-00014230: 7674 7066 696c 6529 0a20 2020 2020 2020  vtpfile).       
-00014240: 2073 656c 662e 7772 6974 655f 696d 6167   self.write_imag
-00014250: 6528 6f75 7478 696d 6167 652c 2072 656e  e(outximage, ren
-00014260: 5769 6e29 0a20 2020 2020 2020 2073 656c  Win).        sel
-00014270: 662e 7363 616c 655f 6d61 736b 696d 6728  f.scale_maskimg(
-00014280: 290a 0a20 2020 2020 2020 206f 6e65 6d61  )..        onema
-00014290: 736b 6469 6374 203d 2064 6963 7428 290a  skdict = dict().
-000142a0: 2020 2020 2020 2020 6f6e 656d 6173 6b64          onemaskd
-000142b0: 6963 745b 2778 275d 203d 206f 732e 7061  ict['x'] = os.pa
-000142c0: 7468 2e62 6173 656e 616d 6528 6f75 7478  th.basename(outx
-000142d0: 696d 6167 6529 2069 6620 6f73 2e70 6174  image) if os.pat
-000142e0: 682e 6973 6669 6c65 286f 7574 7869 6d61  h.isfile(outxima
-000142f0: 6765 2920 656c 7365 204e 6f6e 650a 2020  ge) else None.  
-00014300: 2020 2020 2020 6f6e 656d 6173 6b64 6963        onemaskdic
-00014310: 745b 2779 275d 203d 206f 732e 7061 7468  t['y'] = os.path
-00014320: 2e62 6173 656e 616d 6528 6f75 7479 696d  .basename(outyim
-00014330: 6167 6529 2069 6620 6f73 2e70 6174 682e  age) if os.path.
-00014340: 6973 6669 6c65 286f 7574 7969 6d61 6765  isfile(outyimage
-00014350: 2920 656c 7365 204e 6f6e 650a 2020 2020  ) else None.    
-00014360: 2020 2020 6f6e 656d 6173 6b64 6963 745b      onemaskdict[
-00014370: 277a 275d 203d 206f 732e 7061 7468 2e62  'z'] = os.path.b
-00014380: 6173 656e 616d 6528 6f75 747a 696d 6167  asename(outzimag
-00014390: 6529 2069 6620 6f73 2e70 6174 682e 6973  e) if os.path.is
-000143a0: 6669 6c65 286f 7574 7a69 6d61 6765 2920  file(outzimage) 
-000143b0: 656c 7365 204e 6f6e 650a 0a20 2020 2020  else None..     
-000143c0: 2020 2072 6574 7572 6e20 6f6e 656d 6173     return onemas
-000143d0: 6b64 6963 740a 0a20 2020 2064 6566 206d  kdict..    def m
-000143e0: 6173 6b76 6965 7773 5f63 6869 6d65 7261  askviews_chimera
-000143f0: 2873 656c 662c 206d 6173 6b2c 2063 6869  (self, mask, chi
-00014400: 6d65 7261 6170 7029 3a0a 2020 2020 2020  meraapp):.      
-00014410: 2020 2222 220a 2020 2020 2020 2020 2020    """.          
-00014420: 2020 4765 6e65 7261 7465 206d 6173 6b20    Generate mask 
-00014430: 7669 6577 2062 7920 7573 696e 6720 4368  view by using Ch
-00014440: 696d 6572 6158 0a20 2020 2020 2020 2020  imeraX.         
-00014450: 2020 2054 6f64 6f3a 2061 2063 6f6e 746f     Todo: a conto
-00014460: 7572 206c 6576 656c 206e 6565 6465 6420  ur level needed 
-00014470: 6865 7265 2066 6f72 2074 6865 206d 6173  here for the mas
-00014480: 6b0a 0a20 2020 2020 2020 203a 7265 7475  k..        :retu
-00014490: 726e 3a0a 2020 2020 2020 2020 2222 220a  rn:.        """.
-000144a0: 0a20 2020 2020 2020 2023 206d 6170 6e61  .        # mapna
-000144b0: 6d65 203d 2073 656c 662e 776f 726b 6469  me = self.workdi
-000144c0: 7220 2b20 7365 6c66 2e6d 6170 6e61 6d65  r + self.mapname
-000144d0: 202b 2027 2e6d 6170 270a 2020 2020 2020   + '.map'.      
-000144e0: 2020 6572 726c 6973 7420 3d20 5b5d 0a20    errlist = []. 
-000144f0: 2020 2020 2020 2073 7461 7274 203d 2074         start = t
-00014500: 696d 6569 742e 6465 6661 756c 745f 7469  imeit.default_ti
-00014510: 6d65 7228 290a 2020 2020 2020 2020 6d61  mer().        ma
-00014520: 706e 616d 6520 3d20 7365 6c66 2e77 6f72  pname = self.wor
-00014530: 6b64 6972 202b 2073 656c 662e 6d61 706e  kdir + self.mapn
-00014540: 616d 650a 2020 2020 2020 2020 6d61 736b  ame.        mask
-00014550: 6e61 6d65 203d 206d 6173 6b2e 7370 6c69  name = mask.spli
-00014560: 7428 272f 2729 5b2d 315d 0a20 2020 2020  t('/')[-1].     
-00014570: 2020 2072 6567 5f6d 6173 6b6e 616d 6520     reg_maskname 
-00014580: 3d20 7265 2e73 6561 7263 6828 2765 6d64  = re.search('emd
-00014590: 5f2e 2a5f 6d73 6b2e 6d61 7027 2c20 6d61  _.*_msk.map', ma
-000145a0: 736b 6e61 6d65 290a 2020 2020 2020 2020  skname).        
-000145b0: 6966 2072 6567 5f6d 6173 6b6e 616d 653a  if reg_maskname:
-000145c0: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
-000145d0: 5f6d 6173 6b6e 616d 6520 3d20 277b 7d5f  _maskname = '{}_
-000145e0: 312e 6d61 7027 2e66 6f72 6d61 7428 6d61  1.map'.format(ma
-000145f0: 736b 6e61 6d65 5b3a 2d34 5d29 0a20 2020  skname[:-4]).   
-00014600: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
-00014610: 2121 204d 6173 6b20 6e61 6d65 2069 7320  !! Mask name is 
-00014620: 6f6c 6420 2121 2729 0a20 2020 2020 2020  old !!').       
-00014630: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00014640: 2020 206f 7574 5f6d 6173 6b6e 616d 6520     out_maskname 
-00014650: 3d20 6d61 736b 6e61 6d65 0a20 2020 2020  = maskname.     
-00014660: 2020 206d 6173 6b66 6e20 3d20 277b 7d5f     maskfn = '{}_
-00014670: 7b7d 272e 666f 726d 6174 286d 6173 6b6e  {}'.format(maskn
-00014680: 616d 652c 2073 656c 662e 6d61 706e 616d  ame, self.mapnam
-00014690: 6529 0a20 2020 2020 2020 2063 6869 6d65  e).        chime
-000146a0: 7261 636d 6420 3d20 6d61 736b 666e 202b  racmd = maskfn +
-000146b0: 2027 5f63 6869 6d65 7261 2e63 7863 270a   '_chimera.cxc'.
-000146c0: 2020 2020 2020 2020 6c6f 6343 4849 4d45          locCHIME
-000146d0: 5241 203d 2063 6869 6d65 7261 6170 700a  RA = chimeraapp.
-000146e0: 2020 2020 2020 2020 6269 6e64 6973 706c          bindispl
-000146f0: 6179 203d 206f 732e 6765 7465 6e76 2827  ay = os.getenv('
-00014700: 4449 5350 4c41 5927 290a 2020 2020 2020  DISPLAY').      
-00014710: 2020 6d73 6b63 6c20 3d20 7365 6c66 2e61    mskcl = self.a
-00014720: 6c6c 6d61 736b 735b 6d61 736b 5d0a 0a20  llmasks[mask].. 
-00014730: 2020 2020 2020 2023 2069 6620 286d 736b         # if (msk
-00014740: 636c 2061 6e64 2073 656c 662e 636c 2920  cl and self.cl) 
-00014750: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00014760: 2020 2020 206d 6574 5f63 6865 636b 203d       met_check =
-00014770: 2046 616c 7365 0a20 2020 2020 2020 2069   False.        i
-00014780: 6620 7365 6c66 2e6d 6574 203d 3d20 2774  f self.met == 't
-00014790: 6f6d 6f27 3a0a 2020 2020 2020 2020 2020  omo':.          
-000147a0: 2020 6966 206d 736b 636c 2069 7320 6e6f    if mskcl is no
-000147b0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-000147c0: 2020 2020 2020 2020 6d65 745f 6368 6563          met_chec
-000147d0: 6b20 3d20 5472 7565 0a20 2020 2020 2020  k = True.       
-000147e0: 2065 6c69 6620 7365 6c66 2e6d 6574 203d   elif self.met =
-000147f0: 3d20 2773 7027 206f 7220 7365 6c66 2e6d  = 'sp' or self.m
-00014800: 6574 203d 3d20 2768 656c 6927 206f 7220  et == 'heli' or 
-00014810: 7365 6c66 2e6d 6574 203d 3d20 2773 7562  self.met == 'sub
-00014820: 746f 6d6f 2720 6f72 2073 656c 662e 6d65  tomo' or self.me
-00014830: 7420 3d3d 2027 3264 6372 7973 273a 0a20  t == '2dcrys':. 
-00014840: 2020 2020 2020 2020 2020 2069 6620 286d             if (m
-00014850: 736b 636c 2061 6e64 2073 656c 662e 636c  skcl and self.cl
-00014860: 2920 6973 206e 6f74 204e 6f6e 653a 0a20  ) is not None:. 
-00014870: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00014880: 6574 5f63 6865 636b 203d 2054 7275 650a  et_check = True.
-00014890: 2020 2020 2020 2020 6966 206d 6574 5f63          if met_c
-000148a0: 6865 636b 2061 6e64 206f 732e 7061 7468  heck and os.path
-000148b0: 2e69 7366 696c 6528 7365 6c66 2e77 6f72  .isfile(self.wor
-000148c0: 6b64 6972 202b 2073 7472 286d 6173 6b6e  kdir + str(maskn
-000148d0: 616d 6529 293a 0a20 2020 2020 2020 2020  ame)):.         
-000148e0: 2020 2023 2049 6e20 6361 7365 2074 6865     # In case the
-000148f0: 7265 2069 7320 6e6f 206d 6173 6b20 636f  re is no mask co
-00014900: 6e74 6f75 7220 6c65 7665 6c2c 2068 6572  ntour level, her
-00014910: 6520 7765 2075 7365 2031 2e30 2069 6e73  e we use 1.0 ins
-00014920: 7465 6164 0a20 2020 2020 2020 2020 2020  tead.           
-00014930: 2063 6f6e 746f 7572 203d 2022 6c65 7665   contour = "leve
-00014940: 6c20 2220 2b20 7374 7228 6d73 6b63 6c29  l " + str(mskcl)
-00014950: 2069 6620 6d73 6b63 6c20 6973 206e 6f74   if mskcl is not
-00014960: 204e 6f6e 6520 656c 7365 2031 2e30 0a20   None else 1.0. 
-00014970: 2020 2020 2020 2020 2020 2077 6974 6820             with 
-00014980: 6f70 656e 2873 656c 662e 776f 726b 6469  open(self.workdi
-00014990: 7220 2b20 6368 696d 6572 6163 6d64 2c20  r + chimeracmd, 
-000149a0: 2777 2729 2061 7320 663a 0a20 2020 2020  'w') as f:.     
-000149b0: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-000149c0: 6c66 2e6d 6574 2021 3d20 2774 6f6d 6f27  lf.met != 'tomo'
-000149d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000149e0: 2020 2020 2020 662e 7772 6974 6528 0a20        f.write(. 
-000149f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014a00: 2020 2020 2020 2027 6f70 656e 2027 202b         'open ' +
-00014a10: 2073 7472 286d 6170 6e61 6d65 2920 2b20   str(mapname) + 
-00014a20: 2720 666f 726d 6174 2063 6370 3427 202b  ' format ccp4' +
-00014a30: 2027 5c6e 270a 2020 2020 2020 2020 2020   '\n'.          
-00014a40: 2020 2020 2020 2020 2020 2020 2020 276f                'o
-00014a50: 7065 6e20 2720 2b20 7365 6c66 2e77 6f72  pen ' + self.wor
-00014a60: 6b64 6972 202b 2073 7472 286d 6173 6b6e  kdir + str(maskn
-00014a70: 616d 6529 202b 2027 2066 6f72 6d61 7420  ame) + ' format 
-00014a80: 6363 7034 2720 2b20 275c 6e27 0a20 2020  ccp4' + '\n'.   
-00014a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014aa0: 2020 2020 2022 766f 6c75 6d65 2023 3120       "volume #1 
-00014ab0: 7374 796c 6520 7375 7266 6163 6520 6578  style surface ex
-00014ac0: 7061 6e64 5369 6e67 6c65 506c 616e 6520  pandSinglePlane 
-00014ad0: 5472 7565 2022 202b 2027 5c6e 270a 2020  True " + '\n'.  
-00014ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014af0: 2020 2020 2020 2276 6f6c 756d 6520 2332        "volume #2
-00014b00: 2073 7479 6c65 2073 7572 6661 6365 2065   style surface e
-00014b10: 7870 616e 6453 696e 676c 6550 6c61 6e65  xpandSinglePlane
-00014b20: 2054 7275 6520 2220 2b20 275c 6e27 0a20   True " + '\n'. 
-00014b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014b40: 2020 2020 2020 2022 766f 6c75 6d65 2023         "volume #
-00014b50: 3120 636f 6c6f 7220 2342 3838 3630 4220  1 color #B8860B 
-00014b60: 7374 6570 2031 206c 6576 656c 2022 202b  step 1 level " +
-00014b70: 2073 7472 2873 656c 662e 636c 2920 2b20   str(self.cl) + 
-00014b80: 275c 6e27 0a20 2020 2020 2020 2020 2020  '\n'.           
-00014b90: 2020 2020 2020 2020 2020 2020 2022 766f               "vo
-00014ba0: 6c75 6d65 2023 3220 636f 6c6f 7220 626c  lume #2 color bl
-00014bb0: 7565 2073 7465 7020 3120 2220 2b20 636f  ue step 1 " + co
-00014bc0: 6e74 6f75 7220 2b20 275c 6e27 0a20 2020  ntour + '\n'.   
-00014bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014be0: 2020 2020 2022 766f 6c75 6d65 2023 3120       "volume #1 
-00014bf0: 7472 616e 7370 6172 656e 6379 2030 2e36  transparency 0.6
-00014c00: 3522 202b 2027 5c6e 270a 2020 2020 2020  5" + '\n'.      
-00014c10: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00014c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014c30: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00014c40: 2020 2020 2020 2020 2020 662e 7772 6974            f.writ
-00014c50: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
-00014c60: 2020 2020 2020 2020 2020 2027 6f70 656e             'open
-00014c70: 2027 202b 2073 656c 662e 776f 726b 6469   ' + self.workdi
-00014c80: 7220 2b20 7374 7228 6d61 736b 6e61 6d65  r + str(maskname
-00014c90: 2920 2b20 2720 666f 726d 6174 2063 6370  ) + ' format ccp
-00014ca0: 3427 202b 275c 6e27 0a20 2020 2020 2020  4' +'\n'.       
-00014cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014cc0: 2022 766f 6c75 6d65 2023 3120 7374 796c   "volume #1 styl
-00014cd0: 6520 7375 7266 6163 6520 6578 7061 6e64  e surface expand
-00014ce0: 5369 6e67 6c65 506c 616e 6520 5472 7565  SinglePlane True
-00014cf0: 2022 202b 2027 5c6e 270a 2020 2020 2020   " + '\n'.      
-00014d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014d10: 2020 2276 6f6c 756d 6520 2331 2063 6f6c    "volume #1 col
-00014d20: 6f72 2062 6c75 6520 7374 6570 2031 2022  or blue step 1 "
-00014d30: 202b 2063 6f6e 746f 7572 202b 2027 5c6e   + contour + '\n
-00014d40: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00014d50: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00014d60: 2020 2020 2020 2020 662e 7772 6974 6528          f.write(
-00014d70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014d80: 2020 2020 2023 2027 6f70 656e 2027 202b       # 'open ' +
-00014d90: 2073 7472 286d 6173 6b29 202b 2027 2066   str(mask) + ' f
-00014da0: 6f72 6d61 7420 6363 7034 2720 2b27 5c6e  ormat ccp4' +'\n
-00014db0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00014dc0: 2020 2020 2020 2320 2276 6f6c 756d 6520        # "volume 
-00014dd0: 2331 2073 7479 6c65 2073 7572 6661 6365  #1 style surface
-00014de0: 2065 7870 616e 6453 696e 676c 6550 6c61   expandSinglePla
-00014df0: 6e65 2054 7275 6520 2220 2b20 275c 6e27  ne True " + '\n'
-00014e00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014e10: 2020 2020 2023 2022 766f 6c75 6d65 2023       # "volume #
-00014e20: 3220 7374 796c 6520 7375 7266 6163 6520  2 style surface 
-00014e30: 6578 7061 6e64 5369 6e67 6c65 506c 616e  expandSinglePlan
-00014e40: 6520 5472 7565 2022 202b 2027 5c6e 270a  e True " + '\n'.
-00014e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014e60: 2020 2020 2320 2276 6f6c 756d 6520 2331      # "volume #1
-00014e70: 2063 6f6c 6f72 2023 4238 3836 3042 2073   color #B8860B s
-00014e80: 7465 7020 3120 6c65 7665 6c20 2220 2b20  tep 1 level " + 
-00014e90: 7374 7228 7365 6c66 2e63 6c29 202b 2027  str(self.cl) + '
-00014ea0: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
-00014eb0: 2020 2020 2020 2020 2320 2276 6f6c 756d          # "volum
-00014ec0: 6520 2332 2063 6f6c 6f72 2062 6c75 6520  e #2 color blue 
-00014ed0: 7374 6570 2031 2022 202b 2063 6f6e 746f  step 1 " + conto
-00014ee0: 7572 202b 2027 5c6e 270a 2020 2020 2020  ur + '\n'.      
-00014ef0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00014f00: 2276 6f6c 756d 6520 2331 2074 7261 6e73  "volume #1 trans
-00014f10: 7061 7265 6e63 7920 302e 3635 2220 2b20  parency 0.65" + 
-00014f20: 275c 6e27 0a20 2020 2020 2020 2020 2020  '\n'.           
-00014f30: 2020 2020 2020 2020 2022 7365 7420 6267           "set bg
-00014f40: 436f 6c6f 7220 6c69 6768 7420 6772 6179  Color light gray
-00014f50: 2220 2b20 275c 6e27 0a20 2020 2020 2020  " + '\n'.       
-00014f60: 2020 2020 2020 2020 2020 2020 2022 7669               "vi
-00014f70: 6577 2063 6f66 7220 5472 7565 2220 2b20  ew cofr True" + 
-00014f80: 275c 6e27 0a20 2020 2020 2020 2020 2020  '\n'.           
-00014f90: 2020 2020 2020 2020 2022 7361 7665 2022           "save "
-00014fa0: 202b 2073 7472 286d 6170 6e61 6d65 2920   + str(mapname) 
-00014fb0: 2b20 225f 2220 2b20 7374 7228 6f75 745f  + "_" + str(out_
-00014fc0: 6d61 736b 6e61 6d65 2920 2b20 225f 7a6d  maskname) + "_zm
-00014fd0: 6173 6b76 6965 772e 6a70 6567 2220 2b20  askview.jpeg" + 
-00014fe0: 2220 7375 7065 7273 616d 706c 6520 3320  " supersample 3 
-00014ff0: 7769 6474 6820 3132 3030 2068 6569 6768  width 1200 heigh
-00015000: 7420 3132 3030 2220 2b20 275c 6e27 0a20  t 1200" + '\n'. 
-00015010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015020: 2020 2022 7475 726e 2078 202d 3930 2220     "turn x -90" 
-00015030: 2b20 275c 6e27 0a20 2020 2020 2020 2020  + '\n'.         
-00015040: 2020 2020 2020 2020 2020 2022 7475 726e             "turn
-00015050: 2079 202d 3930 2220 2b20 275c 6e27 0a20   y -90" + '\n'. 
-00015060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015070: 2020 2022 7669 6577 2063 6f66 7220 5472     "view cofr Tr
-00015080: 7565 2220 2b20 275c 6e27 0a20 2020 2020  ue" + '\n'.     
-00015090: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000150a0: 7361 7665 2022 202b 2073 7472 286d 6170  save " + str(map
-000150b0: 6e61 6d65 2920 2b20 225f 2220 2b20 7374  name) + "_" + st
-000150c0: 7228 6f75 745f 6d61 736b 6e61 6d65 2920  r(out_maskname) 
-000150d0: 2b20 225f 786d 6173 6b76 6965 772e 6a70  + "_xmaskview.jp
-000150e0: 6567 2220 2b20 2220 7375 7065 7273 616d  eg" + " supersam
-000150f0: 706c 6520 3320 7769 6474 6820 3132 3030  ple 3 width 1200
-00015100: 2068 6569 6768 7420 3132 3030 2220 2b20   height 1200" + 
-00015110: 275c 6e27 0a20 2020 2020 2020 2020 2020  '\n'.           
-00015120: 2020 2020 2020 2020 2022 7669 6577 206f           "view o
-00015130: 7269 656e 7422 202b 2027 5c6e 270a 2020  rient" + '\n'.  
-00015140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015150: 2020 2274 7572 6e20 7820 3930 2220 2b20    "turn x 90" + 
-00015160: 275c 6e27 0a20 2020 2020 2020 2020 2020  '\n'.           
-00015170: 2020 2020 2020 2020 2022 7475 726e 207a           "turn z
-00015180: 2039 3022 202b 2027 5c6e 270a 2020 2020   90" + '\n'.    
-00015190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000151a0: 2276 6965 7720 636f 6672 2054 7275 6522  "view cofr True"
-000151b0: 202b 2027 5c6e 270a 2020 2020 2020 2020   + '\n'.        
-000151c0: 2020 2020 2020 2020 2020 2020 2273 6176              "sav
-000151d0: 6520 2220 2b20 7374 7228 6d61 706e 616d  e " + str(mapnam
-000151e0: 6529 202b 2022 5f22 202b 2073 7472 286f  e) + "_" + str(o
-000151f0: 7574 5f6d 6173 6b6e 616d 6529 202b 2022  ut_maskname) + "
-00015200: 5f79 6d61 736b 7669 6577 2e6a 7065 6722  _ymaskview.jpeg"
-00015210: 202b 2022 2073 7570 6572 7361 6d70 6c65   + " supersample
-00015220: 2033 2077 6964 7468 2031 3230 3020 6865   3 width 1200 he
-00015230: 6967 6874 2031 3230 3022 202b 2027 5c6e  ight 1200" + '\n
-00015240: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00015250: 2020 2020 2020 2263 6c6f 7365 2061 6c6c        "close all
-00015260: 2220 2b20 225c 6e22 0a20 2020 2020 2020  " + "\n".       
-00015270: 2020 2020 2020 2020 2020 2020 2022 6578               "ex
-00015280: 6974 220a 2020 2020 2020 2020 2020 2020  it".            
-00015290: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-000152a0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-000152b0: 2020 2020 2020 2069 6620 6e6f 7420 6269         if not bi
-000152c0: 6e64 6973 706c 6179 3a0a 2020 2020 2020  ndisplay:.      
-000152d0: 2020 2020 2020 2020 2020 2020 2020 7375                su
-000152e0: 6270 726f 6365 7373 2e63 6865 636b 5f63  bprocess.check_c
-000152f0: 616c 6c28 6c6f 6343 4849 4d45 5241 202b  all(locCHIMERA +
-00015300: 2022 202d 2d6f 6666 7363 7265 656e 202d   " --offscreen -
-00015310: 2d6e 6f67 7569 2022 202b 2073 656c 662e  -nogui " + self.
-00015320: 776f 726b 6469 7220 2b20 6368 696d 6572  workdir + chimer
-00015330: 6163 6d64 2c0a 2020 2020 2020 2020 2020  acmd,.          
-00015340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015360: 2020 6377 643d 7365 6c66 2e77 6f72 6b64    cwd=self.workd
-00015370: 6972 2c20 7368 656c 6c3d 5472 7565 290a  ir, shell=True).
-00015380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015390: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-000153a0: 2020 2020 2020 2020 2020 7375 6270 726f            subpro
-000153b0: 6365 7373 2e63 6865 636b 5f63 616c 6c28  cess.check_call(
-000153c0: 6c6f 6343 4849 4d45 5241 202b 2022 2022  locCHIMERA + " "
-000153d0: 202b 2073 656c 662e 776f 726b 6469 7220   + self.workdir 
-000153e0: 2b20 6368 696d 6572 6163 6d64 2c20 6377  + chimeracmd, cw
-000153f0: 643d 7365 6c66 2e77 6f72 6b64 6972 2c20  d=self.workdir, 
-00015400: 7368 656c 6c3d 5472 7565 290a 2020 2020  shell=True).    
-00015410: 2020 2020 2020 2020 6578 6365 7074 2073          except s
-00015420: 7562 7072 6f63 6573 732e 4361 6c6c 6564  ubprocess.Called
-00015430: 5072 6f63 6573 7345 7272 6f72 2061 7320  ProcessError as 
-00015440: 7375 6265 7272 3a0a 2020 2020 2020 2020  suberr:.        
-00015450: 2020 2020 2020 2020 6572 7220 3d20 274d          err = 'M
-00015460: 6173 6b20 7669 6577 2062 7920 4368 696d  ask view by Chim
-00015470: 6572 6158 2065 7272 6f72 3a20 7b7d 272e  eraX error: {}'.
-00015480: 666f 726d 6174 2873 7562 6572 7229 0a20  format(suberr). 
-00015490: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-000154a0: 7272 6c69 7374 2e61 7070 656e 6428 6572  rrlist.append(er
-000154b0: 7229 0a20 2020 2020 2020 2020 2020 2020  r).             
-000154c0: 2020 2073 7973 2e73 7464 6572 722e 7772     sys.stderr.wr
-000154d0: 6974 6528 6572 7220 2b20 275c 6e27 290a  ite(err + '\n').
-000154e0: 0a20 2020 2020 2020 2020 2020 2065 6e64  .            end
-000154f0: 203d 2074 696d 6569 742e 6465 6661 756c   = timeit.defaul
-00015500: 745f 7469 6d65 7228 290a 2020 2020 2020  t_timer().      
-00015510: 2020 2020 2020 7072 696e 7428 2750 7269        print('Pri
-00015520: 6d61 7279 206d 6170 2061 6e64 206d 6173  mary map and mas
-00015530: 6b20 7669 6577 2074 696d 653a 2025 7327  k view time: %s'
-00015540: 2025 2028 656e 6420 2d20 7374 6172 7429   % (end - start)
-00015550: 290a 2020 2020 2020 2020 2020 2020 7072  ).            pr
-00015560: 696e 7428 272d 2d2d 2d2d 2d2d 2d2d 2d2d  int('-----------
-00015570: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00015580: 2d2d 2d2d 2d2d 2d2d 2d27 290a 0a20 2020  ---------')..   
-00015590: 2020 2020 2020 2020 2073 656c 662e 7363           self.sc
-000155a0: 616c 655f 6d61 736b 696d 6728 290a 0a20  ale_maskimg().. 
-000155b0: 2020 2020 2020 2020 2020 206f 6e65 6d61             onema
-000155c0: 736b 6469 6374 203d 2064 6963 7428 290a  skdict = dict().
-000155d0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-000155e0: 6469 6d20 696e 205b 2778 272c 2027 7927  dim in ['x', 'y'
-000155f0: 2c20 277a 275d 3a0a 2020 2020 2020 2020  , 'z']:.        
-00015600: 2020 2020 2020 2020 6375 725f 6d61 736b          cur_mask
-00015610: 7669 6577 203d 2027 7b7d 5f7b 7d5f 7b7d  view = '{}_{}_{}
-00015620: 6d61 736b 7669 6577 2e6a 7065 6727 2e66  maskview.jpeg'.f
-00015630: 6f72 6d61 7428 6d61 706e 616d 652c 206f  ormat(mapname, o
-00015640: 7574 5f6d 6173 6b6e 616d 652c 2064 696d  ut_maskname, dim
-00015650: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00015660: 2020 6f6e 656d 6173 6b64 6963 745b 6469    onemaskdict[di
-00015670: 6d5d 203d 2027 7b7d 5f7b 7d5f 7363 616c  m] = '{}_{}_scal
-00015680: 6564 5f7b 7d6d 6173 6b76 6965 772e 6a70  ed_{}maskview.jp
-00015690: 6567 272e 666f 726d 6174 286d 6170 6e61  eg'.format(mapna
-000156a0: 6d65 2c20 6f75 745f 6d61 736b 6e61 6d65  me, out_maskname
-000156b0: 2c20 6469 6d29 2069 6620 6f73 2e70 6174  , dim) if os.pat
-000156c0: 682e 6973 6669 6c65 2863 7572 5f6d 6173  h.isfile(cur_mas
-000156d0: 6b76 6965 7729 2065 6c73 6520 4e6f 6e65  kview) else None
-000156e0: 0a0a 2020 2020 2020 2020 2020 2020 7265  ..            re
-000156f0: 7475 726e 206f 6e65 6d61 736b 6469 6374  turn onemaskdict
-00015700: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00015710: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00015720: 2827 5245 4d49 4e44 4552 3a20 4d69 7373  ('REMINDER: Miss
-00015730: 696e 6720 636f 6e74 6f75 7220 6c65 7665  ing contour leve
-00015740: 6c20 2870 7269 6d61 7279 206d 6170 206f  l (primary map o
-00015750: 7220 6d61 736b 206f 7220 626f 7468 2920  r mask or both) 
-00015760: 6f72 206d 6173 6b20 6669 6c65 2069 7320  or mask file is 
-00015770: 6e6f 7420 6578 6973 742e 2729 0a0a 2020  not exist.')..  
-00015780: 2020 6465 6620 7265 6164 6d61 736b 7328    def readmasks(
-00015790: 7365 6c66 293a 0a20 2020 2020 2020 2022  self):.        "
-000157a0: 2222 0a0a 2020 2020 2020 2020 2020 2020  ""..            
-000157b0: 5769 7468 2074 6865 206d 6173 6b73 2061  With the masks a
-000157c0: 6e64 2072 6561 6420 7468 656d 2069 6e74  nd read them int
-000157d0: 6f20 7468 6520 5445 4d50 7920 6f62 6a65  o the TEMPy obje
-000157e0: 6374 0a0a 2020 2020 2020 2020 3a72 6574  ct..        :ret
-000157f0: 7572 6e3a 2072 6561 646d 616b 7320 7768  urn: readmaks wh
-00015800: 6963 6820 6973 2061 2064 6963 7428 6675  ich is a dict(fu
-00015810: 6c6c 6d61 736b 6e61 6d65 3a0a 2020 2020  llmaskname:.    
-00015820: 2020 2020 2222 220a 0a20 2020 2020 2020      """..       
-00015830: 2066 726f 6d20 7661 2e70 7265 7061 7261   from va.prepara
-00015840: 7469 6f6e 2069 6d70 6f72 7420 5072 6550  tion import PreP
-00015850: 6172 6174 696f 6e20 6173 2076 6170 7265  aration as vapre
-00015860: 700a 0a20 2020 2020 2020 2072 6561 6466  p..        readf
-00015870: 756e 203d 2076 6170 7265 7028 290a 2020  un = vaprep().  
-00015880: 2020 2020 2020 7265 6164 6d61 736b 7320        readmasks 
-00015890: 3d20 7b7d 0a20 2020 2020 2020 2065 7272  = {}.        err
-000158a0: 6c69 7374 203d 205b 5d0a 2020 2020 2020  list = [].      
-000158b0: 2020 666f 7220 6b65 7920 696e 2073 656c    for key in sel
-000158c0: 662e 616c 6c6d 6173 6b73 3a0a 2020 2020  f.allmasks:.    
-000158d0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-000158e0: 2020 2020 2020 2020 2020 2020 2023 2072               # r
-000158f0: 6561 646d 6173 6b73 5b6b 6579 5d20 3d20  eadmasks[key] = 
-00015900: 7265 6164 6675 6e2e 6672 6f6d 6d72 635f  readfun.frommrc_
-00015910: 746f 7465 6d70 7928 6b65 7929 0a20 2020  totempy(key).   
-00015920: 2020 2020 2020 2020 2020 2020 2072 6561               rea
-00015930: 646d 6173 6b73 5b6b 6579 5d20 3d20 7265  dmasks[key] = re
-00015940: 6164 6675 6e2e 6e65 775f 6672 6f6d 6d72  adfun.new_frommr
-00015950: 635f 746f 7465 6d70 7928 6b65 7929 0a20  c_totempy(key). 
-00015960: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-00015970: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
-00015980: 2020 2065 7272 203d 2027 536f 6d65 7468     err = 'Someth
-00015990: 696e 6720 6973 2077 726f 6e67 2077 6974  ing is wrong wit
-000159a0: 6820 7265 6164 696e 6720 6d61 736b 3a20  h reading mask: 
-000159b0: 7b7d 2c20 7b7d 272e 666f 726d 6174 286b  {}, {}'.format(k
-000159c0: 6579 2c20 7379 732e 6578 635f 696e 666f  ey, sys.exc_info
-000159d0: 2829 5b31 5d29 0a20 2020 2020 2020 2020  ()[1]).         
-000159e0: 2020 2020 2020 2065 7272 6c69 7374 2e61         errlist.a
-000159f0: 7070 656e 6428 6572 7229 0a20 2020 2020  ppend(err).     
-00015a00: 2020 2020 2020 2020 2020 2073 7973 2e73             sys.s
-00015a10: 7464 6572 722e 7772 6974 6528 2754 6865  tderr.write('The
-00015a20: 7265 2069 7320 736f 6d65 7468 696e 6720  re is something 
-00015a30: 7772 6f6e 6720 7769 7468 2072 6561 6469  wrong with readi
-00015a40: 6e67 206d 6170 207b 7d5c 6e27 2e66 6f72  ng map {}\n'.for
-00015a50: 6d61 7428 6b65 7929 290a 0a20 2020 2020  mat(key))..     
-00015a60: 2020 2072 6574 7572 6e20 7265 6164 6d61     return readma
-00015a70: 736b 732c 2065 7272 6c69 7374 0a0a 2020  sks, errlist..  
-00015a80: 2020 6465 6620 6365 6e74 7261 6c4d 6173    def centralMas
-00015a90: 6b73 2873 656c 6629 3a0a 2020 2020 2020  ks(self):.      
-00015aa0: 2020 2222 220a 0a20 2020 2020 2020 2020    """..         
-00015ab0: 2020 2050 726f 6475 6365 2074 6865 2063     Produce the c
-00015ac0: 656e 7472 616c 2073 6c69 6365 206f 6620  entral slice of 
-00015ad0: 6561 6368 206d 6173 6b73 2069 6e20 782c  each masks in x,
-00015ae0: 2079 2c20 7a20 6469 7265 6374 696f 6e73   y, z directions
-00015af0: 0a0a 2020 2020 2020 2020 3a72 6574 7572  ..        :retur
-00015b00: 6e3a 2064 6972 6563 746f 7279 2077 6869  n: directory whi
-00015b10: 6368 2063 6f6e 7461 7469 6e73 2061 6c6c  ch contatins all
-00015b20: 2074 6865 2073 6c69 6365 7320 696e 666f   the slices info
-00015b30: 726d 6174 696f 6e0a 0a20 2020 2020 2020  rmation..       
-00015b40: 2022 2222 0a0a 2020 2020 2020 2020 7374   """..        st
-00015b50: 6172 7420 3d20 7469 6d65 6974 2e64 6566  art = timeit.def
-00015b60: 6175 6c74 5f74 696d 6572 2829 0a20 2020  ault_timer().   
-00015b70: 2020 2020 2065 7272 6c69 7374 203d 205b       errlist = [
-00015b80: 5d0a 2020 2020 2020 2020 616c 6c6d 6173  ].        allmas
-00015b90: 6b64 6963 7420 3d20 6469 6374 2829 0a0a  kdict = dict()..
-00015ba0: 2020 2020 2020 2020 7265 6164 6d61 736b          readmask
-00015bb0: 732c 2065 7272 6672 6f6d 6c6f 6164 203d  s, errfromload =
-00015bc0: 2073 656c 662e 7265 6164 6d61 736b 7328   self.readmasks(
-00015bd0: 290a 2020 2020 2020 2020 6966 2065 7272  ).        if err
-00015be0: 6672 6f6d 6c6f 6164 3a0a 2020 2020 2020  fromload:.      
-00015bf0: 2020 2020 2020 6572 726c 6973 742e 6170        errlist.ap
-00015c00: 7065 6e64 2865 7272 6672 6f6d 6c6f 6164  pend(errfromload
-00015c10: 290a 0a20 2020 2020 2020 2066 6f72 2028  )..        for (
-00015c20: 6b65 792c 206d 6170 2920 696e 2069 7465  key, map) in ite
-00015c30: 7269 7465 6d73 2872 6561 646d 6173 6b73  ritems(readmasks
-00015c40: 293a 0a20 2020 2020 2020 2020 2020 206d  ):.            m
-00015c50: 6170 6e61 6d65 203d 206f 732e 7061 7468  apname = os.path
-00015c60: 2e62 6173 656e 616d 6528 6d61 702e 6675  .basename(map.fu
-00015c70: 6c6c 6e61 6d65 290a 2020 2020 2020 2020  llname).        
-00015c80: 2020 2020 6d61 705f 7a73 697a 6520 3d20      map_zsize = 
-00015c90: 6d61 702e 6865 6164 6572 2e6e 7a0a 2020  map.header.nz.  
-00015ca0: 2020 2020 2020 2020 2020 6d61 705f 7973            map_ys
-00015cb0: 697a 6520 3d20 6d61 702e 6865 6164 6572  ize = map.header
-00015cc0: 2e6e 790a 2020 2020 2020 2020 2020 2020  .ny.            
-00015cd0: 6d61 705f 7873 697a 6520 3d20 6d61 702e  map_xsize = map.
-00015ce0: 6865 6164 6572 2e6e 780a 2020 2020 2020  header.nx.      
-00015cf0: 2020 2020 2020 786d 6964 203d 2069 6e74        xmid = int
-00015d00: 2866 6c6f 6174 286d 6170 5f78 7369 7a65  (float(map_xsize
-00015d10: 2920 2f20 3229 0a20 2020 2020 2020 2020  ) / 2).         
-00015d20: 2020 2079 6d69 6420 3d20 696e 7428 666c     ymid = int(fl
-00015d30: 6f61 7428 6d61 705f 7973 697a 6529 202f  oat(map_ysize) /
-00015d40: 2032 290a 2020 2020 2020 2020 2020 2020   2).            
-00015d50: 7a6d 6964 203d 2069 6e74 2866 6c6f 6174  zmid = int(float
-00015d60: 286d 6170 5f7a 7369 7a65 2920 2f20 3229  (map_zsize) / 2)
-00015d70: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00015d80: 7863 656e 7472 616c 203d 206d 6170 2e66  xcentral = map.f
-00015d90: 756c 6c4d 6170 5b3a 2c20 3a2c 2078 6d69  ullMap[:, :, xmi
-00015da0: 645d 0a20 2020 2020 2020 2020 2020 2078  d].            x
-00015db0: 6365 6e74 7261 6c20 3d20 6d61 702e 6461  central = map.da
-00015dc0: 7461 5b3a 2c20 3a2c 2078 6d69 645d 0a20  ta[:, :, xmid]. 
-00015dd0: 2020 2020 2020 2020 2020 2078 6465 6e6f             xdeno
-00015de0: 6d20 3d20 2878 6365 6e74 7261 6c2e 6d61  m = (xcentral.ma
-00015df0: 7828 2920 2d20 7863 656e 7472 616c 2e6d  x() - xcentral.m
-00015e00: 696e 2829 2920 6966 2078 6365 6e74 7261  in()) if xcentra
-00015e10: 6c2e 6d61 7828 2920 213d 2078 6365 6e74  l.max() != xcent
-00015e20: 7261 6c2e 6d69 6e28 2920 656c 7365 2031  ral.min() else 1
-00015e30: 0a20 2020 2020 2020 2020 2020 2078 7265  .            xre
-00015e40: 7363 616c 6564 203d 2028 2828 7863 656e  scaled = (((xcen
-00015e50: 7472 616c 202d 2078 6365 6e74 7261 6c2e  tral - xcentral.
-00015e60: 6d69 6e28 2929 202a 2032 3535 2e30 2920  min()) * 255.0) 
-00015e70: 2f20 7864 656e 6f6d 292e 6173 7479 7065  / xdenom).astype
-00015e80: 2827 7569 6e74 3827 290a 2020 2020 2020  ('uint8').      
-00015e90: 2020 2020 2020 7866 6c69 7070 6564 203d        xflipped =
-00015ea0: 206e 702e 666c 6970 7564 2878 7265 7363   np.flipud(xresc
-00015eb0: 616c 6564 290a 2020 2020 2020 2020 2020  aled).          
-00015ec0: 2020 7869 6d67 203d 2049 6d61 6765 2e66    ximg = Image.f
-00015ed0: 726f 6d61 7272 6179 2878 666c 6970 7065  romarray(xflippe
-00015ee0: 6429 0a20 2020 2020 2020 2020 2020 2074  d).            t
-00015ef0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00015f00: 2020 2020 7869 6d67 2e73 6176 6528 7365      ximg.save(se
-00015f10: 6c66 2e77 6f72 6b64 6972 202b 206d 6170  lf.workdir + map
-00015f20: 6e61 6d65 202b 2027 5f78 6d61 736b 6365  name + '_xmaskce
-00015f30: 6e74 7261 6c5f 736c 6963 652e 6a70 6567  ntral_slice.jpeg
-00015f40: 2729 0a20 2020 2020 2020 2020 2020 2065  ').            e
-00015f50: 7863 6570 7420 494f 4572 726f 7220 6173  xcept IOError as
-00015f60: 2069 6f65 7272 3a0a 2020 2020 2020 2020   ioerr:.        
-00015f70: 2020 2020 2020 2020 7865 7272 203d 2027          xerr = '
-00015f80: 5361 7669 6e67 206f 7269 6769 6e61 6c20  Saving original 
-00015f90: 7820 6365 6e74 7261 6c20 736c 6963 6520  x central slice 
-00015fa0: 6f66 206d 6173 6b20 6572 723a 7b7d 272e  of mask err:{}'.
-00015fb0: 666f 726d 6174 2869 6f65 7272 290a 2020  format(ioerr).  
-00015fc0: 2020 2020 2020 2020 2020 2020 2020 6572                er
-00015fd0: 726c 6973 742e 6170 7065 6e64 2878 6572  rlist.append(xer
-00015fe0: 7229 0a20 2020 2020 2020 2020 2020 2020  r).             
-00015ff0: 2020 2073 7973 2e73 7464 6572 722e 7772     sys.stderr.wr
-00016000: 6974 6528 7865 7272 202b 2027 5c6e 2729  ite(xerr + '\n')
-00016010: 0a0a 2020 2020 2020 2020 2020 2020 7769  ..            wi
-00016020: 6474 682c 2068 6569 6768 7420 3d20 7869  dth, height = xi
-00016030: 6d67 2e73 697a 650a 2020 2020 2020 2020  mg.size.        
-00016040: 2020 2020 7873 6361 6c65 6e61 6d65 203d      xscalename =
-00016050: 2073 656c 662e 776f 726b 6469 7220 2b20   self.workdir + 
-00016060: 6d61 706e 616d 6520 2b20 275f 7363 616c  mapname + '_scal
-00016070: 6564 5f78 6d61 736b 6365 6e74 7261 6c5f  ed_xmaskcentral_
-00016080: 736c 6963 652e 6a70 6567 270a 0a20 2020  slice.jpeg'..   
-00016090: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-000160a0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000160b0: 2077 6964 7468 203e 2033 3030 2061 6e64   width > 300 and
-000160c0: 2068 6569 6768 7420 3e20 3330 303a 0a20   height > 300:. 
-000160d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000160e0: 2020 2069 6620 7769 6474 6820 3e3d 2068     if width >= h
-000160f0: 6569 6768 743a 0a20 2020 2020 2020 2020  eight:.         
-00016100: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00016110: 6172 6765 7273 6361 6c65 7220 3d20 3330  argerscaler = 30
-00016120: 302e 202f 2077 6964 7468 0a20 2020 2020  0. / width.     
-00016130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016140: 2020 206e 6577 6865 6967 6874 203d 2069     newheight = i
-00016150: 6e74 2863 6569 6c28 6c61 7267 6572 7363  nt(ceil(largersc
-00016160: 616c 6572 202a 2068 6569 6768 7429 290a  aler * height)).
-00016170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016180: 2020 2020 2020 2020 696d 7820 3d20 496d          imx = Im
-00016190: 6167 652e 6672 6f6d 6172 7261 7928 7866  age.fromarray(xf
-000161a0: 6c69 7070 6564 292e 7265 7369 7a65 2828  lipped).resize((
-000161b0: 3330 302c 206e 6577 6865 6967 6874 292c  300, newheight),
-000161c0: 2049 6d61 6765 2e52 6573 616d 706c 696e   Image.Resamplin
-000161d0: 672e 4c41 4e43 5a4f 5329 0a20 2020 2020  g.LANCZOS).     
-000161e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000161f0: 2020 2069 6d78 2e73 6176 6528 7873 6361     imx.save(xsca
-00016200: 6c65 6e61 6d65 290a 2020 2020 2020 2020  lename).        
-00016210: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00016220: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00016230: 2020 2020 2020 2020 2020 6c61 7267 6572            larger
-00016240: 7363 616c 6572 203d 2033 3030 2e20 2f20  scaler = 300. / 
-00016250: 6865 6967 6874 0a20 2020 2020 2020 2020  height.         
-00016260: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00016270: 6577 7769 6474 6820 3d20 696e 7428 6365  ewwidth = int(ce
-00016280: 696c 286c 6172 6765 7273 6361 6c65 7220  il(largerscaler 
-00016290: 2a20 7769 6474 6829 290a 2020 2020 2020  * width)).      
-000162a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000162b0: 2020 696d 7820 3d20 496d 6167 652e 6672    imx = Image.fr
-000162c0: 6f6d 6172 7261 7928 7866 6c69 7070 6564  omarray(xflipped
-000162d0: 292e 7265 7369 7a65 2828 6e65 7777 6964  ).resize((newwid
-000162e0: 7468 2c20 3330 3029 2c20 496d 6167 652e  th, 300), Image.
-000162f0: 5265 7361 6d70 6c69 6e67 2e4c 414e 435a  Resampling.LANCZ
-00016300: 4f53 290a 2020 2020 2020 2020 2020 2020  OS).            
-00016310: 2020 2020 2020 2020 2020 2020 696d 782e              imx.
-00016320: 7361 7665 2878 7363 616c 656e 616d 6529  save(xscalename)
-00016330: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016340: 2020 2020 2023 2069 6d78 203d 2049 6d61       # imx = Ima
-00016350: 6765 2e66 726f 6d61 7272 6179 2878 666c  ge.fromarray(xfl
-00016360: 6970 7065 6429 2e72 6573 697a 6528 2833  ipped).resize((3
-00016370: 3030 2c33 3030 2929 0a20 2020 2020 2020  00,300)).       
-00016380: 2020 2020 2020 2020 2020 2020 2023 2069               # i
-00016390: 6d78 2e73 6176 6528 7873 6361 6c65 6e61  mx.save(xscalena
-000163a0: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
-000163b0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000163c0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000163d0: 2077 6964 7468 203e 3d20 6865 6967 6874   width >= height
-000163e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000163f0: 2020 2020 2020 2020 2020 7363 616c 6572            scaler
-00016400: 203d 2033 3030 2e20 2f20 7769 6474 680a   = 300. / width.
-00016410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016420: 2020 2020 2020 2020 6e65 7768 6569 6768          newheigh
-00016430: 7420 3d20 696e 7428 6365 696c 2873 6361  t = int(ceil(sca
-00016440: 6c65 7220 2a20 6865 6967 6874 2929 0a20  ler * height)). 
-00016450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016460: 2020 2020 2020 2069 6d78 203d 2049 6d61         imx = Ima
-00016470: 6765 2e66 726f 6d61 7272 6179 2878 666c  ge.fromarray(xfl
-00016480: 6970 7065 6429 2e72 6573 697a 6528 2833  ipped).resize((3
-00016490: 3030 2c20 6e65 7768 6569 6768 7429 2c20  00, newheight), 
-000164a0: 496d 6167 652e 5265 7361 6d70 6c69 6e67  Image.Resampling
-000164b0: 2e4c 414e 435a 4f53 290a 2020 2020 2020  .LANCZOS).      
-000164c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000164d0: 2020 696d 782e 7361 7665 2878 7363 616c    imx.save(xscal
-000164e0: 656e 616d 6529 0a20 2020 2020 2020 2020  ename).         
-000164f0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00016500: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016510: 2020 2020 2020 2020 2073 6361 6c65 7220           scaler 
-00016520: 3d20 3330 302e 202f 2068 6569 6768 740a  = 300. / height.
-00016530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016540: 2020 2020 2020 2020 6e65 7777 6964 7468          newwidth
-00016550: 203d 2069 6e74 2863 6569 6c28 7363 616c   = int(ceil(scal
-00016560: 6572 202a 2077 6964 7468 2929 0a20 2020  er * width)).   
-00016570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016580: 2020 2020 2069 6d78 203d 2049 6d61 6765       imx = Image
-00016590: 2e66 726f 6d61 7272 6179 2878 666c 6970  .fromarray(xflip
-000165a0: 7065 6429 2e72 6573 697a 6528 286e 6577  ped).resize((new
-000165b0: 7769 6474 682c 2033 3030 292c 2049 6d61  width, 300), Ima
-000165c0: 6765 2e52 6573 616d 706c 696e 672e 4c41  ge.Resampling.LA
-000165d0: 4e43 5a4f 5329 0a20 2020 2020 2020 2020  NCZOS).         
-000165e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000165f0: 6d78 2e73 6176 6528 7873 6361 6c65 6e61  mx.save(xscalena
-00016600: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
-00016610: 6578 6365 7074 3a0a 2020 2020 2020 2020  except:.        
-00016620: 2020 2020 2020 2020 7865 7272 203d 2027          xerr = '
-00016630: 5361 7669 6e67 2073 6361 6c65 6420 7820  Saving scaled x 
-00016640: 6365 6e74 7261 6c20 736c 6963 6520 6f66  central slice of
-00016650: 206d 6173 6b20 6572 723a 7b7d 272e 666f   mask err:{}'.fo
-00016660: 726d 6174 2873 7973 2e65 7863 5f69 6e66  rmat(sys.exc_inf
-00016670: 6f28 295b 315d 290a 2020 2020 2020 2020  o()[1]).        
-00016680: 2020 2020 2020 2020 6572 726c 6973 742e          errlist.
-00016690: 6170 7065 6e64 2878 6572 7229 0a20 2020  append(xerr).   
-000166a0: 2020 2020 2020 2020 2020 2020 2073 7973               sys
-000166b0: 2e73 7464 6572 722e 7772 6974 6528 7865  .stderr.write(xe
-000166c0: 7272 202b 2027 5c6e 2729 0a0a 2020 2020  rr + '\n')..    
-000166d0: 2020 2020 2020 2020 2320 7963 656e 7472          # ycentr
-000166e0: 616c 203d 206d 6170 2e66 756c 6c4d 6170  al = map.fullMap
-000166f0: 5b3a 2c20 796d 6964 2c20 3a5d 0a20 2020  [:, ymid, :].   
-00016700: 2020 2020 2020 2020 2079 6365 6e74 7261           ycentra
-00016710: 6c20 3d20 6d61 702e 6461 7461 5b3a 2c20  l = map.data[:, 
-00016720: 796d 6964 2c20 3a5d 0a20 2020 2020 2020  ymid, :].       
-00016730: 2020 2020 2079 6465 6e6f 6d20 3d20 2879       ydenom = (y
-00016740: 6365 6e74 7261 6c2e 6d61 7828 2920 2d20  central.max() - 
-00016750: 7963 656e 7472 616c 2e6d 696e 2829 2920  ycentral.min()) 
-00016760: 6966 2079 6365 6e74 7261 6c2e 6d61 7828  if ycentral.max(
-00016770: 2920 213d 2079 6365 6e74 7261 6c2e 6d69  ) != ycentral.mi
-00016780: 6e28 2920 656c 7365 2031 0a20 2020 2020  n() else 1.     
-00016790: 2020 2020 2020 2079 7265 7363 616c 6564         yrescaled
-000167a0: 203d 2028 2828 7963 656e 7472 616c 202d   = (((ycentral -
-000167b0: 2079 6365 6e74 7261 6c2e 6d69 6e28 2929   ycentral.min())
-000167c0: 202a 2032 3535 2e30 2920 2f20 7964 656e   * 255.0) / yden
-000167d0: 6f6d 292e 6173 7479 7065 2827 7569 6e74  om).astype('uint
-000167e0: 3827 290a 2020 2020 2020 2020 2020 2020  8').            
-000167f0: 7972 6f74 6174 6520 3d20 6e70 2e72 6f74  yrotate = np.rot
-00016800: 3930 2879 7265 7363 616c 6564 290a 2020  90(yrescaled).  
-00016810: 2020 2020 2020 2020 2020 7969 6d67 203d            yimg =
-00016820: 2049 6d61 6765 2e66 726f 6d61 7272 6179   Image.fromarray
-00016830: 2879 726f 7461 7465 290a 2020 2020 2020  (yrotate).      
-00016840: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-00016850: 2020 2020 2020 2020 2020 2079 696d 672e             yimg.
-00016860: 7361 7665 2873 656c 662e 776f 726b 6469  save(self.workdi
-00016870: 7220 2b20 6d61 706e 616d 6520 2b20 275f  r + mapname + '_
-00016880: 796d 6173 6b63 656e 7472 616c 5f73 6c69  ymaskcentral_sli
-00016890: 6365 2e6a 7065 6727 290a 2020 2020 2020  ce.jpeg').      
-000168a0: 2020 2020 2020 6578 6365 7074 2049 4f45        except IOE
-000168b0: 7272 6f72 2061 7320 696f 6572 723a 0a20  rror as ioerr:. 
-000168c0: 2020 2020 2020 2020 2020 2020 2020 2079                 y
-000168d0: 6572 7220 3d20 2753 6176 696e 6720 6f72  err = 'Saving or
-000168e0: 6967 696e 616c 2079 2063 656e 7472 616c  iginal y central
-000168f0: 2073 6c69 6365 206f 6620 6d61 736b 2065   slice of mask e
-00016900: 7272 3a7b 7d27 2e66 6f72 6d61 7428 696f  rr:{}'.format(io
-00016910: 6572 7229 0a20 2020 2020 2020 2020 2020  err).           
-00016920: 2020 2020 2065 7272 6c69 7374 2e61 7070       errlist.app
-00016930: 656e 6428 7965 7272 290a 2020 2020 2020  end(yerr).      
-00016940: 2020 2020 2020 2020 2020 7379 732e 7374            sys.st
-00016950: 6465 7272 2e77 7269 7465 2879 6572 7220  derr.write(yerr 
-00016960: 2b20 275c 6e27 290a 0a20 2020 2020 2020  + '\n')..       
-00016970: 2020 2020 2077 6964 7468 2c20 6865 6967       width, heig
-00016980: 6874 203d 2079 696d 672e 7369 7a65 0a20  ht = yimg.size. 
-00016990: 2020 2020 2020 2020 2020 2079 7363 616c             yscal
-000169a0: 656e 616d 6520 3d20 7365 6c66 2e77 6f72  ename = self.wor
-000169b0: 6b64 6972 202b 206d 6170 6e61 6d65 202b  kdir + mapname +
-000169c0: 2027 5f73 6361 6c65 645f 796d 6173 6b63   '_scaled_ymaskc
-000169d0: 656e 7472 616c 5f73 6c69 6365 2e6a 7065  entral_slice.jpe
-000169e0: 6727 0a20 2020 2020 2020 2020 2020 2074  g'.            t
-000169f0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00016a00: 2020 2020 6966 2077 6964 7468 203e 2033      if width > 3
-00016a10: 3030 2061 6e64 2068 6569 6768 7420 3e20  00 and height > 
-00016a20: 3330 303a 0a20 2020 2020 2020 2020 2020  300:.           
-00016a30: 2020 2020 2020 2020 2069 6620 7769 6474           if widt
-00016a40: 6820 3e3d 2068 6569 6768 743a 0a20 2020  h >= height:.   
-00016a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016a60: 2020 2020 206c 6172 6765 7273 6361 6c65       largerscale
-00016a70: 7220 3d20 3330 302e 202f 2077 6964 7468  r = 300. / width
-00016a80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016a90: 2020 2020 2020 2020 206e 6577 6865 6967           newheig
-00016aa0: 6874 203d 2069 6e74 2863 6569 6c28 6c61  ht = int(ceil(la
-00016ab0: 7267 6572 7363 616c 6572 202a 2068 6569  rgerscaler * hei
-00016ac0: 6768 7429 290a 2020 2020 2020 2020 2020  ght)).          
-00016ad0: 2020 2020 2020 2020 2020 2020 2020 696d                im
-00016ae0: 7920 3d20 496d 6167 652e 6672 6f6d 6172  y = Image.fromar
-00016af0: 7261 7928 7972 6f74 6174 6529 2e72 6573  ray(yrotate).res
-00016b00: 697a 6528 2833 3030 2c20 6e65 7768 6569  ize((300, newhei
-00016b10: 6768 7429 2c20 496d 6167 652e 5265 7361  ght), Image.Resa
-00016b20: 6d70 6c69 6e67 2e4c 414e 435a 4f53 290a  mpling.LANCZOS).
-00016b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016b40: 2020 2020 2020 2020 696d 792e 7361 7665          imy.save
-00016b50: 2879 7363 616c 656e 616d 6529 0a20 2020  (yscalename).   
-00016b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016b70: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00016b80: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00016b90: 6172 6765 7273 6361 6c65 7220 3d20 3330  argerscaler = 30
-00016ba0: 302e 202f 2068 6569 6768 740a 2020 2020  0. / height.    
-00016bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016bc0: 2020 2020 6e65 7777 6964 7468 203d 2069      newwidth = i
-00016bd0: 6e74 2863 6569 6c28 6c61 7267 6572 7363  nt(ceil(largersc
-00016be0: 616c 6572 202a 2077 6964 7468 2929 0a20  aler * width)). 
-00016bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016c00: 2020 2020 2020 2069 6d79 203d 2049 6d61         imy = Ima
-00016c10: 6765 2e66 726f 6d61 7272 6179 2879 726f  ge.fromarray(yro
-00016c20: 7461 7465 292e 7265 7369 7a65 2828 6e65  tate).resize((ne
-00016c30: 7777 6964 7468 2c20 3330 3029 2c20 496d  wwidth, 300), Im
-00016c40: 6167 652e 5265 7361 6d70 6c69 6e67 2e4c  age.Resampling.L
-00016c50: 414e 435a 4f53 290a 2020 2020 2020 2020  ANCZOS).        
-00016c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016c70: 696d 792e 7361 7665 2879 7363 616c 656e  imy.save(yscalen
-00016c80: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
-00016c90: 2020 2020 2020 2020 2023 2069 6d79 203d           # imy =
-00016ca0: 2049 6d61 6765 2e66 726f 6d61 7272 6179   Image.fromarray
-00016cb0: 2879 726f 7461 7465 292e 7265 7369 7a65  (yrotate).resize
-00016cc0: 2828 3330 302c 2033 3030 2929 0a20 2020  ((300, 300)).   
-00016cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016ce0: 2023 2069 6d79 2e73 6176 6528 7973 6361   # imy.save(ysca
-00016cf0: 6c65 6e61 6d65 290a 2020 2020 2020 2020  lename).        
-00016d00: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00016d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016d20: 2020 6966 2077 6964 7468 203e 3d20 6865    if width >= he
-00016d30: 6967 6874 3a0a 2020 2020 2020 2020 2020  ight:.          
-00016d40: 2020 2020 2020 2020 2020 2020 2020 7363                sc
-00016d50: 616c 6572 203d 2033 3030 2e20 2f20 7769  aler = 300. / wi
-00016d60: 6474 680a 2020 2020 2020 2020 2020 2020  dth.            
-00016d70: 2020 2020 2020 2020 2020 2020 6e65 7768              newh
-00016d80: 6569 6768 7420 3d20 696e 7428 6365 696c  eight = int(ceil
-00016d90: 2873 6361 6c65 7220 2a20 6865 6967 6874  (scaler * height
-00016da0: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-00016db0: 2020 2020 2020 2020 2020 2069 6d79 203d             imy =
-00016dc0: 2049 6d61 6765 2e66 726f 6d61 7272 6179   Image.fromarray
-00016dd0: 2879 726f 7461 7465 292e 7265 7369 7a65  (yrotate).resize
-00016de0: 2828 3330 302c 206e 6577 6865 6967 6874  ((300, newheight
-00016df0: 292c 2049 6d61 6765 2e52 6573 616d 706c  ), Image.Resampl
-00016e00: 696e 672e 4c41 4e43 5a4f 5329 0a20 2020  ing.LANCZOS).   
-00016e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016e20: 2020 2020 2069 6d79 2e73 6176 6528 7973       imy.save(ys
-00016e30: 6361 6c65 6e61 6d65 290a 2020 2020 2020  calename).      
-00016e40: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00016e50: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00016e60: 2020 2020 2020 2020 2020 2020 7363 616c              scal
-00016e70: 6572 203d 2033 3030 2e20 2f20 6865 6967  er = 300. / heig
-00016e80: 6874 0a20 2020 2020 2020 2020 2020 2020  ht.             
-00016e90: 2020 2020 2020 2020 2020 206e 6577 7769             newwi
-00016ea0: 6474 6820 3d20 696e 7428 6365 696c 2873  dth = int(ceil(s
-00016eb0: 6361 6c65 7220 2a20 7769 6474 6829 290a  caler * width)).
-00016ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016ed0: 2020 2020 2020 2020 696d 7920 3d20 496d          imy = Im
-00016ee0: 6167 652e 6672 6f6d 6172 7261 7928 7972  age.fromarray(yr
-00016ef0: 6f74 6174 6529 2e72 6573 697a 6528 286e  otate).resize((n
-00016f00: 6577 7769 6474 682c 2033 3030 292c 2049  ewwidth, 300), I
-00016f10: 6d61 6765 2e52 6573 616d 706c 696e 672e  mage.Resampling.
-00016f20: 4c41 4e43 5a4f 5329 0a20 2020 2020 2020  LANCZOS).       
-00016f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016f40: 2069 6d79 2e73 6176 6528 7973 6361 6c65   imy.save(yscale
-00016f50: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
-00016f60: 2020 6578 6365 7074 3a0a 2020 2020 2020    except:.      
-00016f70: 2020 2020 2020 2020 2020 7965 7272 203d            yerr =
-00016f80: 2027 5361 7669 6e67 2073 6361 6c65 6420   'Saving scaled 
-00016f90: 7920 6365 6e74 7261 6c20 736c 6963 6520  y central slice 
-00016fa0: 6f66 206d 6173 6b20 6572 723a 7b7d 272e  of mask err:{}'.
-00016fb0: 666f 726d 6174 2873 7973 2e65 7863 5f69  format(sys.exc_i
-00016fc0: 6e66 6f28 295b 315d 290a 2020 2020 2020  nfo()[1]).      
-00016fd0: 2020 2020 2020 2020 2020 6572 726c 6973            errlis
-00016fe0: 742e 6170 7065 6e64 2879 6572 7229 0a20  t.append(yerr). 
-00016ff0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00017000: 7973 2e73 7464 6572 722e 7772 6974 6528  ys.stderr.write(
-00017010: 7965 7272 202b 2027 5c6e 2729 0a0a 2020  yerr + '\n')..  
-00017020: 2020 2020 2020 2020 2020 2320 7a63 656e            # zcen
-00017030: 7472 616c 203d 206d 6170 2e66 756c 6c4d  tral = map.fullM
-00017040: 6170 5b7a 6d69 642c 203a 2c20 3a5d 0a20  ap[zmid, :, :]. 
-00017050: 2020 2020 2020 2020 2020 207a 6365 6e74             zcent
-00017060: 7261 6c20 3d20 6d61 702e 6461 7461 5b7a  ral = map.data[z
-00017070: 6d69 642c 203a 2c20 3a5d 0a20 2020 2020  mid, :, :].     
-00017080: 2020 2020 2020 207a 6465 6e6f 6d20 3d20         zdenom = 
-00017090: 287a 6365 6e74 7261 6c2e 6d61 7828 2920  (zcentral.max() 
-000170a0: 2d20 7a63 656e 7472 616c 2e6d 696e 2829  - zcentral.min()
-000170b0: 2920 6966 207a 6365 6e74 7261 6c2e 6d61  ) if zcentral.ma
-000170c0: 7828 2920 213d 207a 6365 6e74 7261 6c2e  x() != zcentral.
-000170d0: 6d69 6e28 2920 656c 7365 2031 0a20 2020  min() else 1.   
-000170e0: 2020 2020 2020 2020 207a 7265 7363 616c           zrescal
-000170f0: 6564 203d 2028 2828 7a63 656e 7472 616c  ed = (((zcentral
-00017100: 202d 207a 6365 6e74 7261 6c2e 6d69 6e28   - zcentral.min(
-00017110: 2929 202a 2032 3535 2e30 2920 2f20 7a64  )) * 255.0) / zd
-00017120: 656e 6f6d 292e 6173 7479 7065 2827 7569  enom).astype('ui
-00017130: 6e74 3827 290a 2020 2020 2020 2020 2020  nt8').          
-00017140: 2020 7a66 6c69 7070 6564 203d 206e 702e    zflipped = np.
-00017150: 666c 6970 7564 287a 7265 7363 616c 6564  flipud(zrescaled
-00017160: 290a 2020 2020 2020 2020 2020 2020 7a69  ).            zi
-00017170: 6d67 203d 2049 6d61 6765 2e66 726f 6d61  mg = Image.froma
-00017180: 7272 6179 287a 666c 6970 7065 6429 0a20  rray(zflipped). 
-00017190: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-000171a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000171b0: 7a69 6d67 2e73 6176 6528 7365 6c66 2e77  zimg.save(self.w
-000171c0: 6f72 6b64 6972 202b 206d 6170 6e61 6d65  orkdir + mapname
-000171d0: 202b 2027 5f7a 6d61 736b 6365 6e74 7261   + '_zmaskcentra
-000171e0: 6c5f 736c 6963 652e 6a70 6567 2729 0a20  l_slice.jpeg'). 
-000171f0: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-00017200: 7420 494f 4572 726f 7220 6173 2069 6f65  t IOError as ioe
-00017210: 7272 3a0a 2020 2020 2020 2020 2020 2020  rr:.            
-00017220: 2020 2020 7a65 7272 203d 2027 5361 7669      zerr = 'Savi
-00017230: 6e67 206f 7269 6769 6e61 6c20 7a20 6365  ng original z ce
-00017240: 6e74 7261 6c20 736c 6963 6520 6f66 206d  ntral slice of m
-00017250: 6173 6b20 6572 723a 7b7d 272e 666f 726d  ask err:{}'.form
-00017260: 6174 2869 6f65 7272 290a 2020 2020 2020  at(ioerr).      
-00017270: 2020 2020 2020 2020 2020 6572 726c 6973            errlis
-00017280: 742e 6170 7065 6e64 287a 6572 7229 0a20  t.append(zerr). 
-00017290: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000172a0: 7973 2e73 7464 6572 722e 7772 6974 6528  ys.stderr.write(
-000172b0: 7a65 7272 202b 2027 5c6e 2729 0a0a 2020  zerr + '\n')..  
-000172c0: 2020 2020 2020 2020 2020 7769 6474 682c            width,
-000172d0: 2068 6569 6768 7420 3d20 7a69 6d67 2e73   height = zimg.s
-000172e0: 697a 650a 2020 2020 2020 2020 2020 2020  ize.            
-000172f0: 7a73 6361 6c65 6e61 6d65 203d 2073 656c  zscalename = sel
-00017300: 662e 776f 726b 6469 7220 2b20 6d61 706e  f.workdir + mapn
-00017310: 616d 6520 2b20 275f 7363 616c 6564 5f7a  ame + '_scaled_z
-00017320: 6d61 736b 6365 6e74 7261 6c5f 736c 6963  maskcentral_slic
-00017330: 652e 6a70 6567 270a 2020 2020 2020 2020  e.jpeg'.        
-00017340: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00017350: 2020 2020 2020 2020 2069 6620 7769 6474           if widt
-00017360: 6820 3e20 3330 3020 616e 6420 6865 6967  h > 300 and heig
-00017370: 6874 203e 2033 3030 3a0a 2020 2020 2020  ht > 300:.      
-00017380: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00017390: 2077 6964 7468 203e 3d20 6865 6967 6874   width >= height
-000173a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000173b0: 2020 2020 2020 2020 2020 6c61 7267 6572            larger
-000173c0: 7363 616c 6572 203d 2033 3030 2e20 2f20  scaler = 300. / 
-000173d0: 7769 6474 680a 2020 2020 2020 2020 2020  width.          
-000173e0: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
-000173f0: 7768 6569 6768 7420 3d20 696e 7428 6365  wheight = int(ce
-00017400: 696c 286c 6172 6765 7273 6361 6c65 7220  il(largerscaler 
-00017410: 2a20 6865 6967 6874 2929 0a20 2020 2020  * height)).     
-00017420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017430: 2020 2069 6d7a 203d 2049 6d61 6765 2e66     imz = Image.f
-00017440: 726f 6d61 7272 6179 287a 666c 6970 7065  romarray(zflippe
-00017450: 6429 2e72 6573 697a 6528 2833 3030 2c20  d).resize((300, 
-00017460: 6e65 7768 6569 6768 7429 2c20 496d 6167  newheight), Imag
-00017470: 652e 5265 7361 6d70 6c69 6e67 2e4c 414e  e.Resampling.LAN
-00017480: 435a 4f53 290a 2020 2020 2020 2020 2020  CZOS).          
-00017490: 2020 2020 2020 2020 2020 2020 2020 696d                im
-000174a0: 7a2e 7361 7665 287a 7363 616c 656e 616d  z.save(zscalenam
-000174b0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-000174c0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000174d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000174e0: 2020 2020 206c 6172 6765 7273 6361 6c65       largerscale
-000174f0: 7220 3d20 3330 302e 202f 2068 6569 6768  r = 300. / heigh
-00017500: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
-00017510: 2020 2020 2020 2020 2020 6e65 7777 6964            newwid
-00017520: 7468 203d 2069 6e74 2863 6569 6c28 6c61  th = int(ceil(la
-00017530: 7267 6572 7363 616c 6572 202a 2077 6964  rgerscaler * wid
-00017540: 7468 2929 0a20 2020 2020 2020 2020 2020  th)).           
-00017550: 2020 2020 2020 2020 2020 2020 2069 6d7a               imz
-00017560: 203d 2049 6d61 6765 2e66 726f 6d61 7272   = Image.fromarr
-00017570: 6179 287a 666c 6970 7065 6429 2e72 6573  ay(zflipped).res
-00017580: 697a 6528 286e 6577 7769 6474 682c 2033  ize((newwidth, 3
-00017590: 3030 292c 2049 6d61 6765 2e52 6573 616d  00), Image.Resam
-000175a0: 706c 696e 672e 4c41 4e43 5a4f 5329 0a20  pling.LANCZOS). 
-000175b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000175c0: 2020 2020 2020 2069 6d7a 2e73 6176 6528         imz.save(
-000175d0: 7a73 6361 6c65 6e61 6d65 290a 2020 2020  zscalename).    
-000175e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000175f0: 2320 696d 7a20 3d20 496d 6167 652e 6672  # imz = Image.fr
-00017600: 6f6d 6172 7261 7928 7a66 6c69 7070 6564  omarray(zflipped
-00017610: 292e 7265 7369 7a65 2828 3330 302c 2033  ).resize((300, 3
-00017620: 3030 2929 0a20 2020 2020 2020 2020 2020  00)).           
-00017630: 2020 2020 2020 2020 2023 2069 6d7a 2e73           # imz.s
-00017640: 6176 6528 7a73 6361 6c65 6e61 6d65 290a  ave(zscalename).
-00017650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017660: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00017670: 2020 2020 2020 2020 2020 6966 2077 6964            if wid
-00017680: 7468 203e 3d20 6865 6967 6874 3a0a 2020  th >= height:.  
-00017690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000176a0: 2020 2020 2020 7363 616c 6572 203d 2033        scaler = 3
-000176b0: 3030 2e20 2f20 7769 6474 680a 2020 2020  00. / width.    
-000176c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000176d0: 2020 2020 6e65 7768 6569 6768 7420 3d20      newheight = 
-000176e0: 696e 7428 6365 696c 2873 6361 6c65 7220  int(ceil(scaler 
-000176f0: 2a20 6865 6967 6874 2929 0a20 2020 2020  * height)).     
-00017700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017710: 2020 2069 6d7a 203d 2049 6d61 6765 2e66     imz = Image.f
-00017720: 726f 6d61 7272 6179 287a 666c 6970 7065  romarray(zflippe
-00017730: 6429 2e72 6573 697a 6528 2833 3030 2c20  d).resize((300, 
-00017740: 6e65 7768 6569 6768 7429 2c20 496d 6167  newheight), Imag
-00017750: 652e 5265 7361 6d70 6c69 6e67 2e4c 414e  e.Resampling.LAN
-00017760: 435a 4f53 290a 2020 2020 2020 2020 2020  CZOS).          
-00017770: 2020 2020 2020 2020 2020 2020 2020 696d                im
-00017780: 7a2e 7361 7665 287a 7363 616c 656e 616d  z.save(zscalenam
-00017790: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-000177a0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000177b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000177c0: 2020 2020 2073 6361 6c65 7220 3d20 3330       scaler = 30
-000177d0: 302e 202f 2068 6569 6768 740a 2020 2020  0. / height.    
-000177e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000177f0: 2020 2020 6e65 7777 6964 7468 203d 2069      newwidth = i
-00017800: 6e74 2863 6569 6c28 7363 616c 6572 202a  nt(ceil(scaler *
-00017810: 2077 6964 7468 2929 0a20 2020 2020 2020   width)).       
-00017820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017830: 2069 6d7a 203d 2049 6d61 6765 2e66 726f   imz = Image.fro
-00017840: 6d61 7272 6179 287a 666c 6970 7065 6429  marray(zflipped)
-00017850: 2e72 6573 697a 6528 286e 6577 7769 6474  .resize((newwidt
-00017860: 682c 2033 3030 292c 2049 6d61 6765 2e52  h, 300), Image.R
-00017870: 6573 616d 706c 696e 672e 4c41 4e43 5a4f  esampling.LANCZO
-00017880: 5329 0a20 2020 2020 2020 2020 2020 2020  S).             
-00017890: 2020 2020 2020 2020 2020 2069 6d7a 2e73             imz.s
-000178a0: 6176 6528 7a73 6361 6c65 6e61 6d65 290a  ave(zscalename).
-000178b0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-000178c0: 7074 3a0a 2020 2020 2020 2020 2020 2020  pt:.            
-000178d0: 2020 2020 7a65 7272 203d 2027 5361 7669      zerr = 'Savi
-000178e0: 6e67 206f 7269 6769 6e61 6c20 7a20 7363  ng original z sc
-000178f0: 616c 6564 2063 656e 7472 616c 2073 6c69  aled central sli
-00017900: 6365 206f 6620 6d61 736b 2065 7272 3a7b  ce of mask err:{
-00017910: 7d27 2e66 6f72 6d61 7428 7379 732e 6578  }'.format(sys.ex
-00017920: 635f 696e 666f 2829 5b31 5d29 0a20 2020  c_info()[1]).   
-00017930: 2020 2020 2020 2020 2020 2020 2065 7272               err
-00017940: 6c69 7374 2e61 7070 656e 6428 7a65 7272  list.append(zerr
-00017950: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00017960: 2020 7379 732e 7374 6465 7272 2e77 7269    sys.stderr.wri
-00017970: 7465 287a 6572 7220 2b20 275c 6e27 290a  te(zerr + '\n').
-00017980: 0a20 2020 2020 2020 2020 2020 2063 736c  .            csl
-00017990: 6963 656a 736f 6e20 3d20 6469 6374 2829  icejson = dict()
-000179a0: 0a20 2020 2020 2020 2020 2020 2063 736c  .            csl
-000179b0: 6963 656a 736f 6e5b 2778 275d 203d 206f  icejson['x'] = o
-000179c0: 732e 7061 7468 2e62 6173 656e 616d 6528  s.path.basename(
-000179d0: 7873 6361 6c65 6e61 6d65 2920 6966 206f  xscalename) if o
-000179e0: 732e 7061 7468 2e69 7366 696c 6528 7873  s.path.isfile(xs
-000179f0: 6361 6c65 6e61 6d65 2920 656c 7365 204e  calename) else N
-00017a00: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
-00017a10: 6373 6c69 6365 6a73 6f6e 5b27 7927 5d20  cslicejson['y'] 
-00017a20: 3d20 6f73 2e70 6174 682e 6261 7365 6e61  = os.path.basena
-00017a30: 6d65 2879 7363 616c 656e 616d 6529 2069  me(yscalename) i
-00017a40: 6620 6f73 2e70 6174 682e 6973 6669 6c65  f os.path.isfile
-00017a50: 2879 7363 616c 656e 616d 6529 2065 6c73  (yscalename) els
-00017a60: 6520 4e6f 6e65 0a20 2020 2020 2020 2020  e None.         
-00017a70: 2020 2063 736c 6963 656a 736f 6e5b 277a     cslicejson['z
-00017a80: 275d 203d 206f 732e 7061 7468 2e62 6173  '] = os.path.bas
-00017a90: 656e 616d 6528 7a73 6361 6c65 6e61 6d65  ename(zscalename
-00017aa0: 2920 6966 206f 732e 7061 7468 2e69 7366  ) if os.path.isf
-00017ab0: 696c 6528 7a73 6361 6c65 6e61 6d65 2920  ile(zscalename) 
-00017ac0: 656c 7365 204e 6f6e 650a 0a20 2020 2020  else None..     
-00017ad0: 2020 2020 2020 2061 6c6c 6d61 736b 6469         allmaskdi
-00017ae0: 6374 5b6d 6170 6e61 6d65 5d20 3d20 6373  ct[mapname] = cs
-00017af0: 6c69 6365 6a73 6f6e 0a0a 2020 2020 2020  licejson..      
-00017b00: 2020 6966 2065 7272 6c69 7374 3a0a 2020    if errlist:.  
-00017b10: 2020 2020 2020 2020 2020 616c 6c6d 6173            allmas
-00017b20: 6b64 6963 745b 2765 7272 275d 203d 207b  kdict['err'] = {
-00017b30: 276d 6173 6b5f 6365 6e74 7261 6c5f 736c  'mask_central_sl
-00017b40: 6963 655f 6572 7227 3a20 6572 726c 6973  ice_err': errlis
-00017b50: 747d 0a20 2020 2020 2020 2066 696e 616c  t}.        final
-00017b60: 6469 6374 203d 207b 276d 6173 6b5f 6365  dict = {'mask_ce
-00017b70: 6e74 7261 6c5f 736c 6963 6527 3a20 616c  ntral_slice': al
-00017b80: 6c6d 6173 6b64 6963 747d 0a0a 2020 2020  lmaskdict}..    
-00017b90: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00017ba0: 2020 2020 2077 6974 6820 636f 6465 6373       with codecs
-00017bb0: 2e6f 7065 6e28 7365 6c66 2e77 6f72 6b64  .open(self.workd
-00017bc0: 6972 202b 2073 656c 662e 6d61 706e 616d  ir + self.mapnam
-00017bd0: 6520 2b20 275f 6d61 736b 6365 6e74 7261  e + '_maskcentra
-00017be0: 6c73 6c69 6365 2e6a 736f 6e27 2c20 2777  lslice.json', 'w
-00017bf0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+000104c0: 2020 2320 4368 616e 6765 2074 6865 2076    # Change the v
+000104d0: 6965 7720 6261 636b 0a20 2020 2020 2020  iew back.       
+000104e0: 2020 2020 2020 2020 2020 2020 2061 6374               act
+000104f0: 6f72 2e52 6f74 6174 6558 282d 3930 290a  or.RotateX(-90).
+00010500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010510: 2020 2020 6163 746f 722e 526f 7461 7465      actor.Rotate
+00010520: 5a28 2d39 3029 0a20 2020 2020 2020 2020  Z(-90).         
+00010530: 2020 2020 2020 2020 2020 2061 6374 6f72             actor
+00010540: 2e52 6f74 6174 6559 282d 3930 290a 2020  .RotateY(-90).  
+00010550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010560: 2020 6163 746f 722e 526f 7461 7465 5828    actor.RotateX(
+00010570: 2d39 3029 0a20 2020 2020 2020 2020 2020  -90).           
+00010580: 2020 2020 2020 2020 2072 656e 2e52 6573           ren.Res
+00010590: 6574 4361 6d65 7261 2829 0a0a 2020 2020  etCamera()..    
+000105a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000105b0: 6163 746f 722e 4765 7450 726f 7065 7274  actor.GetPropert
+000105c0: 7928 292e 5365 744f 7061 6369 7479 2830  y().SetOpacity(0
+000105d0: 2e35 290a 2020 2020 2020 2020 2020 2020  .5).            
+000105e0: 2020 2020 2020 2020 7064 625f 7265 6164          pdb_read
+000105f0: 6572 203d 2076 746b 2e76 746b 5044 4252  er = vtk.vtkPDBR
+00010600: 6561 6465 7228 290a 2020 2020 2020 2020  eader().        
+00010610: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
+00010620: 6c5f 6d61 7070 6572 203d 2076 746b 2e76  l_mapper = vtk.v
+00010630: 746b 506f 6c79 4461 7461 4d61 7070 6572  tkPolyDataMapper
+00010640: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+00010650: 2020 2020 2020 206d 6f64 656c 5f61 6374         model_act
+00010660: 6f72 203d 2076 746b 2e76 746b 4163 746f  or = vtk.vtkActo
+00010670: 7228 290a 2020 2020 2020 2020 2020 2020  r().            
+00010680: 2020 2020 2020 2020 6d6f 6465 6c5f 6163          model_ac
+00010690: 746f 722e 4765 7450 726f 7065 7274 7928  tor.GetProperty(
+000106a0: 292e 5365 744c 696e 6557 6964 7468 2836  ).SetLineWidth(6
+000106b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000106c0: 2020 2020 2020 7064 625f 7265 6164 6572        pdb_reader
+000106d0: 2e53 6574 4669 6c65 4e61 6d65 286d 6f64  .SetFileName(mod
+000106e0: 656c 290a 0a20 2020 2020 2020 2020 2020  el)..           
+000106f0: 2020 2020 2020 2020 2023 2054 6573 7420           # Test 
+00010700: 6f66 2062 6163 6b62 6f6e 6520 7374 7275  of backbone stru
+00010710: 6374 7572 650a 2020 2020 2020 2020 2020  cture.          
+00010720: 2020 2020 2020 2020 2020 2320 7365 7475            # setu
+00010730: 7020 7269 6262 6f6e 2066 696c 7465 720a  p ribbon filter.
+00010740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010750: 2020 2020 7269 6262 6f6e 4669 6c74 6572      ribbonFilter
+00010760: 203d 2076 746b 2e76 746b 5072 6f74 6569   = vtk.vtkProtei
+00010770: 6e52 6962 626f 6e46 696c 7465 7228 290a  nRibbonFilter().
+00010780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010790: 2020 2020 7269 6262 6f6e 4669 6c74 6572      ribbonFilter
+000107a0: 2e53 6574 496e 7075 7443 6f6e 6e65 6374  .SetInputConnect
+000107b0: 696f 6e28 7064 625f 7265 6164 6572 2e47  ion(pdb_reader.G
+000107c0: 6574 4f75 7470 7574 506f 7274 2829 290a  etOutputPort()).
+000107d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000107e0: 2020 2020 7269 6262 6f6e 4669 6c74 6572      ribbonFilter
+000107f0: 2e55 7064 6174 6528 290a 2020 2020 2020  .Update().      
+00010800: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
+00010810: 6465 6c5f 6d61 7070 6572 2e53 6574 496e  del_mapper.SetIn
+00010820: 7075 7444 6174 6128 7269 6262 6f6e 4669  putData(ribbonFi
+00010830: 6c74 6572 2e47 6574 4f75 7470 7574 2829  lter.GetOutput()
+00010840: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00010850: 2020 2020 2020 6d6f 6465 6c5f 6d61 7070        model_mapp
+00010860: 6572 2e55 7064 6174 6528 290a 0a0a 2020  er.Update()...  
+00010870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010880: 2020 2320 6d6f 6465 6c5f 6d61 7070 6572    # model_mapper
+00010890: 2e53 6574 496e 7075 7443 6f6e 6e65 6374  .SetInputConnect
+000108a0: 696f 6e28 7064 625f 7265 6164 6572 2e47  ion(pdb_reader.G
+000108b0: 6574 4f75 7470 7574 506f 7274 2829 290a  etOutputPort()).
+000108c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000108d0: 2020 2020 6d6f 6465 6c5f 6163 746f 722e      model_actor.
+000108e0: 5365 744d 6170 7065 7228 6d6f 6465 6c5f  SetMapper(model_
+000108f0: 6d61 7070 6572 290a 2020 2020 2020 2020  mapper).        
+00010900: 2020 2020 2020 2020 2020 2020 7265 6e2e              ren.
+00010910: 4164 6441 6374 6f72 286d 6f64 656c 5f61  AddActor(model_a
+00010920: 6374 6f72 290a 2020 2020 2020 2020 2020  ctor).          
+00010930: 2020 2020 2020 2020 2020 7265 6e2e 5265            ren.Re
+00010940: 7365 7443 616d 6572 6128 290a 2020 2020  setCamera().    
+00010950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010960: 7265 6e2e 4765 7441 6374 6976 6543 616d  ren.GetActiveCam
+00010970: 6572 6128 292e 5a6f 6f6d 2831 2e33 3029  era().Zoom(1.30)
+00010980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010990: 2020 2020 2072 656e 5769 6e2e 5265 6e64       renWin.Rend
+000109a0: 6572 2829 0a0a 2020 2020 2020 2020 2020  er()..          
+000109b0: 2020 2020 2020 2020 2020 2320 4f75 7470            # Outp
+000109c0: 7574 206d 6f64 656c 2061 6e64 206d 6170  ut model and map
+000109d0: 7320 6f76 6572 6c61 7920 696d 6167 6573  s overlay images
+000109e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000109f0: 2020 2020 206f 7574 7a69 6d61 6765 203d       outzimage =
+00010a00: 2027 7b7d 7b7d 5f65 6d64 5f7b 7d5f 7a73   '{}{}_emd_{}_zs
+00010a10: 7572 6661 6365 2e6a 7065 6727 2e66 6f72  urface.jpeg'.for
+00010a20: 6d61 7428 7365 6c66 2e77 6f72 6b64 6972  mat(self.workdir
+00010a30: 2c20 7064 6269 642c 2073 656c 662e 656d  , pdbid, self.em
+00010a40: 6469 6429 0a20 2020 2020 2020 2020 2020  did).           
+00010a50: 2020 2020 2020 2020 2073 656c 662e 7772           self.wr
+00010a60: 6974 655f 696d 6167 6528 6f75 747a 696d  ite_image(outzim
+00010a70: 6167 652c 2072 656e 5769 6e29 0a0a 2020  age, renWin)..  
+00010a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010a90: 2020 6163 746f 722e 526f 7461 7465 5828    actor.RotateX(
+00010aa0: 3930 290a 2020 2020 2020 2020 2020 2020  90).            
+00010ab0: 2020 2020 2020 2020 6163 746f 722e 526f          actor.Ro
+00010ac0: 7461 7465 5928 3930 290a 2020 2020 2020  tateY(90).      
+00010ad0: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
+00010ae0: 6465 6c5f 6163 746f 722e 526f 7461 7465  del_actor.Rotate
+00010af0: 5828 3930 290a 2020 2020 2020 2020 2020  X(90).          
+00010b00: 2020 2020 2020 2020 2020 6d6f 6465 6c5f            model_
+00010b10: 6163 746f 722e 526f 7461 7465 5928 3930  actor.RotateY(90
+00010b20: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00010b30: 2020 2020 2020 2320 7265 6e2e 5265 7365        # ren.Rese
+00010b40: 7443 616d 6572 6128 290a 2020 2020 2020  tCamera().      
+00010b50: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
+00010b60: 7479 696d 6167 6520 3d20 277b 7d7b 7d5f  tyimage = '{}{}_
+00010b70: 656d 645f 7b7d 5f79 7375 7266 6163 652e  emd_{}_ysurface.
+00010b80: 6a70 6567 272e 666f 726d 6174 2873 656c  jpeg'.format(sel
+00010b90: 662e 776f 726b 6469 722c 2070 6462 6964  f.workdir, pdbid
+00010ba0: 2c20 7365 6c66 2e65 6d64 6964 290a 2020  , self.emdid).  
+00010bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010bc0: 2020 7365 6c66 2e77 7269 7465 5f69 6d61    self.write_ima
+00010bd0: 6765 286f 7574 7969 6d61 6765 2c20 7265  ge(outyimage, re
+00010be0: 6e57 696e 290a 0a20 2020 2020 2020 2020  nWin)..         
+00010bf0: 2020 2020 2020 2020 2020 2061 6374 6f72             actor
+00010c00: 2e52 6f74 6174 655a 2839 3029 0a20 2020  .RotateZ(90).   
+00010c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010c20: 2061 6374 6f72 2e52 6f74 6174 6558 2839   actor.RotateX(9
+00010c30: 3029 0a20 2020 2020 2020 2020 2020 2020  0).             
+00010c40: 2020 2020 2020 206d 6f64 656c 5f61 6374         model_act
+00010c50: 6f72 2e52 6f74 6174 655a 2839 3029 0a20  or.RotateZ(90). 
+00010c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010c70: 2020 206d 6f64 656c 5f61 6374 6f72 2e52     model_actor.R
+00010c80: 6f74 6174 6558 2839 3029 0a20 2020 2020  otateX(90).     
+00010c90: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00010ca0: 2072 656e 2e52 6573 6574 4361 6d65 7261   ren.ResetCamera
+00010cb0: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+00010cc0: 2020 2020 2020 206f 7574 7869 6d61 6765         outximage
+00010cd0: 203d 2027 7b7d 7b7d 5f65 6d64 5f7b 7d5f   = '{}{}_emd_{}_
+00010ce0: 7873 7572 6661 6365 2e6a 7065 6727 2e66  xsurface.jpeg'.f
+00010cf0: 6f72 6d61 7428 7365 6c66 2e77 6f72 6b64  ormat(self.workd
+00010d00: 6972 2c20 7064 6269 642c 2073 656c 662e  ir, pdbid, self.
+00010d10: 656d 6469 6429 0a20 2020 2020 2020 2020  emdid).         
+00010d20: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00010d30: 7772 6974 655f 696d 6167 6528 6f75 7478  write_image(outx
+00010d40: 696d 6167 652c 2072 656e 5769 6e29 0a20  image, renWin). 
+00010d50: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+00010d60: 2827 5375 7266 6163 6520 7669 6577 7320  ('Surface views 
+00010d70: 7765 7265 2067 656e 6572 6174 6564 2062  were generated b
+00010d80: 7920 5654 4b20 6d65 7468 6f64 2e27 290a  y VTK method.').
+00010d90: 0a20 2020 2020 2020 2020 2020 2023 2065  .            # e
+00010da0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00010db0: 2023 2020 2020 2320 4f75 7075 7420 6d61   #    # Ouput ma
+00010dc0: 7073 2069 6d61 6765 7320 6f6e 6c79 0a20  ps images only. 
+00010dd0: 2020 2020 2020 2020 2020 2023 2020 2020             #    
+00010de0: 7265 6e2e 5265 7365 7443 616d 6572 6128  ren.ResetCamera(
+00010df0: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
+00010e00: 2020 2072 656e 2e47 6574 4163 7469 7665     ren.GetActive
+00010e10: 4361 6d65 7261 2829 2e5a 6f6f 6d28 302e  Camera().Zoom(0.
+00010e20: 3535 290a 2020 2020 2020 2020 2020 2020  55).            
+00010e30: 2320 2020 206f 7574 7a69 6d61 6765 203d  #    outzimage =
+00010e40: 2027 7b7d 7b7d 5f65 6d64 5f7b 7d5f 7a73   '{}{}_emd_{}_zs
+00010e50: 7572 6661 6365 2e6a 7065 6727 2e66 6f72  urface.jpeg'.for
+00010e60: 6d61 7428 7365 6c66 2e77 6f72 6b64 6972  mat(self.workdir
+00010e70: 2c20 7064 6269 642c 2073 656c 662e 656d  , pdbid, self.em
+00010e80: 6469 6420 290a 2020 2020 2020 2020 2020  did ).          
+00010e90: 2020 2320 2020 2077 7269 7465 5f69 6d61    #    write_ima
+00010ea0: 6765 286f 7574 7a69 6d61 6765 2c20 7265  ge(outzimage, re
+00010eb0: 6e57 696e 290a 0a20 2020 2020 2020 2020  nWin)..         
+00010ec0: 2020 2023 2020 2020 6163 746f 722e 526f     #    actor.Ro
+00010ed0: 7461 7465 5828 3930 290a 2020 2020 2020  tateX(90).      
+00010ee0: 2020 2020 2020 2320 2020 2061 6374 6f72        #    actor
+00010ef0: 2e52 6f74 6174 6559 2839 3029 0a20 2020  .RotateY(90).   
+00010f00: 2020 2020 2020 2020 2023 2020 2020 2372           #    #r
+00010f10: 656e 2e52 6573 6574 4361 6d65 7261 2829  en.ResetCamera()
+00010f20: 0a20 2020 2020 2020 2020 2020 2023 2020  .            #  
+00010f30: 2020 6f75 7479 696d 6167 6520 3d20 277b    outyimage = '{
+00010f40: 7d7b 7d5f 656d 645f 7b7d 5f79 7375 7266  }{}_emd_{}_ysurf
+00010f50: 6163 652e 6a70 6567 272e 666f 726d 6174  ace.jpeg'.format
+00010f60: 2873 656c 662e 776f 726b 6469 722c 2070  (self.workdir, p
+00010f70: 6462 6964 2c20 7365 6c66 2e65 6d64 6964  dbid, self.emdid
+00010f80: 2029 0a20 2020 2020 2020 2020 2020 2023   ).            #
+00010f90: 2020 2020 7365 6c66 2e77 7269 7465 5f69      self.write_i
+00010fa0: 6d61 6765 286f 7574 7969 6d61 6765 2c20  mage(outyimage, 
+00010fb0: 7265 6e57 696e 290a 0a20 2020 2020 2020  renWin)..       
+00010fc0: 2020 2020 2023 2020 2020 6163 746f 722e       #    actor.
+00010fd0: 526f 7461 7465 5a28 3930 290a 2020 2020  RotateZ(90).    
+00010fe0: 2020 2020 2020 2020 2320 2020 2061 6374          #    act
+00010ff0: 6f72 2e52 6f74 6174 6558 2839 3029 0a20  or.RotateX(90). 
+00011000: 2020 2020 2020 2020 2020 2023 2020 2020             #    
+00011010: 2372 656e 2e52 6573 6574 4361 6d65 7261  #ren.ResetCamera
+00011020: 2829 0a20 2020 2020 2020 2020 2020 2023  ().            #
+00011030: 2020 2020 6f75 7478 696d 6167 6520 3d20      outximage = 
+00011040: 277b 7d7b 7d5f 656d 645f 7b7d 5f78 7375  '{}{}_emd_{}_xsu
+00011050: 7266 6163 652e 6a70 6567 272e 666f 726d  rface.jpeg'.form
+00011060: 6174 2873 656c 662e 776f 726b 6469 722c  at(self.workdir,
+00011070: 2070 6462 6964 2c20 7365 6c66 2e65 6d64   pdbid, self.emd
+00011080: 6964 2029 0a20 2020 2020 2020 2020 2020  id ).           
+00011090: 2023 2020 2020 7365 6c66 2e77 7269 7465   #    self.write
+000110a0: 5f69 6d61 6765 286f 7574 7869 6d61 6765  _image(outximage
+000110b0: 2c20 7265 6e57 696e 290a 0a20 2020 2020  , renWin)..     
+000110c0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000110d0: 2020 2020 2069 6620 7365 6c66 2e6d 6170       if self.map
+000110e0: 2069 7320 6e6f 7420 4e6f 6e65 2061 6e64   is not None and
+000110f0: 2073 656c 662e 636c 2069 7320 6e6f 7420   self.cl is not 
+00011100: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00011110: 2020 2020 2020 6368 6563 6b76 7470 7265        checkvtpre
+00011120: 7375 6c74 203d 2073 656c 662e 6368 6563  sult = self.chec
+00011130: 6b76 7470 2829 0a20 2020 2020 2020 2020  kvtp().         
+00011140: 2020 2020 2020 2069 6620 6368 6563 6b76         if checkv
+00011150: 7470 7265 7375 6c74 3a0a 2020 2020 2020  tpresult:.      
+00011160: 2020 2020 2020 2020 2020 2020 2020 7674                vt
+00011170: 7046 696c 6520 3d20 6368 6563 6b76 7470  pFile = checkvtp
+00011180: 7265 7375 6c74 0a20 2020 2020 2020 2020  result.         
+00011190: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000111a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000111b0: 2023 2046 6972 7374 2066 756e 6374 696f   # First functio
+000111c0: 6e20 6865 7265 2070 726f 6475 6365 2076  n here produce v
+000111d0: 7470 2066 696c 6520 6261 7365 6420 6f6e  tp file based on
+000111e0: 206d 6170 2077 6974 6820 7468 6520 636c   map with the cl
+000111f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011200: 2020 2020 2076 7470 4669 6c65 203d 2073       vtpFile = s
+00011210: 656c 662e 6765 6e76 7470 2873 656c 662e  elf.genvtp(self.
+00011220: 6d61 702e 6669 6c65 6e61 6d65 290a 2020  map.filename).  
+00011230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011240: 2020 7072 696e 7428 2741 2076 7470 2066    print('A vtp f
+00011250: 696c 6520 636f 7272 6573 706f 6e64 2074  ile correspond t
+00011260: 6f20 6465 6e73 6974 7920 6d61 7020 6973  o density map is
+00011270: 2067 656e 6572 6174 6564 2e27 290a 0a20   generated.').. 
+00011280: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00011290: 6163 7447 7261 7068 6963 7320 3d20 7674  actGraphics = vt
+000112a0: 6b2e 7674 6b47 7261 7068 6963 7346 6163  k.vtkGraphicsFac
+000112b0: 746f 7279 2829 0a20 2020 2020 2020 2020  tory().         
+000112c0: 2020 2020 2020 2066 6163 7447 7261 7068         factGraph
+000112d0: 6963 732e 5365 744f 6666 5363 7265 656e  ics.SetOffScreen
+000112e0: 4f6e 6c79 4d6f 6465 2831 293b 0a20 2020  OnlyMode(1);.   
+000112f0: 2020 2020 2020 2020 2020 2020 2066 6163               fac
+00011300: 7447 7261 7068 6963 732e 5365 7455 7365  tGraphics.SetUse
+00011310: 4d65 7361 436c 6173 7365 7328 3129 0a20  MesaClasses(1). 
+00011320: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00011330: 6561 6465 7220 3d20 7674 6b2e 7674 6b58  eader = vtk.vtkX
+00011340: 4d4c 506f 6c79 4461 7461 5265 6164 6572  MLPolyDataReader
+00011350: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+00011360: 2020 2072 6561 6465 722e 5365 7446 696c     reader.SetFil
+00011370: 654e 616d 6528 7674 7046 696c 6529 0a20  eName(vtpFile). 
+00011380: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00011390: 6561 6465 722e 5570 6461 7465 2829 0a0a  eader.Update()..
+000113a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000113b0: 6d61 7070 6572 203d 2076 746b 2e76 746b  mapper = vtk.vtk
+000113c0: 506f 6c79 4461 7461 4d61 7070 6572 2829  PolyDataMapper()
+000113d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000113e0: 206d 6170 7065 722e 5363 616c 6172 5669   mapper.ScalarVi
+000113f0: 7369 6269 6c69 7479 4f66 6628 290a 2020  sibilityOff().  
+00011400: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
+00011410: 7070 6572 2e53 6574 496e 7075 7443 6f6e  pper.SetInputCon
+00011420: 6e65 6374 696f 6e28 7265 6164 6572 2e47  nection(reader.G
+00011430: 6574 4f75 7470 7574 506f 7274 2829 290a  etOutputPort()).
+00011440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011450: 2061 6374 6f72 203d 2076 746b 2e76 746b   actor = vtk.vtk
+00011460: 4163 746f 7228 290a 2020 2020 2020 2020  Actor().        
+00011470: 2020 2020 2020 2020 6163 746f 722e 5365          actor.Se
+00011480: 744d 6170 7065 7228 6d61 7070 6572 290a  tMapper(mapper).
+00011490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000114a0: 6163 746f 722e 4765 7450 726f 7065 7274  actor.GetPropert
+000114b0: 7928 292e 5365 7443 6f6c 6f72 2831 2e30  y().SetColor(1.0
+000114c0: 2c20 302e 382c 2030 2e31 290a 2020 2020  , 0.8, 0.1).    
+000114d0: 2020 2020 2020 2020 2020 2020 6163 746f              acto
+000114e0: 722e 4765 7450 726f 7065 7274 7928 292e  r.GetProperty().
+000114f0: 5365 7449 6e74 6572 706f 6c61 7469 6f6e  SetInterpolation
+00011500: 546f 5068 6f6e 6728 290a 2020 2020 2020  ToPhong().      
+00011510: 2020 2020 2020 2020 2020 6163 746f 722e            actor.
+00011520: 4765 7450 726f 7065 7274 7928 292e 5365  GetProperty().Se
+00011530: 7444 6966 6675 7365 2830 2e39 290a 2020  tDiffuse(0.9).  
+00011540: 2020 2020 2020 2020 2020 2020 2020 6163                ac
+00011550: 746f 722e 4765 7450 726f 7065 7274 7928  tor.GetProperty(
+00011560: 292e 5365 7453 7065 6375 6c61 7228 302e  ).SetSpecular(0.
+00011570: 3629 0a20 2020 2020 2020 2020 2020 2020  6).             
+00011580: 2020 2061 6374 6f72 2e47 6574 5072 6f70     actor.GetProp
+00011590: 6572 7479 2829 2e53 6574 5370 6563 756c  erty().SetSpecul
+000115a0: 6172 506f 7765 7228 3330 290a 2020 2020  arPower(30).    
+000115b0: 2020 2020 2020 2020 2020 2020 6163 746f              acto
+000115c0: 722e 4765 7450 726f 7065 7274 7928 292e  r.GetProperty().
+000115d0: 4261 636b 6661 6365 4375 6c6c 696e 674f  BackfaceCullingO
+000115e0: 6e28 290a 2020 2020 2020 2020 2020 2020  n().            
+000115f0: 2020 2020 6163 746f 722e 4765 7450 726f      actor.GetPro
+00011600: 7065 7274 7928 292e 4672 6f6e 7466 6163  perty().Frontfac
+00011610: 6543 756c 6c69 6e67 4f6e 2829 0a0a 2020  eCullingOn()..  
+00011620: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00011630: 4372 6561 7465 2074 6865 2067 7261 7068  Create the graph
+00011640: 6963 7320 7374 7275 6374 7572 652e 2054  ics structure. T
+00011650: 6865 2072 656e 6465 7265 7220 7265 6e64  he renderer rend
+00011660: 6572 7320 696e 746f 2074 6865 2072 656e  ers into the ren
+00011670: 6465 720a 2020 2020 2020 2020 2020 2020  der.            
+00011680: 2020 2020 2320 7769 6e64 6f77 2e20 5468      # window. Th
+00011690: 6520 7265 6e64 6572 2077 696e 646f 7720  e render window 
+000116a0: 696e 7465 7261 6374 6f72 2063 6170 7475  interactor captu
+000116b0: 7265 7320 6d6f 7573 6520 6576 656e 7473  res mouse events
+000116c0: 2061 6e64 2077 696c 6c0a 2020 2020 2020   and will.      
+000116d0: 2020 2020 2020 2020 2020 2320 7065 7266            # perf
+000116e0: 6f72 6d20 6170 7072 6f70 7269 6174 6520  orm appropriate 
+000116f0: 6361 6d65 7261 206f 7220 6163 746f 7220  camera or actor 
+00011700: 6d61 6e69 7075 6c61 7469 6f6e 2064 6570  manipulation dep
+00011710: 656e 6469 6e67 206f 6e20 7468 650a 2020  ending on the.  
+00011720: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00011730: 6e61 7475 7265 206f 6620 7468 6520 6576  nature of the ev
+00011740: 656e 7473 2e0a 0a20 2020 2020 2020 2020  ents...         
+00011750: 2020 2020 2020 2072 656e 203d 2076 746b         ren = vtk
+00011760: 2e76 746b 5265 6e64 6572 6572 2829 0a20  .vtkRenderer(). 
+00011770: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00011780: 656e 5769 6e20 3d20 7674 6b2e 7674 6b52  enWin = vtk.vtkR
+00011790: 656e 6465 7257 696e 646f 7728 290a 2020  enderWindow().  
+000117a0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+000117b0: 6e57 696e 2e53 6574 4f66 6653 6372 6565  nWin.SetOffScree
+000117c0: 6e52 656e 6465 7269 6e67 2831 290a 2020  nRendering(1).  
+000117d0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+000117e0: 6e57 696e 2e53 6574 5369 7a65 2833 3030  nWin.SetSize(300
+000117f0: 302c 2033 3030 3029 0a20 2020 2020 2020  0, 3000).       
+00011800: 2020 2020 2020 2020 2072 656e 5769 6e2e           renWin.
+00011810: 4164 6452 656e 6465 7265 7228 7265 6e29  AddRenderer(ren)
+00011820: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00011830: 2020 2320 4164 6420 7468 6520 6163 746f    # Add the acto
+00011840: 7273 2074 6f20 7468 6520 7265 6e64 6572  rs to the render
+00011850: 6572 2c20 7365 7420 7468 6520 6261 636b  er, set the back
+00011860: 6772 6f75 6e64 2061 6e64 2073 697a 650a  ground and size.
+00011870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011880: 2320 6163 746f 722e 526f 7461 7465 5928  # actor.RotateY(
+00011890: 3930 290a 2020 2020 2020 2020 2020 2020  90).            
+000118a0: 2020 2020 7265 6e2e 4164 6441 6374 6f72      ren.AddActor
+000118b0: 2861 6374 6f72 290a 2020 2020 2020 2020  (actor).        
+000118c0: 2020 2020 2020 2020 7265 6e2e 5365 7442          ren.SetB
+000118d0: 6163 6b67 726f 756e 6428 302e 392c 2030  ackground(0.9, 0
+000118e0: 2e39 2c20 302e 3929 0a20 2020 2020 2020  .9, 0.9).       
+000118f0: 2020 2020 2020 2020 2072 656e 2e47 6574           ren.Get
+00011900: 4163 7469 7665 4361 6d65 7261 2829 2e53  ActiveCamera().S
+00011910: 6574 5061 7261 6c6c 656c 5072 6f6a 6563  etParallelProjec
+00011920: 7469 6f6e 2831 290a 2020 2020 2020 2020  tion(1).        
+00011930: 2020 2020 2020 2020 7265 6e57 696e 2e52          renWin.R
+00011940: 656e 6465 7228 290a 0a20 2020 2020 2020  ender()..       
+00011950: 2020 2020 2020 2020 2023 204f 7570 7574           # Ouput
+00011960: 206d 6170 7320 696d 6167 6573 206f 6e6c   maps images onl
+00011970: 790a 2020 2020 2020 2020 2020 2020 2020  y.              
+00011980: 2020 7265 6e2e 5265 7365 7443 616d 6572    ren.ResetCamer
+00011990: 6128 290a 2020 2020 2020 2020 2020 2020  a().            
+000119a0: 2020 2020 7265 6e2e 4765 7441 6374 6976      ren.GetActiv
+000119b0: 6543 616d 6572 6128 292e 5a6f 6f6d 2831  eCamera().Zoom(1
+000119c0: 2e33 3029 0a20 2020 2020 2020 2020 2020  .30).           
+000119d0: 2020 2020 206f 7574 6d61 707a 696d 6167       outmapzimag
+000119e0: 6520 3d20 277b 7d7b 7d5f 7a73 7572 6661  e = '{}{}_zsurfa
+000119f0: 6365 2e6a 7065 6727 2e66 6f72 6d61 7428  ce.jpeg'.format(
+00011a00: 7365 6c66 2e77 6f72 6b64 6972 2c20 7365  self.workdir, se
+00011a10: 6c66 2e6d 6170 6e61 6d65 290a 2020 2020  lf.mapname).    
+00011a20: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00011a30: 2e77 7269 7465 5f69 6d61 6765 286f 7574  .write_image(out
+00011a40: 6d61 707a 696d 6167 652c 2072 656e 5769  mapzimage, renWi
+00011a50: 6e29 0a0a 2020 2020 2020 2020 2020 2020  n)..            
+00011a60: 2020 2020 6163 746f 722e 526f 7461 7465      actor.Rotate
+00011a70: 5828 3930 290a 2020 2020 2020 2020 2020  X(90).          
+00011a80: 2020 2020 2020 6163 746f 722e 526f 7461        actor.Rota
+00011a90: 7465 5928 3930 290a 2020 2020 2020 2020  teY(90).        
+00011aa0: 2020 2020 2020 2020 2320 7265 6e2e 5265          # ren.Re
+00011ab0: 7365 7443 616d 6572 6128 290a 2020 2020  setCamera().    
+00011ac0: 2020 2020 2020 2020 2020 2020 6f75 746d              outm
+00011ad0: 6170 7969 6d61 6765 203d 2027 7b7d 7b7d  apyimage = '{}{}
+00011ae0: 5f79 7375 7266 6163 652e 6a70 6567 272e  _ysurface.jpeg'.
+00011af0: 666f 726d 6174 2873 656c 662e 776f 726b  format(self.work
+00011b00: 6469 722c 2073 656c 662e 6d61 706e 616d  dir, self.mapnam
+00011b10: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+00011b20: 2020 2073 656c 662e 7772 6974 655f 696d     self.write_im
+00011b30: 6167 6528 6f75 746d 6170 7969 6d61 6765  age(outmapyimage
+00011b40: 2c20 7265 6e57 696e 290a 0a20 2020 2020  , renWin)..     
+00011b50: 2020 2020 2020 2020 2020 2061 6374 6f72             actor
+00011b60: 2e52 6f74 6174 655a 2839 3029 0a20 2020  .RotateZ(90).   
+00011b70: 2020 2020 2020 2020 2020 2020 2061 6374               act
+00011b80: 6f72 2e52 6f74 6174 6558 2839 3029 0a20  or.RotateX(90). 
+00011b90: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00011ba0: 2072 656e 2e52 6573 6574 4361 6d65 7261   ren.ResetCamera
+00011bb0: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+00011bc0: 2020 206f 7574 6d61 7078 696d 6167 6520     outmapximage 
+00011bd0: 3d20 277b 7d7b 7d5f 7873 7572 6661 6365  = '{}{}_xsurface
+00011be0: 2e6a 7065 6727 2e66 6f72 6d61 7428 7365  .jpeg'.format(se
+00011bf0: 6c66 2e77 6f72 6b64 6972 2c20 7365 6c66  lf.workdir, self
+00011c00: 2e6d 6170 6e61 6d65 290a 2020 2020 2020  .mapname).      
+00011c10: 2020 2020 2020 2020 2020 7365 6c66 2e77            self.w
+00011c20: 7269 7465 5f69 6d61 6765 286f 7574 6d61  rite_image(outma
+00011c30: 7078 696d 6167 652c 2072 656e 5769 6e29  pximage, renWin)
+00011c40: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00011c50: 2020 2320 4d6f 6465 6c20 6578 6973 740a    # Model exist.
+00011c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011c70: 6966 2073 656c 662e 6d6f 6465 6c73 3a0a  if self.models:.
+00011c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011c90: 2020 2020 2320 7072 696e 7420 2273 656c      # print "sel
+00011ca0: 662e 6d6f 6465 6c73 3a25 7322 2025 2073  f.models:%s" % s
+00011cb0: 656c 662e 6d6f 6465 6c73 0a20 2020 2020  elf.models.     
+00011cc0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00011cd0: 6f72 206d 6f64 656c 2069 6e20 7365 6c66  or model in self
+00011ce0: 2e6d 6f64 656c 733a 0a20 2020 2020 2020  .models:.       
+00011cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011d00: 2070 6462 6964 203d 206d 6f64 656c 2e66   pdbid = model.f
+00011d10: 696c 656e 616d 652e 7370 6c69 7428 272f  ilename.split('/
+00011d20: 2729 5b2d 315d 2e73 706c 6974 2827 2e27  ')[-1].split('.'
+00011d30: 295b 305d 0a20 2020 2020 2020 2020 2020  )[0].           
+00011d40: 2020 2020 2020 2020 2020 2020 2070 6462               pdb
+00011d50: 726f 6f74 203d 2073 656c 662e 776f 726b  root = self.work
+00011d60: 6469 720a 2020 2020 2020 2020 2020 2020  dir.            
+00011d70: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
+00011d80: 6c20 3d20 277b 7d70 6462 7b7d 2e65 6e74  l = '{}pdb{}.ent
+00011d90: 272e 666f 726d 6174 2870 6462 726f 6f74  '.format(pdbroot
+00011da0: 2c20 7064 6269 6429 0a20 2020 2020 2020  , pdbid).       
+00011db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011dc0: 2023 2043 6861 6e67 6520 7468 6520 7669   # Change the vi
+00011dd0: 6577 2062 6163 6b0a 2020 2020 2020 2020  ew back.        
+00011de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011df0: 6163 746f 722e 526f 7461 7465 5828 2d39  actor.RotateX(-9
+00011e00: 3029 0a20 2020 2020 2020 2020 2020 2020  0).             
+00011e10: 2020 2020 2020 2020 2020 2061 6374 6f72             actor
+00011e20: 2e52 6f74 6174 655a 282d 3930 290a 2020  .RotateZ(-90).  
+00011e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011e40: 2020 2020 2020 6163 746f 722e 526f 7461        actor.Rota
+00011e50: 7465 5928 2d39 3029 0a20 2020 2020 2020  teY(-90).       
+00011e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011e70: 2061 6374 6f72 2e52 6f74 6174 6558 282d   actor.RotateX(-
+00011e80: 3930 290a 2020 2020 2020 2020 2020 2020  90).            
+00011e90: 2020 2020 2020 2020 2020 2020 7265 6e2e              ren.
+00011ea0: 5265 7365 7443 616d 6572 6128 290a 0a20  ResetCamera().. 
+00011eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011ec0: 2020 2020 2020 2061 6374 6f72 2e47 6574         actor.Get
+00011ed0: 5072 6f70 6572 7479 2829 2e53 6574 4f70  Property().SetOp
+00011ee0: 6163 6974 7928 302e 3529 0a20 2020 2020  acity(0.5).     
+00011ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011f00: 2020 2070 6462 5f72 6561 6465 7220 3d20     pdb_reader = 
+00011f10: 7674 6b2e 7674 6b50 4442 5265 6164 6572  vtk.vtkPDBReader
+00011f20: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+00011f30: 2020 2020 2020 2020 2020 206d 6f64 656c             model
+00011f40: 5f6d 6170 7065 7220 3d20 7674 6b2e 7674  _mapper = vtk.vt
+00011f50: 6b50 6f6c 7944 6174 614d 6170 7065 7228  kPolyDataMapper(
+00011f60: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00011f70: 2020 2020 2020 2020 2020 6d6f 6465 6c5f            model_
+00011f80: 6163 746f 7220 3d20 7674 6b2e 7674 6b41  actor = vtk.vtkA
+00011f90: 6374 6f72 2829 0a20 2020 2020 2020 2020  ctor().         
+00011fa0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00011fb0: 6f64 656c 5f61 6374 6f72 2e47 6574 5072  odel_actor.GetPr
+00011fc0: 6f70 6572 7479 2829 2e53 6574 4c69 6e65  operty().SetLine
+00011fd0: 5769 6474 6828 3629 0a20 2020 2020 2020  Width(6).       
+00011fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011ff0: 2070 6462 5f72 6561 6465 722e 5365 7446   pdb_reader.SetF
+00012000: 696c 654e 616d 6528 6d6f 6465 6c29 0a0a  ileName(model)..
+00012010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012020: 2020 2020 2020 2020 6d6f 6465 6c5f 6d61          model_ma
+00012030: 7070 6572 2e53 6574 496e 7075 7443 6f6e  pper.SetInputCon
+00012040: 6e65 6374 696f 6e28 7064 625f 7265 6164  nection(pdb_read
+00012050: 6572 2e47 6574 4f75 7470 7574 506f 7274  er.GetOutputPort
+00012060: 2829 290a 2020 2020 2020 2020 2020 2020  ()).            
+00012070: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
+00012080: 6c5f 6163 746f 722e 5365 744d 6170 7065  l_actor.SetMappe
+00012090: 7228 6d6f 6465 6c5f 6d61 7070 6572 290a  r(model_mapper).
+000120a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000120b0: 2020 2020 2020 2020 7265 6e2e 4164 6441          ren.AddA
+000120c0: 6374 6f72 286d 6f64 656c 5f61 6374 6f72  ctor(model_actor
+000120d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000120e0: 2020 2020 2020 2020 2020 7265 6e2e 5265            ren.Re
+000120f0: 7365 7443 616d 6572 6128 290a 2020 2020  setCamera().    
+00012100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012110: 2020 2020 7265 6e2e 4765 7441 6374 6976      ren.GetActiv
+00012120: 6543 616d 6572 6128 292e 5a6f 6f6d 2831  eCamera().Zoom(1
+00012130: 2e35 3029 0a20 2020 2020 2020 2020 2020  .50).           
+00012140: 2020 2020 2020 2020 2020 2020 2072 656e               ren
+00012150: 5769 6e2e 5265 6e64 6572 2829 0a0a 2020  Win.Render()..  
+00012160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012170: 2020 2020 2020 2320 4f75 7470 7574 206d        # Output m
+00012180: 6f64 656c 2061 6e64 206d 6170 7320 6f76  odel and maps ov
+00012190: 6572 6c61 7920 696d 6167 6573 0a20 2020  erlay images.   
+000121a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000121b0: 2020 2020 206f 7574 7a69 6d61 6765 203d       outzimage =
+000121c0: 2027 7b7d 7b7d 5f65 6d64 5f7b 7d5f 7a73   '{}{}_emd_{}_zs
+000121d0: 7572 6661 6365 2e6a 7065 6727 2e66 6f72  urface.jpeg'.for
+000121e0: 6d61 7428 7365 6c66 2e77 6f72 6b64 6972  mat(self.workdir
+000121f0: 2c20 7064 6269 642c 2073 656c 662e 6d61  , pdbid, self.ma
+00012200: 706e 616d 6529 0a20 2020 2020 2020 2020  pname).         
+00012210: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00012220: 656c 662e 7772 6974 655f 696d 6167 6528  elf.write_image(
+00012230: 6f75 747a 696d 6167 652c 2072 656e 5769  outzimage, renWi
+00012240: 6e29 0a0a 2020 2020 2020 2020 2020 2020  n)..            
+00012250: 2020 2020 2020 2020 2020 2020 6163 746f              acto
+00012260: 722e 526f 7461 7465 5828 3930 290a 2020  r.RotateX(90).  
+00012270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012280: 2020 2020 2020 6163 746f 722e 526f 7461        actor.Rota
+00012290: 7465 5928 3930 290a 2020 2020 2020 2020  teY(90).        
+000122a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000122b0: 6d6f 6465 6c5f 6163 746f 722e 526f 7461  model_actor.Rota
+000122c0: 7465 5828 3930 290a 2020 2020 2020 2020  teX(90).        
+000122d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000122e0: 6d6f 6465 6c5f 6163 746f 722e 526f 7461  model_actor.Rota
+000122f0: 7465 5928 3930 290a 2020 2020 2020 2020  teY(90).        
+00012300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012310: 2320 7265 6e2e 5265 7365 7443 616d 6572  # ren.ResetCamer
+00012320: 6128 290a 2020 2020 2020 2020 2020 2020  a().            
+00012330: 2020 2020 2020 2020 2020 2020 6f75 7479              outy
+00012340: 696d 6167 6520 3d20 277b 7d7b 7d5f 656d  image = '{}{}_em
+00012350: 645f 7b7d 5f79 7375 7266 6163 652e 6a70  d_{}_ysurface.jp
+00012360: 6567 272e 666f 726d 6174 2873 656c 662e  eg'.format(self.
+00012370: 776f 726b 6469 722c 2070 6462 6964 2c20  workdir, pdbid, 
+00012380: 7365 6c66 2e6d 6170 6e61 6d65 290a 2020  self.mapname).  
+00012390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000123a0: 2020 2020 2020 7365 6c66 2e77 7269 7465        self.write
+000123b0: 5f69 6d61 6765 286f 7574 7969 6d61 6765  _image(outyimage
+000123c0: 2c20 7265 6e57 696e 290a 0a20 2020 2020  , renWin)..     
+000123d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000123e0: 2020 2061 6374 6f72 2e52 6f74 6174 655a     actor.RotateZ
+000123f0: 2839 3029 0a20 2020 2020 2020 2020 2020  (90).           
+00012400: 2020 2020 2020 2020 2020 2020 2061 6374               act
+00012410: 6f72 2e52 6f74 6174 6558 2839 3029 0a20  or.RotateX(90). 
+00012420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012430: 2020 2020 2020 206d 6f64 656c 5f61 6374         model_act
+00012440: 6f72 2e52 6f74 6174 655a 2839 3029 0a20  or.RotateZ(90). 
+00012450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012460: 2020 2020 2020 206d 6f64 656c 5f61 6374         model_act
+00012470: 6f72 2e52 6f74 6174 6558 2839 3029 0a20  or.RotateX(90). 
+00012480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012490: 2020 2020 2020 2023 2072 656e 2e52 6573         # ren.Res
+000124a0: 6574 4361 6d65 7261 2829 0a20 2020 2020  etCamera().     
+000124b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000124c0: 2020 206f 7574 7869 6d61 6765 203d 2027     outximage = '
+000124d0: 7b7d 7b7d 5f65 6d64 5f7b 7d5f 7873 7572  {}{}_emd_{}_xsur
+000124e0: 6661 6365 2e6a 7065 6727 2e66 6f72 6d61  face.jpeg'.forma
+000124f0: 7428 7365 6c66 2e77 6f72 6b64 6972 2c20  t(self.workdir, 
+00012500: 7064 6269 642c 2073 656c 662e 6d61 706e  pdbid, self.mapn
+00012510: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
+00012520: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00012530: 662e 7772 6974 655f 696d 6167 6528 6f75  f.write_image(ou
+00012540: 7478 696d 6167 652c 2072 656e 5769 6e29  tximage, renWin)
+00012550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012560: 2070 7269 6e74 2827 5375 7266 6163 6520   print('Surface 
+00012570: 7669 6577 7320 7765 7265 2067 656e 6572  views were gener
+00012580: 6174 6564 2062 7920 5654 4b20 6d65 7468  ated by VTK meth
+00012590: 6f64 2729 0a20 2020 2020 2020 2020 2020  od').           
+000125a0: 2065 6c69 6620 7365 6c66 2e63 6c20 6973   elif self.cl is
+000125b0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+000125c0: 2020 2020 2020 2070 7269 6e74 2827 5769         print('Wi
+000125d0: 7468 6f75 7420 636f 6e74 6f75 7220 6c65  thout contour le
+000125e0: 7665 6c20 6e6f 2073 7572 6661 6365 2076  vel no surface v
+000125f0: 6965 7720 7769 6c6c 2062 6520 7072 6f64  iew will be prod
+00012600: 7563 6564 2e27 290a 0a20 2020 2020 2020  uced.')..       
+00012610: 2073 656c 662e 7363 616c 655f 7375 7266   self.scale_surf
+00012620: 6163 6576 6965 7728 290a 0a20 2020 2020  aceview()..     
+00012630: 2020 206f 7574 7a69 6d61 6765 203d 2027     outzimage = '
+00012640: 7b7d 656d 645f 7b7d 5f7a 7375 7266 6163  {}emd_{}_zsurfac
+00012650: 652e 6a70 6567 272e 666f 726d 6174 2873  e.jpeg'.format(s
+00012660: 656c 662e 776f 726b 6469 722c 2073 656c  elf.workdir, sel
+00012670: 662e 656d 6469 6429 0a0a 2020 2020 2020  f.emdid)..      
+00012680: 2020 7375 7266 6163 6576 6965 776a 736f    surfaceviewjso
+00012690: 6e20 3d20 6469 6374 2829 0a20 2020 2020  n = dict().     
+000126a0: 2020 2069 6620 6f75 746d 6170 7869 6d61     if outmapxima
+000126b0: 6765 3a0a 2020 2020 2020 2020 2020 2020  ge:.            
+000126c0: 6d61 7078 6c69 7374 203d 206f 7574 6d61  mapxlist = outma
+000126d0: 7078 696d 6167 652e 7370 6c69 7428 275f  pximage.split('_
+000126e0: 2729 0a20 2020 2020 2020 2020 2020 206d  ').            m
+000126f0: 6170 7873 6361 6c65 696d 6167 6520 3d20  apxscaleimage = 
+00012700: 275f 272e 6a6f 696e 286d 6170 786c 6973  '_'.join(mapxlis
+00012710: 745b 3a2d 315d 2920 2b20 275f 7363 616c  t[:-1]) + '_scal
+00012720: 6564 5f27 202b 206d 6170 786c 6973 745b  ed_' + mapxlist[
+00012730: 2d31 5d0a 2020 2020 2020 2020 2020 2020  -1].            
+00012740: 7375 7266 6163 6576 6965 776a 736f 6e5b  surfaceviewjson[
+00012750: 2778 275d 203d 206f 732e 7061 7468 2e62  'x'] = os.path.b
+00012760: 6173 656e 616d 6528 6d61 7078 7363 616c  asename(mapxscal
+00012770: 6569 6d61 6765 2920 6966 206f 732e 7061  eimage) if os.pa
+00012780: 7468 2e69 7366 696c 6528 6d61 7078 7363  th.isfile(mapxsc
+00012790: 616c 6569 6d61 6765 2920 656c 7365 204e  aleimage) else N
+000127a0: 6f6e 650a 2020 2020 2020 2020 6966 206f  one.        if o
+000127b0: 7574 6d61 7079 696d 6167 653a 0a20 2020  utmapyimage:.   
+000127c0: 2020 2020 2020 2020 206d 6170 796c 6973           mapylis
+000127d0: 7420 3d20 6f75 746d 6170 7969 6d61 6765  t = outmapyimage
+000127e0: 2e73 706c 6974 2827 5f27 290a 2020 2020  .split('_').    
+000127f0: 2020 2020 2020 2020 6d61 7079 7363 616c          mapyscal
+00012800: 6569 6d61 6765 203d 2027 5f27 2e6a 6f69  eimage = '_'.joi
+00012810: 6e28 6d61 7079 6c69 7374 5b3a 2d31 5d29  n(mapylist[:-1])
+00012820: 202b 2027 5f73 6361 6c65 645f 2720 2b20   + '_scaled_' + 
+00012830: 6d61 7079 6c69 7374 5b2d 315d 0a20 2020  mapylist[-1].   
+00012840: 2020 2020 2020 2020 2073 7572 6661 6365           surface
+00012850: 7669 6577 6a73 6f6e 5b27 7927 5d20 3d20  viewjson['y'] = 
+00012860: 6f73 2e70 6174 682e 6261 7365 6e61 6d65  os.path.basename
+00012870: 286d 6170 7973 6361 6c65 696d 6167 6529  (mapyscaleimage)
+00012880: 2069 6620 6f73 2e70 6174 682e 6973 6669   if os.path.isfi
+00012890: 6c65 286d 6170 7973 6361 6c65 696d 6167  le(mapyscaleimag
+000128a0: 6529 2065 6c73 6520 4e6f 6e65 0a20 2020  e) else None.   
+000128b0: 2020 2020 2069 6620 6f75 746d 6170 7a69       if outmapzi
+000128c0: 6d61 6765 3a0a 2020 2020 2020 2020 2020  mage:.          
+000128d0: 2020 6d61 707a 6c69 7374 203d 206f 7574    mapzlist = out
+000128e0: 6d61 707a 696d 6167 652e 7370 6c69 7428  mapzimage.split(
+000128f0: 275f 2729 0a20 2020 2020 2020 2020 2020  '_').           
+00012900: 206d 6170 7a73 6361 6c65 696d 6167 6520   mapzscaleimage 
+00012910: 3d20 275f 272e 6a6f 696e 286d 6170 7a6c  = '_'.join(mapzl
+00012920: 6973 745b 3a2d 315d 2920 2b20 275f 7363  ist[:-1]) + '_sc
+00012930: 616c 6564 5f27 202b 206d 6170 7a6c 6973  aled_' + mapzlis
+00012940: 745b 2d31 5d0a 2020 2020 2020 2020 2020  t[-1].          
+00012950: 2020 7375 7266 6163 6576 6965 776a 736f    surfaceviewjso
+00012960: 6e5b 277a 275d 203d 206f 732e 7061 7468  n['z'] = os.path
+00012970: 2e62 6173 656e 616d 6528 6d61 707a 7363  .basename(mapzsc
+00012980: 616c 6569 6d61 6765 2920 6966 206f 732e  aleimage) if os.
+00012990: 7061 7468 2e69 7366 696c 6528 6d61 707a  path.isfile(mapz
+000129a0: 7363 616c 6569 6d61 6765 2920 656c 7365  scaleimage) else
+000129b0: 204e 6f6e 650a 2020 2020 2020 2020 6669   None.        fi
+000129c0: 6e61 6c64 6963 7420 3d20 7b27 6d61 705f  naldict = {'map_
+000129d0: 7375 7266 6163 6527 3a20 7375 7266 6163  surface': surfac
+000129e0: 6576 6965 776a 736f 6e7d 0a0a 2020 2020  eviewjson}..    
+000129f0: 2020 2020 7769 7468 2063 6f64 6563 732e      with codecs.
+00012a00: 6f70 656e 2873 656c 662e 776f 726b 6469  open(self.workdi
+00012a10: 7220 2b20 7365 6c66 2e6d 6170 6e61 6d65  r + self.mapname
+00012a20: 202b 2027 5f6d 6170 7375 7266 6163 6576   + '_mapsurfacev
+00012a30: 6965 772e 6a73 6f6e 272c 2027 7727 2c0a  iew.json', 'w',.
+00012a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012a50: 2020 2020 2020 2020 2065 6e63 6f64 696e           encodin
+00012a60: 673d 2775 7466 2d38 2729 2061 7320 663a  g='utf-8') as f:
+00012a70: 0a20 2020 2020 2020 2020 2020 206a 736f  .            jso
+00012a80: 6e2e 6475 6d70 2866 696e 616c 6469 6374  n.dump(finaldict
+00012a90: 2c20 6629 0a0a 2020 2020 2020 2020 6a70  , f)..        jp
+00012aa0: 6567 7320 3d20 676c 6f62 2e67 6c6f 6228  egs = glob.glob(
+00012ab0: 7365 6c66 2e77 6f72 6b64 6972 202b 2027  self.workdir + '
+00012ac0: 2f2a 7375 7266 6163 652e 6a70 6567 2729  /*surface.jpeg')
+00012ad0: 0a20 2020 2020 2020 206d 6f64 656c 7375  .        modelsu
+00012ae0: 7266 203d 2064 6963 7428 290a 2020 2020  rf = dict().    
+00012af0: 2020 2020 6669 6e61 6c6d 6d64 6963 7420      finalmmdict 
+00012b00: 3d20 6469 6374 2829 0a20 2020 2020 2020  = dict().       
+00012b10: 2069 6620 7365 6c66 2e6d 6f64 656c 733a   if self.models:
+00012b20: 0a20 2020 2020 2020 2020 2020 2023 2070  .            # p
+00012b30: 7269 6e74 2022 7365 6c66 2e6d 6f64 656c  rint "self.model
+00012b40: 733a 2573 2220 2520 7365 6c66 2e6d 6f64  s:%s" % self.mod
+00012b50: 656c 730a 2020 2020 2020 2020 2020 2020  els.            
+00012b60: 666f 7220 6d6f 6465 6c20 696e 2073 656c  for model in sel
+00012b70: 662e 6d6f 6465 6c73 3a0a 2020 2020 2020  f.models:.      
+00012b80: 2020 2020 2020 2020 2020 6d6f 6465 6c6e            modeln
+00012b90: 616d 6520 3d20 6d6f 6465 6c2e 6669 6c65  ame = model.file
+00012ba0: 6e61 6d65 2e73 706c 6974 2827 2f27 295b  name.split('/')[
+00012bb0: 2d31 5d2e 7370 6c69 7428 272e 2729 5b30  -1].split('.')[0
+00012bc0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00012bd0: 2020 6d6f 6465 6c6d 6170 7375 7266 6163    modelmapsurfac
+00012be0: 6520 3d20 6469 6374 2829 0a20 2020 2020  e = dict().     
+00012bf0: 2020 2020 2020 2020 2020 2066 6f72 206a             for j
+00012c00: 7065 6720 696e 206a 7065 6773 3a0a 2020  peg in jpegs:.  
+00012c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012c20: 2020 6966 206d 6f64 656c 6e61 6d65 2069    if modelname i
+00012c30: 6e20 6a70 6567 2061 6e64 2027 7873 7572  n jpeg and 'xsur
+00012c40: 6661 6365 2720 696e 206a 7065 673a 0a20  face' in jpeg:. 
+00012c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012c60: 2020 2020 2020 206d 6f64 656c 6d61 7073         modelmaps
+00012c70: 7572 6661 6365 5b27 7827 5d20 3d20 6d6f  urface['x'] = mo
+00012c80: 6465 6c6e 616d 6520 2b20 275f 656d 645f  delname + '_emd_
+00012c90: 2720 2b20 7365 6c66 2e6d 6170 6e61 6d65  ' + self.mapname
+00012ca0: 202b 2027 5f73 6361 6c65 645f 7873 7572   + '_scaled_xsur
+00012cb0: 6661 6365 2e6a 7065 6727 0a20 2020 2020  face.jpeg'.     
+00012cc0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00012cd0: 6620 6d6f 6465 6c6e 616d 6520 696e 206a  f modelname in j
+00012ce0: 7065 6720 616e 6420 2779 7375 7266 6163  peg and 'ysurfac
+00012cf0: 6527 2069 6e20 6a70 6567 3a0a 2020 2020  e' in jpeg:.    
+00012d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012d10: 2020 2020 6d6f 6465 6c6d 6170 7375 7266      modelmapsurf
+00012d20: 6163 655b 2779 275d 203d 206d 6f64 656c  ace['y'] = model
+00012d30: 6e61 6d65 202b 2027 5f65 6d64 5f27 202b  name + '_emd_' +
+00012d40: 2073 656c 662e 6d61 706e 616d 6520 2b20   self.mapname + 
+00012d50: 275f 7363 616c 6564 5f79 7375 7266 6163  '_scaled_ysurfac
+00012d60: 652e 6a70 6567 270a 2020 2020 2020 2020  e.jpeg'.        
+00012d70: 2020 2020 2020 2020 2020 2020 6966 206d              if m
+00012d80: 6f64 656c 6e61 6d65 2069 6e20 6a70 6567  odelname in jpeg
+00012d90: 2061 6e64 2027 7a73 7572 6661 6365 2720   and 'zsurface' 
+00012da0: 696e 206a 7065 673a 0a20 2020 2020 2020  in jpeg:.       
+00012db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012dc0: 206d 6f64 656c 6d61 7073 7572 6661 6365   modelmapsurface
+00012dd0: 5b27 7a27 5d20 3d20 6d6f 6465 6c6e 616d  ['z'] = modelnam
+00012de0: 6520 2b20 275f 656d 645f 2720 2b20 7365  e + '_emd_' + se
+00012df0: 6c66 2e6d 6170 6e61 6d65 202b 2027 5f73  lf.mapname + '_s
+00012e00: 6361 6c65 645f 7a73 7572 6661 6365 2e6a  caled_zsurface.j
+00012e10: 7065 6727 0a20 2020 2020 2020 2020 2020  peg'.           
+00012e20: 2020 2020 206d 6f64 656c 7375 7266 5b6d       modelsurf[m
+00012e30: 6f64 656c 6e61 6d65 5d20 3d20 6d6f 6465  odelname] = mode
+00012e40: 6c6d 6170 7375 7266 6163 650a 2020 2020  lmapsurface.    
+00012e50: 2020 2020 2020 2020 6669 6e61 6c6d 6d64          finalmmd
+00012e60: 6963 745b 276d 6170 6d6f 6465 6c5f 7375  ict['mapmodel_su
+00012e70: 7266 6163 6527 5d20 3d20 6d6f 6465 6c73  rface'] = models
+00012e80: 7572 660a 0a20 2020 2020 2020 2020 2020  urf..           
+00012e90: 2077 6974 6820 636f 6465 6373 2e6f 7065   with codecs.ope
+00012ea0: 6e28 7365 6c66 2e77 6f72 6b64 6972 202b  n(self.workdir +
+00012eb0: 2073 656c 662e 6d61 706e 616d 6520 2b20   self.mapname + 
+00012ec0: 275f 6d61 706d 6f64 656c 7375 7266 6163  '_mapmodelsurfac
+00012ed0: 6576 6965 772e 6a73 6f6e 272c 2027 7727  eview.json', 'w'
+00012ee0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00012ef0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00012f00: 6e63 6f64 696e 673d 2775 7466 2d38 2729  ncoding='utf-8')
+00012f10: 2061 7320 663a 0a20 2020 2020 2020 2020   as f:.         
+00012f20: 2020 2020 2020 206a 736f 6e2e 6475 6d70         json.dump
+00012f30: 2866 696e 616c 6d6d 6469 6374 2c20 6629  (finalmmdict, f)
+00012f40: 0a0a 0a20 2020 2020 2020 2065 6e64 203d  ...        end =
+00012f50: 2074 696d 6569 742e 6465 6661 756c 745f   timeit.default_
+00012f60: 7469 6d65 7228 290a 2020 2020 2020 2020  timer().        
+00012f70: 7072 696e 7428 2753 7572 6661 6365 7669  print('Surfacevi
+00012f80: 6577 2074 696d 653a 207b 7d27 2e66 6f72  ew time: {}'.for
+00012f90: 6d61 7428 656e 642d 7374 6172 7429 290a  mat(end-start)).
+00012fa0: 2020 2020 2020 2020 7072 696e 7428 272d          print('-
+00012fb0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00012fc0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00012fd0: 2d2d 2d27 290a 0a20 2020 2020 2020 2072  ---')..        r
+00012fe0: 6574 7572 6e20 4e6f 6e65 0a0a 2020 2020  eturn None..    
+00012ff0: 2320 466f 7220 6d61 736b 2076 6965 7773  # For mask views
+00013000: 2061 6e64 2063 656e 7472 616c 2073 6c69   and central sli
+00013010: 6365 206f 6620 6d61 736b 730a 2020 2020  ce of masks.    
+00013020: 2320 4070 726f 6669 6c65 0a20 2020 2064  # @profile.    d
+00013030: 6566 206d 6173 6b73 2873 656c 6629 3a0a  ef masks(self):.
+00013040: 2020 2020 2020 2020 2222 220a 0a0a 2020          """...  
+00013050: 2020 2020 2020 3a72 6574 7572 6e3a 0a20        :return:. 
+00013060: 2020 2020 2020 2022 2222 0a0a 2020 2020         """..    
+00013070: 2020 2020 7674 6b70 6163 6b2c 2063 6869      vtkpack, chi
+00013080: 6d65 7261 6170 7020 3d20 7365 6c66 2e73  meraapp = self.s
+00013090: 7572 6661 6365 5f65 6e76 6368 6563 6b28  urface_envcheck(
+000130a0: 290a 2020 2020 2020 2020 6966 2073 656c  ).        if sel
+000130b0: 662e 616c 6c6d 6173 6b73 3a0a 2020 2020  f.allmasks:.    
+000130c0: 2020 2020 2020 2020 2320 5768 656e 206d          # When m
+000130d0: 6173 6b73 2064 6174 6128 6e6f 7420 7365  asks data(not se
+000130e0: 676d 656e 7461 7469 6f6e 2920 6172 6520  gmentation) are 
+000130f0: 7265 6164 792c 2073 7769 7463 6820 7468  ready, switch th
+00013100: 6973 206f 6e20 746f 2070 726f 6475 6365  is on to produce
+00013110: 2070 726f 7065 7220 6365 6e74 7261 6c20   proper central 
+00013120: 736c 6963 6520 6f66 206d 6173 6b73 0a20  slice of masks. 
+00013130: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00013140: 6365 6e74 7261 6c4d 6173 6b73 2829 0a20  centralMasks(). 
+00013150: 2020 2020 2020 2020 2020 2069 6620 6368             if ch
+00013160: 696d 6572 6161 7070 3a0a 2020 2020 2020  imeraapp:.      
+00013170: 2020 2020 2020 2020 2020 7365 6c66 2e6d            self.m
+00013180: 6173 6b76 6965 7763 6869 6d65 7261 2863  askviewchimera(c
+00013190: 6869 6d65 7261 6170 7029 0a20 2020 2020  himeraapp).     
+000131a0: 2020 2020 2020 2065 6c69 6620 7674 6b70         elif vtkp
+000131b0: 6163 6b3a 0a20 2020 2020 2020 2020 2020  ack:.           
+000131c0: 2020 2020 2073 656c 662e 6d61 736b 7669       self.maskvi
+000131d0: 6577 7328 290a 2020 2020 2020 2020 2020  ews().          
+000131e0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000131f0: 2020 2020 2020 2020 2320 7072 696e 7428          # print(
+00013200: 274e 6f20 7072 6f70 6572 2056 544b 206f  'No proper VTK o
+00013210: 7220 4368 696d 6572 6120 6361 6e20 6265  r Chimera can be
+00013220: 2075 7365 6420 666f 7220 7072 6f64 7563   used for produc
+00013230: 696e 6720 6d61 736b 2076 6965 772e 2050  ing mask view. P
+00013240: 6c65 6173 6520 6368 6563 6b2e 272c 2066  lease check.', f
+00013250: 696c 653d 7379 732e 7374 6465 7272 290a  ile=sys.stderr).
+00013260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013270: 7379 732e 7374 6465 7272 2e77 7269 7465  sys.stderr.write
+00013280: 2827 4e6f 2070 726f 7065 7220 5654 4b20  ('No proper VTK 
+00013290: 6f72 2043 6869 6d65 7261 5820 6361 6e20  or ChimeraX can 
+000132a0: 6265 2075 7365 6420 666f 7220 7072 6f64  be used for prod
+000132b0: 7563 696e 6720 6d61 736b 2076 6965 772e  ucing mask view.
+000132c0: 2050 6c65 6173 6520 6368 6563 6b2e 5c6e   Please check.\n
+000132d0: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
+000132e0: 2020 2070 7269 6e74 2827 2d2d 2d2d 2d2d     print('------
+000132f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00013300: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2729  --------------')
+00013310: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00013320: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+00013330: 2827 4e6f 206d 6173 6b73 2066 6f72 2074  ('No masks for t
+00013340: 6869 7320 656e 7472 7921 2729 0a20 2020  his entry!').   
+00013350: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
+00013360: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00013370: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00013380: 2d2d 2d2d 2729 0a0a 2020 2020 6465 6620  ----')..    def 
+00013390: 6d61 736b 7376 7470 2873 656c 662c 206d  masksvtp(self, m
+000133a0: 6173 6b72 6573 756c 7429 3a0a 2020 2020  askresult):.    
+000133b0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+000133c0: 2020 2050 726f 6475 6365 2076 7470 2066     Produce vtp f
+000133d0: 696c 6573 2066 6f72 2074 686f 7365 2077  iles for those w
+000133e0: 6869 6368 2064 6f65 7320 6e6f 7420 6861  hich does not ha
+000133f0: 7665 2061 2076 7470 2066 696c 6520 6265  ve a vtp file be
+00013400: 666f 7265 0a20 2020 2020 2020 2020 2020  fore.           
+00013410: 746f 646f 3a20 6e65 6564 2074 6f20 6265  todo: need to be
+00013420: 2063 6861 6e67 6564 2077 6865 6e20 6d61   changed when ma
+00013430: 736b 7265 7375 6c74 2072 6574 7572 6e65  skresult returne
+00013440: 6420 6973 2061 2064 6963 7469 6f6e 6172  d is a dictionar
+00013450: 790a 0a20 2020 2020 2020 203a 7061 7261  y..        :para
+00013460: 6d20 6d61 736b 733a 0a20 2020 2020 2020  m masks:.       
+00013470: 203a 7265 7475 726e 3a0a 2020 2020 2020   :return:.      
+00013480: 2020 2222 220a 2020 2020 2020 2020 6d61    """.        ma
+00013490: 736b 7320 3d20 5b5d 0a0a 2020 2020 2020  sks = []..      
+000134a0: 2020 6d65 7368 6d61 6b65 7220 3d20 4661    meshmaker = Fa
+000134b0: 6c73 650a 2020 2020 2020 2020 6966 204d  lse.        if M
+000134c0: 4553 484d 414b 4552 5041 5448 2069 7320  ESHMAKERPATH is 
+000134d0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+000134e0: 2020 2020 2020 6d65 7368 6d61 6b65 7220        meshmaker 
+000134f0: 3d20 5472 7565 0a20 2020 2020 2020 2020  = True.         
+00013500: 2020 206d 6573 686d 616b 6572 7061 7468     meshmakerpath
+00013510: 203d 204d 4553 484d 414b 4552 5041 5448   = MESHMAKERPATH
+00013520: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00013530: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+00013540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013550: 6173 7365 7274 2066 696e 645f 6578 6563  assert find_exec
+00013560: 7574 6162 6c65 2827 6d65 7368 6d61 6b65  utable('meshmake
+00013570: 7227 2920 6973 206e 6f74 204e 6f6e 650a  r') is not None.
+00013580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013590: 6d65 7368 6d61 6b65 7270 6174 6820 3d20  meshmakerpath = 
+000135a0: 6669 6e64 5f65 7865 6375 7461 626c 6528  find_executable(
+000135b0: 276d 6573 686d 616b 6572 2729 0a20 2020  'meshmaker').   
+000135c0: 2020 2020 2020 2020 2020 2020 206d 6573               mes
+000135d0: 686d 616b 6572 203d 2054 7275 650a 2020  hmaker = True.  
+000135e0: 2020 2020 2020 2020 2020 6578 6365 7074            except
+000135f0: 2041 7373 6572 7469 6f6e 4572 726f 723a   AssertionError:
+00013600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013610: 2023 2070 7269 6e74 2827 6d65 7368 6d61   # print('meshma
+00013620: 6b65 7220 6578 6563 7574 6162 6c65 2069  ker executable i
+00013630: 7320 6e6f 7420 7468 6572 652e 272c 2066  s not there.', f
+00013640: 696c 653d 7379 732e 7374 6465 7272 290a  ile=sys.stderr).
+00013650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013660: 7379 732e 7374 6465 7272 2e77 7269 7465  sys.stderr.write
+00013670: 2827 6d65 7368 6d61 6b65 7220 6578 6563  ('meshmaker exec
+00013680: 7574 6162 6c65 2069 7320 6e6f 7420 7468  utable is not th
+00013690: 6572 652e 5c6e 2729 0a20 2020 2020 2020  ere.\n').       
+000136a0: 2020 2020 2073 7973 2e73 7464 6572 722e       sys.stderr.
+000136b0: 7772 6974 6528 274e 6f20 7072 6f70 6572  write('No proper
+000136c0: 2056 544b 206f 7220 4368 696d 6572 6158   VTK or ChimeraX
+000136d0: 2063 616e 2062 6520 7573 6564 2066 6f72   can be used for
+000136e0: 2070 726f 6475 6369 6e67 206d 6173 6b20   producing mask 
+000136f0: 7669 6577 2e20 506c 6561 7365 2063 6865  view. Please che
+00013700: 636b 2e5c 6e27 290a 0a20 2020 2020 2020  ck.\n')..       
+00013710: 2069 6620 6e6f 7420 6d61 736b 7265 7375   if not maskresu
+00013720: 6c74 3a0a 2020 2020 2020 2020 2020 2020  lt:.            
+00013730: 7265 7475 726e 204e 6f6e 650a 2020 2020  return None.    
+00013740: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00013750: 2020 2020 2020 666f 7220 6d61 736b 2069        for mask i
+00013760: 6e20 6d61 736b 7265 7375 6c74 3a0a 2020  n maskresult:.  
+00013770: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00013780: 6966 206d 6173 6b2e 656e 6473 7769 7468  if mask.endswith
+00013790: 2827 2e6d 6170 2729 3a0a 2020 2020 2020  ('.map'):.      
+000137a0: 2020 2020 2020 2020 2020 6966 206d 6173            if mas
+000137b0: 6b3a 0a20 2020 2020 2020 2020 2020 2020  k:.             
+000137c0: 2020 2020 2020 2023 206d 6173 6b6e 616d         # masknam
+000137d0: 6520 3d20 6d61 736b 5b3a 2d34 5d0a 2020  e = mask[:-4].  
+000137e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000137f0: 2020 2320 6d61 736b 7674 7020 3d20 6d61    # maskvtp = ma
+00013800: 736b 6e61 6d65 202b 2027 2e76 7470 270a  skname + '.vtp'.
+00013810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013820: 2020 2020 6d61 736b 7674 7020 3d20 6d61      maskvtp = ma
+00013830: 736b 202b 2027 2e76 7470 270a 2020 2020  sk + '.vtp'.    
+00013840: 2020 2020 2020 2020 2020 2020 6966 206f              if o
+00013850: 732e 7061 7468 2e69 7366 696c 6528 6d61  s.path.isfile(ma
+00013860: 736b 7674 7029 3a0a 2020 2020 2020 2020  skvtp):.        
+00013870: 2020 2020 2020 2020 2020 2020 6d61 736b              mask
+00013880: 732e 6170 7065 6e64 286d 6173 6b76 7470  s.append(maskvtp
+00013890: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000138a0: 2020 2020 2020 7072 696e 7428 2756 7470        print('Vtp
+000138b0: 2066 696c 6520 666f 7220 6d61 736b 3a20   file for mask: 
+000138c0: 2573 2065 7869 7374 2e27 2025 206d 6173  %s exist.' % mas
+000138d0: 6b76 7470 290a 2020 2020 2020 2020 2020  kvtp).          
+000138e0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000138f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013900: 6d61 736b 732e 6170 7065 6e64 286d 6173  masks.append(mas
+00013910: 6b76 7470 290a 2020 2020 2020 2020 2020  kvtp).          
+00013920: 2020 2020 2020 2020 2020 2320 546f 646f            # Todo
+00013930: 3a43 6f6e 746f 7572 206c 6576 656c 2066  :Contour level f
+00013940: 6f72 206d 6173 6b73 2075 7365 2031 2e30  or masks use 1.0
+00013950: 2066 6f72 206e 6f77 2061 6e64 2077 696c   for now and wil
+00013960: 6c20 6265 206c 6f61 6465 6420 6672 6f6d  l be loaded from
+00013970: 206d 6d63 6966 2066 696c 6520 6c61 7465   mmcif file late
+00013980: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
+00013990: 2020 2020 2020 636d 6420 3d20 6d65 7368        cmd = mesh
+000139a0: 6d61 6b65 7270 6174 6820 2b20 2720 2720  makerpath + ' ' 
+000139b0: 2b20 6d61 736b 202b 2027 202d 6320 2720  + mask + ' -c ' 
+000139c0: 2b20 2731 2e30 2720 2b20 2720 2d6f 2027  + '1.0' + ' -o '
+000139d0: 202b 206d 6173 6b6e 616d 6520 2b20 2720   + maskname + ' 
+000139e0: 2d44 202d 7627 0a20 2020 2020 2020 2020  -D -v'.         
+000139f0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+00013a00: 2863 6d64 290a 2020 2020 2020 2020 2020  (cmd).          
+00013a10: 2020 2020 2020 2020 2020 2320 6966 2073            # if s
+00013a20: 656c 662e 656d 6469 643a 0a20 2020 2020  elf.emdid:.     
+00013a30: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00013a40: 2020 2020 2063 6d64 203d 2027 736f 7572       cmd = 'sour
+00013a50: 6365 2027 202b 2043 4f4e 4441 5041 5448  ce ' + CONDAPATH
+00013a60: 202b 2027 3b73 6f75 7263 6520 6163 7469   + ';source acti
+00013a70: 7661 7465 206d 6573 686d 616b 6572 3b20  vate meshmaker; 
+00013a80: 6d65 7368 6d61 6b65 7220 2720 2b20 6d61  meshmaker ' + ma
+00013a90: 736b 202b 2027 202d 6320 2720 5c0a 2020  sk + ' -c ' \.  
+00013aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013ab0: 2020 2320 2020 2020 2020 2020 2020 2b20    #           + 
+00013ac0: 2731 2e30 2720 2b20 2720 2d6f 2027 202b  '1.0' + ' -o ' +
+00013ad0: 206d 6173 6b6e 616d 6520 2b20 2720 2d44   maskname + ' -D
+00013ae0: 202d 7627 0a20 2020 2020 2020 2020 2020   -v'.           
+00013af0: 2020 2020 2020 2020 2023 2020 2020 2070           #     p
+00013b00: 7269 6e74 2063 6d64 0a20 2020 2020 2020  rint cmd.       
+00013b10: 2020 2020 2020 2020 2020 2020 2023 2065               # e
+00013b20: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00013b30: 2020 2020 2020 2020 2023 2020 2020 2063           #     c
+00013b40: 6d64 203d 2027 736f 7572 6365 2061 6374  md = 'source act
+00013b50: 6976 6174 6520 6d65 7368 6d61 6b65 723b  ivate meshmaker;
+00013b60: 206d 6573 686d 616b 6572 2027 202b 206d   meshmaker ' + m
+00013b70: 6173 6b20 2b20 2720 2d63 2027 205c 0a20  ask + ' -c ' \. 
+00013b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013b90: 2020 2023 2020 2020 2020 2020 2020 202b     #           +
+00013ba0: 2027 312e 3027 202b 2027 2d6f 2027 202b   '1.0' + '-o ' +
+00013bb0: 206d 6173 6b6e 616d 6520 2b20 2720 2d44   maskname + ' -D
+00013bc0: 202d 7627 0a20 2020 2020 2020 2020 2020   -v'.           
+00013bd0: 2020 2020 2020 2020 2023 7072 6f63 6573           #proces
+00013be0: 7320 3d20 7375 6270 726f 6365 7373 2e50  s = subprocess.P
+00013bf0: 6f70 656e 2863 6d64 2c20 7374 646f 7574  open(cmd, stdout
+00013c00: 3d73 7562 7072 6f63 6573 732e 5049 5045  =subprocess.PIPE
+00013c10: 2c20 7374 6465 7272 3d73 7562 7072 6f63  , stderr=subproc
+00013c20: 6573 732e 5049 5045 290a 2020 2020 2020  ess.PIPE).      
+00013c30: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+00013c40: 6f63 6573 7320 3d20 7375 6270 726f 6365  ocess = subproce
+00013c50: 7373 2e50 6f70 656e 2863 6d64 2c20 7368  ss.Popen(cmd, sh
+00013c60: 656c 6c3d 5472 7565 2c20 6578 6563 7574  ell=True, execut
+00013c70: 6162 6c65 3d27 2f62 696e 2f62 6173 6827  able='/bin/bash'
+00013c80: 2c20 6377 643d 7365 6c66 2e77 6f72 6b64  , cwd=self.workd
+00013c90: 6972 290a 2020 2020 2020 2020 2020 2020  ir).            
+00013ca0: 2020 2020 2020 2020 7265 636f 6465 203d          recode =
+00013cb0: 2070 726f 6365 7373 2e77 6169 7428 290a   process.wait().
+00013cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013cd0: 2020 2020 636f 6465 2c20 6572 726f 7220      code, error 
+00013ce0: 3d20 7072 6f63 6573 732e 636f 6d6d 756e  = process.commun
+00013cf0: 6963 6174 6528 290a 2020 2020 2020 2020  icate().        
+00013d00: 2020 2020 2020 2020 2020 2020 6966 2072              if r
+00013d10: 6563 6f64 6520 3d3d 2030 3a0a 2020 2020  ecode == 0:.    
+00013d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013d30: 2020 2020 7072 696e 7428 2750 726f 6475      print('Produ
+00013d40: 6365 2066 696c 653a 2025 7320 7375 6363  ce file: %s succ
+00013d50: 6573 7366 756c 6c79 2720 2520 6d61 736b  essfully' % mask
+00013d60: 7674 7029 0a20 2020 2020 2020 2020 2020  vtp).           
+00013d70: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00013d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013d90: 2020 2020 2020 2070 7269 6e74 2863 6f64         print(cod
+00013da0: 652c 2065 7272 6f72 290a 2020 2020 2020  e, error).      
+00013db0: 2020 2020 2020 7265 7475 726e 206d 6173        return mas
+00013dc0: 6b73 0a0a 2020 2020 6465 6620 6d61 736b  ks..    def mask
+00013dd0: 7669 6577 7328 7365 6c66 293a 0a20 2020  views(self):.   
+00013de0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00013df0: 2020 2020 2047 656e 6572 6174 6520 6d61       Generate ma
+00013e00: 736b 2076 6965 7773 2062 7920 7573 696e  sk views by usin
+00013e10: 6720 7674 6b20 6d65 7468 6f64 0a0a 2020  g vtk method..  
+00013e20: 2020 2020 2020 3a72 6574 7572 6e3a 0a20        :return:. 
+00013e30: 2020 2020 2020 2022 2222 0a0a 2020 2020         """..    
+00013e40: 2020 2020 6d61 736b 7265 7375 6c74 203d      maskresult =
+00013e50: 205b 6974 656d 2066 6f72 2069 7465 6d20   [item for item 
+00013e60: 696e 2073 656c 662e 616c 6c6d 6173 6b73  in self.allmasks
+00013e70: 2069 6620 6f73 2e70 6174 682e 6973 6669   if os.path.isfi
+00013e80: 6c65 2869 7465 6d29 5d0a 2020 2020 2020  le(item)].      
+00013e90: 2020 6d61 736b 7364 6963 7420 3d20 6469    masksdict = di
+00013ea0: 6374 2829 0a20 2020 2020 2020 2069 6620  ct().        if 
+00013eb0: 6e6f 7420 6d61 736b 7265 7375 6c74 3a0a  not maskresult:.
+00013ec0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+00013ed0: 7428 2754 6865 7265 2069 7320 6e6f 206d  t('There is no m
+00013ee0: 6173 6b73 206f 6666 6572 6564 2066 6f72  asks offered for
+00013ef0: 2074 6869 7320 6d61 702e 2729 0a20 2020   this map.').   
+00013f00: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
+00013f10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00013f20: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00013f30: 2d2d 2d2d 2729 0a20 2020 2020 2020 2065  ----').        e
+00013f40: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00013f50: 206d 6173 6b73 203d 2073 656c 662e 6d61   masks = self.ma
+00013f60: 736b 7376 7470 286d 6173 6b72 6573 756c  sksvtp(maskresul
+00013f70: 7429 0a20 2020 2020 2020 2020 2020 2069  t).            i
+00013f80: 6620 6d61 736b 733a 0a20 2020 2020 2020  f masks:.       
+00013f90: 2020 2020 2020 2020 2072 6f6f 7420 3d20           root = 
+00013fa0: 6f73 2e70 6174 682e 6469 726e 616d 6528  os.path.dirname(
+00013fb0: 6d61 736b 735b 305d 290a 2020 2020 2020  masks[0]).      
+00013fc0: 2020 2020 2020 2020 2020 6d61 7076 7470            mapvtp
+00013fd0: 203d 2027 7b7d 2f7b 7d5f 7b7d 2e76 7470   = '{}/{}_{}.vtp
+00013fe0: 272e 666f 726d 6174 2873 656c 662e 776f  '.format(self.wo
+00013ff0: 726b 6469 722c 2073 656c 662e 6d61 706e  rkdir, self.mapn
+00014000: 616d 652c 2073 7472 2873 656c 662e 636c  ame, str(self.cl
+00014010: 2929 0a20 2020 2020 2020 2020 2020 2066  )).            f
+00014020: 6f72 206d 6173 6b20 696e 206d 6173 6b73  or mask in masks
+00014030: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00014040: 2020 6d61 736b 7364 6963 745b 6d61 736b    masksdict[mask
+00014050: 5d20 3d20 7365 6c66 2e6d 6173 6b76 6965  ] = self.maskvie
+00014060: 7773 5f76 746b 286d 6170 7674 702c 206d  ws_vtk(mapvtp, m
+00014070: 6173 6b29 0a20 2020 2020 2020 2020 2020  ask).           
+00014080: 2077 6974 6820 636f 6465 6373 2e6f 7065   with codecs.ope
+00014090: 6e28 7365 6c66 2e77 6f72 6b64 6972 202b  n(self.workdir +
+000140a0: 2073 656c 662e 6d61 706e 616d 6520 2b20   self.mapname + 
+000140b0: 275f 6d61 706d 6173 6b76 6965 772e 6a73  '_mapmaskview.js
+000140c0: 6f6e 272c 2027 7727 2c0a 2020 2020 2020  on', 'w',.      
+000140d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000140e0: 2020 2020 2020 2065 6e63 6f64 696e 673d         encoding=
+000140f0: 2775 7466 2d38 2729 2061 7320 663a 0a20  'utf-8') as f:. 
+00014100: 2020 2020 2020 2020 2020 2020 2020 206a                 j
+00014110: 736f 6e2e 6475 6d70 286d 6173 6b73 6469  son.dump(masksdi
+00014120: 6374 2c20 6629 0a0a 2020 2020 2020 2020  ct, f)..        
+00014130: 2020 2020 7072 696e 7428 274d 6173 6b73      print('Masks
+00014140: 2076 6965 7720 6279 2075 7369 6e67 2056   view by using V
+00014150: 544b 206d 6574 686f 642e 2729 0a20 2020  TK method.').   
+00014160: 2020 2020 2072 6574 7572 6e20 4e6f 6e65       return None
+00014170: 0a0a 2020 2020 6465 6620 6d61 736b 7669  ..    def maskvi
+00014180: 6577 6368 696d 6572 6128 7365 6c66 2c20  ewchimera(self, 
+00014190: 6368 696d 6572 6161 7070 293a 0a20 2020  chimeraapp):.   
+000141a0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+000141b0: 2020 2020 2047 656e 6572 6174 6520 6d61       Generate ma
+000141c0: 736b 2076 6965 7773 2062 7920 7573 696e  sk views by usin
+000141d0: 6720 6368 696d 6572 6120 6d65 7468 6f64  g chimera method
+000141e0: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
+000141f0: 3a0a 2020 2020 2020 2020 2222 220a 0a20  :.        """.. 
+00014200: 2020 2020 2020 2073 7461 7274 203d 2074         start = t
+00014210: 696d 6569 742e 6465 6661 756c 745f 7469  imeit.default_ti
+00014220: 6d65 7228 290a 2020 2020 2020 2020 6572  mer().        er
+00014230: 726c 6973 7420 3d20 5b5d 0a20 2020 2020  rlist = [].     
+00014240: 2020 206d 6173 6b72 6573 756c 7473 203d     maskresults =
+00014250: 205b 6974 656d 2066 6f72 2069 7465 6d20   [item for item 
+00014260: 696e 2073 656c 662e 616c 6c6d 6173 6b73  in self.allmasks
+00014270: 2069 6620 6f73 2e70 6174 682e 6973 6669   if os.path.isfi
+00014280: 6c65 2873 656c 662e 776f 726b 6469 7220  le(self.workdir 
+00014290: 2b20 6f73 2e70 6174 682e 6261 7365 6e61  + os.path.basena
+000142a0: 6d65 2869 7465 6d29 295d 0a20 2020 2020  me(item))].     
+000142b0: 2020 206d 6173 6b73 6469 6374 203d 2064     masksdict = d
+000142c0: 6963 7428 290a 2020 2020 2020 2020 6669  ict().        fi
+000142d0: 6e61 6c64 6963 7420 3d20 6469 6374 2829  naldict = dict()
+000142e0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+000142f0: 6d61 736b 7265 7375 6c74 733a 0a20 2020  maskresults:.   
+00014300: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
+00014310: 5468 6572 6520 6973 206e 6f20 6d61 736b  There is no mask
+00014320: 7320 6f66 6665 7265 6420 666f 7220 7468  s offered for th
+00014330: 6973 206d 6170 2e27 290a 2020 2020 2020  is map.').      
+00014340: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00014350: 2020 2020 2320 666f 7220 6d61 736b 2069      # for mask i
+00014360: 6e20 6d61 736b 7265 7375 6c74 733a 0a20  n maskresults:. 
+00014370: 2020 2020 2020 2020 2020 2066 6f72 206d             for m
+00014380: 6173 6b20 696e 2073 656c 662e 616c 6c6d  ask in self.allm
+00014390: 6173 6b73 3a0a 2020 2020 2020 2020 2020  asks:.          
+000143a0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+000143b0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+000143c0: 6173 6b73 6469 6374 5b6f 732e 7061 7468  asksdict[os.path
+000143d0: 2e62 6173 656e 616d 6528 6d61 736b 295d  .basename(mask)]
+000143e0: 203d 2073 656c 662e 6d61 736b 7669 6577   = self.maskview
+000143f0: 735f 6368 696d 6572 6128 6d61 736b 2c20  s_chimera(mask, 
+00014400: 6368 696d 6572 6161 7070 290a 2020 2020  chimeraapp).    
+00014410: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+00014420: 7074 3a0a 2020 2020 2020 2020 2020 2020  pt:.            
+00014430: 2020 2020 2020 2020 6572 7220 3d20 2753          err = 'S
+00014440: 6176 696e 6720 6d61 736b 207b 7d20 7669  aving mask {} vi
+00014450: 6577 7320 6572 726f 723a 207b 7d2e 272e  ews error: {}.'.
+00014460: 666f 726d 6174 286d 6173 6b2c 2073 7973  format(mask, sys
+00014470: 2e65 7863 5f69 6e66 6f28 295b 315d 290a  .exc_info()[1]).
+00014480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014490: 2020 2020 6572 726c 6973 742e 6170 7065      errlist.appe
+000144a0: 6e64 2865 7272 290a 2020 2020 2020 2020  nd(err).        
+000144b0: 2020 2020 2020 2020 2020 2020 7379 732e              sys.
+000144c0: 7374 6465 7272 2e77 7269 7465 2865 7272  stderr.write(err
+000144d0: 202b 2027 5c6e 2729 0a20 2020 2020 2020   + '\n').       
+000144e0: 2020 2020 2069 6620 6572 726c 6973 743a       if errlist:
+000144f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014500: 206d 6173 6b73 6469 6374 5b27 6572 7227   masksdict['err'
+00014510: 5d20 3d20 7b27 6d61 736b 5f76 6965 775f  ] = {'mask_view_
+00014520: 6572 7227 3a20 6572 726c 6973 747d 0a20  err': errlist}. 
+00014530: 2020 2020 2020 2020 2020 2066 696e 616c             final
+00014540: 6469 6374 5b27 6d61 736b 7327 5d20 3d20  dict['masks'] = 
+00014550: 6d61 736b 7364 6963 740a 2020 2020 2020  masksdict.      
+00014560: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00014570: 2020 2020 2020 2020 2020 2077 6974 6820             with 
+00014580: 636f 6465 6373 2e6f 7065 6e28 7365 6c66  codecs.open(self
+00014590: 2e77 6f72 6b64 6972 202b 2073 656c 662e  .workdir + self.
+000145a0: 6d61 706e 616d 6520 2b20 275f 6d61 706d  mapname + '_mapm
+000145b0: 6173 6b76 6965 772e 6a73 6f6e 272c 2027  askview.json', '
+000145c0: 7727 2c0a 2020 2020 2020 2020 2020 2020  w',.            
+000145d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000145e0: 2020 2020 2065 6e63 6f64 696e 673d 2775       encoding='u
+000145f0: 7466 2d38 2729 2061 7320 663a 0a20 2020  tf-8') as f:.   
+00014600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014610: 206a 736f 6e2e 6475 6d70 2866 696e 616c   json.dump(final
+00014620: 6469 6374 2c20 6629 0a20 2020 2020 2020  dict, f).       
+00014630: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
+00014640: 4d61 736b 7320 7669 6577 2062 7920 7573  Masks view by us
+00014650: 696e 6720 4368 696d 6572 6158 206d 6574  ing ChimeraX met
+00014660: 686f 642e 2729 0a20 2020 2020 2020 2020  hod.').         
+00014670: 2020 2065 7863 6570 743a 0a20 2020 2020     except:.     
+00014680: 2020 2020 2020 2020 2020 2073 7973 2e73             sys.s
+00014690: 7464 6572 722e 7772 6974 6528 2753 6176  tderr.write('Sav
+000146a0: 696e 6720 6d61 736b 7320 746f 206a 736f  ing masks to jso
+000146b0: 6e20 6572 726f 723a 207b 7d2e 5c6e 272e  n error: {}.\n'.
+000146c0: 666f 726d 6174 2873 7973 2e65 7863 5f69  format(sys.exc_i
+000146d0: 6e66 6f28 295b 315d 2929 0a0a 2020 2020  nfo()[1]))..    
+000146e0: 2020 2020 656e 6420 3d20 7469 6d65 6974      end = timeit
+000146f0: 2e64 6566 6175 6c74 5f74 696d 6572 2829  .default_timer()
+00014700: 0a20 2020 2020 2020 2070 7269 6e74 2827  .        print('
+00014710: 4d61 736b 7669 6577 2074 696d 653a 207b  Maskview time: {
+00014720: 7d27 2e66 6f72 6d61 7428 656e 642d 7374  }'.format(end-st
+00014730: 6172 7429 290a 2020 2020 2020 2020 7072  art)).        pr
+00014740: 696e 7428 272d 2d2d 2d2d 2d2d 2d2d 2d2d  int('-----------
+00014750: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00014760: 2d2d 2d2d 2d2d 2d2d 2d27 290a 2020 2020  ---------').    
+00014770: 2020 2020 7265 7475 726e 204e 6f6e 650a      return None.
+00014780: 0a20 2020 2064 6566 206d 6173 6b76 6965  .    def maskvie
+00014790: 7773 5f76 746b 2873 656c 662c 206d 6170  ws_vtk(self, map
+000147a0: 7674 702c 206d 6173 6b76 7470 293a 0a20  vtp, maskvtp):. 
+000147b0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+000147c0: 2020 2020 2020 2055 7369 6e67 2074 6865         Using the
+000147d0: 2076 746b 206d 6574 686f 6420 746f 2067   vtk method to g
+000147e0: 656e 6572 6174 6520 6d61 736b 2076 6965  enerate mask vie
+000147f0: 7773 0a0a 2020 2020 2020 2020 3a72 6574  ws..        :ret
+00014800: 7572 6e3a 0a20 2020 2020 2020 2022 2222  urn:.        """
+00014810: 0a0a 2020 2020 2020 2020 726f 6f74 203d  ..        root =
+00014820: 206f 732e 7061 7468 2e64 6972 6e61 6d65   os.path.dirname
+00014830: 286d 6173 6b76 7470 290a 2020 2020 2020  (maskvtp).      
+00014840: 2020 6d61 736b 7674 7066 696c 6520 3d20    maskvtpfile = 
+00014850: 6d61 736b 7674 705b 3a2d 345d 2e73 706c  maskvtp[:-4].spl
+00014860: 6974 2827 2f27 295b 2d31 5d0a 2020 2020  it('/')[-1].    
+00014870: 2020 2020 6d61 7076 7470 203d 2072 6f6f      mapvtp = roo
+00014880: 7420 2b20 272f 2720 2b20 7365 6c66 2e6d  t + '/' + self.m
+00014890: 6170 6e61 6d65 202b 2027 5f27 202b 2073  apname + '_' + s
+000148a0: 7472 2873 656c 662e 636c 2920 2b20 272e  tr(self.cl) + '.
+000148b0: 7674 7027 0a0a 0a20 2020 2020 2020 2066  vtp'...        f
+000148c0: 6163 7447 7261 7068 6963 7320 3d20 7674  actGraphics = vt
+000148d0: 6b2e 7674 6b47 7261 7068 6963 7346 6163  k.vtkGraphicsFac
+000148e0: 746f 7279 2829 0a20 2020 2020 2020 2066  tory().        f
+000148f0: 6163 7447 7261 7068 6963 732e 5365 744f  actGraphics.SetO
+00014900: 6666 5363 7265 656e 4f6e 6c79 4d6f 6465  ffScreenOnlyMode
+00014910: 2831 290a 2020 2020 2020 2020 6661 6374  (1).        fact
+00014920: 4772 6170 6869 6373 2e53 6574 5573 654d  Graphics.SetUseM
+00014930: 6573 6143 6c61 7373 6573 2831 290a 2020  esaClasses(1).  
+00014940: 2020 2020 2020 7265 6164 6572 203d 2076        reader = v
+00014950: 746b 2e76 746b 584d 4c50 6f6c 7944 6174  tk.vtkXMLPolyDat
+00014960: 6152 6561 6465 7228 290a 2020 2020 2020  aReader().      
+00014970: 2020 7265 6164 6572 2e53 6574 4669 6c65    reader.SetFile
+00014980: 4e61 6d65 286d 6170 7674 7029 0a20 2020  Name(mapvtp).   
+00014990: 2020 2020 2072 6561 6465 722e 5570 6461       reader.Upda
+000149a0: 7465 2829 0a0a 2020 2020 2020 2020 2320  te()..        # 
+000149b0: 6164 6420 6d61 7020 7674 7020 696e 746f  add map vtp into
+000149c0: 2069 740a 2020 2020 2020 2020 6d61 705f   it.        map_
+000149d0: 7265 6164 6572 203d 2076 746b 2e76 746b  reader = vtk.vtk
+000149e0: 584d 4c50 6f6c 7944 6174 6152 6561 6465  XMLPolyDataReade
+000149f0: 7228 290a 2020 2020 2020 2020 6d61 705f  r().        map_
+00014a00: 7265 6164 6572 2e53 6574 4669 6c65 4e61  reader.SetFileNa
+00014a10: 6d65 286d 6173 6b76 7470 290a 2020 2020  me(maskvtp).    
+00014a20: 2020 2020 6d61 705f 6d61 7070 6572 203d      map_mapper =
+00014a30: 2076 746b 2e76 746b 506f 6c79 4461 7461   vtk.vtkPolyData
+00014a40: 4d61 7070 6572 2829 0a20 2020 2020 2020  Mapper().       
+00014a50: 206d 6170 5f6d 6170 7065 722e 5363 616c   map_mapper.Scal
+00014a60: 6172 5669 7369 6269 6c69 7479 4f66 6628  arVisibilityOff(
+00014a70: 290a 2020 2020 2020 2020 6d61 705f 6d61  ).        map_ma
+00014a80: 7070 6572 2e53 6574 496e 7075 7443 6f6e  pper.SetInputCon
+00014a90: 6e65 6374 696f 6e28 6d61 705f 7265 6164  nection(map_read
+00014aa0: 6572 2e47 6574 4f75 7470 7574 506f 7274  er.GetOutputPort
+00014ab0: 2829 290a 2020 2020 2020 2020 6d61 705f  ()).        map_
+00014ac0: 6163 746f 7220 3d20 7674 6b2e 7674 6b41  actor = vtk.vtkA
+00014ad0: 6374 6f72 2829 0a20 2020 2020 2020 206d  ctor().        m
+00014ae0: 6170 5f61 6374 6f72 2e53 6574 4d61 7070  ap_actor.SetMapp
+00014af0: 6572 286d 6170 5f6d 6170 7065 7229 0a0a  er(map_mapper)..
+00014b00: 2020 2020 2020 2020 6d61 705f 6163 746f          map_acto
+00014b10: 722e 4765 7450 726f 7065 7274 7928 292e  r.GetProperty().
+00014b20: 5365 7443 6f6c 6f72 2830 2e30 2c20 302e  SetColor(0.0, 0.
+00014b30: 302c 2031 2e30 290a 2020 2020 2020 2020  0, 1.0).        
+00014b40: 6d61 705f 6163 746f 722e 4765 7450 726f  map_actor.GetPro
+00014b50: 7065 7274 7928 292e 5365 7449 6e74 6572  perty().SetInter
+00014b60: 706f 6c61 7469 6f6e 546f 5068 6f6e 6728  polationToPhong(
+00014b70: 290a 2020 2020 2020 2020 6d61 705f 6163  ).        map_ac
+00014b80: 746f 722e 4765 7450 726f 7065 7274 7928  tor.GetProperty(
+00014b90: 292e 5365 7444 6966 6675 7365 2830 2e39  ).SetDiffuse(0.9
+00014ba0: 290a 2020 2020 2020 2020 6d61 705f 6163  ).        map_ac
+00014bb0: 746f 722e 4765 7450 726f 7065 7274 7928  tor.GetProperty(
+00014bc0: 292e 5365 7453 7065 6375 6c61 7228 302e  ).SetSpecular(0.
+00014bd0: 3629 0a20 2020 2020 2020 206d 6170 5f61  6).        map_a
+00014be0: 6374 6f72 2e47 6574 5072 6f70 6572 7479  ctor.GetProperty
+00014bf0: 2829 2e53 6574 5370 6563 756c 6172 506f  ().SetSpecularPo
+00014c00: 7765 7228 3330 290a 2020 2020 2020 2020  wer(30).        
+00014c10: 6d61 705f 6163 746f 722e 4765 7450 726f  map_actor.GetPro
+00014c20: 7065 7274 7928 292e 4261 636b 6661 6365  perty().Backface
+00014c30: 4375 6c6c 696e 674f 6e28 290a 2020 2020  CullingOn().    
+00014c40: 2020 2020 6d61 705f 6163 746f 722e 4765      map_actor.Ge
+00014c50: 7450 726f 7065 7274 7928 292e 4672 6f6e  tProperty().Fron
+00014c60: 7466 6163 6543 756c 6c69 6e67 4f6e 2829  tfaceCullingOn()
+00014c70: 0a20 2020 2020 2020 2023 2323 2323 2323  .        #######
+00014c80: 2323 2323 230a 0a20 2020 2020 2020 206d  #####..        m
+00014c90: 6170 7065 7220 3d20 7674 6b2e 7674 6b50  apper = vtk.vtkP
+00014ca0: 6f6c 7944 6174 614d 6170 7065 7228 290a  olyDataMapper().
+00014cb0: 2020 2020 2020 2020 6d61 7070 6572 2e53          mapper.S
+00014cc0: 6361 6c61 7256 6973 6962 696c 6974 794f  calarVisibilityO
+00014cd0: 6666 2829 0a20 2020 2020 2020 206d 6170  ff().        map
+00014ce0: 7065 722e 5365 7449 6e70 7574 436f 6e6e  per.SetInputConn
+00014cf0: 6563 7469 6f6e 2872 6561 6465 722e 4765  ection(reader.Ge
+00014d00: 744f 7574 7075 7450 6f72 7428 2929 0a0a  tOutputPort())..
+00014d10: 2020 2020 2020 2020 6163 746f 7220 3d20          actor = 
+00014d20: 7674 6b2e 7674 6b41 6374 6f72 2829 0a20  vtk.vtkActor(). 
+00014d30: 2020 2020 2020 2061 6374 6f72 2e53 6574         actor.Set
+00014d40: 4d61 7070 6572 286d 6170 7065 7229 0a20  Mapper(mapper). 
+00014d50: 2020 2020 2020 2061 6374 6f72 2e47 6574         actor.Get
+00014d60: 5072 6f70 6572 7479 2829 2e53 6574 436f  Property().SetCo
+00014d70: 6c6f 7228 312e 302c 2030 2e38 2c20 302e  lor(1.0, 0.8, 0.
+00014d80: 3129 0a20 2020 2020 2020 2061 6374 6f72  1).        actor
+00014d90: 2e47 6574 5072 6f70 6572 7479 2829 2e53  .GetProperty().S
+00014da0: 6574 496e 7465 7270 6f6c 6174 696f 6e54  etInterpolationT
+00014db0: 6f50 686f 6e67 2829 0a20 2020 2020 2020  oPhong().       
+00014dc0: 2061 6374 6f72 2e47 6574 5072 6f70 6572   actor.GetProper
+00014dd0: 7479 2829 2e53 6574 4469 6666 7573 6528  ty().SetDiffuse(
+00014de0: 302e 3929 0a20 2020 2020 2020 2061 6374  0.9).        act
+00014df0: 6f72 2e47 6574 5072 6f70 6572 7479 2829  or.GetProperty()
+00014e00: 2e53 6574 5370 6563 756c 6172 2830 2e36  .SetSpecular(0.6
+00014e10: 290a 2020 2020 2020 2020 6163 746f 722e  ).        actor.
+00014e20: 4765 7450 726f 7065 7274 7928 292e 5365  GetProperty().Se
+00014e30: 7453 7065 6375 6c61 7250 6f77 6572 2833  tSpecularPower(3
+00014e40: 3029 0a20 2020 2020 2020 2061 6374 6f72  0).        actor
+00014e50: 2e47 6574 5072 6f70 6572 7479 2829 2e42  .GetProperty().B
+00014e60: 6163 6b66 6163 6543 756c 6c69 6e67 4f6e  ackfaceCullingOn
+00014e70: 2829 0a20 2020 2020 2020 2061 6374 6f72  ().        actor
+00014e80: 2e47 6574 5072 6f70 6572 7479 2829 2e46  .GetProperty().F
+00014e90: 726f 6e74 6661 6365 4375 6c6c 696e 674f  rontfaceCullingO
+00014ea0: 6e28 290a 2020 2020 2020 2020 6163 746f  n().        acto
+00014eb0: 722e 4765 7450 726f 7065 7274 7928 292e  r.GetProperty().
+00014ec0: 5365 744f 7061 6369 7479 2830 2e35 290a  SetOpacity(0.5).
+00014ed0: 0a20 2020 2020 2020 2023 2043 7265 6174  .        # Creat
+00014ee0: 6520 7468 6520 6772 6170 6869 6373 2073  e the graphics s
+00014ef0: 7472 7563 7475 7265 2e20 5468 6520 7265  tructure. The re
+00014f00: 6e64 6572 6572 2072 656e 6465 7273 2069  nderer renders i
+00014f10: 6e74 6f20 7468 6520 7265 6e64 6572 0a20  nto the render. 
+00014f20: 2020 2020 2020 2023 2077 696e 646f 772e         # window.
+00014f30: 2054 6865 2072 656e 6465 7220 7769 6e64   The render wind
+00014f40: 6f77 2069 6e74 6572 6163 746f 7220 6361  ow interactor ca
+00014f50: 7074 7572 6573 206d 6f75 7365 2065 7665  ptures mouse eve
+00014f60: 6e74 7320 616e 6420 7769 6c6c 0a20 2020  nts and will.   
+00014f70: 2020 2020 2023 2070 6572 666f 726d 2061       # perform a
+00014f80: 7070 726f 7072 6961 7465 2063 616d 6572  ppropriate camer
+00014f90: 6120 6f72 2061 6374 6f72 206d 616e 6970  a or actor manip
+00014fa0: 756c 6174 696f 6e20 6465 7065 6e64 696e  ulation dependin
+00014fb0: 6720 6f6e 2074 6865 0a20 2020 2020 2020  g on the.       
+00014fc0: 2023 206e 6174 7572 6520 6f66 2074 6865   # nature of the
+00014fd0: 2065 7665 6e74 732e 0a0a 2020 2020 2020   events...      
+00014fe0: 2020 7265 6e20 3d20 7674 6b2e 7674 6b52    ren = vtk.vtkR
+00014ff0: 656e 6465 7265 7228 290a 2020 2020 2020  enderer().      
+00015000: 2020 7265 6e57 696e 203d 2076 746b 2e76    renWin = vtk.v
+00015010: 746b 5265 6e64 6572 5769 6e64 6f77 2829  tkRenderWindow()
+00015020: 0a20 2020 2020 2020 2072 656e 5769 6e2e  .        renWin.
+00015030: 5365 744f 6666 5363 7265 656e 5265 6e64  SetOffScreenRend
+00015040: 6572 696e 6728 3129 0a20 2020 2020 2020  ering(1).       
+00015050: 2072 656e 5769 6e2e 5365 7453 697a 6528   renWin.SetSize(
+00015060: 3330 3030 2c20 3330 3030 290a 2020 2020  3000, 3000).    
+00015070: 2020 2020 7265 6e57 696e 2e41 6464 5265      renWin.AddRe
+00015080: 6e64 6572 6572 2872 656e 290a 0a20 2020  nderer(ren)..   
+00015090: 2020 2020 2023 2041 6464 2074 6865 2061       # Add the a
+000150a0: 6374 6f72 7320 746f 2074 6865 2072 656e  ctors to the ren
+000150b0: 6465 7265 722c 2073 6574 2074 6865 2062  derer, set the b
+000150c0: 6163 6b67 726f 756e 6420 616e 6420 7369  ackground and si
+000150d0: 7a65 0a20 2020 2020 2020 2023 2061 6374  ze.        # act
+000150e0: 6f72 2e52 6f74 6174 6559 2839 3029 0a20  or.RotateY(90). 
+000150f0: 2020 2020 2020 2072 656e 2e41 6464 4163         ren.AddAc
+00015100: 746f 7228 6163 746f 7229 0a20 2020 2020  tor(actor).     
+00015110: 2020 2072 656e 2e41 6464 4163 746f 7228     ren.AddActor(
+00015120: 6d61 705f 6163 746f 7229 0a20 2020 2020  map_actor).     
+00015130: 2020 2072 656e 2e53 6574 4261 636b 6772     ren.SetBackgr
+00015140: 6f75 6e64 2830 2e39 2c20 302e 392c 2030  ound(0.9, 0.9, 0
+00015150: 2e39 290a 2020 2020 2020 2020 7265 6e2e  .9).        ren.
+00015160: 4765 7441 6374 6976 6543 616d 6572 6128  GetActiveCamera(
+00015170: 292e 5365 7450 6172 616c 6c65 6c50 726f  ).SetParallelPro
+00015180: 6a65 6374 696f 6e28 3129 0a20 2020 2020  jection(1).     
+00015190: 2020 2072 656e 5769 6e2e 5265 6e64 6572     renWin.Render
+000151a0: 2829 0a0a 2020 2020 2020 2020 2320 4f75  ()..        # Ou
+000151b0: 7470 7574 206d 6170 7320 696d 6167 6573  tput maps images
+000151c0: 206f 6e6c 790a 2020 2020 2020 2020 7265   only.        re
+000151d0: 6e2e 5265 7365 7443 616d 6572 6128 290a  n.ResetCamera().
+000151e0: 2020 2020 2020 2020 7265 6e2e 4765 7441          ren.GetA
+000151f0: 6374 6976 6543 616d 6572 6128 292e 5a6f  ctiveCamera().Zo
+00015200: 6f6d 2831 2e33 3029 0a20 2020 2020 2020  om(1.30).       
+00015210: 206f 7574 7a69 6d61 6765 203d 2027 7b7d   outzimage = '{}
+00015220: 7b7d 5f7a 6d61 736b 2e6a 7065 6727 2e66  {}_zmask.jpeg'.f
+00015230: 6f72 6d61 7428 7365 6c66 2e77 6f72 6b64  ormat(self.workd
+00015240: 6972 2c20 6d61 736b 7674 7066 696c 6529  ir, maskvtpfile)
+00015250: 0a20 2020 2020 2020 2073 656c 662e 7772  .        self.wr
+00015260: 6974 655f 696d 6167 6528 6f75 747a 696d  ite_image(outzim
+00015270: 6167 652c 2072 656e 5769 6e29 0a0a 2020  age, renWin)..  
+00015280: 2020 2020 2020 6163 746f 722e 526f 7461        actor.Rota
+00015290: 7465 5828 3930 290a 2020 2020 2020 2020  teX(90).        
+000152a0: 6163 746f 722e 526f 7461 7465 5928 3930  actor.RotateY(90
+000152b0: 290a 2020 2020 2020 2020 6d61 705f 6163  ).        map_ac
+000152c0: 746f 722e 526f 7461 7465 5828 3930 290a  tor.RotateX(90).
+000152d0: 2020 2020 2020 2020 6d61 705f 6163 746f          map_acto
+000152e0: 722e 526f 7461 7465 5928 3930 290a 2020  r.RotateY(90).  
+000152f0: 2020 2020 2020 2320 7265 6e2e 5265 7365        # ren.Rese
+00015300: 7443 616d 6572 6128 290a 2020 2020 2020  tCamera().      
+00015310: 2020 6f75 7479 696d 6167 6520 3d20 277b    outyimage = '{
+00015320: 7d7b 7d5f 796d 6173 6b2e 6a70 6567 272e  }{}_ymask.jpeg'.
+00015330: 666f 726d 6174 2873 656c 662e 776f 726b  format(self.work
+00015340: 6469 722c 206d 6173 6b76 7470 6669 6c65  dir, maskvtpfile
+00015350: 290a 2020 2020 2020 2020 7365 6c66 2e77  ).        self.w
+00015360: 7269 7465 5f69 6d61 6765 286f 7574 7969  rite_image(outyi
+00015370: 6d61 6765 2c20 7265 6e57 696e 290a 0a20  mage, renWin).. 
+00015380: 2020 2020 2020 2061 6374 6f72 2e52 6f74         actor.Rot
+00015390: 6174 655a 2839 3029 0a20 2020 2020 2020  ateZ(90).       
+000153a0: 2061 6374 6f72 2e52 6f74 6174 6558 2839   actor.RotateX(9
+000153b0: 3029 0a20 2020 2020 2020 206d 6170 5f61  0).        map_a
+000153c0: 6374 6f72 2e52 6f74 6174 655a 2839 3029  ctor.RotateZ(90)
+000153d0: 0a20 2020 2020 2020 206d 6170 5f61 6374  .        map_act
+000153e0: 6f72 2e52 6f74 6174 6558 2839 3029 0a20  or.RotateX(90). 
+000153f0: 2020 2020 2020 2023 2072 656e 2e52 6573         # ren.Res
+00015400: 6574 4361 6d65 7261 2829 0a20 2020 2020  etCamera().     
+00015410: 2020 206f 7574 7869 6d61 6765 203d 2027     outximage = '
+00015420: 7b7d 7b7d 5f78 6d61 736b 2e6a 7065 6727  {}{}_xmask.jpeg'
+00015430: 2e66 6f72 6d61 7428 7365 6c66 2e77 6f72  .format(self.wor
+00015440: 6b64 6972 2c20 6d61 736b 7674 7066 696c  kdir, maskvtpfil
+00015450: 6529 0a20 2020 2020 2020 2073 656c 662e  e).        self.
+00015460: 7772 6974 655f 696d 6167 6528 6f75 7478  write_image(outx
+00015470: 696d 6167 652c 2072 656e 5769 6e29 0a20  image, renWin). 
+00015480: 2020 2020 2020 2073 656c 662e 7363 616c         self.scal
+00015490: 655f 6d61 736b 696d 6728 290a 0a20 2020  e_maskimg()..   
+000154a0: 2020 2020 206f 6e65 6d61 736b 6469 6374       onemaskdict
+000154b0: 203d 2064 6963 7428 290a 2020 2020 2020   = dict().      
+000154c0: 2020 6f6e 656d 6173 6b64 6963 745b 2778    onemaskdict['x
+000154d0: 275d 203d 206f 732e 7061 7468 2e62 6173  '] = os.path.bas
+000154e0: 656e 616d 6528 6f75 7478 696d 6167 6529  ename(outximage)
+000154f0: 2069 6620 6f73 2e70 6174 682e 6973 6669   if os.path.isfi
+00015500: 6c65 286f 7574 7869 6d61 6765 2920 656c  le(outximage) el
+00015510: 7365 204e 6f6e 650a 2020 2020 2020 2020  se None.        
+00015520: 6f6e 656d 6173 6b64 6963 745b 2779 275d  onemaskdict['y']
+00015530: 203d 206f 732e 7061 7468 2e62 6173 656e   = os.path.basen
+00015540: 616d 6528 6f75 7479 696d 6167 6529 2069  ame(outyimage) i
+00015550: 6620 6f73 2e70 6174 682e 6973 6669 6c65  f os.path.isfile
+00015560: 286f 7574 7969 6d61 6765 2920 656c 7365  (outyimage) else
+00015570: 204e 6f6e 650a 2020 2020 2020 2020 6f6e   None.        on
+00015580: 656d 6173 6b64 6963 745b 277a 275d 203d  emaskdict['z'] =
+00015590: 206f 732e 7061 7468 2e62 6173 656e 616d   os.path.basenam
+000155a0: 6528 6f75 747a 696d 6167 6529 2069 6620  e(outzimage) if 
+000155b0: 6f73 2e70 6174 682e 6973 6669 6c65 286f  os.path.isfile(o
+000155c0: 7574 7a69 6d61 6765 2920 656c 7365 204e  utzimage) else N
+000155d0: 6f6e 650a 0a20 2020 2020 2020 2072 6574  one..        ret
+000155e0: 7572 6e20 6f6e 656d 6173 6b64 6963 740a  urn onemaskdict.
+000155f0: 0a20 2020 2064 6566 206d 6173 6b76 6965  .    def maskvie
+00015600: 7773 5f63 6869 6d65 7261 2873 656c 662c  ws_chimera(self,
+00015610: 206d 6173 6b2c 2063 6869 6d65 7261 6170   mask, chimeraap
+00015620: 7029 3a0a 2020 2020 2020 2020 2222 220a  p):.        """.
+00015630: 2020 2020 2020 2020 2020 2020 4765 6e65              Gene
+00015640: 7261 7465 206d 6173 6b20 7669 6577 2062  rate mask view b
+00015650: 7920 7573 696e 6720 4368 696d 6572 6158  y using ChimeraX
+00015660: 0a20 2020 2020 2020 2020 2020 2054 6f64  .            Tod
+00015670: 6f3a 2061 2063 6f6e 746f 7572 206c 6576  o: a contour lev
+00015680: 656c 206e 6565 6465 6420 6865 7265 2066  el needed here f
+00015690: 6f72 2074 6865 206d 6173 6b0a 0a20 2020  or the mask..   
+000156a0: 2020 2020 203a 7265 7475 726e 3a0a 2020       :return:.  
+000156b0: 2020 2020 2020 2222 220a 0a20 2020 2020        """..     
+000156c0: 2020 2023 206d 6170 6e61 6d65 203d 2073     # mapname = s
+000156d0: 656c 662e 776f 726b 6469 7220 2b20 7365  elf.workdir + se
+000156e0: 6c66 2e6d 6170 6e61 6d65 202b 2027 2e6d  lf.mapname + '.m
+000156f0: 6170 270a 2020 2020 2020 2020 6572 726c  ap'.        errl
+00015700: 6973 7420 3d20 5b5d 0a20 2020 2020 2020  ist = [].       
+00015710: 2073 7461 7274 203d 2074 696d 6569 742e   start = timeit.
+00015720: 6465 6661 756c 745f 7469 6d65 7228 290a  default_timer().
+00015730: 2020 2020 2020 2020 6d61 706e 616d 6520          mapname 
+00015740: 3d20 7365 6c66 2e77 6f72 6b64 6972 202b  = self.workdir +
+00015750: 2073 656c 662e 6d61 706e 616d 650a 2020   self.mapname.  
+00015760: 2020 2020 2020 6d61 736b 6e61 6d65 203d        maskname =
+00015770: 206d 6173 6b2e 7370 6c69 7428 272f 2729   mask.split('/')
+00015780: 5b2d 315d 0a20 2020 2020 2020 2072 6567  [-1].        reg
+00015790: 5f6d 6173 6b6e 616d 6520 3d20 7265 2e73  _maskname = re.s
+000157a0: 6561 7263 6828 2765 6d64 5f2e 2a5f 6d73  earch('emd_.*_ms
+000157b0: 6b2e 6d61 7027 2c20 6d61 736b 6e61 6d65  k.map', maskname
+000157c0: 290a 2020 2020 2020 2020 6966 2072 6567  ).        if reg
+000157d0: 5f6d 6173 6b6e 616d 653a 0a20 2020 2020  _maskname:.     
+000157e0: 2020 2020 2020 206f 7574 5f6d 6173 6b6e         out_maskn
+000157f0: 616d 6520 3d20 277b 7d5f 312e 6d61 7027  ame = '{}_1.map'
+00015800: 2e66 6f72 6d61 7428 6d61 736b 6e61 6d65  .format(maskname
+00015810: 5b3a 2d34 5d29 0a20 2020 2020 2020 2020  [:-4]).         
+00015820: 2020 2070 7269 6e74 2827 2121 204d 6173     print('!! Mas
+00015830: 6b20 6e61 6d65 2069 7320 6f6c 6420 2121  k name is old !!
+00015840: 2729 0a20 2020 2020 2020 2065 6c73 653a  ').        else:
+00015850: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
+00015860: 5f6d 6173 6b6e 616d 6520 3d20 6d61 736b  _maskname = mask
+00015870: 6e61 6d65 0a20 2020 2020 2020 206d 6173  name.        mas
+00015880: 6b66 6e20 3d20 277b 7d5f 7b7d 272e 666f  kfn = '{}_{}'.fo
+00015890: 726d 6174 286d 6173 6b6e 616d 652c 2073  rmat(maskname, s
+000158a0: 656c 662e 6d61 706e 616d 6529 0a20 2020  elf.mapname).   
+000158b0: 2020 2020 2063 6869 6d65 7261 636d 6420       chimeracmd 
+000158c0: 3d20 6d61 736b 666e 202b 2027 5f63 6869  = maskfn + '_chi
+000158d0: 6d65 7261 2e63 7863 270a 2020 2020 2020  mera.cxc'.      
+000158e0: 2020 6c6f 6343 4849 4d45 5241 203d 2063    locCHIMERA = c
+000158f0: 6869 6d65 7261 6170 700a 2020 2020 2020  himeraapp.      
+00015900: 2020 6269 6e64 6973 706c 6179 203d 206f    bindisplay = o
+00015910: 732e 6765 7465 6e76 2827 4449 5350 4c41  s.getenv('DISPLA
+00015920: 5927 290a 2020 2020 2020 2020 6d73 6b63  Y').        mskc
+00015930: 6c20 3d20 7365 6c66 2e61 6c6c 6d61 736b  l = self.allmask
+00015940: 735b 6d61 736b 5d0a 0a20 2020 2020 2020  s[mask]..       
+00015950: 2023 2069 6620 286d 736b 636c 2061 6e64   # if (mskcl and
+00015960: 2073 656c 662e 636c 2920 6973 206e 6f74   self.cl) is not
+00015970: 204e 6f6e 653a 0a20 2020 2020 2020 206d   None:.        m
+00015980: 6574 5f63 6865 636b 203d 2046 616c 7365  et_check = False
+00015990: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+000159a0: 2e6d 6574 203d 3d20 2774 6f6d 6f27 3a0a  .met == 'tomo':.
+000159b0: 2020 2020 2020 2020 2020 2020 6966 206d              if m
+000159c0: 736b 636c 2069 7320 6e6f 7420 4e6f 6e65  skcl is not None
+000159d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000159e0: 2020 6d65 745f 6368 6563 6b20 3d20 5472    met_check = Tr
+000159f0: 7565 0a20 2020 2020 2020 2065 6c69 6620  ue.        elif 
+00015a00: 7365 6c66 2e6d 6574 203d 3d20 2773 7027  self.met == 'sp'
+00015a10: 206f 7220 7365 6c66 2e6d 6574 203d 3d20   or self.met == 
+00015a20: 2768 656c 6927 206f 7220 7365 6c66 2e6d  'heli' or self.m
+00015a30: 6574 203d 3d20 2773 7562 746f 6d6f 2720  et == 'subtomo' 
+00015a40: 6f72 2073 656c 662e 6d65 7420 3d3d 2027  or self.met == '
+00015a50: 3264 6372 7973 273a 0a20 2020 2020 2020  2dcrys':.       
+00015a60: 2020 2020 2069 6620 286d 736b 636c 2061       if (mskcl a
+00015a70: 6e64 2073 656c 662e 636c 2920 6973 206e  nd self.cl) is n
+00015a80: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00015a90: 2020 2020 2020 2020 206d 6574 5f63 6865           met_che
+00015aa0: 636b 203d 2054 7275 650a 2020 2020 2020  ck = True.      
+00015ab0: 2020 6966 206d 6574 5f63 6865 636b 2061    if met_check a
+00015ac0: 6e64 206f 732e 7061 7468 2e69 7366 696c  nd os.path.isfil
+00015ad0: 6528 7365 6c66 2e77 6f72 6b64 6972 202b  e(self.workdir +
+00015ae0: 2073 7472 286d 6173 6b6e 616d 6529 293a   str(maskname)):
+00015af0: 0a20 2020 2020 2020 2020 2020 2023 2049  .            # I
+00015b00: 6e20 6361 7365 2074 6865 7265 2069 7320  n case there is 
+00015b10: 6e6f 206d 6173 6b20 636f 6e74 6f75 7220  no mask contour 
+00015b20: 6c65 7665 6c2c 2068 6572 6520 7765 2075  level, here we u
+00015b30: 7365 2031 2e30 2069 6e73 7465 6164 0a20  se 1.0 instead. 
+00015b40: 2020 2020 2020 2020 2020 2063 6f6e 746f             conto
+00015b50: 7572 203d 2022 6c65 7665 6c20 2220 2b20  ur = "level " + 
+00015b60: 7374 7228 6d73 6b63 6c29 2069 6620 6d73  str(mskcl) if ms
+00015b70: 6b63 6c20 6973 206e 6f74 204e 6f6e 6520  kcl is not None 
+00015b80: 656c 7365 2031 2e30 0a20 2020 2020 2020  else 1.0.       
+00015b90: 2020 2020 2077 6974 6820 6f70 656e 2873       with open(s
+00015ba0: 656c 662e 776f 726b 6469 7220 2b20 6368  elf.workdir + ch
+00015bb0: 696d 6572 6163 6d64 2c20 2777 2729 2061  imeracmd, 'w') a
+00015bc0: 7320 663a 0a20 2020 2020 2020 2020 2020  s f:.           
+00015bd0: 2020 2020 2069 6620 7365 6c66 2e6d 6574       if self.met
+00015be0: 2021 3d20 2774 6f6d 6f27 3a0a 2020 2020   != 'tomo':.    
+00015bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015c00: 662e 7772 6974 6528 0a20 2020 2020 2020  f.write(.       
+00015c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015c20: 2027 6f70 656e 2027 202b 2073 7472 286d   'open ' + str(m
+00015c30: 6170 6e61 6d65 2920 2b20 2720 666f 726d  apname) + ' form
+00015c40: 6174 2063 6370 3427 202b 2027 5c6e 270a  at ccp4' + '\n'.
+00015c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015c60: 2020 2020 2020 2020 276f 7065 6e20 2720          'open ' 
+00015c70: 2b20 7365 6c66 2e77 6f72 6b64 6972 202b  + self.workdir +
+00015c80: 2073 7472 286d 6173 6b6e 616d 6529 202b   str(maskname) +
+00015c90: 2027 2066 6f72 6d61 7420 6363 7034 2720   ' format ccp4' 
+00015ca0: 2b20 275c 6e27 0a20 2020 2020 2020 2020  + '\n'.         
+00015cb0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00015cc0: 766f 6c75 6d65 2023 3120 7374 796c 6520  volume #1 style 
+00015cd0: 7375 7266 6163 6520 6578 7061 6e64 5369  surface expandSi
+00015ce0: 6e67 6c65 506c 616e 6520 5472 7565 2022  nglePlane True "
+00015cf0: 202b 2027 5c6e 270a 2020 2020 2020 2020   + '\n'.        
+00015d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015d10: 2276 6f6c 756d 6520 2332 2073 7479 6c65  "volume #2 style
+00015d20: 2073 7572 6661 6365 2065 7870 616e 6453   surface expandS
+00015d30: 696e 676c 6550 6c61 6e65 2054 7275 6520  inglePlane True 
+00015d40: 2220 2b20 275c 6e27 0a20 2020 2020 2020  " + '\n'.       
+00015d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015d60: 2022 766f 6c75 6d65 2023 3120 636f 6c6f   "volume #1 colo
+00015d70: 7220 2342 3838 3630 4220 7374 6570 2031  r #B8860B step 1
+00015d80: 206c 6576 656c 2022 202b 2073 7472 2873   level " + str(s
+00015d90: 656c 662e 636c 2920 2b20 275c 6e27 0a20  elf.cl) + '\n'. 
+00015da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015db0: 2020 2020 2020 2022 766f 6c75 6d65 2023         "volume #
+00015dc0: 3220 636f 6c6f 7220 626c 7565 2073 7465  2 color blue ste
+00015dd0: 7020 3120 2220 2b20 636f 6e74 6f75 7220  p 1 " + contour 
+00015de0: 2b20 275c 6e27 0a20 2020 2020 2020 2020  + '\n'.         
+00015df0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00015e00: 766f 6c75 6d65 2023 3120 7472 616e 7370  volume #1 transp
+00015e10: 6172 656e 6379 2030 2e36 3522 202b 2027  arency 0.65" + '
+00015e20: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
+00015e30: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00015e40: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00015e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015e60: 2020 2020 662e 7772 6974 6528 0a20 2020      f.write(.   
+00015e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015e80: 2020 2020 2027 6f70 656e 2027 202b 2073       'open ' + s
+00015e90: 656c 662e 776f 726b 6469 7220 2b20 7374  elf.workdir + st
+00015ea0: 7228 6d61 736b 6e61 6d65 2920 2b20 2720  r(maskname) + ' 
+00015eb0: 666f 726d 6174 2063 6370 3427 202b 275c  format ccp4' +'\
+00015ec0: 6e27 0a20 2020 2020 2020 2020 2020 2020  n'.             
+00015ed0: 2020 2020 2020 2020 2020 2022 766f 6c75             "volu
+00015ee0: 6d65 2023 3120 7374 796c 6520 7375 7266  me #1 style surf
+00015ef0: 6163 6520 6578 7061 6e64 5369 6e67 6c65  ace expandSingle
+00015f00: 506c 616e 6520 5472 7565 2022 202b 2027  Plane True " + '
+00015f10: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
+00015f20: 2020 2020 2020 2020 2020 2020 2276 6f6c              "vol
+00015f30: 756d 6520 2331 2063 6f6c 6f72 2062 6c75  ume #1 color blu
+00015f40: 6520 7374 6570 2031 2022 202b 2063 6f6e  e step 1 " + con
+00015f50: 746f 7572 202b 2027 5c6e 270a 2020 2020  tour + '\n'.    
+00015f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015f70: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00015f80: 2020 662e 7772 6974 6528 0a20 2020 2020    f.write(.     
+00015f90: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00015fa0: 2027 6f70 656e 2027 202b 2073 7472 286d   'open ' + str(m
+00015fb0: 6173 6b29 202b 2027 2066 6f72 6d61 7420  ask) + ' format 
+00015fc0: 6363 7034 2720 2b27 5c6e 270a 2020 2020  ccp4' +'\n'.    
+00015fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015fe0: 2320 2276 6f6c 756d 6520 2331 2073 7479  # "volume #1 sty
+00015ff0: 6c65 2073 7572 6661 6365 2065 7870 616e  le surface expan
+00016000: 6453 696e 676c 6550 6c61 6e65 2054 7275  dSinglePlane Tru
+00016010: 6520 2220 2b20 275c 6e27 0a20 2020 2020  e " + '\n'.     
+00016020: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00016030: 2022 766f 6c75 6d65 2023 3220 7374 796c   "volume #2 styl
+00016040: 6520 7375 7266 6163 6520 6578 7061 6e64  e surface expand
+00016050: 5369 6e67 6c65 506c 616e 6520 5472 7565  SinglePlane True
+00016060: 2022 202b 2027 5c6e 270a 2020 2020 2020   " + '\n'.      
+00016070: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00016080: 2276 6f6c 756d 6520 2331 2063 6f6c 6f72  "volume #1 color
+00016090: 2023 4238 3836 3042 2073 7465 7020 3120   #B8860B step 1 
+000160a0: 6c65 7665 6c20 2220 2b20 7374 7228 7365  level " + str(se
+000160b0: 6c66 2e63 6c29 202b 2027 5c6e 270a 2020  lf.cl) + '\n'.  
+000160c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000160d0: 2020 2320 2276 6f6c 756d 6520 2332 2063    # "volume #2 c
+000160e0: 6f6c 6f72 2062 6c75 6520 7374 6570 2031  olor blue step 1
+000160f0: 2022 202b 2063 6f6e 746f 7572 202b 2027   " + contour + '
+00016100: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
+00016110: 2020 2020 2020 2020 2320 2276 6f6c 756d          # "volum
+00016120: 6520 2331 2074 7261 6e73 7061 7265 6e63  e #1 transparenc
+00016130: 7920 302e 3635 2220 2b20 275c 6e27 0a20  y 0.65" + '\n'. 
+00016140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016150: 2020 2022 7365 7420 6267 436f 6c6f 7220     "set bgColor 
+00016160: 6c69 6768 7420 6772 6179 2220 2b20 275c  light gray" + '\
+00016170: 6e27 0a20 2020 2020 2020 2020 2020 2020  n'.             
+00016180: 2020 2020 2020 2022 7669 6577 2063 6f66         "view cof
+00016190: 7220 5472 7565 2220 2b20 275c 6e27 0a20  r True" + '\n'. 
+000161a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000161b0: 2020 2022 7361 7665 2022 202b 2073 7472     "save " + str
+000161c0: 286d 6170 6e61 6d65 2920 2b20 225f 2220  (mapname) + "_" 
+000161d0: 2b20 7374 7228 6f75 745f 6d61 736b 6e61  + str(out_maskna
+000161e0: 6d65 2920 2b20 225f 7a6d 6173 6b76 6965  me) + "_zmaskvie
+000161f0: 772e 6a70 6567 2220 2b20 2220 7375 7065  w.jpeg" + " supe
+00016200: 7273 616d 706c 6520 3320 7769 6474 6820  rsample 3 width 
+00016210: 3132 3030 2068 6569 6768 7420 3132 3030  1200 height 1200
+00016220: 2220 2b20 275c 6e27 0a20 2020 2020 2020  " + '\n'.       
+00016230: 2020 2020 2020 2020 2020 2020 2022 7475               "tu
+00016240: 726e 2078 202d 3930 2220 2b20 275c 6e27  rn x -90" + '\n'
+00016250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016260: 2020 2020 2022 7475 726e 2079 202d 3930       "turn y -90
+00016270: 2220 2b20 275c 6e27 0a20 2020 2020 2020  " + '\n'.       
+00016280: 2020 2020 2020 2020 2020 2020 2022 7669               "vi
+00016290: 6577 2063 6f66 7220 5472 7565 2220 2b20  ew cofr True" + 
+000162a0: 275c 6e27 0a20 2020 2020 2020 2020 2020  '\n'.           
+000162b0: 2020 2020 2020 2020 2022 7361 7665 2022           "save "
+000162c0: 202b 2073 7472 286d 6170 6e61 6d65 2920   + str(mapname) 
+000162d0: 2b20 225f 2220 2b20 7374 7228 6f75 745f  + "_" + str(out_
+000162e0: 6d61 736b 6e61 6d65 2920 2b20 225f 786d  maskname) + "_xm
+000162f0: 6173 6b76 6965 772e 6a70 6567 2220 2b20  askview.jpeg" + 
+00016300: 2220 7375 7065 7273 616d 706c 6520 3320  " supersample 3 
+00016310: 7769 6474 6820 3132 3030 2068 6569 6768  width 1200 heigh
+00016320: 7420 3132 3030 2220 2b20 275c 6e27 0a20  t 1200" + '\n'. 
+00016330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016340: 2020 2022 7669 6577 206f 7269 656e 7422     "view orient"
+00016350: 202b 2027 5c6e 270a 2020 2020 2020 2020   + '\n'.        
+00016360: 2020 2020 2020 2020 2020 2020 2274 7572              "tur
+00016370: 6e20 7820 3930 2220 2b20 275c 6e27 0a20  n x 90" + '\n'. 
+00016380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016390: 2020 2022 7475 726e 207a 2039 3022 202b     "turn z 90" +
+000163a0: 2027 5c6e 270a 2020 2020 2020 2020 2020   '\n'.          
+000163b0: 2020 2020 2020 2020 2020 2276 6965 7720            "view 
+000163c0: 636f 6672 2054 7275 6522 202b 2027 5c6e  cofr True" + '\n
+000163d0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+000163e0: 2020 2020 2020 2273 6176 6520 2220 2b20        "save " + 
+000163f0: 7374 7228 6d61 706e 616d 6529 202b 2022  str(mapname) + "
+00016400: 5f22 202b 2073 7472 286f 7574 5f6d 6173  _" + str(out_mas
+00016410: 6b6e 616d 6529 202b 2022 5f79 6d61 736b  kname) + "_ymask
+00016420: 7669 6577 2e6a 7065 6722 202b 2022 2073  view.jpeg" + " s
+00016430: 7570 6572 7361 6d70 6c65 2033 2077 6964  upersample 3 wid
+00016440: 7468 2031 3230 3020 6865 6967 6874 2031  th 1200 height 1
+00016450: 3230 3022 202b 2027 5c6e 270a 2020 2020  200" + '\n'.    
+00016460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016470: 2263 6c6f 7365 2061 6c6c 2220 2b20 225c  "close all" + "\
+00016480: 6e22 0a20 2020 2020 2020 2020 2020 2020  n".             
+00016490: 2020 2020 2020 2022 6578 6974 220a 2020         "exit".  
+000164a0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+000164b0: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+000164c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000164d0: 2069 6620 6e6f 7420 6269 6e64 6973 706c   if not bindispl
+000164e0: 6179 3a0a 2020 2020 2020 2020 2020 2020  ay:.            
+000164f0: 2020 2020 2020 2020 7375 6270 726f 6365          subproce
+00016500: 7373 2e63 6865 636b 5f63 616c 6c28 6c6f  ss.check_call(lo
+00016510: 6343 4849 4d45 5241 202b 2022 202d 2d6f  cCHIMERA + " --o
+00016520: 6666 7363 7265 656e 202d 2d6e 6f67 7569  ffscreen --nogui
+00016530: 2022 202b 2073 656c 662e 776f 726b 6469   " + self.workdi
+00016540: 7220 2b20 6368 696d 6572 6163 6d64 2c0a  r + chimeracmd,.
+00016550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016570: 2020 2020 2020 2020 2020 2020 6377 643d              cwd=
+00016580: 7365 6c66 2e77 6f72 6b64 6972 2c20 7368  self.workdir, sh
+00016590: 656c 6c3d 5472 7565 290a 2020 2020 2020  ell=True).      
+000165a0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+000165b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000165c0: 2020 2020 7375 6270 726f 6365 7373 2e63      subprocess.c
+000165d0: 6865 636b 5f63 616c 6c28 6c6f 6343 4849  heck_call(locCHI
+000165e0: 4d45 5241 202b 2022 2022 202b 2073 656c  MERA + " " + sel
+000165f0: 662e 776f 726b 6469 7220 2b20 6368 696d  f.workdir + chim
+00016600: 6572 6163 6d64 2c20 6377 643d 7365 6c66  eracmd, cwd=self
+00016610: 2e77 6f72 6b64 6972 2c20 7368 656c 6c3d  .workdir, shell=
+00016620: 5472 7565 290a 2020 2020 2020 2020 2020  True).          
+00016630: 2020 6578 6365 7074 2073 7562 7072 6f63    except subproc
+00016640: 6573 732e 4361 6c6c 6564 5072 6f63 6573  ess.CalledProces
+00016650: 7345 7272 6f72 2061 7320 7375 6265 7272  sError as suberr
+00016660: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00016670: 2020 6572 7220 3d20 274d 6173 6b20 7669    err = 'Mask vi
+00016680: 6577 2062 7920 4368 696d 6572 6158 2065  ew by ChimeraX e
+00016690: 7272 6f72 3a20 7b7d 272e 666f 726d 6174  rror: {}'.format
+000166a0: 2873 7562 6572 7229 0a20 2020 2020 2020  (suberr).       
+000166b0: 2020 2020 2020 2020 2065 7272 6c69 7374           errlist
+000166c0: 2e61 7070 656e 6428 6572 7229 0a20 2020  .append(err).   
+000166d0: 2020 2020 2020 2020 2020 2020 2073 7973               sys
+000166e0: 2e73 7464 6572 722e 7772 6974 6528 6572  .stderr.write(er
+000166f0: 7220 2b20 275c 6e27 290a 0a20 2020 2020  r + '\n')..     
+00016700: 2020 2020 2020 2065 6e64 203d 2074 696d         end = tim
+00016710: 6569 742e 6465 6661 756c 745f 7469 6d65  eit.default_time
+00016720: 7228 290a 2020 2020 2020 2020 2020 2020  r().            
+00016730: 7072 696e 7428 2750 7269 6d61 7279 206d  print('Primary m
+00016740: 6170 2061 6e64 206d 6173 6b20 7669 6577  ap and mask view
+00016750: 2074 696d 653a 2025 7327 2025 2028 656e   time: %s' % (en
+00016760: 6420 2d20 7374 6172 7429 290a 2020 2020  d - start)).    
+00016770: 2020 2020 2020 2020 7072 696e 7428 272d          print('-
+00016780: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00016790: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000167a0: 2d2d 2d27 290a 0a20 2020 2020 2020 2020  ---')..         
+000167b0: 2020 2073 656c 662e 7363 616c 655f 6d61     self.scale_ma
+000167c0: 736b 696d 6728 290a 0a20 2020 2020 2020  skimg()..       
+000167d0: 2020 2020 206f 6e65 6d61 736b 6469 6374       onemaskdict
+000167e0: 203d 2064 6963 7428 290a 2020 2020 2020   = dict().      
+000167f0: 2020 2020 2020 666f 7220 6469 6d20 696e        for dim in
+00016800: 205b 2778 272c 2027 7927 2c20 277a 275d   ['x', 'y', 'z']
+00016810: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00016820: 2020 6375 725f 6d61 736b 7669 6577 203d    cur_maskview =
+00016830: 2027 7b7d 5f7b 7d5f 7b7d 6d61 736b 7669   '{}_{}_{}maskvi
+00016840: 6577 2e6a 7065 6727 2e66 6f72 6d61 7428  ew.jpeg'.format(
+00016850: 6d61 706e 616d 652c 206f 7574 5f6d 6173  mapname, out_mas
+00016860: 6b6e 616d 652c 2064 696d 290a 2020 2020  kname, dim).    
+00016870: 2020 2020 2020 2020 2020 2020 6f6e 656d              onem
+00016880: 6173 6b64 6963 745b 6469 6d5d 203d 2027  askdict[dim] = '
+00016890: 7b7d 5f7b 7d5f 7363 616c 6564 5f7b 7d6d  {}_{}_scaled_{}m
+000168a0: 6173 6b76 6965 772e 6a70 6567 272e 666f  askview.jpeg'.fo
+000168b0: 726d 6174 286d 6170 6e61 6d65 2c20 6f75  rmat(mapname, ou
+000168c0: 745f 6d61 736b 6e61 6d65 2c20 6469 6d29  t_maskname, dim)
+000168d0: 2069 6620 6f73 2e70 6174 682e 6973 6669   if os.path.isfi
+000168e0: 6c65 2863 7572 5f6d 6173 6b76 6965 7729  le(cur_maskview)
+000168f0: 2065 6c73 6520 4e6f 6e65 0a0a 2020 2020   else None..    
+00016900: 2020 2020 2020 2020 7265 7475 726e 206f          return o
+00016910: 6e65 6d61 736b 6469 6374 0a20 2020 2020  nemaskdict.     
+00016920: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00016930: 2020 2020 2070 7269 6e74 2827 5245 4d49       print('REMI
+00016940: 4e44 4552 3a20 4d69 7373 696e 6720 636f  NDER: Missing co
+00016950: 6e74 6f75 7220 6c65 7665 6c20 2870 7269  ntour level (pri
+00016960: 6d61 7279 206d 6170 206f 7220 6d61 736b  mary map or mask
+00016970: 206f 7220 626f 7468 2920 6f72 206d 6173   or both) or mas
+00016980: 6b20 6669 6c65 2069 7320 6e6f 7420 6578  k file is not ex
+00016990: 6973 742e 2729 0a0a 2020 2020 6465 6620  ist.')..    def 
+000169a0: 7265 6164 6d61 736b 7328 7365 6c66 293a  readmasks(self):
+000169b0: 0a20 2020 2020 2020 2022 2222 0a0a 2020  .        """..  
+000169c0: 2020 2020 2020 2020 2020 5769 7468 2074            With t
+000169d0: 6865 206d 6173 6b73 2061 6e64 2072 6561  he masks and rea
+000169e0: 6420 7468 656d 2069 6e74 6f20 7468 6520  d them into the 
+000169f0: 5445 4d50 7920 6f62 6a65 6374 0a0a 2020  TEMPy object..  
+00016a00: 2020 2020 2020 3a72 6574 7572 6e3a 2072        :return: r
+00016a10: 6561 646d 616b 7320 7768 6963 6820 6973  eadmaks which is
+00016a20: 2061 2064 6963 7428 6675 6c6c 6d61 736b   a dict(fullmask
+00016a30: 6e61 6d65 3a0a 2020 2020 2020 2020 2222  name:.        ""
+00016a40: 220a 0a20 2020 2020 2020 2066 726f 6d20  "..        from 
+00016a50: 7661 2e70 7265 7061 7261 7469 6f6e 2069  va.preparation i
+00016a60: 6d70 6f72 7420 5072 6550 6172 6174 696f  mport PreParatio
+00016a70: 6e20 6173 2076 6170 7265 700a 0a20 2020  n as vaprep..   
+00016a80: 2020 2020 2072 6561 6466 756e 203d 2076       readfun = v
+00016a90: 6170 7265 7028 290a 2020 2020 2020 2020  aprep().        
+00016aa0: 7265 6164 6d61 736b 7320 3d20 7b7d 0a20  readmasks = {}. 
+00016ab0: 2020 2020 2020 2065 7272 6c69 7374 203d         errlist =
+00016ac0: 205b 5d0a 2020 2020 2020 2020 666f 7220   [].        for 
+00016ad0: 6b65 7920 696e 2073 656c 662e 616c 6c6d  key in self.allm
+00016ae0: 6173 6b73 3a0a 2020 2020 2020 2020 2020  asks:.          
+00016af0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00016b00: 2020 2020 2020 2023 2072 6561 646d 6173         # readmas
+00016b10: 6b73 5b6b 6579 5d20 3d20 7265 6164 6675  ks[key] = readfu
+00016b20: 6e2e 6672 6f6d 6d72 635f 746f 7465 6d70  n.frommrc_totemp
+00016b30: 7928 6b65 7929 0a20 2020 2020 2020 2020  y(key).         
+00016b40: 2020 2020 2020 2072 6561 646d 6173 6b73         readmasks
+00016b50: 5b6b 6579 5d20 3d20 7265 6164 6675 6e2e  [key] = readfun.
+00016b60: 6e65 775f 6672 6f6d 6d72 635f 746f 7465  new_frommrc_tote
+00016b70: 6d70 7928 6b65 7929 0a20 2020 2020 2020  mpy(key).       
+00016b80: 2020 2020 2065 7863 6570 743a 0a20 2020       except:.   
+00016b90: 2020 2020 2020 2020 2020 2020 2065 7272               err
+00016ba0: 203d 2027 536f 6d65 7468 696e 6720 6973   = 'Something is
+00016bb0: 2077 726f 6e67 2077 6974 6820 7265 6164   wrong with read
+00016bc0: 696e 6720 6d61 736b 3a20 7b7d 2c20 7b7d  ing mask: {}, {}
+00016bd0: 272e 666f 726d 6174 286b 6579 2c20 7379  '.format(key, sy
+00016be0: 732e 6578 635f 696e 666f 2829 5b31 5d29  s.exc_info()[1])
+00016bf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016c00: 2065 7272 6c69 7374 2e61 7070 656e 6428   errlist.append(
+00016c10: 6572 7229 0a20 2020 2020 2020 2020 2020  err).           
+00016c20: 2020 2020 2073 7973 2e73 7464 6572 722e       sys.stderr.
+00016c30: 7772 6974 6528 2754 6865 7265 2069 7320  write('There is 
+00016c40: 736f 6d65 7468 696e 6720 7772 6f6e 6720  something wrong 
+00016c50: 7769 7468 2072 6561 6469 6e67 206d 6170  with reading map
+00016c60: 207b 7d5c 6e27 2e66 6f72 6d61 7428 6b65   {}\n'.format(ke
+00016c70: 7929 290a 0a20 2020 2020 2020 2072 6574  y))..        ret
+00016c80: 7572 6e20 7265 6164 6d61 736b 732c 2065  urn readmasks, e
+00016c90: 7272 6c69 7374 0a0a 2020 2020 6465 6620  rrlist..    def 
+00016ca0: 6365 6e74 7261 6c4d 6173 6b73 2873 656c  centralMasks(sel
+00016cb0: 6629 3a0a 2020 2020 2020 2020 2222 220a  f):.        """.
+00016cc0: 0a20 2020 2020 2020 2020 2020 2050 726f  .            Pro
+00016cd0: 6475 6365 2074 6865 2063 656e 7472 616c  duce the central
+00016ce0: 2073 6c69 6365 206f 6620 6561 6368 206d   slice of each m
+00016cf0: 6173 6b73 2069 6e20 782c 2079 2c20 7a20  asks in x, y, z 
+00016d00: 6469 7265 6374 696f 6e73 0a0a 2020 2020  directions..    
+00016d10: 2020 2020 3a72 6574 7572 6e3a 2064 6972      :return: dir
+00016d20: 6563 746f 7279 2077 6869 6368 2063 6f6e  ectory which con
+00016d30: 7461 7469 6e73 2061 6c6c 2074 6865 2073  tatins all the s
+00016d40: 6c69 6365 7320 696e 666f 726d 6174 696f  lices informatio
+00016d50: 6e0a 0a20 2020 2020 2020 2022 2222 0a0a  n..        """..
+00016d60: 2020 2020 2020 2020 7374 6172 7420 3d20          start = 
+00016d70: 7469 6d65 6974 2e64 6566 6175 6c74 5f74  timeit.default_t
+00016d80: 696d 6572 2829 0a20 2020 2020 2020 2065  imer().        e
+00016d90: 7272 6c69 7374 203d 205b 5d0a 2020 2020  rrlist = [].    
+00016da0: 2020 2020 616c 6c6d 6173 6b64 6963 7420      allmaskdict 
+00016db0: 3d20 6469 6374 2829 0a0a 2020 2020 2020  = dict()..      
+00016dc0: 2020 7265 6164 6d61 736b 732c 2065 7272    readmasks, err
+00016dd0: 6672 6f6d 6c6f 6164 203d 2073 656c 662e  fromload = self.
+00016de0: 7265 6164 6d61 736b 7328 290a 2020 2020  readmasks().    
+00016df0: 2020 2020 6572 726c 6973 742e 6170 7065      errlist.appe
+00016e00: 6e64 2865 7272 6672 6f6d 6c6f 6164 290a  nd(errfromload).
+00016e10: 0a20 2020 2020 2020 2066 6f72 2028 6b65  .        for (ke
+00016e20: 792c 206d 6170 2920 696e 2069 7465 7269  y, map) in iteri
+00016e30: 7465 6d73 2872 6561 646d 6173 6b73 293a  tems(readmasks):
+00016e40: 0a20 2020 2020 2020 2020 2020 206d 6170  .            map
+00016e50: 6e61 6d65 203d 206f 732e 7061 7468 2e62  name = os.path.b
+00016e60: 6173 656e 616d 6528 6d61 702e 6675 6c6c  asename(map.full
+00016e70: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
+00016e80: 2020 6d61 705f 7a73 697a 6520 3d20 6d61    map_zsize = ma
+00016e90: 702e 6865 6164 6572 2e6e 7a0a 2020 2020  p.header.nz.    
+00016ea0: 2020 2020 2020 2020 6d61 705f 7973 697a          map_ysiz
+00016eb0: 6520 3d20 6d61 702e 6865 6164 6572 2e6e  e = map.header.n
+00016ec0: 790a 2020 2020 2020 2020 2020 2020 6d61  y.            ma
+00016ed0: 705f 7873 697a 6520 3d20 6d61 702e 6865  p_xsize = map.he
+00016ee0: 6164 6572 2e6e 780a 2020 2020 2020 2020  ader.nx.        
+00016ef0: 2020 2020 786d 6964 203d 2069 6e74 2866      xmid = int(f
+00016f00: 6c6f 6174 286d 6170 5f78 7369 7a65 2920  loat(map_xsize) 
+00016f10: 2f20 3229 0a20 2020 2020 2020 2020 2020  / 2).           
+00016f20: 2079 6d69 6420 3d20 696e 7428 666c 6f61   ymid = int(floa
+00016f30: 7428 6d61 705f 7973 697a 6529 202f 2032  t(map_ysize) / 2
+00016f40: 290a 2020 2020 2020 2020 2020 2020 7a6d  ).            zm
+00016f50: 6964 203d 2069 6e74 2866 6c6f 6174 286d  id = int(float(m
+00016f60: 6170 5f7a 7369 7a65 2920 2f20 3229 0a0a  ap_zsize) / 2)..
+00016f70: 2020 2020 2020 2020 2020 2020 2320 7863              # xc
+00016f80: 656e 7472 616c 203d 206d 6170 2e66 756c  entral = map.ful
+00016f90: 6c4d 6170 5b3a 2c20 3a2c 2078 6d69 645d  lMap[:, :, xmid]
+00016fa0: 0a20 2020 2020 2020 2020 2020 2078 6365  .            xce
+00016fb0: 6e74 7261 6c20 3d20 6d61 702e 6461 7461  ntral = map.data
+00016fc0: 5b3a 2c20 3a2c 2078 6d69 645d 0a20 2020  [:, :, xmid].   
+00016fd0: 2020 2020 2020 2020 2078 6465 6e6f 6d20           xdenom 
+00016fe0: 3d20 2878 6365 6e74 7261 6c2e 6d61 7828  = (xcentral.max(
+00016ff0: 2920 2d20 7863 656e 7472 616c 2e6d 696e  ) - xcentral.min
+00017000: 2829 2920 6966 2078 6365 6e74 7261 6c2e  ()) if xcentral.
+00017010: 6d61 7828 2920 213d 2078 6365 6e74 7261  max() != xcentra
+00017020: 6c2e 6d69 6e28 2920 656c 7365 2031 0a20  l.min() else 1. 
+00017030: 2020 2020 2020 2020 2020 2078 7265 7363             xresc
+00017040: 616c 6564 203d 2028 2828 7863 656e 7472  aled = (((xcentr
+00017050: 616c 202d 2078 6365 6e74 7261 6c2e 6d69  al - xcentral.mi
+00017060: 6e28 2929 202a 2032 3535 2e30 2920 2f20  n()) * 255.0) / 
+00017070: 7864 656e 6f6d 292e 6173 7479 7065 2827  xdenom).astype('
+00017080: 7569 6e74 3827 290a 2020 2020 2020 2020  uint8').        
+00017090: 2020 2020 7866 6c69 7070 6564 203d 206e      xflipped = n
+000170a0: 702e 666c 6970 7564 2878 7265 7363 616c  p.flipud(xrescal
+000170b0: 6564 290a 2020 2020 2020 2020 2020 2020  ed).            
+000170c0: 7869 6d67 203d 2049 6d61 6765 2e66 726f  ximg = Image.fro
+000170d0: 6d61 7272 6179 2878 666c 6970 7065 6429  marray(xflipped)
+000170e0: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
+000170f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00017100: 2020 7869 6d67 2e73 6176 6528 7365 6c66    ximg.save(self
+00017110: 2e77 6f72 6b64 6972 202b 206d 6170 6e61  .workdir + mapna
+00017120: 6d65 202b 2027 5f78 6d61 736b 6365 6e74  me + '_xmaskcent
+00017130: 7261 6c5f 736c 6963 652e 6a70 6567 2729  ral_slice.jpeg')
+00017140: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
+00017150: 6570 7420 494f 4572 726f 7220 6173 2069  ept IOError as i
+00017160: 6f65 7272 3a0a 2020 2020 2020 2020 2020  oerr:.          
+00017170: 2020 2020 2020 7865 7272 203d 2027 5361        xerr = 'Sa
+00017180: 7669 6e67 206f 7269 6769 6e61 6c20 7820  ving original x 
+00017190: 6365 6e74 7261 6c20 736c 6963 6520 6f66  central slice of
+000171a0: 206d 6173 6b20 6572 723a 7b7d 272e 666f   mask err:{}'.fo
+000171b0: 726d 6174 2869 6f65 7272 290a 2020 2020  rmat(ioerr).    
+000171c0: 2020 2020 2020 2020 2020 2020 6572 726c              errl
+000171d0: 6973 742e 6170 7065 6e64 2878 6572 7229  ist.append(xerr)
+000171e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000171f0: 2073 7973 2e73 7464 6572 722e 7772 6974   sys.stderr.writ
+00017200: 6528 7865 7272 202b 2027 5c6e 2729 0a0a  e(xerr + '\n')..
+00017210: 2020 2020 2020 2020 2020 2020 7769 6474              widt
+00017220: 682c 2068 6569 6768 7420 3d20 7869 6d67  h, height = ximg
+00017230: 2e73 697a 650a 2020 2020 2020 2020 2020  .size.          
+00017240: 2020 7873 6361 6c65 6e61 6d65 203d 2073    xscalename = s
+00017250: 656c 662e 776f 726b 6469 7220 2b20 6d61  elf.workdir + ma
+00017260: 706e 616d 6520 2b20 275f 7363 616c 6564  pname + '_scaled
+00017270: 5f78 6d61 736b 6365 6e74 7261 6c5f 736c  _xmaskcentral_sl
+00017280: 6963 652e 6a70 6567 270a 0a20 2020 2020  ice.jpeg'..     
+00017290: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+000172a0: 2020 2020 2020 2020 2020 2020 6966 2077              if w
+000172b0: 6964 7468 203e 2033 3030 2061 6e64 2068  idth > 300 and h
+000172c0: 6569 6768 7420 3e20 3330 303a 0a20 2020  eight > 300:.   
+000172d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000172e0: 2069 6620 7769 6474 6820 3e3d 2068 6569   if width >= hei
+000172f0: 6768 743a 0a20 2020 2020 2020 2020 2020  ght:.           
+00017300: 2020 2020 2020 2020 2020 2020 206c 6172               lar
+00017310: 6765 7273 6361 6c65 7220 3d20 3330 302e  gerscaler = 300.
+00017320: 202f 2077 6964 7468 0a20 2020 2020 2020   / width.       
+00017330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017340: 206e 6577 6865 6967 6874 203d 2069 6e74   newheight = int
+00017350: 2863 6569 6c28 6c61 7267 6572 7363 616c  (ceil(largerscal
+00017360: 6572 202a 2068 6569 6768 7429 290a 2020  er * height)).  
+00017370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017380: 2020 2020 2020 696d 7820 3d20 496d 6167        imx = Imag
+00017390: 652e 6672 6f6d 6172 7261 7928 7866 6c69  e.fromarray(xfli
+000173a0: 7070 6564 292e 7265 7369 7a65 2828 3330  pped).resize((30
+000173b0: 302c 206e 6577 6865 6967 6874 292c 2049  0, newheight), I
+000173c0: 6d61 6765 2e41 4e54 4941 4c49 4153 290a  mage.ANTIALIAS).
+000173d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000173e0: 2020 2020 2020 2020 696d 782e 7361 7665          imx.save
+000173f0: 2878 7363 616c 656e 616d 6529 0a20 2020  (xscalename).   
+00017400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017410: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00017420: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00017430: 6172 6765 7273 6361 6c65 7220 3d20 3330  argerscaler = 30
+00017440: 302e 202f 2068 6569 6768 740a 2020 2020  0. / height.    
+00017450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017460: 2020 2020 6e65 7777 6964 7468 203d 2069      newwidth = i
+00017470: 6e74 2863 6569 6c28 6c61 7267 6572 7363  nt(ceil(largersc
+00017480: 616c 6572 202a 2077 6964 7468 2929 0a20  aler * width)). 
+00017490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000174a0: 2020 2020 2020 2069 6d78 203d 2049 6d61         imx = Ima
+000174b0: 6765 2e66 726f 6d61 7272 6179 2878 666c  ge.fromarray(xfl
+000174c0: 6970 7065 6429 2e72 6573 697a 6528 286e  ipped).resize((n
+000174d0: 6577 7769 6474 682c 2033 3030 292c 2049  ewwidth, 300), I
+000174e0: 6d61 6765 2e41 4e54 4941 4c49 4153 290a  mage.ANTIALIAS).
+000174f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017500: 2020 2020 2020 2020 696d 782e 7361 7665          imx.save
+00017510: 2878 7363 616c 656e 616d 6529 0a20 2020  (xscalename).   
+00017520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017530: 2023 2069 6d78 203d 2049 6d61 6765 2e66   # imx = Image.f
+00017540: 726f 6d61 7272 6179 2878 666c 6970 7065  romarray(xflippe
+00017550: 6429 2e72 6573 697a 6528 2833 3030 2c33  d).resize((300,3
+00017560: 3030 2929 0a20 2020 2020 2020 2020 2020  00)).           
+00017570: 2020 2020 2020 2020 2023 2069 6d78 2e73           # imx.s
+00017580: 6176 6528 7873 6361 6c65 6e61 6d65 290a  ave(xscalename).
+00017590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000175a0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000175b0: 2020 2020 2020 2020 2020 6966 2077 6964            if wid
+000175c0: 7468 203e 3d20 6865 6967 6874 3a0a 2020  th >= height:.  
+000175d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000175e0: 2020 2020 2020 7363 616c 6572 203d 2033        scaler = 3
+000175f0: 3030 2e20 2f20 7769 6474 680a 2020 2020  00. / width.    
+00017600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017610: 2020 2020 6e65 7768 6569 6768 7420 3d20      newheight = 
+00017620: 696e 7428 6365 696c 2873 6361 6c65 7220  int(ceil(scaler 
+00017630: 2a20 6865 6967 6874 2929 0a20 2020 2020  * height)).     
+00017640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017650: 2020 2069 6d78 203d 2049 6d61 6765 2e66     imx = Image.f
+00017660: 726f 6d61 7272 6179 2878 666c 6970 7065  romarray(xflippe
+00017670: 6429 2e72 6573 697a 6528 2833 3030 2c20  d).resize((300, 
+00017680: 6e65 7768 6569 6768 7429 2c20 496d 6167  newheight), Imag
+00017690: 652e 414e 5449 414c 4941 5329 0a20 2020  e.ANTIALIAS).   
+000176a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000176b0: 2020 2020 2069 6d78 2e73 6176 6528 7873       imx.save(xs
+000176c0: 6361 6c65 6e61 6d65 290a 2020 2020 2020  calename).      
+000176d0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+000176e0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000176f0: 2020 2020 2020 2020 2020 2020 7363 616c              scal
+00017700: 6572 203d 2033 3030 2e20 2f20 6865 6967  er = 300. / heig
+00017710: 6874 0a20 2020 2020 2020 2020 2020 2020  ht.             
+00017720: 2020 2020 2020 2020 2020 206e 6577 7769             newwi
+00017730: 6474 6820 3d20 696e 7428 6365 696c 2873  dth = int(ceil(s
+00017740: 6361 6c65 7220 2a20 7769 6474 6829 290a  caler * width)).
+00017750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017760: 2020 2020 2020 2020 696d 7820 3d20 496d          imx = Im
+00017770: 6167 652e 6672 6f6d 6172 7261 7928 7866  age.fromarray(xf
+00017780: 6c69 7070 6564 292e 7265 7369 7a65 2828  lipped).resize((
+00017790: 6e65 7777 6964 7468 2c20 3330 3029 2c20  newwidth, 300), 
+000177a0: 496d 6167 652e 414e 5449 414c 4941 5329  Image.ANTIALIAS)
+000177b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000177c0: 2020 2020 2020 2020 2069 6d78 2e73 6176           imx.sav
+000177d0: 6528 7873 6361 6c65 6e61 6d65 290a 2020  e(xscalename).  
+000177e0: 2020 2020 2020 2020 2020 6578 6365 7074            except
+000177f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00017800: 2020 7865 7272 203d 2027 5361 7669 6e67    xerr = 'Saving
+00017810: 2073 6361 6c65 6420 7820 6365 6e74 7261   scaled x centra
+00017820: 6c20 736c 6963 6520 6f66 206d 6173 6b20  l slice of mask 
+00017830: 6572 723a 7b7d 272e 666f 726d 6174 2873  err:{}'.format(s
+00017840: 7973 2e65 7863 5f69 6e66 6f28 295b 315d  ys.exc_info()[1]
+00017850: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00017860: 2020 6572 726c 6973 742e 6170 7065 6e64    errlist.append
+00017870: 2878 6572 7229 0a20 2020 2020 2020 2020  (xerr).         
+00017880: 2020 2020 2020 2073 7973 2e73 7464 6572         sys.stder
+00017890: 722e 7772 6974 6528 7865 7272 202b 2027  r.write(xerr + '
+000178a0: 5c6e 2729 0a0a 2020 2020 2020 2020 2020  \n')..          
+000178b0: 2020 2320 7963 656e 7472 616c 203d 206d    # ycentral = m
+000178c0: 6170 2e66 756c 6c4d 6170 5b3a 2c20 796d  ap.fullMap[:, ym
+000178d0: 6964 2c20 3a5d 0a20 2020 2020 2020 2020  id, :].         
+000178e0: 2020 2079 6365 6e74 7261 6c20 3d20 6d61     ycentral = ma
+000178f0: 702e 6461 7461 5b3a 2c20 796d 6964 2c20  p.data[:, ymid, 
+00017900: 3a5d 0a20 2020 2020 2020 2020 2020 2079  :].            y
+00017910: 6465 6e6f 6d20 3d20 2879 6365 6e74 7261  denom = (ycentra
+00017920: 6c2e 6d61 7828 2920 2d20 7963 656e 7472  l.max() - ycentr
+00017930: 616c 2e6d 696e 2829 2920 6966 2079 6365  al.min()) if yce
+00017940: 6e74 7261 6c2e 6d61 7828 2920 213d 2079  ntral.max() != y
+00017950: 6365 6e74 7261 6c2e 6d69 6e28 2920 656c  central.min() el
+00017960: 7365 2031 0a20 2020 2020 2020 2020 2020  se 1.           
+00017970: 2079 7265 7363 616c 6564 203d 2028 2828   yrescaled = (((
+00017980: 7963 656e 7472 616c 202d 2079 6365 6e74  ycentral - ycent
+00017990: 7261 6c2e 6d69 6e28 2929 202a 2032 3535  ral.min()) * 255
+000179a0: 2e30 2920 2f20 7964 656e 6f6d 292e 6173  .0) / ydenom).as
+000179b0: 7479 7065 2827 7569 6e74 3827 290a 2020  type('uint8').  
+000179c0: 2020 2020 2020 2020 2020 7972 6f74 6174            yrotat
+000179d0: 6520 3d20 6e70 2e72 6f74 3930 2879 7265  e = np.rot90(yre
+000179e0: 7363 616c 6564 290a 2020 2020 2020 2020  scaled).        
+000179f0: 2020 2020 7969 6d67 203d 2049 6d61 6765      yimg = Image
+00017a00: 2e66 726f 6d61 7272 6179 2879 726f 7461  .fromarray(yrota
+00017a10: 7465 290a 2020 2020 2020 2020 2020 2020  te).            
+00017a20: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00017a30: 2020 2020 2079 696d 672e 7361 7665 2873       yimg.save(s
+00017a40: 656c 662e 776f 726b 6469 7220 2b20 6d61  elf.workdir + ma
+00017a50: 706e 616d 6520 2b20 275f 796d 6173 6b63  pname + '_ymaskc
+00017a60: 656e 7472 616c 5f73 6c69 6365 2e6a 7065  entral_slice.jpe
+00017a70: 6727 290a 2020 2020 2020 2020 2020 2020  g').            
+00017a80: 6578 6365 7074 2049 4f45 7272 6f72 2061  except IOError a
+00017a90: 7320 696f 6572 723a 0a20 2020 2020 2020  s ioerr:.       
+00017aa0: 2020 2020 2020 2020 2079 6572 7220 3d20           yerr = 
+00017ab0: 2753 6176 696e 6720 6f72 6967 696e 616c  'Saving original
+00017ac0: 2079 2063 656e 7472 616c 2073 6c69 6365   y central slice
+00017ad0: 206f 6620 6d61 736b 2065 7272 3a7b 7d27   of mask err:{}'
+00017ae0: 2e66 6f72 6d61 7428 696f 6572 7229 0a20  .format(ioerr). 
+00017af0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00017b00: 7272 6c69 7374 2e61 7070 656e 6428 7965  rrlist.append(ye
+00017b10: 7272 290a 2020 2020 2020 2020 2020 2020  rr).            
+00017b20: 2020 2020 7379 732e 7374 6465 7272 2e77      sys.stderr.w
+00017b30: 7269 7465 2879 6572 7220 2b20 275c 6e27  rite(yerr + '\n'
+00017b40: 290a 0a20 2020 2020 2020 2020 2020 2077  )..            w
+00017b50: 6964 7468 2c20 6865 6967 6874 203d 2079  idth, height = y
+00017b60: 696d 672e 7369 7a65 0a20 2020 2020 2020  img.size.       
+00017b70: 2020 2020 2079 7363 616c 656e 616d 6520       yscalename 
+00017b80: 3d20 7365 6c66 2e77 6f72 6b64 6972 202b  = self.workdir +
+00017b90: 206d 6170 6e61 6d65 202b 2027 5f73 6361   mapname + '_sca
+00017ba0: 6c65 645f 796d 6173 6b63 656e 7472 616c  led_ymaskcentral
+00017bb0: 5f73 6c69 6365 2e6a 7065 6727 0a20 2020  _slice.jpeg'.   
+00017bc0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+00017bd0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00017be0: 2077 6964 7468 203e 2033 3030 2061 6e64   width > 300 and
+00017bf0: 2068 6569 6768 7420 3e20 3330 303a 0a20   height > 300:. 
 00017c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017c10: 656e 636f 6469 6e67 3d27 7574 662d 3827  encoding='utf-8'
-00017c20: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
-00017c30: 2020 2020 2020 2020 6a73 6f6e 2e64 756d          json.dum
-00017c40: 7028 6669 6e61 6c64 6963 742c 2066 290a  p(finaldict, f).
-00017c50: 2020 2020 2020 2020 6578 6365 7074 2049          except I
-00017c60: 4f45 7272 6f72 2061 7320 696f 6572 723a  OError as ioerr:
-00017c70: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-00017c80: 6e74 2827 5361 7669 6e67 206d 6173 6b73  nt('Saving masks
-00017c90: 2063 656e 7472 616c 2073 6c69 6365 7320   central slices 
-00017ca0: 746f 206a 736f 6e20 6572 723a 207b 7d27  to json err: {}'
-00017cb0: 2e66 6f72 6d61 7428 696f 6572 7229 290a  .format(ioerr)).
-00017cc0: 0a20 2020 2020 2020 2065 6e64 203d 2074  .        end = t
-00017cd0: 696d 6569 742e 6465 6661 756c 745f 7469  imeit.default_ti
-00017ce0: 6d65 7228 290a 2020 2020 2020 2020 7072  mer().        pr
-00017cf0: 696e 7428 274d 616b 7343 656e 7472 616c  int('MaksCentral
-00017d00: 536c 6963 6520 7469 6d65 3a20 2573 2720  Slice time: %s' 
-00017d10: 2520 2865 6e64 202d 2073 7461 7274 2929  % (end - start))
-00017d20: 0a20 2020 2020 2020 2070 7269 6e74 2827  .        print('
-00017d30: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00017d40: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00017d50: 2d2d 2d2d 2729 0a0a 2020 2020 2020 2020  ----')..        
-00017d60: 7265 7475 726e 204e 6f6e 650a 0a20 2020  return None..   
-00017d70: 2064 6566 2063 6865 636b 7674 7028 7365   def checkvtp(se
-00017d80: 6c66 293a 0a20 2020 2020 2020 2022 2222  lf):.        """
-00017d90: 0a0a 2020 2020 2020 2020 2020 2020 4368  ..            Ch
-00017da0: 6563 6b20 6966 2074 6865 7265 2069 7320  eck if there is 
-00017db0: 6120 7674 7020 6669 6c65 2065 7869 7374  a vtp file exist
-00017dc0: 206f 7220 6e6f 740a 0a20 2020 2020 2020   or not..       
-00017dd0: 203a 7265 7475 726e 3a0a 2020 2020 2020   :return:.      
-00017de0: 2020 2222 220a 0a0a 2020 2020 2020 2020    """...        
-00017df0: 7674 7072 6567 203d 2073 656c 662e 776f  vtpreg = self.wo
-00017e00: 726b 6469 7220 2b20 272a 2e76 7470 270a  rkdir + '*.vtp'.
-00017e10: 2020 2020 2020 2020 676c 6f62 7265 7375          globresu
-00017e20: 6c74 203d 2067 6c6f 622e 676c 6f62 2876  lt = glob.glob(v
-00017e30: 7470 7265 6729 0a20 2020 2020 2020 2076  tpreg).        v
-00017e40: 7470 6e61 6d65 203d 2027 7b7d 7b7d 5f7b  tpname = '{}{}_{
-00017e50: 7d2e 7674 7027 2e66 6f72 6d61 7428 7365  }.vtp'.format(se
-00017e60: 6c66 2e77 6f72 6b64 6972 2c20 7365 6c66  lf.workdir, self
-00017e70: 2e6d 6170 6e61 6d65 2c20 7365 6c66 2e63  .mapname, self.c
-00017e80: 6c29 0a20 2020 2020 2020 2069 6620 7674  l).        if vt
-00017e90: 706e 616d 6520 696e 2067 6c6f 6272 6573  pname in globres
-00017ea0: 756c 743a 0a20 2020 2020 2020 2020 2020  ult:.           
-00017eb0: 2076 7470 6675 6c6c 6e61 6d65 203d 2076   vtpfullname = v
-00017ec0: 7470 6e61 6d65 0a20 2020 2020 2020 2020  tpname.         
-00017ed0: 2020 2070 7269 6e74 2827 2573 2065 7869     print('%s exi
-00017ee0: 7374 2061 6c72 6561 6479 2e27 2025 2076  st already.' % v
-00017ef0: 7470 6e61 6d65 290a 2020 2020 2020 2020  tpname).        
-00017f00: 2020 2020 7265 7475 726e 2076 7470 6675      return vtpfu
-00017f10: 6c6c 6e61 6d65 0a20 2020 2020 2020 2065  llname.        e
-00017f20: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00017f30: 2069 6620 676c 6f62 7265 7375 6c74 2069   if globresult i
-00017f40: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00017f50: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-00017f60: 7428 2776 7470 2066 696c 653a 2025 7320  t('vtp file: %s 
-00017f70: 6578 6973 742c 2070 6c65 6173 6520 6368  exist, please ch
-00017f80: 6563 6b2e 2720 2520 676c 6f62 7265 7375  eck.' % globresu
-00017f90: 6c74 290a 2020 2020 2020 2020 2020 2020  lt).            
-00017fa0: 7265 7475 726e 204e 6f6e 650a 0a20 2020  return None..   
-00017fb0: 2064 6566 2067 656e 7674 7028 7365 6c66   def genvtp(self
-00017fc0: 2c20 6675 6c6c 6d61 7070 6174 6829 3a0a  , fullmappath):.
-00017fd0: 2020 2020 2020 2020 2222 220a 0a20 2020          """..   
-00017fe0: 2020 2020 2020 2020 2047 656e 6572 6174           Generat
-00017ff0: 6520 7674 7020 6669 6c65 2066 6f72 206e  e vtp file for n
-00018000: 6f6e 2d73 6572 7665 7220 696e 7075 740a  on-server input.
-00018010: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-00018020: 6675 6c6c 6d61 7070 6174 683a 0a20 2020  fullmappath:.   
-00018030: 2020 2020 203a 7265 7475 726e 3a0a 2020       :return:.  
-00018040: 2020 2020 2020 2222 220a 0a20 2020 2020        """..     
-00018050: 2020 206d 6573 686d 616b 6572 203d 2046     meshmaker = F
-00018060: 616c 7365 0a20 2020 2020 2020 2069 6620  alse.        if 
-00018070: 4d45 5348 4d41 4b45 5250 4154 4820 6973  MESHMAKERPATH is
-00018080: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-00018090: 2020 2020 2020 206d 6573 686d 616b 6572         meshmaker
-000180a0: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
-000180b0: 2020 2020 6d65 7368 6d61 6b65 7270 6174      meshmakerpat
-000180c0: 6820 3d20 4d45 5348 4d41 4b45 5250 4154  h = MESHMAKERPAT
-000180d0: 480a 2020 2020 2020 2020 656c 7365 3a0a  H.        else:.
-000180e0: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-000180f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018100: 2061 7373 6572 7420 6669 6e64 5f65 7865   assert find_exe
-00018110: 6375 7461 626c 6528 276d 6573 686d 616b  cutable('meshmak
-00018120: 6572 2729 2069 7320 6e6f 7420 4e6f 6e65  er') is not None
-00018130: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018140: 206d 6573 686d 616b 6572 7061 7468 203d   meshmakerpath =
-00018150: 2066 696e 645f 6578 6563 7574 6162 6c65   find_executable
-00018160: 2827 6d65 7368 6d61 6b65 7227 290a 2020  ('meshmaker').  
-00018170: 2020 2020 2020 2020 2020 2020 2020 6d65                me
-00018180: 7368 6d61 6b65 7220 3d20 5472 7565 0a20  shmaker = True. 
-00018190: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-000181a0: 7420 4173 7365 7274 696f 6e45 7272 6f72  t AssertionError
-000181b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000181c0: 2020 7379 732e 7374 6465 7272 2e77 7269    sys.stderr.wri
-000181d0: 7465 2827 6d65 7368 6d61 6b65 7220 6578  te('meshmaker ex
-000181e0: 6563 7574 6162 6c65 2069 7320 6e6f 7420  ecutable is not 
-000181f0: 7468 6572 652e 5c6e 2729 0a0a 2020 2020  there.\n')..    
-00018200: 2020 2020 6966 206d 6573 686d 616b 6572      if meshmaker
-00018210: 2061 6e64 2073 656c 662e 636c 2069 7320   and self.cl is 
-00018220: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00018230: 2020 2020 2020 6f75 7476 7470 6e61 6d65        outvtpname
-00018240: 203d 2027 7b7d 7b7d 5f7b 7d27 2e66 6f72   = '{}{}_{}'.for
-00018250: 6d61 7428 7365 6c66 2e77 6f72 6b64 6972  mat(self.workdir
-00018260: 2c20 7365 6c66 2e6d 6170 6e61 6d65 2c20  , self.mapname, 
-00018270: 7365 6c66 2e63 6c29 0a20 2020 2020 2020  self.cl).       
-00018280: 2020 2020 2063 6d64 203d 206d 6573 686d       cmd = meshm
-00018290: 616b 6572 7061 7468 202b 2027 2027 202b  akerpath + ' ' +
-000182a0: 2066 756c 6c6d 6170 7061 7468 202b 2027   fullmappath + '
-000182b0: 202d 6320 2720 2b20 7374 7228 7365 6c66   -c ' + str(self
-000182c0: 2e63 6c29 202b 2027 202d 6f20 2720 2b20  .cl) + ' -o ' + 
-000182d0: 6f75 7476 7470 6e61 6d65 202b 2027 202d  outvtpname + ' -
-000182e0: 4420 2d76 270a 2020 2020 2020 2020 2020  D -v'.          
-000182f0: 2020 7072 6f63 6573 7320 3d20 7375 6270    process = subp
-00018300: 726f 6365 7373 2e50 6f70 656e 2863 6d64  rocess.Popen(cmd
-00018310: 2c20 7368 656c 6c3d 5472 7565 2c20 6578  , shell=True, ex
-00018320: 6563 7574 6162 6c65 3d27 2f62 696e 2f62  ecutable='/bin/b
-00018330: 6173 6827 290a 2020 2020 2020 2020 2020  ash').          
-00018340: 2020 636f 6465 203d 2070 726f 6365 7373    code = process
-00018350: 2e77 6169 7428 290a 2020 2020 2020 2020  .wait().        
-00018360: 2020 2020 6966 2063 6f64 6520 3d3d 2030      if code == 0
-00018370: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00018380: 2020 7265 7375 6c74 203d 206f 7574 7674    result = outvt
-00018390: 706e 616d 6520 2b20 272e 7674 7027 0a20  pname + '.vtp'. 
-000183a0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-000183b0: 7269 6e74 2827 5072 6f64 7563 6520 6669  rint('Produce fi
-000183c0: 6c65 3a20 2573 2073 7563 6365 7373 6675  le: %s successfu
-000183d0: 6c6c 7927 2025 2072 6573 756c 7429 0a20  lly' % result). 
-000183e0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-000183f0: 6574 7572 6e20 7265 7375 6c74 0a20 2020  eturn result.   
-00018400: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00018410: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00018420: 7269 6e74 2827 4d65 7368 6d61 6b65 7220  rint('Meshmaker 
-00018430: 6469 6420 6e6f 7420 7072 6f64 7563 6520  did not produce 
-00018440: 7468 6520 7674 7020 6669 6c65 2063 6865  the vtp file che
-00018450: 636b 2074 6865 2069 6e70 7574 732e 2729  ck the inputs.')
-00018460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018470: 2072 6574 7572 6e20 4e6f 6e65 0a20 2020   return None.   
-00018480: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00018490: 2020 2020 2020 2070 7269 6e74 2827 4469         print('Di
-000184a0: 6420 6e6f 7420 6669 6e64 2070 726f 7065  d not find prope
-000184b0: 7220 6d65 7368 6d61 6b65 7220 6f72 2074  r meshmaker or t
-000184c0: 6865 206e 6f20 636f 6e74 6f75 7220 6c65  he no contour le
-000184d0: 7665 6c20 6176 6169 6c61 626c 6520 2e27  vel available .'
-000184e0: 290a 0a20 2020 2040 7374 6174 6963 6d65  )..    @staticme
-000184f0: 7468 6f64 0a20 2020 2064 6566 2077 7269  thod.    def wri
-00018500: 7465 5f69 6d61 6765 2869 6d61 6765 4669  te_image(imageFi
-00018510: 6c65 2c20 7265 6e57 696e 293a 0a20 2020  le, renWin):.   
-00018520: 2020 2020 2023 2057 7269 7465 2074 6865       # Write the
-00018530: 2063 7572 7265 6e74 2076 6965 7720 6f66   current view of
-00018540: 2074 6865 2072 656e 6465 7265 7220 746f   the renderer to
-00018550: 2061 6e20 696d 6167 650a 2020 2020 2020   an image.      
-00018560: 2020 6966 2069 6d61 6765 4669 6c65 3a0a    if imageFile:.
-00018570: 2020 2020 2020 2020 2020 2020 7772 6974              writ
-00018580: 6572 203d 2076 746b 2e76 746b 424d 5057  er = vtk.vtkBMPW
-00018590: 7269 7465 7228 290a 2020 2020 2020 2020  riter().        
-000185a0: 2020 2020 7769 6e64 6f77 746f 5f69 6d61      windowto_ima
-000185b0: 6765 5f66 696c 7465 7220 3d20 7674 6b2e  ge_filter = vtk.
-000185c0: 7674 6b57 696e 646f 7754 6f49 6d61 6765  vtkWindowToImage
-000185d0: 4669 6c74 6572 2829 0a20 2020 2020 2020  Filter().       
-000185e0: 2020 2020 2077 696e 646f 7774 6f5f 696d       windowto_im
-000185f0: 6167 655f 6669 6c74 6572 2e53 6574 496e  age_filter.SetIn
-00018600: 7075 7428 7265 6e57 696e 290a 2020 2020  put(renWin).    
-00018610: 2020 2020 2020 2020 2320 696d 6167 6520          # image 
-00018620: 7175 616c 6974 790a 2020 2020 2020 2020  quality.        
-00018630: 2020 2020 7769 6e64 6f77 746f 5f69 6d61      windowto_ima
-00018640: 6765 5f66 696c 7465 722e 5365 7449 6e70  ge_filter.SetInp
-00018650: 7574 4275 6666 6572 5479 7065 546f 5247  utBufferTypeToRG
-00018660: 4228 290a 0a20 2020 2020 2020 2020 2020  B()..           
-00018670: 2077 7269 7465 722e 5365 7446 696c 654e   writer.SetFileN
-00018680: 616d 6528 696d 6167 6546 696c 6529 0a20  ame(imageFile). 
-00018690: 2020 2020 2020 2020 2020 2077 7269 7465             write
-000186a0: 722e 5365 7449 6e70 7574 436f 6e6e 6563  r.SetInputConnec
-000186b0: 7469 6f6e 2877 696e 646f 7774 6f5f 696d  tion(windowto_im
-000186c0: 6167 655f 6669 6c74 6572 2e47 6574 4f75  age_filter.GetOu
-000186d0: 7470 7574 506f 7274 2829 290a 2020 2020  tputPort()).    
-000186e0: 2020 2020 2020 2020 7772 6974 6572 2e57          writer.W
-000186f0: 7269 7465 2829 0a20 2020 2020 2020 2065  rite().        e
-00018700: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00018710: 2072 6169 7365 2052 756e 7469 6d65 4572   raise RuntimeEr
-00018720: 726f 7228 274e 6565 6420 6120 6669 6c65  ror('Need a file
-00018730: 6e61 6d65 2e27 290a 0a20 2020 2023 2052  name.')..    # R
-00018740: 6177 6d61 7020 7375 7266 6163 6520 7669  awmap surface vi
-00018750: 6577 2077 6865 6e20 7477 6f20 6861 6c66  ew when two half
-00018760: 206d 6170 7320 6172 6520 6769 7665 6e0a   maps are given.
-00018770: 2020 2020 6465 6620 7261 776d 6170 636c      def rawmapcl
-00018780: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-00018790: 2222 220a 0a20 2020 2020 2020 2020 2020  """..           
-000187a0: 2043 616c 6375 6c61 7465 2061 2063 6f72   Calculate a cor
-000187b0: 7265 7370 6f6e 6469 6e67 2027 7265 636f  responding 'reco
-000187c0: 6d6d 656e 6465 6420 636f 6e74 6f75 7220  mmended contour 
-000187d0: 6c65 7665 6c27 2062 6173 6564 206f 6e20  level' based on 
-000187e0: 7468 6520 7265 636f 6d6d 656e 6465 6420  the recommended 
-000187f0: 636f 6e74 6f75 7220 6c65 7665 6c0a 2020  contour level.  
-00018800: 2020 2020 2020 2020 2020 2868 6176 6520            (have 
-00018810: 7472 6965 6420 6d61 7463 6869 6e67 2074  tried matching t
-00018820: 6865 2076 616c 7565 2073 6361 6c65 2077  he value scale w
-00018830: 6869 6368 2067 6574 2077 6f72 7365 2072  hich get worse r
-00018840: 6573 756c 7420 7468 616e 2074 6869 7320  esult than this 
-00018850: 6f6e 6529 0a0a 2020 2020 2020 2020 3a72  one)..        :r
-00018860: 6574 7572 6e3a 2041 2066 6c6f 6174 2077  eturn: A float w
-00018870: 6869 6368 2067 6976 6520 7468 6520 636f  hich give the co
-00018880: 6e74 6f75 7220 6c65 7665 6c0a 2020 2020  ntour level.    
-00018890: 2020 2020 2222 220a 0a20 2020 2020 2020      """..       
-000188a0: 2023 206e 756d 766f 7820 3d20 6c65 6e28   # numvox = len(
-000188b0: 7365 6c66 2e6d 6170 2e66 756c 6c4d 6170  self.map.fullMap
-000188c0: 5b73 656c 662e 6d61 702e 6675 6c6c 4d61  [self.map.fullMa
-000188d0: 7020 3e3d 2073 656c 662e 636c 5d29 0a20  p >= self.cl]). 
-000188e0: 2020 2020 2020 206e 756d 766f 7820 3d20         numvox = 
-000188f0: 6c65 6e28 7365 6c66 2e6d 6170 2e64 6174  len(self.map.dat
-00018900: 615b 7365 6c66 2e6d 6170 2e64 6174 6120  a[self.map.data 
-00018910: 3e3d 2073 656c 662e 636c 5d29 0a20 2020  >= self.cl]).   
-00018920: 2020 2020 2072 6177 6d61 7020 3d20 7365       rawmap = se
-00018930: 6c66 2e72 6177 6d61 700a 2020 2020 2020  lf.rawmap.      
-00018940: 2020 2320 7261 7764 6174 6120 3d20 7261    # rawdata = ra
-00018950: 776d 6170 2e66 756c 6c4d 6170 2e66 6c61  wmap.fullMap.fla
-00018960: 7474 656e 2829 0a20 2020 2020 2020 2072  tten().        r
-00018970: 6177 6461 7461 203d 2072 6177 6d61 702e  awdata = rawmap.
-00018980: 6461 7461 2e66 6c61 7474 656e 2829 0a20  data.flatten(). 
-00018990: 2020 2020 2020 2066 6c61 7472 6177 203d         flatraw =
-000189a0: 2073 6f72 7465 6428 7261 7764 6174 6129   sorted(rawdata)
-000189b0: 5b3a 3a2d 315d 0a20 2020 2020 2020 2072  [::-1].        r
-000189c0: 6177 636c 203d 2066 6c61 7472 6177 5b6e  awcl = flatraw[n
-000189d0: 756d 766f 785d 0a0a 2020 2020 2020 2020  umvox]..        
-000189e0: 7265 7475 726e 2072 6177 636c 0a0a 0a20  return rawcl... 
-000189f0: 2020 2064 6566 2066 696e 6472 6177 6d61     def findrawma
-00018a00: 7028 7365 6c66 293a 0a0a 2020 2020 2020  p(self):..      
-00018a10: 2020 6966 2073 656c 662e 656d 6469 643a    if self.emdid:
-00018a20: 0a20 2020 2020 2020 2020 2020 2072 6177  .            raw
-00018a30: 6d61 706e 616d 6520 3d20 277b 7d65 6d64  mapname = '{}emd
-00018a40: 5f7b 7d5f 7261 776d 6170 2e6d 6170 272e  _{}_rawmap.map'.
-00018a50: 666f 726d 6174 2873 656c 662e 776f 726b  format(self.work
-00018a60: 6469 722c 2073 656c 662e 656d 6469 6429  dir, self.emdid)
-00018a70: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00018a80: 2020 2020 2020 2020 2020 206f 6464 6e61             oddna
-00018a90: 6d65 203d 206f 732e 7061 7468 2e62 6173  me = os.path.bas
-00018aa0: 656e 616d 6528 7365 6c66 2e68 6d6f 6464  ename(self.hmodd
-00018ab0: 2e66 756c 6c6e 616d 6529 0a20 2020 2020  .fullname).     
-00018ac0: 2020 2020 2020 2065 7665 6e6e 616d 6520         evenname 
-00018ad0: 3d20 6f73 2e70 6174 682e 6261 7365 6e61  = os.path.basena
-00018ae0: 6d65 2873 656c 662e 686d 6576 656e 2e66  me(self.hmeven.f
-00018af0: 756c 6c6e 616d 6529 0a20 2020 2020 2020  ullname).       
-00018b00: 2020 2020 2072 6177 6d61 706e 616d 6520       rawmapname 
-00018b10: 3d20 277b 7d7b 7d5f 7b7d 5f72 6177 6d61  = '{}{}_{}_rawma
-00018b20: 702e 6d61 7027 2e66 6f72 6d61 7428 7365  p.map'.format(se
-00018b30: 6c66 2e77 6f72 6b64 6972 2c20 6f64 646e  lf.workdir, oddn
-00018b40: 616d 652c 2065 7665 6e6e 616d 6529 0a0a  ame, evenname)..
-00018b50: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00018b60: 686d 6f64 6420 6973 206e 6f74 204e 6f6e  hmodd is not Non
-00018b70: 6520 616e 6420 7365 6c66 2e68 6d65 7665  e and self.hmeve
-00018b80: 6e20 6973 206e 6f74 204e 6f6e 653a 0a20  n is not None:. 
-00018b90: 2020 2020 2020 2020 2020 2069 6620 6f73             if os
-00018ba0: 2e70 6174 682e 6973 6669 6c65 2872 6177  .path.isfile(raw
-00018bb0: 6d61 706e 616d 6529 3a0a 2020 2020 2020  mapname):.      
-00018bc0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00018bd0: 2072 6177 6d61 706e 616d 650a 2020 2020   rawmapname.    
-00018be0: 2020 2020 2020 2020 656c 7365 3a0a 0a20          else:.. 
-00018bf0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00018c00: 7269 6e74 2827 4261 7365 206f 6e20 7468  rint('Base on th
-00018c10: 6520 6861 6c66 206d 6170 732c 2072 6177  e half maps, raw
-00018c20: 6d61 7020 6973 206e 6f74 2070 726f 6475  map is not produ
-00018c30: 6365 6421 2127 290a 2020 2020 2020 2020  ced!!').        
-00018c40: 2020 2020 2020 2020 7265 7475 726e 204e          return N
-00018c50: 6f6e 650a 2020 2020 2020 2020 656c 7365  one.        else
-00018c60: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00018c70: 7475 726e 204e 6f6e 650a 0a0a 2020 2020  turn None...    
-00018c80: 6465 6620 7261 776d 6170 7375 7266 6163  def rawmapsurfac
-00018c90: 655f 6368 696d 6572 6128 7365 6c66 2c20  e_chimera(self, 
-00018ca0: 6368 696d 6572 6161 7070 293a 0a20 2020  chimeraapp):.   
-00018cb0: 2020 2020 2022 2222 0a0a 2020 2020 2020       """..      
-00018cc0: 2020 2020 2020 4765 6e65 7261 7465 2072        Generate r
-00018cd0: 6177 6d61 7020 7375 7266 6163 6573 2069  awmap surfaces i
-00018ce0: 6620 7477 6f20 6861 6c66 206d 6170 7320  f two half maps 
-00018cf0: 616e 6420 7261 776d 6170 2061 6e64 2072  and rawmap and r
-00018d00: 6177 6d61 7020 636f 6e74 6f75 7220 6172  awmap contour ar
-00018d10: 6520 7468 6572 650a 0a20 2020 2020 2020  e there..       
-00018d20: 203a 7061 7261 6d20 6368 696d 6572 6161   :param chimeraa
-00018d30: 7070 3a20 6269 6e61 7279 2076 616c 7565  pp: binary value
-00018d40: 2074 6f20 6368 6563 6b20 6966 2043 6869   to check if Chi
-00018d50: 6d65 7261 5820 6973 2074 6865 7265 2070  meraX is there p
-00018d60: 726f 7065 726c 790a 2020 2020 2020 2020  roperly.        
-00018d70: 3a72 6574 7572 6e3a 204e 6f6e 650a 2020  :return: None.  
-00018d80: 2020 2020 2020 2222 220a 0a20 2020 2020        """..     
-00018d90: 2020 2023 2072 6177 6d61 7072 6520 3d20     # rawmapre = 
-00018da0: 272a 5f72 6177 6d61 702e 6d61 7027 0a20  '*_rawmap.map'. 
-00018db0: 2020 2020 2020 2023 2072 6177 6d61 706e         # rawmapn
-00018dc0: 616d 6520 3d20 676c 6f62 2e67 6c6f 6228  ame = glob.glob(
-00018dd0: 7365 6c66 2e77 6f72 6b64 6972 202b 2072  self.workdir + r
-00018de0: 6177 6d61 7072 6529 0a20 2020 2020 2020  awmapre).       
-00018df0: 2069 6620 7365 6c66 2e68 6d6f 6464 2069   if self.hmodd i
-00018e00: 7320 6e6f 7420 4e6f 6e65 2061 6e64 2073  s not None and s
-00018e10: 656c 662e 686d 6576 656e 2069 7320 6e6f  elf.hmeven is no
-00018e20: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-00018e30: 2020 2020 7261 776d 6170 6e61 6d65 203d      rawmapname =
-00018e40: 2073 656c 662e 6669 6e64 7261 776d 6170   self.findrawmap
-00018e50: 2829 0a20 2020 2020 2020 2065 6c73 653a  ().        else:
-00018e60: 0a20 2020 2020 2020 2020 2020 2072 6177  .            raw
-00018e70: 6d61 706e 616d 6520 3d20 4e6f 6e65 0a0a  mapname = None..
-00018e80: 2020 2020 2020 2020 6269 6e64 6973 706c          bindispl
-00018e90: 6179 203d 206f 732e 6765 7465 6e76 2827  ay = os.getenv('
-00018ea0: 4449 5350 4c41 5927 290a 0a20 2020 2020  DISPLAY')..     
-00018eb0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00018ec0: 2020 2020 7261 776d 6170 636c 203d 2073      rawmapcl = s
-00018ed0: 656c 662e 7261 776d 6170 636c 2829 0a20  elf.rawmapcl(). 
-00018ee0: 2020 2020 2020 2065 7863 6570 743a 0a20         except:. 
-00018ef0: 2020 2020 2020 2020 2020 2072 6177 6d61             rawma
-00018f00: 7063 6c20 3d20 4e6f 6e65 0a20 2020 2020  pcl = None.     
-00018f10: 2020 2020 2020 2070 7269 6e74 2827 5072         print('Pr
-00018f20: 6f62 6c65 6d20 7769 7468 2072 6177 206d  oblem with raw m
-00018f30: 6170 2063 6f6e 746f 7572 206c 6576 656c  ap contour level
-00018f40: 2063 616c 6375 6c61 7469 6f6e 2729 0a0a   calculation')..
-00018f50: 2020 2020 2020 2020 6966 2028 7365 6c66          if (self
-00018f60: 2e68 6d6f 6464 2069 7320 6e6f 7420 4e6f  .hmodd is not No
-00018f70: 6e65 2061 6e64 2073 656c 662e 686d 6576  ne and self.hmev
-00018f80: 656e 2069 7320 6e6f 7420 4e6f 6e65 2920  en is not None) 
-00018f90: 616e 6420 7261 776d 6170 6e61 6d65 2061  and rawmapname a
-00018fa0: 6e64 2072 6177 6d61 7063 6c20 6973 206e  nd rawmapcl is n
-00018fb0: 6f74 204e 6f6e 653a 0a0a 2020 2020 2020  ot None:..      
-00018fc0: 2020 2020 2020 7374 6172 7420 3d20 7469        start = ti
-00018fd0: 6d65 6974 2e64 6566 6175 6c74 5f74 696d  meit.default_tim
-00018fe0: 6572 2829 0a20 2020 2020 2020 2020 2020  er().           
-00018ff0: 2065 7272 6c69 7374 203d 205b 5d0a 0a20   errlist = [].. 
-00019000: 2020 2020 2020 2020 2020 206d 6170 6e61             mapna
-00019010: 6d65 203d 206f 732e 7061 7468 2e62 6173  me = os.path.bas
-00019020: 656e 616d 6528 7261 776d 6170 6e61 6d65  ename(rawmapname
-00019030: 290a 2020 2020 2020 2020 2020 2020 6c6f  ).            lo
-00019040: 6343 4849 4d45 5241 203d 2063 6869 6d65  cCHIMERA = chime
-00019050: 7261 6170 700a 2020 2020 2020 2020 2020  raapp.          
-00019060: 2020 2320 7261 776d 6170 2073 7572 6661    # rawmap surfa
-00019070: 6365 2076 6965 7720 616c 6f6e 650a 2020  ce view alone.  
-00019080: 2020 2020 2020 2020 2020 7261 776d 6170            rawmap
-00019090: 6368 696d 6572 6163 6d64 203d 2072 6177  chimeracmd = raw
-000190a0: 6d61 706e 616d 6520 2b20 275f 6368 696d  mapname + '_chim
-000190b0: 6572 612e 6378 6327 0a20 2020 2020 2020  era.cxc'.       
-000190c0: 2020 2020 2061 7373 656d 626c 6520 3d20       assemble = 
-000190d0: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
-000190e0: 2020 7769 7468 206f 7065 6e28 7261 776d    with open(rawm
-000190f0: 6170 6368 696d 6572 6163 6d64 2c20 2777  apchimeracmd, 'w
-00019100: 2729 2061 7320 663a 0a20 2020 2020 2020  ') as f:.       
-00019110: 2020 2020 2020 2020 2066 2e77 7269 7465           f.write
-00019120: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00019130: 2020 2020 2020 2320 4368 696d 6572 6120        # Chimera 
-00019140: 7665 7273 696f 6e0a 2020 2020 2020 2020  version.        
-00019150: 2020 2020 2020 2020 2020 2020 2320 276f              # 'o
-00019160: 7065 6e20 6363 7034 3a27 202b 2073 7472  pen ccp4:' + str
-00019170: 286d 6170 6e61 6d65 2920 2b20 275c 6e27  (mapname) + '\n'
-00019180: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019190: 2020 2020 2023 2022 766f 6c75 6d65 2023       # "volume #
-000191a0: 3020 7374 796c 6520 7375 7266 6163 6520  0 style surface 
-000191b0: 6578 7061 6e64 5369 6e67 6c65 506c 616e  expandSinglePlan
-000191c0: 6520 5472 7565 2022 202b 2027 5c6e 270a  e True " + '\n'.
-000191d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000191e0: 2020 2020 2320 2276 6f6c 756d 6520 2330      # "volume #0
-000191f0: 2063 6f6c 6f72 2023 4238 3836 3042 2073   color #B8860B s
-00019200: 7465 7020 3120 2220 2b20 636f 6e74 6f75  tep 1 " + contou
-00019210: 7220 2b20 275c 6e27 0a20 2020 2020 2020  r + '\n'.       
-00019220: 2020 2020 2020 2020 2020 2020 2023 2022               # "
-00019230: 7365 7420 7072 6f6a 6563 7469 6f6e 206f  set projection o
-00019240: 7274 686f 6772 6170 6869 6322 202b 2027  rthographic" + '
-00019250: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
-00019260: 2020 2020 2020 2020 2320 2273 7572 6674          # "surft
-00019270: 7261 6e73 7020 3530 2220 2b20 275c 6e27  ransp 50" + '\n'
-00019280: 2020 2320 6d61 6b65 2074 6865 2073 7572    # make the sur
-00019290: 6661 6365 2061 206c 6974 746c 6520 6269  face a little bi
-000192a0: 7420 7365 652d 7468 726f 7567 680a 2020  t see-through.  
-000192b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000192c0: 2020 2320 2262 6163 6b67 726f 756e 6420    # "background 
-000192d0: 736f 6c69 6420 6c69 6768 7420 6772 6179  solid light gray
-000192e0: 2220 2b20 275c 6e27 0a20 2020 2020 2020  " + '\n'.       
-000192f0: 2020 2020 2020 2020 2020 2020 2023 2022               # "
-00019300: 636f 7079 2066 696c 6520 2220 2b20 7374  copy file " + st
-00019310: 7228 7365 6c66 2e6d 6170 6e61 6d65 2920  r(self.mapname) 
-00019320: 2b20 225f 7a73 7572 6661 6365 2e6a 7065  + "_zsurface.jpe
-00019330: 6722 202b 2022 2073 7570 6572 7361 6d70  g" + " supersamp
-00019340: 6c65 2033 2077 6964 7468 2031 3230 3020  le 3 width 1200 
-00019350: 6865 6967 6874 2031 3230 3022 202b 2027  height 1200" + '
-00019360: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
-00019370: 2020 2020 2020 2020 2320 2274 7572 6e20          # "turn 
-00019380: 7820 2d39 3022 202b 2027 5c6e 270a 2020  x -90" + '\n'.  
-00019390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000193a0: 2020 2320 2263 656e 7465 7222 202b 2027    # "center" + '
-000193b0: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
-000193c0: 2020 2020 2020 2020 2320 2263 6f70 7920          # "copy 
-000193d0: 6669 6c65 2022 202b 2073 7472 2873 656c  file " + str(sel
-000193e0: 662e 6d61 706e 616d 6529 202b 2022 5f78  f.mapname) + "_x
-000193f0: 7375 7266 6163 652e 6a70 6567 2220 2b20  surface.jpeg" + 
-00019400: 2220 7375 7065 7273 616d 706c 6520 3320  " supersample 3 
-00019410: 7769 6474 6820 3132 3030 2068 6569 6768  width 1200 heigh
-00019420: 7420 3132 3030 2220 2b20 275c 6e27 0a20  t 1200" + '\n'. 
-00019430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019440: 2020 2023 2022 7475 726e 207a 202d 3930     # "turn z -90
-00019450: 2220 2b20 275c 6e27 0a20 2020 2020 2020  " + '\n'.       
-00019460: 2020 2020 2020 2020 2020 2020 2023 2022               # "
-00019470: 6365 6e74 6572 2220 2b20 275c 6e27 0a20  center" + '\n'. 
-00019480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019490: 2020 2023 2022 636f 7079 2066 696c 6520     # "copy file 
-000194a0: 2220 2b20 7374 7228 7365 6c66 2e6d 6170  " + str(self.map
-000194b0: 6e61 6d65 2920 2b20 225f 7973 7572 6661  name) + "_ysurfa
-000194c0: 6365 2e6a 7065 6722 202b 2022 2073 7570  ce.jpeg" + " sup
-000194d0: 6572 7361 6d70 6c65 2033 2077 6964 7468  ersample 3 width
-000194e0: 2031 3230 3020 6865 6967 6874 2031 3230   1200 height 120
-000194f0: 3022 202b 2027 5c6e 270a 2020 2020 2020  0" + '\n'.      
-00019500: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00019510: 2263 6c6f 7365 2061 6c6c 2220 2b20 225c  "close all" + "\
-00019520: 6e22 0a20 2020 2020 2020 2020 2020 2020  n".             
-00019530: 2020 2020 2020 2023 2022 7374 6f70 220a         # "stop".
-00019540: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019550: 2020 2020 2023 2043 6869 6d65 7261 5820       # ChimeraX 
-00019560: 7665 7273 696f 6e0a 2020 2020 2020 2020  version.        
-00019570: 2020 2020 2020 2020 2020 2020 226f 7065              "ope
-00019580: 6e20 2220 2b20 7374 7228 7261 776d 6170  n " + str(rawmap
-00019590: 6e61 6d65 2920 2b20 2220 666f 726d 6174  name) + " format
-000195a0: 2063 6370 3422 202b 2027 5c6e 270a 2020   ccp4" + '\n'.  
-000195b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000195c0: 2020 2276 6f6c 756d 6520 2331 2073 7479    "volume #1 sty
-000195d0: 6c65 2073 7572 6661 6365 2065 7870 616e  le surface expan
-000195e0: 6453 696e 676c 6550 6c61 6e65 2054 7275  dSinglePlane Tru
-000195f0: 6522 202b 2027 5c6e 270a 2020 2020 2020  e" + '\n'.      
-00019600: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00019610: 2276 6f6c 756d 6520 2331 2063 6f6c 6f72  "volume #1 color
-00019620: 2023 4238 3836 3042 2073 7465 7020 3120   #B8860B step 1 
-00019630: 6c65 7665 6c20 2220 2b20 7374 7228 7365  level " + str(se
-00019640: 6c66 2e63 6c29 202b 2027 5c6e 270a 2020  lf.cl) + '\n'.  
-00019650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019660: 2020 2276 6f6c 756d 6520 2331 2073 7465    "volume #1 ste
-00019670: 7020 3120 6c65 7665 6c20 2220 2b20 7374  p 1 level " + st
-00019680: 7228 7261 776d 6170 636c 2920 2b20 275c  r(rawmapcl) + '\
-00019690: 6e27 0a20 2020 2020 2020 2020 2020 2020  n'.             
-000196a0: 2020 2020 2020 2022 7365 7420 6267 436f         "set bgCo
-000196b0: 6c6f 7220 7768 6974 6522 202b 2027 5c6e  lor white" + '\n
-000196c0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-000196d0: 2020 2020 2020 226c 6967 6874 696e 6720        "lighting 
-000196e0: 6675 6c6c 205c 6e22 0a20 2020 2020 2020  full \n".       
-000196f0: 2020 2020 2020 2020 2020 2020 2022 7669               "vi
-00019700: 6577 2063 6f66 7220 5472 7565 205c 6e22  ew cofr True \n"
-00019710: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019720: 2020 2020 2022 7361 7665 2022 202b 2073       "save " + s
-00019730: 7472 286d 6170 6e61 6d65 2920 2b20 225f  tr(mapname) + "_
-00019740: 7a73 7572 6661 6365 2e6a 7065 6722 202b  zsurface.jpeg" +
-00019750: 2022 2073 7570 6572 7361 6d70 6c65 2033   " supersample 3
-00019760: 2077 6964 7468 2031 3230 3020 6865 6967   width 1200 heig
-00019770: 6874 2031 3230 3022 202b 2027 5c6e 270a  ht 1200" + '\n'.
-00019780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019790: 2020 2020 2274 7572 6e20 7820 2d39 3022      "turn x -90"
-000197a0: 202b 2027 5c6e 270a 2020 2020 2020 2020   + '\n'.        
-000197b0: 2020 2020 2020 2020 2020 2020 2274 7572              "tur
-000197c0: 6e20 7920 2d39 3022 202b 2027 5c6e 270a  n y -90" + '\n'.
-000197d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000197e0: 2020 2020 2276 6965 7720 636f 6672 2054      "view cofr T
-000197f0: 7275 6522 202b 2027 5c6e 270a 2020 2020  rue" + '\n'.    
-00019800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019810: 2273 6176 6520 2220 2b20 7374 7228 6d61  "save " + str(ma
-00019820: 706e 616d 6529 202b 2022 5f78 7375 7266  pname) + "_xsurf
-00019830: 6163 652e 6a70 6567 2220 2b20 2220 7375  ace.jpeg" + " su
-00019840: 7065 7273 616d 706c 6520 3320 7769 6474  persample 3 widt
-00019850: 6820 3132 3030 2068 6569 6768 7420 3132  h 1200 height 12
-00019860: 3030 2220 2b20 275c 6e27 0a20 2020 2020  00" + '\n'.     
-00019870: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00019880: 7669 6577 206f 7269 656e 7422 202b 2027  view orient" + '
-00019890: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
-000198a0: 2020 2020 2020 2020 2274 7572 6e20 7820          "turn x 
-000198b0: 3930 2220 2b20 275c 6e27 0a20 2020 2020  90" + '\n'.     
-000198c0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000198d0: 7475 726e 207a 2039 3022 202b 2027 5c6e  turn z 90" + '\n
-000198e0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-000198f0: 2020 2020 2020 2276 6965 7720 636f 6672        "view cofr
-00019900: 2054 7275 6522 202b 2027 5c6e 270a 2020   True" + '\n'.  
-00019910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019920: 2020 2273 6176 6520 2220 2b20 7374 7228    "save " + str(
-00019930: 6d61 706e 616d 6529 202b 2022 5f79 7375  mapname) + "_ysu
-00019940: 7266 6163 652e 6a70 6567 2220 2b20 2220  rface.jpeg" + " 
-00019950: 7375 7065 7273 616d 706c 6520 3320 7769  supersample 3 wi
-00019960: 6474 6820 3132 3030 2068 6569 6768 7420  dth 1200 height 
-00019970: 3132 3030 2220 2b20 275c 6e27 0a20 2020  1200" + '\n'.   
-00019980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019990: 2022 636c 6f73 6520 616c 6c22 202b 2022   "close all" + "
-000199a0: 5c6e 220a 2020 2020 2020 2020 2020 2020  \n".            
-000199b0: 2020 2020 2020 2020 2265 7869 7422 202b          "exit" +
-000199c0: 2027 5c6e 270a 2020 2020 2020 2020 2020   '\n'.          
-000199d0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000199e0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-000199f0: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-00019a00: 6269 6e64 6973 706c 6179 3a0a 2020 2020  bindisplay:.    
-00019a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019a20: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
-00019a30: 5f63 616c 6c28 6c6f 6343 4849 4d45 5241  _call(locCHIMERA
-00019a40: 202b 2022 202d 2d6f 6666 7363 7265 656e   + " --offscreen
-00019a50: 202d 2d6e 6f67 7569 2022 202b 2072 6177   --nogui " + raw
-00019a60: 6d61 7063 6869 6d65 7261 636d 642c 0a20  mapchimeracmd,. 
-00019a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019a90: 2020 2020 2020 2020 2020 2063 7764 3d73             cwd=s
-00019aa0: 656c 662e 776f 726b 6469 722c 2073 6865  elf.workdir, she
-00019ab0: 6c6c 3d54 7275 6529 0a20 2020 2020 2020  ll=True).       
-00019ac0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00019ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019ae0: 2020 2073 7562 7072 6f63 6573 732e 6368     subprocess.ch
-00019af0: 6563 6b5f 6361 6c6c 286c 6f63 4348 494d  eck_call(locCHIM
-00019b00: 4552 4120 2b20 2220 2220 2b20 7261 776d  ERA + " " + rawm
-00019b10: 6170 6368 696d 6572 6163 6d64 2c20 6377  apchimeracmd, cw
-00019b20: 643d 7365 6c66 2e77 6f72 6b64 6972 2c20  d=self.workdir, 
-00019b30: 7368 656c 6c3d 5472 7565 290a 0a20 2020  shell=True)..   
-00019b40: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-00019b50: 7375 6270 726f 6365 7373 2e43 616c 6c65  subprocess.Calle
-00019b60: 6450 726f 6365 7373 4572 726f 7220 6173  dProcessError as
-00019b70: 2073 7562 6572 723a 0a20 2020 2020 2020   suberr:.       
-00019b80: 2020 2020 2020 2020 2065 7272 203d 2027           err = '
-00019b90: 5261 7720 6d61 7020 7375 7266 6163 6520  Raw map surface 
-00019ba0: 7669 6577 2062 7920 4368 696d 6572 6158  view by ChimeraX
-00019bb0: 2065 7272 6f72 3a20 7b7d 272e 666f 726d   error: {}'.form
-00019bc0: 6174 2873 7562 6572 7229 0a20 2020 2020  at(suberr).     
-00019bd0: 2020 2020 2020 2020 2020 2065 7272 6c69             errli
-00019be0: 7374 2e61 7070 656e 6428 6572 7229 0a20  st.append(err). 
-00019bf0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00019c00: 7973 2e73 7464 6572 722e 7772 6974 6528  ys.stderr.write(
-00019c10: 6572 7220 2b20 275c 6e27 290a 0a20 2020  err + '\n')..   
-00019c20: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
-00019c30: 5261 7720 6d61 7020 7375 7266 6163 6520  Raw map surface 
-00019c40: 7669 6577 7320 7765 7265 2067 656e 6572  views were gener
-00019c50: 6174 6564 2062 7920 4368 696d 6572 6158  ated by ChimeraX
-00019c60: 206d 6574 686f 6427 290a 2020 2020 2020   method').      
-00019c70: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-00019c80: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00019c90: 7363 616c 655f 7375 7266 6163 6576 6965  scale_surfacevie
-00019ca0: 7728 290a 2020 2020 2020 2020 2020 2020  w().            
-00019cb0: 6578 6365 7074 3a0a 2020 2020 2020 2020  except:.        
-00019cc0: 2020 2020 2020 2020 6572 7220 3d20 2753          err = 'S
-00019cd0: 6361 6c69 6e67 2074 6865 2073 7572 6661  caling the surfa
-00019ce0: 6365 2076 6965 7773 2065 7272 3a20 7b7d  ce views err: {}
-00019cf0: 272e 666f 726d 6174 2873 7973 2e65 7863  '.format(sys.exc
-00019d00: 5f69 6e66 6f28 295b 315d 290a 2020 2020  _info()[1]).    
-00019d10: 2020 2020 2020 2020 2020 2020 6572 726c              errl
-00019d20: 6973 742e 6170 7065 6e64 2865 7272 290a  ist.append(err).
-00019d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019d40: 7379 732e 7374 6465 7272 2e77 7269 7465  sys.stderr.write
-00019d50: 2865 7272 202b 2027 5c6e 2729 0a0a 2020  (err + '\n')..  
-00019d60: 2020 2020 2020 2020 2020 7261 7773 7572            rawsur
-00019d70: 6661 6365 7669 6577 6a73 6f6e 203d 2064  faceviewjson = d
-00019d80: 6963 7428 290a 0a20 2020 2020 2020 2020  ict()..         
-00019d90: 2020 206f 7574 6d61 7078 696d 6167 6520     outmapximage 
-00019da0: 3d20 7374 7228 6d61 706e 616d 6529 202b  = str(mapname) +
-00019db0: 2027 5f78 7375 7266 6163 652e 6a70 6567   '_xsurface.jpeg
-00019dc0: 270a 2020 2020 2020 2020 2020 2020 6d61  '.            ma
-00019dd0: 7078 6c69 7374 203d 206f 7574 6d61 7078  pxlist = outmapx
-00019de0: 696d 6167 652e 7370 6c69 7428 275f 2729  image.split('_')
-00019df0: 0a20 2020 2020 2020 2020 2020 206d 6170  .            map
-00019e00: 7873 6361 6c65 696d 6167 6520 3d20 275f  xscaleimage = '_
-00019e10: 272e 6a6f 696e 286d 6170 786c 6973 745b  '.join(mapxlist[
-00019e20: 3a2d 315d 2920 2b20 275f 7363 616c 6564  :-1]) + '_scaled
-00019e30: 5f27 202b 206d 6170 786c 6973 745b 2d31  _' + mapxlist[-1
-00019e40: 5d0a 2020 2020 2020 2020 2020 2020 7261  ].            ra
-00019e50: 7773 7572 6661 6365 7669 6577 6a73 6f6e  wsurfaceviewjson
-00019e60: 5b27 7827 5d20 3d20 6f73 2e70 6174 682e  ['x'] = os.path.
-00019e70: 6261 7365 6e61 6d65 286d 6170 7873 6361  basename(mapxsca
-00019e80: 6c65 696d 6167 6529 2069 6620 6f73 2e70  leimage) if os.p
-00019e90: 6174 682e 6973 6669 6c65 280a 2020 2020  ath.isfile(.    
-00019ea0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00019eb0: 2e77 6f72 6b64 6972 202b 206d 6170 7873  .workdir + mapxs
-00019ec0: 6361 6c65 696d 6167 6529 2065 6c73 6520  caleimage) else 
-00019ed0: 4e6f 6e65 0a0a 2020 2020 2020 2020 2020  None..          
-00019ee0: 2020 6f75 746d 6170 7969 6d61 6765 203d    outmapyimage =
-00019ef0: 2073 7472 286d 6170 6e61 6d65 2920 2b20   str(mapname) + 
-00019f00: 275f 7973 7572 6661 6365 2e6a 7065 6727  '_ysurface.jpeg'
-00019f10: 0a20 2020 2020 2020 2020 2020 206d 6170  .            map
-00019f20: 796c 6973 7420 3d20 6f75 746d 6170 7969  ylist = outmapyi
-00019f30: 6d61 6765 2e73 706c 6974 2827 5f27 290a  mage.split('_').
-00019f40: 2020 2020 2020 2020 2020 2020 6d61 7079              mapy
-00019f50: 7363 616c 6569 6d61 6765 203d 2027 5f27  scaleimage = '_'
-00019f60: 2e6a 6f69 6e28 6d61 7079 6c69 7374 5b3a  .join(mapylist[:
-00019f70: 2d31 5d29 202b 2027 5f73 6361 6c65 645f  -1]) + '_scaled_
-00019f80: 2720 2b20 6d61 7079 6c69 7374 5b2d 315d  ' + mapylist[-1]
-00019f90: 0a20 2020 2020 2020 2020 2020 2072 6177  .            raw
-00019fa0: 7375 7266 6163 6576 6965 776a 736f 6e5b  surfaceviewjson[
-00019fb0: 2779 275d 203d 206f 732e 7061 7468 2e62  'y'] = os.path.b
-00019fc0: 6173 656e 616d 6528 6d61 7079 7363 616c  asename(mapyscal
-00019fd0: 6569 6d61 6765 2920 6966 206f 732e 7061  eimage) if os.pa
-00019fe0: 7468 2e69 7366 696c 6528 0a20 2020 2020  th.isfile(.     
-00019ff0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0001a000: 776f 726b 6469 7220 2b20 6d61 7079 7363  workdir + mapysc
-0001a010: 616c 6569 6d61 6765 2920 656c 7365 204e  aleimage) else N
-0001a020: 6f6e 650a 0a20 2020 2020 2020 2020 2020  one..           
-0001a030: 206f 7574 6d61 707a 696d 6167 6520 3d20   outmapzimage = 
-0001a040: 7374 7228 6d61 706e 616d 6529 202b 2027  str(mapname) + '
-0001a050: 5f7a 7375 7266 6163 652e 6a70 6567 270a  _zsurface.jpeg'.
-0001a060: 2020 2020 2020 2020 2020 2020 6d61 707a              mapz
-0001a070: 6c69 7374 203d 206f 7574 6d61 707a 696d  list = outmapzim
-0001a080: 6167 652e 7370 6c69 7428 275f 2729 0a20  age.split('_'). 
-0001a090: 2020 2020 2020 2020 2020 206d 6170 7a73             mapzs
-0001a0a0: 6361 6c65 696d 6167 6520 3d20 275f 272e  caleimage = '_'.
-0001a0b0: 6a6f 696e 286d 6170 7a6c 6973 745b 3a2d  join(mapzlist[:-
-0001a0c0: 315d 2920 2b20 275f 7363 616c 6564 5f27  1]) + '_scaled_'
-0001a0d0: 202b 206d 6170 7a6c 6973 745b 2d31 5d0a   + mapzlist[-1].
-0001a0e0: 2020 2020 2020 2020 2020 2020 7261 7773              raws
-0001a0f0: 7572 6661 6365 7669 6577 6a73 6f6e 5b27  urfaceviewjson['
-0001a100: 7a27 5d20 3d20 6f73 2e70 6174 682e 6261  z'] = os.path.ba
-0001a110: 7365 6e61 6d65 286d 6170 7a73 6361 6c65  sename(mapzscale
-0001a120: 696d 6167 6529 2069 6620 6f73 2e70 6174  image) if os.pat
-0001a130: 682e 6973 6669 6c65 280a 2020 2020 2020  h.isfile(.      
-0001a140: 2020 2020 2020 2020 2020 7365 6c66 2e77            self.w
-0001a150: 6f72 6b64 6972 202b 206d 6170 7a73 6361  orkdir + mapzsca
-0001a160: 6c65 696d 6167 6529 2065 6c73 6520 4e6f  leimage) else No
-0001a170: 6e65 0a20 2020 2020 2020 2020 2020 2069  ne.            i
-0001a180: 6620 6572 726c 6973 743a 0a20 2020 2020  f errlist:.     
-0001a190: 2020 2020 2020 2020 2020 2072 6177 7375             rawsu
-0001a1a0: 7266 6163 6576 6965 776a 736f 6e5b 2765  rfaceviewjson['e
-0001a1b0: 7272 275d 203d 207b 2772 6177 6d61 705f  rr'] = {'rawmap_
-0001a1c0: 7375 7266 6163 655f 6572 7227 3a20 6572  surface_err': er
-0001a1d0: 726c 6973 747d 0a0a 2020 2020 2020 2020  rlist}..        
-0001a1e0: 2020 2020 6669 6e61 6c64 6963 7420 3d20      finaldict = 
-0001a1f0: 7b27 7261 776d 6170 5f6d 6170 5f73 7572  {'rawmap_map_sur
-0001a200: 6661 6365 273a 2072 6177 7375 7266 6163  face': rawsurfac
-0001a210: 6576 6965 776a 736f 6e7d 0a20 2020 2020  eviewjson}.     
-0001a220: 2020 2020 2020 2072 6177 636c 6469 6374         rawcldict
-0001a230: 203d 207b 2772 6177 6d61 705f 636f 6e74   = {'rawmap_cont
-0001a240: 6f75 725f 6c65 7665 6c27 3a20 7b27 636c  our_level': {'cl
-0001a250: 273a 2027 7b3a 302e 3266 7d27 2e66 6f72  ': '{:0.2f}'.for
-0001a260: 6d61 7428 7261 776d 6170 636c 297d 7d0a  mat(rawmapcl)}}.
-0001a270: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
-0001a280: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001a290: 2020 7769 7468 2063 6f64 6563 732e 6f70    with codecs.op
-0001a2a0: 656e 2873 656c 662e 776f 726b 6469 7220  en(self.workdir 
-0001a2b0: 2b20 6d61 706e 616d 6520 2b20 275f 7261  + mapname + '_ra
-0001a2c0: 776d 6170 7375 7266 6163 6576 6965 772e  wmapsurfaceview.
-0001a2d0: 6a73 6f6e 272c 2027 7727 2c0a 2020 2020  json', 'w',.    
-0001a2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a2f0: 2020 2020 2020 2020 2020 2020 2065 6e63               enc
-0001a300: 6f64 696e 673d 2775 7466 2d38 2729 2061  oding='utf-8') a
-0001a310: 7320 663a 0a20 2020 2020 2020 2020 2020  s f:.           
-0001a320: 2020 2020 2020 2020 206a 736f 6e2e 6475           json.du
-0001a330: 6d70 2866 696e 616c 6469 6374 2c20 6629  mp(finaldict, f)
-0001a340: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-0001a350: 6570 743a 0a20 2020 2020 2020 2020 2020  ept:.           
-0001a360: 2020 2020 2065 7272 203d 2027 5361 7669       err = 'Savi
-0001a370: 6e67 206d 6170 2073 7572 6661 6365 2076  ng map surface v
-0001a380: 6965 7720 6a73 6f6e 2065 7272 6f72 3a20  iew json error: 
-0001a390: 7b7d 2e27 2e66 6f72 6d61 7428 7379 732e  {}.'.format(sys.
-0001a3a0: 6578 635f 696e 666f 2829 5b31 5d29 0a20  exc_info()[1]). 
-0001a3b0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001a3c0: 7973 2e73 7464 6572 722e 7772 6974 6528  ys.stderr.write(
-0001a3d0: 6572 7220 2b20 275c 6e27 290a 0a20 2020  err + '\n')..   
-0001a3e0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-0001a3f0: 2020 2020 2020 2020 2020 2020 2020 7769                wi
-0001a400: 7468 2063 6f64 6563 732e 6f70 656e 2873  th codecs.open(s
-0001a410: 656c 662e 776f 726b 6469 7220 2b20 6d61  elf.workdir + ma
-0001a420: 706e 616d 6520 2b20 275f 7261 776d 6170  pname + '_rawmap
-0001a430: 636c 2e6a 736f 6e27 2c20 2777 272c 2065  cl.json', 'w', e
-0001a440: 6e63 6f64 696e 673d 2775 7466 2d38 2729  ncoding='utf-8')
-0001a450: 2061 7320 6666 3a0a 2020 2020 2020 2020   as ff:.        
-0001a460: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
-0001a470: 2e64 756d 7028 7261 7763 6c64 6963 742c  .dump(rawcldict,
-0001a480: 2066 6629 0a20 2020 2020 2020 2020 2020   ff).           
-0001a490: 2065 7863 6570 743a 0a20 2020 2020 2020   except:.       
-0001a4a0: 2020 2020 2020 2020 2065 7272 203d 2027           err = '
-0001a4b0: 5361 7669 6e67 2072 6177 6d61 7020 636f  Saving rawmap co
-0001a4c0: 6e74 6f75 7220 6c65 7665 6c20 6a73 6f6e  ntour level json
-0001a4d0: 2065 7272 6f72 3a20 7b7d 2e27 2e66 6f72   error: {}.'.for
-0001a4e0: 6d61 7428 7379 732e 6578 635f 696e 666f  mat(sys.exc_info
-0001a4f0: 2829 5b31 5d29 0a20 2020 2020 2020 2020  ()[1]).         
-0001a500: 2020 2020 2020 2073 7973 2e73 7464 6572         sys.stder
-0001a510: 722e 7772 6974 6528 6572 7220 2b20 275c  r.write(err + '\
-0001a520: 6e27 290a 0a20 2020 2020 2020 2020 2020  n')..           
-0001a530: 2065 6e64 203d 2074 696d 6569 742e 6465   end = timeit.de
-0001a540: 6661 756c 745f 7469 6d65 7228 290a 2020  fault_timer().  
-0001a550: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-0001a560: 2752 6177 206d 6170 2073 7572 6661 6365  'Raw map surface
-0001a570: 2076 6965 7720 7469 6d65 3a20 2573 2720   view time: %s' 
-0001a580: 2520 2865 6e64 202d 2073 7461 7274 2929  % (end - start))
-0001a590: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-0001a5a0: 6e74 2827 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  nt('------------
-0001a5b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0001a5c0: 2d2d 2d2d 2d2d 2d2d 2729 0a0a 2020 2020  --------')..    
-0001a5d0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0001a5e0: 2020 2020 2020 7072 696e 7428 274e 6f20        print('No 
-0001a5f0: 7261 7720 6d61 7020 6f72 2068 616c 6620  raw map or half 
-0001a600: 6d61 7073 206f 7220 7261 7720 6d61 7020  maps or raw map 
-0001a610: 636f 6e74 6f75 7220 6c65 7665 6c20 666f  contour level fo
-0001a620: 7220 7261 7720 6d61 7020 7375 7266 6163  r raw map surfac
-0001a630: 6573 2e27 290a 0a0a 2020 2020 2320 5375  es.')...    # Su
-0001a640: 7266 6163 6520 4368 696d 6572 6120 7761  rface Chimera wa
-0001a650: 790a 2020 2020 6465 6620 7375 7266 6163  y.    def surfac
-0001a660: 6576 6965 775f 6368 696d 6572 6128 7365  eview_chimera(se
-0001a670: 6c66 2c20 6368 696d 6572 6161 7070 293a  lf, chimeraapp):
-0001a680: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0001a690: 2020 2020 2020 2020 2047 656e 6572 6174           Generat
-0001a6a0: 6520 7375 7266 6163 6520 7669 6577 2062  e surface view b
-0001a6b0: 7920 7573 696e 6720 6865 6164 6c65 7373  y using headless
-0001a6c0: 2043 6869 6d65 7261 2061 6e64 2070 7963   Chimera and pyc
-0001a6d0: 6869 6d65 7261 0a0a 2020 2020 2020 2020  himera..        
-0001a6e0: 2222 220a 2020 2020 2020 2020 696d 706f  """.        impo
-0001a6f0: 7274 206d 6d61 700a 0a20 2020 2020 2020  rt mmap..       
-0001a700: 2073 7461 7274 203d 2074 696d 6569 742e   start = timeit.
-0001a710: 6465 6661 756c 745f 7469 6d65 7228 290a  default_timer().
-0001a720: 2020 2020 2020 2020 6572 726c 6973 7420          errlist 
-0001a730: 3d20 5b5d 0a20 2020 2020 2020 206d 6d65  = [].        mme
-0001a740: 7272 6c69 7374 203d 205b 5d0a 2020 2020  rrlist = [].    
-0001a750: 2020 2020 6269 6e64 6973 706c 6179 203d      bindisplay =
-0001a760: 206f 732e 6765 7465 6e76 2827 4449 5350   os.getenv('DISP
-0001a770: 4c41 5927 290a 0a20 2020 2020 2020 206d  LAY')..        m
-0001a780: 6170 6e61 6d65 203d 2073 656c 662e 776f  apname = self.wo
-0001a790: 726b 6469 7220 2b20 7365 6c66 2e6d 6170  rkdir + self.map
-0001a7a0: 6e61 6d65 0a20 2020 2020 2020 2069 6620  name.        if 
-0001a7b0: 6e6f 7420 6f73 2e70 6174 682e 6973 6669  not os.path.isfi
-0001a7c0: 6c65 286d 6170 6e61 6d65 2920 616e 6420  le(mapname) and 
-0001a7d0: 6f73 2e70 6174 682e 6973 6669 6c65 2873  os.path.isfile(s
-0001a7e0: 656c 662e 6d61 706e 616d 6529 3a0a 2020  elf.mapname):.  
-0001a7f0: 2020 2020 2020 2020 2020 6d61 706e 616d            mapnam
-0001a800: 6520 3d20 7365 6c66 2e6d 6170 6e61 6d65  e = self.mapname
-0001a810: 0a0a 2020 2020 2020 2020 6c6f 6343 4849  ..        locCHI
-0001a820: 4d45 5241 203d 2063 6869 6d65 7261 6170  MERA = chimeraap
-0001a830: 700a 2020 2020 2020 2020 636f 6e74 6f75  p.        contou
-0001a840: 7220 3d20 226c 6576 656c 2022 202b 2073  r = "level " + s
-0001a850: 7472 2873 656c 662e 636c 2920 6966 2073  tr(self.cl) if s
-0001a860: 656c 662e 636c 2069 7320 6e6f 7420 4e6f  elf.cl is not No
-0001a870: 6e65 2065 6c73 6520 2727 0a20 2020 2020  ne else ''.     
-0001a880: 2020 2023 206d 6170 2073 7572 6661 6365     # map surface
-0001a890: 2076 6965 7720 616c 6f6e 650a 2020 2020   view alone.    
-0001a8a0: 2020 2020 6d61 7063 6869 6d65 7261 636d      mapchimeracm
-0001a8b0: 6420 3d20 7365 6c66 2e6d 6170 6e61 6d65  d = self.mapname
-0001a8c0: 202b 2027 5f63 6869 6d65 7261 2e63 7863   + '_chimera.cxc
-0001a8d0: 270a 2020 2020 2020 2020 6173 7365 6d62  '.        assemb
-0001a8e0: 6c65 203d 2046 616c 7365 0a20 2020 2020  le = False.     
-0001a8f0: 2020 2077 6974 6820 6f70 656e 2873 656c     with open(sel
-0001a900: 662e 776f 726b 6469 7220 2b20 6d61 7063  f.workdir + mapc
-0001a910: 6869 6d65 7261 636d 642c 2027 7727 2920  himeracmd, 'w') 
-0001a920: 6173 2066 3a0a 2020 2020 2020 2020 2020  as f:.          
-0001a930: 2020 662e 7772 6974 6528 0a20 2020 2020    f.write(.     
-0001a940: 2020 2020 2020 2020 2020 2023 2043 6869             # Chi
-0001a950: 6d65 7261 2076 6572 7369 6f6e 0a20 2020  mera version.   
-0001a960: 2020 2020 2020 2020 2020 2020 2023 2027               # '
-0001a970: 6f70 656e 2063 6370 343a 2720 2b20 7374  open ccp4:' + st
-0001a980: 7228 6d61 706e 616d 6529 202b 2027 5c6e  r(mapname) + '\n
-0001a990: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0001a9a0: 2020 2320 2276 6f6c 756d 6520 2330 2073    # "volume #0 s
-0001a9b0: 7479 6c65 2073 7572 6661 6365 2065 7870  tyle surface exp
-0001a9c0: 616e 6453 696e 676c 6550 6c61 6e65 2054  andSinglePlane T
-0001a9d0: 7275 6520 2220 2b20 275c 6e27 0a20 2020  rue " + '\n'.   
-0001a9e0: 2020 2020 2020 2020 2020 2020 2023 2022               # "
-0001a9f0: 766f 6c75 6d65 2023 3020 636f 6c6f 7220  volume #0 color 
-0001aa00: 2342 3838 3630 4220 7374 6570 2031 2022  #B8860B step 1 "
-0001aa10: 202b 2063 6f6e 746f 7572 202b 2027 5c6e   + contour + '\n
-0001aa20: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0001aa30: 2020 2320 2273 6574 2070 726f 6a65 6374    # "set project
-0001aa40: 696f 6e20 6f72 7468 6f67 7261 7068 6963  ion orthographic
-0001aa50: 2220 2b20 275c 6e27 0a20 2020 2020 2020  " + '\n'.       
-0001aa60: 2020 2020 2020 2020 2023 2022 7375 7266           # "surf
-0001aa70: 7472 616e 7370 2035 3022 202b 2027 5c6e  transp 50" + '\n
-0001aa80: 2720 2023 206d 616b 6520 7468 6520 7375  '  # make the su
-0001aa90: 7266 6163 6520 6120 6c69 7474 6c65 2062  rface a little b
-0001aaa0: 6974 2073 6565 2d74 6872 6f75 6768 0a20  it see-through. 
-0001aab0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0001aac0: 2022 6261 636b 6772 6f75 6e64 2073 6f6c   "background sol
-0001aad0: 6964 206c 6967 6874 2067 7261 7922 202b  id light gray" +
-0001aae0: 2027 5c6e 270a 2020 2020 2020 2020 2020   '\n'.          
-0001aaf0: 2020 2020 2020 2320 2263 6f70 7920 6669        # "copy fi
-0001ab00: 6c65 2022 202b 2073 7472 2873 656c 662e  le " + str(self.
-0001ab10: 6d61 706e 616d 6529 202b 2022 5f7a 7375  mapname) + "_zsu
-0001ab20: 7266 6163 652e 6a70 6567 2220 2b20 2220  rface.jpeg" + " 
-0001ab30: 7375 7065 7273 616d 706c 6520 3320 7769  supersample 3 wi
-0001ab40: 6474 6820 3132 3030 2068 6569 6768 7420  dth 1200 height 
-0001ab50: 3132 3030 2220 2b20 275c 6e27 0a20 2020  1200" + '\n'.   
-0001ab60: 2020 2020 2020 2020 2020 2020 2023 2022               # "
-0001ab70: 7475 726e 2078 202d 3930 2220 2b20 275c  turn x -90" + '\
-0001ab80: 6e27 0a20 2020 2020 2020 2020 2020 2020  n'.             
-0001ab90: 2020 2023 2022 6365 6e74 6572 2220 2b20     # "center" + 
-0001aba0: 275c 6e27 0a20 2020 2020 2020 2020 2020  '\n'.           
-0001abb0: 2020 2020 2023 2022 636f 7079 2066 696c       # "copy fil
-0001abc0: 6520 2220 2b20 7374 7228 7365 6c66 2e6d  e " + str(self.m
-0001abd0: 6170 6e61 6d65 2920 2b20 225f 7873 7572  apname) + "_xsur
-0001abe0: 6661 6365 2e6a 7065 6722 202b 2022 2073  face.jpeg" + " s
-0001abf0: 7570 6572 7361 6d70 6c65 2033 2077 6964  upersample 3 wid
-0001ac00: 7468 2031 3230 3020 6865 6967 6874 2031  th 1200 height 1
-0001ac10: 3230 3022 202b 2027 5c6e 270a 2020 2020  200" + '\n'.    
-0001ac20: 2020 2020 2020 2020 2020 2020 2320 2274              # "t
-0001ac30: 7572 6e20 7a20 2d39 3022 202b 2027 5c6e  urn z -90" + '\n
-0001ac40: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0001ac50: 2020 2320 2263 656e 7465 7222 202b 2027    # "center" + '
-0001ac60: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
-0001ac70: 2020 2020 2320 2263 6f70 7920 6669 6c65      # "copy file
-0001ac80: 2022 202b 2073 7472 2873 656c 662e 6d61   " + str(self.ma
-0001ac90: 706e 616d 6529 202b 2022 5f79 7375 7266  pname) + "_ysurf
-0001aca0: 6163 652e 6a70 6567 2220 2b20 2220 7375  ace.jpeg" + " su
-0001acb0: 7065 7273 616d 706c 6520 3320 7769 6474  persample 3 widt
-0001acc0: 6820 3132 3030 2068 6569 6768 7420 3132  h 1200 height 12
-0001acd0: 3030 2220 2b20 275c 6e27 0a20 2020 2020  00" + '\n'.     
-0001ace0: 2020 2020 2020 2020 2020 2023 2022 636c             # "cl
-0001acf0: 6f73 6520 616c 6c22 202b 2022 5c6e 220a  ose all" + "\n".
-0001ad00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ad10: 2320 2273 746f 7022 0a0a 2020 2020 2020  # "stop"..      
-0001ad20: 2020 2020 2020 2020 2020 2320 4368 696d            # Chim
-0001ad30: 6572 6158 2076 6572 7369 6f6e 0a20 2020  eraX version.   
-0001ad40: 2020 2020 2020 2020 2020 2020 2022 6f70               "op
-0001ad50: 656e 2022 202b 2073 7472 286d 6170 6e61  en " + str(mapna
-0001ad60: 6d65 2920 2b20 2220 666f 726d 6174 2063  me) + " format c
-0001ad70: 6370 3422 202b 2027 5c6e 270a 2020 2020  cp4" + '\n'.    
-0001ad80: 2020 2020 2020 2020 2020 2020 2276 6f6c              "vol
-0001ad90: 756d 6520 2331 2073 7479 6c65 2073 7572  ume #1 style sur
-0001ada0: 6661 6365 2065 7870 616e 6453 696e 676c  face expandSingl
-0001adb0: 6550 6c61 6e65 2054 7275 6522 202b 2027  ePlane True" + '
-0001adc0: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
-0001add0: 2020 2020 2320 2276 6f6c 756d 6520 2331      # "volume #1
-0001ade0: 2063 6f6c 6f72 2023 4238 3836 3042 2073   color #B8860B s
-0001adf0: 7465 7020 3120 6c65 7665 6c20 2220 2b20  tep 1 level " + 
-0001ae00: 7374 7228 7365 6c66 2e63 6c29 202b 2027  str(self.cl) + '
-0001ae10: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
-0001ae20: 2020 2020 2276 6f6c 756d 6520 2331 2073      "volume #1 s
-0001ae30: 7465 7020 3120 6c65 7665 6c20 2220 2b20  tep 1 level " + 
-0001ae40: 7374 7228 7365 6c66 2e63 6c29 202b 2027  str(self.cl) + '
-0001ae50: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
-0001ae60: 2020 2020 2273 6574 2062 6743 6f6c 6f72      "set bgColor
-0001ae70: 2077 6869 7465 2220 2b20 275c 6e27 0a20   white" + '\n'. 
-0001ae80: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0001ae90: 6c69 6768 7469 6e67 2066 756c 6c20 5c6e  lighting full \n
-0001aea0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0001aeb0: 2020 2276 6965 7720 636f 6672 2054 7275    "view cofr Tru
-0001aec0: 6520 5c6e 220a 2020 2020 2020 2020 2020  e \n".          
-0001aed0: 2020 2020 2020 2273 6176 6520 2220 2b20        "save " + 
-0001aee0: 7374 7228 7365 6c66 2e6d 6170 6e61 6d65  str(self.mapname
-0001aef0: 2920 2b20 225f 7a73 7572 6661 6365 2e6a  ) + "_zsurface.j
-0001af00: 7065 6722 202b 2022 2073 7570 6572 7361  peg" + " supersa
-0001af10: 6d70 6c65 2033 2077 6964 7468 2031 3230  mple 3 width 120
-0001af20: 3020 6865 6967 6874 2031 3230 3022 202b  0 height 1200" +
-0001af30: 2027 5c6e 270a 2020 2020 2020 2020 2020   '\n'.          
-0001af40: 2020 2020 2020 2274 7572 6e20 7820 2d39        "turn x -9
-0001af50: 3022 202b 2027 5c6e 270a 2020 2020 2020  0" + '\n'.      
-0001af60: 2020 2020 2020 2020 2020 2274 7572 6e20            "turn 
-0001af70: 7920 2d39 3022 202b 2027 5c6e 270a 2020  y -90" + '\n'.  
-0001af80: 2020 2020 2020 2020 2020 2020 2020 2276                "v
-0001af90: 6965 7720 636f 6672 2054 7275 6522 202b  iew cofr True" +
-0001afa0: 2027 5c6e 270a 2020 2020 2020 2020 2020   '\n'.          
-0001afb0: 2020 2020 2020 2273 6176 6520 2220 2b20        "save " + 
-0001afc0: 7374 7228 7365 6c66 2e6d 6170 6e61 6d65  str(self.mapname
-0001afd0: 2920 2b20 225f 7873 7572 6661 6365 2e6a  ) + "_xsurface.j
-0001afe0: 7065 6722 202b 2022 2073 7570 6572 7361  peg" + " supersa
-0001aff0: 6d70 6c65 2033 2077 6964 7468 2031 3230  mple 3 width 120
-0001b000: 3020 6865 6967 6874 2031 3230 3022 202b  0 height 1200" +
-0001b010: 2027 5c6e 270a 2020 2020 2020 2020 2020   '\n'.          
-0001b020: 2020 2020 2020 2276 6965 7720 6f72 6965        "view orie
-0001b030: 6e74 2220 2b20 275c 6e27 0a20 2020 2020  nt" + '\n'.     
-0001b040: 2020 2020 2020 2020 2020 2022 7475 726e             "turn
-0001b050: 2078 2039 3022 202b 2027 5c6e 270a 2020   x 90" + '\n'.  
-0001b060: 2020 2020 2020 2020 2020 2020 2020 2274                "t
-0001b070: 7572 6e20 7a20 3930 2220 2b20 275c 6e27  urn z 90" + '\n'
-0001b080: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b090: 2022 7669 6577 2063 6f66 7220 5472 7565   "view cofr True
-0001b0a0: 2220 2b20 275c 6e27 0a20 2020 2020 2020  " + '\n'.       
-0001b0b0: 2020 2020 2020 2020 2022 7361 7665 2022           "save "
-0001b0c0: 202b 2073 7472 2873 656c 662e 6d61 706e   + str(self.mapn
-0001b0d0: 616d 6529 202b 2022 5f79 7375 7266 6163  ame) + "_ysurfac
-0001b0e0: 652e 6a70 6567 2220 2b20 2220 7375 7065  e.jpeg" + " supe
-0001b0f0: 7273 616d 706c 6520 3320 7769 6474 6820  rsample 3 width 
-0001b100: 3132 3030 2068 6569 6768 7420 3132 3030  1200 height 1200
-0001b110: 2220 2b20 275c 6e27 0a20 2020 2020 2020  " + '\n'.       
-0001b120: 2020 2020 2020 2020 2022 636c 6f73 6520           "close 
-0001b130: 616c 6c22 202b 2022 5c6e 220a 2020 2020  all" + "\n".    
-0001b140: 2020 2020 2020 2020 2020 2020 2265 7869              "exi
-0001b150: 7422 202b 2027 5c6e 270a 2020 2020 2020  t" + '\n'.      
-0001b160: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-0001b170: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-0001b180: 2020 6966 206e 6f74 2062 696e 6469 7370    if not bindisp
-0001b190: 6c61 793a 0a20 2020 2020 2020 2020 2020  lay:.           
-0001b1a0: 2020 2020 2073 7562 7072 6f63 6573 732e       subprocess.
-0001b1b0: 6368 6563 6b5f 6361 6c6c 286c 6f63 4348  check_call(locCH
-0001b1c0: 494d 4552 4120 2b20 2220 2d2d 6f66 6673  IMERA + " --offs
-0001b1d0: 6372 6565 6e20 2d2d 6e6f 6775 6920 2220  creen --nogui " 
-0001b1e0: 2b20 7365 6c66 2e77 6f72 6b64 6972 202b  + self.workdir +
-0001b1f0: 206d 6170 6368 696d 6572 6163 6d64 2c0a   mapchimeracmd,.
-0001b200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b220: 2020 2020 2020 2020 6377 643d 7365 6c66          cwd=self
-0001b230: 2e77 6f72 6b64 6972 2c20 7368 656c 6c3d  .workdir, shell=
-0001b240: 5472 7565 290a 2020 2020 2020 2020 2020  True).          
-0001b250: 2020 2020 2020 656e 6420 3d20 7469 6d65        end = time
-0001b260: 6974 2e64 6566 6175 6c74 5f74 696d 6572  it.default_timer
-0001b270: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
-0001b280: 2020 2070 7269 6e74 2827 5072 696d 6172     print('Primar
-0001b290: 7920 6d61 7020 7375 7266 6163 6520 7669  y map surface vi
-0001b2a0: 6577 2074 696d 653a 2025 7327 2025 2028  ew time: %s' % (
-0001b2b0: 656e 6420 2d20 7374 6172 7429 290a 2020  end - start)).  
-0001b2c0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-0001b2d0: 696e 7428 272d 2d2d 2d2d 2d2d 2d2d 2d2d  int('-----------
-0001b2e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0001b2f0: 2d2d 2d2d 2d2d 2d2d 2d27 290a 2020 2020  ---------').    
-0001b300: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001b310: 2020 2020 2020 2020 2020 2020 2020 7375                su
-0001b320: 6270 726f 6365 7373 2e63 6865 636b 5f63  bprocess.check_c
-0001b330: 616c 6c28 6c6f 6343 4849 4d45 5241 202b  all(locCHIMERA +
-0001b340: 2022 2022 202b 2073 656c 662e 776f 726b   " " + self.work
-0001b350: 6469 7220 2b20 6d61 7063 6869 6d65 7261  dir + mapchimera
-0001b360: 636d 642c 2063 7764 3d73 656c 662e 776f  cmd, cwd=self.wo
-0001b370: 726b 6469 722c 2073 6865 6c6c 3d54 7275  rkdir, shell=Tru
-0001b380: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-0001b390: 2020 2065 6e64 203d 2074 696d 6569 742e     end = timeit.
-0001b3a0: 6465 6661 756c 745f 7469 6d65 7228 290a  default_timer().
-0001b3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b3c0: 7072 696e 7428 2750 7269 6d61 7279 206d  print('Primary m
-0001b3d0: 6170 2073 7572 6661 6365 2076 6965 7720  ap surface view 
-0001b3e0: 7469 6d65 3a20 2573 2720 2520 2865 6e64  time: %s' % (end
-0001b3f0: 202d 2073 7461 7274 2929 0a20 2020 2020   - start)).     
-0001b400: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-0001b410: 2827 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ('--------------
-0001b420: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0001b430: 2d2d 2d2d 2d2d 2729 0a20 2020 2020 2020  ------').       
-0001b440: 2065 7863 6570 7420 7375 6270 726f 6365   except subproce
-0001b450: 7373 2e43 616c 6c65 6450 726f 6365 7373  ss.CalledProcess
-0001b460: 4572 726f 7220 6173 2073 7562 6572 723a  Error as suberr:
-0001b470: 0a20 2020 2020 2020 2020 2020 2065 6e64  .            end
-0001b480: 203d 2074 696d 6569 742e 6465 6661 756c   = timeit.defaul
-0001b490: 745f 7469 6d65 7228 290a 2020 2020 2020  t_timer().      
-0001b4a0: 2020 2020 2020 6572 7220 3d20 2750 7269        err = 'Pri
-0001b4b0: 6d61 7279 206d 6170 2073 7572 6661 6365  mary map surface
-0001b4c0: 2076 6965 7720 6279 2043 6869 6d65 7261   view by Chimera
-0001b4d0: 5820 6572 726f 723a 207b 7d27 2e66 6f72  X error: {}'.for
-0001b4e0: 6d61 7428 7375 6265 7272 290a 2020 2020  mat(suberr).    
-0001b4f0: 2020 2020 2020 2020 7072 696e 7428 2750          print('P
-0001b500: 7269 6d61 7279 206d 6170 2073 7572 6661  rimary map surfa
-0001b510: 6365 2076 6965 7720 7469 6d65 3a20 2573  ce view time: %s
-0001b520: 2720 2520 2865 6e64 202d 2073 7461 7274  ' % (end - start
-0001b530: 2929 0a20 2020 2020 2020 2020 2020 2070  )).            p
-0001b540: 7269 6e74 2827 2d2d 2d2d 2d2d 2d2d 2d2d  rint('----------
-0001b550: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0001b560: 2d2d 2d2d 2d2d 2d2d 2d2d 2729 0a20 2020  ----------').   
-0001b570: 2020 2020 2020 2020 2065 7272 6c69 7374           errlist
-0001b580: 2e61 7070 656e 6428 6572 7229 0a20 2020  .append(err).   
-0001b590: 2020 2020 2020 2020 2073 7973 2e73 7464           sys.std
-0001b5a0: 6572 722e 7772 6974 6528 6572 7220 2b20  err.write(err + 
-0001b5b0: 275c 6e27 290a 0a0a 2020 2020 2020 2020  '\n')...        
-0001b5c0: 2320 6d61 7020 616e 6420 6d6f 6465 6c73  # map and models
-0001b5d0: 2076 6965 7720 746f 6765 7468 6572 0a20   view together. 
-0001b5e0: 2020 2020 2020 206e 7374 6172 7420 3d20         nstart = 
-0001b5f0: 7469 6d65 6974 2e64 6566 6175 6c74 5f74  timeit.default_t
-0001b600: 696d 6572 2829 0a20 2020 2020 2020 2069  imer().        i
-0001b610: 6620 7365 6c66 2e6d 6f64 656c 733a 0a20  f self.models:. 
-0001b620: 2020 2020 2020 2020 2020 2066 6f72 206d             for m
-0001b630: 6f64 656c 2069 6e20 7365 6c66 2e6d 6f64  odel in self.mod
-0001b640: 656c 733a 0a20 2020 2020 2020 2020 2020  els:.           
-0001b650: 2020 2020 2023 2070 6462 6964 203d 206d       # pdbid = m
-0001b660: 6f64 656c 2e66 696c 656e 616d 652e 7370  odel.filename.sp
-0001b670: 6c69 7428 272f 2729 5b2d 315d 2e73 706c  lit('/')[-1].spl
-0001b680: 6974 2827 2e27 295b 305d 0a20 2020 2020  it('.')[0].     
-0001b690: 2020 2020 2020 2020 2020 2070 6462 6964             pdbid
-0001b6a0: 203d 206f 732e 7061 7468 2e62 6173 656e   = os.path.basen
-0001b6b0: 616d 6528 6d6f 6465 6c2e 6669 6c65 6e61  ame(model.filena
-0001b6c0: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
-0001b6d0: 2020 2020 7375 7266 6163 6566 6e20 3d20      surfacefn = 
-0001b6e0: 277b 7d5f 7b7d 272e 666f 726d 6174 2870  '{}_{}'.format(p
-0001b6f0: 6462 6964 2c20 7365 6c66 2e6d 6170 6e61  dbid, self.mapna
-0001b700: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
-0001b710: 2020 2020 6368 696d 6572 6163 6d64 203d      chimeracmd =
-0001b720: 2073 7572 6661 6365 666e 202b 2027 5f63   surfacefn + '_c
-0001b730: 6869 6d65 7261 2e63 7863 270a 2020 2020  himera.cxc'.    
-0001b740: 2020 2020 2020 2020 2020 2020 7769 7468              with
-0001b750: 206f 7065 6e28 7365 6c66 2e77 6f72 6b64   open(self.workd
-0001b760: 6972 202b 2063 6869 6d65 7261 636d 642c  ir + chimeracmd,
-0001b770: 2027 7727 2920 6173 2066 3a0a 2020 2020   'w') as f:.    
-0001b780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b790: 662e 7772 6974 6528 0a20 2020 2020 2020  f.write(.       
-0001b7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b7b0: 2023 2043 6869 6d65 7261 2076 6572 7369   # Chimera versi
-0001b7c0: 6f6e 0a20 2020 2020 2020 2020 2020 2020  on.             
-0001b7d0: 2020 2020 2020 2020 2020 2023 2027 6f70             # 'op
-0001b7e0: 656e 2063 6370 343a 2720 2b20 7374 7228  en ccp4:' + str(
-0001b7f0: 6d61 706e 616d 6529 202b 2027 5c6e 270a  mapname) + '\n'.
-0001b800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b810: 2020 2020 2020 2020 2320 226f 7065 6e20          # "open 
-0001b820: 6369 663a 2220 2b20 7374 7228 6d6f 6465  cif:" + str(mode
-0001b830: 6c2e 6669 6c65 6e61 6d65 2920 2b20 275c  l.filename) + '\
-0001b840: 6e27 0a20 2020 2020 2020 2020 2020 2020  n'.             
-0001b850: 2020 2020 2020 2020 2020 2023 2022 766f             # "vo
-0001b860: 6c75 6d65 2023 3020 7374 796c 6520 7375  lume #0 style su
-0001b870: 7266 6163 6520 6578 7061 6e64 5369 6e67  rface expandSing
-0001b880: 6c65 506c 616e 6520 5472 7565 2022 202b  lePlane True " +
-0001b890: 2027 5c6e 270a 2020 2020 2020 2020 2020   '\n'.          
-0001b8a0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0001b8b0: 2276 6f6c 756d 6520 2330 2063 6f6c 6f72  "volume #0 color
-0001b8c0: 2023 4238 3836 3042 2073 7465 7020 3120   #B8860B step 1 
-0001b8d0: 2220 2b20 636f 6e74 6f75 7220 2b20 275c  " + contour + '\
-0001b8e0: 6e27 0a20 2020 2020 2020 2020 2020 2020  n'.             
-0001b8f0: 2020 2020 2020 2020 2020 2023 2022 7365             # "se
-0001b900: 7420 7072 6f6a 6563 7469 6f6e 206f 7274  t projection ort
-0001b910: 686f 6772 6170 6869 6322 202b 2027 5c6e  hographic" + '\n
-0001b920: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0001b930: 2020 2020 2020 2020 2020 2320 2273 7572            # "sur
-0001b940: 6674 7261 6e73 7020 3530 2220 2b20 275c  ftransp 50" + '\
-0001b950: 6e27 2020 2320 6d61 6b65 2074 6865 2073  n'  # make the s
-0001b960: 7572 6661 6365 2061 206c 6974 746c 6520  urface a little 
-0001b970: 6269 7420 7365 652d 7468 726f 7567 680a  bit see-through.
-0001b980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b990: 2020 2020 2020 2020 2320 2262 6163 6b67          # "backg
-0001b9a0: 726f 756e 6420 736f 6c69 6420 6c69 6768  round solid ligh
-0001b9b0: 7420 6772 6179 2220 2b20 275c 6e27 0a20  t gray" + '\n'. 
-0001b9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b9d0: 2020 2020 2020 2023 2022 636f 7079 2066         # "copy f
-0001b9e0: 696c 6520 2220 2b20 7374 7228 7375 7266  ile " + str(surf
-0001b9f0: 6163 6566 6e29 202b 2022 5f7a 7375 7266  acefn) + "_zsurf
-0001ba00: 6163 652e 6a70 6567 2220 2b20 2220 7375  ace.jpeg" + " su
-0001ba10: 7065 7273 616d 706c 6520 3320 7769 6474  persample 3 widt
-0001ba20: 6820 3132 3030 2068 6569 6768 7420 3132  h 1200 height 12
-0001ba30: 3030 2220 2b20 275c 6e27 0a20 2020 2020  00" + '\n'.     
-0001ba40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ba50: 2020 2023 2022 7475 726e 2078 202d 3930     # "turn x -90
-0001ba60: 2220 2b20 275c 6e27 0a20 2020 2020 2020  " + '\n'.       
-0001ba70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ba80: 2023 2022 6365 6e74 6572 2220 2b20 275c   # "center" + '\
-0001ba90: 6e27 0a20 2020 2020 2020 2020 2020 2020  n'.             
-0001baa0: 2020 2020 2020 2020 2020 2023 2022 636f             # "co
-0001bab0: 7079 2066 696c 6520 2220 2b20 7374 7228  py file " + str(
-0001bac0: 7375 7266 6163 6566 6e29 202b 2022 5f78  surfacefn) + "_x
-0001bad0: 7375 7266 6163 652e 6a70 6567 2220 2b20  surface.jpeg" + 
-0001bae0: 2220 7375 7065 7273 616d 706c 6520 3320  " supersample 3 
-0001baf0: 7769 6474 6820 3132 3030 2068 6569 6768  width 1200 heigh
-0001bb00: 7420 3132 3030 2220 2b20 275c 6e27 0a20  t 1200" + '\n'. 
-0001bb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bb20: 2020 2020 2020 2023 2022 7475 726e 207a         # "turn z
-0001bb30: 202d 3930 2220 2b20 275c 6e27 0a20 2020   -90" + '\n'.   
-0001bb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bb50: 2020 2020 2023 2022 6365 6e74 6572 2220       # "center" 
-0001bb60: 2b20 275c 6e27 0a20 2020 2020 2020 2020  + '\n'.         
+00017c10: 2020 2069 6620 7769 6474 6820 3e3d 2068     if width >= h
+00017c20: 6569 6768 743a 0a20 2020 2020 2020 2020  eight:.         
+00017c30: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00017c40: 6172 6765 7273 6361 6c65 7220 3d20 3330  argerscaler = 30
+00017c50: 302e 202f 2077 6964 7468 0a20 2020 2020  0. / width.     
+00017c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017c70: 2020 206e 6577 6865 6967 6874 203d 2069     newheight = i
+00017c80: 6e74 2863 6569 6c28 6c61 7267 6572 7363  nt(ceil(largersc
+00017c90: 616c 6572 202a 2068 6569 6768 7429 290a  aler * height)).
+00017ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017cb0: 2020 2020 2020 2020 696d 7920 3d20 496d          imy = Im
+00017cc0: 6167 652e 6672 6f6d 6172 7261 7928 7972  age.fromarray(yr
+00017cd0: 6f74 6174 6529 2e72 6573 697a 6528 2833  otate).resize((3
+00017ce0: 3030 2c20 6e65 7768 6569 6768 7429 2c20  00, newheight), 
+00017cf0: 496d 6167 652e 414e 5449 414c 4941 5329  Image.ANTIALIAS)
+00017d00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017d10: 2020 2020 2020 2020 2069 6d79 2e73 6176           imy.sav
+00017d20: 6528 7973 6361 6c65 6e61 6d65 290a 2020  e(yscalename).  
+00017d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017d40: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00017d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017d60: 6c61 7267 6572 7363 616c 6572 203d 2033  largerscaler = 3
+00017d70: 3030 2e20 2f20 6865 6967 6874 0a20 2020  00. / height.   
+00017d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017d90: 2020 2020 206e 6577 7769 6474 6820 3d20       newwidth = 
+00017da0: 696e 7428 6365 696c 286c 6172 6765 7273  int(ceil(largers
+00017db0: 6361 6c65 7220 2a20 7769 6474 6829 290a  caler * width)).
+00017dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017dd0: 2020 2020 2020 2020 696d 7920 3d20 496d          imy = Im
+00017de0: 6167 652e 6672 6f6d 6172 7261 7928 7972  age.fromarray(yr
+00017df0: 6f74 6174 6529 2e72 6573 697a 6528 286e  otate).resize((n
+00017e00: 6577 7769 6474 682c 2033 3030 292c 2049  ewwidth, 300), I
+00017e10: 6d61 6765 2e41 4e54 4941 4c49 4153 290a  mage.ANTIALIAS).
+00017e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017e30: 2020 2020 2020 2020 696d 792e 7361 7665          imy.save
+00017e40: 2879 7363 616c 656e 616d 6529 0a20 2020  (yscalename).   
+00017e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017e60: 2023 2069 6d79 203d 2049 6d61 6765 2e66   # imy = Image.f
+00017e70: 726f 6d61 7272 6179 2879 726f 7461 7465  romarray(yrotate
+00017e80: 292e 7265 7369 7a65 2828 3330 302c 2033  ).resize((300, 3
+00017e90: 3030 2929 0a20 2020 2020 2020 2020 2020  00)).           
+00017ea0: 2020 2020 2020 2020 2023 2069 6d79 2e73           # imy.s
+00017eb0: 6176 6528 7973 6361 6c65 6e61 6d65 290a  ave(yscalename).
+00017ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017ed0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00017ee0: 2020 2020 2020 2020 2020 6966 2077 6964            if wid
+00017ef0: 7468 203e 3d20 6865 6967 6874 3a0a 2020  th >= height:.  
+00017f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017f10: 2020 2020 2020 7363 616c 6572 203d 2033        scaler = 3
+00017f20: 3030 2e20 2f20 7769 6474 680a 2020 2020  00. / width.    
+00017f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017f40: 2020 2020 6e65 7768 6569 6768 7420 3d20      newheight = 
+00017f50: 696e 7428 6365 696c 2873 6361 6c65 7220  int(ceil(scaler 
+00017f60: 2a20 6865 6967 6874 2929 0a20 2020 2020  * height)).     
+00017f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017f80: 2020 2069 6d79 203d 2049 6d61 6765 2e66     imy = Image.f
+00017f90: 726f 6d61 7272 6179 2879 726f 7461 7465  romarray(yrotate
+00017fa0: 292e 7265 7369 7a65 2828 3330 302c 206e  ).resize((300, n
+00017fb0: 6577 6865 6967 6874 292c 2049 6d61 6765  ewheight), Image
+00017fc0: 2e41 4e54 4941 4c49 4153 290a 2020 2020  .ANTIALIAS).    
+00017fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017fe0: 2020 2020 696d 792e 7361 7665 2879 7363      imy.save(ysc
+00017ff0: 616c 656e 616d 6529 0a20 2020 2020 2020  alename).       
+00018000: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+00018010: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00018020: 2020 2020 2020 2020 2020 2073 6361 6c65             scale
+00018030: 7220 3d20 3330 302e 202f 2068 6569 6768  r = 300. / heigh
+00018040: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
+00018050: 2020 2020 2020 2020 2020 6e65 7777 6964            newwid
+00018060: 7468 203d 2069 6e74 2863 6569 6c28 7363  th = int(ceil(sc
+00018070: 616c 6572 202a 2077 6964 7468 2929 0a20  aler * width)). 
+00018080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018090: 2020 2020 2020 2069 6d79 203d 2049 6d61         imy = Ima
+000180a0: 6765 2e66 726f 6d61 7272 6179 2879 726f  ge.fromarray(yro
+000180b0: 7461 7465 292e 7265 7369 7a65 2828 6e65  tate).resize((ne
+000180c0: 7777 6964 7468 2c20 3330 3029 2c20 496d  wwidth, 300), Im
+000180d0: 6167 652e 414e 5449 414c 4941 5329 0a20  age.ANTIALIAS). 
+000180e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000180f0: 2020 2020 2020 2069 6d79 2e73 6176 6528         imy.save(
+00018100: 7973 6361 6c65 6e61 6d65 290a 2020 2020  yscalename).    
+00018110: 2020 2020 2020 2020 6578 6365 7074 3a0a          except:.
+00018120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018130: 7965 7272 203d 2027 5361 7669 6e67 2073  yerr = 'Saving s
+00018140: 6361 6c65 6420 7920 6365 6e74 7261 6c20  caled y central 
+00018150: 736c 6963 6520 6f66 206d 6173 6b20 6572  slice of mask er
+00018160: 723a 7b7d 272e 666f 726d 6174 2873 7973  r:{}'.format(sys
+00018170: 2e65 7863 5f69 6e66 6f28 295b 315d 290a  .exc_info()[1]).
+00018180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018190: 6572 726c 6973 742e 6170 7065 6e64 2879  errlist.append(y
+000181a0: 6572 7229 0a20 2020 2020 2020 2020 2020  err).           
+000181b0: 2020 2020 2073 7973 2e73 7464 6572 722e       sys.stderr.
+000181c0: 7772 6974 6528 7965 7272 202b 2027 5c6e  write(yerr + '\n
+000181d0: 2729 0a0a 2020 2020 2020 2020 2020 2020  ')..            
+000181e0: 2320 7a63 656e 7472 616c 203d 206d 6170  # zcentral = map
+000181f0: 2e66 756c 6c4d 6170 5b7a 6d69 642c 203a  .fullMap[zmid, :
+00018200: 2c20 3a5d 0a20 2020 2020 2020 2020 2020  , :].           
+00018210: 207a 6365 6e74 7261 6c20 3d20 6d61 702e   zcentral = map.
+00018220: 6461 7461 5b7a 6d69 642c 203a 2c20 3a5d  data[zmid, :, :]
+00018230: 0a20 2020 2020 2020 2020 2020 207a 6465  .            zde
+00018240: 6e6f 6d20 3d20 287a 6365 6e74 7261 6c2e  nom = (zcentral.
+00018250: 6d61 7828 2920 2d20 7a63 656e 7472 616c  max() - zcentral
+00018260: 2e6d 696e 2829 2920 6966 207a 6365 6e74  .min()) if zcent
+00018270: 7261 6c2e 6d61 7828 2920 213d 207a 6365  ral.max() != zce
+00018280: 6e74 7261 6c2e 6d69 6e28 2920 656c 7365  ntral.min() else
+00018290: 2031 0a20 2020 2020 2020 2020 2020 207a   1.            z
+000182a0: 7265 7363 616c 6564 203d 2028 2828 7a63  rescaled = (((zc
+000182b0: 656e 7472 616c 202d 207a 6365 6e74 7261  entral - zcentra
+000182c0: 6c2e 6d69 6e28 2929 202a 2032 3535 2e30  l.min()) * 255.0
+000182d0: 2920 2f20 7a64 656e 6f6d 292e 6173 7479  ) / zdenom).asty
+000182e0: 7065 2827 7569 6e74 3827 290a 2020 2020  pe('uint8').    
+000182f0: 2020 2020 2020 2020 7a66 6c69 7070 6564          zflipped
+00018300: 203d 206e 702e 666c 6970 7564 287a 7265   = np.flipud(zre
+00018310: 7363 616c 6564 290a 2020 2020 2020 2020  scaled).        
+00018320: 2020 2020 7a69 6d67 203d 2049 6d61 6765      zimg = Image
+00018330: 2e66 726f 6d61 7272 6179 287a 666c 6970  .fromarray(zflip
+00018340: 7065 6429 0a20 2020 2020 2020 2020 2020  ped).           
+00018350: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+00018360: 2020 2020 2020 7a69 6d67 2e73 6176 6528        zimg.save(
+00018370: 7365 6c66 2e77 6f72 6b64 6972 202b 206d  self.workdir + m
+00018380: 6170 6e61 6d65 202b 2027 5f7a 6d61 736b  apname + '_zmask
+00018390: 6365 6e74 7261 6c5f 736c 6963 652e 6a70  central_slice.jp
+000183a0: 6567 2729 0a20 2020 2020 2020 2020 2020  eg').           
+000183b0: 2065 7863 6570 7420 494f 4572 726f 7220   except IOError 
+000183c0: 6173 2069 6f65 7272 3a0a 2020 2020 2020  as ioerr:.      
+000183d0: 2020 2020 2020 2020 2020 7a65 7272 203d            zerr =
+000183e0: 2027 5361 7669 6e67 206f 7269 6769 6e61   'Saving origina
+000183f0: 6c20 7a20 6365 6e74 7261 6c20 736c 6963  l z central slic
+00018400: 6520 6f66 206d 6173 6b20 6572 723a 7b7d  e of mask err:{}
+00018410: 272e 666f 726d 6174 2869 6f65 7272 290a  '.format(ioerr).
+00018420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018430: 6572 726c 6973 742e 6170 7065 6e64 287a  errlist.append(z
+00018440: 6572 7229 0a20 2020 2020 2020 2020 2020  err).           
+00018450: 2020 2020 2073 7973 2e73 7464 6572 722e       sys.stderr.
+00018460: 7772 6974 6528 7a65 7272 202b 2027 5c6e  write(zerr + '\n
+00018470: 2729 0a0a 2020 2020 2020 2020 2020 2020  ')..            
+00018480: 7769 6474 682c 2068 6569 6768 7420 3d20  width, height = 
+00018490: 7a69 6d67 2e73 697a 650a 2020 2020 2020  zimg.size.      
+000184a0: 2020 2020 2020 7a73 6361 6c65 6e61 6d65        zscalename
+000184b0: 203d 2073 656c 662e 776f 726b 6469 7220   = self.workdir 
+000184c0: 2b20 6d61 706e 616d 6520 2b20 275f 7363  + mapname + '_sc
+000184d0: 616c 6564 5f7a 6d61 736b 6365 6e74 7261  aled_zmaskcentra
+000184e0: 6c5f 736c 6963 652e 6a70 6567 270a 2020  l_slice.jpeg'.  
+000184f0: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+00018500: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00018510: 6620 7769 6474 6820 3e20 3330 3020 616e  f width > 300 an
+00018520: 6420 6865 6967 6874 203e 2033 3030 3a0a  d height > 300:.
+00018530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018540: 2020 2020 6966 2077 6964 7468 203e 3d20      if width >= 
+00018550: 6865 6967 6874 3a0a 2020 2020 2020 2020  height:.        
+00018560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018570: 6c61 7267 6572 7363 616c 6572 203d 2033  largerscaler = 3
+00018580: 3030 2e20 2f20 7769 6474 680a 2020 2020  00. / width.    
+00018590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000185a0: 2020 2020 6e65 7768 6569 6768 7420 3d20      newheight = 
+000185b0: 696e 7428 6365 696c 286c 6172 6765 7273  int(ceil(largers
+000185c0: 6361 6c65 7220 2a20 6865 6967 6874 2929  caler * height))
+000185d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000185e0: 2020 2020 2020 2020 2069 6d7a 203d 2049           imz = I
+000185f0: 6d61 6765 2e66 726f 6d61 7272 6179 287a  mage.fromarray(z
+00018600: 666c 6970 7065 6429 2e72 6573 697a 6528  flipped).resize(
+00018610: 2833 3030 2c20 6e65 7768 6569 6768 7429  (300, newheight)
+00018620: 2c20 496d 6167 652e 414e 5449 414c 4941  , Image.ANTIALIA
+00018630: 5329 0a20 2020 2020 2020 2020 2020 2020  S).             
+00018640: 2020 2020 2020 2020 2020 2069 6d7a 2e73             imz.s
+00018650: 6176 6528 7a73 6361 6c65 6e61 6d65 290a  ave(zscalename).
+00018660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018670: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00018680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018690: 2020 6c61 7267 6572 7363 616c 6572 203d    largerscaler =
+000186a0: 2033 3030 2e20 2f20 6865 6967 6874 0a20   300. / height. 
+000186b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000186c0: 2020 2020 2020 206e 6577 7769 6474 6820         newwidth 
+000186d0: 3d20 696e 7428 6365 696c 286c 6172 6765  = int(ceil(large
+000186e0: 7273 6361 6c65 7220 2a20 7769 6474 6829  rscaler * width)
+000186f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00018700: 2020 2020 2020 2020 2020 696d 7a20 3d20            imz = 
+00018710: 496d 6167 652e 6672 6f6d 6172 7261 7928  Image.fromarray(
+00018720: 7a66 6c69 7070 6564 292e 7265 7369 7a65  zflipped).resize
+00018730: 2828 6e65 7777 6964 7468 2c20 3330 3029  ((newwidth, 300)
+00018740: 2c20 496d 6167 652e 414e 5449 414c 4941  , Image.ANTIALIA
+00018750: 5329 0a20 2020 2020 2020 2020 2020 2020  S).             
+00018760: 2020 2020 2020 2020 2020 2069 6d7a 2e73             imz.s
+00018770: 6176 6528 7a73 6361 6c65 6e61 6d65 290a  ave(zscalename).
+00018780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018790: 2020 2020 2320 696d 7a20 3d20 496d 6167      # imz = Imag
+000187a0: 652e 6672 6f6d 6172 7261 7928 7a66 6c69  e.fromarray(zfli
+000187b0: 7070 6564 292e 7265 7369 7a65 2828 3330  pped).resize((30
+000187c0: 302c 2033 3030 2929 0a20 2020 2020 2020  0, 300)).       
+000187d0: 2020 2020 2020 2020 2020 2020 2023 2069               # i
+000187e0: 6d7a 2e73 6176 6528 7a73 6361 6c65 6e61  mz.save(zscalena
+000187f0: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
+00018800: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00018810: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00018820: 2077 6964 7468 203e 3d20 6865 6967 6874   width >= height
+00018830: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00018840: 2020 2020 2020 2020 2020 7363 616c 6572            scaler
+00018850: 203d 2033 3030 2e20 2f20 7769 6474 680a   = 300. / width.
+00018860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018870: 2020 2020 2020 2020 6e65 7768 6569 6768          newheigh
+00018880: 7420 3d20 696e 7428 6365 696c 2873 6361  t = int(ceil(sca
+00018890: 6c65 7220 2a20 6865 6967 6874 2929 0a20  ler * height)). 
+000188a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000188b0: 2020 2020 2020 2069 6d7a 203d 2049 6d61         imz = Ima
+000188c0: 6765 2e66 726f 6d61 7272 6179 287a 666c  ge.fromarray(zfl
+000188d0: 6970 7065 6429 2e72 6573 697a 6528 2833  ipped).resize((3
+000188e0: 3030 2c20 6e65 7768 6569 6768 7429 2c20  00, newheight), 
+000188f0: 496d 6167 652e 414e 5449 414c 4941 5329  Image.ANTIALIAS)
+00018900: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018910: 2020 2020 2020 2020 2069 6d7a 2e73 6176           imz.sav
+00018920: 6528 7a73 6361 6c65 6e61 6d65 290a 2020  e(zscalename).  
+00018930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018940: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00018950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018960: 7363 616c 6572 203d 2033 3030 2e20 2f20  scaler = 300. / 
+00018970: 6865 6967 6874 0a20 2020 2020 2020 2020  height.         
+00018980: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00018990: 6577 7769 6474 6820 3d20 696e 7428 6365  ewwidth = int(ce
+000189a0: 696c 2873 6361 6c65 7220 2a20 7769 6474  il(scaler * widt
+000189b0: 6829 290a 2020 2020 2020 2020 2020 2020  h)).            
+000189c0: 2020 2020 2020 2020 2020 2020 696d 7a20              imz 
+000189d0: 3d20 496d 6167 652e 6672 6f6d 6172 7261  = Image.fromarra
+000189e0: 7928 7a66 6c69 7070 6564 292e 7265 7369  y(zflipped).resi
+000189f0: 7a65 2828 6e65 7777 6964 7468 2c20 3330  ze((newwidth, 30
+00018a00: 3029 2c20 496d 6167 652e 414e 5449 414c  0), Image.ANTIAL
+00018a10: 4941 5329 0a20 2020 2020 2020 2020 2020  IAS).           
+00018a20: 2020 2020 2020 2020 2020 2020 2069 6d7a               imz
+00018a30: 2e73 6176 6528 7a73 6361 6c65 6e61 6d65  .save(zscalename
+00018a40: 290a 2020 2020 2020 2020 2020 2020 6578  ).            ex
+00018a50: 6365 7074 3a0a 2020 2020 2020 2020 2020  cept:.          
+00018a60: 2020 2020 2020 7a65 7272 203d 2027 5361        zerr = 'Sa
+00018a70: 7669 6e67 206f 7269 6769 6e61 6c20 7a20  ving original z 
+00018a80: 7363 616c 6564 2063 656e 7472 616c 2073  scaled central s
+00018a90: 6c69 6365 206f 6620 6d61 736b 2065 7272  lice of mask err
+00018aa0: 3a7b 7d27 2e66 6f72 6d61 7428 7379 732e  :{}'.format(sys.
+00018ab0: 6578 635f 696e 666f 2829 5b31 5d29 0a20  exc_info()[1]). 
+00018ac0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00018ad0: 7272 6c69 7374 2e61 7070 656e 6428 7a65  rrlist.append(ze
+00018ae0: 7272 290a 2020 2020 2020 2020 2020 2020  rr).            
+00018af0: 2020 2020 7379 732e 7374 6465 7272 2e77      sys.stderr.w
+00018b00: 7269 7465 287a 6572 7220 2b20 275c 6e27  rite(zerr + '\n'
+00018b10: 290a 0a20 2020 2020 2020 2020 2020 2063  )..            c
+00018b20: 736c 6963 656a 736f 6e20 3d20 6469 6374  slicejson = dict
+00018b30: 2829 0a20 2020 2020 2020 2020 2020 2063  ().            c
+00018b40: 736c 6963 656a 736f 6e5b 2778 275d 203d  slicejson['x'] =
+00018b50: 206f 732e 7061 7468 2e62 6173 656e 616d   os.path.basenam
+00018b60: 6528 7873 6361 6c65 6e61 6d65 2920 6966  e(xscalename) if
+00018b70: 206f 732e 7061 7468 2e69 7366 696c 6528   os.path.isfile(
+00018b80: 7873 6361 6c65 6e61 6d65 2920 656c 7365  xscalename) else
+00018b90: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
+00018ba0: 2020 6373 6c69 6365 6a73 6f6e 5b27 7927    cslicejson['y'
+00018bb0: 5d20 3d20 6f73 2e70 6174 682e 6261 7365  ] = os.path.base
+00018bc0: 6e61 6d65 2879 7363 616c 656e 616d 6529  name(yscalename)
+00018bd0: 2069 6620 6f73 2e70 6174 682e 6973 6669   if os.path.isfi
+00018be0: 6c65 2879 7363 616c 656e 616d 6529 2065  le(yscalename) e
+00018bf0: 6c73 6520 4e6f 6e65 0a20 2020 2020 2020  lse None.       
+00018c00: 2020 2020 2063 736c 6963 656a 736f 6e5b       cslicejson[
+00018c10: 277a 275d 203d 206f 732e 7061 7468 2e62  'z'] = os.path.b
+00018c20: 6173 656e 616d 6528 7a73 6361 6c65 6e61  asename(zscalena
+00018c30: 6d65 2920 6966 206f 732e 7061 7468 2e69  me) if os.path.i
+00018c40: 7366 696c 6528 7a73 6361 6c65 6e61 6d65  sfile(zscalename
+00018c50: 2920 656c 7365 204e 6f6e 650a 0a20 2020  ) else None..   
+00018c60: 2020 2020 2020 2020 2061 6c6c 6d61 736b           allmask
+00018c70: 6469 6374 5b6d 6170 6e61 6d65 5d20 3d20  dict[mapname] = 
+00018c80: 6373 6c69 6365 6a73 6f6e 0a0a 2020 2020  cslicejson..    
+00018c90: 2020 2020 6966 2065 7272 6c69 7374 3a0a      if errlist:.
+00018ca0: 2020 2020 2020 2020 2020 2020 616c 6c6d              allm
+00018cb0: 6173 6b64 6963 745b 2765 7272 275d 203d  askdict['err'] =
+00018cc0: 207b 276d 6173 6b5f 6365 6e74 7261 6c5f   {'mask_central_
+00018cd0: 736c 6963 655f 6572 7227 3a20 6572 726c  slice_err': errl
+00018ce0: 6973 747d 0a20 2020 2020 2020 2066 696e  ist}.        fin
+00018cf0: 616c 6469 6374 203d 207b 276d 6173 6b5f  aldict = {'mask_
+00018d00: 6365 6e74 7261 6c5f 736c 6963 6527 3a20  central_slice': 
+00018d10: 616c 6c6d 6173 6b64 6963 747d 0a0a 2020  allmaskdict}..  
+00018d20: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00018d30: 2020 2020 2020 2077 6974 6820 636f 6465         with code
+00018d40: 6373 2e6f 7065 6e28 7365 6c66 2e77 6f72  cs.open(self.wor
+00018d50: 6b64 6972 202b 2073 656c 662e 6d61 706e  kdir + self.mapn
+00018d60: 616d 6520 2b20 275f 6d61 736b 6365 6e74  ame + '_maskcent
+00018d70: 7261 6c73 6c69 6365 2e6a 736f 6e27 2c20  ralslice.json', 
+00018d80: 2777 272c 0a20 2020 2020 2020 2020 2020  'w',.           
+00018d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018da0: 2020 656e 636f 6469 6e67 3d27 7574 662d    encoding='utf-
+00018db0: 3827 2920 6173 2066 3a0a 2020 2020 2020  8') as f:.      
+00018dc0: 2020 2020 2020 2020 2020 6a73 6f6e 2e64            json.d
+00018dd0: 756d 7028 6669 6e61 6c64 6963 742c 2066  ump(finaldict, f
+00018de0: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
+00018df0: 2049 4f45 7272 6f72 2061 7320 696f 6572   IOError as ioer
+00018e00: 723a 0a20 2020 2020 2020 2020 2020 2070  r:.            p
+00018e10: 7269 6e74 2827 5361 7669 6e67 206d 6173  rint('Saving mas
+00018e20: 6b73 2063 656e 7472 616c 2073 6c69 6365  ks central slice
+00018e30: 7320 746f 206a 736f 6e20 6572 723a 207b  s to json err: {
+00018e40: 7d27 2e66 6f72 6d61 7428 696f 6572 7229  }'.format(ioerr)
+00018e50: 290a 0a20 2020 2020 2020 2065 6e64 203d  )..        end =
+00018e60: 2074 696d 6569 742e 6465 6661 756c 745f   timeit.default_
+00018e70: 7469 6d65 7228 290a 2020 2020 2020 2020  timer().        
+00018e80: 7072 696e 7428 274d 616b 7343 656e 7472  print('MaksCentr
+00018e90: 616c 536c 6963 6520 7469 6d65 3a20 2573  alSlice time: %s
+00018ea0: 2720 2520 2865 6e64 202d 2073 7461 7274  ' % (end - start
+00018eb0: 2929 0a20 2020 2020 2020 2070 7269 6e74  )).        print
+00018ec0: 2827 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ('--------------
+00018ed0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00018ee0: 2d2d 2d2d 2d2d 2729 0a0a 2020 2020 2020  ------')..      
+00018ef0: 2020 7265 7475 726e 204e 6f6e 650a 0a20    return None.. 
+00018f00: 2020 2064 6566 2063 6865 636b 7674 7028     def checkvtp(
+00018f10: 7365 6c66 293a 0a20 2020 2020 2020 2022  self):.        "
+00018f20: 2222 0a0a 2020 2020 2020 2020 2020 2020  ""..            
+00018f30: 4368 6563 6b20 6966 2074 6865 7265 2069  Check if there i
+00018f40: 7320 6120 7674 7020 6669 6c65 2065 7869  s a vtp file exi
+00018f50: 7374 206f 7220 6e6f 740a 0a20 2020 2020  st or not..     
+00018f60: 2020 203a 7265 7475 726e 3a0a 2020 2020     :return:.    
+00018f70: 2020 2020 2222 220a 0a0a 2020 2020 2020      """...      
+00018f80: 2020 7674 7072 6567 203d 2073 656c 662e    vtpreg = self.
+00018f90: 776f 726b 6469 7220 2b20 272a 2e76 7470  workdir + '*.vtp
+00018fa0: 270a 2020 2020 2020 2020 676c 6f62 7265  '.        globre
+00018fb0: 7375 6c74 203d 2067 6c6f 622e 676c 6f62  sult = glob.glob
+00018fc0: 2876 7470 7265 6729 0a20 2020 2020 2020  (vtpreg).       
+00018fd0: 2076 7470 6e61 6d65 203d 2027 7b7d 7b7d   vtpname = '{}{}
+00018fe0: 5f7b 7d2e 7674 7027 2e66 6f72 6d61 7428  _{}.vtp'.format(
+00018ff0: 7365 6c66 2e77 6f72 6b64 6972 2c20 7365  self.workdir, se
+00019000: 6c66 2e6d 6170 6e61 6d65 2c20 7365 6c66  lf.mapname, self
+00019010: 2e63 6c29 0a20 2020 2020 2020 2069 6620  .cl).        if 
+00019020: 7674 706e 616d 6520 696e 2067 6c6f 6272  vtpname in globr
+00019030: 6573 756c 743a 0a20 2020 2020 2020 2020  esult:.         
+00019040: 2020 2076 7470 6675 6c6c 6e61 6d65 203d     vtpfullname =
+00019050: 2076 7470 6e61 6d65 0a20 2020 2020 2020   vtpname.       
+00019060: 2020 2020 2070 7269 6e74 2827 2573 2065       print('%s e
+00019070: 7869 7374 2061 6c72 6561 6479 2e27 2025  xist already.' %
+00019080: 2076 7470 6e61 6d65 290a 2020 2020 2020   vtpname).      
+00019090: 2020 2020 2020 7265 7475 726e 2076 7470        return vtp
+000190a0: 6675 6c6c 6e61 6d65 0a20 2020 2020 2020  fullname.       
+000190b0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000190c0: 2020 2069 6620 676c 6f62 7265 7375 6c74     if globresult
+000190d0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+000190e0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+000190f0: 696e 7428 2776 7470 2066 696c 653a 2025  int('vtp file: %
+00019100: 7320 6578 6973 742c 2070 6c65 6173 6520  s exist, please 
+00019110: 6368 6563 6b2e 2720 2520 676c 6f62 7265  check.' % globre
+00019120: 7375 6c74 290a 2020 2020 2020 2020 2020  sult).          
+00019130: 2020 7265 7475 726e 204e 6f6e 650a 0a20    return None.. 
+00019140: 2020 2064 6566 2067 656e 7674 7028 7365     def genvtp(se
+00019150: 6c66 2c20 6675 6c6c 6d61 7070 6174 6829  lf, fullmappath)
+00019160: 3a0a 2020 2020 2020 2020 2222 220a 0a20  :.        """.. 
+00019170: 2020 2020 2020 2020 2020 2047 656e 6572             Gener
+00019180: 6174 6520 7674 7020 6669 6c65 2066 6f72  ate vtp file for
+00019190: 206e 6f6e 2d73 6572 7665 7220 696e 7075   non-server inpu
+000191a0: 740a 0a20 2020 2020 2020 203a 7061 7261  t..        :para
+000191b0: 6d20 6675 6c6c 6d61 7070 6174 683a 0a20  m fullmappath:. 
+000191c0: 2020 2020 2020 203a 7265 7475 726e 3a0a         :return:.
+000191d0: 2020 2020 2020 2020 2222 220a 0a20 2020          """..   
+000191e0: 2020 2020 206d 6573 686d 616b 6572 203d       meshmaker =
+000191f0: 2046 616c 7365 0a20 2020 2020 2020 2069   False.        i
+00019200: 6620 4d45 5348 4d41 4b45 5250 4154 4820  f MESHMAKERPATH 
+00019210: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00019220: 2020 2020 2020 2020 206d 6573 686d 616b           meshmak
+00019230: 6572 203d 2054 7275 650a 2020 2020 2020  er = True.      
+00019240: 2020 2020 2020 6d65 7368 6d61 6b65 7270        meshmakerp
+00019250: 6174 6820 3d20 4d45 5348 4d41 4b45 5250  ath = MESHMAKERP
+00019260: 4154 480a 2020 2020 2020 2020 656c 7365  ATH.        else
+00019270: 3a0a 2020 2020 2020 2020 2020 2020 7472  :.            tr
+00019280: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00019290: 2020 2061 7373 6572 7420 6669 6e64 5f65     assert find_e
+000192a0: 7865 6375 7461 626c 6528 276d 6573 686d  xecutable('meshm
+000192b0: 616b 6572 2729 2069 7320 6e6f 7420 4e6f  aker') is not No
+000192c0: 6e65 0a20 2020 2020 2020 2020 2020 2020  ne.             
+000192d0: 2020 206d 6573 686d 616b 6572 7061 7468     meshmakerpath
+000192e0: 203d 2066 696e 645f 6578 6563 7574 6162   = find_executab
+000192f0: 6c65 2827 6d65 7368 6d61 6b65 7227 290a  le('meshmaker').
+00019300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019310: 6d65 7368 6d61 6b65 7220 3d20 5472 7565  meshmaker = True
+00019320: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
+00019330: 6570 7420 4173 7365 7274 696f 6e45 7272  ept AssertionErr
+00019340: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
+00019350: 2020 2020 7379 732e 7374 6465 7272 2e77      sys.stderr.w
+00019360: 7269 7465 2827 6d65 7368 6d61 6b65 7220  rite('meshmaker 
+00019370: 6578 6563 7574 6162 6c65 2069 7320 6e6f  executable is no
+00019380: 7420 7468 6572 652e 5c6e 2729 0a0a 2020  t there.\n')..  
+00019390: 2020 2020 2020 6966 206d 6573 686d 616b        if meshmak
+000193a0: 6572 2061 6e64 2073 656c 662e 636c 2069  er and self.cl i
+000193b0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+000193c0: 2020 2020 2020 2020 6f75 7476 7470 6e61          outvtpna
+000193d0: 6d65 203d 2027 7b7d 7b7d 5f7b 7d27 2e66  me = '{}{}_{}'.f
+000193e0: 6f72 6d61 7428 7365 6c66 2e77 6f72 6b64  ormat(self.workd
+000193f0: 6972 2c20 7365 6c66 2e6d 6170 6e61 6d65  ir, self.mapname
+00019400: 2c20 7365 6c66 2e63 6c29 0a20 2020 2020  , self.cl).     
+00019410: 2020 2020 2020 2063 6d64 203d 206d 6573         cmd = mes
+00019420: 686d 616b 6572 7061 7468 202b 2027 2027  hmakerpath + ' '
+00019430: 202b 2066 756c 6c6d 6170 7061 7468 202b   + fullmappath +
+00019440: 2027 202d 6320 2720 2b20 7374 7228 7365   ' -c ' + str(se
+00019450: 6c66 2e63 6c29 202b 2027 202d 6f20 2720  lf.cl) + ' -o ' 
+00019460: 2b20 6f75 7476 7470 6e61 6d65 202b 2027  + outvtpname + '
+00019470: 202d 4420 2d76 270a 2020 2020 2020 2020   -D -v'.        
+00019480: 2020 2020 7072 6f63 6573 7320 3d20 7375      process = su
+00019490: 6270 726f 6365 7373 2e50 6f70 656e 2863  bprocess.Popen(c
+000194a0: 6d64 2c20 7368 656c 6c3d 5472 7565 2c20  md, shell=True, 
+000194b0: 6578 6563 7574 6162 6c65 3d27 2f62 696e  executable='/bin
+000194c0: 2f62 6173 6827 290a 2020 2020 2020 2020  /bash').        
+000194d0: 2020 2020 636f 6465 203d 2070 726f 6365      code = proce
+000194e0: 7373 2e77 6169 7428 290a 2020 2020 2020  ss.wait().      
+000194f0: 2020 2020 2020 6966 2063 6f64 6520 3d3d        if code ==
+00019500: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+00019510: 2020 2020 7265 7375 6c74 203d 206f 7574      result = out
+00019520: 7674 706e 616d 6520 2b20 272e 7674 7027  vtpname + '.vtp'
+00019530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019540: 2070 7269 6e74 2827 5072 6f64 7563 6520   print('Produce 
+00019550: 6669 6c65 3a20 2573 2073 7563 6365 7373  file: %s success
+00019560: 6675 6c6c 7927 2025 2072 6573 756c 7429  fully' % result)
+00019570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019580: 2072 6574 7572 6e20 7265 7375 6c74 0a20   return result. 
+00019590: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+000195a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000195b0: 2070 7269 6e74 2827 4d65 7368 6d61 6b65   print('Meshmake
+000195c0: 7220 6469 6420 6e6f 7420 7072 6f64 7563  r did not produc
+000195d0: 6520 7468 6520 7674 7020 6669 6c65 2063  e the vtp file c
+000195e0: 6865 636b 2074 6865 2069 6e70 7574 732e  heck the inputs.
+000195f0: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
+00019600: 2020 2072 6574 7572 6e20 4e6f 6e65 0a20     return None. 
+00019610: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00019620: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
+00019630: 4469 6420 6e6f 7420 6669 6e64 2070 726f  Did not find pro
+00019640: 7065 7220 6d65 7368 6d61 6b65 7220 6f72  per meshmaker or
+00019650: 2074 6865 206e 6f20 636f 6e74 6f75 7220   the no contour 
+00019660: 6c65 7665 6c20 6176 6169 6c61 626c 6520  level available 
+00019670: 2e27 290a 0a20 2020 2040 7374 6174 6963  .')..    @static
+00019680: 6d65 7468 6f64 0a20 2020 2064 6566 2077  method.    def w
+00019690: 7269 7465 5f69 6d61 6765 2869 6d61 6765  rite_image(image
+000196a0: 4669 6c65 2c20 7265 6e57 696e 293a 0a20  File, renWin):. 
+000196b0: 2020 2020 2020 2023 2057 7269 7465 2074         # Write t
+000196c0: 6865 2063 7572 7265 6e74 2076 6965 7720  he current view 
+000196d0: 6f66 2074 6865 2072 656e 6465 7265 7220  of the renderer 
+000196e0: 746f 2061 6e20 696d 6167 650a 2020 2020  to an image.    
+000196f0: 2020 2020 6966 2069 6d61 6765 4669 6c65      if imageFile
+00019700: 3a0a 2020 2020 2020 2020 2020 2020 7772  :.            wr
+00019710: 6974 6572 203d 2076 746b 2e76 746b 424d  iter = vtk.vtkBM
+00019720: 5057 7269 7465 7228 290a 2020 2020 2020  PWriter().      
+00019730: 2020 2020 2020 7769 6e64 6f77 746f 5f69        windowto_i
+00019740: 6d61 6765 5f66 696c 7465 7220 3d20 7674  mage_filter = vt
+00019750: 6b2e 7674 6b57 696e 646f 7754 6f49 6d61  k.vtkWindowToIma
+00019760: 6765 4669 6c74 6572 2829 0a20 2020 2020  geFilter().     
+00019770: 2020 2020 2020 2077 696e 646f 7774 6f5f         windowto_
+00019780: 696d 6167 655f 6669 6c74 6572 2e53 6574  image_filter.Set
+00019790: 496e 7075 7428 7265 6e57 696e 290a 2020  Input(renWin).  
+000197a0: 2020 2020 2020 2020 2020 2320 696d 6167            # imag
+000197b0: 6520 7175 616c 6974 790a 2020 2020 2020  e quality.      
+000197c0: 2020 2020 2020 7769 6e64 6f77 746f 5f69        windowto_i
+000197d0: 6d61 6765 5f66 696c 7465 722e 5365 7449  mage_filter.SetI
+000197e0: 6e70 7574 4275 6666 6572 5479 7065 546f  nputBufferTypeTo
+000197f0: 5247 4228 290a 0a20 2020 2020 2020 2020  RGB()..         
+00019800: 2020 2077 7269 7465 722e 5365 7446 696c     writer.SetFil
+00019810: 654e 616d 6528 696d 6167 6546 696c 6529  eName(imageFile)
+00019820: 0a20 2020 2020 2020 2020 2020 2077 7269  .            wri
+00019830: 7465 722e 5365 7449 6e70 7574 436f 6e6e  ter.SetInputConn
+00019840: 6563 7469 6f6e 2877 696e 646f 7774 6f5f  ection(windowto_
+00019850: 696d 6167 655f 6669 6c74 6572 2e47 6574  image_filter.Get
+00019860: 4f75 7470 7574 506f 7274 2829 290a 2020  OutputPort()).  
+00019870: 2020 2020 2020 2020 2020 7772 6974 6572            writer
+00019880: 2e57 7269 7465 2829 0a20 2020 2020 2020  .Write().       
+00019890: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000198a0: 2020 2072 6169 7365 2052 756e 7469 6d65     raise Runtime
+000198b0: 4572 726f 7228 274e 6565 6420 6120 6669  Error('Need a fi
+000198c0: 6c65 6e61 6d65 2e27 290a 0a20 2020 2023  lename.')..    #
+000198d0: 2052 6177 6d61 7020 7375 7266 6163 6520   Rawmap surface 
+000198e0: 7669 6577 2077 6865 6e20 7477 6f20 6861  view when two ha
+000198f0: 6c66 206d 6170 7320 6172 6520 6769 7665  lf maps are give
+00019900: 6e0a 2020 2020 6465 6620 7261 776d 6170  n.    def rawmap
+00019910: 636c 2873 656c 6629 3a0a 2020 2020 2020  cl(self):.      
+00019920: 2020 2222 220a 0a20 2020 2020 2020 2020    """..         
+00019930: 2020 2043 616c 6375 6c61 7465 2061 2063     Calculate a c
+00019940: 6f72 7265 7370 6f6e 6469 6e67 2027 7265  orresponding 're
+00019950: 636f 6d6d 656e 6465 6420 636f 6e74 6f75  commended contou
+00019960: 7220 6c65 7665 6c27 2062 6173 6564 206f  r level' based o
+00019970: 6e20 7468 6520 7265 636f 6d6d 656e 6465  n the recommende
+00019980: 6420 636f 6e74 6f75 7220 6c65 7665 6c0a  d contour level.
+00019990: 2020 2020 2020 2020 2020 2020 2868 6176              (hav
+000199a0: 6520 7472 6965 6420 6d61 7463 6869 6e67  e tried matching
+000199b0: 2074 6865 2076 616c 7565 2073 6361 6c65   the value scale
+000199c0: 2077 6869 6368 2067 6574 2077 6f72 7365   which get worse
+000199d0: 2072 6573 756c 7420 7468 616e 2074 6869   result than thi
+000199e0: 7320 6f6e 6529 0a0a 2020 2020 2020 2020  s one)..        
+000199f0: 3a72 6574 7572 6e3a 2041 2066 6c6f 6174  :return: A float
+00019a00: 2077 6869 6368 2067 6976 6520 7468 6520   which give the 
+00019a10: 636f 6e74 6f75 7220 6c65 7665 6c0a 2020  contour level.  
+00019a20: 2020 2020 2020 2222 220a 0a20 2020 2020        """..     
+00019a30: 2020 2023 206e 756d 766f 7820 3d20 6c65     # numvox = le
+00019a40: 6e28 7365 6c66 2e6d 6170 2e66 756c 6c4d  n(self.map.fullM
+00019a50: 6170 5b73 656c 662e 6d61 702e 6675 6c6c  ap[self.map.full
+00019a60: 4d61 7020 3e3d 2073 656c 662e 636c 5d29  Map >= self.cl])
+00019a70: 0a20 2020 2020 2020 206e 756d 766f 7820  .        numvox 
+00019a80: 3d20 6c65 6e28 7365 6c66 2e6d 6170 2e64  = len(self.map.d
+00019a90: 6174 615b 7365 6c66 2e6d 6170 2e64 6174  ata[self.map.dat
+00019aa0: 6120 3e3d 2073 656c 662e 636c 5d29 0a20  a >= self.cl]). 
+00019ab0: 2020 2020 2020 2072 6177 6d61 7020 3d20         rawmap = 
+00019ac0: 7365 6c66 2e72 6177 6d61 700a 2020 2020  self.rawmap.    
+00019ad0: 2020 2020 2320 7261 7764 6174 6120 3d20      # rawdata = 
+00019ae0: 7261 776d 6170 2e66 756c 6c4d 6170 2e66  rawmap.fullMap.f
+00019af0: 6c61 7474 656e 2829 0a20 2020 2020 2020  latten().       
+00019b00: 2072 6177 6461 7461 203d 2072 6177 6d61   rawdata = rawma
+00019b10: 702e 6461 7461 2e66 6c61 7474 656e 2829  p.data.flatten()
+00019b20: 0a20 2020 2020 2020 2066 6c61 7472 6177  .        flatraw
+00019b30: 203d 2073 6f72 7465 6428 7261 7764 6174   = sorted(rawdat
+00019b40: 6129 5b3a 3a2d 315d 0a20 2020 2020 2020  a)[::-1].       
+00019b50: 2072 6177 636c 203d 2066 6c61 7472 6177   rawcl = flatraw
+00019b60: 5b6e 756d 766f 785d 0a0a 2020 2020 2020  [numvox]..      
+00019b70: 2020 7265 7475 726e 2072 6177 636c 0a0a    return rawcl..
+00019b80: 0a20 2020 2064 6566 2066 696e 6472 6177  .    def findraw
+00019b90: 6d61 7028 7365 6c66 293a 0a0a 2020 2020  map(self):..    
+00019ba0: 2020 2020 6966 2073 656c 662e 656d 6469      if self.emdi
+00019bb0: 643a 0a20 2020 2020 2020 2020 2020 2072  d:.            r
+00019bc0: 6177 6d61 706e 616d 6520 3d20 277b 7d65  awmapname = '{}e
+00019bd0: 6d64 5f7b 7d5f 7261 776d 6170 2e6d 6170  md_{}_rawmap.map
+00019be0: 272e 666f 726d 6174 2873 656c 662e 776f  '.format(self.wo
+00019bf0: 726b 6469 722c 2073 656c 662e 656d 6469  rkdir, self.emdi
+00019c00: 6429 0a20 2020 2020 2020 2065 6c73 653a  d).        else:
+00019c10: 0a20 2020 2020 2020 2020 2020 206f 6464  .            odd
+00019c20: 6e61 6d65 203d 206f 732e 7061 7468 2e62  name = os.path.b
+00019c30: 6173 656e 616d 6528 7365 6c66 2e68 6d6f  asename(self.hmo
+00019c40: 6464 2e66 756c 6c6e 616d 6529 0a20 2020  dd.fullname).   
+00019c50: 2020 2020 2020 2020 2065 7665 6e6e 616d           evennam
+00019c60: 6520 3d20 6f73 2e70 6174 682e 6261 7365  e = os.path.base
+00019c70: 6e61 6d65 2873 656c 662e 686d 6576 656e  name(self.hmeven
+00019c80: 2e66 756c 6c6e 616d 6529 0a20 2020 2020  .fullname).     
+00019c90: 2020 2020 2020 2072 6177 6d61 706e 616d         rawmapnam
+00019ca0: 6520 3d20 277b 7d7b 7d5f 7b7d 5f72 6177  e = '{}{}_{}_raw
+00019cb0: 6d61 702e 6d61 7027 2e66 6f72 6d61 7428  map.map'.format(
+00019cc0: 7365 6c66 2e77 6f72 6b64 6972 2c20 6f64  self.workdir, od
+00019cd0: 646e 616d 652c 2065 7665 6e6e 616d 6529  dname, evenname)
+00019ce0: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+00019cf0: 662e 686d 6f64 6420 6973 206e 6f74 204e  f.hmodd is not N
+00019d00: 6f6e 6520 616e 6420 7365 6c66 2e68 6d65  one and self.hme
+00019d10: 7665 6e20 6973 206e 6f74 204e 6f6e 653a  ven is not None:
+00019d20: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00019d30: 6f73 2e70 6174 682e 6973 6669 6c65 2872  os.path.isfile(r
+00019d40: 6177 6d61 706e 616d 6529 3a0a 2020 2020  awmapname):.    
+00019d50: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00019d60: 726e 2072 6177 6d61 706e 616d 650a 2020  rn rawmapname.  
+00019d70: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00019d80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019d90: 2070 7269 6e74 2827 4261 7365 206f 6e20   print('Base on 
+00019da0: 7468 6520 6861 6c66 206d 6170 732c 2072  the half maps, r
+00019db0: 6177 6d61 7020 6973 206e 6f74 2070 726f  awmap is not pro
+00019dc0: 6475 6365 6421 2127 290a 2020 2020 2020  duced!!').      
+00019dd0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00019de0: 204e 6f6e 650a 2020 2020 2020 2020 656c   None.        el
+00019df0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00019e00: 7265 7475 726e 204e 6f6e 650a 0a0a 2020  return None...  
+00019e10: 2020 6465 6620 7261 776d 6170 7375 7266    def rawmapsurf
+00019e20: 6163 655f 6368 696d 6572 6128 7365 6c66  ace_chimera(self
+00019e30: 2c20 6368 696d 6572 6161 7070 293a 0a20  , chimeraapp):. 
+00019e40: 2020 2020 2020 2022 2222 0a0a 2020 2020         """..    
+00019e50: 2020 2020 2020 2020 4765 6e65 7261 7465          Generate
+00019e60: 2072 6177 6d61 7020 7375 7266 6163 6573   rawmap surfaces
+00019e70: 2069 6620 7477 6f20 6861 6c66 206d 6170   if two half map
+00019e80: 7320 616e 6420 7261 776d 6170 2061 6e64  s and rawmap and
+00019e90: 2072 6177 6d61 7020 636f 6e74 6f75 7220   rawmap contour 
+00019ea0: 6172 6520 7468 6572 650a 0a20 2020 2020  are there..     
+00019eb0: 2020 203a 7061 7261 6d20 6368 696d 6572     :param chimer
+00019ec0: 6161 7070 3a20 6269 6e61 7279 2076 616c  aapp: binary val
+00019ed0: 7565 2074 6f20 6368 6563 6b20 6966 2043  ue to check if C
+00019ee0: 6869 6d65 7261 5820 6973 2074 6865 7265  himeraX is there
+00019ef0: 2070 726f 7065 726c 790a 2020 2020 2020   properly.      
+00019f00: 2020 3a72 6574 7572 6e3a 204e 6f6e 650a    :return: None.
+00019f10: 2020 2020 2020 2020 2222 220a 0a20 2020          """..   
+00019f20: 2020 2020 2023 2072 6177 6d61 7072 6520       # rawmapre 
+00019f30: 3d20 272a 5f72 6177 6d61 702e 6d61 7027  = '*_rawmap.map'
+00019f40: 0a20 2020 2020 2020 2023 2072 6177 6d61  .        # rawma
+00019f50: 706e 616d 6520 3d20 676c 6f62 2e67 6c6f  pname = glob.glo
+00019f60: 6228 7365 6c66 2e77 6f72 6b64 6972 202b  b(self.workdir +
+00019f70: 2072 6177 6d61 7072 6529 0a20 2020 2020   rawmapre).     
+00019f80: 2020 2069 6620 7365 6c66 2e68 6d6f 6464     if self.hmodd
+00019f90: 2069 7320 6e6f 7420 4e6f 6e65 2061 6e64   is not None and
+00019fa0: 2073 656c 662e 686d 6576 656e 2069 7320   self.hmeven is 
+00019fb0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+00019fc0: 2020 2020 2020 7261 776d 6170 6e61 6d65        rawmapname
+00019fd0: 203d 2073 656c 662e 6669 6e64 7261 776d   = self.findrawm
+00019fe0: 6170 2829 0a20 2020 2020 2020 2065 6c73  ap().        els
+00019ff0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+0001a000: 6177 6d61 706e 616d 6520 3d20 4e6f 6e65  awmapname = None
+0001a010: 0a0a 2020 2020 2020 2020 6269 6e64 6973  ..        bindis
+0001a020: 706c 6179 203d 206f 732e 6765 7465 6e76  play = os.getenv
+0001a030: 2827 4449 5350 4c41 5927 290a 0a20 2020  ('DISPLAY')..   
+0001a040: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0001a050: 2020 2020 2020 7261 776d 6170 636c 203d        rawmapcl =
+0001a060: 2073 656c 662e 7261 776d 6170 636c 2829   self.rawmapcl()
+0001a070: 0a20 2020 2020 2020 2065 7863 6570 743a  .        except:
+0001a080: 0a20 2020 2020 2020 2020 2020 2072 6177  .            raw
+0001a090: 6d61 7063 6c20 3d20 4e6f 6e65 0a20 2020  mapcl = None.   
+0001a0a0: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
+0001a0b0: 5072 6f62 6c65 6d20 7769 7468 2072 6177  Problem with raw
+0001a0c0: 206d 6170 2063 6f6e 746f 7572 206c 6576   map contour lev
+0001a0d0: 656c 2063 616c 6375 6c61 7469 6f6e 2729  el calculation')
+0001a0e0: 0a0a 2020 2020 2020 2020 6966 2028 7365  ..        if (se
+0001a0f0: 6c66 2e68 6d6f 6464 2069 7320 6e6f 7420  lf.hmodd is not 
+0001a100: 4e6f 6e65 2061 6e64 2073 656c 662e 686d  None and self.hm
+0001a110: 6576 656e 2069 7320 6e6f 7420 4e6f 6e65  even is not None
+0001a120: 2920 616e 6420 7261 776d 6170 6e61 6d65  ) and rawmapname
+0001a130: 2061 6e64 2072 6177 6d61 7063 6c20 6973   and rawmapcl is
+0001a140: 206e 6f74 204e 6f6e 653a 0a0a 2020 2020   not None:..    
+0001a150: 2020 2020 2020 2020 7374 6172 7420 3d20          start = 
+0001a160: 7469 6d65 6974 2e64 6566 6175 6c74 5f74  timeit.default_t
+0001a170: 696d 6572 2829 0a20 2020 2020 2020 2020  imer().         
+0001a180: 2020 2065 7272 6c69 7374 203d 205b 5d0a     errlist = [].
+0001a190: 0a20 2020 2020 2020 2020 2020 206d 6170  .            map
+0001a1a0: 6e61 6d65 203d 206f 732e 7061 7468 2e62  name = os.path.b
+0001a1b0: 6173 656e 616d 6528 7261 776d 6170 6e61  asename(rawmapna
+0001a1c0: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
+0001a1d0: 6c6f 6343 4849 4d45 5241 203d 2063 6869  locCHIMERA = chi
+0001a1e0: 6d65 7261 6170 700a 2020 2020 2020 2020  meraapp.        
+0001a1f0: 2020 2020 2320 7261 776d 6170 2073 7572      # rawmap sur
+0001a200: 6661 6365 2076 6965 7720 616c 6f6e 650a  face view alone.
+0001a210: 2020 2020 2020 2020 2020 2020 7261 776d              rawm
+0001a220: 6170 6368 696d 6572 6163 6d64 203d 2072  apchimeracmd = r
+0001a230: 6177 6d61 706e 616d 6520 2b20 275f 6368  awmapname + '_ch
+0001a240: 696d 6572 612e 6378 6327 0a20 2020 2020  imera.cxc'.     
+0001a250: 2020 2020 2020 2061 7373 656d 626c 6520         assemble 
+0001a260: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
+0001a270: 2020 2020 7769 7468 206f 7065 6e28 7261      with open(ra
+0001a280: 776d 6170 6368 696d 6572 6163 6d64 2c20  wmapchimeracmd, 
+0001a290: 2777 2729 2061 7320 663a 0a20 2020 2020  'w') as f:.     
+0001a2a0: 2020 2020 2020 2020 2020 2066 2e77 7269             f.wri
+0001a2b0: 7465 280a 2020 2020 2020 2020 2020 2020  te(.            
+0001a2c0: 2020 2020 2020 2020 2320 4368 696d 6572          # Chimer
+0001a2d0: 6120 7665 7273 696f 6e0a 2020 2020 2020  a version.      
+0001a2e0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0001a2f0: 276f 7065 6e20 6363 7034 3a27 202b 2073  'open ccp4:' + s
+0001a300: 7472 286d 6170 6e61 6d65 2920 2b20 275c  tr(mapname) + '\
+0001a310: 6e27 0a20 2020 2020 2020 2020 2020 2020  n'.             
+0001a320: 2020 2020 2020 2023 2022 766f 6c75 6d65         # "volume
+0001a330: 2023 3020 7374 796c 6520 7375 7266 6163   #0 style surfac
+0001a340: 6520 6578 7061 6e64 5369 6e67 6c65 506c  e expandSinglePl
+0001a350: 616e 6520 5472 7565 2022 202b 2027 5c6e  ane True " + '\n
+0001a360: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0001a370: 2020 2020 2020 2320 2276 6f6c 756d 6520        # "volume 
+0001a380: 2330 2063 6f6c 6f72 2023 4238 3836 3042  #0 color #B8860B
+0001a390: 2073 7465 7020 3120 2220 2b20 636f 6e74   step 1 " + cont
+0001a3a0: 6f75 7220 2b20 275c 6e27 0a20 2020 2020  our + '\n'.     
+0001a3b0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0001a3c0: 2022 7365 7420 7072 6f6a 6563 7469 6f6e   "set projection
+0001a3d0: 206f 7274 686f 6772 6170 6869 6322 202b   orthographic" +
+0001a3e0: 2027 5c6e 270a 2020 2020 2020 2020 2020   '\n'.          
+0001a3f0: 2020 2020 2020 2020 2020 2320 2273 7572            # "sur
+0001a400: 6674 7261 6e73 7020 3530 2220 2b20 275c  ftransp 50" + '\
+0001a410: 6e27 2020 2320 6d61 6b65 2074 6865 2073  n'  # make the s
+0001a420: 7572 6661 6365 2061 206c 6974 746c 6520  urface a little 
+0001a430: 6269 7420 7365 652d 7468 726f 7567 680a  bit see-through.
+0001a440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a450: 2020 2020 2320 2262 6163 6b67 726f 756e      # "backgroun
+0001a460: 6420 736f 6c69 6420 6c69 6768 7420 6772  d solid light gr
+0001a470: 6179 2220 2b20 275c 6e27 0a20 2020 2020  ay" + '\n'.     
+0001a480: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0001a490: 2022 636f 7079 2066 696c 6520 2220 2b20   "copy file " + 
+0001a4a0: 7374 7228 7365 6c66 2e6d 6170 6e61 6d65  str(self.mapname
+0001a4b0: 2920 2b20 225f 7a73 7572 6661 6365 2e6a  ) + "_zsurface.j
+0001a4c0: 7065 6722 202b 2022 2073 7570 6572 7361  peg" + " supersa
+0001a4d0: 6d70 6c65 2033 2077 6964 7468 2031 3230  mple 3 width 120
+0001a4e0: 3020 6865 6967 6874 2031 3230 3022 202b  0 height 1200" +
+0001a4f0: 2027 5c6e 270a 2020 2020 2020 2020 2020   '\n'.          
+0001a500: 2020 2020 2020 2020 2020 2320 2274 7572            # "tur
+0001a510: 6e20 7820 2d39 3022 202b 2027 5c6e 270a  n x -90" + '\n'.
+0001a520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a530: 2020 2020 2320 2263 656e 7465 7222 202b      # "center" +
+0001a540: 2027 5c6e 270a 2020 2020 2020 2020 2020   '\n'.          
+0001a550: 2020 2020 2020 2020 2020 2320 2263 6f70            # "cop
+0001a560: 7920 6669 6c65 2022 202b 2073 7472 2873  y file " + str(s
+0001a570: 656c 662e 6d61 706e 616d 6529 202b 2022  elf.mapname) + "
+0001a580: 5f78 7375 7266 6163 652e 6a70 6567 2220  _xsurface.jpeg" 
+0001a590: 2b20 2220 7375 7065 7273 616d 706c 6520  + " supersample 
+0001a5a0: 3320 7769 6474 6820 3132 3030 2068 6569  3 width 1200 hei
+0001a5b0: 6768 7420 3132 3030 2220 2b20 275c 6e27  ght 1200" + '\n'
+0001a5c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a5d0: 2020 2020 2023 2022 7475 726e 207a 202d       # "turn z -
+0001a5e0: 3930 2220 2b20 275c 6e27 0a20 2020 2020  90" + '\n'.     
+0001a5f0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0001a600: 2022 6365 6e74 6572 2220 2b20 275c 6e27   "center" + '\n'
+0001a610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a620: 2020 2020 2023 2022 636f 7079 2066 696c       # "copy fil
+0001a630: 6520 2220 2b20 7374 7228 7365 6c66 2e6d  e " + str(self.m
+0001a640: 6170 6e61 6d65 2920 2b20 225f 7973 7572  apname) + "_ysur
+0001a650: 6661 6365 2e6a 7065 6722 202b 2022 2073  face.jpeg" + " s
+0001a660: 7570 6572 7361 6d70 6c65 2033 2077 6964  upersample 3 wid
+0001a670: 7468 2031 3230 3020 6865 6967 6874 2031  th 1200 height 1
+0001a680: 3230 3022 202b 2027 5c6e 270a 2020 2020  200" + '\n'.    
+0001a690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a6a0: 2320 2263 6c6f 7365 2061 6c6c 2220 2b20  # "close all" + 
+0001a6b0: 225c 6e22 0a20 2020 2020 2020 2020 2020  "\n".           
+0001a6c0: 2020 2020 2020 2020 2023 2022 7374 6f70           # "stop
+0001a6d0: 220a 0a20 2020 2020 2020 2020 2020 2020  "..             
+0001a6e0: 2020 2020 2020 2023 2043 6869 6d65 7261         # Chimera
+0001a6f0: 5820 7665 7273 696f 6e0a 2020 2020 2020  X version.      
+0001a700: 2020 2020 2020 2020 2020 2020 2020 226f                "o
+0001a710: 7065 6e20 2220 2b20 7374 7228 7261 776d  pen " + str(rawm
+0001a720: 6170 6e61 6d65 2920 2b20 2220 666f 726d  apname) + " form
+0001a730: 6174 2063 6370 3422 202b 2027 5c6e 270a  at ccp4" + '\n'.
+0001a740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a750: 2020 2020 2276 6f6c 756d 6520 2331 2073      "volume #1 s
+0001a760: 7479 6c65 2073 7572 6661 6365 2065 7870  tyle surface exp
+0001a770: 616e 6453 696e 676c 6550 6c61 6e65 2054  andSinglePlane T
+0001a780: 7275 6522 202b 2027 5c6e 270a 2020 2020  rue" + '\n'.    
+0001a790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a7a0: 2320 2276 6f6c 756d 6520 2331 2063 6f6c  # "volume #1 col
+0001a7b0: 6f72 2023 4238 3836 3042 2073 7465 7020  or #B8860B step 
+0001a7c0: 3120 6c65 7665 6c20 2220 2b20 7374 7228  1 level " + str(
+0001a7d0: 7365 6c66 2e63 6c29 202b 2027 5c6e 270a  self.cl) + '\n'.
+0001a7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a7f0: 2020 2020 2276 6f6c 756d 6520 2331 2073      "volume #1 s
+0001a800: 7465 7020 3120 6c65 7665 6c20 2220 2b20  tep 1 level " + 
+0001a810: 7374 7228 7261 776d 6170 636c 2920 2b20  str(rawmapcl) + 
+0001a820: 275c 6e27 0a20 2020 2020 2020 2020 2020  '\n'.           
+0001a830: 2020 2020 2020 2020 2022 7365 7420 6267           "set bg
+0001a840: 436f 6c6f 7220 7768 6974 6522 202b 2027  Color white" + '
+0001a850: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
+0001a860: 2020 2020 2020 2020 226c 6967 6874 696e          "lightin
+0001a870: 6720 6675 6c6c 205c 6e22 0a20 2020 2020  g full \n".     
+0001a880: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0001a890: 7669 6577 2063 6f66 7220 5472 7565 205c  view cofr True \
+0001a8a0: 6e22 0a20 2020 2020 2020 2020 2020 2020  n".             
+0001a8b0: 2020 2020 2020 2022 7361 7665 2022 202b         "save " +
+0001a8c0: 2073 7472 286d 6170 6e61 6d65 2920 2b20   str(mapname) + 
+0001a8d0: 225f 7a73 7572 6661 6365 2e6a 7065 6722  "_zsurface.jpeg"
+0001a8e0: 202b 2022 2073 7570 6572 7361 6d70 6c65   + " supersample
+0001a8f0: 2033 2077 6964 7468 2031 3230 3020 6865   3 width 1200 he
+0001a900: 6967 6874 2031 3230 3022 202b 2027 5c6e  ight 1200" + '\n
+0001a910: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0001a920: 2020 2020 2020 2274 7572 6e20 7820 2d39        "turn x -9
+0001a930: 3022 202b 2027 5c6e 270a 2020 2020 2020  0" + '\n'.      
+0001a940: 2020 2020 2020 2020 2020 2020 2020 2274                "t
+0001a950: 7572 6e20 7920 2d39 3022 202b 2027 5c6e  urn y -90" + '\n
+0001a960: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0001a970: 2020 2020 2020 2276 6965 7720 636f 6672        "view cofr
+0001a980: 2054 7275 6522 202b 2027 5c6e 270a 2020   True" + '\n'.  
+0001a990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a9a0: 2020 2273 6176 6520 2220 2b20 7374 7228    "save " + str(
+0001a9b0: 6d61 706e 616d 6529 202b 2022 5f78 7375  mapname) + "_xsu
+0001a9c0: 7266 6163 652e 6a70 6567 2220 2b20 2220  rface.jpeg" + " 
+0001a9d0: 7375 7065 7273 616d 706c 6520 3320 7769  supersample 3 wi
+0001a9e0: 6474 6820 3132 3030 2068 6569 6768 7420  dth 1200 height 
+0001a9f0: 3132 3030 2220 2b20 275c 6e27 0a20 2020  1200" + '\n'.   
+0001aa00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aa10: 2022 7669 6577 206f 7269 656e 7422 202b   "view orient" +
+0001aa20: 2027 5c6e 270a 2020 2020 2020 2020 2020   '\n'.          
+0001aa30: 2020 2020 2020 2020 2020 2274 7572 6e20            "turn 
+0001aa40: 7820 3930 2220 2b20 275c 6e27 0a20 2020  x 90" + '\n'.   
+0001aa50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aa60: 2022 7475 726e 207a 2039 3022 202b 2027   "turn z 90" + '
+0001aa70: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
+0001aa80: 2020 2020 2020 2020 2276 6965 7720 636f          "view co
+0001aa90: 6672 2054 7275 6522 202b 2027 5c6e 270a  fr True" + '\n'.
+0001aaa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aab0: 2020 2020 2273 6176 6520 2220 2b20 7374      "save " + st
+0001aac0: 7228 6d61 706e 616d 6529 202b 2022 5f79  r(mapname) + "_y
+0001aad0: 7375 7266 6163 652e 6a70 6567 2220 2b20  surface.jpeg" + 
+0001aae0: 2220 7375 7065 7273 616d 706c 6520 3320  " supersample 3 
+0001aaf0: 7769 6474 6820 3132 3030 2068 6569 6768  width 1200 heigh
+0001ab00: 7420 3132 3030 2220 2b20 275c 6e27 0a20  t 1200" + '\n'. 
+0001ab10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ab20: 2020 2022 636c 6f73 6520 616c 6c22 202b     "close all" +
+0001ab30: 2022 5c6e 220a 2020 2020 2020 2020 2020   "\n".          
+0001ab40: 2020 2020 2020 2020 2020 2265 7869 7422            "exit"
+0001ab50: 202b 2027 5c6e 270a 2020 2020 2020 2020   + '\n'.        
+0001ab60: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0001ab70: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+0001ab80: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+0001ab90: 7420 6269 6e64 6973 706c 6179 3a0a 2020  t bindisplay:.  
+0001aba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001abb0: 2020 7375 6270 726f 6365 7373 2e63 6865    subprocess.che
+0001abc0: 636b 5f63 616c 6c28 6c6f 6343 4849 4d45  ck_call(locCHIME
+0001abd0: 5241 202b 2022 202d 2d6f 6666 7363 7265  RA + " --offscre
+0001abe0: 656e 202d 2d6e 6f67 7569 2022 202b 2072  en --nogui " + r
+0001abf0: 6177 6d61 7063 6869 6d65 7261 636d 642c  awmapchimeracmd,
+0001ac00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ac10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ac20: 2020 2020 2020 2020 2020 2020 2063 7764               cwd
+0001ac30: 3d73 656c 662e 776f 726b 6469 722c 2073  =self.workdir, s
+0001ac40: 6865 6c6c 3d54 7275 6529 0a20 2020 2020  hell=True).     
+0001ac50: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0001ac60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ac70: 2020 2020 2073 7562 7072 6f63 6573 732e       subprocess.
+0001ac80: 6368 6563 6b5f 6361 6c6c 286c 6f63 4348  check_call(locCH
+0001ac90: 494d 4552 4120 2b20 2220 2220 2b20 7261  IMERA + " " + ra
+0001aca0: 776d 6170 6368 696d 6572 6163 6d64 2c20  wmapchimeracmd, 
+0001acb0: 6377 643d 7365 6c66 2e77 6f72 6b64 6972  cwd=self.workdir
+0001acc0: 2c20 7368 656c 6c3d 5472 7565 290a 0a20  , shell=True).. 
+0001acd0: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+0001ace0: 7420 7375 6270 726f 6365 7373 2e43 616c  t subprocess.Cal
+0001acf0: 6c65 6450 726f 6365 7373 4572 726f 7220  ledProcessError 
+0001ad00: 6173 2073 7562 6572 723a 0a20 2020 2020  as suberr:.     
+0001ad10: 2020 2020 2020 2020 2020 2065 7272 203d             err =
+0001ad20: 2027 5261 7720 6d61 7020 7375 7266 6163   'Raw map surfac
+0001ad30: 6520 7669 6577 2062 7920 4368 696d 6572  e view by Chimer
+0001ad40: 6158 2065 7272 6f72 3a20 7b7d 272e 666f  aX error: {}'.fo
+0001ad50: 726d 6174 2873 7562 6572 7229 0a20 2020  rmat(suberr).   
+0001ad60: 2020 2020 2020 2020 2020 2020 2065 7272               err
+0001ad70: 6c69 7374 2e61 7070 656e 6428 6572 7229  list.append(err)
+0001ad80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ad90: 2073 7973 2e73 7464 6572 722e 7772 6974   sys.stderr.writ
+0001ada0: 6528 6572 7220 2b20 275c 6e27 290a 0a20  e(err + '\n').. 
+0001adb0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0001adc0: 2827 5261 7720 6d61 7020 7375 7266 6163  ('Raw map surfac
+0001add0: 6520 7669 6577 7320 7765 7265 2067 656e  e views were gen
+0001ade0: 6572 6174 6564 2062 7920 4368 696d 6572  erated by Chimer
+0001adf0: 6158 206d 6574 686f 6427 290a 2020 2020  aX method').    
+0001ae00: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+0001ae10: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0001ae20: 662e 7363 616c 655f 7375 7266 6163 6576  f.scale_surfacev
+0001ae30: 6965 7728 290a 2020 2020 2020 2020 2020  iew().          
+0001ae40: 2020 6578 6365 7074 3a0a 2020 2020 2020    except:.      
+0001ae50: 2020 2020 2020 2020 2020 6572 7220 3d20            err = 
+0001ae60: 2753 6361 6c69 6e67 2074 6865 2073 7572  'Scaling the sur
+0001ae70: 6661 6365 2076 6965 7773 2065 7272 3a20  face views err: 
+0001ae80: 7b7d 272e 666f 726d 6174 2873 7973 2e65  {}'.format(sys.e
+0001ae90: 7863 5f69 6e66 6f28 295b 315d 290a 2020  xc_info()[1]).  
+0001aea0: 2020 2020 2020 2020 2020 2020 2020 6572                er
+0001aeb0: 726c 6973 742e 6170 7065 6e64 2865 7272  rlist.append(err
+0001aec0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001aed0: 2020 7379 732e 7374 6465 7272 2e77 7269    sys.stderr.wri
+0001aee0: 7465 2865 7272 202b 2027 5c6e 2729 0a0a  te(err + '\n')..
+0001aef0: 2020 2020 2020 2020 2020 2020 7261 7773              raws
+0001af00: 7572 6661 6365 7669 6577 6a73 6f6e 203d  urfaceviewjson =
+0001af10: 2064 6963 7428 290a 0a20 2020 2020 2020   dict()..       
+0001af20: 2020 2020 206f 7574 6d61 7078 696d 6167       outmapximag
+0001af30: 6520 3d20 7374 7228 6d61 706e 616d 6529  e = str(mapname)
+0001af40: 202b 2027 5f78 7375 7266 6163 652e 6a70   + '_xsurface.jp
+0001af50: 6567 270a 2020 2020 2020 2020 2020 2020  eg'.            
+0001af60: 6d61 7078 6c69 7374 203d 206f 7574 6d61  mapxlist = outma
+0001af70: 7078 696d 6167 652e 7370 6c69 7428 275f  pximage.split('_
+0001af80: 2729 0a20 2020 2020 2020 2020 2020 206d  ').            m
+0001af90: 6170 7873 6361 6c65 696d 6167 6520 3d20  apxscaleimage = 
+0001afa0: 275f 272e 6a6f 696e 286d 6170 786c 6973  '_'.join(mapxlis
+0001afb0: 745b 3a2d 315d 2920 2b20 275f 7363 616c  t[:-1]) + '_scal
+0001afc0: 6564 5f27 202b 206d 6170 786c 6973 745b  ed_' + mapxlist[
+0001afd0: 2d31 5d0a 2020 2020 2020 2020 2020 2020  -1].            
+0001afe0: 7261 7773 7572 6661 6365 7669 6577 6a73  rawsurfaceviewjs
+0001aff0: 6f6e 5b27 7827 5d20 3d20 6f73 2e70 6174  on['x'] = os.pat
+0001b000: 682e 6261 7365 6e61 6d65 286d 6170 7873  h.basename(mapxs
+0001b010: 6361 6c65 696d 6167 6529 2069 6620 6f73  caleimage) if os
+0001b020: 2e70 6174 682e 6973 6669 6c65 280a 2020  .path.isfile(.  
+0001b030: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0001b040: 6c66 2e77 6f72 6b64 6972 202b 206d 6170  lf.workdir + map
+0001b050: 7873 6361 6c65 696d 6167 6529 2065 6c73  xscaleimage) els
+0001b060: 6520 4e6f 6e65 0a0a 2020 2020 2020 2020  e None..        
+0001b070: 2020 2020 6f75 746d 6170 7969 6d61 6765      outmapyimage
+0001b080: 203d 2073 7472 286d 6170 6e61 6d65 2920   = str(mapname) 
+0001b090: 2b20 275f 7973 7572 6661 6365 2e6a 7065  + '_ysurface.jpe
+0001b0a0: 6727 0a20 2020 2020 2020 2020 2020 206d  g'.            m
+0001b0b0: 6170 796c 6973 7420 3d20 6f75 746d 6170  apylist = outmap
+0001b0c0: 7969 6d61 6765 2e73 706c 6974 2827 5f27  yimage.split('_'
+0001b0d0: 290a 2020 2020 2020 2020 2020 2020 6d61  ).            ma
+0001b0e0: 7079 7363 616c 6569 6d61 6765 203d 2027  pyscaleimage = '
+0001b0f0: 5f27 2e6a 6f69 6e28 6d61 7079 6c69 7374  _'.join(mapylist
+0001b100: 5b3a 2d31 5d29 202b 2027 5f73 6361 6c65  [:-1]) + '_scale
+0001b110: 645f 2720 2b20 6d61 7079 6c69 7374 5b2d  d_' + mapylist[-
+0001b120: 315d 0a20 2020 2020 2020 2020 2020 2072  1].            r
+0001b130: 6177 7375 7266 6163 6576 6965 776a 736f  awsurfaceviewjso
+0001b140: 6e5b 2779 275d 203d 206f 732e 7061 7468  n['y'] = os.path
+0001b150: 2e62 6173 656e 616d 6528 6d61 7079 7363  .basename(mapysc
+0001b160: 616c 6569 6d61 6765 2920 6966 206f 732e  aleimage) if os.
+0001b170: 7061 7468 2e69 7366 696c 6528 0a20 2020  path.isfile(.   
+0001b180: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0001b190: 662e 776f 726b 6469 7220 2b20 6d61 7079  f.workdir + mapy
+0001b1a0: 7363 616c 6569 6d61 6765 2920 656c 7365  scaleimage) else
+0001b1b0: 204e 6f6e 650a 0a20 2020 2020 2020 2020   None..         
+0001b1c0: 2020 206f 7574 6d61 707a 696d 6167 6520     outmapzimage 
+0001b1d0: 3d20 7374 7228 6d61 706e 616d 6529 202b  = str(mapname) +
+0001b1e0: 2027 5f7a 7375 7266 6163 652e 6a70 6567   '_zsurface.jpeg
+0001b1f0: 270a 2020 2020 2020 2020 2020 2020 6d61  '.            ma
+0001b200: 707a 6c69 7374 203d 206f 7574 6d61 707a  pzlist = outmapz
+0001b210: 696d 6167 652e 7370 6c69 7428 275f 2729  image.split('_')
+0001b220: 0a20 2020 2020 2020 2020 2020 206d 6170  .            map
+0001b230: 7a73 6361 6c65 696d 6167 6520 3d20 275f  zscaleimage = '_
+0001b240: 272e 6a6f 696e 286d 6170 7a6c 6973 745b  '.join(mapzlist[
+0001b250: 3a2d 315d 2920 2b20 275f 7363 616c 6564  :-1]) + '_scaled
+0001b260: 5f27 202b 206d 6170 7a6c 6973 745b 2d31  _' + mapzlist[-1
+0001b270: 5d0a 2020 2020 2020 2020 2020 2020 7261  ].            ra
+0001b280: 7773 7572 6661 6365 7669 6577 6a73 6f6e  wsurfaceviewjson
+0001b290: 5b27 7a27 5d20 3d20 6f73 2e70 6174 682e  ['z'] = os.path.
+0001b2a0: 6261 7365 6e61 6d65 286d 6170 7a73 6361  basename(mapzsca
+0001b2b0: 6c65 696d 6167 6529 2069 6620 6f73 2e70  leimage) if os.p
+0001b2c0: 6174 682e 6973 6669 6c65 280a 2020 2020  ath.isfile(.    
+0001b2d0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001b2e0: 2e77 6f72 6b64 6972 202b 206d 6170 7a73  .workdir + mapzs
+0001b2f0: 6361 6c65 696d 6167 6529 2065 6c73 6520  caleimage) else 
+0001b300: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+0001b310: 2069 6620 6572 726c 6973 743a 0a20 2020   if errlist:.   
+0001b320: 2020 2020 2020 2020 2020 2020 2072 6177               raw
+0001b330: 7375 7266 6163 6576 6965 776a 736f 6e5b  surfaceviewjson[
+0001b340: 2765 7272 275d 203d 207b 2772 6177 6d61  'err'] = {'rawma
+0001b350: 705f 7375 7266 6163 655f 6572 7227 3a20  p_surface_err': 
+0001b360: 6572 726c 6973 747d 0a0a 2020 2020 2020  errlist}..      
+0001b370: 2020 2020 2020 6669 6e61 6c64 6963 7420        finaldict 
+0001b380: 3d20 7b27 7261 776d 6170 5f6d 6170 5f73  = {'rawmap_map_s
+0001b390: 7572 6661 6365 273a 2072 6177 7375 7266  urface': rawsurf
+0001b3a0: 6163 6576 6965 776a 736f 6e7d 0a20 2020  aceviewjson}.   
+0001b3b0: 2020 2020 2020 2020 2072 6177 636c 6469           rawcldi
+0001b3c0: 6374 203d 207b 2772 6177 6d61 705f 636f  ct = {'rawmap_co
+0001b3d0: 6e74 6f75 725f 6c65 7665 6c27 3a20 7b27  ntour_level': {'
+0001b3e0: 636c 273a 2027 7b3a 302e 3266 7d27 2e66  cl': '{:0.2f}'.f
+0001b3f0: 6f72 6d61 7428 7261 776d 6170 636c 297d  ormat(rawmapcl)}
+0001b400: 7d0a 0a20 2020 2020 2020 2020 2020 2074  }..            t
+0001b410: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+0001b420: 2020 2020 7769 7468 2063 6f64 6563 732e      with codecs.
+0001b430: 6f70 656e 2873 656c 662e 776f 726b 6469  open(self.workdi
+0001b440: 7220 2b20 6d61 706e 616d 6520 2b20 275f  r + mapname + '_
+0001b450: 7261 776d 6170 7375 7266 6163 6576 6965  rawmapsurfacevie
+0001b460: 772e 6a73 6f6e 272c 2027 7727 2c0a 2020  w.json', 'w',.  
+0001b470: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b480: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0001b490: 6e63 6f64 696e 673d 2775 7466 2d38 2729  ncoding='utf-8')
+0001b4a0: 2061 7320 663a 0a20 2020 2020 2020 2020   as f:.         
+0001b4b0: 2020 2020 2020 2020 2020 206a 736f 6e2e             json.
+0001b4c0: 6475 6d70 2866 696e 616c 6469 6374 2c20  dump(finaldict, 
+0001b4d0: 6629 0a20 2020 2020 2020 2020 2020 2065  f).            e
+0001b4e0: 7863 6570 743a 0a20 2020 2020 2020 2020  xcept:.         
+0001b4f0: 2020 2020 2020 2065 7272 203d 2027 5361         err = 'Sa
+0001b500: 7669 6e67 206d 6170 2073 7572 6661 6365  ving map surface
+0001b510: 2076 6965 7720 6a73 6f6e 2065 7272 6f72   view json error
+0001b520: 3a20 7b7d 2e27 2e66 6f72 6d61 7428 7379  : {}.'.format(sy
+0001b530: 732e 6578 635f 696e 666f 2829 5b31 5d29  s.exc_info()[1])
+0001b540: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001b550: 2073 7973 2e73 7464 6572 722e 7772 6974   sys.stderr.writ
+0001b560: 6528 6572 7220 2b20 275c 6e27 290a 0a20  e(err + '\n').. 
+0001b570: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+0001b580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b590: 7769 7468 2063 6f64 6563 732e 6f70 656e  with codecs.open
+0001b5a0: 2873 656c 662e 776f 726b 6469 7220 2b20  (self.workdir + 
+0001b5b0: 6d61 706e 616d 6520 2b20 275f 7261 776d  mapname + '_rawm
+0001b5c0: 6170 636c 2e6a 736f 6e27 2c20 2777 272c  apcl.json', 'w',
+0001b5d0: 2065 6e63 6f64 696e 673d 2775 7466 2d38   encoding='utf-8
+0001b5e0: 2729 2061 7320 6666 3a0a 2020 2020 2020  ') as ff:.      
+0001b5f0: 2020 2020 2020 2020 2020 2020 2020 6a73                js
+0001b600: 6f6e 2e64 756d 7028 7261 7763 6c64 6963  on.dump(rawcldic
+0001b610: 742c 2066 6629 0a20 2020 2020 2020 2020  t, ff).         
+0001b620: 2020 2065 7863 6570 743a 0a20 2020 2020     except:.     
+0001b630: 2020 2020 2020 2020 2020 2065 7272 203d             err =
+0001b640: 2027 5361 7669 6e67 2072 6177 6d61 7020   'Saving rawmap 
+0001b650: 636f 6e74 6f75 7220 6c65 7665 6c20 6a73  contour level js
+0001b660: 6f6e 2065 7272 6f72 3a20 7b7d 2e27 2e66  on error: {}.'.f
+0001b670: 6f72 6d61 7428 7379 732e 6578 635f 696e  ormat(sys.exc_in
+0001b680: 666f 2829 5b31 5d29 0a20 2020 2020 2020  fo()[1]).       
+0001b690: 2020 2020 2020 2020 2073 7973 2e73 7464           sys.std
+0001b6a0: 6572 722e 7772 6974 6528 6572 7220 2b20  err.write(err + 
+0001b6b0: 275c 6e27 290a 0a20 2020 2020 2020 2020  '\n')..         
+0001b6c0: 2020 2065 6e64 203d 2074 696d 6569 742e     end = timeit.
+0001b6d0: 6465 6661 756c 745f 7469 6d65 7228 290a  default_timer().
+0001b6e0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0001b6f0: 7428 2752 6177 206d 6170 2073 7572 6661  t('Raw map surfa
+0001b700: 6365 2076 6965 7720 7469 6d65 3a20 2573  ce view time: %s
+0001b710: 2720 2520 2865 6e64 202d 2073 7461 7274  ' % (end - start
+0001b720: 2929 0a20 2020 2020 2020 2020 2020 2070  )).            p
+0001b730: 7269 6e74 2827 2d2d 2d2d 2d2d 2d2d 2d2d  rint('----------
+0001b740: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0001b750: 2d2d 2d2d 2d2d 2d2d 2d2d 2729 0a0a 2020  ----------')..  
+0001b760: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0001b770: 2020 2020 2020 2020 7072 696e 7428 274e          print('N
+0001b780: 6f20 7261 7720 6d61 7020 6f72 2068 616c  o raw map or hal
+0001b790: 6620 6d61 7073 206f 7220 7261 7720 6d61  f maps or raw ma
+0001b7a0: 7020 636f 6e74 6f75 7220 6c65 7665 6c20  p contour level 
+0001b7b0: 666f 7220 7261 7720 6d61 7020 7375 7266  for raw map surf
+0001b7c0: 6163 6573 2e27 290a 0a0a 2020 2020 2320  aces.')...    # 
+0001b7d0: 5375 7266 6163 6520 4368 696d 6572 6120  Surface Chimera 
+0001b7e0: 7761 790a 2020 2020 6465 6620 7375 7266  way.    def surf
+0001b7f0: 6163 6576 6965 775f 6368 696d 6572 6128  aceview_chimera(
+0001b800: 7365 6c66 2c20 6368 696d 6572 6161 7070  self, chimeraapp
+0001b810: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
+0001b820: 2020 2020 2020 2020 2020 2047 656e 6572             Gener
+0001b830: 6174 6520 7375 7266 6163 6520 7669 6577  ate surface view
+0001b840: 2062 7920 7573 696e 6720 6865 6164 6c65   by using headle
+0001b850: 7373 2043 6869 6d65 7261 2061 6e64 2070  ss Chimera and p
+0001b860: 7963 6869 6d65 7261 0a0a 2020 2020 2020  ychimera..      
+0001b870: 2020 2222 220a 2020 2020 2020 2020 696d    """.        im
+0001b880: 706f 7274 206d 6d61 700a 0a20 2020 2020  port mmap..     
+0001b890: 2020 2073 7461 7274 203d 2074 696d 6569     start = timei
+0001b8a0: 742e 6465 6661 756c 745f 7469 6d65 7228  t.default_timer(
+0001b8b0: 290a 2020 2020 2020 2020 6572 726c 6973  ).        errlis
+0001b8c0: 7420 3d20 5b5d 0a20 2020 2020 2020 206d  t = [].        m
+0001b8d0: 6d65 7272 6c69 7374 203d 205b 5d0a 2020  merrlist = [].  
+0001b8e0: 2020 2020 2020 6269 6e64 6973 706c 6179        bindisplay
+0001b8f0: 203d 206f 732e 6765 7465 6e76 2827 4449   = os.getenv('DI
+0001b900: 5350 4c41 5927 290a 0a20 2020 2020 2020  SPLAY')..       
+0001b910: 206d 6170 6e61 6d65 203d 2073 656c 662e   mapname = self.
+0001b920: 776f 726b 6469 7220 2b20 7365 6c66 2e6d  workdir + self.m
+0001b930: 6170 6e61 6d65 0a20 2020 2020 2020 2069  apname.        i
+0001b940: 6620 6e6f 7420 6f73 2e70 6174 682e 6973  f not os.path.is
+0001b950: 6669 6c65 286d 6170 6e61 6d65 2920 616e  file(mapname) an
+0001b960: 6420 6f73 2e70 6174 682e 6973 6669 6c65  d os.path.isfile
+0001b970: 2873 656c 662e 6d61 706e 616d 6529 3a0a  (self.mapname):.
+0001b980: 2020 2020 2020 2020 2020 2020 6d61 706e              mapn
+0001b990: 616d 6520 3d20 7365 6c66 2e6d 6170 6e61  ame = self.mapna
+0001b9a0: 6d65 0a0a 2020 2020 2020 2020 6c6f 6343  me..        locC
+0001b9b0: 4849 4d45 5241 203d 2063 6869 6d65 7261  HIMERA = chimera
+0001b9c0: 6170 700a 2020 2020 2020 2020 636f 6e74  app.        cont
+0001b9d0: 6f75 7220 3d20 226c 6576 656c 2022 202b  our = "level " +
+0001b9e0: 2073 7472 2873 656c 662e 636c 2920 6966   str(self.cl) if
+0001b9f0: 2073 656c 662e 636c 2069 7320 6e6f 7420   self.cl is not 
+0001ba00: 4e6f 6e65 2065 6c73 6520 2727 0a20 2020  None else ''.   
+0001ba10: 2020 2020 2023 206d 6170 2073 7572 6661       # map surfa
+0001ba20: 6365 2076 6965 7720 616c 6f6e 650a 2020  ce view alone.  
+0001ba30: 2020 2020 2020 6d61 7063 6869 6d65 7261        mapchimera
+0001ba40: 636d 6420 3d20 7365 6c66 2e6d 6170 6e61  cmd = self.mapna
+0001ba50: 6d65 202b 2027 5f63 6869 6d65 7261 2e63  me + '_chimera.c
+0001ba60: 7863 270a 2020 2020 2020 2020 6173 7365  xc'.        asse
+0001ba70: 6d62 6c65 203d 2046 616c 7365 0a20 2020  mble = False.   
+0001ba80: 2020 2020 2077 6974 6820 6f70 656e 2873       with open(s
+0001ba90: 656c 662e 776f 726b 6469 7220 2b20 6d61  elf.workdir + ma
+0001baa0: 7063 6869 6d65 7261 636d 642c 2027 7727  pchimeracmd, 'w'
+0001bab0: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
+0001bac0: 2020 2020 662e 7772 6974 6528 0a20 2020      f.write(.   
+0001bad0: 2020 2020 2020 2020 2020 2020 2023 2043               # C
+0001bae0: 6869 6d65 7261 2076 6572 7369 6f6e 0a20  himera version. 
+0001baf0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0001bb00: 2027 6f70 656e 2063 6370 343a 2720 2b20   'open ccp4:' + 
+0001bb10: 7374 7228 6d61 706e 616d 6529 202b 2027  str(mapname) + '
+0001bb20: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
+0001bb30: 2020 2020 2320 2276 6f6c 756d 6520 2330      # "volume #0
+0001bb40: 2073 7479 6c65 2073 7572 6661 6365 2065   style surface e
+0001bb50: 7870 616e 6453 696e 676c 6550 6c61 6e65  xpandSinglePlane
+0001bb60: 2054 7275 6520 2220 2b20 275c 6e27 0a20   True " + '\n'. 
 0001bb70: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0001bb80: 2022 636f 7079 2066 696c 6520 2220 2b20   "copy file " + 
-0001bb90: 7374 7228 7375 7266 6163 6566 6e29 202b  str(surfacefn) +
-0001bba0: 2022 5f79 7375 7266 6163 652e 6a70 6567   "_ysurface.jpeg
-0001bbb0: 2220 2b20 2220 7375 7065 7273 616d 706c  " + " supersampl
-0001bbc0: 6520 3320 7769 6474 6820 3132 3030 2068  e 3 width 1200 h
-0001bbd0: 6569 6768 7420 3132 3030 2220 2b20 275c  eight 1200" + '\
-0001bbe0: 6e27 0a20 2020 2020 2020 2020 2020 2020  n'.             
-0001bbf0: 2020 2020 2020 2020 2020 2023 2022 636c             # "cl
-0001bc00: 6f73 6520 616c 6c22 202b 2022 5c6e 220a  ose all" + "\n".
-0001bc10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bc20: 2020 2020 2020 2020 2320 2273 746f 7022          # "stop"
-0001bc30: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0001bc40: 2020 2020 2020 2020 2020 2320 4368 696d            # Chim
-0001bc50: 6572 6158 2076 6572 7369 6f6e 0a20 2020  eraX version.   
-0001bc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bc70: 2020 2020 2027 6f70 656e 2027 202b 2073       'open ' + s
-0001bc80: 7472 286d 6170 6e61 6d65 2920 2b20 2220  tr(mapname) + " 
-0001bc90: 666f 726d 6174 2063 6370 3422 202b 2027  format ccp4" + '
-0001bca0: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
-0001bcb0: 2020 2020 2020 2020 2020 2020 226f 7065              "ope
-0001bcc0: 6e20 2220 2b20 7374 7228 6d6f 6465 6c2e  n " + str(model.
-0001bcd0: 6669 6c65 6e61 6d65 2920 2b20 2220 666f  filename) + " fo
-0001bce0: 726d 6174 206d 6d63 6966 2220 2b20 275c  rmat mmcif" + '\
-0001bcf0: 6e27 0a20 2020 2020 2020 2020 2020 2020  n'.             
-0001bd00: 2020 2020 2020 2020 2020 2022 6869 6465             "hide
-0001bd10: 2073 656c 4174 6f6d 7322 202b 2027 5c6e   selAtoms" + '\n
-0001bd20: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0001bd30: 2020 2020 2020 2020 2020 2273 686f 7720            "show 
-0001bd40: 7365 6c41 746f 6d73 2072 6962 626f 6e73  selAtoms ribbons
-0001bd50: 2220 2b20 275c 6e27 0a20 2020 2020 2020  " + '\n'.       
-0001bd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bd70: 2022 636f 6c6f 7220 2332 2023 3030 3342   "color #2 #003B
-0001bd80: 4646 2220 2b20 275c 6e27 0a20 2020 2020  FF" + '\n'.     
-0001bd90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bda0: 2020 2022 766f 6c75 6d65 2023 3120 7374     "volume #1 st
-0001bdb0: 796c 6520 7375 7266 6163 6520 6578 7061  yle surface expa
-0001bdc0: 6e64 5369 6e67 6c65 506c 616e 6520 5472  ndSinglePlane Tr
-0001bdd0: 7565 2022 202b 2027 5c6e 270a 2020 2020  ue " + '\n'.    
-0001bde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bdf0: 2020 2020 2276 6f6c 756d 6520 2331 2063      "volume #1 c
-0001be00: 6f6c 6f72 2023 4238 3836 3042 2073 7465  olor #B8860B ste
-0001be10: 7020 3120 2220 2b20 636f 6e74 6f75 7220  p 1 " + contour 
-0001be20: 2b20 275c 6e27 0a20 2020 2020 2020 2020  + '\n'.         
-0001be30: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0001be40: 766f 6c75 6d65 2023 3120 7472 616e 7370  volume #1 transp
-0001be50: 6172 656e 6379 2030 2e36 3522 202b 2027  arency 0.65" + '
-0001be60: 5c6e 2720 2023 206d 616b 6520 7468 6520  \n'  # make the 
-0001be70: 7375 7266 6163 6520 6120 6c69 7474 6c65  surface a little
-0001be80: 2062 6974 2073 6565 2d74 6872 6f75 6768   bit see-through
-0001be90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001bea0: 2020 2020 2020 2020 2022 7365 7420 6267           "set bg
-0001beb0: 436f 6c6f 7220 6c69 6768 7420 6772 6179  Color light gray
-0001bec0: 2220 2b20 275c 6e27 0a20 2020 2020 2020  " + '\n'.       
-0001bed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bee0: 2022 7669 6577 2063 6f66 7220 5472 7565   "view cofr True
-0001bef0: 205c 6e22 0a20 2020 2020 2020 2020 2020   \n".           
-0001bf00: 2020 2020 2020 2020 2020 2020 2022 7361               "sa
-0001bf10: 7665 2022 202b 2073 7472 2873 7572 6661  ve " + str(surfa
-0001bf20: 6365 666e 2920 2b20 225f 7a73 7572 6661  cefn) + "_zsurfa
-0001bf30: 6365 2e6a 7065 6722 202b 2022 2073 7570  ce.jpeg" + " sup
-0001bf40: 6572 7361 6d70 6c65 2033 2077 6964 7468  ersample 3 width
-0001bf50: 2031 3230 3020 6865 6967 6874 2031 3230   1200 height 120
-0001bf60: 3022 202b 2027 5c6e 270a 2020 2020 2020  0" + '\n'.      
-0001bf70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bf80: 2020 2274 7572 6e20 7820 2d39 3022 202b    "turn x -90" +
-0001bf90: 2027 5c6e 270a 2020 2020 2020 2020 2020   '\n'.          
-0001bfa0: 2020 2020 2020 2020 2020 2020 2020 2274                "t
-0001bfb0: 7572 6e20 7920 2d39 3022 202b 2027 5c6e  urn y -90" + '\n
-0001bfc0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0001bfd0: 2020 2020 2020 2020 2020 2276 6965 7720            "view 
-0001bfe0: 636f 6672 2054 7275 6522 202b 2027 5c6e  cofr True" + '\n
-0001bff0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0001c000: 2020 2020 2020 2020 2020 2273 6176 6520            "save 
-0001c010: 2220 2b20 7374 7228 7375 7266 6163 6566  " + str(surfacef
-0001c020: 6e29 202b 2022 5f78 7375 7266 6163 652e  n) + "_xsurface.
-0001c030: 6a70 6567 2220 2b20 2220 7375 7065 7273  jpeg" + " supers
-0001c040: 616d 706c 6520 3320 7769 6474 6820 3132  ample 3 width 12
-0001c050: 3030 2068 6569 6768 7420 3132 3030 2220  00 height 1200" 
-0001c060: 2b20 275c 6e27 0a20 2020 2020 2020 2020  + '\n'.         
-0001c070: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0001c080: 7669 6577 206f 7269 656e 7422 202b 2027  view orient" + '
-0001c090: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
-0001c0a0: 2020 2020 2020 2020 2020 2020 2274 7572              "tur
-0001c0b0: 6e20 7820 3930 2220 2b20 275c 6e27 0a20  n x 90" + '\n'. 
-0001c0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c0d0: 2020 2020 2020 2022 7475 726e 207a 2039         "turn z 9
-0001c0e0: 3022 202b 2027 5c6e 270a 2020 2020 2020  0" + '\n'.      
-0001c0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c100: 2020 2276 6965 7720 636f 6672 2054 7275    "view cofr Tru
-0001c110: 6522 202b 2027 5c6e 270a 2020 2020 2020  e" + '\n'.      
-0001c120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c130: 2020 2273 6176 6520 2220 2b20 7374 7228    "save " + str(
-0001c140: 7375 7266 6163 6566 6e29 202b 2022 5f79  surfacefn) + "_y
-0001c150: 7375 7266 6163 652e 6a70 6567 2220 2b20  surface.jpeg" + 
-0001c160: 2220 7375 7065 7273 616d 706c 6520 3320  " supersample 3 
-0001c170: 7769 6474 6820 3132 3030 2068 6569 6768  width 1200 heigh
-0001c180: 7420 3132 3030 2220 2b20 275c 6e27 0a20  t 1200" + '\n'. 
-0001c190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c1a0: 2020 2020 2020 2022 636c 6f73 6520 616c         "close al
-0001c1b0: 6c22 202b 2022 5c6e 220a 2020 2020 2020  l" + "\n".      
-0001c1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c1d0: 2020 2265 7869 7422 0a0a 2020 2020 2020    "exit"..      
-0001c1e0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0001bb80: 2022 766f 6c75 6d65 2023 3020 636f 6c6f   "volume #0 colo
+0001bb90: 7220 2342 3838 3630 4220 7374 6570 2031  r #B8860B step 1
+0001bba0: 2022 202b 2063 6f6e 746f 7572 202b 2027   " + contour + '
+0001bbb0: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
+0001bbc0: 2020 2020 2320 2273 6574 2070 726f 6a65      # "set proje
+0001bbd0: 6374 696f 6e20 6f72 7468 6f67 7261 7068  ction orthograph
+0001bbe0: 6963 2220 2b20 275c 6e27 0a20 2020 2020  ic" + '\n'.     
+0001bbf0: 2020 2020 2020 2020 2020 2023 2022 7375             # "su
+0001bc00: 7266 7472 616e 7370 2035 3022 202b 2027  rftransp 50" + '
+0001bc10: 5c6e 2720 2023 206d 616b 6520 7468 6520  \n'  # make the 
+0001bc20: 7375 7266 6163 6520 6120 6c69 7474 6c65  surface a little
+0001bc30: 2062 6974 2073 6565 2d74 6872 6f75 6768   bit see-through
+0001bc40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001bc50: 2023 2022 6261 636b 6772 6f75 6e64 2073   # "background s
+0001bc60: 6f6c 6964 206c 6967 6874 2067 7261 7922  olid light gray"
+0001bc70: 202b 2027 5c6e 270a 2020 2020 2020 2020   + '\n'.        
+0001bc80: 2020 2020 2020 2020 2320 2263 6f70 7920          # "copy 
+0001bc90: 6669 6c65 2022 202b 2073 7472 2873 656c  file " + str(sel
+0001bca0: 662e 6d61 706e 616d 6529 202b 2022 5f7a  f.mapname) + "_z
+0001bcb0: 7375 7266 6163 652e 6a70 6567 2220 2b20  surface.jpeg" + 
+0001bcc0: 2220 7375 7065 7273 616d 706c 6520 3320  " supersample 3 
+0001bcd0: 7769 6474 6820 3132 3030 2068 6569 6768  width 1200 heigh
+0001bce0: 7420 3132 3030 2220 2b20 275c 6e27 0a20  t 1200" + '\n'. 
+0001bcf0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0001bd00: 2022 7475 726e 2078 202d 3930 2220 2b20   "turn x -90" + 
+0001bd10: 275c 6e27 0a20 2020 2020 2020 2020 2020  '\n'.           
+0001bd20: 2020 2020 2023 2022 6365 6e74 6572 2220       # "center" 
+0001bd30: 2b20 275c 6e27 0a20 2020 2020 2020 2020  + '\n'.         
+0001bd40: 2020 2020 2020 2023 2022 636f 7079 2066         # "copy f
+0001bd50: 696c 6520 2220 2b20 7374 7228 7365 6c66  ile " + str(self
+0001bd60: 2e6d 6170 6e61 6d65 2920 2b20 225f 7873  .mapname) + "_xs
+0001bd70: 7572 6661 6365 2e6a 7065 6722 202b 2022  urface.jpeg" + "
+0001bd80: 2073 7570 6572 7361 6d70 6c65 2033 2077   supersample 3 w
+0001bd90: 6964 7468 2031 3230 3020 6865 6967 6874  idth 1200 height
+0001bda0: 2031 3230 3022 202b 2027 5c6e 270a 2020   1200" + '\n'.  
+0001bdb0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0001bdc0: 2274 7572 6e20 7a20 2d39 3022 202b 2027  "turn z -90" + '
+0001bdd0: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
+0001bde0: 2020 2020 2320 2263 656e 7465 7222 202b      # "center" +
+0001bdf0: 2027 5c6e 270a 2020 2020 2020 2020 2020   '\n'.          
+0001be00: 2020 2020 2020 2320 2263 6f70 7920 6669        # "copy fi
+0001be10: 6c65 2022 202b 2073 7472 2873 656c 662e  le " + str(self.
+0001be20: 6d61 706e 616d 6529 202b 2022 5f79 7375  mapname) + "_ysu
+0001be30: 7266 6163 652e 6a70 6567 2220 2b20 2220  rface.jpeg" + " 
+0001be40: 7375 7065 7273 616d 706c 6520 3320 7769  supersample 3 wi
+0001be50: 6474 6820 3132 3030 2068 6569 6768 7420  dth 1200 height 
+0001be60: 3132 3030 2220 2b20 275c 6e27 0a20 2020  1200" + '\n'.   
+0001be70: 2020 2020 2020 2020 2020 2020 2023 2022               # "
+0001be80: 636c 6f73 6520 616c 6c22 202b 2022 5c6e  close all" + "\n
+0001be90: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0001bea0: 2020 2320 2273 746f 7022 0a0a 2020 2020    # "stop"..    
+0001beb0: 2020 2020 2020 2020 2020 2020 2320 4368              # Ch
+0001bec0: 696d 6572 6158 2076 6572 7369 6f6e 0a20  imeraX version. 
+0001bed0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0001bee0: 6f70 656e 2022 202b 2073 7472 286d 6170  open " + str(map
+0001bef0: 6e61 6d65 2920 2b20 2220 666f 726d 6174  name) + " format
+0001bf00: 2063 6370 3422 202b 2027 5c6e 270a 2020   ccp4" + '\n'.  
+0001bf10: 2020 2020 2020 2020 2020 2020 2020 2276                "v
+0001bf20: 6f6c 756d 6520 2331 2073 7479 6c65 2073  olume #1 style s
+0001bf30: 7572 6661 6365 2065 7870 616e 6453 696e  urface expandSin
+0001bf40: 676c 6550 6c61 6e65 2054 7275 6522 202b  glePlane True" +
+0001bf50: 2027 5c6e 270a 2020 2020 2020 2020 2020   '\n'.          
+0001bf60: 2020 2020 2020 2320 2276 6f6c 756d 6520        # "volume 
+0001bf70: 2331 2063 6f6c 6f72 2023 4238 3836 3042  #1 color #B8860B
+0001bf80: 2073 7465 7020 3120 6c65 7665 6c20 2220   step 1 level " 
+0001bf90: 2b20 7374 7228 7365 6c66 2e63 6c29 202b  + str(self.cl) +
+0001bfa0: 2027 5c6e 270a 2020 2020 2020 2020 2020   '\n'.          
+0001bfb0: 2020 2020 2020 2276 6f6c 756d 6520 2331        "volume #1
+0001bfc0: 2073 7465 7020 3120 6c65 7665 6c20 2220   step 1 level " 
+0001bfd0: 2b20 7374 7228 7365 6c66 2e63 6c29 202b  + str(self.cl) +
+0001bfe0: 2027 5c6e 270a 2020 2020 2020 2020 2020   '\n'.          
+0001bff0: 2020 2020 2020 2273 6574 2062 6743 6f6c        "set bgCol
+0001c000: 6f72 2077 6869 7465 2220 2b20 275c 6e27  or white" + '\n'
+0001c010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c020: 2022 6c69 6768 7469 6e67 2066 756c 6c20   "lighting full 
+0001c030: 5c6e 220a 2020 2020 2020 2020 2020 2020  \n".            
+0001c040: 2020 2020 2276 6965 7720 636f 6672 2054      "view cofr T
+0001c050: 7275 6520 5c6e 220a 2020 2020 2020 2020  rue \n".        
+0001c060: 2020 2020 2020 2020 2273 6176 6520 2220          "save " 
+0001c070: 2b20 7374 7228 7365 6c66 2e6d 6170 6e61  + str(self.mapna
+0001c080: 6d65 2920 2b20 225f 7a73 7572 6661 6365  me) + "_zsurface
+0001c090: 2e6a 7065 6722 202b 2022 2073 7570 6572  .jpeg" + " super
+0001c0a0: 7361 6d70 6c65 2033 2077 6964 7468 2031  sample 3 width 1
+0001c0b0: 3230 3020 6865 6967 6874 2031 3230 3022  200 height 1200"
+0001c0c0: 202b 2027 5c6e 270a 2020 2020 2020 2020   + '\n'.        
+0001c0d0: 2020 2020 2020 2020 2274 7572 6e20 7820          "turn x 
+0001c0e0: 2d39 3022 202b 2027 5c6e 270a 2020 2020  -90" + '\n'.    
+0001c0f0: 2020 2020 2020 2020 2020 2020 2274 7572              "tur
+0001c100: 6e20 7920 2d39 3022 202b 2027 5c6e 270a  n y -90" + '\n'.
+0001c110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c120: 2276 6965 7720 636f 6672 2054 7275 6522  "view cofr True"
+0001c130: 202b 2027 5c6e 270a 2020 2020 2020 2020   + '\n'.        
+0001c140: 2020 2020 2020 2020 2273 6176 6520 2220          "save " 
+0001c150: 2b20 7374 7228 7365 6c66 2e6d 6170 6e61  + str(self.mapna
+0001c160: 6d65 2920 2b20 225f 7873 7572 6661 6365  me) + "_xsurface
+0001c170: 2e6a 7065 6722 202b 2022 2073 7570 6572  .jpeg" + " super
+0001c180: 7361 6d70 6c65 2033 2077 6964 7468 2031  sample 3 width 1
+0001c190: 3230 3020 6865 6967 6874 2031 3230 3022  200 height 1200"
+0001c1a0: 202b 2027 5c6e 270a 2020 2020 2020 2020   + '\n'.        
+0001c1b0: 2020 2020 2020 2020 2276 6965 7720 6f72          "view or
+0001c1c0: 6965 6e74 2220 2b20 275c 6e27 0a20 2020  ient" + '\n'.   
+0001c1d0: 2020 2020 2020 2020 2020 2020 2022 7475               "tu
+0001c1e0: 726e 2078 2039 3022 202b 2027 5c6e 270a  rn x 90" + '\n'.
 0001c1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c200: 7769 7468 206f 7065 6e28 7374 7228 6d6f  with open(str(mo
-0001c210: 6465 6c2e 6669 6c65 6e61 6d65 2929 2061  del.filename)) a
-0001c220: 7320 663a 0a20 2020 2020 2020 2020 2020  s f:.           
-0001c230: 2020 2020 2020 2020 2073 203d 206d 6d61           s = mma
-0001c240: 702e 6d6d 6170 2866 2e66 696c 656e 6f28  p.mmap(f.fileno(
-0001c250: 292c 2030 2c20 6163 6365 7373 3d6d 6d61  ), 0, access=mma
-0001c260: 702e 4143 4345 5353 5f52 4541 4429 0a20  p.ACCESS_READ). 
-0001c270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c280: 2020 2023 2070 7974 686f 6e20 3320 6d6d     # python 3 mm
-0001c290: 6170 2e6d 6d61 7028 6669 6c65 2e66 696c  ap.mmap(file.fil
-0001c2a0: 656e 6f28 292c 2030 2c20 6163 6365 7373  eno(), 0, access
-0001c2b0: 3d6d 6d61 702e 4143 4345 5353 5f52 4541  =mmap.ACCESS_REA
-0001c2c0: 4429 2061 7320 733a 0a20 2020 2020 2020  D) as s:.       
-0001c2d0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0001c2e0: 732e 6669 6e64 2862 2770 6f69 6e74 2073  s.find(b'point s
-0001c2f0: 796d 6d65 7472 7920 6f70 6572 6174 696f  ymmetry operatio
-0001c300: 6e27 2920 213d 202d 313a 0a20 2020 2020  n') != -1:.     
-0001c310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c320: 2020 2061 7373 656d 626c 6520 3d20 5472     assemble = Tr
-0001c330: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
-0001c340: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0001c350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c360: 2020 2020 2061 7373 656d 626c 6520 3d20       assemble = 
-0001c370: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
-0001c380: 2020 2020 2020 6368 696d 6572 6163 6d64        chimeracmd
-0001c390: 6173 7365 6d62 6c65 203d 2073 7572 6661  assemble = surfa
-0001c3a0: 6365 666e 202b 2027 5f63 6869 6d65 7261  cefn + '_chimera
-0001c3b0: 5f61 7373 656d 626c 652e 6378 6327 0a20  _assemble.cxc'. 
-0001c3c0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0001c3d0: 6620 6173 7365 6d62 6c65 3a0a 2020 2020  f assemble:.    
-0001c3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c3f0: 6d6f 6465 6c6e 616d 6520 3d20 6f73 2e70  modelname = os.p
-0001c400: 6174 682e 6261 7365 6e61 6d65 286d 6f64  ath.basename(mod
-0001c410: 656c 2e66 696c 656e 616d 6529 0a20 2020  el.filename).   
-0001c420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c430: 206d 6170 6e61 6d65 203d 206f 732e 7061   mapname = os.pa
-0001c440: 7468 2e62 6173 656e 616d 6528 6d61 706e  th.basename(mapn
-0001c450: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
-0001c460: 2020 2020 2020 2020 2070 7265 6669 7820           prefix 
-0001c470: 3d20 277b 7d5f 7b7d 272e 666f 726d 6174  = '{}_{}'.format
-0001c480: 286d 6f64 656c 6e61 6d65 2c20 6d61 706e  (modelname, mapn
-0001c490: 616d 6529 0a0a 2020 2020 2020 2020 2020  ame)..          
-0001c4a0: 2020 2020 2020 2020 2020 7769 7468 206f            with o
-0001c4b0: 7065 6e28 7365 6c66 2e77 6f72 6b64 6972  pen(self.workdir
-0001c4c0: 202b 2063 6869 6d65 7261 636d 6461 7373   + chimeracmdass
-0001c4d0: 656d 626c 652c 2027 7727 2920 6173 2066  emble, 'w') as f
-0001c4e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001c4f0: 2020 2020 2020 2020 2020 662e 7772 6974            f.writ
-0001c500: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
-0001c510: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0001c520: 2043 6869 6d65 7261 5820 7665 7273 696f   ChimeraX versio
-0001c530: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
-0001c540: 2020 2020 2020 2020 2020 2020 2020 226f                "o
-0001c550: 7065 6e20 2220 2b20 7374 7228 6d61 706e  pen " + str(mapn
-0001c560: 616d 6529 202b 2022 2066 6f72 6d61 7420  ame) + " format 
-0001c570: 6363 7034 2220 2b20 275c 6e27 0a20 2020  ccp4" + '\n'.   
-0001c580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c590: 2020 2020 2020 2020 2022 6f70 656e 2022           "open "
-0001c5a0: 202b 2073 7472 286d 6f64 656c 2e66 696c   + str(model.fil
-0001c5b0: 656e 616d 6529 202b 2022 2066 6f72 6d61  ename) + " forma
-0001c5c0: 7420 6d6d 6369 6622 202b 2027 5c6e 270a  t mmcif" + '\n'.
-0001c5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c5e0: 2020 2020 2020 2020 2020 2020 2268 6964              "hid
-0001c5f0: 6520 7365 6c41 746f 6d73 2220 2b20 275c  e selAtoms" + '\
-0001c600: 6e27 0a20 2020 2020 2020 2020 2020 2020  n'.             
-0001c610: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0001c620: 7368 6f77 2073 656c 4174 6f6d 7320 7269  show selAtoms ri
-0001c630: 6262 6f6e 7322 202b 2027 5c6e 270a 2020  bbons" + '\n'.  
-0001c640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c650: 2020 2020 2020 2020 2020 2263 6f6c 6f72            "color
-0001c660: 2023 3220 2330 3033 4246 4622 202b 2027   #2 #003BFF" + '
-0001c670: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
-0001c680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c690: 2276 6f6c 756d 6520 2331 2073 7479 6c65  "volume #1 style
-0001c6a0: 2073 7572 6661 6365 2065 7870 616e 6453   surface expandS
-0001c6b0: 696e 676c 6550 6c61 6e65 2054 7275 6522  inglePlane True"
-0001c6c0: 202b 2027 5c6e 270a 2020 2020 2020 2020   + '\n'.        
-0001c6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c6e0: 2020 2020 2276 6f6c 756d 6520 2331 2063      "volume #1 c
-0001c6f0: 6f6c 6f72 2023 4238 3836 3042 2073 7465  olor #B8860B ste
-0001c700: 7020 3120 2220 2b20 636f 6e74 6f75 7220  p 1 " + contour 
-0001c710: 2b20 275c 6e27 0a20 2020 2020 2020 2020  + '\n'.         
-0001c720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c730: 2020 2022 766f 6c75 6d65 2023 3120 7472     "volume #1 tr
-0001c740: 616e 7370 6172 656e 6379 2030 2e36 3522  ansparency 0.65"
-0001c750: 202b 2027 5c6e 2720 2023 206d 616b 6520   + '\n'  # make 
-0001c760: 7468 6520 7375 7266 6163 6520 6120 6c69  the surface a li
-0001c770: 7474 6c65 2062 6974 2073 6565 2d74 6872  ttle bit see-thr
-0001c780: 6f75 6768 0a20 2020 2020 2020 2020 2020  ough.           
-0001c790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c7a0: 2022 7379 6d20 2332 2061 7373 656d 626c   "sym #2 assembl
-0001c7b0: 7920 315c 6e22 0a20 2020 2020 2020 2020  y 1\n".         
-0001c7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c7d0: 2020 2022 7365 7420 6267 436f 6c6f 7220     "set bgColor 
-0001c7e0: 6c69 6768 7420 6772 6179 2220 2b20 275c  light gray" + '\
-0001c7f0: 6e27 0a20 2020 2020 2020 2020 2020 2020  n'.             
-0001c800: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0001c810: 7669 6577 2063 6f66 7220 5472 7565 205c  view cofr True \
-0001c820: 6e22 0a20 2020 2020 2020 2020 2020 2020  n".             
-0001c830: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0001c840: 7361 7665 2022 202b 2073 7472 2870 7265  save " + str(pre
-0001c850: 6669 7829 202b 2022 5f61 7373 656d 626c  fix) + "_assembl
-0001c860: 655f 7a73 7572 6661 6365 2e6a 7065 6722  e_zsurface.jpeg"
-0001c870: 202b 2022 2073 7570 6572 7361 6d70 6c65   + " supersample
-0001c880: 2033 2077 6964 7468 2031 3230 3020 6865   3 width 1200 he
-0001c890: 6967 6874 2031 3230 3022 202b 2027 5c6e  ight 1200" + '\n
-0001c8a0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0001c8b0: 2020 2020 2020 2020 2020 2020 2020 2274                "t
-0001c8c0: 7572 6e20 7820 2d39 3022 202b 2027 5c6e  urn x -90" + '\n
-0001c8d0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0001c8e0: 2020 2020 2020 2020 2020 2020 2020 2274                "t
-0001c8f0: 7572 6e20 7920 2d39 3022 202b 2027 5c6e  urn y -90" + '\n
-0001c900: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0001c910: 2020 2020 2020 2020 2020 2020 2020 2276                "v
-0001c920: 6965 7720 636f 6672 2054 7275 6522 202b  iew cofr True" +
-0001c930: 2027 5c6e 270a 2020 2020 2020 2020 2020   '\n'.          
-0001c940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c950: 2020 2273 6176 6520 2220 2b20 7374 7228    "save " + str(
-0001c960: 7072 6566 6978 2920 2b20 225f 6173 7365  prefix) + "_asse
-0001c970: 6d62 6c65 5f78 7375 7266 6163 652e 6a70  mble_xsurface.jp
-0001c980: 6567 2220 2b20 2220 7375 7065 7273 616d  eg" + " supersam
-0001c990: 706c 6520 3320 7769 6474 6820 3132 3030  ple 3 width 1200
-0001c9a0: 2068 6569 6768 7420 3132 3030 2220 2b20   height 1200" + 
-0001c9b0: 275c 6e27 0a20 2020 2020 2020 2020 2020  '\n'.           
-0001c9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c9d0: 2022 7669 6577 206f 7269 656e 7422 202b   "view orient" +
-0001c9e0: 2027 5c6e 270a 2020 2020 2020 2020 2020   '\n'.          
-0001c9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ca00: 2020 2274 7572 6e20 7820 3930 2220 2b20    "turn x 90" + 
-0001ca10: 275c 6e27 0a20 2020 2020 2020 2020 2020  '\n'.           
-0001ca20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ca30: 2022 7475 726e 207a 2039 3022 202b 2027   "turn z 90" + '
-0001ca40: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
-0001ca50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ca60: 2276 6965 7720 636f 6672 2054 7275 6522  "view cofr True"
-0001ca70: 202b 2027 5c6e 270a 2020 2020 2020 2020   + '\n'.        
-0001ca80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ca90: 2020 2020 2273 6176 6520 2220 2b20 7374      "save " + st
-0001caa0: 7228 7072 6566 6978 2920 2b20 225f 6173  r(prefix) + "_as
-0001cab0: 7365 6d62 6c65 5f79 7375 7266 6163 652e  semble_ysurface.
-0001cac0: 6a70 6567 2220 2b20 2220 7375 7065 7273  jpeg" + " supers
-0001cad0: 616d 706c 6520 3320 7769 6474 6820 3132  ample 3 width 12
-0001cae0: 3030 2068 6569 6768 7420 3132 3030 2220  00 height 1200" 
-0001caf0: 2b20 275c 6e27 0a20 2020 2020 2020 2020  + '\n'.         
-0001cb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cb10: 2020 2022 636c 6f73 6520 616c 6c22 202b     "close all" +
-0001cb20: 2022 5c6e 220a 2020 2020 2020 2020 2020   "\n".          
-0001cb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cb40: 2020 2265 7869 7422 202b 2027 5c6e 270a    "exit" + '\n'.
-0001cb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cb60: 2020 2020 2020 2020 290a 0a0a 2020 2020          )...    
-0001cb70: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-0001cb80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001cb90: 2020 2020 2069 6620 6e6f 7420 6269 6e64       if not bind
-0001cba0: 6973 706c 6179 3a0a 2020 2020 2020 2020  isplay:.        
-0001cbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cbc0: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
-0001cbd0: 5f63 616c 6c28 6c6f 6343 4849 4d45 5241  _call(locCHIMERA
-0001cbe0: 202b 2022 202d 2d6f 6666 7363 7265 656e   + " --offscreen
-0001cbf0: 202d 2d6e 6f67 7569 2022 202b 2073 656c   --nogui " + sel
-0001cc00: 662e 776f 726b 6469 7220 2b20 6368 696d  f.workdir + chim
-0001cc10: 6572 6163 6d64 2c0a 2020 2020 2020 2020  eracmd,.        
-0001cc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cc40: 2020 2020 2020 6377 643d 7365 6c66 2e77        cwd=self.w
-0001cc50: 6f72 6b64 6972 2c20 7368 656c 6c3d 5472  orkdir, shell=Tr
-0001cc60: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
-0001cc70: 2020 2020 2020 2020 2020 2020 6966 2061              if a
-0001cc80: 7373 656d 626c 653a 0a20 2020 2020 2020  ssemble:.       
-0001cc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cca0: 2020 2020 2073 7562 7072 6f63 6573 732e       subprocess.
-0001ccb0: 6368 6563 6b5f 6361 6c6c 286c 6f63 4348  check_call(locCH
-0001ccc0: 494d 4552 4120 2b20 2220 2d2d 6f66 6673  IMERA + " --offs
-0001ccd0: 6372 6565 6e20 2d2d 6e6f 6775 6920 2220  creen --nogui " 
-0001cce0: 2b20 7365 6c66 2e77 6f72 6b64 6972 202b  + self.workdir +
-0001ccf0: 2063 6869 6d65 7261 636d 6461 7373 656d   chimeracmdassem
-0001cd00: 626c 652c 0a20 2020 2020 2020 2020 2020  ble,.           
-0001cd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cd30: 2020 2020 2020 2063 7764 3d73 656c 662e         cwd=self.
-0001cd40: 776f 726b 6469 722c 2073 6865 6c6c 3d54  workdir, shell=T
-0001cd50: 7275 6529 0a20 2020 2020 2020 2020 2020  rue).           
-0001cd60: 2020 2020 2020 2020 2020 2020 206e 656e               nen
-0001cd70: 6420 3d20 7469 6d65 6974 2e64 6566 6175  d = timeit.defau
-0001cd80: 6c74 5f74 696d 6572 2829 0a20 2020 2020  lt_timer().     
-0001cd90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cda0: 2020 2070 7269 6e74 2827 5072 696d 6172     print('Primar
-0001cdb0: 7920 6d61 7020 616e 6420 6d6f 6465 6c20  y map and model 
-0001cdc0: 7669 6577 2074 696d 653a 2025 7327 2025  view time: %s' %
-0001cdd0: 2028 6e65 6e64 202d 206e 7374 6172 7429   (nend - nstart)
-0001cde0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001cdf0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-0001ce00: 272d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  '---------------
-0001ce10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0001ce20: 2d2d 2d2d 2d27 290a 2020 2020 2020 2020  -----').        
-0001ce30: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0001ce40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001ce50: 2020 2020 2020 2020 2020 7375 6270 726f            subpro
-0001ce60: 6365 7373 2e63 6865 636b 5f63 616c 6c28  cess.check_call(
-0001ce70: 6c6f 6343 4849 4d45 5241 202b 2022 2022  locCHIMERA + " "
-0001ce80: 202b 2073 656c 662e 776f 726b 6469 7220   + self.workdir 
-0001ce90: 2b20 6368 696d 6572 6163 6d64 2c20 6377  + chimeracmd, cw
-0001cea0: 643d 7365 6c66 2e77 6f72 6b64 6972 2c20  d=self.workdir, 
-0001ceb0: 7368 656c 6c3d 5472 7565 290a 2020 2020  shell=True).    
-0001cec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ced0: 2020 2020 6966 2061 7373 656d 626c 653a      if assemble:
-0001cee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001cef0: 2020 2020 2020 2020 2020 2020 2073 7562               sub
-0001cf00: 7072 6f63 6573 732e 6368 6563 6b5f 6361  process.check_ca
-0001cf10: 6c6c 286c 6f63 4348 494d 4552 4120 2b20  ll(locCHIMERA + 
-0001cf20: 2220 2220 2b20 7365 6c66 2e77 6f72 6b64  " " + self.workd
-0001cf30: 6972 202b 2063 6869 6d65 7261 636d 6461  ir + chimeracmda
-0001cf40: 7373 656d 626c 652c 0a20 2020 2020 2020  ssemble,.       
-0001cf50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cf60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cf70: 2020 2020 2020 2020 2020 2063 7764 3d73             cwd=s
-0001cf80: 656c 662e 776f 726b 6469 722c 2073 6865  elf.workdir, she
-0001cf90: 6c6c 3d54 7275 6529 0a20 2020 2020 2020  ll=True).       
-0001cfa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cfb0: 206e 656e 6420 3d20 7469 6d65 6974 2e64   nend = timeit.d
-0001cfc0: 6566 6175 6c74 5f74 696d 6572 2829 0a20  efault_timer(). 
-0001cfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cfe0: 2020 2020 2020 2070 7269 6e74 2827 5072         print('Pr
-0001cff0: 696d 6172 7920 6d61 7020 616e 6420 6d6f  imary map and mo
-0001d000: 6465 6c20 7669 6577 2074 696d 653a 2025  del view time: %
-0001d010: 7327 2025 2028 6e65 6e64 202d 206e 7374  s' % (nend - nst
-0001d020: 6172 7429 290a 2020 2020 2020 2020 2020  art)).          
-0001d030: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-0001d040: 696e 7428 272d 2d2d 2d2d 2d2d 2d2d 2d2d  int('-----------
-0001d050: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0001d060: 2d2d 2d2d 2d2d 2d2d 2d27 290a 0a20 2020  ---------')..   
-0001d070: 2020 2020 2020 2020 2020 2020 2065 7863               exc
-0001d080: 6570 7420 7375 6270 726f 6365 7373 2e43  ept subprocess.C
-0001d090: 616c 6c65 6450 726f 6365 7373 4572 726f  alledProcessErro
-0001d0a0: 7220 6173 2073 7562 6572 723a 0a20 2020  r as suberr:.   
-0001d0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d0c0: 2065 7272 203d 2027 5361 7669 6e67 206d   err = 'Saving m
-0001d0d0: 6f64 656c 207b 7d20 616e 6420 6d61 7020  odel {} and map 
-0001d0e0: 6572 723a 207b 7d27 2e66 6f72 6d61 7428  err: {}'.format(
-0001d0f0: 7374 7228 6d6f 6465 6c2e 6669 6c65 6e61  str(model.filena
-0001d100: 6d65 292c 2073 7562 6572 7229 0a20 2020  me), suberr).   
-0001d110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d120: 206d 6d65 7272 6c69 7374 2e61 7070 656e   mmerrlist.appen
-0001d130: 6428 6572 7229 0a20 2020 2020 2020 2020  d(err).         
-0001d140: 2020 2020 2020 2020 2020 2073 7973 2e73             sys.s
-0001d150: 7464 6572 722e 7772 6974 6528 6572 7220  tderr.write(err 
-0001d160: 2b20 275c 6e27 290a 0a20 2020 2020 2020  + '\n')..       
-0001d170: 2070 7269 6e74 2827 5375 7266 6163 6520   print('Surface 
-0001d180: 7669 6577 7320 7765 7265 2067 656e 6572  views were gener
-0001d190: 6174 6564 2062 7920 4368 696d 6572 6158  ated by ChimeraX
-0001d1a0: 2729 0a20 2020 2020 2020 2074 7279 3a0a  ').        try:.
-0001d1b0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0001d1c0: 2e73 6361 6c65 5f73 7572 6661 6365 7669  .scale_surfacevi
-0001d1d0: 6577 2829 0a20 2020 2020 2020 2065 7863  ew().        exc
-0001d1e0: 6570 743a 0a20 2020 2020 2020 2020 2020  ept:.           
-0001d1f0: 2065 7272 203d 2027 5363 616c 696e 6720   err = 'Scaling 
-0001d200: 7468 6520 7375 7266 6163 6520 7669 6577  the surface view
-0001d210: 7320 6572 723a 207b 7d27 2e66 6f72 6d61  s err: {}'.forma
-0001d220: 7428 7379 732e 6578 635f 696e 666f 2829  t(sys.exc_info()
-0001d230: 5b31 5d29 0a20 2020 2020 2020 2020 2020  [1]).           
-0001d240: 2065 7272 6c69 7374 2e61 7070 656e 6428   errlist.append(
-0001d250: 6572 7229 0a20 2020 2020 2020 2020 2020  err).           
-0001d260: 206d 6d65 7272 6c69 7374 2e61 7070 656e   mmerrlist.appen
-0001d270: 6428 6572 7229 0a20 2020 2020 2020 2020  d(err).         
-0001d280: 2020 2073 7973 2e73 7464 6572 722e 7772     sys.stderr.wr
-0001d290: 6974 6528 6572 7220 2b20 275c 6e27 290a  ite(err + '\n').
-0001d2a0: 0a20 2020 2020 2020 2073 7572 6661 6365  .        surface
-0001d2b0: 7669 6577 6a73 6f6e 203d 2064 6963 7428  viewjson = dict(
-0001d2c0: 290a 2020 2020 2020 2020 6f75 746d 6170  ).        outmap
-0001d2d0: 7869 6d61 6765 203d 2073 7472 2873 656c  ximage = str(sel
-0001d2e0: 662e 6d61 706e 616d 6529 202b 2027 5f78  f.mapname) + '_x
-0001d2f0: 7375 7266 6163 652e 6a70 6567 270a 2020  surface.jpeg'.  
-0001d300: 2020 2020 2020 6d61 7078 6c69 7374 203d        mapxlist =
-0001d310: 206f 7574 6d61 7078 696d 6167 652e 7370   outmapximage.sp
-0001d320: 6c69 7428 275f 2729 0a20 2020 2020 2020  lit('_').       
-0001d330: 206d 6170 7873 6361 6c65 696d 6167 6520   mapxscaleimage 
-0001d340: 3d20 275f 272e 6a6f 696e 286d 6170 786c  = '_'.join(mapxl
-0001d350: 6973 745b 3a2d 315d 2920 2b20 275f 7363  ist[:-1]) + '_sc
-0001d360: 616c 6564 5f27 202b 206d 6170 786c 6973  aled_' + mapxlis
-0001d370: 745b 2d31 5d0a 2020 2020 2020 2020 7375  t[-1].        su
-0001d380: 7266 6163 6576 6965 776a 736f 6e5b 2778  rfaceviewjson['x
-0001d390: 275d 203d 206f 732e 7061 7468 2e62 6173  '] = os.path.bas
-0001d3a0: 656e 616d 6528 6d61 7078 7363 616c 6569  ename(mapxscalei
-0001d3b0: 6d61 6765 2920 6966 206f 732e 7061 7468  mage) if os.path
-0001d3c0: 2e69 7366 696c 6528 7365 6c66 2e77 6f72  .isfile(self.wor
-0001d3d0: 6b64 6972 202b 206d 6170 7873 6361 6c65  kdir + mapxscale
-0001d3e0: 696d 6167 6529 2065 6c73 6520 4e6f 6e65  image) else None
-0001d3f0: 0a0a 2020 2020 2020 2020 6f75 746d 6170  ..        outmap
-0001d400: 7969 6d61 6765 203d 2073 7472 2873 656c  yimage = str(sel
-0001d410: 662e 6d61 706e 616d 6529 202b 2027 5f79  f.mapname) + '_y
-0001d420: 7375 7266 6163 652e 6a70 6567 270a 2020  surface.jpeg'.  
-0001d430: 2020 2020 2020 6d61 7079 6c69 7374 203d        mapylist =
-0001d440: 206f 7574 6d61 7079 696d 6167 652e 7370   outmapyimage.sp
-0001d450: 6c69 7428 275f 2729 0a20 2020 2020 2020  lit('_').       
-0001d460: 206d 6170 7973 6361 6c65 696d 6167 6520   mapyscaleimage 
-0001d470: 3d20 275f 272e 6a6f 696e 286d 6170 796c  = '_'.join(mapyl
-0001d480: 6973 745b 3a2d 315d 2920 2b20 275f 7363  ist[:-1]) + '_sc
-0001d490: 616c 6564 5f27 202b 206d 6170 796c 6973  aled_' + mapylis
-0001d4a0: 745b 2d31 5d0a 2020 2020 2020 2020 7375  t[-1].        su
-0001d4b0: 7266 6163 6576 6965 776a 736f 6e5b 2779  rfaceviewjson['y
-0001d4c0: 275d 203d 206f 732e 7061 7468 2e62 6173  '] = os.path.bas
-0001d4d0: 656e 616d 6528 6d61 7079 7363 616c 6569  ename(mapyscalei
-0001d4e0: 6d61 6765 2920 6966 206f 732e 7061 7468  mage) if os.path
-0001d4f0: 2e69 7366 696c 6528 7365 6c66 2e77 6f72  .isfile(self.wor
-0001d500: 6b64 6972 202b 206d 6170 7973 6361 6c65  kdir + mapyscale
-0001d510: 696d 6167 6529 2065 6c73 6520 4e6f 6e65  image) else None
-0001d520: 0a0a 2020 2020 2020 2020 6f75 746d 6170  ..        outmap
-0001d530: 7a69 6d61 6765 203d 2073 7472 2873 656c  zimage = str(sel
-0001d540: 662e 6d61 706e 616d 6529 202b 2027 5f7a  f.mapname) + '_z
-0001d550: 7375 7266 6163 652e 6a70 6567 270a 2020  surface.jpeg'.  
-0001d560: 2020 2020 2020 6d61 707a 6c69 7374 203d        mapzlist =
-0001d570: 206f 7574 6d61 707a 696d 6167 652e 7370   outmapzimage.sp
-0001d580: 6c69 7428 275f 2729 0a20 2020 2020 2020  lit('_').       
-0001d590: 206d 6170 7a73 6361 6c65 696d 6167 6520   mapzscaleimage 
-0001d5a0: 3d20 275f 272e 6a6f 696e 286d 6170 7a6c  = '_'.join(mapzl
-0001d5b0: 6973 745b 3a2d 315d 2920 2b20 275f 7363  ist[:-1]) + '_sc
-0001d5c0: 616c 6564 5f27 202b 206d 6170 7a6c 6973  aled_' + mapzlis
-0001d5d0: 745b 2d31 5d0a 2020 2020 2020 2020 7375  t[-1].        su
-0001d5e0: 7266 6163 6576 6965 776a 736f 6e5b 277a  rfaceviewjson['z
-0001d5f0: 275d 203d 206f 732e 7061 7468 2e62 6173  '] = os.path.bas
-0001d600: 656e 616d 6528 6d61 707a 7363 616c 6569  ename(mapzscalei
-0001d610: 6d61 6765 2920 6966 206f 732e 7061 7468  mage) if os.path
-0001d620: 2e69 7366 696c 6528 7365 6c66 2e77 6f72  .isfile(self.wor
-0001d630: 6b64 6972 202b 206d 6170 7a73 6361 6c65  kdir + mapzscale
-0001d640: 696d 6167 6529 2065 6c73 6520 4e6f 6e65  image) else None
-0001d650: 0a20 2020 2020 2020 2069 6620 6572 726c  .        if errl
-0001d660: 6973 743a 0a20 2020 2020 2020 2020 2020  ist:.           
-0001d670: 2073 7572 6661 6365 7669 6577 6a73 6f6e   surfaceviewjson
-0001d680: 5b27 6572 7227 5d20 3d20 7b27 6d61 705f  ['err'] = {'map_
-0001d690: 7375 7266 6163 655f 6572 7227 3a20 6572  surface_err': er
-0001d6a0: 726c 6973 747d 0a0a 2020 2020 2020 2020  rlist}..        
-0001d6b0: 6669 6e61 6c64 6963 7420 3d20 7b27 6d61  finaldict = {'ma
-0001d6c0: 705f 7375 7266 6163 6527 3a20 7375 7266  p_surface': surf
-0001d6d0: 6163 6576 6965 776a 736f 6e7d 0a0a 2020  aceviewjson}..  
-0001d6e0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0001d6f0: 2020 2020 2020 2077 6974 6820 636f 6465         with code
-0001d700: 6373 2e6f 7065 6e28 7365 6c66 2e77 6f72  cs.open(self.wor
-0001d710: 6b64 6972 202b 2073 656c 662e 6d61 706e  kdir + self.mapn
-0001d720: 616d 6520 2b20 275f 6d61 7073 7572 6661  ame + '_mapsurfa
-0001d730: 6365 7669 6577 2e6a 736f 6e27 2c20 2777  ceview.json', 'w
-0001d740: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-0001d750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d760: 656e 636f 6469 6e67 3d27 7574 662d 3827  encoding='utf-8'
-0001d770: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
-0001d780: 2020 2020 2020 2020 6a73 6f6e 2e64 756d          json.dum
-0001d790: 7028 6669 6e61 6c64 6963 742c 2066 290a  p(finaldict, f).
-0001d7a0: 2020 2020 2020 2020 6578 6365 7074 3a0a          except:.
-0001d7b0: 2020 2020 2020 2020 2020 2020 6572 7220              err 
-0001d7c0: 3d20 2753 6176 696e 6720 6d61 7020 7375  = 'Saving map su
-0001d7d0: 7266 6163 6520 7669 6577 206a 736f 6e20  rface view json 
-0001d7e0: 6572 726f 723a 207b 7d2e 272e 666f 726d  error: {}.'.form
-0001d7f0: 6174 2873 7973 2e65 7863 5f69 6e66 6f28  at(sys.exc_info(
-0001d800: 295b 315d 290a 2020 2020 2020 2020 2020  )[1]).          
-0001d810: 2020 7379 732e 7374 6465 7272 2e77 7269    sys.stderr.wri
-0001d820: 7465 2865 7272 202b 2027 5c6e 2729 0a0a  te(err + '\n')..
-0001d830: 2020 2020 2020 2020 6a70 6567 7320 3d20          jpegs = 
-0001d840: 676c 6f62 2e67 6c6f 6228 7365 6c66 2e77  glob.glob(self.w
-0001d850: 6f72 6b64 6972 202b 2027 2f2a 7375 7266  orkdir + '/*surf
-0001d860: 6163 652e 6a70 6567 2729 0a20 2020 2020  ace.jpeg').     
-0001d870: 2020 206d 6f64 656c 7375 7266 203d 2064     modelsurf = d
-0001d880: 6963 7428 290a 2020 2020 2020 2020 6669  ict().        fi
-0001d890: 6e61 6c6d 6d64 6963 7420 3d20 6469 6374  nalmmdict = dict
-0001d8a0: 2829 0a20 2020 2020 2020 2069 6620 7365  ().        if se
-0001d8b0: 6c66 2e6d 6f64 656c 733a 0a20 2020 2020  lf.models:.     
-0001d8c0: 2020 2020 2020 2023 2070 7269 6e74 2022         # print "
-0001d8d0: 7365 6c66 2e6d 6f64 656c 733a 2573 2220  self.models:%s" 
-0001d8e0: 2520 7365 6c66 2e6d 6f64 656c 730a 2020  % self.models.  
-0001d8f0: 2020 2020 2020 2020 2020 666f 7220 6d6f            for mo
-0001d900: 6465 6c20 696e 2073 656c 662e 6d6f 6465  del in self.mode
-0001d910: 6c73 3a0a 2020 2020 2020 2020 2020 2020  ls:.            
-0001d920: 2020 2020 6d6f 6465 6c6e 616d 6520 3d20      modelname = 
-0001d930: 6f73 2e70 6174 682e 6261 7365 6e61 6d65  os.path.basename
-0001d940: 286d 6f64 656c 2e66 696c 656e 616d 6529  (model.filename)
-0001d950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001d960: 2073 7572 6661 6365 666e 203d 2027 7b7d   surfacefn = '{}
-0001d970: 5f7b 7d27 2e66 6f72 6d61 7428 6d6f 6465  _{}'.format(mode
-0001d980: 6c6e 616d 652c 2073 656c 662e 6d61 706e  lname, self.mapn
-0001d990: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
-0001d9a0: 2020 2020 206d 6f64 656c 6d61 7073 7572       modelmapsur
-0001d9b0: 6661 6365 203d 2064 6963 7428 290a 2020  face = dict().  
-0001d9c0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0001d9d0: 7220 6a70 6567 2069 6e20 6a70 6567 733a  r jpeg in jpegs:
-0001d9e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001d9f0: 2020 2020 2069 6620 6d6f 6465 6c6e 616d       if modelnam
-0001da00: 6520 696e 206a 7065 6720 616e 6420 2778  e in jpeg and 'x
-0001da10: 7375 7266 6163 6527 2069 6e20 6a70 6567  surface' in jpeg
-0001da20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001da30: 2020 2020 2020 2020 2020 6d6f 6465 6c6d            modelm
-0001da40: 6170 7375 7266 6163 655b 2778 275d 203d  apsurface['x'] =
-0001da50: 2073 7472 2873 7572 6661 6365 666e 2920   str(surfacefn) 
-0001da60: 2b20 275f 7363 616c 6564 5f78 7375 7266  + '_scaled_xsurf
-0001da70: 6163 652e 6a70 6567 270a 2020 2020 2020  ace.jpeg'.      
-0001da80: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0001da90: 206d 6f64 656c 6e61 6d65 2069 6e20 6a70   modelname in jp
-0001daa0: 6567 2061 6e64 2027 7973 7572 6661 6365  eg and 'ysurface
-0001dab0: 2720 696e 206a 7065 673a 0a20 2020 2020  ' in jpeg:.     
-0001dac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dad0: 2020 206d 6f64 656c 6d61 7073 7572 6661     modelmapsurfa
-0001dae0: 6365 5b27 7927 5d20 3d20 7374 7228 7375  ce['y'] = str(su
-0001daf0: 7266 6163 6566 6e29 202b 2027 5f73 6361  rfacefn) + '_sca
-0001db00: 6c65 645f 7973 7572 6661 6365 2e6a 7065  led_ysurface.jpe
-0001db10: 6727 0a20 2020 2020 2020 2020 2020 2020  g'.             
-0001db20: 2020 2020 2020 2069 6620 6d6f 6465 6c6e         if modeln
-0001db30: 616d 6520 696e 206a 7065 6720 616e 6420  ame in jpeg and 
-0001db40: 277a 7375 7266 6163 6527 2069 6e20 6a70  'zsurface' in jp
-0001db50: 6567 3a0a 2020 2020 2020 2020 2020 2020  eg:.            
-0001db60: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
-0001db70: 6c6d 6170 7375 7266 6163 655b 277a 275d  lmapsurface['z']
-0001db80: 203d 2073 7472 2873 7572 6661 6365 666e   = str(surfacefn
-0001db90: 2920 2b20 275f 7363 616c 6564 5f7a 7375  ) + '_scaled_zsu
-0001dba0: 7266 6163 652e 6a70 6567 270a 0a20 2020  rface.jpeg'..   
-0001dbb0: 2020 2020 2020 2020 2020 2020 2077 6974               wit
-0001dbc0: 6820 6f70 656e 2873 7472 286d 6f64 656c  h open(str(model
-0001dbd0: 2e66 696c 656e 616d 6529 2920 6173 2066  .filename)) as f
-0001dbe0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001dbf0: 2020 2020 2020 7320 3d20 6d6d 6170 2e6d        s = mmap.m
-0001dc00: 6d61 7028 662e 6669 6c65 6e6f 2829 2c20  map(f.fileno(), 
-0001dc10: 302c 2061 6363 6573 733d 6d6d 6170 2e41  0, access=mmap.A
-0001dc20: 4343 4553 535f 5245 4144 290a 2020 2020  CCESS_READ).    
-0001dc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dc40: 2320 7079 7468 6f6e 2033 206d 6d61 702e  # python 3 mmap.
-0001dc50: 6d6d 6170 2866 696c 652e 6669 6c65 6e6f  mmap(file.fileno
-0001dc60: 2829 2c20 302c 2061 6363 6573 733d 6d6d  (), 0, access=mm
-0001dc70: 6170 2e41 4343 4553 535f 5245 4144 2920  ap.ACCESS_READ) 
-0001dc80: 6173 2073 3a0a 2020 2020 2020 2020 2020  as s:.          
-0001dc90: 2020 2020 2020 2020 2020 6966 2073 2e66            if s.f
-0001dca0: 696e 6428 6227 706f 696e 7420 7379 6d6d  ind(b'point symm
-0001dcb0: 6574 7279 206f 7065 7261 7469 6f6e 2729  etry operation')
-0001dcc0: 2021 3d20 2d31 3a0a 2020 2020 2020 2020   != -1:.        
-0001dcd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dce0: 6173 7365 6d62 6c65 203d 2054 7275 650a  assemble = True.
-0001dcf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dd00: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0001dd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dd20: 2020 6173 7365 6d62 6c65 203d 2046 616c    assemble = Fal
-0001dd30: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
-0001dd40: 2020 2061 7373 656d 626c 656d 6170 7375     assemblemapsu
-0001dd50: 7266 6163 6520 3d20 6469 6374 2829 0a20  rface = dict(). 
-0001dd60: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0001dd70: 6620 6173 7365 6d62 6c65 3a0a 2020 2020  f assemble:.    
-0001dd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dd90: 6d6f 6465 6c6e 616d 6520 3d20 6f73 2e70  modelname = os.p
-0001dda0: 6174 682e 6261 7365 6e61 6d65 286d 6f64  ath.basename(mod
-0001ddb0: 656c 2e66 696c 656e 616d 6529 0a20 2020  el.filename).   
+0001c200: 2274 7572 6e20 7a20 3930 2220 2b20 275c  "turn z 90" + '\
+0001c210: 6e27 0a20 2020 2020 2020 2020 2020 2020  n'.             
+0001c220: 2020 2022 7669 6577 2063 6f66 7220 5472     "view cofr Tr
+0001c230: 7565 2220 2b20 275c 6e27 0a20 2020 2020  ue" + '\n'.     
+0001c240: 2020 2020 2020 2020 2020 2022 7361 7665             "save
+0001c250: 2022 202b 2073 7472 2873 656c 662e 6d61   " + str(self.ma
+0001c260: 706e 616d 6529 202b 2022 5f79 7375 7266  pname) + "_ysurf
+0001c270: 6163 652e 6a70 6567 2220 2b20 2220 7375  ace.jpeg" + " su
+0001c280: 7065 7273 616d 706c 6520 3320 7769 6474  persample 3 widt
+0001c290: 6820 3132 3030 2068 6569 6768 7420 3132  h 1200 height 12
+0001c2a0: 3030 2220 2b20 275c 6e27 0a20 2020 2020  00" + '\n'.     
+0001c2b0: 2020 2020 2020 2020 2020 2022 636c 6f73             "clos
+0001c2c0: 6520 616c 6c22 202b 2022 5c6e 220a 2020  e all" + "\n".  
+0001c2d0: 2020 2020 2020 2020 2020 2020 2020 2265                "e
+0001c2e0: 7869 7422 202b 2027 5c6e 270a 2020 2020  xit" + '\n'.    
+0001c2f0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+0001c300: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0001c310: 2020 2020 6966 206e 6f74 2062 696e 6469      if not bindi
+0001c320: 7370 6c61 793a 0a20 2020 2020 2020 2020  splay:.         
+0001c330: 2020 2020 2020 2073 7562 7072 6f63 6573         subproces
+0001c340: 732e 6368 6563 6b5f 6361 6c6c 286c 6f63  s.check_call(loc
+0001c350: 4348 494d 4552 4120 2b20 2220 2d2d 6f66  CHIMERA + " --of
+0001c360: 6673 6372 6565 6e20 2d2d 6e6f 6775 6920  fscreen --nogui 
+0001c370: 2220 2b20 7365 6c66 2e77 6f72 6b64 6972  " + self.workdir
+0001c380: 202b 206d 6170 6368 696d 6572 6163 6d64   + mapchimeracmd
+0001c390: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001c3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c3b0: 2020 2020 2020 2020 2020 6377 643d 7365            cwd=se
+0001c3c0: 6c66 2e77 6f72 6b64 6972 2c20 7368 656c  lf.workdir, shel
+0001c3d0: 6c3d 5472 7565 290a 2020 2020 2020 2020  l=True).        
+0001c3e0: 2020 2020 2020 2020 656e 6420 3d20 7469          end = ti
+0001c3f0: 6d65 6974 2e64 6566 6175 6c74 5f74 696d  meit.default_tim
+0001c400: 6572 2829 0a20 2020 2020 2020 2020 2020  er().           
+0001c410: 2020 2020 2070 7269 6e74 2827 5072 696d       print('Prim
+0001c420: 6172 7920 6d61 7020 7375 7266 6163 6520  ary map surface 
+0001c430: 7669 6577 2074 696d 653a 2025 7327 2025  view time: %s' %
+0001c440: 2028 656e 6420 2d20 7374 6172 7429 290a   (end - start)).
+0001c450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c460: 7072 696e 7428 272d 2d2d 2d2d 2d2d 2d2d  print('---------
+0001c470: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0001c480: 2d2d 2d2d 2d2d 2d2d 2d2d 2d27 290a 2020  -----------').  
+0001c490: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0001c4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c4b0: 7375 6270 726f 6365 7373 2e63 6865 636b  subprocess.check
+0001c4c0: 5f63 616c 6c28 6c6f 6343 4849 4d45 5241  _call(locCHIMERA
+0001c4d0: 202b 2022 2022 202b 2073 656c 662e 776f   + " " + self.wo
+0001c4e0: 726b 6469 7220 2b20 6d61 7063 6869 6d65  rkdir + mapchime
+0001c4f0: 7261 636d 642c 2063 7764 3d73 656c 662e  racmd, cwd=self.
+0001c500: 776f 726b 6469 722c 2073 6865 6c6c 3d54  workdir, shell=T
+0001c510: 7275 6529 0a20 2020 2020 2020 2020 2020  rue).           
+0001c520: 2020 2020 2065 6e64 203d 2074 696d 6569       end = timei
+0001c530: 742e 6465 6661 756c 745f 7469 6d65 7228  t.default_timer(
+0001c540: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001c550: 2020 7072 696e 7428 2750 7269 6d61 7279    print('Primary
+0001c560: 206d 6170 2073 7572 6661 6365 2076 6965   map surface vie
+0001c570: 7720 7469 6d65 3a20 2573 2720 2520 2865  w time: %s' % (e
+0001c580: 6e64 202d 2073 7461 7274 2929 0a20 2020  nd - start)).   
+0001c590: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+0001c5a0: 6e74 2827 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  nt('------------
+0001c5b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0001c5c0: 2d2d 2d2d 2d2d 2d2d 2729 0a20 2020 2020  --------').     
+0001c5d0: 2020 2065 7863 6570 7420 7375 6270 726f     except subpro
+0001c5e0: 6365 7373 2e43 616c 6c65 6450 726f 6365  cess.CalledProce
+0001c5f0: 7373 4572 726f 7220 6173 2073 7562 6572  ssError as suber
+0001c600: 723a 0a20 2020 2020 2020 2020 2020 2065  r:.            e
+0001c610: 6e64 203d 2074 696d 6569 742e 6465 6661  nd = timeit.defa
+0001c620: 756c 745f 7469 6d65 7228 290a 2020 2020  ult_timer().    
+0001c630: 2020 2020 2020 2020 6572 7220 3d20 2750          err = 'P
+0001c640: 7269 6d61 7279 206d 6170 2073 7572 6661  rimary map surfa
+0001c650: 6365 2076 6965 7720 6279 2043 6869 6d65  ce view by Chime
+0001c660: 7261 5820 6572 726f 723a 207b 7d27 2e66  raX error: {}'.f
+0001c670: 6f72 6d61 7428 7375 6265 7272 290a 2020  ormat(suberr).  
+0001c680: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0001c690: 2750 7269 6d61 7279 206d 6170 2073 7572  'Primary map sur
+0001c6a0: 6661 6365 2076 6965 7720 7469 6d65 3a20  face view time: 
+0001c6b0: 2573 2720 2520 2865 6e64 202d 2073 7461  %s' % (end - sta
+0001c6c0: 7274 2929 0a20 2020 2020 2020 2020 2020  rt)).           
+0001c6d0: 2070 7269 6e74 2827 2d2d 2d2d 2d2d 2d2d   print('--------
+0001c6e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0001c6f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2729 0a20  ------------'). 
+0001c700: 2020 2020 2020 2020 2020 2065 7272 6c69             errli
+0001c710: 7374 2e61 7070 656e 6428 6572 7229 0a20  st.append(err). 
+0001c720: 2020 2020 2020 2020 2020 2073 7973 2e73             sys.s
+0001c730: 7464 6572 722e 7772 6974 6528 6572 7220  tderr.write(err 
+0001c740: 2b20 275c 6e27 290a 0a0a 2020 2020 2020  + '\n')...      
+0001c750: 2020 2320 6d61 7020 616e 6420 6d6f 6465    # map and mode
+0001c760: 6c73 2076 6965 7720 746f 6765 7468 6572  ls view together
+0001c770: 0a20 2020 2020 2020 206e 7374 6172 7420  .        nstart 
+0001c780: 3d20 7469 6d65 6974 2e64 6566 6175 6c74  = timeit.default
+0001c790: 5f74 696d 6572 2829 0a20 2020 2020 2020  _timer().       
+0001c7a0: 2069 6620 7365 6c66 2e6d 6f64 656c 733a   if self.models:
+0001c7b0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+0001c7c0: 206d 6f64 656c 2069 6e20 7365 6c66 2e6d   model in self.m
+0001c7d0: 6f64 656c 733a 0a20 2020 2020 2020 2020  odels:.         
+0001c7e0: 2020 2020 2020 2023 2070 6462 6964 203d         # pdbid =
+0001c7f0: 206d 6f64 656c 2e66 696c 656e 616d 652e   model.filename.
+0001c800: 7370 6c69 7428 272f 2729 5b2d 315d 2e73  split('/')[-1].s
+0001c810: 706c 6974 2827 2e27 295b 305d 0a20 2020  plit('.')[0].   
+0001c820: 2020 2020 2020 2020 2020 2020 2070 6462               pdb
+0001c830: 6964 203d 206f 732e 7061 7468 2e62 6173  id = os.path.bas
+0001c840: 656e 616d 6528 6d6f 6465 6c2e 6669 6c65  ename(model.file
+0001c850: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
+0001c860: 2020 2020 2020 7375 7266 6163 6566 6e20        surfacefn 
+0001c870: 3d20 277b 7d5f 7b7d 272e 666f 726d 6174  = '{}_{}'.format
+0001c880: 2870 6462 6964 2c20 7365 6c66 2e6d 6170  (pdbid, self.map
+0001c890: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
+0001c8a0: 2020 2020 2020 6368 696d 6572 6163 6d64        chimeracmd
+0001c8b0: 203d 2073 7572 6661 6365 666e 202b 2027   = surfacefn + '
+0001c8c0: 5f63 6869 6d65 7261 2e63 7863 270a 2020  _chimera.cxc'.  
+0001c8d0: 2020 2020 2020 2020 2020 2020 2020 7769                wi
+0001c8e0: 7468 206f 7065 6e28 7365 6c66 2e77 6f72  th open(self.wor
+0001c8f0: 6b64 6972 202b 2063 6869 6d65 7261 636d  kdir + chimeracm
+0001c900: 642c 2027 7727 2920 6173 2066 3a0a 2020  d, 'w') as f:.  
+0001c910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c920: 2020 662e 7772 6974 6528 0a20 2020 2020    f.write(.     
+0001c930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c940: 2020 2023 2043 6869 6d65 7261 2076 6572     # Chimera ver
+0001c950: 7369 6f6e 0a20 2020 2020 2020 2020 2020  sion.           
+0001c960: 2020 2020 2020 2020 2020 2020 2023 2027               # '
+0001c970: 6f70 656e 2063 6370 343a 2720 2b20 7374  open ccp4:' + st
+0001c980: 7228 6d61 706e 616d 6529 202b 2027 5c6e  r(mapname) + '\n
+0001c990: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0001c9a0: 2020 2020 2020 2020 2020 2320 226f 7065            # "ope
+0001c9b0: 6e20 6369 663a 2220 2b20 7374 7228 6d6f  n cif:" + str(mo
+0001c9c0: 6465 6c2e 6669 6c65 6e61 6d65 2920 2b20  del.filename) + 
+0001c9d0: 275c 6e27 0a20 2020 2020 2020 2020 2020  '\n'.           
+0001c9e0: 2020 2020 2020 2020 2020 2020 2023 2022               # "
+0001c9f0: 766f 6c75 6d65 2023 3020 7374 796c 6520  volume #0 style 
+0001ca00: 7375 7266 6163 6520 6578 7061 6e64 5369  surface expandSi
+0001ca10: 6e67 6c65 506c 616e 6520 5472 7565 2022  nglePlane True "
+0001ca20: 202b 2027 5c6e 270a 2020 2020 2020 2020   + '\n'.        
+0001ca30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ca40: 2320 2276 6f6c 756d 6520 2330 2063 6f6c  # "volume #0 col
+0001ca50: 6f72 2023 4238 3836 3042 2073 7465 7020  or #B8860B step 
+0001ca60: 3120 2220 2b20 636f 6e74 6f75 7220 2b20  1 " + contour + 
+0001ca70: 275c 6e27 0a20 2020 2020 2020 2020 2020  '\n'.           
+0001ca80: 2020 2020 2020 2020 2020 2020 2023 2022               # "
+0001ca90: 7365 7420 7072 6f6a 6563 7469 6f6e 206f  set projection o
+0001caa0: 7274 686f 6772 6170 6869 6322 202b 2027  rthographic" + '
+0001cab0: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
+0001cac0: 2020 2020 2020 2020 2020 2020 2320 2273              # "s
+0001cad0: 7572 6674 7261 6e73 7020 3530 2220 2b20  urftransp 50" + 
+0001cae0: 275c 6e27 2020 2320 6d61 6b65 2074 6865  '\n'  # make the
+0001caf0: 2073 7572 6661 6365 2061 206c 6974 746c   surface a littl
+0001cb00: 6520 6269 7420 7365 652d 7468 726f 7567  e bit see-throug
+0001cb10: 680a 2020 2020 2020 2020 2020 2020 2020  h.              
+0001cb20: 2020 2020 2020 2020 2020 2320 2262 6163            # "bac
+0001cb30: 6b67 726f 756e 6420 736f 6c69 6420 6c69  kground solid li
+0001cb40: 6768 7420 6772 6179 2220 2b20 275c 6e27  ght gray" + '\n'
+0001cb50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001cb60: 2020 2020 2020 2020 2023 2022 636f 7079           # "copy
+0001cb70: 2066 696c 6520 2220 2b20 7374 7228 7375   file " + str(su
+0001cb80: 7266 6163 6566 6e29 202b 2022 5f7a 7375  rfacefn) + "_zsu
+0001cb90: 7266 6163 652e 6a70 6567 2220 2b20 2220  rface.jpeg" + " 
+0001cba0: 7375 7065 7273 616d 706c 6520 3320 7769  supersample 3 wi
+0001cbb0: 6474 6820 3132 3030 2068 6569 6768 7420  dth 1200 height 
+0001cbc0: 3132 3030 2220 2b20 275c 6e27 0a20 2020  1200" + '\n'.   
+0001cbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cbe0: 2020 2020 2023 2022 7475 726e 2078 202d       # "turn x -
+0001cbf0: 3930 2220 2b20 275c 6e27 0a20 2020 2020  90" + '\n'.     
+0001cc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cc10: 2020 2023 2022 6365 6e74 6572 2220 2b20     # "center" + 
+0001cc20: 275c 6e27 0a20 2020 2020 2020 2020 2020  '\n'.           
+0001cc30: 2020 2020 2020 2020 2020 2020 2023 2022               # "
+0001cc40: 636f 7079 2066 696c 6520 2220 2b20 7374  copy file " + st
+0001cc50: 7228 7375 7266 6163 6566 6e29 202b 2022  r(surfacefn) + "
+0001cc60: 5f78 7375 7266 6163 652e 6a70 6567 2220  _xsurface.jpeg" 
+0001cc70: 2b20 2220 7375 7065 7273 616d 706c 6520  + " supersample 
+0001cc80: 3320 7769 6474 6820 3132 3030 2068 6569  3 width 1200 hei
+0001cc90: 6768 7420 3132 3030 2220 2b20 275c 6e27  ght 1200" + '\n'
+0001cca0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ccb0: 2020 2020 2020 2020 2023 2022 7475 726e           # "turn
+0001ccc0: 207a 202d 3930 2220 2b20 275c 6e27 0a20   z -90" + '\n'. 
+0001ccd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cce0: 2020 2020 2020 2023 2022 6365 6e74 6572         # "center
+0001ccf0: 2220 2b20 275c 6e27 0a20 2020 2020 2020  " + '\n'.       
+0001cd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cd10: 2023 2022 636f 7079 2066 696c 6520 2220   # "copy file " 
+0001cd20: 2b20 7374 7228 7375 7266 6163 6566 6e29  + str(surfacefn)
+0001cd30: 202b 2022 5f79 7375 7266 6163 652e 6a70   + "_ysurface.jp
+0001cd40: 6567 2220 2b20 2220 7375 7065 7273 616d  eg" + " supersam
+0001cd50: 706c 6520 3320 7769 6474 6820 3132 3030  ple 3 width 1200
+0001cd60: 2068 6569 6768 7420 3132 3030 2220 2b20   height 1200" + 
+0001cd70: 275c 6e27 0a20 2020 2020 2020 2020 2020  '\n'.           
+0001cd80: 2020 2020 2020 2020 2020 2020 2023 2022               # "
+0001cd90: 636c 6f73 6520 616c 6c22 202b 2022 5c6e  close all" + "\n
+0001cda0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0001cdb0: 2020 2020 2020 2020 2020 2320 2273 746f            # "sto
+0001cdc0: 7022 0a0a 2020 2020 2020 2020 2020 2020  p"..            
+0001cdd0: 2020 2020 2020 2020 2020 2020 2320 4368              # Ch
+0001cde0: 696d 6572 6158 2076 6572 7369 6f6e 0a20  imeraX version. 
+0001cdf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ce00: 2020 2020 2020 2027 6f70 656e 2027 202b         'open ' +
+0001ce10: 2073 7472 286d 6170 6e61 6d65 2920 2b20   str(mapname) + 
+0001ce20: 2220 666f 726d 6174 2063 6370 3422 202b  " format ccp4" +
+0001ce30: 2027 5c6e 270a 2020 2020 2020 2020 2020   '\n'.          
+0001ce40: 2020 2020 2020 2020 2020 2020 2020 226f                "o
+0001ce50: 7065 6e20 2220 2b20 7374 7228 6d6f 6465  pen " + str(mode
+0001ce60: 6c2e 6669 6c65 6e61 6d65 2920 2b20 2220  l.filename) + " 
+0001ce70: 666f 726d 6174 206d 6d63 6966 2220 2b20  format mmcif" + 
+0001ce80: 275c 6e27 0a20 2020 2020 2020 2020 2020  '\n'.           
+0001ce90: 2020 2020 2020 2020 2020 2020 2022 6869               "hi
+0001cea0: 6465 2073 656c 4174 6f6d 7322 202b 2027  de selAtoms" + '
+0001ceb0: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
+0001cec0: 2020 2020 2020 2020 2020 2020 2273 686f              "sho
+0001ced0: 7720 7365 6c41 746f 6d73 2072 6962 626f  w selAtoms ribbo
+0001cee0: 6e73 2220 2b20 275c 6e27 0a20 2020 2020  ns" + '\n'.     
+0001cef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cf00: 2020 2022 636f 6c6f 7220 2332 2023 3030     "color #2 #00
+0001cf10: 3342 4646 2220 2b20 275c 6e27 0a20 2020  3BFF" + '\n'.   
+0001cf20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cf30: 2020 2020 2022 766f 6c75 6d65 2023 3120       "volume #1 
+0001cf40: 7374 796c 6520 7375 7266 6163 6520 6578  style surface ex
+0001cf50: 7061 6e64 5369 6e67 6c65 506c 616e 6520  pandSinglePlane 
+0001cf60: 5472 7565 2022 202b 2027 5c6e 270a 2020  True " + '\n'.  
+0001cf70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cf80: 2020 2020 2020 2276 6f6c 756d 6520 2331        "volume #1
+0001cf90: 2063 6f6c 6f72 2023 4238 3836 3042 2073   color #B8860B s
+0001cfa0: 7465 7020 3120 2220 2b20 636f 6e74 6f75  tep 1 " + contou
+0001cfb0: 7220 2b20 275c 6e27 0a20 2020 2020 2020  r + '\n'.       
+0001cfc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cfd0: 2022 766f 6c75 6d65 2023 3120 7472 616e   "volume #1 tran
+0001cfe0: 7370 6172 656e 6379 2030 2e36 3522 202b  sparency 0.65" +
+0001cff0: 2027 5c6e 2720 2023 206d 616b 6520 7468   '\n'  # make th
+0001d000: 6520 7375 7266 6163 6520 6120 6c69 7474  e surface a litt
+0001d010: 6c65 2062 6974 2073 6565 2d74 6872 6f75  le bit see-throu
+0001d020: 6768 0a20 2020 2020 2020 2020 2020 2020  gh.             
+0001d030: 2020 2020 2020 2020 2020 2022 7365 7420             "set 
+0001d040: 6267 436f 6c6f 7220 6c69 6768 7420 6772  bgColor light gr
+0001d050: 6179 2220 2b20 275c 6e27 0a20 2020 2020  ay" + '\n'.     
+0001d060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d070: 2020 2022 7669 6577 2063 6f66 7220 5472     "view cofr Tr
+0001d080: 7565 205c 6e22 0a20 2020 2020 2020 2020  ue \n".         
+0001d090: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0001d0a0: 7361 7665 2022 202b 2073 7472 2873 7572  save " + str(sur
+0001d0b0: 6661 6365 666e 2920 2b20 225f 7a73 7572  facefn) + "_zsur
+0001d0c0: 6661 6365 2e6a 7065 6722 202b 2022 2073  face.jpeg" + " s
+0001d0d0: 7570 6572 7361 6d70 6c65 2033 2077 6964  upersample 3 wid
+0001d0e0: 7468 2031 3230 3020 6865 6967 6874 2031  th 1200 height 1
+0001d0f0: 3230 3022 202b 2027 5c6e 270a 2020 2020  200" + '\n'.    
+0001d100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d110: 2020 2020 2274 7572 6e20 7820 2d39 3022      "turn x -90"
+0001d120: 202b 2027 5c6e 270a 2020 2020 2020 2020   + '\n'.        
+0001d130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d140: 2274 7572 6e20 7920 2d39 3022 202b 2027  "turn y -90" + '
+0001d150: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
+0001d160: 2020 2020 2020 2020 2020 2020 2276 6965              "vie
+0001d170: 7720 636f 6672 2054 7275 6522 202b 2027  w cofr True" + '
+0001d180: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
+0001d190: 2020 2020 2020 2020 2020 2020 2273 6176              "sav
+0001d1a0: 6520 2220 2b20 7374 7228 7375 7266 6163  e " + str(surfac
+0001d1b0: 6566 6e29 202b 2022 5f78 7375 7266 6163  efn) + "_xsurfac
+0001d1c0: 652e 6a70 6567 2220 2b20 2220 7375 7065  e.jpeg" + " supe
+0001d1d0: 7273 616d 706c 6520 3320 7769 6474 6820  rsample 3 width 
+0001d1e0: 3132 3030 2068 6569 6768 7420 3132 3030  1200 height 1200
+0001d1f0: 2220 2b20 275c 6e27 0a20 2020 2020 2020  " + '\n'.       
+0001d200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d210: 2022 7669 6577 206f 7269 656e 7422 202b   "view orient" +
+0001d220: 2027 5c6e 270a 2020 2020 2020 2020 2020   '\n'.          
+0001d230: 2020 2020 2020 2020 2020 2020 2020 2274                "t
+0001d240: 7572 6e20 7820 3930 2220 2b20 275c 6e27  urn x 90" + '\n'
+0001d250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d260: 2020 2020 2020 2020 2022 7475 726e 207a           "turn z
+0001d270: 2039 3022 202b 2027 5c6e 270a 2020 2020   90" + '\n'.    
+0001d280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d290: 2020 2020 2276 6965 7720 636f 6672 2054      "view cofr T
+0001d2a0: 7275 6522 202b 2027 5c6e 270a 2020 2020  rue" + '\n'.    
+0001d2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d2c0: 2020 2020 2273 6176 6520 2220 2b20 7374      "save " + st
+0001d2d0: 7228 7375 7266 6163 6566 6e29 202b 2022  r(surfacefn) + "
+0001d2e0: 5f79 7375 7266 6163 652e 6a70 6567 2220  _ysurface.jpeg" 
+0001d2f0: 2b20 2220 7375 7065 7273 616d 706c 6520  + " supersample 
+0001d300: 3320 7769 6474 6820 3132 3030 2068 6569  3 width 1200 hei
+0001d310: 6768 7420 3132 3030 2220 2b20 275c 6e27  ght 1200" + '\n'
+0001d320: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d330: 2020 2020 2020 2020 2022 636c 6f73 6520           "close 
+0001d340: 616c 6c22 202b 2022 5c6e 220a 2020 2020  all" + "\n".    
+0001d350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d360: 2020 2020 2265 7869 7422 0a0a 2020 2020      "exit"..    
+0001d370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d380: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001d390: 2020 7769 7468 206f 7065 6e28 7374 7228    with open(str(
+0001d3a0: 6d6f 6465 6c2e 6669 6c65 6e61 6d65 2929  model.filename))
+0001d3b0: 2061 7320 663a 0a20 2020 2020 2020 2020   as f:.         
+0001d3c0: 2020 2020 2020 2020 2020 2073 203d 206d             s = m
+0001d3d0: 6d61 702e 6d6d 6170 2866 2e66 696c 656e  map.mmap(f.filen
+0001d3e0: 6f28 292c 2030 2c20 6163 6365 7373 3d6d  o(), 0, access=m
+0001d3f0: 6d61 702e 4143 4345 5353 5f52 4541 4429  map.ACCESS_READ)
+0001d400: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d410: 2020 2020 2023 2070 7974 686f 6e20 3320       # python 3 
+0001d420: 6d6d 6170 2e6d 6d61 7028 6669 6c65 2e66  mmap.mmap(file.f
+0001d430: 696c 656e 6f28 292c 2030 2c20 6163 6365  ileno(), 0, acce
+0001d440: 7373 3d6d 6d61 702e 4143 4345 5353 5f52  ss=mmap.ACCESS_R
+0001d450: 4541 4429 2061 7320 733a 0a20 2020 2020  EAD) as s:.     
+0001d460: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0001d470: 6620 732e 6669 6e64 2862 2770 6f69 6e74  f s.find(b'point
+0001d480: 2073 796d 6d65 7472 7920 6f70 6572 6174   symmetry operat
+0001d490: 696f 6e27 2920 213d 202d 313a 0a20 2020  ion') != -1:.   
+0001d4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d4b0: 2020 2020 2061 7373 656d 626c 6520 3d20       assemble = 
+0001d4c0: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
+0001d4d0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0001d4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d4f0: 2020 2020 2020 2061 7373 656d 626c 6520         assemble 
+0001d500: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
+0001d510: 2020 2020 2020 2020 6368 696d 6572 6163          chimerac
+0001d520: 6d64 6173 7365 6d62 6c65 203d 2073 7572  mdassemble = sur
+0001d530: 6661 6365 666e 202b 2027 5f63 6869 6d65  facefn + '_chime
+0001d540: 7261 5f61 7373 656d 626c 652e 6378 6327  ra_assemble.cxc'
+0001d550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d560: 2069 6620 6173 7365 6d62 6c65 3a0a 2020   if assemble:.  
+0001d570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d580: 2020 6d6f 6465 6c6e 616d 6520 3d20 6f73    modelname = os
+0001d590: 2e70 6174 682e 6261 7365 6e61 6d65 286d  .path.basename(m
+0001d5a0: 6f64 656c 2e66 696c 656e 616d 6529 0a20  odel.filename). 
+0001d5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d5c0: 2020 206d 6170 6e61 6d65 203d 206f 732e     mapname = os.
+0001d5d0: 7061 7468 2e62 6173 656e 616d 6528 6d61  path.basename(ma
+0001d5e0: 706e 616d 6529 0a20 2020 2020 2020 2020  pname).         
+0001d5f0: 2020 2020 2020 2020 2020 2070 7265 6669             prefi
+0001d600: 7820 3d20 277b 7d5f 7b7d 272e 666f 726d  x = '{}_{}'.form
+0001d610: 6174 286d 6f64 656c 6e61 6d65 2c20 6d61  at(modelname, ma
+0001d620: 706e 616d 6529 0a0a 2020 2020 2020 2020  pname)..        
+0001d630: 2020 2020 2020 2020 2020 2020 7769 7468              with
+0001d640: 206f 7065 6e28 7365 6c66 2e77 6f72 6b64   open(self.workd
+0001d650: 6972 202b 2063 6869 6d65 7261 636d 6461  ir + chimeracmda
+0001d660: 7373 656d 626c 652c 2027 7727 2920 6173  ssemble, 'w') as
+0001d670: 2066 3a0a 2020 2020 2020 2020 2020 2020   f:.            
+0001d680: 2020 2020 2020 2020 2020 2020 662e 7772              f.wr
+0001d690: 6974 6528 0a20 2020 2020 2020 2020 2020  ite(.           
+0001d6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d6b0: 2023 2043 6869 6d65 7261 5820 7665 7273   # ChimeraX vers
+0001d6c0: 696f 6e0a 2020 2020 2020 2020 2020 2020  ion.            
+0001d6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d6e0: 226f 7065 6e20 2220 2b20 7374 7228 6d61  "open " + str(ma
+0001d6f0: 706e 616d 6529 202b 2022 2066 6f72 6d61  pname) + " forma
+0001d700: 7420 6363 7034 2220 2b20 275c 6e27 0a20  t ccp4" + '\n'. 
+0001d710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d720: 2020 2020 2020 2020 2020 2022 6f70 656e             "open
+0001d730: 2022 202b 2073 7472 286d 6f64 656c 2e66   " + str(model.f
+0001d740: 696c 656e 616d 6529 202b 2022 2066 6f72  ilename) + " for
+0001d750: 6d61 7420 6d6d 6369 6622 202b 2027 5c6e  mat mmcif" + '\n
+0001d760: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0001d770: 2020 2020 2020 2020 2020 2020 2020 2268                "h
+0001d780: 6964 6520 7365 6c41 746f 6d73 2220 2b20  ide selAtoms" + 
+0001d790: 275c 6e27 0a20 2020 2020 2020 2020 2020  '\n'.           
+0001d7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d7b0: 2022 7368 6f77 2073 656c 4174 6f6d 7320   "show selAtoms 
+0001d7c0: 7269 6262 6f6e 7322 202b 2027 5c6e 270a  ribbons" + '\n'.
+0001d7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d7e0: 2020 2020 2020 2020 2020 2020 2263 6f6c              "col
+0001d7f0: 6f72 2023 3220 2330 3033 4246 4622 202b  or #2 #003BFF" +
+0001d800: 2027 5c6e 270a 2020 2020 2020 2020 2020   '\n'.          
+0001d810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d820: 2020 2276 6f6c 756d 6520 2331 2073 7479    "volume #1 sty
+0001d830: 6c65 2073 7572 6661 6365 2065 7870 616e  le surface expan
+0001d840: 6453 696e 676c 6550 6c61 6e65 2054 7275  dSinglePlane Tru
+0001d850: 6522 202b 2027 5c6e 270a 2020 2020 2020  e" + '\n'.      
+0001d860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d870: 2020 2020 2020 2276 6f6c 756d 6520 2331        "volume #1
+0001d880: 2063 6f6c 6f72 2023 4238 3836 3042 2073   color #B8860B s
+0001d890: 7465 7020 3120 2220 2b20 636f 6e74 6f75  tep 1 " + contou
+0001d8a0: 7220 2b20 275c 6e27 0a20 2020 2020 2020  r + '\n'.       
+0001d8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d8c0: 2020 2020 2022 766f 6c75 6d65 2023 3120       "volume #1 
+0001d8d0: 7472 616e 7370 6172 656e 6379 2030 2e36  transparency 0.6
+0001d8e0: 3522 202b 2027 5c6e 2720 2023 206d 616b  5" + '\n'  # mak
+0001d8f0: 6520 7468 6520 7375 7266 6163 6520 6120  e the surface a 
+0001d900: 6c69 7474 6c65 2062 6974 2073 6565 2d74  little bit see-t
+0001d910: 6872 6f75 6768 0a20 2020 2020 2020 2020  hrough.         
+0001d920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d930: 2020 2022 7379 6d20 2332 2061 7373 656d     "sym #2 assem
+0001d940: 626c 7920 315c 6e22 0a20 2020 2020 2020  bly 1\n".       
+0001d950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d960: 2020 2020 2022 7365 7420 6267 436f 6c6f       "set bgColo
+0001d970: 7220 6c69 6768 7420 6772 6179 2220 2b20  r light gray" + 
+0001d980: 275c 6e27 0a20 2020 2020 2020 2020 2020  '\n'.           
+0001d990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d9a0: 2022 7669 6577 2063 6f66 7220 5472 7565   "view cofr True
+0001d9b0: 205c 6e22 0a20 2020 2020 2020 2020 2020   \n".           
+0001d9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d9d0: 2022 7361 7665 2022 202b 2073 7472 2870   "save " + str(p
+0001d9e0: 7265 6669 7829 202b 2022 5f61 7373 656d  refix) + "_assem
+0001d9f0: 626c 655f 7a73 7572 6661 6365 2e6a 7065  ble_zsurface.jpe
+0001da00: 6722 202b 2022 2073 7570 6572 7361 6d70  g" + " supersamp
+0001da10: 6c65 2033 2077 6964 7468 2031 3230 3020  le 3 width 1200 
+0001da20: 6865 6967 6874 2031 3230 3022 202b 2027  height 1200" + '
+0001da30: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
+0001da40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001da50: 2274 7572 6e20 7820 2d39 3022 202b 2027  "turn x -90" + '
+0001da60: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
+0001da70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001da80: 2274 7572 6e20 7920 2d39 3022 202b 2027  "turn y -90" + '
+0001da90: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
+0001daa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dab0: 2276 6965 7720 636f 6672 2054 7275 6522  "view cofr True"
+0001dac0: 202b 2027 5c6e 270a 2020 2020 2020 2020   + '\n'.        
+0001dad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dae0: 2020 2020 2273 6176 6520 2220 2b20 7374      "save " + st
+0001daf0: 7228 7072 6566 6978 2920 2b20 225f 6173  r(prefix) + "_as
+0001db00: 7365 6d62 6c65 5f78 7375 7266 6163 652e  semble_xsurface.
+0001db10: 6a70 6567 2220 2b20 2220 7375 7065 7273  jpeg" + " supers
+0001db20: 616d 706c 6520 3320 7769 6474 6820 3132  ample 3 width 12
+0001db30: 3030 2068 6569 6768 7420 3132 3030 2220  00 height 1200" 
+0001db40: 2b20 275c 6e27 0a20 2020 2020 2020 2020  + '\n'.         
+0001db50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001db60: 2020 2022 7669 6577 206f 7269 656e 7422     "view orient"
+0001db70: 202b 2027 5c6e 270a 2020 2020 2020 2020   + '\n'.        
+0001db80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001db90: 2020 2020 2274 7572 6e20 7820 3930 2220      "turn x 90" 
+0001dba0: 2b20 275c 6e27 0a20 2020 2020 2020 2020  + '\n'.         
+0001dbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dbc0: 2020 2022 7475 726e 207a 2039 3022 202b     "turn z 90" +
+0001dbd0: 2027 5c6e 270a 2020 2020 2020 2020 2020   '\n'.          
+0001dbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dbf0: 2020 2276 6965 7720 636f 6672 2054 7275    "view cofr Tru
+0001dc00: 6522 202b 2027 5c6e 270a 2020 2020 2020  e" + '\n'.      
+0001dc10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dc20: 2020 2020 2020 2273 6176 6520 2220 2b20        "save " + 
+0001dc30: 7374 7228 7072 6566 6978 2920 2b20 225f  str(prefix) + "_
+0001dc40: 6173 7365 6d62 6c65 5f79 7375 7266 6163  assemble_ysurfac
+0001dc50: 652e 6a70 6567 2220 2b20 2220 7375 7065  e.jpeg" + " supe
+0001dc60: 7273 616d 706c 6520 3320 7769 6474 6820  rsample 3 width 
+0001dc70: 3132 3030 2068 6569 6768 7420 3132 3030  1200 height 1200
+0001dc80: 2220 2b20 275c 6e27 0a20 2020 2020 2020  " + '\n'.       
+0001dc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dca0: 2020 2020 2022 636c 6f73 6520 616c 6c22       "close all"
+0001dcb0: 202b 2022 5c6e 220a 2020 2020 2020 2020   + "\n".        
+0001dcc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dcd0: 2020 2020 2265 7869 7422 202b 2027 5c6e      "exit" + '\n
+0001dce0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+0001dcf0: 2020 2020 2020 2020 2020 290a 0a0a 2020            )...  
+0001dd00: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+0001dd10: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+0001dd20: 2020 2020 2020 2069 6620 6e6f 7420 6269         if not bi
+0001dd30: 6e64 6973 706c 6179 3a0a 2020 2020 2020  ndisplay:.      
+0001dd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dd50: 2020 7375 6270 726f 6365 7373 2e63 6865    subprocess.che
+0001dd60: 636b 5f63 616c 6c28 6c6f 6343 4849 4d45  ck_call(locCHIME
+0001dd70: 5241 202b 2022 202d 2d6f 6666 7363 7265  RA + " --offscre
+0001dd80: 656e 202d 2d6e 6f67 7569 2022 202b 2073  en --nogui " + s
+0001dd90: 656c 662e 776f 726b 6469 7220 2b20 6368  elf.workdir + ch
+0001dda0: 696d 6572 6163 6d64 2c0a 2020 2020 2020  imeracmd,.      
+0001ddb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0001ddc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ddd0: 2073 7572 6661 6365 666e 203d 2027 7b7d   surfacefn = '{}
-0001dde0: 5f7b 7d27 2e66 6f72 6d61 7428 6d6f 6465  _{}'.format(mode
-0001ddf0: 6c6e 616d 652c 2073 656c 662e 6d61 706e  lname, self.mapn
-0001de00: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
-0001de10: 2020 2020 2020 2020 2066 6f72 206a 7065           for jpe
-0001de20: 6720 696e 206a 7065 6773 3a0a 2020 2020  g in jpegs:.    
-0001de30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001de40: 2020 2020 6966 206d 6f64 656c 6e61 6d65      if modelname
-0001de50: 2069 6e20 6a70 6567 2061 6e64 2027 7873   in jpeg and 'xs
-0001de60: 7572 6661 6365 2720 696e 206a 7065 673a  urface' in jpeg:
-0001de70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001de80: 2020 2020 2020 2020 2020 2020 2061 7373               ass
-0001de90: 656d 626c 656d 6170 7375 7266 6163 655b  emblemapsurface[
-0001dea0: 2778 5f61 7373 656d 626c 6527 5d20 3d20  'x_assemble'] = 
-0001deb0: 7374 7228 7375 7266 6163 6566 6e29 202b  str(surfacefn) +
-0001dec0: 2027 5f61 7373 656d 626c 655f 7363 616c   '_assemble_scal
-0001ded0: 6564 5f78 7375 7266 6163 652e 6a70 6567  ed_xsurface.jpeg
-0001dee0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0001def0: 2020 2020 2020 2020 2020 6966 206d 6f64            if mod
-0001df00: 656c 6e61 6d65 2069 6e20 6a70 6567 2061  elname in jpeg a
-0001df10: 6e64 2027 7973 7572 6661 6365 2720 696e  nd 'ysurface' in
-0001df20: 206a 7065 673a 0a20 2020 2020 2020 2020   jpeg:.         
-0001df30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001df40: 2020 2061 7373 656d 626c 656d 6170 7375     assemblemapsu
-0001df50: 7266 6163 655b 2779 5f61 7373 656d 626c  rface['y_assembl
-0001df60: 6527 5d20 3d20 7374 7228 7375 7266 6163  e'] = str(surfac
-0001df70: 6566 6e29 202b 2027 5f61 7373 656d 626c  efn) + '_assembl
-0001df80: 655f 7363 616c 6564 5f79 7375 7266 6163  e_scaled_ysurfac
-0001df90: 652e 6a70 6567 270a 2020 2020 2020 2020  e.jpeg'.        
-0001dfa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dfb0: 6966 206d 6f64 656c 6e61 6d65 2069 6e20  if modelname in 
-0001dfc0: 6a70 6567 2061 6e64 2027 7a73 7572 6661  jpeg and 'zsurfa
-0001dfd0: 6365 2720 696e 206a 7065 673a 0a20 2020  ce' in jpeg:.   
-0001dfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001dff0: 2020 2020 2020 2020 2061 7373 656d 626c           assembl
-0001e000: 656d 6170 7375 7266 6163 655b 277a 5f61  emapsurface['z_a
-0001e010: 7373 656d 626c 6527 5d20 3d20 7374 7228  ssemble'] = str(
-0001e020: 7375 7266 6163 6566 6e29 202b 2027 5f61  surfacefn) + '_a
-0001e030: 7373 656d 626c 655f 7363 616c 6564 5f7a  ssemble_scaled_z
-0001e040: 7375 7266 6163 652e 6a70 6567 270a 0a20  surface.jpeg'.. 
-0001e050: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0001e060: 6572 6765 6464 6963 7420 3d20 6469 6374  ergeddict = dict
-0001e070: 286d 6f64 656c 6d61 7073 7572 6661 6365  (modelmapsurface
-0001e080: 2c20 2a2a 6173 7365 6d62 6c65 6d61 7073  , **assemblemaps
-0001e090: 7572 6661 6365 290a 2020 2020 2020 2020  urface).        
-0001e0a0: 2020 2020 2020 2020 6d6f 6465 6c73 7572          modelsur
-0001e0b0: 665b 6d6f 6465 6c6e 616d 655d 203d 206d  f[modelname] = m
-0001e0c0: 6572 6765 6464 6963 740a 2020 2020 2020  ergeddict.      
-0001e0d0: 2020 6966 206d 6d65 7272 6c69 7374 3a0a    if mmerrlist:.
-0001e0e0: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
-0001e0f0: 6c73 7572 665b 2765 7272 275d 203d 207b  lsurf['err'] = {
-0001e100: 276d 6170 6d6f 6465 6c5f 7375 7266 6163  'mapmodel_surfac
-0001e110: 655f 6572 7227 3a20 6d6d 6572 726c 6973  e_err': mmerrlis
-0001e120: 747d 0a20 2020 2020 2020 2066 696e 616c  t}.        final
-0001e130: 6d6d 6469 6374 5b27 6d61 706d 6f64 656c  mmdict['mapmodel
-0001e140: 5f73 7572 6661 6365 275d 203d 206d 6f64  _surface'] = mod
-0001e150: 656c 7375 7266 0a0a 2020 2020 2020 2020  elsurf..        
-0001e160: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-0001e170: 2077 6974 6820 636f 6465 6373 2e6f 7065   with codecs.ope
-0001e180: 6e28 7365 6c66 2e77 6f72 6b64 6972 202b  n(self.workdir +
-0001e190: 2073 656c 662e 6d61 706e 616d 6520 2b20   self.mapname + 
-0001e1a0: 275f 6d61 706d 6f64 656c 7375 7266 6163  '_mapmodelsurfac
-0001e1b0: 6576 6965 772e 6a73 6f6e 272c 2027 7727  eview.json', 'w'
-0001e1c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001e1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e1e0: 2020 656e 636f 6469 6e67 3d27 7574 662d    encoding='utf-
-0001e1f0: 3827 2920 6173 2066 3a0a 2020 2020 2020  8') as f:.      
-0001e200: 2020 2020 2020 2020 2020 6a73 6f6e 2e64            json.d
-0001e210: 756d 7028 6669 6e61 6c6d 6d64 6963 742c  ump(finalmmdict,
-0001e220: 2066 290a 2020 2020 2020 2020 6578 6365   f).        exce
-0001e230: 7074 3a0a 2020 2020 2020 2020 2020 2020  pt:.            
-0001e240: 6572 7220 3d20 2753 6176 696e 6720 6d6f  err = 'Saving mo
-0001e250: 6465 6c20 616e 6420 6d61 7020 7375 7266  del and map surf
-0001e260: 6163 6520 7669 6577 7320 6a73 6f6e 2065  ace views json e
-0001e270: 7272 6f72 3a20 7b7d 2e27 2e66 6f72 6d61  rror: {}.'.forma
-0001e280: 7428 7379 732e 6578 635f 696e 666f 2829  t(sys.exc_info()
-0001e290: 5b31 5d29 0a20 2020 2020 2020 2020 2020  [1]).           
-0001e2a0: 2073 7973 2e73 7464 6572 722e 7772 6974   sys.stderr.writ
-0001e2b0: 6528 6572 7220 2b20 275c 6e27 290a 0a20  e(err + '\n').. 
-0001e2c0: 2020 2020 2020 2065 6e64 203d 2074 696d         end = tim
-0001e2d0: 6569 742e 6465 6661 756c 745f 7469 6d65  eit.default_time
-0001e2e0: 7228 290a 2020 2020 2020 2020 7072 696e  r().        prin
-0001e2f0: 7428 2753 7572 6661 6365 7669 6577 2074  t('Surfaceview t
-0001e300: 696d 653a 2025 7327 2025 2028 656e 6420  ime: %s' % (end 
-0001e310: 2d20 7374 6172 7429 290a 2020 2020 2020  - start)).      
-0001e320: 2020 7072 696e 7428 272d 2d2d 2d2d 2d2d    print('-------
-0001e330: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0001e340: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d27 290a  -------------').
-0001e350: 0a0a 2020 2020 6465 6620 6d6f 6465 6c66  ..    def modelf
-0001e360: 6974 7375 7266 6163 6528 7365 6c66 2c20  itsurface(self, 
-0001e370: 6368 696d 6572 6161 7070 293a 0a0a 2020  chimeraapp):..  
-0001e380: 2020 2020 2020 2320 7265 6164 206a 736f        # read jso
-0001e390: 6e0a 2020 2020 2020 2020 7374 6172 7420  n.        start 
-0001e3a0: 3d20 7469 6d65 6974 2e64 6566 6175 6c74  = timeit.default
-0001e3b0: 5f74 696d 6572 2829 0a20 2020 2020 2020  _timer().       
-0001e3c0: 2069 6e6a 736f 6e20 3d20 676c 6f62 2e67   injson = glob.g
-0001e3d0: 6c6f 6228 7365 6c66 2e77 6f72 6b64 6972  lob(self.workdir
-0001e3e0: 202b 2027 2a72 6573 6964 7565 5f69 6e63   + '*residue_inc
-0001e3f0: 6c75 7369 6f6e 2e6a 736f 6e27 290a 2020  lusion.json').  
-0001e400: 2020 2020 2020 6261 7365 6469 7220 3d20        basedir = 
-0001e410: 7365 6c66 2e77 6f72 6b64 6972 0a20 2020  self.workdir.   
-0001e420: 2020 2020 206d 6170 6e61 6d65 203d 2073       mapname = s
-0001e430: 656c 662e 6d61 706e 616d 650a 2020 2020  elf.mapname.    
-0001e440: 2020 2020 6c6f 6343 4849 4d45 5241 203d      locCHIMERA =
-0001e450: 2063 6869 6d65 7261 6170 700a 2020 2020   chimeraapp.    
-0001e460: 2020 2020 6269 6e64 6973 706c 6179 203d      bindisplay =
-0001e470: 206f 732e 6765 7465 6e76 2827 4449 5350   os.getenv('DISP
-0001e480: 4c41 5927 290a 2020 2020 2020 2020 6572  LAY').        er
-0001e490: 726c 6973 7420 3d20 5b5d 0a0a 2020 2020  rlist = []..    
-0001e4a0: 2020 2020 6675 6c69 6e6a 736f 6e20 3d20      fulinjson = 
-0001e4b0: 696e 6a73 6f6e 5b30 5d20 6966 2069 6e6a  injson[0] if inj
-0001e4c0: 736f 6e20 656c 7365 204e 6f6e 650a 2020  son else None.  
-0001e4d0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0001e4e0: 2020 2020 2020 2069 6620 6675 6c69 6e6a         if fulinj
-0001e4f0: 736f 6e3a 0a20 2020 2020 2020 2020 2020  son:.           
-0001e500: 2020 2020 2077 6974 6820 6f70 656e 2866       with open(f
-0001e510: 756c 696e 6a73 6f6e 2c20 2772 2729 2061  ulinjson, 'r') a
-0001e520: 7320 663a 0a20 2020 2020 2020 2020 2020  s f:.           
-0001e530: 2020 2020 2020 2020 2061 7267 7320 3d20           args = 
-0001e540: 6a73 6f6e 2e6c 6f61 6428 6629 0a20 2020  json.load(f).   
-0001e550: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0001e560: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0001e570: 7267 7320 3d20 4e6f 6e65 0a20 2020 2020  rgs = None.     
-0001e580: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-0001e590: 2827 5468 6572 6520 6973 206e 6f20 7265  ('There is no re
-0001e5a0: 7369 6475 6520 696e 636c 7573 696f 6e20  sidue inclusion 
-0001e5b0: 6a73 6f6e 2066 696c 652e 2729 0a20 2020  json file.').   
-0001e5c0: 2020 2020 2065 7863 6570 7420 5479 7065       except Type
-0001e5d0: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
-0001e5e0: 2020 2065 7272 203d 2027 4f70 656e 2072     err = 'Open r
-0001e5f0: 6573 6964 7565 5f69 6e63 6c75 7369 6f6e  esidue_inclusion
-0001e600: 2065 7272 6f72 3a20 7b7d 2e27 2e66 6f72   error: {}.'.for
-0001e610: 6d61 7428 7379 732e 6578 635f 696e 666f  mat(sys.exc_info
-0001e620: 2829 5b31 5d29 0a20 2020 2020 2020 2020  ()[1]).         
-0001e630: 2020 2065 7272 6c69 7374 2e61 7070 656e     errlist.appen
-0001e640: 6428 6572 7229 0a20 2020 2020 2020 2020  d(err).         
-0001e650: 2020 2073 7973 2e73 7464 6572 722e 7772     sys.stderr.wr
-0001e660: 6974 6528 6572 7220 2b20 275c 6e27 290a  ite(err + '\n').
-0001e670: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0001e680: 2020 2020 2020 2020 2020 6966 2061 7267            if arg
-0001e690: 7320 6973 206e 6f74 204e 6f6e 653a 0a20  s is not None:. 
-0001e6a0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0001e6b0: 6f64 656c 7320 3d20 6172 6773 5b27 7265  odels = args['re
-0001e6c0: 7369 6475 655f 696e 636c 7573 696f 6e27  sidue_inclusion'
-0001e6d0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0001e6e0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-0001e6f0: 2020 2020 2020 2020 2020 2064 656c 206d             del m
-0001e700: 6f64 656c 735b 2765 7272 275d 0a20 2020  odels['err'].   
-0001e710: 2020 2020 2020 2020 2020 2020 2065 7863               exc
-0001e720: 6570 743a 0a20 2020 2020 2020 2020 2020  ept:.           
-0001e730: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
-0001e740: 5265 7369 6475 6520 696e 636c 7573 696f  Residue inclusio
-0001e750: 6e20 6a73 6f6e 2072 6573 756c 7420 6973  n json result is
-0001e760: 2063 6f72 7265 6374 2729 0a0a 2020 2020   correct')..    
-0001e770: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0001e780: 7428 2754 6865 7265 2069 732f 6172 6520  t('There is/are 
-0001e790: 2573 206d 6f64 656c 2873 292e 2720 2520  %s model(s).' % 
-0001e7a0: 6c65 6e28 6d6f 6465 6c73 2929 0a0a 2020  len(models))..  
-0001e7b0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0001e7c0: 7220 286b 6579 2c20 7661 6c75 6529 2069  r (key, value) i
-0001e7d0: 6e20 6974 6572 6974 656d 7328 6d6f 6465  n iteritems(mode
-0001e7e0: 6c73 293a 0a20 2020 2020 2020 2020 2020  ls):.           
-0001e7f0: 2020 2020 2020 2020 2023 2066 6f72 2028           # for (
-0001e800: 6b65 7932 2c20 7661 6c75 6532 2920 696e  key2, value2) in
-0001e810: 2069 7465 7269 7465 6d73 2876 616c 7565   iteritems(value
-0001e820: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0001e830: 2020 2020 2020 206b 6579 6c69 7374 203d         keylist =
-0001e840: 206c 6973 7428 7661 6c75 6529 0a20 2020   list(value).   
-0001e850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e860: 2066 6f72 206b 6579 2069 6e20 6b65 796c   for key in keyl
-0001e870: 6973 743a 0a20 2020 2020 2020 2020 2020  ist:.           
-0001e880: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0001e890: 6b65 7920 213d 2027 6e61 6d65 273a 0a20  key != 'name':. 
-0001e8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e8b0: 2020 2020 2020 2020 2020 2063 6f6c 6f72             color
-0001e8c0: 7320 3d20 7661 6c75 655b 6b65 795d 5b27  s = value[key]['
-0001e8d0: 636f 6c6f 7227 5d0a 2020 2020 2020 2020  color'].        
+0001ddd0: 2020 2020 2020 2020 6377 643d 7365 6c66          cwd=self
+0001dde0: 2e77 6f72 6b64 6972 2c20 7368 656c 6c3d  .workdir, shell=
+0001ddf0: 5472 7565 290a 2020 2020 2020 2020 2020  True).          
+0001de00: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0001de10: 2061 7373 656d 626c 653a 0a20 2020 2020   assemble:.     
+0001de20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001de30: 2020 2020 2020 2073 7562 7072 6f63 6573         subproces
+0001de40: 732e 6368 6563 6b5f 6361 6c6c 286c 6f63  s.check_call(loc
+0001de50: 4348 494d 4552 4120 2b20 2220 2d2d 6f66  CHIMERA + " --of
+0001de60: 6673 6372 6565 6e20 2d2d 6e6f 6775 6920  fscreen --nogui 
+0001de70: 2220 2b20 7365 6c66 2e77 6f72 6b64 6972  " + self.workdir
+0001de80: 202b 2063 6869 6d65 7261 636d 6461 7373   + chimeracmdass
+0001de90: 656d 626c 652c 0a20 2020 2020 2020 2020  emble,.         
+0001dea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001deb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dec0: 2020 2020 2020 2020 2063 7764 3d73 656c           cwd=sel
+0001ded0: 662e 776f 726b 6469 722c 2073 6865 6c6c  f.workdir, shell
+0001dee0: 3d54 7275 6529 0a20 2020 2020 2020 2020  =True).         
+0001def0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0001df00: 656e 6420 3d20 7469 6d65 6974 2e64 6566  end = timeit.def
+0001df10: 6175 6c74 5f74 696d 6572 2829 0a20 2020  ault_timer().   
+0001df20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001df30: 2020 2020 2070 7269 6e74 2827 5072 696d       print('Prim
+0001df40: 6172 7920 6d61 7020 616e 6420 6d6f 6465  ary map and mode
+0001df50: 6c20 7669 6577 2074 696d 653a 2025 7327  l view time: %s'
+0001df60: 2025 2028 6e65 6e64 202d 206e 7374 6172   % (nend - nstar
+0001df70: 7429 290a 2020 2020 2020 2020 2020 2020  t)).            
+0001df80: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0001df90: 7428 272d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  t('-------------
+0001dfa0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0001dfb0: 2d2d 2d2d 2d2d 2d27 290a 2020 2020 2020  -------').      
+0001dfc0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+0001dfd0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0001dfe0: 2020 2020 2020 2020 2020 2020 7375 6270              subp
+0001dff0: 726f 6365 7373 2e63 6865 636b 5f63 616c  rocess.check_cal
+0001e000: 6c28 6c6f 6343 4849 4d45 5241 202b 2022  l(locCHIMERA + "
+0001e010: 2022 202b 2073 656c 662e 776f 726b 6469   " + self.workdi
+0001e020: 7220 2b20 6368 696d 6572 6163 6d64 2c20  r + chimeracmd, 
+0001e030: 6377 643d 7365 6c66 2e77 6f72 6b64 6972  cwd=self.workdir
+0001e040: 2c20 7368 656c 6c3d 5472 7565 290a 2020  , shell=True).  
+0001e050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e060: 2020 2020 2020 6966 2061 7373 656d 626c        if assembl
+0001e070: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0001e080: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0001e090: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
+0001e0a0: 6361 6c6c 286c 6f63 4348 494d 4552 4120  call(locCHIMERA 
+0001e0b0: 2b20 2220 2220 2b20 7365 6c66 2e77 6f72  + " " + self.wor
+0001e0c0: 6b64 6972 202b 2063 6869 6d65 7261 636d  kdir + chimeracm
+0001e0d0: 6461 7373 656d 626c 652c 0a20 2020 2020  dassemble,.     
+0001e0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e100: 2020 2020 2020 2020 2020 2020 2063 7764               cwd
+0001e110: 3d73 656c 662e 776f 726b 6469 722c 2073  =self.workdir, s
+0001e120: 6865 6c6c 3d54 7275 6529 0a20 2020 2020  hell=True).     
+0001e130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e140: 2020 206e 656e 6420 3d20 7469 6d65 6974     nend = timeit
+0001e150: 2e64 6566 6175 6c74 5f74 696d 6572 2829  .default_timer()
+0001e160: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001e170: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
+0001e180: 5072 696d 6172 7920 6d61 7020 616e 6420  Primary map and 
+0001e190: 6d6f 6465 6c20 7669 6577 2074 696d 653a  model view time:
+0001e1a0: 2025 7327 2025 2028 6e65 6e64 202d 206e   %s' % (nend - n
+0001e1b0: 7374 6172 7429 290a 2020 2020 2020 2020  start)).        
+0001e1c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e1d0: 7072 696e 7428 272d 2d2d 2d2d 2d2d 2d2d  print('---------
+0001e1e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0001e1f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d27 290a 0a20  -----------').. 
+0001e200: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0001e210: 7863 6570 7420 7375 6270 726f 6365 7373  xcept subprocess
+0001e220: 2e43 616c 6c65 6450 726f 6365 7373 4572  .CalledProcessEr
+0001e230: 726f 7220 6173 2073 7562 6572 723a 0a20  ror as suberr:. 
+0001e240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e250: 2020 2065 7272 203d 2027 5361 7669 6e67     err = 'Saving
+0001e260: 206d 6f64 656c 207b 7d20 616e 6420 6d61   model {} and ma
+0001e270: 7020 6572 723a 207b 7d27 2e66 6f72 6d61  p err: {}'.forma
+0001e280: 7428 7374 7228 6d6f 6465 6c2e 6669 6c65  t(str(model.file
+0001e290: 6e61 6d65 292c 2073 7562 6572 7229 0a20  name), suberr). 
+0001e2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e2b0: 2020 206d 6d65 7272 6c69 7374 2e61 7070     mmerrlist.app
+0001e2c0: 656e 6428 6572 7229 0a20 2020 2020 2020  end(err).       
+0001e2d0: 2020 2020 2020 2020 2020 2020 2073 7973               sys
+0001e2e0: 2e73 7464 6572 722e 7772 6974 6528 6572  .stderr.write(er
+0001e2f0: 7220 2b20 275c 6e27 290a 0a20 2020 2020  r + '\n')..     
+0001e300: 2020 2070 7269 6e74 2827 5375 7266 6163     print('Surfac
+0001e310: 6520 7669 6577 7320 7765 7265 2067 656e  e views were gen
+0001e320: 6572 6174 6564 2062 7920 4368 696d 6572  erated by Chimer
+0001e330: 6158 2729 0a20 2020 2020 2020 2074 7279  aX').        try
+0001e340: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0001e350: 6c66 2e73 6361 6c65 5f73 7572 6661 6365  lf.scale_surface
+0001e360: 7669 6577 2829 0a20 2020 2020 2020 2065  view().        e
+0001e370: 7863 6570 743a 0a20 2020 2020 2020 2020  xcept:.         
+0001e380: 2020 2065 7272 203d 2027 5363 616c 696e     err = 'Scalin
+0001e390: 6720 7468 6520 7375 7266 6163 6520 7669  g the surface vi
+0001e3a0: 6577 7320 6572 723a 207b 7d27 2e66 6f72  ews err: {}'.for
+0001e3b0: 6d61 7428 7379 732e 6578 635f 696e 666f  mat(sys.exc_info
+0001e3c0: 2829 5b31 5d29 0a20 2020 2020 2020 2020  ()[1]).         
+0001e3d0: 2020 2065 7272 6c69 7374 2e61 7070 656e     errlist.appen
+0001e3e0: 6428 6572 7229 0a20 2020 2020 2020 2020  d(err).         
+0001e3f0: 2020 206d 6d65 7272 6c69 7374 2e61 7070     mmerrlist.app
+0001e400: 656e 6428 6572 7229 0a20 2020 2020 2020  end(err).       
+0001e410: 2020 2020 2073 7973 2e73 7464 6572 722e       sys.stderr.
+0001e420: 7772 6974 6528 6572 7220 2b20 275c 6e27  write(err + '\n'
+0001e430: 290a 0a20 2020 2020 2020 2073 7572 6661  )..        surfa
+0001e440: 6365 7669 6577 6a73 6f6e 203d 2064 6963  ceviewjson = dic
+0001e450: 7428 290a 2020 2020 2020 2020 6f75 746d  t().        outm
+0001e460: 6170 7869 6d61 6765 203d 2073 7472 2873  apximage = str(s
+0001e470: 656c 662e 6d61 706e 616d 6529 202b 2027  elf.mapname) + '
+0001e480: 5f78 7375 7266 6163 652e 6a70 6567 270a  _xsurface.jpeg'.
+0001e490: 2020 2020 2020 2020 6d61 7078 6c69 7374          mapxlist
+0001e4a0: 203d 206f 7574 6d61 7078 696d 6167 652e   = outmapximage.
+0001e4b0: 7370 6c69 7428 275f 2729 0a20 2020 2020  split('_').     
+0001e4c0: 2020 206d 6170 7873 6361 6c65 696d 6167     mapxscaleimag
+0001e4d0: 6520 3d20 275f 272e 6a6f 696e 286d 6170  e = '_'.join(map
+0001e4e0: 786c 6973 745b 3a2d 315d 2920 2b20 275f  xlist[:-1]) + '_
+0001e4f0: 7363 616c 6564 5f27 202b 206d 6170 786c  scaled_' + mapxl
+0001e500: 6973 745b 2d31 5d0a 2020 2020 2020 2020  ist[-1].        
+0001e510: 7375 7266 6163 6576 6965 776a 736f 6e5b  surfaceviewjson[
+0001e520: 2778 275d 203d 206f 732e 7061 7468 2e62  'x'] = os.path.b
+0001e530: 6173 656e 616d 6528 6d61 7078 7363 616c  asename(mapxscal
+0001e540: 6569 6d61 6765 2920 6966 206f 732e 7061  eimage) if os.pa
+0001e550: 7468 2e69 7366 696c 6528 7365 6c66 2e77  th.isfile(self.w
+0001e560: 6f72 6b64 6972 202b 206d 6170 7873 6361  orkdir + mapxsca
+0001e570: 6c65 696d 6167 6529 2065 6c73 6520 4e6f  leimage) else No
+0001e580: 6e65 0a0a 2020 2020 2020 2020 6f75 746d  ne..        outm
+0001e590: 6170 7969 6d61 6765 203d 2073 7472 2873  apyimage = str(s
+0001e5a0: 656c 662e 6d61 706e 616d 6529 202b 2027  elf.mapname) + '
+0001e5b0: 5f79 7375 7266 6163 652e 6a70 6567 270a  _ysurface.jpeg'.
+0001e5c0: 2020 2020 2020 2020 6d61 7079 6c69 7374          mapylist
+0001e5d0: 203d 206f 7574 6d61 7079 696d 6167 652e   = outmapyimage.
+0001e5e0: 7370 6c69 7428 275f 2729 0a20 2020 2020  split('_').     
+0001e5f0: 2020 206d 6170 7973 6361 6c65 696d 6167     mapyscaleimag
+0001e600: 6520 3d20 275f 272e 6a6f 696e 286d 6170  e = '_'.join(map
+0001e610: 796c 6973 745b 3a2d 315d 2920 2b20 275f  ylist[:-1]) + '_
+0001e620: 7363 616c 6564 5f27 202b 206d 6170 796c  scaled_' + mapyl
+0001e630: 6973 745b 2d31 5d0a 2020 2020 2020 2020  ist[-1].        
+0001e640: 7375 7266 6163 6576 6965 776a 736f 6e5b  surfaceviewjson[
+0001e650: 2779 275d 203d 206f 732e 7061 7468 2e62  'y'] = os.path.b
+0001e660: 6173 656e 616d 6528 6d61 7079 7363 616c  asename(mapyscal
+0001e670: 6569 6d61 6765 2920 6966 206f 732e 7061  eimage) if os.pa
+0001e680: 7468 2e69 7366 696c 6528 7365 6c66 2e77  th.isfile(self.w
+0001e690: 6f72 6b64 6972 202b 206d 6170 7973 6361  orkdir + mapysca
+0001e6a0: 6c65 696d 6167 6529 2065 6c73 6520 4e6f  leimage) else No
+0001e6b0: 6e65 0a0a 2020 2020 2020 2020 6f75 746d  ne..        outm
+0001e6c0: 6170 7a69 6d61 6765 203d 2073 7472 2873  apzimage = str(s
+0001e6d0: 656c 662e 6d61 706e 616d 6529 202b 2027  elf.mapname) + '
+0001e6e0: 5f7a 7375 7266 6163 652e 6a70 6567 270a  _zsurface.jpeg'.
+0001e6f0: 2020 2020 2020 2020 6d61 707a 6c69 7374          mapzlist
+0001e700: 203d 206f 7574 6d61 707a 696d 6167 652e   = outmapzimage.
+0001e710: 7370 6c69 7428 275f 2729 0a20 2020 2020  split('_').     
+0001e720: 2020 206d 6170 7a73 6361 6c65 696d 6167     mapzscaleimag
+0001e730: 6520 3d20 275f 272e 6a6f 696e 286d 6170  e = '_'.join(map
+0001e740: 7a6c 6973 745b 3a2d 315d 2920 2b20 275f  zlist[:-1]) + '_
+0001e750: 7363 616c 6564 5f27 202b 206d 6170 7a6c  scaled_' + mapzl
+0001e760: 6973 745b 2d31 5d0a 2020 2020 2020 2020  ist[-1].        
+0001e770: 7375 7266 6163 6576 6965 776a 736f 6e5b  surfaceviewjson[
+0001e780: 277a 275d 203d 206f 732e 7061 7468 2e62  'z'] = os.path.b
+0001e790: 6173 656e 616d 6528 6d61 707a 7363 616c  asename(mapzscal
+0001e7a0: 6569 6d61 6765 2920 6966 206f 732e 7061  eimage) if os.pa
+0001e7b0: 7468 2e69 7366 696c 6528 7365 6c66 2e77  th.isfile(self.w
+0001e7c0: 6f72 6b64 6972 202b 206d 6170 7a73 6361  orkdir + mapzsca
+0001e7d0: 6c65 696d 6167 6529 2065 6c73 6520 4e6f  leimage) else No
+0001e7e0: 6e65 0a20 2020 2020 2020 2069 6620 6572  ne.        if er
+0001e7f0: 726c 6973 743a 0a20 2020 2020 2020 2020  rlist:.         
+0001e800: 2020 2073 7572 6661 6365 7669 6577 6a73     surfaceviewjs
+0001e810: 6f6e 5b27 6572 7227 5d20 3d20 7b27 6d61  on['err'] = {'ma
+0001e820: 705f 7375 7266 6163 655f 6572 7227 3a20  p_surface_err': 
+0001e830: 6572 726c 6973 747d 0a0a 2020 2020 2020  errlist}..      
+0001e840: 2020 6669 6e61 6c64 6963 7420 3d20 7b27    finaldict = {'
+0001e850: 6d61 705f 7375 7266 6163 6527 3a20 7375  map_surface': su
+0001e860: 7266 6163 6576 6965 776a 736f 6e7d 0a0a  rfaceviewjson}..
+0001e870: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+0001e880: 2020 2020 2020 2020 2077 6974 6820 636f           with co
+0001e890: 6465 6373 2e6f 7065 6e28 7365 6c66 2e77  decs.open(self.w
+0001e8a0: 6f72 6b64 6972 202b 2073 656c 662e 6d61  orkdir + self.ma
+0001e8b0: 706e 616d 6520 2b20 275f 6d61 7073 7572  pname + '_mapsur
+0001e8c0: 6661 6365 7669 6577 2e6a 736f 6e27 2c20  faceview.json', 
+0001e8d0: 2777 272c 0a20 2020 2020 2020 2020 2020  'w',.           
 0001e8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e8f0: 2020 2020 7265 7369 6475 6573 203d 2076      residues = v
-0001e900: 616c 7565 5b6b 6579 5d5b 2772 6573 6964  alue[key]['resid
-0001e910: 7565 275d 0a20 2020 2020 2020 2020 2020  ue'].           
-0001e920: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-0001e930: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0001e940: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0001e950: 6f64 656c 6e61 6d65 203d 2076 616c 7565  odelname = value
-0001e960: 5b6b 6579 5d0a 2020 2020 2020 2020 2020  [key].          
-0001e970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e980: 2020 6d6f 6465 6c20 3d20 7365 6c66 2e77    model = self.w
-0001e990: 6f72 6b64 6972 202b 206d 6f64 656c 6e61  orkdir + modelna
-0001e9a0: 6d65 0a20 2020 2020 2020 2020 2020 2020  me.             
-0001e9b0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0001e9c0: 6869 6d65 7261 666e 616d 6520 3d20 277b  himerafname = '{
-0001e9d0: 7d5f 7b7d 5f66 6974 5f63 6869 6d65 7261  }_{}_fit_chimera
-0001e9e0: 2e63 7863 272e 666f 726d 6174 286d 6f64  .cxc'.format(mod
-0001e9f0: 656c 6e61 6d65 2c20 6d61 706e 616d 6529  elname, mapname)
-0001ea00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ea10: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-0001ea20: 6e74 2863 6869 6d65 7261 666e 616d 6529  nt(chimerafname)
-0001ea30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ea40: 2020 2020 2020 2020 2020 2020 2073 7572               sur
-0001ea50: 6661 6365 666e 203d 2027 7b7d 7b7d 5f7b  facefn = '{}{}_{
-0001ea60: 7d27 2e66 6f72 6d61 7428 6261 7365 6469  }'.format(basedi
-0001ea70: 722c 206d 6f64 656c 6e61 6d65 2c20 6d61  r, modelname, ma
-0001ea80: 706e 616d 6529 0a20 2020 2020 2020 2020  pname).         
-0001ea90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001eaa0: 2020 2063 6869 6d65 7261 636d 6420 3d20     chimeracmd = 
-0001eab0: 6368 696d 6572 6166 6e61 6d65 0a20 2020  chimerafname.   
-0001eac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ead0: 2077 6974 6820 6f70 656e 2873 656c 662e   with open(self.
-0001eae0: 776f 726b 6469 7220 2b20 6368 696d 6572  workdir + chimer
-0001eaf0: 6163 6d64 2c20 2777 2729 2061 7320 6670  acmd, 'w') as fp
-0001eb00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001eb10: 2020 2020 2020 2020 2020 6670 2e77 7269            fp.wri
-0001eb20: 7465 2822 6f70 656e 2022 202b 2073 7472  te("open " + str
-0001eb30: 286d 6f64 656c 2920 2b20 2220 666f 726d  (model) + " form
-0001eb40: 6174 206d 6d63 6966 2220 2b20 275c 6e27  at mmcif" + '\n'
-0001eb50: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001eb60: 2020 2020 2020 2020 2020 6670 2e77 7269            fp.wri
-0001eb70: 7465 2827 7368 6f77 2073 656c 4174 6f6d  te('show selAtom
-0001eb80: 7320 7269 6262 6f6e 7327 202b 2027 5c6e  s ribbons' + '\n
-0001eb90: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
-0001eba0: 2020 2020 2020 2020 2020 2066 702e 7772             fp.wr
-0001ebb0: 6974 6528 2768 6964 6520 7365 6c41 746f  ite('hide selAto
-0001ebc0: 6d73 2720 2b20 275c 6e27 290a 0a20 2020  ms' + '\n')..   
-0001ebd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ebe0: 2020 2020 2066 6f72 2028 636f 6c6f 722c       for (color,
-0001ebf0: 2072 6573 6964 7565 2920 696e 207a 6970   residue) in zip
-0001ec00: 2863 6f6c 6f72 732c 2072 6573 6964 7565  (colors, residue
-0001ec10: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
-0001ec20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ec30: 6368 6169 6e2c 2072 6573 746d 7020 3d20  chain, restmp = 
-0001ec40: 7265 7369 6475 652e 7370 6c69 7428 273a  residue.split(':
-0001ec50: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
-0001ec60: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0001ec70: 204e 6f74 2073 7572 6520 6966 2061 6c6c   Not sure if all
-0001ec80: 2074 6865 206c 6574 7465 7273 2073 686f   the letters sho
-0001ec90: 756c 6420 6265 2072 6570 6c61 6365 640a  uld be replaced.
-0001eca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ecb0: 2020 2020 2020 2020 2020 2020 2320 7265              # re
-0001ecc0: 7320 3d20 7265 2e73 7562 2822 5c44 222c  s = re.sub("\D",
-0001ecd0: 2022 222c 2072 6573 746d 7029 0a20 2020   "", restmp).   
-0001ece0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ecf0: 2020 2020 2020 2020 2072 6573 203d 2072           res = r
-0001ed00: 652e 6669 6e64 616c 6c28 7227 2d3f 5c64  e.findall(r'-?\d
-0001ed10: 2b27 2c20 7265 7374 6d70 295b 305d 0a20  +', restmp)[0]. 
-0001ed20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ed30: 2020 2020 2020 2020 2020 2066 702e 7772             fp.wr
-0001ed40: 6974 6528 0a20 2020 2020 2020 2020 2020  ite(.           
-0001ed50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ed60: 2020 2020 2027 636f 6c6f 7220 2f27 202b       'color /' +
-0001ed70: 2063 6861 696e 202b 2027 3a27 202b 2072   chain + ':' + r
-0001ed80: 6573 202b 2027 2027 202b 2063 6f6c 6f72  es + ' ' + color
-0001ed90: 202b 2027 5c6e 270a 2020 2020 2020 2020   + '\n'.        
-0001eda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001edb0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-0001edc0: 2020 2020 2020 2020 2020 2020 2020 6670                fp
-0001edd0: 2e77 7269 7465 280a 2020 2020 2020 2020  .write(.        
-0001ede0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001edf0: 2020 2020 2273 6574 2062 6743 6f6c 6f72      "set bgColor
-0001ee00: 2077 6869 7465 2220 2b20 275c 6e27 0a20   white" + '\n'. 
-0001ee10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ee20: 2020 2020 2020 2020 2020 2022 6c69 6768             "ligh
-0001ee30: 7469 6e67 2073 6f66 7422 202b 2027 5c6e  ting soft" + '\n
-0001ee40: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0001ee50: 2020 2020 2020 2020 2020 2020 2020 2276                "v
-0001ee60: 6965 7720 636f 6672 2054 7275 6522 202b  iew cofr True" +
-0001ee70: 2027 5c6e 270a 2020 2020 2020 2020 2020   '\n'.          
-0001ee80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ee90: 2020 2273 6176 6520 2220 2b20 7374 7228    "save " + str(
-0001eea0: 7375 7266 6163 6566 6e29 202b 2022 5f7a  surfacefn) + "_z
-0001eeb0: 6669 7473 7572 6661 6365 2e6a 7065 6722  fitsurface.jpeg"
-0001eec0: 202b 2022 2073 7570 6572 7361 6d70 6c65   + " supersample
-0001eed0: 2033 2077 6964 7468 2031 3230 3020 6865   3 width 1200 he
-0001eee0: 6967 6874 2031 3230 3022 202b 2027 5c6e  ight 1200" + '\n
-0001eef0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0001ef00: 2020 2020 2020 2020 2020 2020 2020 2274                "t
-0001ef10: 7572 6e20 7820 2d39 3022 202b 2027 5c6e  urn x -90" + '\n
-0001ef20: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0001ef30: 2020 2020 2020 2020 2020 2020 2020 2274                "t
-0001ef40: 7572 6e20 7920 2d39 3022 202b 2027 5c6e  urn y -90" + '\n
-0001ef50: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0001ef60: 2020 2020 2020 2020 2020 2020 2020 2276                "v
-0001ef70: 6965 7720 636f 6672 2054 7275 6522 202b  iew cofr True" +
-0001ef80: 2027 5c6e 270a 2020 2020 2020 2020 2020   '\n'.          
-0001ef90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001efa0: 2020 2273 6176 6520 2220 2b20 7374 7228    "save " + str(
-0001efb0: 7375 7266 6163 6566 6e29 202b 2022 5f78  surfacefn) + "_x
-0001efc0: 6669 7473 7572 6661 6365 2e6a 7065 6722  fitsurface.jpeg"
-0001efd0: 202b 2022 2073 7570 6572 7361 6d70 6c65   + " supersample
-0001efe0: 2033 2077 6964 7468 2031 3230 3020 6865   3 width 1200 he
-0001eff0: 6967 6874 2031 3230 3022 202b 2027 5c6e  ight 1200" + '\n
-0001f000: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0001f010: 2020 2020 2020 2020 2020 2020 2020 2276                "v
-0001f020: 6965 7720 6f72 6965 6e74 2220 2b20 275c  iew orient" + '\
-0001f030: 6e27 0a20 2020 2020 2020 2020 2020 2020  n'.             
-0001f040: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0001f050: 7475 726e 2078 2039 3022 202b 2027 5c6e  turn x 90" + '\n
-0001f060: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0001f070: 2020 2020 2020 2020 2020 2020 2020 2274                "t
-0001f080: 7572 6e20 7a20 3930 2220 2b20 275c 6e27  urn z 90" + '\n'
-0001f090: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f0a0: 2020 2020 2020 2020 2020 2020 2022 7669               "vi
-0001f0b0: 6577 2063 6f66 7220 5472 7565 2220 2b20  ew cofr True" + 
-0001f0c0: 275c 6e27 0a20 2020 2020 2020 2020 2020  '\n'.           
-0001f0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f0e0: 2022 7361 7665 2022 202b 2073 7472 2873   "save " + str(s
-0001f0f0: 7572 6661 6365 666e 2920 2b20 225f 7966  urfacefn) + "_yf
-0001f100: 6974 7375 7266 6163 652e 6a70 6567 2220  itsurface.jpeg" 
-0001f110: 2b20 2220 7375 7065 7273 616d 706c 6520  + " supersample 
-0001f120: 3320 7769 6474 6820 3132 3030 2068 6569  3 width 1200 hei
-0001f130: 6768 7420 3132 3030 2220 2b20 275c 6e27  ght 1200" + '\n'
-0001f140: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f150: 2020 2020 2020 2020 2020 2020 2022 636c               "cl
-0001f160: 6f73 6520 616c 6c22 202b 2022 5c6e 220a  ose all" + "\n".
+0001e8f0: 2020 656e 636f 6469 6e67 3d27 7574 662d    encoding='utf-
+0001e900: 3827 2920 6173 2066 3a0a 2020 2020 2020  8') as f:.      
+0001e910: 2020 2020 2020 2020 2020 6a73 6f6e 2e64            json.d
+0001e920: 756d 7028 6669 6e61 6c64 6963 742c 2066  ump(finaldict, f
+0001e930: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
+0001e940: 3a0a 2020 2020 2020 2020 2020 2020 6572  :.            er
+0001e950: 7220 3d20 2753 6176 696e 6720 6d61 7020  r = 'Saving map 
+0001e960: 7375 7266 6163 6520 7669 6577 206a 736f  surface view jso
+0001e970: 6e20 6572 726f 723a 207b 7d2e 272e 666f  n error: {}.'.fo
+0001e980: 726d 6174 2873 7973 2e65 7863 5f69 6e66  rmat(sys.exc_inf
+0001e990: 6f28 295b 315d 290a 2020 2020 2020 2020  o()[1]).        
+0001e9a0: 2020 2020 7379 732e 7374 6465 7272 2e77      sys.stderr.w
+0001e9b0: 7269 7465 2865 7272 202b 2027 5c6e 2729  rite(err + '\n')
+0001e9c0: 0a0a 2020 2020 2020 2020 6a70 6567 7320  ..        jpegs 
+0001e9d0: 3d20 676c 6f62 2e67 6c6f 6228 7365 6c66  = glob.glob(self
+0001e9e0: 2e77 6f72 6b64 6972 202b 2027 2f2a 7375  .workdir + '/*su
+0001e9f0: 7266 6163 652e 6a70 6567 2729 0a20 2020  rface.jpeg').   
+0001ea00: 2020 2020 206d 6f64 656c 7375 7266 203d       modelsurf =
+0001ea10: 2064 6963 7428 290a 2020 2020 2020 2020   dict().        
+0001ea20: 6669 6e61 6c6d 6d64 6963 7420 3d20 6469  finalmmdict = di
+0001ea30: 6374 2829 0a20 2020 2020 2020 2069 6620  ct().        if 
+0001ea40: 7365 6c66 2e6d 6f64 656c 733a 0a20 2020  self.models:.   
+0001ea50: 2020 2020 2020 2020 2023 2070 7269 6e74           # print
+0001ea60: 2022 7365 6c66 2e6d 6f64 656c 733a 2573   "self.models:%s
+0001ea70: 2220 2520 7365 6c66 2e6d 6f64 656c 730a  " % self.models.
+0001ea80: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0001ea90: 6d6f 6465 6c20 696e 2073 656c 662e 6d6f  model in self.mo
+0001eaa0: 6465 6c73 3a0a 2020 2020 2020 2020 2020  dels:.          
+0001eab0: 2020 2020 2020 6d6f 6465 6c6e 616d 6520        modelname 
+0001eac0: 3d20 6f73 2e70 6174 682e 6261 7365 6e61  = os.path.basena
+0001ead0: 6d65 286d 6f64 656c 2e66 696c 656e 616d  me(model.filenam
+0001eae0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+0001eaf0: 2020 2073 7572 6661 6365 666e 203d 2027     surfacefn = '
+0001eb00: 7b7d 5f7b 7d27 2e66 6f72 6d61 7428 6d6f  {}_{}'.format(mo
+0001eb10: 6465 6c6e 616d 652c 2073 656c 662e 6d61  delname, self.ma
+0001eb20: 706e 616d 6529 0a20 2020 2020 2020 2020  pname).         
+0001eb30: 2020 2020 2020 206d 6f64 656c 6d61 7073         modelmaps
+0001eb40: 7572 6661 6365 203d 2064 6963 7428 290a  urface = dict().
+0001eb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001eb60: 666f 7220 6a70 6567 2069 6e20 6a70 6567  for jpeg in jpeg
+0001eb70: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0001eb80: 2020 2020 2020 2069 6620 6d6f 6465 6c6e         if modeln
+0001eb90: 616d 6520 696e 206a 7065 6720 616e 6420  ame in jpeg and 
+0001eba0: 2778 7375 7266 6163 6527 2069 6e20 6a70  'xsurface' in jp
+0001ebb0: 6567 3a0a 2020 2020 2020 2020 2020 2020  eg:.            
+0001ebc0: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
+0001ebd0: 6c6d 6170 7375 7266 6163 655b 2778 275d  lmapsurface['x']
+0001ebe0: 203d 2073 7472 2873 7572 6661 6365 666e   = str(surfacefn
+0001ebf0: 2920 2b20 275f 7363 616c 6564 5f78 7375  ) + '_scaled_xsu
+0001ec00: 7266 6163 652e 6a70 6567 270a 2020 2020  rface.jpeg'.    
+0001ec10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ec20: 6966 206d 6f64 656c 6e61 6d65 2069 6e20  if modelname in 
+0001ec30: 6a70 6567 2061 6e64 2027 7973 7572 6661  jpeg and 'ysurfa
+0001ec40: 6365 2720 696e 206a 7065 673a 0a20 2020  ce' in jpeg:.   
+0001ec50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ec60: 2020 2020 206d 6f64 656c 6d61 7073 7572       modelmapsur
+0001ec70: 6661 6365 5b27 7927 5d20 3d20 7374 7228  face['y'] = str(
+0001ec80: 7375 7266 6163 6566 6e29 202b 2027 5f73  surfacefn) + '_s
+0001ec90: 6361 6c65 645f 7973 7572 6661 6365 2e6a  caled_ysurface.j
+0001eca0: 7065 6727 0a20 2020 2020 2020 2020 2020  peg'.           
+0001ecb0: 2020 2020 2020 2020 2069 6620 6d6f 6465           if mode
+0001ecc0: 6c6e 616d 6520 696e 206a 7065 6720 616e  lname in jpeg an
+0001ecd0: 6420 277a 7375 7266 6163 6527 2069 6e20  d 'zsurface' in 
+0001ece0: 6a70 6567 3a0a 2020 2020 2020 2020 2020  jpeg:.          
+0001ecf0: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
+0001ed00: 6465 6c6d 6170 7375 7266 6163 655b 277a  delmapsurface['z
+0001ed10: 275d 203d 2073 7472 2873 7572 6661 6365  '] = str(surface
+0001ed20: 666e 2920 2b20 275f 7363 616c 6564 5f7a  fn) + '_scaled_z
+0001ed30: 7375 7266 6163 652e 6a70 6567 270a 0a20  surface.jpeg'.. 
+0001ed40: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+0001ed50: 6974 6820 6f70 656e 2873 7472 286d 6f64  ith open(str(mod
+0001ed60: 656c 2e66 696c 656e 616d 6529 2920 6173  el.filename)) as
+0001ed70: 2066 3a0a 2020 2020 2020 2020 2020 2020   f:.            
+0001ed80: 2020 2020 2020 2020 7320 3d20 6d6d 6170          s = mmap
+0001ed90: 2e6d 6d61 7028 662e 6669 6c65 6e6f 2829  .mmap(f.fileno()
+0001eda0: 2c20 302c 2061 6363 6573 733d 6d6d 6170  , 0, access=mmap
+0001edb0: 2e41 4343 4553 535f 5245 4144 290a 2020  .ACCESS_READ).  
+0001edc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001edd0: 2020 2320 7079 7468 6f6e 2033 206d 6d61    # python 3 mma
+0001ede0: 702e 6d6d 6170 2866 696c 652e 6669 6c65  p.mmap(file.file
+0001edf0: 6e6f 2829 2c20 302c 2061 6363 6573 733d  no(), 0, access=
+0001ee00: 6d6d 6170 2e41 4343 4553 535f 5245 4144  mmap.ACCESS_READ
+0001ee10: 2920 6173 2073 3a0a 2020 2020 2020 2020  ) as s:.        
+0001ee20: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+0001ee30: 2e66 696e 6428 6227 706f 696e 7420 7379  .find(b'point sy
+0001ee40: 6d6d 6574 7279 206f 7065 7261 7469 6f6e  mmetry operation
+0001ee50: 2729 2021 3d20 2d31 3a0a 2020 2020 2020  ') != -1:.      
+0001ee60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ee70: 2020 6173 7365 6d62 6c65 203d 2054 7275    assemble = Tru
+0001ee80: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+0001ee90: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0001eea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001eeb0: 2020 2020 6173 7365 6d62 6c65 203d 2046      assemble = F
+0001eec0: 616c 7365 0a20 2020 2020 2020 2020 2020  alse.           
+0001eed0: 2020 2020 2061 7373 656d 626c 656d 6170       assemblemap
+0001eee0: 7375 7266 6163 6520 3d20 6469 6374 2829  surface = dict()
+0001eef0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ef00: 2069 6620 6173 7365 6d62 6c65 3a0a 2020   if assemble:.  
+0001ef10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ef20: 2020 6d6f 6465 6c6e 616d 6520 3d20 6f73    modelname = os
+0001ef30: 2e70 6174 682e 6261 7365 6e61 6d65 286d  .path.basename(m
+0001ef40: 6f64 656c 2e66 696c 656e 616d 6529 0a20  odel.filename). 
+0001ef50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ef60: 2020 2073 7572 6661 6365 666e 203d 2027     surfacefn = '
+0001ef70: 7b7d 5f7b 7d27 2e66 6f72 6d61 7428 6d6f  {}_{}'.format(mo
+0001ef80: 6465 6c6e 616d 652c 2073 656c 662e 6d61  delname, self.ma
+0001ef90: 706e 616d 6529 0a20 2020 2020 2020 2020  pname).         
+0001efa0: 2020 2020 2020 2020 2020 2066 6f72 206a             for j
+0001efb0: 7065 6720 696e 206a 7065 6773 3a0a 2020  peg in jpegs:.  
+0001efc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001efd0: 2020 2020 2020 6966 206d 6f64 656c 6e61        if modelna
+0001efe0: 6d65 2069 6e20 6a70 6567 2061 6e64 2027  me in jpeg and '
+0001eff0: 7873 7572 6661 6365 2720 696e 206a 7065  xsurface' in jpe
+0001f000: 673a 0a20 2020 2020 2020 2020 2020 2020  g:.             
+0001f010: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0001f020: 7373 656d 626c 656d 6170 7375 7266 6163  ssemblemapsurfac
+0001f030: 655b 2778 5f61 7373 656d 626c 6527 5d20  e['x_assemble'] 
+0001f040: 3d20 7374 7228 7375 7266 6163 6566 6e29  = str(surfacefn)
+0001f050: 202b 2027 5f61 7373 656d 626c 655f 7363   + '_assemble_sc
+0001f060: 616c 6564 5f78 7375 7266 6163 652e 6a70  aled_xsurface.jp
+0001f070: 6567 270a 2020 2020 2020 2020 2020 2020  eg'.            
+0001f080: 2020 2020 2020 2020 2020 2020 6966 206d              if m
+0001f090: 6f64 656c 6e61 6d65 2069 6e20 6a70 6567  odelname in jpeg
+0001f0a0: 2061 6e64 2027 7973 7572 6661 6365 2720   and 'ysurface' 
+0001f0b0: 696e 206a 7065 673a 0a20 2020 2020 2020  in jpeg:.       
+0001f0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f0d0: 2020 2020 2061 7373 656d 626c 656d 6170       assemblemap
+0001f0e0: 7375 7266 6163 655b 2779 5f61 7373 656d  surface['y_assem
+0001f0f0: 626c 6527 5d20 3d20 7374 7228 7375 7266  ble'] = str(surf
+0001f100: 6163 6566 6e29 202b 2027 5f61 7373 656d  acefn) + '_assem
+0001f110: 626c 655f 7363 616c 6564 5f79 7375 7266  ble_scaled_ysurf
+0001f120: 6163 652e 6a70 6567 270a 2020 2020 2020  ace.jpeg'.      
+0001f130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f140: 2020 6966 206d 6f64 656c 6e61 6d65 2069    if modelname i
+0001f150: 6e20 6a70 6567 2061 6e64 2027 7a73 7572  n jpeg and 'zsur
+0001f160: 6661 6365 2720 696e 206a 7065 673a 0a20  face' in jpeg:. 
 0001f170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f180: 2020 2020 2020 2020 2020 2020 2265 7869              "exi
-0001f190: 7422 0a20 2020 2020 2020 2020 2020 2020  t".             
-0001f1a0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0001f1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f1c0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-0001f1d0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0001f1e0: 206e 6f74 2062 696e 6469 7370 6c61 793a   not bindisplay:
-0001f1f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f200: 2020 2020 2020 2020 2020 2020 2073 7562               sub
-0001f210: 7072 6f63 6573 732e 6368 6563 6b5f 6361  process.check_ca
-0001f220: 6c6c 286c 6f63 4348 494d 4552 4120 2b20  ll(locCHIMERA + 
-0001f230: 2220 2d2d 6f66 6673 6372 6565 6e20 2d2d  " --offscreen --
-0001f240: 6e6f 6775 6920 2220 2b20 7365 6c66 2e77  nogui " + self.w
-0001f250: 6f72 6b64 6972 202b 2063 6869 6d65 7261  orkdir + chimera
-0001f260: 636d 642c 0a20 2020 2020 2020 2020 2020  cmd,.           
-0001f270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f290: 2020 2020 2020 2063 7764 3d73 656c 662e         cwd=self.
-0001f2a0: 776f 726b 6469 722c 2073 6865 6c6c 3d54  workdir, shell=T
-0001f2b0: 7275 6529 0a20 2020 2020 2020 2020 2020  rue).           
-0001f2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f2d0: 2070 7269 6e74 2827 436f 6c6f 7265 6420   print('Colored 
-0001f2e0: 6d6f 6465 6c73 2077 6572 6520 7072 6f64  models were prod
-0001f2f0: 7563 6564 2e27 290a 2020 2020 2020 2020  uced.').        
-0001f300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f310: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0001f320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f330: 2020 7375 6270 726f 6365 7373 2e63 6865    subprocess.che
-0001f340: 636b 5f63 616c 6c28 6c6f 6343 4849 4d45  ck_call(locCHIME
-0001f350: 5241 202b 2022 2022 202b 2073 656c 662e  RA + " " + self.
-0001f360: 776f 726b 6469 7220 2b20 6368 696d 6572  workdir + chimer
-0001f370: 6163 6d64 2c20 6377 643d 7365 6c66 2e77  acmd, cwd=self.w
-0001f380: 6f72 6b64 6972 2c0a 2020 2020 2020 2020  orkdir,.        
-0001f390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f3b0: 2020 2020 2020 2020 2020 7368 656c 6c3d            shell=
-0001f3c0: 5472 7565 290a 2020 2020 2020 2020 2020  True).          
-0001f3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f3e0: 2020 7072 696e 7428 2743 6f6c 6f72 6564    print('Colored
-0001f3f0: 206d 6f64 656c 7320 7765 7265 2070 726f   models were pro
-0001f400: 6475 6365 642e 2729 0a20 2020 2020 2020  duced.').       
-0001f410: 2020 2020 2020 2020 2020 2020 2065 7863               exc
-0001f420: 6570 7420 7375 6270 726f 6365 7373 2e43  ept subprocess.C
-0001f430: 616c 6c65 6450 726f 6365 7373 4572 726f  alledProcessErro
-0001f440: 7220 6173 2073 7562 6572 723a 0a20 2020  r as suberr:.   
-0001f450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f460: 2020 2020 2065 7272 203d 2027 5361 7669       err = 'Savi
-0001f470: 6e67 206d 6f64 656c 207b 7d20 6669 7420  ng model {} fit 
-0001f480: 7375 7266 6163 6520 7669 6577 2065 7272  surface view err
-0001f490: 6f72 3a20 7b7d 2e27 2e66 6f72 6d61 7428  or: {}.'.format(
-0001f4a0: 6d6f 6465 6c6e 616d 652c 2073 7562 6572  modelname, suber
-0001f4b0: 7229 0a20 2020 2020 2020 2020 2020 2020  r).             
-0001f4c0: 2020 2020 2020 2020 2020 2065 7272 6c69             errli
-0001f4d0: 7374 2e61 7070 656e 6428 6572 7229 0a20  st.append(err). 
-0001f4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f4f0: 2020 2020 2020 2073 7973 2e73 7464 6572         sys.stder
-0001f500: 722e 7772 6974 6528 6572 7220 2b20 275c  r.write(err + '\
-0001f510: 6e27 290a 0a20 2020 2020 2020 2020 2020  n')..           
-0001f520: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-0001f530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f540: 2020 2020 2020 7365 6c66 2e73 6361 6c65        self.scale
-0001f550: 5f73 7572 6661 6365 7669 6577 2829 0a20  _surfaceview(). 
-0001f560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f570: 2020 2065 7863 6570 743a 0a20 2020 2020     except:.     
-0001f580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f590: 2020 2065 7272 203d 2027 5363 616c 696e     err = 'Scalin
-0001f5a0: 6720 6d6f 6465 6c20 6669 7420 7375 7266  g model fit surf
-0001f5b0: 6163 6520 7669 6577 2065 7272 6f72 3a20  ace view error: 
-0001f5c0: 7b7d 2e27 2e66 6f72 6d61 7428 7379 732e  {}.'.format(sys.
-0001f5d0: 6578 635f 696e 666f 2829 5b31 5d29 0a20  exc_info()[1]). 
-0001f5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f5f0: 2020 2020 2020 2065 7272 6c69 7374 2e61         errlist.a
-0001f600: 7070 656e 6428 6572 7229 0a20 2020 2020  ppend(err).     
-0001f610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f620: 2020 2073 7973 2e73 7464 6572 722e 7772     sys.stderr.wr
-0001f630: 6974 6528 6572 7220 2b20 275c 6e27 290a  ite(err + '\n').
-0001f640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f650: 2020 2020 206a 7065 6773 203d 2067 6c6f       jpegs = glo
-0001f660: 622e 676c 6f62 2873 656c 662e 776f 726b  b.glob(self.work
-0001f670: 6469 7220 2b20 272f 2a73 7572 6661 6365  dir + '/*surface
-0001f680: 2e6a 7065 6727 290a 2020 2020 2020 2020  .jpeg').        
-0001f690: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
-0001f6a0: 6c73 7572 6620 3d20 6469 6374 2829 0a20  lsurf = dict(). 
-0001f6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f6c0: 2020 2066 696e 616c 6d6d 6469 6374 203d     finalmmdict =
-0001f6d0: 2064 6963 7428 290a 2020 2020 2020 2020   dict().        
-0001f6e0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-0001f6f0: 656c 662e 6d6f 6465 6c73 3a0a 2020 2020  elf.models:.    
-0001f700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f710: 2020 2020 666f 7220 6d6f 6465 6c20 696e      for model in
-0001f720: 2073 656c 662e 6d6f 6465 6c73 3a0a 2020   self.models:.  
-0001f730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f740: 2020 2020 2020 2020 2020 6d6f 6465 6c6e            modeln
-0001f750: 616d 6520 3d20 6f73 2e70 6174 682e 6261  ame = os.path.ba
-0001f760: 7365 6e61 6d65 286d 6f64 656c 2e66 696c  sename(model.fil
-0001f770: 656e 616d 6529 0a20 2020 2020 2020 2020  ename).         
-0001f780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f790: 2020 2073 7572 6661 6365 666e 203d 2027     surfacefn = '
-0001f7a0: 7b7d 5f7b 7d27 2e66 6f72 6d61 7428 6d6f  {}_{}'.format(mo
-0001f7b0: 6465 6c6e 616d 652c 2073 656c 662e 6d61  delname, self.ma
-0001f7c0: 706e 616d 6529 0a20 2020 2020 2020 2020  pname).         
-0001f7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f7e0: 2020 206d 6f64 656c 6d61 7073 7572 6661     modelmapsurfa
-0001f7f0: 6365 203d 2064 6963 7428 290a 2020 2020  ce = dict().    
-0001f800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f810: 2020 2020 2020 2020 666f 7220 6a70 6567          for jpeg
-0001f820: 2069 6e20 6a70 6567 733a 0a20 2020 2020   in jpegs:.     
-0001f830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f840: 2020 2020 2020 2020 2020 2069 6620 6d6f             if mo
-0001f850: 6465 6c6e 616d 6520 696e 206a 7065 6720  delname in jpeg 
-0001f860: 616e 6420 2778 6669 7473 7572 6661 6365  and 'xfitsurface
-0001f870: 2720 696e 206a 7065 673a 0a20 2020 2020  ' in jpeg:.     
-0001f880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f890: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0001f8a0: 6f64 656c 6d61 7073 7572 6661 6365 5b27  odelmapsurface['
-0001f8b0: 7827 5d20 3d20 7374 7228 7375 7266 6163  x'] = str(surfac
-0001f8c0: 6566 6e29 202b 2027 5f73 6361 6c65 645f  efn) + '_scaled_
-0001f8d0: 7866 6974 7375 7266 6163 652e 6a70 6567  xfitsurface.jpeg
-0001f8e0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0001f8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f900: 2020 6966 206d 6f64 656c 6e61 6d65 2069    if modelname i
-0001f910: 6e20 6a70 6567 2061 6e64 2027 7966 6974  n jpeg and 'yfit
-0001f920: 7375 7266 6163 6527 2069 6e20 6a70 6567  surface' in jpeg
-0001f930: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001f180: 2020 2020 2020 2020 2020 2061 7373 656d             assem
+0001f190: 626c 656d 6170 7375 7266 6163 655b 277a  blemapsurface['z
+0001f1a0: 5f61 7373 656d 626c 6527 5d20 3d20 7374  _assemble'] = st
+0001f1b0: 7228 7375 7266 6163 6566 6e29 202b 2027  r(surfacefn) + '
+0001f1c0: 5f61 7373 656d 626c 655f 7363 616c 6564  _assemble_scaled
+0001f1d0: 5f7a 7375 7266 6163 652e 6a70 6567 270a  _zsurface.jpeg'.
+0001f1e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001f1f0: 206d 6572 6765 6464 6963 7420 3d20 6469   mergeddict = di
+0001f200: 6374 286d 6f64 656c 6d61 7073 7572 6661  ct(modelmapsurfa
+0001f210: 6365 2c20 2a2a 6173 7365 6d62 6c65 6d61  ce, **assemblema
+0001f220: 7073 7572 6661 6365 290a 2020 2020 2020  psurface).      
+0001f230: 2020 2020 2020 2020 2020 6d6f 6465 6c73            models
+0001f240: 7572 665b 6d6f 6465 6c6e 616d 655d 203d  urf[modelname] =
+0001f250: 206d 6572 6765 6464 6963 740a 2020 2020   mergeddict.    
+0001f260: 2020 2020 6966 206d 6d65 7272 6c69 7374      if mmerrlist
+0001f270: 3a0a 2020 2020 2020 2020 2020 2020 6d6f  :.            mo
+0001f280: 6465 6c73 7572 665b 2765 7272 275d 203d  delsurf['err'] =
+0001f290: 207b 276d 6170 6d6f 6465 6c5f 7375 7266   {'mapmodel_surf
+0001f2a0: 6163 655f 6572 7227 3a20 6d6d 6572 726c  ace_err': mmerrl
+0001f2b0: 6973 747d 0a20 2020 2020 2020 2066 696e  ist}.        fin
+0001f2c0: 616c 6d6d 6469 6374 5b27 6d61 706d 6f64  almmdict['mapmod
+0001f2d0: 656c 5f73 7572 6661 6365 275d 203d 206d  el_surface'] = m
+0001f2e0: 6f64 656c 7375 7266 0a0a 2020 2020 2020  odelsurf..      
+0001f2f0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+0001f300: 2020 2077 6974 6820 636f 6465 6373 2e6f     with codecs.o
+0001f310: 7065 6e28 7365 6c66 2e77 6f72 6b64 6972  pen(self.workdir
+0001f320: 202b 2073 656c 662e 6d61 706e 616d 6520   + self.mapname 
+0001f330: 2b20 275f 6d61 706d 6f64 656c 7375 7266  + '_mapmodelsurf
+0001f340: 6163 6576 6965 772e 6a73 6f6e 272c 2027  aceview.json', '
+0001f350: 7727 2c0a 2020 2020 2020 2020 2020 2020  w',.            
+0001f360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f370: 2020 2020 656e 636f 6469 6e67 3d27 7574      encoding='ut
+0001f380: 662d 3827 2920 6173 2066 3a0a 2020 2020  f-8') as f:.    
+0001f390: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
+0001f3a0: 2e64 756d 7028 6669 6e61 6c6d 6d64 6963  .dump(finalmmdic
+0001f3b0: 742c 2066 290a 2020 2020 2020 2020 6578  t, f).        ex
+0001f3c0: 6365 7074 3a0a 2020 2020 2020 2020 2020  cept:.          
+0001f3d0: 2020 6572 7220 3d20 2753 6176 696e 6720    err = 'Saving 
+0001f3e0: 6d6f 6465 6c20 616e 6420 6d61 7020 7375  model and map su
+0001f3f0: 7266 6163 6520 7669 6577 7320 6a73 6f6e  rface views json
+0001f400: 2065 7272 6f72 3a20 7b7d 2e27 2e66 6f72   error: {}.'.for
+0001f410: 6d61 7428 7379 732e 6578 635f 696e 666f  mat(sys.exc_info
+0001f420: 2829 5b31 5d29 0a20 2020 2020 2020 2020  ()[1]).         
+0001f430: 2020 2073 7973 2e73 7464 6572 722e 7772     sys.stderr.wr
+0001f440: 6974 6528 6572 7220 2b20 275c 6e27 290a  ite(err + '\n').
+0001f450: 0a20 2020 2020 2020 2065 6e64 203d 2074  .        end = t
+0001f460: 696d 6569 742e 6465 6661 756c 745f 7469  imeit.default_ti
+0001f470: 6d65 7228 290a 2020 2020 2020 2020 7072  mer().        pr
+0001f480: 696e 7428 2753 7572 6661 6365 7669 6577  int('Surfaceview
+0001f490: 2074 696d 653a 2025 7327 2025 2028 656e   time: %s' % (en
+0001f4a0: 6420 2d20 7374 6172 7429 290a 2020 2020  d - start)).    
+0001f4b0: 2020 2020 7072 696e 7428 272d 2d2d 2d2d      print('-----
+0001f4c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0001f4d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d27  ---------------'
+0001f4e0: 290a 0a0a 2020 2020 6465 6620 6d6f 6465  )...    def mode
+0001f4f0: 6c66 6974 7375 7266 6163 6528 7365 6c66  lfitsurface(self
+0001f500: 2c20 6368 696d 6572 6161 7070 293a 0a0a  , chimeraapp):..
+0001f510: 2020 2020 2020 2020 2320 7265 6164 206a          # read j
+0001f520: 736f 6e0a 2020 2020 2020 2020 7374 6172  son.        star
+0001f530: 7420 3d20 7469 6d65 6974 2e64 6566 6175  t = timeit.defau
+0001f540: 6c74 5f74 696d 6572 2829 0a20 2020 2020  lt_timer().     
+0001f550: 2020 2069 6e6a 736f 6e20 3d20 676c 6f62     injson = glob
+0001f560: 2e67 6c6f 6228 7365 6c66 2e77 6f72 6b64  .glob(self.workd
+0001f570: 6972 202b 2027 2a72 6573 6964 7565 5f69  ir + '*residue_i
+0001f580: 6e63 6c75 7369 6f6e 2e6a 736f 6e27 290a  nclusion.json').
+0001f590: 2020 2020 2020 2020 6261 7365 6469 7220          basedir 
+0001f5a0: 3d20 7365 6c66 2e77 6f72 6b64 6972 0a20  = self.workdir. 
+0001f5b0: 2020 2020 2020 206d 6170 6e61 6d65 203d         mapname =
+0001f5c0: 2073 656c 662e 6d61 706e 616d 650a 2020   self.mapname.  
+0001f5d0: 2020 2020 2020 6c6f 6343 4849 4d45 5241        locCHIMERA
+0001f5e0: 203d 2063 6869 6d65 7261 6170 700a 2020   = chimeraapp.  
+0001f5f0: 2020 2020 2020 6269 6e64 6973 706c 6179        bindisplay
+0001f600: 203d 206f 732e 6765 7465 6e76 2827 4449   = os.getenv('DI
+0001f610: 5350 4c41 5927 290a 2020 2020 2020 2020  SPLAY').        
+0001f620: 6572 726c 6973 7420 3d20 5b5d 0a0a 2020  errlist = []..  
+0001f630: 2020 2020 2020 6675 6c69 6e6a 736f 6e20        fulinjson 
+0001f640: 3d20 696e 6a73 6f6e 5b30 5d20 6966 2069  = injson[0] if i
+0001f650: 6e6a 736f 6e20 656c 7365 204e 6f6e 650a  njson else None.
+0001f660: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+0001f670: 2020 2020 2020 2020 2069 6620 6675 6c69           if fuli
+0001f680: 6e6a 736f 6e3a 0a20 2020 2020 2020 2020  njson:.         
+0001f690: 2020 2020 2020 2077 6974 6820 6f70 656e         with open
+0001f6a0: 2866 756c 696e 6a73 6f6e 2c20 2772 2729  (fulinjson, 'r')
+0001f6b0: 2061 7320 663a 0a20 2020 2020 2020 2020   as f:.         
+0001f6c0: 2020 2020 2020 2020 2020 2061 7267 7320             args 
+0001f6d0: 3d20 6a73 6f6e 2e6c 6f61 6428 6629 0a20  = json.load(f). 
+0001f6e0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0001f6f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001f700: 2061 7267 7320 3d20 4e6f 6e65 0a20 2020   args = None.   
+0001f710: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+0001f720: 6e74 2827 5468 6572 6520 6973 206e 6f20  nt('There is no 
+0001f730: 7265 7369 6475 6520 696e 636c 7573 696f  residue inclusio
+0001f740: 6e20 6a73 6f6e 2066 696c 652e 2729 0a20  n json file.'). 
+0001f750: 2020 2020 2020 2065 7863 6570 7420 5479         except Ty
+0001f760: 7065 4572 726f 723a 0a20 2020 2020 2020  peError:.       
+0001f770: 2020 2020 2065 7272 203d 2027 4f70 656e       err = 'Open
+0001f780: 2072 6573 6964 7565 5f69 6e63 6c75 7369   residue_inclusi
+0001f790: 6f6e 2065 7272 6f72 3a20 7b7d 2e27 2e66  on error: {}.'.f
+0001f7a0: 6f72 6d61 7428 7379 732e 6578 635f 696e  ormat(sys.exc_in
+0001f7b0: 666f 2829 5b31 5d29 0a20 2020 2020 2020  fo()[1]).       
+0001f7c0: 2020 2020 2065 7272 6c69 7374 2e61 7070       errlist.app
+0001f7d0: 656e 6428 6572 7229 0a20 2020 2020 2020  end(err).       
+0001f7e0: 2020 2020 2073 7973 2e73 7464 6572 722e       sys.stderr.
+0001f7f0: 7772 6974 6528 6572 7220 2b20 275c 6e27  write(err + '\n'
+0001f800: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+0001f810: 2020 2020 2020 2020 2020 2020 6966 2061              if a
+0001f820: 7267 7320 6973 206e 6f74 204e 6f6e 653a  rgs is not None:
+0001f830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001f840: 206d 6f64 656c 7320 3d20 6172 6773 5b27   models = args['
+0001f850: 7265 7369 6475 655f 696e 636c 7573 696f  residue_inclusio
+0001f860: 6e27 5d0a 2020 2020 2020 2020 2020 2020  n'].            
+0001f870: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0001f880: 2020 2020 2020 2020 2020 2020 2064 656c               del
+0001f890: 206d 6f64 656c 735b 2765 7272 275d 0a20   models['err']. 
+0001f8a0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0001f8b0: 7863 6570 743a 0a20 2020 2020 2020 2020  xcept:.         
+0001f8c0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0001f8d0: 2827 5265 7369 6475 6520 696e 636c 7573  ('Residue inclus
+0001f8e0: 696f 6e20 6a73 6f6e 2072 6573 756c 7420  ion json result 
+0001f8f0: 6973 2063 6f72 7265 6374 2729 0a0a 2020  is correct')..  
+0001f900: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+0001f910: 696e 7428 2754 6865 7265 2069 732f 6172  int('There is/ar
+0001f920: 6520 2573 206d 6f64 656c 2873 292e 2720  e %s model(s).' 
+0001f930: 2520 6c65 6e28 6d6f 6465 6c73 2929 0a0a  % len(models))..
 0001f940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f950: 2020 2020 2020 6d6f 6465 6c6d 6170 7375        modelmapsu
-0001f960: 7266 6163 655b 2779 275d 203d 2073 7472  rface['y'] = str
-0001f970: 2873 7572 6661 6365 666e 2920 2b20 275f  (surfacefn) + '_
-0001f980: 7363 616c 6564 5f79 6669 7473 7572 6661  scaled_yfitsurfa
-0001f990: 6365 2e6a 7065 6727 0a20 2020 2020 2020  ce.jpeg'.       
-0001f9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f9b0: 2020 2020 2020 2020 2069 6620 6d6f 6465           if mode
-0001f9c0: 6c6e 616d 6520 696e 206a 7065 6720 616e  lname in jpeg an
-0001f9d0: 6420 277a 6669 7473 7572 6661 6365 2720  d 'zfitsurface' 
-0001f9e0: 696e 206a 7065 673a 0a20 2020 2020 2020  in jpeg:.       
-0001f9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fa00: 2020 2020 2020 2020 2020 2020 206d 6f64               mod
-0001fa10: 656c 6d61 7073 7572 6661 6365 5b27 7a27  elmapsurface['z'
-0001fa20: 5d20 3d20 7374 7228 7375 7266 6163 6566  ] = str(surfacef
-0001fa30: 6e29 202b 2027 5f73 6361 6c65 645f 7a66  n) + '_scaled_zf
-0001fa40: 6974 7375 7266 6163 652e 6a70 6567 270a  itsurface.jpeg'.
-0001fa50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fa60: 2020 2020 2020 2020 2020 2020 6966 2065              if e
-0001fa70: 7272 6c69 7374 3a0a 2020 2020 2020 2020  rrlist:.        
-0001fa80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fa90: 2020 2020 2020 2020 6d6f 6465 6c73 7572          modelsur
-0001faa0: 665b 2765 7272 275d 203d 207b 276d 6f64  f['err'] = {'mod
-0001fab0: 656c 5f66 6974 5f65 7272 273a 2065 7272  el_fit_err': err
-0001fac0: 6c69 7374 7d0a 2020 2020 2020 2020 2020  list}.          
+0001f950: 666f 7220 286b 6579 2c20 7661 6c75 6529  for (key, value)
+0001f960: 2069 6e20 6974 6572 6974 656d 7328 6d6f   in iteritems(mo
+0001f970: 6465 6c73 293a 0a20 2020 2020 2020 2020  dels):.         
+0001f980: 2020 2020 2020 2020 2020 2023 2066 6f72             # for
+0001f990: 2028 6b65 7932 2c20 7661 6c75 6532 2920   (key2, value2) 
+0001f9a0: 696e 2069 7465 7269 7465 6d73 2876 616c  in iteritems(val
+0001f9b0: 7565 293a 0a20 2020 2020 2020 2020 2020  ue):.           
+0001f9c0: 2020 2020 2020 2020 206b 6579 6c69 7374           keylist
+0001f9d0: 203d 206c 6973 7428 7661 6c75 6529 0a20   = list(value). 
+0001f9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f9f0: 2020 2066 6f72 206b 6579 2069 6e20 6b65     for key in ke
+0001fa00: 796c 6973 743a 0a20 2020 2020 2020 2020  ylist:.         
+0001fa10: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0001fa20: 6620 6b65 7920 213d 2027 6e61 6d65 273a  f key != 'name':
+0001fa30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001fa40: 2020 2020 2020 2020 2020 2020 2063 6f6c               col
+0001fa50: 6f72 7320 3d20 7661 6c75 655b 6b65 795d  ors = value[key]
+0001fa60: 5b27 636f 6c6f 7227 5d0a 2020 2020 2020  ['color'].      
+0001fa70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fa80: 2020 2020 2020 7265 7369 6475 6573 203d        residues =
+0001fa90: 2076 616c 7565 5b6b 6579 5d5b 2772 6573   value[key]['res
+0001faa0: 6964 7565 275d 0a20 2020 2020 2020 2020  idue'].         
+0001fab0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0001fac0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
 0001fad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fae0: 2020 6d6f 6465 6c73 7572 665b 6d6f 6465    modelsurf[mode
-0001faf0: 6c6e 616d 655d 203d 206d 6f64 656c 6d61  lname] = modelma
-0001fb00: 7073 7572 6661 6365 0a20 2020 2020 2020  psurface.       
-0001fb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fb20: 2066 696e 616c 6d6d 6469 6374 5b27 6d6f   finalmmdict['mo
-0001fb30: 6465 6c66 6974 5f73 7572 6661 6365 275d  delfit_surface']
-0001fb40: 203d 206d 6f64 656c 7375 7266 0a0a 2020   = modelsurf..  
-0001fb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fb60: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0001fb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fb80: 2020 2020 2020 2077 6974 6820 636f 6465         with code
-0001fb90: 6373 2e6f 7065 6e28 7365 6c66 2e77 6f72  cs.open(self.wor
-0001fba0: 6b64 6972 202b 2073 656c 662e 6d61 706e  kdir + self.mapn
-0001fbb0: 616d 6520 2b20 275f 6d6f 6465 6c66 6974  ame + '_modelfit
-0001fbc0: 7375 7266 6163 6576 6965 772e 6a73 6f6e  surfaceview.json
-0001fbd0: 272c 2027 7727 2c0a 2020 2020 2020 2020  ', 'w',.        
-0001fbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fc00: 2020 2020 2065 6e63 6f64 696e 673d 2775       encoding='u
-0001fc10: 7466 2d38 2729 2061 7320 663a 0a20 2020  tf-8') as f:.   
+0001fae0: 206d 6f64 656c 6e61 6d65 203d 2076 616c   modelname = val
+0001faf0: 7565 5b6b 6579 5d0a 2020 2020 2020 2020  ue[key].        
+0001fb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fb10: 2020 2020 6d6f 6465 6c20 3d20 7365 6c66      model = self
+0001fb20: 2e77 6f72 6b64 6972 202b 206d 6f64 656c  .workdir + model
+0001fb30: 6e61 6d65 0a20 2020 2020 2020 2020 2020  name.           
+0001fb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fb50: 2063 6869 6d65 7261 666e 616d 6520 3d20   chimerafname = 
+0001fb60: 277b 7d5f 7b7d 5f66 6974 5f63 6869 6d65  '{}_{}_fit_chime
+0001fb70: 7261 2e63 7863 272e 666f 726d 6174 286d  ra.cxc'.format(m
+0001fb80: 6f64 656c 6e61 6d65 2c20 6d61 706e 616d  odelname, mapnam
+0001fb90: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+0001fba0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0001fbb0: 7269 6e74 2863 6869 6d65 7261 666e 616d  rint(chimerafnam
+0001fbc0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+0001fbd0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0001fbe0: 7572 6661 6365 666e 203d 2027 7b7d 7b7d  urfacefn = '{}{}
+0001fbf0: 5f7b 7d27 2e66 6f72 6d61 7428 6261 7365  _{}'.format(base
+0001fc00: 6469 722c 206d 6f64 656c 6e61 6d65 2c20  dir, modelname, 
+0001fc10: 6d61 706e 616d 6529 0a20 2020 2020 2020  mapname).       
 0001fc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fc30: 2020 2020 2020 2020 2020 2020 206a 736f               jso
-0001fc40: 6e2e 6475 6d70 2866 696e 616c 6d6d 6469  n.dump(finalmmdi
-0001fc50: 6374 2c20 6629 0a20 2020 2020 2020 2020  ct, f).         
-0001fc60: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0001fc70: 7863 6570 743a 0a20 2020 2020 2020 2020  xcept:.         
-0001fc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fc90: 2020 2073 7973 2e73 7464 6572 722e 7772     sys.stderr.wr
-0001fca0: 6974 6528 2753 6176 696e 6720 6d6f 6465  ite('Saving mode
-0001fcb0: 6c20 6669 7420 7375 7266 6163 6520 7669  l fit surface vi
-0001fcc0: 6577 2074 6f20 6a73 6f6e 2065 7272 6f72  ew to json error
-0001fcd0: 3a20 7b7d 2e5c 6e27 2e66 6f72 6d61 7428  : {}.\n'.format(
-0001fce0: 7379 732e 6578 635f 696e 666f 2829 5b31  sys.exc_info()[1
-0001fcf0: 5d29 290a 0a20 2020 2020 2020 2020 2020  ]))..           
-0001fd00: 2020 2020 2065 6e64 203d 2074 696d 6569       end = timei
-0001fd10: 742e 6465 6661 756c 745f 7469 6d65 7228  t.default_timer(
-0001fd20: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001fd30: 2020 7072 696e 7428 274d 6f64 656c 6669    print('Modelfi
-0001fd40: 7473 7572 6661 6365 2074 696d 653a 2025  tsurface time: %
-0001fd50: 7327 2025 2028 656e 6420 2d20 7374 6172  s' % (end - star
-0001fd60: 7429 290a 2020 2020 2020 2020 2020 2020  t)).            
-0001fd70: 2020 2020 7072 696e 7428 272d 2d2d 2d2d      print('-----
-0001fd80: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0001fd90: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d27  ---------------'
-0001fda0: 290a 0a0a 2020 2020 6465 6620 7363 616c  )...    def scal
-0001fdb0: 655f 7375 7266 6163 6576 6965 7728 7365  e_surfaceview(se
-0001fdc0: 6c66 293a 0a20 2020 2020 2020 2022 2222  lf):.        """
-0001fdd0: 0a20 2020 2020 2020 2020 2020 2053 6361  .            Sca
-0001fde0: 6c65 2074 6865 2073 7572 6661 6365 2076  le the surface v
-0001fdf0: 6965 7720 696d 6167 6573 2073 697a 6520  iew images size 
-0001fe00: 746f 2033 3030 5833 3030 0a0a 2020 2020  to 300X300..    
-0001fe10: 2020 2020 3a72 6574 7572 6e3a 204e 6f6e      :return: Non
-0001fe20: 650a 2020 2020 2020 2020 2222 220a 0a20  e.        """.. 
-0001fe30: 2020 2020 2020 2023 2069 6d70 6f72 7420         # import 
-0001fe40: 696d 6167 6569 6f0a 2020 2020 2020 2020  imageio.        
-0001fe50: 696d 706f 7274 2067 6c6f 620a 0a20 2020  import glob..   
-0001fe60: 2020 2020 2066 6f72 2069 6d67 6669 6c65       for imgfile
-0001fe70: 2069 6e20 676c 6f62 2e67 6c6f 6228 7365   in glob.glob(se
-0001fe80: 6c66 2e77 6f72 6b64 6972 202b 2027 2a73  lf.workdir + '*s
-0001fe90: 7572 6661 6365 2e6a 7065 6727 293a 0a20  urface.jpeg'):. 
-0001fea0: 2020 2020 2020 2020 2020 2069 6620 2773             if 's
-0001feb0: 6361 6c65 6427 206e 6f74 2069 6e20 696d  caled' not in im
-0001fec0: 6766 696c 653a 0a20 2020 2020 2020 2020  gfile:.         
-0001fed0: 2020 2020 2020 206e 616d 656c 6973 7420         namelist 
-0001fee0: 3d20 696d 6766 696c 652e 7370 6c69 7428  = imgfile.split(
-0001fef0: 272f 2729 5b2d 315d 2e73 706c 6974 2827  '/')[-1].split('
-0001ff00: 5f27 290a 2020 2020 2020 2020 2020 2020  _').            
-0001ff10: 2020 2020 6e61 6d65 6f6e 6520 3d20 275f      nameone = '_
-0001ff20: 272e 6a6f 696e 286e 616d 656c 6973 745b  '.join(namelist[
-0001ff30: 3a2d 315d 290a 2020 2020 2020 2020 2020  :-1]).          
-0001ff40: 2020 2020 2020 6e61 6d65 7477 6f20 3d20        nametwo = 
-0001ff50: 6e61 6d65 6c69 7374 5b2d 315d 0a20 2020  namelist[-1].   
-0001ff60: 2020 2020 2020 2020 2020 2020 206e 7069               npi
-0001ff70: 6d67 203d 2049 6d61 6765 2e6f 7065 6e28  mg = Image.open(
-0001ff80: 696d 6766 696c 6529 0a20 2020 2020 2020  imgfile).       
-0001ff90: 2020 2020 2020 2020 2069 6d20 3d20 6e70           im = np
-0001ffa0: 696d 672e 7265 7369 7a65 2828 3330 302c  img.resize((300,
-0001ffb0: 2033 3030 2929 0a20 2020 2020 2020 2020   300)).         
-0001ffc0: 2020 2020 2020 2069 6d2e 7361 7665 2873         im.save(s
-0001ffd0: 656c 662e 776f 726b 6469 7220 2b20 6e61  elf.workdir + na
-0001ffe0: 6d65 6f6e 6520 2b20 275f 7363 616c 6564  meone + '_scaled
-0001fff0: 5f27 202b 206e 616d 6574 776f 290a 0a20  _' + nametwo).. 
-00020000: 2020 2020 2020 2072 6574 7572 6e20 4e6f         return No
-00020010: 6e65 0a0a 2020 2020 6465 6620 7363 616c  ne..    def scal
-00020020: 655f 6d61 736b 696d 6728 7365 6c66 293a  e_maskimg(self):
-00020030: 0a20 2020 2020 2020 2022 2222 0a0a 2020  .        """..  
-00020040: 2020 2020 2020 3a72 6574 7572 6e3a 204e        :return: N
-00020050: 6f6e 650a 2020 2020 2020 2020 2222 220a  one.        """.
-00020060: 0a20 2020 2020 2020 2023 2069 6d70 6f72  .        # impor
-00020070: 7420 696d 6167 6569 6f0a 2020 2020 2020  t imageio.      
-00020080: 2020 696d 706f 7274 2067 6c6f 620a 0a20    import glob.. 
-00020090: 2020 2020 2020 2066 6f72 2069 6d67 6669         for imgfi
-000200a0: 6c65 2069 6e20 676c 6f62 2e67 6c6f 6228  le in glob.glob(
-000200b0: 7365 6c66 2e77 6f72 6b64 6972 202b 2027  self.workdir + '
-000200c0: 2a6d 6173 6b76 6965 772e 6a70 6567 2729  *maskview.jpeg')
-000200d0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-000200e0: 2027 7363 616c 6564 2720 6e6f 7420 696e   'scaled' not in
-000200f0: 2069 6d67 6669 6c65 3a0a 2020 2020 2020   imgfile:.      
-00020100: 2020 2020 2020 2020 2020 6e61 6d65 6c69            nameli
-00020110: 7374 203d 2069 6d67 6669 6c65 2e73 706c  st = imgfile.spl
-00020120: 6974 2827 2f27 295b 2d31 5d2e 7370 6c69  it('/')[-1].spli
-00020130: 7428 275f 2729 0a20 2020 2020 2020 2020  t('_').         
-00020140: 2020 2020 2020 206e 616d 656f 6e65 203d         nameone =
-00020150: 2027 5f27 2e6a 6f69 6e28 6e61 6d65 6c69   '_'.join(nameli
-00020160: 7374 5b3a 2d31 5d29 0a20 2020 2020 2020  st[:-1]).       
-00020170: 2020 2020 2020 2020 206e 616d 6574 776f           nametwo
-00020180: 203d 206e 616d 656c 6973 745b 2d31 5d0a   = namelist[-1].
-00020190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000201a0: 6e70 696d 6720 3d20 496d 6167 652e 6f70  npimg = Image.op
-000201b0: 656e 2869 6d67 6669 6c65 290a 2020 2020  en(imgfile).    
-000201c0: 2020 2020 2020 2020 2020 2020 696d 203d              im =
-000201d0: 206e 7069 6d67 2e72 6573 697a 6528 2833   npimg.resize((3
-000201e0: 3030 2c20 3330 3029 290a 2020 2020 2020  00, 300)).      
-000201f0: 2020 2020 2020 2020 2020 696d 2e73 6176            im.sav
-00020200: 6528 7365 6c66 2e77 6f72 6b64 6972 202b  e(self.workdir +
-00020210: 206e 616d 656f 6e65 202b 2027 5f73 6361   nameone + '_sca
-00020220: 6c65 645f 2720 2b20 6e61 6d65 7477 6f29  led_' + nametwo)
-00020230: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00020240: 204e 6f6e 650a 0a0a 2020 2020 6465 6620   None...    def 
-00020250: 7a6f 6f6d 696e 2873 656c 662c 696d 672c  zoomin(self,img,
-00020260: 2066 6163 746f 722c 202a 2a6b 7761 7267   factor, **kwarg
-00020270: 7329 3a0a 2020 2020 2020 2020 2222 220a  s):.        """.
-00020280: 2020 2020 2020 2020 2020 2020 5a6f 6f6d              Zoom
-00020290: 2069 6e20 746f 2074 6865 2073 7572 6661   in to the surfa
-000202a0: 6365 2076 6965 7720 696d 6167 6573 0a20  ce view images. 
-000202b0: 2020 2020 2020 203a 7061 7261 6d20 696d         :param im
-000202c0: 673a 2069 6d67 206f 626a 6563 7420 6f66  g: img object of
-000202d0: 2069 6e70 7574 0a20 2020 2020 2020 203a   input.        :
-000202e0: 7265 7475 726e 3a0a 2020 2020 2020 2020  return:.        
-000202f0: 2222 220a 2020 2020 2020 2020 6672 6f6d  """.        from
-00020300: 2073 6369 7079 2e6e 6469 6d61 6765 2069   scipy.ndimage i
-00020310: 6d70 6f72 7420 7a6f 6f6d 0a0a 2020 2020  mport zoom..    
-00020320: 2020 2020 682c 2077 203d 2069 6d67 2e73      h, w = img.s
-00020330: 6861 7065 5b3a 325d 0a20 2020 2020 2020  hape[:2].       
-00020340: 207a 6f6f 6d5f 7475 706c 6520 3d20 2866   zoom_tuple = (f
-00020350: 6163 746f 722c 2920 2a20 3220 2b20 2831  actor,) * 2 + (1
-00020360: 2c29 202a 2028 696d 672e 6e64 696d 202d  ,) * (img.ndim -
-00020370: 2032 290a 2020 2020 2020 2020 6966 2066   2).        if f
-00020380: 6163 746f 7220 213d 2031 2e3a 0a20 2020  actor != 1.:.   
-00020390: 2020 2020 2020 2020 2023 2042 6f75 6e64           # Bound
-000203a0: 696e 6720 626f 7820 6f66 2074 6865 207a  ing box of the z
-000203b0: 6f6f 6d65 642d 696e 2072 6567 696f 6e20  oomed-in region 
-000203c0: 7769 7468 696e 2074 6865 2069 6e70 7574  within the input
-000203d0: 2061 7272 6179 0a20 2020 2020 2020 2020   array.         
-000203e0: 2020 207a 6820 3d20 696e 7428 6e70 2e72     zh = int(np.r
-000203f0: 6f75 6e64 2868 202f 2066 6163 746f 7229  ound(h / factor)
-00020400: 290a 2020 2020 2020 2020 2020 2020 7a77  ).            zw
-00020410: 203d 2069 6e74 286e 702e 726f 756e 6428   = int(np.round(
-00020420: 7720 2f20 6661 6374 6f72 2929 0a20 2020  w / factor)).   
-00020430: 2020 2020 2020 2020 2074 6f70 203d 2028           top = (
-00020440: 6820 2d20 7a68 2920 2f2f 2032 0a20 2020  h - zh) // 2.   
-00020450: 2020 2020 2020 2020 206c 6566 7420 3d20           left = 
-00020460: 2877 202d 207a 7729 202f 2f20 320a 0a20  (w - zw) // 2.. 
-00020470: 2020 2020 2020 2020 2020 206f 7574 203d             out =
-00020480: 207a 6f6f 6d28 696d 675b 746f 703a 746f   zoom(img[top:to
-00020490: 7020 2b20 7a68 2c20 6c65 6674 3a6c 6566  p + zh, left:lef
-000204a0: 7420 2b20 7a77 5d2c 207a 6f6f 6d5f 7475  t + zw], zoom_tu
-000204b0: 706c 652c 202a 2a6b 7761 7267 7329 0a20  ple, **kwargs). 
-000204c0: 2020 2020 2020 2020 2020 2074 7269 6d5f             trim_
-000204d0: 746f 7020 3d20 2828 6f75 742e 7368 6170  top = ((out.shap
-000204e0: 655b 305d 202d 2068 2920 2f2f 2032 290a  e[0] - h) // 2).
-000204f0: 2020 2020 2020 2020 2020 2020 7472 696d              trim
-00020500: 5f6c 6566 7420 3d20 2828 6f75 742e 7368  _left = ((out.sh
-00020510: 6170 655b 315d 202d 2077 2920 2f2f 2032  ape[1] - w) // 2
-00020520: 290a 2020 2020 2020 2020 2020 2020 6f75  ).            ou
-00020530: 7420 3d20 6f75 745b 7472 696d 5f74 6f70  t = out[trim_top
-00020540: 3a74 7269 6d5f 746f 7020 2b20 682c 2074  :trim_top + h, t
-00020550: 7269 6d5f 6c65 6674 3a74 7269 6d5f 6c65  rim_left:trim_le
-00020560: 6674 202b 2077 5d0a 0a20 2020 2020 2020  ft + w]..       
-00020570: 2023 2049 6620 6661 6374 6f72 203d 3d20   # If factor == 
-00020580: 312c 206a 7573 7420 7265 7475 726e 2074  1, just return t
-00020590: 6865 2069 6e70 7574 2061 7272 6179 0a20  he input array. 
-000205a0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000205b0: 2020 2020 2020 2020 206f 7574 203d 2069           out = i
-000205c0: 6d67 0a0a 2020 2020 2020 2020 7265 7475  mg..        retu
-000205d0: 726e 206f 7574 0a0a 0a20 2020 2040 7374  rn out...    @st
-000205e0: 6174 6963 6d65 7468 6f64 0a20 2020 2064  aticmethod.    d
-000205f0: 6566 2073 7572 6661 6365 5f65 6e76 6368  ef surface_envch
-00020600: 6563 6b28 293a 0a20 2020 2020 2020 2022  eck():.        "
-00020610: 2222 0a0a 2020 2020 2020 2020 2020 2020  ""..            
-00020620: 4368 6563 6b20 7468 6520 7275 6e6e 696e  Check the runnin
-00020630: 6720 656e 7669 726f 6e6d 656e 7420 666f  g environment fo
-00020640: 7220 7375 7266 6163 6520 7669 6577 2e0a  r surface view..
-00020650: 2020 2020 2020 2020 2020 2020 4966 2074              If t
-00020660: 6865 206d 6163 6869 6e65 2069 7320 6865  he machine is he
-00020670: 6164 6c65 7373 2c20 7265 6d69 6e64 2074  adless, remind t
-00020680: 6865 2075 7365 7220 7674 6b20 6f72 2043  he user vtk or C
-00020690: 6869 6d65 7261 2068 6176 6520 746f 2062  himera have to b
-000206a0: 6520 6275 696c 6420 696e 2074 6865 2068  e build in the h
-000206b0: 6561 646c 6573 7320 7761 792e 0a20 2020  eadless way..   
-000206c0: 2020 2020 2020 2020 2049 6620 7674 6b20           If vtk 
-000206d0: 6361 6e20 6e6f 7420 696d 706f 7274 6564  can not imported
-000206e0: 2c20 7472 7920 7573 6520 4368 696d 6572  , try use Chimer
-000206f0: 612e 0a0a 2020 2020 2020 2020 3a72 6574  a...        :ret
-00020700: 7572 6e3a 2074 7570 6c65 206f 6620 7674  urn: tuple of vt
-00020710: 6b70 6163 6b20 616e 6420 6368 696d 6572  kpack and chimer
-00020720: 6161 7070 2062 696e 6172 7920 7661 6c75  aapp binary valu
-00020730: 650a 2020 2020 2020 2020 2222 220a 0a20  e.        """.. 
-00020740: 2020 2020 2020 2064 6973 706c 6179 203d         display =
-00020750: 206f 732e 6765 7465 6e76 2827 4449 5350   os.getenv('DISP
-00020760: 4c41 5927 290a 2020 2020 2020 2020 6966  LAY').        if
-00020770: 2064 6973 706c 6179 2069 7320 4e6f 6e65   display is None
-00020780: 3a0a 2020 2020 2020 2020 2020 2020 7072  :.            pr
-00020790: 696e 7428 2759 6f75 206d 6179 2072 756e  int('You may run
-000207a0: 6e69 6e67 2074 6869 7320 7072 6f67 7261  ning this progra
-000207b0: 6d20 6f6e 2061 2068 6561 646c 6573 7320  m on a headless 
-000207c0: 6d61 6368 696e 652e 2050 6c65 6173 6520  machine. Please 
-000207d0: 6d61 6b65 2073 7572 6520 6569 7468 6572  make sure either
-000207e0: 2068 6561 646c 6573 7320 5654 4b20 6f72   headless VTK or
-000207f0: 2068 6561 646c 6573 7327 205c 0a20 2020   headless' \.   
-00020800: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00020810: 4368 696d 6572 6158 2061 7265 2070 726f  ChimeraX are pro
-00020820: 7065 726c 7920 696e 7374 616c 6c65 6420  perly installed 
-00020830: 6163 636f 7264 696e 676c 792e 2729 0a0a  accordingly.')..
-00020840: 2020 2020 2020 2020 7674 6b70 6163 6b20          vtkpack 
-00020850: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
-00020860: 6368 696d 6572 6161 7070 203d 2046 616c  chimeraapp = Fal
-00020870: 7365 0a20 2020 2020 2020 2074 7279 3a0a  se.        try:.
-00020880: 2020 2020 2020 2020 2020 2020 696d 706f              impo
-00020890: 7274 2076 746b 0a20 2020 2020 2020 2020  rt vtk.         
-000208a0: 2020 2076 746b 7061 636b 203d 2054 7275     vtkpack = Tru
-000208b0: 650a 2020 2020 2020 2020 6578 6365 7074  e.        except
-000208c0: 2049 6d70 6f72 7445 7272 6f72 3a0a 2020   ImportError:.  
-000208d0: 2020 2020 2020 2020 2020 7379 732e 7374            sys.st
-000208e0: 6465 7272 2e77 7269 7465 2827 5654 4b20  derr.write('VTK 
-000208f0: 6973 206e 6f74 2069 6e73 7461 6c6c 6564  is not installed
-00020900: 206f 7220 696d 706f 7274 6564 2070 726f   or imported pro
-00020910: 7065 726c 792e 2054 7279 696e 6720 746f  perly. Trying to
-00020920: 2075 7365 2043 6869 6d65 7261 5820 746f   use ChimeraX to
-00020930: 2070 726f 6475 6365 2073 7572 6661 6365   produce surface
-00020940: 2076 6965 7773 2e5c 6e27 290a 0a20 2020   views.\n')..   
-00020950: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00020960: 2020 2020 2020 6966 2043 4849 4d45 5241        if CHIMERA
-00020970: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00020980: 2020 2020 2020 2020 2020 2020 2020 6368                ch
-00020990: 696d 6572 6161 7070 203d 2043 4849 4d45  imeraapp = CHIME
-000209a0: 5241 0a20 2020 2020 2020 2020 2020 2020  RA.             
-000209b0: 2020 2070 7269 6e74 2863 6869 6d65 7261     print(chimera
-000209c0: 6170 7029 0a20 2020 2020 2020 2020 2020  app).           
-000209d0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000209e0: 2020 2020 2020 2061 7373 6572 7420 6669         assert fi
-000209f0: 6e64 5f65 7865 6375 7461 626c 6528 2743  nd_executable('C
-00020a00: 6869 6d65 7261 5827 2920 6973 206e 6f74  himeraX') is not
-00020a10: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
-00020a20: 2020 2020 2020 6368 696d 6572 6161 7070        chimeraapp
-00020a30: 203d 2066 696e 645f 6578 6563 7574 6162   = find_executab
-00020a40: 6c65 2827 4368 696d 6572 6158 2729 0a20  le('ChimeraX'). 
-00020a50: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00020a60: 7269 6e74 2863 6869 6d65 7261 6170 7029  rint(chimeraapp)
-00020a70: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-00020a80: 4173 7365 7274 696f 6e45 7272 6f72 3a0a  AssertionError:.
-00020a90: 2020 2020 2020 2020 2020 2020 2320 7072              # pr
-00020aa0: 696e 7428 2743 6869 6d65 7261 2065 7865  int('Chimera exe
-00020ab0: 6375 7461 626c 6520 6973 206e 6f74 2074  cutable is not t
-00020ac0: 6865 7265 2e27 2c20 6669 6c65 3d73 7973  here.', file=sys
-00020ad0: 2e73 7464 6572 7229 0a20 2020 2020 2020  .stderr).       
-00020ae0: 2020 2020 2073 7973 2e73 7464 6572 722e       sys.stderr.
-00020af0: 7772 6974 6528 2743 6869 6d65 7261 5820  write('ChimeraX 
-00020b00: 6578 6563 7574 6162 6c65 2069 7320 6e6f  executable is no
-00020b10: 7420 7468 6572 652e 5c6e 2729 0a0a 2020  t there.\n')..  
-00020b20: 2020 2020 2020 7265 7475 726e 2076 746b        return vtk
-00020b30: 7061 636b 2c20 6368 696d 6572 6161 7070  pack, chimeraapp
-00020b40: 0a0a 2020 2020 2320 4465 6e73 6974 7920  ..    # Density 
-00020b50: 6469 7374 7269 6275 7469 6f6e 0a20 2020  distribution.   
-00020b60: 2023 2040 7072 6f66 696c 650a 2020 2020   # @profile.    
-00020b70: 6465 6620 6d61 7064 656e 7369 7479 5f64  def mapdensity_d
-00020b80: 6973 7472 6962 7574 696f 6e28 7365 6c66  istribution(self
-00020b90: 293a 0a20 2020 2020 2020 2022 2222 0a0a  ):.        """..
-00020ba0: 2020 2020 2020 2020 2020 2020 7072 6f64              prod
-00020bb0: 7563 6520 7468 6520 6d61 7020 6465 6e73  uce the map dens
-00020bc0: 6974 7920 6469 7374 7269 6275 7469 6f6e  ity distribution
-00020bd0: 0a0a 2020 2020 2020 2020 3a72 6574 7572  ..        :retur
-00020be0: 6e3a 204e 6f6e 650a 2020 2020 2020 2020  n: None.        
-00020bf0: 2222 220a 2020 2020 2020 2020 7365 6c66  """.        self
-00020c00: 2e64 656e 7369 7479 5f64 6973 7472 6962  .density_distrib
-00020c10: 7574 696f 6e28 7365 6c66 2e6d 6170 290a  ution(self.map).
-00020c20: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00020c30: 4e6f 6e65 0a0a 2020 2020 2320 4070 726f  None..    # @pro
-00020c40: 6669 6c65 0a20 2020 2064 6566 2072 6177  file.    def raw
-00020c50: 6d61 7064 656e 7369 7479 5f64 6973 7472  mapdensity_distr
-00020c60: 6962 7574 696f 6e28 7365 6c66 293a 0a20  ibution(self):. 
-00020c70: 2020 2020 2020 2022 2222 0a0a 2020 2020         """..    
-00020c80: 2020 2020 2020 2020 5072 6f64 7563 6520          Produce 
-00020c90: 7261 7720 6d61 7020 6465 6e73 6974 7920  raw map density 
-00020ca0: 6469 7374 7269 6275 7469 6f6e 0a0a 2020  distribution..  
-00020cb0: 2020 2020 2020 3a70 6172 616d 2072 6177        :param raw
-00020cc0: 6d61 703a 2052 6177 206d 6170 206f 626a  map: Raw map obj
-00020cd0: 6563 740a 2020 2020 2020 2020 3a72 6574  ect.        :ret
-00020ce0: 7572 6e3a 204e 6f6e 650a 2020 2020 2020  urn: None.      
-00020cf0: 2020 2222 220a 0a20 2020 2020 2020 2069    """..        i
-00020d00: 6620 7365 6c66 2e72 6177 6d61 7020 6973  f self.rawmap is
-00020d10: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-00020d20: 2020 2020 2020 2073 656c 662e 6465 6e73         self.dens
-00020d30: 6974 795f 6469 7374 7269 6275 7469 6f6e  ity_distribution
-00020d40: 2873 656c 662e 7261 776d 6170 290a 2020  (self.rawmap).  
-00020d50: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00020d60: 2020 2020 2020 2020 7072 696e 7428 2754          print('T
-00020d70: 6865 7265 2069 7320 6e6f 2072 6177 206d  here is no raw m
-00020d80: 6170 2066 6f72 2064 656e 7369 7479 2064  ap for density d
-00020d90: 6973 7472 6962 7574 696f 6e2e 2729 0a20  istribution.'). 
-00020da0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00020db0: 2827 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ('--------------
-00020dc0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00020dd0: 2d2d 2d2d 2d2d 2729 0a0a 2020 2020 2020  ------')..      
-00020de0: 2020 7265 7475 726e 204e 6f6e 650a 0a20    return None.. 
-00020df0: 2020 2023 2040 7072 6f66 696c 650a 2020     # @profile.  
-00020e00: 2020 6465 6620 6465 6e73 6974 795f 6469    def density_di
-00020e10: 7374 7269 6275 7469 6f6e 2873 656c 662c  stribution(self,
-00020e20: 2064 656e 6d61 703d 4e6f 6e65 293a 0a20   denmap=None):. 
-00020e30: 2020 2020 2020 2022 2222 0a0a 2020 2020         """..    
-00020e40: 2020 2020 2020 2020 5072 6f64 7563 6520          Produce 
-00020e50: 6465 6e73 6974 7920 7661 6c75 6520 6469  density value di
-00020e60: 7374 7269 6275 7469 6f6e 2069 6e66 6f72  stribution infor
-00020e70: 6d61 7469 6f6e 2077 6974 6820 7468 6520  mation with the 
-00020e80: 6465 6e73 6974 7920 6d61 7020 696e 666f  density map info
-00020e90: 726d 6174 696f 6e2e 0a20 2020 2020 2020  rmation..       
-00020ea0: 2020 2020 2078 2077 6173 2064 6976 6964       x was divid
-00020eb0: 6564 2069 6e74 6f20 3132 3820 6269 6e73  ed into 128 bins
-00020ec0: 0a20 2020 2020 2020 2020 2020 2079 2077  .            y w
-00020ed0: 6173 2073 6361 6c65 6420 6279 206c 6f67  as scaled by log
-00020ee0: 6172 6974 686d 6963 2031 3020 2866 6f72  arithmic 10 (for
-00020ef0: 2030 2076 616c 7565 2061 6464 2031 2074   0 value add 1 t
-00020f00: 6f20 6967 6f6e 7265 2061 7274 6966 6163  o igonre artifac
-00020f10: 7473 290a 0a20 2020 2020 2020 203a 7061  ts)..        :pa
-00020f20: 7261 6d3a 204e 6f6e 650a 2020 2020 2020  ram: None.      
-00020f30: 2020 3a72 6574 7572 6e3a 204e 6f6e 650a    :return: None.
-00020f40: 0a20 2020 2020 2020 2022 2222 0a0a 2020  .        """..  
-00020f50: 2020 2020 2020 7374 6172 7420 3d20 7469        start = ti
-00020f60: 6d65 6974 2e64 6566 6175 6c74 5f74 696d  meit.default_tim
-00020f70: 6572 2829 0a20 2020 2020 2020 2062 696e  er().        bin
-00020f80: 7320 3d20 3132 380a 2020 2020 2020 2020  s = 128.        
-00020f90: 6572 726c 6973 7420 3d20 5b5d 0a20 2020  errlist = [].   
-00020fa0: 2020 2020 2064 6174 6164 6963 7420 3d20       datadict = 
-00020fb0: 7b7d 0a20 2020 2020 2020 2023 2063 7572  {}.        # cur
-00020fc0: 6d61 706e 616d 6520 3d20 6f73 2e70 6174  mapname = os.pat
-00020fd0: 682e 6261 7365 6e61 6d65 2864 656e 6d61  h.basename(denma
-00020fe0: 702e 6669 6c65 6e61 6d65 290a 2020 2020  p.filename).    
-00020ff0: 2020 2020 6375 726d 6170 6e61 6d65 203d      curmapname =
-00021000: 206f 732e 7061 7468 2e62 6173 656e 616d   os.path.basenam
-00021010: 6528 6465 6e6d 6170 2e66 756c 6c6e 616d  e(denmap.fullnam
-00021020: 6529 0a20 2020 2020 2020 2069 6620 2772  e).        if 'r
-00021030: 6177 6d61 7027 2069 6e20 6375 726d 6170  awmap' in curmap
-00021040: 6e61 6d65 3a0a 2020 2020 2020 2020 2020  name:.          
-00021050: 2020 7461 6720 3d20 2772 6177 6d61 705f    tag = 'rawmap_
-00021060: 270a 2020 2020 2020 2020 656c 7365 3a0a  '.        else:.
-00021070: 2020 2020 2020 2020 2020 2020 7461 6720              tag 
-00021080: 3d20 2727 0a20 2020 2020 2020 2074 7279  = ''.        try
-00021090: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-000210a0: 6d61 7064 6174 6120 3d20 7365 6c66 2e6d  mapdata = self.m
-000210b0: 6170 2e67 6574 4d61 7028 290a 2020 2020  ap.getMap().    
-000210c0: 2020 2020 2020 2020 6d61 7064 6174 6120          mapdata 
-000210d0: 3d20 6465 6e6d 6170 2e64 6174 610a 2020  = denmap.data.  
-000210e0: 2020 2020 2020 2020 2020 666c 6174 6d61            flatma
-000210f0: 7020 3d20 6d61 7064 6174 612e 666c 6174  p = mapdata.flat
-00021100: 7465 6e28 290a 2020 2020 2020 2020 2020  ten().          
-00021110: 2020 2320 6461 7461 6d6f 6465 203d 2073    # datamode = s
-00021120: 656c 662e 6d61 702e 6865 6164 6572 5b33  elf.map.header[3
-00021130: 5d0a 2020 2020 2020 2020 2020 2020 6461  ].            da
-00021140: 7461 6d6f 6465 203d 2073 656c 662e 6d61  tamode = self.ma
-00021150: 702e 6865 6164 6572 2e6d 6f64 650a 2020  p.header.mode.  
-00021160: 2020 2020 2020 2020 2020 756e 6971 7565            unique
-00021170: 732c 2075 6e69 7175 6563 6f75 6e74 7320  s, uniquecounts 
-00021180: 3d20 6e70 2e75 6e69 7175 6528 666c 6174  = np.unique(flat
-00021190: 6d61 702c 2072 6574 7572 6e5f 636f 756e  map, return_coun
-000211a0: 7473 3d54 7275 6529 0a20 2020 2020 2020  ts=True).       
-000211b0: 2020 2020 2075 6e69 7175 656c 656e 203d       uniquelen =
-000211c0: 206c 656e 2875 6e69 7175 6573 290a 2020   len(uniques).  
-000211d0: 2020 2020 2020 2020 2020 6966 2064 6174            if dat
-000211e0: 616d 6f64 6520 3d3d 2030 3a0a 2020 2020  amode == 0:.    
-000211f0: 2020 2020 2020 2020 2020 2020 6269 6e73              bins
-00021200: 203d 2075 6e69 7175 6573 0a20 2020 2020   = uniques.     
-00021210: 2020 2020 2020 2020 2020 2068 6973 742c             hist,
-00021220: 2062 696e 5f65 6467 6573 203d 206e 702e   bin_edges = np.
-00021230: 6869 7374 6f67 7261 6d28 666c 6174 6d61  histogram(flatma
-00021240: 702c 2062 696e 733d 6269 6e73 290a 2020  p, bins=bins).  
-00021250: 2020 2020 2020 2020 2020 656c 6966 2064            elif d
-00021260: 6174 616d 6f64 6520 3d3d 2031 206f 7220  atamode == 1 or 
-00021270: 6461 7461 6d6f 6465 203d 3d20 363a 0a20  datamode == 6:. 
-00021280: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00021290: 6620 756e 6971 7565 6c65 6e20 3e20 3130  f uniquelen > 10
-000212a0: 3030 3a0a 2020 2020 2020 2020 2020 2020  00:.            
-000212b0: 2020 2020 2020 2020 696e 6473 203d 206e          inds = n
-000212c0: 702e 6c69 6e73 7061 6365 2830 2c20 756e  p.linspace(0, un
-000212d0: 6971 7565 6c65 6e2d 312c 206e 756d 3d31  iquelen-1, num=1
-000212e0: 3238 2c20 6474 7970 653d 6e70 2e75 696e  28, dtype=np.uin
-000212f0: 7431 3629 0a20 2020 2020 2020 2020 2020  t16).           
-00021300: 2020 2020 2020 2020 2062 696e 7320 3d20           bins = 
-00021310: 6e70 2e74 616b 6528 756e 6971 7565 732c  np.take(uniques,
-00021320: 2069 6e64 7329 0a20 2020 2020 2020 2020   inds).         
-00021330: 2020 2020 2020 2020 2020 2068 6973 742c             hist,
-00021340: 2062 696e 5f65 6467 6573 203d 206e 702e   bin_edges = np.
-00021350: 6869 7374 6f67 7261 6d28 666c 6174 6d61  histogram(flatma
-00021360: 702c 2062 696e 733d 6269 6e73 290a 2020  p, bins=bins).  
-00021370: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00021380: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00021390: 2020 2020 2020 2020 6869 7374 203d 2075          hist = u
-000213a0: 6e69 7175 6563 6f75 6e74 730a 2020 2020  niquecounts.    
-000213b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000213c0: 6269 6e5f 6564 6765 7320 3d20 6e70 2e61  bin_edges = np.a
-000213d0: 7070 656e 6428 756e 6971 7565 732c 2075  ppend(uniques, u
-000213e0: 6e69 7175 6573 5b2d 315d 290a 2020 2020  niques[-1]).    
-000213f0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00021400: 2020 2020 2020 2020 2020 2020 2020 6269                bi
-00021410: 6e73 203d 206e 702e 6c69 6e73 7061 6365  ns = np.linspace
-00021420: 286d 696e 2866 6c61 746d 6170 292c 206d  (min(flatmap), m
-00021430: 6178 2866 6c61 746d 6170 292c 2031 3238  ax(flatmap), 128
-00021440: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00021450: 2020 6869 7374 2c20 6269 6e5f 6564 6765    hist, bin_edge
-00021460: 7320 3d20 6e70 2e68 6973 746f 6772 616d  s = np.histogram
-00021470: 2866 6c61 746d 6170 2c20 6269 6e73 3d62  (flatmap, bins=b
-00021480: 696e 7329 0a20 2020 2020 2020 2020 2020  ins).           
-00021490: 2023 2068 6973 742c 2062 696e 5f65 6467   # hist, bin_edg
-000214a0: 6573 203d 206e 702e 6869 7374 6f67 7261  es = np.histogra
-000214b0: 6d28 666c 6174 6d61 702c 2062 696e 733d  m(flatmap, bins=
-000214c0: 6269 6e73 290a 2020 2020 2020 2020 2020  bins).          
-000214d0: 2020 6869 7374 5b68 6973 7420 3c20 315d    hist[hist < 1]
-000214e0: 203d 2031 0a20 2020 2020 2020 2020 2020   = 1.           
-000214f0: 206e 6577 6869 7374 203d 206e 702e 6c6f   newhist = np.lo
-00021500: 6731 3028 6869 7374 290a 0a20 2020 2020  g10(hist)..     
-00021510: 2020 2020 2020 2070 6c74 2e66 6967 7572         plt.figur
-00021520: 6528 6669 6773 697a 653d 2831 302c 2033  e(figsize=(10, 3
-00021530: 2929 0a20 2020 2020 2020 2020 2020 2070  )).            p
-00021540: 6c74 2e70 6c6f 7428 6e70 2e72 6f75 6e64  lt.plot(np.round
-00021550: 2862 696e 5f65 6467 6573 5b3a 2d31 5d2c  (bin_edges[:-1],
-00021560: 2031 3029 2e74 6f6c 6973 7428 292c 206e   10).tolist(), n
-00021570: 702e 726f 756e 6428 6e65 7768 6973 742c  p.round(newhist,
-00021580: 2031 3029 2e74 6f6c 6973 7428 2929 0a20   10).tolist()). 
-00021590: 2020 2020 2020 2020 2020 2070 6c74 2e73             plt.s
-000215a0: 6176 6566 6967 2873 656c 662e 776f 726b  avefig(self.work
-000215b0: 6469 7220 2b20 272f 2720 2b20 6375 726d  dir + '/' + curm
-000215c0: 6170 6e61 6d65 202b 2027 5f76 6f78 656c  apname + '_voxel
-000215d0: 5f64 6973 7472 6962 7574 696f 6e2e 706e  _distribution.pn
-000215e0: 6727 290a 2020 2020 2020 2020 2020 2020  g').            
-000215f0: 706c 742e 636c 6f73 6528 290a 0a20 2020  plt.close()..   
-00021600: 2020 2020 2020 2020 206d 6f64 6520 3d20           mode = 
-00021610: 6e70 2e72 6f75 6e64 2862 696e 5f65 6467  np.round(bin_edg
-00021620: 6573 5b3a 2d31 5d5b 6e70 2e61 7267 6d61  es[:-1][np.argma
-00021630: 7828 6e65 7768 6973 7429 5d2c 2035 292e  x(newhist)], 5).
-00021640: 746f 6c69 7374 2829 0a20 2020 2020 2020  tolist().       
-00021650: 2020 2020 2064 6174 6164 6963 7420 3d20       datadict = 
-00021660: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00021670: 2020 7461 6720 2b20 2764 656e 7369 7479    tag + 'density
-00021680: 5f64 6973 7472 6962 7574 696f 6e27 3a20  _distribution': 
-00021690: 7b27 7927 3a20 6e70 2e72 6f75 6e64 286e  {'y': np.round(n
-000216a0: 6577 6869 7374 2c20 3130 292e 746f 6c69  ewhist, 10).toli
-000216b0: 7374 2829 2c0a 2020 2020 2020 2020 2020  st(),.          
-000216c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000216d0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-000216e0: 7827 3a20 6e70 2e72 6f75 6e64 2862 696e  x': np.round(bin
-000216f0: 5f65 6467 6573 5b3a 2d31 5d2c 2031 3029  _edges[:-1], 10)
-00021700: 2e74 6f6c 6973 7428 292c 0a20 2020 2020  .tolist(),.     
-00021710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021730: 2020 2020 276d 6f64 6527 3a20 6d6f 6465      'mode': mode
-00021740: 7d7d 0a20 2020 2020 2020 2065 7863 6570  }}.        excep
-00021750: 743a 0a20 2020 2020 2020 2020 2020 2065  t:.            e
-00021760: 7272 203d 2027 4465 6e73 6974 7920 6469  rr = 'Density di
-00021770: 7374 7269 6275 7469 6f6e 2065 7272 6f72  stribution error
-00021780: 3a7b 7d2e 272e 666f 726d 6174 2873 7973  :{}.'.format(sys
-00021790: 2e65 7863 5f69 6e66 6f28 295b 315d 290a  .exc_info()[1]).
-000217a0: 2020 2020 2020 2020 2020 2020 6572 726c              errl
-000217b0: 6973 742e 6170 7065 6e64 2865 7272 290a  ist.append(err).
-000217c0: 2020 2020 2020 2020 2020 2020 7379 732e              sys.
-000217d0: 7374 6465 7272 2e77 7269 7465 2865 7272  stderr.write(err
-000217e0: 202b 2027 5c6e 2729 0a0a 2020 2020 2020   + '\n')..      
-000217f0: 2020 6966 2065 7272 6c69 7374 3a0a 2020    if errlist:.  
-00021800: 2020 2020 2020 2020 2020 6461 7461 6469            datadi
-00021810: 6374 203d 207b 7461 6720 2b20 2764 656e  ct = {tag + 'den
-00021820: 7369 7479 5f64 6973 7472 6962 7574 696f  sity_distributio
-00021830: 6e27 3a20 7b27 6572 7227 3a20 7b27 6465  n': {'err': {'de
-00021840: 6e73 6974 795f 6469 7374 7269 6275 7469  nsity_distributi
-00021850: 6f6e 5f65 7272 6f72 273a 2065 7272 6c69  on_error': errli
-00021860: 7374 7d7d 7d0a 0a20 2020 2020 2020 2074  st}}}..        t
-00021870: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00021880: 7769 7468 2063 6f64 6563 732e 6f70 656e  with codecs.open
-00021890: 2873 656c 662e 776f 726b 6469 7220 2b20  (self.workdir + 
-000218a0: 6375 726d 6170 6e61 6d65 202b 2027 5f64  curmapname + '_d
-000218b0: 656e 7369 7479 5f64 6973 7472 6962 7574  ensity_distribut
-000218c0: 696f 6e2e 6a73 6f6e 272c 2027 7727 2c0a  ion.json', 'w',.
-000218d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000218e0: 2020 2020 2020 2020 2020 2020 2065 6e63               enc
-000218f0: 6f64 696e 673d 2775 7466 2d38 2729 2061  oding='utf-8') a
-00021900: 7320 663a 0a20 2020 2020 2020 2020 2020  s f:.           
-00021910: 2020 2020 206a 736f 6e2e 6475 6d70 2864       json.dump(d
-00021920: 6174 6164 6963 742c 2066 290a 2020 2020  atadict, f).    
-00021930: 2020 2020 6578 6365 7074 3a0a 2020 2020      except:.    
-00021940: 2020 2020 2020 2020 7379 732e 7374 6465          sys.stde
-00021950: 7272 2e77 7269 7465 2827 5361 7669 6e67  rr.write('Saving
-00021960: 2064 656e 6973 7479 2064 6973 7472 6962   denisty distrib
-00021970: 7574 696f 6e20 746f 206a 736f 6e20 6572  ution to json er
-00021980: 726f 722e 2729 0a0a 2020 2020 2020 2020  ror.')..        
-00021990: 656e 6420 3d20 7469 6d65 6974 2e64 6566  end = timeit.def
-000219a0: 6175 6c74 5f74 696d 6572 2829 0a20 2020  ault_timer().   
-000219b0: 2020 2020 2070 7269 6e74 2874 6167 202b       print(tag +
-000219c0: 2027 4465 6e73 6974 7920 6469 7374 7269   'Density distri
-000219d0: 6275 7469 6f6e 2074 696d 653a 2025 7327  bution time: %s'
-000219e0: 2025 2028 656e 6420 2d20 7374 6172 7429   % (end - start)
-000219f0: 290a 2020 2020 2020 2020 7072 696e 7428  ).        print(
-00021a00: 272d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  '---------------
-00021a10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00021a20: 2d2d 2d2d 2d27 290a 0a20 2020 2020 2020  -----')..       
-00021a30: 2072 6574 7572 6e20 4e6f 6e65 0a0a 2020   return None..  
-00021a40: 2020 2320 4174 6f6d 2061 6e64 2072 6573    # Atom and res
-00021a50: 6964 7565 2069 6e63 6c75 6473 696f 6e0a  idue includsion.
-00021a60: 2020 2020 4073 7461 7469 636d 6574 686f      @staticmetho
-00021a70: 640a 2020 2020 6465 6620 5f5f 666c 6f61  d.    def __floa
-00021a80: 746f 6865 7828 6e75 6d6c 6973 7429 3a0a  tohex(numlist):.
-00021a90: 2020 2020 2020 2020 2222 220a 0a20 2020          """..   
-00021aa0: 2020 2020 2020 2020 2050 726f 6475 6365           Produce
-00021ab0: 2068 6578 2063 6f6c 6f72 2062 6574 7765   hex color betwe
-00021ac0: 656e 2072 6564 2061 6e64 2067 7265 656e  en red and green
-00021ad0: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
-00021ae0: 206e 756d 6c69 7374 3a20 4120 6c69 7374   numlist: A list
-00021af0: 206f 6620 5247 4220 7661 6c75 6573 0a20   of RGB values. 
-00021b00: 2020 2020 2020 203a 7265 7475 726e 3a20         :return: 
-00021b10: 4120 6c69 7374 206f 6620 6865 7820 7661  A list of hex va
-00021b20: 6c75 6520 6265 7477 6565 6e20 5220 616e  lue between R an
-00021b30: 6420 4720 7769 7468 2042 203d 2030 0a0a  d G with B = 0..
-00021b40: 2020 2020 2020 2020 2222 220a 0a20 2020          """..   
-00021b50: 2020 2020 2023 2072 6762 7320 3d20 5b5b       # rgbs = [[
-00021b60: 696e 7428 2831 202d 206e 756d 2920 2a20  int((1 - num) * 
-00021b70: 3235 3529 2c20 696e 7428 6e75 6d20 2a20  255), int(num * 
-00021b80: 3235 3529 2c20 305d 2066 6f72 206e 756d  255), 0] for num
-00021b90: 2069 6e20 6e75 6d6c 6973 745d 0a20 2020   in numlist].   
-00021ba0: 2020 2020 2023 2072 6762 7320 3d20 5b5b       # rgbs = [[
-00021bb0: 696e 7428 2831 202d 206e 756d 2920 2a20  int((1 - num) * 
-00021bc0: 3235 3529 2a30 2e35 2c20 3132 302c 2069  255)*0.5, 120, i
-00021bd0: 6e74 286e 756d 202a 2032 3535 292a 302e  nt(num * 255)*0.
-00021be0: 355d 2066 6f72 206e 756d 2069 6e20 6e75  5] for num in nu
-00021bf0: 6d6c 6973 745d 0a20 2020 2020 2020 206e  mlist].        n
-00021c00: 756d 6c69 7374 203d 205b 2d31 2069 6620  umlist = [-1 if 
-00021c10: 6920 3c20 3020 656c 7365 2069 2066 6f72  i < 0 else i for
-00021c20: 2069 2069 6e20 6e75 6d6c 6973 745d 0a20   i in numlist]. 
-00021c30: 2020 2020 2020 2072 6762 7320 3d20 5b5b         rgbs = [[
-00021c40: 3132 322c 2069 6e74 286e 756d 202a 2032  122, int(num * 2
-00021c50: 3535 292c 2069 6e74 286e 756d 202a 2032  55), int(num * 2
-00021c60: 3535 295d 2069 6620 6e75 6d20 3e3d 2030  55)] if num >= 0
-00021c70: 2065 6c73 6520 5b32 3535 2c20 302c 2032   else [255, 0, 2
-00021c80: 3535 5d20 666f 7220 6e75 6d20 696e 206e  55] for num in n
-00021c90: 756d 6c69 7374 5d0a 2020 2020 2020 2020  umlist].        
-00021ca0: 7265 7375 6c74 6c69 7374 203d 205b 2723  resultlist = ['#
-00021cb0: 2530 3258 2530 3258 2530 3258 2720 2520  %02X%02X%02X' % 
-00021cc0: 2872 6762 5b30 5d2c 2072 6762 5b31 5d2c  (rgb[0], rgb[1],
-00021cd0: 2072 6762 5b32 5d29 2066 6f72 2072 6762   rgb[2]) for rgb
-00021ce0: 2069 6e20 7267 6273 5d0a 0a20 2020 2020   in rgbs]..     
-00021cf0: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
-00021d00: 6c69 7374 0a0a 2020 2020 2320 4174 6f6d  list..    # Atom
-00021d10: 2061 6e64 2072 6573 6964 7565 2069 6e63   and residue inc
-00021d20: 6c75 6473 696f 6e0a 2020 2020 4073 7461  ludsion.    @sta
-00021d30: 7469 636d 6574 686f 640a 2020 2020 6465  ticmethod.    de
-00021d40: 6620 5f5f 666c 6f61 746f 6865 785f 6162  f __floatohex_ab
-00021d50: 6f76 656f 6e65 286e 756d 6c69 7374 293a  oveone(numlist):
-00021d60: 0a20 2020 2020 2020 2022 2222 0a0a 2020  .        """..  
-00021d70: 2020 2020 2020 2020 2020 5072 6f64 7563            Produc
-00021d80: 6520 6865 7820 636f 6c6f 7220 6265 7477  e hex color betw
-00021d90: 6565 6e20 7265 6420 616e 6420 6772 6565  een red and gree
-00021da0: 6e0a 0a20 2020 2020 2020 203a 7061 7261  n..        :para
-00021db0: 6d20 6e75 6d6c 6973 743a 2041 206c 6973  m numlist: A lis
-00021dc0: 7420 6f66 2052 4742 2076 616c 7565 730a  t of RGB values.
-00021dd0: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
-00021de0: 2041 206c 6973 7420 6f66 2068 6578 2076   A list of hex v
-00021df0: 616c 7565 2062 6574 7765 656e 2052 2061  alue between R a
-00021e00: 6e64 2047 2077 6974 6820 4220 3d20 300a  nd G with B = 0.
-00021e10: 0a20 2020 2020 2020 2022 2222 0a0a 2020  .        """..  
-00021e20: 2020 2020 2020 2320 7267 6273 203d 205b        # rgbs = [
-00021e30: 5b69 6e74 2828 3120 2d20 6e75 6d29 202a  [int((1 - num) *
-00021e40: 2032 3535 292c 2069 6e74 286e 756d 202a   255), int(num *
-00021e50: 2032 3535 292c 2030 5d20 666f 7220 6e75   255), 0] for nu
-00021e60: 6d20 696e 206e 756d 6c69 7374 5d0a 2020  m in numlist].  
-00021e70: 2020 2020 2020 2320 7267 6273 203d 205b        # rgbs = [
-00021e80: 5b69 6e74 2828 3120 2d20 6e75 6d29 202a  [int((1 - num) *
-00021e90: 2032 3535 292a 302e 352c 2031 3230 2c20   255)*0.5, 120, 
-00021ea0: 696e 7428 6e75 6d20 2a20 3235 3529 2a30  int(num * 255)*0
-00021eb0: 2e35 5d20 666f 7220 6e75 6d20 696e 206e  .5] for num in n
-00021ec0: 756d 6c69 7374 5d0a 2020 2020 2020 2020  umlist].        
-00021ed0: 6e75 6d6c 6973 7420 3d20 5b2d 3120 6966  numlist = [-1 if
-00021ee0: 2069 203c 2030 2065 6c73 6520 6920 666f   i < 0 else i fo
-00021ef0: 7220 6920 696e 206e 756d 6c69 7374 5d0a  r i in numlist].
-00021f00: 2020 2020 2020 2020 7267 6273 203d 205b          rgbs = [
-00021f10: 5b69 6e74 286e 756d 202a 2031 3329 2c20  [int(num * 13), 
-00021f20: 302c 2069 6e74 286e 756d 202a 2032 3535  0, int(num * 255
-00021f30: 295d 2069 6620 6e75 6d20 3e3d 2030 2065  )] if num >= 0 e
-00021f40: 6c73 6520 5b32 3535 2c20 302c 2032 3535  lse [255, 0, 255
-00021f50: 5d20 666f 7220 6e75 6d20 696e 206e 756d  ] for num in num
-00021f60: 6c69 7374 5d0a 2020 2020 2020 2020 7265  list].        re
-00021f70: 7375 6c74 6c69 7374 203d 205b 5d0a 2020  sultlist = [].  
-00021f80: 2020 2020 2020 7265 7375 6c74 6c69 7374        resultlist
-00021f90: 203d 205b 2723 2530 3258 2530 3258 2530   = ['#%02X%02X%0
-00021fa0: 3258 2720 2520 2872 6762 5b30 5d2c 2072  2X' % (rgb[0], r
-00021fb0: 6762 5b31 5d2c 2072 6762 5b32 5d29 2066  gb[1], rgb[2]) f
-00021fc0: 6f72 2072 6762 2069 6e20 7267 6273 5d0a  or rgb in rgbs].
-00021fd0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00021fe0: 7265 7375 6c74 6c69 7374 0a0a 2020 2020  resultlist..    
-00021ff0: 6465 6620 5f5f 696e 7465 7250 6f6c 6174  def __interPolat
-00022000: 696f 6e28 7365 6c66 293a 0a20 2020 2020  ion(self):.     
-00022010: 2020 2022 2222 0a0a 2020 2020 2020 2020     """..        
-00022020: 2020 2020 5573 6320 7363 6970 7920 7265      Usc scipy re
-00022030: 6775 6c61 7267 7269 6420 696e 7465 7270  gulargrid interp
-00022040: 6f6c 6174 696f 6e20 6d65 7468 6f64 2066  olation method f
-00022050: 6565 6420 7769 7468 2061 6c6c 206d 6170  eed with all map
-00022060: 7320 696e 666f 0a0a 2020 2020 2020 2020  s info..        
-00022070: 3a70 6172 616d 206d 6170 3a20 456c 6563  :param map: Elec
-00022080: 7472 6f6e 2064 656e 7369 7479 206d 6170  tron density map
-00022090: 2069 6e20 6d72 632f 6d61 7020 666f 726d   in mrc/map form
-000220a0: 6174 0a20 2020 2020 2020 203a 7061 7261  at.        :para
-000220b0: 6d20 6d6f 6465 6c3a 2050 726f 7465 696e  m model: Protein
-000220c0: 206d 6f64 656c 2069 6e20 6d6d 6369 6620   model in mmcif 
-000220d0: 666f 726d 6174 0a20 2020 2020 2020 203a  format.        :
-000220e0: 7265 7475 726e 3a20 4120 696e 7465 7270  return: A interp
-000220f0: 6f6c 6174 696f 6e20 6675 6e63 7469 6f6e  olation function
-00022100: 0a0a 2020 2020 2020 2020 2222 220a 0a20  ..        """.. 
-00022110: 2020 2020 2020 2023 206d 6170 6461 7461         # mapdata
-00022120: 203d 2073 656c 662e 6d61 702e 6765 744d   = self.map.getM
-00022130: 6170 2829 0a20 2020 2020 2020 206d 6170  ap().        map
-00022140: 6461 7461 203d 2073 656c 662e 6d61 702e  data = self.map.
-00022150: 6461 7461 0a20 2020 2020 2020 2074 6d70  data.        tmp
-00022160: 6d61 7064 6174 6120 3d20 6e70 2e73 7761  mapdata = np.swa
-00022170: 7061 7865 7328 6d61 7064 6174 612c 2030  paxes(mapdata, 0
-00022180: 2c20 3229 0a20 2020 2020 2020 2063 6c69  , 2).        cli
-00022190: 6d2c 2062 6c69 6d2c 2061 6c69 6d20 3d20  m, blim, alim = 
-000221a0: 6d61 7064 6174 612e 7368 6170 650a 2020  mapdata.shape.  
-000221b0: 2020 2020 2020 7820 3d20 7261 6e67 6528        x = range(
-000221c0: 616c 696d 290a 2020 2020 2020 2020 7920  alim).        y 
-000221d0: 3d20 7261 6e67 6528 626c 696d 290a 2020  = range(blim).  
-000221e0: 2020 2020 2020 7a20 3d20 7261 6e67 6528        z = range(
-000221f0: 636c 696d 290a 2020 2020 2020 2020 6d79  clim).        my
-00022200: 696e 7465 7220 3d20 5265 6775 6c61 7247  inter = RegularG
-00022210: 7269 6449 6e74 6572 706f 6c61 746f 7228  ridInterpolator(
-00022220: 2878 2c20 792c 207a 292c 2074 6d70 6d61  (x, y, z), tmpma
-00022230: 7064 6174 6129 0a0a 2020 2020 2020 2020  pdata)..        
-00022240: 7265 7475 726e 206d 7969 6e74 6572 0a0a  return myinter..
-00022250: 2020 2020 2320 7665 7273 696f 6e20 3120      # version 1 
-00022260: 6279 2075 7369 6e67 2054 454d 5079 0a20  by using TEMPy. 
-00022270: 2020 2064 6566 205f 5f69 6e74 6572 7468     def __interth
-00022280: 6972 6428 7365 6c66 293a 0a20 2020 2020  ird(self):.     
-00022290: 2020 2022 2222 0a0a 2020 2020 2020 2020     """..        
-000222a0: 2020 2020 496e 7465 7270 6f6c 6174 6520      Interpolate 
-000222b0: 6465 6e73 6974 7920 7661 6c75 6520 6f66  density value of
-000222c0: 206f 6e65 2061 746f 6d2c 2069 6620 696e   one atom, if in
-000222d0: 6469 6365 7320 6172 6520 6f6e 2074 6865  dices are on the
-000222e0: 2073 616d 6520 706c 616e 6520 7573 6520   same plane use 
-000222f0: 6e65 6172 6573 7420 6d65 7468 6f64 0a20  nearest method. 
-00022300: 2020 2020 2020 2020 2020 206f 7468 6572             other
-00022310: 7769 7365 2075 7365 206c 696e 6561 720a  wise use linear.
-00022320: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-00022330: 6d61 703a 2054 454d 5079 206d 6170 2069  map: TEMPy map i
-00022340: 6e73 7461 6e63 650a 2020 2020 2020 2020  nstance.        
-00022350: 3a70 6172 616d 206d 6f64 656c 3a20 5374  :param model: St
-00022360: 7275 6374 7572 6520 696e 7374 616e 6365  ructure instance
-00022370: 2066 726f 6d20 5445 4d50 7920 7061 636b   from TEMPy pack
-00022380: 6167 6520 6d6d 6369 6620 7061 7273 6572  age mmcif parser
-00022390: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-000223a0: 3a20 4c69 7374 2063 6f6e 7461 696e 7320  : List contains 
-000223b0: 616c 6c20 6465 6e73 6974 7920 696e 7465  all density inte
-000223c0: 7270 6f6c 6174 696f 6e73 206f 6620 6174  rpolations of at
-000223d0: 6f6d 7320 6672 6f6d 206d 6f64 656c 0a0a  oms from model..
-000223e0: 2020 2020 2020 2020 2222 220a 0a20 2020          """..   
-000223f0: 2020 2020 206d 7969 6e74 6572 203d 2073       myinter = s
-00022400: 656c 662e 5f5f 696e 7465 7250 6f6c 6174  elf.__interPolat
-00022410: 696f 6e28 290a 2020 2020 2020 2020 2320  ion().        # 
-00022420: 4d69 6768 7420 6861 7669 6e67 206d 756c  Might having mul
-00022430: 7470 6c65 206d 6f64 656c 730a 2020 2020  tple models.    
-00022440: 2020 2020 6d6f 6465 6c73 203d 205b 5d0a      models = [].
-00022450: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-00022460: 7461 6e63 6528 7365 6c66 2e6d 6f64 656c  tance(self.model
-00022470: 732c 206c 6973 7429 3a0a 2020 2020 2020  s, list):.      
-00022480: 2020 2020 2020 6d6f 6465 6c73 203d 2073        models = s
-00022490: 656c 662e 6d6f 6465 6c73 0a20 2020 2020  elf.models.     
-000224a0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000224b0: 2020 2020 206d 6f64 656c 732e 6170 7065       models.appe
-000224c0: 6e64 2873 656c 662e 6d6f 6465 6c73 290a  nd(self.models).
-000224d0: 2020 2020 2020 2020 6d61 7020 3d20 7365          map = se
-000224e0: 6c66 2e6d 6170 0a20 2020 2020 2020 2063  lf.map.        c
-000224f0: 6f6e 746f 7572 203d 2073 656c 662e 636c  ontour = self.cl
-00022500: 0a20 2020 2020 2020 2023 2052 616e 6765  .        # Range
-00022510: 206f 6620 636f 6e74 6f75 7220 6c65 7665   of contour leve
-00022520: 6c20 7661 6c75 6573 2066 6f72 2073 6361  l values for sca
-00022530: 6c65 7220 6261 720a 2020 2020 2020 2020  ler bar.        
-00022540: 2320 546f 646f 3a20 5269 6768 7420 6e6f  # Todo: Right no
-00022550: 7720 7769 7468 2066 6978 6564 206e 756d  w with fixed num
-00022560: 6265 7220 6f66 2070 6f69 6e74 7320 6f6e  ber of points on
-00022570: 2062 6f74 6820 7369 6465 7320 6f66 2074   both sides of t
-00022580: 6865 2072 6563 6f6d 6d65 6e64 6564 2063  he recommended c
-00022590: 6f6e 746f 7572 206c 6576 656c 2c20 636f  ontour level, co
-000225a0: 756c 6420 696d 7072 6f76 6520 746f 0a20  uld improve to. 
-000225b0: 2020 2020 2020 2023 2054 6f64 6f3a 2067         # Todo: g
-000225c0: 656e 6572 6174 6520 6120 7265 6173 6f6e  enerate a reason
-000225d0: 6162 6c65 2072 616e 6765 2073 7572 726f  able range surro
-000225e0: 756e 6420 7468 6520 7265 636f 6d6d 656e  und the recommen
-000225f0: 6465 6420 636f 6e74 6f75 7220 6c65 7665  ded contour leve
-00022600: 6c0a 2020 2020 2020 2020 2320 5365 7474  l.        # Sett
-00022610: 696e 6720 6120 736d 6172 7465 7220 7261  ing a smarter ra
-00022620: 6e67 6520 6265 7477 6565 6e20 2863 6f6e  nge between (con
-00022630: 746f 7572 2d73 6967 2c63 6f6e 746f 7572  tour-sig,contour
-00022640: 2c20 636f 756e 746f 7572 202b 2073 6967  , countour + sig
-00022650: 290a 2020 2020 2020 2020 6d61 7073 6967  ).        mapsig
-00022660: 203d 206d 6170 2e73 7464 2829 0a20 2020   = map.std().   
-00022670: 2020 2020 2023 2063 6f6e 746f 7572 7261       # contourra
-00022680: 6e67 6520 3d20 6e70 2e63 6f6e 6361 7465  nge = np.concate
-00022690: 6e61 7465 2828 6e70 2e6c 696e 7370 6163  nate((np.linspac
-000226a0: 6528 636f 6e74 6f75 7220 2d20 666c 6f61  e(contour - floa
-000226b0: 7428 312e 3520 2a20 6d61 7073 6967 292c  t(1.5 * mapsig),
-000226c0: 2063 6f6e 746f 7572 2c20 332c 2065 6e64   contour, 3, end
-000226d0: 706f 696e 743d 4661 6c73 6529 2c0a 2020  point=False),.  
-000226e0: 2020 2020 2020 2320 2020 2020 2020 2020        #         
-000226f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022700: 2020 2020 2020 206e 702e 6c69 6e73 7061         np.linspa
-00022710: 6365 2863 6f6e 746f 7572 2c20 636f 6e74  ce(contour, cont
-00022720: 6f75 7220 2b20 666c 6f61 7428 312e 3520  our + float(1.5 
-00022730: 2a20 6d61 7073 6967 292c 2034 2929 2c20  * mapsig), 4)), 
-00022740: 6178 6973 3d4e 6f6e 6529 0a20 2020 2020  axis=None).     
-00022750: 2020 2023 2063 6f6e 746f 7572 7261 6e67     # contourrang
-00022760: 6520 3d20 6e70 2e63 6f6e 6361 7465 6e61  e = np.concatena
-00022770: 7465 2828 6e70 2e6c 696e 7370 6163 6528  te((np.linspace(
-00022780: 6d61 702e 6d69 6e28 292c 2063 6f6e 746f  map.min(), conto
-00022790: 7572 2c20 332c 2065 6e64 706f 696e 743d  ur, 3, endpoint=
-000227a0: 4661 6c73 6529 2c20 6e70 2e6c 696e 7370  False), np.linsp
-000227b0: 6163 6528 636f 6e74 6f75 722c 206d 6170  ace(contour, map
-000227c0: 2e6d 6178 2829 2c20 3329 292c 2061 7869  .max(), 3)), axi
-000227d0: 733d 4e6f 6e65 290a 2020 2020 2020 2020  s=None).        
-000227e0: 2320 5768 656e 2072 756e 6e69 6e67 2066  # When running f
-000227f0: 6f72 2045 4d44 4220 6b65 6570 2069 7420  or EMDB keep it 
-00022800: 6173 2061 2066 6c65 7869 626c 6520 7261  as a flexible ra
-00022810: 6e67 6520 666f 7220 6f6e 6564 6570 206f  nge for onedep o
-00022820: 7220 6f74 6865 7220 7573 6572 7320 6f6e  r other users on
-00022830: 6c79 2072 756e 2069 7420 6f6e 6365 2066  ly run it once f
-00022840: 6f72 2072 6563 6f6d 6d65 6e64 6564 0a20  or recommended. 
-00022850: 2020 2020 2020 2023 2063 6f6e 746f 7572         # contour
-00022860: 206c 6576 656c 3a0a 0a20 2020 2020 2020   level:..       
-00022870: 2023 2069 6620 7365 6c66 2e65 6d64 6964   # if self.emdid
-00022880: 3a0a 2020 2020 2020 2020 2320 2020 2020  :.        #     
-00022890: 636f 6e74 6f75 7272 616e 6765 203d 206e  contourrange = n
-000228a0: 702e 636f 6e63 6174 656e 6174 6528 286e  p.concatenate((n
-000228b0: 702e 6c69 6e73 7061 6365 2863 6f6e 746f  p.linspace(conto
-000228c0: 7572 202d 2066 6c6f 6174 2831 2e35 202a  ur - float(1.5 *
-000228d0: 206d 6170 7369 6729 2c20 636f 6e74 6f75   mapsig), contou
-000228e0: 722c 2033 2c20 656e 6470 6f69 6e74 3d46  r, 3, endpoint=F
-000228f0: 616c 7365 292c 0a20 2020 2020 2020 2023  alse),.        #
-00022900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022920: 2020 2020 6e70 2e6c 696e 7370 6163 6528      np.linspace(
-00022930: 636f 6e74 6f75 722c 2063 6f6e 746f 7572  contour, contour
-00022940: 202b 2066 6c6f 6174 2831 2e35 202a 206d   + float(1.5 * m
-00022950: 6170 7369 6729 2c20 3429 292c 2061 7869  apsig), 4)), axi
-00022960: 733d 4e6f 6e65 290a 2020 2020 2020 2020  s=None).        
-00022970: 2320 656c 7365 3a0a 2020 2020 2020 2020  # else:.        
-00022980: 2320 2020 2020 636f 6e74 6f75 7272 616e  #     contourran
-00022990: 6765 203d 206e 702e 6173 6172 7261 7928  ge = np.asarray(
-000229a0: 5b63 6f6e 746f 7572 5d29 0a0a 2020 2020  [contour])..    
-000229b0: 2020 2020 636f 6e74 6f75 7272 616e 6765      contourrange
-000229c0: 203d 206e 702e 6173 6172 7261 7928 5b63   = np.asarray([c
-000229d0: 6f6e 746f 7572 5d29 0a20 2020 2020 2020  ontour]).       
-000229e0: 2072 6573 756c 7420 3d20 7b7d 0a20 2020   result = {}.   
-000229f0: 2020 2020 2066 6f72 206d 6f64 656c 2069       for model i
-00022a00: 6e20 6d6f 6465 6c73 3a0a 2020 2020 2020  n models:.      
-00022a10: 2020 2020 2020 616c 6c63 6f6e 746f 7572        allcontour
-00022a20: 7364 6963 7420 3d20 4f72 6465 7265 6444  sdict = OrderedD
-00022a30: 6963 7428 290a 2020 2020 2020 2020 2020  ict().          
-00022a40: 2020 6174 6f6d 6f75 7473 6964 656e 756d    atomoutsidenum
-00022a50: 203d 2030 0a20 2020 2020 2020 2020 2020   = 0.           
-00022a60: 206d 6f64 656c 6e61 6d65 203d 206d 6f64   modelname = mod
-00022a70: 656c 2e66 696c 656e 616d 652e 7370 6c69  el.filename.spli
-00022a80: 7428 272f 2729 5b2d 315d 0a0a 2020 2020  t('/')[-1]..    
-00022a90: 2020 2020 2020 2020 6174 6f6d 636f 756e          atomcoun
-00022aa0: 7420 3d20 300a 2020 2020 2020 2020 2020  t = 0.          
-00022ab0: 2020 6368 6169 6e63 6f75 6e74 203d 2031    chaincount = 1
-00022ac0: 0a20 2020 2020 2020 2020 2020 2063 6861  .            cha
-00022ad0: 696e 6174 6f6d 7320 3d20 300a 2020 2020  inatoms = 0.    
-00022ae0: 2020 2020 2020 2020 6368 6169 6e61 6973          chainais
-00022af0: 636f 7265 203d 207b 7d0a 2020 2020 2020  core = {}.      
-00022b00: 2020 2020 2020 6368 6169 6e61 6920 3d20        chainai = 
-00022b10: 302e 0a0a 2020 2020 2020 2020 2020 2020  0...            
-00022b20: 666f 7220 636f 6e74 6f75 7220 696e 2063  for contour in c
-00022b30: 6f6e 746f 7572 7261 6e67 653a 0a20 2020  ontourrange:.   
-00022b40: 2020 2020 2020 2020 2020 2020 2069 6e74               int
-00022b50: 6572 706f 6c61 7469 6f6e 7320 3d20 5b5d  erpolations = []
-00022b60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022b70: 2061 6c6c 6b65 7973 203d 205b 5d0a 2020   allkeys = [].  
-00022b80: 2020 2020 2020 2020 2020 2020 2020 616c                al
-00022b90: 6c76 616c 7565 7320 3d20 5b5d 0a20 2020  lvalues = [].   
-00022ba0: 2020 2020 2020 2020 2020 2020 2070 7265               pre
-00022bb0: 7265 7369 6420 3d20 300a 2020 2020 2020  resid = 0.      
-00022bc0: 2020 2020 2020 2020 2020 7072 6563 6861            precha
-00022bd0: 696e 203d 2027 270a 2020 2020 2020 2020  in = ''.        
-00022be0: 2020 2020 2020 2020 6169 7072 6563 6861          aiprecha
-00022bf0: 696e 203d 2027 270a 2020 2020 2020 2020  in = ''.        
-00022c00: 2020 2020 2020 2020 7072 6572 6573 203d          preres =
-00022c10: 2027 270a 2020 2020 2020 2020 2020 2020   ''.            
-00022c20: 2020 2020 7265 7363 6f75 6e74 203d 2030      rescount = 0
-00022c30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022c40: 2073 756d 6174 6f6d 696e 7465 7262 696e   sumatominterbin
-00022c50: 203d 2030 0a20 2020 2020 2020 2020 2020   = 0.           
-00022c60: 2020 2020 2066 6f72 2061 746f 6d20 696e       for atom in
-00022c70: 206d 6f64 656c 3a0a 2020 2020 2020 2020   model:.        
-00022c80: 2020 2020 2020 2020 2020 2020 6174 6f6d              atom
-00022c90: 636f 756e 7420 2b3d 2031 0a20 2020 2020  count += 1.     
-00022ca0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00022cb0: 2069 6620 2748 2720 6e6f 7420 696e 2061   if 'H' not in a
-00022cc0: 746f 6d2e 6174 6f6d 5f6e 616d 653a 0a20  tom.atom_name:. 
-00022cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022ce0: 2020 206f 6e65 636f 6f72 203d 205b 6174     onecoor = [at
-00022cf0: 6f6d 2e78 2c20 6174 6f6d 2e79 2c20 6174  om.x, atom.y, at
-00022d00: 6f6d 2e7a 5d0a 2020 2020 2020 2020 2020  om.z].          
-00022d10: 2020 2020 2020 2020 2020 6f6e 6569 6e64            oneind
-00022d20: 6578 203d 2073 656c 662e 5f5f 6765 7469  ex = self.__geti
-00022d30: 6e64 6963 6573 286f 6e65 636f 6f72 295b  ndices(onecoor)[
-00022d40: 315d 0a20 2020 2020 2020 2020 2020 2020  1].             
-00022d50: 2020 2020 2020 2069 6620 6f6e 6569 6e64         if oneind
-00022d60: 6578 5b30 5d20 3e20 6d61 702e 785f 7369  ex[0] > map.x_si
-00022d70: 7a65 2829 202d 2031 206f 7220 6f6e 6569  ze() - 1 or onei
-00022d80: 6e64 6578 5b30 5d20 3c20 3020 6f72 205c  ndex[0] < 0 or \
-00022d90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022da0: 2020 2020 2020 2020 2020 2020 206f 6e65               one
-00022db0: 696e 6465 785b 315d 203e 206d 6170 2e79  index[1] > map.y
-00022dc0: 5f73 697a 6528 2920 2d20 3120 6f72 206f  _size() - 1 or o
-00022dd0: 6e65 696e 6465 785b 315d 203c 2030 206f  neindex[1] < 0 o
-00022de0: 7220 5c0a 2020 2020 2020 2020 2020 2020  r \.            
-00022df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022e00: 6f6e 6569 6e64 6578 5b32 5d20 3e20 6d61  oneindex[2] > ma
-00022e10: 702e 7a5f 7369 7a65 2829 202d 2031 206f  p.z_size() - 1 o
-00022e20: 7220 6f6e 6569 6e64 6578 5b32 5d20 3c20  r oneindex[2] < 
-00022e30: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
-00022e40: 2020 2020 2020 2020 2020 2063 7572 696e             curin
-00022e50: 7465 7270 6f6c 6174 696f 6e20 3d20 6d61  terpolation = ma
-00022e60: 702e 6d69 6e28 290a 2020 2020 2020 2020  p.min().        
-00022e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022e80: 6174 6f6d 6f75 7473 6964 656e 756d 202b  atomoutsidenum +
-00022e90: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
-00022ea0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00022eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022ec0: 2020 2020 2020 6375 7269 6e74 6572 706f        curinterpo
-00022ed0: 6c61 7469 6f6e 203d 206d 7969 6e74 6572  lation = myinter
-00022ee0: 286f 6e65 696e 6465 7829 2e74 6f6c 6973  (oneindex).tolis
-00022ef0: 7428 295b 305d 0a20 2020 2020 2020 2020  t()[0].         
-00022f00: 2020 2020 2020 2020 2020 2069 6e74 6572             inter
-00022f10: 706f 6c61 7469 6f6e 732e 6170 7065 6e64  polations.append
-00022f20: 2863 7572 696e 7465 7270 6f6c 6174 696f  (curinterpolatio
-00022f30: 6e29 0a20 2020 2020 2020 2020 2020 2020  n).             
-00022f40: 2020 2020 2020 2061 746f 6d69 6e74 6572         atominter
-00022f50: 6269 6e20 3d20 3120 6966 2063 7572 696e  bin = 1 if curin
-00022f60: 7465 7270 6f6c 6174 696f 6e20 3e20 636f  terpolation > co
-00022f70: 6e74 6f75 7220 656c 7365 2030 0a20 2020  ntour else 0.   
-00022f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022f90: 2069 6620 2872 6573 636f 756e 7420 3d3d   if (rescount ==
-00022fa0: 2030 2920 6f72 2028 6174 6f6d 2e72 6573   0) or (atom.res
-00022fb0: 5f6e 6f20 3d3d 2070 7265 7265 7369 6420  _no == preresid 
-00022fc0: 616e 6420 6174 6f6d 2e63 6861 696e 203d  and atom.chain =
-00022fd0: 3d20 7072 6563 6861 696e 293a 0a20 2020  = prechain):.   
-00022fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022ff0: 2020 2020 2073 756d 6174 6f6d 696e 7465       sumatominte
-00023000: 7262 696e 202b 3d20 6174 6f6d 696e 7465  rbin += atominte
-00023010: 7262 696e 0a20 2020 2020 2020 2020 2020  rbin.           
-00023020: 2020 2020 2020 2020 2020 2020 2072 6573               res
-00023030: 636f 756e 7420 2b3d 2031 0a20 2020 2020  count += 1.     
-00023040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023050: 2020 2070 7265 7265 7369 6420 3d20 6174     preresid = at
-00023060: 6f6d 2e72 6573 5f6e 6f0a 2020 2020 2020  om.res_no.      
-00023070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023080: 2020 7072 6563 6861 696e 203d 2061 746f    prechain = ato
-00023090: 6d2e 6368 6169 6e0a 2020 2020 2020 2020  m.chain.        
-000230a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000230b0: 7072 6572 6573 203d 2061 746f 6d2e 7265  preres = atom.re
-000230c0: 730a 0a20 2020 2020 2020 2020 2020 2020  s..             
-000230d0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000230e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000230f0: 2020 2020 206b 6579 7374 7220 3d20 7072       keystr = pr
-00023100: 6563 6861 696e 202b 2027 3a27 202b 2073  echain + ':' + s
-00023110: 7472 2870 7265 7265 7369 6429 202b 2070  tr(preresid) + p
-00023120: 7265 7265 730a 2020 2020 2020 2020 2020  reres.          
-00023130: 2020 2020 2020 2020 2020 2020 2020 616c                al
-00023140: 6c6b 6579 732e 6170 7065 6e64 286b 6579  lkeys.append(key
-00023150: 7374 7229 0a20 2020 2020 2020 2020 2020  str).           
-00023160: 2020 2020 2020 2020 2020 2020 2023 2076               # v
-00023170: 616c 7565 203d 2066 6c6f 6174 2873 756d  alue = float(sum
-00023180: 6174 6f6d 696e 7465 7262 696e 292f 7265  atominterbin)/re
-00023190: 7363 6f75 6e74 0a20 2020 2020 2020 2020  scount.         
-000231a0: 2020 2020 2020 2020 2020 2020 2020 2076                 v
-000231b0: 616c 7565 203d 2066 6c6f 6174 2827 252e  alue = float('%.
-000231c0: 3466 2720 2520 726f 756e 6428 2866 6c6f  4f' % round((flo
-000231d0: 6174 2873 756d 6174 6f6d 696e 7465 7262  at(sumatominterb
-000231e0: 696e 2920 2f20 7265 7363 6f75 6e74 292c  in) / rescount),
-000231f0: 2034 2929 0a20 2020 2020 2020 2020 2020   4)).           
-00023200: 2020 2020 2020 2020 2020 2020 2061 6c6c               all
-00023210: 7661 6c75 6573 2e61 7070 656e 6428 7661  values.append(va
-00023220: 6c75 6529 0a20 2020 2020 2020 2020 2020  lue).           
-00023230: 2020 2020 2020 2020 2020 2020 2073 756d               sum
-00023240: 6174 6f6d 696e 7465 7262 696e 203d 2061  atominterbin = a
-00023250: 746f 6d69 6e74 6572 6269 6e0a 2020 2020  tominterbin.    
-00023260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023270: 2020 2020 7072 6572 6573 6964 203d 2061      preresid = a
-00023280: 746f 6d2e 7265 735f 6e6f 0a20 2020 2020  tom.res_no.     
-00023290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000232a0: 2020 2070 7265 6368 6169 6e20 3d20 6174     prechain = at
-000232b0: 6f6d 2e63 6861 696e 0a20 2020 2020 2020  om.chain.       
-000232c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000232d0: 2072 6573 636f 756e 7420 3d20 310a 0a20   rescount = 1.. 
-000232e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000232f0: 2020 2023 2041 6464 2074 6865 2063 6861     # Add the cha
-00023300: 696e 2062 6173 6564 2061 746f 6d20 696e  in based atom in
-00023310: 636c 7573 696f 6e20 7363 6f72 650a 2020  clusion score.  
-00023320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023330: 2020 6966 2028 6174 6f6d 636f 756e 7420    if (atomcount 
-00023340: 3d3d 2031 2920 6f72 2028 6174 6f6d 2e63  == 1) or (atom.c
-00023350: 6861 696e 203d 3d20 6169 7072 6563 6861  hain == aiprecha
-00023360: 696e 293a 0a20 2020 2020 2020 2020 2020  in):.           
-00023370: 2020 2020 2020 2020 2020 2020 2063 6861               cha
-00023380: 696e 6174 6f6d 7320 2b3d 2031 0a20 2020  inatoms += 1.   
-00023390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000233a0: 2020 2020 2061 6970 7265 6368 6169 6e20       aiprechain 
-000233b0: 3d20 6174 6f6d 2e63 6861 696e 0a20 2020  = atom.chain.   
-000233c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000233d0: 2020 2020 2063 6861 696e 6169 202b 3d20       chainai += 
-000233e0: 6174 6f6d 696e 7465 7262 696e 0a20 2020  atominterbin.   
-000233f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023400: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00023410: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00023420: 6976 616c 7565 203d 2072 6f75 6e64 2866  ivalue = round(f
-00023430: 6c6f 6174 2863 6861 696e 6169 2920 2f20  loat(chainai) / 
-00023440: 6368 6169 6e61 746f 6d73 2c20 3329 0a20  chainatoms, 3). 
-00023450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023460: 2020 2020 2020 2061 6963 6f6c 6f72 203d         aicolor =
-00023470: 2073 656c 662e 5f5f 666c 6f61 746f 6865   self.__floatohe
-00023480: 7828 5b61 6976 616c 7565 5d29 5b30 5d0a  x([aivalue])[0].
-00023490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000234a0: 2020 2020 2020 2020 2320 6368 6169 6e61          # chaina
-000234b0: 6973 636f 7265 5b70 7265 6368 6169 6e5d  iscore[prechain]
-000234c0: 203d 207b 2776 616c 7565 273a 2061 6976   = {'value': aiv
-000234d0: 616c 7565 2c20 2763 6f6c 6f72 273a 2061  alue, 'color': a
-000234e0: 6963 6f6c 6f72 7d0a 2020 2020 2020 2020  icolor}.        
-000234f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023500: 2320 2854 6f64 6f29 2046 6f72 2063 6861  # (Todo) For cha
-00023510: 696e 2077 6869 6368 2068 6176 6520 7468  in which have th
-00023520: 6520 7361 6d65 2063 6861 696e 2069 6420  e same chain id 
-00023530: 6e6f 6e2d 7072 6f74 6569 6e20 7061 7274  non-protein part
-00023540: 206e 6f74 2069 6e63 6c75 6465 6420 7965   not included ye
-00023550: 7420 6573 7065 6369 616c 6c79 0a20 2020  t especially.   
-00023560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023570: 2020 2020 2023 206c 6967 616e 6420 6269       # ligand bi
-00023580: 6e64 2074 6f20 7468 6520 7072 6f74 6569  nd to the protei
-00023590: 6e20 6c69 6761 6e64 2068 6173 2074 6865  n ligand has the
-000235a0: 2073 616d 6520 6368 6169 6e20 6964 2061   same chain id a
-000235b0: 7320 7468 6520 7072 6f74 6569 6e2c 2074  s the protein, t
-000235c0: 6865 6e20 686f 7720 746f 2061 7665 7267  hen how to averg
-000235d0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-000235e0: 2020 2020 2020 2020 2020 2320 7468 6520            # the 
-000235f0: 6c69 6761 6e64 2061 6e64 2074 6865 2070  ligand and the p
-00023600: 726f 7465 696e 2074 6f67 6574 6865 7220  rotein together 
-00023610: 6e65 6564 2074 6f20 7461 6b65 2074 6865  need to take the
-00023620: 206e 756d 6265 7273 2069 6e74 6f20 6163   numbers into ac
-00023630: 636f 756e 7420 7768 6963 6820 616c 736f  count which also
-00023640: 206d 6561 6e73 0a20 2020 2020 2020 2020   means.         
-00023650: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00023660: 206e 6565 6420 746f 2061 6464 2061 6e6f   need to add ano
-00023670: 7468 6572 2076 616c 7565 2069 6e20 7468  ther value in th
-00023680: 6520 6469 6374 6f6e 6172 790a 2020 2020  e dictonary.    
-00023690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000236a0: 2020 2020 2320 4e65 6564 2074 6f20 7072      # Need to pr
-000236b0: 6f70 6572 6c79 2063 616e 6375 6c61 7465  operly canculate
-000236c0: 6420 7468 6520 6176 6572 6167 6520 6f66  d the average of
-000236d0: 206f 6e65 2063 6861 696e 0a20 2020 2020   one chain.     
-000236e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000236f0: 2020 2069 6620 6169 7072 6563 6861 696e     if aiprechain
-00023700: 2069 6e20 6368 6169 6e61 6973 636f 7265   in chainaiscore
-00023710: 2e6b 6579 7328 293a 0a20 2020 2020 2020  .keys():.       
-00023720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023730: 2020 2020 2023 2063 6861 696e 6169 7363       # chainaisc
-00023740: 6f72 655b 6169 7072 6563 6861 696e 202b  ore[aiprechain +
-00023750: 2027 5f27 202b 2073 7472 2861 6976 616c   '_' + str(aival
-00023760: 7565 295d 203d 207b 2776 616c 7565 273a  ue)] = {'value':
-00023770: 2061 6976 616c 7565 2c20 2763 6f6c 6f72   aivalue, 'color
-00023780: 273a 2061 6963 6f6c 6f72 7d0a 2020 2020  ': aicolor}.    
-00023790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000237a0: 2020 2020 2020 2020 7061 7373 0a20 2020          pass.   
-000237b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000237c0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-000237d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000237e0: 2020 2020 2020 2063 6861 696e 6169 7363         chainaisc
-000237f0: 6f72 655b 6169 7072 6563 6861 696e 5d20  ore[aiprechain] 
-00023800: 3d20 7b27 7661 6c75 6527 3a20 6169 7661  = {'value': aiva
-00023810: 6c75 652c 2027 636f 6c6f 7227 3a20 6169  lue, 'color': ai
-00023820: 636f 6c6f 722c 2027 6e75 6d62 6572 4f66  color, 'numberOf
-00023830: 4174 6f6d 7327 3a20 6368 6169 6e61 746f  Atoms': chainato
-00023840: 6d73 7d0a 0a20 2020 2020 2020 2020 2020  ms}..           
-00023850: 2020 2020 2020 2020 2020 2020 2063 6861               cha
-00023860: 696e 6174 6f6d 7320 3d20 310a 2020 2020  inatoms = 1.    
-00023870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023880: 2020 2020 6368 6169 6e63 6f75 6e74 202b      chaincount +
-00023890: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
-000238a0: 2020 2020 2020 2020 2020 2020 6368 6169              chai
-000238b0: 6e61 6920 3d20 6174 6f6d 696e 7465 7262  nai = atominterb
-000238c0: 696e 0a20 2020 2020 2020 2020 2020 2020  in.             
-000238d0: 2020 2020 2020 2020 2020 2061 6970 7265             aipre
-000238e0: 6368 6169 6e20 3d20 6174 6f6d 2e63 6861  chain = atom.cha
-000238f0: 696e 0a0a 2020 2020 2020 2020 2020 2020  in..            
-00023900: 2020 2020 6169 7661 6c75 6520 3d20 726f      aivalue = ro
-00023910: 756e 6428 666c 6f61 7428 6368 6169 6e61  und(float(chaina
-00023920: 6929 202f 2063 6861 696e 6174 6f6d 732c  i) / chainatoms,
-00023930: 2033 290a 2020 2020 2020 2020 2020 2020   3).            
-00023940: 2020 2020 6169 636f 6c6f 7220 3d20 7365      aicolor = se
-00023950: 6c66 2e5f 5f66 6c6f 6174 6f68 6578 285b  lf.__floatohex([
-00023960: 6169 7661 6c75 655d 295b 305d 0a20 2020  aivalue])[0].   
-00023970: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00023980: 6169 7072 6563 6861 696e 2069 6e20 6368  aiprechain in ch
-00023990: 6169 6e61 6973 636f 7265 2e6b 6579 7328  ainaiscore.keys(
-000239a0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000239b0: 2020 2020 2020 2023 2063 6861 696e 6169         # chainai
-000239c0: 7363 6f72 655b 6169 7072 6563 6861 696e  score[aiprechain
-000239d0: 202b 2027 5f27 202b 2073 7472 2861 6976   + '_' + str(aiv
-000239e0: 616c 7565 295d 203d 207b 2776 616c 7565  alue)] = {'value
-000239f0: 273a 2061 6976 616c 7565 2c20 2763 6f6c  ': aivalue, 'col
-00023a00: 6f72 273a 2061 6963 6f6c 6f72 7d0a 2020  or': aicolor}.  
-00023a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023a20: 2020 7061 7373 0a20 2020 2020 2020 2020    pass.         
-00023a30: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00023a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023a50: 2063 6861 696e 6169 7363 6f72 655b 6169   chainaiscore[ai
-00023a60: 7072 6563 6861 696e 5d20 3d20 7b27 7661  prechain] = {'va
-00023a70: 6c75 6527 3a20 6169 7661 6c75 652c 2027  lue': aivalue, '
-00023a80: 636f 6c6f 7227 3a20 6169 636f 6c6f 722c  color': aicolor,
-00023a90: 2027 6e75 6d62 6572 4f66 4174 6f6d 7327   'numberOfAtoms'
-00023aa0: 3a20 6368 6169 6e61 746f 6d73 7d0a 2020  : chainatoms}.  
-00023ab0: 2020 2020 2020 2020 2020 2020 2020 6b65                ke
-00023ac0: 7973 7472 203d 2061 6970 7265 6368 6169  ystr = aiprechai
-00023ad0: 6e20 2b20 273a 2720 2b20 7374 7228 7072  n + ':' + str(pr
-00023ae0: 6572 6573 6964 2920 2b20 7072 6572 6573  eresid) + preres
-00023af0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00023b00: 2061 6c6c 6b65 7973 2e61 7070 656e 6428   allkeys.append(
-00023b10: 6b65 7973 7472 290a 2020 2020 2020 2020  keystr).        
-00023b20: 2020 2020 2020 2020 7661 6c75 6520 3d20          value = 
-00023b30: 666c 6f61 7428 2725 2e34 6627 2025 2072  float('%.4f' % r
-00023b40: 6f75 6e64 2828 666c 6f61 7428 7375 6d61  ound((float(suma
-00023b50: 746f 6d69 6e74 6572 6269 6e29 202f 2072  tominterbin) / r
-00023b60: 6573 636f 756e 7429 2c20 3429 290a 2020  escount), 4)).  
-00023b70: 2020 2020 2020 2020 2020 2020 2020 616c                al
-00023b80: 6c76 616c 7565 732e 6170 7065 6e64 2876  lvalues.append(v
-00023b90: 616c 7565 290a 2020 2020 2020 2020 2020  alue).          
-00023ba0: 2020 2020 2020 616c 6c63 6f6e 746f 7572        allcontour
-00023bb0: 7364 6963 745b 7374 7228 636f 6e74 6f75  sdict[str(contou
-00023bc0: 7229 5d20 3d20 2861 6c6c 6b65 7973 2c20  r)] = (allkeys, 
-00023bd0: 616c 6c76 616c 7565 7329 0a20 2020 2020  allvalues).     
-00023be0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00023bf0: 2827 4d6f 6465 6c3a 2025 7320 6174 2063  ('Model: %s at c
-00023c00: 6f6e 746f 7572 206c 6576 656c 2025 7320  ontour level %s 
-00023c10: 6861 7320 2573 2061 746f 6d73 2073 7469  has %s atoms sti
-00023c20: 636b 206f 7574 206f 6620 7468 6520 6465  ck out of the de
-00023c30: 6e73 6974 792e 2720 2520 286d 6f64 656c  nsity.' % (model
-00023c40: 6e61 6d65 2c20 636f 6e74 6f75 722c 0a20  name, contour,. 
-00023c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023cb0: 6174 6f6d 6f75 7473 6964 656e 756d 2929  atomoutsidenum))
-00023cc0: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00023cd0: 7265 7375 6c74 5b6d 6f64 656c 6e61 6d65  result[modelname
-00023ce0: 5d20 3d20 2869 6e74 6572 706f 6c61 7469  ] = (interpolati
-00023cf0: 6f6e 732c 2061 6c6c 6b65 7973 2c20 616c  ons, allkeys, al
-00023d00: 6c76 616c 7565 7329 0a20 2020 2020 2020  lvalues).       
-00023d10: 2020 2020 2023 2072 6573 756c 743a 207b       # result: {
-00023d20: 6d6f 6465 6c6e 616d 6520 2331 3a20 2869  modelname #1: (i
-00023d30: 6e74 6572 706f 6c61 7469 6f6e 7320 2331  nterpolations #1
-00023d40: 2c20 7b63 6f6e 746f 7572 313a 2028 616c  , {contour1: (al
-00023d50: 6c6b 6579 732c 2061 6c6c 7661 6c75 6573  lkeys, allvalues
-00023d60: 292c 2063 6f6e 746f 7572 323a 2028 616c  ), contour2: (al
-00023d70: 6c6b 6579 732c 2061 6c6c 7661 6c75 6573  lkeys, allvalues
-00023d80: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
-00023d90: 2e2e 2e7d 292c 206d 6f64 656c 6e61 6d65  ...}), modelname
-00023da0: 2023 323a 2028 696e 7465 7270 6f6c 6174   #2: (interpolat
-00023db0: 696f 6e73 2023 322c 207b 636f 6e74 6f75  ions #2, {contou
-00023dc0: 7231 3a20 2861 6c6c 6b65 7973 2c20 616c  r1: (allkeys, al
-00023dd0: 6c76 616c 7565 7329 2c2e 2e2e 7d29 2c2e  lvalues),...}),.
-00023de0: 2e2e 7d0a 2020 2020 2020 2020 2020 2020  ..}.            
-00023df0: 7265 7375 6c74 5b6d 6f64 656c 6e61 6d65  result[modelname
-00023e00: 5d20 3d20 2869 6e74 6572 706f 6c61 7469  ] = (interpolati
-00023e10: 6f6e 732c 2061 6c6c 636f 6e74 6f75 7273  ons, allcontours
-00023e20: 6469 6374 2c20 6368 6169 6e61 6973 636f  dict, chainaisco
-00023e30: 7265 2c20 6174 6f6d 6f75 7473 6964 656e  re, atomoutsiden
-00023e40: 756d 290a 0a20 2020 2020 2020 2072 6574  um)..        ret
-00023e50: 7572 6e20 7265 7375 6c74 0a0a 2020 2020  urn result..    
-00023e60: 2320 7665 7273 696f 6e20 3220 7769 7468  # version 2 with
-00023e70: 6f75 7420 7573 696e 6720 5445 4d50 7920  out using TEMPy 
-00023e80: 666f 7220 6d6f 6465 6c20 6c6f 6164 696e  for model loadin
-00023e90: 6720 7768 6963 6820 6973 2077 6f72 6b69  g which is worki
-00023ea0: 6e67 2062 7574 206e 6f74 206f 7074 696d  ng but not optim
-00023eb0: 616c 2066 6f72 2075 7369 6e67 2062 696f  al for using bio
-00023ec0: 7079 7468 6f6e 0a20 2020 2064 6566 205f  python.    def _
-00023ed0: 5f6e 6577 696e 7465 7274 6869 7264 2873  _newinterthird(s
-00023ee0: 656c 6629 3a0a 2020 2020 2020 2020 2222  elf):.        ""
-00023ef0: 220a 0a20 2020 2020 2020 2020 2020 2049  "..            I
-00023f00: 6e74 6572 706f 6c61 7465 2064 656e 7369  nterpolate densi
-00023f10: 7479 2076 616c 7565 206f 6620 6f6e 6520  ty value of one 
-00023f20: 6174 6f6d 2c20 6966 2069 6e64 6963 6573  atom, if indices
-00023f30: 2061 7265 206f 6e20 7468 6520 7361 6d65   are on the same
-00023f40: 2070 6c61 6e65 2075 7365 206e 6561 7265   plane use neare
-00023f50: 7374 206d 6574 686f 640a 2020 2020 2020  st method.      
-00023f60: 2020 2020 2020 6f74 6865 7277 6973 6520        otherwise 
-00023f70: 7573 6520 6c69 6e65 6172 0a0a 2020 2020  use linear..    
-00023f80: 2020 2020 3a70 6172 616d 206d 6170 3a20      :param map: 
-00023f90: 5445 4d50 7920 6d61 7020 696e 7374 616e  TEMPy map instan
-00023fa0: 6365 0a20 2020 2020 2020 203a 7061 7261  ce.        :para
-00023fb0: 6d20 6d6f 6465 6c3a 2053 7472 7563 7475  m model: Structu
-00023fc0: 7265 2069 6e73 7461 6e63 6520 6672 6f6d  re instance from
-00023fd0: 2054 454d 5079 2070 6163 6b61 6765 206d   TEMPy package m
-00023fe0: 6d63 6966 2070 6172 7365 720a 2020 2020  mcif parser.    
-00023ff0: 2020 2020 3a72 6574 7572 6e3a 204c 6973      :return: Lis
-00024000: 7420 636f 6e74 6169 6e73 2061 6c6c 2064  t contains all d
-00024010: 656e 7369 7479 2069 6e74 6572 706f 6c61  ensity interpola
-00024020: 7469 6f6e 7320 6f66 2061 746f 6d73 2066  tions of atoms f
-00024030: 726f 6d20 6d6f 6465 6c0a 0a20 2020 2020  rom model..     
-00024040: 2020 2022 2222 0a0a 2020 2020 2020 2020     """..        
-00024050: 6d79 696e 7465 7220 3d20 7365 6c66 2e5f  myinter = self._
-00024060: 5f69 6e74 6572 506f 6c61 7469 6f6e 2829  _interPolation()
-00024070: 0a20 2020 2020 2020 2023 204d 6967 6874  .        # Might
-00024080: 2068 6176 696e 6720 6d75 6c74 706c 6520   having multple 
-00024090: 6d6f 6465 6c73 0a20 2020 2020 2020 206d  models.        m
-000240a0: 6f64 656c 7320 3d20 5b5d 0a20 2020 2020  odels = [].     
-000240b0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
-000240c0: 2873 656c 662e 6d6f 6465 6c73 2c20 6c69  (self.models, li
-000240d0: 7374 293a 0a20 2020 2020 2020 2020 2020  st):.           
-000240e0: 206d 6f64 656c 7320 3d20 7365 6c66 2e6d   models = self.m
-000240f0: 6f64 656c 730a 2020 2020 2020 2020 656c  odels.        el
-00024100: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00024110: 6d6f 6465 6c73 2e61 7070 656e 6428 7365  models.append(se
-00024120: 6c66 2e6d 6f64 656c 7329 0a20 2020 2020  lf.models).     
-00024130: 2020 206d 6170 203d 2073 656c 662e 6d61     map = self.ma
-00024140: 700a 2020 2020 2020 2020 636f 6e74 6f75  p.        contou
-00024150: 7220 3d20 7365 6c66 2e63 6c0a 2020 2020  r = self.cl.    
-00024160: 2020 2020 2320 5261 6e67 6520 6f66 2063      # Range of c
-00024170: 6f6e 746f 7572 206c 6576 656c 2076 616c  ontour level val
-00024180: 7565 7320 666f 7220 7363 616c 6572 2062  ues for scaler b
-00024190: 6172 0a20 2020 2020 2020 2023 2054 6f64  ar.        # Tod
-000241a0: 6f3a 2052 6967 6874 206e 6f77 2077 6974  o: Right now wit
-000241b0: 6820 6669 7865 6420 6e75 6d62 6572 206f  h fixed number o
-000241c0: 6620 706f 696e 7473 206f 6e20 626f 7468  f points on both
-000241d0: 2073 6964 6573 206f 6620 7468 6520 7265   sides of the re
-000241e0: 636f 6d6d 656e 6465 6420 636f 6e74 6f75  commended contou
-000241f0: 7220 6c65 7665 6c2c 2063 6f75 6c64 2069  r level, could i
-00024200: 6d70 726f 7665 2074 6f0a 2020 2020 2020  mprove to.      
-00024210: 2020 2320 546f 646f 3a20 6765 6e65 7261    # Todo: genera
-00024220: 7465 2061 2072 6561 736f 6e61 626c 6520  te a reasonable 
-00024230: 7261 6e67 6520 7375 7272 6f75 6e64 2074  range surround t
-00024240: 6865 2072 6563 6f6d 6d65 6e64 6564 2063  he recommended c
-00024250: 6f6e 746f 7572 206c 6576 656c 0a20 2020  ontour level.   
-00024260: 2020 2020 2023 2053 6574 7469 6e67 2061       # Setting a
-00024270: 2073 6d61 7274 6572 2072 616e 6765 2062   smarter range b
-00024280: 6574 7765 656e 2028 636f 6e74 6f75 722d  etween (contour-
-00024290: 7369 672c 636f 6e74 6f75 722c 2063 6f75  sig,contour, cou
-000242a0: 6e74 6f75 7220 2b20 7369 6729 0a20 2020  ntour + sig).   
-000242b0: 2020 2020 2023 206d 6170 7369 6720 3d20       # mapsig = 
-000242c0: 6d61 702e 7374 6428 290a 2020 2020 2020  map.std().      
-000242d0: 2020 2320 636f 6e74 6f75 7272 616e 6765    # contourrange
-000242e0: 203d 206e 702e 636f 6e63 6174 656e 6174   = np.concatenat
-000242f0: 6528 286e 702e 6c69 6e73 7061 6365 2863  e((np.linspace(c
-00024300: 6f6e 746f 7572 202d 2066 6c6f 6174 2831  ontour - float(1
-00024310: 2e35 202a 206d 6170 7369 6729 2c20 636f  .5 * mapsig), co
-00024320: 6e74 6f75 722c 2033 2c20 656e 6470 6f69  ntour, 3, endpoi
-00024330: 6e74 3d46 616c 7365 292c 0a20 2020 2020  nt=False),.     
-00024340: 2020 2023 2020 2020 2020 2020 2020 2020     #            
-00024350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024360: 2020 2020 6e70 2e6c 696e 7370 6163 6528      np.linspace(
-00024370: 636f 6e74 6f75 722c 2063 6f6e 746f 7572  contour, contour
-00024380: 202b 2066 6c6f 6174 2831 2e35 202a 206d   + float(1.5 * m
-00024390: 6170 7369 6729 2c20 3429 292c 2061 7869  apsig), 4)), axi
-000243a0: 733d 4e6f 6e65 290a 2020 2020 2020 2020  s=None).        
-000243b0: 2320 636f 6e74 6f75 7272 616e 6765 203d  # contourrange =
-000243c0: 206e 702e 636f 6e63 6174 656e 6174 6528   np.concatenate(
-000243d0: 286e 702e 6c69 6e73 7061 6365 286d 6170  (np.linspace(map
-000243e0: 2e6d 696e 2829 2c20 636f 6e74 6f75 722c  .min(), contour,
-000243f0: 2033 2c20 656e 6470 6f69 6e74 3d46 616c   3, endpoint=Fal
-00024400: 7365 292c 206e 702e 6c69 6e73 7061 6365  se), np.linspace
-00024410: 2863 6f6e 746f 7572 2c20 6d61 702e 6d61  (contour, map.ma
-00024420: 7828 292c 2033 2929 2c20 6178 6973 3d4e  x(), 3)), axis=N
-00024430: 6f6e 6529 0a20 2020 2020 2020 2023 2057  one).        # W
-00024440: 6865 6e20 7275 6e6e 696e 6720 666f 7220  hen running for 
-00024450: 454d 4442 206b 6565 7020 6974 2061 7320  EMDB keep it as 
-00024460: 6120 666c 6578 6962 6c65 2072 616e 6765  a flexible range
-00024470: 2066 6f72 206f 6e65 6465 7020 6f72 206f   for onedep or o
-00024480: 7468 6572 2075 7365 7273 206f 6e6c 7920  ther users only 
-00024490: 7275 6e20 6974 206f 6e63 6520 666f 7220  run it once for 
-000244a0: 7265 636f 6d6d 656e 6465 640a 2020 2020  recommended.    
-000244b0: 2020 2020 2320 636f 6e74 6f75 7220 6c65      # contour le
-000244c0: 7665 6c3a 0a0a 2020 2020 2020 2020 2320  vel:..        # 
-000244d0: 6966 2073 656c 662e 656d 6469 643a 0a20  if self.emdid:. 
-000244e0: 2020 2020 2020 2023 2020 2020 2063 6f6e         #     con
-000244f0: 746f 7572 7261 6e67 6520 3d20 6e70 2e63  tourrange = np.c
-00024500: 6f6e 6361 7465 6e61 7465 2828 6e70 2e6c  oncatenate((np.l
-00024510: 696e 7370 6163 6528 636f 6e74 6f75 7220  inspace(contour 
-00024520: 2d20 666c 6f61 7428 312e 3520 2a20 6d61  - float(1.5 * ma
-00024530: 7073 6967 292c 2063 6f6e 746f 7572 2c20  psig), contour, 
-00024540: 332c 2065 6e64 706f 696e 743d 4661 6c73  3, endpoint=Fals
-00024550: 6529 2c0a 2020 2020 2020 2020 2320 2020  e),.        #   
-00024560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024580: 206e 702e 6c69 6e73 7061 6365 2863 6f6e   np.linspace(con
-00024590: 746f 7572 2c20 636f 6e74 6f75 7220 2b20  tour, contour + 
-000245a0: 666c 6f61 7428 312e 3520 2a20 6d61 7073  float(1.5 * maps
-000245b0: 6967 292c 2034 2929 2c20 6178 6973 3d4e  ig), 4)), axis=N
-000245c0: 6f6e 6529 0a20 2020 2020 2020 2023 2065  one).        # e
-000245d0: 6c73 653a 0a20 2020 2020 2020 2023 2020  lse:.        #  
-000245e0: 2020 2063 6f6e 746f 7572 7261 6e67 6520     contourrange 
-000245f0: 3d20 6e70 2e61 7361 7272 6179 285b 636f  = np.asarray([co
-00024600: 6e74 6f75 725d 290a 0a20 2020 2020 2020  ntour])..       
-00024610: 2063 6f6e 746f 7572 7261 6e67 6520 3d20   contourrange = 
-00024620: 6e70 2e61 7361 7272 6179 285b 636f 6e74  np.asarray([cont
-00024630: 6f75 725d 290a 2020 2020 2020 2020 7265  our]).        re
-00024640: 7375 6c74 203d 207b 7d0a 2020 2020 2020  sult = {}.      
-00024650: 2020 666f 7220 6d6f 6465 6c20 696e 206d    for model in m
-00024660: 6f64 656c 733a 0a20 2020 2020 2020 2020  odels:.         
-00024670: 2020 2061 6c6c 636f 6e74 6f75 7273 6469     allcontoursdi
-00024680: 6374 203d 204f 7264 6572 6564 4469 6374  ct = OrderedDict
-00024690: 2829 0a20 2020 2020 2020 2020 2020 2061  ().            a
-000246a0: 746f 6d6f 7574 7369 6465 6e75 6d20 3d20  tomoutsidenum = 
-000246b0: 300a 2020 2020 2020 2020 2020 2020 6d6f  0.            mo
-000246c0: 6465 6c6e 616d 6520 3d20 6d6f 6465 6c2e  delname = model.
-000246d0: 6669 6c65 6e61 6d65 2e73 706c 6974 2827  filename.split('
-000246e0: 2f27 295b 2d31 5d0a 0a20 2020 2020 2020  /')[-1]..       
-000246f0: 2020 2020 2061 746f 6d63 6f75 6e74 203d       atomcount =
-00024700: 2030 0a20 2020 2020 2020 2020 2020 2063   0.            c
-00024710: 6861 696e 636f 756e 7420 3d20 310a 2020  haincount = 1.  
-00024720: 2020 2020 2020 2020 2020 6368 6169 6e61            chaina
-00024730: 746f 6d73 203d 2030 0a20 2020 2020 2020  toms = 0.       
-00024740: 2020 2020 2063 6861 696e 6169 7363 6f72       chainaiscor
-00024750: 6520 3d20 7b7d 0a20 2020 2020 2020 2020  e = {}.         
-00024760: 2020 2063 6861 696e 6169 203d 2030 2e0a     chainai = 0..
-00024770: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00024780: 2063 6f6e 746f 7572 2069 6e20 636f 6e74   contour in cont
-00024790: 6f75 7272 616e 6765 3a0a 2020 2020 2020  ourrange:.      
-000247a0: 2020 2020 2020 2020 2020 696e 7465 7270            interp
-000247b0: 6f6c 6174 696f 6e73 203d 205b 5d0a 2020  olations = [].  
-000247c0: 2020 2020 2020 2020 2020 2020 2020 616c                al
-000247d0: 6c6b 6579 7320 3d20 5b5d 0a20 2020 2020  lkeys = [].     
-000247e0: 2020 2020 2020 2020 2020 2061 6c6c 7661             allva
-000247f0: 6c75 6573 203d 205b 5d0a 2020 2020 2020  lues = [].      
-00024800: 2020 2020 2020 2020 2020 7072 6572 6573            preres
-00024810: 6964 203d 2030 0a20 2020 2020 2020 2020  id = 0.         
-00024820: 2020 2020 2020 2070 7265 6368 6169 6e20         prechain 
-00024830: 3d20 2727 0a20 2020 2020 2020 2020 2020  = ''.           
-00024840: 2020 2020 2061 6970 7265 6368 6169 6e20       aiprechain 
-00024850: 3d20 2727 0a20 2020 2020 2020 2020 2020  = ''.           
-00024860: 2020 2020 2070 7265 7265 7320 3d20 2727       preres = ''
-00024870: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00024880: 2072 6573 636f 756e 7420 3d20 300a 2020   rescount = 0.  
-00024890: 2020 2020 2020 2020 2020 2020 2020 7375                su
-000248a0: 6d61 746f 6d69 6e74 6572 6269 6e20 3d20  matominterbin = 
-000248b0: 300a 2020 2020 2020 2020 2020 2020 2020  0.              
-000248c0: 2020 666f 7220 6174 6f6d 2069 6e20 6d6f    for atom in mo
-000248d0: 6465 6c2e 6765 745f 6174 6f6d 7328 293a  del.get_atoms():
-000248e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000248f0: 2020 2020 2061 746f 6d63 6f75 6e74 202b       atomcount +
-00024900: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
-00024910: 2020 2020 2020 2020 2320 6966 2027 4827          # if 'H'
-00024920: 206e 6f74 2069 6e20 6174 6f6d 2e61 746f   not in atom.ato
-00024930: 6d5f 6e61 6d65 3a0a 2020 2020 2020 2020  m_name:.        
-00024940: 2020 2020 2020 2020 2020 2020 2320 6f6e              # on
-00024950: 6563 6f6f 7220 3d20 5b61 746f 6d2e 782c  ecoor = [atom.x,
-00024960: 2061 746f 6d2e 792c 2061 746f 6d2e 7a5d   atom.y, atom.z]
-00024970: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00024980: 2020 2020 206f 6e65 636f 6f72 203d 2061       onecoor = a
-00024990: 746f 6d2e 636f 6f72 640a 2020 2020 2020  tom.coord.      
-000249a0: 2020 2020 2020 2020 2020 2020 2020 6f6e                on
-000249b0: 6569 6e64 6578 203d 2073 656c 662e 5f5f  eindex = self.__
-000249c0: 6765 7469 6e64 6963 6573 286f 6e65 636f  getindices(oneco
-000249d0: 6f72 295b 315d 0a20 2020 2020 2020 2020  or)[1].         
-000249e0: 2020 2020 2020 2020 2020 2069 6620 6f6e             if on
-000249f0: 6569 6e64 6578 5b30 5d20 3e20 6d61 702e  eindex[0] > map.
-00024a00: 6865 6164 6572 2e6e 7820 2d20 3120 6f72  header.nx - 1 or
-00024a10: 206f 6e65 696e 6465 785b 305d 203c 2030   oneindex[0] < 0
-00024a20: 206f 7220 5c0a 2020 2020 2020 2020 2020   or \.          
-00024a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024a40: 2020 6f6e 6569 6e64 6578 5b31 5d20 3e20    oneindex[1] > 
-00024a50: 6d61 702e 6865 6164 6572 2e6e 7920 2d20  map.header.ny - 
-00024a60: 3120 6f72 206f 6e65 696e 6465 785b 315d  1 or oneindex[1]
-00024a70: 203c 2030 206f 7220 5c0a 2020 2020 2020   < 0 or \.      
-00024a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024a90: 2020 2020 2020 6f6e 6569 6e64 6578 5b32        oneindex[2
-00024aa0: 5d20 3e20 6d61 702e 6865 6164 6572 2e6e  ] > map.header.n
-00024ab0: 7a20 2d20 3120 6f72 206f 6e65 696e 6465  z - 1 or oneinde
-00024ac0: 785b 325d 203c 2030 3a0a 2020 2020 2020  x[2] < 0:.      
-00024ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024ae0: 2020 6375 7269 6e74 6572 706f 6c61 7469    curinterpolati
-00024af0: 6f6e 203d 206d 6170 2e6d 696e 2829 0a20  on = map.min(). 
-00024b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024b10: 2020 2020 2020 2061 746f 6d6f 7574 7369         atomoutsi
-00024b20: 6465 6e75 6d20 2b3d 2031 0a20 2020 2020  denum += 1.     
-00024b30: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00024b40: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00024b50: 2020 2020 2020 2020 2020 2020 2063 7572               cur
-00024b60: 696e 7465 7270 6f6c 6174 696f 6e20 3d20  interpolation = 
-00024b70: 6d79 696e 7465 7228 6f6e 6569 6e64 6578  myinter(oneindex
-00024b80: 292e 746f 6c69 7374 2829 5b30 5d0a 2020  ).tolist()[0].  
-00024b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024ba0: 2020 696e 7465 7270 6f6c 6174 696f 6e73    interpolations
-00024bb0: 2e61 7070 656e 6428 6375 7269 6e74 6572  .append(curinter
-00024bc0: 706f 6c61 7469 6f6e 290a 2020 2020 2020  polation).      
-00024bd0: 2020 2020 2020 2020 2020 2020 2020 6174                at
-00024be0: 6f6d 696e 7465 7262 696e 203d 2031 2069  ominterbin = 1 i
-00024bf0: 6620 6375 7269 6e74 6572 706f 6c61 7469  f curinterpolati
-00024c00: 6f6e 203e 2063 6f6e 746f 7572 2065 6c73  on > contour els
-00024c10: 6520 300a 0a20 2020 2020 2020 2020 2020  e 0..           
-00024c20: 2020 2020 2020 2020 2069 6620 2872 6573           if (res
-00024c30: 636f 756e 7420 3d3d 2030 2920 6f72 2028  count == 0) or (
-00024c40: 7265 7369 6475 652e 6964 5b31 5d20 3d3d  residue.id[1] ==
-00024c50: 2070 7265 7265 7369 6420 616e 6420 6174   preresid and at
-00024c60: 6f6d 2e66 756c 6c5f 6964 5b32 5d20 3d3d  om.full_id[2] ==
-00024c70: 2070 7265 6368 6169 6e29 3a0a 2020 2020   prechain):.    
-00024c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024c90: 2020 2020 7375 6d61 746f 6d69 6e74 6572      sumatominter
-00024ca0: 6269 6e20 2b3d 2061 746f 6d69 6e74 6572  bin += atominter
-00024cb0: 6269 6e0a 2020 2020 2020 2020 2020 2020  bin.            
-00024cc0: 2020 2020 2020 2020 2020 2020 7265 7363              resc
-00024cd0: 6f75 6e74 202b 3d20 310a 2020 2020 2020  ount += 1.      
-00024ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024cf0: 2020 7072 6572 6573 6964 203d 2072 6573    preresid = res
-00024d00: 6964 7565 2e69 645b 315d 0a20 2020 2020  idue.id[1].     
-00024d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024d20: 2020 2070 7265 6368 6169 6e20 3d20 6174     prechain = at
-00024d30: 6f6d 2e66 756c 6c5f 6964 5b32 5d0a 2020  om.full_id[2].  
-00024d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024d50: 2020 2020 2020 7072 6572 6573 203d 2072        preres = r
-00024d60: 6573 6964 7565 2e72 6573 6e61 6d65 0a20  esidue.resname. 
-00024d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024d80: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00024d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024da0: 206b 6579 7374 7220 3d20 7072 6563 6861   keystr = precha
-00024db0: 696e 202b 2027 3a27 202b 2073 7472 2870  in + ':' + str(p
-00024dc0: 7265 7265 7369 6429 202b 2070 7265 7265  reresid) + prere
-00024dd0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-00024de0: 2020 2020 2020 2020 2020 616c 6c6b 6579            allkey
-00024df0: 732e 6170 7065 6e64 286b 6579 7374 7229  s.append(keystr)
-00024e00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00024e10: 2020 2020 2020 2020 2076 616c 7565 203d           value =
-00024e20: 2066 6c6f 6174 2827 252e 3466 2720 2520   float('%.4f' % 
-00024e30: 726f 756e 6428 2866 6c6f 6174 2873 756d  round((float(sum
-00024e40: 6174 6f6d 696e 7465 7262 696e 2920 2f20  atominterbin) / 
-00024e50: 7265 7363 6f75 6e74 292c 2034 2929 0a20  rescount), 4)). 
-00024e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024e70: 2020 2020 2020 2061 6c6c 7661 6c75 6573         allvalues
-00024e80: 2e61 7070 656e 6428 7661 6c75 6529 0a20  .append(value). 
-00024e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024ea0: 2020 2020 2020 2073 756d 6174 6f6d 696e         sumatomin
-00024eb0: 7465 7262 696e 203d 2061 746f 6d69 6e74  terbin = atomint
-00024ec0: 6572 6269 6e0a 2020 2020 2020 2020 2020  erbin.          
-00024ed0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-00024ee0: 6572 6573 6964 203d 2072 6573 6964 7565  eresid = residue
-00024ef0: 2e69 645b 315d 0a20 2020 2020 2020 2020  .id[1].         
-00024f00: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00024f10: 7265 6368 6169 6e20 3d20 6174 6f6d 2e66  rechain = atom.f
-00024f20: 756c 6c5f 6964 5b32 5d0a 2020 2020 2020  ull_id[2].      
-00024f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024f40: 2020 7265 7363 6f75 6e74 203d 2031 0a0a    rescount = 1..
-00024f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024f60: 2020 2020 2320 4164 6420 7468 6520 6368      # Add the ch
-00024f70: 6169 6e20 6261 7365 6420 6174 6f6d 2069  ain based atom i
-00024f80: 6e63 6c75 7369 6f6e 2073 636f 7265 0a20  nclusion score. 
-00024f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024fa0: 2020 2069 6620 2861 746f 6d63 6f75 6e74     if (atomcount
-00024fb0: 203d 3d20 3129 206f 7220 2861 746f 6d2e   == 1) or (atom.
-00024fc0: 6675 6c6c 5f69 645b 325d 203d 3d20 6169  full_id[2] == ai
-00024fd0: 7072 6563 6861 696e 293a 0a20 2020 2020  prechain):.     
-00024fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024ff0: 2020 2063 6861 696e 6174 6f6d 7320 2b3d     chainatoms +=
-00025000: 2031 0a20 2020 2020 2020 2020 2020 2020   1.             
-00025010: 2020 2020 2020 2020 2020 2023 2061 6970             # aip
-00025020: 7265 6368 6169 6e20 3d20 6174 6f6d 2e63  rechain = atom.c
-00025030: 6861 696e 0a20 2020 2020 2020 2020 2020  hain.           
-00025040: 2020 2020 2020 2020 2020 2020 2061 6970               aip
-00025050: 7265 6368 6169 6e20 3d20 6174 6f6d 2e66  rechain = atom.f
-00025060: 756c 6c5f 6964 5b32 5d0a 2020 2020 2020  ull_id[2].      
-00025070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025080: 2020 6368 6169 6e61 6920 2b3d 2061 746f    chainai += ato
-00025090: 6d69 6e74 6572 6269 6e0a 2020 2020 2020  minterbin.      
-000250a0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-000250b0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000250c0: 2020 2020 2020 2020 2020 2020 6169 7661              aiva
-000250d0: 6c75 6520 3d20 726f 756e 6428 666c 6f61  lue = round(floa
-000250e0: 7428 6368 6169 6e61 6929 202f 2063 6861  t(chainai) / cha
-000250f0: 696e 6174 6f6d 732c 2033 290a 2020 2020  inatoms, 3).    
-00025100: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025110: 2020 2020 6169 636f 6c6f 7220 3d20 7365      aicolor = se
-00025120: 6c66 2e5f 5f66 6c6f 6174 6f68 6578 285b  lf.__floatohex([
-00025130: 6169 7661 6c75 655d 295b 305d 0a20 2020  aivalue])[0].   
-00025140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025150: 2020 2020 2023 2063 6861 696e 6169 7363       # chainaisc
-00025160: 6f72 655b 7072 6563 6861 696e 5d20 3d20  ore[prechain] = 
-00025170: 7b27 7661 6c75 6527 3a20 6169 7661 6c75  {'value': aivalu
-00025180: 652c 2027 636f 6c6f 7227 3a20 6169 636f  e, 'color': aico
-00025190: 6c6f 727d 0a20 2020 2020 2020 2020 2020  lor}.           
-000251a0: 2020 2020 2020 2020 2020 2020 2023 2028               # (
-000251b0: 546f 646f 2920 466f 7220 6368 6169 6e20  Todo) For chain 
-000251c0: 7768 6963 6820 6861 7665 2074 6865 2073  which have the s
-000251d0: 616d 6520 6368 6169 6e20 6964 206e 6f6e  ame chain id non
-000251e0: 2d70 726f 7465 696e 2070 6172 7420 6e6f  -protein part no
-000251f0: 7420 696e 636c 7564 6564 2079 6574 2065  t included yet e
-00025200: 7370 6563 6961 6c6c 790a 2020 2020 2020  specially.      
-00025210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025220: 2020 2320 6c69 6761 6e64 2062 696e 6420    # ligand bind 
-00025230: 746f 2074 6865 2070 726f 7465 696e 206c  to the protein l
-00025240: 6967 616e 6420 6861 7320 7468 6520 7361  igand has the sa
-00025250: 6d65 2063 6861 696e 2069 6420 6173 2074  me chain id as t
-00025260: 6865 2070 726f 7465 696e 2c20 7468 656e  he protein, then
-00025270: 2068 6f77 2074 6f20 6176 6572 6765 0a20   how to averge. 
-00025280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025290: 2020 2020 2020 2023 2074 6865 206c 6967         # the lig
-000252a0: 616e 6420 616e 6420 7468 6520 7072 6f74  and and the prot
-000252b0: 6569 6e20 746f 6765 7468 6572 206e 6565  ein together nee
-000252c0: 6420 746f 2074 616b 6520 7468 6520 6e75  d to take the nu
-000252d0: 6d62 6572 7320 696e 746f 2061 6363 6f75  mbers into accou
-000252e0: 6e74 2077 6869 6368 2061 6c73 6f20 6d65  nt which also me
-000252f0: 616e 730a 2020 2020 2020 2020 2020 2020  ans.            
-00025300: 2020 2020 2020 2020 2020 2020 2320 6e65              # ne
-00025310: 6564 2074 6f20 6164 6420 616e 6f74 6865  ed to add anothe
-00025320: 7220 7661 6c75 6520 696e 2074 6865 2064  r value in the d
-00025330: 6963 746f 6e61 7279 0a20 2020 2020 2020  ictonary.       
-00025340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025350: 2023 204e 6565 6420 746f 2070 726f 7065   # Need to prope
-00025360: 726c 7920 6361 6e63 756c 6174 6564 2074  rly canculated t
-00025370: 6865 2061 7665 7261 6765 206f 6620 6f6e  he average of on
-00025380: 6520 6368 6169 6e0a 2020 2020 2020 2020  e chain.        
-00025390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000253a0: 6966 2061 6970 7265 6368 6169 6e20 696e  if aiprechain in
-000253b0: 2063 6861 696e 6169 7363 6f72 652e 6b65   chainaiscore.ke
-000253c0: 7973 2829 3a0a 2020 2020 2020 2020 2020  ys():.          
-000253d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000253e0: 2020 2320 6368 6169 6e61 6973 636f 7265    # chainaiscore
-000253f0: 5b61 6970 7265 6368 6169 6e20 2b20 275f  [aiprechain + '_
-00025400: 2720 2b20 7374 7228 6169 7661 6c75 6529  ' + str(aivalue)
-00025410: 5d20 3d20 7b27 7661 6c75 6527 3a20 6169  ] = {'value': ai
-00025420: 7661 6c75 652c 2027 636f 6c6f 7227 3a20  value, 'color': 
-00025430: 6169 636f 6c6f 727d 0a20 2020 2020 2020  aicolor}.       
-00025440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025450: 2020 2020 2070 6173 730a 2020 2020 2020       pass.      
-00025460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025470: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00025480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025490: 2020 2020 6368 6169 6e61 6973 636f 7265      chainaiscore
-000254a0: 5b61 6970 7265 6368 6169 6e5d 203d 207b  [aiprechain] = {
-000254b0: 2776 616c 7565 273a 2061 6976 616c 7565  'value': aivalue
-000254c0: 2c20 2763 6f6c 6f72 273a 2061 6963 6f6c  , 'color': aicol
-000254d0: 6f72 7d0a 0a20 2020 2020 2020 2020 2020  or}..           
-000254e0: 2020 2020 2020 2020 2020 2020 2063 6861               cha
-000254f0: 696e 6174 6f6d 7320 3d20 310a 2020 2020  inatoms = 1.    
-00025500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025510: 2020 2020 6368 6169 6e63 6f75 6e74 202b      chaincount +
-00025520: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
-00025530: 2020 2020 2020 2020 2020 2020 6368 6169              chai
-00025540: 6e61 6920 3d20 6174 6f6d 696e 7465 7262  nai = atominterb
-00025550: 696e 0a20 2020 2020 2020 2020 2020 2020  in.             
-00025560: 2020 2020 2020 2020 2020 2023 2061 6970             # aip
-00025570: 7265 6368 6169 6e20 3d20 6174 6f6d 2e63  rechain = atom.c
-00025580: 6861 696e 0a20 2020 2020 2020 2020 2020  hain.           
-00025590: 2020 2020 2020 2020 2020 2020 2061 6970               aip
-000255a0: 7265 6368 6169 6e20 3d20 6174 6f6d 2e66  rechain = atom.f
-000255b0: 756c 6c5f 6964 5b32 5d0a 0a20 2020 2020  ull_id[2]..     
-000255c0: 2020 2020 2020 2020 2020 2061 6976 616c             aival
-000255d0: 7565 203d 2072 6f75 6e64 2866 6c6f 6174  ue = round(float
-000255e0: 2863 6861 696e 6169 2920 2f20 6368 6169  (chainai) / chai
-000255f0: 6e61 746f 6d73 2c20 3329 0a20 2020 2020  natoms, 3).     
-00025600: 2020 2020 2020 2020 2020 2061 6963 6f6c             aicol
-00025610: 6f72 203d 2073 656c 662e 5f5f 666c 6f61  or = self.__floa
-00025620: 746f 6865 7828 5b61 6976 616c 7565 5d29  tohex([aivalue])
-00025630: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
-00025640: 2020 2020 6966 2061 6970 7265 6368 6169      if aiprechai
-00025650: 6e20 696e 2063 6861 696e 6169 7363 6f72  n in chainaiscor
-00025660: 652e 6b65 7973 2829 3a0a 2020 2020 2020  e.keys():.      
-00025670: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00025680: 6368 6169 6e61 6973 636f 7265 5b61 6970  chainaiscore[aip
-00025690: 7265 6368 6169 6e20 2b20 275f 2720 2b20  rechain + '_' + 
-000256a0: 7374 7228 6169 7661 6c75 6529 5d20 3d20  str(aivalue)] = 
-000256b0: 7b27 7661 6c75 6527 3a20 6169 7661 6c75  {'value': aivalu
-000256c0: 652c 2027 636f 6c6f 7227 3a20 6169 636f  e, 'color': aico
-000256d0: 6c6f 727d 0a20 2020 2020 2020 2020 2020  lor}.           
-000256e0: 2020 2020 2020 2020 2070 6173 730a 2020           pass.  
-000256f0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00025700: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00025710: 2020 2020 2020 2020 6368 6169 6e61 6973          chainais
-00025720: 636f 7265 5b61 6970 7265 6368 6169 6e5d  core[aiprechain]
-00025730: 203d 207b 2776 616c 7565 273a 2061 6976   = {'value': aiv
-00025740: 616c 7565 2c20 2763 6f6c 6f72 273a 2061  alue, 'color': a
-00025750: 6963 6f6c 6f72 7d0a 2020 2020 2020 2020  icolor}.        
-00025760: 2020 2020 2020 2020 6b65 7973 7472 203d          keystr =
-00025770: 2061 6970 7265 6368 6169 6e20 2b20 273a   aiprechain + ':
-00025780: 2720 2b20 7374 7228 7072 6572 6573 6964  ' + str(preresid
-00025790: 2920 2b20 7072 6572 6573 0a20 2020 2020  ) + preres.     
-000257a0: 2020 2020 2020 2020 2020 2061 6c6c 6b65             allke
-000257b0: 7973 2e61 7070 656e 6428 6b65 7973 7472  ys.append(keystr
-000257c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000257d0: 2020 7661 6c75 6520 3d20 666c 6f61 7428    value = float(
-000257e0: 2725 2e34 6627 2025 2072 6f75 6e64 2828  '%.4f' % round((
-000257f0: 666c 6f61 7428 7375 6d61 746f 6d69 6e74  float(sumatomint
-00025800: 6572 6269 6e29 202f 2072 6573 636f 756e  erbin) / rescoun
-00025810: 7429 2c20 3429 290a 2020 2020 2020 2020  t), 4)).        
-00025820: 2020 2020 2020 2020 616c 6c76 616c 7565          allvalue
-00025830: 732e 6170 7065 6e64 2876 616c 7565 290a  s.append(value).
-00025840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025850: 616c 6c63 6f6e 746f 7572 7364 6963 745b  allcontoursdict[
-00025860: 7374 7228 636f 6e74 6f75 7229 5d20 3d20  str(contour)] = 
-00025870: 2861 6c6c 6b65 7973 2c20 616c 6c76 616c  (allkeys, allval
-00025880: 7565 7329 0a20 2020 2020 2020 2020 2020  ues).           
-00025890: 2020 2020 2070 7269 6e74 2827 4d6f 6465       print('Mode
-000258a0: 6c3a 2025 7320 6174 2063 6f6e 746f 7572  l: %s at contour
-000258b0: 206c 6576 656c 2025 7320 6861 7320 2573   level %s has %s
-000258c0: 2061 746f 6d73 2073 7469 636b 206f 7574   atoms stick out
-000258d0: 206f 6620 7468 6520 6465 6e73 6974 792e   of the density.
-000258e0: 2720 2520 286d 6f64 656c 6e61 6d65 2c20  ' % (modelname, 
-000258f0: 636f 6e74 6f75 722c 0a20 2020 2020 2020  contour,.       
-00025900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025950: 2020 2020 2020 2020 2020 6174 6f6d 6f75            atomou
-00025960: 7473 6964 656e 756d 2929 0a0a 2020 2020  tsidenum))..    
-00025970: 2020 2020 2020 2020 2320 7265 7375 6c74          # result
-00025980: 5b6d 6f64 656c 6e61 6d65 5d20 3d20 2869  [modelname] = (i
-00025990: 6e74 6572 706f 6c61 7469 6f6e 732c 2061  nterpolations, a
-000259a0: 6c6c 6b65 7973 2c20 616c 6c76 616c 7565  llkeys, allvalue
-000259b0: 7329 0a20 2020 2020 2020 2020 2020 2023  s).            #
-000259c0: 2072 6573 756c 743a 207b 6d6f 6465 6c6e   result: {modeln
-000259d0: 616d 6520 2331 3a20 2869 6e74 6572 706f  ame #1: (interpo
-000259e0: 6c61 7469 6f6e 7320 2331 2c20 7b63 6f6e  lations #1, {con
-000259f0: 746f 7572 313a 2028 616c 6c6b 6579 732c  tour1: (allkeys,
-00025a00: 2061 6c6c 7661 6c75 6573 292c 2063 6f6e   allvalues), con
-00025a10: 746f 7572 323a 2028 616c 6c6b 6579 732c  tour2: (allkeys,
-00025a20: 2061 6c6c 7661 6c75 6573 290a 2020 2020   allvalues).    
-00025a30: 2020 2020 2020 2020 2320 2e2e 2e7d 292c          # ...}),
-00025a40: 206d 6f64 656c 6e61 6d65 2023 323a 2028   modelname #2: (
-00025a50: 696e 7465 7270 6f6c 6174 696f 6e73 2023  interpolations #
-00025a60: 322c 207b 636f 6e74 6f75 7231 3a20 2861  2, {contour1: (a
-00025a70: 6c6c 6b65 7973 2c20 616c 6c76 616c 7565  llkeys, allvalue
-00025a80: 7329 2c2e 2e2e 7d29 2c2e 2e2e 7d0a 2020  s),...}),...}.  
-00025a90: 2020 2020 2020 2020 2020 7265 7375 6c74            result
-00025aa0: 5b6d 6f64 656c 6e61 6d65 5d20 3d20 2869  [modelname] = (i
-00025ab0: 6e74 6572 706f 6c61 7469 6f6e 732c 2061  nterpolations, a
-00025ac0: 6c6c 636f 6e74 6f75 7273 6469 6374 2c20  llcontoursdict, 
-00025ad0: 6368 6169 6e61 6973 636f 7265 2c20 6174  chainaiscore, at
-00025ae0: 6f6d 6f75 7473 6964 656e 756d 290a 0a20  omoutsidenum).. 
-00025af0: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
-00025b00: 7375 6c74 0a0a 2020 2020 2320 7665 7273  sult..    # vers
-00025b10: 696f 6e20 3320 666f 7220 6f70 7469 6d61  ion 3 for optima
-00025b20: 6c20 7573 6167 6520 6f66 2062 696f 7079  l usage of biopy
-00025b30: 7468 6f6e 0a20 2020 2064 6566 205f 5f6e  thon.    def __n
-00025b40: 6e65 7769 6e74 6572 7468 6972 6428 7365  newinterthird(se
-00025b50: 6c66 293a 0a20 2020 2020 2020 2022 2222  lf):.        """
-00025b60: 0a0a 2020 2020 2020 2020 2020 2020 496e  ..            In
-00025b70: 7465 7270 6f6c 6174 6520 6465 6e73 6974  terpolate densit
-00025b80: 7920 7661 6c75 6520 6f66 206f 6e65 2061  y value of one a
-00025b90: 746f 6d2c 2069 6620 696e 6469 6365 7320  tom, if indices 
-00025ba0: 6172 6520 6f6e 2074 6865 2073 616d 6520  are on the same 
-00025bb0: 706c 616e 6520 7573 6520 6e65 6172 6573  plane use neares
-00025bc0: 7420 6d65 7468 6f64 0a20 2020 2020 2020  t method.       
-00025bd0: 2020 2020 206f 7468 6572 7769 7365 2075       otherwise u
-00025be0: 7365 206c 696e 6561 720a 0a20 2020 2020  se linear..     
-00025bf0: 2020 203a 7061 7261 6d20 6d61 703a 2054     :param map: T
-00025c00: 454d 5079 206d 6170 2069 6e73 7461 6e63  EMPy map instanc
-00025c10: 650a 2020 2020 2020 2020 3a70 6172 616d  e.        :param
-00025c20: 206d 6f64 656c 3a20 5374 7275 6374 7572   model: Structur
-00025c30: 6520 696e 7374 616e 6365 2066 726f 6d20  e instance from 
-00025c40: 5445 4d50 7920 7061 636b 6167 6520 6d6d  TEMPy package mm
-00025c50: 6369 6620 7061 7273 6572 0a20 2020 2020  cif parser.     
-00025c60: 2020 203a 7265 7475 726e 3a20 4c69 7374     :return: List
-00025c70: 2063 6f6e 7461 696e 7320 616c 6c20 6465   contains all de
-00025c80: 6e73 6974 7920 696e 7465 7270 6f6c 6174  nsity interpolat
-00025c90: 696f 6e73 206f 6620 6174 6f6d 7320 6672  ions of atoms fr
-00025ca0: 6f6d 206d 6f64 656c 0a0a 2020 2020 2020  om model..      
-00025cb0: 2020 2222 220a 0a20 2020 2020 2020 206d    """..        m
-00025cc0: 7969 6e74 6572 203d 2073 656c 662e 5f5f  yinter = self.__
-00025cd0: 696e 7465 7250 6f6c 6174 696f 6e28 290a  interPolation().
-00025ce0: 2020 2020 2020 2020 2320 4d69 6768 7420          # Might 
-00025cf0: 6861 7669 6e67 206d 756c 7470 6c65 206d  having multple m
-00025d00: 6f64 656c 730a 2020 2020 2020 2020 6d6f  odels.        mo
-00025d10: 6465 6c73 203d 205b 5d0a 2020 2020 2020  dels = [].      
-00025d20: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-00025d30: 7365 6c66 2e6d 6f64 656c 732c 206c 6973  self.models, lis
-00025d40: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
-00025d50: 6d6f 6465 6c73 203d 2073 656c 662e 6d6f  models = self.mo
-00025d60: 6465 6c73 0a20 2020 2020 2020 2065 6c73  dels.        els
-00025d70: 653a 0a20 2020 2020 2020 2020 2020 206d  e:.            m
-00025d80: 6f64 656c 732e 6170 7065 6e64 2873 656c  odels.append(sel
-00025d90: 662e 6d6f 6465 6c73 290a 2020 2020 2020  f.models).      
-00025da0: 2020 6d61 7020 3d20 7365 6c66 2e6d 6170    map = self.map
-00025db0: 0a20 2020 2020 2020 2063 6f6e 746f 7572  .        contour
-00025dc0: 203d 2073 656c 662e 636c 0a20 2020 2020   = self.cl.     
-00025dd0: 2020 2023 2052 616e 6765 206f 6620 636f     # Range of co
-00025de0: 6e74 6f75 7220 6c65 7665 6c20 7661 6c75  ntour level valu
-00025df0: 6573 2066 6f72 2073 6361 6c65 7220 6261  es for scaler ba
-00025e00: 720a 2020 2020 2020 2020 2320 546f 646f  r.        # Todo
-00025e10: 3a20 5269 6768 7420 6e6f 7720 7769 7468  : Right now with
-00025e20: 2066 6978 6564 206e 756d 6265 7220 6f66   fixed number of
-00025e30: 2070 6f69 6e74 7320 6f6e 2062 6f74 6820   points on both 
-00025e40: 7369 6465 7320 6f66 2074 6865 2072 6563  sides of the rec
-00025e50: 6f6d 6d65 6e64 6564 2063 6f6e 746f 7572  ommended contour
-00025e60: 206c 6576 656c 2c20 636f 756c 6420 696d   level, could im
-00025e70: 7072 6f76 6520 746f 0a20 2020 2020 2020  prove to.       
-00025e80: 2023 2054 6f64 6f3a 2067 656e 6572 6174   # Todo: generat
-00025e90: 6520 6120 7265 6173 6f6e 6162 6c65 2072  e a reasonable r
-00025ea0: 616e 6765 2073 7572 726f 756e 6420 7468  ange surround th
-00025eb0: 6520 7265 636f 6d6d 656e 6465 6420 636f  e recommended co
-00025ec0: 6e74 6f75 7220 6c65 7665 6c0a 2020 2020  ntour level.    
-00025ed0: 2020 2020 2320 5365 7474 696e 6720 6120      # Setting a 
-00025ee0: 736d 6172 7465 7220 7261 6e67 6520 6265  smarter range be
-00025ef0: 7477 6565 6e20 2863 6f6e 746f 7572 2d73  tween (contour-s
-00025f00: 6967 2c63 6f6e 746f 7572 2c20 636f 756e  ig,contour, coun
-00025f10: 746f 7572 202b 2073 6967 290a 2020 2020  tour + sig).    
-00025f20: 2020 2020 2320 6d61 7073 6967 203d 206d      # mapsig = m
-00025f30: 6170 2e73 7464 2829 0a20 2020 2020 2020  ap.std().       
-00025f40: 2023 206d 6170 7369 6720 3d20 6d61 702e   # mapsig = map.
-00025f50: 6461 7461 2e73 7464 2829 0a20 2020 2020  data.std().     
-00025f60: 2020 2023 2063 6f6e 746f 7572 7261 6e67     # contourrang
-00025f70: 6520 3d20 6e70 2e63 6f6e 6361 7465 6e61  e = np.concatena
-00025f80: 7465 2828 6e70 2e6c 696e 7370 6163 6528  te((np.linspace(
-00025f90: 636f 6e74 6f75 7220 2d20 666c 6f61 7428  contour - float(
-00025fa0: 312e 3520 2a20 6d61 7073 6967 292c 2063  1.5 * mapsig), c
-00025fb0: 6f6e 746f 7572 2c20 332c 2065 6e64 706f  ontour, 3, endpo
-00025fc0: 696e 743d 4661 6c73 6529 2c0a 2020 2020  int=False),.    
-00025fd0: 2020 2020 2320 2020 2020 2020 2020 2020      #           
-00025fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025ff0: 2020 2020 206e 702e 6c69 6e73 7061 6365       np.linspace
-00026000: 2863 6f6e 746f 7572 2c20 636f 6e74 6f75  (contour, contou
-00026010: 7220 2b20 666c 6f61 7428 312e 3520 2a20  r + float(1.5 * 
-00026020: 6d61 7073 6967 292c 2034 2929 2c20 6178  mapsig), 4)), ax
-00026030: 6973 3d4e 6f6e 6529 0a20 2020 2020 2020  is=None).       
-00026040: 2023 2063 6f6e 746f 7572 7261 6e67 6520   # contourrange 
-00026050: 3d20 6e70 2e63 6f6e 6361 7465 6e61 7465  = np.concatenate
-00026060: 2828 6e70 2e6c 696e 7370 6163 6528 6d61  ((np.linspace(ma
-00026070: 702e 6d69 6e28 292c 2063 6f6e 746f 7572  p.min(), contour
-00026080: 2c20 332c 2065 6e64 706f 696e 743d 4661  , 3, endpoint=Fa
-00026090: 6c73 6529 2c20 6e70 2e6c 696e 7370 6163  lse), np.linspac
-000260a0: 6528 636f 6e74 6f75 722c 206d 6170 2e6d  e(contour, map.m
-000260b0: 6178 2829 2c20 3329 292c 2061 7869 733d  ax(), 3)), axis=
-000260c0: 4e6f 6e65 290a 2020 2020 2020 2020 2320  None).        # 
-000260d0: 5768 656e 2072 756e 6e69 6e67 2066 6f72  When running for
-000260e0: 2045 4d44 4220 6b65 6570 2069 7420 6173   EMDB keep it as
-000260f0: 2061 2066 6c65 7869 626c 6520 7261 6e67   a flexible rang
-00026100: 6520 666f 7220 6f6e 6564 6570 206f 7220  e for onedep or 
-00026110: 6f74 6865 7220 7573 6572 7320 6f6e 6c79  other users only
-00026120: 2072 756e 2069 7420 6f6e 6365 2066 6f72   run it once for
-00026130: 2072 6563 6f6d 6d65 6e64 6564 0a20 2020   recommended.   
-00026140: 2020 2020 2023 2063 6f6e 746f 7572 206c       # contour l
-00026150: 6576 656c 3a0a 0a20 2020 2020 2020 2023  evel:..        #
-00026160: 2069 6620 7365 6c66 2e65 6d64 6964 3a0a   if self.emdid:.
-00026170: 2020 2020 2020 2020 2320 2020 2020 636f          #     co
-00026180: 6e74 6f75 7272 616e 6765 203d 206e 702e  ntourrange = np.
-00026190: 636f 6e63 6174 656e 6174 6528 286e 702e  concatenate((np.
-000261a0: 6c69 6e73 7061 6365 2863 6f6e 746f 7572  linspace(contour
-000261b0: 202d 2066 6c6f 6174 2831 2e35 202a 206d   - float(1.5 * m
-000261c0: 6170 7369 6729 2c20 636f 6e74 6f75 722c  apsig), contour,
-000261d0: 2033 2c20 656e 6470 6f69 6e74 3d46 616c   3, endpoint=Fal
-000261e0: 7365 292c 0a20 2020 2020 2020 2023 2020  se),.        #  
-000261f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fc30: 2020 2020 2063 6869 6d65 7261 636d 6420       chimeracmd 
+0001fc40: 3d20 6368 696d 6572 6166 6e61 6d65 0a20  = chimerafname. 
+0001fc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fc60: 2020 2077 6974 6820 6f70 656e 2873 656c     with open(sel
+0001fc70: 662e 776f 726b 6469 7220 2b20 6368 696d  f.workdir + chim
+0001fc80: 6572 6163 6d64 2c20 2777 2729 2061 7320  eracmd, 'w') as 
+0001fc90: 6670 3a0a 2020 2020 2020 2020 2020 2020  fp:.            
+0001fca0: 2020 2020 2020 2020 2020 2020 6670 2e77              fp.w
+0001fcb0: 7269 7465 2822 6f70 656e 2022 202b 2073  rite("open " + s
+0001fcc0: 7472 286d 6f64 656c 2920 2b20 2220 666f  tr(model) + " fo
+0001fcd0: 726d 6174 206d 6d63 6966 2220 2b20 275c  rmat mmcif" + '\
+0001fce0: 6e27 290a 2020 2020 2020 2020 2020 2020  n').            
+0001fcf0: 2020 2020 2020 2020 2020 2020 6670 2e77              fp.w
+0001fd00: 7269 7465 2827 7368 6f77 2073 656c 4174  rite('show selAt
+0001fd10: 6f6d 7320 7269 6262 6f6e 7327 202b 2027  oms ribbons' + '
+0001fd20: 5c6e 2729 0a20 2020 2020 2020 2020 2020  \n').           
+0001fd30: 2020 2020 2020 2020 2020 2020 2066 702e               fp.
+0001fd40: 7772 6974 6528 2768 6964 6520 7365 6c41  write('hide selA
+0001fd50: 746f 6d73 2720 2b20 275c 6e27 290a 0a20  toms' + '\n').. 
+0001fd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fd70: 2020 2020 2020 2066 6f72 2028 636f 6c6f         for (colo
+0001fd80: 722c 2072 6573 6964 7565 2920 696e 207a  r, residue) in z
+0001fd90: 6970 2863 6f6c 6f72 732c 2072 6573 6964  ip(colors, resid
+0001fda0: 7565 7329 3a0a 2020 2020 2020 2020 2020  ues):.          
+0001fdb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fdc0: 2020 6368 6169 6e2c 2072 6573 746d 7020    chain, restmp 
+0001fdd0: 3d20 7265 7369 6475 652e 7370 6c69 7428  = residue.split(
+0001fde0: 273a 2729 0a20 2020 2020 2020 2020 2020  ':').           
+0001fdf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fe00: 2023 204e 6f74 2073 7572 6520 6966 2061   # Not sure if a
+0001fe10: 6c6c 2074 6865 206c 6574 7465 7273 2073  ll the letters s
+0001fe20: 686f 756c 6420 6265 2072 6570 6c61 6365  hould be replace
+0001fe30: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+0001fe40: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0001fe50: 7265 7320 3d20 7265 2e73 7562 2822 5c44  res = re.sub("\D
+0001fe60: 222c 2022 222c 2072 6573 746d 7029 0a20  ", "", restmp). 
+0001fe70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fe80: 2020 2020 2020 2020 2020 2072 6573 203d             res =
+0001fe90: 2072 652e 6669 6e64 616c 6c28 7227 2d3f   re.findall(r'-?
+0001fea0: 5c64 2b27 2c20 7265 7374 6d70 295b 305d  \d+', restmp)[0]
+0001feb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001fec0: 2020 2020 2020 2020 2020 2020 2066 702e               fp.
+0001fed0: 7772 6974 6528 0a20 2020 2020 2020 2020  write(.         
+0001fee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fef0: 2020 2020 2020 2027 636f 6c6f 7220 2f27         'color /'
+0001ff00: 202b 2063 6861 696e 202b 2027 3a27 202b   + chain + ':' +
+0001ff10: 2072 6573 202b 2027 2027 202b 2063 6f6c   res + ' ' + col
+0001ff20: 6f72 202b 2027 5c6e 270a 2020 2020 2020  or + '\n'.      
+0001ff30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ff40: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0001ff50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ff60: 6670 2e77 7269 7465 280a 2020 2020 2020  fp.write(.      
+0001ff70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ff80: 2020 2020 2020 2273 6574 2062 6743 6f6c        "set bgCol
+0001ff90: 6f72 2077 6869 7465 2220 2b20 275c 6e27  or white" + '\n'
+0001ffa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ffb0: 2020 2020 2020 2020 2020 2020 2022 6c69               "li
+0001ffc0: 6768 7469 6e67 2073 6f66 7422 202b 2027  ghting soft" + '
+0001ffd0: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
+0001ffe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fff0: 2276 6965 7720 636f 6672 2054 7275 6522  "view cofr True"
+00020000: 202b 2027 5c6e 270a 2020 2020 2020 2020   + '\n'.        
+00020010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020020: 2020 2020 2273 6176 6520 2220 2b20 7374      "save " + st
+00020030: 7228 7375 7266 6163 6566 6e29 202b 2022  r(surfacefn) + "
+00020040: 5f7a 6669 7473 7572 6661 6365 2e6a 7065  _zfitsurface.jpe
+00020050: 6722 202b 2022 2073 7570 6572 7361 6d70  g" + " supersamp
+00020060: 6c65 2033 2077 6964 7468 2031 3230 3020  le 3 width 1200 
+00020070: 6865 6967 6874 2031 3230 3022 202b 2027  height 1200" + '
+00020080: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
+00020090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000200a0: 2274 7572 6e20 7820 2d39 3022 202b 2027  "turn x -90" + '
+000200b0: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
+000200c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000200d0: 2274 7572 6e20 7920 2d39 3022 202b 2027  "turn y -90" + '
+000200e0: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
+000200f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020100: 2276 6965 7720 636f 6672 2054 7275 6522  "view cofr True"
+00020110: 202b 2027 5c6e 270a 2020 2020 2020 2020   + '\n'.        
+00020120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020130: 2020 2020 2273 6176 6520 2220 2b20 7374      "save " + st
+00020140: 7228 7375 7266 6163 6566 6e29 202b 2022  r(surfacefn) + "
+00020150: 5f78 6669 7473 7572 6661 6365 2e6a 7065  _xfitsurface.jpe
+00020160: 6722 202b 2022 2073 7570 6572 7361 6d70  g" + " supersamp
+00020170: 6c65 2033 2077 6964 7468 2031 3230 3020  le 3 width 1200 
+00020180: 6865 6967 6874 2031 3230 3022 202b 2027  height 1200" + '
+00020190: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
+000201a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000201b0: 2276 6965 7720 6f72 6965 6e74 2220 2b20  "view orient" + 
+000201c0: 275c 6e27 0a20 2020 2020 2020 2020 2020  '\n'.           
+000201d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000201e0: 2022 7475 726e 2078 2039 3022 202b 2027   "turn x 90" + '
+000201f0: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
+00020200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020210: 2274 7572 6e20 7a20 3930 2220 2b20 275c  "turn z 90" + '\
+00020220: 6e27 0a20 2020 2020 2020 2020 2020 2020  n'.             
+00020230: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00020240: 7669 6577 2063 6f66 7220 5472 7565 2220  view cofr True" 
+00020250: 2b20 275c 6e27 0a20 2020 2020 2020 2020  + '\n'.         
+00020260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020270: 2020 2022 7361 7665 2022 202b 2073 7472     "save " + str
+00020280: 2873 7572 6661 6365 666e 2920 2b20 225f  (surfacefn) + "_
+00020290: 7966 6974 7375 7266 6163 652e 6a70 6567  yfitsurface.jpeg
+000202a0: 2220 2b20 2220 7375 7065 7273 616d 706c  " + " supersampl
+000202b0: 6520 3320 7769 6474 6820 3132 3030 2068  e 3 width 1200 h
+000202c0: 6569 6768 7420 3132 3030 2220 2b20 275c  eight 1200" + '\
+000202d0: 6e27 0a20 2020 2020 2020 2020 2020 2020  n'.             
+000202e0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+000202f0: 636c 6f73 6520 616c 6c22 202b 2022 5c6e  close all" + "\n
+00020300: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00020310: 2020 2020 2020 2020 2020 2020 2020 2265                "e
+00020320: 7869 7422 0a20 2020 2020 2020 2020 2020  xit".           
+00020330: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00020340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020350: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00020360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020370: 6966 206e 6f74 2062 696e 6469 7370 6c61  if not bindispla
+00020380: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00020390: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000203a0: 7562 7072 6f63 6573 732e 6368 6563 6b5f  ubprocess.check_
+000203b0: 6361 6c6c 286c 6f63 4348 494d 4552 4120  call(locCHIMERA 
+000203c0: 2b20 2220 2d2d 6f66 6673 6372 6565 6e20  + " --offscreen 
+000203d0: 2d2d 6e6f 6775 6920 2220 2b20 7365 6c66  --nogui " + self
+000203e0: 2e77 6f72 6b64 6972 202b 2063 6869 6d65  .workdir + chime
+000203f0: 7261 636d 642c 0a20 2020 2020 2020 2020  racmd,.         
+00020400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020420: 2020 2020 2020 2020 2063 7764 3d73 656c           cwd=sel
+00020430: 662e 776f 726b 6469 722c 2073 6865 6c6c  f.workdir, shell
+00020440: 3d54 7275 6529 0a20 2020 2020 2020 2020  =True).         
+00020450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020460: 2020 2070 7269 6e74 2827 436f 6c6f 7265     print('Colore
+00020470: 6420 6d6f 6465 6c73 2077 6572 6520 7072  d models were pr
+00020480: 6f64 7563 6564 2e27 290a 2020 2020 2020  oduced.').      
+00020490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000204a0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000204b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000204c0: 2020 2020 7375 6270 726f 6365 7373 2e63      subprocess.c
+000204d0: 6865 636b 5f63 616c 6c28 6c6f 6343 4849  heck_call(locCHI
+000204e0: 4d45 5241 202b 2022 2022 202b 2073 656c  MERA + " " + sel
+000204f0: 662e 776f 726b 6469 7220 2b20 6368 696d  f.workdir + chim
+00020500: 6572 6163 6d64 2c20 6377 643d 7365 6c66  eracmd, cwd=self
+00020510: 2e77 6f72 6b64 6972 2c0a 2020 2020 2020  .workdir,.      
+00020520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020540: 2020 2020 2020 2020 2020 2020 7368 656c              shel
+00020550: 6c3d 5472 7565 290a 2020 2020 2020 2020  l=True).        
+00020560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020570: 2020 2020 7072 696e 7428 2743 6f6c 6f72      print('Color
+00020580: 6564 206d 6f64 656c 7320 7765 7265 2070  ed models were p
+00020590: 726f 6475 6365 642e 2729 0a20 2020 2020  roduced.').     
+000205a0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+000205b0: 7863 6570 7420 7375 6270 726f 6365 7373  xcept subprocess
+000205c0: 2e43 616c 6c65 6450 726f 6365 7373 4572  .CalledProcessEr
+000205d0: 726f 7220 6173 2073 7562 6572 723a 0a20  ror as suberr:. 
+000205e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000205f0: 2020 2020 2020 2065 7272 203d 2027 5361         err = 'Sa
+00020600: 7669 6e67 206d 6f64 656c 207b 7d20 6669  ving model {} fi
+00020610: 7420 7375 7266 6163 6520 7669 6577 2065  t surface view e
+00020620: 7272 6f72 3a20 7b7d 2e27 2e66 6f72 6d61  rror: {}.'.forma
+00020630: 7428 6d6f 6465 6c6e 616d 652c 2073 7562  t(modelname, sub
+00020640: 6572 7229 0a20 2020 2020 2020 2020 2020  err).           
+00020650: 2020 2020 2020 2020 2020 2020 2065 7272               err
+00020660: 6c69 7374 2e61 7070 656e 6428 6572 7229  list.append(err)
+00020670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020680: 2020 2020 2020 2020 2073 7973 2e73 7464           sys.std
+00020690: 6572 722e 7772 6974 6528 6572 7220 2b20  err.write(err + 
+000206a0: 275c 6e27 290a 0a20 2020 2020 2020 2020  '\n')..         
+000206b0: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+000206c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000206d0: 2020 2020 2020 2020 7365 6c66 2e73 6361          self.sca
+000206e0: 6c65 5f73 7572 6661 6365 7669 6577 2829  le_surfaceview()
+000206f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020700: 2020 2020 2065 7863 6570 743a 0a20 2020       except:.   
+00020710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020720: 2020 2020 2065 7272 203d 2027 5363 616c       err = 'Scal
+00020730: 696e 6720 6d6f 6465 6c20 6669 7420 7375  ing model fit su
+00020740: 7266 6163 6520 7669 6577 2065 7272 6f72  rface view error
+00020750: 3a20 7b7d 2e27 2e66 6f72 6d61 7428 7379  : {}.'.format(sy
+00020760: 732e 6578 635f 696e 666f 2829 5b31 5d29  s.exc_info()[1])
+00020770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020780: 2020 2020 2020 2020 2065 7272 6c69 7374           errlist
+00020790: 2e61 7070 656e 6428 6572 7229 0a20 2020  .append(err).   
+000207a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000207b0: 2020 2020 2073 7973 2e73 7464 6572 722e       sys.stderr.
+000207c0: 7772 6974 6528 6572 7220 2b20 275c 6e27  write(err + '\n'
+000207d0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+000207e0: 2020 2020 2020 206a 7065 6773 203d 2067         jpegs = g
+000207f0: 6c6f 622e 676c 6f62 2873 656c 662e 776f  lob.glob(self.wo
+00020800: 726b 6469 7220 2b20 272f 2a73 7572 6661  rkdir + '/*surfa
+00020810: 6365 2e6a 7065 6727 290a 2020 2020 2020  ce.jpeg').      
+00020820: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
+00020830: 6465 6c73 7572 6620 3d20 6469 6374 2829  delsurf = dict()
+00020840: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020850: 2020 2020 2066 696e 616c 6d6d 6469 6374       finalmmdict
+00020860: 203d 2064 6963 7428 290a 2020 2020 2020   = dict().      
+00020870: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00020880: 2073 656c 662e 6d6f 6465 6c73 3a0a 2020   self.models:.  
+00020890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000208a0: 2020 2020 2020 666f 7220 6d6f 6465 6c20        for model 
+000208b0: 696e 2073 656c 662e 6d6f 6465 6c73 3a0a  in self.models:.
+000208c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000208d0: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
+000208e0: 6c6e 616d 6520 3d20 6f73 2e70 6174 682e  lname = os.path.
+000208f0: 6261 7365 6e61 6d65 286d 6f64 656c 2e66  basename(model.f
+00020900: 696c 656e 616d 6529 0a20 2020 2020 2020  ilename).       
+00020910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020920: 2020 2020 2073 7572 6661 6365 666e 203d       surfacefn =
+00020930: 2027 7b7d 5f7b 7d27 2e66 6f72 6d61 7428   '{}_{}'.format(
+00020940: 6d6f 6465 6c6e 616d 652c 2073 656c 662e  modelname, self.
+00020950: 6d61 706e 616d 6529 0a20 2020 2020 2020  mapname).       
+00020960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020970: 2020 2020 206d 6f64 656c 6d61 7073 7572       modelmapsur
+00020980: 6661 6365 203d 2064 6963 7428 290a 2020  face = dict().  
+00020990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000209a0: 2020 2020 2020 2020 2020 666f 7220 6a70            for jp
+000209b0: 6567 2069 6e20 6a70 6567 733a 0a20 2020  eg in jpegs:.   
+000209c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000209d0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000209e0: 6d6f 6465 6c6e 616d 6520 696e 206a 7065  modelname in jpe
+000209f0: 6720 616e 6420 2778 6669 7473 7572 6661  g and 'xfitsurfa
+00020a00: 6365 2720 696e 206a 7065 673a 0a20 2020  ce' in jpeg:.   
+00020a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020a30: 206d 6f64 656c 6d61 7073 7572 6661 6365   modelmapsurface
+00020a40: 5b27 7827 5d20 3d20 7374 7228 7375 7266  ['x'] = str(surf
+00020a50: 6163 6566 6e29 202b 2027 5f73 6361 6c65  acefn) + '_scale
+00020a60: 645f 7866 6974 7375 7266 6163 652e 6a70  d_xfitsurface.jp
+00020a70: 6567 270a 2020 2020 2020 2020 2020 2020  eg'.            
+00020a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020a90: 2020 2020 6966 206d 6f64 656c 6e61 6d65      if modelname
+00020aa0: 2069 6e20 6a70 6567 2061 6e64 2027 7966   in jpeg and 'yf
+00020ab0: 6974 7375 7266 6163 6527 2069 6e20 6a70  itsurface' in jp
+00020ac0: 6567 3a0a 2020 2020 2020 2020 2020 2020  eg:.            
+00020ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020ae0: 2020 2020 2020 2020 6d6f 6465 6c6d 6170          modelmap
+00020af0: 7375 7266 6163 655b 2779 275d 203d 2073  surface['y'] = s
+00020b00: 7472 2873 7572 6661 6365 666e 2920 2b20  tr(surfacefn) + 
+00020b10: 275f 7363 616c 6564 5f79 6669 7473 7572  '_scaled_yfitsur
+00020b20: 6661 6365 2e6a 7065 6727 0a20 2020 2020  face.jpeg'.     
+00020b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020b40: 2020 2020 2020 2020 2020 2069 6620 6d6f             if mo
+00020b50: 6465 6c6e 616d 6520 696e 206a 7065 6720  delname in jpeg 
+00020b60: 616e 6420 277a 6669 7473 7572 6661 6365  and 'zfitsurface
+00020b70: 2720 696e 206a 7065 673a 0a20 2020 2020  ' in jpeg:.     
+00020b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020b90: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00020ba0: 6f64 656c 6d61 7073 7572 6661 6365 5b27  odelmapsurface['
+00020bb0: 7a27 5d20 3d20 7374 7228 7375 7266 6163  z'] = str(surfac
+00020bc0: 6566 6e29 202b 2027 5f73 6361 6c65 645f  efn) + '_scaled_
+00020bd0: 7a66 6974 7375 7266 6163 652e 6a70 6567  zfitsurface.jpeg
+00020be0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00020bf0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00020c00: 2065 7272 6c69 7374 3a0a 2020 2020 2020   errlist:.      
+00020c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020c20: 2020 2020 2020 2020 2020 6d6f 6465 6c73            models
+00020c30: 7572 665b 2765 7272 275d 203d 207b 276d  urf['err'] = {'m
+00020c40: 6f64 656c 5f66 6974 5f65 7272 273a 2065  odel_fit_err': e
+00020c50: 7272 6c69 7374 7d0a 2020 2020 2020 2020  rrlist}.        
+00020c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020c70: 2020 2020 6d6f 6465 6c73 7572 665b 6d6f      modelsurf[mo
+00020c80: 6465 6c6e 616d 655d 203d 206d 6f64 656c  delname] = model
+00020c90: 6d61 7073 7572 6661 6365 0a20 2020 2020  mapsurface.     
+00020ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020cb0: 2020 2066 696e 616c 6d6d 6469 6374 5b27     finalmmdict['
+00020cc0: 6d6f 6465 6c66 6974 5f73 7572 6661 6365  modelfit_surface
+00020cd0: 275d 203d 206d 6f64 656c 7375 7266 0a0a  '] = modelsurf..
+00020ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020cf0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00020d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020d10: 2020 2020 2020 2020 2077 6974 6820 636f           with co
+00020d20: 6465 6373 2e6f 7065 6e28 7365 6c66 2e77  decs.open(self.w
+00020d30: 6f72 6b64 6972 202b 2073 656c 662e 6d61  orkdir + self.ma
+00020d40: 706e 616d 6520 2b20 275f 6d6f 6465 6c66  pname + '_modelf
+00020d50: 6974 7375 7266 6163 6576 6965 772e 6a73  itsurfaceview.js
+00020d60: 6f6e 272c 2027 7727 2c0a 2020 2020 2020  on', 'w',.      
+00020d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020d90: 2020 2020 2020 2065 6e63 6f64 696e 673d         encoding=
+00020da0: 2775 7466 2d38 2729 2061 7320 663a 0a20  'utf-8') as f:. 
+00020db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020dc0: 2020 2020 2020 2020 2020 2020 2020 206a                 j
+00020dd0: 736f 6e2e 6475 6d70 2866 696e 616c 6d6d  son.dump(finalmm
+00020de0: 6469 6374 2c20 6629 0a20 2020 2020 2020  dict, f).       
+00020df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020e00: 2065 7863 6570 743a 0a20 2020 2020 2020   except:.       
+00020e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020e20: 2020 2020 2073 7973 2e73 7464 6572 722e       sys.stderr.
+00020e30: 7772 6974 6528 2753 6176 696e 6720 6d6f  write('Saving mo
+00020e40: 6465 6c20 6669 7420 7375 7266 6163 6520  del fit surface 
+00020e50: 7669 6577 2074 6f20 6a73 6f6e 2065 7272  view to json err
+00020e60: 6f72 3a20 7b7d 2e5c 6e27 2e66 6f72 6d61  or: {}.\n'.forma
+00020e70: 7428 7379 732e 6578 635f 696e 666f 2829  t(sys.exc_info()
+00020e80: 5b31 5d29 290a 0a20 2020 2020 2020 2020  [1]))..         
+00020e90: 2020 2020 2020 2065 6e64 203d 2074 696d         end = tim
+00020ea0: 6569 742e 6465 6661 756c 745f 7469 6d65  eit.default_time
+00020eb0: 7228 290a 2020 2020 2020 2020 2020 2020  r().            
+00020ec0: 2020 2020 7072 696e 7428 274d 6f64 656c      print('Model
+00020ed0: 6669 7473 7572 6661 6365 2074 696d 653a  fitsurface time:
+00020ee0: 2025 7327 2025 2028 656e 6420 2d20 7374   %s' % (end - st
+00020ef0: 6172 7429 290a 2020 2020 2020 2020 2020  art)).          
+00020f00: 2020 2020 2020 7072 696e 7428 272d 2d2d        print('---
+00020f10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00020f20: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00020f30: 2d27 290a 0a0a 2020 2020 6465 6620 7363  -')...    def sc
+00020f40: 616c 655f 7375 7266 6163 6576 6965 7728  ale_surfaceview(
+00020f50: 7365 6c66 293a 0a20 2020 2020 2020 2022  self):.        "
+00020f60: 2222 0a20 2020 2020 2020 2020 2020 2053  "".            S
+00020f70: 6361 6c65 2074 6865 2073 7572 6661 6365  cale the surface
+00020f80: 2076 6965 7720 696d 6167 6573 2073 697a   view images siz
+00020f90: 6520 746f 2033 3030 5833 3030 0a0a 2020  e to 300X300..  
+00020fa0: 2020 2020 2020 3a72 6574 7572 6e3a 204e        :return: N
+00020fb0: 6f6e 650a 2020 2020 2020 2020 2222 220a  one.        """.
+00020fc0: 0a20 2020 2020 2020 2023 2069 6d70 6f72  .        # impor
+00020fd0: 7420 696d 6167 6569 6f0a 2020 2020 2020  t imageio.      
+00020fe0: 2020 696d 706f 7274 2067 6c6f 620a 0a20    import glob.. 
+00020ff0: 2020 2020 2020 2066 6f72 2069 6d67 6669         for imgfi
+00021000: 6c65 2069 6e20 676c 6f62 2e67 6c6f 6228  le in glob.glob(
+00021010: 7365 6c66 2e77 6f72 6b64 6972 202b 2027  self.workdir + '
+00021020: 2a73 7572 6661 6365 2e6a 7065 6727 293a  *surface.jpeg'):
+00021030: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00021040: 2773 6361 6c65 6427 206e 6f74 2069 6e20  'scaled' not in 
+00021050: 696d 6766 696c 653a 0a20 2020 2020 2020  imgfile:.       
+00021060: 2020 2020 2020 2020 206e 616d 656c 6973           namelis
+00021070: 7420 3d20 696d 6766 696c 652e 7370 6c69  t = imgfile.spli
+00021080: 7428 272f 2729 5b2d 315d 2e73 706c 6974  t('/')[-1].split
+00021090: 2827 5f27 290a 2020 2020 2020 2020 2020  ('_').          
+000210a0: 2020 2020 2020 6e61 6d65 6f6e 6520 3d20        nameone = 
+000210b0: 275f 272e 6a6f 696e 286e 616d 656c 6973  '_'.join(namelis
+000210c0: 745b 3a2d 315d 290a 2020 2020 2020 2020  t[:-1]).        
+000210d0: 2020 2020 2020 2020 6e61 6d65 7477 6f20          nametwo 
+000210e0: 3d20 6e61 6d65 6c69 7374 5b2d 315d 0a20  = namelist[-1]. 
+000210f0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00021100: 7069 6d67 203d 2049 6d61 6765 2e6f 7065  pimg = Image.ope
+00021110: 6e28 696d 6766 696c 6529 0a20 2020 2020  n(imgfile).     
+00021120: 2020 2020 2020 2020 2020 2069 6d20 3d20             im = 
+00021130: 6e70 696d 672e 7265 7369 7a65 2828 3330  npimg.resize((30
+00021140: 302c 2033 3030 2929 0a20 2020 2020 2020  0, 300)).       
+00021150: 2020 2020 2020 2020 2069 6d2e 7361 7665           im.save
+00021160: 2873 656c 662e 776f 726b 6469 7220 2b20  (self.workdir + 
+00021170: 6e61 6d65 6f6e 6520 2b20 275f 7363 616c  nameone + '_scal
+00021180: 6564 5f27 202b 206e 616d 6574 776f 290a  ed_' + nametwo).
+00021190: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000211a0: 4e6f 6e65 0a0a 2020 2020 6465 6620 7363  None..    def sc
+000211b0: 616c 655f 6d61 736b 696d 6728 7365 6c66  ale_maskimg(self
+000211c0: 293a 0a20 2020 2020 2020 2022 2222 0a0a  ):.        """..
+000211d0: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
+000211e0: 204e 6f6e 650a 2020 2020 2020 2020 2222   None.        ""
+000211f0: 220a 0a20 2020 2020 2020 2023 2069 6d70  "..        # imp
+00021200: 6f72 7420 696d 6167 6569 6f0a 2020 2020  ort imageio.    
+00021210: 2020 2020 696d 706f 7274 2067 6c6f 620a      import glob.
+00021220: 0a20 2020 2020 2020 2066 6f72 2069 6d67  .        for img
+00021230: 6669 6c65 2069 6e20 676c 6f62 2e67 6c6f  file in glob.glo
+00021240: 6228 7365 6c66 2e77 6f72 6b64 6972 202b  b(self.workdir +
+00021250: 2027 2a6d 6173 6b76 6965 772e 6a70 6567   '*maskview.jpeg
+00021260: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
+00021270: 6966 2027 7363 616c 6564 2720 6e6f 7420  if 'scaled' not 
+00021280: 696e 2069 6d67 6669 6c65 3a0a 2020 2020  in imgfile:.    
+00021290: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+000212a0: 6c69 7374 203d 2069 6d67 6669 6c65 2e73  list = imgfile.s
+000212b0: 706c 6974 2827 2f27 295b 2d31 5d2e 7370  plit('/')[-1].sp
+000212c0: 6c69 7428 275f 2729 0a20 2020 2020 2020  lit('_').       
+000212d0: 2020 2020 2020 2020 206e 616d 656f 6e65           nameone
+000212e0: 203d 2027 5f27 2e6a 6f69 6e28 6e61 6d65   = '_'.join(name
+000212f0: 6c69 7374 5b3a 2d31 5d29 0a20 2020 2020  list[:-1]).     
+00021300: 2020 2020 2020 2020 2020 206e 616d 6574             namet
+00021310: 776f 203d 206e 616d 656c 6973 745b 2d31  wo = namelist[-1
+00021320: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00021330: 2020 6e70 696d 6720 3d20 496d 6167 652e    npimg = Image.
+00021340: 6f70 656e 2869 6d67 6669 6c65 290a 2020  open(imgfile).  
+00021350: 2020 2020 2020 2020 2020 2020 2020 696d                im
+00021360: 203d 206e 7069 6d67 2e72 6573 697a 6528   = npimg.resize(
+00021370: 2833 3030 2c20 3330 3029 290a 2020 2020  (300, 300)).    
+00021380: 2020 2020 2020 2020 2020 2020 696d 2e73              im.s
+00021390: 6176 6528 7365 6c66 2e77 6f72 6b64 6972  ave(self.workdir
+000213a0: 202b 206e 616d 656f 6e65 202b 2027 5f73   + nameone + '_s
+000213b0: 6361 6c65 645f 2720 2b20 6e61 6d65 7477  caled_' + nametw
+000213c0: 6f29 0a0a 2020 2020 2020 2020 7265 7475  o)..        retu
+000213d0: 726e 204e 6f6e 650a 0a0a 2020 2020 6465  rn None...    de
+000213e0: 6620 7a6f 6f6d 696e 2873 656c 662c 696d  f zoomin(self,im
+000213f0: 672c 2066 6163 746f 722c 202a 2a6b 7761  g, factor, **kwa
+00021400: 7267 7329 3a0a 2020 2020 2020 2020 2222  rgs):.        ""
+00021410: 220a 2020 2020 2020 2020 2020 2020 5a6f  ".            Zo
+00021420: 6f6d 2069 6e20 746f 2074 6865 2073 7572  om in to the sur
+00021430: 6661 6365 2076 6965 7720 696d 6167 6573  face view images
+00021440: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+00021450: 696d 673a 2069 6d67 206f 626a 6563 7420  img: img object 
+00021460: 6f66 2069 6e70 7574 0a20 2020 2020 2020  of input.       
+00021470: 203a 7265 7475 726e 3a0a 2020 2020 2020   :return:.      
+00021480: 2020 2222 220a 2020 2020 2020 2020 6672    """.        fr
+00021490: 6f6d 2073 6369 7079 2e6e 6469 6d61 6765  om scipy.ndimage
+000214a0: 2069 6d70 6f72 7420 7a6f 6f6d 0a0a 2020   import zoom..  
+000214b0: 2020 2020 2020 682c 2077 203d 2069 6d67        h, w = img
+000214c0: 2e73 6861 7065 5b3a 325d 0a20 2020 2020  .shape[:2].     
+000214d0: 2020 207a 6f6f 6d5f 7475 706c 6520 3d20     zoom_tuple = 
+000214e0: 2866 6163 746f 722c 2920 2a20 3220 2b20  (factor,) * 2 + 
+000214f0: 2831 2c29 202a 2028 696d 672e 6e64 696d  (1,) * (img.ndim
+00021500: 202d 2032 290a 2020 2020 2020 2020 6966   - 2).        if
+00021510: 2066 6163 746f 7220 213d 2031 2e3a 0a20   factor != 1.:. 
+00021520: 2020 2020 2020 2020 2020 2023 2042 6f75             # Bou
+00021530: 6e64 696e 6720 626f 7820 6f66 2074 6865  nding box of the
+00021540: 207a 6f6f 6d65 642d 696e 2072 6567 696f   zoomed-in regio
+00021550: 6e20 7769 7468 696e 2074 6865 2069 6e70  n within the inp
+00021560: 7574 2061 7272 6179 0a20 2020 2020 2020  ut array.       
+00021570: 2020 2020 207a 6820 3d20 696e 7428 6e70       zh = int(np
+00021580: 2e72 6f75 6e64 2868 202f 2066 6163 746f  .round(h / facto
+00021590: 7229 290a 2020 2020 2020 2020 2020 2020  r)).            
+000215a0: 7a77 203d 2069 6e74 286e 702e 726f 756e  zw = int(np.roun
+000215b0: 6428 7720 2f20 6661 6374 6f72 2929 0a20  d(w / factor)). 
+000215c0: 2020 2020 2020 2020 2020 2074 6f70 203d             top =
+000215d0: 2028 6820 2d20 7a68 2920 2f2f 2032 0a20   (h - zh) // 2. 
+000215e0: 2020 2020 2020 2020 2020 206c 6566 7420             left 
+000215f0: 3d20 2877 202d 207a 7729 202f 2f20 320a  = (w - zw) // 2.
+00021600: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
+00021610: 203d 207a 6f6f 6d28 696d 675b 746f 703a   = zoom(img[top:
+00021620: 746f 7020 2b20 7a68 2c20 6c65 6674 3a6c  top + zh, left:l
+00021630: 6566 7420 2b20 7a77 5d2c 207a 6f6f 6d5f  eft + zw], zoom_
+00021640: 7475 706c 652c 202a 2a6b 7761 7267 7329  tuple, **kwargs)
+00021650: 0a20 2020 2020 2020 2020 2020 2074 7269  .            tri
+00021660: 6d5f 746f 7020 3d20 2828 6f75 742e 7368  m_top = ((out.sh
+00021670: 6170 655b 305d 202d 2068 2920 2f2f 2032  ape[0] - h) // 2
+00021680: 290a 2020 2020 2020 2020 2020 2020 7472  ).            tr
+00021690: 696d 5f6c 6566 7420 3d20 2828 6f75 742e  im_left = ((out.
+000216a0: 7368 6170 655b 315d 202d 2077 2920 2f2f  shape[1] - w) //
+000216b0: 2032 290a 2020 2020 2020 2020 2020 2020   2).            
+000216c0: 6f75 7420 3d20 6f75 745b 7472 696d 5f74  out = out[trim_t
+000216d0: 6f70 3a74 7269 6d5f 746f 7020 2b20 682c  op:trim_top + h,
+000216e0: 2074 7269 6d5f 6c65 6674 3a74 7269 6d5f   trim_left:trim_
+000216f0: 6c65 6674 202b 2077 5d0a 0a20 2020 2020  left + w]..     
+00021700: 2020 2023 2049 6620 6661 6374 6f72 203d     # If factor =
+00021710: 3d20 312c 206a 7573 7420 7265 7475 726e  = 1, just return
+00021720: 2074 6865 2069 6e70 7574 2061 7272 6179   the input array
+00021730: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00021740: 2020 2020 2020 2020 2020 206f 7574 203d             out =
+00021750: 2069 6d67 0a0a 2020 2020 2020 2020 7265   img..        re
+00021760: 7475 726e 206f 7574 0a0a 0a20 2020 2040  turn out...    @
+00021770: 7374 6174 6963 6d65 7468 6f64 0a20 2020  staticmethod.   
+00021780: 2064 6566 2073 7572 6661 6365 5f65 6e76   def surface_env
+00021790: 6368 6563 6b28 293a 0a20 2020 2020 2020  check():.       
+000217a0: 2022 2222 0a0a 2020 2020 2020 2020 2020   """..          
+000217b0: 2020 4368 6563 6b20 7468 6520 7275 6e6e    Check the runn
+000217c0: 696e 6720 656e 7669 726f 6e6d 656e 7420  ing environment 
+000217d0: 666f 7220 7375 7266 6163 6520 7669 6577  for surface view
+000217e0: 2e0a 2020 2020 2020 2020 2020 2020 4966  ..            If
+000217f0: 2074 6865 206d 6163 6869 6e65 2069 7320   the machine is 
+00021800: 6865 6164 6c65 7373 2c20 7265 6d69 6e64  headless, remind
+00021810: 2074 6865 2075 7365 7220 7674 6b20 6f72   the user vtk or
+00021820: 2043 6869 6d65 7261 2068 6176 6520 746f   Chimera have to
+00021830: 2062 6520 6275 696c 6420 696e 2074 6865   be build in the
+00021840: 2068 6561 646c 6573 7320 7761 792e 0a20   headless way.. 
+00021850: 2020 2020 2020 2020 2020 2049 6620 7674             If vt
+00021860: 6b20 6361 6e20 6e6f 7420 696d 706f 7274  k can not import
+00021870: 6564 2c20 7472 7920 7573 6520 4368 696d  ed, try use Chim
+00021880: 6572 612e 0a0a 2020 2020 2020 2020 3a72  era...        :r
+00021890: 6574 7572 6e3a 2074 7570 6c65 206f 6620  eturn: tuple of 
+000218a0: 7674 6b70 6163 6b20 616e 6420 6368 696d  vtkpack and chim
+000218b0: 6572 6161 7070 2062 696e 6172 7920 7661  eraapp binary va
+000218c0: 6c75 650a 2020 2020 2020 2020 2222 220a  lue.        """.
+000218d0: 0a20 2020 2020 2020 2064 6973 706c 6179  .        display
+000218e0: 203d 206f 732e 6765 7465 6e76 2827 4449   = os.getenv('DI
+000218f0: 5350 4c41 5927 290a 2020 2020 2020 2020  SPLAY').        
+00021900: 6966 2064 6973 706c 6179 2069 7320 4e6f  if display is No
+00021910: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00021920: 7072 696e 7428 2759 6f75 206d 6179 2072  print('You may r
+00021930: 756e 6e69 6e67 2074 6869 7320 7072 6f67  unning this prog
+00021940: 7261 6d20 6f6e 2061 2068 6561 646c 6573  ram on a headles
+00021950: 7320 6d61 6368 696e 652e 2050 6c65 6173  s machine. Pleas
+00021960: 6520 6d61 6b65 2073 7572 6520 6569 7468  e make sure eith
+00021970: 6572 2068 6561 646c 6573 7320 5654 4b20  er headless VTK 
+00021980: 6f72 2068 6561 646c 6573 7327 205c 0a20  or headless' \. 
+00021990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000219a0: 2027 4368 696d 6572 6158 2061 7265 2070   'ChimeraX are p
+000219b0: 726f 7065 726c 7920 696e 7374 616c 6c65  roperly installe
+000219c0: 6420 6163 636f 7264 696e 676c 792e 2729  d accordingly.')
+000219d0: 0a0a 2020 2020 2020 2020 7674 6b70 6163  ..        vtkpac
+000219e0: 6b20 3d20 4661 6c73 650a 2020 2020 2020  k = False.      
+000219f0: 2020 6368 696d 6572 6161 7070 203d 2046    chimeraapp = F
+00021a00: 616c 7365 0a20 2020 2020 2020 2074 7279  alse.        try
+00021a10: 3a0a 2020 2020 2020 2020 2020 2020 696d  :.            im
+00021a20: 706f 7274 2076 746b 0a20 2020 2020 2020  port vtk.       
+00021a30: 2020 2020 2076 746b 7061 636b 203d 2054       vtkpack = T
+00021a40: 7275 650a 2020 2020 2020 2020 6578 6365  rue.        exce
+00021a50: 7074 2049 6d70 6f72 7445 7272 6f72 3a0a  pt ImportError:.
+00021a60: 2020 2020 2020 2020 2020 2020 7379 732e              sys.
+00021a70: 7374 6465 7272 2e77 7269 7465 2827 5654  stderr.write('VT
+00021a80: 4b20 6973 206e 6f74 2069 6e73 7461 6c6c  K is not install
+00021a90: 6564 206f 7220 696d 706f 7274 6564 2070  ed or imported p
+00021aa0: 726f 7065 726c 792e 2054 7279 696e 6720  roperly. Trying 
+00021ab0: 746f 2075 7365 2043 6869 6d65 7261 5820  to use ChimeraX 
+00021ac0: 746f 2070 726f 6475 6365 2073 7572 6661  to produce surfa
+00021ad0: 6365 2076 6965 7773 2e5c 6e27 290a 0a20  ce views.\n').. 
+00021ae0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+00021af0: 2020 2020 2020 2020 6966 2043 4849 4d45          if CHIME
+00021b00: 5241 2069 7320 6e6f 7420 4e6f 6e65 3a0a  RA is not None:.
+00021b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021b20: 6368 696d 6572 6161 7070 203d 2043 4849  chimeraapp = CHI
+00021b30: 4d45 5241 0a20 2020 2020 2020 2020 2020  MERA.           
+00021b40: 2020 2020 2070 7269 6e74 2863 6869 6d65       print(chime
+00021b50: 7261 6170 7029 0a20 2020 2020 2020 2020  raapp).         
+00021b60: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00021b70: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00021b80: 6669 6e64 5f65 7865 6375 7461 626c 6528  find_executable(
+00021b90: 2743 6869 6d65 7261 5827 2920 6973 206e  'ChimeraX') is n
+00021ba0: 6f74 204e 6f6e 650a 2020 2020 2020 2020  ot None.        
+00021bb0: 2020 2020 2020 2020 6368 696d 6572 6161          chimeraa
+00021bc0: 7070 203d 2066 696e 645f 6578 6563 7574  pp = find_execut
+00021bd0: 6162 6c65 2827 4368 696d 6572 6158 2729  able('ChimeraX')
+00021be0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021bf0: 2070 7269 6e74 2863 6869 6d65 7261 6170   print(chimeraap
+00021c00: 7029 0a20 2020 2020 2020 2065 7863 6570  p).        excep
+00021c10: 7420 4173 7365 7274 696f 6e45 7272 6f72  t AssertionError
+00021c20: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+00021c30: 7072 696e 7428 2743 6869 6d65 7261 2065  print('Chimera e
+00021c40: 7865 6375 7461 626c 6520 6973 206e 6f74  xecutable is not
+00021c50: 2074 6865 7265 2e27 2c20 6669 6c65 3d73   there.', file=s
+00021c60: 7973 2e73 7464 6572 7229 0a20 2020 2020  ys.stderr).     
+00021c70: 2020 2020 2020 2073 7973 2e73 7464 6572         sys.stder
+00021c80: 722e 7772 6974 6528 2743 6869 6d65 7261  r.write('Chimera
+00021c90: 5820 6578 6563 7574 6162 6c65 2069 7320  X executable is 
+00021ca0: 6e6f 7420 7468 6572 652e 5c6e 2729 0a0a  not there.\n')..
+00021cb0: 2020 2020 2020 2020 7265 7475 726e 2076          return v
+00021cc0: 746b 7061 636b 2c20 6368 696d 6572 6161  tkpack, chimeraa
+00021cd0: 7070 0a0a 2020 2020 2320 4465 6e73 6974  pp..    # Densit
+00021ce0: 7920 6469 7374 7269 6275 7469 6f6e 0a20  y distribution. 
+00021cf0: 2020 2023 2040 7072 6f66 696c 650a 2020     # @profile.  
+00021d00: 2020 6465 6620 6d61 7064 656e 7369 7479    def mapdensity
+00021d10: 5f64 6973 7472 6962 7574 696f 6e28 7365  _distribution(se
+00021d20: 6c66 293a 0a20 2020 2020 2020 2022 2222  lf):.        """
+00021d30: 0a0a 2020 2020 2020 2020 2020 2020 7072  ..            pr
+00021d40: 6f64 7563 6520 7468 6520 6d61 7020 6465  oduce the map de
+00021d50: 6e73 6974 7920 6469 7374 7269 6275 7469  nsity distributi
+00021d60: 6f6e 0a0a 2020 2020 2020 2020 3a72 6574  on..        :ret
+00021d70: 7572 6e3a 204e 6f6e 650a 2020 2020 2020  urn: None.      
+00021d80: 2020 2222 220a 2020 2020 2020 2020 7365    """.        se
+00021d90: 6c66 2e64 656e 7369 7479 5f64 6973 7472  lf.density_distr
+00021da0: 6962 7574 696f 6e28 7365 6c66 2e6d 6170  ibution(self.map
+00021db0: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+00021dc0: 6e20 4e6f 6e65 0a0a 2020 2020 2320 4070  n None..    # @p
+00021dd0: 726f 6669 6c65 0a20 2020 2064 6566 2072  rofile.    def r
+00021de0: 6177 6d61 7064 656e 7369 7479 5f64 6973  awmapdensity_dis
+00021df0: 7472 6962 7574 696f 6e28 7365 6c66 293a  tribution(self):
+00021e00: 0a20 2020 2020 2020 2022 2222 0a0a 2020  .        """..  
+00021e10: 2020 2020 2020 2020 2020 5072 6f64 7563            Produc
+00021e20: 6520 7261 7720 6d61 7020 6465 6e73 6974  e raw map densit
+00021e30: 7920 6469 7374 7269 6275 7469 6f6e 0a0a  y distribution..
+00021e40: 2020 2020 2020 2020 3a70 6172 616d 2072          :param r
+00021e50: 6177 6d61 703a 2052 6177 206d 6170 206f  awmap: Raw map o
+00021e60: 626a 6563 740a 2020 2020 2020 2020 3a72  bject.        :r
+00021e70: 6574 7572 6e3a 204e 6f6e 650a 2020 2020  eturn: None.    
+00021e80: 2020 2020 2222 220a 0a20 2020 2020 2020      """..       
+00021e90: 2069 6620 7365 6c66 2e72 6177 6d61 7020   if self.rawmap 
+00021ea0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00021eb0: 2020 2020 2020 2020 2073 656c 662e 6465           self.de
+00021ec0: 6e73 6974 795f 6469 7374 7269 6275 7469  nsity_distributi
+00021ed0: 6f6e 2873 656c 662e 7261 776d 6170 290a  on(self.rawmap).
+00021ee0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00021ef0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+00021f00: 2754 6865 7265 2069 7320 6e6f 2072 6177  'There is no raw
+00021f10: 206d 6170 2066 6f72 2064 656e 7369 7479   map for density
+00021f20: 2064 6973 7472 6962 7574 696f 6e2e 2729   distribution.')
+00021f30: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
+00021f40: 6e74 2827 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  nt('------------
+00021f50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00021f60: 2d2d 2d2d 2d2d 2d2d 2729 0a0a 2020 2020  --------')..    
+00021f70: 2020 2020 7265 7475 726e 204e 6f6e 650a      return None.
+00021f80: 0a20 2020 2023 2040 7072 6f66 696c 650a  .    # @profile.
+00021f90: 2020 2020 6465 6620 6465 6e73 6974 795f      def density_
+00021fa0: 6469 7374 7269 6275 7469 6f6e 2873 656c  distribution(sel
+00021fb0: 662c 2064 656e 6d61 703d 4e6f 6e65 293a  f, denmap=None):
+00021fc0: 0a20 2020 2020 2020 2022 2222 0a0a 2020  .        """..  
+00021fd0: 2020 2020 2020 2020 2020 5072 6f64 7563            Produc
+00021fe0: 6520 6465 6e73 6974 7920 7661 6c75 6520  e density value 
+00021ff0: 6469 7374 7269 6275 7469 6f6e 2069 6e66  distribution inf
+00022000: 6f72 6d61 7469 6f6e 2077 6974 6820 7468  ormation with th
+00022010: 6520 6465 6e73 6974 7920 6d61 7020 696e  e density map in
+00022020: 666f 726d 6174 696f 6e2e 0a20 2020 2020  formation..     
+00022030: 2020 2020 2020 2078 2077 6173 2064 6976         x was div
+00022040: 6964 6564 2069 6e74 6f20 3132 3820 6269  ided into 128 bi
+00022050: 6e73 0a20 2020 2020 2020 2020 2020 2079  ns.            y
+00022060: 2077 6173 2073 6361 6c65 6420 6279 206c   was scaled by l
+00022070: 6f67 6172 6974 686d 6963 2031 3020 2866  ogarithmic 10 (f
+00022080: 6f72 2030 2076 616c 7565 2061 6464 2031  or 0 value add 1
+00022090: 2074 6f20 6967 6f6e 7265 2061 7274 6966   to igonre artif
+000220a0: 6163 7473 290a 0a20 2020 2020 2020 203a  acts)..        :
+000220b0: 7061 7261 6d3a 204e 6f6e 650a 2020 2020  param: None.    
+000220c0: 2020 2020 3a72 6574 7572 6e3a 204e 6f6e      :return: Non
+000220d0: 650a 0a20 2020 2020 2020 2022 2222 0a0a  e..        """..
+000220e0: 2020 2020 2020 2020 7374 6172 7420 3d20          start = 
+000220f0: 7469 6d65 6974 2e64 6566 6175 6c74 5f74  timeit.default_t
+00022100: 696d 6572 2829 0a20 2020 2020 2020 2062  imer().        b
+00022110: 696e 7320 3d20 3132 380a 2020 2020 2020  ins = 128.      
+00022120: 2020 6572 726c 6973 7420 3d20 5b5d 0a20    errlist = []. 
+00022130: 2020 2020 2020 2064 6174 6164 6963 7420         datadict 
+00022140: 3d20 7b7d 0a20 2020 2020 2020 2023 2063  = {}.        # c
+00022150: 7572 6d61 706e 616d 6520 3d20 6f73 2e70  urmapname = os.p
+00022160: 6174 682e 6261 7365 6e61 6d65 2864 656e  ath.basename(den
+00022170: 6d61 702e 6669 6c65 6e61 6d65 290a 2020  map.filename).  
+00022180: 2020 2020 2020 6375 726d 6170 6e61 6d65        curmapname
+00022190: 203d 206f 732e 7061 7468 2e62 6173 656e   = os.path.basen
+000221a0: 616d 6528 6465 6e6d 6170 2e66 756c 6c6e  ame(denmap.fulln
+000221b0: 616d 6529 0a20 2020 2020 2020 2069 6620  ame).        if 
+000221c0: 2772 6177 6d61 7027 2069 6e20 6375 726d  'rawmap' in curm
+000221d0: 6170 6e61 6d65 3a0a 2020 2020 2020 2020  apname:.        
+000221e0: 2020 2020 7461 6720 3d20 2772 6177 6d61      tag = 'rawma
+000221f0: 705f 270a 2020 2020 2020 2020 656c 7365  p_'.        else
+00022200: 3a0a 2020 2020 2020 2020 2020 2020 7461  :.            ta
+00022210: 6720 3d20 2727 0a20 2020 2020 2020 2074  g = ''.        t
+00022220: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00022230: 2320 6d61 7064 6174 6120 3d20 7365 6c66  # mapdata = self
+00022240: 2e6d 6170 2e67 6574 4d61 7028 290a 2020  .map.getMap().  
+00022250: 2020 2020 2020 2020 2020 6d61 7064 6174            mapdat
+00022260: 6120 3d20 6465 6e6d 6170 2e64 6174 610a  a = denmap.data.
+00022270: 2020 2020 2020 2020 2020 2020 666c 6174              flat
+00022280: 6d61 7020 3d20 6d61 7064 6174 612e 666c  map = mapdata.fl
+00022290: 6174 7465 6e28 290a 2020 2020 2020 2020  atten().        
+000222a0: 2020 2020 2320 6461 7461 6d6f 6465 203d      # datamode =
+000222b0: 2073 656c 662e 6d61 702e 6865 6164 6572   self.map.header
+000222c0: 5b33 5d0a 2020 2020 2020 2020 2020 2020  [3].            
+000222d0: 6461 7461 6d6f 6465 203d 2073 656c 662e  datamode = self.
+000222e0: 6d61 702e 6865 6164 6572 2e6d 6f64 650a  map.header.mode.
+000222f0: 2020 2020 2020 2020 2020 2020 756e 6971              uniq
+00022300: 7565 732c 2075 6e69 7175 6563 6f75 6e74  ues, uniquecount
+00022310: 7320 3d20 6e70 2e75 6e69 7175 6528 666c  s = np.unique(fl
+00022320: 6174 6d61 702c 2072 6574 7572 6e5f 636f  atmap, return_co
+00022330: 756e 7473 3d54 7275 6529 0a20 2020 2020  unts=True).     
+00022340: 2020 2020 2020 2075 6e69 7175 656c 656e         uniquelen
+00022350: 203d 206c 656e 2875 6e69 7175 6573 290a   = len(uniques).
+00022360: 2020 2020 2020 2020 2020 2020 6966 2064              if d
+00022370: 6174 616d 6f64 6520 3d3d 2030 3a0a 2020  atamode == 0:.  
+00022380: 2020 2020 2020 2020 2020 2020 2020 6269                bi
+00022390: 6e73 203d 2075 6e69 7175 6573 0a20 2020  ns = uniques.   
+000223a0: 2020 2020 2020 2020 2020 2020 2068 6973               his
+000223b0: 742c 2062 696e 5f65 6467 6573 203d 206e  t, bin_edges = n
+000223c0: 702e 6869 7374 6f67 7261 6d28 666c 6174  p.histogram(flat
+000223d0: 6d61 702c 2062 696e 733d 6269 6e73 290a  map, bins=bins).
+000223e0: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+000223f0: 2064 6174 616d 6f64 6520 3d3d 2031 206f   datamode == 1 o
+00022400: 7220 6461 7461 6d6f 6465 203d 3d20 363a  r datamode == 6:
+00022410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022420: 2069 6620 756e 6971 7565 6c65 6e20 3e20   if uniquelen > 
+00022430: 3130 3030 3a0a 2020 2020 2020 2020 2020  1000:.          
+00022440: 2020 2020 2020 2020 2020 696e 6473 203d            inds =
+00022450: 206e 702e 6c69 6e73 7061 6365 2830 2c20   np.linspace(0, 
+00022460: 756e 6971 7565 6c65 6e2d 312c 206e 756d  uniquelen-1, num
+00022470: 3d31 3238 2c20 6474 7970 653d 6e70 2e75  =128, dtype=np.u
+00022480: 696e 7431 3629 0a20 2020 2020 2020 2020  int16).         
+00022490: 2020 2020 2020 2020 2020 2062 696e 7320             bins 
+000224a0: 3d20 6e70 2e74 616b 6528 756e 6971 7565  = np.take(unique
+000224b0: 732c 2069 6e64 7329 0a20 2020 2020 2020  s, inds).       
+000224c0: 2020 2020 2020 2020 2020 2020 2068 6973               his
+000224d0: 742c 2062 696e 5f65 6467 6573 203d 206e  t, bin_edges = n
+000224e0: 702e 6869 7374 6f67 7261 6d28 666c 6174  p.histogram(flat
+000224f0: 6d61 702c 2062 696e 733d 6269 6e73 290a  map, bins=bins).
+00022500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022510: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00022520: 2020 2020 2020 2020 2020 6869 7374 203d            hist =
+00022530: 2075 6e69 7175 6563 6f75 6e74 730a 2020   uniquecounts.  
+00022540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022550: 2020 6269 6e5f 6564 6765 7320 3d20 6e70    bin_edges = np
+00022560: 2e61 7070 656e 6428 756e 6971 7565 732c  .append(uniques,
+00022570: 2075 6e69 7175 6573 5b2d 315d 290a 2020   uniques[-1]).  
+00022580: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00022590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000225a0: 6269 6e73 203d 206e 702e 6c69 6e73 7061  bins = np.linspa
+000225b0: 6365 286d 696e 2866 6c61 746d 6170 292c  ce(min(flatmap),
+000225c0: 206d 6178 2866 6c61 746d 6170 292c 2031   max(flatmap), 1
+000225d0: 3238 290a 2020 2020 2020 2020 2020 2020  28).            
+000225e0: 2020 2020 6869 7374 2c20 6269 6e5f 6564      hist, bin_ed
+000225f0: 6765 7320 3d20 6e70 2e68 6973 746f 6772  ges = np.histogr
+00022600: 616d 2866 6c61 746d 6170 2c20 6269 6e73  am(flatmap, bins
+00022610: 3d62 696e 7329 0a20 2020 2020 2020 2020  =bins).         
+00022620: 2020 2023 2068 6973 742c 2062 696e 5f65     # hist, bin_e
+00022630: 6467 6573 203d 206e 702e 6869 7374 6f67  dges = np.histog
+00022640: 7261 6d28 666c 6174 6d61 702c 2062 696e  ram(flatmap, bin
+00022650: 733d 6269 6e73 290a 2020 2020 2020 2020  s=bins).        
+00022660: 2020 2020 6869 7374 5b68 6973 7420 3c20      hist[hist < 
+00022670: 315d 203d 2031 0a20 2020 2020 2020 2020  1] = 1.         
+00022680: 2020 206e 6577 6869 7374 203d 206e 702e     newhist = np.
+00022690: 6c6f 6731 3028 6869 7374 290a 0a20 2020  log10(hist)..   
+000226a0: 2020 2020 2020 2020 2070 6c74 2e66 6967           plt.fig
+000226b0: 7572 6528 6669 6773 697a 653d 2831 302c  ure(figsize=(10,
+000226c0: 2033 2929 0a20 2020 2020 2020 2020 2020   3)).           
+000226d0: 2070 6c74 2e70 6c6f 7428 6e70 2e72 6f75   plt.plot(np.rou
+000226e0: 6e64 2862 696e 5f65 6467 6573 5b3a 2d31  nd(bin_edges[:-1
+000226f0: 5d2c 2031 3029 2e74 6f6c 6973 7428 292c  ], 10).tolist(),
+00022700: 206e 702e 726f 756e 6428 6e65 7768 6973   np.round(newhis
+00022710: 742c 2031 3029 2e74 6f6c 6973 7428 2929  t, 10).tolist())
+00022720: 0a20 2020 2020 2020 2020 2020 2070 6c74  .            plt
+00022730: 2e73 6176 6566 6967 2873 656c 662e 776f  .savefig(self.wo
+00022740: 726b 6469 7220 2b20 272f 2720 2b20 6375  rkdir + '/' + cu
+00022750: 726d 6170 6e61 6d65 202b 2027 5f76 6f78  rmapname + '_vox
+00022760: 656c 5f64 6973 7472 6962 7574 696f 6e2e  el_distribution.
+00022770: 706e 6727 290a 2020 2020 2020 2020 2020  png').          
+00022780: 2020 706c 742e 636c 6f73 6528 290a 0a20    plt.close().. 
+00022790: 2020 2020 2020 2020 2020 206d 6f64 6520             mode 
+000227a0: 3d20 6e70 2e72 6f75 6e64 2862 696e 5f65  = np.round(bin_e
+000227b0: 6467 6573 5b3a 2d31 5d5b 6e70 2e61 7267  dges[:-1][np.arg
+000227c0: 6d61 7828 6e65 7768 6973 7429 5d2c 2035  max(newhist)], 5
+000227d0: 292e 746f 6c69 7374 2829 0a20 2020 2020  ).tolist().     
+000227e0: 2020 2020 2020 2064 6174 6164 6963 7420         datadict 
+000227f0: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
+00022800: 2020 2020 7461 6720 2b20 2764 656e 7369      tag + 'densi
+00022810: 7479 5f64 6973 7472 6962 7574 696f 6e27  ty_distribution'
+00022820: 3a20 7b27 7927 3a20 6e70 2e72 6f75 6e64  : {'y': np.round
+00022830: 286e 6577 6869 7374 2c20 3130 292e 746f  (newhist, 10).to
+00022840: 6c69 7374 2829 2c0a 2020 2020 2020 2020  list(),.        
+00022850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022870: 2027 7827 3a20 6e70 2e72 6f75 6e64 2862   'x': np.round(b
+00022880: 696e 5f65 6467 6573 5b3a 2d31 5d2c 2031  in_edges[:-1], 1
+00022890: 3029 2e74 6f6c 6973 7428 292c 0a20 2020  0).tolist(),.   
+000228a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000228b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000228c0: 2020 2020 2020 276d 6f64 6527 3a20 6d6f        'mode': mo
+000228d0: 6465 7d7d 0a20 2020 2020 2020 2065 7863  de}}.        exc
+000228e0: 6570 743a 0a20 2020 2020 2020 2020 2020  ept:.           
+000228f0: 2065 7272 203d 2027 4465 6e73 6974 7920   err = 'Density 
+00022900: 6469 7374 7269 6275 7469 6f6e 2065 7272  distribution err
+00022910: 6f72 3a7b 7d2e 272e 666f 726d 6174 2873  or:{}.'.format(s
+00022920: 7973 2e65 7863 5f69 6e66 6f28 295b 315d  ys.exc_info()[1]
+00022930: 290a 2020 2020 2020 2020 2020 2020 6572  ).            er
+00022940: 726c 6973 742e 6170 7065 6e64 2865 7272  rlist.append(err
+00022950: 290a 2020 2020 2020 2020 2020 2020 7379  ).            sy
+00022960: 732e 7374 6465 7272 2e77 7269 7465 2865  s.stderr.write(e
+00022970: 7272 202b 2027 5c6e 2729 0a0a 2020 2020  rr + '\n')..    
+00022980: 2020 2020 6966 2065 7272 6c69 7374 3a0a      if errlist:.
+00022990: 2020 2020 2020 2020 2020 2020 6461 7461              data
+000229a0: 6469 6374 203d 207b 7461 6720 2b20 2764  dict = {tag + 'd
+000229b0: 656e 7369 7479 5f64 6973 7472 6962 7574  ensity_distribut
+000229c0: 696f 6e27 3a20 7b27 6572 7227 3a20 7b27  ion': {'err': {'
+000229d0: 6465 6e73 6974 795f 6469 7374 7269 6275  density_distribu
+000229e0: 7469 6f6e 5f65 7272 6f72 273a 2065 7272  tion_error': err
+000229f0: 6c69 7374 7d7d 7d0a 0a20 2020 2020 2020  list}}}..       
+00022a00: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+00022a10: 2020 7769 7468 2063 6f64 6563 732e 6f70    with codecs.op
+00022a20: 656e 2873 656c 662e 776f 726b 6469 7220  en(self.workdir 
+00022a30: 2b20 6375 726d 6170 6e61 6d65 202b 2027  + curmapname + '
+00022a40: 5f64 656e 7369 7479 5f64 6973 7472 6962  _density_distrib
+00022a50: 7574 696f 6e2e 6a73 6f6e 272c 2027 7727  ution.json', 'w'
+00022a60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00022a70: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00022a80: 6e63 6f64 696e 673d 2775 7466 2d38 2729  ncoding='utf-8')
+00022a90: 2061 7320 663a 0a20 2020 2020 2020 2020   as f:.         
+00022aa0: 2020 2020 2020 206a 736f 6e2e 6475 6d70         json.dump
+00022ab0: 2864 6174 6164 6963 742c 2066 290a 2020  (datadict, f).  
+00022ac0: 2020 2020 2020 6578 6365 7074 3a0a 2020        except:.  
+00022ad0: 2020 2020 2020 2020 2020 7379 732e 7374            sys.st
+00022ae0: 6465 7272 2e77 7269 7465 2827 5361 7669  derr.write('Savi
+00022af0: 6e67 2064 656e 6973 7479 2064 6973 7472  ng denisty distr
+00022b00: 6962 7574 696f 6e20 746f 206a 736f 6e20  ibution to json 
+00022b10: 6572 726f 722e 2729 0a0a 2020 2020 2020  error.')..      
+00022b20: 2020 656e 6420 3d20 7469 6d65 6974 2e64    end = timeit.d
+00022b30: 6566 6175 6c74 5f74 696d 6572 2829 0a20  efault_timer(). 
+00022b40: 2020 2020 2020 2070 7269 6e74 2874 6167         print(tag
+00022b50: 202b 2027 4465 6e73 6974 7920 6469 7374   + 'Density dist
+00022b60: 7269 6275 7469 6f6e 2074 696d 653a 2025  ribution time: %
+00022b70: 7327 2025 2028 656e 6420 2d20 7374 6172  s' % (end - star
+00022b80: 7429 290a 2020 2020 2020 2020 7072 696e  t)).        prin
+00022b90: 7428 272d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  t('-------------
+00022ba0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00022bb0: 2d2d 2d2d 2d2d 2d27 290a 0a20 2020 2020  -------')..     
+00022bc0: 2020 2072 6574 7572 6e20 4e6f 6e65 0a0a     return None..
+00022bd0: 2020 2020 2320 4174 6f6d 2061 6e64 2072      # Atom and r
+00022be0: 6573 6964 7565 2069 6e63 6c75 6473 696f  esidue includsio
+00022bf0: 6e0a 2020 2020 4073 7461 7469 636d 6574  n.    @staticmet
+00022c00: 686f 640a 2020 2020 6465 6620 5f5f 666c  hod.    def __fl
+00022c10: 6f61 746f 6865 7828 6e75 6d6c 6973 7429  oatohex(numlist)
+00022c20: 3a0a 2020 2020 2020 2020 2222 220a 0a20  :.        """.. 
+00022c30: 2020 2020 2020 2020 2020 2050 726f 6475             Produ
+00022c40: 6365 2068 6578 2063 6f6c 6f72 2062 6574  ce hex color bet
+00022c50: 7765 656e 2072 6564 2061 6e64 2067 7265  ween red and gre
+00022c60: 656e 0a0a 2020 2020 2020 2020 3a70 6172  en..        :par
+00022c70: 616d 206e 756d 6c69 7374 3a20 4120 6c69  am numlist: A li
+00022c80: 7374 206f 6620 5247 4220 7661 6c75 6573  st of RGB values
+00022c90: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
+00022ca0: 3a20 4120 6c69 7374 206f 6620 6865 7820  : A list of hex 
+00022cb0: 7661 6c75 6520 6265 7477 6565 6e20 5220  value between R 
+00022cc0: 616e 6420 4720 7769 7468 2042 203d 2030  and G with B = 0
+00022cd0: 0a0a 2020 2020 2020 2020 2222 220a 0a20  ..        """.. 
+00022ce0: 2020 2020 2020 2023 2072 6762 7320 3d20         # rgbs = 
+00022cf0: 5b5b 696e 7428 2831 202d 206e 756d 2920  [[int((1 - num) 
+00022d00: 2a20 3235 3529 2c20 696e 7428 6e75 6d20  * 255), int(num 
+00022d10: 2a20 3235 3529 2c20 305d 2066 6f72 206e  * 255), 0] for n
+00022d20: 756d 2069 6e20 6e75 6d6c 6973 745d 0a20  um in numlist]. 
+00022d30: 2020 2020 2020 2023 2072 6762 7320 3d20         # rgbs = 
+00022d40: 5b5b 696e 7428 2831 202d 206e 756d 2920  [[int((1 - num) 
+00022d50: 2a20 3235 3529 2a30 2e35 2c20 3132 302c  * 255)*0.5, 120,
+00022d60: 2069 6e74 286e 756d 202a 2032 3535 292a   int(num * 255)*
+00022d70: 302e 355d 2066 6f72 206e 756d 2069 6e20  0.5] for num in 
+00022d80: 6e75 6d6c 6973 745d 0a20 2020 2020 2020  numlist].       
+00022d90: 206e 756d 6c69 7374 203d 205b 2d31 2069   numlist = [-1 i
+00022da0: 6620 6920 3c20 3020 656c 7365 2069 2066  f i < 0 else i f
+00022db0: 6f72 2069 2069 6e20 6e75 6d6c 6973 745d  or i in numlist]
+00022dc0: 0a20 2020 2020 2020 2072 6762 7320 3d20  .        rgbs = 
+00022dd0: 5b5b 3132 322c 2069 6e74 286e 756d 202a  [[122, int(num *
+00022de0: 2032 3535 292c 2069 6e74 286e 756d 202a   255), int(num *
+00022df0: 2032 3535 295d 2069 6620 6e75 6d20 3e3d   255)] if num >=
+00022e00: 2030 2065 6c73 6520 5b32 3535 2c20 302c   0 else [255, 0,
+00022e10: 2032 3535 5d20 666f 7220 6e75 6d20 696e   255] for num in
+00022e20: 206e 756d 6c69 7374 5d0a 2020 2020 2020   numlist].      
+00022e30: 2020 7265 7375 6c74 6c69 7374 203d 205b    resultlist = [
+00022e40: 2723 2530 3258 2530 3258 2530 3258 2720  '#%02X%02X%02X' 
+00022e50: 2520 2872 6762 5b30 5d2c 2072 6762 5b31  % (rgb[0], rgb[1
+00022e60: 5d2c 2072 6762 5b32 5d29 2066 6f72 2072  ], rgb[2]) for r
+00022e70: 6762 2069 6e20 7267 6273 5d0a 0a20 2020  gb in rgbs]..   
+00022e80: 2020 2020 2072 6574 7572 6e20 7265 7375       return resu
+00022e90: 6c74 6c69 7374 0a0a 2020 2020 2320 4174  ltlist..    # At
+00022ea0: 6f6d 2061 6e64 2072 6573 6964 7565 2069  om and residue i
+00022eb0: 6e63 6c75 6473 696f 6e0a 2020 2020 4073  ncludsion.    @s
+00022ec0: 7461 7469 636d 6574 686f 640a 2020 2020  taticmethod.    
+00022ed0: 6465 6620 5f5f 666c 6f61 746f 6865 785f  def __floatohex_
+00022ee0: 6162 6f76 656f 6e65 286e 756d 6c69 7374  aboveone(numlist
+00022ef0: 293a 0a20 2020 2020 2020 2022 2222 0a0a  ):.        """..
+00022f00: 2020 2020 2020 2020 2020 2020 5072 6f64              Prod
+00022f10: 7563 6520 6865 7820 636f 6c6f 7220 6265  uce hex color be
+00022f20: 7477 6565 6e20 7265 6420 616e 6420 6772  tween red and gr
+00022f30: 6565 6e0a 0a20 2020 2020 2020 203a 7061  een..        :pa
+00022f40: 7261 6d20 6e75 6d6c 6973 743a 2041 206c  ram numlist: A l
+00022f50: 6973 7420 6f66 2052 4742 2076 616c 7565  ist of RGB value
+00022f60: 730a 2020 2020 2020 2020 3a72 6574 7572  s.        :retur
+00022f70: 6e3a 2041 206c 6973 7420 6f66 2068 6578  n: A list of hex
+00022f80: 2076 616c 7565 2062 6574 7765 656e 2052   value between R
+00022f90: 2061 6e64 2047 2077 6974 6820 4220 3d20   and G with B = 
+00022fa0: 300a 0a20 2020 2020 2020 2022 2222 0a0a  0..        """..
+00022fb0: 2020 2020 2020 2020 2320 7267 6273 203d          # rgbs =
+00022fc0: 205b 5b69 6e74 2828 3120 2d20 6e75 6d29   [[int((1 - num)
+00022fd0: 202a 2032 3535 292c 2069 6e74 286e 756d   * 255), int(num
+00022fe0: 202a 2032 3535 292c 2030 5d20 666f 7220   * 255), 0] for 
+00022ff0: 6e75 6d20 696e 206e 756d 6c69 7374 5d0a  num in numlist].
+00023000: 2020 2020 2020 2020 2320 7267 6273 203d          # rgbs =
+00023010: 205b 5b69 6e74 2828 3120 2d20 6e75 6d29   [[int((1 - num)
+00023020: 202a 2032 3535 292a 302e 352c 2031 3230   * 255)*0.5, 120
+00023030: 2c20 696e 7428 6e75 6d20 2a20 3235 3529  , int(num * 255)
+00023040: 2a30 2e35 5d20 666f 7220 6e75 6d20 696e  *0.5] for num in
+00023050: 206e 756d 6c69 7374 5d0a 2020 2020 2020   numlist].      
+00023060: 2020 6e75 6d6c 6973 7420 3d20 5b2d 3120    numlist = [-1 
+00023070: 6966 2069 203c 2030 2065 6c73 6520 6920  if i < 0 else i 
+00023080: 666f 7220 6920 696e 206e 756d 6c69 7374  for i in numlist
+00023090: 5d0a 2020 2020 2020 2020 7267 6273 203d  ].        rgbs =
+000230a0: 205b 5b69 6e74 286e 756d 202a 2031 3329   [[int(num * 13)
+000230b0: 2c20 302c 2069 6e74 286e 756d 202a 2032  , 0, int(num * 2
+000230c0: 3535 295d 2069 6620 6e75 6d20 3e3d 2030  55)] if num >= 0
+000230d0: 2065 6c73 6520 5b32 3535 2c20 302c 2032   else [255, 0, 2
+000230e0: 3535 5d20 666f 7220 6e75 6d20 696e 206e  55] for num in n
+000230f0: 756d 6c69 7374 5d0a 2020 2020 2020 2020  umlist].        
+00023100: 7265 7375 6c74 6c69 7374 203d 205b 5d0a  resultlist = [].
+00023110: 2020 2020 2020 2020 7265 7375 6c74 6c69          resultli
+00023120: 7374 203d 205b 2723 2530 3258 2530 3258  st = ['#%02X%02X
+00023130: 2530 3258 2720 2520 2872 6762 5b30 5d2c  %02X' % (rgb[0],
+00023140: 2072 6762 5b31 5d2c 2072 6762 5b32 5d29   rgb[1], rgb[2])
+00023150: 2066 6f72 2072 6762 2069 6e20 7267 6273   for rgb in rgbs
+00023160: 5d0a 0a20 2020 2020 2020 2072 6574 7572  ]..        retur
+00023170: 6e20 7265 7375 6c74 6c69 7374 0a0a 2020  n resultlist..  
+00023180: 2020 6465 6620 5f5f 696e 7465 7250 6f6c    def __interPol
+00023190: 6174 696f 6e28 7365 6c66 293a 0a20 2020  ation(self):.   
+000231a0: 2020 2020 2022 2222 0a0a 2020 2020 2020       """..      
+000231b0: 2020 2020 2020 5573 6320 7363 6970 7920        Usc scipy 
+000231c0: 7265 6775 6c61 7267 7269 6420 696e 7465  regulargrid inte
+000231d0: 7270 6f6c 6174 696f 6e20 6d65 7468 6f64  rpolation method
+000231e0: 2066 6565 6420 7769 7468 2061 6c6c 206d   feed with all m
+000231f0: 6170 7320 696e 666f 0a0a 2020 2020 2020  aps info..      
+00023200: 2020 3a70 6172 616d 206d 6170 3a20 456c    :param map: El
+00023210: 6563 7472 6f6e 2064 656e 7369 7479 206d  ectron density m
+00023220: 6170 2069 6e20 6d72 632f 6d61 7020 666f  ap in mrc/map fo
+00023230: 726d 6174 0a20 2020 2020 2020 203a 7061  rmat.        :pa
+00023240: 7261 6d20 6d6f 6465 6c3a 2050 726f 7465  ram model: Prote
+00023250: 696e 206d 6f64 656c 2069 6e20 6d6d 6369  in model in mmci
+00023260: 6620 666f 726d 6174 0a20 2020 2020 2020  f format.       
+00023270: 203a 7265 7475 726e 3a20 4120 696e 7465   :return: A inte
+00023280: 7270 6f6c 6174 696f 6e20 6675 6e63 7469  rpolation functi
+00023290: 6f6e 0a0a 2020 2020 2020 2020 2222 220a  on..        """.
+000232a0: 0a20 2020 2020 2020 2023 206d 6170 6461  .        # mapda
+000232b0: 7461 203d 2073 656c 662e 6d61 702e 6765  ta = self.map.ge
+000232c0: 744d 6170 2829 0a20 2020 2020 2020 206d  tMap().        m
+000232d0: 6170 6461 7461 203d 2073 656c 662e 6d61  apdata = self.ma
+000232e0: 702e 6461 7461 0a20 2020 2020 2020 2074  p.data.        t
+000232f0: 6d70 6d61 7064 6174 6120 3d20 6e70 2e73  mpmapdata = np.s
+00023300: 7761 7061 7865 7328 6d61 7064 6174 612c  wapaxes(mapdata,
+00023310: 2030 2c20 3229 0a20 2020 2020 2020 2063   0, 2).        c
+00023320: 6c69 6d2c 2062 6c69 6d2c 2061 6c69 6d20  lim, blim, alim 
+00023330: 3d20 6d61 7064 6174 612e 7368 6170 650a  = mapdata.shape.
+00023340: 2020 2020 2020 2020 7820 3d20 7261 6e67          x = rang
+00023350: 6528 616c 696d 290a 2020 2020 2020 2020  e(alim).        
+00023360: 7920 3d20 7261 6e67 6528 626c 696d 290a  y = range(blim).
+00023370: 2020 2020 2020 2020 7a20 3d20 7261 6e67          z = rang
+00023380: 6528 636c 696d 290a 2020 2020 2020 2020  e(clim).        
+00023390: 6d79 696e 7465 7220 3d20 5265 6775 6c61  myinter = Regula
+000233a0: 7247 7269 6449 6e74 6572 706f 6c61 746f  rGridInterpolato
+000233b0: 7228 2878 2c20 792c 207a 292c 2074 6d70  r((x, y, z), tmp
+000233c0: 6d61 7064 6174 6129 0a0a 2020 2020 2020  mapdata)..      
+000233d0: 2020 7265 7475 726e 206d 7969 6e74 6572    return myinter
+000233e0: 0a0a 2020 2020 2320 7665 7273 696f 6e20  ..    # version 
+000233f0: 3120 6279 2075 7369 6e67 2054 454d 5079  1 by using TEMPy
+00023400: 0a20 2020 2064 6566 205f 5f69 6e74 6572  .    def __inter
+00023410: 7468 6972 6428 7365 6c66 293a 0a20 2020  third(self):.   
+00023420: 2020 2020 2022 2222 0a0a 2020 2020 2020       """..      
+00023430: 2020 2020 2020 496e 7465 7270 6f6c 6174        Interpolat
+00023440: 6520 6465 6e73 6974 7920 7661 6c75 6520  e density value 
+00023450: 6f66 206f 6e65 2061 746f 6d2c 2069 6620  of one atom, if 
+00023460: 696e 6469 6365 7320 6172 6520 6f6e 2074  indices are on t
+00023470: 6865 2073 616d 6520 706c 616e 6520 7573  he same plane us
+00023480: 6520 6e65 6172 6573 7420 6d65 7468 6f64  e nearest method
+00023490: 0a20 2020 2020 2020 2020 2020 206f 7468  .            oth
+000234a0: 6572 7769 7365 2075 7365 206c 696e 6561  erwise use linea
+000234b0: 720a 0a20 2020 2020 2020 203a 7061 7261  r..        :para
+000234c0: 6d20 6d61 703a 2054 454d 5079 206d 6170  m map: TEMPy map
+000234d0: 2069 6e73 7461 6e63 650a 2020 2020 2020   instance.      
+000234e0: 2020 3a70 6172 616d 206d 6f64 656c 3a20    :param model: 
+000234f0: 5374 7275 6374 7572 6520 696e 7374 616e  Structure instan
+00023500: 6365 2066 726f 6d20 5445 4d50 7920 7061  ce from TEMPy pa
+00023510: 636b 6167 6520 6d6d 6369 6620 7061 7273  ckage mmcif pars
+00023520: 6572 0a20 2020 2020 2020 203a 7265 7475  er.        :retu
+00023530: 726e 3a20 4c69 7374 2063 6f6e 7461 696e  rn: List contain
+00023540: 7320 616c 6c20 6465 6e73 6974 7920 696e  s all density in
+00023550: 7465 7270 6f6c 6174 696f 6e73 206f 6620  terpolations of 
+00023560: 6174 6f6d 7320 6672 6f6d 206d 6f64 656c  atoms from model
+00023570: 0a0a 2020 2020 2020 2020 2222 220a 0a20  ..        """.. 
+00023580: 2020 2020 2020 206d 7969 6e74 6572 203d         myinter =
+00023590: 2073 656c 662e 5f5f 696e 7465 7250 6f6c   self.__interPol
+000235a0: 6174 696f 6e28 290a 2020 2020 2020 2020  ation().        
+000235b0: 2320 4d69 6768 7420 6861 7669 6e67 206d  # Might having m
+000235c0: 756c 7470 6c65 206d 6f64 656c 730a 2020  ultple models.  
+000235d0: 2020 2020 2020 6d6f 6465 6c73 203d 205b        models = [
+000235e0: 5d0a 2020 2020 2020 2020 6966 2069 7369  ].        if isi
+000235f0: 6e73 7461 6e63 6528 7365 6c66 2e6d 6f64  nstance(self.mod
+00023600: 656c 732c 206c 6973 7429 3a0a 2020 2020  els, list):.    
+00023610: 2020 2020 2020 2020 6d6f 6465 6c73 203d          models =
+00023620: 2073 656c 662e 6d6f 6465 6c73 0a20 2020   self.models.   
+00023630: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00023640: 2020 2020 2020 206d 6f64 656c 732e 6170         models.ap
+00023650: 7065 6e64 2873 656c 662e 6d6f 6465 6c73  pend(self.models
+00023660: 290a 2020 2020 2020 2020 6d61 7020 3d20  ).        map = 
+00023670: 7365 6c66 2e6d 6170 0a20 2020 2020 2020  self.map.       
+00023680: 2063 6f6e 746f 7572 203d 2073 656c 662e   contour = self.
+00023690: 636c 0a20 2020 2020 2020 2023 2052 616e  cl.        # Ran
+000236a0: 6765 206f 6620 636f 6e74 6f75 7220 6c65  ge of contour le
+000236b0: 7665 6c20 7661 6c75 6573 2066 6f72 2073  vel values for s
+000236c0: 6361 6c65 7220 6261 720a 2020 2020 2020  caler bar.      
+000236d0: 2020 2320 546f 646f 3a20 5269 6768 7420    # Todo: Right 
+000236e0: 6e6f 7720 7769 7468 2066 6978 6564 206e  now with fixed n
+000236f0: 756d 6265 7220 6f66 2070 6f69 6e74 7320  umber of points 
+00023700: 6f6e 2062 6f74 6820 7369 6465 7320 6f66  on both sides of
+00023710: 2074 6865 2072 6563 6f6d 6d65 6e64 6564   the recommended
+00023720: 2063 6f6e 746f 7572 206c 6576 656c 2c20   contour level, 
+00023730: 636f 756c 6420 696d 7072 6f76 6520 746f  could improve to
+00023740: 0a20 2020 2020 2020 2023 2054 6f64 6f3a  .        # Todo:
+00023750: 2067 656e 6572 6174 6520 6120 7265 6173   generate a reas
+00023760: 6f6e 6162 6c65 2072 616e 6765 2073 7572  onable range sur
+00023770: 726f 756e 6420 7468 6520 7265 636f 6d6d  round the recomm
+00023780: 656e 6465 6420 636f 6e74 6f75 7220 6c65  ended contour le
+00023790: 7665 6c0a 2020 2020 2020 2020 2320 5365  vel.        # Se
+000237a0: 7474 696e 6720 6120 736d 6172 7465 7220  tting a smarter 
+000237b0: 7261 6e67 6520 6265 7477 6565 6e20 2863  range between (c
+000237c0: 6f6e 746f 7572 2d73 6967 2c63 6f6e 746f  ontour-sig,conto
+000237d0: 7572 2c20 636f 756e 746f 7572 202b 2073  ur, countour + s
+000237e0: 6967 290a 2020 2020 2020 2020 6d61 7073  ig).        maps
+000237f0: 6967 203d 206d 6170 2e73 7464 2829 0a20  ig = map.std(). 
+00023800: 2020 2020 2020 2023 2063 6f6e 746f 7572         # contour
+00023810: 7261 6e67 6520 3d20 6e70 2e63 6f6e 6361  range = np.conca
+00023820: 7465 6e61 7465 2828 6e70 2e6c 696e 7370  tenate((np.linsp
+00023830: 6163 6528 636f 6e74 6f75 7220 2d20 666c  ace(contour - fl
+00023840: 6f61 7428 312e 3520 2a20 6d61 7073 6967  oat(1.5 * mapsig
+00023850: 292c 2063 6f6e 746f 7572 2c20 332c 2065  ), contour, 3, e
+00023860: 6e64 706f 696e 743d 4661 6c73 6529 2c0a  ndpoint=False),.
+00023870: 2020 2020 2020 2020 2320 2020 2020 2020          #       
+00023880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023890: 2020 2020 2020 2020 206e 702e 6c69 6e73           np.lins
+000238a0: 7061 6365 2863 6f6e 746f 7572 2c20 636f  pace(contour, co
+000238b0: 6e74 6f75 7220 2b20 666c 6f61 7428 312e  ntour + float(1.
+000238c0: 3520 2a20 6d61 7073 6967 292c 2034 2929  5 * mapsig), 4))
+000238d0: 2c20 6178 6973 3d4e 6f6e 6529 0a20 2020  , axis=None).   
+000238e0: 2020 2020 2023 2063 6f6e 746f 7572 7261       # contourra
+000238f0: 6e67 6520 3d20 6e70 2e63 6f6e 6361 7465  nge = np.concate
+00023900: 6e61 7465 2828 6e70 2e6c 696e 7370 6163  nate((np.linspac
+00023910: 6528 6d61 702e 6d69 6e28 292c 2063 6f6e  e(map.min(), con
+00023920: 746f 7572 2c20 332c 2065 6e64 706f 696e  tour, 3, endpoin
+00023930: 743d 4661 6c73 6529 2c20 6e70 2e6c 696e  t=False), np.lin
+00023940: 7370 6163 6528 636f 6e74 6f75 722c 206d  space(contour, m
+00023950: 6170 2e6d 6178 2829 2c20 3329 292c 2061  ap.max(), 3)), a
+00023960: 7869 733d 4e6f 6e65 290a 2020 2020 2020  xis=None).      
+00023970: 2020 2320 5768 656e 2072 756e 6e69 6e67    # When running
+00023980: 2066 6f72 2045 4d44 4220 6b65 6570 2069   for EMDB keep i
+00023990: 7420 6173 2061 2066 6c65 7869 626c 6520  t as a flexible 
+000239a0: 7261 6e67 6520 666f 7220 6f6e 6564 6570  range for onedep
+000239b0: 206f 7220 6f74 6865 7220 7573 6572 7320   or other users 
+000239c0: 6f6e 6c79 2072 756e 2069 7420 6f6e 6365  only run it once
+000239d0: 2066 6f72 2072 6563 6f6d 6d65 6e64 6564   for recommended
+000239e0: 0a20 2020 2020 2020 2023 2063 6f6e 746f  .        # conto
+000239f0: 7572 206c 6576 656c 3a0a 0a20 2020 2020  ur level:..     
+00023a00: 2020 2023 2069 6620 7365 6c66 2e65 6d64     # if self.emd
+00023a10: 6964 3a0a 2020 2020 2020 2020 2320 2020  id:.        #   
+00023a20: 2020 636f 6e74 6f75 7272 616e 6765 203d    contourrange =
+00023a30: 206e 702e 636f 6e63 6174 656e 6174 6528   np.concatenate(
+00023a40: 286e 702e 6c69 6e73 7061 6365 2863 6f6e  (np.linspace(con
+00023a50: 746f 7572 202d 2066 6c6f 6174 2831 2e35  tour - float(1.5
+00023a60: 202a 206d 6170 7369 6729 2c20 636f 6e74   * mapsig), cont
+00023a70: 6f75 722c 2033 2c20 656e 6470 6f69 6e74  our, 3, endpoint
+00023a80: 3d46 616c 7365 292c 0a20 2020 2020 2020  =False),.       
+00023a90: 2023 2020 2020 2020 2020 2020 2020 2020   #              
+00023aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023ab0: 2020 2020 2020 6e70 2e6c 696e 7370 6163        np.linspac
+00023ac0: 6528 636f 6e74 6f75 722c 2063 6f6e 746f  e(contour, conto
+00023ad0: 7572 202b 2066 6c6f 6174 2831 2e35 202a  ur + float(1.5 *
+00023ae0: 206d 6170 7369 6729 2c20 3429 292c 2061   mapsig), 4)), a
+00023af0: 7869 733d 4e6f 6e65 290a 2020 2020 2020  xis=None).      
+00023b00: 2020 2320 656c 7365 3a0a 2020 2020 2020    # else:.      
+00023b10: 2020 2320 2020 2020 636f 6e74 6f75 7272    #     contourr
+00023b20: 616e 6765 203d 206e 702e 6173 6172 7261  ange = np.asarra
+00023b30: 7928 5b63 6f6e 746f 7572 5d29 0a0a 2020  y([contour])..  
+00023b40: 2020 2020 2020 636f 6e74 6f75 7272 616e        contourran
+00023b50: 6765 203d 206e 702e 6173 6172 7261 7928  ge = np.asarray(
+00023b60: 5b63 6f6e 746f 7572 5d29 0a20 2020 2020  [contour]).     
+00023b70: 2020 2072 6573 756c 7420 3d20 7b7d 0a20     result = {}. 
+00023b80: 2020 2020 2020 2066 6f72 206d 6f64 656c         for model
+00023b90: 2069 6e20 6d6f 6465 6c73 3a0a 2020 2020   in models:.    
+00023ba0: 2020 2020 2020 2020 616c 6c63 6f6e 746f          allconto
+00023bb0: 7572 7364 6963 7420 3d20 4f72 6465 7265  ursdict = Ordere
+00023bc0: 6444 6963 7428 290a 2020 2020 2020 2020  dDict().        
+00023bd0: 2020 2020 6174 6f6d 6f75 7473 6964 656e      atomoutsiden
+00023be0: 756d 203d 2030 0a20 2020 2020 2020 2020  um = 0.         
+00023bf0: 2020 206d 6f64 656c 6e61 6d65 203d 206d     modelname = m
+00023c00: 6f64 656c 2e66 696c 656e 616d 652e 7370  odel.filename.sp
+00023c10: 6c69 7428 272f 2729 5b2d 315d 0a0a 2020  lit('/')[-1]..  
+00023c20: 2020 2020 2020 2020 2020 6174 6f6d 636f            atomco
+00023c30: 756e 7420 3d20 300a 2020 2020 2020 2020  unt = 0.        
+00023c40: 2020 2020 6368 6169 6e63 6f75 6e74 203d      chaincount =
+00023c50: 2031 0a20 2020 2020 2020 2020 2020 2063   1.            c
+00023c60: 6861 696e 6174 6f6d 7320 3d20 300a 2020  hainatoms = 0.  
+00023c70: 2020 2020 2020 2020 2020 6368 6169 6e61            chaina
+00023c80: 6973 636f 7265 203d 207b 7d0a 2020 2020  iscore = {}.    
+00023c90: 2020 2020 2020 2020 6368 6169 6e61 6920          chainai 
+00023ca0: 3d20 302e 0a0a 2020 2020 2020 2020 2020  = 0...          
+00023cb0: 2020 666f 7220 636f 6e74 6f75 7220 696e    for contour in
+00023cc0: 2063 6f6e 746f 7572 7261 6e67 653a 0a20   contourrange:. 
+00023cd0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00023ce0: 6e74 6572 706f 6c61 7469 6f6e 7320 3d20  nterpolations = 
+00023cf0: 5b5d 0a20 2020 2020 2020 2020 2020 2020  [].             
+00023d00: 2020 2061 6c6c 6b65 7973 203d 205b 5d0a     allkeys = [].
+00023d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023d20: 616c 6c76 616c 7565 7320 3d20 5b5d 0a20  allvalues = []. 
+00023d30: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00023d40: 7265 7265 7369 6420 3d20 300a 2020 2020  reresid = 0.    
+00023d50: 2020 2020 2020 2020 2020 2020 7072 6563              prec
+00023d60: 6861 696e 203d 2027 270a 2020 2020 2020  hain = ''.      
+00023d70: 2020 2020 2020 2020 2020 6169 7072 6563            aiprec
+00023d80: 6861 696e 203d 2027 270a 2020 2020 2020  hain = ''.      
+00023d90: 2020 2020 2020 2020 2020 7072 6572 6573            preres
+00023da0: 203d 2027 270a 2020 2020 2020 2020 2020   = ''.          
+00023db0: 2020 2020 2020 7265 7363 6f75 6e74 203d        rescount =
+00023dc0: 2030 0a20 2020 2020 2020 2020 2020 2020   0.             
+00023dd0: 2020 2073 756d 6174 6f6d 696e 7465 7262     sumatominterb
+00023de0: 696e 203d 2030 0a20 2020 2020 2020 2020  in = 0.         
+00023df0: 2020 2020 2020 2066 6f72 2061 746f 6d20         for atom 
+00023e00: 696e 206d 6f64 656c 3a0a 2020 2020 2020  in model:.      
+00023e10: 2020 2020 2020 2020 2020 2020 2020 6174                at
+00023e20: 6f6d 636f 756e 7420 2b3d 2031 0a20 2020  omcount += 1.   
+00023e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023e40: 2023 2069 6620 2748 2720 6e6f 7420 696e   # if 'H' not in
+00023e50: 2061 746f 6d2e 6174 6f6d 5f6e 616d 653a   atom.atom_name:
+00023e60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023e70: 2020 2020 206f 6e65 636f 6f72 203d 205b       onecoor = [
+00023e80: 6174 6f6d 2e78 2c20 6174 6f6d 2e79 2c20  atom.x, atom.y, 
+00023e90: 6174 6f6d 2e7a 5d0a 2020 2020 2020 2020  atom.z].        
+00023ea0: 2020 2020 2020 2020 2020 2020 6f6e 6569              onei
+00023eb0: 6e64 6578 203d 2073 656c 662e 5f5f 6765  ndex = self.__ge
+00023ec0: 7469 6e64 6963 6573 286f 6e65 636f 6f72  tindices(onecoor
+00023ed0: 295b 315d 0a20 2020 2020 2020 2020 2020  )[1].           
+00023ee0: 2020 2020 2020 2020 2069 6620 6f6e 6569           if onei
+00023ef0: 6e64 6578 5b30 5d20 3e20 6d61 702e 785f  ndex[0] > map.x_
+00023f00: 7369 7a65 2829 202d 2031 206f 7220 6f6e  size() - 1 or on
+00023f10: 6569 6e64 6578 5b30 5d20 3c20 3020 6f72  eindex[0] < 0 or
+00023f20: 205c 0a20 2020 2020 2020 2020 2020 2020   \.             
+00023f30: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00023f40: 6e65 696e 6465 785b 315d 203e 206d 6170  neindex[1] > map
+00023f50: 2e79 5f73 697a 6528 2920 2d20 3120 6f72  .y_size() - 1 or
+00023f60: 206f 6e65 696e 6465 785b 315d 203c 2030   oneindex[1] < 0
+00023f70: 206f 7220 5c0a 2020 2020 2020 2020 2020   or \.          
+00023f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023f90: 2020 6f6e 6569 6e64 6578 5b32 5d20 3e20    oneindex[2] > 
+00023fa0: 6d61 702e 7a5f 7369 7a65 2829 202d 2031  map.z_size() - 1
+00023fb0: 206f 7220 6f6e 6569 6e64 6578 5b32 5d20   or oneindex[2] 
+00023fc0: 3c20 303a 0a20 2020 2020 2020 2020 2020  < 0:.           
+00023fd0: 2020 2020 2020 2020 2020 2020 2063 7572               cur
+00023fe0: 696e 7465 7270 6f6c 6174 696f 6e20 3d20  interpolation = 
+00023ff0: 6d61 702e 6d69 6e28 290a 2020 2020 2020  map.min().      
+00024000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024010: 2020 6174 6f6d 6f75 7473 6964 656e 756d    atomoutsidenum
+00024020: 202b 3d20 310a 2020 2020 2020 2020 2020   += 1.          
+00024030: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00024040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024050: 2020 2020 2020 2020 6375 7269 6e74 6572          curinter
+00024060: 706f 6c61 7469 6f6e 203d 206d 7969 6e74  polation = myint
+00024070: 6572 286f 6e65 696e 6465 7829 2e74 6f6c  er(oneindex).tol
+00024080: 6973 7428 295b 305d 0a20 2020 2020 2020  ist()[0].       
+00024090: 2020 2020 2020 2020 2020 2020 2069 6e74               int
+000240a0: 6572 706f 6c61 7469 6f6e 732e 6170 7065  erpolations.appe
+000240b0: 6e64 2863 7572 696e 7465 7270 6f6c 6174  nd(curinterpolat
+000240c0: 696f 6e29 0a20 2020 2020 2020 2020 2020  ion).           
+000240d0: 2020 2020 2020 2020 2061 746f 6d69 6e74           atomint
+000240e0: 6572 6269 6e20 3d20 3120 6966 2063 7572  erbin = 1 if cur
+000240f0: 696e 7465 7270 6f6c 6174 696f 6e20 3e20  interpolation > 
+00024100: 636f 6e74 6f75 7220 656c 7365 2030 0a20  contour else 0. 
+00024110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024120: 2020 2069 6620 2872 6573 636f 756e 7420     if (rescount 
+00024130: 3d3d 2030 2920 6f72 2028 6174 6f6d 2e72  == 0) or (atom.r
+00024140: 6573 5f6e 6f20 3d3d 2070 7265 7265 7369  es_no == preresi
+00024150: 6420 616e 6420 6174 6f6d 2e63 6861 696e  d and atom.chain
+00024160: 203d 3d20 7072 6563 6861 696e 293a 0a20   == prechain):. 
+00024170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024180: 2020 2020 2020 2073 756d 6174 6f6d 696e         sumatomin
+00024190: 7465 7262 696e 202b 3d20 6174 6f6d 696e  terbin += atomin
+000241a0: 7465 7262 696e 0a20 2020 2020 2020 2020  terbin.         
+000241b0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000241c0: 6573 636f 756e 7420 2b3d 2031 0a20 2020  escount += 1.   
+000241d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000241e0: 2020 2020 2070 7265 7265 7369 6420 3d20       preresid = 
+000241f0: 6174 6f6d 2e72 6573 5f6e 6f0a 2020 2020  atom.res_no.    
+00024200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024210: 2020 2020 7072 6563 6861 696e 203d 2061      prechain = a
+00024220: 746f 6d2e 6368 6169 6e0a 2020 2020 2020  tom.chain.      
+00024230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024240: 2020 7072 6572 6573 203d 2061 746f 6d2e    preres = atom.
+00024250: 7265 730a 0a20 2020 2020 2020 2020 2020  res..           
+00024260: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00024270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024280: 2020 2020 2020 206b 6579 7374 7220 3d20         keystr = 
+00024290: 7072 6563 6861 696e 202b 2027 3a27 202b  prechain + ':' +
+000242a0: 2073 7472 2870 7265 7265 7369 6429 202b   str(preresid) +
+000242b0: 2070 7265 7265 730a 2020 2020 2020 2020   preres.        
+000242c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000242d0: 616c 6c6b 6579 732e 6170 7065 6e64 286b  allkeys.append(k
+000242e0: 6579 7374 7229 0a20 2020 2020 2020 2020  eystr).         
+000242f0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00024300: 2076 616c 7565 203d 2066 6c6f 6174 2873   value = float(s
+00024310: 756d 6174 6f6d 696e 7465 7262 696e 292f  umatominterbin)/
+00024320: 7265 7363 6f75 6e74 0a20 2020 2020 2020  rescount.       
+00024330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024340: 2076 616c 7565 203d 2066 6c6f 6174 2827   value = float('
+00024350: 252e 3466 2720 2520 726f 756e 6428 2866  %.4f' % round((f
+00024360: 6c6f 6174 2873 756d 6174 6f6d 696e 7465  loat(sumatominte
+00024370: 7262 696e 2920 2f20 7265 7363 6f75 6e74  rbin) / rescount
+00024380: 292c 2034 2929 0a20 2020 2020 2020 2020  ), 4)).         
+00024390: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+000243a0: 6c6c 7661 6c75 6573 2e61 7070 656e 6428  llvalues.append(
+000243b0: 7661 6c75 6529 0a20 2020 2020 2020 2020  value).         
+000243c0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000243d0: 756d 6174 6f6d 696e 7465 7262 696e 203d  umatominterbin =
+000243e0: 2061 746f 6d69 6e74 6572 6269 6e0a 2020   atominterbin.  
+000243f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024400: 2020 2020 2020 7072 6572 6573 6964 203d        preresid =
+00024410: 2061 746f 6d2e 7265 735f 6e6f 0a20 2020   atom.res_no.   
+00024420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024430: 2020 2020 2070 7265 6368 6169 6e20 3d20       prechain = 
+00024440: 6174 6f6d 2e63 6861 696e 0a20 2020 2020  atom.chain.     
+00024450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024460: 2020 2072 6573 636f 756e 7420 3d20 310a     rescount = 1.
+00024470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00024480: 2020 2020 2023 2041 6464 2074 6865 2063       # Add the c
+00024490: 6861 696e 2062 6173 6564 2061 746f 6d20  hain based atom 
+000244a0: 696e 636c 7573 696f 6e20 7363 6f72 650a  inclusion score.
+000244b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000244c0: 2020 2020 6966 2028 6174 6f6d 636f 756e      if (atomcoun
+000244d0: 7420 3d3d 2031 2920 6f72 2028 6174 6f6d  t == 1) or (atom
+000244e0: 2e63 6861 696e 203d 3d20 6169 7072 6563  .chain == aiprec
+000244f0: 6861 696e 293a 0a20 2020 2020 2020 2020  hain):.         
+00024500: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00024510: 6861 696e 6174 6f6d 7320 2b3d 2031 0a20  hainatoms += 1. 
+00024520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024530: 2020 2020 2020 2061 6970 7265 6368 6169         aiprechai
+00024540: 6e20 3d20 6174 6f6d 2e63 6861 696e 0a20  n = atom.chain. 
+00024550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024560: 2020 2020 2020 2063 6861 696e 6169 202b         chainai +
+00024570: 3d20 6174 6f6d 696e 7465 7262 696e 0a20  = atominterbin. 
+00024580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024590: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000245a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000245b0: 2061 6976 616c 7565 203d 2072 6f75 6e64   aivalue = round
+000245c0: 2866 6c6f 6174 2863 6861 696e 6169 2920  (float(chainai) 
+000245d0: 2f20 6368 6169 6e61 746f 6d73 2c20 3329  / chainatoms, 3)
+000245e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000245f0: 2020 2020 2020 2020 2061 6963 6f6c 6f72           aicolor
+00024600: 203d 2073 656c 662e 5f5f 666c 6f61 746f   = self.__floato
+00024610: 6865 7828 5b61 6976 616c 7565 5d29 5b30  hex([aivalue])[0
+00024620: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00024630: 2020 2020 2020 2020 2020 2320 6368 6169            # chai
+00024640: 6e61 6973 636f 7265 5b70 7265 6368 6169  naiscore[prechai
+00024650: 6e5d 203d 207b 2776 616c 7565 273a 2061  n] = {'value': a
+00024660: 6976 616c 7565 2c20 2763 6f6c 6f72 273a  ivalue, 'color':
+00024670: 2061 6963 6f6c 6f72 7d0a 2020 2020 2020   aicolor}.      
+00024680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024690: 2020 2320 2854 6f64 6f29 2046 6f72 2063    # (Todo) For c
+000246a0: 6861 696e 2077 6869 6368 2068 6176 6520  hain which have 
+000246b0: 7468 6520 7361 6d65 2063 6861 696e 2069  the same chain i
+000246c0: 6420 6e6f 6e2d 7072 6f74 6569 6e20 7061  d non-protein pa
+000246d0: 7274 206e 6f74 2069 6e63 6c75 6465 6420  rt not included 
+000246e0: 7965 7420 6573 7065 6369 616c 6c79 0a20  yet especially. 
+000246f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024700: 2020 2020 2020 2023 206c 6967 616e 6420         # ligand 
+00024710: 6269 6e64 2074 6f20 7468 6520 7072 6f74  bind to the prot
+00024720: 6569 6e20 6c69 6761 6e64 2068 6173 2074  ein ligand has t
+00024730: 6865 2073 616d 6520 6368 6169 6e20 6964  he same chain id
+00024740: 2061 7320 7468 6520 7072 6f74 6569 6e2c   as the protein,
+00024750: 2074 6865 6e20 686f 7720 746f 2061 7665   then how to ave
+00024760: 7267 650a 2020 2020 2020 2020 2020 2020  rge.            
+00024770: 2020 2020 2020 2020 2020 2020 2320 7468              # th
+00024780: 6520 6c69 6761 6e64 2061 6e64 2074 6865  e ligand and the
+00024790: 2070 726f 7465 696e 2074 6f67 6574 6865   protein togethe
+000247a0: 7220 6e65 6564 2074 6f20 7461 6b65 2074  r need to take t
+000247b0: 6865 206e 756d 6265 7273 2069 6e74 6f20  he numbers into 
+000247c0: 6163 636f 756e 7420 7768 6963 6820 616c  account which al
+000247d0: 736f 206d 6561 6e73 0a20 2020 2020 2020  so means.       
+000247e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000247f0: 2023 206e 6565 6420 746f 2061 6464 2061   # need to add a
+00024800: 6e6f 7468 6572 2076 616c 7565 2069 6e20  nother value in 
+00024810: 7468 6520 6469 6374 6f6e 6172 790a 2020  the dictonary.  
+00024820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024830: 2020 2020 2020 2320 4e65 6564 2074 6f20        # Need to 
+00024840: 7072 6f70 6572 6c79 2063 616e 6375 6c61  properly cancula
+00024850: 7465 6420 7468 6520 6176 6572 6167 6520  ted the average 
+00024860: 6f66 206f 6e65 2063 6861 696e 0a20 2020  of one chain.   
+00024870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024880: 2020 2020 2069 6620 6169 7072 6563 6861       if aiprecha
+00024890: 696e 2069 6e20 6368 6169 6e61 6973 636f  in in chainaisco
+000248a0: 7265 2e6b 6579 7328 293a 0a20 2020 2020  re.keys():.     
+000248b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000248c0: 2020 2020 2020 2023 2063 6861 696e 6169         # chainai
+000248d0: 7363 6f72 655b 6169 7072 6563 6861 696e  score[aiprechain
+000248e0: 202b 2027 5f27 202b 2073 7472 2861 6976   + '_' + str(aiv
+000248f0: 616c 7565 295d 203d 207b 2776 616c 7565  alue)] = {'value
+00024900: 273a 2061 6976 616c 7565 2c20 2763 6f6c  ': aivalue, 'col
+00024910: 6f72 273a 2061 6963 6f6c 6f72 7d0a 2020  or': aicolor}.  
+00024920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024930: 2020 2020 2020 2020 2020 7061 7373 0a20            pass. 
+00024940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024950: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00024960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024970: 2020 2020 2020 2020 2063 6861 696e 6169           chainai
+00024980: 7363 6f72 655b 6169 7072 6563 6861 696e  score[aiprechain
+00024990: 5d20 3d20 7b27 7661 6c75 6527 3a20 6169  ] = {'value': ai
+000249a0: 7661 6c75 652c 2027 636f 6c6f 7227 3a20  value, 'color': 
+000249b0: 6169 636f 6c6f 722c 2027 6e75 6d62 6572  aicolor, 'number
+000249c0: 4f66 4174 6f6d 7327 3a20 6368 6169 6e61  OfAtoms': chaina
+000249d0: 746f 6d73 7d0a 0a20 2020 2020 2020 2020  toms}..         
+000249e0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000249f0: 6861 696e 6174 6f6d 7320 3d20 310a 2020  hainatoms = 1.  
+00024a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024a10: 2020 2020 2020 6368 6169 6e63 6f75 6e74        chaincount
+00024a20: 202b 3d20 310a 2020 2020 2020 2020 2020   += 1.          
+00024a30: 2020 2020 2020 2020 2020 2020 2020 6368                ch
+00024a40: 6169 6e61 6920 3d20 6174 6f6d 696e 7465  ainai = atominte
+00024a50: 7262 696e 0a20 2020 2020 2020 2020 2020  rbin.           
+00024a60: 2020 2020 2020 2020 2020 2020 2061 6970               aip
+00024a70: 7265 6368 6169 6e20 3d20 6174 6f6d 2e63  rechain = atom.c
+00024a80: 6861 696e 0a0a 2020 2020 2020 2020 2020  hain..          
+00024a90: 2020 2020 2020 6169 7661 6c75 6520 3d20        aivalue = 
+00024aa0: 726f 756e 6428 666c 6f61 7428 6368 6169  round(float(chai
+00024ab0: 6e61 6929 202f 2063 6861 696e 6174 6f6d  nai) / chainatom
+00024ac0: 732c 2033 290a 2020 2020 2020 2020 2020  s, 3).          
+00024ad0: 2020 2020 2020 6169 636f 6c6f 7220 3d20        aicolor = 
+00024ae0: 7365 6c66 2e5f 5f66 6c6f 6174 6f68 6578  self.__floatohex
+00024af0: 285b 6169 7661 6c75 655d 295b 305d 0a20  ([aivalue])[0]. 
+00024b00: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00024b10: 6620 6169 7072 6563 6861 696e 2069 6e20  f aiprechain in 
+00024b20: 6368 6169 6e61 6973 636f 7265 2e6b 6579  chainaiscore.key
+00024b30: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+00024b40: 2020 2020 2020 2020 2023 2063 6861 696e           # chain
+00024b50: 6169 7363 6f72 655b 6169 7072 6563 6861  aiscore[aiprecha
+00024b60: 696e 202b 2027 5f27 202b 2073 7472 2861  in + '_' + str(a
+00024b70: 6976 616c 7565 295d 203d 207b 2776 616c  ivalue)] = {'val
+00024b80: 7565 273a 2061 6976 616c 7565 2c20 2763  ue': aivalue, 'c
+00024b90: 6f6c 6f72 273a 2061 6963 6f6c 6f72 7d0a  olor': aicolor}.
+00024ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024bb0: 2020 2020 7061 7373 0a20 2020 2020 2020      pass.       
+00024bc0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00024bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024be0: 2020 2063 6861 696e 6169 7363 6f72 655b     chainaiscore[
+00024bf0: 6169 7072 6563 6861 696e 5d20 3d20 7b27  aiprechain] = {'
+00024c00: 7661 6c75 6527 3a20 6169 7661 6c75 652c  value': aivalue,
+00024c10: 2027 636f 6c6f 7227 3a20 6169 636f 6c6f   'color': aicolo
+00024c20: 722c 2027 6e75 6d62 6572 4f66 4174 6f6d  r, 'numberOfAtom
+00024c30: 7327 3a20 6368 6169 6e61 746f 6d73 7d0a  s': chainatoms}.
+00024c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024c50: 6b65 7973 7472 203d 2061 6970 7265 6368  keystr = aiprech
+00024c60: 6169 6e20 2b20 273a 2720 2b20 7374 7228  ain + ':' + str(
+00024c70: 7072 6572 6573 6964 2920 2b20 7072 6572  preresid) + prer
+00024c80: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
+00024c90: 2020 2061 6c6c 6b65 7973 2e61 7070 656e     allkeys.appen
+00024ca0: 6428 6b65 7973 7472 290a 2020 2020 2020  d(keystr).      
+00024cb0: 2020 2020 2020 2020 2020 7661 6c75 6520            value 
+00024cc0: 3d20 666c 6f61 7428 2725 2e34 6627 2025  = float('%.4f' %
+00024cd0: 2072 6f75 6e64 2828 666c 6f61 7428 7375   round((float(su
+00024ce0: 6d61 746f 6d69 6e74 6572 6269 6e29 202f  matominterbin) /
+00024cf0: 2072 6573 636f 756e 7429 2c20 3429 290a   rescount), 4)).
+00024d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024d10: 616c 6c76 616c 7565 732e 6170 7065 6e64  allvalues.append
+00024d20: 2876 616c 7565 290a 2020 2020 2020 2020  (value).        
+00024d30: 2020 2020 2020 2020 616c 6c63 6f6e 746f          allconto
+00024d40: 7572 7364 6963 745b 7374 7228 636f 6e74  ursdict[str(cont
+00024d50: 6f75 7229 5d20 3d20 2861 6c6c 6b65 7973  our)] = (allkeys
+00024d60: 2c20 616c 6c76 616c 7565 7329 0a20 2020  , allvalues).   
+00024d70: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+00024d80: 6e74 2827 4d6f 6465 6c3a 2025 7320 6174  nt('Model: %s at
+00024d90: 2063 6f6e 746f 7572 206c 6576 656c 2025   contour level %
+00024da0: 7320 6861 7320 2573 2061 746f 6d73 2073  s has %s atoms s
+00024db0: 7469 636b 206f 7574 206f 6620 7468 6520  tick out of the 
+00024dc0: 6465 6e73 6974 792e 2720 2520 286d 6f64  density.' % (mod
+00024dd0: 656c 6e61 6d65 2c20 636f 6e74 6f75 722c  elname, contour,
+00024de0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00024df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024e40: 2020 6174 6f6d 6f75 7473 6964 656e 756d    atomoutsidenum
+00024e50: 2929 0a0a 2020 2020 2020 2020 2020 2020  ))..            
+00024e60: 2320 7265 7375 6c74 5b6d 6f64 656c 6e61  # result[modelna
+00024e70: 6d65 5d20 3d20 2869 6e74 6572 706f 6c61  me] = (interpola
+00024e80: 7469 6f6e 732c 2061 6c6c 6b65 7973 2c20  tions, allkeys, 
+00024e90: 616c 6c76 616c 7565 7329 0a20 2020 2020  allvalues).     
+00024ea0: 2020 2020 2020 2023 2072 6573 756c 743a         # result:
+00024eb0: 207b 6d6f 6465 6c6e 616d 6520 2331 3a20   {modelname #1: 
+00024ec0: 2869 6e74 6572 706f 6c61 7469 6f6e 7320  (interpolations 
+00024ed0: 2331 2c20 7b63 6f6e 746f 7572 313a 2028  #1, {contour1: (
+00024ee0: 616c 6c6b 6579 732c 2061 6c6c 7661 6c75  allkeys, allvalu
+00024ef0: 6573 292c 2063 6f6e 746f 7572 323a 2028  es), contour2: (
+00024f00: 616c 6c6b 6579 732c 2061 6c6c 7661 6c75  allkeys, allvalu
+00024f10: 6573 290a 2020 2020 2020 2020 2020 2020  es).            
+00024f20: 2320 2e2e 2e7d 292c 206d 6f64 656c 6e61  # ...}), modelna
+00024f30: 6d65 2023 323a 2028 696e 7465 7270 6f6c  me #2: (interpol
+00024f40: 6174 696f 6e73 2023 322c 207b 636f 6e74  ations #2, {cont
+00024f50: 6f75 7231 3a20 2861 6c6c 6b65 7973 2c20  our1: (allkeys, 
+00024f60: 616c 6c76 616c 7565 7329 2c2e 2e2e 7d29  allvalues),...})
+00024f70: 2c2e 2e2e 7d0a 2020 2020 2020 2020 2020  ,...}.          
+00024f80: 2020 7265 7375 6c74 5b6d 6f64 656c 6e61    result[modelna
+00024f90: 6d65 5d20 3d20 2869 6e74 6572 706f 6c61  me] = (interpola
+00024fa0: 7469 6f6e 732c 2061 6c6c 636f 6e74 6f75  tions, allcontou
+00024fb0: 7273 6469 6374 2c20 6368 6169 6e61 6973  rsdict, chainais
+00024fc0: 636f 7265 2c20 6174 6f6d 6f75 7473 6964  core, atomoutsid
+00024fd0: 656e 756d 290a 0a20 2020 2020 2020 2072  enum)..        r
+00024fe0: 6574 7572 6e20 7265 7375 6c74 0a0a 2020  eturn result..  
+00024ff0: 2020 2320 7665 7273 696f 6e20 3220 7769    # version 2 wi
+00025000: 7468 6f75 7420 7573 696e 6720 5445 4d50  thout using TEMP
+00025010: 7920 666f 7220 6d6f 6465 6c20 6c6f 6164  y for model load
+00025020: 696e 6720 7768 6963 6820 6973 2077 6f72  ing which is wor
+00025030: 6b69 6e67 2062 7574 206e 6f74 206f 7074  king but not opt
+00025040: 696d 616c 2066 6f72 2075 7369 6e67 2062  imal for using b
+00025050: 696f 7079 7468 6f6e 0a20 2020 2064 6566  iopython.    def
+00025060: 205f 5f6e 6577 696e 7465 7274 6869 7264   __newinterthird
+00025070: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00025080: 2222 220a 0a20 2020 2020 2020 2020 2020  """..           
+00025090: 2049 6e74 6572 706f 6c61 7465 2064 656e   Interpolate den
+000250a0: 7369 7479 2076 616c 7565 206f 6620 6f6e  sity value of on
+000250b0: 6520 6174 6f6d 2c20 6966 2069 6e64 6963  e atom, if indic
+000250c0: 6573 2061 7265 206f 6e20 7468 6520 7361  es are on the sa
+000250d0: 6d65 2070 6c61 6e65 2075 7365 206e 6561  me plane use nea
+000250e0: 7265 7374 206d 6574 686f 640a 2020 2020  rest method.    
+000250f0: 2020 2020 2020 2020 6f74 6865 7277 6973          otherwis
+00025100: 6520 7573 6520 6c69 6e65 6172 0a0a 2020  e use linear..  
+00025110: 2020 2020 2020 3a70 6172 616d 206d 6170        :param map
+00025120: 3a20 5445 4d50 7920 6d61 7020 696e 7374  : TEMPy map inst
+00025130: 616e 6365 0a20 2020 2020 2020 203a 7061  ance.        :pa
+00025140: 7261 6d20 6d6f 6465 6c3a 2053 7472 7563  ram model: Struc
+00025150: 7475 7265 2069 6e73 7461 6e63 6520 6672  ture instance fr
+00025160: 6f6d 2054 454d 5079 2070 6163 6b61 6765  om TEMPy package
+00025170: 206d 6d63 6966 2070 6172 7365 720a 2020   mmcif parser.  
+00025180: 2020 2020 2020 3a72 6574 7572 6e3a 204c        :return: L
+00025190: 6973 7420 636f 6e74 6169 6e73 2061 6c6c  ist contains all
+000251a0: 2064 656e 7369 7479 2069 6e74 6572 706f   density interpo
+000251b0: 6c61 7469 6f6e 7320 6f66 2061 746f 6d73  lations of atoms
+000251c0: 2066 726f 6d20 6d6f 6465 6c0a 0a20 2020   from model..   
+000251d0: 2020 2020 2022 2222 0a0a 2020 2020 2020       """..      
+000251e0: 2020 6d79 696e 7465 7220 3d20 7365 6c66    myinter = self
+000251f0: 2e5f 5f69 6e74 6572 506f 6c61 7469 6f6e  .__interPolation
+00025200: 2829 0a20 2020 2020 2020 2023 204d 6967  ().        # Mig
+00025210: 6874 2068 6176 696e 6720 6d75 6c74 706c  ht having multpl
+00025220: 6520 6d6f 6465 6c73 0a20 2020 2020 2020  e models.       
+00025230: 206d 6f64 656c 7320 3d20 5b5d 0a20 2020   models = [].   
+00025240: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+00025250: 6365 2873 656c 662e 6d6f 6465 6c73 2c20  ce(self.models, 
+00025260: 6c69 7374 293a 0a20 2020 2020 2020 2020  list):.         
+00025270: 2020 206d 6f64 656c 7320 3d20 7365 6c66     models = self
+00025280: 2e6d 6f64 656c 730a 2020 2020 2020 2020  .models.        
+00025290: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000252a0: 2020 6d6f 6465 6c73 2e61 7070 656e 6428    models.append(
+000252b0: 7365 6c66 2e6d 6f64 656c 7329 0a20 2020  self.models).   
+000252c0: 2020 2020 206d 6170 203d 2073 656c 662e       map = self.
+000252d0: 6d61 700a 2020 2020 2020 2020 636f 6e74  map.        cont
+000252e0: 6f75 7220 3d20 7365 6c66 2e63 6c0a 2020  our = self.cl.  
+000252f0: 2020 2020 2020 2320 5261 6e67 6520 6f66        # Range of
+00025300: 2063 6f6e 746f 7572 206c 6576 656c 2076   contour level v
+00025310: 616c 7565 7320 666f 7220 7363 616c 6572  alues for scaler
+00025320: 2062 6172 0a20 2020 2020 2020 2023 2054   bar.        # T
+00025330: 6f64 6f3a 2052 6967 6874 206e 6f77 2077  odo: Right now w
+00025340: 6974 6820 6669 7865 6420 6e75 6d62 6572  ith fixed number
+00025350: 206f 6620 706f 696e 7473 206f 6e20 626f   of points on bo
+00025360: 7468 2073 6964 6573 206f 6620 7468 6520  th sides of the 
+00025370: 7265 636f 6d6d 656e 6465 6420 636f 6e74  recommended cont
+00025380: 6f75 7220 6c65 7665 6c2c 2063 6f75 6c64  our level, could
+00025390: 2069 6d70 726f 7665 2074 6f0a 2020 2020   improve to.    
+000253a0: 2020 2020 2320 546f 646f 3a20 6765 6e65      # Todo: gene
+000253b0: 7261 7465 2061 2072 6561 736f 6e61 626c  rate a reasonabl
+000253c0: 6520 7261 6e67 6520 7375 7272 6f75 6e64  e range surround
+000253d0: 2074 6865 2072 6563 6f6d 6d65 6e64 6564   the recommended
+000253e0: 2063 6f6e 746f 7572 206c 6576 656c 0a20   contour level. 
+000253f0: 2020 2020 2020 2023 2053 6574 7469 6e67         # Setting
+00025400: 2061 2073 6d61 7274 6572 2072 616e 6765   a smarter range
+00025410: 2062 6574 7765 656e 2028 636f 6e74 6f75   between (contou
+00025420: 722d 7369 672c 636f 6e74 6f75 722c 2063  r-sig,contour, c
+00025430: 6f75 6e74 6f75 7220 2b20 7369 6729 0a20  ountour + sig). 
+00025440: 2020 2020 2020 2023 206d 6170 7369 6720         # mapsig 
+00025450: 3d20 6d61 702e 7374 6428 290a 2020 2020  = map.std().    
+00025460: 2020 2020 2320 636f 6e74 6f75 7272 616e      # contourran
+00025470: 6765 203d 206e 702e 636f 6e63 6174 656e  ge = np.concaten
+00025480: 6174 6528 286e 702e 6c69 6e73 7061 6365  ate((np.linspace
+00025490: 2863 6f6e 746f 7572 202d 2066 6c6f 6174  (contour - float
+000254a0: 2831 2e35 202a 206d 6170 7369 6729 2c20  (1.5 * mapsig), 
+000254b0: 636f 6e74 6f75 722c 2033 2c20 656e 6470  contour, 3, endp
+000254c0: 6f69 6e74 3d46 616c 7365 292c 0a20 2020  oint=False),.   
+000254d0: 2020 2020 2023 2020 2020 2020 2020 2020       #          
+000254e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000254f0: 2020 2020 2020 6e70 2e6c 696e 7370 6163        np.linspac
+00025500: 6528 636f 6e74 6f75 722c 2063 6f6e 746f  e(contour, conto
+00025510: 7572 202b 2066 6c6f 6174 2831 2e35 202a  ur + float(1.5 *
+00025520: 206d 6170 7369 6729 2c20 3429 292c 2061   mapsig), 4)), a
+00025530: 7869 733d 4e6f 6e65 290a 2020 2020 2020  xis=None).      
+00025540: 2020 2320 636f 6e74 6f75 7272 616e 6765    # contourrange
+00025550: 203d 206e 702e 636f 6e63 6174 656e 6174   = np.concatenat
+00025560: 6528 286e 702e 6c69 6e73 7061 6365 286d  e((np.linspace(m
+00025570: 6170 2e6d 696e 2829 2c20 636f 6e74 6f75  ap.min(), contou
+00025580: 722c 2033 2c20 656e 6470 6f69 6e74 3d46  r, 3, endpoint=F
+00025590: 616c 7365 292c 206e 702e 6c69 6e73 7061  alse), np.linspa
+000255a0: 6365 2863 6f6e 746f 7572 2c20 6d61 702e  ce(contour, map.
+000255b0: 6d61 7828 292c 2033 2929 2c20 6178 6973  max(), 3)), axis
+000255c0: 3d4e 6f6e 6529 0a20 2020 2020 2020 2023  =None).        #
+000255d0: 2057 6865 6e20 7275 6e6e 696e 6720 666f   When running fo
+000255e0: 7220 454d 4442 206b 6565 7020 6974 2061  r EMDB keep it a
+000255f0: 7320 6120 666c 6578 6962 6c65 2072 616e  s a flexible ran
+00025600: 6765 2066 6f72 206f 6e65 6465 7020 6f72  ge for onedep or
+00025610: 206f 7468 6572 2075 7365 7273 206f 6e6c   other users onl
+00025620: 7920 7275 6e20 6974 206f 6e63 6520 666f  y run it once fo
+00025630: 7220 7265 636f 6d6d 656e 6465 640a 2020  r recommended.  
+00025640: 2020 2020 2020 2320 636f 6e74 6f75 7220        # contour 
+00025650: 6c65 7665 6c3a 0a0a 2020 2020 2020 2020  level:..        
+00025660: 2320 6966 2073 656c 662e 656d 6469 643a  # if self.emdid:
+00025670: 0a20 2020 2020 2020 2023 2020 2020 2063  .        #     c
+00025680: 6f6e 746f 7572 7261 6e67 6520 3d20 6e70  ontourrange = np
+00025690: 2e63 6f6e 6361 7465 6e61 7465 2828 6e70  .concatenate((np
+000256a0: 2e6c 696e 7370 6163 6528 636f 6e74 6f75  .linspace(contou
+000256b0: 7220 2d20 666c 6f61 7428 312e 3520 2a20  r - float(1.5 * 
+000256c0: 6d61 7073 6967 292c 2063 6f6e 746f 7572  mapsig), contour
+000256d0: 2c20 332c 2065 6e64 706f 696e 743d 4661  , 3, endpoint=Fa
+000256e0: 6c73 6529 2c0a 2020 2020 2020 2020 2320  lse),.        # 
+000256f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025710: 2020 206e 702e 6c69 6e73 7061 6365 2863     np.linspace(c
+00025720: 6f6e 746f 7572 2c20 636f 6e74 6f75 7220  ontour, contour 
+00025730: 2b20 666c 6f61 7428 312e 3520 2a20 6d61  + float(1.5 * ma
+00025740: 7073 6967 292c 2034 2929 2c20 6178 6973  psig), 4)), axis
+00025750: 3d4e 6f6e 6529 0a20 2020 2020 2020 2023  =None).        #
+00025760: 2065 6c73 653a 0a20 2020 2020 2020 2023   else:.        #
+00025770: 2020 2020 2063 6f6e 746f 7572 7261 6e67       contourrang
+00025780: 6520 3d20 6e70 2e61 7361 7272 6179 285b  e = np.asarray([
+00025790: 636f 6e74 6f75 725d 290a 0a20 2020 2020  contour])..     
+000257a0: 2020 2063 6f6e 746f 7572 7261 6e67 6520     contourrange 
+000257b0: 3d20 6e70 2e61 7361 7272 6179 285b 636f  = np.asarray([co
+000257c0: 6e74 6f75 725d 290a 2020 2020 2020 2020  ntour]).        
+000257d0: 7265 7375 6c74 203d 207b 7d0a 2020 2020  result = {}.    
+000257e0: 2020 2020 666f 7220 6d6f 6465 6c20 696e      for model in
+000257f0: 206d 6f64 656c 733a 0a20 2020 2020 2020   models:.       
+00025800: 2020 2020 2061 6c6c 636f 6e74 6f75 7273       allcontours
+00025810: 6469 6374 203d 204f 7264 6572 6564 4469  dict = OrderedDi
+00025820: 6374 2829 0a20 2020 2020 2020 2020 2020  ct().           
+00025830: 2061 746f 6d6f 7574 7369 6465 6e75 6d20   atomoutsidenum 
+00025840: 3d20 300a 2020 2020 2020 2020 2020 2020  = 0.            
+00025850: 6d6f 6465 6c6e 616d 6520 3d20 6d6f 6465  modelname = mode
+00025860: 6c2e 6669 6c65 6e61 6d65 2e73 706c 6974  l.filename.split
+00025870: 2827 2f27 295b 2d31 5d0a 0a20 2020 2020  ('/')[-1]..     
+00025880: 2020 2020 2020 2061 746f 6d63 6f75 6e74         atomcount
+00025890: 203d 2030 0a20 2020 2020 2020 2020 2020   = 0.           
+000258a0: 2063 6861 696e 636f 756e 7420 3d20 310a   chaincount = 1.
+000258b0: 2020 2020 2020 2020 2020 2020 6368 6169              chai
+000258c0: 6e61 746f 6d73 203d 2030 0a20 2020 2020  natoms = 0.     
+000258d0: 2020 2020 2020 2063 6861 696e 6169 7363         chainaisc
+000258e0: 6f72 6520 3d20 7b7d 0a20 2020 2020 2020  ore = {}.       
+000258f0: 2020 2020 2063 6861 696e 6169 203d 2030       chainai = 0
+00025900: 2e0a 0a20 2020 2020 2020 2020 2020 2066  ...            f
+00025910: 6f72 2063 6f6e 746f 7572 2069 6e20 636f  or contour in co
+00025920: 6e74 6f75 7272 616e 6765 3a0a 2020 2020  ntourrange:.    
+00025930: 2020 2020 2020 2020 2020 2020 696e 7465              inte
+00025940: 7270 6f6c 6174 696f 6e73 203d 205b 5d0a  rpolations = [].
+00025950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025960: 616c 6c6b 6579 7320 3d20 5b5d 0a20 2020  allkeys = [].   
+00025970: 2020 2020 2020 2020 2020 2020 2061 6c6c               all
+00025980: 7661 6c75 6573 203d 205b 5d0a 2020 2020  values = [].    
+00025990: 2020 2020 2020 2020 2020 2020 7072 6572              prer
+000259a0: 6573 6964 203d 2030 0a20 2020 2020 2020  esid = 0.       
+000259b0: 2020 2020 2020 2020 2070 7265 6368 6169           prechai
+000259c0: 6e20 3d20 2727 0a20 2020 2020 2020 2020  n = ''.         
+000259d0: 2020 2020 2020 2061 6970 7265 6368 6169         aiprechai
+000259e0: 6e20 3d20 2727 0a20 2020 2020 2020 2020  n = ''.         
+000259f0: 2020 2020 2020 2070 7265 7265 7320 3d20         preres = 
+00025a00: 2727 0a20 2020 2020 2020 2020 2020 2020  ''.             
+00025a10: 2020 2072 6573 636f 756e 7420 3d20 300a     rescount = 0.
+00025a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025a30: 7375 6d61 746f 6d69 6e74 6572 6269 6e20  sumatominterbin 
+00025a40: 3d20 300a 2020 2020 2020 2020 2020 2020  = 0.            
+00025a50: 2020 2020 666f 7220 6174 6f6d 2069 6e20      for atom in 
+00025a60: 6d6f 6465 6c2e 6765 745f 6174 6f6d 7328  model.get_atoms(
+00025a70: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00025a80: 2020 2020 2020 2061 746f 6d63 6f75 6e74         atomcount
+00025a90: 202b 3d20 310a 2020 2020 2020 2020 2020   += 1.          
+00025aa0: 2020 2020 2020 2020 2020 2320 6966 2027            # if '
+00025ab0: 4827 206e 6f74 2069 6e20 6174 6f6d 2e61  H' not in atom.a
+00025ac0: 746f 6d5f 6e61 6d65 3a0a 2020 2020 2020  tom_name:.      
+00025ad0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00025ae0: 6f6e 6563 6f6f 7220 3d20 5b61 746f 6d2e  onecoor = [atom.
+00025af0: 782c 2061 746f 6d2e 792c 2061 746f 6d2e  x, atom.y, atom.
+00025b00: 7a5d 0a20 2020 2020 2020 2020 2020 2020  z].             
+00025b10: 2020 2020 2020 206f 6e65 636f 6f72 203d         onecoor =
+00025b20: 2061 746f 6d2e 636f 6f72 640a 2020 2020   atom.coord.    
+00025b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025b40: 6f6e 6569 6e64 6578 203d 2073 656c 662e  oneindex = self.
+00025b50: 5f5f 6765 7469 6e64 6963 6573 286f 6e65  __getindices(one
+00025b60: 636f 6f72 295b 315d 0a20 2020 2020 2020  coor)[1].       
+00025b70: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00025b80: 6f6e 6569 6e64 6578 5b30 5d20 3e20 6d61  oneindex[0] > ma
+00025b90: 702e 6865 6164 6572 2e6e 7820 2d20 3120  p.header.nx - 1 
+00025ba0: 6f72 206f 6e65 696e 6465 785b 305d 203c  or oneindex[0] <
+00025bb0: 2030 206f 7220 5c0a 2020 2020 2020 2020   0 or \.        
+00025bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025bd0: 2020 2020 6f6e 6569 6e64 6578 5b31 5d20      oneindex[1] 
+00025be0: 3e20 6d61 702e 6865 6164 6572 2e6e 7920  > map.header.ny 
+00025bf0: 2d20 3120 6f72 206f 6e65 696e 6465 785b  - 1 or oneindex[
+00025c00: 315d 203c 2030 206f 7220 5c0a 2020 2020  1] < 0 or \.    
+00025c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025c20: 2020 2020 2020 2020 6f6e 6569 6e64 6578          oneindex
+00025c30: 5b32 5d20 3e20 6d61 702e 6865 6164 6572  [2] > map.header
+00025c40: 2e6e 7a20 2d20 3120 6f72 206f 6e65 696e  .nz - 1 or onein
+00025c50: 6465 785b 325d 203c 2030 3a0a 2020 2020  dex[2] < 0:.    
+00025c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025c70: 2020 2020 6375 7269 6e74 6572 706f 6c61      curinterpola
+00025c80: 7469 6f6e 203d 206d 6170 2e6d 696e 2829  tion = map.min()
+00025c90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00025ca0: 2020 2020 2020 2020 2061 746f 6d6f 7574           atomout
+00025cb0: 7369 6465 6e75 6d20 2b3d 2031 0a20 2020  sidenum += 1.   
+00025cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025cd0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00025ce0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00025cf0: 7572 696e 7465 7270 6f6c 6174 696f 6e20  urinterpolation 
+00025d00: 3d20 6d79 696e 7465 7228 6f6e 6569 6e64  = myinter(oneind
+00025d10: 6578 292e 746f 6c69 7374 2829 5b30 5d0a  ex).tolist()[0].
+00025d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025d30: 2020 2020 696e 7465 7270 6f6c 6174 696f      interpolatio
+00025d40: 6e73 2e61 7070 656e 6428 6375 7269 6e74  ns.append(curint
+00025d50: 6572 706f 6c61 7469 6f6e 290a 2020 2020  erpolation).    
+00025d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025d70: 6174 6f6d 696e 7465 7262 696e 203d 2031  atominterbin = 1
+00025d80: 2069 6620 6375 7269 6e74 6572 706f 6c61   if curinterpola
+00025d90: 7469 6f6e 203e 2063 6f6e 746f 7572 2065  tion > contour e
+00025da0: 6c73 6520 300a 0a20 2020 2020 2020 2020  lse 0..         
+00025db0: 2020 2020 2020 2020 2020 2069 6620 2872             if (r
+00025dc0: 6573 636f 756e 7420 3d3d 2030 2920 6f72  escount == 0) or
+00025dd0: 2028 7265 7369 6475 652e 6964 5b31 5d20   (residue.id[1] 
+00025de0: 3d3d 2070 7265 7265 7369 6420 616e 6420  == preresid and 
+00025df0: 6174 6f6d 2e66 756c 6c5f 6964 5b32 5d20  atom.full_id[2] 
+00025e00: 3d3d 2070 7265 6368 6169 6e29 3a0a 2020  == prechain):.  
+00025e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025e20: 2020 2020 2020 7375 6d61 746f 6d69 6e74        sumatomint
+00025e30: 6572 6269 6e20 2b3d 2061 746f 6d69 6e74  erbin += atomint
+00025e40: 6572 6269 6e0a 2020 2020 2020 2020 2020  erbin.          
+00025e50: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00025e60: 7363 6f75 6e74 202b 3d20 310a 2020 2020  scount += 1.    
+00025e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025e80: 2020 2020 7072 6572 6573 6964 203d 2072      preresid = r
+00025e90: 6573 6964 7565 2e69 645b 315d 0a20 2020  esidue.id[1].   
+00025ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025eb0: 2020 2020 2070 7265 6368 6169 6e20 3d20       prechain = 
+00025ec0: 6174 6f6d 2e66 756c 6c5f 6964 5b32 5d0a  atom.full_id[2].
+00025ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025ee0: 2020 2020 2020 2020 7072 6572 6573 203d          preres =
+00025ef0: 2072 6573 6964 7565 2e72 6573 6e61 6d65   residue.resname
+00025f00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00025f10: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00025f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025f30: 2020 206b 6579 7374 7220 3d20 7072 6563     keystr = prec
+00025f40: 6861 696e 202b 2027 3a27 202b 2073 7472  hain + ':' + str
+00025f50: 2870 7265 7265 7369 6429 202b 2070 7265  (preresid) + pre
+00025f60: 7265 730a 2020 2020 2020 2020 2020 2020  res.            
+00025f70: 2020 2020 2020 2020 2020 2020 616c 6c6b              allk
+00025f80: 6579 732e 6170 7065 6e64 286b 6579 7374  eys.append(keyst
+00025f90: 7229 0a20 2020 2020 2020 2020 2020 2020  r).             
+00025fa0: 2020 2020 2020 2020 2020 2076 616c 7565             value
+00025fb0: 203d 2066 6c6f 6174 2827 252e 3466 2720   = float('%.4f' 
+00025fc0: 2520 726f 756e 6428 2866 6c6f 6174 2873  % round((float(s
+00025fd0: 756d 6174 6f6d 696e 7465 7262 696e 2920  umatominterbin) 
+00025fe0: 2f20 7265 7363 6f75 6e74 292c 2034 2929  / rescount), 4))
+00025ff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00026000: 2020 2020 2020 2020 2061 6c6c 7661 6c75           allvalu
+00026010: 6573 2e61 7070 656e 6428 7661 6c75 6529  es.append(value)
+00026020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00026030: 2020 2020 2020 2020 2073 756d 6174 6f6d           sumatom
+00026040: 696e 7465 7262 696e 203d 2061 746f 6d69  interbin = atomi
+00026050: 6e74 6572 6269 6e0a 2020 2020 2020 2020  nterbin.        
+00026060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026070: 7072 6572 6573 6964 203d 2072 6573 6964  preresid = resid
+00026080: 7565 2e69 645b 315d 0a20 2020 2020 2020  ue.id[1].       
+00026090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000260a0: 2070 7265 6368 6169 6e20 3d20 6174 6f6d   prechain = atom
+000260b0: 2e66 756c 6c5f 6964 5b32 5d0a 2020 2020  .full_id[2].    
+000260c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000260d0: 2020 2020 7265 7363 6f75 6e74 203d 2031      rescount = 1
+000260e0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000260f0: 2020 2020 2020 2320 4164 6420 7468 6520        # Add the 
+00026100: 6368 6169 6e20 6261 7365 6420 6174 6f6d  chain based atom
+00026110: 2069 6e63 6c75 7369 6f6e 2073 636f 7265   inclusion score
+00026120: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00026130: 2020 2020 2069 6620 2861 746f 6d63 6f75       if (atomcou
+00026140: 6e74 203d 3d20 3129 206f 7220 2861 746f  nt == 1) or (ato
+00026150: 6d2e 6675 6c6c 5f69 645b 325d 203d 3d20  m.full_id[2] == 
+00026160: 6169 7072 6563 6861 696e 293a 0a20 2020  aiprechain):.   
+00026170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026180: 2020 2020 2063 6861 696e 6174 6f6d 7320       chainatoms 
+00026190: 2b3d 2031 0a20 2020 2020 2020 2020 2020  += 1.           
+000261a0: 2020 2020 2020 2020 2020 2020 2023 2061               # a
+000261b0: 6970 7265 6368 6169 6e20 3d20 6174 6f6d  iprechain = atom
+000261c0: 2e63 6861 696e 0a20 2020 2020 2020 2020  .chain.         
+000261d0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+000261e0: 6970 7265 6368 6169 6e20 3d20 6174 6f6d  iprechain = atom
+000261f0: 2e66 756c 6c5f 6964 5b32 5d0a 2020 2020  .full_id[2].    
 00026200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026210: 2020 6e70 2e6c 696e 7370 6163 6528 636f    np.linspace(co
-00026220: 6e74 6f75 722c 2063 6f6e 746f 7572 202b  ntour, contour +
-00026230: 2066 6c6f 6174 2831 2e35 202a 206d 6170   float(1.5 * map
-00026240: 7369 6729 2c20 3429 292c 2061 7869 733d  sig), 4)), axis=
-00026250: 4e6f 6e65 290a 2020 2020 2020 2020 2320  None).        # 
-00026260: 656c 7365 3a0a 2020 2020 2020 2020 2320  else:.        # 
-00026270: 2020 2020 636f 6e74 6f75 7272 616e 6765      contourrange
-00026280: 203d 206e 702e 6173 6172 7261 7928 5b63   = np.asarray([c
-00026290: 6f6e 746f 7572 5d29 0a0a 2020 2020 2020  ontour])..      
-000262a0: 2020 636f 6e74 6f75 7272 616e 6765 203d    contourrange =
-000262b0: 206e 702e 6173 6172 7261 7928 5b63 6f6e   np.asarray([con
-000262c0: 746f 7572 5d29 0a20 2020 2020 2020 2072  tour]).        r
-000262d0: 6573 756c 7420 3d20 7b7d 0a20 2020 2020  esult = {}.     
-000262e0: 2020 2066 6f72 206d 6f64 656c 2069 6e20     for model in 
-000262f0: 6d6f 6465 6c73 3a0a 2020 2020 2020 2020  models:.        
-00026300: 2020 2020 616c 6c63 6f6e 746f 7572 7364      allcontoursd
-00026310: 6963 7420 3d20 4f72 6465 7265 6444 6963  ict = OrderedDic
-00026320: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
-00026330: 6174 6f6d 6f75 7473 6964 656e 756d 203d  atomoutsidenum =
-00026340: 2030 0a20 2020 2020 2020 2020 2020 206d   0.            m
-00026350: 6f64 656c 6e61 6d65 203d 206d 6f64 656c  odelname = model
-00026360: 2e66 696c 656e 616d 652e 7370 6c69 7428  .filename.split(
-00026370: 272f 2729 5b2d 315d 0a0a 2020 2020 2020  '/')[-1]..      
-00026380: 2020 2020 2020 6174 6f6d 636f 756e 7420        atomcount 
-00026390: 3d20 300a 2020 2020 2020 2020 2020 2020  = 0.            
-000263a0: 6368 6169 6e63 6f75 6e74 203d 2031 0a20  chaincount = 1. 
-000263b0: 2020 2020 2020 2020 2020 2063 6861 696e             chain
-000263c0: 6174 6f6d 7320 3d20 300a 2020 2020 2020  atoms = 0.      
-000263d0: 2020 2020 2020 6368 6169 6e61 6973 636f        chainaisco
-000263e0: 7265 203d 207b 7d0a 2020 2020 2020 2020  re = {}.        
-000263f0: 2020 2020 6368 6169 6e61 6920 3d20 302e      chainai = 0.
-00026400: 0a0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
-00026410: 7220 636f 6e74 6f75 7220 696e 2063 6f6e  r contour in con
-00026420: 746f 7572 7261 6e67 653a 0a20 2020 2020  tourrange:.     
-00026430: 2020 2020 2020 2020 2020 2069 6e74 6572             inter
-00026440: 706f 6c61 7469 6f6e 7320 3d20 5b5d 0a20  polations = []. 
-00026450: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00026460: 6c6c 6b65 7973 203d 205b 5d0a 2020 2020  llkeys = [].    
-00026470: 2020 2020 2020 2020 2020 2020 616c 6c76              allv
-00026480: 616c 7565 7320 3d20 5b5d 0a20 2020 2020  alues = [].     
-00026490: 2020 2020 2020 2020 2020 2070 7265 7265             prere
-000264a0: 7369 6420 3d20 300a 2020 2020 2020 2020  sid = 0.        
-000264b0: 2020 2020 2020 2020 7072 6563 6861 696e          prechain
-000264c0: 203d 2027 270a 2020 2020 2020 2020 2020   = ''.          
-000264d0: 2020 2020 2020 6169 7072 6563 6861 696e        aiprechain
-000264e0: 203d 2027 270a 2020 2020 2020 2020 2020   = ''.          
-000264f0: 2020 2020 2020 7072 6572 6573 203d 2027        preres = '
-00026500: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00026510: 2020 7265 7363 6f75 6e74 203d 2030 0a20    rescount = 0. 
-00026520: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00026530: 756d 6174 6f6d 696e 7465 7262 696e 203d  umatominterbin =
-00026540: 2030 0a20 2020 2020 2020 2020 2020 2020   0.             
-00026550: 2020 2063 6861 696e 6169 5f61 746f 6d73     chainai_atoms
-00026560: 6e6f 203d 207b 7d0a 2020 2020 2020 2020  no = {}.        
-00026570: 2020 2020 2020 2020 666f 7220 6368 6169          for chai
-00026580: 6e20 696e 206d 6f64 656c 2e67 6574 5f63  n in model.get_c
-00026590: 6861 696e 7328 293a 0a20 2020 2020 2020  hains():.       
-000265a0: 2020 2020 2020 2020 2020 2020 2063 6861               cha
-000265b0: 696e 6174 6f6d 696e 7465 7262 696e 203d  inatominterbin =
-000265c0: 2030 0a20 2020 2020 2020 2020 2020 2020   0.             
-000265d0: 2020 2020 2020 2063 6861 696e 5f61 746f         chain_ato
-000265e0: 6d5f 636f 756e 7420 3d20 300a 2020 2020  m_count = 0.    
+00026210: 2020 2020 6368 6169 6e61 6920 2b3d 2061      chainai += a
+00026220: 746f 6d69 6e74 6572 6269 6e0a 2020 2020  tominterbin.    
+00026230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026240: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00026250: 2020 2020 2020 2020 2020 2020 2020 6169                ai
+00026260: 7661 6c75 6520 3d20 726f 756e 6428 666c  value = round(fl
+00026270: 6f61 7428 6368 6169 6e61 6929 202f 2063  oat(chainai) / c
+00026280: 6861 696e 6174 6f6d 732c 2033 290a 2020  hainatoms, 3).  
+00026290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000262a0: 2020 2020 2020 6169 636f 6c6f 7220 3d20        aicolor = 
+000262b0: 7365 6c66 2e5f 5f66 6c6f 6174 6f68 6578  self.__floatohex
+000262c0: 285b 6169 7661 6c75 655d 295b 305d 0a20  ([aivalue])[0]. 
+000262d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000262e0: 2020 2020 2020 2023 2063 6861 696e 6169         # chainai
+000262f0: 7363 6f72 655b 7072 6563 6861 696e 5d20  score[prechain] 
+00026300: 3d20 7b27 7661 6c75 6527 3a20 6169 7661  = {'value': aiva
+00026310: 6c75 652c 2027 636f 6c6f 7227 3a20 6169  lue, 'color': ai
+00026320: 636f 6c6f 727d 0a20 2020 2020 2020 2020  color}.         
+00026330: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00026340: 2028 546f 646f 2920 466f 7220 6368 6169   (Todo) For chai
+00026350: 6e20 7768 6963 6820 6861 7665 2074 6865  n which have the
+00026360: 2073 616d 6520 6368 6169 6e20 6964 206e   same chain id n
+00026370: 6f6e 2d70 726f 7465 696e 2070 6172 7420  on-protein part 
+00026380: 6e6f 7420 696e 636c 7564 6564 2079 6574  not included yet
+00026390: 2065 7370 6563 6961 6c6c 790a 2020 2020   especially.    
+000263a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000263b0: 2020 2020 2320 6c69 6761 6e64 2062 696e      # ligand bin
+000263c0: 6420 746f 2074 6865 2070 726f 7465 696e  d to the protein
+000263d0: 206c 6967 616e 6420 6861 7320 7468 6520   ligand has the 
+000263e0: 7361 6d65 2063 6861 696e 2069 6420 6173  same chain id as
+000263f0: 2074 6865 2070 726f 7465 696e 2c20 7468   the protein, th
+00026400: 656e 2068 6f77 2074 6f20 6176 6572 6765  en how to averge
+00026410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00026420: 2020 2020 2020 2020 2023 2074 6865 206c           # the l
+00026430: 6967 616e 6420 616e 6420 7468 6520 7072  igand and the pr
+00026440: 6f74 6569 6e20 746f 6765 7468 6572 206e  otein together n
+00026450: 6565 6420 746f 2074 616b 6520 7468 6520  eed to take the 
+00026460: 6e75 6d62 6572 7320 696e 746f 2061 6363  numbers into acc
+00026470: 6f75 6e74 2077 6869 6368 2061 6c73 6f20  ount which also 
+00026480: 6d65 616e 730a 2020 2020 2020 2020 2020  means.          
+00026490: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+000264a0: 6e65 6564 2074 6f20 6164 6420 616e 6f74  need to add anot
+000264b0: 6865 7220 7661 6c75 6520 696e 2074 6865  her value in the
+000264c0: 2064 6963 746f 6e61 7279 0a20 2020 2020   dictonary.     
+000264d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000264e0: 2020 2023 204e 6565 6420 746f 2070 726f     # Need to pro
+000264f0: 7065 726c 7920 6361 6e63 756c 6174 6564  perly canculated
+00026500: 2074 6865 2061 7665 7261 6765 206f 6620   the average of 
+00026510: 6f6e 6520 6368 6169 6e0a 2020 2020 2020  one chain.      
+00026520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026530: 2020 6966 2061 6970 7265 6368 6169 6e20    if aiprechain 
+00026540: 696e 2063 6861 696e 6169 7363 6f72 652e  in chainaiscore.
+00026550: 6b65 7973 2829 3a0a 2020 2020 2020 2020  keys():.        
+00026560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026570: 2020 2020 2320 6368 6169 6e61 6973 636f      # chainaisco
+00026580: 7265 5b61 6970 7265 6368 6169 6e20 2b20  re[aiprechain + 
+00026590: 275f 2720 2b20 7374 7228 6169 7661 6c75  '_' + str(aivalu
+000265a0: 6529 5d20 3d20 7b27 7661 6c75 6527 3a20  e)] = {'value': 
+000265b0: 6169 7661 6c75 652c 2027 636f 6c6f 7227  aivalue, 'color'
+000265c0: 3a20 6169 636f 6c6f 727d 0a20 2020 2020  : aicolor}.     
+000265d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000265e0: 2020 2020 2020 2070 6173 730a 2020 2020         pass.    
 000265f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026600: 6368 6169 6e5f 6e61 6d65 203d 2063 6861  chain_name = cha
-00026610: 696e 2e69 640a 2020 2020 2020 2020 2020  in.id.          
-00026620: 2020 2020 2020 2020 2020 666f 7220 7265            for re
-00026630: 7369 6475 6520 696e 2063 6861 696e 2e67  sidue in chain.g
-00026640: 6574 5f72 6573 6964 7565 7328 293a 0a20  et_residues():. 
-00026650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026660: 2020 2020 2020 2072 6573 6174 6f6d 696e         resatomin
-00026670: 7465 7262 696e 203d 2030 0a20 2020 2020  terbin = 0.     
-00026680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026690: 2020 2072 6573 6964 7565 5f61 746f 6d5f     residue_atom_
-000266a0: 636f 756e 7420 3d20 300a 2020 2020 2020  count = 0.      
-000266b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000266c0: 2020 7265 7369 6475 655f 6e61 6d65 203d    residue_name =
-000266d0: 2072 6573 6964 7565 2e72 6573 6e61 6d65   residue.resname
-000266e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000266f0: 2020 2020 2020 2020 2072 6573 6964 7565           residue
-00026700: 5f6e 6f20 3d20 7265 7369 6475 652e 6964  _no = residue.id
-00026710: 5b31 5d0a 2020 2020 2020 2020 2020 2020  [1].            
-00026720: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00026730: 6174 6f6d 2069 6e20 7265 7369 6475 652e  atom in residue.
-00026740: 6765 745f 6174 6f6d 7328 293a 0a20 2020  get_atoms():.   
-00026750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026760: 2020 2020 2020 2020 2069 6620 6174 6f6d           if atom
-00026770: 2e6e 616d 652e 7374 6172 7473 7769 7468  .name.startswith
-00026780: 2827 4827 2920 6f72 2061 746f 6d2e 6765  ('H') or atom.ge
-00026790: 745f 7061 7265 6e74 2829 2e72 6573 6e61  t_parent().resna
-000267a0: 6d65 203d 3d20 2748 4f48 273a 0a20 2020  me == 'HOH':.   
-000267b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000267c0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-000267d0: 7469 6e75 650a 2020 2020 2020 2020 2020  tinue.          
-000267e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000267f0: 2020 2320 6966 2027 4827 206e 6f74 2069    # if 'H' not i
-00026800: 6e20 6174 6f6d 2e6e 616d 653a 0a20 2020  n atom.name:.   
-00026810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026820: 2020 2020 2020 2020 2061 746f 6d63 6f75           atomcou
-00026830: 6e74 202b 3d20 310a 2020 2020 2020 2020  nt += 1.        
-00026840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026850: 2020 2020 7265 7369 6475 655f 6174 6f6d      residue_atom
-00026860: 5f63 6f75 6e74 202b 3d20 310a 2020 2020  _count += 1.    
-00026870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026880: 2020 2020 2020 2020 2320 6368 6169 6e5f          # chain_
-00026890: 6174 6f6d 5f63 6f75 6e74 202b 3d20 310a  atom_count += 1.
-000268a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000268b0: 2020 2020 2020 2020 2020 2020 6f6e 6563              onec
-000268c0: 6f6f 7220 3d20 6174 6f6d 2e63 6f6f 7264  oor = atom.coord
-000268d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000268e0: 2020 2020 2020 2020 2020 2020 206f 6e65               one
-000268f0: 696e 6465 7820 3d20 7365 6c66 2e5f 5f67  index = self.__g
-00026900: 6574 696e 6469 6365 7328 6f6e 6563 6f6f  etindices(onecoo
-00026910: 7229 5b31 5d0a 2020 2020 2020 2020 2020  r)[1].          
-00026920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026930: 2020 2320 6966 206f 6e65 696e 6465 785b    # if oneindex[
-00026940: 305d 203e 206d 6170 2e78 5f73 697a 6528  0] > map.x_size(
-00026950: 2920 2d20 3120 6f72 206f 6e65 696e 6465  ) - 1 or oneinde
-00026960: 785b 305d 203c 2030 206f 7220 5c0a 2020  x[0] < 0 or \.  
-00026970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026980: 2020 2020 2020 2020 2020 2320 2020 2020            #     
-00026990: 2020 2020 6f6e 6569 6e64 6578 5b31 5d20      oneindex[1] 
-000269a0: 3e20 6d61 702e 795f 7369 7a65 2829 202d  > map.y_size() -
-000269b0: 2031 206f 7220 6f6e 6569 6e64 6578 5b31   1 or oneindex[1
-000269c0: 5d20 3c20 3020 6f72 205c 0a20 2020 2020  ] < 0 or \.     
-000269d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000269e0: 2020 2020 2020 2023 2020 2020 2020 2020         #        
-000269f0: 206f 6e65 696e 6465 785b 325d 203e 206d   oneindex[2] > m
-00026a00: 6170 2e7a 5f73 697a 6528 2920 2d20 3120  ap.z_size() - 1 
-00026a10: 6f72 206f 6e65 696e 6465 785b 325d 203c  or oneindex[2] <
-00026a20: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-00026a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026a40: 6966 206f 6e65 696e 6465 785b 305d 203e  if oneindex[0] >
-00026a50: 206d 6170 2e68 6561 6465 722e 6e78 202d   map.header.nx -
-00026a60: 2031 206f 7220 6f6e 6569 6e64 6578 5b30   1 or oneindex[0
-00026a70: 5d20 3c20 3020 6f72 205c 0a20 2020 2020  ] < 0 or \.     
-00026a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026a90: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00026aa0: 6e65 696e 6465 785b 315d 203e 206d 6170  neindex[1] > map
-00026ab0: 2e68 6561 6465 722e 6e79 202d 2031 206f  .header.ny - 1 o
-00026ac0: 7220 6f6e 6569 6e64 6578 5b31 5d20 3c20  r oneindex[1] < 
-00026ad0: 3020 6f72 205c 0a20 2020 2020 2020 2020  0 or \.         
-00026ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026af0: 2020 2020 2020 2020 2020 206f 6e65 696e             onein
-00026b00: 6465 785b 325d 203e 206d 6170 2e68 6561  dex[2] > map.hea
-00026b10: 6465 722e 6e7a 202d 2031 206f 7220 6f6e  der.nz - 1 or on
-00026b20: 6569 6e64 6578 5b32 5d20 3c20 303a 0a20  eindex[2] < 0:. 
-00026b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026b40: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00026b50: 2063 7572 696e 7465 7270 6f6c 6174 696f   curinterpolatio
-00026b60: 6e20 3d20 6d61 702e 6d69 6e28 290a 2020  n = map.min().  
-00026b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026b80: 2020 2020 2020 2020 2020 2020 2020 6375                cu
-00026b90: 7269 6e74 6572 706f 6c61 7469 6f6e 203d  rinterpolation =
-00026ba0: 206d 6170 2e64 6174 612e 6d69 6e28 290a   map.data.min().
-00026bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026bd0: 6174 6f6d 6f75 7473 6964 656e 756d 202b  atomoutsidenum +
-00026be0: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
-00026bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026c00: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00026c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026c20: 2020 2020 2020 6375 7269 6e74 6572 706f        curinterpo
-00026c30: 6c61 7469 6f6e 203d 206d 7969 6e74 6572  lation = myinter
-00026c40: 286f 6e65 696e 6465 7829 2e74 6f6c 6973  (oneindex).tolis
-00026c50: 7428 295b 305d 0a20 2020 2020 2020 2020  t()[0].         
-00026c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026c70: 2020 2069 6e74 6572 706f 6c61 7469 6f6e     interpolation
-00026c80: 732e 6170 7065 6e64 2863 7572 696e 7465  s.append(curinte
-00026c90: 7270 6f6c 6174 696f 6e29 0a20 2020 2020  rpolation).     
-00026ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026cb0: 2020 2020 2020 2061 746f 6d69 6e74 6572         atominter
-00026cc0: 6269 6e20 3d20 3120 6966 2063 7572 696e  bin = 1 if curin
-00026cd0: 7465 7270 6f6c 6174 696f 6e20 3e20 636f  terpolation > co
-00026ce0: 6e74 6f75 7220 656c 7365 2030 0a20 2020  ntour else 0.   
-00026cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026d00: 2020 2020 2020 2020 2072 6573 6174 6f6d           resatom
-00026d10: 696e 7465 7262 696e 202b 3d20 6174 6f6d  interbin += atom
-00026d20: 696e 7465 7262 696e 0a20 2020 2020 2020  interbin.       
-00026d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026d40: 2020 2020 2069 6620 2748 2720 6e6f 7420       if 'H' not 
-00026d50: 696e 2061 746f 6d2e 6e61 6d65 3a0a 2020  in atom.name:.  
-00026d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026d70: 2020 2020 2020 2020 2020 2020 2020 6368                ch
-00026d80: 6169 6e61 746f 6d69 6e74 6572 6269 6e20  ainatominterbin 
-00026d90: 2b3d 2061 746f 6d69 6e74 6572 6269 6e0a  += atominterbin.
-00026da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026dc0: 6368 6169 6e5f 6174 6f6d 5f63 6f75 6e74  chain_atom_count
-00026dd0: 202b 3d20 310a 2020 2020 2020 2020 2020   += 1.          
-00026de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026df0: 2020 7375 6d61 746f 6d69 6e74 6572 6269    sumatominterbi
-00026e00: 6e20 2b3d 2061 746f 6d69 6e74 6572 6269  n += atominterbi
-00026e10: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
-00026e20: 2020 2020 2020 2020 2020 6966 2072 6573            if res
-00026e30: 6964 7565 5f61 746f 6d5f 636f 756e 7420  idue_atom_count 
-00026e40: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
-00026e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026e60: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
-00026e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026e80: 2020 2023 2072 6573 6964 7565 2069 6e63     # residue inc
-00026e90: 6c75 7369 6f6e 2073 6563 7469 6f6e 0a20  lusion section. 
-00026ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026eb0: 2020 2020 2020 206b 6579 7374 7220 3d20         keystr = 
-00026ec0: 6368 6169 6e5f 6e61 6d65 202b 2027 3a27  chain_name + ':'
-00026ed0: 202b 2073 7472 2872 6573 6964 7565 5f6e   + str(residue_n
-00026ee0: 6f29 202b 2072 6573 6964 7565 5f6e 616d  o) + residue_nam
-00026ef0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00026f00: 2020 2020 2020 2020 2020 616c 6c6b 6579            allkey
-00026f10: 732e 6170 7065 6e64 286b 6579 7374 7229  s.append(keystr)
-00026f20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00026f30: 2020 2020 2020 2020 2076 616c 7565 203d           value =
-00026f40: 2066 6c6f 6174 2827 252e 3466 2720 2520   float('%.4f' % 
-00026f50: 726f 756e 6428 2866 6c6f 6174 2872 6573  round((float(res
-00026f60: 6174 6f6d 696e 7465 7262 696e 2920 2f20  atominterbin) / 
-00026f70: 7265 7369 6475 655f 6174 6f6d 5f63 6f75  residue_atom_cou
-00026f80: 6e74 292c 2034 2929 0a20 2020 2020 2020  nt), 4)).       
-00026f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026fa0: 2061 6c6c 7661 6c75 6573 2e61 7070 656e   allvalues.appen
-00026fb0: 6428 7661 6c75 6529 0a0a 2020 2020 2020  d(value)..      
-00026fc0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00026fd0: 6368 6169 6e20 696e 636c 7573 696f 6e20  chain inclusion 
-00026fe0: 7365 6374 696f 6e0a 2020 2020 2020 2020  section.        
-00026ff0: 2020 2020 2020 2020 2020 2020 6966 2063              if c
-00027000: 6861 696e 5f6e 616d 6520 696e 2063 6861  hain_name in cha
-00027010: 696e 6169 5f61 746f 6d73 6e6f 2e6b 6579  inai_atomsno.key
-00027020: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-00027030: 2020 2020 2020 2020 2020 2020 2063 6861               cha
-00027040: 696e 6174 6f6d 696e 7465 7262 696e 202b  inatominterbin +
-00027050: 3d20 6368 6169 6e61 695f 6174 6f6d 736e  = chainai_atomsn
-00027060: 6f5b 6368 6169 6e5f 6e61 6d65 5d5b 2776  o[chain_name]['v
-00027070: 616c 7565 275d 0a20 2020 2020 2020 2020  alue'].         
-00027080: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00027090: 6861 696e 5f61 746f 6d5f 636f 756e 7420  hain_atom_count 
-000270a0: 2b3d 2063 6861 696e 6169 5f61 746f 6d73  += chainai_atoms
-000270b0: 6e6f 5b63 6861 696e 5f6e 616d 655d 5b27  no[chain_name]['
-000270c0: 6174 6f6d 7369 6e63 6861 696e 275d 0a20  atomsinchain']. 
-000270d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000270e0: 2020 2023 2046 6f72 2063 6173 6573 2077     # For cases w
-000270f0: 6865 7265 206f 6e65 2077 6174 6572 206d  here one water m
-00027100: 6f6c 6563 756c 6520 6861 7320 6120 7369  olecule has a si
-00027110: 676c 6520 6275 7420 6469 6666 6572 656e  gle but differen
-00027120: 7420 6368 6169 6e20 6964 0a20 2020 2020  t chain id.     
-00027130: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00027140: 6620 6368 6169 6e5f 6174 6f6d 5f63 6f75  f chain_atom_cou
-00027150: 6e74 203d 3d20 303a 0a20 2020 2020 2020  nt == 0:.       
-00027160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027170: 2063 6f6e 7469 6e75 650a 2020 2020 2020   continue.      
-00027180: 2020 2020 2020 2020 2020 2020 2020 6368                ch
-00027190: 6169 6e61 695f 6174 6f6d 736e 6f5b 6368  ainai_atomsno[ch
-000271a0: 6169 6e5f 6e61 6d65 5d20 3d20 7b27 7661  ain_name] = {'va
-000271b0: 6c75 6527 3a20 6368 6169 6e61 746f 6d69  lue': chainatomi
-000271c0: 6e74 6572 6269 6e2c 2027 6174 6f6d 7369  nterbin, 'atomsi
-000271d0: 6e63 6861 696e 273a 2063 6861 696e 5f61  nchain': chain_a
-000271e0: 746f 6d5f 636f 756e 747d 0a0a 2020 2020  tom_count}..    
-000271f0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00027200: 6368 6169 6e6e 616d 652c 2063 6861 696e  chainname, chain
-00027210: 5f73 636f 7265 7320 696e 2063 6861 696e  _scores in chain
-00027220: 6169 5f61 746f 6d73 6e6f 2e69 7465 6d73  ai_atomsno.items
-00027230: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00027240: 2020 2020 2020 2020 6368 6169 6e5f 6169          chain_ai
-00027250: 203d 2066 6c6f 6174 2827 252e 3366 2720   = float('%.3f' 
-00027260: 2520 726f 756e 6428 2866 6c6f 6174 2863  % round((float(c
-00027270: 6861 696e 5f73 636f 7265 735b 2776 616c  hain_scores['val
-00027280: 7565 275d 2920 2f20 6368 6169 6e5f 7363  ue']) / chain_sc
-00027290: 6f72 6573 5b27 6174 6f6d 7369 6e63 6861  ores['atomsincha
-000272a0: 696e 275d 292c 2034 2929 0a20 2020 2020  in']), 4)).     
-000272b0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-000272c0: 6963 6f6c 6f72 203d 2073 656c 662e 5f5f  icolor = self.__
-000272d0: 666c 6f61 746f 6865 7828 5b63 6861 696e  floatohex([chain
-000272e0: 5f61 695d 295b 305d 0a20 2020 2020 2020  _ai])[0].       
-000272f0: 2020 2020 2020 2020 2020 2020 2063 6861               cha
-00027300: 696e 6169 7363 6f72 655b 6368 6169 6e6e  inaiscore[chainn
-00027310: 616d 655d 203d 207b 2776 616c 7565 273a  ame] = {'value':
-00027320: 2063 6861 696e 5f61 692c 2027 636f 6c6f   chain_ai, 'colo
-00027330: 7227 3a20 6169 636f 6c6f 722c 2027 6e75  r': aicolor, 'nu
-00027340: 6d62 6572 4f66 4174 6f6d 7327 3a20 6368  mberOfAtoms': ch
-00027350: 6169 6e5f 7363 6f72 6573 5b27 6174 6f6d  ain_scores['atom
-00027360: 7369 6e63 6861 696e 275d 7d0a 2020 2020  sinchain']}.    
-00027370: 2020 2020 2020 2020 2020 2020 616c 6c63              allc
-00027380: 6f6e 746f 7572 7364 6963 745b 7374 7228  ontoursdict[str(
-00027390: 636f 6e74 6f75 7229 5d20 3d20 2861 6c6c  contour)] = (all
-000273a0: 6b65 7973 2c20 616c 6c76 616c 7565 7329  keys, allvalues)
-000273b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000273c0: 2070 7269 6e74 2827 4d6f 6465 6c3a 2025   print('Model: %
-000273d0: 7320 6174 2063 6f6e 746f 7572 206c 6576  s at contour lev
-000273e0: 656c 2025 7320 6861 7320 2573 2061 746f  el %s has %s ato
-000273f0: 6d73 2073 7469 636b 206f 7574 206f 6620  ms stick out of 
-00027400: 7468 6520 6465 6e73 6974 792e 2720 2520  the density.' % 
-00027410: 286d 6f64 656c 6e61 6d65 2c20 636f 6e74  (modelname, cont
-00027420: 6f75 722c 0a20 2020 2020 2020 2020 2020  our,.           
-00027430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027480: 2020 2020 2061 746f 6d6f 7574 7369 6465       atomoutside
-00027490: 6e75 6d29 290a 0a20 2020 2020 2020 2020  num))..         
-000274a0: 2020 2023 2072 6573 756c 745b 6d6f 6465     # result[mode
-000274b0: 6c6e 616d 655d 203d 2028 696e 7465 7270  lname] = (interp
-000274c0: 6f6c 6174 696f 6e73 2c20 616c 6c6b 6579  olations, allkey
-000274d0: 732c 2061 6c6c 7661 6c75 6573 290a 2020  s, allvalues).  
-000274e0: 2020 2020 2020 2020 2020 2320 7265 7375            # resu
-000274f0: 6c74 3a20 7b6d 6f64 656c 6e61 6d65 2023  lt: {modelname #
-00027500: 313a 2028 696e 7465 7270 6f6c 6174 696f  1: (interpolatio
-00027510: 6e73 2023 312c 207b 636f 6e74 6f75 7231  ns #1, {contour1
-00027520: 3a20 2861 6c6c 6b65 7973 2c20 616c 6c76  : (allkeys, allv
-00027530: 616c 7565 7329 2c20 636f 6e74 6f75 7232  alues), contour2
-00027540: 3a20 2861 6c6c 6b65 7973 2c20 616c 6c76  : (allkeys, allv
-00027550: 616c 7565 7329 0a20 2020 2020 2020 2020  alues).         
-00027560: 2020 2023 202e 2e2e 7d29 2c20 6d6f 6465     # ...}), mode
-00027570: 6c6e 616d 6520 2332 3a20 2869 6e74 6572  lname #2: (inter
-00027580: 706f 6c61 7469 6f6e 7320 2332 2c20 7b63  polations #2, {c
-00027590: 6f6e 746f 7572 313a 2028 616c 6c6b 6579  ontour1: (allkey
-000275a0: 732c 2061 6c6c 7661 6c75 6573 292c 2e2e  s, allvalues),..
-000275b0: 2e7d 292c 2e2e 2e7d 0a20 2020 2020 2020  .}),...}.       
-000275c0: 2020 2020 2072 6573 756c 745b 6d6f 6465       result[mode
-000275d0: 6c6e 616d 655d 203d 2028 696e 7465 7270  lname] = (interp
-000275e0: 6f6c 6174 696f 6e73 2c20 616c 6c63 6f6e  olations, allcon
-000275f0: 746f 7572 7364 6963 742c 2063 6861 696e  toursdict, chain
-00027600: 6169 7363 6f72 652c 2061 746f 6d6f 7574  aiscore, atomout
-00027610: 7369 6465 6e75 6d29 0a0a 2020 2020 2020  sidenum)..      
-00027620: 2020 7265 7475 726e 2072 6573 756c 740a    return result.
-00027630: 0a0a 2020 2020 6465 6620 6d61 705f 6d61  ..    def map_ma
-00027640: 7472 6978 2873 656c 662c 2061 7069 7873  trix(self, apixs
-00027650: 2c20 616e 6773 293a 0a20 2020 2020 2020  , angs):.       
-00027660: 2022 2222 0a0a 2020 2020 2020 2020 2020   """..          
-00027670: 2020 6361 6c63 756c 6174 6520 7468 6520    calculate the 
-00027680: 6d61 7472 6978 2074 6f20 7472 616e 7366  matrix to transf
-00027690: 6f72 6d20 4361 7274 6573 6961 6e20 636f  orm Cartesian co
-000276a0: 6f72 6469 6e61 7465 7320 746f 2066 7261  ordinates to fra
-000276b0: 6374 696f 6e61 6c20 636f 6f72 6469 6e61  ctional coordina
-000276c0: 7465 730a 2020 2020 2020 2020 2020 2020  tes.            
-000276d0: 2863 6865 636b 2074 6865 2064 6566 696e  (check the defin
-000276e0: 696e 6174 696f 6e20 746f 2073 6565 2074  ination to see t
-000276f0: 6865 206d 6174 7269 7820 666f 726d 756c  he matrix formul
-00027700: 6172 290a 0a20 2020 2020 2020 203a 7061  ar)..        :pa
-00027710: 7261 6d20 6170 6978 733a 2061 7272 6179  ram apixs: array
-00027720: 206f 6620 6170 6978 206c 656e 6768 740a   of apix lenght.
-00027730: 2020 2020 2020 2020 3a70 6172 616d 2061          :param a
-00027740: 6e67 733a 2061 7272 6179 206f 6620 616e  ngs: array of an
-00027750: 676c 6578 2069 6e20 616c 7068 612c 2062  glex in alpha, b
-00027760: 6574 612c 2067 616d 6d61 206f 7264 6572  eta, gamma order
-00027770: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-00027780: 3a0a 2020 2020 2020 2020 2222 220a 0a20  :.        """.. 
-00027790: 2020 2020 2020 2061 6e67 203d 2028 616e         ang = (an
-000277a0: 6773 5b30 5d2a 6d61 7468 2e70 692f 3138  gs[0]*math.pi/18
-000277b0: 302c 2061 6e67 735b 315d 2a6d 6174 682e  0, angs[1]*math.
-000277c0: 7069 2f31 3830 2c20 616e 6773 5b32 5d2a  pi/180, angs[2]*
-000277d0: 6d61 7468 2e70 692f 3138 3029 0a20 2020  math.pi/180).   
-000277e0: 2020 2020 2069 6e73 6964 6573 7172 7420       insidesqrt 
-000277f0: 3d20 3120 2b20 3220 2a20 6d61 7468 2e63  = 1 + 2 * math.c
-00027800: 6f73 2861 6e67 5b30 5d29 202a 206d 6174  os(ang[0]) * mat
-00027810: 682e 636f 7328 616e 675b 315d 2920 2a20  h.cos(ang[1]) * 
-00027820: 6d61 7468 2e63 6f73 2861 6e67 5b32 5d29  math.cos(ang[2])
-00027830: 202d 205c 0a20 2020 2020 2020 2020 2020   - \.           
-00027840: 2020 2020 2020 2020 2020 6d61 7468 2e63            math.c
-00027850: 6f73 2861 6e67 5b30 5d29 2a2a 3220 2d20  os(ang[0])**2 - 
-00027860: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
-00027870: 2020 2020 2020 206d 6174 682e 636f 7328         math.cos(
-00027880: 616e 675b 315d 292a 2a32 202d 205c 0a20  ang[1])**2 - \. 
-00027890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000278a0: 2020 2020 6d61 7468 2e63 6f73 2861 6e67      math.cos(ang
-000278b0: 5b32 5d29 2a2a 320a 0a20 2020 2020 2020  [2])**2..       
-000278c0: 2063 656c 6c76 6f6c 756d 6520 3d20 6170   cellvolume = ap
-000278d0: 6978 735b 305d 2a61 7069 7873 5b31 5d2a  ixs[0]*apixs[1]*
-000278e0: 6170 6978 735b 325d 2a6d 6174 682e 7371  apixs[2]*math.sq
-000278f0: 7274 2869 6e73 6964 6573 7172 7429 0a0a  rt(insidesqrt)..
-00027900: 2020 2020 2020 2020 6d31 3120 3d20 312f          m11 = 1/
-00027910: 6170 6978 735b 305d 0a20 2020 2020 2020  apixs[0].       
-00027920: 206d 3132 203d 202d 6d61 7468 2e63 6f73   m12 = -math.cos
-00027930: 2861 6e67 5b32 5d29 2f28 6170 6978 735b  (ang[2])/(apixs[
-00027940: 305d 2a6d 6174 682e 7369 6e28 616e 675b  0]*math.sin(ang[
-00027950: 325d 2929 0a0a 2020 2020 2020 2020 6d31  2]))..        m1
-00027960: 3320 3d20 6170 6978 735b 315d 202a 2061  3 = apixs[1] * a
-00027970: 7069 7873 5b32 5d20 2a20 286d 6174 682e  pixs[2] * (math.
-00027980: 636f 7328 616e 675b 305d 2920 2a20 6d61  cos(ang[0]) * ma
-00027990: 7468 2e63 6f73 2861 6e67 5b32 5d29 202d  th.cos(ang[2]) -
-000279a0: 206d 6174 682e 636f 7328 616e 675b 315d   math.cos(ang[1]
-000279b0: 2929 202f 2028 6365 6c6c 766f 6c75 6d65  )) / (cellvolume
-000279c0: 202a 206d 6174 682e 7369 6e28 616e 675b   * math.sin(ang[
-000279d0: 325d 2929 0a20 2020 2020 2020 206d 3231  2])).        m21
-000279e0: 203d 2030 0a20 2020 2020 2020 206d 3232   = 0.        m22
-000279f0: 203d 2031 202f 2028 6170 6978 735b 315d   = 1 / (apixs[1]
-00027a00: 202a 206d 6174 682e 7369 6e28 616e 675b   * math.sin(ang[
-00027a10: 325d 2929 0a20 2020 2020 2020 206d 3233  2])).        m23
-00027a20: 203d 2061 7069 7873 5b30 5d20 2a20 6170   = apixs[0] * ap
-00027a30: 6978 735b 325d 202a 2028 6d61 7468 2e63  ixs[2] * (math.c
-00027a40: 6f73 2861 6e67 5b31 5d29 202a 206d 6174  os(ang[1]) * mat
-00027a50: 682e 636f 7328 616e 675b 325d 2920 2d20  h.cos(ang[2]) - 
-00027a60: 6d61 7468 2e63 6f73 2861 6e67 5b30 5d29  math.cos(ang[0])
-00027a70: 2920 2f20 2863 656c 6c76 6f6c 756d 6520  ) / (cellvolume 
-00027a80: 2a20 6d61 7468 2e73 696e 2861 6e67 5b32  * math.sin(ang[2
-00027a90: 5d29 290a 2020 2020 2020 2020 6d33 3120  ])).        m31 
-00027aa0: 3d20 300a 2020 2020 2020 2020 6d33 3220  = 0.        m32 
-00027ab0: 3d20 300a 2020 2020 2020 2020 6d33 3320  = 0.        m33 
-00027ac0: 3d20 6170 6978 735b 305d 202a 2061 7069  = apixs[0] * api
-00027ad0: 7873 5b31 5d20 2a20 6d61 7468 2e73 696e  xs[1] * math.sin
-00027ae0: 2861 6e67 5b32 5d29 202f 2063 656c 6c76  (ang[2]) / cellv
-00027af0: 6f6c 756d 650a 2020 2020 2020 2020 7072  olume.        pr
-00027b00: 656d 6174 7269 7820 3d20 5b5b 6d31 312c  ematrix = [[m11,
-00027b10: 206d 3132 2c20 6d31 335d 2c20 5b6d 3231   m12, m13], [m21
-00027b20: 2c20 6d32 322c 206d 3233 5d2c 205b 6d33  , m22, m23], [m3
-00027b30: 312c 206d 3332 2c20 6d33 335d 5d0a 2020  1, m32, m33]].  
-00027b40: 2020 2020 2020 6d61 7472 6978 203d 206e        matrix = n
-00027b50: 702e 6173 6172 7261 7928 7072 656d 6174  p.asarray(premat
-00027b60: 7269 7829 0a0a 2020 2020 2020 2020 7265  rix)..        re
-00027b70: 7475 726e 206d 6174 7269 780a 0a0a 2020  turn matrix...  
-00027b80: 2020 6465 6620 6d61 7472 6978 5f69 6e64    def matrix_ind
-00027b90: 6963 6573 2873 656c 662c 2061 7069 7873  ices(self, apixs
-00027ba0: 2c20 6f6e 6563 6f6f 7229 3a0a 2020 2020  , onecoor):.    
-00027bb0: 2020 2020 2222 220a 0a20 2020 2020 2020      """..       
-00027bc0: 2020 2020 204d 6574 686f 6420 323a 2075       Method 2: u
-00027bd0: 7369 6e67 2074 6865 2066 7261 6374 696f  sing the fractio
-00027be0: 6e61 6c20 636f 6f72 6469 6e61 7465 206d  nal coordinate m
-00027bf0: 6174 7269 7820 746f 2063 616c 6375 6c61  atrix to calcula
-00027c00: 7465 2074 6865 2069 6e64 6963 6573 2077  te the indices w
-00027c10: 6865 6e20 7468 6520 6d61 7073 2061 7265  hen the maps are
-00027c20: 206e 6f6e 2d6f 7274 686f 676f 6e61 6c0a   non-orthogonal.
-00027c30: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-00027c40: 3a0a 2020 2020 2020 2020 2222 220a 0a20  :.        """.. 
-00027c50: 2020 2020 2020 2023 204d 6574 686f 6420         # Method 
-00027c60: 323a 2062 7920 7573 696e 6720 7468 6520  2: by using the 
-00027c70: 6672 6163 7469 6f6e 616c 2063 6f6f 7264  fractional coord
-00027c80: 696e 6174 6520 6d61 7472 6978 0a20 2020  inate matrix.   
-00027c90: 2020 2020 2023 2043 686f 7365 6e20 6173       # Chosen as
-00027ca0: 2074 6865 206d 6169 6e20 6675 6e63 7469   the main functi
-00027cb0: 6f6e 2066 6f72 2074 6865 2063 7572 7265  on for the curre
-00027cc0: 6e74 2069 6d70 6c65 6d65 6e74 6174 696f  nt implementatio
-00027cd0: 6e0a 0a20 2020 2020 2020 2023 2046 6967  n..        # Fig
-00027ce0: 7572 6520 6f75 7420 7468 6520 6f72 6465  ure out the orde
-00027cf0: 7220 6f66 2074 6865 2078 2c20 792c 207a  r of the x, y, z
-00027d00: 2062 6173 6564 206f 6e20 6372 7320 696e   based on crs in
-00027d10: 666f 2069 6e20 7468 6520 6865 6164 6572  fo in the header
-00027d20: 0a20 2020 2020 2020 2023 2063 7273 203d  .        # crs =
-00027d30: 206c 6973 7428 7365 6c66 2e6d 6170 2e68   list(self.map.h
-00027d40: 6561 6465 725b 3136 3a31 395d 290a 2020  eader[16:19]).  
-00027d50: 2020 2020 2020 6372 7320 3d20 5b73 656c        crs = [sel
-00027d60: 662e 6d61 702e 6865 6164 6572 2e6d 6170  f.map.header.map
-00027d70: 632c 2073 656c 662e 6d61 702e 6865 6164  c, self.map.head
-00027d80: 6572 2e6d 6170 722c 2073 656c 662e 6d61  er.mapr, self.ma
-00027d90: 702e 6865 6164 6572 2e6d 6170 735d 0a20  p.header.maps]. 
-00027da0: 2020 2020 2020 2023 206f 7264 696e 6473         # ordinds
-00027db0: 2073 6176 6520 7468 6520 696e 6469 6365   save the indice
-00027dc0: 7320 636f 7272 6573 706f 6469 6e67 2074  s correspoding t
-00027dd0: 6f20 782c 2079 202c 7a0a 2020 2020 2020  o x, y ,z.      
-00027de0: 2020 6f72 6469 6e64 7320 3d20 5b63 7273    ordinds = [crs
-00027df0: 2e69 6e64 6578 2831 292c 2063 7273 2e69  .index(1), crs.i
-00027e00: 6e64 6578 2832 292c 2063 7273 2e69 6e64  ndex(2), crs.ind
-00027e10: 6578 2833 295d 0a20 2020 2020 2020 2023  ex(3)].        #
-00027e20: 2061 6e67 7320 3d20 7365 6c66 2e6d 6170   angs = self.map
-00027e30: 2e68 6561 6465 725b 3133 3a31 365d 0a20  .header[13:16]. 
-00027e40: 2020 2020 2020 2061 6e67 7320 3d20 5b73         angs = [s
-00027e50: 656c 662e 6d61 702e 6865 6164 6572 2e63  elf.map.header.c
-00027e60: 656c 6c62 2e61 6c70 6861 2c20 7365 6c66  ellb.alpha, self
-00027e70: 2e6d 6170 2e68 6561 6465 722e 6365 6c6c  .map.header.cell
-00027e80: 622e 6265 7461 2c20 7365 6c66 2e6d 6170  b.beta, self.map
-00027e90: 2e68 6561 6465 722e 6365 6c6c 622e 6761  .header.cellb.ga
-00027ea0: 6d6d 615d 0a20 2020 2020 2020 206d 6174  mma].        mat
-00027eb0: 7269 7820 3d20 7365 6c66 2e6d 6170 5f6d  rix = self.map_m
-00027ec0: 6174 7269 7828 6170 6978 732c 2061 6e67  atrix(apixs, ang
-00027ed0: 7329 0a20 2020 2020 2020 2072 6573 756c  s).        resul
-00027ee0: 7420 3d20 6d61 7472 6978 2e64 6f74 286e  t = matrix.dot(n
-00027ef0: 702e 6173 6172 7261 7928 6f6e 6563 6f6f  p.asarray(onecoo
-00027f00: 7229 290a 2020 2020 2020 2020 2320 7869  r)).        # xi
-00027f10: 6e64 6578 203d 2072 6573 756c 745b 305d  ndex = result[0]
-00027f20: 202d 2073 656c 662e 6d61 702e 6865 6164   - self.map.head
-00027f30: 6572 5b34 202b 206f 7264 696e 6473 5b30  er[4 + ordinds[0
-00027f40: 5d5d 0a20 2020 2020 2020 2023 2079 696e  ]].        # yin
-00027f50: 6465 7820 3d20 7265 7375 6c74 5b31 5d20  dex = result[1] 
-00027f60: 2d20 7365 6c66 2e6d 6170 2e68 6561 6465  - self.map.heade
-00027f70: 725b 3420 2b20 6f72 6469 6e64 735b 315d  r[4 + ordinds[1]
-00027f80: 5d0a 2020 2020 2020 2020 2320 7a69 6e64  ].        # zind
-00027f90: 6578 203d 2072 6573 756c 745b 325d 202d  ex = result[2] -
-00027fa0: 2073 656c 662e 6d61 702e 6865 6164 6572   self.map.header
-00027fb0: 5b34 202b 206f 7264 696e 6473 5b32 5d5d  [4 + ordinds[2]]
-00027fc0: 0a20 2020 2020 2020 2078 696e 6465 7820  .        xindex 
-00027fd0: 3d20 7265 7375 6c74 5b30 5d20 2d20 7365  = result[0] - se
-00027fe0: 6c66 2e6d 6170 2e68 6561 6465 722e 6e78  lf.map.header.nx
-00027ff0: 7374 6172 740a 2020 2020 2020 2020 7969  start.        yi
-00028000: 6e64 6578 203d 2072 6573 756c 745b 315d  ndex = result[1]
-00028010: 202d 2073 656c 662e 6d61 702e 6865 6164   - self.map.head
-00028020: 6572 2e6e 7973 7461 7274 0a20 2020 2020  er.nystart.     
-00028030: 2020 207a 696e 6465 7820 3d20 7265 7375     zindex = resu
-00028040: 6c74 5b32 5d20 2d20 7365 6c66 2e6d 6170  lt[2] - self.map
-00028050: 2e68 6561 6465 722e 6e7a 7374 6172 740a  .header.nzstart.
-00028060: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00028070: 2878 696e 6465 782c 2079 696e 6465 782c  (xindex, yindex,
-00028080: 207a 696e 6465 7829 0a0a 0a20 2020 2064   zindex)...    d
-00028090: 6566 2070 726f 6a65 6374 696f 6e5f 696e  ef projection_in
-000280a0: 6469 6365 7328 7365 6c66 2c20 6f6e 6563  dices(self, onec
-000280b0: 6f6f 7229 3a0a 2020 2020 2020 2020 2222  oor):.        ""
-000280c0: 220a 0a20 2020 2020 2020 2020 2020 204d  "..            M
-000280d0: 6574 686f 6420 313a 2075 7369 6e67 2074  ethod 1: using t
-000280e0: 6865 2070 726f 6a65 6374 696f 6e20 7761  he projection wa
-000280f0: 7920 746f 2063 616c 6375 6c61 7465 2074  y to calculate t
-00028100: 6865 2069 6e64 6963 6573 2077 6865 6e20  he indices when 
-00028110: 7468 6520 6d61 7073 2061 7265 206e 6f6e  the maps are non
-00028120: 2d6f 7274 686f 676f 6e61 6c0a 0a20 2020  -orthogonal..   
-00028130: 2020 2020 203a 7265 7475 726e 3a20 7475       :return: tu
-00028140: 6d70 6c65 2077 6869 6368 2063 6f6e 7461  mple which conta
-00028150: 696e 7320 616c 6c20 7468 7265 6520 666c  ins all three fl
-00028160: 6f61 7420 6e65 7720 696e 6469 6365 7320  oat new indices 
-00028170: 696e 2028 782c 2079 2c20 7a29 206f 7264  in (x, y, z) ord
-00028180: 6572 0a20 2020 2020 2020 2022 2222 0a0a  er.        """..
-00028190: 2020 2020 2020 2020 6d61 7020 3d20 7365          map = se
-000281a0: 6c66 2e6d 6170 0a20 2020 2020 2020 207a  lf.map.        z
-000281b0: 6469 6d20 3d20 6d61 702e 6865 6164 6572  dim = map.header
-000281c0: 5b31 325d 0a20 2020 2020 2020 207a 6e69  [12].        zni
-000281d0: 6e74 6572 7661 6c73 203d 206d 6170 2e68  ntervals = map.h
-000281e0: 6561 6465 725b 395d 0a20 2020 2020 2020  eader[9].       
-000281f0: 207a 5f61 7069 7820 3d20 7a64 696d 202f   z_apix = zdim /
-00028200: 207a 6e69 6e74 6572 7661 6c73 0a0a 2020   znintervals..  
-00028210: 2020 2020 2020 7964 696d 203d 206d 6170        ydim = map
-00028220: 2e68 6561 6465 725b 3131 5d0a 2020 2020  .header[11].    
-00028230: 2020 2020 796e 696e 7465 7276 616c 7320      ynintervals 
-00028240: 3d20 6d61 702e 6865 6164 6572 5b38 5d0a  = map.header[8].
-00028250: 2020 2020 2020 2020 795f 6170 6978 203d          y_apix =
-00028260: 2079 6469 6d20 2f20 796e 696e 7465 7276   ydim / yninterv
-00028270: 616c 730a 0a20 2020 2020 2020 2078 6469  als..        xdi
-00028280: 6d20 3d20 6d61 702e 6865 6164 6572 5b31  m = map.header[1
-00028290: 305d 0a20 2020 2020 2020 2078 6e69 6e74  0].        xnint
-000282a0: 6572 7661 6c73 203d 206d 6170 2e68 6561  ervals = map.hea
-000282b0: 6465 725b 375d 0a20 2020 2020 2020 2078  der[7].        x
-000282c0: 5f61 7069 7820 3d20 7864 696d 202f 2078  _apix = xdim / x
-000282d0: 6e69 6e74 6572 7661 6c73 0a0a 2020 2020  nintervals..    
-000282e0: 2020 2020 7468 6574 6120 3d20 286d 6170      theta = (map
-000282f0: 2e68 6561 6465 725b 3133 5d20 2f20 3930  .header[13] / 90
-00028300: 2920 2a20 286d 6174 682e 7069 202f 2032  ) * (math.pi / 2
-00028310: 290a 2020 2020 2020 2020 6265 7461 203d  ).        beta =
-00028320: 2028 6d61 702e 6865 6164 6572 5b31 345d   (map.header[14]
-00028330: 202f 2039 3029 202a 2028 6d61 7468 2e70   / 90) * (math.p
-00028340: 6920 2f20 3229 0a20 2020 2020 2020 2067  i / 2).        g
-00028350: 616d 6d61 203d 2028 6d61 702e 6865 6164  amma = (map.head
-00028360: 6572 5b31 355d 202f 2039 3029 202a 2028  er[15] / 90) * (
-00028370: 6d61 7468 2e70 6920 2f20 3229 0a0a 2020  math.pi / 2)..  
-00028380: 2020 2020 2020 696e 7369 6465 7371 7274        insidesqrt
-00028390: 203d 2031 202b 2032 202a 206d 6174 682e   = 1 + 2 * math.
-000283a0: 636f 7328 7468 6574 6129 202a 206d 6174  cos(theta) * mat
-000283b0: 682e 636f 7328 6265 7461 2920 2a20 6d61  h.cos(beta) * ma
-000283c0: 7468 2e63 6f73 2867 616d 6d61 2920 2d20  th.cos(gamma) - 
-000283d0: 5c0a 2020 2020 2020 2020 2020 2020 2020  \.              
-000283e0: 2020 2020 2020 206d 6174 682e 636f 7328         math.cos(
-000283f0: 7468 6574 6129 202a 206d 6174 682e 636f  theta) * math.co
-00028400: 7328 7468 6574 6129 202d 205c 0a20 2020  s(theta) - \.   
-00028410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028420: 2020 6d61 7468 2e63 6f73 2862 6574 6129    math.cos(beta)
-00028430: 202a 206d 6174 682e 636f 7328 6265 7461   * math.cos(beta
-00028440: 2920 2d20 5c0a 2020 2020 2020 2020 2020  ) - \.          
-00028450: 2020 2020 2020 2020 2020 206d 6174 682e             math.
-00028460: 636f 7328 6761 6d6d 6129 202a 206d 6174  cos(gamma) * mat
-00028470: 682e 636f 7328 6761 6d6d 6129 0a0a 2020  h.cos(gamma)..  
-00028480: 2020 2020 2020 6365 6c6c 766f 6c75 6d65        cellvolume
-00028490: 203d 2078 5f61 7069 7820 2a20 795f 6170   = x_apix * y_ap
-000284a0: 6978 202a 207a 5f61 7069 7820 2a20 6d61  ix * z_apix * ma
-000284b0: 7468 2e73 7172 7428 696e 7369 6465 7371  th.sqrt(insidesq
-000284c0: 7274 290a 0a20 2020 2020 2020 2063 656c  rt)..        cel
-000284d0: 6c68 6569 6768 747a 203d 2063 656c 6c76  lheightz = cellv
-000284e0: 6f6c 756d 6520 2f20 2878 5f61 7069 7820  olume / (x_apix 
-000284f0: 2a20 795f 6170 6978 202a 206d 6174 682e  * y_apix * math.
-00028500: 7369 6e28 6761 6d6d 6129 290a 2020 2020  sin(gamma)).    
-00028510: 2020 2020 6365 6c6c 6865 6967 6874 7920      cellheighty 
-00028520: 3d20 6365 6c6c 766f 6c75 6d65 202f 2028  = cellvolume / (
-00028530: 785f 6170 6978 202a 207a 5f61 7069 7820  x_apix * z_apix 
-00028540: 2a20 6d61 7468 2e73 696e 2862 6574 6129  * math.sin(beta)
-00028550: 290a 2020 2020 2020 2020 6365 6c6c 6865  ).        cellhe
-00028560: 6967 6874 7820 3d20 6365 6c6c 766f 6c75  ightx = cellvolu
-00028570: 6d65 202f 2028 7a5f 6170 6978 202a 2079  me / (z_apix * y
-00028580: 5f61 7069 7820 2a20 6d61 7468 2e73 696e  _apix * math.sin
-00028590: 2874 6865 7461 2929 0a0a 2020 2020 2020  (theta))..      
-000285a0: 2020 2320 4669 6775 7265 206f 7574 2074    # Figure out t
-000285b0: 6865 206f 7264 6572 206f 6620 7468 6520  he order of the 
-000285c0: 782c 2079 2c20 7a20 6261 7365 6420 6f6e  x, y, z based on
-000285d0: 2063 7273 2069 6e66 6f20 696e 2074 6865   crs info in the
-000285e0: 2068 6561 6465 720a 2020 2020 2020 2020   header.        
-000285f0: 6372 7320 3d20 6c69 7374 286d 6170 2e68  crs = list(map.h
-00028600: 6561 6465 725b 3136 3a31 395d 290a 2020  eader[16:19]).  
-00028610: 2020 2020 2020 2320 6f72 6469 6e64 7320        # ordinds 
-00028620: 7361 7665 2074 6865 2069 6e64 6963 6573  save the indices
-00028630: 2063 6f72 7265 7370 6f64 696e 6720 746f   correspoding to
-00028640: 2078 2c20 7920 2c7a 0a20 2020 2020 2020   x, y ,z.       
-00028650: 206f 7264 696e 6473 203d 205b 6372 732e   ordinds = [crs.
-00028660: 696e 6465 7828 3129 2c20 6372 732e 696e  index(1), crs.in
-00028670: 6465 7828 3229 2c20 6372 732e 696e 6465  dex(2), crs.inde
-00028680: 7828 3329 5d0a 0a20 2020 2020 2020 2023  x(3)]..        #
-00028690: 204d 6568 746f 6420 313a 2043 616c 6375   Mehtod 1: Calcu
-000286a0: 6c61 7465 696e 6720 7468 6520 6469 7374  lateing the dist
-000286b0: 616e 6365 7320 6672 6f6d 2074 6865 2061  ances from the a
-000286c0: 746f 6d20 746f 2064 6966 6665 7265 6e74  tom to different
-000286d0: 2070 6c61 6e65 7328 7827 7927 2c20 7827   planes(x'y', x'
-000286e0: 7a27 2c20 7927 7a27 2920 616e 6420 6469  z', y'z') and di
-000286f0: 7669 6465 6420 6279 0a20 2020 2020 2020  vided by.       
-00028700: 2023 2054 6865 2075 6e69 7420 6365 6c6c   # The unit cell
-00028710: 2068 6569 6768 7428 6361 6c63 756c 6174   height(calculat
-00028720: 6564 2062 7920 7573 696e 6720 756e 6974  ed by using unit
-00028730: 2063 656c 6c20 766f 6c75 6d65 2064 6976   cell volume div
-00028740: 6964 6564 2062 7920 7468 6520 706c 616e  ided by the plan
-00028750: 6520 7375 7266 6163 6520 6172 6561 2920  e surface area) 
-00028760: 746f 2067 6574 2074 6865 0a20 2020 2020  to get the.     
-00028770: 2020 2023 2069 6e64 6963 6573 2c20 7468     # indices, th
-00028780: 656e 2064 6564 7563 7420 7468 6520 6f72  en deduct the or
-00028790: 6967 696e 2069 6e64 6578 2077 6869 6368  igin index which
-000287a0: 2067 6976 6520 7468 6520 6669 6e61 6c20   give the final 
-000287b0: 7265 7375 6c74 732e 2057 6865 6e20 6361  results. When ca
-000287c0: 6c63 756c 6174 696e 6720 7468 6520 7369  lculating the si
-000287d0: 676e 206f 6620 7468 650a 2020 2020 2020  gn of the.      
-000287e0: 2020 2320 6469 7374 616e 6365 2c20 6669    # distance, fi
-000287f0: 6e64 2061 2070 6c61 6e65 2070 6172 616c  nd a plane paral
-00028800: 6c65 6c20 746f 2074 6865 2070 726f 6a65  lel to the proje
-00028810: 6374 696f 6e20 706c 616e 6520 616e 6420  ction plane and 
-00028820: 6974 2070 6173 7320 7468 726f 7567 6820  it pass through 
-00028830: 7468 6520 6174 6f6d 2c20 7468 6520 6375  the atom, the cu
-00028840: 746f 6666 206f 6620 7468 6973 0a20 2020  toff of this.   
-00028850: 2020 2020 2023 2070 6c61 6e65 2061 6e64       # plane and
-00028860: 2074 6865 2063 6f72 7265 7370 6f64 696e   the correspodin
-00028870: 6720 6178 6973 2067 6976 6520 7468 6520  g axis give the 
-00028880: 6c6f 6361 7469 6f6e 206f 6620 7468 6520  location of the 
-00028890: 6174 6f6d 2070 726f 6a65 6374 696f 6e20  atom projection 
-000288a0: 6375 746f 6666 2061 7420 7468 6520 6178  cutoff at the ax
-000288b0: 6973 0a20 2020 2020 2020 2023 2028 7468  is.        # (th
-000288c0: 6973 2073 686f 756c 6420 616c 736f 2062  is should also b
-000288d0: 6520 6162 6c65 2074 6f20 7573 6564 2074  e able to used t
-000288e0: 6f20 6361 6c63 756c 6174 6520 7468 6520  o calculate the 
-000288f0: 6669 6e61 6c20 696e 6469 6365 7328 6e6f  final indices(no
-00028900: 7420 7472 6965 6429 292e 2049 6620 7468  t tried)). If th
-00028910: 6973 2070 6f69 6e74 2069 7320 6f75 7473  is point is outs
-00028920: 6964 650a 2020 2020 2020 2020 2320 7468  ide.        # th
-00028930: 6520 6e6f 726d 616c 2063 656c 6c20 6469  e normal cell di
-00028940: 6d65 6e73 696f 6e20 7261 6e67 652c 2074  mension range, t
-00028950: 6865 6e20 7468 6520 6469 7374 616e 6365  hen the distance
-00028960: 2073 686f 756c 6420 6265 206e 6567 6174   should be negat
-00028970: 6976 6520 616e 6420 7669 6365 2076 6572  ive and vice ver
-00028980: 7365 0a20 2020 2020 2020 2072 656c 6174  se.        relat
-00028990: 6976 6578 203d 206f 6e65 636f 6f72 5b30  ivex = onecoor[0
-000289a0: 5d20 2d20 6d61 702e 6865 6164 6572 5b34  ] - map.header[4
-000289b0: 395d 0a20 2020 2020 2020 2072 656c 6174  9].        relat
-000289c0: 6976 6579 203d 206f 6e65 636f 6f72 5b31  ivey = onecoor[1
-000289d0: 5d20 2d20 6d61 702e 6865 6164 6572 5b35  ] - map.header[5
-000289e0: 305d 0a20 2020 2020 2020 2072 656c 6174  0].        relat
-000289f0: 6976 657a 203d 206f 6e65 636f 6f72 5b32  ivez = onecoor[2
-00028a00: 5d20 2d20 6d61 702e 6865 6164 6572 5b35  ] - map.header[5
-00028a10: 315d 0a0a 2020 2020 2020 2020 2320 5a20  1]..        # Z 
-00028a20: 696e 6465 7820 6279 2075 7369 6e67 2074  index by using t
-00028a30: 6865 2072 656c 6174 6976 657a 202f 2063  he relativez / c
-00028a40: 656c 6c68 6569 6768 747a 0a20 2020 2020  ellheightz.     
-00028a50: 2020 207a 696e 6420 3d20 7265 6c61 7469     zind = relati
-00028a60: 7665 7a20 2f20 6365 6c6c 6865 6967 6874  vez / cellheight
-00028a70: 7a0a 2020 2020 2020 2020 7a69 6e64 6578  z.        zindex
-00028a80: 203d 207a 696e 6420 2d20 6d61 702e 6865   = zind - map.he
-00028a90: 6164 6572 5b34 202b 206f 7264 696e 6473  ader[4 + ordinds
-00028aa0: 5b32 5d5d 0a0a 2020 2020 2020 2020 2320  [2]]..        # 
-00028ab0: 5820 696e 6465 7820 6279 2063 616c 6375  X index by calcu
-00028ac0: 6c61 7469 6e67 2074 6865 2070 6c61 6e65  lating the plane
-00028ad0: 2066 6972 7374 2061 6e64 2074 6865 6e20   first and then 
-00028ae0: 6361 6c63 756c 6174 6520 7468 6520 6469  calculate the di
-00028af0: 7374 616e 6365 2066 726f 6d20 6174 6f6d  stance from atom
-00028b00: 2074 6f20 706c 616e 650a 2020 2020 2020   to plane.      
-00028b10: 2020 2320 506c 616e 6520 7827 7a27 0a20    # Plane x'z'. 
-00028b20: 2020 2020 2020 2023 2041 7820 2b20 4279         # Ax + By
-00028b30: 202b 2043 7a20 2b20 4420 3d20 3020 7769   + Cz + D = 0 wi
-00028b40: 7468 2074 6872 6565 2064 6174 6120 706f  th three data po
-00028b50: 696e 7473 3a20 2830 2c20 302c 2030 292c  ints: (0, 0, 0),
-00028b60: 2028 622c 2030 2c20 3029 2c0a 2020 2020   (b, 0, 0),.    
-00028b70: 2020 2020 2320 2861 2a63 6f73 2861 6c70      # (a*cos(alp
-00028b80: 6861 292c 2073 7172 7428 612a 2a32 202d  ha), sqrt(a**2 -
-00028b90: 2028 6365 6c6c 6c68 7a29 2a2a 3220 2d20   (celllhz)**2 - 
-00028ba0: 2861 2a63 6f73 2861 6c70 6861 292a 2a32  (a*cos(alpha)**2
-00028bb0: 292c 2063 656c 6c68 7a29 2c20 7827 2075  ), cellhz), x' u
-00028bc0: 6e69 7420 6365 6c6c 206c 656e 6774 6820  nit cell length 
-00028bd0: 6973 2062 2c20 616c 7068 6120 6973 0a20  is b, alpha is. 
-00028be0: 2020 2020 2020 2023 2074 6865 2061 6e67         # the ang
-00028bf0: 6c65 2062 6574 7765 656e 2078 2720 616e  le between x' an
-00028c00: 6420 7a27 2877 6869 6368 2061 7265 2074  d z'(which are t
-00028c10: 6865 2063 656c 6c20 6178 6573 290a 2020  he cell axes).  
-00028c20: 2020 2020 2020 2320 4279 2075 7369 6e67        # By using
-00028c30: 2074 6865 7365 2074 6872 6565 2070 6f69   these three poi
-00028c40: 6e74 7320 7468 6520 706c 616e 6520 6f66  nts the plane of
-00028c50: 2078 277a 2720 6361 6e20 6265 2063 616c   x'z' can be cal
-00028c60: 6375 6c61 7465 640a 2020 2020 2020 2020  culated.        
-00028c70: 2320 413d 302c 2042 3d63 656c 6c68 7a2c  # A=0, B=cellhz,
-00028c80: 2043 203d 202d 7371 7274 2861 2a2a 3220   C = -sqrt(a**2 
-00028c90: 2d20 2863 656c 6c68 7a29 2a2a 3220 2d20  - (cellhz)**2 - 
-00028ca0: 2861 2a63 6f73 2861 6c70 6861 2929 2a2a  (a*cos(alpha))**
-00028cb0: 3229 2c20 443d 300a 2020 2020 2020 2020  2), D=0.        
-00028cc0: 4120 3d20 300a 2020 2020 2020 2020 4220  A = 0.        B 
-00028cd0: 3d20 6365 6c6c 6865 6967 6874 7a0a 2020  = cellheightz.  
-00028ce0: 2020 2020 2020 4320 3d20 2d6d 6174 682e        C = -math.
-00028cf0: 7371 7274 287a 5f61 7069 7820 2a2a 2032  sqrt(z_apix ** 2
-00028d00: 202d 2063 656c 6c68 6569 6768 747a 202a   - cellheightz *
-00028d10: 2a20 3220 2d20 287a 5f61 7069 7820 2a20  * 2 - (z_apix * 
-00028d20: 6d61 7468 2e63 6f73 2862 6574 6129 2920  math.cos(beta)) 
-00028d30: 2a2a 2032 290a 2020 2020 2020 2020 4420  ** 2).        D 
-00028d40: 3d20 300a 0a20 2020 2020 2020 2023 2064  = 0..        # d
-00028d50: 6973 7461 6e63 6520 6672 6f6d 2061 746f  istance from ato
-00028d60: 6d20 746f 2078 277a 2720 706c 616e 653a  m to x'z' plane:
-00028d70: 0a20 2020 2020 2020 2023 2020 2020 2020  .        #      
-00028d80: 2020 207c 4178 202b 2042 7920 2b20 437a     |Ax + By + Cz
-00028d90: 202b 2044 7c0a 2020 2020 2020 2020 2320   + D|.        # 
-00028da0: 6420 3d20 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  d = ------------
-00028db0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00028dc0: 2d0a 2020 2020 2020 2020 2320 2020 2020  -.        #     
-00028dd0: 2020 7371 7274 2841 2a2a 3220 2b20 422a    sqrt(A**2 + B*
-00028de0: 2a32 202b 2043 2a2a 3229 0a20 2020 2020  *2 + C**2).     
-00028df0: 2020 2064 7920 3d20 6d61 7468 2e66 6162     dy = math.fab
-00028e00: 7328 4220 2a20 7265 6c61 7469 7665 7920  s(B * relativey 
-00028e10: 2b20 4320 2a20 7265 6c61 7469 7665 7a29  + C * relativez)
-00028e20: 202f 206d 6174 682e 7371 7274 2841 202a   / math.sqrt(A *
-00028e30: 2a20 3220 2b20 4220 2a2a 2032 202b 2043  * 2 + B ** 2 + C
-00028e40: 202a 2a20 3229 0a0a 2020 2020 2020 2020   ** 2)..        
-00028e50: 2320 5468 6520 7061 7261 6c6c 656c 2070  # The parallel p
-00028e60: 6c61 6e20 7768 6963 6820 7061 7373 2074  lan which pass t
-00028e70: 6865 2061 746f 6d20 616e 6420 696e 7465  he atom and inte
-00028e80: 7273 6563 7420 7769 7468 2074 6865 2078  rsect with the x
-00028e90: 2069 733a 0a20 2020 2020 2020 2023 2041   is:.        # A
-00028ea0: 7829 202b 2042 2879 202b 2061 2920 2b20  x) + B(y + a) + 
-00028eb0: 437a 202b 2044 203d 2030 0a20 2020 2020  Cz + D = 0.     
-00028ec0: 2020 2023 2061 203d 202d 2841 7820 2b20     # a = -(Ax + 
-00028ed0: 4279 202b 2043 7a20 2b20 4429 2f41 0a20  By + Cz + D)/A. 
-00028ee0: 2020 2020 2020 2023 2078 6375 7420 3d20         # xcut = 
-00028ef0: 2d61 0a20 2020 2020 2020 2079 6375 7420  -a.        ycut 
-00028f00: 3d20 2d28 4120 2a20 6f6e 6563 6f6f 725b  = -(A * onecoor[
-00028f10: 305d 202b 206f 6e65 636f 6f72 5b31 5d20  0] + onecoor[1] 
-00028f20: 2b20 2843 202f 2042 2920 2a20 6f6e 6563  + (C / B) * onec
-00028f30: 6f6f 725b 325d 290a 2020 2020 2020 2020  oor[2]).        
-00028f40: 7963 7574 203d 202d 7963 7574 0a20 2020  ycut = -ycut.   
-00028f50: 2020 2020 2069 6620 7963 7574 203c 2030       if ycut < 0
-00028f60: 206f 7220 7963 7574 203e 206d 6170 2e68   or ycut > map.h
-00028f70: 6561 6465 725b 3020 2b20 6f72 6469 6e64  eader[0 + ordind
-00028f80: 735b 315d 5d20 2a20 795f 6170 6978 202a  s[1]] * y_apix *
-00028f90: 206d 6174 682e 7369 6e28 6761 6d6d 6129   math.sin(gamma)
-00028fa0: 3a0a 2020 2020 2020 2020 2020 2020 6479  :.            dy
-00028fb0: 203d 202d 6479 0a0a 2020 2020 2020 2020   = -dy..        
-00028fc0: 7969 6e64 203d 2064 7920 2f20 6365 6c6c  yind = dy / cell
-00028fd0: 6865 6967 6874 790a 2020 2020 2020 2020  heighty.        
-00028fe0: 7969 6e64 6578 203d 2079 696e 6420 2d20  yindex = yind - 
-00028ff0: 6d61 702e 6865 6164 6572 5b34 202b 206f  map.header[4 + o
-00029000: 7264 696e 6473 5b31 5d5d 0a0a 2020 2020  rdinds[1]]..    
-00029010: 2020 2020 2320 506c 616e 6520 7a27 7927      # Plane z'y'
-00029020: 0a20 2020 2020 2020 2023 2041 7820 2b20  .        # Ax + 
-00029030: 4279 202b 2043 7a20 2b20 4420 3d20 3020  By + Cz + D = 0 
-00029040: 7769 7468 2074 6872 6565 2064 6174 6120  with three data 
-00029050: 706f 696e 7473 3a20 2830 2c20 302c 2030  points: (0, 0, 0
-00029060: 292c 2028 612a 636f 7328 616c 7068 6129  ), (a*cos(alpha)
-00029070: 2c0a 2020 2020 2020 2020 2320 7371 7274  ,.        # sqrt
-00029080: 2861 2a2a 3220 2d20 2863 656c 6c68 7a29  (a**2 - (cellhz)
-00029090: 2a2a 3220 2d20 2861 2a63 6f73 2861 6c70  **2 - (a*cos(alp
-000290a0: 6861 292a 2a32 292c 2063 656c 6c68 7a29  ha)**2), cellhz)
-000290b0: 2c0a 2020 2020 2020 2020 2320 2864 2a63  ,.        # (d*c
-000290c0: 6f73 2867 616d 6d61 292c 2064 2a73 696e  os(gamma), d*sin
-000290d0: 2867 616d 6d61 292c 2030 290a 2020 2020  (gamma), 0).    
-000290e0: 2020 2020 2320 6265 7461 2069 7320 7468      # beta is th
-000290f0: 6520 616e 676c 6520 6265 7477 6565 6e20  e angle between 
-00029100: 7827 2061 6e64 207a 273b 2067 616d 6d61  x' and z'; gamma
-00029110: 2069 7320 7468 6520 616e 676c 6520 6265   is the angle be
-00029120: 7477 6565 6e20 7827 2061 6e64 2079 273b  tween x' and y';
-00029130: 2064 2069 7320 7468 6520 6365 6c6c 2075   d is the cell u
-00029140: 6e69 7420 6c65 6e67 7468 0a20 2020 2020  nit length.     
-00029150: 2020 2023 2061 6c6f 6e67 2079 270a 2020     # along y'.  
-00029160: 2020 2020 2020 2320 5573 696e 6720 7468        # Using th
-00029170: 6573 6520 7468 7265 6520 706f 696e 7473  ese three points
-00029180: 2061 2070 6c61 6e65 2063 616e 2062 6520   a plane can be 
-00029190: 6361 6c63 756c 6174 6564 0a20 2020 2020  calculated.     
-000291a0: 2020 2023 2041 3d2d 7467 2862 6574 6129     # A=-tg(beta)
-000291b0: 2c20 4220 3d20 312c 2044 3d30 2c0a 2020  , B = 1, D=0,.  
-000291c0: 2020 2020 2020 2320 2020 2020 2061 2a63        #      a*c
-000291d0: 6f73 2861 6c70 6861 292a 7467 2862 6574  os(alpha)*tg(bet
-000291e0: 6129 202d 2074 0a20 2020 2020 2020 2023  a) - t.        #
-000291f0: 2043 203d 202d 2d2d 2d2d 2d2d 2d2d 2d2d   C = -----------
-00029200: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00029210: 202c 2020 2020 2074 203d 2073 7172 7428   ,     t = sqrt(
-00029220: 612a 2a32 202d 2028 6365 6c6c 687a 292a  a**2 - (cellhz)*
-00029230: 2a32 202d 2028 612a 636f 7328 616c 7068  *2 - (a*cos(alph
-00029240: 6129 292a 2a32 290a 2020 2020 2020 2020  a))**2).        
-00029250: 2320 2020 2020 2020 2020 2020 2063 656c  #            cel
-00029260: 6c68 7a0a 2020 2020 2020 2020 2320 4120  lhz.        # A 
-00029270: 3d20 2d6d 6174 682e 7461 6e28 6761 6d6d  = -math.tan(gamm
-00029280: 6129 0a20 2020 2020 2020 2023 2042 203d  a).        # B =
-00029290: 2031 0a20 2020 2020 2020 2023 2044 203d   1.        # D =
-000292a0: 2030 0a20 2020 2020 2020 2023 2074 203d   0.        # t =
-000292b0: 206d 6174 682e 7371 7274 287a 5f61 7069   math.sqrt(z_api
-000292c0: 782a 2a32 202d 2063 656c 6c68 6569 6768  x**2 - cellheigh
-000292d0: 747a 2a2a 3220 2d20 287a 5f61 7069 782a  tz**2 - (z_apix*
-000292e0: 6d61 7468 2e63 6f73 2862 6574 6129 292a  math.cos(beta))*
-000292f0: 2a32 290a 2020 2020 2020 2020 2320 4320  *2).        # C 
-00029300: 3d20 287a 5f61 7069 7820 2a20 6d61 7468  = (z_apix * math
-00029310: 2e63 6f73 2862 6574 6129 2a6d 6174 682e  .cos(beta)*math.
-00029320: 7461 6e28 6761 6d6d 6129 202d 2074 2920  tan(gamma) - t) 
-00029330: 2f20 6365 6c6c 6865 6967 6874 7a0a 0a20  / cellheightz.. 
-00029340: 2020 2020 2020 2069 6620 6d61 702e 6865         if map.he
-00029350: 6164 6572 5b31 355d 203d 3d20 3930 2e3a  ader[15] == 90.:
-00029360: 0a20 2020 2020 2020 2020 2020 2073 696e  .            sin
-00029370: 6761 6d6d 6120 3d20 312e 0a20 2020 2020  gamma = 1..     
-00029380: 2020 2020 2020 2063 6f73 6761 6d6d 6120         cosgamma 
-00029390: 3d20 302e 0a20 2020 2020 2020 2065 6c73  = 0..        els
-000293a0: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
-000293b0: 696e 6761 6d6d 6120 3d20 6d61 7468 2e73  ingamma = math.s
-000293c0: 696e 2867 616d 6d61 290a 2020 2020 2020  in(gamma).      
-000293d0: 2020 2020 2020 636f 7367 616d 6d61 203d        cosgamma =
-000293e0: 206d 6174 682e 636f 7328 6761 6d6d 6129   math.cos(gamma)
-000293f0: 0a0a 2020 2020 2020 2020 6966 206d 6170  ..        if map
-00029400: 2e68 6561 6465 725b 3134 5d20 3d3d 2039  .header[14] == 9
-00029410: 302e 3a0a 2020 2020 2020 2020 2020 2020  0.:.            
-00029420: 7369 6e67 6265 7461 203d 2031 2e0a 2020  singbeta = 1..  
-00029430: 2020 2020 2020 2020 2020 636f 7362 6574            cosbet
-00029440: 6120 3d20 302e 0a20 2020 2020 2020 2065  a = 0..        e
-00029450: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00029460: 2073 696e 6265 7461 203d 206d 6174 682e   sinbeta = math.
-00029470: 7369 6e28 6265 7461 290a 2020 2020 2020  sin(beta).      
-00029480: 2020 2020 2020 636f 7362 6574 6120 3d20        cosbeta = 
-00029490: 6d61 7468 2e63 6f73 2862 6574 6129 0a0a  math.cos(beta)..
-000294a0: 2020 2020 2020 2020 4120 3d20 2d73 696e          A = -sin
-000294b0: 6761 6d6d 610a 2020 2020 2020 2020 4220  gamma.        B 
-000294c0: 3d20 636f 7367 616d 6d61 0a20 2020 2020  = cosgamma.     
-000294d0: 2020 2044 203d 2030 0a20 2020 2020 2020     D = 0.       
-000294e0: 2074 203d 206d 6174 682e 7371 7274 287a   t = math.sqrt(z
-000294f0: 5f61 7069 7820 2a2a 2032 202d 2063 656c  _apix ** 2 - cel
-00029500: 6c68 6569 6768 747a 202a 2a20 3220 2d20  lheightz ** 2 - 
-00029510: 287a 5f61 7069 7820 2a20 636f 7362 6574  (z_apix * cosbet
-00029520: 6129 202a 2a20 3229 0a20 2020 2020 2020  a) ** 2).       
-00029530: 2043 203d 2028 7a5f 6170 6978 202a 2063   C = (z_apix * c
-00029540: 6f73 6265 7461 202a 2073 696e 6761 6d6d  osbeta * singamm
-00029550: 6120 2d20 7420 2a20 636f 7367 616d 6d61  a - t * cosgamma
-00029560: 2920 2f20 6365 6c6c 6865 6967 6874 7a0a  ) / cellheightz.
-00029570: 0a20 2020 2020 2020 2023 2064 6973 7461  .        # dista
-00029580: 6e63 6520 6672 6f6d 2061 746f 6d20 746f  nce from atom to
-00029590: 207a 2779 2720 706c 616e 653a 0a20 2020   z'y' plane:.   
-000295a0: 2020 2020 2023 2020 2020 2020 2020 207c       #         |
-000295b0: 4178 202b 2042 7920 2b20 437a 202b 2044  Ax + By + Cz + D
-000295c0: 7c0a 2020 2020 2020 2020 2320 6420 3d20  |.        # d = 
-000295d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000295e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020  -------------.  
-000295f0: 2020 2020 2020 2320 2020 2020 2020 7371        #       sq
-00029600: 7274 2841 2a2a 3220 2b20 422a 2a32 202b  rt(A**2 + B**2 +
-00029610: 2043 2a2a 3229 0a20 2020 2020 2020 2064   C**2).        d
-00029620: 7820 3d20 6d61 7468 2e66 6162 7328 4120  x = math.fabs(A 
-00029630: 2a20 7265 6c61 7469 7665 7820 2b20 4220  * relativex + B 
-00029640: 2a20 7265 6c61 7469 7665 7920 2b20 4320  * relativey + C 
-00029650: 2a20 7265 6c61 7469 7665 7a29 202f 206d  * relativez) / m
-00029660: 6174 682e 7371 7274 2841 202a 2a20 3220  ath.sqrt(A ** 2 
-00029670: 2b20 4220 2a2a 2032 202b 2043 202a 2a20  + B ** 2 + C ** 
-00029680: 3229 0a20 2020 2020 2020 2078 6375 7420  2).        xcut 
-00029690: 3d20 282d 286f 6e65 636f 6f72 5b30 5d20  = (-(onecoor[0] 
-000296a0: 2b20 2842 202f 2041 2920 2a20 6f6e 6563  + (B / A) * onec
-000296b0: 6f6f 725b 315d 202b 2028 4320 2f20 4129  oor[1] + (C / A)
-000296c0: 202a 206f 6e65 636f 6f72 5b32 5d29 290a   * onecoor[2])).
-000296d0: 2020 2020 2020 2020 7863 7574 203d 202d          xcut = -
-000296e0: 7863 7574 0a20 2020 2020 2020 2069 6620  xcut.        if 
-000296f0: 7863 7574 203c 2030 206f 7220 7863 7574  xcut < 0 or xcut
-00029700: 203e 206d 6170 2e68 6561 6465 725b 3020   > map.header[0 
-00029710: 2b20 6f72 6469 6e64 735b 305d 5d20 2a20  + ordinds[0]] * 
-00029720: 785f 6170 6978 3a0a 2020 2020 2020 2020  x_apix:.        
-00029730: 2020 2020 6478 203d 202d 6478 0a20 2020      dx = -dx.   
-00029740: 2020 2020 2078 696e 6420 3d20 6478 202f       xind = dx /
-00029750: 2063 656c 6c68 6569 6768 7478 0a20 2020   cellheightx.   
-00029760: 2020 2020 2078 696e 6465 7820 3d20 7869       xindex = xi
-00029770: 6e64 202d 206d 6170 2e68 6561 6465 725b  nd - map.header[
-00029780: 3420 2b20 6f72 6469 6e64 735b 305d 5d0a  4 + ordinds[0]].
-00029790: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-000297a0: 2878 696e 6465 782c 2079 696e 6465 782c  (xindex, yindex,
-000297b0: 207a 696e 6465 7829 0a0a 0a20 2020 2064   zindex)...    d
-000297c0: 6566 205f 5f67 6574 696e 6469 6365 7328  ef __getindices(
-000297d0: 7365 6c66 2c20 6f6e 6563 6f6f 7229 3a0a  self, onecoor):.
-000297e0: 2020 2020 2020 2020 2222 220a 0a20 2020          """..   
-000297f0: 2020 2020 2020 2020 2046 696e 6420 6f6e           Find on
-00029800: 6520 6174 6f6d 2773 2069 6e64 6963 6573  e atom's indices
-00029810: 2063 6f72 7265 7370 6f64 696e 6720 746f   correspoding to
-00029820: 2069 7473 2063 7562 6963 206f 7220 706c   its cubic or pl
-00029830: 616e 650a 2020 2020 2020 2020 2020 2020  ane.            
-00029840: 7468 6520 3820 2863 7562 6963 2920 6f72  the 8 (cubic) or
-00029850: 2034 2028 706c 616e 6529 2069 6e64 6963   4 (plane) indic
-00029860: 6573 2061 7265 2073 6176 6564 2069 6e20  es are saved in 
-00029870: 696e 6469 6365 7320 7661 7269 6162 6c65  indices variable
-00029880: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
-00029890: 206d 6170 3a20 4465 6e73 6974 7920 6d61   map: Density ma
-000298a0: 7020 696e 7374 616e 6365 2066 726f 6d20  p instance from 
-000298b0: 5445 4d50 792e 4d61 7050 6172 7365 720a  TEMPy.MapParser.
-000298c0: 2020 2020 2020 2020 3a70 6172 616d 206f          :param o
-000298d0: 6e65 636f 6f72 3a20 4c69 7374 2063 6f6e  necoor: List con
-000298e0: 7461 696e 7320 7468 6520 6174 6f6d 2063  tains the atom c
-000298f0: 6f6f 7264 696e 6174 6573 2069 6e20 2878  oordinates in (x
-00029900: 2c20 792c 207a 2920 6f72 6465 720a 2020  , y, z) order.  
-00029910: 2020 2020 2020 3a72 6574 7572 6e3a 2054        :return: T
-00029920: 7570 6c65 2063 6f6e 7461 696e 7320 7477  uple contains tw
-00029930: 6f20 6c69 7374 206f 6620 696e 6465 783a  o list of index:
-00029940: 2066 6972 7374 2068 6173 2074 6865 2038   first has the 8
-00029950: 206f 7220 3420 696e 6469 6365 7320 696e   or 4 indices in
-00029960: 2074 6865 2063 7562 6963 3b0a 2020 2020   the cubic;.    
-00029970: 2020 2020 2020 2020 2020 2020 2073 6563               sec
-00029980: 6f6e 6420 6861 7320 7468 6520 666c 6f61  ond has the floa
-00029990: 7420 696e 6465 7820 6f66 2074 6865 2069  t index of the i
-000299a0: 6e70 7574 2061 746f 6d0a 0a20 2020 2020  nput atom..     
-000299b0: 2020 2022 2222 0a0a 2020 2020 2020 2020     """..        
-000299c0: 2320 466f 7220 6e6f 6e2d 6375 6269 6320  # For non-cubic 
-000299d0: 6f72 2073 6b65 7765 6420 6465 6e73 6974  or skewed densit
-000299e0: 7920 6d61 7073 2c20 7468 6579 206d 6967  y maps, they mig
-000299f0: 6874 2068 6176 6520 6469 6666 6572 656e  ht have differen
-00029a00: 7420 6170 6978 206f 6e20 6469 6666 6572  t apix on differ
-00029a10: 656e 7420 6178 6973 6573 0a20 2020 2020  ent axises.     
-00029a20: 2020 206d 6170 203d 2073 656c 662e 6d61     map = self.ma
-00029a30: 700a 2020 2020 2020 2020 7a64 696d 203d  p.        zdim =
-00029a40: 206d 6170 2e68 6561 6465 722e 6365 6c6c   map.header.cell
-00029a50: 612e 7a0a 2020 2020 2020 2020 7a6e 696e  a.z.        znin
-00029a60: 7465 7276 616c 7320 3d20 6d61 702e 6865  tervals = map.he
-00029a70: 6164 6572 2e6d 7a0a 2020 2020 2020 2020  ader.mz.        
-00029a80: 7a5f 6170 6978 203d 207a 6469 6d20 2f20  z_apix = zdim / 
-00029a90: 7a6e 696e 7465 7276 616c 730a 0a20 2020  znintervals..   
-00029aa0: 2020 2020 2079 6469 6d20 3d20 6d61 702e       ydim = map.
-00029ab0: 6865 6164 6572 2e63 656c 6c61 2e79 0a20  header.cella.y. 
-00029ac0: 2020 2020 2020 2079 6e69 6e74 6572 7661         yninterva
-00029ad0: 6c73 203d 206d 6170 2e68 6561 6465 722e  ls = map.header.
-00029ae0: 6d79 0a20 2020 2020 2020 2079 5f61 7069  my.        y_api
-00029af0: 7820 3d20 7964 696d 202f 2079 6e69 6e74  x = ydim / ynint
-00029b00: 6572 7661 6c73 0a0a 2020 2020 2020 2020  ervals..        
-00029b10: 7864 696d 203d 206d 6170 2e68 6561 6465  xdim = map.heade
-00029b20: 722e 6365 6c6c 612e 780a 2020 2020 2020  r.cella.x.      
-00029b30: 2020 786e 696e 7465 7276 616c 7320 3d20    xnintervals = 
-00029b40: 6d61 702e 6865 6164 6572 2e6d 780a 2020  map.header.mx.  
-00029b50: 2020 2020 2020 785f 6170 6978 203d 2078        x_apix = x
-00029b60: 6469 6d20 2f20 786e 696e 7465 7276 616c  dim / xninterval
-00029b70: 730a 0a20 2020 2020 2020 206d 6170 5f7a  s..        map_z
-00029b80: 7369 7a65 203d 206d 6170 2e68 6561 6465  size = map.heade
-00029b90: 722e 6e7a 0a20 2020 2020 2020 206d 6170  r.nz.        map
-00029ba0: 5f79 7369 7a65 203d 206d 6170 2e68 6561  _ysize = map.hea
-00029bb0: 6465 722e 6e79 0a20 2020 2020 2020 206d  der.ny.        m
-00029bc0: 6170 5f78 7369 7a65 203d 206d 6170 2e68  ap_xsize = map.h
-00029bd0: 6561 6465 722e 6e78 0a0a 2020 2020 2020  eader.nx..      
-00029be0: 2020 2320 6966 206d 6170 2e68 6561 6465    # if map.heade
-00029bf0: 725b 3133 5d20 3d3d 206d 6170 2e68 6561  r[13] == map.hea
-00029c00: 6465 725b 3134 5d20 3d3d 206d 6170 2e68  der[14] == map.h
-00029c10: 6561 6465 725b 3135 5d20 3d3d 2039 302e  eader[15] == 90.
-00029c20: 3a0a 2020 2020 2020 2020 6966 206d 6170  :.        if map
-00029c30: 2e68 6561 6465 722e 6365 6c6c 622e 616c  .header.cellb.al
-00029c40: 7068 6120 3d3d 206d 6170 2e68 6561 6465  pha == map.heade
-00029c50: 722e 6365 6c6c 622e 6265 7461 203d 3d20  r.cellb.beta == 
-00029c60: 6d61 702e 6865 6164 6572 2e63 656c 6c62  map.header.cellb
-00029c70: 2e67 616d 6d61 203d 3d20 3930 2e3a 0a20  .gamma == 90.:. 
-00029c80: 2020 2020 2020 2020 2020 2023 2046 6967             # Fig
-00029c90: 7572 6520 6f75 7420 7468 6520 6f72 6465  ure out the orde
-00029ca0: 7220 6f66 2074 6865 2078 2c20 792c 207a  r of the x, y, z
-00029cb0: 2062 6173 6564 206f 6e20 6372 7320 696e   based on crs in
-00029cc0: 666f 2069 6e20 7468 6520 6865 6164 6572  fo in the header
-00029cd0: 0a20 2020 2020 2020 2020 2020 2023 2063  .            # c
-00029ce0: 7273 203d 206c 6973 7428 6d61 702e 6865  rs = list(map.he
-00029cf0: 6164 6572 5b31 363a 3139 5d29 0a20 2020  ader[16:19]).   
-00029d00: 2020 2020 2020 2020 2063 7273 203d 205b           crs = [
-00029d10: 6d61 702e 6865 6164 6572 2e6d 6170 632c  map.header.mapc,
-00029d20: 206d 6170 2e68 6561 6465 722e 6d61 7072   map.header.mapr
-00029d30: 2c20 6d61 702e 6865 6164 6572 2e6d 6170  , map.header.map
-00029d40: 735d 0a20 2020 2020 2020 2020 2020 2023  s].            #
-00029d50: 206f 7264 696e 6473 2073 6176 6520 7468   ordinds save th
-00029d60: 6520 696e 6469 6365 7320 636f 7272 6573  e indices corres
-00029d70: 706f 6469 6e67 2074 6f20 782c 2079 202c  poding to x, y ,
-00029d80: 7a0a 2020 2020 2020 2020 2020 2020 6f72  z.            or
-00029d90: 6469 6e64 7320 3d20 5b63 7273 2e69 6e64  dinds = [crs.ind
-00029da0: 6578 2831 292c 2063 7273 2e69 6e64 6578  ex(1), crs.index
-00029db0: 2832 292c 2063 7273 2e69 6e64 6578 2833  (2), crs.index(3
-00029dc0: 295d 0a0a 2020 2020 2020 2020 2020 2020  )]..            
-00029dd0: 7a69 6e64 6578 203d 2066 6c6f 6174 286f  zindex = float(o
-00029de0: 6e65 636f 6f72 5b32 5d20 2d20 6d61 702e  necoor[2] - map.
-00029df0: 6865 6164 6572 2e6f 7269 6769 6e2e 7a29  header.origin.z)
-00029e00: 202f 207a 5f61 7069 7820 2d20 6d61 702e   / z_apix - map.
-00029e10: 6865 6164 6572 2e6e 7a73 7461 7274 0a20  header.nzstart. 
-00029e20: 2020 2020 2020 2020 2020 2079 696e 6465             yinde
-00029e30: 7820 3d20 666c 6f61 7428 6f6e 6563 6f6f  x = float(onecoo
-00029e40: 725b 315d 202d 206d 6170 2e68 6561 6465  r[1] - map.heade
-00029e50: 722e 6f72 6967 696e 2e79 2920 2f20 795f  r.origin.y) / y_
-00029e60: 6170 6978 202d 206d 6170 2e68 6561 6465  apix - map.heade
-00029e70: 722e 6e79 7374 6172 740a 2020 2020 2020  r.nystart.      
-00029e80: 2020 2020 2020 7869 6e64 6578 203d 2066        xindex = f
-00029e90: 6c6f 6174 286f 6e65 636f 6f72 5b30 5d20  loat(onecoor[0] 
-00029ea0: 2d20 6d61 702e 6865 6164 6572 2e6f 7269  - map.header.ori
-00029eb0: 6769 6e2e 7829 202f 2078 5f61 7069 7820  gin.x) / x_apix 
-00029ec0: 2d20 6d61 702e 6865 6164 6572 2e6e 7873  - map.header.nxs
-00029ed0: 7461 7274 0a0a 2020 2020 2020 2020 2020  tart..          
-00029ee0: 2020 7a66 6c6f 6f72 203d 2069 6e74 2866    zfloor = int(f
-00029ef0: 6c6f 6f72 287a 696e 6465 7829 290a 2020  loor(zindex)).  
-00029f00: 2020 2020 2020 2020 2020 6966 207a 666c            if zfl
-00029f10: 6f6f 7220 3e3d 206d 6170 5f7a 7369 7a65  oor >= map_zsize
-00029f20: 202d 2031 3a0a 2020 2020 2020 2020 2020   - 1:.          
-00029f30: 2020 2020 2020 7a63 6569 6c20 3d20 7a66        zceil = zf
-00029f40: 6c6f 6f72 0a20 2020 2020 2020 2020 2020  loor.           
-00029f50: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00029f60: 2020 2020 2020 207a 6365 696c 203d 207a         zceil = z
-00029f70: 666c 6f6f 7220 2b20 310a 0a20 2020 2020  floor + 1..     
-00029f80: 2020 2020 2020 2079 666c 6f6f 7220 3d20         yfloor = 
-00029f90: 696e 7428 666c 6f6f 7228 7969 6e64 6578  int(floor(yindex
-00029fa0: 2929 0a20 2020 2020 2020 2020 2020 2069  )).            i
-00029fb0: 6620 7966 6c6f 6f72 203e 3d20 6d61 705f  f yfloor >= map_
-00029fc0: 7973 697a 6520 2d20 313a 0a20 2020 2020  ysize - 1:.     
-00029fd0: 2020 2020 2020 2020 2020 2079 6365 696c             yceil
-00029fe0: 203d 2079 666c 6f6f 720a 2020 2020 2020   = yfloor.      
-00029ff0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0002a000: 2020 2020 2020 2020 2020 2020 7963 6569              ycei
-0002a010: 6c20 3d20 7966 6c6f 6f72 202b 2031 0a0a  l = yfloor + 1..
-0002a020: 2020 2020 2020 2020 2020 2020 7866 6c6f              xflo
-0002a030: 6f72 203d 2069 6e74 2866 6c6f 6f72 2878  or = int(floor(x
-0002a040: 696e 6465 7829 290a 2020 2020 2020 2020  index)).        
-0002a050: 2020 2020 6966 2078 666c 6f6f 7220 3e3d      if xfloor >=
-0002a060: 206d 6170 5f78 7369 7a65 202d 2031 3a0a   map_xsize - 1:.
-0002a070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a080: 7863 6569 6c20 3d20 7866 6c6f 6f72 0a20  xceil = xfloor. 
-0002a090: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0002a0a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002a0b0: 2078 6365 696c 203d 2078 666c 6f6f 7220   xceil = xfloor 
-0002a0c0: 2b20 310a 2020 2020 2020 2020 656c 7365  + 1.        else
-0002a0d0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-0002a0e0: 4d65 7468 6f64 2032 3a20 6279 2075 7369  Method 2: by usi
-0002a0f0: 6e67 2074 6865 2066 7261 6374 696f 6e61  ng the fractiona
-0002a100: 6c20 636f 6f72 6469 6e61 7465 206d 6174  l coordinate mat
-0002a110: 7269 780a 2020 2020 2020 2020 2020 2020  rix.            
-0002a120: 2320 4368 6f73 656e 2061 7320 7468 6520  # Chosen as the 
-0002a130: 7072 696d 6172 7920 666f 7220 7468 6520  primary for the 
-0002a140: 6375 7272 656e 7420 696d 706c 656d 656e  current implemen
-0002a150: 7461 7469 6f6e 0a20 2020 2020 2020 2020  tation.         
-0002a160: 2020 2061 7069 7873 203d 205b 785f 6170     apixs = [x_ap
-0002a170: 6978 2c20 795f 6170 6978 2c20 7a5f 6170  ix, y_apix, z_ap
-0002a180: 6978 5d0a 2020 2020 2020 2020 2020 2020  ix].            
-0002a190: 2320 4d65 7468 6f64 2031 3a20 6279 2075  # Method 1: by u
-0002a1a0: 7369 6e67 2074 6865 2061 746f 6d20 7072  sing the atom pr
-0002a1b0: 6f6a 6563 7469 6f6e 206f 6e20 706c 616e  ojection on plan
-0002a1c0: 6573 0a20 2020 2020 2020 2020 2020 2023  es.            #
-0002a1d0: 2078 696e 6465 782c 2079 696e 6465 782c   xindex, yindex,
-0002a1e0: 207a 696e 6465 7820 3d20 7365 6c66 2e70   zindex = self.p
-0002a1f0: 726f 6a65 6374 696f 6e5f 696e 6469 6365  rojection_indice
-0002a200: 7328 6f6e 6563 6f6f 7229 290a 2020 2020  s(onecoor)).    
-0002a210: 2020 2020 2020 2020 7869 6e64 6578 2c20          xindex, 
-0002a220: 7969 6e64 6578 2c20 7a69 6e64 6578 203d  yindex, zindex =
-0002a230: 2073 656c 662e 6d61 7472 6978 5f69 6e64   self.matrix_ind
-0002a240: 6963 6573 2861 7069 7873 2c20 6f6e 6563  ices(apixs, onec
-0002a250: 6f6f 7229 0a0a 2020 2020 2020 2020 2020  oor)..          
-0002a260: 2020 7a66 6c6f 6f72 203d 2069 6e74 2866    zfloor = int(f
-0002a270: 6c6f 6f72 287a 696e 6465 7829 290a 2020  loor(zindex)).  
-0002a280: 2020 2020 2020 2020 2020 6966 207a 666c            if zfl
-0002a290: 6f6f 7220 3e3d 206d 6170 5f7a 7369 7a65  oor >= map_zsize
-0002a2a0: 202d 2031 3a0a 2020 2020 2020 2020 2020   - 1:.          
-0002a2b0: 2020 2020 2020 7a63 6569 6c20 3d20 7a66        zceil = zf
-0002a2c0: 6c6f 6f72 0a20 2020 2020 2020 2020 2020  loor.           
-0002a2d0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0002a2e0: 2020 2020 2020 207a 6365 696c 203d 207a         zceil = z
-0002a2f0: 666c 6f6f 7220 2b20 310a 0a20 2020 2020  floor + 1..     
-0002a300: 2020 2020 2020 2079 666c 6f6f 7220 3d20         yfloor = 
-0002a310: 696e 7428 666c 6f6f 7228 7969 6e64 6578  int(floor(yindex
-0002a320: 2929 0a20 2020 2020 2020 2020 2020 2069  )).            i
-0002a330: 6620 7966 6c6f 6f72 203e 3d20 6d61 705f  f yfloor >= map_
-0002a340: 7973 697a 6520 2d20 313a 0a20 2020 2020  ysize - 1:.     
-0002a350: 2020 2020 2020 2020 2020 2079 6365 696c             yceil
-0002a360: 203d 2079 666c 6f6f 720a 2020 2020 2020   = yfloor.      
-0002a370: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0002a380: 2020 2020 2020 2020 2020 2020 7963 6569              ycei
-0002a390: 6c20 3d20 7966 6c6f 6f72 202b 2031 0a0a  l = yfloor + 1..
-0002a3a0: 2020 2020 2020 2020 2020 2020 7866 6c6f              xflo
-0002a3b0: 6f72 203d 2069 6e74 2866 6c6f 6f72 2878  or = int(floor(x
-0002a3c0: 696e 6465 7829 290a 2020 2020 2020 2020  index)).        
-0002a3d0: 2020 2020 6966 2078 666c 6f6f 7220 3e3d      if xfloor >=
-0002a3e0: 206d 6170 5f78 7369 7a65 202d 2031 3a0a   map_xsize - 1:.
-0002a3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a400: 7863 6569 6c20 3d20 7866 6c6f 6f72 0a20  xceil = xfloor. 
-0002a410: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0002a420: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002a430: 2078 6365 696c 203d 2078 666c 6f6f 7220   xceil = xfloor 
-0002a440: 2b20 310a 0a20 2020 2020 2020 2069 6e64  + 1..        ind
-0002a450: 6963 6573 203d 206e 702e 6172 7261 7928  ices = np.array(
-0002a460: 6e70 2e6d 6573 6867 7269 6428 6e70 2e61  np.meshgrid(np.a
-0002a470: 7261 6e67 6528 7866 6c6f 6f72 2c20 7863  range(xfloor, xc
-0002a480: 6569 6c20 2b20 3129 2c20 6e70 2e61 7261  eil + 1), np.ara
-0002a490: 6e67 6528 7966 6c6f 6f72 2c20 7963 6569  nge(yfloor, ycei
-0002a4a0: 6c20 2b20 3129 2c0a 2020 2020 2020 2020  l + 1),.        
-0002a4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a4c0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0002a4d0: 702e 6172 616e 6765 287a 666c 6f6f 722c  p.arange(zfloor,
-0002a4e0: 207a 6365 696c 202b 2031 2929 292e 542e   zceil + 1))).T.
-0002a4f0: 7265 7368 6170 6528 2d31 2c20 3329 0a20  reshape(-1, 3). 
-0002a500: 2020 2020 2020 206f 6e65 696e 6465 7820         oneindex 
-0002a510: 3d20 5b78 696e 6465 782c 2079 696e 6465  = [xindex, yinde
-0002a520: 782c 207a 696e 6465 785d 0a0a 2020 2020  x, zindex]..    
-0002a530: 2020 2020 7265 7475 726e 2028 696e 6469      return (indi
-0002a540: 6365 732c 206f 6e65 696e 6465 7829 0a0a  ces, oneindex)..
-0002a550: 0a20 2020 2064 6566 205f 5f67 6574 6672  .    def __getfr
-0002a560: 6163 7469 6f6e 7328 7365 6c66 2c20 696e  actions(self, in
-0002a570: 7465 7270 6f6c 6174 696f 6e2c 206d 6f64  terpolation, mod
-0002a580: 656c 293a 0a20 2020 2020 2020 2022 2222  el):.        """
-0002a590: 0a0a 2020 2020 2020 2020 2020 2020 5072  ..            Pr
-0002a5a0: 6f64 7563 6520 6174 6f6d 2069 6e63 6c75  oduce atom inclu
-0002a5b0: 7369 6f6e 2066 7261 6374 696f 6e20 696e  sion fraction in
-0002a5c0: 666f 726d 6174 696f 6e20 666f 7220 6675  formation for fu
-0002a5d0: 6c6c 2061 746f 6d73 2061 6e64 2062 6163  ll atoms and bac
-0002a5e0: 6b62 6f6e 6520 7472 6163 650a 0a20 2020  kbone trace..   
-0002a5f0: 2020 2020 203a 7061 7261 6d20 696e 7465       :param inte
-0002a600: 7270 6f6c 6174 696f 6e3a 204c 6973 7420  rpolation: List 
-0002a610: 6f66 2069 6e74 6572 706f 6c61 7469 6f6e  of interpolation
-0002a620: 2076 616c 7565 730a 2020 2020 2020 2020   values.        
-0002a630: 3a70 6172 616d 206d 6170 3a20 456c 6563  :param map: Elec
-0002a640: 7472 6f6e 2064 656e 7369 7479 206d 6170  tron density map
-0002a650: 2069 6e20 6d72 632f 6d61 7020 666f 726d   in mrc/map form
-0002a660: 6174 0a20 2020 2020 2020 203a 7061 7261  at.        :para
-0002a670: 6d20 6d6f 6465 6c3a 2050 726f 7465 696e  m model: Protein
-0002a680: 206d 6f64 656c 2069 6e20 6d6d 6369 6620   model in mmcif 
-0002a690: 666f 726d 6174 0a20 2020 2020 2020 203a  format.        :
-0002a6a0: 7265 7475 726e 3a20 5475 706c 6520 636f  return: Tuple co
-0002a6b0: 6e74 6169 6e73 2066 756c 6c20 6174 6f6d  ntains full atom
-0002a6c0: 2069 6e63 6c75 7369 6f6e 2066 7261 6374   inclusion fract
-0002a6d0: 696f 6e73 2061 6e64 2062 6163 6b62 6f6e  ions and backbon
-0002a6e0: 6520 696e 636c 7573 696f 6e20 6672 6163  e inclusion frac
-0002a6f0: 7469 6f6e 730a 0a20 2020 2020 2020 2022  tions..        "
-0002a700: 2222 0a0a 2020 2020 2020 2020 6d61 7020  ""..        map 
-0002a710: 3d20 7365 6c66 2e6d 6170 0a20 2020 2020  = self.map.     
-0002a720: 2020 2062 696e 7320 3d20 6e70 2e6c 696e     bins = np.lin
-0002a730: 7370 6163 6528 6d61 702e 6461 7461 2e6d  space(map.data.m
-0002a740: 696e 2829 2c20 6d61 702e 6461 7461 2e6d  in(), map.data.m
-0002a750: 6178 2829 2c20 3132 3929 0a20 2020 2020  ax(), 129).     
-0002a760: 2020 2062 696e 6c69 7374 203d 2062 696e     binlist = bin
-0002a770: 732e 746f 6c69 7374 2829 0a20 2020 2020  s.tolist().     
-0002a780: 2020 2062 6973 6563 742e 696e 736f 7274     bisect.insort
-0002a790: 2862 696e 6c69 7374 2c20 7365 6c66 2e63  (binlist, self.c
-0002a7a0: 6c29 0a20 2020 2020 2020 2063 6c69 6e64  l).        clind
-0002a7b0: 6578 203d 2062 696e 6c69 7374 2e69 6e64  ex = binlist.ind
-0002a7c0: 6578 2873 656c 662e 636c 290a 2020 2020  ex(self.cl).    
-0002a7d0: 2020 2020 6269 6e6c 6973 742e 706f 7028      binlist.pop(
-0002a7e0: 636c 696e 6465 7820 2d20 3129 0a20 2020  clindex - 1).   
-0002a7f0: 2020 2020 2062 696e 7320 3d20 6e70 2e61       bins = np.a
-0002a800: 7361 7272 6179 2862 696e 6c69 7374 290a  sarray(binlist).
-0002a810: 0a20 2020 2020 2020 206e 6577 696e 7465  .        newinte
-0002a820: 7270 6f6c 6174 696f 6e20 3d20 5b5d 0a20  rpolation = []. 
-0002a830: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
-0002a840: 7261 6e67 6528 6c65 6e28 696e 7465 7270  range(len(interp
-0002a850: 6f6c 6174 696f 6e29 293a 0a20 2020 2020  olation)):.     
-0002a860: 2020 2020 2020 2023 2069 6620 2748 2720         # if 'H' 
-0002a870: 6e6f 7420 696e 206d 6f64 656c 5b69 5d2e  not in model[i].
-0002a880: 6174 6f6d 5f6e 616d 653a 0a20 2020 2020  atom_name:.     
-0002a890: 2020 2020 2020 2069 6620 2748 2720 6e6f         if 'H' no
-0002a8a0: 7420 696e 206d 6f64 656c 5b69 5d2e 6675  t in model[i].fu
-0002a8b0: 6c6c 6e61 6d65 3a0a 2020 2020 2020 2020  llname:.        
-0002a8c0: 2020 2020 2020 2020 6e65 7769 6e74 6572          newinter
-0002a8d0: 706f 6c61 7469 6f6e 2e61 7070 656e 6428  polation.append(
-0002a8e0: 696e 7465 7270 6f6c 6174 696f 6e5b 695d  interpolation[i]
-0002a8f0: 290a 0a20 2020 2020 2020 2023 2057 686f  )..        # Who
-0002a900: 6c65 206d 6f64 656c 2061 7665 7261 6765  le model average
-0002a910: 2061 746f 6d20 696e 6c63 7573 696f 6e0a   atom inlcusion.
-0002a920: 2020 2020 2020 2020 656e 7469 7265 5f61          entire_a
-0002a930: 7665 7261 6765 203d 2073 756d 286e 702e  verage = sum(np.
-0002a940: 6173 6172 7261 7928 6e65 7769 6e74 6572  asarray(newinter
-0002a950: 706f 6c61 7469 6f6e 2920 3e20 7365 6c66  polation) > self
-0002a960: 2e63 6c29 202f 2066 6c6f 6174 286c 656e  .cl) / float(len
-0002a970: 286e 6577 696e 7465 7270 6f6c 6174 696f  (newinterpolatio
-0002a980: 6e29 290a 0a20 2020 2020 2020 2023 2046  n))..        # F
-0002a990: 756c 6c20 6174 6f6d 2069 6e63 6c75 7369  ull atom inclusi
-0002a9a0: 6f6e 0a20 2020 2020 2020 2061 203d 205b  on.        a = [
-0002a9b0: 5d0a 2020 2020 2020 2020 7465 6d70 6c69  ].        templi
-0002a9c0: 7374 203d 206e 702e 6173 6172 7261 7928  st = np.asarray(
-0002a9d0: 6e65 7769 6e74 6572 706f 6c61 7469 6f6e  newinterpolation
-0002a9e0: 290a 2020 2020 2020 2020 666f 7220 6920  ).        for i 
-0002a9f0: 696e 2062 696e 733a 0a20 2020 2020 2020  in bins:.       
-0002aa00: 2020 2020 2078 203d 2073 756d 2874 656d       x = sum(tem
-0002aa10: 706c 6973 7420 3e20 6929 202f 2066 6c6f  plist > i) / flo
-0002aa20: 6174 286c 656e 2874 656d 706c 6973 7429  at(len(templist)
-0002aa30: 290a 2020 2020 2020 2020 2020 2020 612e  ).            a.
-0002aa40: 6170 7065 6e64 2878 290a 0a20 2020 2020  append(x)..     
-0002aa50: 2020 2074 7261 6365 696e 7465 7220 3d20     traceinter = 
-0002aa60: 5b5d 0a20 2020 2020 2020 2066 6f72 2069  [].        for i
-0002aa70: 2069 6e20 7261 6e67 6528 6c65 6e28 696e   in range(len(in
-0002aa80: 7465 7270 6f6c 6174 696f 6e29 293a 0a20  terpolation)):. 
-0002aa90: 2020 2020 2020 2020 2020 2069 6620 286d             if (m
-0002aaa0: 6f64 656c 5b69 5d2e 6675 6c6c 6e61 6d65  odel[i].fullname
-0002aab0: 203d 3d20 274e 2720 6f72 206d 6f64 656c   == 'N' or model
-0002aac0: 5b69 5d2e 6675 6c6c 6e61 6d65 203d 3d20  [i].fullname == 
-0002aad0: 2743 2720 6f72 206d 6f64 656c 5b69 5d2e  'C' or model[i].
-0002aae0: 6675 6c6c 6e61 6d65 203d 3d20 274f 2720  fullname == 'O' 
-0002aaf0: 6f72 0a20 2020 2020 2020 2020 2020 2020  or.             
-0002ab00: 2020 2020 2020 206d 6f64 656c 5b69 5d2e         model[i].
-0002ab10: 6675 6c6c 6e61 6d65 203d 3d20 2743 4127  fullname == 'CA'
-0002ab20: 206f 7220 6d6f 6465 6c5b 695d 2e66 756c   or model[i].ful
-0002ab30: 6c6e 616d 6520 3d3d 2022 4333 2722 206f  lname == "C3'" o
-0002ab40: 7220 6d6f 6465 6c5b 695d 2e66 756c 6c6e  r model[i].fulln
-0002ab50: 616d 6520 3d3d 2022 4334 2722 206f 720a  ame == "C4'" or.
-0002ab60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ab70: 2020 2020 6d6f 6465 6c5b 695d 2e66 756c      model[i].ful
-0002ab80: 6c6e 616d 6520 3d3d 2022 4335 2722 206f  lname == "C5'" o
-0002ab90: 7220 6d6f 6465 6c5b 695d 2e66 756c 6c6e  r model[i].fulln
-0002aba0: 616d 6520 3d3d 2022 4f33 2722 206f 7220  ame == "O3'" or 
-0002abb0: 6d6f 6465 6c5b 695d 2e66 756c 6c6e 616d  model[i].fullnam
-0002abc0: 6520 3d3d 2022 4f35 2722 206f 720a 2020  e == "O5'" or.  
-0002abd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002abe0: 2020 6d6f 6465 6c5b 695d 2e66 756c 6c6e    model[i].fulln
-0002abf0: 616d 6520 3d3d 2027 5027 206f 7220 6d6f  ame == 'P' or mo
-0002ac00: 6465 6c5b 695d 2e66 756c 6c6e 616d 6520  del[i].fullname 
-0002ac10: 3d3d 2027 4f58 5427 293a 0a20 2020 2020  == 'OXT'):.     
-0002ac20: 2020 2020 2020 2020 2020 2074 7261 6365             trace
-0002ac30: 696e 7465 722e 6170 7065 6e64 2869 6e74  inter.append(int
-0002ac40: 6572 706f 6c61 7469 6f6e 5b69 5d29 0a0a  erpolation[i])..
-0002ac50: 2020 2020 2020 2020 2320 4261 636b 626f          # Backbo
-0002ac60: 6e65 2069 6e63 6c75 7369 6f6e 0a20 2020  ne inclusion.   
-0002ac70: 2020 2020 2062 203d 205b 5d0a 2020 2020       b = [].    
-0002ac80: 2020 2020 7465 6d70 7472 6163 6569 6e74      temptraceint
-0002ac90: 6572 203d 206e 702e 6173 6172 7261 7928  er = np.asarray(
-0002aca0: 7472 6163 6569 6e74 6572 290a 2020 2020  traceinter).    
-0002acb0: 2020 2020 666f 7220 6a20 696e 2062 696e      for j in bin
-0002acc0: 733a 0a20 2020 2020 2020 2020 2020 2079  s:.            y
-0002acd0: 203d 2073 756d 2874 656d 7074 7261 6365   = sum(temptrace
-0002ace0: 696e 7465 7220 3e20 6a29 202f 2066 6c6f  inter > j) / flo
-0002acf0: 6174 286c 656e 2874 656d 7074 7261 6365  at(len(temptrace
-0002ad00: 696e 7465 7229 290a 2020 2020 2020 2020  inter)).        
-0002ad10: 2020 2020 622e 6170 7065 6e64 2879 290a      b.append(y).
-0002ad20: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0002ad30: 612c 2062 2c20 656e 7469 7265 5f61 7665  a, b, entire_ave
-0002ad40: 7261 6765 2c20 666c 6f61 7428 6c65 6e28  rage, float(len(
-0002ad50: 6e65 7769 6e74 6572 706f 6c61 7469 6f6e  newinterpolation
-0002ad60: 2929 0a0a 2020 2020 6465 6620 6169 5f62  ))..    def ai_b
-0002ad70: 6172 2873 656c 6629 3a0a 0a20 2020 2020  ar(self):..     
-0002ad80: 2020 2069 6620 6e6f 7420 7365 6c66 2e6f     if not self.o
-0002ad90: 6e6c 7962 6172 3a0a 2020 2020 2020 2020  nlybar:.        
-0002ada0: 2020 2020 7365 6c66 2e61 746f 6d5f 696e      self.atom_in
-0002adb0: 636c 7573 696f 6e28 290a 2020 2020 2020  clusion().      
-0002adc0: 2020 7365 6c66 2e67 6574 5f62 6172 2827    self.get_bar('
-0002add0: 6174 6f6d 5f69 6e63 6c75 7369 6f6e 2729  atom_inclusion')
-0002ade0: 0a0a 2020 2020 2320 4070 726f 6669 6c65  ..    # @profile
-0002adf0: 0a20 2020 2064 6566 2061 746f 6d5f 696e  .    def atom_in
-0002ae00: 636c 7573 696f 6e28 7365 6c66 293a 0a20  clusion(self):. 
-0002ae10: 2020 2020 2020 2022 2222 0a0a 2020 2020         """..    
-0002ae20: 2020 2020 2020 2020 4765 6e65 7261 7465          Generate
-0002ae30: 2061 746f 6d20 696e 636c 7573 696f 6e20   atom inclusion 
-0002ae40: 616e 6420 7265 7369 6475 6520 6174 6f6d  and residue atom
-0002ae50: 2069 6e63 6c75 7369 6f6e 2069 6e66 6f72   inclusion infor
-0002ae60: 6d61 7469 6f6e 2076 6572 7365 7320 6469  mation verses di
-0002ae70: 6666 6572 656e 7420 636f 6e74 6f75 7220  fferent contour 
-0002ae80: 6c65 7665 6c0a 2020 2020 2020 2020 2020  level.          
-0002ae90: 2020 426f 7468 2066 756c 6c20 6174 6f6d    Both full atom
-0002aea0: 7320 616e 6420 6261 636b 626f 6e65 2069  s and backbone i
-0002aeb0: 6e66 6f72 6d61 7469 6f6e 2061 7265 2069  nformation are i
-0002aec0: 6e63 6c75 6465 642e 0a20 2020 2020 2020  ncluded..       
-0002aed0: 2020 2020 2052 6573 756c 7473 2077 726f       Results wro
-0002aee0: 7465 2074 6f20 4a53 4f4e 2066 696c 650a  te to JSON file.
-0002aef0: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-0002af00: 3a20 4e6f 6e65 0a0a 2020 2020 2020 2020  : None..        
-0002af10: 2222 220a 2020 2020 2020 2020 6966 2073  """.        if s
-0002af20: 656c 662e 6d6f 6465 6c73 2069 7320 4e6f  elf.models is No
-0002af30: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0002af40: 7379 732e 7374 6465 7272 2e77 7269 7465  sys.stderr.write
-0002af50: 2827 5245 4d49 4e44 4552 3a20 6174 6f6d  ('REMINDER: atom
-0002af60: 2069 6e63 6c75 7369 6f6e 2061 6e64 2072   inclusion and r
-0002af70: 6573 6964 7565 2069 6e63 6c75 7369 6f6e  esidue inclusion
-0002af80: 2077 696c 6c20 6e6f 7420 6265 2063 616c   will not be cal
-0002af90: 6375 6c61 7465 6420 7769 7468 6f75 7420  culated without 
-0002afa0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-0002afb0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0002afc0: 6d6f 6465 6c20 7374 7275 6374 7572 652e  model structure.
-0002afd0: 5c6e 2729 0a20 2020 2020 2020 2020 2020  \n').           
-0002afe0: 2070 7269 6e74 2827 2d2d 2d2d 2d2d 2d2d   print('--------
-0002aff0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0002b000: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2729 0a20  ------------'). 
-0002b010: 2020 2020 2020 2065 6c69 6620 7365 6c66         elif self
-0002b020: 2e63 6c20 6973 204e 6f6e 653a 0a20 2020  .cl is None:.   
-0002b030: 2020 2020 2020 2020 2073 7973 2e73 7464           sys.std
-0002b040: 6572 722e 7772 6974 6528 2752 454d 494e  err.write('REMIN
-0002b050: 4445 523a 2061 746f 6d20 696e 636c 7573  DER: atom inclus
-0002b060: 696f 6e20 616e 6420 7265 7369 6475 6520  ion and residue 
-0002b070: 696e 636c 7573 696f 6e20 7769 6c6c 206e  inclusion will n
-0002b080: 6f74 2062 6520 6361 6c63 756c 6174 6564  ot be calculated
-0002b090: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-0002b0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b0b0: 2777 6974 686f 7574 2063 6f6e 746f 7572  'without contour
-0002b0c0: 206c 6576 656c 2067 6976 656e 2e5c 6e27   level given.\n'
-0002b0d0: 290a 2020 2020 2020 2020 2020 2020 7072  ).            pr
-0002b0e0: 696e 7428 272d 2d2d 2d2d 2d2d 2d2d 2d2d  int('-----------
-0002b0f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0002b100: 2d2d 2d2d 2d2d 2d2d 2d27 290a 2020 2020  ---------').    
-0002b110: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0002b120: 2020 2020 2020 7374 6172 7420 3d20 7469        start = ti
-0002b130: 6d65 6974 2e64 6566 6175 6c74 5f74 696d  meit.default_tim
-0002b140: 6572 2829 0a20 2020 2020 2020 2020 2020  er().           
-0002b150: 206d 6170 203d 2073 656c 662e 6d61 700a   map = self.map.
-0002b160: 0a20 2020 2020 2020 2020 2020 2023 206d  .            # m
-0002b170: 6f64 656c 6e61 6d65 7320 3d20 5b20 6d6f  odelnames = [ mo
-0002b180: 6465 6c2e 6669 6c65 6e61 6d65 2066 6f72  del.filename for
-0002b190: 206d 6f64 656c 2069 6e20 7365 6c66 2e6d   model in self.m
-0002b1a0: 6f64 656c 7320 5d0a 2020 2020 2020 2020  odels ].        
-0002b1b0: 2020 2020 2320 7665 7273 696f 6e20 3120      # version 1 
-0002b1c0: 7573 6520 7465 6d70 790a 2020 2020 2020  use tempy.      
-0002b1d0: 2020 2020 2020 2320 636f 6d62 696e 7265        # combinre
-0002b1e0: 7375 6c74 203d 2073 656c 662e 5f5f 696e  sult = self.__in
-0002b1f0: 7465 7274 6869 7264 2829 0a20 2020 2020  terthird().     
-0002b200: 2020 2020 2020 2023 2076 6572 7369 6f6e         # version
-0002b210: 2032 2075 7365 2062 696f 7079 7468 6f6e   2 use biopython
-0002b220: 2062 7574 206e 6f74 206f 7074 6d69 7365   but not optmise
-0002b230: 6420 666f 7220 6269 6f70 7974 686f 6e0a  d for biopython.
-0002b240: 2020 2020 2020 2020 2020 2020 2320 636f              # co
-0002b250: 6d62 696e 7265 7375 6c74 203d 2073 656c  mbinresult = sel
-0002b260: 662e 5f5f 6e65 7769 6e74 6572 7468 6972  f.__newinterthir
-0002b270: 6428 290a 2020 2020 2020 2020 2020 2020  d().            
-0002b280: 2320 7665 7273 696f 6e20 3320 7573 6520  # version 3 use 
-0002b290: 6269 6f70 7974 686f 6e20 6e65 6564 206d  biopython need m
-0002b2a0: 6f72 6520 7465 7374 7320 616e 6420 7468  ore tests and th
-0002b2b0: 656e 2064 656c 6574 6520 7468 6520 6f74  en delete the ot
-0002b2c0: 6865 7220 7477 6f20 6162 6f76 650a 2020  her two above.  
-0002b2d0: 2020 2020 2020 2020 2020 636f 6d62 696e            combin
-0002b2e0: 7265 7375 6c74 203d 2073 656c 662e 5f5f  result = self.__
-0002b2f0: 6e6e 6577 696e 7465 7274 6869 7264 2829  nnewinterthird()
-0002b300: 0a20 2020 2020 2020 2020 2020 2061 746f  .            ato
-0002b310: 6d69 6e64 6963 7420 3d20 4f72 6465 7265  mindict = Ordere
-0002b320: 6444 6963 7428 290a 2020 2020 2020 2020  dDict().        
-0002b330: 2020 2020 7265 7369 6e64 6963 7420 3d20      resindict = 
-0002b340: 4f72 6465 7265 6444 6963 7428 290a 2020  OrderedDict().  
-0002b350: 2020 2020 2020 2020 2020 6461 7461 6469            datadi
-0002b360: 6374 203d 204f 7264 6572 6564 4469 6374  ct = OrderedDict
-0002b370: 2829 0a20 2020 2020 2020 2020 2020 2072  ().            r
-0002b380: 6573 6469 6374 203d 204f 7264 6572 6564  esdict = Ordered
-0002b390: 4469 6374 2829 0a20 2020 2020 2020 2020  Dict().         
-0002b3a0: 2020 2063 6f75 6e74 6572 203d 2030 0a20     counter = 0. 
-0002b3b0: 2020 2020 2020 2020 2020 2065 7272 6c69             errli
-0002b3c0: 7374 203d 205b 5d0a 2020 2020 2020 2020  st = [].        
-0002b3d0: 2020 2020 7265 7365 7272 6c69 7374 203d      reserrlist =
-0002b3e0: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
-0002b3f0: 616c 6c6d 6f64 656c 735f 6e75 6d62 6572  allmodels_number
-0002b400: 6174 6f6d 7320 3d20 300a 2020 2020 2020  atoms = 0.      
-0002b410: 2020 2020 2020 616c 6c6d 6f64 656c 735f        allmodels_
-0002b420: 6174 6f6d 5f69 6e63 6c75 7369 6f6e 203d  atom_inclusion =
-0002b430: 2030 2e30 0a20 2020 2020 2020 2020 2020   0.0.           
-0002b440: 2066 6f72 206b 6579 2c20 7661 6c75 6520   for key, value 
-0002b450: 696e 2063 6f6d 6269 6e72 6573 756c 742e  in combinresult.
-0002b460: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
-0002b470: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-0002b480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b490: 2020 696e 7465 7270 6f6c 6174 696f 6e73    interpolations
-0002b4a0: 2c20 616c 6c63 6f6e 746f 7572 7364 6963  , allcontoursdic
-0002b4b0: 742c 2063 6861 696e 6169 7363 6f72 652c  t, chainaiscore,
-0002b4c0: 2061 746f 6d6f 7574 7369 6465 626f 7820   atomoutsidebox 
-0002b4d0: 3d20 7661 6c75 650a 2020 2020 2020 2020  = value.        
-0002b4e0: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-0002b4f0: 7369 6e73 7461 6e63 6528 7365 6c66 2e6d  sinstance(self.m
-0002b500: 6f64 656c 732c 206c 6973 7429 3a0a 2020  odels, list):.  
-0002b510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b520: 2020 2020 2020 6d6f 6465 6c73 203d 205b        models = [
-0002b530: 6375 726d 6f64 656c 2066 6f72 2063 7572  curmodel for cur
-0002b540: 6d6f 6465 6c20 696e 2073 656c 662e 6d6f  model in self.mo
-0002b550: 6465 6c73 2069 6620 6b65 7920 696e 2063  dels if key in c
-0002b560: 7572 6d6f 6465 6c2e 6669 6c65 6e61 6d65  urmodel.filename
-0002b570: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0002b580: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0002b590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b5a0: 2020 2020 6d6f 6465 6c73 203d 206c 6973      models = lis
-0002b5b0: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
-0002b5c0: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
-0002b5d0: 6c73 2e61 7070 656e 6428 7365 6c66 2e6d  ls.append(self.m
-0002b5e0: 6f64 656c 7329 0a0a 2020 2020 2020 2020  odels)..        
-0002b5f0: 2020 2020 2020 2020 2020 2020 6966 206c              if l
-0002b600: 656e 286d 6f64 656c 7329 203d 3d20 313a  en(models) == 1:
-0002b610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002b620: 2020 2020 2020 2020 206d 6f64 656c 203d           model =
-0002b630: 206d 6f64 656c 735b 305d 0a20 2020 2020   models[0].     
-0002b640: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0002b650: 6c69 6620 6c65 6e28 6d6f 6465 6c73 2920  lif len(models) 
-0002b660: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
-0002b670: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-0002b680: 696e 7428 2754 6865 7265 2069 7320 6e6f  int('There is no
-0002b690: 206d 6f64 656c 2127 290a 2020 2020 2020   model!').      
-0002b6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b6b0: 2020 6578 6974 2829 0a20 2020 2020 2020    exit().       
-0002b6c0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-0002b6d0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0002b6e0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-0002b6f0: 2827 5468 6572 6520 6172 6520 6d6f 7265  ('There are more
-0002b700: 2074 6861 6e20 6f6e 6520 6d6f 6465 6c20   than one model 
-0002b710: 7768 6963 6820 7368 6f75 6c64 2062 6520  which should be 
-0002b720: 6f6e 6c79 206f 6e65 2e27 290a 2020 2020  only one.').    
-0002b730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b740: 2020 2020 6578 6974 2829 0a0a 2020 2020      exit()..    
-0002b750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b760: 616c 6c61 746f 6d73 203d 206c 6973 7428  allatoms = list(
-0002b770: 6d6f 6465 6c2e 6765 745f 6174 6f6d 7328  model.get_atoms(
-0002b780: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-0002b790: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
-0002b7a0: 7365 6c66 2e5f 5f67 6574 6672 6163 7469  self.__getfracti
-0002b7b0: 6f6e 7328 696e 7465 7270 6f6c 6174 696f  ons(interpolatio
-0002b7c0: 6e73 2c20 616c 6c61 746f 6d73 290a 2020  ns, allatoms).  
-0002b7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b7e0: 2020 6c65 7665 6c73 203d 206e 702e 6c69    levels = np.li
-0002b7f0: 6e73 7061 6365 286d 6170 2e64 6174 612e  nspace(map.data.
-0002b800: 6d69 6e28 292c 206d 6170 2e64 6174 612e  min(), map.data.
-0002b810: 6d61 7828 292c 2031 3239 290a 0a20 2020  max(), 129)..   
-0002b820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b830: 2062 696e 6c69 7374 203d 206c 6576 656c   binlist = level
-0002b840: 732e 746f 6c69 7374 2829 0a20 2020 2020  s.tolist().     
-0002b850: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-0002b860: 6973 6563 742e 696e 736f 7274 2862 696e  isect.insort(bin
-0002b870: 6c69 7374 2c20 7365 6c66 2e63 6c29 0a20  list, self.cl). 
-0002b880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b890: 2020 2063 6c69 6e64 6578 203d 2062 696e     clindex = bin
-0002b8a0: 6c69 7374 2e69 6e64 6578 2873 656c 662e  list.index(self.
-0002b8b0: 636c 290a 2020 2020 2020 2020 2020 2020  cl).            
-0002b8c0: 2020 2020 2020 2020 6269 6e6c 6973 742e          binlist.
-0002b8d0: 706f 7028 636c 696e 6465 7820 2d20 3129  pop(clindex - 1)
-0002b8e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002b8f0: 2020 2020 206c 6576 656c 7320 3d20 6e70       levels = np
-0002b900: 2e61 7361 7272 6179 2862 696e 6c69 7374  .asarray(binlist
-0002b910: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-0002b920: 2020 2020 2020 2023 2073 636f 7265 5f74         # score_t
-0002b930: 7970 6520 3d20 2761 6927 0a20 2020 2020  ype = 'ai'.     
-0002b940: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0002b950: 206e 6577 5f64 6963 7420 3d20 7b27 6964   new_dict = {'id
-0002b960: 273a 2073 656c 662e 656d 6469 642c 2027  ': self.emdid, '
-0002b970: 7265 736f 6c75 7469 6f6e 273a 2066 6c6f  resolution': flo
-0002b980: 6174 2873 656c 662e 7265 736f 6c75 7469  at(self.resoluti
-0002b990: 6f6e 292c 2027 6e61 6d65 273a 206b 6579  on), 'name': key
-0002b9a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002b9b0: 2020 2020 2020 2320 2020 2020 2020 2020        #         
-0002b9c0: 2020 2020 7363 6f72 655f 7479 7065 3a20      score_type: 
-0002b9d0: 726f 756e 6428 7265 7375 6c74 5b32 5d2c  round(result[2],
-0002b9e0: 2033 297d 0a20 2020 2020 2020 2020 2020   3)}.           
-0002b9f0: 2020 2020 2020 2020 2023 2070 6c6f 745f           # plot_
-0002ba00: 6e61 6d65 203d 2027 7b7d 5f7b 7d5f 7b7d  name = '{}_{}_{}
-0002ba10: 5f62 6172 2e70 6e67 272e 666f 726d 6174  _bar.png'.format
-0002ba20: 2873 656c 662e 6d61 706e 616d 652c 206b  (self.mapname, k
-0002ba30: 6579 2c20 7363 6f72 655f 7479 7065 290a  ey, score_type).
-0002ba40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ba50: 2020 2020 2320 7363 6f72 655f 6469 7220      # score_dir 
-0002ba60: 3d20 6f73 2e70 6174 682e 6469 726e 616d  = os.path.dirnam
-0002ba70: 6528 7661 2e5f 5f66 696c 655f 5f29 0a20  e(va.__file__). 
-0002ba80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ba90: 2020 2023 2072 656c 6174 6976 655f 746f     # relative_to
-0002baa0: 7768 6f6c 652c 2072 656c 6174 6976 655f  whole, relative_
-0002bab0: 746f 7477 6f20 3d20 6261 7228 6e65 775f  totwo = bar(new_
-0002bac0: 6469 6374 2c20 7363 6f72 655f 7479 7065  dict, score_type
-0002bad0: 2c20 7365 6c66 2e77 6f72 6b64 6972 2c20  , self.workdir, 
-0002bae0: 7363 6f72 655f 6469 722c 2070 6c6f 745f  score_dir, plot_
-0002baf0: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
-0002bb00: 2020 2020 2020 2020 2020 2320 6169 6261            # aiba
-0002bb10: 7220 3d20 7b27 7768 6f6c 6527 3a20 7265  r = {'whole': re
-0002bb20: 6c61 7469 7665 5f74 6f77 686f 6c65 2c20  lative_towhole, 
-0002bb30: 2772 656c 6174 6976 6527 3a20 7265 6c61  'relative': rela
-0002bb40: 7469 7665 5f74 6f74 776f 7d0a 0a20 2020  tive_totwo}..   
-0002bb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bb60: 2064 6174 6164 6963 745b 7374 7228 636f   datadict[str(co
-0002bb70: 756e 7465 7229 5d20 3d20 7b27 6e61 6d65  unter)] = {'name
-0002bb80: 273a 206b 6579 2c20 276c 6576 656c 273a  ': key, 'level':
-0002bb90: 205b 726f 756e 6428 656c 656d 2c20 3629   [round(elem, 6)
-0002bba0: 2066 6f72 2065 6c65 6d20 696e 206c 6576   for elem in lev
-0002bbb0: 656c 732e 746f 6c69 7374 2829 5d2c 0a20  els.tolist()],. 
-0002bbc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bbe0: 2020 2020 2020 2020 2020 2020 2027 616c               'al
-0002bbf0: 6c5f 6174 6f6d 273a 205b 726f 756e 6428  l_atom': [round(
-0002bc00: 656c 656d 2c20 3329 2066 6f72 2065 6c65  elem, 3) for ele
-0002bc10: 6d20 696e 2072 6573 756c 745b 305d 5d2c  m in result[0]],
-0002bc20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002bc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bc40: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0002bc50: 6261 636b 626f 6e65 273a 205b 726f 756e  backbone': [roun
-0002bc60: 6428 656c 656d 2c20 3329 2066 6f72 2065  d(elem, 3) for e
-0002bc70: 6c65 6d20 696e 2072 6573 756c 745b 315d  lem in result[1]
-0002bc80: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-0002bc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bcb0: 2027 6174 6f6d 6f75 7473 6964 6527 3a20   'atomoutside': 
-0002bcc0: 6174 6f6d 6f75 7473 6964 6562 6f78 2c0a  atomoutsidebox,.
-0002bcd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bcf0: 2020 2020 2020 2020 2020 2020 2020 2763                'c
-0002bd00: 6861 696e 6169 7363 6f72 6527 3a20 6368  hainaiscore': ch
-0002bd10: 6169 6e61 6973 636f 7265 2c0a 2020 2020  ainaiscore,.    
-0002bd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bd40: 2020 2020 2020 2020 2020 2774 6f74 616c            'total
-0002bd50: 4e75 6d62 6572 4f66 4174 6f6d 7327 3a20  NumberOfAtoms': 
-0002bd60: 696e 7428 7265 7375 6c74 5b33 5d29 2c0a  int(result[3]),.
-0002bd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bd90: 2020 2020 2020 2020 2020 2020 2020 2761                'a
-0002bda0: 7665 7261 6765 5f61 695f 6d6f 6465 6c27  verage_ai_model'
-0002bdb0: 3a20 726f 756e 6428 7265 7375 6c74 5b32  : round(result[2
-0002bdc0: 5d2c 2033 292c 0a20 2020 2020 2020 2020  ], 3),.         
-0002bdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bdf0: 2020 2020 2027 6176 6572 6167 655f 6169       'average_ai
-0002be00: 5f63 6f6c 6f72 273a 2073 656c 662e 5f5f  _color': self.__
-0002be10: 666c 6f61 746f 6865 7828 5b72 6f75 6e64  floatohex([round
-0002be20: 2872 6573 756c 745b 325d 2c20 3629 5d29  (result[2], 6)])
-0002be30: 5b30 5d2c 0a20 2020 2020 2020 2020 2020  [0],.           
-0002be40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002be50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002be60: 2020 2023 2027 6169 5f62 6172 273a 2061     # 'ai_bar': a
-0002be70: 6962 6172 0a20 2020 2020 2020 2020 2020  ibar.           
-0002be80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002be90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bea0: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-0002beb0: 2020 2020 2020 2020 2061 6c6c 6d6f 6465           allmode
-0002bec0: 6c73 5f6e 756d 6265 7261 746f 6d73 202b  ls_numberatoms +
-0002bed0: 3d20 696e 7428 7265 7375 6c74 5b33 5d29  = int(result[3])
-0002bee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002bef0: 2020 2020 2061 6c6c 6d6f 6465 6c73 5f61       allmodels_a
-0002bf00: 746f 6d5f 696e 636c 7573 696f 6e20 2b3d  tom_inclusion +=
-0002bf10: 2072 6573 756c 745b 335d 2a72 6573 756c   result[3]*resul
-0002bf20: 745b 325d 0a0a 2020 2020 2020 2020 2020  t[2]..          
-0002bf30: 2020 2020 2020 2020 2020 6461 7461 5f6c            data_l
-0002bf40: 656e 203d 206c 656e 286c 6576 656c 732e  en = len(levels.
-0002bf50: 746f 6c69 7374 2829 290a 2020 2020 2020  tolist()).      
-0002bf60: 2020 2020 2020 2020 2020 2020 2020 706c                pl
-0002bf70: 742e 706c 6f74 285b 726f 756e 6428 656c  t.plot([round(el
-0002bf80: 656d 2c20 3130 2920 666f 7220 656c 656d  em, 10) for elem
-0002bf90: 2069 6e20 6c65 7665 6c73 2e74 6f6c 6973   in levels.tolis
-0002bfa0: 7428 295d 2c20 5b72 6f75 6e64 2865 6c65  t()], [round(ele
-0002bfb0: 6d2c 2031 3029 2066 6f72 2065 6c65 6d20  m, 10) for elem 
-0002bfc0: 696e 2072 6573 756c 745b 305d 5d2c 2027  in result[0]], '
-0002bfd0: 2d67 272c 206c 6162 656c 3d27 4675 6c6c  -g', label='Full
-0002bfe0: 2061 746f 6d27 290a 2020 2020 2020 2020   atom').        
-0002bff0: 2020 2020 2020 2020 2020 2020 706c 742e              plt.
-0002c000: 706c 6f74 285b 726f 756e 6428 656c 656d  plot([round(elem
-0002c010: 2c20 3130 2920 666f 7220 656c 656d 2069  , 10) for elem i
-0002c020: 6e20 6c65 7665 6c73 2e74 6f6c 6973 7428  n levels.tolist(
-0002c030: 295d 2c20 5b72 6f75 6e64 2865 6c65 6d2c  )], [round(elem,
-0002c040: 2031 3029 2066 6f72 2065 6c65 6d20 696e   10) for elem in
-0002c050: 2072 6573 756c 745b 315d 5d2c 2027 2d62   result[1]], '-b
-0002c060: 272c 206c 6162 656c 3d27 4261 636b 626f  ', label='Backbo
-0002c070: 6e65 2729 0a20 2020 2020 2020 2020 2020  ne').           
-0002c080: 2020 2020 2020 2020 2070 6c74 2e70 6c6f           plt.plo
-0002c090: 7428 6461 7461 5f6c 656e 202a 205b 7365  t(data_len * [se
-0002c0a0: 6c66 2e63 6c5d 2c20 6e70 2e6c 696e 7370  lf.cl], np.linsp
-0002c0b0: 6163 6528 302c 2031 2c20 6461 7461 5f6c  ace(0, 1, data_l
-0002c0c0: 656e 292c 2027 2d72 272c 206c 6162 656c  en), '-r', label
-0002c0d0: 3d27 5265 636f 6d6d 656e 6465 6420 636f  ='Recommended co
-0002c0e0: 6e74 6f75 7220 6c65 7665 6c27 290a 2020  ntour level').  
-0002c0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c100: 2020 706c 742e 6c65 6765 6e64 286c 6f63    plt.legend(loc
-0002c110: 3d27 6c6f 7765 7220 6c65 6674 2729 0a20  ='lower left'). 
-0002c120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c130: 2020 2070 6c74 2e73 6176 6566 6967 2873     plt.savefig(s
-0002c140: 656c 662e 776f 726b 6469 7220 2b20 7365  elf.workdir + se
-0002c150: 6c66 2e6d 6170 6e61 6d65 202b 2027 5f69  lf.mapname + '_i
-0002c160: 6e63 6c75 7369 6f6e 2e70 6e67 2729 0a20  nclusion.png'). 
-0002c170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c180: 2020 2070 6c74 2e63 6c6f 7365 2829 0a20     plt.close(). 
-0002c190: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0002c1a0: 7863 6570 743a 0a20 2020 2020 2020 2020  xcept:.         
-0002c1b0: 2020 2020 2020 2020 2020 2065 7272 203d             err =
-0002c1c0: 2027 4174 6f6d 2069 6e63 6c75 7369 6f6e   'Atom inclusion
-0002c1d0: 2063 616c 6375 6c61 7469 6f6e 2065 7272   calculation err
-0002c1e0: 6f72 284d 6f64 656c 3a20 7b7d 293a 207b  or(Model: {}): {
-0002c1f0: 7d2e 272e 666f 726d 6174 286b 6579 2c20  }.'.format(key, 
-0002c200: 7379 732e 6578 635f 696e 666f 2829 5b31  sys.exc_info()[1
-0002c210: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
-0002c220: 2020 2020 2020 2065 7272 6c69 7374 2e61         errlist.a
-0002c230: 7070 656e 6428 6572 7229 0a20 2020 2020  ppend(err).     
-0002c240: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0002c250: 7973 2e73 7464 6572 722e 7772 6974 6528  ys.stderr.write(
-0002c260: 6572 7220 2b20 275c 6e27 290a 2020 2020  err + '\n').    
-0002c270: 2020 2020 2020 2020 2020 2020 6966 2065              if e
-0002c280: 7272 6c69 7374 3a0a 2020 2020 2020 2020  rrlist:.        
-0002c290: 2020 2020 2020 2020 2020 2020 6461 7461              data
-0002c2a0: 6469 6374 5b73 7472 2863 6f75 6e74 6572  dict[str(counter
-0002c2b0: 295d 203d 207b 2765 7272 273a 207b 2761  )] = {'err': {'a
-0002c2c0: 746f 6d5f 696e 636c 7573 696f 6e5f 6572  tom_inclusion_er
-0002c2d0: 7227 3a20 6572 726c 6973 747d 7d0a 0a20  r': errlist}}.. 
-0002c2e0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0002c2f0: 6f6e 746f 7572 6469 6374 203d 204f 7264  ontourdict = Ord
-0002c300: 6572 6564 4469 6374 2829 0a20 2020 2020  eredDict().     
-0002c310: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-0002c320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c330: 2020 2020 666f 7220 636f 6e74 6f75 722c      for contour,
-0002c340: 206b 6579 7376 616c 7565 7320 696e 2061   keysvalues in a
-0002c350: 6c6c 636f 6e74 6f75 7273 6469 6374 2e69  llcontoursdict.i
-0002c360: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
-0002c370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c380: 616c 6c76 616c 7565 7320 3d20 6b65 7973  allvalues = keys
-0002c390: 7661 6c75 6573 5b31 5d0a 2020 2020 2020  values[1].      
-0002c3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c3b0: 2020 616c 6c6b 6579 7320 3d20 6b65 7973    allkeys = keys
-0002c3c0: 7661 6c75 6573 5b30 5d0a 2020 2020 2020  values[0].      
-0002c3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c3e0: 2020 636f 6c6f 7572 7320 3d20 7365 6c66    colours = self
-0002c3f0: 2e5f 5f66 6c6f 6174 6f68 6578 2861 6c6c  .__floatohex(all
-0002c400: 7661 6c75 6573 290a 2020 2020 2020 2020  values).        
-0002c410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c420: 636f 6e74 6f75 726b 6579 203d 2073 7472  contourkey = str
-0002c430: 2872 6f75 6e64 2866 6c6f 6174 2863 6f6e  (round(float(con
-0002c440: 746f 7572 292c 2036 2929 0a20 2020 2020  tour), 6)).     
-0002c450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c460: 2020 2063 6f6e 746f 7572 6469 6374 5b63     contourdict[c
-0002c470: 6f6e 746f 7572 6b65 795d 203d 204f 7264  ontourkey] = Ord
-0002c480: 6572 6564 4469 6374 285b 2827 636f 6c6f  eredDict([('colo
-0002c490: 7227 2c20 636f 6c6f 7572 7329 2c20 2827  r', colours), ('
-0002c4a0: 696e 636c 7573 696f 6e27 2c20 616c 6c76  inclusion', allv
-0002c4b0: 616c 7565 7329 2c0a 2020 2020 2020 2020  alues),.        
-0002c4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c4f0: 2020 2020 2020 2028 2772 6573 6964 7565         ('residue
-0002c500: 272c 2061 6c6c 6b65 7973 295d 290a 0a20  ', allkeys)]).. 
-0002c510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c520: 2020 2063 6f6e 746f 7572 6469 6374 5b27     contourdict['
-0002c530: 6e61 6d65 275d 203d 206b 6579 0a20 2020  name'] = key.   
-0002c540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c550: 2072 6573 6469 6374 5b73 7472 2863 6f75   resdict[str(cou
-0002c560: 6e74 6572 295d 203d 2063 6f6e 746f 7572  nter)] = contour
-0002c570: 6469 6374 0a20 2020 2020 2020 2020 2020  dict.           
-0002c580: 2020 2020 2065 7863 6570 743a 0a20 2020       except:.   
-0002c590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c5a0: 2065 7272 203d 2027 5265 7369 6475 6520   err = 'Residue 
-0002c5b0: 696e 636c 7573 696f 6e20 6361 6c63 756c  inclusion calcul
-0002c5c0: 6174 696f 6e20 6572 726f 7228 4d6f 6465  ation error(Mode
-0002c5d0: 6c3a 207b 7d29 3a20 7b7d 2e27 2e66 6f72  l: {}): {}.'.for
-0002c5e0: 6d61 7428 6b65 792c 2073 7973 2e65 7863  mat(key, sys.exc
-0002c5f0: 5f69 6e66 6f28 295b 315d 290a 2020 2020  _info()[1]).    
-0002c600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c610: 7265 7365 7272 6c69 7374 2e61 7070 656e  reserrlist.appen
-0002c620: 6428 6572 7229 0a20 2020 2020 2020 2020  d(err).         
-0002c630: 2020 2020 2020 2020 2020 2073 7973 2e73             sys.s
-0002c640: 7464 6572 722e 7772 6974 6528 6572 7220  tderr.write(err 
-0002c650: 2b20 275c 6e27 290a 2020 2020 2020 2020  + '\n').        
-0002c660: 2020 2020 2020 2020 6966 2072 6573 6572          if reser
-0002c670: 726c 6973 743a 0a20 2020 2020 2020 2020  rlist:.         
-0002c680: 2020 2020 2020 2020 2020 2072 6573 6469             resdi
-0002c690: 6374 5b73 7472 2863 6f75 6e74 6572 295d  ct[str(counter)]
-0002c6a0: 203d 207b 2765 7272 273a 207b 2772 6573   = {'err': {'res
-0002c6b0: 6964 7565 5f69 6e63 6c75 7369 6f6e 5f65  idue_inclusion_e
-0002c6c0: 7272 273a 2072 6573 6572 726c 6973 747d  rr': reserrlist}
-0002c6d0: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-0002c6e0: 2020 636f 756e 7465 7220 2b3d 2031 0a0a    counter += 1..
-0002c6f0: 2020 2020 2020 2020 2020 2020 6966 2061              if a
-0002c700: 6c6c 6d6f 6465 6c73 5f6e 756d 6265 7261  llmodels_numbera
-0002c710: 746f 6d73 2021 3d20 303a 0a20 2020 2020  toms != 0:.     
-0002c720: 2020 2020 2020 2020 2020 2061 7665 7261             avera
-0002c730: 6765 5f61 695f 616c 6c6d 6f64 656c 7320  ge_ai_allmodels 
-0002c740: 3d20 616c 6c6d 6f64 656c 735f 6174 6f6d  = allmodels_atom
-0002c750: 5f69 6e63 6c75 7369 6f6e 202f 2061 6c6c  _inclusion / all
-0002c760: 6d6f 6465 6c73 5f6e 756d 6265 7261 746f  models_numberato
-0002c770: 6d73 0a20 2020 2020 2020 2020 2020 2020  ms.             
-0002c780: 2020 2064 6174 6164 6963 745b 2761 7665     datadict['ave
-0002c790: 7261 6765 5f61 695f 616c 6c6d 6f64 656c  rage_ai_allmodel
-0002c7a0: 7327 5d20 3d20 726f 756e 6428 6176 6572  s'] = round(aver
-0002c7b0: 6167 655f 6169 5f61 6c6c 6d6f 6465 6c73  age_ai_allmodels
-0002c7c0: 2c20 3329 0a20 2020 2020 2020 2020 2020  , 3).           
-0002c7d0: 2061 746f 6d69 6e64 6963 745b 2761 746f   atomindict['ato
-0002c7e0: 6d5f 696e 636c 7573 696f 6e5f 6279 5f6c  m_inclusion_by_l
-0002c7f0: 6576 656c 275d 203d 2064 6174 6164 6963  evel'] = datadic
-0002c800: 740a 2020 2020 2020 2020 2020 2020 7265  t.            re
-0002c810: 7369 6e64 6963 745b 2772 6573 6964 7565  sindict['residue
-0002c820: 5f69 6e63 6c75 7369 6f6e 275d 203d 2072  _inclusion'] = r
-0002c830: 6573 6469 6374 0a0a 2020 2020 2020 2020  esdict..        
-0002c840: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-0002c850: 2020 2020 2020 2020 2077 6974 6820 636f           with co
-0002c860: 6465 6373 2e6f 7065 6e28 7365 6c66 2e77  decs.open(self.w
-0002c870: 6f72 6b64 6972 202b 2073 656c 662e 6d61  orkdir + self.ma
-0002c880: 706e 616d 6520 2b20 275f 6174 6f6d 5f69  pname + '_atom_i
-0002c890: 6e63 6c75 7369 6f6e 2e6a 736f 6e27 2c20  nclusion.json', 
-0002c8a0: 2777 272c 0a20 2020 2020 2020 2020 2020  'w',.           
-0002c8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c8c0: 2020 2020 2020 656e 636f 6469 6e67 3d27        encoding='
-0002c8d0: 7574 662d 3827 2920 6173 2066 3a0a 2020  utf-8') as f:.  
+00026600: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00026610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026620: 2020 2020 2020 6368 6169 6e61 6973 636f        chainaisco
+00026630: 7265 5b61 6970 7265 6368 6169 6e5d 203d  re[aiprechain] =
+00026640: 207b 2776 616c 7565 273a 2061 6976 616c   {'value': aival
+00026650: 7565 2c20 2763 6f6c 6f72 273a 2061 6963  ue, 'color': aic
+00026660: 6f6c 6f72 7d0a 0a20 2020 2020 2020 2020  olor}..         
+00026670: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00026680: 6861 696e 6174 6f6d 7320 3d20 310a 2020  hainatoms = 1.  
+00026690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000266a0: 2020 2020 2020 6368 6169 6e63 6f75 6e74        chaincount
+000266b0: 202b 3d20 310a 2020 2020 2020 2020 2020   += 1.          
+000266c0: 2020 2020 2020 2020 2020 2020 2020 6368                ch
+000266d0: 6169 6e61 6920 3d20 6174 6f6d 696e 7465  ainai = atominte
+000266e0: 7262 696e 0a20 2020 2020 2020 2020 2020  rbin.           
+000266f0: 2020 2020 2020 2020 2020 2020 2023 2061               # a
+00026700: 6970 7265 6368 6169 6e20 3d20 6174 6f6d  iprechain = atom
+00026710: 2e63 6861 696e 0a20 2020 2020 2020 2020  .chain.         
+00026720: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00026730: 6970 7265 6368 6169 6e20 3d20 6174 6f6d  iprechain = atom
+00026740: 2e66 756c 6c5f 6964 5b32 5d0a 0a20 2020  .full_id[2]..   
+00026750: 2020 2020 2020 2020 2020 2020 2061 6976               aiv
+00026760: 616c 7565 203d 2072 6f75 6e64 2866 6c6f  alue = round(flo
+00026770: 6174 2863 6861 696e 6169 2920 2f20 6368  at(chainai) / ch
+00026780: 6169 6e61 746f 6d73 2c20 3329 0a20 2020  ainatoms, 3).   
+00026790: 2020 2020 2020 2020 2020 2020 2061 6963               aic
+000267a0: 6f6c 6f72 203d 2073 656c 662e 5f5f 666c  olor = self.__fl
+000267b0: 6f61 746f 6865 7828 5b61 6976 616c 7565  oatohex([aivalue
+000267c0: 5d29 5b30 5d0a 2020 2020 2020 2020 2020  ])[0].          
+000267d0: 2020 2020 2020 6966 2061 6970 7265 6368        if aiprech
+000267e0: 6169 6e20 696e 2063 6861 696e 6169 7363  ain in chainaisc
+000267f0: 6f72 652e 6b65 7973 2829 3a0a 2020 2020  ore.keys():.    
+00026800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026810: 2320 6368 6169 6e61 6973 636f 7265 5b61  # chainaiscore[a
+00026820: 6970 7265 6368 6169 6e20 2b20 275f 2720  iprechain + '_' 
+00026830: 2b20 7374 7228 6169 7661 6c75 6529 5d20  + str(aivalue)] 
+00026840: 3d20 7b27 7661 6c75 6527 3a20 6169 7661  = {'value': aiva
+00026850: 6c75 652c 2027 636f 6c6f 7227 3a20 6169  lue, 'color': ai
+00026860: 636f 6c6f 727d 0a20 2020 2020 2020 2020  color}.         
+00026870: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
+00026880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026890: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000268a0: 2020 2020 2020 2020 2020 6368 6169 6e61            chaina
+000268b0: 6973 636f 7265 5b61 6970 7265 6368 6169  iscore[aiprechai
+000268c0: 6e5d 203d 207b 2776 616c 7565 273a 2061  n] = {'value': a
+000268d0: 6976 616c 7565 2c20 2763 6f6c 6f72 273a  ivalue, 'color':
+000268e0: 2061 6963 6f6c 6f72 7d0a 2020 2020 2020   aicolor}.      
+000268f0: 2020 2020 2020 2020 2020 6b65 7973 7472            keystr
+00026900: 203d 2061 6970 7265 6368 6169 6e20 2b20   = aiprechain + 
+00026910: 273a 2720 2b20 7374 7228 7072 6572 6573  ':' + str(preres
+00026920: 6964 2920 2b20 7072 6572 6573 0a20 2020  id) + preres.   
+00026930: 2020 2020 2020 2020 2020 2020 2061 6c6c               all
+00026940: 6b65 7973 2e61 7070 656e 6428 6b65 7973  keys.append(keys
+00026950: 7472 290a 2020 2020 2020 2020 2020 2020  tr).            
+00026960: 2020 2020 7661 6c75 6520 3d20 666c 6f61      value = floa
+00026970: 7428 2725 2e34 6627 2025 2072 6f75 6e64  t('%.4f' % round
+00026980: 2828 666c 6f61 7428 7375 6d61 746f 6d69  ((float(sumatomi
+00026990: 6e74 6572 6269 6e29 202f 2072 6573 636f  nterbin) / resco
+000269a0: 756e 7429 2c20 3429 290a 2020 2020 2020  unt), 4)).      
+000269b0: 2020 2020 2020 2020 2020 616c 6c76 616c            allval
+000269c0: 7565 732e 6170 7065 6e64 2876 616c 7565  ues.append(value
+000269d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000269e0: 2020 616c 6c63 6f6e 746f 7572 7364 6963    allcontoursdic
+000269f0: 745b 7374 7228 636f 6e74 6f75 7229 5d20  t[str(contour)] 
+00026a00: 3d20 2861 6c6c 6b65 7973 2c20 616c 6c76  = (allkeys, allv
+00026a10: 616c 7565 7329 0a20 2020 2020 2020 2020  alues).         
+00026a20: 2020 2020 2020 2070 7269 6e74 2827 4d6f         print('Mo
+00026a30: 6465 6c3a 2025 7320 6174 2063 6f6e 746f  del: %s at conto
+00026a40: 7572 206c 6576 656c 2025 7320 6861 7320  ur level %s has 
+00026a50: 2573 2061 746f 6d73 2073 7469 636b 206f  %s atoms stick o
+00026a60: 7574 206f 6620 7468 6520 6465 6e73 6974  ut of the densit
+00026a70: 792e 2720 2520 286d 6f64 656c 6e61 6d65  y.' % (modelname
+00026a80: 2c20 636f 6e74 6f75 722c 0a20 2020 2020  , contour,.     
+00026a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026ae0: 2020 2020 2020 2020 2020 2020 6174 6f6d              atom
+00026af0: 6f75 7473 6964 656e 756d 2929 0a0a 2020  outsidenum))..  
+00026b00: 2020 2020 2020 2020 2020 2320 7265 7375            # resu
+00026b10: 6c74 5b6d 6f64 656c 6e61 6d65 5d20 3d20  lt[modelname] = 
+00026b20: 2869 6e74 6572 706f 6c61 7469 6f6e 732c  (interpolations,
+00026b30: 2061 6c6c 6b65 7973 2c20 616c 6c76 616c   allkeys, allval
+00026b40: 7565 7329 0a20 2020 2020 2020 2020 2020  ues).           
+00026b50: 2023 2072 6573 756c 743a 207b 6d6f 6465   # result: {mode
+00026b60: 6c6e 616d 6520 2331 3a20 2869 6e74 6572  lname #1: (inter
+00026b70: 706f 6c61 7469 6f6e 7320 2331 2c20 7b63  polations #1, {c
+00026b80: 6f6e 746f 7572 313a 2028 616c 6c6b 6579  ontour1: (allkey
+00026b90: 732c 2061 6c6c 7661 6c75 6573 292c 2063  s, allvalues), c
+00026ba0: 6f6e 746f 7572 323a 2028 616c 6c6b 6579  ontour2: (allkey
+00026bb0: 732c 2061 6c6c 7661 6c75 6573 290a 2020  s, allvalues).  
+00026bc0: 2020 2020 2020 2020 2020 2320 2e2e 2e7d            # ...}
+00026bd0: 292c 206d 6f64 656c 6e61 6d65 2023 323a  ), modelname #2:
+00026be0: 2028 696e 7465 7270 6f6c 6174 696f 6e73   (interpolations
+00026bf0: 2023 322c 207b 636f 6e74 6f75 7231 3a20   #2, {contour1: 
+00026c00: 2861 6c6c 6b65 7973 2c20 616c 6c76 616c  (allkeys, allval
+00026c10: 7565 7329 2c2e 2e2e 7d29 2c2e 2e2e 7d0a  ues),...}),...}.
+00026c20: 2020 2020 2020 2020 2020 2020 7265 7375              resu
+00026c30: 6c74 5b6d 6f64 656c 6e61 6d65 5d20 3d20  lt[modelname] = 
+00026c40: 2869 6e74 6572 706f 6c61 7469 6f6e 732c  (interpolations,
+00026c50: 2061 6c6c 636f 6e74 6f75 7273 6469 6374   allcontoursdict
+00026c60: 2c20 6368 6169 6e61 6973 636f 7265 2c20  , chainaiscore, 
+00026c70: 6174 6f6d 6f75 7473 6964 656e 756d 290a  atomoutsidenum).
+00026c80: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00026c90: 7265 7375 6c74 0a0a 2020 2020 2320 7665  result..    # ve
+00026ca0: 7273 696f 6e20 3320 666f 7220 6f70 7469  rsion 3 for opti
+00026cb0: 6d61 6c20 7573 6167 6520 6f66 2062 696f  mal usage of bio
+00026cc0: 7079 7468 6f6e 0a20 2020 2064 6566 205f  python.    def _
+00026cd0: 5f6e 6e65 7769 6e74 6572 7468 6972 6428  _nnewinterthird(
+00026ce0: 7365 6c66 293a 0a20 2020 2020 2020 2022  self):.        "
+00026cf0: 2222 0a0a 2020 2020 2020 2020 2020 2020  ""..            
+00026d00: 496e 7465 7270 6f6c 6174 6520 6465 6e73  Interpolate dens
+00026d10: 6974 7920 7661 6c75 6520 6f66 206f 6e65  ity value of one
+00026d20: 2061 746f 6d2c 2069 6620 696e 6469 6365   atom, if indice
+00026d30: 7320 6172 6520 6f6e 2074 6865 2073 616d  s are on the sam
+00026d40: 6520 706c 616e 6520 7573 6520 6e65 6172  e plane use near
+00026d50: 6573 7420 6d65 7468 6f64 0a20 2020 2020  est method.     
+00026d60: 2020 2020 2020 206f 7468 6572 7769 7365         otherwise
+00026d70: 2075 7365 206c 696e 6561 720a 0a20 2020   use linear..   
+00026d80: 2020 2020 203a 7061 7261 6d20 6d61 703a       :param map:
+00026d90: 2054 454d 5079 206d 6170 2069 6e73 7461   TEMPy map insta
+00026da0: 6e63 650a 2020 2020 2020 2020 3a70 6172  nce.        :par
+00026db0: 616d 206d 6f64 656c 3a20 5374 7275 6374  am model: Struct
+00026dc0: 7572 6520 696e 7374 616e 6365 2066 726f  ure instance fro
+00026dd0: 6d20 5445 4d50 7920 7061 636b 6167 6520  m TEMPy package 
+00026de0: 6d6d 6369 6620 7061 7273 6572 0a20 2020  mmcif parser.   
+00026df0: 2020 2020 203a 7265 7475 726e 3a20 4c69       :return: Li
+00026e00: 7374 2063 6f6e 7461 696e 7320 616c 6c20  st contains all 
+00026e10: 6465 6e73 6974 7920 696e 7465 7270 6f6c  density interpol
+00026e20: 6174 696f 6e73 206f 6620 6174 6f6d 7320  ations of atoms 
+00026e30: 6672 6f6d 206d 6f64 656c 0a0a 2020 2020  from model..    
+00026e40: 2020 2020 2222 220a 0a20 2020 2020 2020      """..       
+00026e50: 206d 7969 6e74 6572 203d 2073 656c 662e   myinter = self.
+00026e60: 5f5f 696e 7465 7250 6f6c 6174 696f 6e28  __interPolation(
+00026e70: 290a 2020 2020 2020 2020 2320 4d69 6768  ).        # Migh
+00026e80: 7420 6861 7669 6e67 206d 756c 7470 6c65  t having multple
+00026e90: 206d 6f64 656c 730a 2020 2020 2020 2020   models.        
+00026ea0: 6d6f 6465 6c73 203d 205b 5d0a 2020 2020  models = [].    
+00026eb0: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+00026ec0: 6528 7365 6c66 2e6d 6f64 656c 732c 206c  e(self.models, l
+00026ed0: 6973 7429 3a0a 2020 2020 2020 2020 2020  ist):.          
+00026ee0: 2020 6d6f 6465 6c73 203d 2073 656c 662e    models = self.
+00026ef0: 6d6f 6465 6c73 0a20 2020 2020 2020 2065  models.        e
+00026f00: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00026f10: 206d 6f64 656c 732e 6170 7065 6e64 2873   models.append(s
+00026f20: 656c 662e 6d6f 6465 6c73 290a 2020 2020  elf.models).    
+00026f30: 2020 2020 6d61 7020 3d20 7365 6c66 2e6d      map = self.m
+00026f40: 6170 0a20 2020 2020 2020 2063 6f6e 746f  ap.        conto
+00026f50: 7572 203d 2073 656c 662e 636c 0a20 2020  ur = self.cl.   
+00026f60: 2020 2020 2023 2052 616e 6765 206f 6620       # Range of 
+00026f70: 636f 6e74 6f75 7220 6c65 7665 6c20 7661  contour level va
+00026f80: 6c75 6573 2066 6f72 2073 6361 6c65 7220  lues for scaler 
+00026f90: 6261 720a 2020 2020 2020 2020 2320 546f  bar.        # To
+00026fa0: 646f 3a20 5269 6768 7420 6e6f 7720 7769  do: Right now wi
+00026fb0: 7468 2066 6978 6564 206e 756d 6265 7220  th fixed number 
+00026fc0: 6f66 2070 6f69 6e74 7320 6f6e 2062 6f74  of points on bot
+00026fd0: 6820 7369 6465 7320 6f66 2074 6865 2072  h sides of the r
+00026fe0: 6563 6f6d 6d65 6e64 6564 2063 6f6e 746f  ecommended conto
+00026ff0: 7572 206c 6576 656c 2c20 636f 756c 6420  ur level, could 
+00027000: 696d 7072 6f76 6520 746f 0a20 2020 2020  improve to.     
+00027010: 2020 2023 2054 6f64 6f3a 2067 656e 6572     # Todo: gener
+00027020: 6174 6520 6120 7265 6173 6f6e 6162 6c65  ate a reasonable
+00027030: 2072 616e 6765 2073 7572 726f 756e 6420   range surround 
+00027040: 7468 6520 7265 636f 6d6d 656e 6465 6420  the recommended 
+00027050: 636f 6e74 6f75 7220 6c65 7665 6c0a 2020  contour level.  
+00027060: 2020 2020 2020 2320 5365 7474 696e 6720        # Setting 
+00027070: 6120 736d 6172 7465 7220 7261 6e67 6520  a smarter range 
+00027080: 6265 7477 6565 6e20 2863 6f6e 746f 7572  between (contour
+00027090: 2d73 6967 2c63 6f6e 746f 7572 2c20 636f  -sig,contour, co
+000270a0: 756e 746f 7572 202b 2073 6967 290a 2020  untour + sig).  
+000270b0: 2020 2020 2020 2320 6d61 7073 6967 203d        # mapsig =
+000270c0: 206d 6170 2e73 7464 2829 0a20 2020 2020   map.std().     
+000270d0: 2020 2023 206d 6170 7369 6720 3d20 6d61     # mapsig = ma
+000270e0: 702e 6461 7461 2e73 7464 2829 0a20 2020  p.data.std().   
+000270f0: 2020 2020 2023 2063 6f6e 746f 7572 7261       # contourra
+00027100: 6e67 6520 3d20 6e70 2e63 6f6e 6361 7465  nge = np.concate
+00027110: 6e61 7465 2828 6e70 2e6c 696e 7370 6163  nate((np.linspac
+00027120: 6528 636f 6e74 6f75 7220 2d20 666c 6f61  e(contour - floa
+00027130: 7428 312e 3520 2a20 6d61 7073 6967 292c  t(1.5 * mapsig),
+00027140: 2063 6f6e 746f 7572 2c20 332c 2065 6e64   contour, 3, end
+00027150: 706f 696e 743d 4661 6c73 6529 2c0a 2020  point=False),.  
+00027160: 2020 2020 2020 2320 2020 2020 2020 2020        #         
+00027170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027180: 2020 2020 2020 206e 702e 6c69 6e73 7061         np.linspa
+00027190: 6365 2863 6f6e 746f 7572 2c20 636f 6e74  ce(contour, cont
+000271a0: 6f75 7220 2b20 666c 6f61 7428 312e 3520  our + float(1.5 
+000271b0: 2a20 6d61 7073 6967 292c 2034 2929 2c20  * mapsig), 4)), 
+000271c0: 6178 6973 3d4e 6f6e 6529 0a20 2020 2020  axis=None).     
+000271d0: 2020 2023 2063 6f6e 746f 7572 7261 6e67     # contourrang
+000271e0: 6520 3d20 6e70 2e63 6f6e 6361 7465 6e61  e = np.concatena
+000271f0: 7465 2828 6e70 2e6c 696e 7370 6163 6528  te((np.linspace(
+00027200: 6d61 702e 6d69 6e28 292c 2063 6f6e 746f  map.min(), conto
+00027210: 7572 2c20 332c 2065 6e64 706f 696e 743d  ur, 3, endpoint=
+00027220: 4661 6c73 6529 2c20 6e70 2e6c 696e 7370  False), np.linsp
+00027230: 6163 6528 636f 6e74 6f75 722c 206d 6170  ace(contour, map
+00027240: 2e6d 6178 2829 2c20 3329 292c 2061 7869  .max(), 3)), axi
+00027250: 733d 4e6f 6e65 290a 2020 2020 2020 2020  s=None).        
+00027260: 2320 5768 656e 2072 756e 6e69 6e67 2066  # When running f
+00027270: 6f72 2045 4d44 4220 6b65 6570 2069 7420  or EMDB keep it 
+00027280: 6173 2061 2066 6c65 7869 626c 6520 7261  as a flexible ra
+00027290: 6e67 6520 666f 7220 6f6e 6564 6570 206f  nge for onedep o
+000272a0: 7220 6f74 6865 7220 7573 6572 7320 6f6e  r other users on
+000272b0: 6c79 2072 756e 2069 7420 6f6e 6365 2066  ly run it once f
+000272c0: 6f72 2072 6563 6f6d 6d65 6e64 6564 0a20  or recommended. 
+000272d0: 2020 2020 2020 2023 2063 6f6e 746f 7572         # contour
+000272e0: 206c 6576 656c 3a0a 0a20 2020 2020 2020   level:..       
+000272f0: 2023 2069 6620 7365 6c66 2e65 6d64 6964   # if self.emdid
+00027300: 3a0a 2020 2020 2020 2020 2320 2020 2020  :.        #     
+00027310: 636f 6e74 6f75 7272 616e 6765 203d 206e  contourrange = n
+00027320: 702e 636f 6e63 6174 656e 6174 6528 286e  p.concatenate((n
+00027330: 702e 6c69 6e73 7061 6365 2863 6f6e 746f  p.linspace(conto
+00027340: 7572 202d 2066 6c6f 6174 2831 2e35 202a  ur - float(1.5 *
+00027350: 206d 6170 7369 6729 2c20 636f 6e74 6f75   mapsig), contou
+00027360: 722c 2033 2c20 656e 6470 6f69 6e74 3d46  r, 3, endpoint=F
+00027370: 616c 7365 292c 0a20 2020 2020 2020 2023  alse),.        #
+00027380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000273a0: 2020 2020 6e70 2e6c 696e 7370 6163 6528      np.linspace(
+000273b0: 636f 6e74 6f75 722c 2063 6f6e 746f 7572  contour, contour
+000273c0: 202b 2066 6c6f 6174 2831 2e35 202a 206d   + float(1.5 * m
+000273d0: 6170 7369 6729 2c20 3429 292c 2061 7869  apsig), 4)), axi
+000273e0: 733d 4e6f 6e65 290a 2020 2020 2020 2020  s=None).        
+000273f0: 2320 656c 7365 3a0a 2020 2020 2020 2020  # else:.        
+00027400: 2320 2020 2020 636f 6e74 6f75 7272 616e  #     contourran
+00027410: 6765 203d 206e 702e 6173 6172 7261 7928  ge = np.asarray(
+00027420: 5b63 6f6e 746f 7572 5d29 0a0a 2020 2020  [contour])..    
+00027430: 2020 2020 636f 6e74 6f75 7272 616e 6765      contourrange
+00027440: 203d 206e 702e 6173 6172 7261 7928 5b63   = np.asarray([c
+00027450: 6f6e 746f 7572 5d29 0a20 2020 2020 2020  ontour]).       
+00027460: 2072 6573 756c 7420 3d20 7b7d 0a20 2020   result = {}.   
+00027470: 2020 2020 2066 6f72 206d 6f64 656c 2069       for model i
+00027480: 6e20 6d6f 6465 6c73 3a0a 2020 2020 2020  n models:.      
+00027490: 2020 2020 2020 616c 6c63 6f6e 746f 7572        allcontour
+000274a0: 7364 6963 7420 3d20 4f72 6465 7265 6444  sdict = OrderedD
+000274b0: 6963 7428 290a 2020 2020 2020 2020 2020  ict().          
+000274c0: 2020 6174 6f6d 6f75 7473 6964 656e 756d    atomoutsidenum
+000274d0: 203d 2030 0a20 2020 2020 2020 2020 2020   = 0.           
+000274e0: 206d 6f64 656c 6e61 6d65 203d 206d 6f64   modelname = mod
+000274f0: 656c 2e66 696c 656e 616d 652e 7370 6c69  el.filename.spli
+00027500: 7428 272f 2729 5b2d 315d 0a0a 2020 2020  t('/')[-1]..    
+00027510: 2020 2020 2020 2020 6174 6f6d 636f 756e          atomcoun
+00027520: 7420 3d20 300a 2020 2020 2020 2020 2020  t = 0.          
+00027530: 2020 6368 6169 6e63 6f75 6e74 203d 2031    chaincount = 1
+00027540: 0a20 2020 2020 2020 2020 2020 2063 6861  .            cha
+00027550: 696e 6174 6f6d 7320 3d20 300a 2020 2020  inatoms = 0.    
+00027560: 2020 2020 2020 2020 6368 6169 6e61 6973          chainais
+00027570: 636f 7265 203d 207b 7d0a 2020 2020 2020  core = {}.      
+00027580: 2020 2020 2020 6368 6169 6e61 6920 3d20        chainai = 
+00027590: 302e 0a0a 2020 2020 2020 2020 2020 2020  0...            
+000275a0: 666f 7220 636f 6e74 6f75 7220 696e 2063  for contour in c
+000275b0: 6f6e 746f 7572 7261 6e67 653a 0a20 2020  ontourrange:.   
+000275c0: 2020 2020 2020 2020 2020 2020 2069 6e74               int
+000275d0: 6572 706f 6c61 7469 6f6e 7320 3d20 5b5d  erpolations = []
+000275e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000275f0: 2061 6c6c 6b65 7973 203d 205b 5d0a 2020   allkeys = [].  
+00027600: 2020 2020 2020 2020 2020 2020 2020 616c                al
+00027610: 6c76 616c 7565 7320 3d20 5b5d 0a20 2020  lvalues = [].   
+00027620: 2020 2020 2020 2020 2020 2020 2070 7265               pre
+00027630: 7265 7369 6420 3d20 300a 2020 2020 2020  resid = 0.      
+00027640: 2020 2020 2020 2020 2020 7072 6563 6861            precha
+00027650: 696e 203d 2027 270a 2020 2020 2020 2020  in = ''.        
+00027660: 2020 2020 2020 2020 6169 7072 6563 6861          aiprecha
+00027670: 696e 203d 2027 270a 2020 2020 2020 2020  in = ''.        
+00027680: 2020 2020 2020 2020 7072 6572 6573 203d          preres =
+00027690: 2027 270a 2020 2020 2020 2020 2020 2020   ''.            
+000276a0: 2020 2020 7265 7363 6f75 6e74 203d 2030      rescount = 0
+000276b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000276c0: 2073 756d 6174 6f6d 696e 7465 7262 696e   sumatominterbin
+000276d0: 203d 2030 0a20 2020 2020 2020 2020 2020   = 0.           
+000276e0: 2020 2020 2063 6861 696e 6169 5f61 746f       chainai_ato
+000276f0: 6d73 6e6f 203d 207b 7d0a 2020 2020 2020  msno = {}.      
+00027700: 2020 2020 2020 2020 2020 666f 7220 6368            for ch
+00027710: 6169 6e20 696e 206d 6f64 656c 2e67 6574  ain in model.get
+00027720: 5f63 6861 696e 7328 293a 0a20 2020 2020  _chains():.     
+00027730: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00027740: 6861 696e 6174 6f6d 696e 7465 7262 696e  hainatominterbin
+00027750: 203d 2030 0a20 2020 2020 2020 2020 2020   = 0.           
+00027760: 2020 2020 2020 2020 2063 6861 696e 5f61           chain_a
+00027770: 746f 6d5f 636f 756e 7420 3d20 300a 2020  tom_count = 0.  
+00027780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027790: 2020 6368 6169 6e5f 6e61 6d65 203d 2063    chain_name = c
+000277a0: 6861 696e 2e69 640a 2020 2020 2020 2020  hain.id.        
+000277b0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+000277c0: 7265 7369 6475 6520 696e 2063 6861 696e  residue in chain
+000277d0: 2e67 6574 5f72 6573 6964 7565 7328 293a  .get_residues():
+000277e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000277f0: 2020 2020 2020 2020 2072 6573 6174 6f6d           resatom
+00027800: 696e 7465 7262 696e 203d 2030 0a20 2020  interbin = 0.   
+00027810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027820: 2020 2020 2072 6573 6964 7565 5f61 746f       residue_ato
+00027830: 6d5f 636f 756e 7420 3d20 300a 2020 2020  m_count = 0.    
+00027840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027850: 2020 2020 7265 7369 6475 655f 6e61 6d65      residue_name
+00027860: 203d 2072 6573 6964 7565 2e72 6573 6e61   = residue.resna
+00027870: 6d65 0a20 2020 2020 2020 2020 2020 2020  me.             
+00027880: 2020 2020 2020 2020 2020 2072 6573 6964             resid
+00027890: 7565 5f6e 6f20 3d20 7265 7369 6475 652e  ue_no = residue.
+000278a0: 6964 5b31 5d0a 2020 2020 2020 2020 2020  id[1].          
+000278b0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+000278c0: 7220 6174 6f6d 2069 6e20 7265 7369 6475  r atom in residu
+000278d0: 652e 6765 745f 6174 6f6d 7328 293a 0a20  e.get_atoms():. 
+000278e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000278f0: 2020 2020 2020 2020 2020 2069 6620 6174             if at
+00027900: 6f6d 2e6e 616d 652e 7374 6172 7473 7769  om.name.startswi
+00027910: 7468 2827 4827 2920 6f72 2061 746f 6d2e  th('H') or atom.
+00027920: 6765 745f 7061 7265 6e74 2829 2e72 6573  get_parent().res
+00027930: 6e61 6d65 203d 3d20 2748 4f48 273a 0a20  name == 'HOH':. 
+00027940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027950: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00027960: 6f6e 7469 6e75 650a 2020 2020 2020 2020  ontinue.        
+00027970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027980: 2020 2020 2320 6966 2027 4827 206e 6f74      # if 'H' not
+00027990: 2069 6e20 6174 6f6d 2e6e 616d 653a 0a20   in atom.name:. 
+000279a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000279b0: 2020 2020 2020 2020 2020 2061 746f 6d63             atomc
+000279c0: 6f75 6e74 202b 3d20 310a 2020 2020 2020  ount += 1.      
+000279d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000279e0: 2020 2020 2020 7265 7369 6475 655f 6174        residue_at
+000279f0: 6f6d 5f63 6f75 6e74 202b 3d20 310a 2020  om_count += 1.  
+00027a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027a10: 2020 2020 2020 2020 2020 2320 6368 6169            # chai
+00027a20: 6e5f 6174 6f6d 5f63 6f75 6e74 202b 3d20  n_atom_count += 
+00027a30: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
+00027a40: 2020 2020 2020 2020 2020 2020 2020 6f6e                on
+00027a50: 6563 6f6f 7220 3d20 6174 6f6d 2e63 6f6f  ecoor = atom.coo
+00027a60: 7264 0a20 2020 2020 2020 2020 2020 2020  rd.             
+00027a70: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00027a80: 6e65 696e 6465 7820 3d20 7365 6c66 2e5f  neindex = self._
+00027a90: 5f67 6574 696e 6469 6365 7328 6f6e 6563  _getindices(onec
+00027aa0: 6f6f 7229 5b31 5d0a 2020 2020 2020 2020  oor)[1].        
+00027ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027ac0: 2020 2020 2320 6966 206f 6e65 696e 6465      # if oneinde
+00027ad0: 785b 305d 203e 206d 6170 2e78 5f73 697a  x[0] > map.x_siz
+00027ae0: 6528 2920 2d20 3120 6f72 206f 6e65 696e  e() - 1 or onein
+00027af0: 6465 785b 305d 203c 2030 206f 7220 5c0a  dex[0] < 0 or \.
+00027b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027b10: 2020 2020 2020 2020 2020 2020 2320 2020              #   
+00027b20: 2020 2020 2020 6f6e 6569 6e64 6578 5b31        oneindex[1
+00027b30: 5d20 3e20 6d61 702e 795f 7369 7a65 2829  ] > map.y_size()
+00027b40: 202d 2031 206f 7220 6f6e 6569 6e64 6578   - 1 or oneindex
+00027b50: 5b31 5d20 3c20 3020 6f72 205c 0a20 2020  [1] < 0 or \.   
+00027b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027b70: 2020 2020 2020 2020 2023 2020 2020 2020           #      
+00027b80: 2020 206f 6e65 696e 6465 785b 325d 203e     oneindex[2] >
+00027b90: 206d 6170 2e7a 5f73 697a 6528 2920 2d20   map.z_size() - 
+00027ba0: 3120 6f72 206f 6e65 696e 6465 785b 325d  1 or oneindex[2]
+00027bb0: 203c 2030 3a0a 2020 2020 2020 2020 2020   < 0:.          
+00027bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027bd0: 2020 6966 206f 6e65 696e 6465 785b 305d    if oneindex[0]
+00027be0: 203e 206d 6170 2e68 6561 6465 722e 6e78   > map.header.nx
+00027bf0: 202d 2031 206f 7220 6f6e 6569 6e64 6578   - 1 or oneindex
+00027c00: 5b30 5d20 3c20 3020 6f72 205c 0a20 2020  [0] < 0 or \.   
+00027c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027c30: 206f 6e65 696e 6465 785b 315d 203e 206d   oneindex[1] > m
+00027c40: 6170 2e68 6561 6465 722e 6e79 202d 2031  ap.header.ny - 1
+00027c50: 206f 7220 6f6e 6569 6e64 6578 5b31 5d20   or oneindex[1] 
+00027c60: 3c20 3020 6f72 205c 0a20 2020 2020 2020  < 0 or \.       
+00027c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027c80: 2020 2020 2020 2020 2020 2020 206f 6e65               one
+00027c90: 696e 6465 785b 325d 203e 206d 6170 2e68  index[2] > map.h
+00027ca0: 6561 6465 722e 6e7a 202d 2031 206f 7220  eader.nz - 1 or 
+00027cb0: 6f6e 6569 6e64 6578 5b32 5d20 3c20 303a  oneindex[2] < 0:
+00027cc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00027cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027ce0: 2023 2063 7572 696e 7465 7270 6f6c 6174   # curinterpolat
+00027cf0: 696f 6e20 3d20 6d61 702e 6d69 6e28 290a  ion = map.min().
+00027d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027d20: 6375 7269 6e74 6572 706f 6c61 7469 6f6e  curinterpolation
+00027d30: 203d 206d 6170 2e64 6174 612e 6d69 6e28   = map.data.min(
+00027d40: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00027d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027d60: 2020 6174 6f6d 6f75 7473 6964 656e 756d    atomoutsidenum
+00027d70: 202b 3d20 310a 2020 2020 2020 2020 2020   += 1.          
+00027d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027d90: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00027da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027db0: 2020 2020 2020 2020 6375 7269 6e74 6572          curinter
+00027dc0: 706f 6c61 7469 6f6e 203d 206d 7969 6e74  polation = myint
+00027dd0: 6572 286f 6e65 696e 6465 7829 2e74 6f6c  er(oneindex).tol
+00027de0: 6973 7428 295b 305d 0a20 2020 2020 2020  ist()[0].       
+00027df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027e00: 2020 2020 2069 6e74 6572 706f 6c61 7469       interpolati
+00027e10: 6f6e 732e 6170 7065 6e64 2863 7572 696e  ons.append(curin
+00027e20: 7465 7270 6f6c 6174 696f 6e29 0a20 2020  terpolation).   
+00027e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027e40: 2020 2020 2020 2020 2061 746f 6d69 6e74           atomint
+00027e50: 6572 6269 6e20 3d20 3120 6966 2063 7572  erbin = 1 if cur
+00027e60: 696e 7465 7270 6f6c 6174 696f 6e20 3e20  interpolation > 
+00027e70: 636f 6e74 6f75 7220 656c 7365 2030 0a20  contour else 0. 
+00027e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027e90: 2020 2020 2020 2020 2020 2072 6573 6174             resat
+00027ea0: 6f6d 696e 7465 7262 696e 202b 3d20 6174  ominterbin += at
+00027eb0: 6f6d 696e 7465 7262 696e 0a20 2020 2020  ominterbin.     
+00027ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027ed0: 2020 2020 2020 2069 6620 2748 2720 6e6f         if 'H' no
+00027ee0: 7420 696e 2061 746f 6d2e 6e61 6d65 3a0a  t in atom.name:.
+00027ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027f10: 6368 6169 6e61 746f 6d69 6e74 6572 6269  chainatominterbi
+00027f20: 6e20 2b3d 2061 746f 6d69 6e74 6572 6269  n += atominterbi
+00027f30: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
+00027f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027f50: 2020 6368 6169 6e5f 6174 6f6d 5f63 6f75    chain_atom_cou
+00027f60: 6e74 202b 3d20 310a 2020 2020 2020 2020  nt += 1.        
+00027f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027f80: 2020 2020 7375 6d61 746f 6d69 6e74 6572      sumatominter
+00027f90: 6269 6e20 2b3d 2061 746f 6d69 6e74 6572  bin += atominter
+00027fa0: 6269 6e0a 2020 2020 2020 2020 2020 2020  bin.            
+00027fb0: 2020 2020 2020 2020 2020 2020 6966 2072              if r
+00027fc0: 6573 6964 7565 5f61 746f 6d5f 636f 756e  esidue_atom_coun
+00027fd0: 7420 3d3d 2030 3a0a 2020 2020 2020 2020  t == 0:.        
+00027fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027ff0: 2020 2020 636f 6e74 696e 7565 0a20 2020      continue.   
+00028000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028010: 2020 2020 2023 2072 6573 6964 7565 2069       # residue i
+00028020: 6e63 6c75 7369 6f6e 2073 6563 7469 6f6e  nclusion section
+00028030: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028040: 2020 2020 2020 2020 206b 6579 7374 7220           keystr 
+00028050: 3d20 6368 6169 6e5f 6e61 6d65 202b 2027  = chain_name + '
+00028060: 3a27 202b 2073 7472 2872 6573 6964 7565  :' + str(residue
+00028070: 5f6e 6f29 202b 2072 6573 6964 7565 5f6e  _no) + residue_n
+00028080: 616d 650a 2020 2020 2020 2020 2020 2020  ame.            
+00028090: 2020 2020 2020 2020 2020 2020 616c 6c6b              allk
+000280a0: 6579 732e 6170 7065 6e64 286b 6579 7374  eys.append(keyst
+000280b0: 7229 0a20 2020 2020 2020 2020 2020 2020  r).             
+000280c0: 2020 2020 2020 2020 2020 2076 616c 7565             value
+000280d0: 203d 2066 6c6f 6174 2827 252e 3466 2720   = float('%.4f' 
+000280e0: 2520 726f 756e 6428 2866 6c6f 6174 2872  % round((float(r
+000280f0: 6573 6174 6f6d 696e 7465 7262 696e 2920  esatominterbin) 
+00028100: 2f20 7265 7369 6475 655f 6174 6f6d 5f63  / residue_atom_c
+00028110: 6f75 6e74 292c 2034 2929 0a20 2020 2020  ount), 4)).     
+00028120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028130: 2020 2061 6c6c 7661 6c75 6573 2e61 7070     allvalues.app
+00028140: 656e 6428 7661 6c75 6529 0a0a 2020 2020  end(value)..    
+00028150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028160: 2320 6368 6169 6e20 696e 636c 7573 696f  # chain inclusio
+00028170: 6e20 7365 6374 696f 6e0a 2020 2020 2020  n section.      
+00028180: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00028190: 2063 6861 696e 5f6e 616d 6520 696e 2063   chain_name in c
+000281a0: 6861 696e 6169 5f61 746f 6d73 6e6f 2e6b  hainai_atomsno.k
+000281b0: 6579 7328 293a 0a20 2020 2020 2020 2020  eys():.         
+000281c0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000281d0: 6861 696e 6174 6f6d 696e 7465 7262 696e  hainatominterbin
+000281e0: 202b 3d20 6368 6169 6e61 695f 6174 6f6d   += chainai_atom
+000281f0: 736e 6f5b 6368 6169 6e5f 6e61 6d65 5d5b  sno[chain_name][
+00028200: 2776 616c 7565 275d 0a20 2020 2020 2020  'value'].       
+00028210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028220: 2063 6861 696e 5f61 746f 6d5f 636f 756e   chain_atom_coun
+00028230: 7420 2b3d 2063 6861 696e 6169 5f61 746f  t += chainai_ato
+00028240: 6d73 6e6f 5b63 6861 696e 5f6e 616d 655d  msno[chain_name]
+00028250: 5b27 6174 6f6d 7369 6e63 6861 696e 275d  ['atomsinchain']
+00028260: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028270: 2020 2020 2023 2046 6f72 2063 6173 6573       # For cases
+00028280: 2077 6865 7265 206f 6e65 2077 6174 6572   where one water
+00028290: 206d 6f6c 6563 756c 6520 6861 7320 6120   molecule has a 
+000282a0: 7369 676c 6520 6275 7420 6469 6666 6572  sigle but differ
+000282b0: 656e 7420 6368 6169 6e20 6964 0a20 2020  ent chain id.   
+000282c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000282d0: 2069 6620 6368 6169 6e5f 6174 6f6d 5f63   if chain_atom_c
+000282e0: 6f75 6e74 203d 3d20 303a 0a20 2020 2020  ount == 0:.     
+000282f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028300: 2020 2063 6f6e 7469 6e75 650a 2020 2020     continue.    
+00028310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028320: 6368 6169 6e61 695f 6174 6f6d 736e 6f5b  chainai_atomsno[
+00028330: 6368 6169 6e5f 6e61 6d65 5d20 3d20 7b27  chain_name] = {'
+00028340: 7661 6c75 6527 3a20 6368 6169 6e61 746f  value': chainato
+00028350: 6d69 6e74 6572 6269 6e2c 2027 6174 6f6d  minterbin, 'atom
+00028360: 7369 6e63 6861 696e 273a 2063 6861 696e  sinchain': chain
+00028370: 5f61 746f 6d5f 636f 756e 747d 0a0a 2020  _atom_count}..  
+00028380: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00028390: 7220 6368 6169 6e6e 616d 652c 2063 6861  r chainname, cha
+000283a0: 696e 5f73 636f 7265 7320 696e 2063 6861  in_scores in cha
+000283b0: 696e 6169 5f61 746f 6d73 6e6f 2e69 7465  inai_atomsno.ite
+000283c0: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
+000283d0: 2020 2020 2020 2020 2020 6368 6169 6e5f            chain_
+000283e0: 6169 203d 2066 6c6f 6174 2827 252e 3366  ai = float('%.3f
+000283f0: 2720 2520 726f 756e 6428 2866 6c6f 6174  ' % round((float
+00028400: 2863 6861 696e 5f73 636f 7265 735b 2776  (chain_scores['v
+00028410: 616c 7565 275d 2920 2f20 6368 6169 6e5f  alue']) / chain_
+00028420: 7363 6f72 6573 5b27 6174 6f6d 7369 6e63  scores['atomsinc
+00028430: 6861 696e 275d 292c 2034 2929 0a20 2020  hain']), 4)).   
+00028440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028450: 2061 6963 6f6c 6f72 203d 2073 656c 662e   aicolor = self.
+00028460: 5f5f 666c 6f61 746f 6865 7828 5b63 6861  __floatohex([cha
+00028470: 696e 5f61 695d 295b 305d 0a20 2020 2020  in_ai])[0].     
+00028480: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00028490: 6861 696e 6169 7363 6f72 655b 6368 6169  hainaiscore[chai
+000284a0: 6e6e 616d 655d 203d 207b 2776 616c 7565  nname] = {'value
+000284b0: 273a 2063 6861 696e 5f61 692c 2027 636f  ': chain_ai, 'co
+000284c0: 6c6f 7227 3a20 6169 636f 6c6f 722c 2027  lor': aicolor, '
+000284d0: 6e75 6d62 6572 4f66 4174 6f6d 7327 3a20  numberOfAtoms': 
+000284e0: 6368 6169 6e5f 7363 6f72 6573 5b27 6174  chain_scores['at
+000284f0: 6f6d 7369 6e63 6861 696e 275d 7d0a 2020  omsinchain']}.  
+00028500: 2020 2020 2020 2020 2020 2020 2020 616c                al
+00028510: 6c63 6f6e 746f 7572 7364 6963 745b 7374  lcontoursdict[st
+00028520: 7228 636f 6e74 6f75 7229 5d20 3d20 2861  r(contour)] = (a
+00028530: 6c6c 6b65 7973 2c20 616c 6c76 616c 7565  llkeys, allvalue
+00028540: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+00028550: 2020 2070 7269 6e74 2827 4d6f 6465 6c3a     print('Model:
+00028560: 2025 7320 6174 2063 6f6e 746f 7572 206c   %s at contour l
+00028570: 6576 656c 2025 7320 6861 7320 2573 2061  evel %s has %s a
+00028580: 746f 6d73 2073 7469 636b 206f 7574 206f  toms stick out o
+00028590: 6620 7468 6520 6465 6e73 6974 792e 2720  f the density.' 
+000285a0: 2520 286d 6f64 656c 6e61 6d65 2c20 636f  % (modelname, co
+000285b0: 6e74 6f75 722c 0a20 2020 2020 2020 2020  ntour,.         
+000285c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000285d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000285e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000285f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028610: 2020 2020 2020 2061 746f 6d6f 7574 7369         atomoutsi
+00028620: 6465 6e75 6d29 290a 0a20 2020 2020 2020  denum))..       
+00028630: 2020 2020 2023 2072 6573 756c 745b 6d6f       # result[mo
+00028640: 6465 6c6e 616d 655d 203d 2028 696e 7465  delname] = (inte
+00028650: 7270 6f6c 6174 696f 6e73 2c20 616c 6c6b  rpolations, allk
+00028660: 6579 732c 2061 6c6c 7661 6c75 6573 290a  eys, allvalues).
+00028670: 2020 2020 2020 2020 2020 2020 2320 7265              # re
+00028680: 7375 6c74 3a20 7b6d 6f64 656c 6e61 6d65  sult: {modelname
+00028690: 2023 313a 2028 696e 7465 7270 6f6c 6174   #1: (interpolat
+000286a0: 696f 6e73 2023 312c 207b 636f 6e74 6f75  ions #1, {contou
+000286b0: 7231 3a20 2861 6c6c 6b65 7973 2c20 616c  r1: (allkeys, al
+000286c0: 6c76 616c 7565 7329 2c20 636f 6e74 6f75  lvalues), contou
+000286d0: 7232 3a20 2861 6c6c 6b65 7973 2c20 616c  r2: (allkeys, al
+000286e0: 6c76 616c 7565 7329 0a20 2020 2020 2020  lvalues).       
+000286f0: 2020 2020 2023 202e 2e2e 7d29 2c20 6d6f       # ...}), mo
+00028700: 6465 6c6e 616d 6520 2332 3a20 2869 6e74  delname #2: (int
+00028710: 6572 706f 6c61 7469 6f6e 7320 2332 2c20  erpolations #2, 
+00028720: 7b63 6f6e 746f 7572 313a 2028 616c 6c6b  {contour1: (allk
+00028730: 6579 732c 2061 6c6c 7661 6c75 6573 292c  eys, allvalues),
+00028740: 2e2e 2e7d 292c 2e2e 2e7d 0a20 2020 2020  ...}),...}.     
+00028750: 2020 2020 2020 2072 6573 756c 745b 6d6f         result[mo
+00028760: 6465 6c6e 616d 655d 203d 2028 696e 7465  delname] = (inte
+00028770: 7270 6f6c 6174 696f 6e73 2c20 616c 6c63  rpolations, allc
+00028780: 6f6e 746f 7572 7364 6963 742c 2063 6861  ontoursdict, cha
+00028790: 696e 6169 7363 6f72 652c 2061 746f 6d6f  inaiscore, atomo
+000287a0: 7574 7369 6465 6e75 6d29 0a0a 2020 2020  utsidenum)..    
+000287b0: 2020 2020 7265 7475 726e 2072 6573 756c      return resul
+000287c0: 740a 0a0a 2020 2020 6465 6620 6d61 705f  t...    def map_
+000287d0: 6d61 7472 6978 2873 656c 662c 2061 7069  matrix(self, api
+000287e0: 7873 2c20 616e 6773 293a 0a20 2020 2020  xs, angs):.     
+000287f0: 2020 2022 2222 0a0a 2020 2020 2020 2020     """..        
+00028800: 2020 2020 6361 6c63 756c 6174 6520 7468      calculate th
+00028810: 6520 6d61 7472 6978 2074 6f20 7472 616e  e matrix to tran
+00028820: 7366 6f72 6d20 4361 7274 6573 6961 6e20  sform Cartesian 
+00028830: 636f 6f72 6469 6e61 7465 7320 746f 2066  coordinates to f
+00028840: 7261 6374 696f 6e61 6c20 636f 6f72 6469  ractional coordi
+00028850: 6e61 7465 730a 2020 2020 2020 2020 2020  nates.          
+00028860: 2020 2863 6865 636b 2074 6865 2064 6566    (check the def
+00028870: 696e 696e 6174 696f 6e20 746f 2073 6565  inination to see
+00028880: 2074 6865 206d 6174 7269 7820 666f 726d   the matrix form
+00028890: 756c 6172 290a 0a20 2020 2020 2020 203a  ular)..        :
+000288a0: 7061 7261 6d20 6170 6978 733a 2061 7272  param apixs: arr
+000288b0: 6179 206f 6620 6170 6978 206c 656e 6768  ay of apix lengh
+000288c0: 740a 2020 2020 2020 2020 3a70 6172 616d  t.        :param
+000288d0: 2061 6e67 733a 2061 7272 6179 206f 6620   angs: array of 
+000288e0: 616e 676c 6578 2069 6e20 616c 7068 612c  anglex in alpha,
+000288f0: 2062 6574 612c 2067 616d 6d61 206f 7264   beta, gamma ord
+00028900: 6572 0a20 2020 2020 2020 203a 7265 7475  er.        :retu
+00028910: 726e 3a0a 2020 2020 2020 2020 2222 220a  rn:.        """.
+00028920: 0a20 2020 2020 2020 2061 6e67 203d 2028  .        ang = (
+00028930: 616e 6773 5b30 5d2a 6d61 7468 2e70 692f  angs[0]*math.pi/
+00028940: 3138 302c 2061 6e67 735b 315d 2a6d 6174  180, angs[1]*mat
+00028950: 682e 7069 2f31 3830 2c20 616e 6773 5b32  h.pi/180, angs[2
+00028960: 5d2a 6d61 7468 2e70 692f 3138 3029 0a20  ]*math.pi/180). 
+00028970: 2020 2020 2020 2069 6e73 6964 6573 7172         insidesqr
+00028980: 7420 3d20 3120 2b20 3220 2a20 6d61 7468  t = 1 + 2 * math
+00028990: 2e63 6f73 2861 6e67 5b30 5d29 202a 206d  .cos(ang[0]) * m
+000289a0: 6174 682e 636f 7328 616e 675b 315d 2920  ath.cos(ang[1]) 
+000289b0: 2a20 6d61 7468 2e63 6f73 2861 6e67 5b32  * math.cos(ang[2
+000289c0: 5d29 202d 205c 0a20 2020 2020 2020 2020  ]) - \.         
+000289d0: 2020 2020 2020 2020 2020 2020 6d61 7468              math
+000289e0: 2e63 6f73 2861 6e67 5b30 5d29 2a2a 3220  .cos(ang[0])**2 
+000289f0: 2d20 5c0a 2020 2020 2020 2020 2020 2020  - \.            
+00028a00: 2020 2020 2020 2020 206d 6174 682e 636f           math.co
+00028a10: 7328 616e 675b 315d 292a 2a32 202d 205c  s(ang[1])**2 - \
+00028a20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028a30: 2020 2020 2020 6d61 7468 2e63 6f73 2861        math.cos(a
+00028a40: 6e67 5b32 5d29 2a2a 320a 0a20 2020 2020  ng[2])**2..     
+00028a50: 2020 2063 656c 6c76 6f6c 756d 6520 3d20     cellvolume = 
+00028a60: 6170 6978 735b 305d 2a61 7069 7873 5b31  apixs[0]*apixs[1
+00028a70: 5d2a 6170 6978 735b 325d 2a6d 6174 682e  ]*apixs[2]*math.
+00028a80: 7371 7274 2869 6e73 6964 6573 7172 7429  sqrt(insidesqrt)
+00028a90: 0a0a 2020 2020 2020 2020 6d31 3120 3d20  ..        m11 = 
+00028aa0: 312f 6170 6978 735b 305d 0a20 2020 2020  1/apixs[0].     
+00028ab0: 2020 206d 3132 203d 202d 6d61 7468 2e63     m12 = -math.c
+00028ac0: 6f73 2861 6e67 5b32 5d29 2f28 6170 6978  os(ang[2])/(apix
+00028ad0: 735b 305d 2a6d 6174 682e 7369 6e28 616e  s[0]*math.sin(an
+00028ae0: 675b 325d 2929 0a0a 2020 2020 2020 2020  g[2]))..        
+00028af0: 6d31 3320 3d20 6170 6978 735b 315d 202a  m13 = apixs[1] *
+00028b00: 2061 7069 7873 5b32 5d20 2a20 286d 6174   apixs[2] * (mat
+00028b10: 682e 636f 7328 616e 675b 305d 2920 2a20  h.cos(ang[0]) * 
+00028b20: 6d61 7468 2e63 6f73 2861 6e67 5b32 5d29  math.cos(ang[2])
+00028b30: 202d 206d 6174 682e 636f 7328 616e 675b   - math.cos(ang[
+00028b40: 315d 2929 202f 2028 6365 6c6c 766f 6c75  1])) / (cellvolu
+00028b50: 6d65 202a 206d 6174 682e 7369 6e28 616e  me * math.sin(an
+00028b60: 675b 325d 2929 0a20 2020 2020 2020 206d  g[2])).        m
+00028b70: 3231 203d 2030 0a20 2020 2020 2020 206d  21 = 0.        m
+00028b80: 3232 203d 2031 202f 2028 6170 6978 735b  22 = 1 / (apixs[
+00028b90: 315d 202a 206d 6174 682e 7369 6e28 616e  1] * math.sin(an
+00028ba0: 675b 325d 2929 0a20 2020 2020 2020 206d  g[2])).        m
+00028bb0: 3233 203d 2061 7069 7873 5b30 5d20 2a20  23 = apixs[0] * 
+00028bc0: 6170 6978 735b 325d 202a 2028 6d61 7468  apixs[2] * (math
+00028bd0: 2e63 6f73 2861 6e67 5b31 5d29 202a 206d  .cos(ang[1]) * m
+00028be0: 6174 682e 636f 7328 616e 675b 325d 2920  ath.cos(ang[2]) 
+00028bf0: 2d20 6d61 7468 2e63 6f73 2861 6e67 5b30  - math.cos(ang[0
+00028c00: 5d29 2920 2f20 2863 656c 6c76 6f6c 756d  ])) / (cellvolum
+00028c10: 6520 2a20 6d61 7468 2e73 696e 2861 6e67  e * math.sin(ang
+00028c20: 5b32 5d29 290a 2020 2020 2020 2020 6d33  [2])).        m3
+00028c30: 3120 3d20 300a 2020 2020 2020 2020 6d33  1 = 0.        m3
+00028c40: 3220 3d20 300a 2020 2020 2020 2020 6d33  2 = 0.        m3
+00028c50: 3320 3d20 6170 6978 735b 305d 202a 2061  3 = apixs[0] * a
+00028c60: 7069 7873 5b31 5d20 2a20 6d61 7468 2e73  pixs[1] * math.s
+00028c70: 696e 2861 6e67 5b32 5d29 202f 2063 656c  in(ang[2]) / cel
+00028c80: 6c76 6f6c 756d 650a 2020 2020 2020 2020  lvolume.        
+00028c90: 7072 656d 6174 7269 7820 3d20 5b5b 6d31  prematrix = [[m1
+00028ca0: 312c 206d 3132 2c20 6d31 335d 2c20 5b6d  1, m12, m13], [m
+00028cb0: 3231 2c20 6d32 322c 206d 3233 5d2c 205b  21, m22, m23], [
+00028cc0: 6d33 312c 206d 3332 2c20 6d33 335d 5d0a  m31, m32, m33]].
+00028cd0: 2020 2020 2020 2020 6d61 7472 6978 203d          matrix =
+00028ce0: 206e 702e 6173 6172 7261 7928 7072 656d   np.asarray(prem
+00028cf0: 6174 7269 7829 0a0a 2020 2020 2020 2020  atrix)..        
+00028d00: 7265 7475 726e 206d 6174 7269 780a 0a0a  return matrix...
+00028d10: 2020 2020 6465 6620 6d61 7472 6978 5f69      def matrix_i
+00028d20: 6e64 6963 6573 2873 656c 662c 2061 7069  ndices(self, api
+00028d30: 7873 2c20 6f6e 6563 6f6f 7229 3a0a 2020  xs, onecoor):.  
+00028d40: 2020 2020 2020 2222 220a 0a20 2020 2020        """..     
+00028d50: 2020 2020 2020 204d 6574 686f 6420 323a         Method 2:
+00028d60: 2075 7369 6e67 2074 6865 2066 7261 6374   using the fract
+00028d70: 696f 6e61 6c20 636f 6f72 6469 6e61 7465  ional coordinate
+00028d80: 206d 6174 7269 7820 746f 2063 616c 6375   matrix to calcu
+00028d90: 6c61 7465 2074 6865 2069 6e64 6963 6573  late the indices
+00028da0: 2077 6865 6e20 7468 6520 6d61 7073 2061   when the maps a
+00028db0: 7265 206e 6f6e 2d6f 7274 686f 676f 6e61  re non-orthogona
+00028dc0: 6c0a 0a20 2020 2020 2020 203a 7265 7475  l..        :retu
+00028dd0: 726e 3a0a 2020 2020 2020 2020 2222 220a  rn:.        """.
+00028de0: 0a20 2020 2020 2020 2023 204d 6574 686f  .        # Metho
+00028df0: 6420 323a 2062 7920 7573 696e 6720 7468  d 2: by using th
+00028e00: 6520 6672 6163 7469 6f6e 616c 2063 6f6f  e fractional coo
+00028e10: 7264 696e 6174 6520 6d61 7472 6978 0a20  rdinate matrix. 
+00028e20: 2020 2020 2020 2023 2043 686f 7365 6e20         # Chosen 
+00028e30: 6173 2074 6865 206d 6169 6e20 6675 6e63  as the main func
+00028e40: 7469 6f6e 2066 6f72 2074 6865 2063 7572  tion for the cur
+00028e50: 7265 6e74 2069 6d70 6c65 6d65 6e74 6174  rent implementat
+00028e60: 696f 6e0a 0a20 2020 2020 2020 2023 2046  ion..        # F
+00028e70: 6967 7572 6520 6f75 7420 7468 6520 6f72  igure out the or
+00028e80: 6465 7220 6f66 2074 6865 2078 2c20 792c  der of the x, y,
+00028e90: 207a 2062 6173 6564 206f 6e20 6372 7320   z based on crs 
+00028ea0: 696e 666f 2069 6e20 7468 6520 6865 6164  info in the head
+00028eb0: 6572 0a20 2020 2020 2020 2023 2063 7273  er.        # crs
+00028ec0: 203d 206c 6973 7428 7365 6c66 2e6d 6170   = list(self.map
+00028ed0: 2e68 6561 6465 725b 3136 3a31 395d 290a  .header[16:19]).
+00028ee0: 2020 2020 2020 2020 6372 7320 3d20 5b73          crs = [s
+00028ef0: 656c 662e 6d61 702e 6865 6164 6572 2e6d  elf.map.header.m
+00028f00: 6170 632c 2073 656c 662e 6d61 702e 6865  apc, self.map.he
+00028f10: 6164 6572 2e6d 6170 722c 2073 656c 662e  ader.mapr, self.
+00028f20: 6d61 702e 6865 6164 6572 2e6d 6170 735d  map.header.maps]
+00028f30: 0a20 2020 2020 2020 2023 206f 7264 696e  .        # ordin
+00028f40: 6473 2073 6176 6520 7468 6520 696e 6469  ds save the indi
+00028f50: 6365 7320 636f 7272 6573 706f 6469 6e67  ces correspoding
+00028f60: 2074 6f20 782c 2079 202c 7a0a 2020 2020   to x, y ,z.    
+00028f70: 2020 2020 6f72 6469 6e64 7320 3d20 5b63      ordinds = [c
+00028f80: 7273 2e69 6e64 6578 2831 292c 2063 7273  rs.index(1), crs
+00028f90: 2e69 6e64 6578 2832 292c 2063 7273 2e69  .index(2), crs.i
+00028fa0: 6e64 6578 2833 295d 0a20 2020 2020 2020  ndex(3)].       
+00028fb0: 2023 2061 6e67 7320 3d20 7365 6c66 2e6d   # angs = self.m
+00028fc0: 6170 2e68 6561 6465 725b 3133 3a31 365d  ap.header[13:16]
+00028fd0: 0a20 2020 2020 2020 2061 6e67 7320 3d20  .        angs = 
+00028fe0: 5b73 656c 662e 6d61 702e 6865 6164 6572  [self.map.header
+00028ff0: 2e63 656c 6c62 2e61 6c70 6861 2c20 7365  .cellb.alpha, se
+00029000: 6c66 2e6d 6170 2e68 6561 6465 722e 6365  lf.map.header.ce
+00029010: 6c6c 622e 6265 7461 2c20 7365 6c66 2e6d  llb.beta, self.m
+00029020: 6170 2e68 6561 6465 722e 6365 6c6c 622e  ap.header.cellb.
+00029030: 6761 6d6d 615d 0a20 2020 2020 2020 206d  gamma].        m
+00029040: 6174 7269 7820 3d20 7365 6c66 2e6d 6170  atrix = self.map
+00029050: 5f6d 6174 7269 7828 6170 6978 732c 2061  _matrix(apixs, a
+00029060: 6e67 7329 0a20 2020 2020 2020 2072 6573  ngs).        res
+00029070: 756c 7420 3d20 6d61 7472 6978 2e64 6f74  ult = matrix.dot
+00029080: 286e 702e 6173 6172 7261 7928 6f6e 6563  (np.asarray(onec
+00029090: 6f6f 7229 290a 2020 2020 2020 2020 2320  oor)).        # 
+000290a0: 7869 6e64 6578 203d 2072 6573 756c 745b  xindex = result[
+000290b0: 305d 202d 2073 656c 662e 6d61 702e 6865  0] - self.map.he
+000290c0: 6164 6572 5b34 202b 206f 7264 696e 6473  ader[4 + ordinds
+000290d0: 5b30 5d5d 0a20 2020 2020 2020 2023 2079  [0]].        # y
+000290e0: 696e 6465 7820 3d20 7265 7375 6c74 5b31  index = result[1
+000290f0: 5d20 2d20 7365 6c66 2e6d 6170 2e68 6561  ] - self.map.hea
+00029100: 6465 725b 3420 2b20 6f72 6469 6e64 735b  der[4 + ordinds[
+00029110: 315d 5d0a 2020 2020 2020 2020 2320 7a69  1]].        # zi
+00029120: 6e64 6578 203d 2072 6573 756c 745b 325d  ndex = result[2]
+00029130: 202d 2073 656c 662e 6d61 702e 6865 6164   - self.map.head
+00029140: 6572 5b34 202b 206f 7264 696e 6473 5b32  er[4 + ordinds[2
+00029150: 5d5d 0a20 2020 2020 2020 2078 696e 6465  ]].        xinde
+00029160: 7820 3d20 7265 7375 6c74 5b30 5d20 2d20  x = result[0] - 
+00029170: 7365 6c66 2e6d 6170 2e68 6561 6465 722e  self.map.header.
+00029180: 6e78 7374 6172 740a 2020 2020 2020 2020  nxstart.        
+00029190: 7969 6e64 6578 203d 2072 6573 756c 745b  yindex = result[
+000291a0: 315d 202d 2073 656c 662e 6d61 702e 6865  1] - self.map.he
+000291b0: 6164 6572 2e6e 7973 7461 7274 0a20 2020  ader.nystart.   
+000291c0: 2020 2020 207a 696e 6465 7820 3d20 7265       zindex = re
+000291d0: 7375 6c74 5b32 5d20 2d20 7365 6c66 2e6d  sult[2] - self.m
+000291e0: 6170 2e68 6561 6465 722e 6e7a 7374 6172  ap.header.nzstar
+000291f0: 740a 0a20 2020 2020 2020 2072 6574 7572  t..        retur
+00029200: 6e20 2878 696e 6465 782c 2079 696e 6465  n (xindex, yinde
+00029210: 782c 207a 696e 6465 7829 0a0a 0a20 2020  x, zindex)...   
+00029220: 2064 6566 2070 726f 6a65 6374 696f 6e5f   def projection_
+00029230: 696e 6469 6365 7328 7365 6c66 2c20 6f6e  indices(self, on
+00029240: 6563 6f6f 7229 3a0a 2020 2020 2020 2020  ecoor):.        
+00029250: 2222 220a 0a20 2020 2020 2020 2020 2020  """..           
+00029260: 204d 6574 686f 6420 313a 2075 7369 6e67   Method 1: using
+00029270: 2074 6865 2070 726f 6a65 6374 696f 6e20   the projection 
+00029280: 7761 7920 746f 2063 616c 6375 6c61 7465  way to calculate
+00029290: 2074 6865 2069 6e64 6963 6573 2077 6865   the indices whe
+000292a0: 6e20 7468 6520 6d61 7073 2061 7265 206e  n the maps are n
+000292b0: 6f6e 2d6f 7274 686f 676f 6e61 6c0a 0a20  on-orthogonal.. 
+000292c0: 2020 2020 2020 203a 7265 7475 726e 3a20         :return: 
+000292d0: 7475 6d70 6c65 2077 6869 6368 2063 6f6e  tumple which con
+000292e0: 7461 696e 7320 616c 6c20 7468 7265 6520  tains all three 
+000292f0: 666c 6f61 7420 6e65 7720 696e 6469 6365  float new indice
+00029300: 7320 696e 2028 782c 2079 2c20 7a29 206f  s in (x, y, z) o
+00029310: 7264 6572 0a20 2020 2020 2020 2022 2222  rder.        """
+00029320: 0a0a 2020 2020 2020 2020 6d61 7020 3d20  ..        map = 
+00029330: 7365 6c66 2e6d 6170 0a20 2020 2020 2020  self.map.       
+00029340: 207a 6469 6d20 3d20 6d61 702e 6865 6164   zdim = map.head
+00029350: 6572 5b31 325d 0a20 2020 2020 2020 207a  er[12].        z
+00029360: 6e69 6e74 6572 7661 6c73 203d 206d 6170  nintervals = map
+00029370: 2e68 6561 6465 725b 395d 0a20 2020 2020  .header[9].     
+00029380: 2020 207a 5f61 7069 7820 3d20 7a64 696d     z_apix = zdim
+00029390: 202f 207a 6e69 6e74 6572 7661 6c73 0a0a   / znintervals..
+000293a0: 2020 2020 2020 2020 7964 696d 203d 206d          ydim = m
+000293b0: 6170 2e68 6561 6465 725b 3131 5d0a 2020  ap.header[11].  
+000293c0: 2020 2020 2020 796e 696e 7465 7276 616c        yninterval
+000293d0: 7320 3d20 6d61 702e 6865 6164 6572 5b38  s = map.header[8
+000293e0: 5d0a 2020 2020 2020 2020 795f 6170 6978  ].        y_apix
+000293f0: 203d 2079 6469 6d20 2f20 796e 696e 7465   = ydim / yninte
+00029400: 7276 616c 730a 0a20 2020 2020 2020 2078  rvals..        x
+00029410: 6469 6d20 3d20 6d61 702e 6865 6164 6572  dim = map.header
+00029420: 5b31 305d 0a20 2020 2020 2020 2078 6e69  [10].        xni
+00029430: 6e74 6572 7661 6c73 203d 206d 6170 2e68  ntervals = map.h
+00029440: 6561 6465 725b 375d 0a20 2020 2020 2020  eader[7].       
+00029450: 2078 5f61 7069 7820 3d20 7864 696d 202f   x_apix = xdim /
+00029460: 2078 6e69 6e74 6572 7661 6c73 0a0a 2020   xnintervals..  
+00029470: 2020 2020 2020 7468 6574 6120 3d20 286d        theta = (m
+00029480: 6170 2e68 6561 6465 725b 3133 5d20 2f20  ap.header[13] / 
+00029490: 3930 2920 2a20 286d 6174 682e 7069 202f  90) * (math.pi /
+000294a0: 2032 290a 2020 2020 2020 2020 6265 7461   2).        beta
+000294b0: 203d 2028 6d61 702e 6865 6164 6572 5b31   = (map.header[1
+000294c0: 345d 202f 2039 3029 202a 2028 6d61 7468  4] / 90) * (math
+000294d0: 2e70 6920 2f20 3229 0a20 2020 2020 2020  .pi / 2).       
+000294e0: 2067 616d 6d61 203d 2028 6d61 702e 6865   gamma = (map.he
+000294f0: 6164 6572 5b31 355d 202f 2039 3029 202a  ader[15] / 90) *
+00029500: 2028 6d61 7468 2e70 6920 2f20 3229 0a0a   (math.pi / 2)..
+00029510: 2020 2020 2020 2020 696e 7369 6465 7371          insidesq
+00029520: 7274 203d 2031 202b 2032 202a 206d 6174  rt = 1 + 2 * mat
+00029530: 682e 636f 7328 7468 6574 6129 202a 206d  h.cos(theta) * m
+00029540: 6174 682e 636f 7328 6265 7461 2920 2a20  ath.cos(beta) * 
+00029550: 6d61 7468 2e63 6f73 2867 616d 6d61 2920  math.cos(gamma) 
+00029560: 2d20 5c0a 2020 2020 2020 2020 2020 2020  - \.            
+00029570: 2020 2020 2020 2020 206d 6174 682e 636f           math.co
+00029580: 7328 7468 6574 6129 202a 206d 6174 682e  s(theta) * math.
+00029590: 636f 7328 7468 6574 6129 202d 205c 0a20  cos(theta) - \. 
+000295a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000295b0: 2020 2020 6d61 7468 2e63 6f73 2862 6574      math.cos(bet
+000295c0: 6129 202a 206d 6174 682e 636f 7328 6265  a) * math.cos(be
+000295d0: 7461 2920 2d20 5c0a 2020 2020 2020 2020  ta) - \.        
+000295e0: 2020 2020 2020 2020 2020 2020 206d 6174               mat
+000295f0: 682e 636f 7328 6761 6d6d 6129 202a 206d  h.cos(gamma) * m
+00029600: 6174 682e 636f 7328 6761 6d6d 6129 0a0a  ath.cos(gamma)..
+00029610: 2020 2020 2020 2020 6365 6c6c 766f 6c75          cellvolu
+00029620: 6d65 203d 2078 5f61 7069 7820 2a20 795f  me = x_apix * y_
+00029630: 6170 6978 202a 207a 5f61 7069 7820 2a20  apix * z_apix * 
+00029640: 6d61 7468 2e73 7172 7428 696e 7369 6465  math.sqrt(inside
+00029650: 7371 7274 290a 0a20 2020 2020 2020 2063  sqrt)..        c
+00029660: 656c 6c68 6569 6768 747a 203d 2063 656c  ellheightz = cel
+00029670: 6c76 6f6c 756d 6520 2f20 2878 5f61 7069  lvolume / (x_api
+00029680: 7820 2a20 795f 6170 6978 202a 206d 6174  x * y_apix * mat
+00029690: 682e 7369 6e28 6761 6d6d 6129 290a 2020  h.sin(gamma)).  
+000296a0: 2020 2020 2020 6365 6c6c 6865 6967 6874        cellheight
+000296b0: 7920 3d20 6365 6c6c 766f 6c75 6d65 202f  y = cellvolume /
+000296c0: 2028 785f 6170 6978 202a 207a 5f61 7069   (x_apix * z_api
+000296d0: 7820 2a20 6d61 7468 2e73 696e 2862 6574  x * math.sin(bet
+000296e0: 6129 290a 2020 2020 2020 2020 6365 6c6c  a)).        cell
+000296f0: 6865 6967 6874 7820 3d20 6365 6c6c 766f  heightx = cellvo
+00029700: 6c75 6d65 202f 2028 7a5f 6170 6978 202a  lume / (z_apix *
+00029710: 2079 5f61 7069 7820 2a20 6d61 7468 2e73   y_apix * math.s
+00029720: 696e 2874 6865 7461 2929 0a0a 2020 2020  in(theta))..    
+00029730: 2020 2020 2320 4669 6775 7265 206f 7574      # Figure out
+00029740: 2074 6865 206f 7264 6572 206f 6620 7468   the order of th
+00029750: 6520 782c 2079 2c20 7a20 6261 7365 6420  e x, y, z based 
+00029760: 6f6e 2063 7273 2069 6e66 6f20 696e 2074  on crs info in t
+00029770: 6865 2068 6561 6465 720a 2020 2020 2020  he header.      
+00029780: 2020 6372 7320 3d20 6c69 7374 286d 6170    crs = list(map
+00029790: 2e68 6561 6465 725b 3136 3a31 395d 290a  .header[16:19]).
+000297a0: 2020 2020 2020 2020 2320 6f72 6469 6e64          # ordind
+000297b0: 7320 7361 7665 2074 6865 2069 6e64 6963  s save the indic
+000297c0: 6573 2063 6f72 7265 7370 6f64 696e 6720  es correspoding 
+000297d0: 746f 2078 2c20 7920 2c7a 0a20 2020 2020  to x, y ,z.     
+000297e0: 2020 206f 7264 696e 6473 203d 205b 6372     ordinds = [cr
+000297f0: 732e 696e 6465 7828 3129 2c20 6372 732e  s.index(1), crs.
+00029800: 696e 6465 7828 3229 2c20 6372 732e 696e  index(2), crs.in
+00029810: 6465 7828 3329 5d0a 0a20 2020 2020 2020  dex(3)]..       
+00029820: 2023 204d 6568 746f 6420 313a 2043 616c   # Mehtod 1: Cal
+00029830: 6375 6c61 7465 696e 6720 7468 6520 6469  culateing the di
+00029840: 7374 616e 6365 7320 6672 6f6d 2074 6865  stances from the
+00029850: 2061 746f 6d20 746f 2064 6966 6665 7265   atom to differe
+00029860: 6e74 2070 6c61 6e65 7328 7827 7927 2c20  nt planes(x'y', 
+00029870: 7827 7a27 2c20 7927 7a27 2920 616e 6420  x'z', y'z') and 
+00029880: 6469 7669 6465 6420 6279 0a20 2020 2020  divided by.     
+00029890: 2020 2023 2054 6865 2075 6e69 7420 6365     # The unit ce
+000298a0: 6c6c 2068 6569 6768 7428 6361 6c63 756c  ll height(calcul
+000298b0: 6174 6564 2062 7920 7573 696e 6720 756e  ated by using un
+000298c0: 6974 2063 656c 6c20 766f 6c75 6d65 2064  it cell volume d
+000298d0: 6976 6964 6564 2062 7920 7468 6520 706c  ivided by the pl
+000298e0: 616e 6520 7375 7266 6163 6520 6172 6561  ane surface area
+000298f0: 2920 746f 2067 6574 2074 6865 0a20 2020  ) to get the.   
+00029900: 2020 2020 2023 2069 6e64 6963 6573 2c20       # indices, 
+00029910: 7468 656e 2064 6564 7563 7420 7468 6520  then deduct the 
+00029920: 6f72 6967 696e 2069 6e64 6578 2077 6869  origin index whi
+00029930: 6368 2067 6976 6520 7468 6520 6669 6e61  ch give the fina
+00029940: 6c20 7265 7375 6c74 732e 2057 6865 6e20  l results. When 
+00029950: 6361 6c63 756c 6174 696e 6720 7468 6520  calculating the 
+00029960: 7369 676e 206f 6620 7468 650a 2020 2020  sign of the.    
+00029970: 2020 2020 2320 6469 7374 616e 6365 2c20      # distance, 
+00029980: 6669 6e64 2061 2070 6c61 6e65 2070 6172  find a plane par
+00029990: 616c 6c65 6c20 746f 2074 6865 2070 726f  allel to the pro
+000299a0: 6a65 6374 696f 6e20 706c 616e 6520 616e  jection plane an
+000299b0: 6420 6974 2070 6173 7320 7468 726f 7567  d it pass throug
+000299c0: 6820 7468 6520 6174 6f6d 2c20 7468 6520  h the atom, the 
+000299d0: 6375 746f 6666 206f 6620 7468 6973 0a20  cutoff of this. 
+000299e0: 2020 2020 2020 2023 2070 6c61 6e65 2061         # plane a
+000299f0: 6e64 2074 6865 2063 6f72 7265 7370 6f64  nd the correspod
+00029a00: 696e 6720 6178 6973 2067 6976 6520 7468  ing axis give th
+00029a10: 6520 6c6f 6361 7469 6f6e 206f 6620 7468  e location of th
+00029a20: 6520 6174 6f6d 2070 726f 6a65 6374 696f  e atom projectio
+00029a30: 6e20 6375 746f 6666 2061 7420 7468 6520  n cutoff at the 
+00029a40: 6178 6973 0a20 2020 2020 2020 2023 2028  axis.        # (
+00029a50: 7468 6973 2073 686f 756c 6420 616c 736f  this should also
+00029a60: 2062 6520 6162 6c65 2074 6f20 7573 6564   be able to used
+00029a70: 2074 6f20 6361 6c63 756c 6174 6520 7468   to calculate th
+00029a80: 6520 6669 6e61 6c20 696e 6469 6365 7328  e final indices(
+00029a90: 6e6f 7420 7472 6965 6429 292e 2049 6620  not tried)). If 
+00029aa0: 7468 6973 2070 6f69 6e74 2069 7320 6f75  this point is ou
+00029ab0: 7473 6964 650a 2020 2020 2020 2020 2320  tside.        # 
+00029ac0: 7468 6520 6e6f 726d 616c 2063 656c 6c20  the normal cell 
+00029ad0: 6469 6d65 6e73 696f 6e20 7261 6e67 652c  dimension range,
+00029ae0: 2074 6865 6e20 7468 6520 6469 7374 616e   then the distan
+00029af0: 6365 2073 686f 756c 6420 6265 206e 6567  ce should be neg
+00029b00: 6174 6976 6520 616e 6420 7669 6365 2076  ative and vice v
+00029b10: 6572 7365 0a20 2020 2020 2020 2072 656c  erse.        rel
+00029b20: 6174 6976 6578 203d 206f 6e65 636f 6f72  ativex = onecoor
+00029b30: 5b30 5d20 2d20 6d61 702e 6865 6164 6572  [0] - map.header
+00029b40: 5b34 395d 0a20 2020 2020 2020 2072 656c  [49].        rel
+00029b50: 6174 6976 6579 203d 206f 6e65 636f 6f72  ativey = onecoor
+00029b60: 5b31 5d20 2d20 6d61 702e 6865 6164 6572  [1] - map.header
+00029b70: 5b35 305d 0a20 2020 2020 2020 2072 656c  [50].        rel
+00029b80: 6174 6976 657a 203d 206f 6e65 636f 6f72  ativez = onecoor
+00029b90: 5b32 5d20 2d20 6d61 702e 6865 6164 6572  [2] - map.header
+00029ba0: 5b35 315d 0a0a 2020 2020 2020 2020 2320  [51]..        # 
+00029bb0: 5a20 696e 6465 7820 6279 2075 7369 6e67  Z index by using
+00029bc0: 2074 6865 2072 656c 6174 6976 657a 202f   the relativez /
+00029bd0: 2063 656c 6c68 6569 6768 747a 0a20 2020   cellheightz.   
+00029be0: 2020 2020 207a 696e 6420 3d20 7265 6c61       zind = rela
+00029bf0: 7469 7665 7a20 2f20 6365 6c6c 6865 6967  tivez / cellheig
+00029c00: 6874 7a0a 2020 2020 2020 2020 7a69 6e64  htz.        zind
+00029c10: 6578 203d 207a 696e 6420 2d20 6d61 702e  ex = zind - map.
+00029c20: 6865 6164 6572 5b34 202b 206f 7264 696e  header[4 + ordin
+00029c30: 6473 5b32 5d5d 0a0a 2020 2020 2020 2020  ds[2]]..        
+00029c40: 2320 5820 696e 6465 7820 6279 2063 616c  # X index by cal
+00029c50: 6375 6c61 7469 6e67 2074 6865 2070 6c61  culating the pla
+00029c60: 6e65 2066 6972 7374 2061 6e64 2074 6865  ne first and the
+00029c70: 6e20 6361 6c63 756c 6174 6520 7468 6520  n calculate the 
+00029c80: 6469 7374 616e 6365 2066 726f 6d20 6174  distance from at
+00029c90: 6f6d 2074 6f20 706c 616e 650a 2020 2020  om to plane.    
+00029ca0: 2020 2020 2320 506c 616e 6520 7827 7a27      # Plane x'z'
+00029cb0: 0a20 2020 2020 2020 2023 2041 7820 2b20  .        # Ax + 
+00029cc0: 4279 202b 2043 7a20 2b20 4420 3d20 3020  By + Cz + D = 0 
+00029cd0: 7769 7468 2074 6872 6565 2064 6174 6120  with three data 
+00029ce0: 706f 696e 7473 3a20 2830 2c20 302c 2030  points: (0, 0, 0
+00029cf0: 292c 2028 622c 2030 2c20 3029 2c0a 2020  ), (b, 0, 0),.  
+00029d00: 2020 2020 2020 2320 2861 2a63 6f73 2861        # (a*cos(a
+00029d10: 6c70 6861 292c 2073 7172 7428 612a 2a32  lpha), sqrt(a**2
+00029d20: 202d 2028 6365 6c6c 6c68 7a29 2a2a 3220   - (celllhz)**2 
+00029d30: 2d20 2861 2a63 6f73 2861 6c70 6861 292a  - (a*cos(alpha)*
+00029d40: 2a32 292c 2063 656c 6c68 7a29 2c20 7827  *2), cellhz), x'
+00029d50: 2075 6e69 7420 6365 6c6c 206c 656e 6774   unit cell lengt
+00029d60: 6820 6973 2062 2c20 616c 7068 6120 6973  h is b, alpha is
+00029d70: 0a20 2020 2020 2020 2023 2074 6865 2061  .        # the a
+00029d80: 6e67 6c65 2062 6574 7765 656e 2078 2720  ngle between x' 
+00029d90: 616e 6420 7a27 2877 6869 6368 2061 7265  and z'(which are
+00029da0: 2074 6865 2063 656c 6c20 6178 6573 290a   the cell axes).
+00029db0: 2020 2020 2020 2020 2320 4279 2075 7369          # By usi
+00029dc0: 6e67 2074 6865 7365 2074 6872 6565 2070  ng these three p
+00029dd0: 6f69 6e74 7320 7468 6520 706c 616e 6520  oints the plane 
+00029de0: 6f66 2078 277a 2720 6361 6e20 6265 2063  of x'z' can be c
+00029df0: 616c 6375 6c61 7465 640a 2020 2020 2020  alculated.      
+00029e00: 2020 2320 413d 302c 2042 3d63 656c 6c68    # A=0, B=cellh
+00029e10: 7a2c 2043 203d 202d 7371 7274 2861 2a2a  z, C = -sqrt(a**
+00029e20: 3220 2d20 2863 656c 6c68 7a29 2a2a 3220  2 - (cellhz)**2 
+00029e30: 2d20 2861 2a63 6f73 2861 6c70 6861 2929  - (a*cos(alpha))
+00029e40: 2a2a 3229 2c20 443d 300a 2020 2020 2020  **2), D=0.      
+00029e50: 2020 4120 3d20 300a 2020 2020 2020 2020    A = 0.        
+00029e60: 4220 3d20 6365 6c6c 6865 6967 6874 7a0a  B = cellheightz.
+00029e70: 2020 2020 2020 2020 4320 3d20 2d6d 6174          C = -mat
+00029e80: 682e 7371 7274 287a 5f61 7069 7820 2a2a  h.sqrt(z_apix **
+00029e90: 2032 202d 2063 656c 6c68 6569 6768 747a   2 - cellheightz
+00029ea0: 202a 2a20 3220 2d20 287a 5f61 7069 7820   ** 2 - (z_apix 
+00029eb0: 2a20 6d61 7468 2e63 6f73 2862 6574 6129  * math.cos(beta)
+00029ec0: 2920 2a2a 2032 290a 2020 2020 2020 2020  ) ** 2).        
+00029ed0: 4420 3d20 300a 0a20 2020 2020 2020 2023  D = 0..        #
+00029ee0: 2064 6973 7461 6e63 6520 6672 6f6d 2061   distance from a
+00029ef0: 746f 6d20 746f 2078 277a 2720 706c 616e  tom to x'z' plan
+00029f00: 653a 0a20 2020 2020 2020 2023 2020 2020  e:.        #    
+00029f10: 2020 2020 207c 4178 202b 2042 7920 2b20       |Ax + By + 
+00029f20: 437a 202b 2044 7c0a 2020 2020 2020 2020  Cz + D|.        
+00029f30: 2320 6420 3d20 2d2d 2d2d 2d2d 2d2d 2d2d  # d = ----------
+00029f40: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00029f50: 2d2d 2d0a 2020 2020 2020 2020 2320 2020  ---.        #   
+00029f60: 2020 2020 7371 7274 2841 2a2a 3220 2b20      sqrt(A**2 + 
+00029f70: 422a 2a32 202b 2043 2a2a 3229 0a20 2020  B**2 + C**2).   
+00029f80: 2020 2020 2064 7920 3d20 6d61 7468 2e66       dy = math.f
+00029f90: 6162 7328 4220 2a20 7265 6c61 7469 7665  abs(B * relative
+00029fa0: 7920 2b20 4320 2a20 7265 6c61 7469 7665  y + C * relative
+00029fb0: 7a29 202f 206d 6174 682e 7371 7274 2841  z) / math.sqrt(A
+00029fc0: 202a 2a20 3220 2b20 4220 2a2a 2032 202b   ** 2 + B ** 2 +
+00029fd0: 2043 202a 2a20 3229 0a0a 2020 2020 2020   C ** 2)..      
+00029fe0: 2020 2320 5468 6520 7061 7261 6c6c 656c    # The parallel
+00029ff0: 2070 6c61 6e20 7768 6963 6820 7061 7373   plan which pass
+0002a000: 2074 6865 2061 746f 6d20 616e 6420 696e   the atom and in
+0002a010: 7465 7273 6563 7420 7769 7468 2074 6865  tersect with the
+0002a020: 2078 2069 733a 0a20 2020 2020 2020 2023   x is:.        #
+0002a030: 2041 7829 202b 2042 2879 202b 2061 2920   Ax) + B(y + a) 
+0002a040: 2b20 437a 202b 2044 203d 2030 0a20 2020  + Cz + D = 0.   
+0002a050: 2020 2020 2023 2061 203d 202d 2841 7820       # a = -(Ax 
+0002a060: 2b20 4279 202b 2043 7a20 2b20 4429 2f41  + By + Cz + D)/A
+0002a070: 0a20 2020 2020 2020 2023 2078 6375 7420  .        # xcut 
+0002a080: 3d20 2d61 0a20 2020 2020 2020 2079 6375  = -a.        ycu
+0002a090: 7420 3d20 2d28 4120 2a20 6f6e 6563 6f6f  t = -(A * onecoo
+0002a0a0: 725b 305d 202b 206f 6e65 636f 6f72 5b31  r[0] + onecoor[1
+0002a0b0: 5d20 2b20 2843 202f 2042 2920 2a20 6f6e  ] + (C / B) * on
+0002a0c0: 6563 6f6f 725b 325d 290a 2020 2020 2020  ecoor[2]).      
+0002a0d0: 2020 7963 7574 203d 202d 7963 7574 0a20    ycut = -ycut. 
+0002a0e0: 2020 2020 2020 2069 6620 7963 7574 203c         if ycut <
+0002a0f0: 2030 206f 7220 7963 7574 203e 206d 6170   0 or ycut > map
+0002a100: 2e68 6561 6465 725b 3020 2b20 6f72 6469  .header[0 + ordi
+0002a110: 6e64 735b 315d 5d20 2a20 795f 6170 6978  nds[1]] * y_apix
+0002a120: 202a 206d 6174 682e 7369 6e28 6761 6d6d   * math.sin(gamm
+0002a130: 6129 3a0a 2020 2020 2020 2020 2020 2020  a):.            
+0002a140: 6479 203d 202d 6479 0a0a 2020 2020 2020  dy = -dy..      
+0002a150: 2020 7969 6e64 203d 2064 7920 2f20 6365    yind = dy / ce
+0002a160: 6c6c 6865 6967 6874 790a 2020 2020 2020  llheighty.      
+0002a170: 2020 7969 6e64 6578 203d 2079 696e 6420    yindex = yind 
+0002a180: 2d20 6d61 702e 6865 6164 6572 5b34 202b  - map.header[4 +
+0002a190: 206f 7264 696e 6473 5b31 5d5d 0a0a 2020   ordinds[1]]..  
+0002a1a0: 2020 2020 2020 2320 506c 616e 6520 7a27        # Plane z'
+0002a1b0: 7927 0a20 2020 2020 2020 2023 2041 7820  y'.        # Ax 
+0002a1c0: 2b20 4279 202b 2043 7a20 2b20 4420 3d20  + By + Cz + D = 
+0002a1d0: 3020 7769 7468 2074 6872 6565 2064 6174  0 with three dat
+0002a1e0: 6120 706f 696e 7473 3a20 2830 2c20 302c  a points: (0, 0,
+0002a1f0: 2030 292c 2028 612a 636f 7328 616c 7068   0), (a*cos(alph
+0002a200: 6129 2c0a 2020 2020 2020 2020 2320 7371  a),.        # sq
+0002a210: 7274 2861 2a2a 3220 2d20 2863 656c 6c68  rt(a**2 - (cellh
+0002a220: 7a29 2a2a 3220 2d20 2861 2a63 6f73 2861  z)**2 - (a*cos(a
+0002a230: 6c70 6861 292a 2a32 292c 2063 656c 6c68  lpha)**2), cellh
+0002a240: 7a29 2c0a 2020 2020 2020 2020 2320 2864  z),.        # (d
+0002a250: 2a63 6f73 2867 616d 6d61 292c 2064 2a73  *cos(gamma), d*s
+0002a260: 696e 2867 616d 6d61 292c 2030 290a 2020  in(gamma), 0).  
+0002a270: 2020 2020 2020 2320 6265 7461 2069 7320        # beta is 
+0002a280: 7468 6520 616e 676c 6520 6265 7477 6565  the angle betwee
+0002a290: 6e20 7827 2061 6e64 207a 273b 2067 616d  n x' and z'; gam
+0002a2a0: 6d61 2069 7320 7468 6520 616e 676c 6520  ma is the angle 
+0002a2b0: 6265 7477 6565 6e20 7827 2061 6e64 2079  between x' and y
+0002a2c0: 273b 2064 2069 7320 7468 6520 6365 6c6c  '; d is the cell
+0002a2d0: 2075 6e69 7420 6c65 6e67 7468 0a20 2020   unit length.   
+0002a2e0: 2020 2020 2023 2061 6c6f 6e67 2079 270a       # along y'.
+0002a2f0: 2020 2020 2020 2020 2320 5573 696e 6720          # Using 
+0002a300: 7468 6573 6520 7468 7265 6520 706f 696e  these three poin
+0002a310: 7473 2061 2070 6c61 6e65 2063 616e 2062  ts a plane can b
+0002a320: 6520 6361 6c63 756c 6174 6564 0a20 2020  e calculated.   
+0002a330: 2020 2020 2023 2041 3d2d 7467 2862 6574       # A=-tg(bet
+0002a340: 6129 2c20 4220 3d20 312c 2044 3d30 2c0a  a), B = 1, D=0,.
+0002a350: 2020 2020 2020 2020 2320 2020 2020 2061          #      a
+0002a360: 2a63 6f73 2861 6c70 6861 292a 7467 2862  *cos(alpha)*tg(b
+0002a370: 6574 6129 202d 2074 0a20 2020 2020 2020  eta) - t.       
+0002a380: 2023 2043 203d 202d 2d2d 2d2d 2d2d 2d2d   # C = ---------
+0002a390: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0002a3a0: 2d2d 202c 2020 2020 2074 203d 2073 7172  -- ,     t = sqr
+0002a3b0: 7428 612a 2a32 202d 2028 6365 6c6c 687a  t(a**2 - (cellhz
+0002a3c0: 292a 2a32 202d 2028 612a 636f 7328 616c  )**2 - (a*cos(al
+0002a3d0: 7068 6129 292a 2a32 290a 2020 2020 2020  pha))**2).      
+0002a3e0: 2020 2320 2020 2020 2020 2020 2020 2063    #            c
+0002a3f0: 656c 6c68 7a0a 2020 2020 2020 2020 2320  ellhz.        # 
+0002a400: 4120 3d20 2d6d 6174 682e 7461 6e28 6761  A = -math.tan(ga
+0002a410: 6d6d 6129 0a20 2020 2020 2020 2023 2042  mma).        # B
+0002a420: 203d 2031 0a20 2020 2020 2020 2023 2044   = 1.        # D
+0002a430: 203d 2030 0a20 2020 2020 2020 2023 2074   = 0.        # t
+0002a440: 203d 206d 6174 682e 7371 7274 287a 5f61   = math.sqrt(z_a
+0002a450: 7069 782a 2a32 202d 2063 656c 6c68 6569  pix**2 - cellhei
+0002a460: 6768 747a 2a2a 3220 2d20 287a 5f61 7069  ghtz**2 - (z_api
+0002a470: 782a 6d61 7468 2e63 6f73 2862 6574 6129  x*math.cos(beta)
+0002a480: 292a 2a32 290a 2020 2020 2020 2020 2320  )**2).        # 
+0002a490: 4320 3d20 287a 5f61 7069 7820 2a20 6d61  C = (z_apix * ma
+0002a4a0: 7468 2e63 6f73 2862 6574 6129 2a6d 6174  th.cos(beta)*mat
+0002a4b0: 682e 7461 6e28 6761 6d6d 6129 202d 2074  h.tan(gamma) - t
+0002a4c0: 2920 2f20 6365 6c6c 6865 6967 6874 7a0a  ) / cellheightz.
+0002a4d0: 0a20 2020 2020 2020 2069 6620 6d61 702e  .        if map.
+0002a4e0: 6865 6164 6572 5b31 355d 203d 3d20 3930  header[15] == 90
+0002a4f0: 2e3a 0a20 2020 2020 2020 2020 2020 2073  .:.            s
+0002a500: 696e 6761 6d6d 6120 3d20 312e 0a20 2020  ingamma = 1..   
+0002a510: 2020 2020 2020 2020 2063 6f73 6761 6d6d           cosgamm
+0002a520: 6120 3d20 302e 0a20 2020 2020 2020 2065  a = 0..        e
+0002a530: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0002a540: 2073 696e 6761 6d6d 6120 3d20 6d61 7468   singamma = math
+0002a550: 2e73 696e 2867 616d 6d61 290a 2020 2020  .sin(gamma).    
+0002a560: 2020 2020 2020 2020 636f 7367 616d 6d61          cosgamma
+0002a570: 203d 206d 6174 682e 636f 7328 6761 6d6d   = math.cos(gamm
+0002a580: 6129 0a0a 2020 2020 2020 2020 6966 206d  a)..        if m
+0002a590: 6170 2e68 6561 6465 725b 3134 5d20 3d3d  ap.header[14] ==
+0002a5a0: 2039 302e 3a0a 2020 2020 2020 2020 2020   90.:.          
+0002a5b0: 2020 7369 6e67 6265 7461 203d 2031 2e0a    singbeta = 1..
+0002a5c0: 2020 2020 2020 2020 2020 2020 636f 7362              cosb
+0002a5d0: 6574 6120 3d20 302e 0a20 2020 2020 2020  eta = 0..       
+0002a5e0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0002a5f0: 2020 2073 696e 6265 7461 203d 206d 6174     sinbeta = mat
+0002a600: 682e 7369 6e28 6265 7461 290a 2020 2020  h.sin(beta).    
+0002a610: 2020 2020 2020 2020 636f 7362 6574 6120          cosbeta 
+0002a620: 3d20 6d61 7468 2e63 6f73 2862 6574 6129  = math.cos(beta)
+0002a630: 0a0a 2020 2020 2020 2020 4120 3d20 2d73  ..        A = -s
+0002a640: 696e 6761 6d6d 610a 2020 2020 2020 2020  ingamma.        
+0002a650: 4220 3d20 636f 7367 616d 6d61 0a20 2020  B = cosgamma.   
+0002a660: 2020 2020 2044 203d 2030 0a20 2020 2020       D = 0.     
+0002a670: 2020 2074 203d 206d 6174 682e 7371 7274     t = math.sqrt
+0002a680: 287a 5f61 7069 7820 2a2a 2032 202d 2063  (z_apix ** 2 - c
+0002a690: 656c 6c68 6569 6768 747a 202a 2a20 3220  ellheightz ** 2 
+0002a6a0: 2d20 287a 5f61 7069 7820 2a20 636f 7362  - (z_apix * cosb
+0002a6b0: 6574 6129 202a 2a20 3229 0a20 2020 2020  eta) ** 2).     
+0002a6c0: 2020 2043 203d 2028 7a5f 6170 6978 202a     C = (z_apix *
+0002a6d0: 2063 6f73 6265 7461 202a 2073 696e 6761   cosbeta * singa
+0002a6e0: 6d6d 6120 2d20 7420 2a20 636f 7367 616d  mma - t * cosgam
+0002a6f0: 6d61 2920 2f20 6365 6c6c 6865 6967 6874  ma) / cellheight
+0002a700: 7a0a 0a20 2020 2020 2020 2023 2064 6973  z..        # dis
+0002a710: 7461 6e63 6520 6672 6f6d 2061 746f 6d20  tance from atom 
+0002a720: 746f 207a 2779 2720 706c 616e 653a 0a20  to z'y' plane:. 
+0002a730: 2020 2020 2020 2023 2020 2020 2020 2020         #        
+0002a740: 207c 4178 202b 2042 7920 2b20 437a 202b   |Ax + By + Cz +
+0002a750: 2044 7c0a 2020 2020 2020 2020 2320 6420   D|.        # d 
+0002a760: 3d20 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  = --------------
+0002a770: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a  ---------------.
+0002a780: 2020 2020 2020 2020 2320 2020 2020 2020          #       
+0002a790: 7371 7274 2841 2a2a 3220 2b20 422a 2a32  sqrt(A**2 + B**2
+0002a7a0: 202b 2043 2a2a 3229 0a20 2020 2020 2020   + C**2).       
+0002a7b0: 2064 7820 3d20 6d61 7468 2e66 6162 7328   dx = math.fabs(
+0002a7c0: 4120 2a20 7265 6c61 7469 7665 7820 2b20  A * relativex + 
+0002a7d0: 4220 2a20 7265 6c61 7469 7665 7920 2b20  B * relativey + 
+0002a7e0: 4320 2a20 7265 6c61 7469 7665 7a29 202f  C * relativez) /
+0002a7f0: 206d 6174 682e 7371 7274 2841 202a 2a20   math.sqrt(A ** 
+0002a800: 3220 2b20 4220 2a2a 2032 202b 2043 202a  2 + B ** 2 + C *
+0002a810: 2a20 3229 0a20 2020 2020 2020 2078 6375  * 2).        xcu
+0002a820: 7420 3d20 282d 286f 6e65 636f 6f72 5b30  t = (-(onecoor[0
+0002a830: 5d20 2b20 2842 202f 2041 2920 2a20 6f6e  ] + (B / A) * on
+0002a840: 6563 6f6f 725b 315d 202b 2028 4320 2f20  ecoor[1] + (C / 
+0002a850: 4129 202a 206f 6e65 636f 6f72 5b32 5d29  A) * onecoor[2])
+0002a860: 290a 2020 2020 2020 2020 7863 7574 203d  ).        xcut =
+0002a870: 202d 7863 7574 0a20 2020 2020 2020 2069   -xcut.        i
+0002a880: 6620 7863 7574 203c 2030 206f 7220 7863  f xcut < 0 or xc
+0002a890: 7574 203e 206d 6170 2e68 6561 6465 725b  ut > map.header[
+0002a8a0: 3020 2b20 6f72 6469 6e64 735b 305d 5d20  0 + ordinds[0]] 
+0002a8b0: 2a20 785f 6170 6978 3a0a 2020 2020 2020  * x_apix:.      
+0002a8c0: 2020 2020 2020 6478 203d 202d 6478 0a20        dx = -dx. 
+0002a8d0: 2020 2020 2020 2078 696e 6420 3d20 6478         xind = dx
+0002a8e0: 202f 2063 656c 6c68 6569 6768 7478 0a20   / cellheightx. 
+0002a8f0: 2020 2020 2020 2078 696e 6465 7820 3d20         xindex = 
+0002a900: 7869 6e64 202d 206d 6170 2e68 6561 6465  xind - map.heade
+0002a910: 725b 3420 2b20 6f72 6469 6e64 735b 305d  r[4 + ordinds[0]
+0002a920: 5d0a 0a0a 2020 2020 2020 2020 7265 7475  ]...        retu
+0002a930: 726e 2878 696e 6465 782c 2079 696e 6465  rn(xindex, yinde
+0002a940: 782c 207a 696e 6465 7829 0a0a 0a20 2020  x, zindex)...   
+0002a950: 2064 6566 205f 5f67 6574 696e 6469 6365   def __getindice
+0002a960: 7328 7365 6c66 2c20 6f6e 6563 6f6f 7229  s(self, onecoor)
+0002a970: 3a0a 2020 2020 2020 2020 2222 220a 0a20  :.        """.. 
+0002a980: 2020 2020 2020 2020 2020 2046 696e 6420             Find 
+0002a990: 6f6e 6520 6174 6f6d 2773 2069 6e64 6963  one atom's indic
+0002a9a0: 6573 2063 6f72 7265 7370 6f64 696e 6720  es correspoding 
+0002a9b0: 746f 2069 7473 2063 7562 6963 206f 7220  to its cubic or 
+0002a9c0: 706c 616e 650a 2020 2020 2020 2020 2020  plane.          
+0002a9d0: 2020 7468 6520 3820 2863 7562 6963 2920    the 8 (cubic) 
+0002a9e0: 6f72 2034 2028 706c 616e 6529 2069 6e64  or 4 (plane) ind
+0002a9f0: 6963 6573 2061 7265 2073 6176 6564 2069  ices are saved i
+0002aa00: 6e20 696e 6469 6365 7320 7661 7269 6162  n indices variab
+0002aa10: 6c65 0a0a 2020 2020 2020 2020 3a70 6172  le..        :par
+0002aa20: 616d 206d 6170 3a20 4465 6e73 6974 7920  am map: Density 
+0002aa30: 6d61 7020 696e 7374 616e 6365 2066 726f  map instance fro
+0002aa40: 6d20 5445 4d50 792e 4d61 7050 6172 7365  m TEMPy.MapParse
+0002aa50: 720a 2020 2020 2020 2020 3a70 6172 616d  r.        :param
+0002aa60: 206f 6e65 636f 6f72 3a20 4c69 7374 2063   onecoor: List c
+0002aa70: 6f6e 7461 696e 7320 7468 6520 6174 6f6d  ontains the atom
+0002aa80: 2063 6f6f 7264 696e 6174 6573 2069 6e20   coordinates in 
+0002aa90: 2878 2c20 792c 207a 2920 6f72 6465 720a  (x, y, z) order.
+0002aaa0: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
+0002aab0: 2054 7570 6c65 2063 6f6e 7461 696e 7320   Tuple contains 
+0002aac0: 7477 6f20 6c69 7374 206f 6620 696e 6465  two list of inde
+0002aad0: 783a 2066 6972 7374 2068 6173 2074 6865  x: first has the
+0002aae0: 2038 206f 7220 3420 696e 6469 6365 7320   8 or 4 indices 
+0002aaf0: 696e 2074 6865 2063 7562 6963 3b0a 2020  in the cubic;.  
+0002ab00: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0002ab10: 6563 6f6e 6420 6861 7320 7468 6520 666c  econd has the fl
+0002ab20: 6f61 7420 696e 6465 7820 6f66 2074 6865  oat index of the
+0002ab30: 2069 6e70 7574 2061 746f 6d0a 0a20 2020   input atom..   
+0002ab40: 2020 2020 2022 2222 0a0a 2020 2020 2020       """..      
+0002ab50: 2020 2320 466f 7220 6e6f 6e2d 6375 6269    # For non-cubi
+0002ab60: 6320 6f72 2073 6b65 7765 6420 6465 6e73  c or skewed dens
+0002ab70: 6974 7920 6d61 7073 2c20 7468 6579 206d  ity maps, they m
+0002ab80: 6967 6874 2068 6176 6520 6469 6666 6572  ight have differ
+0002ab90: 656e 7420 6170 6978 206f 6e20 6469 6666  ent apix on diff
+0002aba0: 6572 656e 7420 6178 6973 6573 0a20 2020  erent axises.   
+0002abb0: 2020 2020 206d 6170 203d 2073 656c 662e       map = self.
+0002abc0: 6d61 700a 2020 2020 2020 2020 7a64 696d  map.        zdim
+0002abd0: 203d 206d 6170 2e68 6561 6465 722e 6365   = map.header.ce
+0002abe0: 6c6c 612e 7a0a 2020 2020 2020 2020 7a6e  lla.z.        zn
+0002abf0: 696e 7465 7276 616c 7320 3d20 6d61 702e  intervals = map.
+0002ac00: 6865 6164 6572 2e6d 7a0a 2020 2020 2020  header.mz.      
+0002ac10: 2020 7a5f 6170 6978 203d 207a 6469 6d20    z_apix = zdim 
+0002ac20: 2f20 7a6e 696e 7465 7276 616c 730a 0a20  / znintervals.. 
+0002ac30: 2020 2020 2020 2079 6469 6d20 3d20 6d61         ydim = ma
+0002ac40: 702e 6865 6164 6572 2e63 656c 6c61 2e79  p.header.cella.y
+0002ac50: 0a20 2020 2020 2020 2079 6e69 6e74 6572  .        yninter
+0002ac60: 7661 6c73 203d 206d 6170 2e68 6561 6465  vals = map.heade
+0002ac70: 722e 6d79 0a20 2020 2020 2020 2079 5f61  r.my.        y_a
+0002ac80: 7069 7820 3d20 7964 696d 202f 2079 6e69  pix = ydim / yni
+0002ac90: 6e74 6572 7661 6c73 0a0a 2020 2020 2020  ntervals..      
+0002aca0: 2020 7864 696d 203d 206d 6170 2e68 6561    xdim = map.hea
+0002acb0: 6465 722e 6365 6c6c 612e 780a 2020 2020  der.cella.x.    
+0002acc0: 2020 2020 786e 696e 7465 7276 616c 7320      xnintervals 
+0002acd0: 3d20 6d61 702e 6865 6164 6572 2e6d 780a  = map.header.mx.
+0002ace0: 2020 2020 2020 2020 785f 6170 6978 203d          x_apix =
+0002acf0: 2078 6469 6d20 2f20 786e 696e 7465 7276   xdim / xninterv
+0002ad00: 616c 730a 0a20 2020 2020 2020 206d 6170  als..        map
+0002ad10: 5f7a 7369 7a65 203d 206d 6170 2e68 6561  _zsize = map.hea
+0002ad20: 6465 722e 6e7a 0a20 2020 2020 2020 206d  der.nz.        m
+0002ad30: 6170 5f79 7369 7a65 203d 206d 6170 2e68  ap_ysize = map.h
+0002ad40: 6561 6465 722e 6e79 0a20 2020 2020 2020  eader.ny.       
+0002ad50: 206d 6170 5f78 7369 7a65 203d 206d 6170   map_xsize = map
+0002ad60: 2e68 6561 6465 722e 6e78 0a0a 2020 2020  .header.nx..    
+0002ad70: 2020 2020 2320 6966 206d 6170 2e68 6561      # if map.hea
+0002ad80: 6465 725b 3133 5d20 3d3d 206d 6170 2e68  der[13] == map.h
+0002ad90: 6561 6465 725b 3134 5d20 3d3d 206d 6170  eader[14] == map
+0002ada0: 2e68 6561 6465 725b 3135 5d20 3d3d 2039  .header[15] == 9
+0002adb0: 302e 3a0a 2020 2020 2020 2020 6966 206d  0.:.        if m
+0002adc0: 6170 2e68 6561 6465 722e 6365 6c6c 622e  ap.header.cellb.
+0002add0: 616c 7068 6120 3d3d 206d 6170 2e68 6561  alpha == map.hea
+0002ade0: 6465 722e 6365 6c6c 622e 6265 7461 203d  der.cellb.beta =
+0002adf0: 3d20 6d61 702e 6865 6164 6572 2e63 656c  = map.header.cel
+0002ae00: 6c62 2e67 616d 6d61 203d 3d20 3930 2e3a  lb.gamma == 90.:
+0002ae10: 0a20 2020 2020 2020 2020 2020 2023 2046  .            # F
+0002ae20: 6967 7572 6520 6f75 7420 7468 6520 6f72  igure out the or
+0002ae30: 6465 7220 6f66 2074 6865 2078 2c20 792c  der of the x, y,
+0002ae40: 207a 2062 6173 6564 206f 6e20 6372 7320   z based on crs 
+0002ae50: 696e 666f 2069 6e20 7468 6520 6865 6164  info in the head
+0002ae60: 6572 0a20 2020 2020 2020 2020 2020 2023  er.            #
+0002ae70: 2063 7273 203d 206c 6973 7428 6d61 702e   crs = list(map.
+0002ae80: 6865 6164 6572 5b31 363a 3139 5d29 0a20  header[16:19]). 
+0002ae90: 2020 2020 2020 2020 2020 2063 7273 203d             crs =
+0002aea0: 205b 6d61 702e 6865 6164 6572 2e6d 6170   [map.header.map
+0002aeb0: 632c 206d 6170 2e68 6561 6465 722e 6d61  c, map.header.ma
+0002aec0: 7072 2c20 6d61 702e 6865 6164 6572 2e6d  pr, map.header.m
+0002aed0: 6170 735d 0a20 2020 2020 2020 2020 2020  aps].           
+0002aee0: 2023 206f 7264 696e 6473 2073 6176 6520   # ordinds save 
+0002aef0: 7468 6520 696e 6469 6365 7320 636f 7272  the indices corr
+0002af00: 6573 706f 6469 6e67 2074 6f20 782c 2079  espoding to x, y
+0002af10: 202c 7a0a 2020 2020 2020 2020 2020 2020   ,z.            
+0002af20: 6f72 6469 6e64 7320 3d20 5b63 7273 2e69  ordinds = [crs.i
+0002af30: 6e64 6578 2831 292c 2063 7273 2e69 6e64  ndex(1), crs.ind
+0002af40: 6578 2832 292c 2063 7273 2e69 6e64 6578  ex(2), crs.index
+0002af50: 2833 295d 0a0a 2020 2020 2020 2020 2020  (3)]..          
+0002af60: 2020 7a69 6e64 6578 203d 2066 6c6f 6174    zindex = float
+0002af70: 286f 6e65 636f 6f72 5b32 5d20 2d20 6d61  (onecoor[2] - ma
+0002af80: 702e 6865 6164 6572 2e6f 7269 6769 6e2e  p.header.origin.
+0002af90: 7a29 202f 207a 5f61 7069 7820 2d20 6d61  z) / z_apix - ma
+0002afa0: 702e 6865 6164 6572 2e6e 7a73 7461 7274  p.header.nzstart
+0002afb0: 0a20 2020 2020 2020 2020 2020 2079 696e  .            yin
+0002afc0: 6465 7820 3d20 666c 6f61 7428 6f6e 6563  dex = float(onec
+0002afd0: 6f6f 725b 315d 202d 206d 6170 2e68 6561  oor[1] - map.hea
+0002afe0: 6465 722e 6f72 6967 696e 2e79 2920 2f20  der.origin.y) / 
+0002aff0: 795f 6170 6978 202d 206d 6170 2e68 6561  y_apix - map.hea
+0002b000: 6465 722e 6e79 7374 6172 740a 2020 2020  der.nystart.    
+0002b010: 2020 2020 2020 2020 7869 6e64 6578 203d          xindex =
+0002b020: 2066 6c6f 6174 286f 6e65 636f 6f72 5b30   float(onecoor[0
+0002b030: 5d20 2d20 6d61 702e 6865 6164 6572 2e6f  ] - map.header.o
+0002b040: 7269 6769 6e2e 7829 202f 2078 5f61 7069  rigin.x) / x_api
+0002b050: 7820 2d20 6d61 702e 6865 6164 6572 2e6e  x - map.header.n
+0002b060: 7873 7461 7274 0a0a 2020 2020 2020 2020  xstart..        
+0002b070: 2020 2020 7a66 6c6f 6f72 203d 2069 6e74      zfloor = int
+0002b080: 2866 6c6f 6f72 287a 696e 6465 7829 290a  (floor(zindex)).
+0002b090: 2020 2020 2020 2020 2020 2020 6966 207a              if z
+0002b0a0: 666c 6f6f 7220 3e3d 206d 6170 5f7a 7369  floor >= map_zsi
+0002b0b0: 7a65 202d 2031 3a0a 2020 2020 2020 2020  ze - 1:.        
+0002b0c0: 2020 2020 2020 2020 7a63 6569 6c20 3d20          zceil = 
+0002b0d0: 7a66 6c6f 6f72 0a20 2020 2020 2020 2020  zfloor.         
+0002b0e0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0002b0f0: 2020 2020 2020 2020 207a 6365 696c 203d           zceil =
+0002b100: 207a 666c 6f6f 7220 2b20 310a 0a20 2020   zfloor + 1..   
+0002b110: 2020 2020 2020 2020 2079 666c 6f6f 7220           yfloor 
+0002b120: 3d20 696e 7428 666c 6f6f 7228 7969 6e64  = int(floor(yind
+0002b130: 6578 2929 0a20 2020 2020 2020 2020 2020  ex)).           
+0002b140: 2069 6620 7966 6c6f 6f72 203e 3d20 6d61   if yfloor >= ma
+0002b150: 705f 7973 697a 6520 2d20 313a 0a20 2020  p_ysize - 1:.   
+0002b160: 2020 2020 2020 2020 2020 2020 2079 6365               yce
+0002b170: 696c 203d 2079 666c 6f6f 720a 2020 2020  il = yfloor.    
+0002b180: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0002b190: 2020 2020 2020 2020 2020 2020 2020 7963                yc
+0002b1a0: 6569 6c20 3d20 7966 6c6f 6f72 202b 2031  eil = yfloor + 1
+0002b1b0: 0a0a 2020 2020 2020 2020 2020 2020 7866  ..            xf
+0002b1c0: 6c6f 6f72 203d 2069 6e74 2866 6c6f 6f72  loor = int(floor
+0002b1d0: 2878 696e 6465 7829 290a 2020 2020 2020  (xindex)).      
+0002b1e0: 2020 2020 2020 6966 2078 666c 6f6f 7220        if xfloor 
+0002b1f0: 3e3d 206d 6170 5f78 7369 7a65 202d 2031  >= map_xsize - 1
+0002b200: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002b210: 2020 7863 6569 6c20 3d20 7866 6c6f 6f72    xceil = xfloor
+0002b220: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0002b230: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0002b240: 2020 2078 6365 696c 203d 2078 666c 6f6f     xceil = xfloo
+0002b250: 7220 2b20 310a 2020 2020 2020 2020 656c  r + 1.        el
+0002b260: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0002b270: 2320 4d65 7468 6f64 2032 3a20 6279 2075  # Method 2: by u
+0002b280: 7369 6e67 2074 6865 2066 7261 6374 696f  sing the fractio
+0002b290: 6e61 6c20 636f 6f72 6469 6e61 7465 206d  nal coordinate m
+0002b2a0: 6174 7269 780a 2020 2020 2020 2020 2020  atrix.          
+0002b2b0: 2020 2320 4368 6f73 656e 2061 7320 7468    # Chosen as th
+0002b2c0: 6520 7072 696d 6172 7920 666f 7220 7468  e primary for th
+0002b2d0: 6520 6375 7272 656e 7420 696d 706c 656d  e current implem
+0002b2e0: 656e 7461 7469 6f6e 0a20 2020 2020 2020  entation.       
+0002b2f0: 2020 2020 2061 7069 7873 203d 205b 785f       apixs = [x_
+0002b300: 6170 6978 2c20 795f 6170 6978 2c20 7a5f  apix, y_apix, z_
+0002b310: 6170 6978 5d0a 2020 2020 2020 2020 2020  apix].          
+0002b320: 2020 2320 4d65 7468 6f64 2031 3a20 6279    # Method 1: by
+0002b330: 2075 7369 6e67 2074 6865 2061 746f 6d20   using the atom 
+0002b340: 7072 6f6a 6563 7469 6f6e 206f 6e20 706c  projection on pl
+0002b350: 616e 6573 0a20 2020 2020 2020 2020 2020  anes.           
+0002b360: 2023 2078 696e 6465 782c 2079 696e 6465   # xindex, yinde
+0002b370: 782c 207a 696e 6465 7820 3d20 7365 6c66  x, zindex = self
+0002b380: 2e70 726f 6a65 6374 696f 6e5f 696e 6469  .projection_indi
+0002b390: 6365 7328 6f6e 6563 6f6f 7229 290a 2020  ces(onecoor)).  
+0002b3a0: 2020 2020 2020 2020 2020 7869 6e64 6578            xindex
+0002b3b0: 2c20 7969 6e64 6578 2c20 7a69 6e64 6578  , yindex, zindex
+0002b3c0: 203d 2073 656c 662e 6d61 7472 6978 5f69   = self.matrix_i
+0002b3d0: 6e64 6963 6573 2861 7069 7873 2c20 6f6e  ndices(apixs, on
+0002b3e0: 6563 6f6f 7229 0a0a 2020 2020 2020 2020  ecoor)..        
+0002b3f0: 2020 2020 7a66 6c6f 6f72 203d 2069 6e74      zfloor = int
+0002b400: 2866 6c6f 6f72 287a 696e 6465 7829 290a  (floor(zindex)).
+0002b410: 2020 2020 2020 2020 2020 2020 6966 207a              if z
+0002b420: 666c 6f6f 7220 3e3d 206d 6170 5f7a 7369  floor >= map_zsi
+0002b430: 7a65 202d 2031 3a0a 2020 2020 2020 2020  ze - 1:.        
+0002b440: 2020 2020 2020 2020 7a63 6569 6c20 3d20          zceil = 
+0002b450: 7a66 6c6f 6f72 0a20 2020 2020 2020 2020  zfloor.         
+0002b460: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0002b470: 2020 2020 2020 2020 207a 6365 696c 203d           zceil =
+0002b480: 207a 666c 6f6f 7220 2b20 310a 0a20 2020   zfloor + 1..   
+0002b490: 2020 2020 2020 2020 2079 666c 6f6f 7220           yfloor 
+0002b4a0: 3d20 696e 7428 666c 6f6f 7228 7969 6e64  = int(floor(yind
+0002b4b0: 6578 2929 0a20 2020 2020 2020 2020 2020  ex)).           
+0002b4c0: 2069 6620 7966 6c6f 6f72 203e 3d20 6d61   if yfloor >= ma
+0002b4d0: 705f 7973 697a 6520 2d20 313a 0a20 2020  p_ysize - 1:.   
+0002b4e0: 2020 2020 2020 2020 2020 2020 2079 6365               yce
+0002b4f0: 696c 203d 2079 666c 6f6f 720a 2020 2020  il = yfloor.    
+0002b500: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0002b510: 2020 2020 2020 2020 2020 2020 2020 7963                yc
+0002b520: 6569 6c20 3d20 7966 6c6f 6f72 202b 2031  eil = yfloor + 1
+0002b530: 0a0a 2020 2020 2020 2020 2020 2020 7866  ..            xf
+0002b540: 6c6f 6f72 203d 2069 6e74 2866 6c6f 6f72  loor = int(floor
+0002b550: 2878 696e 6465 7829 290a 2020 2020 2020  (xindex)).      
+0002b560: 2020 2020 2020 6966 2078 666c 6f6f 7220        if xfloor 
+0002b570: 3e3d 206d 6170 5f78 7369 7a65 202d 2031  >= map_xsize - 1
+0002b580: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002b590: 2020 7863 6569 6c20 3d20 7866 6c6f 6f72    xceil = xfloor
+0002b5a0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0002b5b0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0002b5c0: 2020 2078 6365 696c 203d 2078 666c 6f6f     xceil = xfloo
+0002b5d0: 7220 2b20 310a 0a20 2020 2020 2020 2069  r + 1..        i
+0002b5e0: 6e64 6963 6573 203d 206e 702e 6172 7261  ndices = np.arra
+0002b5f0: 7928 6e70 2e6d 6573 6867 7269 6428 6e70  y(np.meshgrid(np
+0002b600: 2e61 7261 6e67 6528 7866 6c6f 6f72 2c20  .arange(xfloor, 
+0002b610: 7863 6569 6c20 2b20 3129 2c20 6e70 2e61  xceil + 1), np.a
+0002b620: 7261 6e67 6528 7966 6c6f 6f72 2c20 7963  range(yfloor, yc
+0002b630: 6569 6c20 2b20 3129 2c0a 2020 2020 2020  eil + 1),.      
+0002b640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b660: 206e 702e 6172 616e 6765 287a 666c 6f6f   np.arange(zfloo
+0002b670: 722c 207a 6365 696c 202b 2031 2929 292e  r, zceil + 1))).
+0002b680: 542e 7265 7368 6170 6528 2d31 2c20 3329  T.reshape(-1, 3)
+0002b690: 0a20 2020 2020 2020 206f 6e65 696e 6465  .        oneinde
+0002b6a0: 7820 3d20 5b78 696e 6465 782c 2079 696e  x = [xindex, yin
+0002b6b0: 6465 782c 207a 696e 6465 785d 0a0a 2020  dex, zindex]..  
+0002b6c0: 2020 2020 2020 7265 7475 726e 2028 696e        return (in
+0002b6d0: 6469 6365 732c 206f 6e65 696e 6465 7829  dices, oneindex)
+0002b6e0: 0a0a 0a20 2020 2064 6566 205f 5f67 6574  ...    def __get
+0002b6f0: 6672 6163 7469 6f6e 7328 7365 6c66 2c20  fractions(self, 
+0002b700: 696e 7465 7270 6f6c 6174 696f 6e2c 206d  interpolation, m
+0002b710: 6f64 656c 293a 0a20 2020 2020 2020 2022  odel):.        "
+0002b720: 2222 0a0a 2020 2020 2020 2020 2020 2020  ""..            
+0002b730: 5072 6f64 7563 6520 6174 6f6d 2069 6e63  Produce atom inc
+0002b740: 6c75 7369 6f6e 2066 7261 6374 696f 6e20  lusion fraction 
+0002b750: 696e 666f 726d 6174 696f 6e20 666f 7220  information for 
+0002b760: 6675 6c6c 2061 746f 6d73 2061 6e64 2062  full atoms and b
+0002b770: 6163 6b62 6f6e 6520 7472 6163 650a 0a20  ackbone trace.. 
+0002b780: 2020 2020 2020 203a 7061 7261 6d20 696e         :param in
+0002b790: 7465 7270 6f6c 6174 696f 6e3a 204c 6973  terpolation: Lis
+0002b7a0: 7420 6f66 2069 6e74 6572 706f 6c61 7469  t of interpolati
+0002b7b0: 6f6e 2076 616c 7565 730a 2020 2020 2020  on values.      
+0002b7c0: 2020 3a70 6172 616d 206d 6170 3a20 456c    :param map: El
+0002b7d0: 6563 7472 6f6e 2064 656e 7369 7479 206d  ectron density m
+0002b7e0: 6170 2069 6e20 6d72 632f 6d61 7020 666f  ap in mrc/map fo
+0002b7f0: 726d 6174 0a20 2020 2020 2020 203a 7061  rmat.        :pa
+0002b800: 7261 6d20 6d6f 6465 6c3a 2050 726f 7465  ram model: Prote
+0002b810: 696e 206d 6f64 656c 2069 6e20 6d6d 6369  in model in mmci
+0002b820: 6620 666f 726d 6174 0a20 2020 2020 2020  f format.       
+0002b830: 203a 7265 7475 726e 3a20 5475 706c 6520   :return: Tuple 
+0002b840: 636f 6e74 6169 6e73 2066 756c 6c20 6174  contains full at
+0002b850: 6f6d 2069 6e63 6c75 7369 6f6e 2066 7261  om inclusion fra
+0002b860: 6374 696f 6e73 2061 6e64 2062 6163 6b62  ctions and backb
+0002b870: 6f6e 6520 696e 636c 7573 696f 6e20 6672  one inclusion fr
+0002b880: 6163 7469 6f6e 730a 0a20 2020 2020 2020  actions..       
+0002b890: 2022 2222 0a0a 2020 2020 2020 2020 6d61   """..        ma
+0002b8a0: 7020 3d20 7365 6c66 2e6d 6170 0a20 2020  p = self.map.   
+0002b8b0: 2020 2020 2062 696e 7320 3d20 6e70 2e6c       bins = np.l
+0002b8c0: 696e 7370 6163 6528 6d61 702e 6461 7461  inspace(map.data
+0002b8d0: 2e6d 696e 2829 2c20 6d61 702e 6461 7461  .min(), map.data
+0002b8e0: 2e6d 6178 2829 2c20 3132 3929 0a20 2020  .max(), 129).   
+0002b8f0: 2020 2020 2062 696e 6c69 7374 203d 2062       binlist = b
+0002b900: 696e 732e 746f 6c69 7374 2829 0a20 2020  ins.tolist().   
+0002b910: 2020 2020 2062 6973 6563 742e 696e 736f       bisect.inso
+0002b920: 7274 2862 696e 6c69 7374 2c20 7365 6c66  rt(binlist, self
+0002b930: 2e63 6c29 0a20 2020 2020 2020 2063 6c69  .cl).        cli
+0002b940: 6e64 6578 203d 2062 696e 6c69 7374 2e69  ndex = binlist.i
+0002b950: 6e64 6578 2873 656c 662e 636c 290a 2020  ndex(self.cl).  
+0002b960: 2020 2020 2020 6269 6e6c 6973 742e 706f        binlist.po
+0002b970: 7028 636c 696e 6465 7820 2d20 3129 0a20  p(clindex - 1). 
+0002b980: 2020 2020 2020 2062 696e 7320 3d20 6e70         bins = np
+0002b990: 2e61 7361 7272 6179 2862 696e 6c69 7374  .asarray(binlist
+0002b9a0: 290a 0a20 2020 2020 2020 206e 6577 696e  )..        newin
+0002b9b0: 7465 7270 6f6c 6174 696f 6e20 3d20 5b5d  terpolation = []
+0002b9c0: 0a20 2020 2020 2020 2066 6f72 2069 2069  .        for i i
+0002b9d0: 6e20 7261 6e67 6528 6c65 6e28 696e 7465  n range(len(inte
+0002b9e0: 7270 6f6c 6174 696f 6e29 293a 0a20 2020  rpolation)):.   
+0002b9f0: 2020 2020 2020 2020 2023 2069 6620 2748           # if 'H
+0002ba00: 2720 6e6f 7420 696e 206d 6f64 656c 5b69  ' not in model[i
+0002ba10: 5d2e 6174 6f6d 5f6e 616d 653a 0a20 2020  ].atom_name:.   
+0002ba20: 2020 2020 2020 2020 2069 6620 2748 2720           if 'H' 
+0002ba30: 6e6f 7420 696e 206d 6f64 656c 5b69 5d2e  not in model[i].
+0002ba40: 6675 6c6c 6e61 6d65 3a0a 2020 2020 2020  fullname:.      
+0002ba50: 2020 2020 2020 2020 2020 6e65 7769 6e74            newint
+0002ba60: 6572 706f 6c61 7469 6f6e 2e61 7070 656e  erpolation.appen
+0002ba70: 6428 696e 7465 7270 6f6c 6174 696f 6e5b  d(interpolation[
+0002ba80: 695d 290a 0a20 2020 2020 2020 2023 2057  i])..        # W
+0002ba90: 686f 6c65 206d 6f64 656c 2061 7665 7261  hole model avera
+0002baa0: 6765 2061 746f 6d20 696e 6c63 7573 696f  ge atom inlcusio
+0002bab0: 6e0a 2020 2020 2020 2020 656e 7469 7265  n.        entire
+0002bac0: 5f61 7665 7261 6765 203d 2073 756d 286e  _average = sum(n
+0002bad0: 702e 6173 6172 7261 7928 6e65 7769 6e74  p.asarray(newint
+0002bae0: 6572 706f 6c61 7469 6f6e 2920 3e20 7365  erpolation) > se
+0002baf0: 6c66 2e63 6c29 202f 2066 6c6f 6174 286c  lf.cl) / float(l
+0002bb00: 656e 286e 6577 696e 7465 7270 6f6c 6174  en(newinterpolat
+0002bb10: 696f 6e29 290a 0a20 2020 2020 2020 2023  ion))..        #
+0002bb20: 2046 756c 6c20 6174 6f6d 2069 6e63 6c75   Full atom inclu
+0002bb30: 7369 6f6e 0a20 2020 2020 2020 2061 203d  sion.        a =
+0002bb40: 205b 5d0a 2020 2020 2020 2020 7465 6d70   [].        temp
+0002bb50: 6c69 7374 203d 206e 702e 6173 6172 7261  list = np.asarra
+0002bb60: 7928 6e65 7769 6e74 6572 706f 6c61 7469  y(newinterpolati
+0002bb70: 6f6e 290a 2020 2020 2020 2020 666f 7220  on).        for 
+0002bb80: 6920 696e 2062 696e 733a 0a20 2020 2020  i in bins:.     
+0002bb90: 2020 2020 2020 2078 203d 2073 756d 2874         x = sum(t
+0002bba0: 656d 706c 6973 7420 3e20 6929 202f 2066  emplist > i) / f
+0002bbb0: 6c6f 6174 286c 656e 2874 656d 706c 6973  loat(len(templis
+0002bbc0: 7429 290a 2020 2020 2020 2020 2020 2020  t)).            
+0002bbd0: 612e 6170 7065 6e64 2878 290a 0a20 2020  a.append(x)..   
+0002bbe0: 2020 2020 2074 7261 6365 696e 7465 7220       traceinter 
+0002bbf0: 3d20 5b5d 0a20 2020 2020 2020 2066 6f72  = [].        for
+0002bc00: 2069 2069 6e20 7261 6e67 6528 6c65 6e28   i in range(len(
+0002bc10: 696e 7465 7270 6f6c 6174 696f 6e29 293a  interpolation)):
+0002bc20: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0002bc30: 286d 6f64 656c 5b69 5d2e 6675 6c6c 6e61  (model[i].fullna
+0002bc40: 6d65 203d 3d20 274e 2720 6f72 206d 6f64  me == 'N' or mod
+0002bc50: 656c 5b69 5d2e 6675 6c6c 6e61 6d65 203d  el[i].fullname =
+0002bc60: 3d20 2743 2720 6f72 206d 6f64 656c 5b69  = 'C' or model[i
+0002bc70: 5d2e 6675 6c6c 6e61 6d65 203d 3d20 274f  ].fullname == 'O
+0002bc80: 2720 6f72 0a20 2020 2020 2020 2020 2020  ' or.           
+0002bc90: 2020 2020 2020 2020 206d 6f64 656c 5b69           model[i
+0002bca0: 5d2e 6675 6c6c 6e61 6d65 203d 3d20 2743  ].fullname == 'C
+0002bcb0: 4127 206f 7220 6d6f 6465 6c5b 695d 2e66  A' or model[i].f
+0002bcc0: 756c 6c6e 616d 6520 3d3d 2022 4333 2722  ullname == "C3'"
+0002bcd0: 206f 7220 6d6f 6465 6c5b 695d 2e66 756c   or model[i].ful
+0002bce0: 6c6e 616d 6520 3d3d 2022 4334 2722 206f  lname == "C4'" o
+0002bcf0: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
+0002bd00: 2020 2020 2020 6d6f 6465 6c5b 695d 2e66        model[i].f
+0002bd10: 756c 6c6e 616d 6520 3d3d 2022 4335 2722  ullname == "C5'"
+0002bd20: 206f 7220 6d6f 6465 6c5b 695d 2e66 756c   or model[i].ful
+0002bd30: 6c6e 616d 6520 3d3d 2022 4f33 2722 206f  lname == "O3'" o
+0002bd40: 7220 6d6f 6465 6c5b 695d 2e66 756c 6c6e  r model[i].fulln
+0002bd50: 616d 6520 3d3d 2022 4f35 2722 206f 720a  ame == "O5'" or.
+0002bd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002bd70: 2020 2020 6d6f 6465 6c5b 695d 2e66 756c      model[i].ful
+0002bd80: 6c6e 616d 6520 3d3d 2027 5027 206f 7220  lname == 'P' or 
+0002bd90: 6d6f 6465 6c5b 695d 2e66 756c 6c6e 616d  model[i].fullnam
+0002bda0: 6520 3d3d 2027 4f58 5427 293a 0a20 2020  e == 'OXT'):.   
+0002bdb0: 2020 2020 2020 2020 2020 2020 2074 7261               tra
+0002bdc0: 6365 696e 7465 722e 6170 7065 6e64 2869  ceinter.append(i
+0002bdd0: 6e74 6572 706f 6c61 7469 6f6e 5b69 5d29  nterpolation[i])
+0002bde0: 0a0a 2020 2020 2020 2020 2320 4261 636b  ..        # Back
+0002bdf0: 626f 6e65 2069 6e63 6c75 7369 6f6e 0a20  bone inclusion. 
+0002be00: 2020 2020 2020 2062 203d 205b 5d0a 2020         b = [].  
+0002be10: 2020 2020 2020 7465 6d70 7472 6163 6569        temptracei
+0002be20: 6e74 6572 203d 206e 702e 6173 6172 7261  nter = np.asarra
+0002be30: 7928 7472 6163 6569 6e74 6572 290a 2020  y(traceinter).  
+0002be40: 2020 2020 2020 666f 7220 6a20 696e 2062        for j in b
+0002be50: 696e 733a 0a20 2020 2020 2020 2020 2020  ins:.           
+0002be60: 2079 203d 2073 756d 2874 656d 7074 7261   y = sum(temptra
+0002be70: 6365 696e 7465 7220 3e20 6a29 202f 2066  ceinter > j) / f
+0002be80: 6c6f 6174 286c 656e 2874 656d 7074 7261  loat(len(temptra
+0002be90: 6365 696e 7465 7229 290a 2020 2020 2020  ceinter)).      
+0002bea0: 2020 2020 2020 622e 6170 7065 6e64 2879        b.append(y
+0002beb0: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+0002bec0: 6e20 612c 2062 2c20 656e 7469 7265 5f61  n a, b, entire_a
+0002bed0: 7665 7261 6765 2c20 666c 6f61 7428 6c65  verage, float(le
+0002bee0: 6e28 6e65 7769 6e74 6572 706f 6c61 7469  n(newinterpolati
+0002bef0: 6f6e 2929 0a0a 2020 2020 6465 6620 6169  on))..    def ai
+0002bf00: 5f62 6172 2873 656c 6629 3a0a 0a20 2020  _bar(self):..   
+0002bf10: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
+0002bf20: 2e6f 6e6c 7962 6172 3a0a 2020 2020 2020  .onlybar:.      
+0002bf30: 2020 2020 2020 7365 6c66 2e61 746f 6d5f        self.atom_
+0002bf40: 696e 636c 7573 696f 6e28 290a 2020 2020  inclusion().    
+0002bf50: 2020 2020 7365 6c66 2e67 6574 5f62 6172      self.get_bar
+0002bf60: 2827 6174 6f6d 5f69 6e63 6c75 7369 6f6e  ('atom_inclusion
+0002bf70: 2729 0a0a 2020 2020 2320 4070 726f 6669  ')..    # @profi
+0002bf80: 6c65 0a20 2020 2064 6566 2061 746f 6d5f  le.    def atom_
+0002bf90: 696e 636c 7573 696f 6e28 7365 6c66 293a  inclusion(self):
+0002bfa0: 0a20 2020 2020 2020 2022 2222 0a0a 2020  .        """..  
+0002bfb0: 2020 2020 2020 2020 2020 4765 6e65 7261            Genera
+0002bfc0: 7465 2061 746f 6d20 696e 636c 7573 696f  te atom inclusio
+0002bfd0: 6e20 616e 6420 7265 7369 6475 6520 6174  n and residue at
+0002bfe0: 6f6d 2069 6e63 6c75 7369 6f6e 2069 6e66  om inclusion inf
+0002bff0: 6f72 6d61 7469 6f6e 2076 6572 7365 7320  ormation verses 
+0002c000: 6469 6666 6572 656e 7420 636f 6e74 6f75  different contou
+0002c010: 7220 6c65 7665 6c0a 2020 2020 2020 2020  r level.        
+0002c020: 2020 2020 426f 7468 2066 756c 6c20 6174      Both full at
+0002c030: 6f6d 7320 616e 6420 6261 636b 626f 6e65  oms and backbone
+0002c040: 2069 6e66 6f72 6d61 7469 6f6e 2061 7265   information are
+0002c050: 2069 6e63 6c75 6465 642e 0a20 2020 2020   included..     
+0002c060: 2020 2020 2020 2052 6573 756c 7473 2077         Results w
+0002c070: 726f 7465 2074 6f20 4a53 4f4e 2066 696c  rote to JSON fil
+0002c080: 650a 0a20 2020 2020 2020 203a 7265 7475  e..        :retu
+0002c090: 726e 3a20 4e6f 6e65 0a0a 2020 2020 2020  rn: None..      
+0002c0a0: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
+0002c0b0: 2073 656c 662e 6d6f 6465 6c73 2069 7320   self.models is 
+0002c0c0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0002c0d0: 2020 7379 732e 7374 6465 7272 2e77 7269    sys.stderr.wri
+0002c0e0: 7465 2827 5245 4d49 4e44 4552 3a20 6174  te('REMINDER: at
+0002c0f0: 6f6d 2069 6e63 6c75 7369 6f6e 2061 6e64  om inclusion and
+0002c100: 2072 6573 6964 7565 2069 6e63 6c75 7369   residue inclusi
+0002c110: 6f6e 2077 696c 6c20 6e6f 7420 6265 2063  on will not be c
+0002c120: 616c 6375 6c61 7465 6420 7769 7468 6f75  alculated withou
+0002c130: 7420 270a 2020 2020 2020 2020 2020 2020  t '.            
+0002c140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c150: 2027 6d6f 6465 6c20 7374 7275 6374 7572   'model structur
+0002c160: 652e 5c6e 2729 0a20 2020 2020 2020 2020  e.\n').         
+0002c170: 2020 2070 7269 6e74 2827 2d2d 2d2d 2d2d     print('------
+0002c180: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0002c190: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2729  --------------')
+0002c1a0: 0a20 2020 2020 2020 2065 6c69 6620 7365  .        elif se
+0002c1b0: 6c66 2e63 6c20 6973 204e 6f6e 653a 0a20  lf.cl is None:. 
+0002c1c0: 2020 2020 2020 2020 2020 2073 7973 2e73             sys.s
+0002c1d0: 7464 6572 722e 7772 6974 6528 2752 454d  tderr.write('REM
+0002c1e0: 494e 4445 523a 2061 746f 6d20 696e 636c  INDER: atom incl
+0002c1f0: 7573 696f 6e20 616e 6420 7265 7369 6475  usion and residu
+0002c200: 6520 696e 636c 7573 696f 6e20 7769 6c6c  e inclusion will
+0002c210: 206e 6f74 2062 6520 6361 6c63 756c 6174   not be calculat
+0002c220: 6564 2027 0a20 2020 2020 2020 2020 2020  ed '.           
+0002c230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c240: 2020 2777 6974 686f 7574 2063 6f6e 746f    'without conto
+0002c250: 7572 206c 6576 656c 2067 6976 656e 2e5c  ur level given.\
+0002c260: 6e27 290a 2020 2020 2020 2020 2020 2020  n').            
+0002c270: 7072 696e 7428 272d 2d2d 2d2d 2d2d 2d2d  print('---------
+0002c280: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0002c290: 2d2d 2d2d 2d2d 2d2d 2d2d 2d27 290a 2020  -----------').  
+0002c2a0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0002c2b0: 2020 2020 2020 2020 7374 6172 7420 3d20          start = 
+0002c2c0: 7469 6d65 6974 2e64 6566 6175 6c74 5f74  timeit.default_t
+0002c2d0: 696d 6572 2829 0a20 2020 2020 2020 2020  imer().         
+0002c2e0: 2020 206d 6170 203d 2073 656c 662e 6d61     map = self.ma
+0002c2f0: 700a 0a20 2020 2020 2020 2020 2020 2023  p..            #
+0002c300: 206d 6f64 656c 6e61 6d65 7320 3d20 5b20   modelnames = [ 
+0002c310: 6d6f 6465 6c2e 6669 6c65 6e61 6d65 2066  model.filename f
+0002c320: 6f72 206d 6f64 656c 2069 6e20 7365 6c66  or model in self
+0002c330: 2e6d 6f64 656c 7320 5d0a 2020 2020 2020  .models ].      
+0002c340: 2020 2020 2020 2320 7665 7273 696f 6e20        # version 
+0002c350: 3120 7573 6520 7465 6d70 790a 2020 2020  1 use tempy.    
+0002c360: 2020 2020 2020 2020 2320 636f 6d62 696e          # combin
+0002c370: 7265 7375 6c74 203d 2073 656c 662e 5f5f  result = self.__
+0002c380: 696e 7465 7274 6869 7264 2829 0a20 2020  interthird().   
+0002c390: 2020 2020 2020 2020 2023 2076 6572 7369           # versi
+0002c3a0: 6f6e 2032 2075 7365 2062 696f 7079 7468  on 2 use biopyth
+0002c3b0: 6f6e 2062 7574 206e 6f74 206f 7074 6d69  on but not optmi
+0002c3c0: 7365 6420 666f 7220 6269 6f70 7974 686f  sed for biopytho
+0002c3d0: 6e0a 2020 2020 2020 2020 2020 2020 2320  n.            # 
+0002c3e0: 636f 6d62 696e 7265 7375 6c74 203d 2073  combinresult = s
+0002c3f0: 656c 662e 5f5f 6e65 7769 6e74 6572 7468  elf.__newinterth
+0002c400: 6972 6428 290a 2020 2020 2020 2020 2020  ird().          
+0002c410: 2020 2320 7665 7273 696f 6e20 3320 7573    # version 3 us
+0002c420: 6520 6269 6f70 7974 686f 6e20 6e65 6564  e biopython need
+0002c430: 206d 6f72 6520 7465 7374 7320 616e 6420   more tests and 
+0002c440: 7468 656e 2064 656c 6574 6520 7468 6520  then delete the 
+0002c450: 6f74 6865 7220 7477 6f20 6162 6f76 650a  other two above.
+0002c460: 2020 2020 2020 2020 2020 2020 636f 6d62              comb
+0002c470: 696e 7265 7375 6c74 203d 2073 656c 662e  inresult = self.
+0002c480: 5f5f 6e6e 6577 696e 7465 7274 6869 7264  __nnewinterthird
+0002c490: 2829 0a20 2020 2020 2020 2020 2020 2061  ().            a
+0002c4a0: 746f 6d69 6e64 6963 7420 3d20 4f72 6465  tomindict = Orde
+0002c4b0: 7265 6444 6963 7428 290a 2020 2020 2020  redDict().      
+0002c4c0: 2020 2020 2020 7265 7369 6e64 6963 7420        resindict 
+0002c4d0: 3d20 4f72 6465 7265 6444 6963 7428 290a  = OrderedDict().
+0002c4e0: 2020 2020 2020 2020 2020 2020 6461 7461              data
+0002c4f0: 6469 6374 203d 204f 7264 6572 6564 4469  dict = OrderedDi
+0002c500: 6374 2829 0a20 2020 2020 2020 2020 2020  ct().           
+0002c510: 2072 6573 6469 6374 203d 204f 7264 6572   resdict = Order
+0002c520: 6564 4469 6374 2829 0a20 2020 2020 2020  edDict().       
+0002c530: 2020 2020 2063 6f75 6e74 6572 203d 2030       counter = 0
+0002c540: 0a20 2020 2020 2020 2020 2020 2065 7272  .            err
+0002c550: 6c69 7374 203d 205b 5d0a 2020 2020 2020  list = [].      
+0002c560: 2020 2020 2020 7265 7365 7272 6c69 7374        reserrlist
+0002c570: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
+0002c580: 2020 616c 6c6d 6f64 656c 735f 6e75 6d62    allmodels_numb
+0002c590: 6572 6174 6f6d 7320 3d20 300a 2020 2020  eratoms = 0.    
+0002c5a0: 2020 2020 2020 2020 616c 6c6d 6f64 656c          allmodel
+0002c5b0: 735f 6174 6f6d 5f69 6e63 6c75 7369 6f6e  s_atom_inclusion
+0002c5c0: 203d 2030 2e30 0a20 2020 2020 2020 2020   = 0.0.         
+0002c5d0: 2020 2066 6f72 206b 6579 2c20 7661 6c75     for key, valu
+0002c5e0: 6520 696e 2063 6f6d 6269 6e72 6573 756c  e in combinresul
+0002c5f0: 742e 6974 656d 7328 293a 0a20 2020 2020  t.items():.     
+0002c600: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+0002c610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c620: 2020 2020 696e 7465 7270 6f6c 6174 696f      interpolatio
+0002c630: 6e73 2c20 616c 6c63 6f6e 746f 7572 7364  ns, allcontoursd
+0002c640: 6963 742c 2063 6861 696e 6169 7363 6f72  ict, chainaiscor
+0002c650: 652c 2061 746f 6d6f 7574 7369 6465 626f  e, atomoutsidebo
+0002c660: 7820 3d20 7661 6c75 650a 2020 2020 2020  x = value.      
+0002c670: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0002c680: 2069 7369 6e73 7461 6e63 6528 7365 6c66   isinstance(self
+0002c690: 2e6d 6f64 656c 732c 206c 6973 7429 3a0a  .models, list):.
+0002c6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c6b0: 2020 2020 2020 2020 6d6f 6465 6c73 203d          models =
+0002c6c0: 205b 6375 726d 6f64 656c 2066 6f72 2063   [curmodel for c
+0002c6d0: 7572 6d6f 6465 6c20 696e 2073 656c 662e  urmodel in self.
+0002c6e0: 6d6f 6465 6c73 2069 6620 6b65 7920 696e  models if key in
+0002c6f0: 2063 7572 6d6f 6465 6c2e 6669 6c65 6e61   curmodel.filena
+0002c700: 6d65 5d0a 2020 2020 2020 2020 2020 2020  me].            
+0002c710: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0002c720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c730: 2020 2020 2020 6d6f 6465 6c73 203d 206c        models = l
+0002c740: 6973 7428 290a 2020 2020 2020 2020 2020  ist().          
+0002c750: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
+0002c760: 6465 6c73 2e61 7070 656e 6428 7365 6c66  dels.append(self
+0002c770: 2e6d 6f64 656c 7329 0a0a 2020 2020 2020  .models)..      
+0002c780: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0002c790: 206c 656e 286d 6f64 656c 7329 203d 3d20   len(models) == 
+0002c7a0: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
+0002c7b0: 2020 2020 2020 2020 2020 206d 6f64 656c             model
+0002c7c0: 203d 206d 6f64 656c 735b 305d 0a20 2020   = models[0].   
+0002c7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c7e0: 2065 6c69 6620 6c65 6e28 6d6f 6465 6c73   elif len(models
+0002c7f0: 2920 3d3d 2030 3a0a 2020 2020 2020 2020  ) == 0:.        
+0002c800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c810: 7072 696e 7428 2754 6865 7265 2069 7320  print('There is 
+0002c820: 6e6f 206d 6f64 656c 2127 290a 2020 2020  no model!').    
+0002c830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c840: 2020 2020 6578 6974 2829 0a20 2020 2020      exit().     
+0002c850: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0002c860: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0002c870: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+0002c880: 6e74 2827 5468 6572 6520 6172 6520 6d6f  nt('There are mo
+0002c890: 7265 2074 6861 6e20 6f6e 6520 6d6f 6465  re than one mode
+0002c8a0: 6c20 7768 6963 6820 7368 6f75 6c64 2062  l which should b
+0002c8b0: 6520 6f6e 6c79 206f 6e65 2e27 290a 2020  e only one.').  
+0002c8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c8d0: 2020 2020 2020 6578 6974 2829 0a0a 2020        exit()..  
 0002c8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c8f0: 2020 6a73 6f6e 2e64 756d 7028 6174 6f6d    json.dump(atom
-0002c900: 696e 6469 6374 2c20 6629 0a20 2020 2020  indict, f).     
-0002c910: 2020 2020 2020 2065 7863 6570 743a 0a20         except:. 
-0002c920: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0002c930: 7973 2e73 7464 6572 722e 7772 6974 6528  ys.stderr.write(
-0002c940: 2753 6176 696e 6720 746f 2061 746f 6d20  'Saving to atom 
-0002c950: 696e 636c 7573 696f 6e20 6a73 6f6e 2065  inclusion json e
-0002c960: 7272 6f72 3a20 7b7d 2e5c 6e27 2e66 6f72  rror: {}.\n'.for
-0002c970: 6d61 7428 7379 732e 6578 635f 696e 666f  mat(sys.exc_info
-0002c980: 2829 5b31 5d29 290a 0a20 2020 2020 2020  ()[1]))..       
-0002c990: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-0002c9a0: 2020 2020 2020 2020 2020 7769 7468 2063            with c
-0002c9b0: 6f64 6563 732e 6f70 656e 2873 656c 662e  odecs.open(self.
-0002c9c0: 776f 726b 6469 7220 2b20 7365 6c66 2e6d  workdir + self.m
-0002c9d0: 6170 6e61 6d65 202b 2027 5f72 6573 6964  apname + '_resid
-0002c9e0: 7565 5f69 6e63 6c75 7369 6f6e 2e6a 736f  ue_inclusion.jso
-0002c9f0: 6e27 2c20 2777 272c 0a20 2020 2020 2020  n', 'w',.       
-0002ca00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ca10: 2020 2020 2020 2020 2020 656e 636f 6469            encodi
-0002ca20: 6e67 3d27 7574 662d 3827 2920 6173 2066  ng='utf-8') as f
-0002ca30: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
-0002ca40: 2020 2020 2020 206a 736f 6e2e 6475 6d70         json.dump
-0002ca50: 2872 6573 696e 6469 6374 2c20 6631 290a  (resindict, f1).
-0002ca60: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-0002ca70: 7074 3a0a 2020 2020 2020 2020 2020 2020  pt:.            
-0002ca80: 2020 2020 7379 732e 7374 6465 7272 2e77      sys.stderr.w
-0002ca90: 7269 7465 2827 5361 7669 6e67 2074 6f20  rite('Saving to 
-0002caa0: 7265 7369 6475 6520 696e 636c 7573 696f  residue inclusio
-0002cab0: 6e20 6a73 6f6e 2065 7272 6f72 3a20 7b7d  n json error: {}
-0002cac0: 2e5c 6e27 2e66 6f72 6d61 7428 7379 732e  .\n'.format(sys.
-0002cad0: 6578 635f 696e 666f 2829 5b31 5d29 290a  exc_info()[1])).
-0002cae0: 0a0a 0a20 2020 2020 2020 2020 2020 2065  ...            e
-0002caf0: 6e64 203d 2074 696d 6569 742e 6465 6661  nd = timeit.defa
-0002cb00: 756c 745f 7469 6d65 7228 290a 2020 2020  ult_timer().    
-0002cb10: 2020 2020 2020 2020 7072 696e 7428 2749          print('I
-0002cb20: 6e63 6c75 7369 6f6e 2074 696d 653a 2025  nclusion time: %
-0002cb30: 7327 2025 2028 656e 6420 2d20 7374 6172  s' % (end - star
-0002cb40: 7429 290a 2020 2020 2020 2020 2020 2020  t)).            
-0002cb50: 7072 696e 7428 272d 2d2d 2d2d 2d2d 2d2d  print('---------
-0002cb60: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0002cb70: 2d2d 2d2d 2d2d 2d2d 2d2d 2d27 290a 2020  -----------').  
-0002cb80: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
-0002cb90: 650a 0a20 2020 2023 2056 6f6c 756d 6563  e..    # Volumec
-0002cba0: 6f6e 746f 7572 0a0a 2020 2020 2320 4070  ontour..    # @p
-0002cbb0: 726f 6669 6c65 0a20 2020 2064 6566 2076  rofile.    def v
-0002cbc0: 6f6c 756d 6563 6f6e 746f 7572 2873 656c  olumecontour(sel
-0002cbd0: 6629 3a0a 2020 2020 2020 2020 2222 220a  f):.        """.
-0002cbe0: 0a20 2020 2020 2020 2020 2020 2047 656e  .            Gen
-0002cbf0: 6572 6174 6520 566f 6c75 6d65 2076 6572  erate Volume ver
-0002cc00: 7375 7320 636f 6e74 6f75 7220 6c65 7665  sus contour leve
-0002cc10: 6c20 706c 6f74 2e0a 2020 2020 2020 2020  l plot..        
-0002cc20: 2020 2020 5265 7375 6c74 2077 726f 7465      Result wrote
-0002cc30: 2074 6f20 6120 4a53 4f4e 2066 696c 652e   to a JSON file.
-0002cc40: 0a20 2020 2020 2020 2020 2020 2056 6965  .            Vie
-0002cc50: 7720 696e 6469 6365 7320 6173 2073 6974  w indices as sit
-0002cc60: 696e 6720 6f6e 2074 6865 2063 656e 7472  ing on the centr
-0002cc70: 616c 206f 6620 6561 6368 2076 6f78 656c  al of each voxel
-0002cc80: 2c20 6e6f 2069 6e74 6572 706f 6c61 7469  , no interpolati
-0002cc90: 6f6e 206e 6565 6465 642e 0a0a 2020 2020  on needed...    
-0002cca0: 2020 2020 3a72 6574 7572 6e3a 204e 6f6e      :return: Non
-0002ccb0: 650a 0a20 2020 2020 2020 2022 2222 0a0a  e..        """..
-0002ccc0: 2020 2020 2020 2020 7374 6172 7420 3d20          start = 
-0002ccd0: 7469 6d65 6974 2e64 6566 6175 6c74 5f74  timeit.default_t
-0002cce0: 696d 6572 2829 0a20 2020 2020 2020 206d  imer().        m
-0002ccf0: 6170 203d 2073 656c 662e 6d61 700a 2020  ap = self.map.  
-0002cd00: 2020 2020 2020 2320 7465 6d70 7261 7279        # temprary
-0002cd10: 2073 6f6c 7574 696f 6e20 6173 2074 6865   solution as the
-0002cd20: 2074 656d 7079 2067 6976 6520 6170 6978   tempy give apix
-0002cd30: 2061 7320 6f6e 6520 7661 6c75 6520 6275   as one value bu
-0002cd40: 7420 6865 7265 2066 726f 6d20 6d72 6366  t here from mrcf
-0002cd50: 696c 6520 7765 2075 7365 2061 2074 7570  ile we use a tup
-0002cd60: 6c65 0a20 2020 2020 2020 2023 2063 6865  le.        # che
-0002cd70: 636b 2066 756e 6374 696f 6e6e 2066 726f  ck functionn fro
-0002cd80: 6d6d 7263 5f74 6f74 656d 7079 2069 6e20  mmrc_totempy in 
-0002cd90: 7072 6570 6172 6174 696f 6e2e 7079 0a20  preparation.py. 
-0002cda0: 2020 2020 2020 2061 7069 7820 3d20 6d61         apix = ma
-0002cdb0: 702e 766f 7865 6c5f 7369 7a65 2e74 6f6c  p.voxel_size.tol
-0002cdc0: 6973 7428 290a 2020 2020 2020 2020 6d61  ist().        ma
-0002cdd0: 7064 6174 6120 3d20 6d61 702e 6461 7461  pdata = map.data
-0002cde0: 0a20 2020 2020 2020 2065 7272 6c69 7374  .        errlist
-0002cdf0: 203d 205b 5d0a 2020 2020 2020 2020 6461   = [].        da
-0002ce00: 7461 6469 6374 203d 2064 6963 7428 290a  tadict = dict().
-0002ce10: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0002ce20: 2020 2020 2020 2020 2062 696e 7320 3d20           bins = 
-0002ce30: 6e70 2e6c 696e 7370 6163 6528 6d61 7064  np.linspace(mapd
-0002ce40: 6174 612e 6d69 6e28 292c 206d 6170 6461  ata.min(), mapda
-0002ce50: 7461 2e6d 6178 2829 2c20 3132 3929 0a20  ta.max(), 129). 
-0002ce60: 2020 2020 2020 2020 2020 2068 6973 742c             hist,
-0002ce70: 2062 696e 5f65 6467 6573 203d 206e 702e   bin_edges = np.
-0002ce80: 6869 7374 6f67 7261 6d28 6d61 7064 6174  histogram(mapdat
-0002ce90: 612c 2062 696e 733d 6269 6e73 290a 2020  a, bins=bins).  
-0002cea0: 2020 2020 2020 2020 2020 6d61 7073 697a            mapsiz
-0002ceb0: 6520 3d20 6d61 702e 6865 6164 6572 2e6e  e = map.header.n
-0002cec0: 7820 2a20 6d61 702e 6865 6164 6572 2e6e  x * map.header.n
-0002ced0: 7920 2a20 6d61 702e 6865 6164 6572 2e6e  y * map.header.n
-0002cee0: 7a0a 2020 2020 2020 2020 2020 2020 7072  z.            pr
-0002cef0: 6572 6573 756c 7420 3d20 6d61 7073 697a  eresult = mapsiz
-0002cf00: 6520 2d20 6e70 2e63 756d 7375 6d28 6869  e - np.cumsum(hi
-0002cf10: 7374 290a 2020 2020 2020 2020 2020 2020  st).            
-0002cf20: 6164 6465 6470 7265 203d 206e 702e 696e  addedpre = np.in
-0002cf30: 7365 7274 2870 7265 7265 7375 6c74 2c20  sert(preresult, 
-0002cf40: 302c 206d 6170 7369 7a65 290a 2020 2020  0, mapsize).    
-0002cf50: 2020 2020 2020 2020 2320 546f 646f 3a20          # Todo: 
-0002cf60: 666f 7220 6e6f 6e2d 6f72 7468 6f67 6f6e  for non-orthogon
-0002cf70: 616c 2076 6f6c 756d 6520 7468 6973 2069  al volume this i
-0002cf80: 7320 6e6f 7420 7468 6520 7269 6768 7420  s not the right 
-0002cf90: 666f 726d 756c 610a 2020 2020 2020 2020  formula.        
-0002cfa0: 2020 2020 2320 4974 206e 6565 6473 2074      # It needs t
-0002cfb0: 6865 2066 6f72 6d75 6c61 203a 2061 6263  he formula : abc
-0002cfc0: 2a20 7371 7274 2831 202b 2032 2a63 6f73  * sqrt(1 + 2*cos
-0002cfd0: 2861 292a 636f 7328 6229 2a62 6f73 2863  (a)*cos(b)*bos(c
-0002cfe0: 2920 2d20 636f 7328 6129 2a2a 3220 2d20  ) - cos(a)**2 - 
-0002cff0: 636f 7328 6229 2a2a 3220 2d20 636f 7328  cos(b)**2 - cos(
-0002d000: 6329 2a2a 3229 0a20 2020 2020 2020 2020  c)**2).         
-0002d010: 2020 2069 6620 7479 7065 2861 7069 7829     if type(apix)
-0002d020: 2069 7320 7475 706c 653a 0a20 2020 2020   is tuple:.     
-0002d030: 2020 2020 2020 2020 2020 2062 6173 6576             basev
-0002d040: 6f6c 756d 6520 3d20 2828 6170 6978 5b30  olume = ((apix[0
-0002d050: 5d2a 6170 6978 5b31 5d2a 6170 6978 5b32  ]*apix[1]*apix[2
-0002d060: 5d29 202f 2028 3130 202a 2a20 3329 290a  ]) / (10 ** 3)).
-0002d070: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0002d080: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002d090: 2020 6261 7365 766f 6c75 6d65 203d 2028    basevolume = (
-0002d0a0: 2861 7069 782a 2a33 2920 2f20 2831 302a  (apix**3) / (10*
-0002d0b0: 2a33 2929 0a20 2020 2020 2020 2020 2020  *3)).           
-0002d0c0: 2074 6d70 7265 7375 6c74 203d 2061 6464   tmpresult = add
-0002d0d0: 6564 7072 6520 2a20 6261 7365 766f 6c75  edpre * basevolu
-0002d0e0: 6d65 0a20 2020 2020 2020 2020 2020 2069  me.            i
-0002d0f0: 6620 7365 6c66 2e63 6c3a 0a20 2020 2020  f self.cl:.     
-0002d100: 2020 2020 2020 2020 2020 2063 6c76 6f6c             clvol
-0002d110: 756d 6520 3d20 286d 6170 6461 7461 203e  ume = (mapdata >
-0002d120: 3d20 7365 6c66 2e63 6c29 2e73 756d 2829  = self.cl).sum()
-0002d130: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002d140: 2065 7374 766f 6c75 6d65 203d 2072 6f75   estvolume = rou
-0002d150: 6e64 2863 6c76 6f6c 756d 6520 2a20 6261  nd(clvolume * ba
-0002d160: 7365 766f 6c75 6d65 2c20 3229 0a20 2020  sevolume, 2).   
-0002d170: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0002d180: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0002d190: 7374 766f 6c75 6d65 203d 204e 6f6e 650a  stvolume = None.
-0002d1a0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0002d1b0: 6573 7476 6f6c 756d 653a 0a20 2020 2020  estvolume:.     
-0002d1c0: 2020 2020 2020 2020 2020 2064 6174 6164             datad
-0002d1d0: 6963 7420 3d20 7b0a 2020 2020 2020 2020  ict = {.        
-0002d1e0: 2020 2020 2020 2020 2020 2020 2776 6f6c              'vol
-0002d1f0: 756d 655f 6573 7469 6d61 7465 273a 207b  ume_estimate': {
-0002d200: 2776 6f6c 756d 6527 3a20 6e70 2e72 6f75  'volume': np.rou
-0002d210: 6e64 2874 6d70 7265 7375 6c74 2c20 3130  nd(tmpresult, 10
-0002d220: 292e 746f 6c69 7374 2829 2c0a 2020 2020  ).tolist(),.    
-0002d230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d250: 2020 2020 276c 6576 656c 273a 206e 702e      'level': np.
-0002d260: 726f 756e 6428 6269 6e73 2c20 3130 292e  round(bins, 10).
-0002d270: 746f 6c69 7374 2829 2c0a 2020 2020 2020  tolist(),.      
+0002c8f0: 2020 616c 6c61 746f 6d73 203d 206c 6973    allatoms = lis
+0002c900: 7428 6d6f 6465 6c2e 6765 745f 6174 6f6d  t(model.get_atom
+0002c910: 7328 2929 0a20 2020 2020 2020 2020 2020  s()).           
+0002c920: 2020 2020 2020 2020 2072 6573 756c 7420           result 
+0002c930: 3d20 7365 6c66 2e5f 5f67 6574 6672 6163  = self.__getfrac
+0002c940: 7469 6f6e 7328 696e 7465 7270 6f6c 6174  tions(interpolat
+0002c950: 696f 6e73 2c20 616c 6c61 746f 6d73 290a  ions, allatoms).
+0002c960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c970: 2020 2020 6c65 7665 6c73 203d 206e 702e      levels = np.
+0002c980: 6c69 6e73 7061 6365 286d 6170 2e64 6174  linspace(map.dat
+0002c990: 612e 6d69 6e28 292c 206d 6170 2e64 6174  a.min(), map.dat
+0002c9a0: 612e 6d61 7828 292c 2031 3239 290a 0a20  a.max(), 129).. 
+0002c9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c9c0: 2020 2062 696e 6c69 7374 203d 206c 6576     binlist = lev
+0002c9d0: 656c 732e 746f 6c69 7374 2829 0a20 2020  els.tolist().   
+0002c9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c9f0: 2062 6973 6563 742e 696e 736f 7274 2862   bisect.insort(b
+0002ca00: 696e 6c69 7374 2c20 7365 6c66 2e63 6c29  inlist, self.cl)
+0002ca10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002ca20: 2020 2020 2063 6c69 6e64 6578 203d 2062       clindex = b
+0002ca30: 696e 6c69 7374 2e69 6e64 6578 2873 656c  inlist.index(sel
+0002ca40: 662e 636c 290a 2020 2020 2020 2020 2020  f.cl).          
+0002ca50: 2020 2020 2020 2020 2020 6269 6e6c 6973            binlis
+0002ca60: 742e 706f 7028 636c 696e 6465 7820 2d20  t.pop(clindex - 
+0002ca70: 3129 0a20 2020 2020 2020 2020 2020 2020  1).             
+0002ca80: 2020 2020 2020 206c 6576 656c 7320 3d20         levels = 
+0002ca90: 6e70 2e61 7361 7272 6179 2862 696e 6c69  np.asarray(binli
+0002caa0: 7374 290a 0a20 2020 2020 2020 2020 2020  st)..           
+0002cab0: 2020 2020 2020 2020 2023 2073 636f 7265           # score
+0002cac0: 5f74 7970 6520 3d20 2761 6927 0a20 2020  _type = 'ai'.   
+0002cad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cae0: 2023 206e 6577 5f64 6963 7420 3d20 7b27   # new_dict = {'
+0002caf0: 6964 273a 2073 656c 662e 656d 6469 642c  id': self.emdid,
+0002cb00: 2027 7265 736f 6c75 7469 6f6e 273a 2066   'resolution': f
+0002cb10: 6c6f 6174 2873 656c 662e 7265 736f 6c75  loat(self.resolu
+0002cb20: 7469 6f6e 292c 2027 6e61 6d65 273a 206b  tion), 'name': k
+0002cb30: 6579 2c0a 2020 2020 2020 2020 2020 2020  ey,.            
+0002cb40: 2020 2020 2020 2020 2320 2020 2020 2020          #       
+0002cb50: 2020 2020 2020 7363 6f72 655f 7479 7065        score_type
+0002cb60: 3a20 726f 756e 6428 7265 7375 6c74 5b32  : round(result[2
+0002cb70: 5d2c 2033 297d 0a20 2020 2020 2020 2020  ], 3)}.         
+0002cb80: 2020 2020 2020 2020 2020 2023 2070 6c6f             # plo
+0002cb90: 745f 6e61 6d65 203d 2027 7b7d 5f7b 7d5f  t_name = '{}_{}_
+0002cba0: 7b7d 5f62 6172 2e70 6e67 272e 666f 726d  {}_bar.png'.form
+0002cbb0: 6174 2873 656c 662e 6d61 706e 616d 652c  at(self.mapname,
+0002cbc0: 206b 6579 2c20 7363 6f72 655f 7479 7065   key, score_type
+0002cbd0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0002cbe0: 2020 2020 2020 2320 7363 6f72 655f 6469        # score_di
+0002cbf0: 7220 3d20 6f73 2e70 6174 682e 6469 726e  r = os.path.dirn
+0002cc00: 616d 6528 7661 2e5f 5f66 696c 655f 5f29  ame(va.__file__)
+0002cc10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002cc20: 2020 2020 2023 2072 656c 6174 6976 655f       # relative_
+0002cc30: 746f 7768 6f6c 652c 2072 656c 6174 6976  towhole, relativ
+0002cc40: 655f 746f 7477 6f20 3d20 6261 7228 6e65  e_totwo = bar(ne
+0002cc50: 775f 6469 6374 2c20 7363 6f72 655f 7479  w_dict, score_ty
+0002cc60: 7065 2c20 7365 6c66 2e77 6f72 6b64 6972  pe, self.workdir
+0002cc70: 2c20 7363 6f72 655f 6469 722c 2070 6c6f  , score_dir, plo
+0002cc80: 745f 6e61 6d65 290a 2020 2020 2020 2020  t_name).        
+0002cc90: 2020 2020 2020 2020 2020 2020 2320 6169              # ai
+0002cca0: 6261 7220 3d20 7b27 7768 6f6c 6527 3a20  bar = {'whole': 
+0002ccb0: 7265 6c61 7469 7665 5f74 6f77 686f 6c65  relative_towhole
+0002ccc0: 2c20 2772 656c 6174 6976 6527 3a20 7265  , 'relative': re
+0002ccd0: 6c61 7469 7665 5f74 6f74 776f 7d0a 0a20  lative_totwo}.. 
+0002cce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ccf0: 2020 2064 6174 6164 6963 745b 7374 7228     datadict[str(
+0002cd00: 636f 756e 7465 7229 5d20 3d20 7b27 6e61  counter)] = {'na
+0002cd10: 6d65 273a 206b 6579 2c20 276c 6576 656c  me': key, 'level
+0002cd20: 273a 205b 726f 756e 6428 656c 656d 2c20  ': [round(elem, 
+0002cd30: 3629 2066 6f72 2065 6c65 6d20 696e 206c  6) for elem in l
+0002cd40: 6576 656c 732e 746f 6c69 7374 2829 5d2c  evels.tolist()],
+0002cd50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002cd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cd70: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0002cd80: 616c 6c5f 6174 6f6d 273a 205b 726f 756e  all_atom': [roun
+0002cd90: 6428 656c 656d 2c20 3329 2066 6f72 2065  d(elem, 3) for e
+0002cda0: 6c65 6d20 696e 2072 6573 756c 745b 305d  lem in result[0]
+0002cdb0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+0002cdc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cde0: 2027 6261 636b 626f 6e65 273a 205b 726f   'backbone': [ro
+0002cdf0: 756e 6428 656c 656d 2c20 3329 2066 6f72  und(elem, 3) for
+0002ce00: 2065 6c65 6d20 696e 2072 6573 756c 745b   elem in result[
+0002ce10: 315d 5d2c 0a20 2020 2020 2020 2020 2020  1]],.           
+0002ce20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ce30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ce40: 2020 2027 6174 6f6d 6f75 7473 6964 6527     'atomoutside'
+0002ce50: 3a20 6174 6f6d 6f75 7473 6964 6562 6f78  : atomoutsidebox
+0002ce60: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002ce70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ce80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ce90: 2763 6861 696e 6169 7363 6f72 6527 3a20  'chainaiscore': 
+0002cea0: 6368 6169 6e61 6973 636f 7265 2c0a 2020  chainaiscore,.  
+0002ceb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ced0: 2020 2020 2020 2020 2020 2020 2774 6f74              'tot
+0002cee0: 616c 4e75 6d62 6572 4f66 4174 6f6d 7327  alNumberOfAtoms'
+0002cef0: 3a20 696e 7428 7265 7375 6c74 5b33 5d29  : int(result[3])
+0002cf00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002cf10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cf20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cf30: 2761 7665 7261 6765 5f61 695f 6d6f 6465  'average_ai_mode
+0002cf40: 6c27 3a20 726f 756e 6428 7265 7375 6c74  l': round(result
+0002cf50: 5b32 5d2c 2033 292c 0a20 2020 2020 2020  [2], 3),.       
+0002cf60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cf70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cf80: 2020 2020 2020 2027 6176 6572 6167 655f         'average_
+0002cf90: 6169 5f63 6f6c 6f72 273a 2073 656c 662e  ai_color': self.
+0002cfa0: 5f5f 666c 6f61 746f 6865 7828 5b72 6f75  __floatohex([rou
+0002cfb0: 6e64 2872 6573 756c 745b 325d 2c20 3629  nd(result[2], 6)
+0002cfc0: 5d29 5b30 5d2c 0a20 2020 2020 2020 2020  ])[0],.         
+0002cfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cff0: 2020 2020 2023 2027 6169 5f62 6172 273a       # 'ai_bar':
+0002d000: 2061 6962 6172 0a20 2020 2020 2020 2020   aibar.         
+0002d010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d030: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+0002d040: 2020 2020 2020 2020 2020 2061 6c6c 6d6f             allmo
+0002d050: 6465 6c73 5f6e 756d 6265 7261 746f 6d73  dels_numberatoms
+0002d060: 202b 3d20 696e 7428 7265 7375 6c74 5b33   += int(result[3
+0002d070: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
+0002d080: 2020 2020 2020 2061 6c6c 6d6f 6465 6c73         allmodels
+0002d090: 5f61 746f 6d5f 696e 636c 7573 696f 6e20  _atom_inclusion 
+0002d0a0: 2b3d 2072 6573 756c 745b 335d 2a72 6573  += result[3]*res
+0002d0b0: 756c 745b 325d 0a0a 2020 2020 2020 2020  ult[2]..        
+0002d0c0: 2020 2020 2020 2020 2020 2020 6461 7461              data
+0002d0d0: 5f6c 656e 203d 206c 656e 286c 6576 656c  _len = len(level
+0002d0e0: 732e 746f 6c69 7374 2829 290a 2020 2020  s.tolist()).    
+0002d0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d100: 706c 742e 706c 6f74 285b 726f 756e 6428  plt.plot([round(
+0002d110: 656c 656d 2c20 3130 2920 666f 7220 656c  elem, 10) for el
+0002d120: 656d 2069 6e20 6c65 7665 6c73 2e74 6f6c  em in levels.tol
+0002d130: 6973 7428 295d 2c20 5b72 6f75 6e64 2865  ist()], [round(e
+0002d140: 6c65 6d2c 2031 3029 2066 6f72 2065 6c65  lem, 10) for ele
+0002d150: 6d20 696e 2072 6573 756c 745b 305d 5d2c  m in result[0]],
+0002d160: 2027 2d67 272c 206c 6162 656c 3d27 4675   '-g', label='Fu
+0002d170: 6c6c 2061 746f 6d27 290a 2020 2020 2020  ll atom').      
+0002d180: 2020 2020 2020 2020 2020 2020 2020 706c                pl
+0002d190: 742e 706c 6f74 285b 726f 756e 6428 656c  t.plot([round(el
+0002d1a0: 656d 2c20 3130 2920 666f 7220 656c 656d  em, 10) for elem
+0002d1b0: 2069 6e20 6c65 7665 6c73 2e74 6f6c 6973   in levels.tolis
+0002d1c0: 7428 295d 2c20 5b72 6f75 6e64 2865 6c65  t()], [round(ele
+0002d1d0: 6d2c 2031 3029 2066 6f72 2065 6c65 6d20  m, 10) for elem 
+0002d1e0: 696e 2072 6573 756c 745b 315d 5d2c 2027  in result[1]], '
+0002d1f0: 2d62 272c 206c 6162 656c 3d27 4261 636b  -b', label='Back
+0002d200: 626f 6e65 2729 0a20 2020 2020 2020 2020  bone').         
+0002d210: 2020 2020 2020 2020 2020 2070 6c74 2e70             plt.p
+0002d220: 6c6f 7428 6461 7461 5f6c 656e 202a 205b  lot(data_len * [
+0002d230: 7365 6c66 2e63 6c5d 2c20 6e70 2e6c 696e  self.cl], np.lin
+0002d240: 7370 6163 6528 302c 2031 2c20 6461 7461  space(0, 1, data
+0002d250: 5f6c 656e 292c 2027 2d72 272c 206c 6162  _len), '-r', lab
+0002d260: 656c 3d27 5265 636f 6d6d 656e 6465 6420  el='Recommended 
+0002d270: 636f 6e74 6f75 7220 6c65 7665 6c27 290a  contour level').
 0002d280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d2a0: 2020 2765 7374 766f 6c75 6d65 273a 2065    'estvolume': e
-0002d2b0: 7374 766f 6c75 6d65 7d7d 0a20 2020 2020  stvolume}}.     
-0002d2c0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0002d2d0: 2020 2020 2020 2020 2020 2020 2064 6174               dat
-0002d2e0: 6164 6963 7420 3d20 7b0a 2020 2020 2020  adict = {.      
-0002d2f0: 2020 2020 2020 2020 2020 2020 2020 2776                'v
-0002d300: 6f6c 756d 655f 6573 7469 6d61 7465 273a  olume_estimate':
-0002d310: 207b 2776 6f6c 756d 6527 3a20 6e70 2e72   {'volume': np.r
-0002d320: 6f75 6e64 2874 6d70 7265 7375 6c74 2c20  ound(tmpresult, 
-0002d330: 3130 292e 746f 6c69 7374 2829 2c0a 2020  10).tolist(),.  
-0002d340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d360: 2020 2020 2020 276c 6576 656c 273a 206e        'level': n
-0002d370: 702e 726f 756e 6428 6269 6e73 2c20 3130  p.round(bins, 10
-0002d380: 292e 746f 6c69 7374 2829 7d7d 0a20 2020  ).tolist()}}.   
-0002d390: 2020 2020 2065 7863 6570 743a 0a20 2020       except:.   
-0002d3a0: 2020 2020 2020 2020 2065 7272 203d 2027           err = '
-0002d3b0: 566f 6c75 6d65 2065 7374 696d 6174 6520  Volume estimate 
-0002d3c0: 6361 6c63 756c 6174 696f 6e20 6572 726f  calculation erro
-0002d3d0: 723a 207b 7d2e 272e 666f 726d 6174 2873  r: {}.'.format(s
-0002d3e0: 7973 2e65 7863 5f69 6e66 6f28 295b 315d  ys.exc_info()[1]
-0002d3f0: 290a 2020 2020 2020 2020 2020 2020 6572  ).            er
-0002d400: 726c 6973 742e 6170 7065 6e64 2865 7272  rlist.append(err
-0002d410: 290a 2020 2020 2020 2020 2020 2020 7379  ).            sy
-0002d420: 732e 7374 6465 7272 2e77 7269 7465 2865  s.stderr.write(e
-0002d430: 7272 202b 2027 5c6e 2729 0a20 2020 2020  rr + '\n').     
-0002d440: 2020 2069 6620 6572 726c 6973 743a 0a20     if errlist:. 
-0002d450: 2020 2020 2020 2020 2020 2064 6174 6164             datad
-0002d460: 6963 7420 3d20 7b27 766f 6c75 6d65 5f65  ict = {'volume_e
-0002d470: 7374 696d 6174 6527 3a20 7b27 6572 7227  stimate': {'err'
-0002d480: 3a20 7b27 766f 6c75 6d65 5f65 7374 696d  : {'volume_estim
-0002d490: 6174 655f 6572 726f 7227 3a20 6572 726c  ate_error': errl
-0002d4a0: 6973 747d 7d7d 0a20 2020 2020 2020 2074  ist}}}.        t
-0002d4b0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0002d4c0: 7769 7468 2063 6f64 6563 732e 6f70 656e  with codecs.open
-0002d4d0: 2873 656c 662e 776f 726b 6469 7220 2b20  (self.workdir + 
-0002d4e0: 7365 6c66 2e6d 6170 6e61 6d65 202b 2027  self.mapname + '
-0002d4f0: 5f76 6f6c 756d 655f 636f 6e74 6f75 722e  _volume_contour.
-0002d500: 6a73 6f6e 272c 2027 7727 2c0a 2020 2020  json', 'w',.    
-0002d510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d520: 2020 2020 2020 2020 2065 6e63 6f64 696e           encodin
-0002d530: 673d 2775 7466 2d38 2729 2061 7320 663a  g='utf-8') as f:
-0002d540: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002d550: 206a 736f 6e2e 6475 6d70 2864 6174 6164   json.dump(datad
-0002d560: 6963 742c 2066 290a 2020 2020 2020 2020  ict, f).        
-0002d570: 6578 6365 7074 3a0a 2020 2020 2020 2020  except:.        
-0002d580: 2020 2020 7379 732e 7374 6465 7272 2e77      sys.stderr.w
-0002d590: 7269 7465 2827 5361 7669 6e67 2076 6f6c  rite('Saving vol
-0002d5a0: 756d 6520 6573 7469 6d61 7465 2074 6f20  ume estimate to 
-0002d5b0: 6a73 6f6e 2065 7272 6f72 3a7b 7d2e 5c6e  json error:{}.\n
-0002d5c0: 272e 666f 726d 6174 2873 7973 2e65 7863  '.format(sys.exc
-0002d5d0: 5f69 6e66 6f28 295b 315d 2929 0a0a 2020  _info()[1]))..  
-0002d5e0: 2020 2020 2020 656e 6420 3d20 7469 6d65        end = time
-0002d5f0: 6974 2e64 6566 6175 6c74 5f74 696d 6572  it.default_timer
-0002d600: 2829 0a20 2020 2020 2020 2070 7269 6e74  ().        print
-0002d610: 2827 566f 6c75 6d65 2063 6f6e 746f 7572  ('Volume contour
-0002d620: 2074 696d 653a 2025 7327 2025 2028 656e   time: %s' % (en
-0002d630: 6420 2d20 7374 6172 7429 290a 2020 2020  d - start)).    
-0002d640: 2020 2020 7072 696e 7428 272d 2d2d 2d2d      print('-----
-0002d650: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0002d660: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d27  ---------------'
-0002d670: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-0002d680: 6e20 4e6f 6e65 0a0a 0a0a 0a0a 2020 2020  n None......    
-0002d690: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0002d6a0: 2323 2320 7465 7374 0a0a 2020 2020 2320  ### test..    # 
-0002d6b0: 6465 6620 7073 7375 6d28 7365 6c66 2c69  def pssum(self,i
-0002d6c0: 2c20 6469 7374 2c20 696e 6469 6178 6973  , dist, indiaxis
-0002d6d0: 293a 0a20 2020 2023 2020 2020 2069 6620  ):.    #     if 
-0002d6e0: 6920 213d 206c 656e 2869 6e64 6961 7869  i != len(indiaxi
-0002d6f0: 7329 202d 2031 3a0a 2020 2020 2320 2020  s) - 1:.    #   
-0002d700: 2020 2020 2020 696e 6469 6365 7320 3d20        indices = 
-0002d710: 6e70 2e61 7267 7768 6572 6528 2864 6973  np.argwhere((dis
-0002d720: 7420 3e20 696e 6469 6178 6973 745b 695d  t > indiaxist[i]
-0002d730: 2920 2620 2864 6973 7420 3c3d 2069 6e64  ) & (dist <= ind
-0002d740: 6961 7869 7374 5b69 202b 2031 5d29 290a  iaxist[i + 1])).
-0002d750: 2020 2020 2320 2020 2020 2020 2020 7073      #         ps
-0002d760: 756d 203d 206c 6f67 3130 2870 736d 6170  um = log10(psmap
-0002d770: 2e66 756c 6c4d 6170 5b74 7570 6c65 2869  .fullMap[tuple(i
-0002d780: 6e64 6963 6573 2e54 295d 2e73 756d 2829  ndices.T)].sum()
-0002d790: 202f 206c 656e 2869 6e64 6963 6573 2929   / len(indices))
-0002d7a0: 0a20 2020 2023 2020 2020 2020 2020 2072  .    #         r
-0002d7b0: 6574 7572 6e20 7073 756d 0a0a 2020 2020  eturn psum..    
-0002d7c0: 2320 6465 6620 7073 7375 6d28 7365 6c66  # def pssum(self
-0002d7d0: 2c69 6e64 6963 6573 293a 0a20 2020 2023  ,indices):.    #
-0002d7e0: 2020 2020 2023 2069 6620 6920 213d 206c       # if i != l
-0002d7f0: 656e 2869 6e64 6961 7869 7329 202d 2031  en(indiaxis) - 1
-0002d800: 3a0a 2020 2020 2320 2020 2020 2320 696e  :.    #     # in
-0002d810: 6469 6365 7320 3d20 6e70 2e61 7267 7768  dices = np.argwh
-0002d820: 6572 6528 2864 6973 7420 3e20 696e 6469  ere((dist > indi
-0002d830: 6178 6973 745b 695d 2920 2620 2864 6973  axist[i]) & (dis
-0002d840: 7420 3c3d 2069 6e64 6961 7869 7374 5b69  t <= indiaxist[i
-0002d850: 202b 2031 5d29 290a 2020 2020 2320 2020   + 1])).    #   
-0002d860: 2020 7073 756d 203d 206c 6f67 3130 2870    psum = log10(p
-0002d870: 736d 6170 2e66 756c 6c4d 6170 5b74 7570  smap.fullMap[tup
-0002d880: 6c65 2869 6e64 6963 6573 2e54 295d 2e73  le(indices.T)].s
-0002d890: 756d 2829 202f 206c 656e 2869 6e64 6963  um() / len(indic
-0002d8a0: 6573 2929 0a20 2020 2023 2020 2020 2072  es)).    #     r
-0002d8b0: 6574 7572 6e20 7073 756d 0a0a 0a20 2020  eturn psum...   
-0002d8c0: 2064 6566 2070 6172 6172 6170 7328 7365   def pararaps(se
-0002d8d0: 6c66 293a 0a20 2020 2020 2020 2022 2222  lf):.        """
-0002d8e0: 0a0a 2020 2020 2020 2020 2020 2020 4361  ..            Ca
-0002d8f0: 6c63 756c 6174 696f 6e20 6f66 2074 6865  lculation of the
-0002d900: 2072 6f74 6174 696f 6e61 6c6c 7920 6176   rotationally av
-0002d910: 6572 6167 6520 706f 7765 7220 7370 6563  erage power spec
-0002d920: 7472 756d 2028 5241 5053 290a 2020 2020  trum (RAPS).    
-0002d930: 2020 2020 2020 2020 5265 7375 6c74 7320          Results 
-0002d940: 7772 6f74 6520 746f 204a 534f 4e20 6669  wrote to JSON fi
-0002d950: 6c65 0a0a 2020 2020 2020 2020 3a72 6574  le..        :ret
-0002d960: 7572 6e3a 204e 6f6e 650a 0a20 2020 2020  urn: None..     
-0002d970: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
-0002d980: 6d70 6f72 7420 6d75 6c74 6970 726f 6365  mport multiproce
-0002d990: 7373 696e 6720 6173 206d 700a 2020 2020  ssing as mp.    
-0002d9a0: 2020 2020 696d 706f 7274 2069 7465 7274      import itert
-0002d9b0: 6f6f 6c73 0a20 2020 2020 2020 2074 6872  ools.        thr
-0002d9c0: 6561 6463 6f75 6e74 203d 2032 0a20 2020  eadcount = 2.   
-0002d9d0: 2020 2020 2070 6f6f 6c20 3d20 6d70 2e50       pool = mp.P
-0002d9e0: 6f6f 6c28 7468 7265 6164 636f 756e 7429  ool(threadcount)
-0002d9f0: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
-0002da00: 662e 6d61 702e 785f 7369 7a65 2829 203d  f.map.x_size() =
-0002da10: 3d20 7365 6c66 2e6d 6170 2e79 5f73 697a  = self.map.y_siz
-0002da20: 6528 2920 3d3d 2073 656c 662e 6d61 702e  e() == self.map.
-0002da30: 7a5f 7369 7a65 2829 3a0a 2020 2020 2020  z_size():.      
-0002da40: 2020 2020 2020 6572 726c 6973 7420 3d20        errlist = 
-0002da50: 5b5d 0a20 2020 2020 2020 2020 2020 2073  [].            s
-0002da60: 7461 7274 203d 2074 696d 6569 742e 6465  tart = timeit.de
-0002da70: 6661 756c 745f 7469 6d65 7228 290a 2020  fault_timer().  
-0002da80: 2020 2020 2020 2020 2020 6d61 7020 3d20            map = 
-0002da90: 7365 6c66 2e6d 6170 0a20 2020 2020 2020  self.map.       
-0002daa0: 2020 2020 2061 7069 7820 3d20 6d61 702e       apix = map.
-0002dab0: 6170 6978 0a20 2020 2020 2020 2020 2020  apix.           
-0002dac0: 2066 6674 6d61 7020 3d20 6d61 702e 666f   fftmap = map.fo
-0002dad0: 7572 6965 725f 7472 616e 7366 6f72 6d28  urier_transform(
-0002dae0: 290a 2020 2020 2020 2020 2020 2020 7073  ).            ps
-0002daf0: 6d61 7020 3d20 6666 746d 6170 2e63 6f70  map = fftmap.cop
-0002db00: 7928 290a 2020 2020 2020 2020 2020 2020  y().            
-0002db10: 7073 6d65 616e 203d 206e 702e 6d65 616e  psmean = np.mean
-0002db20: 2870 736d 6170 2e66 756c 6c4d 6170 290a  (psmap.fullMap).
-0002db30: 2020 2020 2020 2020 2020 2020 7073 7374              psst
-0002db40: 6420 3d20 6e70 2e73 7464 2870 736d 6170  d = np.std(psmap
-0002db50: 2e66 756c 6c4d 6170 290a 2020 2020 2020  .fullMap).      
-0002db60: 2020 2020 2020 7073 6d61 702e 6675 6c6c        psmap.full
-0002db70: 4d61 7020 3d20 6e70 2e61 6273 2828 7073  Map = np.abs((ps
-0002db80: 6d61 702e 6675 6c6c 4d61 7020 2d20 7073  map.fullMap - ps
-0002db90: 6d65 616e 2920 2f20 7073 7374 6429 202a  mean) / psstd) *
-0002dba0: 2a20 320a 0a20 2020 2020 2020 2020 2020  * 2..           
-0002dbb0: 206d 6964 7374 6172 7420 3d20 7469 6d65   midstart = time
-0002dbc0: 6974 2e64 6566 6175 6c74 5f74 696d 6572  it.default_timer
-0002dbd0: 2829 202d 2073 7461 7274 0a20 2020 2020  () - start.     
-0002dbe0: 2020 2020 2020 2070 7269 6e74 2827 202d         print(' -
-0002dbf0: 2d20 5241 5053 2046 6f75 7269 6572 2d74  - RAPS Fourier-t
-0002dc00: 7261 6e73 666f 726d 6174 696f 6e20 7469  ransformation ti
-0002dc10: 6d65 3a20 2573 2720 2520 6d69 6473 7461  me: %s' % midsta
-0002dc20: 7274 290a 0a20 2020 2020 2020 2020 2020  rt)..           
-0002dc30: 207a 6772 6964 203d 206e 702e 6172 616e   zgrid = np.aran
-0002dc40: 6765 2866 6c6f 6f72 2870 736d 6170 2e7a  ge(floor(psmap.z
-0002dc50: 5f73 697a 6528 2920 2f20 322e 3029 202a  _size() / 2.0) *
-0002dc60: 202d 312c 2063 6569 6c28 7073 6d61 702e   -1, ceil(psmap.
-0002dc70: 7a5f 7369 7a65 2829 202f 2032 2e30 2929  z_size() / 2.0))
-0002dc80: 202f 2066 6c6f 6174 2866 6c6f 6f72 2870   / float(floor(p
-0002dc90: 736d 6170 2e7a 5f73 697a 6528 2929 290a  smap.z_size())).
-0002dca0: 2020 2020 2020 2020 2020 2020 7967 7269              ygri
-0002dcb0: 6420 3d20 6e70 2e61 7261 6e67 6528 666c  d = np.arange(fl
-0002dcc0: 6f6f 7228 7073 6d61 702e 795f 7369 7a65  oor(psmap.y_size
-0002dcd0: 2829 202f 2032 2e30 2920 2a20 2d31 2c20  () / 2.0) * -1, 
-0002dce0: 6365 696c 2870 736d 6170 2e79 5f73 697a  ceil(psmap.y_siz
-0002dcf0: 6528 2920 2f20 322e 3029 2920 2f20 666c  e() / 2.0)) / fl
-0002dd00: 6f61 7428 666c 6f6f 7228 7073 6d61 702e  oat(floor(psmap.
-0002dd10: 795f 7369 7a65 2829 2929 0a20 2020 2020  y_size())).     
-0002dd20: 2020 2020 2020 2078 6772 6964 203d 206e         xgrid = n
-0002dd30: 702e 6172 616e 6765 2866 6c6f 6f72 2870  p.arange(floor(p
-0002dd40: 736d 6170 2e78 5f73 697a 6528 2920 2f20  smap.x_size() / 
-0002dd50: 322e 3029 202a 202d 312c 2063 6569 6c28  2.0) * -1, ceil(
-0002dd60: 7073 6d61 702e 785f 7369 7a65 2829 202f  psmap.x_size() /
-0002dd70: 2032 2e30 2929 202f 2066 6c6f 6174 2866   2.0)) / float(f
-0002dd80: 6c6f 6f72 2870 736d 6170 2e78 5f73 697a  loor(psmap.x_siz
-0002dd90: 6528 2929 290a 2020 2020 2020 2020 2020  e())).          
-0002dda0: 2020 7864 6973 203d 2078 6772 6964 202a    xdis = xgrid *
-0002ddb0: 2a20 320a 2020 2020 2020 2020 2020 2020  * 2.            
-0002ddc0: 7964 6973 203d 2079 6772 6964 202a 2a20  ydis = ygrid ** 
-0002ddd0: 320a 2020 2020 2020 2020 2020 2020 7a64  2.            zd
-0002dde0: 6973 203d 207a 6772 6964 202a 2a20 320a  is = zgrid ** 2.
-0002ddf0: 2020 2020 2020 2020 2020 2020 6469 7374              dist
-0002de00: 203d 206e 702e 7371 7274 287a 6469 735b   = np.sqrt(zdis[
-0002de10: 3a2c 204e 6f6e 652c 204e 6f6e 655d 202b  :, None, None] +
-0002de20: 2079 6469 735b 3a2c 204e 6f6e 655d 202b   ydis[:, None] +
-0002de30: 2078 6469 7329 0a0a 2020 2020 2020 2020   xdis)..        
-0002de40: 2020 2020 616c 6c61 7869 7320 3d20 5b7a      allaxis = [z
-0002de50: 6772 6964 2c20 7967 7269 642c 2078 6772  grid, ygrid, xgr
-0002de60: 6964 5d0a 2020 2020 2020 2020 2020 2020  id].            
-0002de70: 746d 7069 6e64 6961 7869 7320 3d20 6d61  tmpindiaxis = ma
-0002de80: 7828 616c 6c61 7869 732c 206b 6579 3d6c  x(allaxis, key=l
-0002de90: 656e 290a 2020 2020 2020 2020 2020 2020  en).            
-0002dea0: 696e 6469 6178 6973 7420 3d20 746d 7069  indiaxist = tmpi
-0002deb0: 6e64 6961 7869 735b 746d 7069 6e64 6961  ndiaxis[tmpindia
-0002dec0: 7869 7320 3e3d 2030 5d0a 2020 2020 2020  xis >= 0].      
-0002ded0: 2020 2020 2020 696e 6469 6178 6973 203d        indiaxis =
-0002dee0: 206e 702e 6c69 6e73 7061 6365 2830 2c20   np.linspace(0, 
-0002def0: 3120 2f20 2832 202a 2061 7069 7829 2c20  1 / (2 * apix), 
-0002df00: 6c65 6e28 696e 6469 6178 6973 7429 290a  len(indiaxist)).
-0002df10: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0002df20: 7428 2764 6973 743a 2729 0a20 2020 2020  t('dist:').     
-0002df30: 2020 2020 2020 2070 7269 6e74 2861 6c6c         print(all
-0002df40: 6178 6973 290a 2020 2020 2020 2020 2020  axis).          
-0002df50: 2020 7072 696e 7428 6469 7374 2e73 6861    print(dist.sha
-0002df60: 7065 290a 2020 2020 2020 2020 2020 2020  pe).            
-0002df70: 7072 696e 7428 696e 6469 6178 6973 290a  print(indiaxis).
-0002df80: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0002df90: 7428 7073 6d61 702e 7a5f 7369 7a65 2829  t(psmap.z_size()
-0002dfa0: 290a 2020 2020 2020 2020 2020 2020 7072  ).            pr
-0002dfb0: 696e 7428 272d 2d2d 2d2d 2d2d 2729 0a20  int('-------'). 
-0002dfc0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-0002dfd0: 2864 6973 745b 3938 2c39 362c 3936 5d29  (dist[98,96,96])
-0002dfe0: 0a0a 0a20 2020 2020 2020 2020 2020 2061  ...            a
-0002dff0: 7073 203d 205b 5d0a 2020 2020 2020 2020  ps = [].        
-0002e000: 2020 2020 2320 666f 7220 6920 696e 2072      # for i in r
-0002e010: 616e 6765 286c 656e 2869 6e64 6961 7869  ange(len(indiaxi
-0002e020: 7329 293a 0a20 2020 2020 2020 2020 2020  s)):.           
-0002e030: 2023 2020 2020 2069 6620 6920 213d 206c   #     if i != l
-0002e040: 656e 2869 6e64 6961 7869 7329 202d 2031  en(indiaxis) - 1
-0002e050: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-0002e060: 2020 2020 2020 2020 696e 6469 6365 7320          indices 
-0002e070: 3d20 6e70 2e61 7267 7768 6572 6528 2864  = np.argwhere((d
-0002e080: 6973 7420 3e20 696e 6469 6178 6973 745b  ist > indiaxist[
-0002e090: 695d 2920 2620 2864 6973 7420 3c3d 2069  i]) & (dist <= i
-0002e0a0: 6e64 6961 7869 7374 5b69 202b 2031 5d29  ndiaxist[i + 1])
-0002e0b0: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
-0002e0c0: 2020 2020 2020 2020 7073 756d 203d 206c          psum = l
-0002e0d0: 6f67 3130 2870 736d 6170 2e66 756c 6c4d  og10(psmap.fullM
-0002e0e0: 6170 5b74 7570 6c65 2869 6e64 6963 6573  ap[tuple(indices
-0002e0f0: 2e54 295d 2e73 756d 2829 202f 206c 656e  .T)].sum() / len
-0002e100: 2869 6e64 6963 6573 2929 0a20 2020 2020  (indices)).     
-0002e110: 2020 2020 2020 2023 2020 2020 2020 2020         #        
-0002e120: 2061 7073 2e61 7070 656e 6428 7073 756d   aps.append(psum
-0002e130: 290a 0a20 2020 2020 2020 2020 2020 2061  )..            a
-0002e140: 6c6c 696e 6469 6365 7320 3d20 5b5d 0a20  llindices = []. 
-0002e150: 2020 2020 2020 2020 2020 2061 6c6c 7073             allps
-0002e160: 6d61 7020 3d20 5b5d 0a20 2020 2020 2020  map = [].       
-0002e170: 2020 2020 2023 2066 6f72 2069 2069 6e20       # for i in 
-0002e180: 7261 6e67 6528 6c65 6e28 696e 6469 6178  range(len(indiax
-0002e190: 6973 2929 3a0a 2020 2020 2020 2020 2020  is)):.          
-0002e1a0: 2020 2320 2020 2020 6966 2069 2021 3d20    #     if i != 
-0002e1b0: 6c65 6e28 696e 6469 6178 6973 2920 2d31  len(indiaxis) -1
-0002e1c0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-0002e1d0: 2020 2020 2020 2020 696e 6469 6365 7320          indices 
-0002e1e0: 3d20 6e70 2e61 7267 7768 6572 6528 2864  = np.argwhere((d
-0002e1f0: 6973 7420 3e20 696e 6469 6178 6973 745b  ist > indiaxist[
-0002e200: 695d 2920 2620 2864 6973 7420 3c3d 2069  i]) & (dist <= i
-0002e210: 6e64 6961 7869 7374 5b69 202b 2031 5d29  ndiaxist[i + 1])
-0002e220: 290a 2020 2020 2020 2020 2020 2020 230a  ).            #.
-0002e230: 2020 2020 2020 2020 2020 2020 2320 2020              #   
-0002e240: 2020 2020 2020 7073 756d 203d 2070 736d        psum = psm
-0002e250: 6170 2e66 756c 6c4d 6170 5b74 7570 6c65  ap.fullMap[tuple
-0002e260: 2869 6e64 6963 6573 2e54 295d 2e73 756d  (indices.T)].sum
-0002e270: 2829 0a20 2020 2020 2020 2020 2020 2023  ().            #
-0002e280: 2020 2020 2020 2020 2061 6c6c 696e 6469           allindi
-0002e290: 6365 732e 6170 7065 6e64 2869 6e64 6963  ces.append(indic
-0002e2a0: 6573 290a 2020 2020 2020 2020 2020 2020  es).            
-0002e2b0: 2320 2020 2020 2020 2020 616c 6c70 736d  #         allpsm
-0002e2c0: 6170 2e61 7070 656e 6428 7073 756d 290a  ap.append(psum).
-0002e2d0: 2020 2020 2020 2020 2020 2020 2320 7072              # pr
-0002e2e0: 696e 7428 616c 6c69 6e64 6963 6573 290a  int(allindices).
-0002e2f0: 2020 2020 2020 2020 2020 2020 6f64 6420              odd 
-0002e300: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
-0002e310: 2065 7665 6e20 3d5b 5d0a 2020 2020 2020   even =[].      
-0002e320: 2020 2020 2020 636f 756e 7465 7220 3d20        counter = 
-0002e330: 300a 2020 2020 2020 2020 2020 2020 726c  0.            rl
-0002e340: 6973 7420 3d20 5b5d 0a20 2020 2020 2020  ist = [].       
-0002e350: 2020 2020 2074 656d 706c 6973 7420 3d20       templist = 
-0002e360: 5b5d 0a20 2020 2020 2020 2020 2020 2066  [].            f
-0002e370: 6f72 2069 2069 6e20 7261 6e67 6528 6c65  or i in range(le
-0002e380: 6e28 696e 6469 6178 6973 292d 3129 3a0a  n(indiaxis)-1):.
-0002e390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e3a0: 636f 756e 7465 7220 2b3d 2031 0a20 2020  counter += 1.   
-0002e3b0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0002e3c0: 6920 3d3d 2030 3a0a 2020 2020 2020 2020  i == 0:.        
-0002e3d0: 2020 2020 2020 2020 2020 2020 7465 6d70              temp
-0002e3e0: 6c69 7374 2e61 7070 656e 6428 6929 0a20  list.append(i). 
-0002e3f0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0002e400: 6c69 6620 6920 2520 3430 203d 3d20 303a  lif i % 40 == 0:
-0002e410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002e420: 2020 2020 2072 6c69 7374 2e61 7070 656e       rlist.appen
-0002e430: 6428 7465 6d70 6c69 7374 290a 2020 2020  d(templist).    
-0002e440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e450: 7465 6d70 6c69 7374 203d 205b 5d0a 2020  templist = [].  
-0002e460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e470: 2020 7465 6d70 6c69 7374 2e61 7070 656e    templist.appen
-0002e480: 6428 6929 0a20 2020 2020 2020 2020 2020  d(i).           
-0002e490: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0002e4a0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0002e4b0: 656d 706c 6973 742e 6170 7065 6e64 2869  emplist.append(i
-0002e4c0: 290a 0a20 2020 2020 2020 2020 2020 2072  )..            r
-0002e4d0: 6c69 7374 2e61 7070 656e 6428 7465 6d70  list.append(temp
-0002e4e0: 6c69 7374 290a 0a20 2020 2020 2020 2020  list)..         
-0002e4f0: 2020 2064 6566 2073 706c 6974 5f6c 6973     def split_lis
-0002e500: 7428 696e 705f 6c69 7374 2c20 6e72 293a  t(inp_list, nr):
-0002e510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002e520: 2022 2222 0a20 2020 2020 2020 2020 2020   """.           
-0002e530: 2020 2020 2053 706c 6974 7320 6576 656e       Splits even
-0002e540: 6c79 2061 206c 6973 740a 2020 2020 2020  ly a list.      
-0002e550: 2020 2020 2020 2020 2020 3a70 6172 616d            :param
-0002e560: 2069 6e70 5f6c 6973 743a 206c 6973 740a   inp_list: list.
-0002e570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e580: 3a70 6172 616d 206e 723a 206e 756d 6265  :param nr: numbe
-0002e590: 7220 6f66 2070 6172 7473 0a20 2020 2020  r of parts.     
-0002e5a0: 2020 2020 2020 2020 2020 203a 7265 7475             :retu
-0002e5b0: 726e 3a20 6c69 7374 206f 6620 226e 7222  rn: list of "nr"
-0002e5c0: 206c 6973 7473 0a20 2020 2020 2020 2020   lists.         
-0002e5d0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0002e5e0: 2020 2020 2020 2020 2020 206e 6577 5f6c             new_l
-0002e5f0: 6973 7420 3d20 5b5d 0a20 2020 2020 2020  ist = [].       
-0002e600: 2020 2020 2020 2020 206e 725f 656c 203d           nr_el =
-0002e610: 2031 2e30 202f 206e 7220 2a20 6c65 6e28   1.0 / nr * len(
-0002e620: 696e 705f 6c69 7374 290a 2020 2020 2020  inp_list).      
-0002e630: 2020 2020 2020 2020 2020 666f 7220 6920            for i 
-0002e640: 696e 2072 616e 6765 286e 7229 3a0a 2020  in range(nr):.  
-0002e650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e660: 2020 7374 6172 7420 3d20 696e 7428 726f    start = int(ro
-0002e670: 756e 6428 6920 2a20 6e72 5f65 6c29 290a  und(i * nr_el)).
-0002e680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e690: 2020 2020 656e 6420 3d20 696e 7428 726f      end = int(ro
-0002e6a0: 756e 6428 2869 202b 2031 2920 2a20 6e72  und((i + 1) * nr
-0002e6b0: 5f65 6c29 290a 2020 2020 2020 2020 2020  _el)).          
-0002e6c0: 2020 2020 2020 2020 2020 6e65 775f 6c69            new_li
-0002e6d0: 7374 2e61 7070 656e 6428 696e 705f 6c69  st.append(inp_li
-0002e6e0: 7374 5b73 7461 7274 3a65 6e64 5d29 0a20  st[start:end]). 
-0002e6f0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0002e700: 6574 7572 6e20 6e65 775f 6c69 7374 0a20  eturn new_list. 
-0002e710: 2020 2020 2020 2020 2020 2069 6e70 7574             input
-0002e720: 6c69 7374 203d 2072 616e 6765 2830 2c20  list = range(0, 
-0002e730: 6c65 6e28 696e 6469 6178 6973 292d 3129  len(indiaxis)-1)
-0002e740: 0a20 2020 2020 2020 2020 2020 2072 6c69  .            rli
-0002e750: 7374 203d 2073 706c 6974 5f6c 6973 7428  st = split_list(
-0002e760: 696e 7075 746c 6973 742c 2074 6872 6561  inputlist, threa
-0002e770: 6463 6f75 6e74 290a 0a20 2020 2020 2020  dcount)..       
-0002e780: 2020 2020 2023 2054 7279 2077 6974 6820       # Try with 
-0002e790: 7368 6172 6564 206f 626a 6563 740a 2020  shared object.  
-0002e7a0: 2020 2020 2020 2020 2020 696d 706f 7274            import
-0002e7b0: 206d 756c 7469 7072 6f63 6573 7369 6e67   multiprocessing
-0002e7c0: 0a20 2020 2020 2020 2020 2020 2069 6d70  .            imp
-0002e7d0: 6f72 7420 6374 7970 6573 0a20 2020 2020  ort ctypes.     
-0002e7e0: 2020 2020 2020 2078 2c20 792c 207a 203d         x, y, z =
-0002e7f0: 2064 6973 742e 7368 6170 650a 0a20 2020   dist.shape..   
-0002e800: 2020 2020 2020 2020 2073 6861 7265 645f           shared_
-0002e810: 6172 7261 795f 6261 7365 203d 206d 756c  array_base = mul
-0002e820: 7469 7072 6f63 6573 7369 6e67 2e41 7272  tiprocessing.Arr
-0002e830: 6179 2863 7479 7065 732e 635f 646f 7562  ay(ctypes.c_doub
-0002e840: 6c65 2c20 782a 792a 7a29 0a20 2020 2020  le, x*y*z).     
-0002e850: 2020 2020 2020 2023 2073 6861 7265 645f         # shared_
-0002e860: 6172 7261 7920 3d20 6e70 2e63 7479 7065  array = np.ctype
-0002e870: 736c 6962 2e61 735f 6172 7261 7928 7368  slib.as_array(sh
-0002e880: 6172 6564 5f61 7272 6179 5f62 6173 652e  ared_array_base.
-0002e890: 6765 745f 6f62 6a28 2929 0a20 2020 2020  get_obj()).     
-0002e8a0: 2020 2020 2020 2073 6861 7265 645f 6172         shared_ar
-0002e8b0: 7261 7920 3d20 6e70 2e66 726f 6d62 7566  ray = np.frombuf
-0002e8c0: 6665 7228 7368 6172 6564 5f61 7272 6179  fer(shared_array
-0002e8d0: 5f62 6173 652e 6765 745f 6f62 6a28 2929  _base.get_obj())
-0002e8e0: 0a20 2020 2020 2020 2020 2020 2073 6861  .            sha
-0002e8f0: 7265 645f 6172 7261 7920 3d20 7368 6172  red_array = shar
-0002e900: 6564 5f61 7272 6179 2e72 6573 6861 7065  ed_array.reshape
-0002e910: 2864 6973 742e 7368 6170 6529 0a0a 0a0a  (dist.shape)....
-0002e920: 2020 2020 2020 2020 2020 2020 7368 6172              shar
-0002e930: 6564 5f61 7272 6179 5b3a 5d20 3d20 6469  ed_array[:] = di
-0002e940: 7374 5b3a 5d0a 2020 2020 2020 2020 2020  st[:].          
-0002e950: 2020 2320 6170 7320 3d20 5b70 6f6f 6c2e    # aps = [pool.
-0002e960: 6170 706c 7928 7063 616c 2c20 6172 6773  apply(pcal, args
-0002e970: 3d28 692c 2061 6c6c 696e 6469 6365 732c  =(i, allindices,
-0002e980: 2061 6c6c 7073 6d61 7029 2920 666f 7220   allpsmap)) for 
-0002e990: 6920 696e 2072 6c69 7374 5d0a 2020 2020  i in rlist].    
-0002e9a0: 2020 2020 2020 2020 6170 7320 3d20 5b70          aps = [p
-0002e9b0: 6f6f 6c2e 6170 706c 7928 7073 7375 6d2c  ool.apply(pssum,
-0002e9c0: 2061 7267 733d 2869 2c20 696e 6469 6178   args=(i, indiax
-0002e9d0: 6973 2c20 696e 6469 6178 6973 742c 2073  is, indiaxist, s
-0002e9e0: 6861 7265 645f 6172 7261 7929 2920 666f  hared_array)) fo
-0002e9f0: 7220 6920 696e 2072 6c69 7374 5d0a 2020  r i in rlist].  
-0002ea00: 2020 2020 2020 2020 2020 2320 6170 7320            # aps 
-0002ea10: 3d20 6170 735b 3a2d 315d 0a20 2020 2020  = aps[:-1].     
-0002ea20: 2020 2020 2020 2023 2061 7073 203d 2070         # aps = p
-0002ea30: 6f6f 6c2e 6d61 7028 7365 6c66 2e70 7373  ool.map(self.pss
-0002ea40: 756d 2c20 5b20 6920 666f 7220 6920 696e  um, [ i for i in
-0002ea50: 2061 6c6c 696e 6469 6365 735d 290a 2020   allindices]).  
-0002ea60: 2020 2020 2020 2020 2020 6e65 7761 7073            newaps
-0002ea70: 203d 206c 6973 7428 6974 6572 746f 6f6c   = list(itertool
-0002ea80: 732e 6368 6169 6e2e 6672 6f6d 5f69 7465  s.chain.from_ite
-0002ea90: 7261 626c 6528 6170 7329 290a 2020 2020  rable(aps)).    
-0002eaa0: 2020 2020 2020 2020 2320 7072 696e 7428          # print(
-0002eab0: 6c65 6e28 6e65 7761 7073 2929 0a0a 2020  len(newaps))..  
-0002eac0: 2020 2020 2020 2020 2020 666f 7220 6920            for i 
-0002ead0: 696e 2072 616e 6765 286c 656e 2869 6e64  in range(len(ind
-0002eae0: 6961 7869 7329 2d31 293a 0a20 2020 2020  iaxis)-1):.     
-0002eaf0: 2020 2020 2020 2020 2020 2069 6620 6920             if i 
-0002eb00: 213d 206c 656e 2869 6e64 6961 7869 7329  != len(indiaxis)
-0002eb10: 202d 313a 0a20 2020 2020 2020 2020 2020   -1:.           
-0002eb20: 2020 2020 2020 2020 2070 7375 6d20 3d20           psum = 
-0002eb30: 6c6f 6731 3028 7073 6d61 702e 6675 6c6c  log10(psmap.full
-0002eb40: 4d61 705b 7475 706c 6528 6e65 7761 7073  Map[tuple(newaps
-0002eb50: 5b69 5d2e 5429 5d2e 7375 6d28 2920 2f20  [i].T)].sum() / 
-0002eb60: 6c65 6e28 6e65 7761 7073 5b69 5d29 290a  len(newaps[i])).
-0002eb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002eb80: 2020 2020 616c 6c70 736d 6170 2e61 7070      allpsmap.app
-0002eb90: 656e 6428 7073 756d 290a 0a20 2020 2020  end(psum)..     
-0002eba0: 2020 2020 2020 2070 7269 6e74 2861 6c6c         print(all
-0002ebb0: 7073 6d61 7029 0a0a 2020 2020 2020 2020  psmap)..        
-0002ebc0: 2020 2020 2323 2323 2323 2323 2323 2323      ############
-0002ebd0: 2323 2323 2323 0a0a 2020 2020 2020 2020  ######..        
-0002ebe0: 2020 2020 6461 7461 6469 6374 203d 207b      datadict = {
-0002ebf0: 2772 6f74 6174 696f 6e61 6c6c 795f 6176  'rotationally_av
-0002ec00: 6572 6167 6564 5f70 6f77 6572 5f73 7065  eraged_power_spe
-0002ec10: 6374 7275 6d27 3a20 7b27 7927 3a20 6e70  ctrum': {'y': np
-0002ec20: 2e72 6f75 6e64 2861 6c6c 7073 6d61 702c  .round(allpsmap,
-0002ec30: 2034 292e 746f 6c69 7374 2829 2c0a 2020   4).tolist(),.  
-0002ec40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ec50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ec60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ec70: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0002ec80: 7827 3a20 6e70 2e72 6f75 6e64 2869 6e64  x': np.round(ind
-0002ec90: 6961 7869 735b 3a2d 315d 2c20 3429 2e74  iaxis[:-1], 4).t
-0002eca0: 6f6c 6973 7428 297d 7d0a 2020 2020 2020  olist()}}.      
-0002ecb0: 2020 2020 2020 6572 7220 3d20 2752 4150        err = 'RAP
-0002ecc0: 5320 6361 6c63 756c 6174 696f 6e20 6572  S calculation er
-0002ecd0: 726f 723a 207b 7d2e 272e 666f 726d 6174  ror: {}.'.format
-0002ece0: 2873 7973 2e65 7863 5f69 6e66 6f28 295b  (sys.exc_info()[
-0002ecf0: 315d 290a 2020 2020 2020 2020 2020 2020  1]).            
-0002ed00: 6572 726c 6973 742e 6170 7065 6e64 2865  errlist.append(e
-0002ed10: 7272 290a 2020 2020 2020 2020 2020 2020  rr).            
-0002ed20: 6461 7461 6469 6374 203d 207b 2772 6f74  datadict = {'rot
-0002ed30: 6174 696f 6e61 6c6c 795f 6176 6572 6167  ationally_averag
-0002ed40: 6564 5f70 6f77 6572 5f73 7065 6374 7275  ed_power_spectru
-0002ed50: 6d27 3a20 7b27 6572 7227 3a20 7b27 7261  m': {'err': {'ra
-0002ed60: 7073 5f65 7272 273a 2065 7272 6c69 7374  ps_err': errlist
-0002ed70: 7d7d 7d0a 2020 2020 2020 2020 2020 2020  }}}.            
-0002ed80: 7379 732e 7374 6465 7272 2e77 7269 7465  sys.stderr.write
-0002ed90: 2865 7272 202b 2027 5c6e 2729 0a0a 2020  (err + '\n')..  
-0002eda0: 2020 2020 2020 2020 2020 6966 2062 6f6f            if boo
-0002edb0: 6c28 6461 7461 6469 6374 293a 0a20 2020  l(datadict):.   
-0002edc0: 2020 2020 2020 2020 2020 2020 2074 7279               try
-0002edd0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002ede0: 2020 2020 2020 7769 7468 2063 6f64 6563        with codec
-0002edf0: 732e 6f70 656e 2873 656c 662e 776f 726b  s.open(self.work
-0002ee00: 6469 7220 2b20 7365 6c66 2e6d 6170 6e61  dir + self.mapna
-0002ee10: 6d65 202b 2027 5f72 6170 732e 6a73 6f6e  me + '_raps.json
-0002ee20: 272c 2027 7727 2c20 656e 636f 6469 6e67  ', 'w', encoding
-0002ee30: 3d27 7574 662d 3827 2920 6173 2066 3a0a  ='utf-8') as f:.
-0002ee40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ee50: 2020 2020 2020 2020 6a73 6f6e 2e64 756d          json.dum
-0002ee60: 7028 6461 7461 6469 6374 2c20 6629 0a20  p(datadict, f). 
-0002ee70: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0002ee80: 7863 6570 743a 0a20 2020 2020 2020 2020  xcept:.         
-0002ee90: 2020 2020 2020 2020 2020 2073 7973 2e73             sys.s
-0002eea0: 7464 6572 722e 7772 6974 6528 2753 6176  tderr.write('Sav
-0002eeb0: 696e 6720 5241 5053 2074 6f20 6a73 6f6e  ing RAPS to json
-0002eec0: 2065 7272 6f72 3a20 7b7d 2e27 2e66 6f72   error: {}.'.for
-0002eed0: 6d61 7428 7379 732e 6578 635f 696e 666f  mat(sys.exc_info
-0002eee0: 2829 5b31 5d29 290a 2020 2020 2020 2020  ()[1])).        
-0002eef0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0002ef00: 2020 2020 2020 2020 2020 7379 732e 7374            sys.st
-0002ef10: 6465 7272 2e77 7269 7465 2827 4e6f 2072  derr.write('No r
-0002ef20: 6170 7320 6461 7461 2069 6e20 7468 6520  aps data in the 
-0002ef30: 6469 6374 696f 6e61 7279 2c20 6e6f 2072  dictionary, no r
-0002ef40: 6170 7320 6a73 6f6e 2066 696c 652e 5c6e  aps json file.\n
-0002ef50: 2729 0a0a 2020 2020 2020 2020 2020 2020  ')..            
-0002ef60: 656e 6420 3d20 7469 6d65 6974 2e64 6566  end = timeit.def
-0002ef70: 6175 6c74 5f74 696d 6572 2829 0a20 2020  ault_timer().   
-0002ef80: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
-0002ef90: 5241 5053 2074 696d 653a 2025 7327 2025  RAPS time: %s' %
-0002efa0: 2028 656e 6420 2d20 7374 6172 7429 290a   (end - start)).
-0002efb0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0002efc0: 7428 272d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  t('-------------
-0002efd0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0002efe0: 2d2d 2d2d 2d2d 2d27 290a 2020 2020 2020  -------').      
-0002eff0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0002f000: 2020 2020 7072 696e 7428 274e 6f20 5241      print('No RA
-0002f010: 5053 2063 616c 6375 6c61 7469 6f6e 2066  PS calculation f
-0002f020: 6f72 206e 6f6e 2d63 7562 6963 206d 6170  or non-cubic map
-0002f030: 2e27 290a 2020 2020 2020 2020 2020 2020  .').            
-0002f040: 7072 696e 7428 272d 2d2d 2d2d 2d2d 2d2d  print('---------
-0002f050: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0002f060: 2d2d 2d2d 2d2d 2d2d 2d2d 2d27 290a 0a0a  -----------')...
-0002f070: 2020 2020 2020 2020 7265 7475 726e 204e          return N
-0002f080: 6f6e 650a 0a0a 2020 2020 6465 6620 7261  one...    def ra
-0002f090: 7073 7328 7365 6c66 293a 0a20 2020 2020  pss(self):.     
-0002f0a0: 2020 2022 2222 0a20 2020 2020 2020 2020     """.         
-0002f0b0: 2020 2063 616c 6375 6c61 7465 2062 6f74     calculate bot
-0002f0c0: 6820 7072 696d 6172 7920 6d61 7020 7261  h primary map ra
-0002f0d0: 7073 2061 6e64 2072 6177 6d61 7020 7261  ps and rawmap ra
-0002f0e0: 7073 0a20 2020 2020 2020 203a 7265 7475  ps.        :retu
-0002f0f0: 726e 3a20 4e6f 6e65 0a20 2020 2020 2020  rn: None.       
-0002f100: 2022 2222 0a20 2020 2020 2020 2069 6620   """.        if 
-0002f110: 7365 6c66 2e6d 6170 3a0a 2020 2020 2020  self.map:.      
-0002f120: 2020 2020 2020 7374 6172 7472 6170 7320        startraps 
-0002f130: 3d20 7469 6d65 6974 2e64 6566 6175 6c74  = timeit.default
-0002f140: 5f74 696d 6572 2829 0a20 2020 2020 2020  _timer().       
-0002f150: 2020 2020 2073 656c 662e 6e65 775f 7261       self.new_ra
-0002f160: 7073 2829 0a20 2020 2020 2020 2020 2020  ps().           
-0002f170: 2073 746f 7072 6170 7320 3d20 7469 6d65   stopraps = time
-0002f180: 6974 2e64 6566 6175 6c74 5f74 696d 6572  it.default_timer
-0002f190: 2829 0a20 2020 2020 2020 2020 2020 2070  ().            p
-0002f1a0: 7269 6e74 2827 5241 5053 3a20 2573 2720  rint('RAPS: %s' 
-0002f1b0: 2520 2873 746f 7072 6170 7320 2d20 7374  % (stopraps - st
-0002f1c0: 6172 7472 6170 7329 290a 2020 2020 2020  artraps)).      
-0002f1d0: 2020 2020 2020 7072 696e 7428 272d 2d2d        print('---
-0002f1e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0002f1f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0002f200: 2d27 290a 2020 2020 2020 2020 656c 7365  -').        else
-0002f210: 3a0a 2020 2020 2020 2020 2020 2020 7072  :.            pr
-0002f220: 696e 7428 274e 6f20 7072 6f70 6572 2070  int('No proper p
-0002f230: 7269 6d61 7279 206d 6170 2066 6f72 2052  rimary map for R
-0002f240: 4150 5320 6361 6c63 756c 6174 696f 6e2e  APS calculation.
-0002f250: 2729 0a0a 2020 2020 2020 2020 6966 2073  ')..        if s
-0002f260: 656c 662e 686d 6576 656e 2069 7320 6e6f  elf.hmeven is no
-0002f270: 7420 4e6f 6e65 2061 6e64 2073 656c 662e  t None and self.
-0002f280: 686d 6f64 6420 6973 206e 6f74 204e 6f6e  hmodd is not Non
-0002f290: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
-0002f2a0: 7461 7274 7261 7073 203d 2074 696d 6569  tartraps = timei
-0002f2b0: 742e 6465 6661 756c 745f 7469 6d65 7228  t.default_timer(
-0002f2c0: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
-0002f2d0: 7365 6c66 2e66 7363 2873 656c 662e 686d  self.fsc(self.hm
-0002f2e0: 6576 656e 2c20 7365 6c66 2e68 6d6f 6464  even, self.hmodd
-0002f2f0: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
-0002f300: 6c66 2e72 6177 6d61 705f 7261 7073 2829  lf.rawmap_raps()
-0002f310: 0a20 2020 2020 2020 2020 2020 2073 746f  .            sto
-0002f320: 7020 3d20 7469 6d65 6974 2e64 6566 6175  p = timeit.defau
-0002f330: 6c74 5f74 696d 6572 2829 0a20 2020 2020  lt_timer().     
-0002f340: 2020 2020 2020 2070 7269 6e74 2827 5261         print('Ra
-0002f350: 7720 6d61 7020 5241 5053 3a20 2573 2720  w map RAPS: %s' 
-0002f360: 2520 2873 746f 7020 2d20 7374 6172 7472  % (stop - startr
-0002f370: 6170 7329 290a 2020 2020 2020 2020 2020  aps)).          
-0002f380: 2020 7072 696e 7428 272d 2d2d 2d2d 2d2d    print('-------
-0002f390: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0002f3a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d27 290a  -------------').
-0002f3b0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0002f3c0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-0002f3d0: 274e 6f20 7261 7720 6d61 7020 5241 5053  'No raw map RAPS
-0002f3e0: 3a20 4d69 7369 6e67 2068 616c 6620 6d61  : Mising half ma
-0002f3f0: 7028 7329 2e27 290a 2020 2020 2020 2020  p(s).').        
-0002f400: 706c 742e 636c 6f73 6528 290a 0a20 2020  plt.close()..   
-0002f410: 2023 2040 7072 6f66 696c 650a 2020 2020   # @profile.    
-0002f420: 6465 6620 7261 776d 6170 5f72 6170 7328  def rawmap_raps(
-0002f430: 7365 6c66 293a 0a0a 2020 2020 2020 2020  self):..        
-0002f440: 7261 776d 6170 203d 2073 656c 662e 7261  rawmap = self.ra
-0002f450: 776d 6170 0a20 2020 2020 2020 2069 6620  wmap.        if 
-0002f460: 7261 776d 6170 2069 7320 6e6f 7420 4e6f  rawmap is not No
-0002f470: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0002f480: 6469 7220 3d20 7365 6c66 2e77 6f72 6b64  dir = self.workd
-0002f490: 6972 0a20 2020 2020 2020 2020 2020 206c  ir.            l
-0002f4a0: 6162 656c 203d 2027 7261 776d 6170 5f27  abel = 'rawmap_'
-0002f4b0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0002f4c0: 662e 6e65 775f 7261 7073 2872 6177 6d61  f.new_raps(rawma
-0002f4d0: 702c 2064 6972 2c20 6c61 6265 6c29 0a20  p, dir, label). 
-0002f4e0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0002f4f0: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
-0002f500: 4e6f 2072 6177 206d 6170 2074 6f20 6361  No raw map to ca
-0002f510: 6c63 756c 6174 6520 5241 5053 2e27 290a  lculate RAPS.').
-0002f520: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0002f530: 4e6f 6e65 0a0a 2020 2020 2340 7072 6f66  None..    #@prof
-0002f540: 696c 650a 2020 2020 6465 6620 666f 7572  ile.    def four
-0002f550: 6965 725f 7472 616e 7366 6f72 6d28 7365  ier_transform(se
-0002f560: 6c66 2c20 6d61 7064 6174 6129 3a0a 0a0a  lf, mapdata):...
-0002f570: 2020 2020 2020 2020 6e65 775f 6d61 7064          new_mapd
-0002f580: 6174 6120 3d20 6666 7473 6869 6674 2866  ata = fftshift(f
-0002f590: 6674 6e28 6d61 7064 6174 6129 290a 2020  ftn(mapdata)).  
-0002f5a0: 2020 2020 2020 7265 7475 726e 206e 6577        return new
-0002f5b0: 5f6d 6170 6461 7461 0a0a 2020 2020 2340  _mapdata..    #@
-0002f5c0: 7072 6f66 696c 650a 2020 2020 6465 6620  profile.    def 
-0002f5d0: 7261 7073 2873 656c 662c 206d 6170 696e  raps(self, mapin
-0002f5e0: 3d4e 6f6e 652c 2077 6f72 6b64 6972 3d4e  =None, workdir=N
-0002f5f0: 6f6e 652c 206c 6162 656c 3d27 2729 3a0a  one, label=''):.
-0002f600: 2020 2020 2020 2020 2222 220a 0a20 2020          """..   
-0002f610: 2020 2020 2020 2020 2043 616c 6375 6c61           Calcula
-0002f620: 7469 6f6e 206f 6620 7468 6520 726f 7461  tion of the rota
-0002f630: 7469 6f6e 616c 6c79 2061 7665 7261 6765  tionally average
-0002f640: 2070 6f77 6572 2073 7065 6374 7275 6d20   power spectrum 
-0002f650: 2852 4150 5329 0a20 2020 2020 2020 2020  (RAPS).         
-0002f660: 2020 2052 6573 756c 7473 2077 726f 7465     Results wrote
-0002f670: 2074 6f20 4a53 4f4e 2066 696c 650a 0a20   to JSON file.. 
-0002f680: 2020 2020 2020 203a 7265 7475 726e 3a20         :return: 
-0002f690: 4e6f 6e65 0a0a 2020 2020 2020 2020 2222  None..        ""
-0002f6a0: 220a 0a20 2020 2020 2020 206d 6170 2c20  "..        map, 
-0002f6b0: 776f 726b 6469 7220 3d20 7365 6c66 2e6d  workdir = self.m
-0002f6c0: 6170 696e 6368 6563 6b28 6d61 7069 6e2c  apincheck(mapin,
-0002f6d0: 2077 6f72 6b64 6972 290a 2020 2020 2020   workdir).      
-0002f6e0: 2020 6d61 706e 616d 6520 3d20 6f73 2e70    mapname = os.p
-0002f6f0: 6174 682e 6261 7365 6e61 6d65 286d 6170  ath.basename(map
-0002f700: 2e66 756c 6c6e 616d 6529 0a0a 2020 2020  .fullname)..    
-0002f710: 2020 2020 6d61 705f 7a73 697a 6520 3d20      map_zsize = 
-0002f720: 6d61 702e 6865 6164 6572 2e6e 7a0a 2020  map.header.nz.  
-0002f730: 2020 2020 2020 6d61 705f 7973 697a 6520        map_ysize 
-0002f740: 3d20 6d61 702e 6865 6164 6572 2e6e 790a  = map.header.ny.
-0002f750: 2020 2020 2020 2020 6d61 705f 7873 697a          map_xsiz
-0002f760: 6520 3d20 6d61 702e 6865 6164 6572 2e6e  e = map.header.n
-0002f770: 780a 0a20 2020 2020 2020 2061 7069 785f  x..        apix_
-0002f780: 6c69 7374 203d 206d 6170 2e76 6f78 656c  list = map.voxel
-0002f790: 5f73 697a 652e 746f 6c69 7374 2829 0a20  _size.tolist(). 
-0002f7a0: 2020 2020 2020 2061 7069 7873 203d 2028         apixs = (
-0002f7b0: 6170 6978 5f6c 6973 745b 305d 2c20 6170  apix_list[0], ap
-0002f7c0: 6978 5f6c 6973 745b 315d 2c20 6170 6978  ix_list[1], apix
-0002f7d0: 5f6c 6973 745b 325d 290a 0a20 2020 2020  _list[2])..     
-0002f7e0: 2020 2069 6620 6d61 7020 6973 206e 6f74     if map is not
-0002f7f0: 204e 6f6e 6520 616e 6420 776f 726b 6469   None and workdi
-0002f800: 7220 6973 206e 6f74 204e 6f6e 653a 0a20  r is not None:. 
-0002f810: 2020 2020 2020 2020 2020 2023 2069 6620             # if 
-0002f820: 6d61 702e 785f 7369 7a65 2829 203d 3d20  map.x_size() == 
-0002f830: 6d61 702e 795f 7369 7a65 2829 203d 3d20  map.y_size() == 
-0002f840: 6d61 702e 7a5f 7369 7a65 2829 3a0a 2020  map.z_size():.  
-0002f850: 2020 2020 2020 2020 2020 6966 206d 6170            if map
-0002f860: 2e68 6561 6465 722e 6e78 203d 3d20 6d61  .header.nx == ma
-0002f870: 702e 6865 6164 6572 2e6e 7920 3d3d 206d  p.header.ny == m
-0002f880: 6170 2e68 6561 6465 722e 6e7a 3a0a 2020  ap.header.nz:.  
-0002f890: 2020 2020 2020 2020 2020 2020 2020 6572                er
-0002f8a0: 726c 6973 7420 3d20 5b5d 0a20 2020 2020  rlist = [].     
-0002f8b0: 2020 2020 2020 2020 2020 2073 7461 7274             start
-0002f8c0: 203d 2074 696d 6569 742e 6465 6661 756c   = timeit.defaul
-0002f8d0: 745f 7469 6d65 7228 290a 2020 2020 2020  t_timer().      
-0002f8e0: 2020 2020 2020 2020 2020 6461 7461 6469            datadi
-0002f8f0: 6374 203d 2064 6963 7428 290a 2020 2020  ct = dict().    
-0002f900: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-0002f910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002f920: 2020 2020 2023 206d 6170 203d 2073 656c       # map = sel
-0002f930: 662e 6d61 700a 2020 2020 2020 2020 2020  f.map.          
-0002f940: 2020 2020 2020 2020 2020 2320 7465 6d70            # temp
-0002f950: 7261 7279 2073 6f6c 7574 696f 6e20 6173  rary solution as
-0002f960: 2074 6865 2074 656d 7079 2067 6976 6520   the tempy give 
-0002f970: 6170 6978 2061 7320 6f6e 6520 7661 6c75  apix as one valu
-0002f980: 6520 6275 7420 6865 7265 2066 726f 6d20  e but here from 
-0002f990: 6d72 6366 696c 6520 7765 2075 7365 2061  mrcfile we use a
-0002f9a0: 2074 7570 6c65 0a20 2020 2020 2020 2020   tuple.         
-0002f9b0: 2020 2020 2020 2020 2020 2023 2069 6620             # if 
-0002f9c0: 7479 7065 286d 6170 2e61 7069 7829 2069  type(map.apix) i
-0002f9d0: 7320 7475 706c 653a 0a20 2020 2020 2020  s tuple:.       
-0002f9e0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0002f9f0: 7479 7065 2861 7069 7873 2920 6973 2074  type(apixs) is t
-0002fa00: 7570 6c65 3a0a 2020 2020 2020 2020 2020  uple:.          
-0002fa10: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0002fa20: 6170 6978 203d 206d 6170 2e61 7069 785b  apix = map.apix[
-0002fa30: 305d 0a20 2020 2020 2020 2020 2020 2020  0].             
-0002fa40: 2020 2020 2020 2020 2020 2061 7069 7820             apix 
-0002fa50: 3d20 6170 6978 735b 305d 0a20 2020 2020  = apixs[0].     
-0002fa60: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0002fa70: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0002fa80: 2020 2020 2020 2020 2020 2020 2023 2061               # a
-0002fa90: 7069 7820 3d20 6d61 702e 6170 6978 0a20  pix = map.apix. 
-0002faa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fab0: 2020 2020 2020 2061 7069 7820 3d20 6170         apix = ap
-0002fac0: 6978 730a 2020 2020 2020 2020 2020 2020  ixs.            
-0002fad0: 2020 2020 2020 2020 2320 6666 746d 6170          # fftmap
-0002fae0: 203d 206d 6170 2e66 6f75 7269 6572 5f74   = map.fourier_t
-0002faf0: 7261 6e73 666f 726d 2829 0a20 2020 2020  ransform().     
-0002fb00: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0002fb10: 6674 6d61 7020 3d20 6666 7473 6869 6674  ftmap = fftshift
-0002fb20: 2866 6674 6e28 6d61 702e 6461 7461 2929  (fftn(map.data))
-0002fb30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002fb40: 2020 2020 2023 2070 736d 6170 203d 2066       # psmap = f
-0002fb50: 6674 6d61 702e 636f 7079 2829 0a20 2020  ftmap.copy().   
-0002fb60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fb70: 2023 2070 736d 6561 6e20 3d20 6e70 2e6d   # psmean = np.m
-0002fb80: 6561 6e28 7073 6d61 702e 6675 6c6c 4d61  ean(psmap.fullMa
-0002fb90: 7029 0a20 2020 2020 2020 2020 2020 2020  p).             
-0002fba0: 2020 2020 2020 2023 2070 7373 7464 203d         # psstd =
-0002fbb0: 206e 702e 7374 6428 7073 6d61 702e 6675   np.std(psmap.fu
-0002fbc0: 6c6c 4d61 7029 0a20 2020 2020 2020 2020  llMap).         
-0002fbd0: 2020 2020 2020 2020 2020 2023 2070 736d             # psm
-0002fbe0: 6170 2e66 756c 6c4d 6170 203d 206e 702e  ap.fullMap = np.
-0002fbf0: 6162 7328 2870 736d 6170 2e66 756c 6c4d  abs((psmap.fullM
-0002fc00: 6170 202d 2070 736d 6561 6e29 202f 2070  ap - psmean) / p
-0002fc10: 7373 7464 2920 2a2a 2032 0a20 2020 2020  sstd) ** 2.     
-0002fc20: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0002fc30: 736d 6561 6e20 3d20 6e70 2e6d 6561 6e28  smean = np.mean(
-0002fc40: 6666 746d 6170 290a 2020 2020 2020 2020  fftmap).        
-0002fc50: 2020 2020 2020 2020 2020 2020 7073 7374              psst
-0002fc60: 6420 3d20 6e70 2e73 7464 2866 6674 6d61  d = np.std(fftma
-0002fc70: 7029 0a20 2020 2020 2020 2020 2020 2020  p).             
-0002fc80: 2020 2020 2020 2066 6674 6d61 7020 3d20         fftmap = 
-0002fc90: 6e70 2e61 6273 2828 6666 746d 6170 202d  np.abs((fftmap -
-0002fca0: 2070 736d 6561 6e29 202f 2070 7373 7464   psmean) / psstd
-0002fcb0: 2920 2a2a 2032 0a0a 2020 2020 2020 2020  ) ** 2..        
-0002fcc0: 2020 2020 2020 2020 2020 2020 6d69 6473              mids
-0002fcd0: 7461 7274 203d 2074 696d 6569 742e 6465  tart = timeit.de
-0002fce0: 6661 756c 745f 7469 6d65 7228 2920 2d20  fault_timer() - 
-0002fcf0: 7374 6172 740a 2020 2020 2020 2020 2020  start.          
-0002fd00: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-0002fd10: 2720 2d2d 2052 4150 5320 466f 7572 6965  ' -- RAPS Fourie
-0002fd20: 722d 7472 616e 7366 6f72 6d61 7469 6f6e  r-transformation
-0002fd30: 2074 696d 653a 2025 7327 2025 206d 6964   time: %s' % mid
-0002fd40: 7374 6172 7429 0a0a 2020 2020 2020 2020  start)..        
-0002fd50: 2020 2020 2020 2020 2020 2020 2320 7a67              # zg
-0002fd60: 7269 6420 3d20 6e70 2e61 7261 6e67 6528  rid = np.arange(
-0002fd70: 666c 6f6f 7228 7073 6d61 702e 7a5f 7369  floor(psmap.z_si
-0002fd80: 7a65 2829 202f 2032 2e30 2920 2a20 2d31  ze() / 2.0) * -1
-0002fd90: 2c20 6365 696c 2870 736d 6170 2e7a 5f73  , ceil(psmap.z_s
-0002fda0: 697a 6528 2920 2f20 322e 3029 2920 2f20  ize() / 2.0)) / 
-0002fdb0: 666c 6f61 7428 666c 6f6f 7228 7073 6d61  float(floor(psma
-0002fdc0: 702e 7a5f 7369 7a65 2829 2929 0a20 2020  p.z_size())).   
+0002d290: 2020 2020 706c 742e 6c65 6765 6e64 286c      plt.legend(l
+0002d2a0: 6f63 3d27 6c6f 7765 7220 6c65 6674 2729  oc='lower left')
+0002d2b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002d2c0: 2020 2020 2070 6c74 2e73 6176 6566 6967       plt.savefig
+0002d2d0: 2873 656c 662e 776f 726b 6469 7220 2b20  (self.workdir + 
+0002d2e0: 7365 6c66 2e6d 6170 6e61 6d65 202b 2027  self.mapname + '
+0002d2f0: 5f69 6e63 6c75 7369 6f6e 2e70 6e67 2729  _inclusion.png')
+0002d300: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002d310: 2020 2020 2070 6c74 2e63 6c6f 7365 2829       plt.close()
+0002d320: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002d330: 2065 7863 6570 743a 0a20 2020 2020 2020   except:.       
+0002d340: 2020 2020 2020 2020 2020 2020 2065 7272               err
+0002d350: 203d 2027 4174 6f6d 2069 6e63 6c75 7369   = 'Atom inclusi
+0002d360: 6f6e 2063 616c 6375 6c61 7469 6f6e 2065  on calculation e
+0002d370: 7272 6f72 284d 6f64 656c 3a20 7b7d 293a  rror(Model: {}):
+0002d380: 207b 7d2e 272e 666f 726d 6174 286b 6579   {}.'.format(key
+0002d390: 2c20 7379 732e 6578 635f 696e 666f 2829  , sys.exc_info()
+0002d3a0: 5b31 5d29 0a20 2020 2020 2020 2020 2020  [1]).           
+0002d3b0: 2020 2020 2020 2020 2065 7272 6c69 7374           errlist
+0002d3c0: 2e61 7070 656e 6428 6572 7229 0a20 2020  .append(err).   
+0002d3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d3e0: 2073 7973 2e73 7464 6572 722e 7772 6974   sys.stderr.writ
+0002d3f0: 6528 6572 7220 2b20 275c 6e27 290a 2020  e(err + '\n').  
+0002d400: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0002d410: 2065 7272 6c69 7374 3a0a 2020 2020 2020   errlist:.      
+0002d420: 2020 2020 2020 2020 2020 2020 2020 6461                da
+0002d430: 7461 6469 6374 5b73 7472 2863 6f75 6e74  tadict[str(count
+0002d440: 6572 295d 203d 207b 2765 7272 273a 207b  er)] = {'err': {
+0002d450: 2761 746f 6d5f 696e 636c 7573 696f 6e5f  'atom_inclusion_
+0002d460: 6572 7227 3a20 6572 726c 6973 747d 7d0a  err': errlist}}.
+0002d470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002d480: 2063 6f6e 746f 7572 6469 6374 203d 204f   contourdict = O
+0002d490: 7264 6572 6564 4469 6374 2829 0a20 2020  rderedDict().   
+0002d4a0: 2020 2020 2020 2020 2020 2020 2074 7279               try
+0002d4b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002d4c0: 2020 2020 2020 666f 7220 636f 6e74 6f75        for contou
+0002d4d0: 722c 206b 6579 7376 616c 7565 7320 696e  r, keysvalues in
+0002d4e0: 2061 6c6c 636f 6e74 6f75 7273 6469 6374   allcontoursdict
+0002d4f0: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
+0002d500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d510: 2020 616c 6c76 616c 7565 7320 3d20 6b65    allvalues = ke
+0002d520: 7973 7661 6c75 6573 5b31 5d0a 2020 2020  ysvalues[1].    
+0002d530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d540: 2020 2020 616c 6c6b 6579 7320 3d20 6b65      allkeys = ke
+0002d550: 7973 7661 6c75 6573 5b30 5d0a 2020 2020  ysvalues[0].    
+0002d560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d570: 2020 2020 636f 6c6f 7572 7320 3d20 7365      colours = se
+0002d580: 6c66 2e5f 5f66 6c6f 6174 6f68 6578 2861  lf.__floatohex(a
+0002d590: 6c6c 7661 6c75 6573 290a 2020 2020 2020  llvalues).      
+0002d5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d5b0: 2020 636f 6e74 6f75 726b 6579 203d 2073    contourkey = s
+0002d5c0: 7472 2872 6f75 6e64 2866 6c6f 6174 2863  tr(round(float(c
+0002d5d0: 6f6e 746f 7572 292c 2036 2929 0a20 2020  ontour), 6)).   
+0002d5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d5f0: 2020 2020 2063 6f6e 746f 7572 6469 6374       contourdict
+0002d600: 5b63 6f6e 746f 7572 6b65 795d 203d 204f  [contourkey] = O
+0002d610: 7264 6572 6564 4469 6374 285b 2827 636f  rderedDict([('co
+0002d620: 6c6f 7227 2c20 636f 6c6f 7572 7329 2c20  lor', colours), 
+0002d630: 2827 696e 636c 7573 696f 6e27 2c20 616c  ('inclusion', al
+0002d640: 6c76 616c 7565 7329 2c0a 2020 2020 2020  lvalues),.      
+0002d650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d680: 2020 2020 2020 2020 2028 2772 6573 6964           ('resid
+0002d690: 7565 272c 2061 6c6c 6b65 7973 295d 290a  ue', allkeys)]).
+0002d6a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002d6b0: 2020 2020 2063 6f6e 746f 7572 6469 6374       contourdict
+0002d6c0: 5b27 6e61 6d65 275d 203d 206b 6579 0a20  ['name'] = key. 
+0002d6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d6e0: 2020 2072 6573 6469 6374 5b73 7472 2863     resdict[str(c
+0002d6f0: 6f75 6e74 6572 295d 203d 2063 6f6e 746f  ounter)] = conto
+0002d700: 7572 6469 6374 0a20 2020 2020 2020 2020  urdict.         
+0002d710: 2020 2020 2020 2065 7863 6570 743a 0a20         except:. 
+0002d720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d730: 2020 2065 7272 203d 2027 5265 7369 6475     err = 'Residu
+0002d740: 6520 696e 636c 7573 696f 6e20 6361 6c63  e inclusion calc
+0002d750: 756c 6174 696f 6e20 6572 726f 7228 4d6f  ulation error(Mo
+0002d760: 6465 6c3a 207b 7d29 3a20 7b7d 2e27 2e66  del: {}): {}.'.f
+0002d770: 6f72 6d61 7428 6b65 792c 2073 7973 2e65  ormat(key, sys.e
+0002d780: 7863 5f69 6e66 6f28 295b 315d 290a 2020  xc_info()[1]).  
+0002d790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002d7a0: 2020 7265 7365 7272 6c69 7374 2e61 7070    reserrlist.app
+0002d7b0: 656e 6428 6572 7229 0a20 2020 2020 2020  end(err).       
+0002d7c0: 2020 2020 2020 2020 2020 2020 2073 7973               sys
+0002d7d0: 2e73 7464 6572 722e 7772 6974 6528 6572  .stderr.write(er
+0002d7e0: 7220 2b20 275c 6e27 290a 2020 2020 2020  r + '\n').      
+0002d7f0: 2020 2020 2020 2020 2020 6966 2072 6573            if res
+0002d800: 6572 726c 6973 743a 0a20 2020 2020 2020  errlist:.       
+0002d810: 2020 2020 2020 2020 2020 2020 2072 6573               res
+0002d820: 6469 6374 5b73 7472 2863 6f75 6e74 6572  dict[str(counter
+0002d830: 295d 203d 207b 2765 7272 273a 207b 2772  )] = {'err': {'r
+0002d840: 6573 6964 7565 5f69 6e63 6c75 7369 6f6e  esidue_inclusion
+0002d850: 5f65 7272 273a 2072 6573 6572 726c 6973  _err': reserrlis
+0002d860: 747d 7d0a 2020 2020 2020 2020 2020 2020  t}}.            
+0002d870: 2020 2020 636f 756e 7465 7220 2b3d 2031      counter += 1
+0002d880: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+0002d890: 2061 6c6c 6d6f 6465 6c73 5f6e 756d 6265   allmodels_numbe
+0002d8a0: 7261 746f 6d73 2021 3d20 303a 0a20 2020  ratoms != 0:.   
+0002d8b0: 2020 2020 2020 2020 2020 2020 2061 7665               ave
+0002d8c0: 7261 6765 5f61 695f 616c 6c6d 6f64 656c  rage_ai_allmodel
+0002d8d0: 7320 3d20 616c 6c6d 6f64 656c 735f 6174  s = allmodels_at
+0002d8e0: 6f6d 5f69 6e63 6c75 7369 6f6e 202f 2061  om_inclusion / a
+0002d8f0: 6c6c 6d6f 6465 6c73 5f6e 756d 6265 7261  llmodels_numbera
+0002d900: 746f 6d73 0a20 2020 2020 2020 2020 2020  toms.           
+0002d910: 2020 2020 2064 6174 6164 6963 745b 2761       datadict['a
+0002d920: 7665 7261 6765 5f61 695f 616c 6c6d 6f64  verage_ai_allmod
+0002d930: 656c 7327 5d20 3d20 726f 756e 6428 6176  els'] = round(av
+0002d940: 6572 6167 655f 6169 5f61 6c6c 6d6f 6465  erage_ai_allmode
+0002d950: 6c73 2c20 3329 0a20 2020 2020 2020 2020  ls, 3).         
+0002d960: 2020 2061 746f 6d69 6e64 6963 745b 2761     atomindict['a
+0002d970: 746f 6d5f 696e 636c 7573 696f 6e5f 6279  tom_inclusion_by
+0002d980: 5f6c 6576 656c 275d 203d 2064 6174 6164  _level'] = datad
+0002d990: 6963 740a 2020 2020 2020 2020 2020 2020  ict.            
+0002d9a0: 7265 7369 6e64 6963 745b 2772 6573 6964  resindict['resid
+0002d9b0: 7565 5f69 6e63 6c75 7369 6f6e 275d 203d  ue_inclusion'] =
+0002d9c0: 2072 6573 6469 6374 0a0a 2020 2020 2020   resdict..      
+0002d9d0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+0002d9e0: 2020 2020 2020 2020 2020 2077 6974 6820             with 
+0002d9f0: 636f 6465 6373 2e6f 7065 6e28 7365 6c66  codecs.open(self
+0002da00: 2e77 6f72 6b64 6972 202b 2073 656c 662e  .workdir + self.
+0002da10: 6d61 706e 616d 6520 2b20 275f 6174 6f6d  mapname + '_atom
+0002da20: 5f69 6e63 6c75 7369 6f6e 2e6a 736f 6e27  _inclusion.json'
+0002da30: 2c20 2777 272c 0a20 2020 2020 2020 2020  , 'w',.         
+0002da40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002da50: 2020 2020 2020 2020 656e 636f 6469 6e67          encoding
+0002da60: 3d27 7574 662d 3827 2920 6173 2066 3a0a  ='utf-8') as f:.
+0002da70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002da80: 2020 2020 6a73 6f6e 2e64 756d 7028 6174      json.dump(at
+0002da90: 6f6d 696e 6469 6374 2c20 6629 0a20 2020  omindict, f).   
+0002daa0: 2020 2020 2020 2020 2065 7863 6570 743a           except:
+0002dab0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002dac0: 2073 7973 2e73 7464 6572 722e 7772 6974   sys.stderr.writ
+0002dad0: 6528 2753 6176 696e 6720 746f 2061 746f  e('Saving to ato
+0002dae0: 6d20 696e 636c 7573 696f 6e20 6a73 6f6e  m inclusion json
+0002daf0: 2065 7272 6f72 3a20 7b7d 2e5c 6e27 2e66   error: {}.\n'.f
+0002db00: 6f72 6d61 7428 7379 732e 6578 635f 696e  ormat(sys.exc_in
+0002db10: 666f 2829 5b31 5d29 290a 0a20 2020 2020  fo()[1]))..     
+0002db20: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+0002db30: 2020 2020 2020 2020 2020 2020 7769 7468              with
+0002db40: 2063 6f64 6563 732e 6f70 656e 2873 656c   codecs.open(sel
+0002db50: 662e 776f 726b 6469 7220 2b20 7365 6c66  f.workdir + self
+0002db60: 2e6d 6170 6e61 6d65 202b 2027 5f72 6573  .mapname + '_res
+0002db70: 6964 7565 5f69 6e63 6c75 7369 6f6e 2e6a  idue_inclusion.j
+0002db80: 736f 6e27 2c20 2777 272c 0a20 2020 2020  son', 'w',.     
+0002db90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002dba0: 2020 2020 2020 2020 2020 2020 656e 636f              enco
+0002dbb0: 6469 6e67 3d27 7574 662d 3827 2920 6173  ding='utf-8') as
+0002dbc0: 2066 313a 0a20 2020 2020 2020 2020 2020   f1:.           
+0002dbd0: 2020 2020 2020 2020 206a 736f 6e2e 6475           json.du
+0002dbe0: 6d70 2872 6573 696e 6469 6374 2c20 6631  mp(resindict, f1
+0002dbf0: 290a 2020 2020 2020 2020 2020 2020 6578  ).            ex
+0002dc00: 6365 7074 3a0a 2020 2020 2020 2020 2020  cept:.          
+0002dc10: 2020 2020 2020 7379 732e 7374 6465 7272        sys.stderr
+0002dc20: 2e77 7269 7465 2827 5361 7669 6e67 2074  .write('Saving t
+0002dc30: 6f20 7265 7369 6475 6520 696e 636c 7573  o residue inclus
+0002dc40: 696f 6e20 6a73 6f6e 2065 7272 6f72 3a20  ion json error: 
+0002dc50: 7b7d 2e5c 6e27 2e66 6f72 6d61 7428 7379  {}.\n'.format(sy
+0002dc60: 732e 6578 635f 696e 666f 2829 5b31 5d29  s.exc_info()[1])
+0002dc70: 290a 0a0a 0a20 2020 2020 2020 2020 2020  )....           
+0002dc80: 2065 6e64 203d 2074 696d 6569 742e 6465   end = timeit.de
+0002dc90: 6661 756c 745f 7469 6d65 7228 290a 2020  fault_timer().  
+0002dca0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0002dcb0: 2749 6e63 6c75 7369 6f6e 2074 696d 653a  'Inclusion time:
+0002dcc0: 2025 7327 2025 2028 656e 6420 2d20 7374   %s' % (end - st
+0002dcd0: 6172 7429 290a 2020 2020 2020 2020 2020  art)).          
+0002dce0: 2020 7072 696e 7428 272d 2d2d 2d2d 2d2d    print('-------
+0002dcf0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0002dd00: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d27 290a  -------------').
+0002dd10: 2020 2020 2020 2020 7265 7475 726e 204e          return N
+0002dd20: 6f6e 650a 0a20 2020 2023 2056 6f6c 756d  one..    # Volum
+0002dd30: 6563 6f6e 746f 7572 0a0a 2020 2020 2320  econtour..    # 
+0002dd40: 4070 726f 6669 6c65 0a20 2020 2064 6566  @profile.    def
+0002dd50: 2076 6f6c 756d 6563 6f6e 746f 7572 2873   volumecontour(s
+0002dd60: 656c 6629 3a0a 2020 2020 2020 2020 2222  elf):.        ""
+0002dd70: 220a 0a20 2020 2020 2020 2020 2020 2047  "..            G
+0002dd80: 656e 6572 6174 6520 566f 6c75 6d65 2076  enerate Volume v
+0002dd90: 6572 7375 7320 636f 6e74 6f75 7220 6c65  ersus contour le
+0002dda0: 7665 6c20 706c 6f74 2e0a 2020 2020 2020  vel plot..      
+0002ddb0: 2020 2020 2020 5265 7375 6c74 2077 726f        Result wro
+0002ddc0: 7465 2074 6f20 6120 4a53 4f4e 2066 696c  te to a JSON fil
+0002ddd0: 652e 0a20 2020 2020 2020 2020 2020 2056  e..            V
+0002dde0: 6965 7720 696e 6469 6365 7320 6173 2073  iew indices as s
+0002ddf0: 6974 696e 6720 6f6e 2074 6865 2063 656e  iting on the cen
+0002de00: 7472 616c 206f 6620 6561 6368 2076 6f78  tral of each vox
+0002de10: 656c 2c20 6e6f 2069 6e74 6572 706f 6c61  el, no interpola
+0002de20: 7469 6f6e 206e 6565 6465 642e 0a0a 2020  tion needed...  
+0002de30: 2020 2020 2020 3a72 6574 7572 6e3a 204e        :return: N
+0002de40: 6f6e 650a 0a20 2020 2020 2020 2022 2222  one..        """
+0002de50: 0a0a 2020 2020 2020 2020 7374 6172 7420  ..        start 
+0002de60: 3d20 7469 6d65 6974 2e64 6566 6175 6c74  = timeit.default
+0002de70: 5f74 696d 6572 2829 0a20 2020 2020 2020  _timer().       
+0002de80: 206d 6170 203d 2073 656c 662e 6d61 700a   map = self.map.
+0002de90: 2020 2020 2020 2020 2320 7465 6d70 7261          # tempra
+0002dea0: 7279 2073 6f6c 7574 696f 6e20 6173 2074  ry solution as t
+0002deb0: 6865 2074 656d 7079 2067 6976 6520 6170  he tempy give ap
+0002dec0: 6978 2061 7320 6f6e 6520 7661 6c75 6520  ix as one value 
+0002ded0: 6275 7420 6865 7265 2066 726f 6d20 6d72  but here from mr
+0002dee0: 6366 696c 6520 7765 2075 7365 2061 2074  cfile we use a t
+0002def0: 7570 6c65 0a20 2020 2020 2020 2023 2063  uple.        # c
+0002df00: 6865 636b 2066 756e 6374 696f 6e6e 2066  heck functionn f
+0002df10: 726f 6d6d 7263 5f74 6f74 656d 7079 2069  rommrc_totempy i
+0002df20: 6e20 7072 6570 6172 6174 696f 6e2e 7079  n preparation.py
+0002df30: 0a20 2020 2020 2020 2061 7069 7820 3d20  .        apix = 
+0002df40: 6d61 702e 766f 7865 6c5f 7369 7a65 2e74  map.voxel_size.t
+0002df50: 6f6c 6973 7428 290a 2020 2020 2020 2020  olist().        
+0002df60: 6d61 7064 6174 6120 3d20 6d61 702e 6461  mapdata = map.da
+0002df70: 7461 0a20 2020 2020 2020 2065 7272 6c69  ta.        errli
+0002df80: 7374 203d 205b 5d0a 2020 2020 2020 2020  st = [].        
+0002df90: 6461 7461 6469 6374 203d 2064 6963 7428  datadict = dict(
+0002dfa0: 290a 2020 2020 2020 2020 7472 793a 0a20  ).        try:. 
+0002dfb0: 2020 2020 2020 2020 2020 2062 696e 7320             bins 
+0002dfc0: 3d20 6e70 2e6c 696e 7370 6163 6528 6d61  = np.linspace(ma
+0002dfd0: 7064 6174 612e 6d69 6e28 292c 206d 6170  pdata.min(), map
+0002dfe0: 6461 7461 2e6d 6178 2829 2c20 3132 3929  data.max(), 129)
+0002dff0: 0a20 2020 2020 2020 2020 2020 2068 6973  .            his
+0002e000: 742c 2062 696e 5f65 6467 6573 203d 206e  t, bin_edges = n
+0002e010: 702e 6869 7374 6f67 7261 6d28 6d61 7064  p.histogram(mapd
+0002e020: 6174 612c 2062 696e 733d 6269 6e73 290a  ata, bins=bins).
+0002e030: 2020 2020 2020 2020 2020 2020 6d61 7073              maps
+0002e040: 697a 6520 3d20 6d61 702e 6865 6164 6572  ize = map.header
+0002e050: 2e6e 7820 2a20 6d61 702e 6865 6164 6572  .nx * map.header
+0002e060: 2e6e 7920 2a20 6d61 702e 6865 6164 6572  .ny * map.header
+0002e070: 2e6e 7a0a 2020 2020 2020 2020 2020 2020  .nz.            
+0002e080: 7072 6572 6573 756c 7420 3d20 6d61 7073  preresult = maps
+0002e090: 697a 6520 2d20 6e70 2e63 756d 7375 6d28  ize - np.cumsum(
+0002e0a0: 6869 7374 290a 2020 2020 2020 2020 2020  hist).          
+0002e0b0: 2020 6164 6465 6470 7265 203d 206e 702e    addedpre = np.
+0002e0c0: 696e 7365 7274 2870 7265 7265 7375 6c74  insert(preresult
+0002e0d0: 2c20 302c 206d 6170 7369 7a65 290a 2020  , 0, mapsize).  
+0002e0e0: 2020 2020 2020 2020 2020 2320 546f 646f            # Todo
+0002e0f0: 3a20 666f 7220 6e6f 6e2d 6f72 7468 6f67  : for non-orthog
+0002e100: 6f6e 616c 2076 6f6c 756d 6520 7468 6973  onal volume this
+0002e110: 2069 7320 6e6f 7420 7468 6520 7269 6768   is not the righ
+0002e120: 7420 666f 726d 756c 610a 2020 2020 2020  t formula.      
+0002e130: 2020 2020 2020 2320 4974 206e 6565 6473        # It needs
+0002e140: 2074 6865 2066 6f72 6d75 6c61 203a 2061   the formula : a
+0002e150: 6263 2a20 7371 7274 2831 202b 2032 2a63  bc* sqrt(1 + 2*c
+0002e160: 6f73 2861 292a 636f 7328 6229 2a62 6f73  os(a)*cos(b)*bos
+0002e170: 2863 2920 2d20 636f 7328 6129 2a2a 3220  (c) - cos(a)**2 
+0002e180: 2d20 636f 7328 6229 2a2a 3220 2d20 636f  - cos(b)**2 - co
+0002e190: 7328 6329 2a2a 3229 0a20 2020 2020 2020  s(c)**2).       
+0002e1a0: 2020 2020 2069 6620 7479 7065 2861 7069       if type(api
+0002e1b0: 7829 2069 7320 7475 706c 653a 0a20 2020  x) is tuple:.   
+0002e1c0: 2020 2020 2020 2020 2020 2020 2062 6173               bas
+0002e1d0: 6576 6f6c 756d 6520 3d20 2828 6170 6978  evolume = ((apix
+0002e1e0: 5b30 5d2a 6170 6978 5b31 5d2a 6170 6978  [0]*apix[1]*apix
+0002e1f0: 5b32 5d29 202f 2028 3130 202a 2a20 3329  [2]) / (10 ** 3)
+0002e200: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+0002e210: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0002e220: 2020 2020 6261 7365 766f 6c75 6d65 203d      basevolume =
+0002e230: 2028 2861 7069 782a 2a33 2920 2f20 2831   ((apix**3) / (1
+0002e240: 302a 2a33 2929 0a20 2020 2020 2020 2020  0**3)).         
+0002e250: 2020 2074 6d70 7265 7375 6c74 203d 2061     tmpresult = a
+0002e260: 6464 6564 7072 6520 2a20 6261 7365 766f  ddedpre * basevo
+0002e270: 6c75 6d65 0a20 2020 2020 2020 2020 2020  lume.           
+0002e280: 2069 6620 7365 6c66 2e63 6c3a 0a20 2020   if self.cl:.   
+0002e290: 2020 2020 2020 2020 2020 2020 2063 6c76               clv
+0002e2a0: 6f6c 756d 6520 3d20 286d 6170 6461 7461  olume = (mapdata
+0002e2b0: 203e 3d20 7365 6c66 2e63 6c29 2e73 756d   >= self.cl).sum
+0002e2c0: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+0002e2d0: 2020 2065 7374 766f 6c75 6d65 203d 2072     estvolume = r
+0002e2e0: 6f75 6e64 2863 6c76 6f6c 756d 6520 2a20  ound(clvolume * 
+0002e2f0: 6261 7365 766f 6c75 6d65 2c20 3229 0a20  basevolume, 2). 
+0002e300: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0002e310: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002e320: 2065 7374 766f 6c75 6d65 203d 204e 6f6e   estvolume = Non
+0002e330: 650a 0a20 2020 2020 2020 2020 2020 2069  e..            i
+0002e340: 6620 6573 7476 6f6c 756d 653a 0a20 2020  f estvolume:.   
+0002e350: 2020 2020 2020 2020 2020 2020 2064 6174               dat
+0002e360: 6164 6963 7420 3d20 7b0a 2020 2020 2020  adict = {.      
+0002e370: 2020 2020 2020 2020 2020 2020 2020 2776                'v
+0002e380: 6f6c 756d 655f 6573 7469 6d61 7465 273a  olume_estimate':
+0002e390: 207b 2776 6f6c 756d 6527 3a20 6e70 2e72   {'volume': np.r
+0002e3a0: 6f75 6e64 2874 6d70 7265 7375 6c74 2c20  ound(tmpresult, 
+0002e3b0: 3130 292e 746f 6c69 7374 2829 2c0a 2020  10).tolist(),.  
+0002e3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e3e0: 2020 2020 2020 276c 6576 656c 273a 206e        'level': n
+0002e3f0: 702e 726f 756e 6428 6269 6e73 2c20 3130  p.round(bins, 10
+0002e400: 292e 746f 6c69 7374 2829 2c0a 2020 2020  ).tolist(),.    
+0002e410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e430: 2020 2020 2765 7374 766f 6c75 6d65 273a      'estvolume':
+0002e440: 2065 7374 766f 6c75 6d65 7d7d 0a20 2020   estvolume}}.   
+0002e450: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0002e460: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0002e470: 6174 6164 6963 7420 3d20 7b0a 2020 2020  atadict = {.    
+0002e480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e490: 2776 6f6c 756d 655f 6573 7469 6d61 7465  'volume_estimate
+0002e4a0: 273a 207b 2776 6f6c 756d 6527 3a20 6e70  ': {'volume': np
+0002e4b0: 2e72 6f75 6e64 2874 6d70 7265 7375 6c74  .round(tmpresult
+0002e4c0: 2c20 3130 292e 746f 6c69 7374 2829 2c0a  , 10).tolist(),.
+0002e4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e4f0: 2020 2020 2020 2020 276c 6576 656c 273a          'level':
+0002e500: 206e 702e 726f 756e 6428 6269 6e73 2c20   np.round(bins, 
+0002e510: 3130 292e 746f 6c69 7374 2829 7d7d 0a20  10).tolist()}}. 
+0002e520: 2020 2020 2020 2065 7863 6570 743a 0a20         except:. 
+0002e530: 2020 2020 2020 2020 2020 2065 7272 203d             err =
+0002e540: 2027 566f 6c75 6d65 2065 7374 696d 6174   'Volume estimat
+0002e550: 6520 6361 6c63 756c 6174 696f 6e20 6572  e calculation er
+0002e560: 726f 723a 207b 7d2e 272e 666f 726d 6174  ror: {}.'.format
+0002e570: 2873 7973 2e65 7863 5f69 6e66 6f28 295b  (sys.exc_info()[
+0002e580: 315d 290a 2020 2020 2020 2020 2020 2020  1]).            
+0002e590: 6572 726c 6973 742e 6170 7065 6e64 2865  errlist.append(e
+0002e5a0: 7272 290a 2020 2020 2020 2020 2020 2020  rr).            
+0002e5b0: 7379 732e 7374 6465 7272 2e77 7269 7465  sys.stderr.write
+0002e5c0: 2865 7272 202b 2027 5c6e 2729 0a20 2020  (err + '\n').   
+0002e5d0: 2020 2020 2069 6620 6572 726c 6973 743a       if errlist:
+0002e5e0: 0a20 2020 2020 2020 2020 2020 2064 6174  .            dat
+0002e5f0: 6164 6963 7420 3d20 7b27 766f 6c75 6d65  adict = {'volume
+0002e600: 5f65 7374 696d 6174 6527 3a20 7b27 6572  _estimate': {'er
+0002e610: 7227 3a20 7b27 766f 6c75 6d65 5f65 7374  r': {'volume_est
+0002e620: 696d 6174 655f 6572 726f 7227 3a20 6572  imate_error': er
+0002e630: 726c 6973 747d 7d7d 0a20 2020 2020 2020  rlist}}}.       
+0002e640: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+0002e650: 2020 7769 7468 2063 6f64 6563 732e 6f70    with codecs.op
+0002e660: 656e 2873 656c 662e 776f 726b 6469 7220  en(self.workdir 
+0002e670: 2b20 7365 6c66 2e6d 6170 6e61 6d65 202b  + self.mapname +
+0002e680: 2027 5f76 6f6c 756d 655f 636f 6e74 6f75   '_volume_contou
+0002e690: 722e 6a73 6f6e 272c 2027 7727 2c0a 2020  r.json', 'w',.  
+0002e6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e6b0: 2020 2020 2020 2020 2020 2065 6e63 6f64             encod
+0002e6c0: 696e 673d 2775 7466 2d38 2729 2061 7320  ing='utf-8') as 
+0002e6d0: 663a 0a20 2020 2020 2020 2020 2020 2020  f:.             
+0002e6e0: 2020 206a 736f 6e2e 6475 6d70 2864 6174     json.dump(dat
+0002e6f0: 6164 6963 742c 2066 290a 2020 2020 2020  adict, f).      
+0002e700: 2020 6578 6365 7074 3a0a 2020 2020 2020    except:.      
+0002e710: 2020 2020 2020 7379 732e 7374 6465 7272        sys.stderr
+0002e720: 2e77 7269 7465 2827 5361 7669 6e67 2076  .write('Saving v
+0002e730: 6f6c 756d 6520 6573 7469 6d61 7465 2074  olume estimate t
+0002e740: 6f20 6a73 6f6e 2065 7272 6f72 3a7b 7d2e  o json error:{}.
+0002e750: 5c6e 272e 666f 726d 6174 2873 7973 2e65  \n'.format(sys.e
+0002e760: 7863 5f69 6e66 6f28 295b 315d 2929 0a0a  xc_info()[1]))..
+0002e770: 2020 2020 2020 2020 656e 6420 3d20 7469          end = ti
+0002e780: 6d65 6974 2e64 6566 6175 6c74 5f74 696d  meit.default_tim
+0002e790: 6572 2829 0a20 2020 2020 2020 2070 7269  er().        pri
+0002e7a0: 6e74 2827 566f 6c75 6d65 2063 6f6e 746f  nt('Volume conto
+0002e7b0: 7572 2074 696d 653a 2025 7327 2025 2028  ur time: %s' % (
+0002e7c0: 656e 6420 2d20 7374 6172 7429 290a 2020  end - start)).  
+0002e7d0: 2020 2020 2020 7072 696e 7428 272d 2d2d        print('---
+0002e7e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0002e7f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0002e800: 2d27 290a 0a20 2020 2020 2020 2072 6574  -')..        ret
+0002e810: 7572 6e20 4e6f 6e65 0a0a 0a0a 0a0a 2020  urn None......  
+0002e820: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
+0002e830: 2323 2323 2320 7465 7374 0a0a 2020 2020  ##### test..    
+0002e840: 2320 6465 6620 7073 7375 6d28 7365 6c66  # def pssum(self
+0002e850: 2c69 2c20 6469 7374 2c20 696e 6469 6178  ,i, dist, indiax
+0002e860: 6973 293a 0a20 2020 2023 2020 2020 2069  is):.    #     i
+0002e870: 6620 6920 213d 206c 656e 2869 6e64 6961  f i != len(india
+0002e880: 7869 7329 202d 2031 3a0a 2020 2020 2320  xis) - 1:.    # 
+0002e890: 2020 2020 2020 2020 696e 6469 6365 7320          indices 
+0002e8a0: 3d20 6e70 2e61 7267 7768 6572 6528 2864  = np.argwhere((d
+0002e8b0: 6973 7420 3e20 696e 6469 6178 6973 745b  ist > indiaxist[
+0002e8c0: 695d 2920 2620 2864 6973 7420 3c3d 2069  i]) & (dist <= i
+0002e8d0: 6e64 6961 7869 7374 5b69 202b 2031 5d29  ndiaxist[i + 1])
+0002e8e0: 290a 2020 2020 2320 2020 2020 2020 2020  ).    #         
+0002e8f0: 7073 756d 203d 206c 6f67 3130 2870 736d  psum = log10(psm
+0002e900: 6170 2e66 756c 6c4d 6170 5b74 7570 6c65  ap.fullMap[tuple
+0002e910: 2869 6e64 6963 6573 2e54 295d 2e73 756d  (indices.T)].sum
+0002e920: 2829 202f 206c 656e 2869 6e64 6963 6573  () / len(indices
+0002e930: 2929 0a20 2020 2023 2020 2020 2020 2020  )).    #        
+0002e940: 2072 6574 7572 6e20 7073 756d 0a0a 2020   return psum..  
+0002e950: 2020 2320 6465 6620 7073 7375 6d28 7365    # def pssum(se
+0002e960: 6c66 2c69 6e64 6963 6573 293a 0a20 2020  lf,indices):.   
+0002e970: 2023 2020 2020 2023 2069 6620 6920 213d   #     # if i !=
+0002e980: 206c 656e 2869 6e64 6961 7869 7329 202d   len(indiaxis) -
+0002e990: 2031 3a0a 2020 2020 2320 2020 2020 2320   1:.    #     # 
+0002e9a0: 696e 6469 6365 7320 3d20 6e70 2e61 7267  indices = np.arg
+0002e9b0: 7768 6572 6528 2864 6973 7420 3e20 696e  where((dist > in
+0002e9c0: 6469 6178 6973 745b 695d 2920 2620 2864  diaxist[i]) & (d
+0002e9d0: 6973 7420 3c3d 2069 6e64 6961 7869 7374  ist <= indiaxist
+0002e9e0: 5b69 202b 2031 5d29 290a 2020 2020 2320  [i + 1])).    # 
+0002e9f0: 2020 2020 7073 756d 203d 206c 6f67 3130      psum = log10
+0002ea00: 2870 736d 6170 2e66 756c 6c4d 6170 5b74  (psmap.fullMap[t
+0002ea10: 7570 6c65 2869 6e64 6963 6573 2e54 295d  uple(indices.T)]
+0002ea20: 2e73 756d 2829 202f 206c 656e 2869 6e64  .sum() / len(ind
+0002ea30: 6963 6573 2929 0a20 2020 2023 2020 2020  ices)).    #    
+0002ea40: 2072 6574 7572 6e20 7073 756d 0a0a 0a20   return psum... 
+0002ea50: 2020 2064 6566 2070 6172 6172 6170 7328     def pararaps(
+0002ea60: 7365 6c66 293a 0a20 2020 2020 2020 2022  self):.        "
+0002ea70: 2222 0a0a 2020 2020 2020 2020 2020 2020  ""..            
+0002ea80: 4361 6c63 756c 6174 696f 6e20 6f66 2074  Calculation of t
+0002ea90: 6865 2072 6f74 6174 696f 6e61 6c6c 7920  he rotationally 
+0002eaa0: 6176 6572 6167 6520 706f 7765 7220 7370  average power sp
+0002eab0: 6563 7472 756d 2028 5241 5053 290a 2020  ectrum (RAPS).  
+0002eac0: 2020 2020 2020 2020 2020 5265 7375 6c74            Result
+0002ead0: 7320 7772 6f74 6520 746f 204a 534f 4e20  s wrote to JSON 
+0002eae0: 6669 6c65 0a0a 2020 2020 2020 2020 3a72  file..        :r
+0002eaf0: 6574 7572 6e3a 204e 6f6e 650a 0a20 2020  eturn: None..   
+0002eb00: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0002eb10: 2069 6d70 6f72 7420 6d75 6c74 6970 726f   import multipro
+0002eb20: 6365 7373 696e 6720 6173 206d 700a 2020  cessing as mp.  
+0002eb30: 2020 2020 2020 696d 706f 7274 2069 7465        import ite
+0002eb40: 7274 6f6f 6c73 0a20 2020 2020 2020 2074  rtools.        t
+0002eb50: 6872 6561 6463 6f75 6e74 203d 2032 0a20  hreadcount = 2. 
+0002eb60: 2020 2020 2020 2070 6f6f 6c20 3d20 6d70         pool = mp
+0002eb70: 2e50 6f6f 6c28 7468 7265 6164 636f 756e  .Pool(threadcoun
+0002eb80: 7429 0a0a 2020 2020 2020 2020 6966 2073  t)..        if s
+0002eb90: 656c 662e 6d61 702e 785f 7369 7a65 2829  elf.map.x_size()
+0002eba0: 203d 3d20 7365 6c66 2e6d 6170 2e79 5f73   == self.map.y_s
+0002ebb0: 697a 6528 2920 3d3d 2073 656c 662e 6d61  ize() == self.ma
+0002ebc0: 702e 7a5f 7369 7a65 2829 3a0a 2020 2020  p.z_size():.    
+0002ebd0: 2020 2020 2020 2020 6572 726c 6973 7420          errlist 
+0002ebe0: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
+0002ebf0: 2073 7461 7274 203d 2074 696d 6569 742e   start = timeit.
+0002ec00: 6465 6661 756c 745f 7469 6d65 7228 290a  default_timer().
+0002ec10: 2020 2020 2020 2020 2020 2020 6d61 7020              map 
+0002ec20: 3d20 7365 6c66 2e6d 6170 0a20 2020 2020  = self.map.     
+0002ec30: 2020 2020 2020 2061 7069 7820 3d20 6d61         apix = ma
+0002ec40: 702e 6170 6978 0a20 2020 2020 2020 2020  p.apix.         
+0002ec50: 2020 2066 6674 6d61 7020 3d20 6d61 702e     fftmap = map.
+0002ec60: 666f 7572 6965 725f 7472 616e 7366 6f72  fourier_transfor
+0002ec70: 6d28 290a 2020 2020 2020 2020 2020 2020  m().            
+0002ec80: 7073 6d61 7020 3d20 6666 746d 6170 2e63  psmap = fftmap.c
+0002ec90: 6f70 7928 290a 2020 2020 2020 2020 2020  opy().          
+0002eca0: 2020 7073 6d65 616e 203d 206e 702e 6d65    psmean = np.me
+0002ecb0: 616e 2870 736d 6170 2e66 756c 6c4d 6170  an(psmap.fullMap
+0002ecc0: 290a 2020 2020 2020 2020 2020 2020 7073  ).            ps
+0002ecd0: 7374 6420 3d20 6e70 2e73 7464 2870 736d  std = np.std(psm
+0002ece0: 6170 2e66 756c 6c4d 6170 290a 2020 2020  ap.fullMap).    
+0002ecf0: 2020 2020 2020 2020 7073 6d61 702e 6675          psmap.fu
+0002ed00: 6c6c 4d61 7020 3d20 6e70 2e61 6273 2828  llMap = np.abs((
+0002ed10: 7073 6d61 702e 6675 6c6c 4d61 7020 2d20  psmap.fullMap - 
+0002ed20: 7073 6d65 616e 2920 2f20 7073 7374 6429  psmean) / psstd)
+0002ed30: 202a 2a20 320a 0a20 2020 2020 2020 2020   ** 2..         
+0002ed40: 2020 206d 6964 7374 6172 7420 3d20 7469     midstart = ti
+0002ed50: 6d65 6974 2e64 6566 6175 6c74 5f74 696d  meit.default_tim
+0002ed60: 6572 2829 202d 2073 7461 7274 0a20 2020  er() - start.   
+0002ed70: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
+0002ed80: 202d 2d20 5241 5053 2046 6f75 7269 6572   -- RAPS Fourier
+0002ed90: 2d74 7261 6e73 666f 726d 6174 696f 6e20  -transformation 
+0002eda0: 7469 6d65 3a20 2573 2720 2520 6d69 6473  time: %s' % mids
+0002edb0: 7461 7274 290a 0a20 2020 2020 2020 2020  tart)..         
+0002edc0: 2020 207a 6772 6964 203d 206e 702e 6172     zgrid = np.ar
+0002edd0: 616e 6765 2866 6c6f 6f72 2870 736d 6170  ange(floor(psmap
+0002ede0: 2e7a 5f73 697a 6528 2920 2f20 322e 3029  .z_size() / 2.0)
+0002edf0: 202a 202d 312c 2063 6569 6c28 7073 6d61   * -1, ceil(psma
+0002ee00: 702e 7a5f 7369 7a65 2829 202f 2032 2e30  p.z_size() / 2.0
+0002ee10: 2929 202f 2066 6c6f 6174 2866 6c6f 6f72  )) / float(floor
+0002ee20: 2870 736d 6170 2e7a 5f73 697a 6528 2929  (psmap.z_size())
+0002ee30: 290a 2020 2020 2020 2020 2020 2020 7967  ).            yg
+0002ee40: 7269 6420 3d20 6e70 2e61 7261 6e67 6528  rid = np.arange(
+0002ee50: 666c 6f6f 7228 7073 6d61 702e 795f 7369  floor(psmap.y_si
+0002ee60: 7a65 2829 202f 2032 2e30 2920 2a20 2d31  ze() / 2.0) * -1
+0002ee70: 2c20 6365 696c 2870 736d 6170 2e79 5f73  , ceil(psmap.y_s
+0002ee80: 697a 6528 2920 2f20 322e 3029 2920 2f20  ize() / 2.0)) / 
+0002ee90: 666c 6f61 7428 666c 6f6f 7228 7073 6d61  float(floor(psma
+0002eea0: 702e 795f 7369 7a65 2829 2929 0a20 2020  p.y_size())).   
+0002eeb0: 2020 2020 2020 2020 2078 6772 6964 203d           xgrid =
+0002eec0: 206e 702e 6172 616e 6765 2866 6c6f 6f72   np.arange(floor
+0002eed0: 2870 736d 6170 2e78 5f73 697a 6528 2920  (psmap.x_size() 
+0002eee0: 2f20 322e 3029 202a 202d 312c 2063 6569  / 2.0) * -1, cei
+0002eef0: 6c28 7073 6d61 702e 785f 7369 7a65 2829  l(psmap.x_size()
+0002ef00: 202f 2032 2e30 2929 202f 2066 6c6f 6174   / 2.0)) / float
+0002ef10: 2866 6c6f 6f72 2870 736d 6170 2e78 5f73  (floor(psmap.x_s
+0002ef20: 697a 6528 2929 290a 2020 2020 2020 2020  ize())).        
+0002ef30: 2020 2020 7864 6973 203d 2078 6772 6964      xdis = xgrid
+0002ef40: 202a 2a20 320a 2020 2020 2020 2020 2020   ** 2.          
+0002ef50: 2020 7964 6973 203d 2079 6772 6964 202a    ydis = ygrid *
+0002ef60: 2a20 320a 2020 2020 2020 2020 2020 2020  * 2.            
+0002ef70: 7a64 6973 203d 207a 6772 6964 202a 2a20  zdis = zgrid ** 
+0002ef80: 320a 2020 2020 2020 2020 2020 2020 6469  2.            di
+0002ef90: 7374 203d 206e 702e 7371 7274 287a 6469  st = np.sqrt(zdi
+0002efa0: 735b 3a2c 204e 6f6e 652c 204e 6f6e 655d  s[:, None, None]
+0002efb0: 202b 2079 6469 735b 3a2c 204e 6f6e 655d   + ydis[:, None]
+0002efc0: 202b 2078 6469 7329 0a0a 2020 2020 2020   + xdis)..      
+0002efd0: 2020 2020 2020 616c 6c61 7869 7320 3d20        allaxis = 
+0002efe0: 5b7a 6772 6964 2c20 7967 7269 642c 2078  [zgrid, ygrid, x
+0002eff0: 6772 6964 5d0a 2020 2020 2020 2020 2020  grid].          
+0002f000: 2020 746d 7069 6e64 6961 7869 7320 3d20    tmpindiaxis = 
+0002f010: 6d61 7828 616c 6c61 7869 732c 206b 6579  max(allaxis, key
+0002f020: 3d6c 656e 290a 2020 2020 2020 2020 2020  =len).          
+0002f030: 2020 696e 6469 6178 6973 7420 3d20 746d    indiaxist = tm
+0002f040: 7069 6e64 6961 7869 735b 746d 7069 6e64  pindiaxis[tmpind
+0002f050: 6961 7869 7320 3e3d 2030 5d0a 2020 2020  iaxis >= 0].    
+0002f060: 2020 2020 2020 2020 696e 6469 6178 6973          indiaxis
+0002f070: 203d 206e 702e 6c69 6e73 7061 6365 2830   = np.linspace(0
+0002f080: 2c20 3120 2f20 2832 202a 2061 7069 7829  , 1 / (2 * apix)
+0002f090: 2c20 6c65 6e28 696e 6469 6178 6973 7429  , len(indiaxist)
+0002f0a0: 290a 2020 2020 2020 2020 2020 2020 7072  ).            pr
+0002f0b0: 696e 7428 2764 6973 743a 2729 0a20 2020  int('dist:').   
+0002f0c0: 2020 2020 2020 2020 2070 7269 6e74 2861           print(a
+0002f0d0: 6c6c 6178 6973 290a 2020 2020 2020 2020  llaxis).        
+0002f0e0: 2020 2020 7072 696e 7428 6469 7374 2e73      print(dist.s
+0002f0f0: 6861 7065 290a 2020 2020 2020 2020 2020  hape).          
+0002f100: 2020 7072 696e 7428 696e 6469 6178 6973    print(indiaxis
+0002f110: 290a 2020 2020 2020 2020 2020 2020 7072  ).            pr
+0002f120: 696e 7428 7073 6d61 702e 7a5f 7369 7a65  int(psmap.z_size
+0002f130: 2829 290a 2020 2020 2020 2020 2020 2020  ()).            
+0002f140: 7072 696e 7428 272d 2d2d 2d2d 2d2d 2729  print('-------')
+0002f150: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
+0002f160: 6e74 2864 6973 745b 3938 2c39 362c 3936  nt(dist[98,96,96
+0002f170: 5d29 0a0a 0a20 2020 2020 2020 2020 2020  ])...           
+0002f180: 2061 7073 203d 205b 5d0a 2020 2020 2020   aps = [].      
+0002f190: 2020 2020 2020 2320 666f 7220 6920 696e        # for i in
+0002f1a0: 2072 616e 6765 286c 656e 2869 6e64 6961   range(len(india
+0002f1b0: 7869 7329 293a 0a20 2020 2020 2020 2020  xis)):.         
+0002f1c0: 2020 2023 2020 2020 2069 6620 6920 213d     #     if i !=
+0002f1d0: 206c 656e 2869 6e64 6961 7869 7329 202d   len(indiaxis) -
+0002f1e0: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
+0002f1f0: 2320 2020 2020 2020 2020 696e 6469 6365  #         indice
+0002f200: 7320 3d20 6e70 2e61 7267 7768 6572 6528  s = np.argwhere(
+0002f210: 2864 6973 7420 3e20 696e 6469 6178 6973  (dist > indiaxis
+0002f220: 745b 695d 2920 2620 2864 6973 7420 3c3d  t[i]) & (dist <=
+0002f230: 2069 6e64 6961 7869 7374 5b69 202b 2031   indiaxist[i + 1
+0002f240: 5d29 290a 2020 2020 2020 2020 2020 2020  ])).            
+0002f250: 2320 2020 2020 2020 2020 7073 756d 203d  #         psum =
+0002f260: 206c 6f67 3130 2870 736d 6170 2e66 756c   log10(psmap.ful
+0002f270: 6c4d 6170 5b74 7570 6c65 2869 6e64 6963  lMap[tuple(indic
+0002f280: 6573 2e54 295d 2e73 756d 2829 202f 206c  es.T)].sum() / l
+0002f290: 656e 2869 6e64 6963 6573 2929 0a20 2020  en(indices)).   
+0002f2a0: 2020 2020 2020 2020 2023 2020 2020 2020           #      
+0002f2b0: 2020 2061 7073 2e61 7070 656e 6428 7073     aps.append(ps
+0002f2c0: 756d 290a 0a20 2020 2020 2020 2020 2020  um)..           
+0002f2d0: 2061 6c6c 696e 6469 6365 7320 3d20 5b5d   allindices = []
+0002f2e0: 0a20 2020 2020 2020 2020 2020 2061 6c6c  .            all
+0002f2f0: 7073 6d61 7020 3d20 5b5d 0a20 2020 2020  psmap = [].     
+0002f300: 2020 2020 2020 2023 2066 6f72 2069 2069         # for i i
+0002f310: 6e20 7261 6e67 6528 6c65 6e28 696e 6469  n range(len(indi
+0002f320: 6178 6973 2929 3a0a 2020 2020 2020 2020  axis)):.        
+0002f330: 2020 2020 2320 2020 2020 6966 2069 2021      #     if i !
+0002f340: 3d20 6c65 6e28 696e 6469 6178 6973 2920  = len(indiaxis) 
+0002f350: 2d31 3a0a 2020 2020 2020 2020 2020 2020  -1:.            
+0002f360: 2320 2020 2020 2020 2020 696e 6469 6365  #         indice
+0002f370: 7320 3d20 6e70 2e61 7267 7768 6572 6528  s = np.argwhere(
+0002f380: 2864 6973 7420 3e20 696e 6469 6178 6973  (dist > indiaxis
+0002f390: 745b 695d 2920 2620 2864 6973 7420 3c3d  t[i]) & (dist <=
+0002f3a0: 2069 6e64 6961 7869 7374 5b69 202b 2031   indiaxist[i + 1
+0002f3b0: 5d29 290a 2020 2020 2020 2020 2020 2020  ])).            
+0002f3c0: 230a 2020 2020 2020 2020 2020 2020 2320  #.            # 
+0002f3d0: 2020 2020 2020 2020 7073 756d 203d 2070          psum = p
+0002f3e0: 736d 6170 2e66 756c 6c4d 6170 5b74 7570  smap.fullMap[tup
+0002f3f0: 6c65 2869 6e64 6963 6573 2e54 295d 2e73  le(indices.T)].s
+0002f400: 756d 2829 0a20 2020 2020 2020 2020 2020  um().           
+0002f410: 2023 2020 2020 2020 2020 2061 6c6c 696e   #         allin
+0002f420: 6469 6365 732e 6170 7065 6e64 2869 6e64  dices.append(ind
+0002f430: 6963 6573 290a 2020 2020 2020 2020 2020  ices).          
+0002f440: 2020 2320 2020 2020 2020 2020 616c 6c70    #         allp
+0002f450: 736d 6170 2e61 7070 656e 6428 7073 756d  smap.append(psum
+0002f460: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
+0002f470: 7072 696e 7428 616c 6c69 6e64 6963 6573  print(allindices
+0002f480: 290a 2020 2020 2020 2020 2020 2020 6f64  ).            od
+0002f490: 6420 3d20 5b5d 0a20 2020 2020 2020 2020  d = [].         
+0002f4a0: 2020 2065 7665 6e20 3d5b 5d0a 2020 2020     even =[].    
+0002f4b0: 2020 2020 2020 2020 636f 756e 7465 7220          counter 
+0002f4c0: 3d20 300a 2020 2020 2020 2020 2020 2020  = 0.            
+0002f4d0: 726c 6973 7420 3d20 5b5d 0a20 2020 2020  rlist = [].     
+0002f4e0: 2020 2020 2020 2074 656d 706c 6973 7420         templist 
+0002f4f0: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
+0002f500: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
+0002f510: 6c65 6e28 696e 6469 6178 6973 292d 3129  len(indiaxis)-1)
+0002f520: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002f530: 2020 636f 756e 7465 7220 2b3d 2031 0a20    counter += 1. 
+0002f540: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0002f550: 6620 6920 3d3d 2030 3a0a 2020 2020 2020  f i == 0:.      
+0002f560: 2020 2020 2020 2020 2020 2020 2020 7465                te
+0002f570: 6d70 6c69 7374 2e61 7070 656e 6428 6929  mplist.append(i)
+0002f580: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002f590: 2065 6c69 6620 6920 2520 3430 203d 3d20   elif i % 40 == 
+0002f5a0: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+0002f5b0: 2020 2020 2020 2072 6c69 7374 2e61 7070         rlist.app
+0002f5c0: 656e 6428 7465 6d70 6c69 7374 290a 2020  end(templist).  
+0002f5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f5e0: 2020 7465 6d70 6c69 7374 203d 205b 5d0a    templist = [].
+0002f5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f600: 2020 2020 7465 6d70 6c69 7374 2e61 7070      templist.app
+0002f610: 656e 6428 6929 0a20 2020 2020 2020 2020  end(i).         
+0002f620: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0002f630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f640: 2074 656d 706c 6973 742e 6170 7065 6e64   templist.append
+0002f650: 2869 290a 0a20 2020 2020 2020 2020 2020  (i)..           
+0002f660: 2072 6c69 7374 2e61 7070 656e 6428 7465   rlist.append(te
+0002f670: 6d70 6c69 7374 290a 0a20 2020 2020 2020  mplist)..       
+0002f680: 2020 2020 2064 6566 2073 706c 6974 5f6c       def split_l
+0002f690: 6973 7428 696e 705f 6c69 7374 2c20 6e72  ist(inp_list, nr
+0002f6a0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0002f6b0: 2020 2022 2222 0a20 2020 2020 2020 2020     """.         
+0002f6c0: 2020 2020 2020 2053 706c 6974 7320 6576         Splits ev
+0002f6d0: 656e 6c79 2061 206c 6973 740a 2020 2020  enly a list.    
+0002f6e0: 2020 2020 2020 2020 2020 2020 3a70 6172              :par
+0002f6f0: 616d 2069 6e70 5f6c 6973 743a 206c 6973  am inp_list: lis
+0002f700: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
+0002f710: 2020 3a70 6172 616d 206e 723a 206e 756d    :param nr: num
+0002f720: 6265 7220 6f66 2070 6172 7473 0a20 2020  ber of parts.   
+0002f730: 2020 2020 2020 2020 2020 2020 203a 7265               :re
+0002f740: 7475 726e 3a20 6c69 7374 206f 6620 226e  turn: list of "n
+0002f750: 7222 206c 6973 7473 0a20 2020 2020 2020  r" lists.       
+0002f760: 2020 2020 2020 2020 2022 2222 0a20 2020           """.   
+0002f770: 2020 2020 2020 2020 2020 2020 206e 6577               new
+0002f780: 5f6c 6973 7420 3d20 5b5d 0a20 2020 2020  _list = [].     
+0002f790: 2020 2020 2020 2020 2020 206e 725f 656c             nr_el
+0002f7a0: 203d 2031 2e30 202f 206e 7220 2a20 6c65   = 1.0 / nr * le
+0002f7b0: 6e28 696e 705f 6c69 7374 290a 2020 2020  n(inp_list).    
+0002f7c0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0002f7d0: 6920 696e 2072 616e 6765 286e 7229 3a0a  i in range(nr):.
+0002f7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f7f0: 2020 2020 7374 6172 7420 3d20 696e 7428      start = int(
+0002f800: 726f 756e 6428 6920 2a20 6e72 5f65 6c29  round(i * nr_el)
+0002f810: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0002f820: 2020 2020 2020 656e 6420 3d20 696e 7428        end = int(
+0002f830: 726f 756e 6428 2869 202b 2031 2920 2a20  round((i + 1) * 
+0002f840: 6e72 5f65 6c29 290a 2020 2020 2020 2020  nr_el)).        
+0002f850: 2020 2020 2020 2020 2020 2020 6e65 775f              new_
+0002f860: 6c69 7374 2e61 7070 656e 6428 696e 705f  list.append(inp_
+0002f870: 6c69 7374 5b73 7461 7274 3a65 6e64 5d29  list[start:end])
+0002f880: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002f890: 2072 6574 7572 6e20 6e65 775f 6c69 7374   return new_list
+0002f8a0: 0a20 2020 2020 2020 2020 2020 2069 6e70  .            inp
+0002f8b0: 7574 6c69 7374 203d 2072 616e 6765 2830  utlist = range(0
+0002f8c0: 2c20 6c65 6e28 696e 6469 6178 6973 292d  , len(indiaxis)-
+0002f8d0: 3129 0a20 2020 2020 2020 2020 2020 2072  1).            r
+0002f8e0: 6c69 7374 203d 2073 706c 6974 5f6c 6973  list = split_lis
+0002f8f0: 7428 696e 7075 746c 6973 742c 2074 6872  t(inputlist, thr
+0002f900: 6561 6463 6f75 6e74 290a 0a20 2020 2020  eadcount)..     
+0002f910: 2020 2020 2020 2023 2054 7279 2077 6974         # Try wit
+0002f920: 6820 7368 6172 6564 206f 626a 6563 740a  h shared object.
+0002f930: 2020 2020 2020 2020 2020 2020 696d 706f              impo
+0002f940: 7274 206d 756c 7469 7072 6f63 6573 7369  rt multiprocessi
+0002f950: 6e67 0a20 2020 2020 2020 2020 2020 2069  ng.            i
+0002f960: 6d70 6f72 7420 6374 7970 6573 0a20 2020  mport ctypes.   
+0002f970: 2020 2020 2020 2020 2078 2c20 792c 207a           x, y, z
+0002f980: 203d 2064 6973 742e 7368 6170 650a 0a20   = dist.shape.. 
+0002f990: 2020 2020 2020 2020 2020 2073 6861 7265             share
+0002f9a0: 645f 6172 7261 795f 6261 7365 203d 206d  d_array_base = m
+0002f9b0: 756c 7469 7072 6f63 6573 7369 6e67 2e41  ultiprocessing.A
+0002f9c0: 7272 6179 2863 7479 7065 732e 635f 646f  rray(ctypes.c_do
+0002f9d0: 7562 6c65 2c20 782a 792a 7a29 0a20 2020  uble, x*y*z).   
+0002f9e0: 2020 2020 2020 2020 2023 2073 6861 7265           # share
+0002f9f0: 645f 6172 7261 7920 3d20 6e70 2e63 7479  d_array = np.cty
+0002fa00: 7065 736c 6962 2e61 735f 6172 7261 7928  peslib.as_array(
+0002fa10: 7368 6172 6564 5f61 7272 6179 5f62 6173  shared_array_bas
+0002fa20: 652e 6765 745f 6f62 6a28 2929 0a20 2020  e.get_obj()).   
+0002fa30: 2020 2020 2020 2020 2073 6861 7265 645f           shared_
+0002fa40: 6172 7261 7920 3d20 6e70 2e66 726f 6d62  array = np.fromb
+0002fa50: 7566 6665 7228 7368 6172 6564 5f61 7272  uffer(shared_arr
+0002fa60: 6179 5f62 6173 652e 6765 745f 6f62 6a28  ay_base.get_obj(
+0002fa70: 2929 0a20 2020 2020 2020 2020 2020 2073  )).            s
+0002fa80: 6861 7265 645f 6172 7261 7920 3d20 7368  hared_array = sh
+0002fa90: 6172 6564 5f61 7272 6179 2e72 6573 6861  ared_array.resha
+0002faa0: 7065 2864 6973 742e 7368 6170 6529 0a0a  pe(dist.shape)..
+0002fab0: 0a0a 2020 2020 2020 2020 2020 2020 7368  ..            sh
+0002fac0: 6172 6564 5f61 7272 6179 5b3a 5d20 3d20  ared_array[:] = 
+0002fad0: 6469 7374 5b3a 5d0a 2020 2020 2020 2020  dist[:].        
+0002fae0: 2020 2020 2320 6170 7320 3d20 5b70 6f6f      # aps = [poo
+0002faf0: 6c2e 6170 706c 7928 7063 616c 2c20 6172  l.apply(pcal, ar
+0002fb00: 6773 3d28 692c 2061 6c6c 696e 6469 6365  gs=(i, allindice
+0002fb10: 732c 2061 6c6c 7073 6d61 7029 2920 666f  s, allpsmap)) fo
+0002fb20: 7220 6920 696e 2072 6c69 7374 5d0a 2020  r i in rlist].  
+0002fb30: 2020 2020 2020 2020 2020 6170 7320 3d20            aps = 
+0002fb40: 5b70 6f6f 6c2e 6170 706c 7928 7073 7375  [pool.apply(pssu
+0002fb50: 6d2c 2061 7267 733d 2869 2c20 696e 6469  m, args=(i, indi
+0002fb60: 6178 6973 2c20 696e 6469 6178 6973 742c  axis, indiaxist,
+0002fb70: 2073 6861 7265 645f 6172 7261 7929 2920   shared_array)) 
+0002fb80: 666f 7220 6920 696e 2072 6c69 7374 5d0a  for i in rlist].
+0002fb90: 2020 2020 2020 2020 2020 2020 2320 6170              # ap
+0002fba0: 7320 3d20 6170 735b 3a2d 315d 0a20 2020  s = aps[:-1].   
+0002fbb0: 2020 2020 2020 2020 2023 2061 7073 203d           # aps =
+0002fbc0: 2070 6f6f 6c2e 6d61 7028 7365 6c66 2e70   pool.map(self.p
+0002fbd0: 7373 756d 2c20 5b20 6920 666f 7220 6920  ssum, [ i for i 
+0002fbe0: 696e 2061 6c6c 696e 6469 6365 735d 290a  in allindices]).
+0002fbf0: 2020 2020 2020 2020 2020 2020 6e65 7761              newa
+0002fc00: 7073 203d 206c 6973 7428 6974 6572 746f  ps = list(iterto
+0002fc10: 6f6c 732e 6368 6169 6e2e 6672 6f6d 5f69  ols.chain.from_i
+0002fc20: 7465 7261 626c 6528 6170 7329 290a 2020  terable(aps)).  
+0002fc30: 2020 2020 2020 2020 2020 2320 7072 696e            # prin
+0002fc40: 7428 6c65 6e28 6e65 7761 7073 2929 0a0a  t(len(newaps))..
+0002fc50: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0002fc60: 6920 696e 2072 616e 6765 286c 656e 2869  i in range(len(i
+0002fc70: 6e64 6961 7869 7329 2d31 293a 0a20 2020  ndiaxis)-1):.   
+0002fc80: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0002fc90: 6920 213d 206c 656e 2869 6e64 6961 7869  i != len(indiaxi
+0002fca0: 7329 202d 313a 0a20 2020 2020 2020 2020  s) -1:.         
+0002fcb0: 2020 2020 2020 2020 2020 2070 7375 6d20             psum 
+0002fcc0: 3d20 6c6f 6731 3028 7073 6d61 702e 6675  = log10(psmap.fu
+0002fcd0: 6c6c 4d61 705b 7475 706c 6528 6e65 7761  llMap[tuple(newa
+0002fce0: 7073 5b69 5d2e 5429 5d2e 7375 6d28 2920  ps[i].T)].sum() 
+0002fcf0: 2f20 6c65 6e28 6e65 7761 7073 5b69 5d29  / len(newaps[i])
+0002fd00: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0002fd10: 2020 2020 2020 616c 6c70 736d 6170 2e61        allpsmap.a
+0002fd20: 7070 656e 6428 7073 756d 290a 0a20 2020  ppend(psum)..   
+0002fd30: 2020 2020 2020 2020 2070 7269 6e74 2861           print(a
+0002fd40: 6c6c 7073 6d61 7029 0a0a 2020 2020 2020  llpsmap)..      
+0002fd50: 2020 2020 2020 2323 2323 2323 2323 2323        ##########
+0002fd60: 2323 2323 2323 2323 0a0a 2020 2020 2020  ########..      
+0002fd70: 2020 2020 2020 6461 7461 6469 6374 203d        datadict =
+0002fd80: 207b 2772 6f74 6174 696f 6e61 6c6c 795f   {'rotationally_
+0002fd90: 6176 6572 6167 6564 5f70 6f77 6572 5f73  averaged_power_s
+0002fda0: 7065 6374 7275 6d27 3a20 7b27 7927 3a20  pectrum': {'y': 
+0002fdb0: 6e70 2e72 6f75 6e64 2861 6c6c 7073 6d61  np.round(allpsma
+0002fdc0: 702c 2034 292e 746f 6c69 7374 2829 2c0a  p, 4).tolist(),.
 0002fdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002fde0: 2023 2079 6772 6964 203d 206e 702e 6172   # ygrid = np.ar
-0002fdf0: 616e 6765 2866 6c6f 6f72 2870 736d 6170  ange(floor(psmap
-0002fe00: 2e79 5f73 697a 6528 2920 2f20 322e 3029  .y_size() / 2.0)
-0002fe10: 202a 202d 312c 2063 6569 6c28 7073 6d61   * -1, ceil(psma
-0002fe20: 702e 795f 7369 7a65 2829 202f 2032 2e30  p.y_size() / 2.0
-0002fe30: 2929 202f 2066 6c6f 6174 2866 6c6f 6f72  )) / float(floor
-0002fe40: 2870 736d 6170 2e79 5f73 697a 6528 2929  (psmap.y_size())
-0002fe50: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0002fe60: 2020 2020 2020 2320 7867 7269 6420 3d20        # xgrid = 
-0002fe70: 6e70 2e61 7261 6e67 6528 666c 6f6f 7228  np.arange(floor(
-0002fe80: 7073 6d61 702e 785f 7369 7a65 2829 202f  psmap.x_size() /
-0002fe90: 2032 2e30 2920 2a20 2d31 2c20 6365 696c   2.0) * -1, ceil
-0002fea0: 2870 736d 6170 2e78 5f73 697a 6528 2920  (psmap.x_size() 
-0002feb0: 2f20 322e 3029 2920 2f20 666c 6f61 7428  / 2.0)) / float(
-0002fec0: 666c 6f6f 7228 7073 6d61 702e 785f 7369  floor(psmap.x_si
-0002fed0: 7a65 2829 2929 0a20 2020 2020 2020 2020  ze())).         
-0002fee0: 2020 2020 2020 2020 2020 207a 6772 6964             zgrid
-0002fef0: 203d 206e 702e 6172 616e 6765 2866 6c6f   = np.arange(flo
-0002ff00: 6f72 286d 6170 5f7a 7369 7a65 202f 2032  or(map_zsize / 2
-0002ff10: 2e30 2920 2a20 2d31 2c20 6365 696c 286d  .0) * -1, ceil(m
-0002ff20: 6170 5f7a 7369 7a65 202f 2032 2e30 2929  ap_zsize / 2.0))
-0002ff30: 202f 2066 6c6f 6174 2866 6c6f 6f72 286d   / float(floor(m
-0002ff40: 6170 5f7a 7369 7a65 2929 0a20 2020 2020  ap_zsize)).     
-0002ff50: 2020 2020 2020 2020 2020 2020 2020 2079                 y
-0002ff60: 6772 6964 203d 206e 702e 6172 616e 6765  grid = np.arange
-0002ff70: 2866 6c6f 6f72 286d 6170 5f79 7369 7a65  (floor(map_ysize
-0002ff80: 202f 2032 2e30 2920 2a20 2d31 2c20 6365   / 2.0) * -1, ce
-0002ff90: 696c 286d 6170 5f79 7369 7a65 202f 2032  il(map_ysize / 2
-0002ffa0: 2e30 2929 202f 2066 6c6f 6174 2866 6c6f  .0)) / float(flo
-0002ffb0: 6f72 286d 6170 5f79 7369 7a65 2929 0a20  or(map_ysize)). 
-0002ffc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ffd0: 2020 2078 6772 6964 203d 206e 702e 6172     xgrid = np.ar
-0002ffe0: 616e 6765 2866 6c6f 6f72 286d 6170 5f78  ange(floor(map_x
-0002fff0: 7369 7a65 202f 2032 2e30 2920 2a20 2d31  size / 2.0) * -1
-00030000: 2c20 6365 696c 286d 6170 5f78 7369 7a65  , ceil(map_xsize
-00030010: 202f 2032 2e30 2929 202f 2066 6c6f 6174   / 2.0)) / float
-00030020: 2866 6c6f 6f72 286d 6170 5f78 7369 7a65  (floor(map_xsize
-00030030: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-00030040: 2020 2020 2020 2023 207a 6772 6964 203d         # zgrid =
-00030050: 206e 702e 6172 616e 6765 2866 6c6f 6f72   np.arange(floor
-00030060: 2870 736d 6170 2e7a 5f73 697a 6528 292a  (psmap.z_size()*
-00030070: 3220 2f20 322e 3029 202a 202d 312c 2063  2 / 2.0) * -1, c
-00030080: 6569 6c28 7073 6d61 702e 7a5f 7369 7a65  eil(psmap.z_size
-00030090: 2829 2a32 202f 2032 2e30 2929 202f 2066  ()*2 / 2.0)) / f
-000300a0: 6c6f 6174 2866 6c6f 6f72 2870 736d 6170  loat(floor(psmap
-000300b0: 2e7a 5f73 697a 6528 2929 290a 2020 2020  .z_size())).    
-000300c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000300d0: 2320 7967 7269 6420 3d20 6e70 2e61 7261  # ygrid = np.ara
-000300e0: 6e67 6528 666c 6f6f 7228 7073 6d61 702e  nge(floor(psmap.
-000300f0: 795f 7369 7a65 2829 2a32 202f 2032 2e30  y_size()*2 / 2.0
-00030100: 2920 2a20 2d31 2c20 6365 696c 2870 736d  ) * -1, ceil(psm
-00030110: 6170 2e79 5f73 697a 6528 292a 3220 2f20  ap.y_size()*2 / 
-00030120: 322e 3029 2920 2f20 666c 6f61 7428 666c  2.0)) / float(fl
-00030130: 6f6f 7228 7073 6d61 702e 795f 7369 7a65  oor(psmap.y_size
-00030140: 2829 2929 0a20 2020 2020 2020 2020 2020  ())).           
-00030150: 2020 2020 2020 2020 2023 2078 6772 6964           # xgrid
-00030160: 203d 206e 702e 6172 616e 6765 2866 6c6f   = np.arange(flo
-00030170: 6f72 2870 736d 6170 2e78 5f73 697a 6528  or(psmap.x_size(
-00030180: 292a 3220 2f20 322e 3029 202a 202d 312c  )*2 / 2.0) * -1,
-00030190: 2063 6569 6c28 7073 6d61 702e 785f 7369   ceil(psmap.x_si
-000301a0: 7a65 2829 2a32 202f 2032 2e30 2929 202f  ze()*2 / 2.0)) /
-000301b0: 2066 6c6f 6174 2866 6c6f 6f72 2870 736d   float(floor(psm
-000301c0: 6170 2e78 5f73 697a 6528 2929 290a 2020  ap.x_size())).  
-000301d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000301e0: 2020 7864 6973 203d 2078 6772 6964 202a    xdis = xgrid *
-000301f0: 2a20 320a 2020 2020 2020 2020 2020 2020  * 2.            
-00030200: 2020 2020 2020 2020 7964 6973 203d 2079          ydis = y
-00030210: 6772 6964 202a 2a20 320a 2020 2020 2020  grid ** 2.      
-00030220: 2020 2020 2020 2020 2020 2020 2020 7a64                zd
-00030230: 6973 203d 207a 6772 6964 202a 2a20 320a  is = zgrid ** 2.
-00030240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030250: 2020 2020 6469 7374 203d 206e 702e 7371      dist = np.sq
-00030260: 7274 287a 6469 735b 3a2c 204e 6f6e 652c  rt(zdis[:, None,
-00030270: 204e 6f6e 655d 202b 2079 6469 735b 3a2c   None] + ydis[:,
-00030280: 204e 6f6e 655d 202b 2078 6469 7329 0a0a   None] + xdis)..
-00030290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000302a0: 2020 2020 616c 6c61 7869 7320 3d20 5b7a      allaxis = [z
-000302b0: 6772 6964 2c20 7967 7269 642c 2078 6772  grid, ygrid, xgr
-000302c0: 6964 5d0a 2020 2020 2020 2020 2020 2020  id].            
-000302d0: 2020 2020 2020 2020 746d 7069 6e64 6961          tmpindia
-000302e0: 7869 7320 3d20 6d61 7828 616c 6c61 7869  xis = max(allaxi
-000302f0: 732c 206b 6579 3d6c 656e 290a 2020 2020  s, key=len).    
-00030300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030310: 696e 6469 6178 6973 7420 3d20 746d 7069  indiaxist = tmpi
-00030320: 6e64 6961 7869 735b 746d 7069 6e64 6961  ndiaxis[tmpindia
-00030330: 7869 7320 3e3d 2030 5d0a 2020 2020 2020  xis >= 0].      
-00030340: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00030350: 696e 6469 6178 6973 7420 3d20 6e70 2e61  indiaxist = np.a
-00030360: 7261 6e67 6528 302c 206e 702e 616d 6178  range(0, np.amax
-00030370: 2874 6d70 696e 6469 6178 6973 292c 302e  (tmpindiaxis),0.
-00030380: 3031 3034 2029 0a20 2020 2020 2020 2020  0104 ).         
-00030390: 2020 2020 2020 2020 2020 2023 2069 6e64             # ind
-000303a0: 6961 7869 7374 203d 206e 702e 6c69 6e73  iaxist = np.lins
-000303b0: 7061 6365 2830 2c20 6e70 2e61 6d61 7828  pace(0, np.amax(
-000303c0: 746d 7069 6e64 6961 7869 7329 2c20 3230  tmpindiaxis), 20
-000303d0: 3020 290a 2020 2020 2020 2020 2020 2020  0 ).            
-000303e0: 2020 2020 2020 2020 696e 6469 6178 6973          indiaxis
-000303f0: 203d 206e 702e 6c69 6e73 7061 6365 2830   = np.linspace(0
-00030400: 2c20 3120 2f20 2832 202a 2061 7069 7829  , 1 / (2 * apix)
-00030410: 2c20 6c65 6e28 696e 6469 6178 6973 7429  , len(indiaxist)
-00030420: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-00030430: 2020 2020 2020 2061 7073 203d 205b 5d0a         aps = [].
-00030440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030450: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
-00030460: 6765 286c 656e 2869 6e64 6961 7869 7329  ge(len(indiaxis)
-00030470: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00030480: 2020 2020 2020 2020 2020 2069 6620 6920             if i 
-00030490: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
-000304a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000304b0: 2020 696e 6469 6365 7320 3d20 6e70 2e61    indices = np.a
-000304c0: 7267 7768 6572 6528 6469 7374 203d 3d20  rgwhere(dist == 
-000304d0: 696e 6469 6178 6973 745b 695d 290a 2020  indiaxist[i]).  
-000304e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000304f0: 2020 2020 2020 2020 2020 2320 7073 756d            # psum
-00030500: 203d 206c 6f67 3130 2870 736d 6170 2e66   = log10(psmap.f
-00030510: 756c 6c4d 6170 5b74 7570 6c65 2869 6e64  ullMap[tuple(ind
-00030520: 6963 6573 2e54 295d 2e73 756d 2829 202f  ices.T)].sum() /
-00030530: 206c 656e 2869 6e64 6963 6573 2929 0a20   len(indices)). 
-00030540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030550: 2020 2020 2020 2020 2020 2070 7375 6d20             psum 
-00030560: 3d20 6c6f 6731 3028 6666 746d 6170 5b74  = log10(fftmap[t
-00030570: 7570 6c65 2869 6e64 6963 6573 2e54 295d  uple(indices.T)]
-00030580: 2e73 756d 2829 202f 206c 656e 2869 6e64  .sum() / len(ind
-00030590: 6963 6573 2929 0a20 2020 2020 2020 2020  ices)).         
-000305a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000305b0: 2020 2061 7073 2e61 7070 656e 6428 7073     aps.append(ps
-000305c0: 756d 290a 2020 2020 2020 2020 2020 2020  um).            
-000305d0: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-000305e0: 2021 3d20 6c65 6e28 696e 6469 6178 6973   != len(indiaxis
-000305f0: 2920 2d20 313a 0a20 2020 2020 2020 2020  ) - 1:.         
-00030600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030610: 2020 2069 6e64 6963 6573 203d 206e 702e     indices = np.
-00030620: 6172 6777 6865 7265 2828 6469 7374 203e  argwhere((dist >
-00030630: 2069 6e64 6961 7869 7374 5b69 5d29 2026   indiaxist[i]) &
-00030640: 2028 6469 7374 203c 3d20 696e 6469 6178   (dist <= indiax
-00030650: 6973 745b 6920 2b20 315d 2929 0a20 2020  ist[i + 1])).   
-00030660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030670: 2020 2020 2020 2020 2023 2070 7375 6d20           # psum 
-00030680: 3d20 6c6f 6731 3028 7073 6d61 702e 6675  = log10(psmap.fu
-00030690: 6c6c 4d61 705b 7475 706c 6528 696e 6469  llMap[tuple(indi
-000306a0: 6365 732e 5429 5d2e 7375 6d28 2920 2f20  ces.T)].sum() / 
-000306b0: 6c65 6e28 696e 6469 6365 7329 290a 2020  len(indices)).  
-000306c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000306d0: 2020 2020 2020 2020 2020 7073 756d 203d            psum =
-000306e0: 206c 6f67 3130 2866 6674 6d61 705b 7475   log10(fftmap[tu
-000306f0: 706c 6528 696e 6469 6365 732e 5429 5d2e  ple(indices.T)].
-00030700: 7375 6d28 2920 2f20 6c65 6e28 696e 6469  sum() / len(indi
-00030710: 6365 7329 290a 2020 2020 2020 2020 2020  ces)).          
-00030720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030730: 2020 6170 732e 6170 7065 6e64 2870 7375    aps.append(psu
-00030740: 6d29 0a20 2020 2020 2020 2020 2020 2020  m).             
-00030750: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00030760: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00030770: 2020 2020 2020 2020 2020 2020 2070 6173               pas
-00030780: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-00030790: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-000307a0: 696e 6469 6365 7320 3d20 6e70 2e61 7267  indices = np.arg
-000307b0: 7768 6572 6528 6469 7374 203d 3d20 696e  where(dist == in
-000307c0: 6469 6178 6973 745b 695d 290a 2020 2020  diaxist[i]).    
-000307d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000307e0: 2020 2020 2020 2020 2320 7073 756d 203d          # psum =
-000307f0: 206c 6f67 3130 2870 736d 6170 2e66 756c   log10(psmap.ful
-00030800: 6c4d 6170 5b74 7570 6c65 2869 6e64 6963  lMap[tuple(indic
-00030810: 6573 2e54 295d 2e73 756d 2829 202f 206c  es.T)].sum() / l
-00030820: 656e 2869 6e64 6963 6573 2929 0a20 2020  en(indices)).   
-00030830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030840: 2020 2020 2020 2020 2023 2061 7073 2e61           # aps.a
-00030850: 7070 656e 6428 7073 756d 290a 2020 2020  ppend(psum).    
-00030860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030870: 7072 696e 7428 6170 7329 0a20 2020 2020  print(aps).     
-00030880: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00030890: 6620 6170 735b 305d 203c 2030 3a0a 2020  f aps[0] < 0:.  
-000308a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000308b0: 2020 2020 2020 6170 735b 305d 203d 2061        aps[0] = a
-000308c0: 7073 5b31 5d0a 2020 2020 2020 2020 2020  ps[1].          
-000308d0: 2020 2020 2020 2020 2020 6461 7461 6469            datadi
-000308e0: 6374 203d 207b 6c61 6265 6c20 2b20 2772  ct = {label + 'r
-000308f0: 6f74 6174 696f 6e61 6c6c 795f 6176 6572  otationally_aver
-00030900: 6167 6564 5f70 6f77 6572 5f73 7065 6374  aged_power_spect
-00030910: 7275 6d27 3a20 207b 2779 273a 206e 702e  rum':  {'y': np.
-00030920: 726f 756e 6428 6170 732c 2031 3029 2e74  round(aps, 10).t
-00030930: 6f6c 6973 7428 292c 0a20 2020 2020 2020  olist(),.       
-00030940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030980: 2020 2778 273a 206e 702e 726f 756e 6428    'x': np.round(
-00030990: 696e 6469 6178 6973 2c20 3130 292e 746f  indiaxis, 10).to
-000309a0: 6c69 7374 2829 7d7d 0a20 2020 2020 2020  list()}}.       
-000309b0: 2020 2020 2020 2020 2020 2020 2070 6c74               plt
-000309c0: 2e66 6967 7572 6528 6669 6773 697a 653d  .figure(figsize=
-000309d0: 2831 302c 2033 2929 0a20 2020 2020 2020  (10, 3)).       
-000309e0: 2020 2020 2020 2020 2020 2020 2070 6c74               plt
-000309f0: 2e70 6c6f 7428 6e70 2e72 6f75 6e64 2869  .plot(np.round(i
-00030a00: 6e64 6961 7869 732c 2034 292e 746f 6c69  ndiaxis, 4).toli
-00030a10: 7374 2829 2c20 6e70 2e72 6f75 6e64 2861  st(), np.round(a
-00030a20: 7073 2c20 3429 2e74 6f6c 6973 7428 292c  ps, 4).tolist(),
-00030a30: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00030a40: 2020 2020 2020 2070 6c74 2e73 6176 6566         plt.savef
-00030a50: 6967 2877 6f72 6b64 6972 202b 2073 656c  ig(workdir + sel
-00030a60: 662e 6d61 706e 616d 6520 2b20 275f 7261  f.mapname + '_ra
-00030a70: 7073 2e70 6e67 2729 0a20 2020 2020 2020  ps.png').       
-00030a80: 2020 2020 2020 2020 2020 2020 2070 6c74               plt
-00030a90: 2e63 6c6f 7365 2829 0a0a 2020 2020 2020  .close()..      
-00030aa0: 2020 2020 2020 2020 2020 6578 6365 7074            except
-00030ab0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00030ac0: 2020 2020 2020 6572 7220 3d20 2752 4150        err = 'RAP
-00030ad0: 5320 6361 6c63 756c 6174 696f 6e20 6572  S calculation er
-00030ae0: 726f 723a 207b 7d2e 272e 666f 726d 6174  ror: {}.'.format
-00030af0: 2873 7973 2e65 7863 5f69 6e66 6f28 295b  (sys.exc_info()[
-00030b00: 315d 290a 2020 2020 2020 2020 2020 2020  1]).            
-00030b10: 2020 2020 2020 2020 6572 726c 6973 742e          errlist.
-00030b20: 6170 7065 6e64 2865 7272 290a 2020 2020  append(err).    
-00030b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030b40: 7379 732e 7374 6465 7272 2e77 7269 7465  sys.stderr.write
-00030b50: 2865 7272 202b 2027 5c6e 2729 0a0a 2020  (err + '\n')..  
-00030b60: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00030b70: 2065 7272 6c69 7374 3a0a 2020 2020 2020   errlist:.      
-00030b80: 2020 2020 2020 2020 2020 2020 2020 6461                da
-00030b90: 7461 6469 6374 203d 207b 2772 6f74 6174  tadict = {'rotat
-00030ba0: 696f 6e61 6c6c 795f 6176 6572 6167 6564  ionally_averaged
-00030bb0: 5f70 6f77 6572 5f73 7065 6374 7275 6d27  _power_spectrum'
-00030bc0: 3a20 7b27 6572 7227 3a20 7b27 7261 7073  : {'err': {'raps
-00030bd0: 5f65 7272 273a 2065 7272 6c69 7374 7d7d  _err': errlist}}
-00030be0: 7d0a 0a20 2020 2020 2020 2020 2020 2020  }..             
-00030bf0: 2020 2069 6620 626f 6f6c 2864 6174 6164     if bool(datad
-00030c00: 6963 7429 3a0a 2020 2020 2020 2020 2020  ict):.          
-00030c10: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-00030c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030c30: 2020 2020 2020 2077 6974 6820 636f 6465         with code
-00030c40: 6373 2e6f 7065 6e28 776f 726b 6469 7220  cs.open(workdir 
-00030c50: 2b20 6d61 706e 616d 6520 2b20 275f 7261  + mapname + '_ra
-00030c60: 7073 2e6a 736f 6e27 2c20 2777 272c 2065  ps.json', 'w', e
-00030c70: 6e63 6f64 696e 673d 2775 7466 2d38 2729  ncoding='utf-8')
-00030c80: 2061 7320 663a 0a20 2020 2020 2020 2020   as f:.         
+0002fde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fdf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fe00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002fe10: 2027 7827 3a20 6e70 2e72 6f75 6e64 2869   'x': np.round(i
+0002fe20: 6e64 6961 7869 735b 3a2d 315d 2c20 3429  ndiaxis[:-1], 4)
+0002fe30: 2e74 6f6c 6973 7428 297d 7d0a 2020 2020  .tolist()}}.    
+0002fe40: 2020 2020 2020 2020 6572 7220 3d20 2752          err = 'R
+0002fe50: 4150 5320 6361 6c63 756c 6174 696f 6e20  APS calculation 
+0002fe60: 6572 726f 723a 207b 7d2e 272e 666f 726d  error: {}.'.form
+0002fe70: 6174 2873 7973 2e65 7863 5f69 6e66 6f28  at(sys.exc_info(
+0002fe80: 295b 315d 290a 2020 2020 2020 2020 2020  )[1]).          
+0002fe90: 2020 6572 726c 6973 742e 6170 7065 6e64    errlist.append
+0002fea0: 2865 7272 290a 2020 2020 2020 2020 2020  (err).          
+0002feb0: 2020 6461 7461 6469 6374 203d 207b 2772    datadict = {'r
+0002fec0: 6f74 6174 696f 6e61 6c6c 795f 6176 6572  otationally_aver
+0002fed0: 6167 6564 5f70 6f77 6572 5f73 7065 6374  aged_power_spect
+0002fee0: 7275 6d27 3a20 7b27 6572 7227 3a20 7b27  rum': {'err': {'
+0002fef0: 7261 7073 5f65 7272 273a 2065 7272 6c69  raps_err': errli
+0002ff00: 7374 7d7d 7d0a 2020 2020 2020 2020 2020  st}}}.          
+0002ff10: 2020 7379 732e 7374 6465 7272 2e77 7269    sys.stderr.wri
+0002ff20: 7465 2865 7272 202b 2027 5c6e 2729 0a0a  te(err + '\n')..
+0002ff30: 2020 2020 2020 2020 2020 2020 6966 2062              if b
+0002ff40: 6f6f 6c28 6461 7461 6469 6374 293a 0a20  ool(datadict):. 
+0002ff50: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0002ff60: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+0002ff70: 2020 2020 2020 2020 7769 7468 2063 6f64          with cod
+0002ff80: 6563 732e 6f70 656e 2873 656c 662e 776f  ecs.open(self.wo
+0002ff90: 726b 6469 7220 2b20 7365 6c66 2e6d 6170  rkdir + self.map
+0002ffa0: 6e61 6d65 202b 2027 5f72 6170 732e 6a73  name + '_raps.js
+0002ffb0: 6f6e 272c 2027 7727 2c20 656e 636f 6469  on', 'w', encodi
+0002ffc0: 6e67 3d27 7574 662d 3827 2920 6173 2066  ng='utf-8') as f
+0002ffd0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002ffe0: 2020 2020 2020 2020 2020 6a73 6f6e 2e64            json.d
+0002fff0: 756d 7028 6461 7461 6469 6374 2c20 6629  ump(datadict, f)
+00030000: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00030010: 2065 7863 6570 743a 0a20 2020 2020 2020   except:.       
+00030020: 2020 2020 2020 2020 2020 2020 2073 7973               sys
+00030030: 2e73 7464 6572 722e 7772 6974 6528 2753  .stderr.write('S
+00030040: 6176 696e 6720 5241 5053 2074 6f20 6a73  aving RAPS to js
+00030050: 6f6e 2065 7272 6f72 3a20 7b7d 2e27 2e66  on error: {}.'.f
+00030060: 6f72 6d61 7428 7379 732e 6578 635f 696e  ormat(sys.exc_in
+00030070: 666f 2829 5b31 5d29 290a 2020 2020 2020  fo()[1])).      
+00030080: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00030090: 2020 2020 2020 2020 2020 2020 7379 732e              sys.
+000300a0: 7374 6465 7272 2e77 7269 7465 2827 4e6f  stderr.write('No
+000300b0: 2072 6170 7320 6461 7461 2069 6e20 7468   raps data in th
+000300c0: 6520 6469 6374 696f 6e61 7279 2c20 6e6f  e dictionary, no
+000300d0: 2072 6170 7320 6a73 6f6e 2066 696c 652e   raps json file.
+000300e0: 5c6e 2729 0a0a 2020 2020 2020 2020 2020  \n')..          
+000300f0: 2020 656e 6420 3d20 7469 6d65 6974 2e64    end = timeit.d
+00030100: 6566 6175 6c74 5f74 696d 6572 2829 0a20  efault_timer(). 
+00030110: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+00030120: 2827 5241 5053 2074 696d 653a 2025 7327  ('RAPS time: %s'
+00030130: 2025 2028 656e 6420 2d20 7374 6172 7429   % (end - start)
+00030140: 290a 2020 2020 2020 2020 2020 2020 7072  ).            pr
+00030150: 696e 7428 272d 2d2d 2d2d 2d2d 2d2d 2d2d  int('-----------
+00030160: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00030170: 2d2d 2d2d 2d2d 2d2d 2d27 290a 2020 2020  ---------').    
+00030180: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00030190: 2020 2020 2020 7072 696e 7428 274e 6f20        print('No 
+000301a0: 5241 5053 2063 616c 6375 6c61 7469 6f6e  RAPS calculation
+000301b0: 2066 6f72 206e 6f6e 2d63 7562 6963 206d   for non-cubic m
+000301c0: 6170 2e27 290a 2020 2020 2020 2020 2020  ap.').          
+000301d0: 2020 7072 696e 7428 272d 2d2d 2d2d 2d2d    print('-------
+000301e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000301f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d27 290a  -------------').
+00030200: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00030210: 204e 6f6e 650a 0a0a 2020 2020 6465 6620   None...    def 
+00030220: 7261 7073 7328 7365 6c66 293a 0a20 2020  rapss(self):.   
+00030230: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00030240: 2020 2020 2063 616c 6375 6c61 7465 2062       calculate b
+00030250: 6f74 6820 7072 696d 6172 7920 6d61 7020  oth primary map 
+00030260: 7261 7073 2061 6e64 2072 6177 6d61 7020  raps and rawmap 
+00030270: 7261 7073 0a20 2020 2020 2020 203a 7265  raps.        :re
+00030280: 7475 726e 3a20 4e6f 6e65 0a20 2020 2020  turn: None.     
+00030290: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
+000302a0: 6620 7365 6c66 2e6d 6170 3a0a 2020 2020  f self.map:.    
+000302b0: 2020 2020 2020 2020 7374 6172 7472 6170          startrap
+000302c0: 7320 3d20 7469 6d65 6974 2e64 6566 6175  s = timeit.defau
+000302d0: 6c74 5f74 696d 6572 2829 0a20 2020 2020  lt_timer().     
+000302e0: 2020 2020 2020 2073 656c 662e 6e65 775f         self.new_
+000302f0: 7261 7073 2829 0a20 2020 2020 2020 2020  raps().         
+00030300: 2020 2073 746f 7072 6170 7320 3d20 7469     stopraps = ti
+00030310: 6d65 6974 2e64 6566 6175 6c74 5f74 696d  meit.default_tim
+00030320: 6572 2829 0a20 2020 2020 2020 2020 2020  er().           
+00030330: 2070 7269 6e74 2827 5241 5053 3a20 2573   print('RAPS: %s
+00030340: 2720 2520 2873 746f 7072 6170 7320 2d20  ' % (stopraps - 
+00030350: 7374 6172 7472 6170 7329 290a 2020 2020  startraps)).    
+00030360: 2020 2020 2020 2020 7072 696e 7428 272d          print('-
+00030370: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00030380: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00030390: 2d2d 2d27 290a 2020 2020 2020 2020 656c  ---').        el
+000303a0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000303b0: 7072 696e 7428 274e 6f20 7072 6f70 6572  print('No proper
+000303c0: 2070 7269 6d61 7279 206d 6170 2066 6f72   primary map for
+000303d0: 2052 4150 5320 6361 6c63 756c 6174 696f   RAPS calculatio
+000303e0: 6e2e 2729 0a0a 2020 2020 2020 2020 6966  n.')..        if
+000303f0: 2073 656c 662e 686d 6576 656e 2069 7320   self.hmeven is 
+00030400: 6e6f 7420 4e6f 6e65 2061 6e64 2073 656c  not None and sel
+00030410: 662e 686d 6f64 6420 6973 206e 6f74 204e  f.hmodd is not N
+00030420: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00030430: 2073 7461 7274 7261 7073 203d 2074 696d   startraps = tim
+00030440: 6569 742e 6465 6661 756c 745f 7469 6d65  eit.default_time
+00030450: 7228 290a 2020 2020 2020 2020 2020 2020  r().            
+00030460: 2320 7365 6c66 2e66 7363 2873 656c 662e  # self.fsc(self.
+00030470: 686d 6576 656e 2c20 7365 6c66 2e68 6d6f  hmeven, self.hmo
+00030480: 6464 290a 2020 2020 2020 2020 2020 2020  dd).            
+00030490: 7365 6c66 2e72 6177 6d61 705f 7261 7073  self.rawmap_raps
+000304a0: 2829 0a20 2020 2020 2020 2020 2020 2073  ().            s
+000304b0: 746f 7020 3d20 7469 6d65 6974 2e64 6566  top = timeit.def
+000304c0: 6175 6c74 5f74 696d 6572 2829 0a20 2020  ault_timer().   
+000304d0: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
+000304e0: 5261 7720 6d61 7020 5241 5053 3a20 2573  Raw map RAPS: %s
+000304f0: 2720 2520 2873 746f 7020 2d20 7374 6172  ' % (stop - star
+00030500: 7472 6170 7329 290a 2020 2020 2020 2020  traps)).        
+00030510: 2020 2020 7072 696e 7428 272d 2d2d 2d2d      print('-----
+00030520: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00030530: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d27  ---------------'
+00030540: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+00030550: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+00030560: 7428 274e 6f20 7261 7720 6d61 7020 5241  t('No raw map RA
+00030570: 5053 3a20 4d69 7369 6e67 2068 616c 6620  PS: Mising half 
+00030580: 6d61 7028 7329 2e27 290a 2020 2020 2020  map(s).').      
+00030590: 2020 706c 742e 636c 6f73 6528 290a 0a20    plt.close().. 
+000305a0: 2020 2023 2040 7072 6f66 696c 650a 2020     # @profile.  
+000305b0: 2020 6465 6620 7261 776d 6170 5f72 6170    def rawmap_rap
+000305c0: 7328 7365 6c66 293a 0a0a 2020 2020 2020  s(self):..      
+000305d0: 2020 7261 776d 6170 203d 2073 656c 662e    rawmap = self.
+000305e0: 7261 776d 6170 0a20 2020 2020 2020 2069  rawmap.        i
+000305f0: 6620 7261 776d 6170 2069 7320 6e6f 7420  f rawmap is not 
+00030600: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00030610: 2020 6469 7220 3d20 7365 6c66 2e77 6f72    dir = self.wor
+00030620: 6b64 6972 0a20 2020 2020 2020 2020 2020  kdir.           
+00030630: 206c 6162 656c 203d 2027 7261 776d 6170   label = 'rawmap
+00030640: 5f27 0a20 2020 2020 2020 2020 2020 2073  _'.            s
+00030650: 656c 662e 6e65 775f 7261 7073 2872 6177  elf.new_raps(raw
+00030660: 6d61 702c 2064 6972 2c20 6c61 6265 6c29  map, dir, label)
+00030670: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00030680: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+00030690: 2827 4e6f 2072 6177 206d 6170 2074 6f20  ('No raw map to 
+000306a0: 6361 6c63 756c 6174 6520 5241 5053 2e27  calculate RAPS.'
+000306b0: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+000306c0: 6e20 4e6f 6e65 0a0a 2020 2020 2340 7072  n None..    #@pr
+000306d0: 6f66 696c 650a 2020 2020 6465 6620 666f  ofile.    def fo
+000306e0: 7572 6965 725f 7472 616e 7366 6f72 6d28  urier_transform(
+000306f0: 7365 6c66 2c20 6d61 7064 6174 6129 3a0a  self, mapdata):.
+00030700: 0a0a 2020 2020 2020 2020 6e65 775f 6d61  ..        new_ma
+00030710: 7064 6174 6120 3d20 6666 7473 6869 6674  pdata = fftshift
+00030720: 2866 6674 6e28 6d61 7064 6174 6129 290a  (fftn(mapdata)).
+00030730: 2020 2020 2020 2020 7265 7475 726e 206e          return n
+00030740: 6577 5f6d 6170 6461 7461 0a0a 2020 2020  ew_mapdata..    
+00030750: 2340 7072 6f66 696c 650a 2020 2020 6465  #@profile.    de
+00030760: 6620 7261 7073 2873 656c 662c 206d 6170  f raps(self, map
+00030770: 696e 3d4e 6f6e 652c 2077 6f72 6b64 6972  in=None, workdir
+00030780: 3d4e 6f6e 652c 206c 6162 656c 3d27 2729  =None, label='')
+00030790: 3a0a 2020 2020 2020 2020 2222 220a 0a20  :.        """.. 
+000307a0: 2020 2020 2020 2020 2020 2043 616c 6375             Calcu
+000307b0: 6c61 7469 6f6e 206f 6620 7468 6520 726f  lation of the ro
+000307c0: 7461 7469 6f6e 616c 6c79 2061 7665 7261  tationally avera
+000307d0: 6765 2070 6f77 6572 2073 7065 6374 7275  ge power spectru
+000307e0: 6d20 2852 4150 5329 0a20 2020 2020 2020  m (RAPS).       
+000307f0: 2020 2020 2052 6573 756c 7473 2077 726f       Results wro
+00030800: 7465 2074 6f20 4a53 4f4e 2066 696c 650a  te to JSON file.
+00030810: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
+00030820: 3a20 4e6f 6e65 0a0a 2020 2020 2020 2020  : None..        
+00030830: 2222 220a 0a20 2020 2020 2020 206d 6170  """..        map
+00030840: 2c20 776f 726b 6469 7220 3d20 7365 6c66  , workdir = self
+00030850: 2e6d 6170 696e 6368 6563 6b28 6d61 7069  .mapincheck(mapi
+00030860: 6e2c 2077 6f72 6b64 6972 290a 2020 2020  n, workdir).    
+00030870: 2020 2020 6d61 706e 616d 6520 3d20 6f73      mapname = os
+00030880: 2e70 6174 682e 6261 7365 6e61 6d65 286d  .path.basename(m
+00030890: 6170 2e66 756c 6c6e 616d 6529 0a0a 2020  ap.fullname)..  
+000308a0: 2020 2020 2020 6d61 705f 7a73 697a 6520        map_zsize 
+000308b0: 3d20 6d61 702e 6865 6164 6572 2e6e 7a0a  = map.header.nz.
+000308c0: 2020 2020 2020 2020 6d61 705f 7973 697a          map_ysiz
+000308d0: 6520 3d20 6d61 702e 6865 6164 6572 2e6e  e = map.header.n
+000308e0: 790a 2020 2020 2020 2020 6d61 705f 7873  y.        map_xs
+000308f0: 697a 6520 3d20 6d61 702e 6865 6164 6572  ize = map.header
+00030900: 2e6e 780a 0a20 2020 2020 2020 2061 7069  .nx..        api
+00030910: 785f 6c69 7374 203d 206d 6170 2e76 6f78  x_list = map.vox
+00030920: 656c 5f73 697a 652e 746f 6c69 7374 2829  el_size.tolist()
+00030930: 0a20 2020 2020 2020 2061 7069 7873 203d  .        apixs =
+00030940: 2028 6170 6978 5f6c 6973 745b 305d 2c20   (apix_list[0], 
+00030950: 6170 6978 5f6c 6973 745b 315d 2c20 6170  apix_list[1], ap
+00030960: 6978 5f6c 6973 745b 325d 290a 0a20 2020  ix_list[2])..   
+00030970: 2020 2020 2069 6620 6d61 7020 6973 206e       if map is n
+00030980: 6f74 204e 6f6e 6520 616e 6420 776f 726b  ot None and work
+00030990: 6469 7220 6973 206e 6f74 204e 6f6e 653a  dir is not None:
+000309a0: 0a20 2020 2020 2020 2020 2020 2023 2069  .            # i
+000309b0: 6620 6d61 702e 785f 7369 7a65 2829 203d  f map.x_size() =
+000309c0: 3d20 6d61 702e 795f 7369 7a65 2829 203d  = map.y_size() =
+000309d0: 3d20 6d61 702e 7a5f 7369 7a65 2829 3a0a  = map.z_size():.
+000309e0: 2020 2020 2020 2020 2020 2020 6966 206d              if m
+000309f0: 6170 2e68 6561 6465 722e 6e78 203d 3d20  ap.header.nx == 
+00030a00: 6d61 702e 6865 6164 6572 2e6e 7920 3d3d  map.header.ny ==
+00030a10: 206d 6170 2e68 6561 6465 722e 6e7a 3a0a   map.header.nz:.
+00030a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030a30: 6572 726c 6973 7420 3d20 5b5d 0a20 2020  errlist = [].   
+00030a40: 2020 2020 2020 2020 2020 2020 2073 7461               sta
+00030a50: 7274 203d 2074 696d 6569 742e 6465 6661  rt = timeit.defa
+00030a60: 756c 745f 7469 6d65 7228 290a 2020 2020  ult_timer().    
+00030a70: 2020 2020 2020 2020 2020 2020 6461 7461              data
+00030a80: 6469 6374 203d 2064 6963 7428 290a 2020  dict = dict().  
+00030a90: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+00030aa0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00030ab0: 2020 2020 2020 2023 206d 6170 203d 2073         # map = s
+00030ac0: 656c 662e 6d61 700a 2020 2020 2020 2020  elf.map.        
+00030ad0: 2020 2020 2020 2020 2020 2020 2320 7465              # te
+00030ae0: 6d70 7261 7279 2073 6f6c 7574 696f 6e20  mprary solution 
+00030af0: 6173 2074 6865 2074 656d 7079 2067 6976  as the tempy giv
+00030b00: 6520 6170 6978 2061 7320 6f6e 6520 7661  e apix as one va
+00030b10: 6c75 6520 6275 7420 6865 7265 2066 726f  lue but here fro
+00030b20: 6d20 6d72 6366 696c 6520 7765 2075 7365  m mrcfile we use
+00030b30: 2061 2074 7570 6c65 0a20 2020 2020 2020   a tuple.       
+00030b40: 2020 2020 2020 2020 2020 2020 2023 2069               # i
+00030b50: 6620 7479 7065 286d 6170 2e61 7069 7829  f type(map.apix)
+00030b60: 2069 7320 7475 706c 653a 0a20 2020 2020   is tuple:.     
+00030b70: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00030b80: 6620 7479 7065 2861 7069 7873 2920 6973  f type(apixs) is
+00030b90: 2074 7570 6c65 3a0a 2020 2020 2020 2020   tuple:.        
+00030ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030bb0: 2320 6170 6978 203d 206d 6170 2e61 7069  # apix = map.api
+00030bc0: 785b 305d 0a20 2020 2020 2020 2020 2020  x[0].           
+00030bd0: 2020 2020 2020 2020 2020 2020 2061 7069               api
+00030be0: 7820 3d20 6170 6978 735b 305d 0a20 2020  x = apixs[0].   
+00030bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030c00: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00030c10: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00030c20: 2061 7069 7820 3d20 6d61 702e 6170 6978   apix = map.apix
+00030c30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00030c40: 2020 2020 2020 2020 2061 7069 7820 3d20           apix = 
+00030c50: 6170 6978 730a 2020 2020 2020 2020 2020  apixs.          
+00030c60: 2020 2020 2020 2020 2020 2320 6666 746d            # fftm
+00030c70: 6170 203d 206d 6170 2e66 6f75 7269 6572  ap = map.fourier
+00030c80: 5f74 7261 6e73 666f 726d 2829 0a20 2020  _transform().   
 00030c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030ca0: 2020 206a 736f 6e2e 6475 6d70 2864 6174     json.dump(dat
-00030cb0: 6164 6963 742c 2066 290a 2020 2020 2020  adict, f).      
-00030cc0: 2020 2020 2020 2020 2020 2020 2020 6578                ex
-00030cd0: 6365 7074 3a0a 2020 2020 2020 2020 2020  cept:.          
-00030ce0: 2020 2020 2020 2020 2020 2020 2020 7379                sy
-00030cf0: 732e 7374 6465 7272 2e77 7269 7465 2827  s.stderr.write('
-00030d00: 5361 7669 6e67 2052 4150 5320 746f 206a  Saving RAPS to j
-00030d10: 736f 6e20 6572 726f 723a 207b 7d2e 272e  son error: {}.'.
-00030d20: 666f 726d 6174 2873 7973 2e65 7863 5f69  format(sys.exc_i
-00030d30: 6e66 6f28 295b 315d 2929 0a20 2020 2020  nfo()[1])).     
-00030d40: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00030d50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00030d60: 2020 2020 2073 7973 2e73 7464 6572 722e       sys.stderr.
-00030d70: 7772 6974 6528 274e 6f20 7261 7073 2064  write('No raps d
-00030d80: 6174 6120 696e 2074 6865 2064 6963 7469  ata in the dicti
-00030d90: 6f6e 6172 792c 206e 6f20 7261 7073 206a  onary, no raps j
-00030da0: 736f 6e20 6669 6c65 2e5c 6e27 290a 0a20  son file.\n').. 
-00030db0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00030dc0: 6e64 203d 2074 696d 6569 742e 6465 6661  nd = timeit.defa
-00030dd0: 756c 745f 7469 6d65 7228 290a 2020 2020  ult_timer().    
-00030de0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-00030df0: 7428 2752 4150 5320 7469 6d65 2066 6f72  t('RAPS time for
-00030e00: 2025 733a 2025 7327 2025 2028 6d61 706e   %s: %s' % (mapn
-00030e10: 616d 652c 2065 6e64 202d 2073 7461 7274  ame, end - start
-00030e20: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-00030e30: 2020 2070 7269 6e74 2827 2d2d 2d2d 2d2d     print('------
-00030e40: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00030e50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2729  --------------')
-00030e60: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00030e70: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00030e80: 2020 2070 7269 6e74 2827 4e6f 2052 4150     print('No RAP
-00030e90: 5320 6361 6c63 756c 6174 696f 6e20 666f  S calculation fo
-00030ea0: 7220 6e6f 6e2d 6375 6269 6320 6d61 702e  r non-cubic map.
-00030eb0: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
-00030ec0: 2020 2070 7269 6e74 2827 2d2d 2d2d 2d2d     print('------
-00030ed0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00030ee0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2729  --------------')
-00030ef0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00030f00: 2020 7265 7475 726e 204e 6f6e 650a 2020    return None.  
-00030f10: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00030f20: 2020 2020 2020 2020 7072 696e 7428 274e          print('N
-00030f30: 6f20 5241 5053 2077 6974 686f 7574 2070  o RAPS without p
-00030f40: 726f 7065 7220 6d61 7020 696e 7075 7420  roper map input 
-00030f50: 616e 6420 7468 6520 6f75 7470 7574 2064  and the output d
-00030f60: 6972 6563 746f 7279 2069 6e66 6f72 6d61  irectory informa
-00030f70: 7469 6f6e 2e27 290a 0a0a 2020 2020 2320  tion.')...    # 
-00030f80: 4265 6c6f 7720 4865 7265 2069 7320 7468  Below Here is th
-00030f90: 6520 7465 7374 206e 6577 2072 6170 7320  e test new raps 
-00030fa0: 6675 6e63 7469 6f6e 2061 7265 610a 0a20  function area.. 
-00030fb0: 2020 2064 6566 2061 7070 6c79 5f33 645f     def apply_3d_
-00030fc0: 7379 6d6d 6574 7279 2873 656c 662c 2069  symmetry(self, i
-00030fd0: 6e64 732c 206f 7269 6769 6e29 3a0a 2020  nds, origin):.  
-00030fe0: 2020 2020 2020 4f20 3d20 6f72 6967 696e        O = origin
-00030ff0: 0a20 2020 2020 2020 206f 7065 7261 746f  .        operato
-00031000: 7273 203d 205b 5b6e 702e 6172 7261 7928  rs = [[np.array(
-00031010: 5b2d 312c 2031 2c20 315d 292c 205b 4f5b  [-1, 1, 1]), [O[
-00031020: 305d 202a 2032 2c20 302c 2030 5d5d 2c0a  0] * 2, 0, 0]],.
-00031030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031040: 2020 2020 205b 6e70 2e61 7272 6179 285b       [np.array([
-00031050: 312c 2031 2c20 2d31 5d29 2c20 5b30 2c20  1, 1, -1]), [0, 
-00031060: 302c 204f 5b32 5d20 2a20 325d 5d2c 0a20  0, O[2] * 2]],. 
-00031070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031080: 2020 2020 2320 5b6e 702e 6172 7261 7928      # [np.array(
-00031090: 5b31 2c20 2d31 2c20 315d 292c 205b 302c  [1, -1, 1]), [0,
-000310a0: 204f 5b31 5d20 2a20 322c 2030 5d5d 2c0a   O[1] * 2, 0]],.
-000310b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000310c0: 2020 2020 2023 205b 6e70 2e61 7272 6179       # [np.array
-000310d0: 285b 2d31 2c20 2d31 2c20 315d 292c 205b  ([-1, -1, 1]), [
-000310e0: 4f5b 305d 202a 2032 2c20 4f5b 315d 202a  O[0] * 2, O[1] *
-000310f0: 2032 2c20 305d 5d2c 0a20 2020 2020 2020   2, 0]],.       
-00031100: 2020 2020 2020 2020 2020 2020 2020 5b6e                [n
-00031110: 702e 6172 7261 7928 5b2d 312c 2031 2c20  p.array([-1, 1, 
-00031120: 2d31 5d29 2c20 5b4f 5b30 5d20 2a20 322c  -1]), [O[0] * 2,
-00031130: 2030 2c20 4f5b 325d 202a 2032 5d5d 2c5d   0, O[2] * 2]],]
-00031140: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00031150: 2020 2020 2020 2320 5b6e 702e 6172 7261        # [np.arra
-00031160: 7928 5b31 2c20 2d31 2c20 2d31 5d29 2c20  y([1, -1, -1]), 
-00031170: 5b30 2c20 4f5b 315d 202a 2032 2c20 4f5b  [0, O[1] * 2, O[
-00031180: 325d 202a 2032 5d5d 2c0a 2020 2020 2020  2] * 2]],.      
-00031190: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000311a0: 205b 6e70 2e61 7272 6179 285b 2d31 2c20   [np.array([-1, 
-000311b0: 2d31 2c20 2d31 5d29 2c20 5b4f 5b30 5d20  -1, -1]), [O[0] 
-000311c0: 2a20 322c 204f 5b31 5d20 2a20 322c 204f  * 2, O[1] * 2, O
-000311d0: 5b32 5d20 2a20 325d 5d5d 0a20 2020 2020  [2] * 2]]].     
-000311e0: 2020 2069 6e64 203d 206e 702e 6172 7261     ind = np.arra
-000311f0: 7928 696e 6473 290a 2020 2020 2020 2020  y(inds).        
-00031200: 7265 7320 3d20 6e70 2e61 7272 6179 2869  res = np.array(i
-00031210: 6e64 7329 0a20 2020 2020 2020 2023 2077  nds).        # w
-00031220: 3120 3d20 6e70 2e77 6865 7265 2828 696e  1 = np.where((in
-00031230: 645b 3a2c 2031 5d20 3d3d 204f 5b31 5d29  d[:, 1] == O[1])
-00031240: 207c 2028 696e 645b 3a2c 2030 5d20 3d3d   | (ind[:, 0] ==
-00031250: 204f 5b30 5d29 207c 2028 696e 645b 3a2c   O[0]) | (ind[:,
-00031260: 2032 5d20 3d3d 204f 5b32 5d29 2c20 5472   2] == O[2]), Tr
-00031270: 7565 2c20 4661 6c73 6529 0a20 2020 2020  ue, False).     
-00031280: 2020 2023 2077 3120 3d20 696e 645b 7731     # w1 = ind[w1
-00031290: 2c20 3a5d 0a20 2020 2020 2020 2023 2077  , :].        # w
-000312a0: 3220 3d20 6e70 2e77 6865 7265 2828 696e  2 = np.where((in
-000312b0: 645b 3a2c 2031 5d20 213d 204f 5b31 5d29  d[:, 1] != O[1])
-000312c0: 207c 2028 696e 645b 3a2c 2030 5d20 213d   | (ind[:, 0] !=
-000312d0: 204f 5b30 5d29 207c 2028 696e 645b 3a2c   O[0]) | (ind[:,
-000312e0: 2032 5d20 213d 204f 5b32 5d29 2c20 5472   2] != O[2]), Tr
-000312f0: 7565 2c20 4661 6c73 6529 0a20 2020 2020  ue, False).     
-00031300: 2020 2023 2077 3220 3d20 696e 645b 7732     # w2 = ind[w2
-00031310: 2c20 3a5d 0a20 2020 2020 2020 2066 6f72  , :].        for
-00031320: 206f 7020 696e 206f 7065 7261 746f 7273   op in operators
-00031330: 5b3a 5d3a 0a20 2020 2020 2020 2020 2020  [:]:.           
-00031340: 2023 2074 6d70 203d 2077 3220 2a20 6f70   # tmp = w2 * op
-00031350: 5b30 5d20 2b20 6e70 2e61 7272 6179 286f  [0] + np.array(o
-00031360: 705b 315d 290a 2020 2020 2020 2020 2020  p[1]).          
-00031370: 2020 746d 7020 3d20 696e 6420 2a20 6f70    tmp = ind * op
-00031380: 5b30 5d20 2b20 6e70 2e61 7272 6179 286f  [0] + np.array(o
-00031390: 705b 315d 290a 2020 2020 2020 2020 2020  p[1]).          
-000313a0: 2020 7265 7320 3d20 6e70 2e63 6f6e 6361    res = np.conca
-000313b0: 7465 6e61 7465 2828 7265 732c 2074 6d70  tenate((res, tmp
-000313c0: 2929 0a20 2020 2020 2020 2023 206f 6e5f  )).        # on_
-000313d0: 6178 6973 5f72 6573 203d 206e 702e 636f  axis_res = np.co
-000313e0: 6e63 6174 656e 6174 6528 2877 3120 2a20  ncatenate((w1 * 
-000313f0: 6e70 2e61 7272 6179 285b 2d31 2c20 2d31  np.array([-1, -1
-00031400: 2c20 2d31 5d29 202b 206e 702e 6172 7261  , -1]) + np.arra
-00031410: 7928 5b4f 5b30 5d20 2a20 322c 204f 5b31  y([O[0] * 2, O[1
-00031420: 5d20 2a20 322c 204f 5b32 5d20 2a20 325d  ] * 2, O[2] * 2]
-00031430: 292c 2077 3129 290a 2020 2020 2020 2020  ), w1)).        
-00031440: 2320 7265 7320 3d20 6e70 2e63 6f6e 6361  # res = np.conca
-00031450: 7465 6e61 7465 2828 7265 732c 206f 6e5f  tenate((res, on_
-00031460: 6178 6973 5f72 6573 2929 0a20 2020 2020  axis_res)).     
-00031470: 2020 2072 6574 7572 6e20 6e70 2e75 6e69     return np.uni
-00031480: 7175 6528 7265 732c 2061 7869 733d 3029  que(res, axis=0)
-00031490: 0a0a 2020 2020 6465 6620 6765 6e65 7261  ..    def genera
-000314a0: 7465 5f73 6865 6c6c 2873 656c 662c 206e  te_shell(self, n
-000314b0: 312c 206e 322c 2073 6861 7065 293a 0a20  1, n2, shape):. 
-000314c0: 2020 2020 2020 2064 3120 3d20 6e31 0a20         d1 = n1. 
-000314d0: 2020 2020 2020 2064 3220 3d20 6e32 0a20         d2 = n2. 
-000314e0: 2020 2020 2020 2023 204f 3120 3d20 5b73         # O1 = [s
-000314f0: 6861 7065 5b30 5d2f 2f32 2c20 7368 6170  hape[0]//2, shap
-00031500: 655b 315d 2f2f 322c 2073 6861 7065 5b32  e[1]//2, shape[2
-00031510: 5d2f 2f32 5d0a 2020 2020 2020 2020 2320  ]//2].        # 
-00031520: 6576 656e 206e 756d 6265 7220 666f 7220  even number for 
-00031530: 6772 6964 0a20 2020 2020 2020 2023 2062  grid.        # b
-00031540: 6173 6564 206f 6e20 6666 740a 2020 2020  ased on fft.    
-00031550: 2020 2020 6966 206d 696e 2873 6861 7065      if min(shape
-00031560: 2920 2520 3220 3d3d 2030 3a0a 2020 2020  ) % 2 == 0:.    
-00031570: 2020 2020 2020 2020 4f31 203d 205b 7368          O1 = [sh
-00031580: 6170 655b 305d 202f 2032 2c20 7368 6170  ape[0] / 2, shap
-00031590: 655b 315d 202f 2032 2c20 7368 6170 655b  e[1] / 2, shape[
-000315a0: 325d 202f 2032 5d0a 2020 2020 2020 2020  2] / 2].        
-000315b0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-000315c0: 2020 4f31 203d 205b 2873 6861 7065 5b30    O1 = [(shape[0
-000315d0: 5d20 2d20 3129 202f 2032 2c20 2873 6861  ] - 1) / 2, (sha
-000315e0: 7065 5b31 5d20 2d20 3129 202f 2032 2c20  pe[1] - 1) / 2, 
-000315f0: 2873 6861 7065 5b32 5d20 2d20 3129 202f  (shape[2] - 1) /
-00031600: 2032 5d0a 2020 2020 2020 2020 696e 6469   2].        indi
-00031610: 6365 7320 3d20 5b5d 0a20 2020 2020 2020  ces = [].       
-00031620: 2023 206d 616b 6520 7375 7265 0a20 2020   # make sure.   
-00031630: 2020 2020 2078 5f6d 6178 203d 2069 6e74       x_max = int
-00031640: 2864 3229 202b 2069 6e74 284f 315b 305d  (d2) + int(O1[0]
-00031650: 2920 2b20 3120 6966 2069 6e74 2864 3229  ) + 1 if int(d2)
-00031660: 202b 2069 6e74 284f 315b 305d 2920 3c20   + int(O1[0]) < 
-00031670: 7368 6170 655b 305d 2065 6c73 6520 696e  shape[0] else in
-00031680: 7428 6432 2920 2b20 696e 7428 4f31 5b30  t(d2) + int(O1[0
-00031690: 5d29 0a20 2020 2020 2020 2079 5f6d 6178  ]).        y_max
-000316a0: 203d 2069 6e74 2864 3229 202b 2069 6e74   = int(d2) + int
-000316b0: 284f 315b 315d 2920 2b20 3120 6966 2069  (O1[1]) + 1 if i
-000316c0: 6e74 2864 3229 202b 2069 6e74 284f 315b  nt(d2) + int(O1[
-000316d0: 315d 2920 3c20 7368 6170 655b 315d 2065  1]) < shape[1] e
-000316e0: 6c73 6520 696e 7428 6432 2920 2b20 696e  lse int(d2) + in
-000316f0: 7428 4f31 5b31 5d29 0a20 2020 2020 2020  t(O1[1]).       
-00031700: 2066 6f72 2078 2069 6e20 7261 6e67 6528   for x in range(
-00031710: 726f 756e 6428 4f31 5b30 5d20 2b20 302e  round(O1[0] + 0.
-00031720: 3129 2c20 785f 6d61 7829 3a0a 2020 2020  1), x_max):.    
-00031730: 2020 2020 2020 2020 666f 7220 7920 696e          for y in
-00031740: 2072 616e 6765 2872 6f75 6e64 284f 315b   range(round(O1[
-00031750: 315d 202b 2030 2e31 292c 2079 5f6d 6178  1] + 0.1), y_max
-00031760: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00031770: 2020 2078 795f 6469 7374 203d 206d 6174     xy_dist = mat
-00031780: 682e 7371 7274 2828 7820 2d20 4f31 5b30  h.sqrt((x - O1[0
-00031790: 5d29 202a 2a20 3220 2b20 2879 202d 204f  ]) ** 2 + (y - O
-000317a0: 315b 315d 2920 2a2a 2032 290a 2020 2020  1[1]) ** 2).    
-000317b0: 2020 2020 2020 2020 2020 2020 6966 2078              if x
-000317c0: 795f 6469 7374 203c 3d20 6432 3a0a 2020  y_dist <= d2:.  
-000317d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000317e0: 2020 6966 2078 795f 6469 7374 203d 3d20    if xy_dist == 
-000317f0: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
-00031800: 2020 2020 2020 2020 2020 207a 5f6d 696e             z_min
-00031810: 203d 2069 6e74 284f 315b 325d 202b 2064   = int(O1[2] + d
-00031820: 3129 0a20 2020 2020 2020 2020 2020 2020  1).             
-00031830: 2020 2020 2020 2020 2020 207a 5f6d 6178             z_max
-00031840: 203d 2069 6e74 284f 315b 325d 202b 2064   = int(O1[2] + d
-00031850: 3229 0a20 2020 2020 2020 2020 2020 2020  2).             
-00031860: 2020 2020 2020 2065 6c69 6620 7879 5f64         elif xy_d
-00031870: 6973 7420 3c20 6431 3a0a 2020 2020 2020  ist < d1:.      
-00031880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031890: 2020 7a5f 6d69 6e20 3d20 6d61 7468 2e73    z_min = math.s
-000318a0: 7172 7428 6431 202a 2a20 3220 2d20 7879  qrt(d1 ** 2 - xy
-000318b0: 5f64 6973 7420 2a2a 2032 2920 2b20 4f31  _dist ** 2) + O1
-000318c0: 5b32 5d0a 2020 2020 2020 2020 2020 2020  [2].            
-000318d0: 2020 2020 2020 2020 2020 2020 7a5f 6d69              z_mi
-000318e0: 6e20 3d20 696e 7428 7a5f 6d69 6e29 0a20  n = int(z_min). 
-000318f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031900: 2020 2020 2020 207a 5f6d 6178 203d 206d         z_max = m
-00031910: 6174 682e 7371 7274 2864 3220 2a2a 2032  ath.sqrt(d2 ** 2
-00031920: 202d 2078 795f 6469 7374 202a 2a20 3229   - xy_dist ** 2)
-00031930: 202b 204f 315b 325d 0a20 2020 2020 2020   + O1[2].       
-00031940: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
-00031950: 6620 6431 203c 3d20 7879 5f64 6973 7420  f d1 <= xy_dist 
-00031960: 3c3d 2064 323a 0a20 2020 2020 2020 2020  <= d2:.         
-00031970: 2020 2020 2020 2020 2020 2020 2020 207a                 z
-00031980: 5f6d 696e 203d 204f 315b 325d 0a20 2020  _min = O1[2].   
-00031990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000319a0: 2020 2020 207a 5f6d 6178 203d 206d 6174       z_max = mat
-000319b0: 682e 7371 7274 2864 3220 2a2a 2032 202d  h.sqrt(d2 ** 2 -
-000319c0: 2078 795f 6469 7374 202a 2a20 3229 202b   xy_dist ** 2) +
-000319d0: 204f 315b 325d 0a20 2020 2020 2020 2020   O1[2].         
-000319e0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-000319f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00031a00: 2020 2020 2020 2020 207a 5f6d 696e 203d           z_min =
-00031a10: 204f 315b 325d 0a20 2020 2020 2020 2020   O1[2].         
-00031a20: 2020 2020 2020 2020 2020 2020 2020 207a                 z
-00031a30: 5f6d 6178 203d 204f 315b 325d 0a20 2020  _max = O1[2].   
-00031a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031a50: 2069 6620 696e 7428 7a5f 6d69 6e29 203c   if int(z_min) <
-00031a60: 204f 315b 325d 3a0a 2020 2020 2020 2020   O1[2]:.        
-00031a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031a80: 7a5f 6d69 6e20 3d20 726f 756e 6428 4f31  z_min = round(O1
-00031a90: 5b32 5d20 2b20 302e 3129 0a20 2020 2020  [2] + 0.1).     
-00031aa0: 2020 2020 2020 2020 2020 2020 2020 207a                 z
-00031ab0: 5f6d 6178 203d 2069 6e74 287a 5f6d 6178  _max = int(z_max
-00031ac0: 2920 2b20 3120 6966 2069 6e74 287a 5f6d  ) + 1 if int(z_m
-00031ad0: 6178 2920 3c20 7368 6170 655b 325d 2065  ax) < shape[2] e
-00031ae0: 6c73 6520 696e 7428 7a5f 6d61 7829 0a20  lse int(z_max). 
+00030ca0: 2066 6674 6d61 7020 3d20 6666 7473 6869   fftmap = fftshi
+00030cb0: 6674 2866 6674 6e28 6d61 702e 6461 7461  ft(fftn(map.data
+00030cc0: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+00030cd0: 2020 2020 2020 2023 2070 736d 6170 203d         # psmap =
+00030ce0: 2066 6674 6d61 702e 636f 7079 2829 0a20   fftmap.copy(). 
+00030cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030d00: 2020 2023 2070 736d 6561 6e20 3d20 6e70     # psmean = np
+00030d10: 2e6d 6561 6e28 7073 6d61 702e 6675 6c6c  .mean(psmap.full
+00030d20: 4d61 7029 0a20 2020 2020 2020 2020 2020  Map).           
+00030d30: 2020 2020 2020 2020 2023 2070 7373 7464           # psstd
+00030d40: 203d 206e 702e 7374 6428 7073 6d61 702e   = np.std(psmap.
+00030d50: 6675 6c6c 4d61 7029 0a20 2020 2020 2020  fullMap).       
+00030d60: 2020 2020 2020 2020 2020 2020 2023 2070               # p
+00030d70: 736d 6170 2e66 756c 6c4d 6170 203d 206e  smap.fullMap = n
+00030d80: 702e 6162 7328 2870 736d 6170 2e66 756c  p.abs((psmap.ful
+00030d90: 6c4d 6170 202d 2070 736d 6561 6e29 202f  lMap - psmean) /
+00030da0: 2070 7373 7464 2920 2a2a 2032 0a20 2020   psstd) ** 2.   
+00030db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030dc0: 2070 736d 6561 6e20 3d20 6e70 2e6d 6561   psmean = np.mea
+00030dd0: 6e28 6666 746d 6170 290a 2020 2020 2020  n(fftmap).      
+00030de0: 2020 2020 2020 2020 2020 2020 2020 7073                ps
+00030df0: 7374 6420 3d20 6e70 2e73 7464 2866 6674  std = np.std(fft
+00030e00: 6d61 7029 0a20 2020 2020 2020 2020 2020  map).           
+00030e10: 2020 2020 2020 2020 2066 6674 6d61 7020           fftmap 
+00030e20: 3d20 6e70 2e61 6273 2828 6666 746d 6170  = np.abs((fftmap
+00030e30: 202d 2070 736d 6561 6e29 202f 2070 7373   - psmean) / pss
+00030e40: 7464 2920 2a2a 2032 0a0a 2020 2020 2020  td) ** 2..      
+00030e50: 2020 2020 2020 2020 2020 2020 2020 6d69                mi
+00030e60: 6473 7461 7274 203d 2074 696d 6569 742e  dstart = timeit.
+00030e70: 6465 6661 756c 745f 7469 6d65 7228 2920  default_timer() 
+00030e80: 2d20 7374 6172 740a 2020 2020 2020 2020  - start.        
+00030e90: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+00030ea0: 7428 2720 2d2d 2052 4150 5320 466f 7572  t(' -- RAPS Four
+00030eb0: 6965 722d 7472 616e 7366 6f72 6d61 7469  ier-transformati
+00030ec0: 6f6e 2074 696d 653a 2025 7327 2025 206d  on time: %s' % m
+00030ed0: 6964 7374 6172 7429 0a0a 2020 2020 2020  idstart)..      
+00030ee0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00030ef0: 7a67 7269 6420 3d20 6e70 2e61 7261 6e67  zgrid = np.arang
+00030f00: 6528 666c 6f6f 7228 7073 6d61 702e 7a5f  e(floor(psmap.z_
+00030f10: 7369 7a65 2829 202f 2032 2e30 2920 2a20  size() / 2.0) * 
+00030f20: 2d31 2c20 6365 696c 2870 736d 6170 2e7a  -1, ceil(psmap.z
+00030f30: 5f73 697a 6528 2920 2f20 322e 3029 2920  _size() / 2.0)) 
+00030f40: 2f20 666c 6f61 7428 666c 6f6f 7228 7073  / float(floor(ps
+00030f50: 6d61 702e 7a5f 7369 7a65 2829 2929 0a20  map.z_size())). 
+00030f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00030f70: 2020 2023 2079 6772 6964 203d 206e 702e     # ygrid = np.
+00030f80: 6172 616e 6765 2866 6c6f 6f72 2870 736d  arange(floor(psm
+00030f90: 6170 2e79 5f73 697a 6528 2920 2f20 322e  ap.y_size() / 2.
+00030fa0: 3029 202a 202d 312c 2063 6569 6c28 7073  0) * -1, ceil(ps
+00030fb0: 6d61 702e 795f 7369 7a65 2829 202f 2032  map.y_size() / 2
+00030fc0: 2e30 2929 202f 2066 6c6f 6174 2866 6c6f  .0)) / float(flo
+00030fd0: 6f72 2870 736d 6170 2e79 5f73 697a 6528  or(psmap.y_size(
+00030fe0: 2929 290a 2020 2020 2020 2020 2020 2020  ))).            
+00030ff0: 2020 2020 2020 2020 2320 7867 7269 6420          # xgrid 
+00031000: 3d20 6e70 2e61 7261 6e67 6528 666c 6f6f  = np.arange(floo
+00031010: 7228 7073 6d61 702e 785f 7369 7a65 2829  r(psmap.x_size()
+00031020: 202f 2032 2e30 2920 2a20 2d31 2c20 6365   / 2.0) * -1, ce
+00031030: 696c 2870 736d 6170 2e78 5f73 697a 6528  il(psmap.x_size(
+00031040: 2920 2f20 322e 3029 2920 2f20 666c 6f61  ) / 2.0)) / floa
+00031050: 7428 666c 6f6f 7228 7073 6d61 702e 785f  t(floor(psmap.x_
+00031060: 7369 7a65 2829 2929 0a20 2020 2020 2020  size())).       
+00031070: 2020 2020 2020 2020 2020 2020 207a 6772               zgr
+00031080: 6964 203d 206e 702e 6172 616e 6765 2866  id = np.arange(f
+00031090: 6c6f 6f72 286d 6170 5f7a 7369 7a65 202f  loor(map_zsize /
+000310a0: 2032 2e30 2920 2a20 2d31 2c20 6365 696c   2.0) * -1, ceil
+000310b0: 286d 6170 5f7a 7369 7a65 202f 2032 2e30  (map_zsize / 2.0
+000310c0: 2929 202f 2066 6c6f 6174 2866 6c6f 6f72  )) / float(floor
+000310d0: 286d 6170 5f7a 7369 7a65 2929 0a20 2020  (map_zsize)).   
+000310e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000310f0: 2079 6772 6964 203d 206e 702e 6172 616e   ygrid = np.aran
+00031100: 6765 2866 6c6f 6f72 286d 6170 5f79 7369  ge(floor(map_ysi
+00031110: 7a65 202f 2032 2e30 2920 2a20 2d31 2c20  ze / 2.0) * -1, 
+00031120: 6365 696c 286d 6170 5f79 7369 7a65 202f  ceil(map_ysize /
+00031130: 2032 2e30 2929 202f 2066 6c6f 6174 2866   2.0)) / float(f
+00031140: 6c6f 6f72 286d 6170 5f79 7369 7a65 2929  loor(map_ysize))
+00031150: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00031160: 2020 2020 2078 6772 6964 203d 206e 702e       xgrid = np.
+00031170: 6172 616e 6765 2866 6c6f 6f72 286d 6170  arange(floor(map
+00031180: 5f78 7369 7a65 202f 2032 2e30 2920 2a20  _xsize / 2.0) * 
+00031190: 2d31 2c20 6365 696c 286d 6170 5f78 7369  -1, ceil(map_xsi
+000311a0: 7a65 202f 2032 2e30 2929 202f 2066 6c6f  ze / 2.0)) / flo
+000311b0: 6174 2866 6c6f 6f72 286d 6170 5f78 7369  at(floor(map_xsi
+000311c0: 7a65 2929 0a20 2020 2020 2020 2020 2020  ze)).           
+000311d0: 2020 2020 2020 2020 2023 207a 6772 6964           # zgrid
+000311e0: 203d 206e 702e 6172 616e 6765 2866 6c6f   = np.arange(flo
+000311f0: 6f72 2870 736d 6170 2e7a 5f73 697a 6528  or(psmap.z_size(
+00031200: 292a 3220 2f20 322e 3029 202a 202d 312c  )*2 / 2.0) * -1,
+00031210: 2063 6569 6c28 7073 6d61 702e 7a5f 7369   ceil(psmap.z_si
+00031220: 7a65 2829 2a32 202f 2032 2e30 2929 202f  ze()*2 / 2.0)) /
+00031230: 2066 6c6f 6174 2866 6c6f 6f72 2870 736d   float(floor(psm
+00031240: 6170 2e7a 5f73 697a 6528 2929 290a 2020  ap.z_size())).  
+00031250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031260: 2020 2320 7967 7269 6420 3d20 6e70 2e61    # ygrid = np.a
+00031270: 7261 6e67 6528 666c 6f6f 7228 7073 6d61  range(floor(psma
+00031280: 702e 795f 7369 7a65 2829 2a32 202f 2032  p.y_size()*2 / 2
+00031290: 2e30 2920 2a20 2d31 2c20 6365 696c 2870  .0) * -1, ceil(p
+000312a0: 736d 6170 2e79 5f73 697a 6528 292a 3220  smap.y_size()*2 
+000312b0: 2f20 322e 3029 2920 2f20 666c 6f61 7428  / 2.0)) / float(
+000312c0: 666c 6f6f 7228 7073 6d61 702e 795f 7369  floor(psmap.y_si
+000312d0: 7a65 2829 2929 0a20 2020 2020 2020 2020  ze())).         
+000312e0: 2020 2020 2020 2020 2020 2023 2078 6772             # xgr
+000312f0: 6964 203d 206e 702e 6172 616e 6765 2866  id = np.arange(f
+00031300: 6c6f 6f72 2870 736d 6170 2e78 5f73 697a  loor(psmap.x_siz
+00031310: 6528 292a 3220 2f20 322e 3029 202a 202d  e()*2 / 2.0) * -
+00031320: 312c 2063 6569 6c28 7073 6d61 702e 785f  1, ceil(psmap.x_
+00031330: 7369 7a65 2829 2a32 202f 2032 2e30 2929  size()*2 / 2.0))
+00031340: 202f 2066 6c6f 6174 2866 6c6f 6f72 2870   / float(floor(p
+00031350: 736d 6170 2e78 5f73 697a 6528 2929 290a  smap.x_size())).
+00031360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031370: 2020 2020 7864 6973 203d 2078 6772 6964      xdis = xgrid
+00031380: 202a 2a20 320a 2020 2020 2020 2020 2020   ** 2.          
+00031390: 2020 2020 2020 2020 2020 7964 6973 203d            ydis =
+000313a0: 2079 6772 6964 202a 2a20 320a 2020 2020   ygrid ** 2.    
+000313b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000313c0: 7a64 6973 203d 207a 6772 6964 202a 2a20  zdis = zgrid ** 
+000313d0: 320a 2020 2020 2020 2020 2020 2020 2020  2.              
+000313e0: 2020 2020 2020 6469 7374 203d 206e 702e        dist = np.
+000313f0: 7371 7274 287a 6469 735b 3a2c 204e 6f6e  sqrt(zdis[:, Non
+00031400: 652c 204e 6f6e 655d 202b 2079 6469 735b  e, None] + ydis[
+00031410: 3a2c 204e 6f6e 655d 202b 2078 6469 7329  :, None] + xdis)
+00031420: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00031430: 2020 2020 2020 616c 6c61 7869 7320 3d20        allaxis = 
+00031440: 5b7a 6772 6964 2c20 7967 7269 642c 2078  [zgrid, ygrid, x
+00031450: 6772 6964 5d0a 2020 2020 2020 2020 2020  grid].          
+00031460: 2020 2020 2020 2020 2020 746d 7069 6e64            tmpind
+00031470: 6961 7869 7320 3d20 6d61 7828 616c 6c61  iaxis = max(alla
+00031480: 7869 732c 206b 6579 3d6c 656e 290a 2020  xis, key=len).  
+00031490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000314a0: 2020 696e 6469 6178 6973 7420 3d20 746d    indiaxist = tm
+000314b0: 7069 6e64 6961 7869 735b 746d 7069 6e64  pindiaxis[tmpind
+000314c0: 6961 7869 7320 3e3d 2030 5d0a 2020 2020  iaxis >= 0].    
+000314d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000314e0: 2320 696e 6469 6178 6973 7420 3d20 6e70  # indiaxist = np
+000314f0: 2e61 7261 6e67 6528 302c 206e 702e 616d  .arange(0, np.am
+00031500: 6178 2874 6d70 696e 6469 6178 6973 292c  ax(tmpindiaxis),
+00031510: 302e 3031 3034 2029 0a20 2020 2020 2020  0.0104 ).       
+00031520: 2020 2020 2020 2020 2020 2020 2023 2069               # i
+00031530: 6e64 6961 7869 7374 203d 206e 702e 6c69  ndiaxist = np.li
+00031540: 6e73 7061 6365 2830 2c20 6e70 2e61 6d61  nspace(0, np.ama
+00031550: 7828 746d 7069 6e64 6961 7869 7329 2c20  x(tmpindiaxis), 
+00031560: 3230 3020 290a 2020 2020 2020 2020 2020  200 ).          
+00031570: 2020 2020 2020 2020 2020 696e 6469 6178            indiax
+00031580: 6973 203d 206e 702e 6c69 6e73 7061 6365  is = np.linspace
+00031590: 2830 2c20 3120 2f20 2832 202a 2061 7069  (0, 1 / (2 * api
+000315a0: 7829 2c20 6c65 6e28 696e 6469 6178 6973  x), len(indiaxis
+000315b0: 7429 290a 0a20 2020 2020 2020 2020 2020  t))..           
+000315c0: 2020 2020 2020 2020 2061 7073 203d 205b           aps = [
+000315d0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+000315e0: 2020 2020 2020 666f 7220 6920 696e 2072        for i in r
+000315f0: 616e 6765 286c 656e 2869 6e64 6961 7869  ange(len(indiaxi
+00031600: 7329 293a 0a20 2020 2020 2020 2020 2020  s)):.           
+00031610: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00031620: 6920 3d3d 2030 3a0a 2020 2020 2020 2020  i == 0:.        
+00031630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031640: 2020 2020 696e 6469 6365 7320 3d20 6e70      indices = np
+00031650: 2e61 7267 7768 6572 6528 6469 7374 203d  .argwhere(dist =
+00031660: 3d20 696e 6469 6178 6973 745b 695d 290a  = indiaxist[i]).
+00031670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031680: 2020 2020 2020 2020 2020 2020 2320 7073              # ps
+00031690: 756d 203d 206c 6f67 3130 2870 736d 6170  um = log10(psmap
+000316a0: 2e66 756c 6c4d 6170 5b74 7570 6c65 2869  .fullMap[tuple(i
+000316b0: 6e64 6963 6573 2e54 295d 2e73 756d 2829  ndices.T)].sum()
+000316c0: 202f 206c 656e 2869 6e64 6963 6573 2929   / len(indices))
+000316d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000316e0: 2020 2020 2020 2020 2020 2020 2070 7375               psu
+000316f0: 6d20 3d20 6c6f 6731 3028 6666 746d 6170  m = log10(fftmap
+00031700: 5b74 7570 6c65 2869 6e64 6963 6573 2e54  [tuple(indices.T
+00031710: 295d 2e73 756d 2829 202f 206c 656e 2869  )].sum() / len(i
+00031720: 6e64 6963 6573 2929 0a20 2020 2020 2020  ndices)).       
+00031730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031740: 2020 2020 2061 7073 2e61 7070 656e 6428       aps.append(
+00031750: 7073 756d 290a 2020 2020 2020 2020 2020  psum).          
+00031760: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00031770: 2069 2021 3d20 6c65 6e28 696e 6469 6178   i != len(indiax
+00031780: 6973 2920 2d20 313a 0a20 2020 2020 2020  is) - 1:.       
+00031790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000317a0: 2020 2020 2069 6e64 6963 6573 203d 206e       indices = n
+000317b0: 702e 6172 6777 6865 7265 2828 6469 7374  p.argwhere((dist
+000317c0: 203e 2069 6e64 6961 7869 7374 5b69 5d29   > indiaxist[i])
+000317d0: 2026 2028 6469 7374 203c 3d20 696e 6469   & (dist <= indi
+000317e0: 6178 6973 745b 6920 2b20 315d 2929 0a20  axist[i + 1])). 
+000317f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031800: 2020 2020 2020 2020 2020 2023 2070 7375             # psu
+00031810: 6d20 3d20 6c6f 6731 3028 7073 6d61 702e  m = log10(psmap.
+00031820: 6675 6c6c 4d61 705b 7475 706c 6528 696e  fullMap[tuple(in
+00031830: 6469 6365 732e 5429 5d2e 7375 6d28 2920  dices.T)].sum() 
+00031840: 2f20 6c65 6e28 696e 6469 6365 7329 290a  / len(indices)).
+00031850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031860: 2020 2020 2020 2020 2020 2020 7073 756d              psum
+00031870: 203d 206c 6f67 3130 2866 6674 6d61 705b   = log10(fftmap[
+00031880: 7475 706c 6528 696e 6469 6365 732e 5429  tuple(indices.T)
+00031890: 5d2e 7375 6d28 2920 2f20 6c65 6e28 696e  ].sum() / len(in
+000318a0: 6469 6365 7329 290a 2020 2020 2020 2020  dices)).        
+000318b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000318c0: 2020 2020 6170 732e 6170 7065 6e64 2870      aps.append(p
+000318d0: 7375 6d29 0a20 2020 2020 2020 2020 2020  sum).           
+000318e0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+000318f0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00031900: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00031910: 6173 730a 2020 2020 2020 2020 2020 2020  ass.            
+00031920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031930: 2320 696e 6469 6365 7320 3d20 6e70 2e61  # indices = np.a
+00031940: 7267 7768 6572 6528 6469 7374 203d 3d20  rgwhere(dist == 
+00031950: 696e 6469 6178 6973 745b 695d 290a 2020  indiaxist[i]).  
+00031960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031970: 2020 2020 2020 2020 2020 2320 7073 756d            # psum
+00031980: 203d 206c 6f67 3130 2870 736d 6170 2e66   = log10(psmap.f
+00031990: 756c 6c4d 6170 5b74 7570 6c65 2869 6e64  ullMap[tuple(ind
+000319a0: 6963 6573 2e54 295d 2e73 756d 2829 202f  ices.T)].sum() /
+000319b0: 206c 656e 2869 6e64 6963 6573 2929 0a20   len(indices)). 
+000319c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000319d0: 2020 2020 2020 2020 2020 2023 2061 7073             # aps
+000319e0: 2e61 7070 656e 6428 7073 756d 290a 2020  .append(psum).  
+000319f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031a00: 2020 7072 696e 7428 6170 7329 0a20 2020    print(aps).   
+00031a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031a20: 2069 6620 6170 735b 305d 203c 2030 3a0a   if aps[0] < 0:.
+00031a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031a40: 2020 2020 2020 2020 6170 735b 305d 203d          aps[0] =
+00031a50: 2061 7073 5b31 5d0a 2020 2020 2020 2020   aps[1].        
+00031a60: 2020 2020 2020 2020 2020 2020 6461 7461              data
+00031a70: 6469 6374 203d 207b 6c61 6265 6c20 2b20  dict = {label + 
+00031a80: 2772 6f74 6174 696f 6e61 6c6c 795f 6176  'rotationally_av
+00031a90: 6572 6167 6564 5f70 6f77 6572 5f73 7065  eraged_power_spe
+00031aa0: 6374 7275 6d27 3a20 207b 2779 273a 206e  ctrum':  {'y': n
+00031ab0: 702e 726f 756e 6428 6170 732c 2031 3029  p.round(aps, 10)
+00031ac0: 2e74 6f6c 6973 7428 292c 0a20 2020 2020  .tolist(),.     
+00031ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00031af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031b00: 2020 2066 6f72 207a 2069 6e20 7261 6e67     for z in rang
-00031b10: 6528 696e 7428 7a5f 6d69 6e29 2c20 7a5f  e(int(z_min), z_
-00031b20: 6d61 7829 3a0a 2020 2020 2020 2020 2020  max):.          
-00031b30: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00031b40: 7072 696e 7428 782c 2079 2c20 7a29 0a20  print(x, y, z). 
-00031b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031b60: 2020 2020 2020 2064 203d 206d 6174 682e         d = math.
-00031b70: 7371 7274 2878 795f 6469 7374 202a 2a20  sqrt(xy_dist ** 
-00031b80: 3220 2b20 2828 7a20 2d20 4f31 5b32 5d29  2 + ((z - O1[2])
-00031b90: 202a 2a20 3229 290a 2020 2020 2020 2020   ** 2)).        
-00031ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031bb0: 6966 2064 3120 3c20 6420 3c3d 2064 323a  if d1 < d <= d2:
-00031bc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00031bd0: 2020 2020 2020 2020 2020 2020 2069 6e64               ind
-00031be0: 6963 6573 2e61 7070 656e 6428 5b78 2c20  ices.append([x, 
-00031bf0: 792c 207a 5d29 0a20 2020 2020 2020 2061  y, z]).        a
-00031c00: 6c6c 5f69 6e64 203d 2073 656c 662e 6170  ll_ind = self.ap
-00031c10: 706c 795f 3364 5f73 796d 6d65 7472 7928  ply_3d_symmetry(
-00031c20: 696e 6469 6365 732c 204f 3129 2e61 7374  indices, O1).ast
-00031c30: 7970 6528 696e 7429 0a20 2020 2020 2020  ype(int).       
-00031c40: 2072 6574 7572 6e20 616c 6c5f 696e 640a   return all_ind.
-00031c50: 0a20 2020 2023 2040 7072 6f66 696c 650a  .    # @profile.
-00031c60: 2020 2020 6465 6620 6e65 775f 7261 7073      def new_raps
-00031c70: 2873 656c 662c 206d 6170 696e 3d4e 6f6e  (self, mapin=Non
-00031c80: 652c 2077 6f72 6b64 6972 3d4e 6f6e 652c  e, workdir=None,
-00031c90: 206c 6162 656c 3d27 2729 3a0a 2020 2020   label=''):.    
-00031ca0: 2020 2020 2222 220a 0a20 2020 2020 2020      """..       
-00031cb0: 2020 2020 2043 616c 6375 6c61 7469 6f6e       Calculation
-00031cc0: 206f 6620 7468 6520 726f 7461 7469 6f6e   of the rotation
-00031cd0: 616c 6c79 2061 7665 7261 6765 2070 6f77  ally average pow
-00031ce0: 6572 2073 7065 6374 7275 6d20 2852 4150  er spectrum (RAP
-00031cf0: 5329 0a20 2020 2020 2020 2020 2020 2052  S).            R
-00031d00: 6573 756c 7473 2077 726f 7465 2074 6f20  esults wrote to 
-00031d10: 4a53 4f4e 2066 696c 650a 0a20 2020 2020  JSON file..     
-00031d20: 2020 203a 7265 7475 726e 3a20 4e6f 6e65     :return: None
-00031d30: 0a0a 2020 2020 2020 2020 2222 220a 0a20  ..        """.. 
-00031d40: 2020 2020 2020 206d 6170 2c20 776f 726b         map, work
-00031d50: 6469 7220 3d20 7365 6c66 2e6d 6170 696e  dir = self.mapin
-00031d60: 6368 6563 6b28 6d61 7069 6e2c 2077 6f72  check(mapin, wor
-00031d70: 6b64 6972 290a 2020 2020 2020 2020 6d61  kdir).        ma
-00031d80: 706e 616d 6520 3d20 6f73 2e70 6174 682e  pname = os.path.
-00031d90: 6261 7365 6e61 6d65 286d 6170 2e66 756c  basename(map.ful
-00031da0: 6c6e 616d 6529 0a20 2020 2020 2020 2061  lname).        a
-00031db0: 7069 785f 6c69 7374 203d 206d 6170 2e76  pix_list = map.v
-00031dc0: 6f78 656c 5f73 697a 652e 746f 6c69 7374  oxel_size.tolist
-00031dd0: 2829 0a20 2020 2020 2020 2061 7069 7873  ().        apixs
-00031de0: 203d 2028 6170 6978 5f6c 6973 745b 305d   = (apix_list[0]
-00031df0: 2c20 6170 6978 5f6c 6973 745b 315d 2c20  , apix_list[1], 
-00031e00: 6170 6978 5f6c 6973 745b 325d 290a 0a20  apix_list[2]).. 
-00031e10: 2020 2020 2020 2069 6620 6d61 7020 6973         if map is
-00031e20: 206e 6f74 204e 6f6e 6520 616e 6420 776f   not None and wo
-00031e30: 726b 6469 7220 6973 206e 6f74 204e 6f6e  rkdir is not Non
-00031e40: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
-00031e50: 2069 6620 6d61 702e 785f 7369 7a65 2829   if map.x_size()
-00031e60: 203d 3d20 6d61 702e 795f 7369 7a65 2829   == map.y_size()
-00031e70: 203d 3d20 6d61 702e 7a5f 7369 7a65 2829   == map.z_size()
-00031e80: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00031e90: 206d 6170 2e68 6561 6465 722e 6e78 203d   map.header.nx =
-00031ea0: 3d20 6d61 702e 6865 6164 6572 2e6e 7920  = map.header.ny 
-00031eb0: 3d3d 206d 6170 2e68 6561 6465 722e 6e7a  == map.header.nz
-00031ec0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00031ed0: 2020 6572 726c 6973 7420 3d20 5b5d 0a20    errlist = []. 
-00031ee0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00031ef0: 7461 7274 203d 2074 696d 6569 742e 6465  tart = timeit.de
-00031f00: 6661 756c 745f 7469 6d65 7228 290a 2020  fault_timer().  
-00031f10: 2020 2020 2020 2020 2020 2020 2020 6461                da
-00031f20: 7461 6469 6374 203d 2064 6963 7428 290a  tadict = dict().
-00031f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031f40: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00031f50: 2020 2020 2020 2020 2023 206d 6170 203d           # map =
-00031f60: 2073 656c 662e 6d61 700a 2020 2020 2020   self.map.      
-00031f70: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00031f80: 7465 6d70 7261 7279 2073 6f6c 7574 696f  temprary solutio
-00031f90: 6e20 6173 2074 6865 2074 656d 7079 2067  n as the tempy g
-00031fa0: 6976 6520 6170 6978 2061 7320 6f6e 6520  ive apix as one 
-00031fb0: 7661 6c75 6520 6275 7420 6865 7265 2066  value but here f
-00031fc0: 726f 6d20 6d72 6366 696c 6520 7765 2075  rom mrcfile we u
-00031fd0: 7365 2061 2074 7570 6c65 0a20 2020 2020  se a tuple.     
-00031fe0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00031ff0: 2069 6620 7479 7065 286d 6170 2e61 7069   if type(map.api
-00032000: 7829 2069 7320 7475 706c 653a 0a20 2020  x) is tuple:.   
-00032010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032020: 2069 6620 7479 7065 2861 7069 7873 2920   if type(apixs) 
-00032030: 6973 2074 7570 6c65 3a0a 2020 2020 2020  is tuple:.      
-00032040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032050: 2020 6170 6978 203d 2061 7069 7873 5b30    apix = apixs[0
-00032060: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00032070: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00032080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032090: 2020 2020 6170 6978 203d 2061 7069 7873      apix = apixs
-000320a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000320b0: 2020 2020 2066 6674 6d61 7020 3d20 6666       fftmap = ff
-000320c0: 7473 6869 6674 2866 6674 6e28 6d61 702e  tshift(fftn(map.
-000320d0: 6461 7461 2929 0a20 2020 2020 2020 2020  data)).         
-000320e0: 2020 2020 2020 2020 2020 2070 736d 6561             psmea
-000320f0: 6e20 3d20 6e70 2e6d 6561 6e28 6666 746d  n = np.mean(fftm
-00032100: 6170 290a 2020 2020 2020 2020 2020 2020  ap).            
-00032110: 2020 2020 2020 2020 7073 7374 6420 3d20          psstd = 
-00032120: 6e70 2e73 7464 2866 6674 6d61 7029 0a20  np.std(fftmap). 
-00032130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032140: 2020 2066 6674 6d61 7020 3d20 6e70 2e61     fftmap = np.a
-00032150: 6273 2828 6666 746d 6170 202d 2070 736d  bs((fftmap - psm
-00032160: 6561 6e29 202f 2070 7373 7464 2920 2a2a  ean) / psstd) **
-00032170: 2032 0a0a 2020 2020 2020 2020 2020 2020   2..            
-00032180: 2020 2020 2020 2020 6d69 6473 7461 7274          midstart
-00032190: 203d 2074 696d 6569 742e 6465 6661 756c   = timeit.defaul
-000321a0: 745f 7469 6d65 7228 2920 2d20 7374 6172  t_timer() - star
-000321b0: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
-000321c0: 2020 2020 2020 7072 696e 7428 2720 2d2d        print(' --
-000321d0: 2052 4150 5320 466f 7572 6965 722d 7472   RAPS Fourier-tr
-000321e0: 616e 7366 6f72 6d61 7469 6f6e 2074 696d  ansformation tim
-000321f0: 653a 2025 7327 2025 206d 6964 7374 6172  e: %s' % midstar
-00032200: 7429 0a0a 2020 2020 2020 2020 2020 2020  t)..            
-00032210: 2020 2020 2020 2020 2323 2061 7070 6c79          ## apply
-00032220: 696e 6720 6e65 7720 696e 6469 6365 7320  ing new indices 
-00032230: 6675 6e63 7469 6f6e 0a20 2020 2020 2020  function.       
-00032240: 2020 2020 2020 2020 2020 2020 206d 6170               map
-00032250: 5f73 6861 7065 203d 2066 6674 6d61 702e  _shape = fftmap.
-00032260: 7368 6170 650a 2020 2020 2020 2020 2020  shape.          
-00032270: 2020 2020 2020 2020 2020 6170 7320 3d20            aps = 
-00032280: 5b5d 0a20 2020 2020 2020 2020 2020 2020  [].             
-00032290: 2020 2020 2020 2069 6620 6d61 705f 7368         if map_sh
-000322a0: 6170 655b 305d 2025 2032 203d 3d20 303a  ape[0] % 2 == 0:
-000322b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000322c0: 2020 2020 2020 2020 206f 7267 203d 205b           org = [
-000322d0: 6d61 705f 7368 6170 655b 305d 202f 2032  map_shape[0] / 2
-000322e0: 2c20 6d61 705f 7368 6170 655b 315d 202f  , map_shape[1] /
-000322f0: 2032 2c20 6d61 705f 7368 6170 655b 325d   2, map_shape[2]
-00032300: 202f 2032 5d0a 2020 2020 2020 2020 2020   / 2].          
-00032310: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00031b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031b10: 2020 2020 2778 273a 206e 702e 726f 756e      'x': np.roun
+00031b20: 6428 696e 6469 6178 6973 2c20 3130 292e  d(indiaxis, 10).
+00031b30: 746f 6c69 7374 2829 7d7d 0a20 2020 2020  tolist()}}.     
+00031b40: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00031b50: 6c74 2e66 6967 7572 6528 6669 6773 697a  lt.figure(figsiz
+00031b60: 653d 2831 302c 2033 2929 0a20 2020 2020  e=(10, 3)).     
+00031b70: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00031b80: 6c74 2e70 6c6f 7428 6e70 2e72 6f75 6e64  lt.plot(np.round
+00031b90: 2869 6e64 6961 7869 732c 2034 292e 746f  (indiaxis, 4).to
+00031ba0: 6c69 7374 2829 2c20 6e70 2e72 6f75 6e64  list(), np.round
+00031bb0: 2861 7073 2c20 3429 2e74 6f6c 6973 7428  (aps, 4).tolist(
+00031bc0: 292c 2029 0a20 2020 2020 2020 2020 2020  ), ).           
+00031bd0: 2020 2020 2020 2020 2070 6c74 2e73 6176           plt.sav
+00031be0: 6566 6967 2877 6f72 6b64 6972 202b 2073  efig(workdir + s
+00031bf0: 656c 662e 6d61 706e 616d 6520 2b20 275f  elf.mapname + '_
+00031c00: 7261 7073 2e70 6e67 2729 0a20 2020 2020  raps.png').     
+00031c10: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00031c20: 6c74 2e63 6c6f 7365 2829 0a0a 2020 2020  lt.close()..    
+00031c30: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+00031c40: 7074 3a0a 2020 2020 2020 2020 2020 2020  pt:.            
+00031c50: 2020 2020 2020 2020 6572 7220 3d20 2752          err = 'R
+00031c60: 4150 5320 6361 6c63 756c 6174 696f 6e20  APS calculation 
+00031c70: 6572 726f 723a 207b 7d2e 272e 666f 726d  error: {}.'.form
+00031c80: 6174 2873 7973 2e65 7863 5f69 6e66 6f28  at(sys.exc_info(
+00031c90: 295b 315d 290a 2020 2020 2020 2020 2020  )[1]).          
+00031ca0: 2020 2020 2020 2020 2020 6572 726c 6973            errlis
+00031cb0: 742e 6170 7065 6e64 2865 7272 290a 2020  t.append(err).  
+00031cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031cd0: 2020 7379 732e 7374 6465 7272 2e77 7269    sys.stderr.wri
+00031ce0: 7465 2865 7272 202b 2027 5c6e 2729 0a0a  te(err + '\n')..
+00031cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031d00: 6966 2065 7272 6c69 7374 3a0a 2020 2020  if errlist:.    
+00031d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031d20: 6461 7461 6469 6374 203d 207b 2772 6f74  datadict = {'rot
+00031d30: 6174 696f 6e61 6c6c 795f 6176 6572 6167  ationally_averag
+00031d40: 6564 5f70 6f77 6572 5f73 7065 6374 7275  ed_power_spectru
+00031d50: 6d27 3a20 7b27 6572 7227 3a20 7b27 7261  m': {'err': {'ra
+00031d60: 7073 5f65 7272 273a 2065 7272 6c69 7374  ps_err': errlist
+00031d70: 7d7d 7d0a 0a20 2020 2020 2020 2020 2020  }}}..           
+00031d80: 2020 2020 2069 6620 626f 6f6c 2864 6174       if bool(dat
+00031d90: 6164 6963 7429 3a0a 2020 2020 2020 2020  adict):.        
+00031da0: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+00031db0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00031dc0: 2020 2020 2020 2020 2077 6974 6820 636f           with co
+00031dd0: 6465 6373 2e6f 7065 6e28 776f 726b 6469  decs.open(workdi
+00031de0: 7220 2b20 6d61 706e 616d 6520 2b20 275f  r + mapname + '_
+00031df0: 7261 7073 2e6a 736f 6e27 2c20 2777 272c  raps.json', 'w',
+00031e00: 2065 6e63 6f64 696e 673d 2775 7466 2d38   encoding='utf-8
+00031e10: 2729 2061 7320 663a 0a20 2020 2020 2020  ') as f:.       
+00031e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031e30: 2020 2020 206a 736f 6e2e 6475 6d70 2864       json.dump(d
+00031e40: 6174 6164 6963 742c 2066 290a 2020 2020  atadict, f).    
+00031e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031e60: 6578 6365 7074 3a0a 2020 2020 2020 2020  except:.        
+00031e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031e80: 7379 732e 7374 6465 7272 2e77 7269 7465  sys.stderr.write
+00031e90: 2827 5361 7669 6e67 2052 4150 5320 746f  ('Saving RAPS to
+00031ea0: 206a 736f 6e20 6572 726f 723a 207b 7d2e   json error: {}.
+00031eb0: 272e 666f 726d 6174 2873 7973 2e65 7863  '.format(sys.exc
+00031ec0: 5f69 6e66 6f28 295b 315d 2929 0a20 2020  _info()[1])).   
+00031ed0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+00031ee0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00031ef0: 2020 2020 2020 2073 7973 2e73 7464 6572         sys.stder
+00031f00: 722e 7772 6974 6528 274e 6f20 7261 7073  r.write('No raps
+00031f10: 2064 6174 6120 696e 2074 6865 2064 6963   data in the dic
+00031f20: 7469 6f6e 6172 792c 206e 6f20 7261 7073  tionary, no raps
+00031f30: 206a 736f 6e20 6669 6c65 2e5c 6e27 290a   json file.\n').
+00031f40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00031f50: 2065 6e64 203d 2074 696d 6569 742e 6465   end = timeit.de
+00031f60: 6661 756c 745f 7469 6d65 7228 290a 2020  fault_timer().  
+00031f70: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+00031f80: 696e 7428 2752 4150 5320 7469 6d65 2066  int('RAPS time f
+00031f90: 6f72 2025 733a 2025 7327 2025 2028 6d61  or %s: %s' % (ma
+00031fa0: 706e 616d 652c 2065 6e64 202d 2073 7461  pname, end - sta
+00031fb0: 7274 2929 0a20 2020 2020 2020 2020 2020  rt)).           
+00031fc0: 2020 2020 2070 7269 6e74 2827 2d2d 2d2d       print('----
+00031fd0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00031fe0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00031ff0: 2729 0a20 2020 2020 2020 2020 2020 2065  ').            e
+00032000: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00032010: 2020 2020 2070 7269 6e74 2827 4e6f 2052       print('No R
+00032020: 4150 5320 6361 6c63 756c 6174 696f 6e20  APS calculation 
+00032030: 666f 7220 6e6f 6e2d 6375 6269 6320 6d61  for non-cubic ma
+00032040: 702e 2729 0a20 2020 2020 2020 2020 2020  p.').           
+00032050: 2020 2020 2070 7269 6e74 2827 2d2d 2d2d       print('----
+00032060: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00032070: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00032080: 2729 0a0a 2020 2020 2020 2020 2020 2020  ')..            
+00032090: 2020 2020 7265 7475 726e 204e 6f6e 650a      return None.
+000320a0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+000320b0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+000320c0: 274e 6f20 5241 5053 2077 6974 686f 7574  'No RAPS without
+000320d0: 2070 726f 7065 7220 6d61 7020 696e 7075   proper map inpu
+000320e0: 7420 616e 6420 7468 6520 6f75 7470 7574  t and the output
+000320f0: 2064 6972 6563 746f 7279 2069 6e66 6f72   directory infor
+00032100: 6d61 7469 6f6e 2e27 290a 0a0a 2020 2020  mation.')...    
+00032110: 2320 4265 6c6f 7720 4865 7265 2069 7320  # Below Here is 
+00032120: 7468 6520 7465 7374 206e 6577 2072 6170  the test new rap
+00032130: 7320 6675 6e63 7469 6f6e 2061 7265 610a  s function area.
+00032140: 0a20 2020 2064 6566 2061 7070 6c79 5f33  .    def apply_3
+00032150: 645f 7379 6d6d 6574 7279 2873 656c 662c  d_symmetry(self,
+00032160: 2069 6e64 732c 206f 7269 6769 6e29 3a0a   inds, origin):.
+00032170: 2020 2020 2020 2020 4f20 3d20 6f72 6967          O = orig
+00032180: 696e 0a20 2020 2020 2020 206f 7065 7261  in.        opera
+00032190: 746f 7273 203d 205b 5b6e 702e 6172 7261  tors = [[np.arra
+000321a0: 7928 5b2d 312c 2031 2c20 315d 292c 205b  y([-1, 1, 1]), [
+000321b0: 4f5b 305d 202a 2032 2c20 302c 2030 5d5d  O[0] * 2, 0, 0]]
+000321c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000321d0: 2020 2020 2020 205b 6e70 2e61 7272 6179         [np.array
+000321e0: 285b 312c 2031 2c20 2d31 5d29 2c20 5b30  ([1, 1, -1]), [0
+000321f0: 2c20 302c 204f 5b32 5d20 2a20 325d 5d2c  , 0, O[2] * 2]],
+00032200: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00032210: 2020 2020 2020 2320 5b6e 702e 6172 7261        # [np.arra
+00032220: 7928 5b31 2c20 2d31 2c20 315d 292c 205b  y([1, -1, 1]), [
+00032230: 302c 204f 5b31 5d20 2a20 322c 2030 5d5d  0, O[1] * 2, 0]]
+00032240: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00032250: 2020 2020 2020 2023 205b 6e70 2e61 7272         # [np.arr
+00032260: 6179 285b 2d31 2c20 2d31 2c20 315d 292c  ay([-1, -1, 1]),
+00032270: 205b 4f5b 305d 202a 2032 2c20 4f5b 315d   [O[0] * 2, O[1]
+00032280: 202a 2032 2c20 305d 5d2c 0a20 2020 2020   * 2, 0]],.     
+00032290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000322a0: 5b6e 702e 6172 7261 7928 5b2d 312c 2031  [np.array([-1, 1
+000322b0: 2c20 2d31 5d29 2c20 5b4f 5b30 5d20 2a20  , -1]), [O[0] * 
+000322c0: 322c 2030 2c20 4f5b 325d 202a 2032 5d5d  2, 0, O[2] * 2]]
+000322d0: 2c5d 0a20 2020 2020 2020 2020 2020 2020  ,].             
+000322e0: 2020 2020 2020 2020 2320 5b6e 702e 6172          # [np.ar
+000322f0: 7261 7928 5b31 2c20 2d31 2c20 2d31 5d29  ray([1, -1, -1])
+00032300: 2c20 5b30 2c20 4f5b 315d 202a 2032 2c20  , [0, O[1] * 2, 
+00032310: 4f5b 325d 202a 2032 5d5d 2c0a 2020 2020  O[2] * 2]],.    
 00032320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032330: 2020 2020 2020 2020 6f72 6720 3d20 5b28          org = [(
-00032340: 6d61 705f 7368 6170 655b 305d 202d 2031  map_shape[0] - 1
-00032350: 2920 2f20 322c 2028 6d61 705f 7368 6170  ) / 2, (map_shap
-00032360: 655b 315d 202d 2031 2920 2f20 322c 2028  e[1] - 1) / 2, (
-00032370: 6d61 705f 7368 6170 655b 325d 202d 2031  map_shape[2] - 1
-00032380: 2920 2f20 325d 0a20 2020 2020 2020 2020  ) / 2].         
-00032390: 2020 2020 2020 2020 2020 2069 6e64 6961             india
-000323a0: 7869 7320 3d20 6e70 2e6c 696e 7370 6163  xis = np.linspac
-000323b0: 6528 302c 2069 6e74 286f 7267 5b30 5d29  e(0, int(org[0])
-000323c0: 2c20 696e 7428 6f72 675b 305d 2920 2b20  , int(org[0]) + 
-000323d0: 3129 202f 2028 6d61 705f 7368 6170 655b  1) / (map_shape[
-000323e0: 305d 202a 2061 7069 7829 0a0a 2020 2020  0] * apix)..    
-000323f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032400: 7368 656c 6c5f 7261 6e67 6520 3d20 696e  shell_range = in
-00032410: 7428 6d61 7828 6d61 705f 7368 6170 6529  t(max(map_shape)
-00032420: 202d 206d 6178 286f 7267 2929 0a20 2020   - max(org)).   
-00032430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032440: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
-00032450: 302c 2073 6865 6c6c 5f72 616e 6765 293a  0, shell_range):
-00032460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00032470: 2020 2020 2020 2020 2069 6e64 6963 6573           indices
-00032480: 203d 2073 656c 662e 6765 6e65 7261 7465   = self.generate
-00032490: 5f73 6865 6c6c 2869 2c20 692b 312c 206d  _shell(i, i+1, m
-000324a0: 6170 5f73 6861 7065 290a 2020 2020 2020  ap_shape).      
-000324b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000324c0: 2020 7073 756d 203d 206c 6f67 3130 2866    psum = log10(f
-000324d0: 6674 6d61 705b 7475 706c 6528 696e 6469  ftmap[tuple(indi
-000324e0: 6365 732e 5429 5d2e 7375 6d28 2920 2f20  ces.T)].sum() / 
-000324f0: 6c65 6e28 696e 6469 6365 7329 290a 2020  len(indices)).  
-00032500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032510: 2020 2020 2020 6170 732e 6170 7065 6e64        aps.append
-00032520: 2870 7375 6d29 0a20 2020 2020 2020 2020  (psum).         
-00032530: 2020 2020 2020 2020 2020 2069 6620 6170             if ap
-00032540: 735b 305d 203c 2030 3a0a 2020 2020 2020  s[0] < 0:.      
-00032550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032560: 2020 6170 735b 305d 203d 2061 7073 5b31    aps[0] = aps[1
-00032570: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00032580: 2020 2020 2020 6966 206d 6170 5f73 6861        if map_sha
-00032590: 7065 5b30 5d20 2520 3220 3d3d 2030 3a0a  pe[0] % 2 == 0:.
-000325a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000325b0: 2020 2020 2020 2020 6170 732e 696e 7365          aps.inse
-000325c0: 7274 2830 2c20 6170 735b 305d 290a 0a20  rt(0, aps[0]).. 
-000325d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000325e0: 2020 2064 6174 6164 6963 7420 3d20 7b6c     datadict = {l
-000325f0: 6162 656c 202b 2027 726f 7461 7469 6f6e  abel + 'rotation
-00032600: 616c 6c79 5f61 7665 7261 6765 645f 706f  ally_averaged_po
-00032610: 7765 725f 7370 6563 7472 756d 273a 2020  wer_spectrum':  
-00032620: 7b27 7927 3a20 6e70 2e72 6f75 6e64 2861  {'y': np.round(a
-00032630: 7073 2c20 3130 292e 746f 6c69 7374 2829  ps, 10).tolist()
-00032640: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00032650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032680: 2020 2020 2020 2020 2020 2027 7827 3a20             'x': 
-00032690: 6e70 2e72 6f75 6e64 2869 6e64 6961 7869  np.round(indiaxi
-000326a0: 732c 2031 3029 2e74 6f6c 6973 7428 297d  s, 10).tolist()}
-000326b0: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-000326c0: 2020 2020 2020 6966 206e 6f74 206c 6162        if not lab
-000326d0: 656c 3a0a 2020 2020 2020 2020 2020 2020  el:.            
-000326e0: 2020 2020 2020 2020 2020 2020 706c 742e              plt.
-000326f0: 706c 6f74 286e 702e 726f 756e 6428 696e  plot(np.round(in
-00032700: 6469 6178 6973 2c20 3429 2e74 6f6c 6973  diaxis, 4).tolis
-00032710: 7428 292c 206e 702e 726f 756e 6428 6170  t(), np.round(ap
-00032720: 732c 2034 292e 746f 6c69 7374 2829 2c20  s, 4).tolist(), 
-00032730: 6c61 6265 6c3d 2752 4150 5327 290a 2020  label='RAPS').  
-00032740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032750: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00032760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032770: 706c 742e 706c 6f74 286e 702e 726f 756e  plt.plot(np.roun
-00032780: 6428 696e 6469 6178 6973 2c20 3429 2e74  d(indiaxis, 4).t
-00032790: 6f6c 6973 7428 292c 206e 702e 726f 756e  olist(), np.roun
-000327a0: 6428 6170 732c 2034 292e 746f 6c69 7374  d(aps, 4).tolist
-000327b0: 2829 2c20 6c61 6265 6c3d 2752 6177 206d  (), label='Raw m
-000327c0: 6170 2052 4150 5327 290a 2020 2020 2020  ap RAPS').      
-000327d0: 2020 2020 2020 2020 2020 2020 2020 706c                pl
-000327e0: 742e 6c65 6765 6e64 2829 0a20 2020 2020  t.legend().     
-000327f0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00032800: 6c74 2e73 6176 6566 6967 2877 6f72 6b64  lt.savefig(workd
-00032810: 6972 202b 2073 656c 662e 6d61 706e 616d  ir + self.mapnam
-00032820: 6520 2b20 275f 7261 7073 2e70 6e67 2729  e + '_raps.png')
-00032830: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00032840: 2020 6578 6365 7074 3a0a 2020 2020 2020    except:.      
-00032850: 2020 2020 2020 2020 2020 2020 2020 6572                er
-00032860: 7220 3d20 2752 4150 5320 6361 6c63 756c  r = 'RAPS calcul
-00032870: 6174 696f 6e20 6572 726f 723a 207b 7d2e  ation error: {}.
-00032880: 272e 666f 726d 6174 2873 7973 2e65 7863  '.format(sys.exc
-00032890: 5f69 6e66 6f28 295b 315d 290a 2020 2020  _info()[1]).    
-000328a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000328b0: 6572 726c 6973 742e 6170 7065 6e64 2865  errlist.append(e
-000328c0: 7272 290a 2020 2020 2020 2020 2020 2020  rr).            
-000328d0: 2020 2020 2020 2020 7379 732e 7374 6465          sys.stde
-000328e0: 7272 2e77 7269 7465 2865 7272 202b 2027  rr.write(err + '
-000328f0: 5c6e 2729 0a0a 2020 2020 2020 2020 2020  \n')..          
-00032900: 2020 2020 2020 6966 2065 7272 6c69 7374        if errlist
-00032910: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00032920: 2020 2020 2020 6461 7461 6469 6374 203d        datadict =
-00032930: 207b 2772 6f74 6174 696f 6e61 6c6c 795f   {'rotationally_
-00032940: 6176 6572 6167 6564 5f70 6f77 6572 5f73  averaged_power_s
-00032950: 7065 6374 7275 6d27 3a20 7b27 6572 7227  pectrum': {'err'
-00032960: 3a20 7b27 7261 7073 5f65 7272 273a 2065  : {'raps_err': e
-00032970: 7272 6c69 7374 7d7d 7d0a 0a20 2020 2020  rrlist}}}..     
-00032980: 2020 2020 2020 2020 2020 2069 6620 626f             if bo
-00032990: 6f6c 2864 6174 6164 6963 7429 3a0a 2020  ol(datadict):.  
-000329a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000329b0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-000329c0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-000329d0: 6974 6820 636f 6465 6373 2e6f 7065 6e28  ith codecs.open(
-000329e0: 776f 726b 6469 7220 2b20 6d61 706e 616d  workdir + mapnam
-000329f0: 6520 2b20 275f 7261 7073 2e6a 736f 6e27  e + '_raps.json'
-00032a00: 2c20 2777 272c 2065 6e63 6f64 696e 673d  , 'w', encoding=
-00032a10: 2775 7466 2d38 2729 2061 7320 663a 0a20  'utf-8') as f:. 
-00032a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032a30: 2020 2020 2020 2020 2020 206a 736f 6e2e             json.
-00032a40: 6475 6d70 2864 6174 6164 6963 742c 2066  dump(datadict, f
-00032a50: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00032a60: 2020 2020 2020 6578 6365 7074 3a0a 2020        except:.  
-00032a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032a80: 2020 2020 2020 7379 732e 7374 6465 7272        sys.stderr
-00032a90: 2e77 7269 7465 2827 5361 7669 6e67 2052  .write('Saving R
-00032aa0: 4150 5320 746f 206a 736f 6e20 6572 726f  APS to json erro
-00032ab0: 723a 207b 7d2e 272e 666f 726d 6174 2873  r: {}.'.format(s
-00032ac0: 7973 2e65 7863 5f69 6e66 6f28 295b 315d  ys.exc_info()[1]
-00032ad0: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-00032ae0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00032af0: 2020 2020 2020 2020 2020 2020 2073 7973               sys
-00032b00: 2e73 7464 6572 722e 7772 6974 6528 274e  .stderr.write('N
-00032b10: 6f20 7261 7073 2064 6174 6120 696e 2074  o raps data in t
-00032b20: 6865 2064 6963 7469 6f6e 6172 792c 206e  he dictionary, n
-00032b30: 6f20 7261 7073 206a 736f 6e20 6669 6c65  o raps json file
-00032b40: 2e5c 6e27 290a 0a20 2020 2020 2020 2020  .\n')..         
-00032b50: 2020 2020 2020 2065 6e64 203d 2074 696d         end = tim
-00032b60: 6569 742e 6465 6661 756c 745f 7469 6d65  eit.default_time
-00032b70: 7228 290a 2020 2020 2020 2020 2020 2020  r().            
-00032b80: 2020 2020 7072 696e 7428 2752 4150 5320      print('RAPS 
-00032b90: 7469 6d65 2066 6f72 2025 733a 2025 7327  time for %s: %s'
-00032ba0: 2025 2028 6d61 706e 616d 652c 2065 6e64   % (mapname, end
-00032bb0: 202d 2073 7461 7274 2929 0a20 2020 2020   - start)).     
-00032bc0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00032bd0: 2827 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ('--------------
-00032be0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00032bf0: 2d2d 2d2d 2d2d 2729 0a20 2020 2020 2020  ------').       
-00032c00: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00032c10: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00032c20: 2827 4e6f 2052 4150 5320 6361 6c63 756c  ('No RAPS calcul
-00032c30: 6174 696f 6e20 666f 7220 6e6f 6e2d 6375  ation for non-cu
-00032c40: 6269 6320 6d61 702e 2729 0a20 2020 2020  bic map.').     
-00032c50: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00032c60: 2827 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ('--------------
-00032c70: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00032c80: 2d2d 2d2d 2d2d 2729 0a0a 2020 2020 2020  ------')..      
-00032c90: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00032ca0: 204e 6f6e 650a 2020 2020 2020 2020 656c   None.        el
-00032cb0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00032cc0: 7072 696e 7428 274e 6f20 5241 5053 2077  print('No RAPS w
-00032cd0: 6974 686f 7574 2070 726f 7065 7220 6d61  ithout proper ma
-00032ce0: 7020 696e 7075 7420 616e 6420 7468 6520  p input and the 
-00032cf0: 6f75 7470 7574 2064 6972 6563 746f 7279  output directory
-00032d00: 2069 6e66 6f72 6d61 7469 6f6e 2e27 290a   information.').
-00032d10: 0a20 2020 2023 2041 626f 7665 2048 6572  .    # Above Her
-00032d20: 6520 6973 2074 6865 2074 6573 7420 6e65  e is the test ne
-00032d30: 7720 7261 7073 2066 756e 6374 696f 6e20  w raps function 
-00032d40: 6172 6561 0a0a 0a20 2020 2023 204e 6577  area...    # New
-00032d50: 2063 7572 7665 2069 6e74 6572 7365 6374   curve intersect
-00032d60: 696f 6e20 6675 6e63 7469 6f6e 730a 2020  ion functions.  
-00032d70: 2020 6465 6620 5f72 6563 745f 696e 7465    def _rect_inte
-00032d80: 725f 696e 6e65 7228 7365 6c66 2c20 7831  r_inner(self, x1
-00032d90: 2c20 7832 293a 0a20 2020 2020 2020 206e  , x2):.        n
-00032da0: 3120 3d20 7831 2e73 6861 7065 5b30 5d20  1 = x1.shape[0] 
-00032db0: 2d20 310a 2020 2020 2020 2020 6e32 203d  - 1.        n2 =
-00032dc0: 2078 322e 7368 6170 655b 305d 202d 2031   x2.shape[0] - 1
-00032dd0: 0a20 2020 2020 2020 2058 3120 3d20 6e70  .        X1 = np
-00032de0: 2e63 5f5b 7831 5b3a 2d31 5d2c 2078 315b  .c_[x1[:-1], x1[
-00032df0: 313a 5d5d 0a20 2020 2020 2020 2058 3220  1:]].        X2 
-00032e00: 3d20 6e70 2e63 5f5b 7832 5b3a 2d31 5d2c  = np.c_[x2[:-1],
-00032e10: 2078 325b 313a 5d5d 0a20 2020 2020 2020   x2[1:]].       
-00032e20: 2053 3120 3d20 6e70 2e74 696c 6528 5831   S1 = np.tile(X1
-00032e30: 2e6d 696e 2861 7869 733d 3129 2c20 286e  .min(axis=1), (n
-00032e40: 322c 2031 2929 2e54 0a20 2020 2020 2020  2, 1)).T.       
-00032e50: 2053 3220 3d20 6e70 2e74 696c 6528 5832   S2 = np.tile(X2
-00032e60: 2e6d 6178 2861 7869 733d 3129 2c20 286e  .max(axis=1), (n
-00032e70: 312c 2031 2929 0a20 2020 2020 2020 2053  1, 1)).        S
-00032e80: 3320 3d20 6e70 2e74 696c 6528 5831 2e6d  3 = np.tile(X1.m
-00032e90: 6178 2861 7869 733d 3129 2c20 286e 322c  ax(axis=1), (n2,
-00032ea0: 2031 2929 2e54 0a20 2020 2020 2020 2053   1)).T.        S
-00032eb0: 3420 3d20 6e70 2e74 696c 6528 5832 2e6d  4 = np.tile(X2.m
-00032ec0: 696e 2861 7869 733d 3129 2c20 286e 312c  in(axis=1), (n1,
-00032ed0: 2031 2929 0a0a 2020 2020 2020 2020 7265   1))..        re
-00032ee0: 7475 726e 2053 312c 2053 322c 2053 332c  turn S1, S2, S3,
-00032ef0: 2053 340a 0a20 2020 2064 6566 205f 7265   S4..    def _re
-00032f00: 6374 616e 676c 655f 696e 7465 7273 6563  ctangle_intersec
-00032f10: 7469 6f6e 2873 656c 662c 2078 312c 2079  tion(self, x1, y
-00032f20: 312c 2078 322c 2079 3229 3a0a 2020 2020  1, x2, y2):.    
-00032f30: 2020 2020 5331 2c20 5332 2c20 5333 2c20      S1, S2, S3, 
-00032f40: 5334 203d 2073 656c 662e 5f72 6563 745f  S4 = self._rect_
-00032f50: 696e 7465 725f 696e 6e65 7228 7831 2c20  inter_inner(x1, 
-00032f60: 7832 290a 2020 2020 2020 2020 5335 2c20  x2).        S5, 
-00032f70: 5336 2c20 5337 2c20 5338 203d 2073 656c  S6, S7, S8 = sel
-00032f80: 662e 5f72 6563 745f 696e 7465 725f 696e  f._rect_inter_in
-00032f90: 6e65 7228 7931 2c20 7932 290a 0a20 2020  ner(y1, y2)..   
-00032fa0: 2020 2020 2043 3120 3d20 6e70 2e6c 6573       C1 = np.les
-00032fb0: 735f 6571 7561 6c28 5331 2c20 5332 290a  s_equal(S1, S2).
-00032fc0: 2020 2020 2020 2020 4332 203d 206e 702e          C2 = np.
-00032fd0: 6772 6561 7465 725f 6571 7561 6c28 5333  greater_equal(S3
-00032fe0: 2c20 5334 290a 2020 2020 2020 2020 4333  , S4).        C3
-00032ff0: 203d 206e 702e 6c65 7373 5f65 7175 616c   = np.less_equal
-00033000: 2853 352c 2053 3629 0a20 2020 2020 2020  (S5, S6).       
-00033010: 2043 3420 3d20 6e70 2e67 7265 6174 6572   C4 = np.greater
-00033020: 5f65 7175 616c 2853 372c 2053 3829 0a0a  _equal(S7, S8)..
-00033030: 2020 2020 2020 2020 6969 2c20 6a6a 203d          ii, jj =
-00033040: 206e 702e 6e6f 6e7a 6572 6f28 4331 2026   np.nonzero(C1 &
-00033050: 2043 3220 2620 4333 2026 2043 3429 0a0a   C2 & C3 & C4)..
-00033060: 2020 2020 2020 2020 7265 7475 726e 2069          return i
-00033070: 692c 206a 6a0a 0a20 2020 2064 6566 2063  i, jj..    def c
-00033080: 7572 7665 735f 696e 7465 7273 6563 7469  urves_intersecti
-00033090: 6f6e 2873 656c 662c 2078 312c 2079 312c  on(self, x1, y1,
-000330a0: 2078 322c 2079 3229 3a0a 2020 2020 2020   x2, y2):.      
-000330b0: 2020 2222 220a 2020 2020 2020 2020 4765    """.        Ge
-000330c0: 7420 7468 6520 696e 7465 7273 6365 7469  t the intersceti
-000330d0: 6f6e 206f 6620 7477 6f20 6375 7276 6573  on of two curves
-000330e0: 0a20 2020 2020 2020 2072 6574 7572 6e3a  .        return:
-000330f0: 206c 6973 7420 6f66 206f 6620 7475 706c   list of of tupl
-00033100: 6520 636f 6e74 6169 6e73 205b 2878 312c  e contains [(x1,
-00033110: 2079 3129 2c20 2878 322c 2079 3229 2c20   y1), (x2, y2), 
-00033120: 2e2e 2e5d 2028 6e6f 2064 7570 6c69 6361  ...] (no duplica
-00033130: 7465 6420 706f 696e 7473 290a 2020 2020  ted points).    
-00033140: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00033150: 7831 203d 206e 702e 6173 6172 7261 7928  x1 = np.asarray(
-00033160: 7831 290a 2020 2020 2020 2020 7832 203d  x1).        x2 =
-00033170: 206e 702e 6173 6172 7261 7928 7832 290a   np.asarray(x2).
-00033180: 2020 2020 2020 2020 7931 203d 206e 702e          y1 = np.
-00033190: 6173 6172 7261 7928 7931 290a 2020 2020  asarray(y1).    
-000331a0: 2020 2020 7932 203d 206e 702e 6173 6172      y2 = np.asar
-000331b0: 7261 7928 7932 290a 0a20 2020 2020 2020  ray(y2)..       
-000331c0: 2069 692c 206a 6a20 3d20 7365 6c66 2e5f   ii, jj = self._
-000331d0: 7265 6374 616e 676c 655f 696e 7465 7273  rectangle_inters
-000331e0: 6563 7469 6f6e 2878 312c 2079 312c 2078  ection(x1, y1, x
-000331f0: 322c 2079 3229 0a20 2020 2020 2020 2069  2, y2).        i
-00033200: 6620 3020 696e 2069 693a 0a20 2020 2020  f 0 in ii:.     
-00033210: 2020 2020 2020 207a 6572 6f5f 696e 6420         zero_ind 
-00033220: 3d20 6e70 2e77 6865 7265 2869 6920 3d3d  = np.where(ii ==
-00033230: 2030 290a 2020 2020 2020 2020 2020 2020   0).            
-00033240: 6969 203d 206e 702e 6465 6c65 7465 2869  ii = np.delete(i
-00033250: 692c 207a 6572 6f5f 696e 6429 0a20 2020  i, zero_ind).   
-00033260: 2020 2020 2020 2020 206a 6a20 3d20 6e70           jj = np
-00033270: 2e64 656c 6574 6528 6a6a 2c20 7a65 726f  .delete(jj, zero
-00033280: 5f69 6e64 290a 2020 2020 2020 2020 6966  _ind).        if
-00033290: 2031 2069 6e20 6969 3a0a 2020 2020 2020   1 in ii:.      
-000332a0: 2020 2020 2020 6f6e 655f 696e 6420 3d20        one_ind = 
-000332b0: 6e70 2e77 6865 7265 2869 6920 3d3d 2031  np.where(ii == 1
-000332c0: 290a 2020 2020 2020 2020 2020 2020 6969  ).            ii
-000332d0: 203d 206e 702e 6465 6c65 7465 2869 692c   = np.delete(ii,
-000332e0: 206f 6e65 5f69 6e64 290a 2020 2020 2020   one_ind).      
-000332f0: 2020 2020 2020 6a6a 203d 206e 702e 6465        jj = np.de
-00033300: 6c65 7465 286a 6a2c 206f 6e65 5f69 6e64  lete(jj, one_ind
-00033310: 290a 2020 2020 2020 2020 6e20 3d20 6c65  ).        n = le
-00033320: 6e28 6969 290a 0a20 2020 2020 2020 2064  n(ii)..        d
-00033330: 7879 3120 3d20 6e70 2e64 6966 6628 6e70  xy1 = np.diff(np
-00033340: 2e63 5f5b 7831 2c20 7931 5d2c 2061 7869  .c_[x1, y1], axi
-00033350: 733d 3029 0a20 2020 2020 2020 2064 7879  s=0).        dxy
-00033360: 3220 3d20 6e70 2e64 6966 6628 6e70 2e63  2 = np.diff(np.c
-00033370: 5f5b 7832 2c20 7932 5d2c 2061 7869 733d  _[x2, y2], axis=
-00033380: 3029 0a0a 2020 2020 2020 2020 5420 3d20  0)..        T = 
-00033390: 6e70 2e7a 6572 6f73 2828 342c 206e 2929  np.zeros((4, n))
-000333a0: 0a20 2020 2020 2020 2041 4120 3d20 6e70  .        AA = np
-000333b0: 2e7a 6572 6f73 2828 342c 2034 2c20 6e29  .zeros((4, 4, n)
-000333c0: 290a 2020 2020 2020 2020 4141 5b30 3a32  ).        AA[0:2
-000333d0: 2c20 322c 203a 5d20 3d20 2d31 0a20 2020  , 2, :] = -1.   
-000333e0: 2020 2020 2041 415b 323a 342c 2033 2c20       AA[2:4, 3, 
-000333f0: 3a5d 203d 202d 310a 2020 2020 2020 2020  :] = -1.        
-00033400: 4141 5b30 3a3a 322c 2030 2c20 3a5d 203d  AA[0::2, 0, :] =
-00033410: 2064 7879 315b 6969 2c20 3a5d 2e54 0a20   dxy1[ii, :].T. 
-00033420: 2020 2020 2020 2041 415b 313a 3a32 2c20         AA[1::2, 
-00033430: 312c 203a 5d20 3d20 6478 7932 5b6a 6a2c  1, :] = dxy2[jj,
-00033440: 203a 5d2e 540a 0a20 2020 2020 2020 2042   :].T..        B
-00033450: 4220 3d20 6e70 2e7a 6572 6f73 2828 342c  B = np.zeros((4,
-00033460: 206e 2929 0a20 2020 2020 2020 2042 425b   n)).        BB[
-00033470: 302c 203a 5d20 3d20 2d78 315b 6969 5d2e  0, :] = -x1[ii].
-00033480: 7261 7665 6c28 290a 2020 2020 2020 2020  ravel().        
-00033490: 4242 5b31 2c20 3a5d 203d 202d 7832 5b6a  BB[1, :] = -x2[j
-000334a0: 6a5d 2e72 6176 656c 2829 0a20 2020 2020  j].ravel().     
-000334b0: 2020 2042 425b 322c 203a 5d20 3d20 2d79     BB[2, :] = -y
-000334c0: 315b 6969 5d2e 7261 7665 6c28 290a 2020  1[ii].ravel().  
-000334d0: 2020 2020 2020 4242 5b33 2c20 3a5d 203d        BB[3, :] =
-000334e0: 202d 7932 5b6a 6a5d 2e72 6176 656c 2829   -y2[jj].ravel()
-000334f0: 0a0a 2020 2020 2020 2020 666f 7220 6920  ..        for i 
-00033500: 696e 2072 616e 6765 286e 293a 0a20 2020  in range(n):.   
-00033510: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-00033520: 2020 2020 2020 2020 2020 2020 2020 545b                T[
-00033530: 3a2c 2069 5d20 3d20 6e70 2e6c 696e 616c  :, i] = np.linal
-00033540: 672e 736f 6c76 6528 4141 5b3a 2c20 3a2c  g.solve(AA[:, :,
-00033550: 2069 5d2c 2042 425b 3a2c 2069 5d29 0a20   i], BB[:, i]). 
-00033560: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-00033570: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
-00033580: 2020 2054 5b3a 2c20 695d 203d 206e 702e     T[:, i] = np.
-00033590: 496e 660a 0a20 2020 2020 2020 2069 6e5f  Inf..        in_
-000335a0: 7261 6e67 6520 3d20 2854 5b30 2c20 3a5d  range = (T[0, :]
-000335b0: 203e 3d20 3029 2026 2028 545b 312c 203a   >= 0) & (T[1, :
-000335c0: 5d20 3e3d 2030 2920 2620 280a 2020 2020  ] >= 0) & (.    
-000335d0: 2020 2020 2020 2020 2020 2020 545b 302c              T[0,
-000335e0: 203a 5d20 3c3d 2031 2920 2620 2854 5b31   :] <= 1) & (T[1
-000335f0: 2c20 3a5d 203c 3d20 3129 0a0a 2020 2020  , :] <= 1)..    
-00033600: 2020 2020 7879 3020 3d20 545b 323a 2c20      xy0 = T[2:, 
-00033610: 696e 5f72 616e 6765 5d0a 2020 2020 2020  in_range].      
-00033620: 2020 7879 3020 3d20 7879 302e 540a 2020    xy0 = xy0.T.  
-00033630: 2020 2020 2020 6e65 776c 6973 7420 3d20        newlist = 
-00033640: 5b5d 0a20 2020 2020 2020 2070 7269 6e74  [].        print
-00033650: 2878 7930 290a 2020 2020 2020 2020 666f  (xy0).        fo
-00033660: 7220 6920 696e 2078 7930 3a0a 2020 2020  r i in xy0:.    
-00033670: 2020 2020 2020 2020 6120 3d20 7475 706c          a = tupl
-00033680: 6528 6929 0a20 2020 2020 2020 2020 2020  e(i).           
-00033690: 206e 6577 6c69 7374 2e61 7070 656e 6428   newlist.append(
-000336a0: 6129 0a20 2020 2020 2020 2072 6573 203d  a).        res =
-000336b0: 206c 6973 7428 7365 7428 6e65 776c 6973   list(set(newlis
-000336c0: 7429 290a 2020 2020 2020 2020 7265 732e  t)).        res.
-000336d0: 736f 7274 286b 6579 3d6e 6577 6c69 7374  sort(key=newlist
-000336e0: 2e69 6e64 6578 290a 2020 2020 2020 2020  .index).        
-000336f0: 6e6c 6973 7420 3d20 5b5d 0a20 2020 2020  nlist = [].     
-00033700: 2020 2066 6f72 2062 2069 6e20 7265 733a     for b in res:
-00033710: 0a20 2020 2020 2020 2020 2020 206e 6c69  .            nli
-00033720: 7374 2e61 7070 656e 6428 6c69 7374 2862  st.append(list(b
-00033730: 2929 0a20 2020 2020 2020 206c 7265 7320  )).        lres 
-00033740: 3d20 6e70 2e61 7272 6179 286e 6c69 7374  = np.array(nlist
-00033750: 290a 2020 2020 2020 2020 7072 696e 7428  ).        print(
-00033760: 6e70 2e61 7272 6179 286e 6c69 7374 2929  np.array(nlist))
-00033770: 0a20 2020 2020 2020 2070 7269 6e74 286e  .        print(n
-00033780: 702e 6172 7261 7928 6e6c 6973 7429 5b3a  p.array(nlist)[:
-00033790: 2c20 305d 290a 2020 2020 2020 2020 7072  , 0]).        pr
-000337a0: 696e 7428 6e70 2e61 7272 6179 286e 6c69  int(np.array(nli
-000337b0: 7374 295b 3a2c 2031 5d29 0a20 2020 2020  st)[:, 1]).     
-000337c0: 2020 2072 6574 7572 6e20 6c72 6573 5b3a     return lres[:
-000337d0: 2c20 305d 2c20 6c72 6573 5b3a 2c20 315d  , 0], lres[:, 1]
-000337e0: 0a0a 2020 2020 2320 456e 6420 6f66 206e  ..    # End of n
-000337f0: 6577 2063 7572 7665 2069 6e74 6572 7365  ew curve interse
-00033800: 6374 696f 6e20 6675 6e63 7469 6f6e 730a  ction functions.
-00033810: 0a20 2020 2064 6566 205f 5f69 6e74 6572  .    def __inter
-00033820: 706f 6c61 7465 645f 696e 7465 7263 6570  polated_intercep
-00033830: 7428 7365 6c66 2c20 782c 2079 312c 2079  t(self, x, y1, y
-00033840: 3229 3a0a 2020 2020 2020 2020 2222 220a  2):.        """.
-00033850: 0a20 2020 2020 2020 2020 2020 2046 696e  .            Fin
-00033860: 6420 7468 6520 696e 7465 7263 6570 7420  d the intercept 
-00033870: 6f66 2074 776f 2063 7572 7665 732c 2067  of two curves, g
-00033880: 6976 656e 2062 7920 7468 6520 7361 6d65  iven by the same
-00033890: 2078 2064 6174 610a 0a20 2020 2020 2020   x data..       
-000338a0: 2022 2222 0a0a 2020 2020 2020 2020 6465   """..        de
-000338b0: 6620 696e 7465 7263 6570 7428 706f 696e  f intercept(poin
-000338c0: 7431 2c20 706f 696e 7432 2c20 706f 696e  t1, point2, poin
-000338d0: 7433 2c20 706f 696e 7434 293a 0a20 2020  t3, point4):.   
-000338e0: 2020 2020 2020 2020 2022 2222 0a0a 2020           """..  
-000338f0: 2020 2020 2020 2020 2020 2020 2020 4669                Fi
-00033900: 6e64 2074 6865 2069 6e74 6572 7365 6374  nd the intersect
-00033910: 696f 6e20 6265 7477 6565 6e20 7477 6f20  ion between two 
-00033920: 6c69 6e65 730a 2020 2020 2020 2020 2020  lines.          
-00033930: 2020 2020 2020 7468 6520 6669 7273 7420        the first 
-00033940: 6c69 6e65 2069 7320 6465 6669 6e65 6420  line is defined 
-00033950: 6279 2074 6865 206c 696e 6520 6265 7477  by the line betw
-00033960: 6565 6e20 706f 696e 7431 2061 6e64 2070  een point1 and p
-00033970: 6f69 6e74 320a 2020 2020 2020 2020 2020  oint2.          
-00033980: 2020 2020 2020 7468 6520 7365 636f 6e64        the second
-00033990: 206c 696e 6520 6973 2064 6566 696e 6564   line is defined
-000339a0: 2062 7920 7468 6520 6c69 6e65 2062 6574   by the line bet
-000339b0: 7765 656e 2070 6f69 6e74 3320 616e 6420  ween point3 and 
-000339c0: 706f 696e 7434 0a20 2020 2020 2020 2020  point4.         
-000339d0: 2020 2020 2020 2065 6163 6820 706f 696e         each poin
-000339e0: 7420 6973 2061 6e20 2878 2c79 2920 7475  t is an (x,y) tu
-000339f0: 706c 652e 0a0a 2020 2020 2020 2020 2020  ple...          
-00033a00: 2020 2020 2020 536f 2c20 666f 7220 6578        So, for ex
-00033a10: 616d 706c 652c 2079 6f75 2063 616e 2066  ample, you can f
-00033a20: 696e 6420 7468 6520 696e 7465 7273 6563  ind the intersec
-00033a30: 7469 6f6e 2062 6574 7765 656e 0a20 2020  tion between.   
-00033a40: 2020 2020 2020 2020 2020 2020 2069 6e74               int
-00033a50: 6572 6365 7074 2828 302c 3029 2c20 2831  ercept((0,0), (1
-00033a60: 2c31 292c 2028 302c 3129 2c20 2831 2c30  ,1), (0,1), (1,0
-00033a70: 2929 203d 2028 302e 352c 2030 2e35 290a  )) = (0.5, 0.5).
-00033a80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00033a90: 203a 7265 7475 726e 3a20 496e 7465 7263   :return: Interc
-00033aa0: 6570 742c 2069 6e20 2878 2c79 2920 666f  ept, in (x,y) fo
-00033ab0: 726d 6174 0a0a 2020 2020 2020 2020 2020  rmat..          
-00033ac0: 2020 2222 220a 0a20 2020 2020 2020 2020    """..         
-00033ad0: 2020 2064 6566 206c 696e 6528 7031 2c20     def line(p1, 
-00033ae0: 7032 293a 0a20 2020 2020 2020 2020 2020  p2):.           
-00033af0: 2020 2020 2041 203d 2028 7031 5b31 5d20       A = (p1[1] 
-00033b00: 2d20 7032 5b31 5d29 0a20 2020 2020 2020  - p2[1]).       
-00033b10: 2020 2020 2020 2020 2042 203d 2028 7032           B = (p2
-00033b20: 5b30 5d20 2d20 7031 5b30 5d29 0a20 2020  [0] - p1[0]).   
-00033b30: 2020 2020 2020 2020 2020 2020 2043 203d               C =
-00033b40: 2028 7031 5b30 5d20 2a20 7032 5b31 5d20   (p1[0] * p2[1] 
-00033b50: 2d20 7032 5b30 5d20 2a20 7031 5b31 5d29  - p2[0] * p1[1])
-00033b60: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00033b70: 2020 7265 7475 726e 2041 2c20 422c 202d    return A, B, -
-00033b80: 430a 0a20 2020 2020 2020 2020 2020 2064  C..            d
-00033b90: 6566 2069 6e74 6572 7365 6374 696f 6e28  ef intersection(
-00033ba0: 4c31 2c20 4c32 293a 0a20 2020 2020 2020  L1, L2):.       
-00033bb0: 2020 2020 2020 2020 2044 203d 204c 315b           D = L1[
-00033bc0: 305d 202a 204c 325b 315d 202d 204c 315b  0] * L2[1] - L1[
-00033bd0: 315d 202a 204c 325b 305d 0a20 2020 2020  1] * L2[0].     
-00033be0: 2020 2020 2020 2020 2020 2044 7820 3d20             Dx = 
-00033bf0: 4c31 5b32 5d20 2a20 4c32 5b31 5d20 2d20  L1[2] * L2[1] - 
-00033c00: 4c31 5b31 5d20 2a20 4c32 5b32 5d0a 2020  L1[1] * L2[2].  
-00033c10: 2020 2020 2020 2020 2020 2020 2020 4479                Dy
-00033c20: 203d 204c 315b 305d 202a 204c 325b 325d   = L1[0] * L2[2]
-00033c30: 202d 204c 315b 325d 202a 204c 325b 305d   - L1[2] * L2[0]
-00033c40: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00033c50: 2020 7820 3d20 4478 202f 2044 0a20 2020    x = Dx / D.   
-00033c60: 2020 2020 2020 2020 2020 2020 2079 203d               y =
-00033c70: 2044 7920 2f20 440a 0a20 2020 2020 2020   Dy / D..       
-00033c80: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00033c90: 782c 2079 0a0a 2020 2020 2020 2020 2020  x, y..          
-00033ca0: 2020 4c31 203d 206c 696e 6528 5b70 6f69    L1 = line([poi
-00033cb0: 6e74 315b 305d 2c20 706f 696e 7431 5b31  nt1[0], point1[1
-00033cc0: 5d5d 2c20 5b70 6f69 6e74 325b 305d 2c20  ]], [point2[0], 
-00033cd0: 706f 696e 7432 5b31 5d5d 290a 2020 2020  point2[1]]).    
-00033ce0: 2020 2020 2020 2020 4c32 203d 206c 696e          L2 = lin
-00033cf0: 6528 5b70 6f69 6e74 335b 305d 2c20 706f  e([point3[0], po
-00033d00: 696e 7433 5b31 5d5d 2c20 5b70 6f69 6e74  int3[1]], [point
-00033d10: 345b 305d 2c20 706f 696e 7434 5b31 5d5d  4[0], point4[1]]
-00033d20: 290a 0a20 2020 2020 2020 2020 2020 2052  )..            R
-00033d30: 203d 2069 6e74 6572 7365 6374 696f 6e28   = intersection(
-00033d40: 4c31 2c20 4c32 290a 0a20 2020 2020 2020  L1, L2)..       
-00033d50: 2020 2020 2072 6574 7572 6e20 520a 0a20       return R.. 
-00033d60: 2020 2020 2020 2069 6478 203d 206e 702e         idx = np.
-00033d70: 6172 6777 6865 7265 286e 702e 6469 6666  argwhere(np.diff
-00033d80: 286e 702e 7369 676e 2879 3120 2d20 7932  (np.sign(y1 - y2
-00033d90: 2929 2021 3d20 3029 0a20 2020 2020 2020  )) != 0).       
-00033da0: 2023 2052 656d 6f76 6520 7468 6520 6669   # Remove the fi
-00033db0: 7273 7420 706f 696e 7420 7573 7561 6c6c  rst point usuall
-00033dc0: 7920 2830 2c20 3129 2074 6f20 6176 6f69  y (0, 1) to avoi
-00033dd0: 6420 616c 6c20 6375 7276 6573 2073 7461  d all curves sta
-00033de0: 7274 696e 6720 6672 6f6d 2028 302c 2031  rting from (0, 1
-00033df0: 2920 7768 6963 6820 7069 636b 2061 7320  ) which pick as 
-00033e00: 6f6e 6520 696e 7465 7273 6563 7469 6f6e  one intersection
-00033e10: 0a20 2020 2020 2020 2069 6620 6964 782e  .        if idx.
-00033e20: 7369 7a65 2021 3d20 303a 0a20 2020 2020  size != 0:.     
-00033e30: 2020 2020 2020 2069 6620 6964 785b 305d         if idx[0]
-00033e40: 5b30 5d20 3d3d 2030 3a0a 2020 2020 2020  [0] == 0:.      
-00033e50: 2020 2020 2020 2020 2020 6964 7820 3d20            idx = 
-00033e60: 6e70 2e64 656c 6574 6528 6964 782c 2030  np.delete(idx, 0
-00033e70: 2c20 3029 0a20 2020 2020 2020 2020 2020  , 0).           
-00033e80: 2078 632c 2079 6320 3d20 696e 7465 7263   xc, yc = interc
-00033e90: 6570 7428 2878 5b69 6478 5d2c 2079 315b  ept((x[idx], y1[
-00033ea0: 6964 785d 292c 2028 2878 5b69 6478 202b  idx]), ((x[idx +
-00033eb0: 2031 5d2c 2079 315b 6964 7820 2b20 315d   1], y1[idx + 1]
-00033ec0: 2929 2c20 2828 785b 6964 785d 2c20 7932  )), ((x[idx], y2
-00033ed0: 5b69 6478 5d29 292c 0a20 2020 2020 2020  [idx])),.       
-00033ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00033ef0: 2020 2020 2020 2020 2828 785b 6964 7820          ((x[idx 
-00033f00: 2b20 315d 2c20 7932 5b69 6478 202b 2031  + 1], y2[idx + 1
-00033f10: 5d29 2929 0a20 2020 2020 2020 2020 2020  ]))).           
-00033f20: 2072 6574 7572 6e20 7863 2c20 7963 0a20   return xc, yc. 
-00033f30: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00033f40: 2020 2020 2020 2020 206e 756c 6c61 7272           nullarr
-00033f50: 203d 206e 702e 656d 7074 7928 7368 6170   = np.empty(shap
-00033f60: 653d 2830 2c20 3029 290a 2020 2020 2020  e=(0, 0)).      
-00033f70: 2020 2020 2020 7265 7475 726e 206e 756c        return nul
-00033f80: 6c61 7272 2c20 6e75 6c6c 6172 720a 0a0a  larr, nullarr...
-00033f90: 2020 2020 6465 6620 6d6d 6673 6328 7365      def mmfsc(se
-00033fa0: 6c66 293a 0a20 2020 2020 2020 2022 2222  lf):.        """
-00033fb0: 0a0a 2020 2020 2020 2020 2020 2020 4361  ..            Ca
-00033fc0: 6c63 756c 6174 6520 4d6f 6465 6c2d 6d61  lculate Model-ma
-00033fd0: 7020 4653 4320 6261 7365 6420 6f6e 2073  p FSC based on s
-00033fe0: 696d 756c 6174 6564 2064 656e 7369 7479  imulated density
-00033ff0: 206d 6170 2066 726f 6d20 6d6f 6465 6c0a   map from model.
-00034000: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-00034010: 3a0a 2020 2020 2020 2020 2222 220a 0a20  :.        """.. 
-00034020: 2020 2020 2020 2069 6620 7365 6c66 2e70         if self.p
-00034030: 6c61 7466 6f72 6d20 3d3d 2027 656d 6462  latform == 'emdb
-00034040: 273a 0a20 2020 2020 2020 2020 2020 2073  ':.            s
-00034050: 7461 7274 203d 2074 696d 6569 742e 6465  tart = timeit.de
-00034060: 6661 756c 745f 7469 6d65 7228 290a 2020  fault_timer().  
-00034070: 2020 2020 2020 2020 2020 6d6f 6465 6c73            models
-00034080: 6d61 7073 203d 2073 656c 662e 6d6f 6465  maps = self.mode
-00034090: 6c73 6d61 7073 0a20 2020 2020 2020 2020  lsmaps.         
-000340a0: 2020 2023 2320 546f 646f 3a20 436f 6e73     ## Todo: Cons
-000340b0: 6964 6572 2070 7574 7469 6e67 2074 6869  ider putting thi
-000340c0: 7320 6572 7220 696e 666f 726d 6174 696f  s err informatio
-000340d0: 6e20 696e 746f 2074 6865 2066 696e 616c  n into the final
-000340e0: 2066 7363 206a 736f 6e20 6669 6c65 0a20   fsc json file. 
-000340f0: 2020 2020 2020 2020 2020 206d 6f64 656c             model
-00034100: 6d61 7073 6469 6374 203d 207b 7d0a 2020  mapsdict = {}.  
-00034110: 2020 2020 2020 2020 2020 6f6c 6466 696c            oldfil
-00034120: 6573 203d 205b 5d0a 2020 2020 2020 2020  es = [].        
-00034130: 2020 2020 6966 2073 656c 662e 6d65 7420      if self.met 
-00034140: 213d 2027 746f 6d6f 2720 616e 6420 7365  != 'tomo' and se
-00034150: 6c66 2e6d 6574 2021 3d20 2763 7279 7327  lf.met != 'crys'
-00034160: 2061 6e64 2028 6d6f 6465 6c73 6d61 7073   and (modelsmaps
-00034170: 2069 7320 6e6f 7420 4e6f 6e65 293a 0a20   is not None):. 
-00034180: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00034190: 6f72 206d 6f64 656c 6d61 7020 696e 206d  or modelmap in m
-000341a0: 6f64 656c 736d 6170 733a 0a20 2020 2020  odelsmaps:.     
-000341b0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000341c0: 2072 6561 6420 6d6f 6465 6c20 6d61 700a   read model map.
-000341d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000341e0: 2020 2020 6d6f 6465 6c6e 616d 6520 3d20      modelname = 
-000341f0: 6f73 2e70 6174 682e 6261 7365 6e61 6d65  os.path.basename
-00034200: 286d 6f64 656c 6d61 7029 2e73 706c 6974  (modelmap).split
-00034210: 2827 5f27 295b 305d 0a20 2020 2020 2020  ('_')[0].       
-00034220: 2020 2020 2020 2020 2020 2020 2023 206f               # o
-00034230: 626a 6d6f 6465 6c6d 6170 203d 2073 656c  bjmodelmap = sel
-00034240: 662e 6672 6f6d 6d72 635f 746f 7465 6d70  f.frommrc_totemp
-00034250: 7928 6d6f 6465 6c6d 6170 290a 2020 2020  y(modelmap).    
-00034260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034270: 6f62 6a6d 6f64 656c 6d61 7020 3d20 6d72  objmodelmap = mr
-00034280: 6366 696c 652e 6d6d 6170 286d 6f64 656c  cfile.mmap(model
-00034290: 6d61 702c 206d 6f64 653d 2772 2729 0a20  map, mode='r'). 
-000342a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000342b0: 2020 2023 2073 656c 662e 6673 6328 7365     # self.fsc(se
-000342c0: 6c66 2e6d 6170 2c20 6f62 6a6d 6f64 656c  lf.map, objmodel
-000342d0: 6d61 702c 206c 6162 656c 3d27 7b7d 5f6d  map, label='{}_m
-000342e0: 6d27 2e66 6f72 6d61 7428 6d6f 6465 6c6e  m'.format(modeln
-000342f0: 616d 6529 290a 2020 2020 2020 2020 2020  ame)).          
-00034300: 2020 2020 2020 2020 2020 7365 6c66 2e6e            self.n
-00034310: 6577 5f66 7363 2873 656c 662e 6d61 702c  ew_fsc(self.map,
-00034320: 206f 626a 6d6f 6465 6c6d 6170 2c20 6c61   objmodelmap, la
-00034330: 6265 6c3d 277b 7d5f 6d6d 272e 666f 726d  bel='{}_mm'.form
-00034340: 6174 286d 6f64 656c 6e61 6d65 2929 0a20  at(modelname)). 
-00034350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034360: 2020 206f 6c64 6e61 6d65 203d 2027 7b7d     oldname = '{}
-00034370: 7b7d 5f7b 7d5f 6d6d 6673 632e 6a73 6f6e  {}_{}_mmfsc.json
-00034380: 272e 666f 726d 6174 2873 656c 662e 776f  '.format(self.wo
-00034390: 726b 6469 722c 2073 656c 662e 6d61 706e  rkdir, self.mapn
-000343a0: 616d 652c 206d 6f64 656c 6e61 6d65 290a  ame, modelname).
-000343b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000343c0: 2020 2020 6e65 776e 616d 6520 3d20 277b      newname = '{
-000343d0: 7d7b 7d27 2e66 6f72 6d61 7428 7365 6c66  }{}'.format(self
-000343e0: 2e77 6f72 6b64 6972 2c20 7365 6c66 2e6d  .workdir, self.m
-000343f0: 6170 6e61 6d65 202b 2027 5f27 202b 206d  apname + '_' + m
-00034400: 6f64 656c 6e61 6d65 202b 2027 5f6d 6d66  odelname + '_mmf
-00034410: 7363 2e6a 736f 6e27 290a 2020 2020 2020  sc.json').      
-00034420: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00034430: 206f 732e 7061 7468 2e69 7366 696c 6528   os.path.isfile(
-00034440: 6f6c 646e 616d 6529 3a0a 2020 2020 2020  oldname):.      
-00034450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034460: 2020 6f6c 6466 696c 6573 2e61 7070 656e    oldfiles.appen
-00034470: 6428 6f6c 646e 616d 6529 0a20 2020 2020  d(oldname).     
-00034480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034490: 2020 206f 732e 7265 6e61 6d65 286f 6c64     os.rename(old
-000344a0: 6e61 6d65 2c20 6e65 776e 616d 6529 0a20  name, newname). 
-000344b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000344c0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000344d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000344e0: 2070 7269 6e74 2827 7b7d 2064 6f65 7320   print('{} does 
-000344f0: 6e6f 7420 6578 6973 742c 2070 6c65 6173  not exist, pleas
-00034500: 6520 6368 6563 6b2e 272e 666f 726d 6174  e check.'.format
-00034510: 286f 6c64 6e61 6d65 2929 0a20 2020 2020  (oldname)).     
-00034520: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00034530: 6f64 656c 6d61 7073 6469 6374 5b6d 6f64  odelmapsdict[mod
-00034540: 656c 6e61 6d65 5d20 3d20 6e65 776e 616d  elname] = newnam
-00034550: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00034560: 2020 7365 6c66 2e6d 6572 6765 6d6d 6673    self.mergemmfs
-00034570: 6328 6d6f 6465 6c6d 6170 7364 6963 7429  c(modelmapsdict)
-00034580: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00034590: 2073 656c 662e 6465 6c6f 6c64 6d6d 6673   self.deloldmmfs
-000345a0: 6328 6f6c 6466 696c 6573 290a 2020 2020  c(oldfiles).    
-000345b0: 2020 2020 2020 2020 2020 2020 656e 6420              end 
-000345c0: 3d20 7469 6d65 6974 2e64 6566 6175 6c74  = timeit.default
-000345d0: 5f74 696d 6572 2829 0a0a 2020 2020 2020  _timer()..      
-000345e0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-000345f0: 276d 6d66 7363 2074 696d 653a 2025 7327  'mmfsc time: %s'
-00034600: 2025 2028 656e 6420 2d20 7374 6172 7429   % (end - start)
-00034610: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00034620: 2020 7072 696e 7428 272d 2d2d 2d2d 2d2d    print('-------
-00034630: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00034640: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d27 290a  -------------').
-00034650: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00034660: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00034670: 2020 2070 7269 6e74 2827 4d6f 6465 6c2d     print('Model-
-00034680: 6d61 7020 4653 4320 6f6e 6c79 2063 616c  map FSC only cal
-00034690: 6375 6c61 7465 6420 666f 7220 7369 6e67  culated for sing
-000346a0: 6c65 2070 6172 7469 636c 6520 6461 7461  le particle data
-000346b0: 2077 6865 7265 2074 6865 7265 2069 7320   where there is 
-000346c0: 6120 6669 7474 6564 206d 6f64 656c 2027  a fitted model '
-000346d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000346e0: 2020 2020 2020 2027 2850 6c65 6173 6520         '(Please 
-000346f0: 7573 6520 2d6d 2073 7020 616e 6420 2d66  use -m sp and -f
-00034700: 2920 6f72 206e 6f20 6d6f 6465 6c20 6d61  ) or no model ma
-00034710: 7020 6973 2063 616c 6375 6c61 7465 6420  p is calculated 
-00034720: 7573 202d 6920 742f 6620 746f 2073 7769  us -i t/f to swi
-00034730: 7463 6820 6966 206f 6e20 6f72 206f 6666  tch if on or off
-00034740: 2e27 290a 0a20 2020 2020 2020 2072 6574  .')..        ret
-00034750: 7572 6e20 4e6f 6e65 0a0a 2020 2020 6465  urn None..    de
-00034760: 6620 6465 6c6f 6c64 6d6d 6673 6328 7365  f deloldmmfsc(se
-00034770: 6c66 2c20 6f6c 6466 696c 6573 293a 0a20  lf, oldfiles):. 
-00034780: 2020 2020 2020 2022 2222 0a0a 2020 2020         """..    
-00034790: 2020 2020 2020 2020 6465 6c65 7465 2073          delete s
-000347a0: 6570 6172 6174 6520 6d6d 6673 6320 6669  eparate mmfsc fi
-000347b0: 6c65 7320 746f 2061 766f 6964 206d 6572  les to avoid mer
-000347c0: 6765 6420 696e 746f 2074 6865 2066 696e  ged into the fin
-000347d0: 616c 206a 736f 6e0a 0a20 2020 2020 2020  al json..       
-000347e0: 203a 7061 7261 6d20 6f6c 6466 696c 6573   :param oldfiles
-000347f0: 3a0a 2020 2020 2020 2020 3a72 6574 7572  :.        :retur
-00034800: 6e3a 204e 6f6e 650a 2020 2020 2020 2020  n: None.        
-00034810: 2222 220a 0a20 2020 2020 2020 2069 6620  """..        if 
-00034820: 6f6c 6466 696c 6573 3a0a 2020 2020 2020  oldfiles:.      
-00034830: 2020 2020 2020 666f 7220 6669 6c65 2069        for file i
-00034840: 6e20 6f6c 6466 696c 6573 3a0a 2020 2020  n oldfiles:.    
-00034850: 2020 2020 2020 2020 2020 2020 6f73 2e72              os.r
-00034860: 656d 6f76 6528 6669 6c65 290a 2020 2020  emove(file).    
-00034870: 2020 2020 2020 2020 7072 696e 7428 2753          print('S
-00034880: 6570 6172 6174 6520 6d6d 6673 6320 6669  eparate mmfsc fi
-00034890: 6c65 7320 7765 7265 2064 656c 6574 6564  les were deleted
-000348a0: 2e27 290a 2020 2020 2020 2020 656c 7365  .').        else
-000348b0: 3a0a 2020 2020 2020 2020 2020 2020 7072  :.            pr
-000348c0: 696e 7428 274e 6f20 6d6d 6673 6320 6578  int('No mmfsc ex
-000348d0: 6973 742c 206e 6f20 6d6d 6673 6320 6669  ist, no mmfsc fi
-000348e0: 6c65 2063 616e 2062 6520 6465 6c65 7465  le can be delete
-000348f0: 6427 290a 0a0a 2020 2020 6465 6620 6d65  d')...    def me
-00034900: 7267 656d 6d66 7363 2873 656c 662c 206d  rgemmfsc(self, m
-00034910: 6d66 7363 6469 6374 293a 0a20 2020 2020  mfscdict):.     
-00034920: 2020 2022 2222 0a0a 2020 2020 2020 2020     """..        
-00034930: 2020 2020 4d65 7267 6520 616c 6c20 2a5f      Merge all *_
-00034940: 6d6d 6673 632e 6a73 6f6e 2066 696c 6573  mmfsc.json files
-00034950: 206f 6620 6469 6666 6572 656e 7420 6d6f   of different mo
-00034960: 6465 6c73 0a0a 2020 2020 2020 2020 3a72  dels..        :r
-00034970: 6574 7572 6e3a 0a20 2020 2020 2020 2022  eturn:.        "
-00034980: 2222 0a0a 2020 2020 2020 2020 6e66 696c  ""..        nfil
-00034990: 6573 203d 206c 656e 286c 6973 7428 6d6d  es = len(list(mm
-000349a0: 6673 6364 6963 7429 290a 2020 2020 2020  fscdict)).      
-000349b0: 2020 6675 6c6c 6461 7461 203d 207b 7d0a    fulldata = {}.
-000349c0: 2020 2020 2020 2020 666f 7220 692c 206d          for i, m
-000349d0: 6f64 656c 6e61 6d65 2069 6e20 7a69 7028  odelname in zip(
-000349e0: 7261 6e67 6528 302c 206e 6669 6c65 7329  range(0, nfiles)
-000349f0: 2c20 6c69 7374 286d 6d66 7363 6469 6374  , list(mmfscdict
-00034a00: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-00034a10: 6669 6c65 203d 206d 6d66 7363 6469 6374  file = mmfscdict
-00034a20: 5b6d 6f64 656c 6e61 6d65 5d0a 2020 2020  [modelname].    
-00034a30: 2020 2020 2020 2020 6966 206f 732e 7061          if os.pa
-00034a40: 7468 2e67 6574 7369 7a65 2866 696c 6529  th.getsize(file)
-00034a50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00034a60: 2020 7769 7468 206f 7065 6e28 6669 6c65    with open(file
-00034a70: 2c20 2772 2729 2061 7320 663a 0a20 2020  , 'r') as f:.   
+00032330: 2023 205b 6e70 2e61 7272 6179 285b 2d31   # [np.array([-1
+00032340: 2c20 2d31 2c20 2d31 5d29 2c20 5b4f 5b30  , -1, -1]), [O[0
+00032350: 5d20 2a20 322c 204f 5b31 5d20 2a20 322c  ] * 2, O[1] * 2,
+00032360: 204f 5b32 5d20 2a20 325d 5d5d 0a20 2020   O[2] * 2]]].   
+00032370: 2020 2020 2069 6e64 203d 206e 702e 6172       ind = np.ar
+00032380: 7261 7928 696e 6473 290a 2020 2020 2020  ray(inds).      
+00032390: 2020 7265 7320 3d20 6e70 2e61 7272 6179    res = np.array
+000323a0: 2869 6e64 7329 0a20 2020 2020 2020 2023  (inds).        #
+000323b0: 2077 3120 3d20 6e70 2e77 6865 7265 2828   w1 = np.where((
+000323c0: 696e 645b 3a2c 2031 5d20 3d3d 204f 5b31  ind[:, 1] == O[1
+000323d0: 5d29 207c 2028 696e 645b 3a2c 2030 5d20  ]) | (ind[:, 0] 
+000323e0: 3d3d 204f 5b30 5d29 207c 2028 696e 645b  == O[0]) | (ind[
+000323f0: 3a2c 2032 5d20 3d3d 204f 5b32 5d29 2c20  :, 2] == O[2]), 
+00032400: 5472 7565 2c20 4661 6c73 6529 0a20 2020  True, False).   
+00032410: 2020 2020 2023 2077 3120 3d20 696e 645b       # w1 = ind[
+00032420: 7731 2c20 3a5d 0a20 2020 2020 2020 2023  w1, :].        #
+00032430: 2077 3220 3d20 6e70 2e77 6865 7265 2828   w2 = np.where((
+00032440: 696e 645b 3a2c 2031 5d20 213d 204f 5b31  ind[:, 1] != O[1
+00032450: 5d29 207c 2028 696e 645b 3a2c 2030 5d20  ]) | (ind[:, 0] 
+00032460: 213d 204f 5b30 5d29 207c 2028 696e 645b  != O[0]) | (ind[
+00032470: 3a2c 2032 5d20 213d 204f 5b32 5d29 2c20  :, 2] != O[2]), 
+00032480: 5472 7565 2c20 4661 6c73 6529 0a20 2020  True, False).   
+00032490: 2020 2020 2023 2077 3220 3d20 696e 645b       # w2 = ind[
+000324a0: 7732 2c20 3a5d 0a20 2020 2020 2020 2066  w2, :].        f
+000324b0: 6f72 206f 7020 696e 206f 7065 7261 746f  or op in operato
+000324c0: 7273 5b3a 5d3a 0a20 2020 2020 2020 2020  rs[:]:.         
+000324d0: 2020 2023 2074 6d70 203d 2077 3220 2a20     # tmp = w2 * 
+000324e0: 6f70 5b30 5d20 2b20 6e70 2e61 7272 6179  op[0] + np.array
+000324f0: 286f 705b 315d 290a 2020 2020 2020 2020  (op[1]).        
+00032500: 2020 2020 746d 7020 3d20 696e 6420 2a20      tmp = ind * 
+00032510: 6f70 5b30 5d20 2b20 6e70 2e61 7272 6179  op[0] + np.array
+00032520: 286f 705b 315d 290a 2020 2020 2020 2020  (op[1]).        
+00032530: 2020 2020 7265 7320 3d20 6e70 2e63 6f6e      res = np.con
+00032540: 6361 7465 6e61 7465 2828 7265 732c 2074  catenate((res, t
+00032550: 6d70 2929 0a20 2020 2020 2020 2023 206f  mp)).        # o
+00032560: 6e5f 6178 6973 5f72 6573 203d 206e 702e  n_axis_res = np.
+00032570: 636f 6e63 6174 656e 6174 6528 2877 3120  concatenate((w1 
+00032580: 2a20 6e70 2e61 7272 6179 285b 2d31 2c20  * np.array([-1, 
+00032590: 2d31 2c20 2d31 5d29 202b 206e 702e 6172  -1, -1]) + np.ar
+000325a0: 7261 7928 5b4f 5b30 5d20 2a20 322c 204f  ray([O[0] * 2, O
+000325b0: 5b31 5d20 2a20 322c 204f 5b32 5d20 2a20  [1] * 2, O[2] * 
+000325c0: 325d 292c 2077 3129 290a 2020 2020 2020  2]), w1)).      
+000325d0: 2020 2320 7265 7320 3d20 6e70 2e63 6f6e    # res = np.con
+000325e0: 6361 7465 6e61 7465 2828 7265 732c 206f  catenate((res, o
+000325f0: 6e5f 6178 6973 5f72 6573 2929 0a20 2020  n_axis_res)).   
+00032600: 2020 2020 2072 6574 7572 6e20 6e70 2e75       return np.u
+00032610: 6e69 7175 6528 7265 732c 2061 7869 733d  nique(res, axis=
+00032620: 3029 0a0a 2020 2020 6465 6620 6765 6e65  0)..    def gene
+00032630: 7261 7465 5f73 6865 6c6c 2873 656c 662c  rate_shell(self,
+00032640: 206e 312c 206e 322c 2073 6861 7065 293a   n1, n2, shape):
+00032650: 0a20 2020 2020 2020 2064 3120 3d20 6e31  .        d1 = n1
+00032660: 0a20 2020 2020 2020 2064 3220 3d20 6e32  .        d2 = n2
+00032670: 0a20 2020 2020 2020 2023 204f 3120 3d20  .        # O1 = 
+00032680: 5b73 6861 7065 5b30 5d2f 2f32 2c20 7368  [shape[0]//2, sh
+00032690: 6170 655b 315d 2f2f 322c 2073 6861 7065  ape[1]//2, shape
+000326a0: 5b32 5d2f 2f32 5d0a 2020 2020 2020 2020  [2]//2].        
+000326b0: 2320 6576 656e 206e 756d 6265 7220 666f  # even number fo
+000326c0: 7220 6772 6964 0a20 2020 2020 2020 2023  r grid.        #
+000326d0: 2062 6173 6564 206f 6e20 6666 740a 2020   based on fft.  
+000326e0: 2020 2020 2020 6966 206d 696e 2873 6861        if min(sha
+000326f0: 7065 2920 2520 3220 3d3d 2030 3a0a 2020  pe) % 2 == 0:.  
+00032700: 2020 2020 2020 2020 2020 4f31 203d 205b            O1 = [
+00032710: 7368 6170 655b 305d 202f 2032 2c20 7368  shape[0] / 2, sh
+00032720: 6170 655b 315d 202f 2032 2c20 7368 6170  ape[1] / 2, shap
+00032730: 655b 325d 202f 2032 5d0a 2020 2020 2020  e[2] / 2].      
+00032740: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00032750: 2020 2020 4f31 203d 205b 2873 6861 7065      O1 = [(shape
+00032760: 5b30 5d20 2d20 3129 202f 2032 2c20 2873  [0] - 1) / 2, (s
+00032770: 6861 7065 5b31 5d20 2d20 3129 202f 2032  hape[1] - 1) / 2
+00032780: 2c20 2873 6861 7065 5b32 5d20 2d20 3129  , (shape[2] - 1)
+00032790: 202f 2032 5d0a 2020 2020 2020 2020 696e   / 2].        in
+000327a0: 6469 6365 7320 3d20 5b5d 0a20 2020 2020  dices = [].     
+000327b0: 2020 2023 206d 616b 6520 7375 7265 0a20     # make sure. 
+000327c0: 2020 2020 2020 2078 5f6d 6178 203d 2069         x_max = i
+000327d0: 6e74 2864 3229 202b 2069 6e74 284f 315b  nt(d2) + int(O1[
+000327e0: 305d 2920 2b20 3120 6966 2069 6e74 2864  0]) + 1 if int(d
+000327f0: 3229 202b 2069 6e74 284f 315b 305d 2920  2) + int(O1[0]) 
+00032800: 3c20 7368 6170 655b 305d 2065 6c73 6520  < shape[0] else 
+00032810: 696e 7428 6432 2920 2b20 696e 7428 4f31  int(d2) + int(O1
+00032820: 5b30 5d29 0a20 2020 2020 2020 2079 5f6d  [0]).        y_m
+00032830: 6178 203d 2069 6e74 2864 3229 202b 2069  ax = int(d2) + i
+00032840: 6e74 284f 315b 315d 2920 2b20 3120 6966  nt(O1[1]) + 1 if
+00032850: 2069 6e74 2864 3229 202b 2069 6e74 284f   int(d2) + int(O
+00032860: 315b 315d 2920 3c20 7368 6170 655b 315d  1[1]) < shape[1]
+00032870: 2065 6c73 6520 696e 7428 6432 2920 2b20   else int(d2) + 
+00032880: 696e 7428 4f31 5b31 5d29 0a20 2020 2020  int(O1[1]).     
+00032890: 2020 2066 6f72 2078 2069 6e20 7261 6e67     for x in rang
+000328a0: 6528 726f 756e 6428 4f31 5b30 5d20 2b20  e(round(O1[0] + 
+000328b0: 302e 3129 2c20 785f 6d61 7829 3a0a 2020  0.1), x_max):.  
+000328c0: 2020 2020 2020 2020 2020 666f 7220 7920            for y 
+000328d0: 696e 2072 616e 6765 2872 6f75 6e64 284f  in range(round(O
+000328e0: 315b 315d 202b 2030 2e31 292c 2079 5f6d  1[1] + 0.1), y_m
+000328f0: 6178 293a 0a20 2020 2020 2020 2020 2020  ax):.           
+00032900: 2020 2020 2078 795f 6469 7374 203d 206d       xy_dist = m
+00032910: 6174 682e 7371 7274 2828 7820 2d20 4f31  ath.sqrt((x - O1
+00032920: 5b30 5d29 202a 2a20 3220 2b20 2879 202d  [0]) ** 2 + (y -
+00032930: 204f 315b 315d 2920 2a2a 2032 290a 2020   O1[1]) ** 2).  
+00032940: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00032950: 2078 795f 6469 7374 203c 3d20 6432 3a0a   xy_dist <= d2:.
+00032960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032970: 2020 2020 6966 2078 795f 6469 7374 203d      if xy_dist =
+00032980: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
+00032990: 2020 2020 2020 2020 2020 2020 207a 5f6d               z_m
+000329a0: 696e 203d 2069 6e74 284f 315b 325d 202b  in = int(O1[2] +
+000329b0: 2064 3129 0a20 2020 2020 2020 2020 2020   d1).           
+000329c0: 2020 2020 2020 2020 2020 2020 207a 5f6d               z_m
+000329d0: 6178 203d 2069 6e74 284f 315b 325d 202b  ax = int(O1[2] +
+000329e0: 2064 3229 0a20 2020 2020 2020 2020 2020   d2).           
+000329f0: 2020 2020 2020 2020 2065 6c69 6620 7879           elif xy
+00032a00: 5f64 6973 7420 3c20 6431 3a0a 2020 2020  _dist < d1:.    
+00032a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032a20: 2020 2020 7a5f 6d69 6e20 3d20 6d61 7468      z_min = math
+00032a30: 2e73 7172 7428 6431 202a 2a20 3220 2d20  .sqrt(d1 ** 2 - 
+00032a40: 7879 5f64 6973 7420 2a2a 2032 2920 2b20  xy_dist ** 2) + 
+00032a50: 4f31 5b32 5d0a 2020 2020 2020 2020 2020  O1[2].          
+00032a60: 2020 2020 2020 2020 2020 2020 2020 7a5f                z_
+00032a70: 6d69 6e20 3d20 696e 7428 7a5f 6d69 6e29  min = int(z_min)
+00032a80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00032a90: 2020 2020 2020 2020 207a 5f6d 6178 203d           z_max =
+00032aa0: 206d 6174 682e 7371 7274 2864 3220 2a2a   math.sqrt(d2 **
+00032ab0: 2032 202d 2078 795f 6469 7374 202a 2a20   2 - xy_dist ** 
+00032ac0: 3229 202b 204f 315b 325d 0a20 2020 2020  2) + O1[2].     
+00032ad0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00032ae0: 6c69 6620 6431 203c 3d20 7879 5f64 6973  lif d1 <= xy_dis
+00032af0: 7420 3c3d 2064 323a 0a20 2020 2020 2020  t <= d2:.       
+00032b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032b10: 207a 5f6d 696e 203d 204f 315b 325d 0a20   z_min = O1[2]. 
+00032b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032b30: 2020 2020 2020 207a 5f6d 6178 203d 206d         z_max = m
+00032b40: 6174 682e 7371 7274 2864 3220 2a2a 2032  ath.sqrt(d2 ** 2
+00032b50: 202d 2078 795f 6469 7374 202a 2a20 3229   - xy_dist ** 2)
+00032b60: 202b 204f 315b 325d 0a20 2020 2020 2020   + O1[2].       
+00032b70: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+00032b80: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00032b90: 2020 2020 2020 2020 2020 207a 5f6d 696e             z_min
+00032ba0: 203d 204f 315b 325d 0a20 2020 2020 2020   = O1[2].       
+00032bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032bc0: 207a 5f6d 6178 203d 204f 315b 325d 0a20   z_max = O1[2]. 
+00032bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032be0: 2020 2069 6620 696e 7428 7a5f 6d69 6e29     if int(z_min)
+00032bf0: 203c 204f 315b 325d 3a0a 2020 2020 2020   < O1[2]:.      
+00032c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032c10: 2020 7a5f 6d69 6e20 3d20 726f 756e 6428    z_min = round(
+00032c20: 4f31 5b32 5d20 2b20 302e 3129 0a20 2020  O1[2] + 0.1).   
+00032c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032c40: 207a 5f6d 6178 203d 2069 6e74 287a 5f6d   z_max = int(z_m
+00032c50: 6178 2920 2b20 3120 6966 2069 6e74 287a  ax) + 1 if int(z
+00032c60: 5f6d 6178 2920 3c20 7368 6170 655b 325d  _max) < shape[2]
+00032c70: 2065 6c73 6520 696e 7428 7a5f 6d61 7829   else int(z_max)
+00032c80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00032c90: 2020 2020 2066 6f72 207a 2069 6e20 7261       for z in ra
+00032ca0: 6e67 6528 696e 7428 7a5f 6d69 6e29 2c20  nge(int(z_min), 
+00032cb0: 7a5f 6d61 7829 3a0a 2020 2020 2020 2020  z_max):.        
+00032cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032cd0: 2320 7072 696e 7428 782c 2079 2c20 7a29  # print(x, y, z)
+00032ce0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00032cf0: 2020 2020 2020 2020 2064 203d 206d 6174           d = mat
+00032d00: 682e 7371 7274 2878 795f 6469 7374 202a  h.sqrt(xy_dist *
+00032d10: 2a20 3220 2b20 2828 7a20 2d20 4f31 5b32  * 2 + ((z - O1[2
+00032d20: 5d29 202a 2a20 3229 290a 2020 2020 2020  ]) ** 2)).      
+00032d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032d40: 2020 6966 2064 3120 3c20 6420 3c3d 2064    if d1 < d <= d
+00032d50: 323a 0a20 2020 2020 2020 2020 2020 2020  2:.             
+00032d60: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00032d70: 6e64 6963 6573 2e61 7070 656e 6428 5b78  ndices.append([x
+00032d80: 2c20 792c 207a 5d29 0a20 2020 2020 2020  , y, z]).       
+00032d90: 2061 6c6c 5f69 6e64 203d 2073 656c 662e   all_ind = self.
+00032da0: 6170 706c 795f 3364 5f73 796d 6d65 7472  apply_3d_symmetr
+00032db0: 7928 696e 6469 6365 732c 204f 3129 2e61  y(indices, O1).a
+00032dc0: 7374 7970 6528 696e 7429 0a20 2020 2020  stype(int).     
+00032dd0: 2020 2072 6574 7572 6e20 616c 6c5f 696e     return all_in
+00032de0: 640a 0a20 2020 2023 2040 7072 6f66 696c  d..    # @profil
+00032df0: 650a 2020 2020 6465 6620 6e65 775f 7261  e.    def new_ra
+00032e00: 7073 2873 656c 662c 206d 6170 696e 3d4e  ps(self, mapin=N
+00032e10: 6f6e 652c 2077 6f72 6b64 6972 3d4e 6f6e  one, workdir=Non
+00032e20: 652c 206c 6162 656c 3d27 2729 3a0a 2020  e, label=''):.  
+00032e30: 2020 2020 2020 2222 220a 0a20 2020 2020        """..     
+00032e40: 2020 2020 2020 2043 616c 6375 6c61 7469         Calculati
+00032e50: 6f6e 206f 6620 7468 6520 726f 7461 7469  on of the rotati
+00032e60: 6f6e 616c 6c79 2061 7665 7261 6765 2070  onally average p
+00032e70: 6f77 6572 2073 7065 6374 7275 6d20 2852  ower spectrum (R
+00032e80: 4150 5329 0a20 2020 2020 2020 2020 2020  APS).           
+00032e90: 2052 6573 756c 7473 2077 726f 7465 2074   Results wrote t
+00032ea0: 6f20 4a53 4f4e 2066 696c 650a 0a20 2020  o JSON file..   
+00032eb0: 2020 2020 203a 7265 7475 726e 3a20 4e6f       :return: No
+00032ec0: 6e65 0a0a 2020 2020 2020 2020 2222 220a  ne..        """.
+00032ed0: 0a20 2020 2020 2020 206d 6170 2c20 776f  .        map, wo
+00032ee0: 726b 6469 7220 3d20 7365 6c66 2e6d 6170  rkdir = self.map
+00032ef0: 696e 6368 6563 6b28 6d61 7069 6e2c 2077  incheck(mapin, w
+00032f00: 6f72 6b64 6972 290a 2020 2020 2020 2020  orkdir).        
+00032f10: 6d61 706e 616d 6520 3d20 6f73 2e70 6174  mapname = os.pat
+00032f20: 682e 6261 7365 6e61 6d65 286d 6170 2e66  h.basename(map.f
+00032f30: 756c 6c6e 616d 6529 0a20 2020 2020 2020  ullname).       
+00032f40: 2061 7069 785f 6c69 7374 203d 206d 6170   apix_list = map
+00032f50: 2e76 6f78 656c 5f73 697a 652e 746f 6c69  .voxel_size.toli
+00032f60: 7374 2829 0a20 2020 2020 2020 2061 7069  st().        api
+00032f70: 7873 203d 2028 6170 6978 5f6c 6973 745b  xs = (apix_list[
+00032f80: 305d 2c20 6170 6978 5f6c 6973 745b 315d  0], apix_list[1]
+00032f90: 2c20 6170 6978 5f6c 6973 745b 325d 290a  , apix_list[2]).
+00032fa0: 0a20 2020 2020 2020 2069 6620 6d61 7020  .        if map 
+00032fb0: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
+00032fc0: 776f 726b 6469 7220 6973 206e 6f74 204e  workdir is not N
+00032fd0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00032fe0: 2023 2069 6620 6d61 702e 785f 7369 7a65   # if map.x_size
+00032ff0: 2829 203d 3d20 6d61 702e 795f 7369 7a65  () == map.y_size
+00033000: 2829 203d 3d20 6d61 702e 7a5f 7369 7a65  () == map.z_size
+00033010: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00033020: 6966 206d 6170 2e68 6561 6465 722e 6e78  if map.header.nx
+00033030: 203d 3d20 6d61 702e 6865 6164 6572 2e6e   == map.header.n
+00033040: 7920 3d3d 206d 6170 2e68 6561 6465 722e  y == map.header.
+00033050: 6e7a 3a0a 2020 2020 2020 2020 2020 2020  nz:.            
+00033060: 2020 2020 6572 726c 6973 7420 3d20 5b5d      errlist = []
+00033070: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00033080: 2073 7461 7274 203d 2074 696d 6569 742e   start = timeit.
+00033090: 6465 6661 756c 745f 7469 6d65 7228 290a  default_timer().
+000330a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000330b0: 6461 7461 6469 6374 203d 2064 6963 7428  datadict = dict(
+000330c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000330d0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+000330e0: 2020 2020 2020 2020 2020 2023 206d 6170             # map
+000330f0: 203d 2073 656c 662e 6d61 700a 2020 2020   = self.map.    
+00033100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033110: 2320 7465 6d70 7261 7279 2073 6f6c 7574  # temprary solut
+00033120: 696f 6e20 6173 2074 6865 2074 656d 7079  ion as the tempy
+00033130: 2067 6976 6520 6170 6978 2061 7320 6f6e   give apix as on
+00033140: 6520 7661 6c75 6520 6275 7420 6865 7265  e value but here
+00033150: 2066 726f 6d20 6d72 6366 696c 6520 7765   from mrcfile we
+00033160: 2075 7365 2061 2074 7570 6c65 0a20 2020   use a tuple.   
+00033170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033180: 2023 2069 6620 7479 7065 286d 6170 2e61   # if type(map.a
+00033190: 7069 7829 2069 7320 7475 706c 653a 0a20  pix) is tuple:. 
+000331a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000331b0: 2020 2069 6620 7479 7065 2861 7069 7873     if type(apixs
+000331c0: 2920 6973 2074 7570 6c65 3a0a 2020 2020  ) is tuple:.    
+000331d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000331e0: 2020 2020 6170 6978 203d 2061 7069 7873      apix = apixs
+000331f0: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
+00033200: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00033210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033220: 2020 2020 2020 6170 6978 203d 2061 7069        apix = api
+00033230: 7873 0a20 2020 2020 2020 2020 2020 2020  xs.             
+00033240: 2020 2020 2020 2066 6674 6d61 7020 3d20         fftmap = 
+00033250: 6666 7473 6869 6674 2866 6674 6e28 6d61  fftshift(fftn(ma
+00033260: 702e 6461 7461 2929 0a20 2020 2020 2020  p.data)).       
+00033270: 2020 2020 2020 2020 2020 2020 2070 736d               psm
+00033280: 6561 6e20 3d20 6e70 2e6d 6561 6e28 6666  ean = np.mean(ff
+00033290: 746d 6170 290a 2020 2020 2020 2020 2020  tmap).          
+000332a0: 2020 2020 2020 2020 2020 7073 7374 6420            psstd 
+000332b0: 3d20 6e70 2e73 7464 2866 6674 6d61 7029  = np.std(fftmap)
+000332c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000332d0: 2020 2020 2066 6674 6d61 7020 3d20 6e70       fftmap = np
+000332e0: 2e61 6273 2828 6666 746d 6170 202d 2070  .abs((fftmap - p
+000332f0: 736d 6561 6e29 202f 2070 7373 7464 2920  smean) / psstd) 
+00033300: 2a2a 2032 0a0a 2020 2020 2020 2020 2020  ** 2..          
+00033310: 2020 2020 2020 2020 2020 6d69 6473 7461            midsta
+00033320: 7274 203d 2074 696d 6569 742e 6465 6661  rt = timeit.defa
+00033330: 756c 745f 7469 6d65 7228 2920 2d20 7374  ult_timer() - st
+00033340: 6172 740a 2020 2020 2020 2020 2020 2020  art.            
+00033350: 2020 2020 2020 2020 7072 696e 7428 2720          print(' 
+00033360: 2d2d 2052 4150 5320 466f 7572 6965 722d  -- RAPS Fourier-
+00033370: 7472 616e 7366 6f72 6d61 7469 6f6e 2074  transformation t
+00033380: 696d 653a 2025 7327 2025 206d 6964 7374  ime: %s' % midst
+00033390: 6172 7429 0a0a 2020 2020 2020 2020 2020  art)..          
+000333a0: 2020 2020 2020 2020 2020 2323 2061 7070            ## app
+000333b0: 6c79 696e 6720 6e65 7720 696e 6469 6365  lying new indice
+000333c0: 7320 6675 6e63 7469 6f6e 0a20 2020 2020  s function.     
+000333d0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+000333e0: 6170 5f73 6861 7065 203d 2066 6674 6d61  ap_shape = fftma
+000333f0: 702e 7368 6170 650a 2020 2020 2020 2020  p.shape.        
+00033400: 2020 2020 2020 2020 2020 2020 6170 7320              aps 
+00033410: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
+00033420: 2020 2020 2020 2020 2069 6620 6d61 705f           if map_
+00033430: 7368 6170 655b 305d 2025 2032 203d 3d20  shape[0] % 2 == 
+00033440: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+00033450: 2020 2020 2020 2020 2020 206f 7267 203d             org =
+00033460: 205b 6d61 705f 7368 6170 655b 305d 202f   [map_shape[0] /
+00033470: 2032 2c20 6d61 705f 7368 6170 655b 315d   2, map_shape[1]
+00033480: 202f 2032 2c20 6d61 705f 7368 6170 655b   / 2, map_shape[
+00033490: 325d 202f 2032 5d0a 2020 2020 2020 2020  2] / 2].        
+000334a0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+000334b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000334c0: 2020 2020 2020 2020 2020 6f72 6720 3d20            org = 
+000334d0: 5b28 6d61 705f 7368 6170 655b 305d 202d  [(map_shape[0] -
+000334e0: 2031 2920 2f20 322c 2028 6d61 705f 7368   1) / 2, (map_sh
+000334f0: 6170 655b 315d 202d 2031 2920 2f20 322c  ape[1] - 1) / 2,
+00033500: 2028 6d61 705f 7368 6170 655b 325d 202d   (map_shape[2] -
+00033510: 2031 2920 2f20 325d 0a20 2020 2020 2020   1) / 2].       
+00033520: 2020 2020 2020 2020 2020 2020 2069 6e64               ind
+00033530: 6961 7869 7320 3d20 6e70 2e6c 696e 7370  iaxis = np.linsp
+00033540: 6163 6528 302c 2069 6e74 286f 7267 5b30  ace(0, int(org[0
+00033550: 5d29 2c20 696e 7428 6f72 675b 305d 2920  ]), int(org[0]) 
+00033560: 2b20 3129 202f 2028 6d61 705f 7368 6170  + 1) / (map_shap
+00033570: 655b 305d 202a 2061 7069 7829 0a0a 2020  e[0] * apix)..  
+00033580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033590: 2020 7368 656c 6c5f 7261 6e67 6520 3d20    shell_range = 
+000335a0: 696e 7428 6d61 7828 6d61 705f 7368 6170  int(max(map_shap
+000335b0: 6529 202d 206d 6178 286f 7267 2929 0a20  e) - max(org)). 
+000335c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000335d0: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
+000335e0: 6528 302c 2073 6865 6c6c 5f72 616e 6765  e(0, shell_range
+000335f0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00033600: 2020 2020 2020 2020 2020 2069 6e64 6963             indic
+00033610: 6573 203d 2073 656c 662e 6765 6e65 7261  es = self.genera
+00033620: 7465 5f73 6865 6c6c 2869 2c20 692b 312c  te_shell(i, i+1,
+00033630: 206d 6170 5f73 6861 7065 290a 2020 2020   map_shape).    
+00033640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033650: 2020 2020 7073 756d 203d 206c 6f67 3130      psum = log10
+00033660: 2866 6674 6d61 705b 7475 706c 6528 696e  (fftmap[tuple(in
+00033670: 6469 6365 732e 5429 5d2e 7375 6d28 2920  dices.T)].sum() 
+00033680: 2f20 6c65 6e28 696e 6469 6365 7329 290a  / len(indices)).
+00033690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000336a0: 2020 2020 2020 2020 6170 732e 6170 7065          aps.appe
+000336b0: 6e64 2870 7375 6d29 0a20 2020 2020 2020  nd(psum).       
+000336c0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000336d0: 6170 735b 305d 203c 2030 3a0a 2020 2020  aps[0] < 0:.    
+000336e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000336f0: 2020 2020 6170 735b 305d 203d 2061 7073      aps[0] = aps
+00033700: 5b31 5d0a 2020 2020 2020 2020 2020 2020  [1].            
+00033710: 2020 2020 2020 2020 6966 206d 6170 5f73          if map_s
+00033720: 6861 7065 5b30 5d20 2520 3220 3d3d 2030  hape[0] % 2 == 0
+00033730: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00033740: 2020 2020 2020 2020 2020 6170 732e 696e            aps.in
+00033750: 7365 7274 2830 2c20 6170 735b 305d 290a  sert(0, aps[0]).
+00033760: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00033770: 2020 2020 2064 6174 6164 6963 7420 3d20       datadict = 
+00033780: 7b6c 6162 656c 202b 2027 726f 7461 7469  {label + 'rotati
+00033790: 6f6e 616c 6c79 5f61 7665 7261 6765 645f  onally_averaged_
+000337a0: 706f 7765 725f 7370 6563 7472 756d 273a  power_spectrum':
+000337b0: 2020 7b27 7927 3a20 6e70 2e72 6f75 6e64    {'y': np.round
+000337c0: 2861 7073 2c20 3130 292e 746f 6c69 7374  (aps, 10).tolist
+000337d0: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
+000337e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000337f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033810: 2020 2020 2020 2020 2020 2020 2027 7827               'x'
+00033820: 3a20 6e70 2e72 6f75 6e64 2869 6e64 6961  : np.round(india
+00033830: 7869 732c 2031 3029 2e74 6f6c 6973 7428  xis, 10).tolist(
+00033840: 297d 7d0a 2020 2020 2020 2020 2020 2020  )}}.            
+00033850: 2020 2020 2020 2020 6966 206e 6f74 206c          if not l
+00033860: 6162 656c 3a0a 2020 2020 2020 2020 2020  abel:.          
+00033870: 2020 2020 2020 2020 2020 2020 2020 706c                pl
+00033880: 742e 706c 6f74 286e 702e 726f 756e 6428  t.plot(np.round(
+00033890: 696e 6469 6178 6973 2c20 3429 2e74 6f6c  indiaxis, 4).tol
+000338a0: 6973 7428 292c 206e 702e 726f 756e 6428  ist(), np.round(
+000338b0: 6170 732c 2034 292e 746f 6c69 7374 2829  aps, 4).tolist()
+000338c0: 2c20 6c61 6265 6c3d 2752 4150 5327 290a  , label='RAPS').
+000338d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000338e0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000338f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033900: 2020 706c 742e 706c 6f74 286e 702e 726f    plt.plot(np.ro
+00033910: 756e 6428 696e 6469 6178 6973 2c20 3429  und(indiaxis, 4)
+00033920: 2e74 6f6c 6973 7428 292c 206e 702e 726f  .tolist(), np.ro
+00033930: 756e 6428 6170 732c 2034 292e 746f 6c69  und(aps, 4).toli
+00033940: 7374 2829 2c20 6c61 6265 6c3d 2752 6177  st(), label='Raw
+00033950: 206d 6170 2052 4150 5327 290a 2020 2020   map RAPS').    
+00033960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033970: 706c 742e 6c65 6765 6e64 2829 0a20 2020  plt.legend().   
+00033980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033990: 2070 6c74 2e73 6176 6566 6967 2877 6f72   plt.savefig(wor
+000339a0: 6b64 6972 202b 2073 656c 662e 6d61 706e  kdir + self.mapn
+000339b0: 616d 6520 2b20 275f 7261 7073 2e70 6e67  ame + '_raps.png
+000339c0: 2729 0a0a 2020 2020 2020 2020 2020 2020  ')..            
+000339d0: 2020 2020 6578 6365 7074 3a0a 2020 2020      except:.    
+000339e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000339f0: 6572 7220 3d20 2752 4150 5320 6361 6c63  err = 'RAPS calc
+00033a00: 756c 6174 696f 6e20 6572 726f 723a 207b  ulation error: {
+00033a10: 7d2e 272e 666f 726d 6174 2873 7973 2e65  }.'.format(sys.e
+00033a20: 7863 5f69 6e66 6f28 295b 315d 290a 2020  xc_info()[1]).  
+00033a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033a40: 2020 6572 726c 6973 742e 6170 7065 6e64    errlist.append
+00033a50: 2865 7272 290a 2020 2020 2020 2020 2020  (err).          
+00033a60: 2020 2020 2020 2020 2020 7379 732e 7374            sys.st
+00033a70: 6465 7272 2e77 7269 7465 2865 7272 202b  derr.write(err +
+00033a80: 2027 5c6e 2729 0a0a 2020 2020 2020 2020   '\n')..        
+00033a90: 2020 2020 2020 2020 6966 2065 7272 6c69          if errli
+00033aa0: 7374 3a0a 2020 2020 2020 2020 2020 2020  st:.            
+00033ab0: 2020 2020 2020 2020 6461 7461 6469 6374          datadict
+00033ac0: 203d 207b 2772 6f74 6174 696f 6e61 6c6c   = {'rotationall
+00033ad0: 795f 6176 6572 6167 6564 5f70 6f77 6572  y_averaged_power
+00033ae0: 5f73 7065 6374 7275 6d27 3a20 7b27 6572  _spectrum': {'er
+00033af0: 7227 3a20 7b27 7261 7073 5f65 7272 273a  r': {'raps_err':
+00033b00: 2065 7272 6c69 7374 7d7d 7d0a 0a20 2020   errlist}}}..   
+00033b10: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00033b20: 626f 6f6c 2864 6174 6164 6963 7429 3a0a  bool(datadict):.
+00033b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033b40: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00033b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033b60: 2077 6974 6820 636f 6465 6373 2e6f 7065   with codecs.ope
+00033b70: 6e28 776f 726b 6469 7220 2b20 6d61 706e  n(workdir + mapn
+00033b80: 616d 6520 2b20 275f 7261 7073 2e6a 736f  ame + '_raps.jso
+00033b90: 6e27 2c20 2777 272c 2065 6e63 6f64 696e  n', 'w', encodin
+00033ba0: 673d 2775 7466 2d38 2729 2061 7320 663a  g='utf-8') as f:
+00033bb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00033bc0: 2020 2020 2020 2020 2020 2020 206a 736f               jso
+00033bd0: 6e2e 6475 6d70 2864 6174 6164 6963 742c  n.dump(datadict,
+00033be0: 2066 290a 2020 2020 2020 2020 2020 2020   f).            
+00033bf0: 2020 2020 2020 2020 6578 6365 7074 3a0a          except:.
+00033c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033c10: 2020 2020 2020 2020 7379 732e 7374 6465          sys.stde
+00033c20: 7272 2e77 7269 7465 2827 5361 7669 6e67  rr.write('Saving
+00033c30: 2052 4150 5320 746f 206a 736f 6e20 6572   RAPS to json er
+00033c40: 726f 723a 207b 7d2e 272e 666f 726d 6174  ror: {}.'.format
+00033c50: 2873 7973 2e65 7863 5f69 6e66 6f28 295b  (sys.exc_info()[
+00033c60: 315d 2929 0a20 2020 2020 2020 2020 2020  1])).           
+00033c70: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00033c80: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00033c90: 7973 2e73 7464 6572 722e 7772 6974 6528  ys.stderr.write(
+00033ca0: 274e 6f20 7261 7073 2064 6174 6120 696e  'No raps data in
+00033cb0: 2074 6865 2064 6963 7469 6f6e 6172 792c   the dictionary,
+00033cc0: 206e 6f20 7261 7073 206a 736f 6e20 6669   no raps json fi
+00033cd0: 6c65 2e5c 6e27 290a 0a20 2020 2020 2020  le.\n')..       
+00033ce0: 2020 2020 2020 2020 2065 6e64 203d 2074           end = t
+00033cf0: 696d 6569 742e 6465 6661 756c 745f 7469  imeit.default_ti
+00033d00: 6d65 7228 290a 2020 2020 2020 2020 2020  mer().          
+00033d10: 2020 2020 2020 7072 696e 7428 2752 4150        print('RAP
+00033d20: 5320 7469 6d65 2066 6f72 2025 733a 2025  S time for %s: %
+00033d30: 7327 2025 2028 6d61 706e 616d 652c 2065  s' % (mapname, e
+00033d40: 6e64 202d 2073 7461 7274 2929 0a20 2020  nd - start)).   
+00033d50: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+00033d60: 6e74 2827 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  nt('------------
+00033d70: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00033d80: 2d2d 2d2d 2d2d 2d2d 2729 0a20 2020 2020  --------').     
+00033d90: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00033da0: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+00033db0: 6e74 2827 4e6f 2052 4150 5320 6361 6c63  nt('No RAPS calc
+00033dc0: 756c 6174 696f 6e20 666f 7220 6e6f 6e2d  ulation for non-
+00033dd0: 6375 6269 6320 6d61 702e 2729 0a20 2020  cubic map.').   
+00033de0: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+00033df0: 6e74 2827 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  nt('------------
+00033e00: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00033e10: 2d2d 2d2d 2d2d 2d2d 2729 0a0a 2020 2020  --------')..    
+00033e20: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00033e30: 726e 204e 6f6e 650a 2020 2020 2020 2020  rn None.        
+00033e40: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00033e50: 2020 7072 696e 7428 274e 6f20 5241 5053    print('No RAPS
+00033e60: 2077 6974 686f 7574 2070 726f 7065 7220   without proper 
+00033e70: 6d61 7020 696e 7075 7420 616e 6420 7468  map input and th
+00033e80: 6520 6f75 7470 7574 2064 6972 6563 746f  e output directo
+00033e90: 7279 2069 6e66 6f72 6d61 7469 6f6e 2e27  ry information.'
+00033ea0: 290a 0a20 2020 2023 2041 626f 7665 2048  )..    # Above H
+00033eb0: 6572 6520 6973 2074 6865 2074 6573 7420  ere is the test 
+00033ec0: 6e65 7720 7261 7073 2066 756e 6374 696f  new raps functio
+00033ed0: 6e20 6172 6561 0a0a 0a20 2020 2023 204e  n area...    # N
+00033ee0: 6577 2063 7572 7665 2069 6e74 6572 7365  ew curve interse
+00033ef0: 6374 696f 6e20 6675 6e63 7469 6f6e 730a  ction functions.
+00033f00: 2020 2020 6465 6620 5f72 6563 745f 696e      def _rect_in
+00033f10: 7465 725f 696e 6e65 7228 7365 6c66 2c20  ter_inner(self, 
+00033f20: 7831 2c20 7832 293a 0a20 2020 2020 2020  x1, x2):.       
+00033f30: 206e 3120 3d20 7831 2e73 6861 7065 5b30   n1 = x1.shape[0
+00033f40: 5d20 2d20 310a 2020 2020 2020 2020 6e32  ] - 1.        n2
+00033f50: 203d 2078 322e 7368 6170 655b 305d 202d   = x2.shape[0] -
+00033f60: 2031 0a20 2020 2020 2020 2058 3120 3d20   1.        X1 = 
+00033f70: 6e70 2e63 5f5b 7831 5b3a 2d31 5d2c 2078  np.c_[x1[:-1], x
+00033f80: 315b 313a 5d5d 0a20 2020 2020 2020 2058  1[1:]].        X
+00033f90: 3220 3d20 6e70 2e63 5f5b 7832 5b3a 2d31  2 = np.c_[x2[:-1
+00033fa0: 5d2c 2078 325b 313a 5d5d 0a20 2020 2020  ], x2[1:]].     
+00033fb0: 2020 2053 3120 3d20 6e70 2e74 696c 6528     S1 = np.tile(
+00033fc0: 5831 2e6d 696e 2861 7869 733d 3129 2c20  X1.min(axis=1), 
+00033fd0: 286e 322c 2031 2929 2e54 0a20 2020 2020  (n2, 1)).T.     
+00033fe0: 2020 2053 3220 3d20 6e70 2e74 696c 6528     S2 = np.tile(
+00033ff0: 5832 2e6d 6178 2861 7869 733d 3129 2c20  X2.max(axis=1), 
+00034000: 286e 312c 2031 2929 0a20 2020 2020 2020  (n1, 1)).       
+00034010: 2053 3320 3d20 6e70 2e74 696c 6528 5831   S3 = np.tile(X1
+00034020: 2e6d 6178 2861 7869 733d 3129 2c20 286e  .max(axis=1), (n
+00034030: 322c 2031 2929 2e54 0a20 2020 2020 2020  2, 1)).T.       
+00034040: 2053 3420 3d20 6e70 2e74 696c 6528 5832   S4 = np.tile(X2
+00034050: 2e6d 696e 2861 7869 733d 3129 2c20 286e  .min(axis=1), (n
+00034060: 312c 2031 2929 0a0a 2020 2020 2020 2020  1, 1))..        
+00034070: 7265 7475 726e 2053 312c 2053 322c 2053  return S1, S2, S
+00034080: 332c 2053 340a 0a20 2020 2064 6566 205f  3, S4..    def _
+00034090: 7265 6374 616e 676c 655f 696e 7465 7273  rectangle_inters
+000340a0: 6563 7469 6f6e 2873 656c 662c 2078 312c  ection(self, x1,
+000340b0: 2079 312c 2078 322c 2079 3229 3a0a 2020   y1, x2, y2):.  
+000340c0: 2020 2020 2020 5331 2c20 5332 2c20 5333        S1, S2, S3
+000340d0: 2c20 5334 203d 2073 656c 662e 5f72 6563  , S4 = self._rec
+000340e0: 745f 696e 7465 725f 696e 6e65 7228 7831  t_inter_inner(x1
+000340f0: 2c20 7832 290a 2020 2020 2020 2020 5335  , x2).        S5
+00034100: 2c20 5336 2c20 5337 2c20 5338 203d 2073  , S6, S7, S8 = s
+00034110: 656c 662e 5f72 6563 745f 696e 7465 725f  elf._rect_inter_
+00034120: 696e 6e65 7228 7931 2c20 7932 290a 0a20  inner(y1, y2).. 
+00034130: 2020 2020 2020 2043 3120 3d20 6e70 2e6c         C1 = np.l
+00034140: 6573 735f 6571 7561 6c28 5331 2c20 5332  ess_equal(S1, S2
+00034150: 290a 2020 2020 2020 2020 4332 203d 206e  ).        C2 = n
+00034160: 702e 6772 6561 7465 725f 6571 7561 6c28  p.greater_equal(
+00034170: 5333 2c20 5334 290a 2020 2020 2020 2020  S3, S4).        
+00034180: 4333 203d 206e 702e 6c65 7373 5f65 7175  C3 = np.less_equ
+00034190: 616c 2853 352c 2053 3629 0a20 2020 2020  al(S5, S6).     
+000341a0: 2020 2043 3420 3d20 6e70 2e67 7265 6174     C4 = np.great
+000341b0: 6572 5f65 7175 616c 2853 372c 2053 3829  er_equal(S7, S8)
+000341c0: 0a0a 2020 2020 2020 2020 6969 2c20 6a6a  ..        ii, jj
+000341d0: 203d 206e 702e 6e6f 6e7a 6572 6f28 4331   = np.nonzero(C1
+000341e0: 2026 2043 3220 2620 4333 2026 2043 3429   & C2 & C3 & C4)
+000341f0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00034200: 2069 692c 206a 6a0a 0a20 2020 2064 6566   ii, jj..    def
+00034210: 2063 7572 7665 735f 696e 7465 7273 6563   curves_intersec
+00034220: 7469 6f6e 2873 656c 662c 2078 312c 2079  tion(self, x1, y
+00034230: 312c 2078 322c 2079 3229 3a0a 2020 2020  1, x2, y2):.    
+00034240: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00034250: 4765 7420 7468 6520 696e 7465 7273 6365  Get the intersce
+00034260: 7469 6f6e 206f 6620 7477 6f20 6375 7276  tion of two curv
+00034270: 6573 0a20 2020 2020 2020 2072 6574 7572  es.        retur
+00034280: 6e3a 206c 6973 7420 6f66 206f 6620 7475  n: list of of tu
+00034290: 706c 6520 636f 6e74 6169 6e73 205b 2878  ple contains [(x
+000342a0: 312c 2079 3129 2c20 2878 322c 2079 3229  1, y1), (x2, y2)
+000342b0: 2c20 2e2e 2e5d 2028 6e6f 2064 7570 6c69  , ...] (no dupli
+000342c0: 6361 7465 6420 706f 696e 7473 290a 2020  cated points).  
+000342d0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+000342e0: 2020 7831 203d 206e 702e 6173 6172 7261    x1 = np.asarra
+000342f0: 7928 7831 290a 2020 2020 2020 2020 7832  y(x1).        x2
+00034300: 203d 206e 702e 6173 6172 7261 7928 7832   = np.asarray(x2
+00034310: 290a 2020 2020 2020 2020 7931 203d 206e  ).        y1 = n
+00034320: 702e 6173 6172 7261 7928 7931 290a 2020  p.asarray(y1).  
+00034330: 2020 2020 2020 7932 203d 206e 702e 6173        y2 = np.as
+00034340: 6172 7261 7928 7932 290a 0a20 2020 2020  array(y2)..     
+00034350: 2020 2069 692c 206a 6a20 3d20 7365 6c66     ii, jj = self
+00034360: 2e5f 7265 6374 616e 676c 655f 696e 7465  ._rectangle_inte
+00034370: 7273 6563 7469 6f6e 2878 312c 2079 312c  rsection(x1, y1,
+00034380: 2078 322c 2079 3229 0a20 2020 2020 2020   x2, y2).       
+00034390: 2069 6620 3020 696e 2069 693a 0a20 2020   if 0 in ii:.   
+000343a0: 2020 2020 2020 2020 207a 6572 6f5f 696e           zero_in
+000343b0: 6420 3d20 6e70 2e77 6865 7265 2869 6920  d = np.where(ii 
+000343c0: 3d3d 2030 290a 2020 2020 2020 2020 2020  == 0).          
+000343d0: 2020 6969 203d 206e 702e 6465 6c65 7465    ii = np.delete
+000343e0: 2869 692c 207a 6572 6f5f 696e 6429 0a20  (ii, zero_ind). 
+000343f0: 2020 2020 2020 2020 2020 206a 6a20 3d20             jj = 
+00034400: 6e70 2e64 656c 6574 6528 6a6a 2c20 7a65  np.delete(jj, ze
+00034410: 726f 5f69 6e64 290a 2020 2020 2020 2020  ro_ind).        
+00034420: 6966 2031 2069 6e20 6969 3a0a 2020 2020  if 1 in ii:.    
+00034430: 2020 2020 2020 2020 6f6e 655f 696e 6420          one_ind 
+00034440: 3d20 6e70 2e77 6865 7265 2869 6920 3d3d  = np.where(ii ==
+00034450: 2031 290a 2020 2020 2020 2020 2020 2020   1).            
+00034460: 6969 203d 206e 702e 6465 6c65 7465 2869  ii = np.delete(i
+00034470: 692c 206f 6e65 5f69 6e64 290a 2020 2020  i, one_ind).    
+00034480: 2020 2020 2020 2020 6a6a 203d 206e 702e          jj = np.
+00034490: 6465 6c65 7465 286a 6a2c 206f 6e65 5f69  delete(jj, one_i
+000344a0: 6e64 290a 2020 2020 2020 2020 6e20 3d20  nd).        n = 
+000344b0: 6c65 6e28 6969 290a 0a20 2020 2020 2020  len(ii)..       
+000344c0: 2064 7879 3120 3d20 6e70 2e64 6966 6628   dxy1 = np.diff(
+000344d0: 6e70 2e63 5f5b 7831 2c20 7931 5d2c 2061  np.c_[x1, y1], a
+000344e0: 7869 733d 3029 0a20 2020 2020 2020 2064  xis=0).        d
+000344f0: 7879 3220 3d20 6e70 2e64 6966 6628 6e70  xy2 = np.diff(np
+00034500: 2e63 5f5b 7832 2c20 7932 5d2c 2061 7869  .c_[x2, y2], axi
+00034510: 733d 3029 0a0a 2020 2020 2020 2020 5420  s=0)..        T 
+00034520: 3d20 6e70 2e7a 6572 6f73 2828 342c 206e  = np.zeros((4, n
+00034530: 2929 0a20 2020 2020 2020 2041 4120 3d20  )).        AA = 
+00034540: 6e70 2e7a 6572 6f73 2828 342c 2034 2c20  np.zeros((4, 4, 
+00034550: 6e29 290a 2020 2020 2020 2020 4141 5b30  n)).        AA[0
+00034560: 3a32 2c20 322c 203a 5d20 3d20 2d31 0a20  :2, 2, :] = -1. 
+00034570: 2020 2020 2020 2041 415b 323a 342c 2033         AA[2:4, 3
+00034580: 2c20 3a5d 203d 202d 310a 2020 2020 2020  , :] = -1.      
+00034590: 2020 4141 5b30 3a3a 322c 2030 2c20 3a5d    AA[0::2, 0, :]
+000345a0: 203d 2064 7879 315b 6969 2c20 3a5d 2e54   = dxy1[ii, :].T
+000345b0: 0a20 2020 2020 2020 2041 415b 313a 3a32  .        AA[1::2
+000345c0: 2c20 312c 203a 5d20 3d20 6478 7932 5b6a  , 1, :] = dxy2[j
+000345d0: 6a2c 203a 5d2e 540a 0a20 2020 2020 2020  j, :].T..       
+000345e0: 2042 4220 3d20 6e70 2e7a 6572 6f73 2828   BB = np.zeros((
+000345f0: 342c 206e 2929 0a20 2020 2020 2020 2042  4, n)).        B
+00034600: 425b 302c 203a 5d20 3d20 2d78 315b 6969  B[0, :] = -x1[ii
+00034610: 5d2e 7261 7665 6c28 290a 2020 2020 2020  ].ravel().      
+00034620: 2020 4242 5b31 2c20 3a5d 203d 202d 7832    BB[1, :] = -x2
+00034630: 5b6a 6a5d 2e72 6176 656c 2829 0a20 2020  [jj].ravel().   
+00034640: 2020 2020 2042 425b 322c 203a 5d20 3d20       BB[2, :] = 
+00034650: 2d79 315b 6969 5d2e 7261 7665 6c28 290a  -y1[ii].ravel().
+00034660: 2020 2020 2020 2020 4242 5b33 2c20 3a5d          BB[3, :]
+00034670: 203d 202d 7932 5b6a 6a5d 2e72 6176 656c   = -y2[jj].ravel
+00034680: 2829 0a0a 2020 2020 2020 2020 666f 7220  ()..        for 
+00034690: 6920 696e 2072 616e 6765 286e 293a 0a20  i in range(n):. 
+000346a0: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+000346b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000346c0: 545b 3a2c 2069 5d20 3d20 6e70 2e6c 696e  T[:, i] = np.lin
+000346d0: 616c 672e 736f 6c76 6528 4141 5b3a 2c20  alg.solve(AA[:, 
+000346e0: 3a2c 2069 5d2c 2042 425b 3a2c 2069 5d29  :, i], BB[:, i])
+000346f0: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
+00034700: 6570 743a 0a20 2020 2020 2020 2020 2020  ept:.           
+00034710: 2020 2020 2054 5b3a 2c20 695d 203d 206e       T[:, i] = n
+00034720: 702e 496e 660a 0a20 2020 2020 2020 2069  p.Inf..        i
+00034730: 6e5f 7261 6e67 6520 3d20 2854 5b30 2c20  n_range = (T[0, 
+00034740: 3a5d 203e 3d20 3029 2026 2028 545b 312c  :] >= 0) & (T[1,
+00034750: 203a 5d20 3e3d 2030 2920 2620 280a 2020   :] >= 0) & (.  
+00034760: 2020 2020 2020 2020 2020 2020 2020 545b                T[
+00034770: 302c 203a 5d20 3c3d 2031 2920 2620 2854  0, :] <= 1) & (T
+00034780: 5b31 2c20 3a5d 203c 3d20 3129 0a0a 2020  [1, :] <= 1)..  
+00034790: 2020 2020 2020 7879 3020 3d20 545b 323a        xy0 = T[2:
+000347a0: 2c20 696e 5f72 616e 6765 5d0a 2020 2020  , in_range].    
+000347b0: 2020 2020 7879 3020 3d20 7879 302e 540a      xy0 = xy0.T.
+000347c0: 2020 2020 2020 2020 6e65 776c 6973 7420          newlist 
+000347d0: 3d20 5b5d 0a20 2020 2020 2020 2070 7269  = [].        pri
+000347e0: 6e74 2878 7930 290a 2020 2020 2020 2020  nt(xy0).        
+000347f0: 666f 7220 6920 696e 2078 7930 3a0a 2020  for i in xy0:.  
+00034800: 2020 2020 2020 2020 2020 6120 3d20 7475            a = tu
+00034810: 706c 6528 6929 0a20 2020 2020 2020 2020  ple(i).         
+00034820: 2020 206e 6577 6c69 7374 2e61 7070 656e     newlist.appen
+00034830: 6428 6129 0a20 2020 2020 2020 2072 6573  d(a).        res
+00034840: 203d 206c 6973 7428 7365 7428 6e65 776c   = list(set(newl
+00034850: 6973 7429 290a 2020 2020 2020 2020 7265  ist)).        re
+00034860: 732e 736f 7274 286b 6579 3d6e 6577 6c69  s.sort(key=newli
+00034870: 7374 2e69 6e64 6578 290a 2020 2020 2020  st.index).      
+00034880: 2020 6e6c 6973 7420 3d20 5b5d 0a20 2020    nlist = [].   
+00034890: 2020 2020 2066 6f72 2062 2069 6e20 7265       for b in re
+000348a0: 733a 0a20 2020 2020 2020 2020 2020 206e  s:.            n
+000348b0: 6c69 7374 2e61 7070 656e 6428 6c69 7374  list.append(list
+000348c0: 2862 2929 0a20 2020 2020 2020 206c 7265  (b)).        lre
+000348d0: 7320 3d20 6e70 2e61 7272 6179 286e 6c69  s = np.array(nli
+000348e0: 7374 290a 2020 2020 2020 2020 7072 696e  st).        prin
+000348f0: 7428 6e70 2e61 7272 6179 286e 6c69 7374  t(np.array(nlist
+00034900: 2929 0a20 2020 2020 2020 2070 7269 6e74  )).        print
+00034910: 286e 702e 6172 7261 7928 6e6c 6973 7429  (np.array(nlist)
+00034920: 5b3a 2c20 305d 290a 2020 2020 2020 2020  [:, 0]).        
+00034930: 7072 696e 7428 6e70 2e61 7272 6179 286e  print(np.array(n
+00034940: 6c69 7374 295b 3a2c 2031 5d29 0a20 2020  list)[:, 1]).   
+00034950: 2020 2020 2072 6574 7572 6e20 6c72 6573       return lres
+00034960: 5b3a 2c20 305d 2c20 6c72 6573 5b3a 2c20  [:, 0], lres[:, 
+00034970: 315d 0a0a 2020 2020 2320 456e 6420 6f66  1]..    # End of
+00034980: 206e 6577 2063 7572 7665 2069 6e74 6572   new curve inter
+00034990: 7365 6374 696f 6e20 6675 6e63 7469 6f6e  section function
+000349a0: 730a 0a20 2020 2064 6566 205f 5f69 6e74  s..    def __int
+000349b0: 6572 706f 6c61 7465 645f 696e 7465 7263  erpolated_interc
+000349c0: 6570 7428 7365 6c66 2c20 782c 2079 312c  ept(self, x, y1,
+000349d0: 2079 3229 3a0a 2020 2020 2020 2020 2222   y2):.        ""
+000349e0: 220a 0a20 2020 2020 2020 2020 2020 2046  "..            F
+000349f0: 696e 6420 7468 6520 696e 7465 7263 6570  ind the intercep
+00034a00: 7420 6f66 2074 776f 2063 7572 7665 732c  t of two curves,
+00034a10: 2067 6976 656e 2062 7920 7468 6520 7361   given by the sa
+00034a20: 6d65 2078 2064 6174 610a 0a20 2020 2020  me x data..     
+00034a30: 2020 2022 2222 0a0a 2020 2020 2020 2020     """..        
+00034a40: 6465 6620 696e 7465 7263 6570 7428 706f  def intercept(po
+00034a50: 696e 7431 2c20 706f 696e 7432 2c20 706f  int1, point2, po
+00034a60: 696e 7433 2c20 706f 696e 7434 293a 0a20  int3, point4):. 
+00034a70: 2020 2020 2020 2020 2020 2022 2222 0a0a             """..
 00034a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034a90: 2069 6620 6620 6973 206e 6f74 204e 6f6e   if f is not Non
-00034aa0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00034ab0: 2020 2020 2020 2020 2020 2063 6f6e 7465             conte
-00034ac0: 6e74 203d 206a 736f 6e2e 6c6f 6164 2866  nt = json.load(f
-00034ad0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00034ae0: 2020 2020 2020 2020 2020 6966 2027 6572            if 'er
-00034af0: 7227 206e 6f74 2069 6e20 636f 6e74 656e  r' not in conten
-00034b00: 742e 6b65 7973 2829 3a0a 2020 2020 2020  t.keys():.      
-00034b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034b20: 2020 2020 2020 6675 6c6c 6461 7461 5b73        fulldata[s
-00034b30: 7472 2869 295d 203d 206c 6973 7428 636f  tr(i)] = list(co
-00034b40: 6e74 656e 742e 7661 6c75 6573 2829 295b  ntent.values())[
-00034b50: 305d 0a20 2020 2020 2020 2020 2020 2020  0].             
-00034b60: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00034b70: 756c 6c64 6174 615b 7374 7228 6929 5d5b  ulldata[str(i)][
-00034b80: 276e 616d 6527 5d20 3d20 6d6f 6465 6c6e  'name'] = modeln
-00034b90: 616d 650a 2020 2020 2020 2020 2020 2020  ame.            
-00034ba0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00034bb0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00034bc0: 2020 2020 2020 2020 2020 2020 2020 6375                cu
-00034bd0: 7265 7272 203d 2063 6f6e 7465 6e74 2e76  rerr = content.v
-00034be0: 616c 7565 7328 295b 305d 5b27 6572 7227  alues()[0]['err'
-00034bf0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00034c00: 2020 2020 2020 2020 2020 2020 2020 6675                fu
-00034c10: 6c6c 6461 7461 5b73 7472 2869 295d 5b27  lldata[str(i)]['
-00034c20: 6572 7227 5d20 3d20 6375 7265 7272 0a0a  err'] = curerr..
-00034c30: 0a20 2020 2020 2020 206f 7574 7075 7420  .        output 
-00034c40: 3d20 277b 7d7b 7d5f 6d6d 6673 632e 6a73  = '{}{}_mmfsc.js
-00034c50: 6f6e 272e 666f 726d 6174 2873 656c 662e  on'.format(self.
-00034c60: 776f 726b 6469 722c 2073 656c 662e 6d61  workdir, self.ma
-00034c70: 706e 616d 652c 2029 0a20 2020 2020 2020  pname, ).       
-00034c80: 2066 696e 616c 6461 7461 203d 207b 7d0a   finaldata = {}.
-00034c90: 2020 2020 2020 2020 6669 6e61 6c64 6174          finaldat
-00034ca0: 615b 276d 6d66 7363 275d 203d 2066 756c  a['mmfsc'] = ful
-00034cb0: 6c64 6174 610a 2020 2020 2020 2020 7769  ldata.        wi
-00034cc0: 7468 206f 7065 6e28 6f75 7470 7574 2c20  th open(output, 
-00034cd0: 2777 2729 2061 7320 6f75 743a 0a20 2020  'w') as out:.   
-00034ce0: 2020 2020 2020 2020 206a 736f 6e2e 6475           json.du
-00034cf0: 6d70 2866 696e 616c 6461 7461 2c20 6f75  mp(finaldata, ou
-00034d00: 7429 0a0a 2020 2020 2020 2020 7265 7475  t)..        retu
-00034d10: 726e 204e 6f6e 650a 0a20 2020 2064 6566  rn None..    def
-00034d20: 2066 726f 6d6d 7263 5f74 6f74 656d 7079   frommrc_totempy
-00034d30: 2873 656c 662c 2066 756c 6c6d 6170 6e61  (self, fullmapna
-00034d40: 6d65 293a 0a20 2020 2020 2020 2022 2222  me):.        """
-00034d50: 0a20 2020 2020 2020 2020 2020 2054 7261  .            Tra
-00034d60: 6e73 6665 7220 7468 6520 6d72 6366 696c  nsfer the mrcfil
-00034d70: 6520 6d61 7020 6f62 6a65 6374 2074 6f20  e map object to 
-00034d80: 5445 4d50 7920 6d61 7020 6f62 6a65 6374  TEMPy map object
-00034d90: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
-00034da0: 2066 756c 6c6d 6170 6e61 6d65 3a0a 2020   fullmapname:.  
-00034db0: 2020 2020 2020 3a72 6574 7572 6e3a 2054        :return: T
-00034dc0: 454d 5079 206d 6170 206f 626a 6563 740a  EMPy map object.
-00034dd0: 2020 2020 2020 2020 2222 220a 0a0a 2020          """...  
-00034de0: 2020 2020 2020 6d72 636d 6170 203d 206d        mrcmap = m
-00034df0: 7263 6669 6c65 2e6d 6d61 7028 6675 6c6c  rcfile.mmap(full
-00034e00: 6d61 706e 616d 652c 206d 6f64 653d 2772  mapname, mode='r
-00034e10: 2729 0a20 2020 2020 2020 206d 7263 6865  ').        mrche
-00034e20: 6164 6572 203d 206d 7263 6d61 702e 6865  ader = mrcmap.he
-00034e30: 6164 6572 0a20 2020 2020 2020 206d 6170  ader.        map
-00034e40: 6461 7461 203d 206d 7263 6d61 702e 6461  data = mrcmap.da
-00034e50: 7461 2e61 7374 7970 6528 2766 6c6f 6174  ta.astype('float
-00034e60: 2729 0a20 2020 2020 2020 2063 7273 203d  ').        crs =
-00034e70: 2028 6d72 6368 6561 6465 722e 6d61 7063   (mrcheader.mapc
-00034e80: 2c20 6d72 6368 6561 6465 722e 6d61 7072  , mrcheader.mapr
-00034e90: 2c20 6d72 6368 6561 6465 722e 6d61 7073  , mrcheader.maps
-00034ea0: 290a 2020 2020 2020 2020 7265 7665 7273  ).        revers
-00034eb0: 6563 7273 203d 2063 7273 5b3a 3a2d 315d  ecrs = crs[::-1]
-00034ec0: 0a20 2020 2020 2020 206e 7374 6172 7473  .        nstarts
-00034ed0: 203d 2028 6d72 6368 6561 6465 722e 6e78   = (mrcheader.nx
-00034ee0: 7374 6172 742c 206d 7263 6865 6164 6572  start, mrcheader
-00034ef0: 2e6e 7973 7461 7274 2c20 6d72 6368 6561  .nystart, mrchea
-00034f00: 6465 722e 6e7a 7374 6172 7429 0a20 2020  der.nzstart).   
-00034f10: 2020 2020 2073 7464 6372 7320 3d20 2833       stdcrs = (3
-00034f20: 2c20 322c 2031 290a 2020 2020 2020 2020  , 2, 1).        
-00034f30: 6469 6666 6372 7320 3d20 7475 706c 6528  diffcrs = tuple(
-00034f40: 782d 7920 666f 7220 782c 7920 696e 207a  x-y for x,y in z
-00034f50: 6970 2872 6576 6572 7365 6372 732c 2073  ip(reversecrs, s
-00034f60: 7464 6372 7329 290a 2020 2020 2020 2020  tdcrs)).        
-00034f70: 6966 2064 6966 6663 7273 2021 3d20 2830  if diffcrs != (0
-00034f80: 2c20 302c 2030 293a 0a20 2020 2020 2020  , 0, 0):.       
-00034f90: 2020 2020 2069 6620 3120 696e 2064 6966       if 1 in dif
-00034fa0: 6663 7273 2061 6e64 202d 3120 696e 2064  fcrs and -1 in d
-00034fb0: 6966 6663 7273 3a0a 2020 2020 2020 2020  iffcrs:.        
-00034fc0: 2020 2020 2020 2020 6d61 7064 6174 6120          mapdata 
-00034fd0: 3d20 6e70 2e73 7761 7061 7865 7328 6d61  = np.swapaxes(ma
-00034fe0: 7064 6174 612c 2064 6966 6663 7273 2e69  pdata, diffcrs.i
-00034ff0: 6e64 6578 282d 3129 2c20 6469 6666 6372  ndex(-1), diffcr
-00035000: 732e 696e 6465 7828 3129 290a 2020 2020  s.index(1)).    
-00035010: 2020 2020 2020 2020 6966 202d 3220 696e          if -2 in
-00035020: 2064 6966 6663 7273 2061 6e64 2032 2069   diffcrs and 2 i
-00035030: 6e20 6469 6666 6372 733a 0a20 2020 2020  n diffcrs:.     
-00035040: 2020 2020 2020 2020 2020 206d 6170 6461             mapda
-00035050: 7461 203d 206e 702e 7377 6170 6178 6573  ta = np.swapaxes
-00035060: 286d 6170 6461 7461 2c20 6469 6666 6372  (mapdata, diffcr
-00035070: 732e 696e 6465 7828 2d32 292c 2064 6966  s.index(-2), dif
-00035080: 6663 7273 2e69 6e64 6578 2832 2929 0a20  fcrs.index(2)). 
-00035090: 2020 2020 2020 2020 2020 2069 6620 3120             if 1 
-000350a0: 696e 2064 6966 6663 7273 2061 6e64 202d  in diffcrs and -
-000350b0: 3220 696e 2064 6966 6663 7273 3a0a 2020  2 in diffcrs:.  
-000350c0: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-000350d0: 7064 6174 6120 3d20 6e70 2e73 7761 7061  pdata = np.swapa
-000350e0: 7865 7328 6e70 2e73 7761 7061 7865 7328  xes(np.swapaxes(
-000350f0: 6d61 7064 6174 612c 2030 2c20 3129 2c20  mapdata, 0, 1), 
-00035100: 312c 2032 290a 2020 2020 2020 2020 2020  1, 2).          
-00035110: 2020 6966 202d 3120 696e 2064 6966 6663    if -1 in diffc
-00035120: 7273 2061 6e64 2032 2069 6e20 6469 6666  rs and 2 in diff
-00035130: 6372 733a 0a20 2020 2020 2020 2020 2020  crs:.           
-00035140: 2020 2020 206d 6170 6461 7461 203d 206e       mapdata = n
-00035150: 702e 7377 6170 6178 6573 286e 702e 7377  p.swapaxes(np.sw
-00035160: 6170 6178 6573 286d 6170 6461 7461 2c20  apaxes(mapdata, 
-00035170: 312c 2032 292c 2030 2c20 3129 0a20 2020  1, 2), 0, 1).   
-00035180: 2020 2020 2020 2020 2023 206d 6170 6461           # mapda
-00035190: 7461 203d 206e 702e 7377 6170 6178 6573  ta = np.swapaxes
-000351a0: 286d 6170 6461 7461 2c20 302c 2032 290a  (mapdata, 0, 2).
-000351b0: 0a20 2020 2020 2020 2023 206d 6170 6461  .        # mapda
-000351c0: 7461 203d 206e 702e 7377 6170 6178 6573  ta = np.swapaxes
-000351d0: 286e 702e 7377 6170 6178 6573 286d 6170  (np.swapaxes(map
-000351e0: 6461 7461 2c20 302c 2032 292c 2031 2c20  data, 0, 2), 1, 
-000351f0: 3229 0a20 2020 2020 2020 2074 656d 7079  2).        tempy
-00035200: 6865 6164 6572 203d 204d 6170 5061 7273  header = MapPars
-00035210: 6572 2e72 6561 644d 5243 4865 6164 6572  er.readMRCHeader
-00035220: 2866 756c 6c6d 6170 6e61 6d65 290a 0a20  (fullmapname).. 
-00035230: 2020 2020 2020 2023 206e 782c 206e 792c         # nx, ny,
-00035240: 206e 7a20 616e 6420 6e78 7374 6172 742c   nz and nxstart,
-00035250: 206e 7973 7461 7274 2c20 6e7a 7374 6172   nystart, nzstar
-00035260: 7420 6861 7665 7220 746f 2062 6520 6368  t haver to be ch
-00035270: 616e 6765 6420 6163 636f 7264 696e 676c  anged accordingl
-00035280: 7920 746f 2074 6865 2064 6174 610a 2020  y to the data.  
-00035290: 2020 2020 2020 7465 6d70 7968 6561 6465        tempyheade
-000352a0: 7220 3d20 6c69 7374 2874 656d 7079 6865  r = list(tempyhe
-000352b0: 6164 6572 290a 2020 2020 2020 2020 7465  ader).        te
-000352c0: 6d70 7968 6561 6465 725b 305d 203d 206d  mpyheader[0] = m
-000352d0: 6170 6461 7461 2e73 6861 7065 5b32 5d0a  apdata.shape[2].
-000352e0: 2020 2020 2020 2020 7465 6d70 7968 6561          tempyhea
-000352f0: 6465 725b 315d 203d 206d 6170 6461 7461  der[1] = mapdata
-00035300: 2e73 6861 7065 5b31 5d0a 2020 2020 2020  .shape[1].      
-00035310: 2020 7465 6d70 7968 6561 6465 725b 325d    tempyheader[2]
-00035320: 203d 206d 6170 6461 7461 2e73 6861 7065   = mapdata.shape
-00035330: 5b30 5d0a 2020 2020 2020 2020 7465 6d70  [0].        temp
-00035340: 7968 6561 6465 725b 335d 203d 206d 7263  yheader[3] = mrc
-00035350: 6865 6164 6572 2e6d 6f64 652e 6974 656d  header.mode.item
-00035360: 2830 290a 2020 2020 2020 2020 7465 6d70  (0).        temp
-00035370: 7968 6561 6465 725b 345d 203d 206e 7374  yheader[4] = nst
-00035380: 6172 7473 5b30 5d2e 6974 656d 2830 290a  arts[0].item(0).
-00035390: 2020 2020 2020 2020 7465 6d70 7968 6561          tempyhea
-000353a0: 6465 725b 355d 203d 206e 7374 6172 7473  der[5] = nstarts
-000353b0: 5b31 5d2e 6974 656d 2830 290a 2020 2020  [1].item(0).    
-000353c0: 2020 2020 7465 6d70 7968 6561 6465 725b      tempyheader[
-000353d0: 365d 203d 206e 7374 6172 7473 5b32 5d2e  6] = nstarts[2].
-000353e0: 6974 656d 2830 290a 2020 2020 2020 2020  item(0).        
-000353f0: 7465 6d70 7968 6561 6465 725b 375d 203d  tempyheader[7] =
-00035400: 206d 7263 6865 6164 6572 2e6d 782e 6974   mrcheader.mx.it
-00035410: 656d 2830 290a 2020 2020 2020 2020 7465  em(0).        te
-00035420: 6d70 7968 6561 6465 725b 385d 203d 206d  mpyheader[8] = m
-00035430: 7263 6865 6164 6572 2e6d 792e 6974 656d  rcheader.my.item
-00035440: 2830 290a 2020 2020 2020 2020 7465 6d70  (0).        temp
-00035450: 7968 6561 6465 725b 395d 203d 206d 7263  yheader[9] = mrc
-00035460: 6865 6164 6572 2e6d 7a2e 6974 656d 2830  header.mz.item(0
-00035470: 290a 2020 2020 2020 2020 7465 6d70 7968  ).        tempyh
-00035480: 6561 6465 725b 3130 5d20 3d20 6d72 6368  eader[10] = mrch
-00035490: 6561 6465 722e 6365 6c6c 612e 782e 6974  eader.cella.x.it
-000354a0: 656d 2830 290a 2020 2020 2020 2020 7465  em(0).        te
-000354b0: 6d70 7968 6561 6465 725b 3131 5d20 3d20  mpyheader[11] = 
-000354c0: 6d72 6368 6561 6465 722e 6365 6c6c 612e  mrcheader.cella.
-000354d0: 792e 6974 656d 2830 290a 2020 2020 2020  y.item(0).      
-000354e0: 2020 7465 6d70 7968 6561 6465 725b 3132    tempyheader[12
-000354f0: 5d20 3d20 6d72 6368 6561 6465 722e 6365  ] = mrcheader.ce
-00035500: 6c6c 612e 7a2e 6974 656d 2830 290a 2020  lla.z.item(0).  
-00035510: 2020 2020 2020 7465 6d70 7968 6561 6465        tempyheade
-00035520: 725b 3133 3a31 365d 203d 206d 7263 6865  r[13:16] = mrche
-00035530: 6164 6572 2e63 656c 6c62 2e74 6f6c 6973  ader.cellb.tolis
-00035540: 7428 290a 2020 2020 2020 2020 7465 6d70  t().        temp
-00035550: 7968 6561 6465 725b 3136 5d20 3d20 6372  yheader[16] = cr
-00035560: 735b 305d 2e69 7465 6d28 3029 0a20 2020  s[0].item(0).   
-00035570: 2020 2020 2074 656d 7079 6865 6164 6572       tempyheader
-00035580: 5b31 375d 203d 2063 7273 5b31 5d2e 6974  [17] = crs[1].it
-00035590: 656d 2830 290a 2020 2020 2020 2020 7465  em(0).        te
-000355a0: 6d70 7968 6561 6465 725b 3138 5d20 3d20  mpyheader[18] = 
-000355b0: 6372 735b 325d 2e69 7465 6d28 3029 0a20  crs[2].item(0). 
-000355c0: 2020 2020 2020 2074 656d 7079 6865 6164         tempyhead
-000355d0: 6572 5b31 395d 203d 206d 7263 6865 6164  er[19] = mrchead
-000355e0: 6572 2e64 6d69 6e2e 6974 656d 2830 290a  er.dmin.item(0).
-000355f0: 2020 2020 2020 2020 7465 6d70 7968 6561          tempyhea
-00035600: 6465 725b 3230 5d20 3d20 6d72 6368 6561  der[20] = mrchea
-00035610: 6465 722e 646d 6178 2e69 7465 6d28 3029  der.dmax.item(0)
-00035620: 0a20 2020 2020 2020 2074 656d 7079 6865  .        tempyhe
-00035630: 6164 6572 5b32 315d 203d 206d 7263 6865  ader[21] = mrche
-00035640: 6164 6572 2e64 6d65 616e 2e69 7465 6d28  ader.dmean.item(
-00035650: 3029 0a20 2020 2020 2020 2074 656d 7079  0).        tempy
-00035660: 6865 6164 6572 5b32 325d 203d 206d 7263  header[22] = mrc
-00035670: 6865 6164 6572 2e69 7370 672e 6974 656d  header.ispg.item
-00035680: 2830 290a 2020 2020 2020 2020 7465 6d70  (0).        temp
-00035690: 7968 6561 6465 725b 3233 5d20 3d20 6d72  yheader[23] = mr
-000356a0: 6368 6561 6465 722e 6e73 796d 6274 2e69  cheader.nsymbt.i
-000356b0: 7465 6d28 3029 0a0a 2020 2020 2020 2020  tem(0)..        
-000356c0: 7465 6d70 7968 6561 6465 725b 3439 5d20  tempyheader[49] 
-000356d0: 3d20 6d72 6368 6561 6465 722e 6f72 6967  = mrcheader.orig
-000356e0: 696e 2e78 2e69 7465 6d28 3029 0a20 2020  in.x.item(0).   
-000356f0: 2020 2020 2074 656d 7079 6865 6164 6572       tempyheader
-00035700: 5b35 305d 203d 206d 7263 6865 6164 6572  [50] = mrcheader
-00035710: 2e6f 7269 6769 6e2e 792e 6974 656d 2830  .origin.y.item(0
-00035720: 290a 2020 2020 2020 2020 7465 6d70 7968  ).        tempyh
-00035730: 6561 6465 725b 3531 5d20 3d20 6d72 6368  eader[51] = mrch
-00035740: 6561 6465 722e 6f72 6967 696e 2e7a 2e69  eader.origin.z.i
-00035750: 7465 6d28 3029 0a20 2020 2020 2020 2074  tem(0).        t
-00035760: 656d 7079 6865 6164 6572 5b35 323a 3535  empyheader[52:55
-00035770: 5d20 3d20 5b27 4d27 2c20 2741 272c 2027  ] = ['M', 'A', '
-00035780: 5027 5d0a 0a20 2020 2020 2020 2074 656d  P']..        tem
-00035790: 7079 6865 6164 6572 5b35 365d 203d 206d  pyheader[56] = m
-000357a0: 7263 6865 6164 6572 2e6d 6163 6873 740a  rcheader.machst.
-000357b0: 2020 2020 2020 2020 7465 6d70 7968 6561          tempyhea
-000357c0: 6465 725b 3537 5d20 3d20 6d72 6368 6561  der[57] = mrchea
-000357d0: 6465 722e 726d 732e 6974 656d 2830 290a  der.rms.item(0).
-000357e0: 2020 2020 2020 2020 7465 6d70 7968 6561          tempyhea
-000357f0: 6465 7220 3d20 7475 706c 6528 7465 6d70  der = tuple(temp
-00035800: 7968 6561 6465 7229 0a20 2020 2020 2020  yheader).       
-00035810: 206f 7269 6769 6e20 3d20 2866 6c6f 6174   origin = (float
-00035820: 286d 7263 6865 6164 6572 2e6f 7269 6769  (mrcheader.origi
-00035830: 6e2e 7829 2c20 666c 6f61 7428 6d72 6368  n.x), float(mrch
-00035840: 6561 6465 722e 6f72 6967 696e 2e79 292c  eader.origin.y),
-00035850: 2066 6c6f 6174 286d 7263 6865 6164 6572   float(mrcheader
-00035860: 2e6f 7269 6769 6e2e 7a29 290a 2020 2020  .origin.z)).    
-00035870: 2020 2020 6170 6978 203d 2028 6d72 6368      apix = (mrch
-00035880: 6561 6465 722e 6365 6c6c 612e 782f 6d72  eader.cella.x/mr
-00035890: 6368 6561 6465 722e 6d78 2c20 6d72 6368  cheader.mx, mrch
-000358a0: 6561 6465 722e 6365 6c6c 612e 792f 6d72  eader.cella.y/mr
-000358b0: 6368 6561 6465 722e 6d79 2c20 6d72 6368  cheader.my, mrch
-000358c0: 6561 6465 722e 6365 6c6c 612e 7a2f 6d72  eader.cella.z/mr
-000358d0: 6368 6561 6465 722e 6d7a 295b 305d 0a0a  cheader.mz)[0]..
-000358e0: 2020 2020 2020 2020 6669 6e61 6c6d 6170          finalmap
-000358f0: 203d 204d 6170 286d 6170 6461 7461 2c20   = Map(mapdata, 
-00035900: 6f72 6967 696e 2c20 6170 6978 2c20 6675  origin, apix, fu
-00035910: 6c6c 6d61 706e 616d 652c 2068 6561 6465  llmapname, heade
-00035920: 723d 7465 6d70 7968 6561 6465 7229 0a0a  r=tempyheader)..
-00035930: 2020 2020 2020 2020 7265 7475 726e 2066          return f
-00035940: 696e 616c 6d61 700a 0a0a 2020 2020 6465  inalmap...    de
-00035950: 6620 6673 635f 7265 6c69 6f6e 2873 656c  f fsc_relion(sel
-00035960: 6629 3a0a 2020 2020 2020 2020 2222 220a  f):.        """.
-00035970: 2020 2020 2020 2020 5573 696e 6720 5265          Using Re
-00035980: 6c69 6f6e 2074 6f20 6361 6c63 756c 6174  lion to calculat
-00035990: 6520 6673 630a 2020 2020 2020 2020 2222  e fsc.        ""
-000359a0: 220a 0a20 2020 2020 2020 2074 7279 3a0a  "..        try:.
-000359b0: 2020 2020 2020 2020 2020 2020 7374 6172              star
-000359c0: 5f66 696c 6520 3d20 7265 6c69 6f6e 5f66  _file = relion_f
-000359d0: 7363 5f63 616c 6375 6c61 7469 6f6e 2873  sc_calculation(s
-000359e0: 656c 662e 686d 6f64 642e 6675 6c6c 6e61  elf.hmodd.fullna
-000359f0: 6d65 2c20 7365 6c66 2e68 6d65 7665 6e2e  me, self.hmeven.
-00035a00: 6675 6c6c 6e61 6d65 2c20 7365 6c66 2e77  fullname, self.w
-00035a10: 6f72 6b64 6972 2c20 7365 6c66 2e6d 6170  orkdir, self.map
-00035a20: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
-00035a30: 2020 2320 7374 6172 5f66 696c 6520 3d20    # star_file = 
-00035a40: 272f 5573 6572 732f 7a68 652f 446f 776e  '/Users/zhe/Down
-00035a50: 6c6f 6164 732f 7465 7374 732f 5641 2f6e  loads/tests/VA/n
-00035a60: 6673 2f6d 7364 2f77 6f72 6b32 2f65 6d64  fs/msd/work2/emd
-00035a70: 622f 6465 7665 6c6f 706d 656e 742f 7374  b/development/st
-00035a80: 6167 696e 672f 656d 2f38 312f 3831 3137  aging/em/81/8117
-00035a90: 2f76 612f 656d 645f 3831 3137 2e6d 6170  /va/emd_8117.map
-00035aa0: 5f72 656c 696f 6e2f 6673 632f 6673 632e  _relion/fsc/fsc.
-00035ab0: 7374 6172 270a 2020 2020 2020 2020 2020  star'.          
-00035ac0: 2020 7374 6172 203d 2047 6574 5374 6172    star = GetStar
-00035ad0: 7328 7374 6172 5f66 696c 6529 0a20 2020  s(star_file).   
-00035ae0: 2020 2020 2020 2020 2069 6e69 7469 616c           initial
-00035af0: 5f66 7363 5f62 6c6f 636b 203d 2073 7461  _fsc_block = sta
-00035b00: 722e 6461 7461 5f66 7363 5f62 6c6f 636b  r.data_fsc_block
-00035b10: 2829 0a20 2020 2020 2020 2020 2020 2064  ().            d
-00035b20: 6174 615f 6673 635f 626c 6f63 6b20 3d20  ata_fsc_block = 
-00035b30: 7374 6172 2e64 6174 615f 6578 7472 6128  star.data_extra(
-00035b40: 696e 6974 6961 6c5f 6673 635f 626c 6f63  initial_fsc_bloc
-00035b50: 6b29 0a20 2020 2020 2020 2020 2020 2064  k).            d
-00035b60: 6174 615f 6375 7276 6573 203d 2073 7461  ata_curves = sta
-00035b70: 722e 616c 6c5f 6375 7276 6573 2864 6174  r.all_curves(dat
-00035b80: 615f 6673 635f 626c 6f63 6b29 0a20 2020  a_fsc_block).   
-00035b90: 2020 2020 2020 2020 2064 6174 615f 696e           data_in
-00035ba0: 7465 7273 6563 7469 6f6e 7320 3d20 7374  tersections = st
-00035bb0: 6172 2e61 6c6c 5f69 6e74 6572 7365 6374  ar.all_intersect
-00035bc0: 696f 6e28 6461 7461 5f66 7363 5f62 6c6f  ion(data_fsc_blo
-00035bd0: 636b 290a 0a20 2020 2020 2020 2020 2020  ck)..           
-00035be0: 2066 7363 5f64 6963 7420 3d20 7b2a 2a64   fsc_dict = {**d
-00035bf0: 6174 615f 6375 7276 6573 2c20 2a2a 6461  ata_curves, **da
-00035c00: 7461 5f69 6e74 6572 7365 6374 696f 6e73  ta_intersections
-00035c10: 7d0a 2020 2020 2020 2020 2020 2020 6f75  }.            ou
-00035c20: 745f 6469 6374 203d 207b 7d0a 2020 2020  t_dict = {}.    
-00035c30: 2020 2020 2020 2020 6f75 745f 6469 6374          out_dict
-00035c40: 5b27 7265 6c69 6f6e 5f66 7363 275d 203d  ['relion_fsc'] =
-00035c50: 2066 7363 5f64 6963 740a 2020 2020 2020   fsc_dict.      
-00035c60: 2020 2020 2020 6f75 745f 6673 635f 6a73        out_fsc_js
-00035c70: 6f6e 203d 2066 277b 7365 6c66 2e77 6f72  on = f'{self.wor
-00035c80: 6b64 6972 7d7b 7365 6c66 2e6d 6170 6e61  kdir}{self.mapna
-00035c90: 6d65 7d5f 6673 635f 7265 6c69 6f6e 2e6a  me}_fsc_relion.j
-00035ca0: 736f 6e27 0a20 2020 2020 2020 2020 2020  son'.           
-00035cb0: 206f 7574 5f6a 736f 6e28 6f75 745f 6469   out_json(out_di
-00035cc0: 6374 2c20 6f75 745f 6673 635f 6a73 6f6e  ct, out_fsc_json
-00035cd0: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
-00035ce0: 2045 7863 6570 7469 6f6e 2061 7320 653a   Exception as e:
-00035cf0: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-00035d00: 6e74 2865 290a 0a0a 0a20 2020 2023 2040  nt(e)....    # @
-00035d10: 7072 6f66 696c 650a 2020 2020 6465 6620  profile.    def 
-00035d20: 6673 6373 2873 656c 6629 3a0a 2020 2020  fscs(self):.    
-00035d30: 2020 2020 2222 220a 0a0a 0a20 2020 2020      """....     
-00035d40: 2020 203a 7265 7475 726e 3a20 4e6f 6e65     :return: None
-00035d50: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00035d60: 2020 2020 2069 6620 7365 6c66 2e68 6d65       if self.hme
-00035d70: 7665 6e20 6973 206e 6f74 204e 6f6e 6520  ven is not None 
-00035d80: 616e 6420 7365 6c66 2e68 6d6f 6464 2069  and self.hmodd i
-00035d90: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00035da0: 2020 2020 2020 2020 7374 6172 7466 7363          startfsc
-00035db0: 203d 2074 696d 6569 742e 6465 6661 756c   = timeit.defaul
-00035dc0: 745f 7469 6d65 7228 290a 2020 2020 2020  t_timer().      
-00035dd0: 2020 2020 2020 2320 7365 6c66 2e66 7363        # self.fsc
-00035de0: 2873 656c 662e 686d 6576 656e 2c20 7365  (self.hmeven, se
-00035df0: 6c66 2e68 6d6f 6464 290a 2020 2020 2020  lf.hmodd).      
-00035e00: 2020 2020 2020 7365 6c66 2e66 7363 5f72        self.fsc_r
-00035e10: 656c 696f 6e28 290a 2020 2020 2020 2020  elion().        
-00035e20: 2020 2020 7365 6c66 2e6e 6577 5f66 7363      self.new_fsc
-00035e30: 2873 656c 662e 686d 6576 656e 2c20 7365  (self.hmeven, se
-00035e40: 6c66 2e68 6d6f 6464 290a 2020 2020 2020  lf.hmodd).      
-00035e50: 2020 2020 2020 7374 6f70 203d 2074 696d        stop = tim
-00035e60: 6569 742e 6465 6661 756c 745f 7469 6d65  eit.default_time
-00035e70: 7228 290a 2020 2020 2020 2020 2020 2020  r().            
-00035e80: 7072 696e 7428 2746 5343 3a20 2573 2720  print('FSC: %s' 
-00035e90: 2520 2873 746f 7020 2d20 7374 6172 7466  % (stop - startf
-00035ea0: 7363 2929 0a20 2020 2020 2020 2020 2020  sc)).           
-00035eb0: 2070 7269 6e74 2827 2d2d 2d2d 2d2d 2d2d   print('--------
-00035ec0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00035ed0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2729 0a20  ------------'). 
-00035ee0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00035ef0: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
-00035f00: 4d69 7369 6e67 2068 616c 6620 6d61 7028  Mising half map(
-00035f10: 7329 2e27 290a 0a20 2020 2020 2020 2066  s).')..        f
-00035f20: 7363 786d 6c72 6520 3d20 272a 5f66 7363  scxmlre = '*_fsc
-00035f30: 2e78 6d6c 270a 2020 2020 2020 2020 6673  .xml'.        fs
-00035f40: 6378 6d6c 6172 7220 3d20 676c 6f62 2e67  cxmlarr = glob.g
-00035f50: 6c6f 6228 7365 6c66 2e77 6f72 6b64 6972  lob(self.workdir
-00035f60: 202b 2066 7363 786d 6c72 6529 0a20 2020   + fscxmlre).   
-00035f70: 2020 2020 2069 6620 6673 6378 6d6c 6172       if fscxmlar
-00035f80: 7220 6f72 2073 656c 662e 6673 6366 696c  r or self.fscfil
-00035f90: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
-00035fa0: 7461 7274 6673 6320 3d20 7469 6d65 6974  tartfsc = timeit
-00035fb0: 2e64 6566 6175 6c74 5f74 696d 6572 2829  .default_timer()
-00035fc0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00035fd0: 662e 7265 6164 6673 6328 290a 2020 2020  f.readfsc().    
-00035fe0: 2020 2020 2020 2020 7374 6f70 203d 2074          stop = t
-00035ff0: 696d 6569 742e 6465 6661 756c 745f 7469  imeit.default_ti
-00036000: 6d65 7228 290a 2020 2020 2020 2020 2020  mer().          
-00036010: 2020 7072 696e 7428 274c 6f61 6420 4653    print('Load FS
-00036020: 433a 2025 7327 2025 2028 7374 6f70 202d  C: %s' % (stop -
-00036030: 2073 7461 7274 6673 6329 290a 2020 2020   startfsc)).    
-00036040: 2020 2020 2020 2020 7072 696e 7428 272d          print('-
-00036050: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00036060: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00036070: 2d2d 2d27 290a 2020 2020 2020 2020 656c  ---').        el
-00036080: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00036090: 7072 696e 7428 274e 6f20 6769 7665 6e20  print('No given 
-000360a0: 4653 4320 6461 7461 2074 6f20 6265 206c  FSC data to be l
-000360b0: 6f61 6465 642e 2729 0a0a 2020 2020 6465  oaded.')..    de
-000360c0: 6620 7265 6164 6673 6328 7365 6c66 2c20  f readfsc(self, 
-000360d0: 6173 796d 3d31 2e30 293a 0a20 2020 2020  asym=1.0):.     
-000360e0: 2020 2022 2222 0a0a 2020 2020 2020 2020     """..        
-000360f0: 3a72 6574 7572 6e3a 0a20 2020 2020 2020  :return:.       
-00036100: 2022 2222 0a20 2020 2020 2020 2069 6d70   """.        imp
-00036110: 6f72 7420 786d 6c2e 6574 7265 652e 456c  ort xml.etree.El
-00036120: 656d 656e 7454 7265 6520 6173 2045 540a  ementTree as ET.
-00036130: 0a20 2020 2020 2020 2065 7272 6c69 7374  .        errlist
-00036140: 203d 205b 5d0a 2020 2020 2020 2020 6669   = [].        fi
-00036150: 6e61 6c64 6963 7420 3d20 6469 6374 2829  naldict = dict()
-00036160: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
-00036170: 662e 6673 6366 696c 6520 6973 206e 6f74  f.fscfile is not
-00036180: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00036190: 2020 2078 6c69 7374 203d 205b 5d0a 2020     xlist = [].  
-000361a0: 2020 2020 2020 2020 2020 796c 6973 7420            ylist 
-000361b0: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
-000361c0: 206d 6170 5f7a 7369 7a65 203d 2073 656c   map_zsize = sel
-000361d0: 662e 6d61 702e 6865 6164 6572 2e6e 7a0a  f.map.header.nz.
-000361e0: 2020 2020 2020 2020 2020 2020 6d61 705f              map_
-000361f0: 7973 697a 6520 3d20 7365 6c66 2e6d 6170  ysize = self.map
-00036200: 2e68 6561 6465 722e 6e79 0a20 2020 2020  .header.ny.     
-00036210: 2020 2020 2020 206d 6170 5f78 7369 7a65         map_xsize
-00036220: 203d 2073 656c 662e 6d61 702e 6865 6164   = self.map.head
-00036230: 6572 2e6e 780a 2020 2020 2020 2020 2020  er.nx.          
-00036240: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00036250: 2020 2020 2020 2066 696c 6566 7363 203d         filefsc =
-00036260: 2073 656c 662e 776f 726b 6469 7220 2b20   self.workdir + 
-00036270: 7365 6c66 2e66 7363 6669 6c65 0a20 2020  self.fscfile.   
-00036280: 2020 2020 2020 2020 2020 2020 2074 7265               tre
-00036290: 6520 3d20 4554 2e70 6172 7365 2866 696c  e = ET.parse(fil
-000362a0: 6566 7363 290a 2020 2020 2020 2020 2020  efsc).          
-000362b0: 2020 2020 2020 726f 6f74 203d 2074 7265        root = tre
-000362c0: 652e 6765 7472 6f6f 7428 290a 2020 2020  e.getroot().    
-000362d0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-000362e0: 6368 696c 6420 696e 2072 6f6f 743a 0a20  child in root:. 
-000362f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036300: 2020 2078 203d 2066 6c6f 6174 2863 6869     x = float(chi
-00036310: 6c64 2e66 696e 6428 2778 2729 2e74 6578  ld.find('x').tex
-00036320: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
-00036330: 2020 2020 2020 2079 203d 2066 6c6f 6174         y = float
-00036340: 2863 6869 6c64 2e66 696e 6428 2779 2729  (child.find('y')
-00036350: 2e74 6578 7429 0a20 2020 2020 2020 2020  .text).         
-00036360: 2020 2020 2020 2020 2020 2078 6c69 7374             xlist
-00036370: 2e61 7070 656e 6428 7829 0a20 2020 2020  .append(x).     
-00036380: 2020 2020 2020 2020 2020 2020 2020 2079                 y
-00036390: 6c69 7374 2e61 7070 656e 6428 7929 0a20  list.append(y). 
-000363a0: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-000363b0: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
-000363c0: 2020 2065 7272 203d 2027 5265 6164 2046     err = 'Read F
-000363d0: 5343 2066 726f 6d20 584d 4c20 6572 726f  SC from XML erro
-000363e0: 723a 207b 7d2e 272e 666f 726d 6174 2873  r: {}.'.format(s
-000363f0: 7973 2e65 7863 5f69 6e66 6f28 295b 315d  ys.exc_info()[1]
-00036400: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00036410: 2020 6572 726c 6973 742e 6170 7065 6e64    errlist.append
-00036420: 2865 7272 290a 2020 2020 2020 2020 2020  (err).          
-00036430: 2020 2020 2020 7379 732e 7374 6465 7272        sys.stderr
-00036440: 2e77 7269 7465 2865 7272 202b 2027 5c6e  .write(err + '\n
-00036450: 2729 0a0a 2020 2020 2020 2020 2020 2020  ')..            
-00036460: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00036470: 2020 2020 2023 2047 7269 6420 6865 7265       # Grid here
-00036480: 2074 6f20 6765 6e65 7261 7465 2066 6f72   to generate for
-00036490: 2074 7261 6369 6e67 2074 6865 2069 6e64   tracing the ind
-000364a0: 6963 6573 206f 6620 6772 6964 7320 7769  ices of grids wi
-000364b0: 7468 2069 6e20 7468 6520 7368 656c 6c73  th in the shells
-000364c0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-000364d0: 2020 7a67 7269 6420 3d20 6e70 2e61 7261    zgrid = np.ara
-000364e0: 6e67 6528 666c 6f6f 7228 6d61 705f 7a73  nge(floor(map_zs
-000364f0: 697a 6520 2f20 322e 3029 202a 202d 312c  ize / 2.0) * -1,
-00036500: 2063 6569 6c28 6d61 705f 7a73 697a 6520   ceil(map_zsize 
-00036510: 2f20 322e 3029 2920 2f20 666c 6f61 7428  / 2.0)) / float(
-00036520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00036530: 2020 2020 2066 6c6f 6f72 286d 6170 5f7a       floor(map_z
-00036540: 7369 7a65 2929 0a20 2020 2020 2020 2020  size)).         
-00036550: 2020 2020 2020 2079 6772 6964 203d 206e         ygrid = n
-00036560: 702e 6172 616e 6765 2866 6c6f 6f72 286d  p.arange(floor(m
-00036570: 6170 5f79 7369 7a65 202f 2032 2e30 2920  ap_ysize / 2.0) 
-00036580: 2a20 2d31 2c20 6365 696c 286d 6170 5f79  * -1, ceil(map_y
-00036590: 7369 7a65 202f 2032 2e30 2929 202f 2066  size / 2.0)) / f
-000365a0: 6c6f 6174 280a 2020 2020 2020 2020 2020  loat(.          
-000365b0: 2020 2020 2020 2020 2020 666c 6f6f 7228            floor(
-000365c0: 6d61 705f 7973 697a 6529 290a 2020 2020  map_ysize)).    
-000365d0: 2020 2020 2020 2020 2020 2020 7867 7269              xgri
-000365e0: 6420 3d20 6e70 2e61 7261 6e67 6528 666c  d = np.arange(fl
-000365f0: 6f6f 7228 6d61 705f 7873 697a 6520 2f20  oor(map_xsize / 
-00036600: 322e 3029 202a 202d 312c 2063 6569 6c28  2.0) * -1, ceil(
-00036610: 6d61 705f 7873 697a 6520 2f20 322e 3029  map_xsize / 2.0)
-00036620: 2920 2f20 666c 6f61 7428 0a20 2020 2020  ) / float(.     
-00036630: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00036640: 6c6f 6f72 286d 6170 5f78 7369 7a65 2929  loor(map_xsize))
-00036650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00036660: 2078 6469 7320 3d20 7867 7269 6420 2a2a   xdis = xgrid **
-00036670: 2032 0a20 2020 2020 2020 2020 2020 2020   2.             
-00036680: 2020 2079 6469 7320 3d20 7967 7269 6420     ydis = ygrid 
-00036690: 2a2a 2032 0a20 2020 2020 2020 2020 2020  ** 2.           
-000366a0: 2020 2020 207a 6469 7320 3d20 7a67 7269       zdis = zgri
-000366b0: 6420 2a2a 2032 0a20 2020 2020 2020 2020  d ** 2.         
-000366c0: 2020 2020 2020 2023 2064 6973 7420 3d20         # dist = 
-000366d0: 6e70 2e73 7172 7428 7a64 6973 5b3a 2c20  np.sqrt(zdis[:, 
-000366e0: 4e6f 6e65 2c20 4e6f 6e65 5d20 2b20 7964  None, None] + yd
-000366f0: 6973 5b3a 2c20 4e6f 6e65 5d20 2b20 7864  is[:, None] + xd
-00036700: 6973 290a 0a20 2020 2020 2020 2020 2020  is)..           
-00036710: 2020 2020 2061 6c6c 6178 6973 203d 206e       allaxis = n
-00036720: 702e 6172 7261 7928 5b7a 6772 6964 2c20  p.array([zgrid, 
-00036730: 7967 7269 642c 2078 6772 6964 5d29 0a20  ygrid, xgrid]). 
-00036740: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00036750: 6d70 696e 6469 6178 6973 203d 206d 6178  mpindiaxis = max
-00036760: 2861 6c6c 6178 6973 2c20 6b65 793d 6c65  (allaxis, key=le
-00036770: 6e29 0a20 2020 2020 2020 2020 2020 2020  n).             
-00036780: 2020 2069 6e64 6961 7869 7374 203d 2074     indiaxist = t
-00036790: 6d70 696e 6469 6178 6973 5b74 6d70 696e  mpindiaxis[tmpin
-000367a0: 6469 6178 6973 203e 3d20 305d 0a20 2020  diaxis >= 0].   
-000367b0: 2020 2020 2020 2020 2020 2020 206c 696e               lin
-000367c0: 6469 203d 206c 656e 2869 6e64 6961 7869  di = len(indiaxi
-000367d0: 7374 290a 2020 2020 2020 2020 2020 2020  st).            
-000367e0: 2020 2020 2320 696e 6469 6178 6973 203d      # indiaxis =
-000367f0: 206e 702e 6c69 6e73 7061 6365 2830 2c20   np.linspace(0, 
-00036800: 3120 2f20 2832 202a 2063 706d 6170 2e61  1 / (2 * cpmap.a
-00036810: 7069 7829 2c20 6c69 6e64 6929 0a0a 2020  pix), lindi)..  
-00036820: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00036830: 4c6f 6f70 696e 6720 7468 726f 7567 6820  Looping through 
-00036840: 616c 6c20 7368 656c 6c73 0a20 2020 2020  all shells.     
-00036850: 2020 2020 2020 2020 2020 2074 6872 6565             three
-00036860: 7369 6720 3d20 5b5d 0a20 2020 2020 2020  sig = [].       
-00036870: 2020 2020 2020 2020 2068 616c 6662 6974           halfbit
-00036880: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
-00036890: 2020 2020 2020 6f6e 6562 6974 203d 205b        onebit = [
-000368a0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-000368b0: 2020 2320 666f 7220 6920 696e 2072 616e    # for i in ran
-000368c0: 6765 286c 656e 2869 6e64 6961 7869 7329  ge(len(indiaxis)
-000368d0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000368e0: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
-000368f0: 6528 6c65 6e28 786c 6973 7429 293a 0a20  e(len(xlist)):. 
-00036900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036910: 2020 2023 2069 6620 6920 3c20 6c65 6e28     # if i < len(
-00036920: 696e 6469 6178 6973 2920 2d20 313a 0a20  indiaxis) - 1:. 
-00036930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036940: 2020 2020 2020 2023 2069 6e64 6963 6573         # indices
-00036950: 203d 206e 702e 6172 6777 6865 7265 2828   = np.argwhere((
-00036960: 6469 7374 203e 3d20 696e 6469 6178 6973  dist >= indiaxis
-00036970: 745b 695d 2920 2620 2864 6973 7420 3c20  t[i]) & (dist < 
-00036980: 696e 6469 6178 6973 745b 6920 2b20 315d  indiaxist[i + 1]
-00036990: 2929 0a0a 2020 2020 2020 2020 2020 2020  ))..            
-000369a0: 2020 2020 2020 2020 766f 6c75 6d65 6469          volumedi
-000369b0: 6666 203d 2028 342e 3020 2f20 332e 3029  ff = (4.0 / 3.0)
-000369c0: 202a 2070 6920 2a20 2828 6920 2b20 3129   * pi * ((i + 1)
-000369d0: 202a 2a20 3320 2d20 6920 2a2a 2033 290a   ** 3 - i ** 3).
-000369e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000369f0: 2020 2020 6e76 6f78 7269 6e67 203d 2076      nvoxring = v
-00036a00: 6f6c 756d 6564 6966 6620 2f20 2831 202a  olumediff / (1 *
-00036a10: 2a20 3329 0a20 2020 2020 2020 2020 2020  * 3).           
-00036a20: 2020 2020 2020 2020 2065 6666 6e76 6f78           effnvox
-00036a30: 203d 2028 6e76 6f78 7269 6e67 202a 2028   = (nvoxring * (
-00036a40: 2831 2e35 202a 2030 2e36 3629 202a 2a20  (1.5 * 0.66) ** 
-00036a50: 3229 2920 2f20 2832 202a 2061 7379 6d29  2)) / (2 * asym)
-00036a60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00036a70: 2020 2020 2069 6620 6566 666e 766f 7820       if effnvox 
-00036a80: 3c20 312e 303a 2065 6666 6e76 6f78 203d  < 1.0: effnvox =
-00036a90: 2031 2e30 0a20 2020 2020 2020 2020 2020   1.0.           
-00036aa0: 2020 2020 2020 2020 2073 7172 6566 666e           sqreffn
-00036ab0: 766f 7820 3d20 6e70 2e73 7172 7428 6566  vox = np.sqrt(ef
-00036ac0: 666e 766f 7829 0a0a 2020 2020 2020 2020  fnvox)..        
-00036ad0: 2020 2020 2020 2020 2020 2020 2320 332d              # 3-
-00036ae0: 7369 676d 6120 6375 7276 650a 2020 2020  sigma curve.    
-00036af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036b00: 6966 2069 2021 3d20 303a 0a20 2020 2020  if i != 0:.     
-00036b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036b20: 2020 2073 6967 7661 6c75 6520 3d20 3320     sigvalue = 3 
-00036b30: 2f20 2873 7172 6566 666e 766f 7820 2b20  / (sqreffnvox + 
-00036b40: 332e 3020 2d20 312e 3029 0a20 2020 2020  3.0 - 1.0).     
-00036b50: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00036b60: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00036b70: 2020 2020 2020 2020 2020 2020 2073 6967               sig
-00036b80: 7661 6c75 6520 3d20 310a 2020 2020 2020  value = 1.      
-00036b90: 2020 2020 2020 2020 2020 2020 2020 7468                th
-00036ba0: 7265 6573 6967 2e61 7070 656e 6428 7369  reesig.append(si
-00036bb0: 6776 616c 7565 290a 0a20 2020 2020 2020  gvalue)..       
-00036bc0: 2020 2020 2020 2020 2020 2020 2023 2048               # H
-00036bd0: 616c 6620 6269 7420 6375 7276 650a 2020  alf bit curve.  
-00036be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036bf0: 2020 6966 2069 2021 3d20 303a 0a20 2020    if i != 0:.   
-00036c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036c10: 2020 2020 2062 6974 7661 6c75 6520 3d20       bitvalue = 
-00036c20: 2830 2e32 3037 3120 2b20 312e 3931 3032  (0.2071 + 1.9102
-00036c30: 202f 2073 7172 6566 666e 766f 7829 202f   / sqreffnvox) /
-00036c40: 2028 312e 3230 3731 202b 2030 2e39 3130   (1.2071 + 0.910
-00036c50: 3220 2f20 7371 7265 6666 6e76 6f78 290a  2 / sqreffnvox).
-00036c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036c70: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00036c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036c90: 2020 6269 7476 616c 7565 203d 2031 0a20    bitvalue = 1. 
-00036ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036cb0: 2020 2068 616c 6662 6974 2e61 7070 656e     halfbit.appen
-00036cc0: 6428 6269 7476 616c 7565 290a 0a20 2020  d(bitvalue)..   
-00036cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036ce0: 2069 6620 6920 213d 2030 3a0a 2020 2020   if i != 0:.    
-00036cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036d00: 2020 2020 6f6e 6562 6974 7661 6c75 6520      onebitvalue 
-00036d10: 3d20 2830 2e35 202b 2032 2e34 3134 3220  = (0.5 + 2.4142 
-00036d20: 2f20 7371 7265 6666 6e76 6f78 2920 2f20  / sqreffnvox) / 
-00036d30: 2831 2e35 202b 2031 2e34 3134 3220 2f20  (1.5 + 1.4142 / 
-00036d40: 7371 7265 6666 6e76 6f78 290a 2020 2020  sqreffnvox).    
-00036d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036d60: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00036d70: 2020 2020 2020 2020 2020 2020 2020 6f6e                on
-00036d80: 6562 6974 7661 6c75 6520 3d20 310a 2020  ebitvalue = 1.  
-00036d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036da0: 2020 6f6e 6562 6974 2e61 7070 656e 6428    onebit.append(
-00036db0: 6f6e 6562 6974 7661 6c75 6529 0a0a 2020  onebitvalue)..  
-00036dc0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00036dd0: 2079 6c69 7374 5b30 5d20 3c3d 2030 3a0a   ylist[0] <= 0:.
-00036de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036df0: 2020 2020 796c 6973 745b 305d 203d 2031      ylist[0] = 1
-00036e00: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00036e10: 2020 6120 3d20 6e70 2e61 7361 7272 6179    a = np.asarray
-00036e20: 2878 6c69 7374 290a 2020 2020 2020 2020  (xlist).        
-00036e30: 2020 2020 2020 2020 6220 3d20 6e70 2e61          b = np.a
-00036e40: 7361 7272 6179 2879 6c69 7374 290a 2020  sarray(ylist).  
-00036e50: 2020 2020 2020 2020 2020 2020 2020 6320                c 
-00036e60: 3d20 6e70 2e61 7361 7272 6179 2874 6872  = np.asarray(thr
-00036e70: 6565 7369 6729 0a20 2020 2020 2020 2020  eesig).         
-00036e80: 2020 2020 2020 2064 203d 206e 702e 6173         d = np.as
-00036e90: 6172 7261 7928 6861 6c66 6269 7429 0a20  array(halfbit). 
-00036ea0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00036eb0: 203d 206e 702e 6173 6172 7261 7928 6f6e   = np.asarray(on
-00036ec0: 6562 6974 290a 2020 2020 2020 2020 2020  ebit).          
-00036ed0: 2020 2020 2020 6620 3d20 6e70 2e66 756c        f = np.ful
-00036ee0: 6c28 286c 656e 2878 6c69 7374 2929 2c20  l((len(xlist)), 
-00036ef0: 302e 3529 0a20 2020 2020 2020 2020 2020  0.5).           
-00036f00: 2020 2020 2067 203d 206e 702e 6675 6c6c       g = np.full
-00036f10: 2828 6c65 6e28 786c 6973 7429 292c 2030  ((len(xlist)), 0
-00036f20: 2e33 3333 290a 2020 2020 2020 2020 2020  .333).          
-00036f30: 2020 2020 2020 6820 3d20 6e70 2e66 756c        h = np.ful
-00036f40: 6c28 286c 656e 2878 6c69 7374 2929 2c20  l((len(xlist)), 
-00036f50: 302e 3134 3329 0a0a 2020 2020 2020 2020  0.143)..        
-00036f60: 2020 2020 2020 2020 6966 206c 656e 2863          if len(c
-00036f70: 2920 3c20 6c65 6e28 6229 3a0a 2020 2020  ) < len(b):.    
-00036f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00036f90: 6220 3d20 625b 3a6c 656e 2863 295d 0a20  b = b[:len(c)]. 
-00036fa0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00036fb0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00036fc0: 2020 2020 2020 2020 2063 203d 2063 5b3a           c = c[:
-00036fd0: 6c65 6e28 6229 5d0a 0a20 2020 2020 2020  len(b)]..       
-00036fe0: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
-00036ff0: 6429 203c 206c 656e 2862 293a 0a20 2020  d) < len(b):.   
-00037000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037010: 2062 203d 2062 5b3a 6c65 6e28 6429 5d0a   b = b[:len(d)].
-00037020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037030: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00037040: 2020 2020 2020 2020 2020 6420 3d20 645b            d = d[
-00037050: 3a6c 656e 2862 295d 0a0a 0a20 2020 2020  :len(b)]...     
-00037060: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
-00037070: 6e28 6529 203c 206c 656e 2862 293a 0a20  n(e) < len(b):. 
-00037080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037090: 2020 2062 203d 2062 5b3a 6c65 6e28 6529     b = b[:len(e)
-000370a0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-000370b0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000370c0: 2020 2020 2020 2020 2020 2020 6520 3d20              e = 
-000370d0: 655b 3a6c 656e 2862 295d 0a0a 0a20 2020  e[:len(b)]...   
-000370e0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000370f0: 6c65 6e28 6629 203c 206c 656e 2862 293a  len(f) < len(b):
-00037100: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00037110: 2020 2020 2062 203d 2062 5b3a 6c65 6e28       b = b[:len(
-00037120: 6629 5d0a 2020 2020 2020 2020 2020 2020  f)].            
-00037130: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00037140: 2020 2020 2020 2020 2020 2020 2020 6620                f 
-00037150: 3d20 665b 3a6c 656e 2862 295d 0a0a 0a20  = f[:len(b)]... 
-00037160: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00037170: 6620 6c65 6e28 6729 203c 206c 656e 2862  f len(g) < len(b
-00037180: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00037190: 2020 2020 2020 2062 203d 2062 5b3a 6c65         b = b[:le
-000371a0: 6e28 6729 5d0a 2020 2020 2020 2020 2020  n(g)].          
-000371b0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-000371c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000371d0: 6720 3d20 675b 3a6c 656e 2862 295d 0a0a  g = g[:len(b)]..
-000371e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000371f0: 6966 206c 656e 2868 2920 3c20 6c65 6e28  if len(h) < len(
-00037200: 6229 3a0a 2020 2020 2020 2020 2020 2020  b):.            
-00037210: 2020 2020 2020 2020 6220 3d20 625b 3a6c          b = b[:l
-00037220: 656e 2868 295d 0a20 2020 2020 2020 2020  en(h)].         
-00037230: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00037240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037250: 2068 203d 2068 5b3a 6c65 6e28 6229 5d0a   h = h[:len(b)].
-00037260: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00037270: 2078 7468 7265 6573 6967 2c20 7974 6872   xthreesig, ythr
-00037280: 6565 7369 6720 3d20 7365 6c66 2e5f 5f69  eesig = self.__i
-00037290: 6e74 6572 706f 6c61 7465 645f 696e 7465  nterpolated_inte
-000372a0: 7263 6570 7428 612c 2062 2c20 6329 0a20  rcept(a, b, c). 
-000372b0: 2020 2020 2020 2020 2020 2020 2020 2078                 x
-000372c0: 6861 6c66 6269 742c 2079 6861 6c66 6269  halfbit, yhalfbi
-000372d0: 7420 3d20 7365 6c66 2e5f 5f69 6e74 6572  t = self.__inter
-000372e0: 706f 6c61 7465 645f 696e 7465 7263 6570  polated_intercep
-000372f0: 7428 612c 2062 2c20 6429 0a20 2020 2020  t(a, b, d).     
-00037300: 2020 2020 2020 2020 2020 2078 6f6e 6562             xoneb
-00037310: 6974 2c20 796f 6e65 6269 7420 3d20 7365  it, yonebit = se
-00037320: 6c66 2e5f 5f69 6e74 6572 706f 6c61 7465  lf.__interpolate
-00037330: 645f 696e 7465 7263 6570 7428 612c 2062  d_intercept(a, b
-00037340: 2c20 6529 0a20 2020 2020 2020 2020 2020  , e).           
-00037350: 2020 2020 2078 6861 6c66 2c20 7968 616c       xhalf, yhal
-00037360: 6620 3d20 7365 6c66 2e5f 5f69 6e74 6572  f = self.__inter
-00037370: 706f 6c61 7465 645f 696e 7465 7263 6570  polated_intercep
-00037380: 7428 612c 2062 2c20 6629 0a20 2020 2020  t(a, b, f).     
-00037390: 2020 2020 2020 2020 2020 2078 6f6e 6574             xonet
-000373a0: 6872 6565 2c20 796f 6e65 7468 7265 6520  hree, yonethree 
-000373b0: 3d20 7365 6c66 2e5f 5f69 6e74 6572 706f  = self.__interpo
-000373c0: 6c61 7465 645f 696e 7465 7263 6570 7428  lated_intercept(
-000373d0: 612c 2062 2c20 6729 0a20 2020 2020 2020  a, b, g).       
-000373e0: 2020 2020 2020 2020 2078 676f 6c64 2c20           xgold, 
-000373f0: 7967 6f6c 6420 3d20 7365 6c66 2e5f 5f69  ygold = self.__i
-00037400: 6e74 6572 706f 6c61 7465 645f 696e 7465  nterpolated_inte
-00037410: 7263 6570 7428 612c 2062 2c20 6829 0a0a  rcept(a, b, h)..
-00037420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037430: 6966 2078 7468 7265 6573 6967 2e73 697a  if xthreesig.siz
-00037440: 6520 3d3d 2030 2061 6e64 2079 7468 7265  e == 0 and ythre
-00037450: 6573 6967 2e73 697a 6520 3d3d 2030 3a0a  esig.size == 0:.
-00037460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037470: 2020 2020 7478 7468 7265 6573 6967 203d      txthreesig =
-00037480: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
-00037490: 2020 2020 2020 2020 2020 7479 7468 7265            tythre
-000374a0: 6573 6967 203d 204e 6f6e 650a 2020 2020  esig = None.    
-000374b0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-000374c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000374d0: 2020 2020 2020 7478 7468 7265 6573 6967        txthreesig
-000374e0: 203d 206e 702e 726f 756e 6428 7874 6872   = np.round(xthr
-000374f0: 6565 7369 675b 305d 5b30 5d2c 2034 290a  eesig[0][0], 4).
-00037500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037510: 2020 2020 7479 7468 7265 6573 6967 203d      tythreesig =
-00037520: 206e 702e 726f 756e 6428 7974 6872 6565   np.round(ythree
-00037530: 7369 675b 305d 5b30 5d2c 2034 290a 0a20  sig[0][0], 4).. 
-00037540: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00037550: 6620 7868 616c 6662 6974 2e73 697a 6520  f xhalfbit.size 
-00037560: 3d3d 2030 2061 6e64 2079 6861 6c66 6269  == 0 and yhalfbi
-00037570: 742e 7369 7a65 203d 3d20 303a 0a20 2020  t.size == 0:.   
-00037580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037590: 2074 7868 616c 6662 6974 203d 204e 6f6e   txhalfbit = Non
-000375a0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-000375b0: 2020 2020 2020 7479 6861 6c66 6269 7420        tyhalfbit 
-000375c0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2020  = None.         
-000375d0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-000375e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000375f0: 2069 6620 6e70 2e69 736e 616e 2878 6861   if np.isnan(xha
-00037600: 6c66 6269 745b 305d 5b30 5d29 3a0a 2020  lfbit[0][0]):.  
-00037610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037620: 2020 2020 2020 7478 6861 6c66 6269 7420        txhalfbit 
-00037630: 3d20 4e6f 6e65 0a20 2020 2020 2020 2020  = None.         
-00037640: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00037650: 7968 616c 6662 6974 203d 204e 6f6e 650a  yhalfbit = None.
-00037660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037670: 2020 2020 2020 2020 7072 696e 7428 2721          print('!
-00037680: 2121 2054 6865 206c 6f61 6465 6420 6673  !! The loaded fs
-00037690: 6320 6861 7320 6e6f 2069 6e74 6572 7365  c has no interse
-000376a0: 6374 696f 6e20 7769 7468 2074 6865 2068  ction with the h
-000376b0: 616c 6620 6269 7420 6375 7276 6520 2121  alf bit curve !!
-000376c0: 2127 290a 2020 2020 2020 2020 2020 2020  !').            
-000376d0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-000376e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000376f0: 2020 2020 2020 7478 6861 6c66 6269 7420        txhalfbit 
-00037700: 3d20 6e70 2e72 6f75 6e64 2878 6861 6c66  = np.round(xhalf
-00037710: 6269 745b 305d 5b30 5d2c 2034 290a 2020  bit[0][0], 4).  
-00037720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037730: 2020 2020 2020 7479 6861 6c66 6269 7420        tyhalfbit 
-00037740: 3d20 6e70 2e72 6f75 6e64 2879 6861 6c66  = np.round(yhalf
-00037750: 6269 745b 305d 5b30 5d2c 2034 290a 0a20  bit[0][0], 4).. 
-00037760: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00037770: 6620 786f 6e65 6269 742e 7369 7a65 203d  f xonebit.size =
-00037780: 3d20 3020 616e 6420 796f 6e65 6269 742e  = 0 and yonebit.
-00037790: 7369 7a65 203d 3d20 303a 0a20 2020 2020  size == 0:.     
-000377a0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-000377b0: 786f 6e65 6269 7420 3d20 4e6f 6e65 0a20  xonebit = None. 
+00034a90: 4669 6e64 2074 6865 2069 6e74 6572 7365  Find the interse
+00034aa0: 6374 696f 6e20 6265 7477 6565 6e20 7477  ction between tw
+00034ab0: 6f20 6c69 6e65 730a 2020 2020 2020 2020  o lines.        
+00034ac0: 2020 2020 2020 2020 7468 6520 6669 7273          the firs
+00034ad0: 7420 6c69 6e65 2069 7320 6465 6669 6e65  t line is define
+00034ae0: 6420 6279 2074 6865 206c 696e 6520 6265  d by the line be
+00034af0: 7477 6565 6e20 706f 696e 7431 2061 6e64  tween point1 and
+00034b00: 2070 6f69 6e74 320a 2020 2020 2020 2020   point2.        
+00034b10: 2020 2020 2020 2020 7468 6520 7365 636f          the seco
+00034b20: 6e64 206c 696e 6520 6973 2064 6566 696e  nd line is defin
+00034b30: 6564 2062 7920 7468 6520 6c69 6e65 2062  ed by the line b
+00034b40: 6574 7765 656e 2070 6f69 6e74 3320 616e  etween point3 an
+00034b50: 6420 706f 696e 7434 0a20 2020 2020 2020  d point4.       
+00034b60: 2020 2020 2020 2020 2065 6163 6820 706f           each po
+00034b70: 696e 7420 6973 2061 6e20 2878 2c79 2920  int is an (x,y) 
+00034b80: 7475 706c 652e 0a0a 2020 2020 2020 2020  tuple...        
+00034b90: 2020 2020 2020 2020 536f 2c20 666f 7220          So, for 
+00034ba0: 6578 616d 706c 652c 2079 6f75 2063 616e  example, you can
+00034bb0: 2066 696e 6420 7468 6520 696e 7465 7273   find the inters
+00034bc0: 6563 7469 6f6e 2062 6574 7765 656e 0a20  ection between. 
+00034bd0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00034be0: 6e74 6572 6365 7074 2828 302c 3029 2c20  ntercept((0,0), 
+00034bf0: 2831 2c31 292c 2028 302c 3129 2c20 2831  (1,1), (0,1), (1
+00034c00: 2c30 2929 203d 2028 302e 352c 2030 2e35  ,0)) = (0.5, 0.5
+00034c10: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+00034c20: 2020 203a 7265 7475 726e 3a20 496e 7465     :return: Inte
+00034c30: 7263 6570 742c 2069 6e20 2878 2c79 2920  rcept, in (x,y) 
+00034c40: 666f 726d 6174 0a0a 2020 2020 2020 2020  format..        
+00034c50: 2020 2020 2222 220a 0a20 2020 2020 2020      """..       
+00034c60: 2020 2020 2064 6566 206c 696e 6528 7031       def line(p1
+00034c70: 2c20 7032 293a 0a20 2020 2020 2020 2020  , p2):.         
+00034c80: 2020 2020 2020 2041 203d 2028 7031 5b31         A = (p1[1
+00034c90: 5d20 2d20 7032 5b31 5d29 0a20 2020 2020  ] - p2[1]).     
+00034ca0: 2020 2020 2020 2020 2020 2042 203d 2028             B = (
+00034cb0: 7032 5b30 5d20 2d20 7031 5b30 5d29 0a20  p2[0] - p1[0]). 
+00034cc0: 2020 2020 2020 2020 2020 2020 2020 2043                 C
+00034cd0: 203d 2028 7031 5b30 5d20 2a20 7032 5b31   = (p1[0] * p2[1
+00034ce0: 5d20 2d20 7032 5b30 5d20 2a20 7031 5b31  ] - p2[0] * p1[1
+00034cf0: 5d29 0a0a 2020 2020 2020 2020 2020 2020  ])..            
+00034d00: 2020 2020 7265 7475 726e 2041 2c20 422c      return A, B,
+00034d10: 202d 430a 0a20 2020 2020 2020 2020 2020   -C..           
+00034d20: 2064 6566 2069 6e74 6572 7365 6374 696f   def intersectio
+00034d30: 6e28 4c31 2c20 4c32 293a 0a20 2020 2020  n(L1, L2):.     
+00034d40: 2020 2020 2020 2020 2020 2044 203d 204c             D = L
+00034d50: 315b 305d 202a 204c 325b 315d 202d 204c  1[0] * L2[1] - L
+00034d60: 315b 315d 202a 204c 325b 305d 0a20 2020  1[1] * L2[0].   
+00034d70: 2020 2020 2020 2020 2020 2020 2044 7820               Dx 
+00034d80: 3d20 4c31 5b32 5d20 2a20 4c32 5b31 5d20  = L1[2] * L2[1] 
+00034d90: 2d20 4c31 5b31 5d20 2a20 4c32 5b32 5d0a  - L1[1] * L2[2].
+00034da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034db0: 4479 203d 204c 315b 305d 202a 204c 325b  Dy = L1[0] * L2[
+00034dc0: 325d 202d 204c 315b 325d 202a 204c 325b  2] - L1[2] * L2[
+00034dd0: 305d 0a0a 2020 2020 2020 2020 2020 2020  0]..            
+00034de0: 2020 2020 7820 3d20 4478 202f 2044 0a20      x = Dx / D. 
+00034df0: 2020 2020 2020 2020 2020 2020 2020 2079                 y
+00034e00: 203d 2044 7920 2f20 440a 0a20 2020 2020   = Dy / D..     
+00034e10: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00034e20: 6e20 782c 2079 0a0a 2020 2020 2020 2020  n x, y..        
+00034e30: 2020 2020 4c31 203d 206c 696e 6528 5b70      L1 = line([p
+00034e40: 6f69 6e74 315b 305d 2c20 706f 696e 7431  oint1[0], point1
+00034e50: 5b31 5d5d 2c20 5b70 6f69 6e74 325b 305d  [1]], [point2[0]
+00034e60: 2c20 706f 696e 7432 5b31 5d5d 290a 2020  , point2[1]]).  
+00034e70: 2020 2020 2020 2020 2020 4c32 203d 206c            L2 = l
+00034e80: 696e 6528 5b70 6f69 6e74 335b 305d 2c20  ine([point3[0], 
+00034e90: 706f 696e 7433 5b31 5d5d 2c20 5b70 6f69  point3[1]], [poi
+00034ea0: 6e74 345b 305d 2c20 706f 696e 7434 5b31  nt4[0], point4[1
+00034eb0: 5d5d 290a 0a20 2020 2020 2020 2020 2020  ]])..           
+00034ec0: 2052 203d 2069 6e74 6572 7365 6374 696f   R = intersectio
+00034ed0: 6e28 4c31 2c20 4c32 290a 0a20 2020 2020  n(L1, L2)..     
+00034ee0: 2020 2020 2020 2072 6574 7572 6e20 520a         return R.
+00034ef0: 0a20 2020 2020 2020 2069 6478 203d 206e  .        idx = n
+00034f00: 702e 6172 6777 6865 7265 286e 702e 6469  p.argwhere(np.di
+00034f10: 6666 286e 702e 7369 676e 2879 3120 2d20  ff(np.sign(y1 - 
+00034f20: 7932 2929 2021 3d20 3029 0a20 2020 2020  y2)) != 0).     
+00034f30: 2020 2023 2052 656d 6f76 6520 7468 6520     # Remove the 
+00034f40: 6669 7273 7420 706f 696e 7420 7573 7561  first point usua
+00034f50: 6c6c 7920 2830 2c20 3129 2074 6f20 6176  lly (0, 1) to av
+00034f60: 6f69 6420 616c 6c20 6375 7276 6573 2073  oid all curves s
+00034f70: 7461 7274 696e 6720 6672 6f6d 2028 302c  tarting from (0,
+00034f80: 2031 2920 7768 6963 6820 7069 636b 2061   1) which pick a
+00034f90: 7320 6f6e 6520 696e 7465 7273 6563 7469  s one intersecti
+00034fa0: 6f6e 0a20 2020 2020 2020 2069 6620 6964  on.        if id
+00034fb0: 782e 7369 7a65 2021 3d20 303a 0a20 2020  x.size != 0:.   
+00034fc0: 2020 2020 2020 2020 2069 6620 6964 785b           if idx[
+00034fd0: 305d 5b30 5d20 3d3d 2030 3a0a 2020 2020  0][0] == 0:.    
+00034fe0: 2020 2020 2020 2020 2020 2020 6964 7820              idx 
+00034ff0: 3d20 6e70 2e64 656c 6574 6528 6964 782c  = np.delete(idx,
+00035000: 2030 2c20 3029 0a20 2020 2020 2020 2020   0, 0).         
+00035010: 2020 2078 632c 2079 6320 3d20 696e 7465     xc, yc = inte
+00035020: 7263 6570 7428 2878 5b69 6478 5d2c 2079  rcept((x[idx], y
+00035030: 315b 6964 785d 292c 2028 2878 5b69 6478  1[idx]), ((x[idx
+00035040: 202b 2031 5d2c 2079 315b 6964 7820 2b20   + 1], y1[idx + 
+00035050: 315d 2929 2c20 2828 785b 6964 785d 2c20  1])), ((x[idx], 
+00035060: 7932 5b69 6478 5d29 292c 0a20 2020 2020  y2[idx])),.     
+00035070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035080: 2020 2020 2020 2020 2020 2828 785b 6964            ((x[id
+00035090: 7820 2b20 315d 2c20 7932 5b69 6478 202b  x + 1], y2[idx +
+000350a0: 2031 5d29 2929 0a20 2020 2020 2020 2020   1]))).         
+000350b0: 2020 2072 6574 7572 6e20 7863 2c20 7963     return xc, yc
+000350c0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+000350d0: 2020 2020 2020 2020 2020 206e 756c 6c61             nulla
+000350e0: 7272 203d 206e 702e 656d 7074 7928 7368  rr = np.empty(sh
+000350f0: 6170 653d 2830 2c20 3029 290a 2020 2020  ape=(0, 0)).    
+00035100: 2020 2020 2020 2020 7265 7475 726e 206e          return n
+00035110: 756c 6c61 7272 2c20 6e75 6c6c 6172 720a  ullarr, nullarr.
+00035120: 0a0a 2020 2020 6465 6620 6d6d 6673 6328  ..    def mmfsc(
+00035130: 7365 6c66 293a 0a20 2020 2020 2020 2022  self):.        "
+00035140: 2222 0a0a 2020 2020 2020 2020 2020 2020  ""..            
+00035150: 4361 6c63 756c 6174 6520 4d6f 6465 6c2d  Calculate Model-
+00035160: 6d61 7020 4653 4320 6261 7365 6420 6f6e  map FSC based on
+00035170: 2073 696d 756c 6174 6564 2064 656e 7369   simulated densi
+00035180: 7479 206d 6170 2066 726f 6d20 6d6f 6465  ty map from mode
+00035190: 6c0a 0a20 2020 2020 2020 203a 7265 7475  l..        :retu
+000351a0: 726e 3a0a 2020 2020 2020 2020 2222 220a  rn:.        """.
+000351b0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+000351c0: 2e70 6c61 7466 6f72 6d20 3d3d 2027 656d  .platform == 'em
+000351d0: 6462 273a 0a20 2020 2020 2020 2020 2020  db':.           
+000351e0: 2073 7461 7274 203d 2074 696d 6569 742e   start = timeit.
+000351f0: 6465 6661 756c 745f 7469 6d65 7228 290a  default_timer().
+00035200: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
+00035210: 6c73 6d61 7073 203d 2073 656c 662e 6d6f  lsmaps = self.mo
+00035220: 6465 6c73 6d61 7073 0a20 2020 2020 2020  delsmaps.       
+00035230: 2020 2020 2023 2320 546f 646f 3a20 436f       ## Todo: Co
+00035240: 6e73 6964 6572 2070 7574 7469 6e67 2074  nsider putting t
+00035250: 6869 7320 6572 7220 696e 666f 726d 6174  his err informat
+00035260: 696f 6e20 696e 746f 2074 6865 2066 696e  ion into the fin
+00035270: 616c 2066 7363 206a 736f 6e20 6669 6c65  al fsc json file
+00035280: 0a20 2020 2020 2020 2020 2020 206d 6f64  .            mod
+00035290: 656c 6d61 7073 6469 6374 203d 207b 7d0a  elmapsdict = {}.
+000352a0: 2020 2020 2020 2020 2020 2020 6f6c 6466              oldf
+000352b0: 696c 6573 203d 205b 5d0a 2020 2020 2020  iles = [].      
+000352c0: 2020 2020 2020 6966 2073 656c 662e 6d65        if self.me
+000352d0: 7420 213d 2027 746f 6d6f 2720 616e 6420  t != 'tomo' and 
+000352e0: 7365 6c66 2e6d 6574 2021 3d20 2763 7279  self.met != 'cry
+000352f0: 7327 2061 6e64 2028 6d6f 6465 6c73 6d61  s' and (modelsma
+00035300: 7073 2069 7320 6e6f 7420 4e6f 6e65 293a  ps is not None):
+00035310: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00035320: 2066 6f72 206d 6f64 656c 6d61 7020 696e   for modelmap in
+00035330: 206d 6f64 656c 736d 6170 733a 0a20 2020   modelsmaps:.   
+00035340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035350: 2023 2072 6561 6420 6d6f 6465 6c20 6d61   # read model ma
+00035360: 700a 2020 2020 2020 2020 2020 2020 2020  p.              
+00035370: 2020 2020 2020 6d6f 6465 6c6e 616d 6520        modelname 
+00035380: 3d20 6f73 2e70 6174 682e 6261 7365 6e61  = os.path.basena
+00035390: 6d65 286d 6f64 656c 6d61 7029 2e73 706c  me(modelmap).spl
+000353a0: 6974 2827 5f27 295b 305d 0a20 2020 2020  it('_')[0].     
+000353b0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+000353c0: 206f 626a 6d6f 6465 6c6d 6170 203d 2073   objmodelmap = s
+000353d0: 656c 662e 6672 6f6d 6d72 635f 746f 7465  elf.frommrc_tote
+000353e0: 6d70 7928 6d6f 6465 6c6d 6170 290a 2020  mpy(modelmap).  
+000353f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035400: 2020 6f62 6a6d 6f64 656c 6d61 7020 3d20    objmodelmap = 
+00035410: 6d72 6366 696c 652e 6d6d 6170 286d 6f64  mrcfile.mmap(mod
+00035420: 656c 6d61 702c 206d 6f64 653d 2772 2729  elmap, mode='r')
+00035430: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00035440: 2020 2020 2023 2073 656c 662e 6673 6328       # self.fsc(
+00035450: 7365 6c66 2e6d 6170 2c20 6f62 6a6d 6f64  self.map, objmod
+00035460: 656c 6d61 702c 206c 6162 656c 3d27 7b7d  elmap, label='{}
+00035470: 5f6d 6d27 2e66 6f72 6d61 7428 6d6f 6465  _mm'.format(mode
+00035480: 6c6e 616d 6529 290a 2020 2020 2020 2020  lname)).        
+00035490: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000354a0: 2e6e 6577 5f66 7363 2873 656c 662e 6d61  .new_fsc(self.ma
+000354b0: 702c 206f 626a 6d6f 6465 6c6d 6170 2c20  p, objmodelmap, 
+000354c0: 6c61 6265 6c3d 277b 7d5f 6d6d 272e 666f  label='{}_mm'.fo
+000354d0: 726d 6174 286d 6f64 656c 6e61 6d65 2929  rmat(modelname))
+000354e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000354f0: 2020 2020 206f 6c64 6e61 6d65 203d 2027       oldname = '
+00035500: 7b7d 7b7d 5f7b 7d5f 6d6d 6673 632e 6a73  {}{}_{}_mmfsc.js
+00035510: 6f6e 272e 666f 726d 6174 2873 656c 662e  on'.format(self.
+00035520: 776f 726b 6469 722c 2073 656c 662e 6d61  workdir, self.ma
+00035530: 706e 616d 652c 206d 6f64 656c 6e61 6d65  pname, modelname
+00035540: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00035550: 2020 2020 2020 6e65 776e 616d 6520 3d20        newname = 
+00035560: 277b 7d7b 7d27 2e66 6f72 6d61 7428 7365  '{}{}'.format(se
+00035570: 6c66 2e77 6f72 6b64 6972 2c20 7365 6c66  lf.workdir, self
+00035580: 2e6d 6170 6e61 6d65 202b 2027 5f27 202b  .mapname + '_' +
+00035590: 206d 6f64 656c 6e61 6d65 202b 2027 5f6d   modelname + '_m
+000355a0: 6d66 7363 2e6a 736f 6e27 290a 2020 2020  mfsc.json').    
+000355b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000355c0: 6966 206f 732e 7061 7468 2e69 7366 696c  if os.path.isfil
+000355d0: 6528 6f6c 646e 616d 6529 3a0a 2020 2020  e(oldname):.    
+000355e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000355f0: 2020 2020 6f6c 6466 696c 6573 2e61 7070      oldfiles.app
+00035600: 656e 6428 6f6c 646e 616d 6529 0a20 2020  end(oldname).   
+00035610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035620: 2020 2020 206f 732e 7265 6e61 6d65 286f       os.rename(o
+00035630: 6c64 6e61 6d65 2c20 6e65 776e 616d 6529  ldname, newname)
+00035640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00035650: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00035660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035670: 2020 2070 7269 6e74 2827 7b7d 2064 6f65     print('{} doe
+00035680: 7320 6e6f 7420 6578 6973 742c 2070 6c65  s not exist, ple
+00035690: 6173 6520 6368 6563 6b2e 272e 666f 726d  ase check.'.form
+000356a0: 6174 286f 6c64 6e61 6d65 2929 0a20 2020  at(oldname)).   
+000356b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000356c0: 206d 6f64 656c 6d61 7073 6469 6374 5b6d   modelmapsdict[m
+000356d0: 6f64 656c 6e61 6d65 5d20 3d20 6e65 776e  odelname] = newn
+000356e0: 616d 650a 2020 2020 2020 2020 2020 2020  ame.            
+000356f0: 2020 2020 7365 6c66 2e6d 6572 6765 6d6d      self.mergemm
+00035700: 6673 6328 6d6f 6465 6c6d 6170 7364 6963  fsc(modelmapsdic
+00035710: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
+00035720: 2020 2073 656c 662e 6465 6c6f 6c64 6d6d     self.deloldmm
+00035730: 6673 6328 6f6c 6466 696c 6573 290a 2020  fsc(oldfiles).  
+00035740: 2020 2020 2020 2020 2020 2020 2020 656e                en
+00035750: 6420 3d20 7469 6d65 6974 2e64 6566 6175  d = timeit.defau
+00035760: 6c74 5f74 696d 6572 2829 0a0a 2020 2020  lt_timer()..    
+00035770: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+00035780: 7428 276d 6d66 7363 2074 696d 653a 2025  t('mmfsc time: %
+00035790: 7327 2025 2028 656e 6420 2d20 7374 6172  s' % (end - star
+000357a0: 7429 290a 2020 2020 2020 2020 2020 2020  t)).            
+000357b0: 2020 2020 7072 696e 7428 272d 2d2d 2d2d      print('-----
+000357c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000357d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d27  ---------------'
+000357e0: 290a 0a20 2020 2020 2020 2020 2020 2065  )..            e
+000357f0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00035800: 2020 2020 2070 7269 6e74 2827 4d6f 6465       print('Mode
+00035810: 6c2d 6d61 7020 4653 4320 6f6e 6c79 2063  l-map FSC only c
+00035820: 616c 6375 6c61 7465 6420 666f 7220 7369  alculated for si
+00035830: 6e67 6c65 2070 6172 7469 636c 6520 6461  ngle particle da
+00035840: 7461 2077 6865 7265 2074 6865 7265 2069  ta where there i
+00035850: 7320 6120 6669 7474 6564 206d 6f64 656c  s a fitted model
+00035860: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
+00035870: 2020 2020 2020 2020 2027 2850 6c65 6173           '(Pleas
+00035880: 6520 7573 6520 2d6d 2073 7020 616e 6420  e use -m sp and 
+00035890: 2d66 2920 6f72 206e 6f20 6d6f 6465 6c20  -f) or no model 
+000358a0: 6d61 7020 6973 2063 616c 6375 6c61 7465  map is calculate
+000358b0: 6420 7573 202d 6920 742f 6620 746f 2073  d us -i t/f to s
+000358c0: 7769 7463 6820 6966 206f 6e20 6f72 206f  witch if on or o
+000358d0: 6666 2e27 290a 0a20 2020 2020 2020 2072  ff.')..        r
+000358e0: 6574 7572 6e20 4e6f 6e65 0a0a 2020 2020  eturn None..    
+000358f0: 6465 6620 6465 6c6f 6c64 6d6d 6673 6328  def deloldmmfsc(
+00035900: 7365 6c66 2c20 6f6c 6466 696c 6573 293a  self, oldfiles):
+00035910: 0a20 2020 2020 2020 2022 2222 0a0a 2020  .        """..  
+00035920: 2020 2020 2020 2020 2020 6465 6c65 7465            delete
+00035930: 2073 6570 6172 6174 6520 6d6d 6673 6320   separate mmfsc 
+00035940: 6669 6c65 7320 746f 2061 766f 6964 206d  files to avoid m
+00035950: 6572 6765 6420 696e 746f 2074 6865 2066  erged into the f
+00035960: 696e 616c 206a 736f 6e0a 0a20 2020 2020  inal json..     
+00035970: 2020 203a 7061 7261 6d20 6f6c 6466 696c     :param oldfil
+00035980: 6573 3a0a 2020 2020 2020 2020 3a72 6574  es:.        :ret
+00035990: 7572 6e3a 204e 6f6e 650a 2020 2020 2020  urn: None.      
+000359a0: 2020 2222 220a 0a20 2020 2020 2020 2069    """..        i
+000359b0: 6620 6f6c 6466 696c 6573 3a0a 2020 2020  f oldfiles:.    
+000359c0: 2020 2020 2020 2020 666f 7220 6669 6c65          for file
+000359d0: 2069 6e20 6f6c 6466 696c 6573 3a0a 2020   in oldfiles:.  
+000359e0: 2020 2020 2020 2020 2020 2020 2020 6f73                os
+000359f0: 2e72 656d 6f76 6528 6669 6c65 290a 2020  .remove(file).  
+00035a00: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+00035a10: 2753 6570 6172 6174 6520 6d6d 6673 6320  'Separate mmfsc 
+00035a20: 6669 6c65 7320 7765 7265 2064 656c 6574  files were delet
+00035a30: 6564 2e27 290a 2020 2020 2020 2020 656c  ed.').        el
+00035a40: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00035a50: 7072 696e 7428 274e 6f20 6d6d 6673 6320  print('No mmfsc 
+00035a60: 6578 6973 742c 206e 6f20 6d6d 6673 6320  exist, no mmfsc 
+00035a70: 6669 6c65 2063 616e 2062 6520 6465 6c65  file can be dele
+00035a80: 7465 6427 290a 0a0a 2020 2020 6465 6620  ted')...    def 
+00035a90: 6d65 7267 656d 6d66 7363 2873 656c 662c  mergemmfsc(self,
+00035aa0: 206d 6d66 7363 6469 6374 293a 0a20 2020   mmfscdict):.   
+00035ab0: 2020 2020 2022 2222 0a0a 2020 2020 2020       """..      
+00035ac0: 2020 2020 2020 4d65 7267 6520 616c 6c20        Merge all 
+00035ad0: 2a5f 6d6d 6673 632e 6a73 6f6e 2066 696c  *_mmfsc.json fil
+00035ae0: 6573 206f 6620 6469 6666 6572 656e 7420  es of different 
+00035af0: 6d6f 6465 6c73 0a0a 2020 2020 2020 2020  models..        
+00035b00: 3a72 6574 7572 6e3a 0a20 2020 2020 2020  :return:.       
+00035b10: 2022 2222 0a0a 2020 2020 2020 2020 6e66   """..        nf
+00035b20: 696c 6573 203d 206c 656e 286c 6973 7428  iles = len(list(
+00035b30: 6d6d 6673 6364 6963 7429 290a 2020 2020  mmfscdict)).    
+00035b40: 2020 2020 6675 6c6c 6461 7461 203d 207b      fulldata = {
+00035b50: 7d0a 2020 2020 2020 2020 666f 7220 692c  }.        for i,
+00035b60: 206d 6f64 656c 6e61 6d65 2069 6e20 7a69   modelname in zi
+00035b70: 7028 7261 6e67 6528 302c 206e 6669 6c65  p(range(0, nfile
+00035b80: 7329 2c20 6c69 7374 286d 6d66 7363 6469  s), list(mmfscdi
+00035b90: 6374 2929 3a0a 2020 2020 2020 2020 2020  ct)):.          
+00035ba0: 2020 6669 6c65 203d 206d 6d66 7363 6469    file = mmfscdi
+00035bb0: 6374 5b6d 6f64 656c 6e61 6d65 5d0a 2020  ct[modelname].  
+00035bc0: 2020 2020 2020 2020 2020 6966 206f 732e            if os.
+00035bd0: 7061 7468 2e67 6574 7369 7a65 2866 696c  path.getsize(fil
+00035be0: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+00035bf0: 2020 2020 7769 7468 206f 7065 6e28 6669      with open(fi
+00035c00: 6c65 2c20 2772 2729 2061 7320 663a 0a20  le, 'r') as f:. 
+00035c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035c20: 2020 2069 6620 6620 6973 206e 6f74 204e     if f is not N
+00035c30: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00035c40: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+00035c50: 7465 6e74 203d 206a 736f 6e2e 6c6f 6164  tent = json.load
+00035c60: 2866 290a 2020 2020 2020 2020 2020 2020  (f).            
+00035c70: 2020 2020 2020 2020 2020 2020 6966 2027              if '
+00035c80: 6572 7227 206e 6f74 2069 6e20 636f 6e74  err' not in cont
+00035c90: 656e 742e 6b65 7973 2829 3a0a 2020 2020  ent.keys():.    
+00035ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035cb0: 2020 2020 2020 2020 6675 6c6c 6461 7461          fulldata
+00035cc0: 5b73 7472 2869 295d 203d 206c 6973 7428  [str(i)] = list(
+00035cd0: 636f 6e74 656e 742e 7661 6c75 6573 2829  content.values()
+00035ce0: 295b 305d 0a20 2020 2020 2020 2020 2020  )[0].           
+00035cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035d00: 2066 756c 6c64 6174 615b 7374 7228 6929   fulldata[str(i)
+00035d10: 5d5b 276e 616d 6527 5d20 3d20 6d6f 6465  ]['name'] = mode
+00035d20: 6c6e 616d 650a 2020 2020 2020 2020 2020  lname.          
+00035d30: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00035d40: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00035d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035d60: 6375 7265 7272 203d 2063 6f6e 7465 6e74  curerr = content
+00035d70: 2e76 616c 7565 7328 295b 305d 5b27 6572  .values()[0]['er
+00035d80: 7227 5d0a 2020 2020 2020 2020 2020 2020  r'].            
+00035d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035da0: 6675 6c6c 6461 7461 5b73 7472 2869 295d  fulldata[str(i)]
+00035db0: 5b27 6572 7227 5d20 3d20 6375 7265 7272  ['err'] = curerr
+00035dc0: 0a0a 0a20 2020 2020 2020 206f 7574 7075  ...        outpu
+00035dd0: 7420 3d20 277b 7d7b 7d5f 6d6d 6673 632e  t = '{}{}_mmfsc.
+00035de0: 6a73 6f6e 272e 666f 726d 6174 2873 656c  json'.format(sel
+00035df0: 662e 776f 726b 6469 722c 2073 656c 662e  f.workdir, self.
+00035e00: 6d61 706e 616d 652c 2029 0a20 2020 2020  mapname, ).     
+00035e10: 2020 2066 696e 616c 6461 7461 203d 207b     finaldata = {
+00035e20: 7d0a 2020 2020 2020 2020 6669 6e61 6c64  }.        finald
+00035e30: 6174 615b 276d 6d66 7363 275d 203d 2066  ata['mmfsc'] = f
+00035e40: 756c 6c64 6174 610a 2020 2020 2020 2020  ulldata.        
+00035e50: 7769 7468 206f 7065 6e28 6f75 7470 7574  with open(output
+00035e60: 2c20 2777 2729 2061 7320 6f75 743a 0a20  , 'w') as out:. 
+00035e70: 2020 2020 2020 2020 2020 206a 736f 6e2e             json.
+00035e80: 6475 6d70 2866 696e 616c 6461 7461 2c20  dump(finaldata, 
+00035e90: 6f75 7429 0a0a 2020 2020 2020 2020 7265  out)..        re
+00035ea0: 7475 726e 204e 6f6e 650a 0a20 2020 2064  turn None..    d
+00035eb0: 6566 2066 726f 6d6d 7263 5f74 6f74 656d  ef frommrc_totem
+00035ec0: 7079 2873 656c 662c 2066 756c 6c6d 6170  py(self, fullmap
+00035ed0: 6e61 6d65 293a 0a20 2020 2020 2020 2022  name):.        "
+00035ee0: 2222 0a20 2020 2020 2020 2020 2020 2054  "".            T
+00035ef0: 7261 6e73 6665 7220 7468 6520 6d72 6366  ransfer the mrcf
+00035f00: 696c 6520 6d61 7020 6f62 6a65 6374 2074  ile map object t
+00035f10: 6f20 5445 4d50 7920 6d61 7020 6f62 6a65  o TEMPy map obje
+00035f20: 6374 0a0a 2020 2020 2020 2020 3a70 6172  ct..        :par
+00035f30: 616d 2066 756c 6c6d 6170 6e61 6d65 3a0a  am fullmapname:.
+00035f40: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
+00035f50: 2054 454d 5079 206d 6170 206f 626a 6563   TEMPy map objec
+00035f60: 740a 2020 2020 2020 2020 2222 220a 0a0a  t.        """...
+00035f70: 2020 2020 2020 2020 6d72 636d 6170 203d          mrcmap =
+00035f80: 206d 7263 6669 6c65 2e6d 6d61 7028 6675   mrcfile.mmap(fu
+00035f90: 6c6c 6d61 706e 616d 652c 206d 6f64 653d  llmapname, mode=
+00035fa0: 2772 2729 0a20 2020 2020 2020 206d 7263  'r').        mrc
+00035fb0: 6865 6164 6572 203d 206d 7263 6d61 702e  header = mrcmap.
+00035fc0: 6865 6164 6572 0a20 2020 2020 2020 206d  header.        m
+00035fd0: 6170 6461 7461 203d 206d 7263 6d61 702e  apdata = mrcmap.
+00035fe0: 6461 7461 2e61 7374 7970 6528 2766 6c6f  data.astype('flo
+00035ff0: 6174 2729 0a20 2020 2020 2020 2063 7273  at').        crs
+00036000: 203d 2028 6d72 6368 6561 6465 722e 6d61   = (mrcheader.ma
+00036010: 7063 2c20 6d72 6368 6561 6465 722e 6d61  pc, mrcheader.ma
+00036020: 7072 2c20 6d72 6368 6561 6465 722e 6d61  pr, mrcheader.ma
+00036030: 7073 290a 2020 2020 2020 2020 7265 7665  ps).        reve
+00036040: 7273 6563 7273 203d 2063 7273 5b3a 3a2d  rsecrs = crs[::-
+00036050: 315d 0a20 2020 2020 2020 206e 7374 6172  1].        nstar
+00036060: 7473 203d 2028 6d72 6368 6561 6465 722e  ts = (mrcheader.
+00036070: 6e78 7374 6172 742c 206d 7263 6865 6164  nxstart, mrchead
+00036080: 6572 2e6e 7973 7461 7274 2c20 6d72 6368  er.nystart, mrch
+00036090: 6561 6465 722e 6e7a 7374 6172 7429 0a20  eader.nzstart). 
+000360a0: 2020 2020 2020 2073 7464 6372 7320 3d20         stdcrs = 
+000360b0: 2833 2c20 322c 2031 290a 2020 2020 2020  (3, 2, 1).      
+000360c0: 2020 6469 6666 6372 7320 3d20 7475 706c    diffcrs = tupl
+000360d0: 6528 782d 7920 666f 7220 782c 7920 696e  e(x-y for x,y in
+000360e0: 207a 6970 2872 6576 6572 7365 6372 732c   zip(reversecrs,
+000360f0: 2073 7464 6372 7329 290a 2020 2020 2020   stdcrs)).      
+00036100: 2020 6966 2064 6966 6663 7273 2021 3d20    if diffcrs != 
+00036110: 2830 2c20 302c 2030 293a 0a20 2020 2020  (0, 0, 0):.     
+00036120: 2020 2020 2020 2069 6620 3120 696e 2064         if 1 in d
+00036130: 6966 6663 7273 2061 6e64 202d 3120 696e  iffcrs and -1 in
+00036140: 2064 6966 6663 7273 3a0a 2020 2020 2020   diffcrs:.      
+00036150: 2020 2020 2020 2020 2020 6d61 7064 6174            mapdat
+00036160: 6120 3d20 6e70 2e73 7761 7061 7865 7328  a = np.swapaxes(
+00036170: 6d61 7064 6174 612c 2064 6966 6663 7273  mapdata, diffcrs
+00036180: 2e69 6e64 6578 282d 3129 2c20 6469 6666  .index(-1), diff
+00036190: 6372 732e 696e 6465 7828 3129 290a 2020  crs.index(1)).  
+000361a0: 2020 2020 2020 2020 2020 6966 202d 3220            if -2 
+000361b0: 696e 2064 6966 6663 7273 2061 6e64 2032  in diffcrs and 2
+000361c0: 2069 6e20 6469 6666 6372 733a 0a20 2020   in diffcrs:.   
+000361d0: 2020 2020 2020 2020 2020 2020 206d 6170               map
+000361e0: 6461 7461 203d 206e 702e 7377 6170 6178  data = np.swapax
+000361f0: 6573 286d 6170 6461 7461 2c20 6469 6666  es(mapdata, diff
+00036200: 6372 732e 696e 6465 7828 2d32 292c 2064  crs.index(-2), d
+00036210: 6966 6663 7273 2e69 6e64 6578 2832 2929  iffcrs.index(2))
+00036220: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00036230: 3120 696e 2064 6966 6663 7273 2061 6e64  1 in diffcrs and
+00036240: 202d 3220 696e 2064 6966 6663 7273 3a0a   -2 in diffcrs:.
+00036250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036260: 6d61 7064 6174 6120 3d20 6e70 2e73 7761  mapdata = np.swa
+00036270: 7061 7865 7328 6e70 2e73 7761 7061 7865  paxes(np.swapaxe
+00036280: 7328 6d61 7064 6174 612c 2030 2c20 3129  s(mapdata, 0, 1)
+00036290: 2c20 312c 2032 290a 2020 2020 2020 2020  , 1, 2).        
+000362a0: 2020 2020 6966 202d 3120 696e 2064 6966      if -1 in dif
+000362b0: 6663 7273 2061 6e64 2032 2069 6e20 6469  fcrs and 2 in di
+000362c0: 6666 6372 733a 0a20 2020 2020 2020 2020  ffcrs:.         
+000362d0: 2020 2020 2020 206d 6170 6461 7461 203d         mapdata =
+000362e0: 206e 702e 7377 6170 6178 6573 286e 702e   np.swapaxes(np.
+000362f0: 7377 6170 6178 6573 286d 6170 6461 7461  swapaxes(mapdata
+00036300: 2c20 312c 2032 292c 2030 2c20 3129 0a20  , 1, 2), 0, 1). 
+00036310: 2020 2020 2020 2020 2020 2023 206d 6170             # map
+00036320: 6461 7461 203d 206e 702e 7377 6170 6178  data = np.swapax
+00036330: 6573 286d 6170 6461 7461 2c20 302c 2032  es(mapdata, 0, 2
+00036340: 290a 0a20 2020 2020 2020 2023 206d 6170  )..        # map
+00036350: 6461 7461 203d 206e 702e 7377 6170 6178  data = np.swapax
+00036360: 6573 286e 702e 7377 6170 6178 6573 286d  es(np.swapaxes(m
+00036370: 6170 6461 7461 2c20 302c 2032 292c 2031  apdata, 0, 2), 1
+00036380: 2c20 3229 0a20 2020 2020 2020 2074 656d  , 2).        tem
+00036390: 7079 6865 6164 6572 203d 204d 6170 5061  pyheader = MapPa
+000363a0: 7273 6572 2e72 6561 644d 5243 4865 6164  rser.readMRCHead
+000363b0: 6572 2866 756c 6c6d 6170 6e61 6d65 290a  er(fullmapname).
+000363c0: 0a20 2020 2020 2020 2023 206e 782c 206e  .        # nx, n
+000363d0: 792c 206e 7a20 616e 6420 6e78 7374 6172  y, nz and nxstar
+000363e0: 742c 206e 7973 7461 7274 2c20 6e7a 7374  t, nystart, nzst
+000363f0: 6172 7420 6861 7665 7220 746f 2062 6520  art haver to be 
+00036400: 6368 616e 6765 6420 6163 636f 7264 696e  changed accordin
+00036410: 676c 7920 746f 2074 6865 2064 6174 610a  gly to the data.
+00036420: 2020 2020 2020 2020 7465 6d70 7968 6561          tempyhea
+00036430: 6465 7220 3d20 6c69 7374 2874 656d 7079  der = list(tempy
+00036440: 6865 6164 6572 290a 2020 2020 2020 2020  header).        
+00036450: 7465 6d70 7968 6561 6465 725b 305d 203d  tempyheader[0] =
+00036460: 206d 6170 6461 7461 2e73 6861 7065 5b32   mapdata.shape[2
+00036470: 5d0a 2020 2020 2020 2020 7465 6d70 7968  ].        tempyh
+00036480: 6561 6465 725b 315d 203d 206d 6170 6461  eader[1] = mapda
+00036490: 7461 2e73 6861 7065 5b31 5d0a 2020 2020  ta.shape[1].    
+000364a0: 2020 2020 7465 6d70 7968 6561 6465 725b      tempyheader[
+000364b0: 325d 203d 206d 6170 6461 7461 2e73 6861  2] = mapdata.sha
+000364c0: 7065 5b30 5d0a 2020 2020 2020 2020 7465  pe[0].        te
+000364d0: 6d70 7968 6561 6465 725b 335d 203d 206d  mpyheader[3] = m
+000364e0: 7263 6865 6164 6572 2e6d 6f64 652e 6974  rcheader.mode.it
+000364f0: 656d 2830 290a 2020 2020 2020 2020 7465  em(0).        te
+00036500: 6d70 7968 6561 6465 725b 345d 203d 206e  mpyheader[4] = n
+00036510: 7374 6172 7473 5b30 5d2e 6974 656d 2830  starts[0].item(0
+00036520: 290a 2020 2020 2020 2020 7465 6d70 7968  ).        tempyh
+00036530: 6561 6465 725b 355d 203d 206e 7374 6172  eader[5] = nstar
+00036540: 7473 5b31 5d2e 6974 656d 2830 290a 2020  ts[1].item(0).  
+00036550: 2020 2020 2020 7465 6d70 7968 6561 6465        tempyheade
+00036560: 725b 365d 203d 206e 7374 6172 7473 5b32  r[6] = nstarts[2
+00036570: 5d2e 6974 656d 2830 290a 2020 2020 2020  ].item(0).      
+00036580: 2020 7465 6d70 7968 6561 6465 725b 375d    tempyheader[7]
+00036590: 203d 206d 7263 6865 6164 6572 2e6d 782e   = mrcheader.mx.
+000365a0: 6974 656d 2830 290a 2020 2020 2020 2020  item(0).        
+000365b0: 7465 6d70 7968 6561 6465 725b 385d 203d  tempyheader[8] =
+000365c0: 206d 7263 6865 6164 6572 2e6d 792e 6974   mrcheader.my.it
+000365d0: 656d 2830 290a 2020 2020 2020 2020 7465  em(0).        te
+000365e0: 6d70 7968 6561 6465 725b 395d 203d 206d  mpyheader[9] = m
+000365f0: 7263 6865 6164 6572 2e6d 7a2e 6974 656d  rcheader.mz.item
+00036600: 2830 290a 2020 2020 2020 2020 7465 6d70  (0).        temp
+00036610: 7968 6561 6465 725b 3130 5d20 3d20 6d72  yheader[10] = mr
+00036620: 6368 6561 6465 722e 6365 6c6c 612e 782e  cheader.cella.x.
+00036630: 6974 656d 2830 290a 2020 2020 2020 2020  item(0).        
+00036640: 7465 6d70 7968 6561 6465 725b 3131 5d20  tempyheader[11] 
+00036650: 3d20 6d72 6368 6561 6465 722e 6365 6c6c  = mrcheader.cell
+00036660: 612e 792e 6974 656d 2830 290a 2020 2020  a.y.item(0).    
+00036670: 2020 2020 7465 6d70 7968 6561 6465 725b      tempyheader[
+00036680: 3132 5d20 3d20 6d72 6368 6561 6465 722e  12] = mrcheader.
+00036690: 6365 6c6c 612e 7a2e 6974 656d 2830 290a  cella.z.item(0).
+000366a0: 2020 2020 2020 2020 7465 6d70 7968 6561          tempyhea
+000366b0: 6465 725b 3133 3a31 365d 203d 206d 7263  der[13:16] = mrc
+000366c0: 6865 6164 6572 2e63 656c 6c62 2e74 6f6c  header.cellb.tol
+000366d0: 6973 7428 290a 2020 2020 2020 2020 7465  ist().        te
+000366e0: 6d70 7968 6561 6465 725b 3136 5d20 3d20  mpyheader[16] = 
+000366f0: 6372 735b 305d 2e69 7465 6d28 3029 0a20  crs[0].item(0). 
+00036700: 2020 2020 2020 2074 656d 7079 6865 6164         tempyhead
+00036710: 6572 5b31 375d 203d 2063 7273 5b31 5d2e  er[17] = crs[1].
+00036720: 6974 656d 2830 290a 2020 2020 2020 2020  item(0).        
+00036730: 7465 6d70 7968 6561 6465 725b 3138 5d20  tempyheader[18] 
+00036740: 3d20 6372 735b 325d 2e69 7465 6d28 3029  = crs[2].item(0)
+00036750: 0a20 2020 2020 2020 2074 656d 7079 6865  .        tempyhe
+00036760: 6164 6572 5b31 395d 203d 206d 7263 6865  ader[19] = mrche
+00036770: 6164 6572 2e64 6d69 6e2e 6974 656d 2830  ader.dmin.item(0
+00036780: 290a 2020 2020 2020 2020 7465 6d70 7968  ).        tempyh
+00036790: 6561 6465 725b 3230 5d20 3d20 6d72 6368  eader[20] = mrch
+000367a0: 6561 6465 722e 646d 6178 2e69 7465 6d28  eader.dmax.item(
+000367b0: 3029 0a20 2020 2020 2020 2074 656d 7079  0).        tempy
+000367c0: 6865 6164 6572 5b32 315d 203d 206d 7263  header[21] = mrc
+000367d0: 6865 6164 6572 2e64 6d65 616e 2e69 7465  header.dmean.ite
+000367e0: 6d28 3029 0a20 2020 2020 2020 2074 656d  m(0).        tem
+000367f0: 7079 6865 6164 6572 5b32 325d 203d 206d  pyheader[22] = m
+00036800: 7263 6865 6164 6572 2e69 7370 672e 6974  rcheader.ispg.it
+00036810: 656d 2830 290a 2020 2020 2020 2020 7465  em(0).        te
+00036820: 6d70 7968 6561 6465 725b 3233 5d20 3d20  mpyheader[23] = 
+00036830: 6d72 6368 6561 6465 722e 6e73 796d 6274  mrcheader.nsymbt
+00036840: 2e69 7465 6d28 3029 0a0a 2020 2020 2020  .item(0)..      
+00036850: 2020 7465 6d70 7968 6561 6465 725b 3439    tempyheader[49
+00036860: 5d20 3d20 6d72 6368 6561 6465 722e 6f72  ] = mrcheader.or
+00036870: 6967 696e 2e78 2e69 7465 6d28 3029 0a20  igin.x.item(0). 
+00036880: 2020 2020 2020 2074 656d 7079 6865 6164         tempyhead
+00036890: 6572 5b35 305d 203d 206d 7263 6865 6164  er[50] = mrchead
+000368a0: 6572 2e6f 7269 6769 6e2e 792e 6974 656d  er.origin.y.item
+000368b0: 2830 290a 2020 2020 2020 2020 7465 6d70  (0).        temp
+000368c0: 7968 6561 6465 725b 3531 5d20 3d20 6d72  yheader[51] = mr
+000368d0: 6368 6561 6465 722e 6f72 6967 696e 2e7a  cheader.origin.z
+000368e0: 2e69 7465 6d28 3029 0a20 2020 2020 2020  .item(0).       
+000368f0: 2074 656d 7079 6865 6164 6572 5b35 323a   tempyheader[52:
+00036900: 3535 5d20 3d20 5b27 4d27 2c20 2741 272c  55] = ['M', 'A',
+00036910: 2027 5027 5d0a 0a20 2020 2020 2020 2074   'P']..        t
+00036920: 656d 7079 6865 6164 6572 5b35 365d 203d  empyheader[56] =
+00036930: 206d 7263 6865 6164 6572 2e6d 6163 6873   mrcheader.machs
+00036940: 740a 2020 2020 2020 2020 7465 6d70 7968  t.        tempyh
+00036950: 6561 6465 725b 3537 5d20 3d20 6d72 6368  eader[57] = mrch
+00036960: 6561 6465 722e 726d 732e 6974 656d 2830  eader.rms.item(0
+00036970: 290a 2020 2020 2020 2020 7465 6d70 7968  ).        tempyh
+00036980: 6561 6465 7220 3d20 7475 706c 6528 7465  eader = tuple(te
+00036990: 6d70 7968 6561 6465 7229 0a20 2020 2020  mpyheader).     
+000369a0: 2020 206f 7269 6769 6e20 3d20 2866 6c6f     origin = (flo
+000369b0: 6174 286d 7263 6865 6164 6572 2e6f 7269  at(mrcheader.ori
+000369c0: 6769 6e2e 7829 2c20 666c 6f61 7428 6d72  gin.x), float(mr
+000369d0: 6368 6561 6465 722e 6f72 6967 696e 2e79  cheader.origin.y
+000369e0: 292c 2066 6c6f 6174 286d 7263 6865 6164  ), float(mrchead
+000369f0: 6572 2e6f 7269 6769 6e2e 7a29 290a 2020  er.origin.z)).  
+00036a00: 2020 2020 2020 6170 6978 203d 2028 6d72        apix = (mr
+00036a10: 6368 6561 6465 722e 6365 6c6c 612e 782f  cheader.cella.x/
+00036a20: 6d72 6368 6561 6465 722e 6d78 2c20 6d72  mrcheader.mx, mr
+00036a30: 6368 6561 6465 722e 6365 6c6c 612e 792f  cheader.cella.y/
+00036a40: 6d72 6368 6561 6465 722e 6d79 2c20 6d72  mrcheader.my, mr
+00036a50: 6368 6561 6465 722e 6365 6c6c 612e 7a2f  cheader.cella.z/
+00036a60: 6d72 6368 6561 6465 722e 6d7a 295b 305d  mrcheader.mz)[0]
+00036a70: 0a0a 2020 2020 2020 2020 6669 6e61 6c6d  ..        finalm
+00036a80: 6170 203d 204d 6170 286d 6170 6461 7461  ap = Map(mapdata
+00036a90: 2c20 6f72 6967 696e 2c20 6170 6978 2c20  , origin, apix, 
+00036aa0: 6675 6c6c 6d61 706e 616d 652c 2068 6561  fullmapname, hea
+00036ab0: 6465 723d 7465 6d70 7968 6561 6465 7229  der=tempyheader)
+00036ac0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00036ad0: 2066 696e 616c 6d61 700a 0a0a 2020 2020   finalmap...    
+00036ae0: 6465 6620 6673 635f 7265 6c69 6f6e 2873  def fsc_relion(s
+00036af0: 656c 6629 3a0a 2020 2020 2020 2020 2222  elf):.        ""
+00036b00: 220a 2020 2020 2020 2020 5573 696e 6720  ".        Using 
+00036b10: 5265 6c69 6f6e 2074 6f20 6361 6c63 756c  Relion to calcul
+00036b20: 6174 6520 6673 630a 2020 2020 2020 2020  ate fsc.        
+00036b30: 2222 220a 0a20 2020 2020 2020 2074 7279  """..        try
+00036b40: 3a0a 2020 2020 2020 2020 2020 2020 7374  :.            st
+00036b50: 6172 5f66 696c 6520 3d20 7265 6c69 6f6e  ar_file = relion
+00036b60: 5f66 7363 5f63 616c 6375 6c61 7469 6f6e  _fsc_calculation
+00036b70: 2873 656c 662e 686d 6f64 642e 6675 6c6c  (self.hmodd.full
+00036b80: 6e61 6d65 2c20 7365 6c66 2e68 6d65 7665  name, self.hmeve
+00036b90: 6e2e 6675 6c6c 6e61 6d65 2c20 7365 6c66  n.fullname, self
+00036ba0: 2e77 6f72 6b64 6972 2c20 7365 6c66 2e6d  .workdir, self.m
+00036bb0: 6170 6e61 6d65 290a 2020 2020 2020 2020  apname).        
+00036bc0: 2020 2020 2320 7374 6172 5f66 696c 6520      # star_file 
+00036bd0: 3d20 272f 5573 6572 732f 7a68 652f 446f  = '/Users/zhe/Do
+00036be0: 776e 6c6f 6164 732f 7465 7374 732f 5641  wnloads/tests/VA
+00036bf0: 2f6e 6673 2f6d 7364 2f77 6f72 6b32 2f65  /nfs/msd/work2/e
+00036c00: 6d64 622f 6465 7665 6c6f 706d 656e 742f  mdb/development/
+00036c10: 7374 6167 696e 672f 656d 2f38 312f 3831  staging/em/81/81
+00036c20: 3137 2f76 612f 656d 645f 3831 3137 2e6d  17/va/emd_8117.m
+00036c30: 6170 5f72 656c 696f 6e2f 6673 632f 6673  ap_relion/fsc/fs
+00036c40: 632e 7374 6172 270a 2020 2020 2020 2020  c.star'.        
+00036c50: 2020 2020 7374 6172 203d 2047 6574 5374      star = GetSt
+00036c60: 6172 7328 7374 6172 5f66 696c 6529 0a20  ars(star_file). 
+00036c70: 2020 2020 2020 2020 2020 2069 6e69 7469             initi
+00036c80: 616c 5f66 7363 5f62 6c6f 636b 203d 2073  al_fsc_block = s
+00036c90: 7461 722e 6461 7461 5f66 7363 5f62 6c6f  tar.data_fsc_blo
+00036ca0: 636b 2829 0a20 2020 2020 2020 2020 2020  ck().           
+00036cb0: 2064 6174 615f 6673 635f 626c 6f63 6b20   data_fsc_block 
+00036cc0: 3d20 7374 6172 2e64 6174 615f 6578 7472  = star.data_extr
+00036cd0: 6128 696e 6974 6961 6c5f 6673 635f 626c  a(initial_fsc_bl
+00036ce0: 6f63 6b29 0a20 2020 2020 2020 2020 2020  ock).           
+00036cf0: 2064 6174 615f 6375 7276 6573 203d 2073   data_curves = s
+00036d00: 7461 722e 616c 6c5f 6375 7276 6573 2864  tar.all_curves(d
+00036d10: 6174 615f 6673 635f 626c 6f63 6b29 0a20  ata_fsc_block). 
+00036d20: 2020 2020 2020 2020 2020 2064 6174 615f             data_
+00036d30: 696e 7465 7273 6563 7469 6f6e 7320 3d20  intersections = 
+00036d40: 7374 6172 2e61 6c6c 5f69 6e74 6572 7365  star.all_interse
+00036d50: 6374 696f 6e28 6461 7461 5f66 7363 5f62  ction(data_fsc_b
+00036d60: 6c6f 636b 290a 0a20 2020 2020 2020 2020  lock)..         
+00036d70: 2020 2066 7363 5f64 6963 7420 3d20 7b2a     fsc_dict = {*
+00036d80: 2a64 6174 615f 6375 7276 6573 2c20 2a2a  *data_curves, **
+00036d90: 6461 7461 5f69 6e74 6572 7365 6374 696f  data_intersectio
+00036da0: 6e73 7d0a 2020 2020 2020 2020 2020 2020  ns}.            
+00036db0: 6f75 745f 6469 6374 203d 207b 7d0a 2020  out_dict = {}.  
+00036dc0: 2020 2020 2020 2020 2020 6f75 745f 6469            out_di
+00036dd0: 6374 5b27 7265 6c69 6f6e 5f66 7363 275d  ct['relion_fsc']
+00036de0: 203d 2066 7363 5f64 6963 740a 2020 2020   = fsc_dict.    
+00036df0: 2020 2020 2020 2020 6f75 745f 6673 635f          out_fsc_
+00036e00: 6a73 6f6e 203d 2066 277b 7365 6c66 2e77  json = f'{self.w
+00036e10: 6f72 6b64 6972 7d7b 7365 6c66 2e6d 6170  orkdir}{self.map
+00036e20: 6e61 6d65 7d5f 6673 635f 7265 6c69 6f6e  name}_fsc_relion
+00036e30: 2e6a 736f 6e27 0a20 2020 2020 2020 2020  .json'.         
+00036e40: 2020 206f 7574 5f6a 736f 6e28 6f75 745f     out_json(out_
+00036e50: 6469 6374 2c20 6f75 745f 6673 635f 6a73  dict, out_fsc_js
+00036e60: 6f6e 290a 2020 2020 2020 2020 6578 6365  on).        exce
+00036e70: 7074 2045 7863 6570 7469 6f6e 2061 7320  pt Exception as 
+00036e80: 653a 0a20 2020 2020 2020 2020 2020 2070  e:.            p
+00036e90: 7269 6e74 2865 290a 0a0a 0a20 2020 2023  rint(e)....    #
+00036ea0: 2040 7072 6f66 696c 650a 2020 2020 6465   @profile.    de
+00036eb0: 6620 6673 6373 2873 656c 6629 3a0a 2020  f fscs(self):.  
+00036ec0: 2020 2020 2020 2222 220a 0a0a 0a20 2020        """....   
+00036ed0: 2020 2020 203a 7265 7475 726e 3a20 4e6f       :return: No
+00036ee0: 6e65 0a20 2020 2020 2020 2022 2222 0a20  ne.        """. 
+00036ef0: 2020 2020 2020 2069 6620 7365 6c66 2e68         if self.h
+00036f00: 6d65 7665 6e20 6973 206e 6f74 204e 6f6e  meven is not Non
+00036f10: 6520 616e 6420 7365 6c66 2e68 6d6f 6464  e and self.hmodd
+00036f20: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00036f30: 2020 2020 2020 2020 2020 7374 6172 7466            startf
+00036f40: 7363 203d 2074 696d 6569 742e 6465 6661  sc = timeit.defa
+00036f50: 756c 745f 7469 6d65 7228 290a 2020 2020  ult_timer().    
+00036f60: 2020 2020 2020 2020 2320 7365 6c66 2e66          # self.f
+00036f70: 7363 2873 656c 662e 686d 6576 656e 2c20  sc(self.hmeven, 
+00036f80: 7365 6c66 2e68 6d6f 6464 290a 2020 2020  self.hmodd).    
+00036f90: 2020 2020 2020 2020 7365 6c66 2e66 7363          self.fsc
+00036fa0: 5f72 656c 696f 6e28 290a 2020 2020 2020  _relion().      
+00036fb0: 2020 2020 2020 7365 6c66 2e6e 6577 5f66        self.new_f
+00036fc0: 7363 2873 656c 662e 686d 6576 656e 2c20  sc(self.hmeven, 
+00036fd0: 7365 6c66 2e68 6d6f 6464 290a 2020 2020  self.hmodd).    
+00036fe0: 2020 2020 2020 2020 7374 6f70 203d 2074          stop = t
+00036ff0: 696d 6569 742e 6465 6661 756c 745f 7469  imeit.default_ti
+00037000: 6d65 7228 290a 2020 2020 2020 2020 2020  mer().          
+00037010: 2020 7072 696e 7428 2746 5343 3a20 2573    print('FSC: %s
+00037020: 2720 2520 2873 746f 7020 2d20 7374 6172  ' % (stop - star
+00037030: 7466 7363 2929 0a20 2020 2020 2020 2020  tfsc)).         
+00037040: 2020 2070 7269 6e74 2827 2d2d 2d2d 2d2d     print('------
+00037050: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00037060: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2729  --------------')
+00037070: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00037080: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+00037090: 2827 4d69 7369 6e67 2068 616c 6620 6d61  ('Mising half ma
+000370a0: 7028 7329 2e27 290a 0a20 2020 2020 2020  p(s).')..       
+000370b0: 2066 7363 786d 6c72 6520 3d20 272a 5f66   fscxmlre = '*_f
+000370c0: 7363 2e78 6d6c 270a 2020 2020 2020 2020  sc.xml'.        
+000370d0: 6673 6378 6d6c 6172 7220 3d20 676c 6f62  fscxmlarr = glob
+000370e0: 2e67 6c6f 6228 7365 6c66 2e77 6f72 6b64  .glob(self.workd
+000370f0: 6972 202b 2066 7363 786d 6c72 6529 0a20  ir + fscxmlre). 
+00037100: 2020 2020 2020 2069 6620 6673 6378 6d6c         if fscxml
+00037110: 6172 7220 6f72 2073 656c 662e 6673 6366  arr or self.fscf
+00037120: 696c 653a 0a20 2020 2020 2020 2020 2020  ile:.           
+00037130: 2073 7461 7274 6673 6320 3d20 7469 6d65   startfsc = time
+00037140: 6974 2e64 6566 6175 6c74 5f74 696d 6572  it.default_timer
+00037150: 2829 0a20 2020 2020 2020 2020 2020 2073  ().            s
+00037160: 656c 662e 7265 6164 6673 6328 290a 2020  elf.readfsc().  
+00037170: 2020 2020 2020 2020 2020 7374 6f70 203d            stop =
+00037180: 2074 696d 6569 742e 6465 6661 756c 745f   timeit.default_
+00037190: 7469 6d65 7228 290a 2020 2020 2020 2020  timer().        
+000371a0: 2020 2020 7072 696e 7428 274c 6f61 6420      print('Load 
+000371b0: 4653 433a 2025 7327 2025 2028 7374 6f70  FSC: %s' % (stop
+000371c0: 202d 2073 7461 7274 6673 6329 290a 2020   - startfsc)).  
+000371d0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+000371e0: 272d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  '---------------
+000371f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00037200: 2d2d 2d2d 2d27 290a 2020 2020 2020 2020  -----').        
+00037210: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00037220: 2020 7072 696e 7428 274e 6f20 6769 7665    print('No give
+00037230: 6e20 4653 4320 6461 7461 2074 6f20 6265  n FSC data to be
+00037240: 206c 6f61 6465 642e 2729 0a0a 2020 2020   loaded.')..    
+00037250: 6465 6620 7265 6164 6673 6328 7365 6c66  def readfsc(self
+00037260: 2c20 6173 796d 3d31 2e30 293a 0a20 2020  , asym=1.0):.   
+00037270: 2020 2020 2022 2222 0a0a 2020 2020 2020       """..      
+00037280: 2020 3a72 6574 7572 6e3a 0a20 2020 2020    :return:.     
+00037290: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
+000372a0: 6d70 6f72 7420 786d 6c2e 6574 7265 652e  mport xml.etree.
+000372b0: 456c 656d 656e 7454 7265 6520 6173 2045  ElementTree as E
+000372c0: 540a 0a20 2020 2020 2020 2065 7272 6c69  T..        errli
+000372d0: 7374 203d 205b 5d0a 2020 2020 2020 2020  st = [].        
+000372e0: 6669 6e61 6c64 6963 7420 3d20 6469 6374  finaldict = dict
+000372f0: 2829 0a0a 2020 2020 2020 2020 6966 2073  ()..        if s
+00037300: 656c 662e 6673 6366 696c 6520 6973 206e  elf.fscfile is n
+00037310: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00037320: 2020 2020 2078 6c69 7374 203d 205b 5d0a       xlist = [].
+00037330: 2020 2020 2020 2020 2020 2020 796c 6973              ylis
+00037340: 7420 3d20 5b5d 0a20 2020 2020 2020 2020  t = [].         
+00037350: 2020 206d 6170 5f7a 7369 7a65 203d 2073     map_zsize = s
+00037360: 656c 662e 6d61 702e 6865 6164 6572 2e6e  elf.map.header.n
+00037370: 7a0a 2020 2020 2020 2020 2020 2020 6d61  z.            ma
+00037380: 705f 7973 697a 6520 3d20 7365 6c66 2e6d  p_ysize = self.m
+00037390: 6170 2e68 6561 6465 722e 6e79 0a20 2020  ap.header.ny.   
+000373a0: 2020 2020 2020 2020 206d 6170 5f78 7369           map_xsi
+000373b0: 7a65 203d 2073 656c 662e 6d61 702e 6865  ze = self.map.he
+000373c0: 6164 6572 2e6e 780a 2020 2020 2020 2020  ader.nx.        
+000373d0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+000373e0: 2020 2020 2020 2020 2066 696c 6566 7363           filefsc
+000373f0: 203d 2073 656c 662e 776f 726b 6469 7220   = self.workdir 
+00037400: 2b20 7365 6c66 2e66 7363 6669 6c65 0a20  + self.fscfile. 
+00037410: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00037420: 7265 6520 3d20 4554 2e70 6172 7365 2866  ree = ET.parse(f
+00037430: 696c 6566 7363 290a 2020 2020 2020 2020  ilefsc).        
+00037440: 2020 2020 2020 2020 726f 6f74 203d 2074          root = t
+00037450: 7265 652e 6765 7472 6f6f 7428 290a 2020  ree.getroot().  
+00037460: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00037470: 7220 6368 696c 6420 696e 2072 6f6f 743a  r child in root:
+00037480: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00037490: 2020 2020 2078 203d 2066 6c6f 6174 2863       x = float(c
+000374a0: 6869 6c64 2e66 696e 6428 2778 2729 2e74  hild.find('x').t
+000374b0: 6578 7429 0a20 2020 2020 2020 2020 2020  ext).           
+000374c0: 2020 2020 2020 2020 2079 203d 2066 6c6f           y = flo
+000374d0: 6174 2863 6869 6c64 2e66 696e 6428 2779  at(child.find('y
+000374e0: 2729 2e74 6578 7429 0a20 2020 2020 2020  ').text).       
+000374f0: 2020 2020 2020 2020 2020 2020 2078 6c69               xli
+00037500: 7374 2e61 7070 656e 6428 7829 0a20 2020  st.append(x).   
+00037510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037520: 2079 6c69 7374 2e61 7070 656e 6428 7929   ylist.append(y)
+00037530: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
+00037540: 6570 743a 0a20 2020 2020 2020 2020 2020  ept:.           
+00037550: 2020 2020 2065 7272 203d 2027 5265 6164       err = 'Read
+00037560: 2046 5343 2066 726f 6d20 584d 4c20 6572   FSC from XML er
+00037570: 726f 723a 207b 7d2e 272e 666f 726d 6174  ror: {}.'.format
+00037580: 2873 7973 2e65 7863 5f69 6e66 6f28 295b  (sys.exc_info()[
+00037590: 315d 290a 2020 2020 2020 2020 2020 2020  1]).            
+000375a0: 2020 2020 6572 726c 6973 742e 6170 7065      errlist.appe
+000375b0: 6e64 2865 7272 290a 2020 2020 2020 2020  nd(err).        
+000375c0: 2020 2020 2020 2020 7379 732e 7374 6465          sys.stde
+000375d0: 7272 2e77 7269 7465 2865 7272 202b 2027  rr.write(err + '
+000375e0: 5c6e 2729 0a0a 2020 2020 2020 2020 2020  \n')..          
+000375f0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00037600: 2020 2020 2020 2023 2047 7269 6420 6865         # Grid he
+00037610: 7265 2074 6f20 6765 6e65 7261 7465 2066  re to generate f
+00037620: 6f72 2074 7261 6369 6e67 2074 6865 2069  or tracing the i
+00037630: 6e64 6963 6573 206f 6620 6772 6964 7320  ndices of grids 
+00037640: 7769 7468 2069 6e20 7468 6520 7368 656c  with in the shel
+00037650: 6c73 2e0a 2020 2020 2020 2020 2020 2020  ls..            
+00037660: 2020 2020 7a67 7269 6420 3d20 6e70 2e61      zgrid = np.a
+00037670: 7261 6e67 6528 666c 6f6f 7228 6d61 705f  range(floor(map_
+00037680: 7a73 697a 6520 2f20 322e 3029 202a 202d  zsize / 2.0) * -
+00037690: 312c 2063 6569 6c28 6d61 705f 7a73 697a  1, ceil(map_zsiz
+000376a0: 6520 2f20 322e 3029 2920 2f20 666c 6f61  e / 2.0)) / floa
+000376b0: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+000376c0: 2020 2020 2020 2066 6c6f 6f72 286d 6170         floor(map
+000376d0: 5f7a 7369 7a65 2929 0a20 2020 2020 2020  _zsize)).       
+000376e0: 2020 2020 2020 2020 2079 6772 6964 203d           ygrid =
+000376f0: 206e 702e 6172 616e 6765 2866 6c6f 6f72   np.arange(floor
+00037700: 286d 6170 5f79 7369 7a65 202f 2032 2e30  (map_ysize / 2.0
+00037710: 2920 2a20 2d31 2c20 6365 696c 286d 6170  ) * -1, ceil(map
+00037720: 5f79 7369 7a65 202f 2032 2e30 2929 202f  _ysize / 2.0)) /
+00037730: 2066 6c6f 6174 280a 2020 2020 2020 2020   float(.        
+00037740: 2020 2020 2020 2020 2020 2020 666c 6f6f              floo
+00037750: 7228 6d61 705f 7973 697a 6529 290a 2020  r(map_ysize)).  
+00037760: 2020 2020 2020 2020 2020 2020 2020 7867                xg
+00037770: 7269 6420 3d20 6e70 2e61 7261 6e67 6528  rid = np.arange(
+00037780: 666c 6f6f 7228 6d61 705f 7873 697a 6520  floor(map_xsize 
+00037790: 2f20 322e 3029 202a 202d 312c 2063 6569  / 2.0) * -1, cei
+000377a0: 6c28 6d61 705f 7873 697a 6520 2f20 322e  l(map_xsize / 2.
+000377b0: 3029 2920 2f20 666c 6f61 7428 0a20 2020  0)) / float(.   
 000377c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000377d0: 2020 2074 796f 6e65 6269 7420 3d20 4e6f     tyonebit = No
-000377e0: 6e65 0a20 2020 2020 2020 2020 2020 2020  ne.             
-000377f0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00037800: 2020 2020 2020 2020 2020 2020 2074 786f               txo
-00037810: 6e65 6269 7420 3d20 6e70 2e72 6f75 6e64  nebit = np.round
-00037820: 2878 6f6e 6562 6974 5b30 5d5b 305d 2c20  (xonebit[0][0], 
-00037830: 3429 0a20 2020 2020 2020 2020 2020 2020  4).             
-00037840: 2020 2020 2020 2074 796f 6e65 6269 7420         tyonebit 
-00037850: 3d20 6e70 2e72 6f75 6e64 2879 6f6e 6562  = np.round(yoneb
-00037860: 6974 5b30 5d5b 305d 2c20 3429 0a0a 2020  it[0][0], 4)..  
-00037870: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00037880: 2078 6861 6c66 2e73 697a 6520 3d3d 2030   xhalf.size == 0
-00037890: 2061 6e64 2079 6861 6c66 2e73 697a 6520   and yhalf.size 
-000378a0: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
-000378b0: 2020 2020 2020 2020 2020 7478 6861 6c66            txhalf
-000378c0: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-000378d0: 2020 2020 2020 2020 2020 2020 7479 6861              tyha
-000378e0: 6c66 203d 204e 6f6e 650a 2020 2020 2020  lf = None.      
-000378f0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00037900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037910: 2020 2020 7478 6861 6c66 203d 206e 702e      txhalf = np.
-00037920: 726f 756e 6428 7868 616c 665b 305d 5b30  round(xhalf[0][0
-00037930: 5d2c 2034 290a 2020 2020 2020 2020 2020  ], 4).          
-00037940: 2020 2020 2020 2020 2020 7479 6861 6c66            tyhalf
-00037950: 203d 206e 702e 726f 756e 6428 7968 616c   = np.round(yhal
-00037960: 665b 305d 5b30 5d2c 2034 290a 0a20 2020  f[0][0], 4)..   
-00037970: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00037980: 786f 6e65 7468 7265 652e 7369 7a65 203d  xonethree.size =
-00037990: 3d20 3020 616e 6420 796f 6e65 7468 7265  = 0 and yonethre
-000379a0: 652e 7369 7a65 203d 3d20 303a 0a20 2020  e.size == 0:.   
+000377d0: 2066 6c6f 6f72 286d 6170 5f78 7369 7a65   floor(map_xsize
+000377e0: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+000377f0: 2020 2078 6469 7320 3d20 7867 7269 6420     xdis = xgrid 
+00037800: 2a2a 2032 0a20 2020 2020 2020 2020 2020  ** 2.           
+00037810: 2020 2020 2079 6469 7320 3d20 7967 7269       ydis = ygri
+00037820: 6420 2a2a 2032 0a20 2020 2020 2020 2020  d ** 2.         
+00037830: 2020 2020 2020 207a 6469 7320 3d20 7a67         zdis = zg
+00037840: 7269 6420 2a2a 2032 0a20 2020 2020 2020  rid ** 2.       
+00037850: 2020 2020 2020 2020 2023 2064 6973 7420           # dist 
+00037860: 3d20 6e70 2e73 7172 7428 7a64 6973 5b3a  = np.sqrt(zdis[:
+00037870: 2c20 4e6f 6e65 2c20 4e6f 6e65 5d20 2b20  , None, None] + 
+00037880: 7964 6973 5b3a 2c20 4e6f 6e65 5d20 2b20  ydis[:, None] + 
+00037890: 7864 6973 290a 0a20 2020 2020 2020 2020  xdis)..         
+000378a0: 2020 2020 2020 2061 6c6c 6178 6973 203d         allaxis =
+000378b0: 206e 702e 6172 7261 7928 5b7a 6772 6964   np.array([zgrid
+000378c0: 2c20 7967 7269 642c 2078 6772 6964 5d29  , ygrid, xgrid])
+000378d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000378e0: 2074 6d70 696e 6469 6178 6973 203d 206d   tmpindiaxis = m
+000378f0: 6178 2861 6c6c 6178 6973 2c20 6b65 793d  ax(allaxis, key=
+00037900: 6c65 6e29 0a20 2020 2020 2020 2020 2020  len).           
+00037910: 2020 2020 2069 6e64 6961 7869 7374 203d       indiaxist =
+00037920: 2074 6d70 696e 6469 6178 6973 5b74 6d70   tmpindiaxis[tmp
+00037930: 696e 6469 6178 6973 203e 3d20 305d 0a20  indiaxis >= 0]. 
+00037940: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00037950: 696e 6469 203d 206c 656e 2869 6e64 6961  indi = len(india
+00037960: 7869 7374 290a 2020 2020 2020 2020 2020  xist).          
+00037970: 2020 2020 2020 2320 696e 6469 6178 6973        # indiaxis
+00037980: 203d 206e 702e 6c69 6e73 7061 6365 2830   = np.linspace(0
+00037990: 2c20 3120 2f20 2832 202a 2063 706d 6170  , 1 / (2 * cpmap
+000379a0: 2e61 7069 7829 2c20 6c69 6e64 6929 0a0a  .apix), lindi)..
 000379b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000379c0: 2074 786f 6e65 7468 7265 6520 3d20 4e6f   txonethree = No
-000379d0: 6e65 0a20 2020 2020 2020 2020 2020 2020  ne.             
-000379e0: 2020 2020 2020 2074 796f 6e65 7468 7265         tyonethre
-000379f0: 6520 3d20 4e6f 6e65 0a20 2020 2020 2020  e = None.       
-00037a00: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00037a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037a20: 2020 2074 786f 6e65 7468 7265 6520 3d20     txonethree = 
-00037a30: 6e70 2e72 6f75 6e64 2878 6f6e 6574 6872  np.round(xonethr
-00037a40: 6565 5b30 5d5b 305d 2c20 3429 0a20 2020  ee[0][0], 4).   
-00037a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037a60: 2074 796f 6e65 7468 7265 6520 3d20 6e70   tyonethree = np
-00037a70: 2e72 6f75 6e64 2879 6f6e 6574 6872 6565  .round(yonethree
-00037a80: 5b30 5d5b 305d 2c20 3429 0a0a 2020 2020  [0][0], 4)..    
-00037a90: 2020 2020 2020 2020 2020 2020 6966 2078              if x
-00037aa0: 676f 6c64 2e73 697a 6520 3d3d 2030 2061  gold.size == 0 a
-00037ab0: 6e64 2079 676f 6c64 2e73 697a 6520 3d3d  nd ygold.size ==
-00037ac0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-00037ad0: 2020 2020 2020 2020 7478 676f 6c64 203d          txgold =
-00037ae0: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
-00037af0: 2020 2020 2020 2020 2020 7479 676f 6c64            tygold
-00037b00: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-00037b10: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00037b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037b30: 2020 7478 676f 6c64 203d 206e 702e 726f    txgold = np.ro
-00037b40: 756e 6428 7867 6f6c 645b 305d 5b30 5d2c  und(xgold[0][0],
-00037b50: 2034 290a 2020 2020 2020 2020 2020 2020   4).            
-00037b60: 2020 2020 2020 2020 7479 676f 6c64 203d          tygold =
-00037b70: 206e 702e 726f 756e 6428 7967 6f6c 645b   np.round(ygold[
-00037b80: 305d 5b30 5d2c 2034 290a 0a20 2020 2020  0][0], 4)..     
-00037b90: 2020 2020 2020 2020 2020 2078 6c65 6e20             xlen 
-00037ba0: 3d20 6c65 6e28 786c 6973 7429 0a0a 2020  = len(xlist)..  
-00037bb0: 2020 2020 2020 2020 2020 2020 2020 6461                da
-00037bc0: 7461 6469 6374 203d 207b 0a20 2020 2020  tadict = {.     
-00037bd0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-00037be0: 6375 7276 6573 273a 207b 2766 7363 7927  curves': {'fscy'
-00037bf0: 3a20 6e70 2e72 6f75 6e64 286e 702e 7265  : np.round(np.re
-00037c00: 616c 2879 6c69 7374 292c 2034 292e 746f  al(ylist), 4).to
-00037c10: 6c69 7374 2829 2c20 2774 6872 6565 7369  list(), 'threesi
-00037c20: 676d 6127 3a20 6e70 2e72 6f75 6e64 2874  gma': np.round(t
-00037c30: 6872 6565 7369 672c 2034 292e 746f 6c69  hreesig, 4).toli
-00037c40: 7374 2829 5b3a 786c 656e 5d2c 0a20 2020  st()[:xlen],.   
-00037c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037c60: 2020 2020 2020 2020 2020 2020 2768 616c              'hal
-00037c70: 6662 6974 273a 206e 702e 726f 756e 6428  fbit': np.round(
-00037c80: 6861 6c66 6269 742c 2034 292e 746f 6c69  halfbit, 4).toli
-00037c90: 7374 2829 5b3a 786c 656e 5d2c 0a20 2020  st()[:xlen],.   
+000379c0: 2320 4c6f 6f70 696e 6720 7468 726f 7567  # Looping throug
+000379d0: 6820 616c 6c20 7368 656c 6c73 0a20 2020  h all shells.   
+000379e0: 2020 2020 2020 2020 2020 2020 2074 6872               thr
+000379f0: 6565 7369 6720 3d20 5b5d 0a20 2020 2020  eesig = [].     
+00037a00: 2020 2020 2020 2020 2020 2068 616c 6662             halfb
+00037a10: 6974 203d 205b 5d0a 2020 2020 2020 2020  it = [].        
+00037a20: 2020 2020 2020 2020 6f6e 6562 6974 203d          onebit =
+00037a30: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
+00037a40: 2020 2020 2320 666f 7220 6920 696e 2072      # for i in r
+00037a50: 616e 6765 286c 656e 2869 6e64 6961 7869  ange(len(indiaxi
+00037a60: 7329 293a 0a20 2020 2020 2020 2020 2020  s)):.           
+00037a70: 2020 2020 2066 6f72 2069 2069 6e20 7261       for i in ra
+00037a80: 6e67 6528 6c65 6e28 786c 6973 7429 293a  nge(len(xlist)):
+00037a90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00037aa0: 2020 2020 2023 2069 6620 6920 3c20 6c65       # if i < le
+00037ab0: 6e28 696e 6469 6178 6973 2920 2d20 313a  n(indiaxis) - 1:
+00037ac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00037ad0: 2020 2020 2020 2020 2023 2069 6e64 6963           # indic
+00037ae0: 6573 203d 206e 702e 6172 6777 6865 7265  es = np.argwhere
+00037af0: 2828 6469 7374 203e 3d20 696e 6469 6178  ((dist >= indiax
+00037b00: 6973 745b 695d 2920 2620 2864 6973 7420  ist[i]) & (dist 
+00037b10: 3c20 696e 6469 6178 6973 745b 6920 2b20  < indiaxist[i + 
+00037b20: 315d 2929 0a0a 2020 2020 2020 2020 2020  1]))..          
+00037b30: 2020 2020 2020 2020 2020 766f 6c75 6d65            volume
+00037b40: 6469 6666 203d 2028 342e 3020 2f20 332e  diff = (4.0 / 3.
+00037b50: 3029 202a 2070 6920 2a20 2828 6920 2b20  0) * pi * ((i + 
+00037b60: 3129 202a 2a20 3320 2d20 6920 2a2a 2033  1) ** 3 - i ** 3
+00037b70: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00037b80: 2020 2020 2020 6e76 6f78 7269 6e67 203d        nvoxring =
+00037b90: 2076 6f6c 756d 6564 6966 6620 2f20 2831   volumediff / (1
+00037ba0: 202a 2a20 3329 0a20 2020 2020 2020 2020   ** 3).         
+00037bb0: 2020 2020 2020 2020 2020 2065 6666 6e76             effnv
+00037bc0: 6f78 203d 2028 6e76 6f78 7269 6e67 202a  ox = (nvoxring *
+00037bd0: 2028 2831 2e35 202a 2030 2e36 3629 202a   ((1.5 * 0.66) *
+00037be0: 2a20 3229 2920 2f20 2832 202a 2061 7379  * 2)) / (2 * asy
+00037bf0: 6d29 0a20 2020 2020 2020 2020 2020 2020  m).             
+00037c00: 2020 2020 2020 2069 6620 6566 666e 766f         if effnvo
+00037c10: 7820 3c20 312e 303a 2065 6666 6e76 6f78  x < 1.0: effnvox
+00037c20: 203d 2031 2e30 0a20 2020 2020 2020 2020   = 1.0.         
+00037c30: 2020 2020 2020 2020 2020 2073 7172 6566             sqref
+00037c40: 666e 766f 7820 3d20 6e70 2e73 7172 7428  fnvox = np.sqrt(
+00037c50: 6566 666e 766f 7829 0a0a 2020 2020 2020  effnvox)..      
+00037c60: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00037c70: 332d 7369 676d 6120 6375 7276 650a 2020  3-sigma curve.  
+00037c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037c90: 2020 6966 2069 2021 3d20 303a 0a20 2020    if i != 0:.   
 00037ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037cb0: 2020 2020 2020 2020 2020 2020 276f 6e65              'one
-00037cc0: 6269 7427 3a20 6e70 2e72 6f75 6e64 286f  bit': np.round(o
-00037cd0: 6e65 6269 742c 2034 292e 746f 6c69 7374  nebit, 4).tolist
-00037ce0: 2829 5b3a 786c 656e 5d2c 2027 302e 3527  ()[:xlen], '0.5'
-00037cf0: 3a20 662e 746f 6c69 7374 2829 5b3a 786c  : f.tolist()[:xl
-00037d00: 656e 5d2c 2027 302e 3333 3327 3a20 672e  en], '0.333': g.
-00037d10: 746f 6c69 7374 2829 5b3a 786c 656e 5d2c  tolist()[:xlen],
-00037d20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00037d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037d40: 2730 2e31 3433 273a 2068 2e74 6f6c 6973  '0.143': h.tolis
-00037d50: 7428 295b 3a78 6c65 6e5d 2c0a 2020 2020  t()[:xlen],.    
-00037d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037d70: 2020 2020 2020 2020 2020 2027 6c65 7665             'leve
-00037d80: 6c27 3a20 6e70 2e72 6f75 6e64 286e 702e  l': np.round(np.
-00037d90: 7265 616c 2878 6c69 7374 292c 2034 292e  real(xlist), 4).
-00037da0: 746f 6c69 7374 2829 2c0a 2020 2020 2020  tolist(),.      
-00037db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037dc0: 2020 2020 2020 2020 2027 6673 6378 273a           'fscx':
-00037dd0: 206e 702e 726f 756e 6428 6e70 2e72 6561   np.round(np.rea
-00037de0: 6c28 786c 6973 7429 2c20 3429 2e74 6f6c  l(xlist), 4).tol
-00037df0: 6973 7428 297d 2c0a 2020 2020 2020 2020  ist()},.        
-00037e00: 2020 2020 2020 2020 2020 2020 2769 6e74              'int
-00037e10: 6572 7365 6374 696f 6e73 273a 207b 2774  ersections': {'t
-00037e20: 6872 6565 7369 6727 3a20 7b27 7827 3a20  hreesig': {'x': 
-00037e30: 7478 7468 7265 6573 6967 2c20 2779 273a  txthreesig, 'y':
-00037e40: 2074 7974 6872 6565 7369 677d 2c0a 2020   tythreesig},.  
-00037e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037cb0: 2020 2020 2073 6967 7661 6c75 6520 3d20       sigvalue = 
+00037cc0: 3320 2f20 2873 7172 6566 666e 766f 7820  3 / (sqreffnvox 
+00037cd0: 2b20 332e 3020 2d20 312e 3029 0a20 2020  + 3.0 - 1.0).   
+00037ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037cf0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00037d00: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00037d10: 6967 7661 6c75 6520 3d20 310a 2020 2020  igvalue = 1.    
+00037d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037d30: 7468 7265 6573 6967 2e61 7070 656e 6428  threesig.append(
+00037d40: 7369 6776 616c 7565 290a 0a20 2020 2020  sigvalue)..     
+00037d50: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00037d60: 2048 616c 6620 6269 7420 6375 7276 650a   Half bit curve.
+00037d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037d80: 2020 2020 6966 2069 2021 3d20 303a 0a20      if i != 0:. 
+00037d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037da0: 2020 2020 2020 2062 6974 7661 6c75 6520         bitvalue 
+00037db0: 3d20 2830 2e32 3037 3120 2b20 312e 3931  = (0.2071 + 1.91
+00037dc0: 3032 202f 2073 7172 6566 666e 766f 7829  02 / sqreffnvox)
+00037dd0: 202f 2028 312e 3230 3731 202b 2030 2e39   / (1.2071 + 0.9
+00037de0: 3130 3220 2f20 7371 7265 6666 6e76 6f78  102 / sqreffnvox
+00037df0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00037e00: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00037e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037e20: 2020 2020 6269 7476 616c 7565 203d 2031      bitvalue = 1
+00037e30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00037e40: 2020 2020 2068 616c 6662 6974 2e61 7070       halfbit.app
+00037e50: 656e 6428 6269 7476 616c 7565 290a 0a20  end(bitvalue).. 
 00037e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037e70: 2020 2020 2768 616c 6662 6974 273a 207b      'halfbit': {
-00037e80: 2778 273a 2074 7868 616c 6662 6974 2c20  'x': txhalfbit, 
-00037e90: 2779 273a 2074 7968 616c 6662 6974 7d2c  'y': tyhalfbit},
-00037ea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00037eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037ec0: 2020 2020 2020 2027 6f6e 6562 6974 273a         'onebit':
-00037ed0: 207b 2778 273a 2074 786f 6e65 6269 742c   {'x': txonebit,
-00037ee0: 2027 7927 3a20 7479 6f6e 6562 6974 7d2c   'y': tyonebit},
-00037ef0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00037e70: 2020 2069 6620 6920 213d 2030 3a0a 2020     if i != 0:.  
+00037e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037e90: 2020 2020 2020 6f6e 6562 6974 7661 6c75        onebitvalu
+00037ea0: 6520 3d20 2830 2e35 202b 2032 2e34 3134  e = (0.5 + 2.414
+00037eb0: 3220 2f20 7371 7265 6666 6e76 6f78 2920  2 / sqreffnvox) 
+00037ec0: 2f20 2831 2e35 202b 2031 2e34 3134 3220  / (1.5 + 1.4142 
+00037ed0: 2f20 7371 7265 6666 6e76 6f78 290a 2020  / sqreffnvox).  
+00037ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037ef0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
 00037f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037f10: 2020 2020 2020 2027 302e 3527 3a20 7b27         '0.5': {'
-00037f20: 7827 3a20 7478 6861 6c66 2c20 2779 273a  x': txhalf, 'y':
-00037f30: 2074 7968 616c 667d 2c0a 2020 2020 2020   tyhalf},.      
-00037f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037f10: 6f6e 6562 6974 7661 6c75 6520 3d20 310a  onebitvalue = 1.
+00037f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037f30: 2020 2020 6f6e 6562 6974 2e61 7070 656e      onebit.appen
+00037f40: 6428 6f6e 6562 6974 7661 6c75 6529 0a0a  d(onebitvalue)..
 00037f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037f60: 2730 2e33 3333 273a 207b 2778 273a 2074  '0.333': {'x': t
-00037f70: 786f 6e65 7468 7265 652c 2027 7927 3a20  xonethree, 'y': 
-00037f80: 7479 6f6e 6574 6872 6565 7d2c 0a20 2020  tyonethree},.   
-00037f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037fb0: 2020 2027 302e 3134 3327 3a20 7b27 7827     '0.143': {'x'
-00037fc0: 3a20 7478 676f 6c64 2c20 2779 273a 2074  : txgold, 'y': t
-00037fd0: 7967 6f6c 647d 7d7d 0a0a 2020 2020 2020  ygold}}}..      
-00037fe0: 2020 2020 2020 2020 2020 6669 6e61 6c64            finald
-00037ff0: 6963 745b 276c 6f61 645f 6673 6327 5d20  ict['load_fsc'] 
-00038000: 3d20 6461 7461 6469 6374 0a0a 2020 2020  = datadict..    
-00038010: 2020 2020 2020 2020 2020 2020 706c 742e              plt.
-00038020: 706c 6f74 2878 6c69 7374 2c20 796c 6973  plot(xlist, ylis
-00038030: 742c 206c 6162 656c 3d27 5072 6f76 6964  t, label='Provid
-00038040: 6564 2046 5343 2729 0a20 2020 2020 2020  ed FSC').       
-00038050: 2020 2020 2020 2020 2023 706c 742e 706c           #plt.pl
-00038060: 6f74 2869 6e64 6961 7869 732c 2074 6872  ot(indiaxis, thr
-00038070: 6565 7369 672c 206c 6162 656c 3d27 3320  eesig, label='3 
-00038080: 7369 676d 6127 290a 2020 2020 2020 2020  sigma').        
-00038090: 2020 2020 2020 2020 2370 6c74 2e70 6c6f          #plt.plo
-000380a0: 7428 696e 6469 6178 6973 2c20 6861 6c66  t(indiaxis, half
-000380b0: 6269 742c 206c 6162 656c 3d27 312f 3220  bit, label='1/2 
-000380c0: 6269 7427 290a 2020 2020 2020 2020 2020  bit').          
-000380d0: 2020 2020 2020 2370 6c74 2e70 6c6f 7428        #plt.plot(
-000380e0: 696e 6469 6178 6973 2c20 6f6e 6562 6974  indiaxis, onebit
-000380f0: 2c20 6c61 6265 6c3d 2731 2062 6974 2729  , label='1 bit')
-00038100: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00038110: 2070 6c74 2e70 6c6f 7428 786c 6973 745b   plt.plot(xlist[
-00038120: 3a2d 315d 2c20 6c65 6e28 786c 6973 745b  :-1], len(xlist[
-00038130: 3a2d 315d 292a 5b30 2e35 5d2c 206c 696e  :-1])*[0.5], lin
-00038140: 6573 7479 6c65 3d27 3a27 2c20 6c61 6265  estyle=':', labe
-00038150: 6c3d 275f 6e6f 6c65 6765 6e64 5f27 290a  l='_nolegend_').
-00038160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038170: 2370 6c74 2e70 6c6f 7428 696e 6469 6178  #plt.plot(indiax
-00038180: 6973 2c20 672c 206c 6162 656c 3d27 302e  is, g, label='0.
-00038190: 3333 3327 2c20 6c69 6e65 7374 796c 653d  333', linestyle=
-000381a0: 272d 2d27 290a 2020 2020 2020 2020 2020  '--').          
-000381b0: 2020 2020 2020 706c 742e 706c 6f74 2878        plt.plot(x
-000381c0: 6c69 7374 5b3a 2d31 5d2c 206c 656e 2878  list[:-1], len(x
-000381d0: 6c69 7374 5b3a 2d31 5d29 2a5b 302e 3134  list[:-1])*[0.14
-000381e0: 335d 2c20 6c69 6e65 7374 796c 653d 272d  3], linestyle='-
-000381f0: 2e27 2c20 6c61 6265 6c3d 275f 6e6f 6c65  .', label='_nole
-00038200: 6765 6e64 5f27 290a 2020 2020 2020 2020  gend_').        
-00038210: 2020 2020 2020 2020 706c 742e 6c65 6765          plt.lege
-00038220: 6e64 2829 0a20 2020 2020 2020 2020 2020  nd().           
-00038230: 2020 2020 2070 6c74 2e73 6176 6566 6967       plt.savefig
-00038240: 2873 656c 662e 776f 726b 6469 7220 2b20  (self.workdir + 
-00038250: 7365 6c66 2e6d 6170 6e61 6d65 202b 2027  self.mapname + '
-00038260: 5f66 7363 2e70 6e67 2729 0a20 2020 2020  _fsc.png').     
-00038270: 2020 2020 2020 2020 2020 2070 6c74 2e63             plt.c
-00038280: 6c6f 7365 2829 0a20 2020 2020 2020 2020  lose().         
-00038290: 2020 2065 7863 6570 743a 0a20 2020 2020     except:.     
-000382a0: 2020 2020 2020 2020 2020 2065 7272 203d             err =
-000382b0: 2027 4653 4320 7265 6164 696e 6720 6572   'FSC reading er
-000382c0: 726f 723a 207b 7d2e 272e 666f 726d 6174  ror: {}.'.format
-000382d0: 2873 7973 2e65 7863 5f69 6e66 6f28 295b  (sys.exc_info()[
-000382e0: 315d 290a 2020 2020 2020 2020 2020 2020  1]).            
-000382f0: 2020 2020 6572 726c 6973 742e 6170 7065      errlist.appe
-00038300: 6e64 2865 7272 290a 2020 2020 2020 2020  nd(err).        
-00038310: 2020 2020 2020 2020 7379 732e 7374 6465          sys.stde
-00038320: 7272 2e77 7269 7465 2865 7272 202b 2027  rr.write(err + '
-00038330: 5c6e 2729 0a0a 2020 2020 2020 2020 2020  \n')..          
-00038340: 2020 6966 2065 7272 6c69 7374 3a0a 2020    if errlist:.  
-00038350: 2020 2020 2020 2020 2020 2020 2020 6669                fi
-00038360: 6e61 6c64 6963 745b 276c 6f61 645f 6673  naldict['load_fs
-00038370: 6327 5d20 3d20 7b27 6572 7227 3a20 7b27  c'] = {'err': {'
-00038380: 6c6f 6164 5f66 7363 5f65 7272 273a 2065  load_fsc_err': e
-00038390: 7272 6c69 7374 7d7d 0a0a 2020 2020 2020  rrlist}}..      
-000383a0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-000383b0: 2020 2020 2020 2020 2020 2077 6974 6820             with 
-000383c0: 636f 6465 6373 2e6f 7065 6e28 7365 6c66  codecs.open(self
-000383d0: 2e77 6f72 6b64 6972 202b 2073 656c 662e  .workdir + self.
-000383e0: 6d61 706e 616d 6520 2b20 275f 6c6f 6164  mapname + '_load
-000383f0: 6673 632e 6a73 6f6e 272c 2027 7727 2c20  fsc.json', 'w', 
-00038400: 656e 636f 6469 6e67 3d27 7574 662d 3827  encoding='utf-8'
-00038410: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
-00038420: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
-00038430: 2e64 756d 7028 6669 6e61 6c64 6963 742c  .dump(finaldict,
-00038440: 2066 290a 0a20 2020 2020 2020 2020 2020   f)..           
-00038450: 2020 2020 2072 6574 7572 6e20 4e6f 6e65       return None
-00038460: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-00038470: 6570 743a 0a20 2020 2020 2020 2020 2020  ept:.           
-00038480: 2020 2020 2073 7973 2e73 7464 6572 722e       sys.stderr.
-00038490: 7772 6974 6528 2753 6176 696e 6720 6c6f  write('Saving lo
-000384a0: 6164 6564 2046 5343 2074 6f20 6a73 6f6e  aded FSC to json
-000384b0: 2065 7272 6f72 3a7b 7d2e 5c6e 272e 666f   error:{}.\n'.fo
-000384c0: 726d 6174 2873 7973 2e65 7863 5f69 6e66  rmat(sys.exc_inf
-000384d0: 6f28 295b 315d 2929 0a20 2020 2020 2020  o()[1])).       
-000384e0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000384f0: 2020 2070 7269 6e74 2827 4e6f 2066 7363     print('No fsc
-00038500: 2e78 6d6c 2066 696c 6520 6361 6e20 6265  .xml file can be
-00038510: 2072 6561 6420 666f 7220 4653 4320 696e   read for FSC in
-00038520: 666f 726d 6174 696f 6e2e 2729 0a0a 0a20  formation.')... 
-00038530: 2020 2023 2040 7072 6f66 696c 650a 2020     # @profile.  
-00038540: 2020 6465 6620 6673 6328 7365 6c66 2c20    def fsc(self, 
-00038550: 6d61 706f 6464 2c20 6d61 7065 7665 6e2c  mapodd, mapeven,
-00038560: 2061 7379 6d3d 312e 302c 206c 6162 656c   asym=1.0, label
-00038570: 3d27 2729 3a0a 2020 2020 2020 2020 2222  =''):.        ""
-00038580: 220a 0a20 2020 2020 2020 2020 2020 2043  "..            C
-00038590: 616c 6375 6c61 7465 2046 5343 2062 6173  alculate FSC bas
-000385a0: 6564 206f 6e20 7468 6520 7477 6f20 696e  ed on the two in
-000385b0: 7075 7420 6861 6c66 206d 6170 730a 2020  put half maps.  
-000385c0: 2020 2020 2020 2020 2020 5265 7375 6c74            Result
-000385d0: 7320 7772 6f74 6520 746f 204a 534f 4e20  s wrote to JSON 
-000385e0: 6669 6c65 2069 6e63 6c75 6469 6e67 2072  file including r
-000385f0: 6573 6f6c 7574 696f 6e20 6174 2030 2e31  esolution at 0.1
-00038600: 3433 2c20 302e 3333 332c 2030 2e35 2061  43, 0.333, 0.5 a
-00038610: 6e64 206e 6f69 7365 0a20 2020 2020 2020  nd noise.       
-00038620: 2020 2020 206c 6576 656c 2061 7420 302e       level at 0.
-00038630: 352d 6269 742c 2031 2d62 6974 2c20 332d  5-bit, 1-bit, 3-
-00038640: 7369 676d 612e 2041 2063 6f72 7265 7370  sigma. A corresp
-00038650: 6f6e 6469 6e67 2070 6c6f 7420 6973 2061  onding plot is a
-00038660: 6c73 6f20 7361 7665 2061 7320 504e 4720  lso save as PNG 
-00038670: 6669 6c65 2e0a 0a20 2020 2020 2020 203a  file...        :
-00038680: 7061 7261 6d20 6d61 706f 6464 3a20 5445  param mapodd: TE
-00038690: 4d50 7920 6d61 7020 696e 7374 616e 6365  MPy map instance
-000386a0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-000386b0: 6d61 7065 7665 6e3a 2054 454d 5079 206d  mapeven: TEMPy m
-000386c0: 6170 2069 6e73 7461 6e63 650a 2020 2020  ap instance.    
-000386d0: 2020 2020 3a72 6574 7572 6e3a 204e 6f6e      :return: Non
-000386e0: 650a 0a20 2020 2020 2020 2022 2222 0a0a  e..        """..
-000386f0: 2020 2020 2020 2020 7374 6172 7420 3d20          start = 
-00038700: 7469 6d65 6974 2e64 6566 6175 6c74 5f74  timeit.default_t
-00038710: 696d 6572 2829 0a20 2020 2020 2020 2065  imer().        e
-00038720: 7272 6c69 7374 203d 205b 5d0a 2020 2020  rrlist = [].    
-00038730: 2020 2020 6461 7461 6469 6374 203d 2064      datadict = d
-00038740: 6963 7428 290a 2020 2020 2020 2020 6669  ict().        fi
-00038750: 6e61 6c64 6963 7420 3d20 6469 6374 2829  naldict = dict()
-00038760: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-00038770: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00038780: 206d 6170 6f64 642e 6461 7461 2e73 6861   mapodd.data.sha
-00038790: 7065 203d 3d20 6d61 7065 7665 6e2e 6461  pe == mapeven.da
-000387a0: 7461 2e73 6861 7065 2c20 2754 6865 2074  ta.shape, 'The t
-000387b0: 776f 2068 616c 6620 6d61 7073 2064 6f20  wo half maps do 
-000387c0: 6e6f 7420 6861 7665 2073 616d 6520 7369  not have same si
-000387d0: 7a65 2e27 0a20 2020 2020 2020 2020 2020  ze.'.           
-000387e0: 2061 7373 6572 7420 6d61 706f 6464 2e76   assert mapodd.v
-000387f0: 6f78 656c 5f73 697a 6520 3d3d 206d 6170  oxel_size == map
-00038800: 6576 656e 2e76 6f78 656c 5f73 697a 652c  even.voxel_size,
-00038810: 2027 5468 6520 7477 6f20 6861 6c66 206d   'The two half m
-00038820: 6170 7320 646f 206e 6f74 2068 6176 6520  aps do not have 
-00038830: 7361 6d65 2061 7069 782e 270a 2020 2020  same apix.'.    
-00038840: 2020 2020 2020 2020 6f64 646e 616e 203d          oddnan =
-00038850: 206e 702e 6973 6e61 6e28 6d61 706f 6464   np.isnan(mapodd
-00038860: 2e64 6174 6129 2e61 6e79 2829 0a20 2020  .data).any().   
-00038870: 2020 2020 2020 2020 2065 7665 6e6e 616e           evennan
-00038880: 203d 206e 702e 6973 6e61 6e28 6d61 7065   = np.isnan(mape
-00038890: 7665 6e2e 6461 7461 292e 616e 7928 290a  ven.data).any().
-000388a0: 2020 2020 2020 2020 2020 2020 6e61 6e63              nanc
-000388b0: 6865 636b 203d 206f 6464 6e61 6e20 7c20  heck = oddnan | 
-000388c0: 6576 656e 6e61 6e0a 2020 2020 2020 2020  evennan.        
-000388d0: 2020 2020 6173 7365 7274 206e 6f74 206e      assert not n
-000388e0: 616e 6368 6563 6b2c 2027 5468 6572 6520  ancheck, 'There 
-000388f0: 6973 204e 614e 2076 616c 7565 2069 6e20  is NaN value in 
-00038900: 6861 6c66 206d 6170 2e27 0a0a 2020 2020  half map.'..    
-00038910: 2020 2020 2020 2020 6d61 705f 7a73 697a          map_zsiz
-00038920: 6520 3d20 6d61 706f 6464 2e68 6561 6465  e = mapodd.heade
-00038930: 722e 6e7a 0a20 2020 2020 2020 2020 2020  r.nz.           
-00038940: 206d 6170 5f79 7369 7a65 203d 206d 6170   map_ysize = map
-00038950: 6f64 642e 6865 6164 6572 2e6e 790a 2020  odd.header.ny.  
-00038960: 2020 2020 2020 2020 2020 6d61 705f 7873            map_xs
-00038970: 697a 6520 3d20 6d61 706f 6464 2e68 6561  ize = mapodd.hea
-00038980: 6465 722e 6e78 0a0a 2020 2020 2020 2020  der.nx..        
-00038990: 2020 2020 6170 6978 7320 3d20 7475 706c      apixs = tupl
-000389a0: 6528 6d61 706f 6464 2e76 6f78 656c 5f73  e(mapodd.voxel_s
-000389b0: 697a 652e 746f 6c69 7374 2829 290a 0a20  ize.tolist()).. 
-000389c0: 2020 2020 2020 2020 2020 206d 6170 6f64             mapod
-000389d0: 645f 6461 7461 203d 2066 6674 7368 6966  d_data = fftshif
-000389e0: 7428 6666 746e 286d 6170 6f64 642e 6461  t(fftn(mapodd.da
-000389f0: 7461 2929 0a20 2020 2020 2020 2020 2020  ta)).           
-00038a00: 206d 6170 6576 656e 5f64 6174 6120 3d20   mapeven_data = 
-00038a10: 6666 7473 6869 6674 2866 6674 6e28 6d61  fftshift(fftn(ma
-00038a20: 7065 7665 6e2e 6461 7461 2929 0a0a 2020  peven.data))..  
-00038a30: 2020 2020 2020 2020 2020 7374 6172 7420            start 
-00038a40: 3d20 7469 6d65 6974 2e64 6566 6175 6c74  = timeit.default
-00038a50: 5f74 696d 6572 2829 202d 2073 7461 7274  _timer() - start
-00038a60: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-00038a70: 6e74 2827 202d 2d20 4653 4320 466f 7572  nt(' -- FSC Four
-00038a80: 6965 722d 7472 616e 7366 6f72 6d61 7469  ier-transformati
-00038a90: 6f6e 2074 696d 653a 2025 7327 2025 2073  on time: %s' % s
-00038aa0: 7461 7274 290a 0a20 2020 2020 2020 2020  tart)..         
-00038ab0: 2020 2023 2047 7269 6420 6865 7265 2074     # Grid here t
-00038ac0: 6f20 6765 6e65 7261 7465 2066 6f72 2074  o generate for t
-00038ad0: 7261 6369 6e67 2074 6865 2069 6e64 6963  racing the indic
-00038ae0: 6573 206f 6620 6772 6964 7320 7769 7468  es of grids with
-00038af0: 2069 6e20 7468 6520 7368 656c 6c73 2e0a   in the shells..
-00038b00: 2020 2020 2020 2020 2020 2020 7a67 7269              zgri
-00038b10: 6420 3d20 6e70 2e61 7261 6e67 6528 666c  d = np.arange(fl
-00038b20: 6f6f 7228 6d61 705f 7a73 697a 6520 2f20  oor(map_zsize / 
-00038b30: 322e 3029 202a 202d 312c 2063 6569 6c28  2.0) * -1, ceil(
-00038b40: 6d61 705f 7a73 697a 6520 2f20 322e 3029  map_zsize / 2.0)
-00038b50: 2920 2f20 666c 6f61 7428 0a20 2020 2020  ) / float(.     
-00038b60: 2020 2020 2020 2020 2020 2066 6c6f 6f72             floor
-00038b70: 286d 6170 5f7a 7369 7a65 2929 0a20 2020  (map_zsize)).   
-00038b80: 2020 2020 2020 2020 2079 6772 6964 203d           ygrid =
-00038b90: 206e 702e 6172 616e 6765 2866 6c6f 6f72   np.arange(floor
-00038ba0: 286d 6170 5f79 7369 7a65 202f 2032 2e30  (map_ysize / 2.0
-00038bb0: 2920 2a20 2d31 2c20 6365 696c 286d 6170  ) * -1, ceil(map
-00038bc0: 5f79 7369 7a65 202f 2032 2e30 2929 202f  _ysize / 2.0)) /
-00038bd0: 2066 6c6f 6174 280a 2020 2020 2020 2020   float(.        
-00038be0: 2020 2020 2020 2020 666c 6f6f 7228 6d61          floor(ma
-00038bf0: 705f 7973 697a 6529 290a 2020 2020 2020  p_ysize)).      
-00038c00: 2020 2020 2020 7867 7269 6420 3d20 6e70        xgrid = np
-00038c10: 2e61 7261 6e67 6528 666c 6f6f 7228 6d61  .arange(floor(ma
-00038c20: 705f 7873 697a 6520 2f20 322e 3029 202a  p_xsize / 2.0) *
-00038c30: 202d 312c 2063 6569 6c28 6d61 705f 7873   -1, ceil(map_xs
-00038c40: 697a 6520 2f20 322e 3029 2920 2f20 666c  ize / 2.0)) / fl
-00038c50: 6f61 7428 0a20 2020 2020 2020 2020 2020  oat(.           
-00038c60: 2020 2020 2066 6c6f 6f72 286d 6170 5f78       floor(map_x
-00038c70: 7369 7a65 2929 0a20 2020 2020 2020 2020  size)).         
-00038c80: 2020 2078 6469 7320 3d20 7867 7269 6420     xdis = xgrid 
-00038c90: 2a2a 2032 0a20 2020 2020 2020 2020 2020  ** 2.           
-00038ca0: 2079 6469 7320 3d20 7967 7269 6420 2a2a   ydis = ygrid **
-00038cb0: 2032 0a20 2020 2020 2020 2020 2020 207a   2.            z
-00038cc0: 6469 7320 3d20 7a67 7269 6420 2a2a 2032  dis = zgrid ** 2
-00038cd0: 0a20 2020 2020 2020 2020 2020 2064 6973  .            dis
-00038ce0: 7420 3d20 6e70 2e73 7172 7428 7a64 6973  t = np.sqrt(zdis
-00038cf0: 5b3a 2c20 4e6f 6e65 2c20 4e6f 6e65 5d20  [:, None, None] 
-00038d00: 2b20 7964 6973 5b3a 2c20 4e6f 6e65 5d20  + ydis[:, None] 
-00038d10: 2b20 7864 6973 290a 0a20 2020 2020 2020  + xdis)..       
-00038d20: 2020 2020 2061 6c6c 6178 6973 203d 206e       allaxis = n
-00038d30: 702e 6172 7261 7928 5b7a 6772 6964 2c20  p.array([zgrid, 
-00038d40: 7967 7269 642c 2078 6772 6964 5d29 0a20  ygrid, xgrid]). 
-00038d50: 2020 2020 2020 2020 2020 2074 6d70 696e             tmpin
-00038d60: 6469 6178 6973 203d 206d 6178 2861 6c6c  diaxis = max(all
-00038d70: 6178 6973 2c20 6b65 793d 6c65 6e29 0a20  axis, key=len). 
-00038d80: 2020 2020 2020 2020 2020 2069 6e64 6961             india
-00038d90: 7869 7374 203d 2074 6d70 696e 6469 6178  xist = tmpindiax
-00038da0: 6973 5b74 6d70 696e 6469 6178 6973 203e  is[tmpindiaxis >
-00038db0: 3d20 305d 0a20 2020 2020 2020 2020 2020  = 0].           
-00038dc0: 206c 696e 6469 203d 206c 656e 2869 6e64   lindi = len(ind
-00038dd0: 6961 7869 7374 290a 2020 2020 2020 2020  iaxist).        
-00038de0: 2020 2020 6966 2074 7970 6528 6170 6978      if type(apix
-00038df0: 7329 2069 7320 7475 706c 653a 0a20 2020  s) is tuple:.   
-00038e00: 2020 2020 2020 2020 2020 2020 2074 6170               tap
-00038e10: 6978 203d 2061 7069 7873 5b30 5d0a 2020  ix = apixs[0].  
-00038e20: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00037f60: 6966 2079 6c69 7374 5b30 5d20 3c3d 2030  if ylist[0] <= 0
+00037f70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00037f80: 2020 2020 2020 796c 6973 745b 305d 203d        ylist[0] =
+00037f90: 2031 0a0a 2020 2020 2020 2020 2020 2020   1..            
+00037fa0: 2020 2020 6120 3d20 6e70 2e61 7361 7272      a = np.asarr
+00037fb0: 6179 2878 6c69 7374 290a 2020 2020 2020  ay(xlist).      
+00037fc0: 2020 2020 2020 2020 2020 6220 3d20 6e70            b = np
+00037fd0: 2e61 7361 7272 6179 2879 6c69 7374 290a  .asarray(ylist).
+00037fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037ff0: 6320 3d20 6e70 2e61 7361 7272 6179 2874  c = np.asarray(t
+00038000: 6872 6565 7369 6729 0a20 2020 2020 2020  hreesig).       
+00038010: 2020 2020 2020 2020 2064 203d 206e 702e           d = np.
+00038020: 6173 6172 7261 7928 6861 6c66 6269 7429  asarray(halfbit)
+00038030: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00038040: 2065 203d 206e 702e 6173 6172 7261 7928   e = np.asarray(
+00038050: 6f6e 6562 6974 290a 2020 2020 2020 2020  onebit).        
+00038060: 2020 2020 2020 2020 6620 3d20 6e70 2e66          f = np.f
+00038070: 756c 6c28 286c 656e 2878 6c69 7374 2929  ull((len(xlist))
+00038080: 2c20 302e 3529 0a20 2020 2020 2020 2020  , 0.5).         
+00038090: 2020 2020 2020 2067 203d 206e 702e 6675         g = np.fu
+000380a0: 6c6c 2828 6c65 6e28 786c 6973 7429 292c  ll((len(xlist)),
+000380b0: 2030 2e33 3333 290a 2020 2020 2020 2020   0.333).        
+000380c0: 2020 2020 2020 2020 6820 3d20 6e70 2e66          h = np.f
+000380d0: 756c 6c28 286c 656e 2878 6c69 7374 2929  ull((len(xlist))
+000380e0: 2c20 302e 3134 3329 0a0a 2020 2020 2020  , 0.143)..      
+000380f0: 2020 2020 2020 2020 2020 6966 206c 656e            if len
+00038100: 2863 2920 3c20 6c65 6e28 6229 3a0a 2020  (c) < len(b):.  
+00038110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038120: 2020 6220 3d20 625b 3a6c 656e 2863 295d    b = b[:len(c)]
+00038130: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00038140: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00038150: 2020 2020 2020 2020 2020 2063 203d 2063             c = c
+00038160: 5b3a 6c65 6e28 6229 5d0a 0a20 2020 2020  [:len(b)]..     
+00038170: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
+00038180: 6e28 6429 203c 206c 656e 2862 293a 0a20  n(d) < len(b):. 
+00038190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000381a0: 2020 2062 203d 2062 5b3a 6c65 6e28 6429     b = b[:len(d)
+000381b0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+000381c0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000381d0: 2020 2020 2020 2020 2020 2020 6420 3d20              d = 
+000381e0: 645b 3a6c 656e 2862 295d 0a0a 0a20 2020  d[:len(b)]...   
+000381f0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00038200: 6c65 6e28 6529 203c 206c 656e 2862 293a  len(e) < len(b):
+00038210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00038220: 2020 2020 2062 203d 2062 5b3a 6c65 6e28       b = b[:len(
+00038230: 6529 5d0a 2020 2020 2020 2020 2020 2020  e)].            
+00038240: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00038250: 2020 2020 2020 2020 2020 2020 2020 6520                e 
+00038260: 3d20 655b 3a6c 656e 2862 295d 0a0a 0a20  = e[:len(b)]... 
+00038270: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00038280: 6620 6c65 6e28 6629 203c 206c 656e 2862  f len(f) < len(b
+00038290: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000382a0: 2020 2020 2020 2062 203d 2062 5b3a 6c65         b = b[:le
+000382b0: 6e28 6629 5d0a 2020 2020 2020 2020 2020  n(f)].          
+000382c0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000382d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000382e0: 6620 3d20 665b 3a6c 656e 2862 295d 0a0a  f = f[:len(b)]..
+000382f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00038300: 2069 6620 6c65 6e28 6729 203c 206c 656e   if len(g) < len
+00038310: 2862 293a 0a20 2020 2020 2020 2020 2020  (b):.           
+00038320: 2020 2020 2020 2020 2062 203d 2062 5b3a           b = b[:
+00038330: 6c65 6e28 6729 5d0a 2020 2020 2020 2020  len(g)].        
+00038340: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00038350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038360: 2020 6720 3d20 675b 3a6c 656e 2862 295d    g = g[:len(b)]
+00038370: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00038380: 2020 6966 206c 656e 2868 2920 3c20 6c65    if len(h) < le
+00038390: 6e28 6229 3a0a 2020 2020 2020 2020 2020  n(b):.          
+000383a0: 2020 2020 2020 2020 2020 6220 3d20 625b            b = b[
+000383b0: 3a6c 656e 2868 295d 0a20 2020 2020 2020  :len(h)].       
+000383c0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+000383d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000383e0: 2020 2068 203d 2068 5b3a 6c65 6e28 6229     h = h[:len(b)
+000383f0: 5d0a 0a20 2020 2020 2020 2020 2020 2020  ]..             
+00038400: 2020 2078 7468 7265 6573 6967 2c20 7974     xthreesig, yt
+00038410: 6872 6565 7369 6720 3d20 7365 6c66 2e5f  hreesig = self._
+00038420: 5f69 6e74 6572 706f 6c61 7465 645f 696e  _interpolated_in
+00038430: 7465 7263 6570 7428 612c 2062 2c20 6329  tercept(a, b, c)
+00038440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00038450: 2078 6861 6c66 6269 742c 2079 6861 6c66   xhalfbit, yhalf
+00038460: 6269 7420 3d20 7365 6c66 2e5f 5f69 6e74  bit = self.__int
+00038470: 6572 706f 6c61 7465 645f 696e 7465 7263  erpolated_interc
+00038480: 6570 7428 612c 2062 2c20 6429 0a20 2020  ept(a, b, d).   
+00038490: 2020 2020 2020 2020 2020 2020 2078 6f6e               xon
+000384a0: 6562 6974 2c20 796f 6e65 6269 7420 3d20  ebit, yonebit = 
+000384b0: 7365 6c66 2e5f 5f69 6e74 6572 706f 6c61  self.__interpola
+000384c0: 7465 645f 696e 7465 7263 6570 7428 612c  ted_intercept(a,
+000384d0: 2062 2c20 6529 0a20 2020 2020 2020 2020   b, e).         
+000384e0: 2020 2020 2020 2078 6861 6c66 2c20 7968         xhalf, yh
+000384f0: 616c 6620 3d20 7365 6c66 2e5f 5f69 6e74  alf = self.__int
+00038500: 6572 706f 6c61 7465 645f 696e 7465 7263  erpolated_interc
+00038510: 6570 7428 612c 2062 2c20 6629 0a20 2020  ept(a, b, f).   
+00038520: 2020 2020 2020 2020 2020 2020 2078 6f6e               xon
+00038530: 6574 6872 6565 2c20 796f 6e65 7468 7265  ethree, yonethre
+00038540: 6520 3d20 7365 6c66 2e5f 5f69 6e74 6572  e = self.__inter
+00038550: 706f 6c61 7465 645f 696e 7465 7263 6570  polated_intercep
+00038560: 7428 612c 2062 2c20 6729 0a20 2020 2020  t(a, b, g).     
+00038570: 2020 2020 2020 2020 2020 2078 676f 6c64             xgold
+00038580: 2c20 7967 6f6c 6420 3d20 7365 6c66 2e5f  , ygold = self._
+00038590: 5f69 6e74 6572 706f 6c61 7465 645f 696e  _interpolated_in
+000385a0: 7465 7263 6570 7428 612c 2062 2c20 6829  tercept(a, b, h)
+000385b0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000385c0: 2020 6966 2078 7468 7265 6573 6967 2e73    if xthreesig.s
+000385d0: 697a 6520 3d3d 2030 2061 6e64 2079 7468  ize == 0 and yth
+000385e0: 7265 6573 6967 2e73 697a 6520 3d3d 2030  reesig.size == 0
+000385f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00038600: 2020 2020 2020 7478 7468 7265 6573 6967        txthreesig
+00038610: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+00038620: 2020 2020 2020 2020 2020 2020 7479 7468              tyth
+00038630: 7265 6573 6967 203d 204e 6f6e 650a 2020  reesig = None.  
+00038640: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00038650: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00038660: 2020 2020 2020 2020 7478 7468 7265 6573          txthrees
+00038670: 6967 203d 206e 702e 726f 756e 6428 7874  ig = np.round(xt
+00038680: 6872 6565 7369 675b 305d 5b30 5d2c 2034  hreesig[0][0], 4
+00038690: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000386a0: 2020 2020 2020 7479 7468 7265 6573 6967        tythreesig
+000386b0: 203d 206e 702e 726f 756e 6428 7974 6872   = np.round(ythr
+000386c0: 6565 7369 675b 305d 5b30 5d2c 2034 290a  eesig[0][0], 4).
+000386d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000386e0: 2069 6620 7868 616c 6662 6974 2e73 697a   if xhalfbit.siz
+000386f0: 6520 3d3d 2030 2061 6e64 2079 6861 6c66  e == 0 and yhalf
+00038700: 6269 742e 7369 7a65 203d 3d20 303a 0a20  bit.size == 0:. 
+00038710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038720: 2020 2074 7868 616c 6662 6974 203d 204e     txhalfbit = N
+00038730: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+00038740: 2020 2020 2020 2020 7479 6861 6c66 6269          tyhalfbi
+00038750: 7420 3d20 4e6f 6e65 0a20 2020 2020 2020  t = None.       
+00038760: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00038770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038780: 2020 2069 6620 6e70 2e69 736e 616e 2878     if np.isnan(x
+00038790: 6861 6c66 6269 745b 305d 5b30 5d29 3a0a  halfbit[0][0]):.
+000387a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000387b0: 2020 2020 2020 2020 7478 6861 6c66 6269          txhalfbi
+000387c0: 7420 3d20 4e6f 6e65 0a20 2020 2020 2020  t = None.       
+000387d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000387e0: 2074 7968 616c 6662 6974 203d 204e 6f6e   tyhalfbit = Non
+000387f0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00038800: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+00038810: 2721 2121 2054 6865 206c 6f61 6465 6420  '!!! The loaded 
+00038820: 6673 6320 6861 7320 6e6f 2069 6e74 6572  fsc has no inter
+00038830: 7365 6374 696f 6e20 7769 7468 2074 6865  section with the
+00038840: 2068 616c 6620 6269 7420 6375 7276 6520   half bit curve 
+00038850: 2121 2127 290a 2020 2020 2020 2020 2020  !!!').          
+00038860: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00038870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038880: 2020 2020 2020 2020 7478 6861 6c66 6269          txhalfbi
+00038890: 7420 3d20 6e70 2e72 6f75 6e64 2878 6861  t = np.round(xha
+000388a0: 6c66 6269 745b 305d 5b30 5d2c 2034 290a  lfbit[0][0], 4).
+000388b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000388c0: 2020 2020 2020 2020 7479 6861 6c66 6269          tyhalfbi
+000388d0: 7420 3d20 6e70 2e72 6f75 6e64 2879 6861  t = np.round(yha
+000388e0: 6c66 6269 745b 305d 5b30 5d2c 2034 290a  lfbit[0][0], 4).
+000388f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00038900: 2069 6620 786f 6e65 6269 742e 7369 7a65   if xonebit.size
+00038910: 203d 3d20 3020 616e 6420 796f 6e65 6269   == 0 and yonebi
+00038920: 742e 7369 7a65 203d 3d20 303a 0a20 2020  t.size == 0:.   
+00038930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038940: 2074 786f 6e65 6269 7420 3d20 4e6f 6e65   txonebit = None
+00038950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00038960: 2020 2020 2074 796f 6e65 6269 7420 3d20       tyonebit = 
+00038970: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+00038980: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00038990: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+000389a0: 786f 6e65 6269 7420 3d20 6e70 2e72 6f75  xonebit = np.rou
+000389b0: 6e64 2878 6f6e 6562 6974 5b30 5d5b 305d  nd(xonebit[0][0]
+000389c0: 2c20 3429 0a20 2020 2020 2020 2020 2020  , 4).           
+000389d0: 2020 2020 2020 2020 2074 796f 6e65 6269           tyonebi
+000389e0: 7420 3d20 6e70 2e72 6f75 6e64 2879 6f6e  t = np.round(yon
+000389f0: 6562 6974 5b30 5d5b 305d 2c20 3429 0a0a  ebit[0][0], 4)..
+00038a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038a10: 6966 2078 6861 6c66 2e73 697a 6520 3d3d  if xhalf.size ==
+00038a20: 2030 2061 6e64 2079 6861 6c66 2e73 697a   0 and yhalf.siz
+00038a30: 6520 3d3d 2030 3a0a 2020 2020 2020 2020  e == 0:.        
+00038a40: 2020 2020 2020 2020 2020 2020 7478 6861              txha
+00038a50: 6c66 203d 204e 6f6e 650a 2020 2020 2020  lf = None.      
+00038a60: 2020 2020 2020 2020 2020 2020 2020 7479                ty
+00038a70: 6861 6c66 203d 204e 6f6e 650a 2020 2020  half = None.    
+00038a80: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00038a90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00038aa0: 2020 2020 2020 7478 6861 6c66 203d 206e        txhalf = n
+00038ab0: 702e 726f 756e 6428 7868 616c 665b 305d  p.round(xhalf[0]
+00038ac0: 5b30 5d2c 2034 290a 2020 2020 2020 2020  [0], 4).        
+00038ad0: 2020 2020 2020 2020 2020 2020 7479 6861              tyha
+00038ae0: 6c66 203d 206e 702e 726f 756e 6428 7968  lf = np.round(yh
+00038af0: 616c 665b 305d 5b30 5d2c 2034 290a 0a20  alf[0][0], 4).. 
+00038b00: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00038b10: 6620 786f 6e65 7468 7265 652e 7369 7a65  f xonethree.size
+00038b20: 203d 3d20 3020 616e 6420 796f 6e65 7468   == 0 and yoneth
+00038b30: 7265 652e 7369 7a65 203d 3d20 303a 0a20  ree.size == 0:. 
+00038b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038b50: 2020 2074 786f 6e65 7468 7265 6520 3d20     txonethree = 
+00038b60: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+00038b70: 2020 2020 2020 2020 2074 796f 6e65 7468           tyoneth
+00038b80: 7265 6520 3d20 4e6f 6e65 0a20 2020 2020  ree = None.     
+00038b90: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00038ba0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00038bb0: 2020 2020 2074 786f 6e65 7468 7265 6520       txonethree 
+00038bc0: 3d20 6e70 2e72 6f75 6e64 2878 6f6e 6574  = np.round(xonet
+00038bd0: 6872 6565 5b30 5d5b 305d 2c20 3429 0a20  hree[0][0], 4). 
+00038be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038bf0: 2020 2074 796f 6e65 7468 7265 6520 3d20     tyonethree = 
+00038c00: 6e70 2e72 6f75 6e64 2879 6f6e 6574 6872  np.round(yonethr
+00038c10: 6565 5b30 5d5b 305d 2c20 3429 0a0a 2020  ee[0][0], 4)..  
+00038c20: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00038c30: 2078 676f 6c64 2e73 697a 6520 3d3d 2030   xgold.size == 0
+00038c40: 2061 6e64 2079 676f 6c64 2e73 697a 6520   and ygold.size 
+00038c50: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
+00038c60: 2020 2020 2020 2020 2020 7478 676f 6c64            txgold
+00038c70: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+00038c80: 2020 2020 2020 2020 2020 2020 7479 676f              tygo
+00038c90: 6c64 203d 204e 6f6e 650a 2020 2020 2020  ld = None.      
+00038ca0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00038cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038cc0: 2020 2020 7478 676f 6c64 203d 206e 702e      txgold = np.
+00038cd0: 726f 756e 6428 7867 6f6c 645b 305d 5b30  round(xgold[0][0
+00038ce0: 5d2c 2034 290a 2020 2020 2020 2020 2020  ], 4).          
+00038cf0: 2020 2020 2020 2020 2020 7479 676f 6c64            tygold
+00038d00: 203d 206e 702e 726f 756e 6428 7967 6f6c   = np.round(ygol
+00038d10: 645b 305d 5b30 5d2c 2034 290a 0a20 2020  d[0][0], 4)..   
+00038d20: 2020 2020 2020 2020 2020 2020 2078 6c65               xle
+00038d30: 6e20 3d20 6c65 6e28 786c 6973 7429 0a0a  n = len(xlist)..
+00038d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038d50: 6461 7461 6469 6374 203d 207b 0a20 2020  datadict = {.   
+00038d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038d70: 2027 6375 7276 6573 273a 207b 2766 7363   'curves': {'fsc
+00038d80: 7927 3a20 6e70 2e72 6f75 6e64 286e 702e  y': np.round(np.
+00038d90: 7265 616c 2879 6c69 7374 292c 2034 292e  real(ylist), 4).
+00038da0: 746f 6c69 7374 2829 2c20 2774 6872 6565  tolist(), 'three
+00038db0: 7369 676d 6127 3a20 6e70 2e72 6f75 6e64  sigma': np.round
+00038dc0: 2874 6872 6565 7369 672c 2034 292e 746f  (threesig, 4).to
+00038dd0: 6c69 7374 2829 5b3a 786c 656e 5d2c 0a20  list()[:xlen],. 
+00038de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038df0: 2020 2020 2020 2020 2020 2020 2020 2768                'h
+00038e00: 616c 6662 6974 273a 206e 702e 726f 756e  alfbit': np.roun
+00038e10: 6428 6861 6c66 6269 742c 2034 292e 746f  d(halfbit, 4).to
+00038e20: 6c69 7374 2829 5b3a 786c 656e 5d2c 0a20  list()[:xlen],. 
 00038e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038e40: 7461 7069 7820 3d20 6170 6978 730a 2020  tapix = apixs.  
-00038e50: 2020 2020 2020 2020 2020 696e 6469 6178            indiax
-00038e60: 6973 203d 206e 702e 6c69 6e73 7061 6365  is = np.linspace
-00038e70: 2830 2c20 3120 2f20 2832 202a 2074 6170  (0, 1 / (2 * tap
-00038e80: 6978 292c 206c 696e 6469 290a 0a20 2020  ix), lindi)..   
-00038e90: 2020 2020 2020 2020 2023 204c 6f6f 7069           # Loopi
-00038ea0: 6e67 2074 6872 6f75 6768 2061 6c6c 2073  ng through all s
-00038eb0: 6865 6c6c 730a 2020 2020 2020 2020 2020  hells.          
-00038ec0: 2020 636f 7272 6c69 7374 203d 205b 5d0a    corrlist = [].
-00038ed0: 2020 2020 2020 2020 2020 2020 7468 7265              thre
-00038ee0: 6573 6967 203d 205b 5d0a 2020 2020 2020  esig = [].      
-00038ef0: 2020 2020 2020 6861 6c66 6269 7420 3d20        halfbit = 
-00038f00: 5b5d 0a20 2020 2020 2020 2020 2020 206f  [].            o
-00038f10: 6e65 6269 7420 3d20 5b5d 0a20 2020 2020  nebit = [].     
-00038f20: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
-00038f30: 7261 6e67 6528 6c65 6e28 696e 6469 6178  range(len(indiax
-00038f40: 6973 2929 3a0a 2020 2020 2020 2020 2020  is)):.          
-00038f50: 2020 2020 2020 6966 2069 203d 3d20 303a        if i == 0:
-00038f60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00038f70: 2020 2020 2069 6e64 6963 6573 203d 206e       indices = n
-00038f80: 702e 6172 6777 6865 7265 2864 6973 7420  p.argwhere(dist 
-00038f90: 3d3d 2069 6e64 6961 7869 735b 695d 290a  == indiaxis[i]).
-00038fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038fb0: 2020 2020 6f64 6472 696e 6720 3d20 6d61      oddring = ma
-00038fc0: 706f 6464 5f64 6174 615b 7475 706c 6528  podd_data[tuple(
-00038fd0: 696e 6469 6365 732e 5429 5d0a 2020 2020  indices.T)].    
+00038e40: 2020 2020 2020 2020 2020 2020 2020 276f                'o
+00038e50: 6e65 6269 7427 3a20 6e70 2e72 6f75 6e64  nebit': np.round
+00038e60: 286f 6e65 6269 742c 2034 292e 746f 6c69  (onebit, 4).toli
+00038e70: 7374 2829 5b3a 786c 656e 5d2c 2027 302e  st()[:xlen], '0.
+00038e80: 3527 3a20 662e 746f 6c69 7374 2829 5b3a  5': f.tolist()[:
+00038e90: 786c 656e 5d2c 2027 302e 3333 3327 3a20  xlen], '0.333': 
+00038ea0: 672e 746f 6c69 7374 2829 5b3a 786c 656e  g.tolist()[:xlen
+00038eb0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00038ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038ed0: 2020 2730 2e31 3433 273a 2068 2e74 6f6c    '0.143': h.tol
+00038ee0: 6973 7428 295b 3a78 6c65 6e5d 2c0a 2020  ist()[:xlen],.  
+00038ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038f00: 2020 2020 2020 2020 2020 2020 2027 6c65               'le
+00038f10: 7665 6c27 3a20 6e70 2e72 6f75 6e64 286e  vel': np.round(n
+00038f20: 702e 7265 616c 2878 6c69 7374 292c 2034  p.real(xlist), 4
+00038f30: 292e 746f 6c69 7374 2829 2c0a 2020 2020  ).tolist(),.    
+00038f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038f50: 2020 2020 2020 2020 2020 2027 6673 6378             'fscx
+00038f60: 273a 206e 702e 726f 756e 6428 6e70 2e72  ': np.round(np.r
+00038f70: 6561 6c28 786c 6973 7429 2c20 3429 2e74  eal(xlist), 4).t
+00038f80: 6f6c 6973 7428 297d 2c0a 2020 2020 2020  olist()},.      
+00038f90: 2020 2020 2020 2020 2020 2020 2020 2769                'i
+00038fa0: 6e74 6572 7365 6374 696f 6e73 273a 207b  ntersections': {
+00038fb0: 2774 6872 6565 7369 6727 3a20 7b27 7827  'threesig': {'x'
+00038fc0: 3a20 7478 7468 7265 6573 6967 2c20 2779  : txthreesig, 'y
+00038fd0: 273a 2074 7974 6872 6565 7369 677d 2c0a  ': tythreesig},.
 00038fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038ff0: 6576 656e 7269 6e67 203d 206d 6170 6576  evenring = mapev
-00039000: 656e 5f64 6174 615b 7475 706c 6528 696e  en_data[tuple(in
-00039010: 6469 6365 732e 5429 5d0a 0a20 2020 2020  dices.T)]..     
-00039020: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-00039030: 6920 213d 206c 656e 2869 6e64 6961 7869  i != len(indiaxi
-00039040: 7329 202d 2031 3a0a 2020 2020 2020 2020  s) - 1:.        
-00039050: 2020 2020 2020 2020 2020 2020 696e 6469              indi
-00039060: 6365 7320 3d20 6e70 2e61 7267 7768 6572  ces = np.argwher
-00039070: 6528 2864 6973 7420 3e20 696e 6469 6178  e((dist > indiax
-00039080: 6973 745b 695d 2920 2620 2864 6973 7420  ist[i]) & (dist 
-00039090: 3c3d 2069 6e64 6961 7869 7374 5b69 202b  <= indiaxist[i +
-000390a0: 2031 5d29 290a 2020 2020 2020 2020 2020   1])).          
-000390b0: 2020 2020 2020 2020 2020 6f64 6472 696e            oddrin
-000390c0: 6720 3d20 6d61 706f 6464 5f64 6174 615b  g = mapodd_data[
-000390d0: 7475 706c 6528 696e 6469 6365 732e 5429  tuple(indices.T)
-000390e0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-000390f0: 2020 2020 2020 6576 656e 7269 6e67 203d        evenring =
-00039100: 206d 6170 6576 656e 5f64 6174 615b 7475   mapeven_data[tu
-00039110: 706c 6528 696e 6469 6365 732e 5429 5d0a  ple(indices.T)].
+00038ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039000: 2020 2020 2020 2768 616c 6662 6974 273a        'halfbit':
+00039010: 207b 2778 273a 2074 7868 616c 6662 6974   {'x': txhalfbit
+00039020: 2c20 2779 273a 2074 7968 616c 6662 6974  , 'y': tyhalfbit
+00039030: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
+00039040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039050: 2020 2020 2020 2020 2027 6f6e 6562 6974           'onebit
+00039060: 273a 207b 2778 273a 2074 786f 6e65 6269  ': {'x': txonebi
+00039070: 742c 2027 7927 3a20 7479 6f6e 6562 6974  t, 'y': tyonebit
+00039080: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
+00039090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000390a0: 2020 2020 2020 2020 2027 302e 3527 3a20           '0.5': 
+000390b0: 7b27 7827 3a20 7478 6861 6c66 2c20 2779  {'x': txhalf, 'y
+000390c0: 273a 2074 7968 616c 667d 2c0a 2020 2020  ': tyhalf},.    
+000390d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000390e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000390f0: 2020 2730 2e33 3333 273a 207b 2778 273a    '0.333': {'x':
+00039100: 2074 786f 6e65 7468 7265 652c 2027 7927   txonethree, 'y'
+00039110: 3a20 7479 6f6e 6574 6872 6565 7d2c 0a20  : tyonethree},. 
 00039120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039130: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00039140: 2020 2020 2020 2020 2020 7061 7373 0a20            pass. 
-00039150: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00039160: 6f72 7220 3d20 286f 6464 7269 6e67 202a  orr = (oddring *
-00039170: 206e 702e 636f 6e6a 2865 7665 6e72 696e   np.conj(evenrin
-00039180: 6729 292e 7375 6d28 290a 2020 2020 2020  g)).sum().      
-00039190: 2020 2020 2020 2020 2020 636f 7272 5f64            corr_d
-000391a0: 656e 6f20 3d20 6e70 2e73 7172 7428 286e  eno = np.sqrt((n
-000391b0: 702e 6162 7328 6f64 6472 696e 6729 202a  p.abs(oddring) *
-000391c0: 2a20 3229 2e73 756d 2829 202a 2028 6e70  * 2).sum() * (np
-000391d0: 2e61 6273 2865 7665 6e72 696e 6729 202a  .abs(evenring) *
-000391e0: 2a20 3229 2e73 756d 2829 290a 2020 2020  * 2).sum()).    
-000391f0: 2020 2020 2020 2020 2020 2020 6966 2063              if c
-00039200: 6f72 725f 6465 6e6f 203d 3d20 302e 3a0a  orr_deno == 0.:.
-00039210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039220: 2020 2020 6e6f 7263 6f72 7220 3d20 302e      norcorr = 0.
-00039230: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00039240: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00039250: 2020 2020 2020 2020 2020 206e 6f72 636f             norco
-00039260: 7272 203d 206e 702e 7265 616c 2863 6f72  rr = np.real(cor
-00039270: 7220 2f20 636f 7272 5f64 656e 6f29 0a20  r / corr_deno). 
-00039280: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00039290: 6f72 726c 6973 742e 6170 7065 6e64 286e  orrlist.append(n
-000392a0: 6f72 636f 7272 290a 0a20 2020 2020 2020  orcorr)..       
-000392b0: 2020 2020 2020 2020 2076 6f6c 756d 6564           volumed
-000392c0: 6966 6620 3d20 2834 2e30 202f 2033 2e30  iff = (4.0 / 3.0
-000392d0: 2920 2a20 7069 202a 2028 2869 202b 2031  ) * pi * ((i + 1
-000392e0: 2920 2a2a 2033 202d 2069 202a 2a20 3329  ) ** 3 - i ** 3)
-000392f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00039300: 206e 766f 7872 696e 6720 3d20 766f 6c75   nvoxring = volu
-00039310: 6d65 6469 6666 202f 2028 3120 2a2a 2033  mediff / (1 ** 3
-00039320: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00039330: 2020 6566 666e 766f 7820 3d20 286e 766f    effnvox = (nvo
-00039340: 7872 696e 6720 2a20 2828 312e 3520 2a20  xring * ((1.5 * 
-00039350: 302e 3636 2920 2a2a 2032 2929 202f 2028  0.66) ** 2)) / (
-00039360: 3220 2a20 6173 796d 290a 2020 2020 2020  2 * asym).      
-00039370: 2020 2020 2020 2020 2020 6966 2065 6666            if eff
-00039380: 6e76 6f78 203c 2031 2e30 3a20 6566 666e  nvox < 1.0: effn
-00039390: 766f 7820 3d20 312e 300a 2020 2020 2020  vox = 1.0.      
-000393a0: 2020 2020 2020 2020 2020 7371 7265 6666            sqreff
-000393b0: 6e76 6f78 203d 206e 702e 7371 7274 2865  nvox = np.sqrt(e
-000393c0: 6666 6e76 6f78 290a 0a0a 2020 2020 2020  ffnvox)...      
-000393d0: 2020 2020 2020 2020 2020 2320 332d 7369            # 3-si
-000393e0: 676d 6120 6375 7276 650a 2020 2020 2020  gma curve.      
-000393f0: 2020 2020 2020 2020 2020 6966 2069 2021            if i !
-00039400: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
-00039410: 2020 2020 2020 2020 2073 6967 7661 6c75           sigvalu
-00039420: 6520 3d20 3320 2f20 2873 7172 6566 666e  e = 3 / (sqreffn
-00039430: 766f 7820 2b20 332e 3020 2d20 312e 3029  vox + 3.0 - 1.0)
-00039440: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00039450: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00039460: 2020 2020 2020 2020 2020 2073 6967 7661             sigva
-00039470: 6c75 6520 3d20 310a 2020 2020 2020 2020  lue = 1.        
-00039480: 2020 2020 2020 2020 7468 7265 6573 6967          threesig
-00039490: 2e61 7070 656e 6428 7369 6776 616c 7565  .append(sigvalue
-000394a0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-000394b0: 2020 2023 2048 616c 6620 6269 7420 6375     # Half bit cu
-000394c0: 7276 650a 2020 2020 2020 2020 2020 2020  rve.            
-000394d0: 2020 2020 6966 2069 2021 3d20 303a 0a20      if i != 0:. 
+00039130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039140: 2020 2020 2027 302e 3134 3327 3a20 7b27       '0.143': {'
+00039150: 7827 3a20 7478 676f 6c64 2c20 2779 273a  x': txgold, 'y':
+00039160: 2074 7967 6f6c 647d 7d7d 0a0a 2020 2020   tygold}}}..    
+00039170: 2020 2020 2020 2020 2020 2020 6669 6e61              fina
+00039180: 6c64 6963 745b 276c 6f61 645f 6673 6327  ldict['load_fsc'
+00039190: 5d20 3d20 6461 7461 6469 6374 0a0a 2020  ] = datadict..  
+000391a0: 2020 2020 2020 2020 2020 2020 2020 706c                pl
+000391b0: 742e 706c 6f74 2878 6c69 7374 2c20 796c  t.plot(xlist, yl
+000391c0: 6973 742c 206c 6162 656c 3d27 5072 6f76  ist, label='Prov
+000391d0: 6964 6564 2046 5343 2729 0a20 2020 2020  ided FSC').     
+000391e0: 2020 2020 2020 2020 2020 2023 706c 742e             #plt.
+000391f0: 706c 6f74 2869 6e64 6961 7869 732c 2074  plot(indiaxis, t
+00039200: 6872 6565 7369 672c 206c 6162 656c 3d27  hreesig, label='
+00039210: 3320 7369 676d 6127 290a 2020 2020 2020  3 sigma').      
+00039220: 2020 2020 2020 2020 2020 2370 6c74 2e70            #plt.p
+00039230: 6c6f 7428 696e 6469 6178 6973 2c20 6861  lot(indiaxis, ha
+00039240: 6c66 6269 742c 206c 6162 656c 3d27 312f  lfbit, label='1/
+00039250: 3220 6269 7427 290a 2020 2020 2020 2020  2 bit').        
+00039260: 2020 2020 2020 2020 2370 6c74 2e70 6c6f          #plt.plo
+00039270: 7428 696e 6469 6178 6973 2c20 6f6e 6562  t(indiaxis, oneb
+00039280: 6974 2c20 6c61 6265 6c3d 2731 2062 6974  it, label='1 bit
+00039290: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
+000392a0: 2020 2070 6c74 2e70 6c6f 7428 786c 6973     plt.plot(xlis
+000392b0: 745b 3a2d 315d 2c20 6c65 6e28 786c 6973  t[:-1], len(xlis
+000392c0: 745b 3a2d 315d 292a 5b30 2e35 5d2c 206c  t[:-1])*[0.5], l
+000392d0: 696e 6573 7479 6c65 3d27 3a27 2c20 6c61  inestyle=':', la
+000392e0: 6265 6c3d 275f 6e6f 6c65 6765 6e64 5f27  bel='_nolegend_'
+000392f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00039300: 2020 2370 6c74 2e70 6c6f 7428 696e 6469    #plt.plot(indi
+00039310: 6178 6973 2c20 672c 206c 6162 656c 3d27  axis, g, label='
+00039320: 302e 3333 3327 2c20 6c69 6e65 7374 796c  0.333', linestyl
+00039330: 653d 272d 2d27 290a 2020 2020 2020 2020  e='--').        
+00039340: 2020 2020 2020 2020 706c 742e 706c 6f74          plt.plot
+00039350: 2878 6c69 7374 5b3a 2d31 5d2c 206c 656e  (xlist[:-1], len
+00039360: 2878 6c69 7374 5b3a 2d31 5d29 2a5b 302e  (xlist[:-1])*[0.
+00039370: 3134 335d 2c20 6c69 6e65 7374 796c 653d  143], linestyle=
+00039380: 272d 2e27 2c20 6c61 6265 6c3d 275f 6e6f  '-.', label='_no
+00039390: 6c65 6765 6e64 5f27 290a 2020 2020 2020  legend_').      
+000393a0: 2020 2020 2020 2020 2020 706c 742e 6c65            plt.le
+000393b0: 6765 6e64 2829 0a20 2020 2020 2020 2020  gend().         
+000393c0: 2020 2020 2020 2070 6c74 2e73 6176 6566         plt.savef
+000393d0: 6967 2873 656c 662e 776f 726b 6469 7220  ig(self.workdir 
+000393e0: 2b20 7365 6c66 2e6d 6170 6e61 6d65 202b  + self.mapname +
+000393f0: 2027 5f66 7363 2e70 6e67 2729 0a20 2020   '_fsc.png').   
+00039400: 2020 2020 2020 2020 2020 2020 2070 6c74               plt
+00039410: 2e63 6c6f 7365 2829 0a20 2020 2020 2020  .close().       
+00039420: 2020 2020 2065 7863 6570 743a 0a20 2020       except:.   
+00039430: 2020 2020 2020 2020 2020 2020 2065 7272               err
+00039440: 203d 2027 4653 4320 7265 6164 696e 6720   = 'FSC reading 
+00039450: 6572 726f 723a 207b 7d2e 272e 666f 726d  error: {}.'.form
+00039460: 6174 2873 7973 2e65 7863 5f69 6e66 6f28  at(sys.exc_info(
+00039470: 295b 315d 290a 2020 2020 2020 2020 2020  )[1]).          
+00039480: 2020 2020 2020 6572 726c 6973 742e 6170        errlist.ap
+00039490: 7065 6e64 2865 7272 290a 2020 2020 2020  pend(err).      
+000394a0: 2020 2020 2020 2020 2020 7379 732e 7374            sys.st
+000394b0: 6465 7272 2e77 7269 7465 2865 7272 202b  derr.write(err +
+000394c0: 2027 5c6e 2729 0a0a 2020 2020 2020 2020   '\n')..        
+000394d0: 2020 2020 6966 2065 7272 6c69 7374 3a0a      if errlist:.
 000394e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000394f0: 2020 2062 6974 7661 6c75 6520 3d20 2830     bitvalue = (0
-00039500: 2e32 3037 3120 2b20 312e 3931 3032 202f  .2071 + 1.9102 /
-00039510: 2073 7172 6566 666e 766f 7829 202f 2028   sqreffnvox) / (
-00039520: 312e 3230 3731 202b 2030 2e39 3130 3220  1.2071 + 0.9102 
-00039530: 2f20 7371 7265 6666 6e76 6f78 290a 2020  / sqreffnvox).  
-00039540: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00039550: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00039560: 2020 2020 2020 2020 6269 7476 616c 7565          bitvalue
-00039570: 203d 2031 0a20 2020 2020 2020 2020 2020   = 1.           
-00039580: 2020 2020 2068 616c 6662 6974 2e61 7070       halfbit.app
-00039590: 656e 6428 6269 7476 616c 7565 290a 0a20  end(bitvalue).. 
-000395a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000395b0: 6620 6920 213d 2030 3a0a 2020 2020 2020  f i != 0:.      
-000395c0: 2020 2020 2020 2020 2020 2020 2020 6f6e                on
-000395d0: 6562 6974 7661 6c75 6520 3d20 2830 2e35  ebitvalue = (0.5
-000395e0: 202b 2032 2e34 3134 3220 2f20 7371 7265   + 2.4142 / sqre
-000395f0: 6666 6e76 6f78 2920 2f20 2831 2e35 202b  ffnvox) / (1.5 +
-00039600: 2031 2e34 3134 3220 2f20 7371 7265 6666   1.4142 / sqreff
-00039610: 6e76 6f78 290a 2020 2020 2020 2020 2020  nvox).          
-00039620: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00039630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039640: 6f6e 6562 6974 7661 6c75 6520 3d20 310a  onebitvalue = 1.
-00039650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039660: 6f6e 6562 6974 2e61 7070 656e 6428 6f6e  onebit.append(on
-00039670: 6562 6974 7661 6c75 6529 0a20 2020 2020  ebitvalue).     
-00039680: 2020 2020 2020 2070 7269 6e74 2863 6f72         print(cor
-00039690: 726c 6973 7429 0a0a 2020 2020 2020 2020  rlist)..        
-000396a0: 2020 2020 6966 2063 6f72 726c 6973 745b      if corrlist[
-000396b0: 305d 203c 3d20 303a 0a20 2020 2020 2020  0] <= 0:.       
-000396c0: 2020 2020 2020 2020 2063 6f72 726c 6973           corrlis
-000396d0: 745b 305d 203d 2031 0a20 2020 2020 2020  t[0] = 1.       
-000396e0: 2020 2020 2061 203d 206e 702e 6173 6172       a = np.asar
-000396f0: 7261 7928 696e 6469 6178 6973 290a 2020  ray(indiaxis).  
-00039700: 2020 2020 2020 2020 2020 6220 3d20 6e70            b = np
-00039710: 2e61 7361 7272 6179 2863 6f72 726c 6973  .asarray(corrlis
-00039720: 7429 0a20 2020 2020 2020 2020 2020 2063  t).            c
-00039730: 203d 206e 702e 6173 6172 7261 7928 7468   = np.asarray(th
-00039740: 7265 6573 6967 290a 2020 2020 2020 2020  reesig).        
-00039750: 2020 2020 6420 3d20 6e70 2e61 7361 7272      d = np.asarr
-00039760: 6179 2868 616c 6662 6974 290a 2020 2020  ay(halfbit).    
-00039770: 2020 2020 2020 2020 6520 3d20 6e70 2e61          e = np.a
-00039780: 7361 7272 6179 286f 6e65 6269 7429 0a20  sarray(onebit). 
-00039790: 2020 2020 2020 2020 2020 2066 203d 206e             f = n
-000397a0: 702e 6675 6c6c 2828 6c65 6e28 696e 6469  p.full((len(indi
-000397b0: 6178 6973 2929 2c20 302e 3529 0a20 2020  axis)), 0.5).   
-000397c0: 2020 2020 2020 2020 2067 203d 206e 702e           g = np.
-000397d0: 6675 6c6c 2828 6c65 6e28 696e 6469 6178  full((len(indiax
-000397e0: 6973 2929 2c20 302e 3333 3329 0a20 2020  is)), 0.333).   
-000397f0: 2020 2020 2020 2020 2068 203d 206e 702e           h = np.
-00039800: 6675 6c6c 2828 6c65 6e28 696e 6469 6178  full((len(indiax
-00039810: 6973 2929 2c20 302e 3134 3329 0a20 2020  is)), 0.143).   
-00039820: 2020 2020 2020 2020 2023 2075 7365 205b           # use [
-00039830: 3a31 5d20 746f 2069 676e 6f72 6520 616c  :1] to ignore al
-00039840: 6c20 7468 6520 6375 7276 6573 2073 7461  l the curves sta
-00039850: 7274 2066 726f 6d20 302c 310a 2020 2020  rt from 0,1.    
-00039860: 2020 2020 2020 2020 7874 6872 6565 7369          xthreesi
-00039870: 672c 2079 7468 7265 6573 6967 203d 2073  g, ythreesig = s
-00039880: 656c 662e 5f5f 696e 7465 7270 6f6c 6174  elf.__interpolat
-00039890: 6564 5f69 6e74 6572 6365 7074 2861 2c20  ed_intercept(a, 
-000398a0: 622c 2063 290a 2020 2020 2020 2020 2020  b, c).          
-000398b0: 2020 7868 616c 6662 6974 2c20 7968 616c    xhalfbit, yhal
-000398c0: 6662 6974 203d 2073 656c 662e 5f5f 696e  fbit = self.__in
-000398d0: 7465 7270 6f6c 6174 6564 5f69 6e74 6572  terpolated_inter
-000398e0: 6365 7074 2861 2c20 622c 2064 290a 2020  cept(a, b, d).  
-000398f0: 2020 2020 2020 2020 2020 786f 6e65 6269            xonebi
-00039900: 742c 2079 6f6e 6562 6974 203d 2073 656c  t, yonebit = sel
-00039910: 662e 5f5f 696e 7465 7270 6f6c 6174 6564  f.__interpolated
-00039920: 5f69 6e74 6572 6365 7074 2861 2c20 622c  _intercept(a, b,
-00039930: 2065 290a 2020 2020 2020 2020 2020 2020   e).            
-00039940: 7868 616c 662c 2079 6861 6c66 203d 2073  xhalf, yhalf = s
-00039950: 656c 662e 5f5f 696e 7465 7270 6f6c 6174  elf.__interpolat
-00039960: 6564 5f69 6e74 6572 6365 7074 2861 2c20  ed_intercept(a, 
-00039970: 622c 2066 290a 0a20 2020 2020 2020 2020  b, f)..         
-00039980: 2020 2023 2043 6865 636b 2069 6620 6d6d     # Check if mm
-00039990: 2069 6e20 6c61 6265 6c20 7468 656e 2c20   in label then, 
-000399a0: 7365 6520 7768 6963 6820 696e 7465 7273  see which inters
-000399b0: 6563 696f 6e20 6973 2074 6865 206d 6f73  ecion is the mos
-000399c0: 7420 636c 6f73 6573 7420 746f 2074 6865  t closest to the
-000399d0: 2067 6976 656e 2072 6573 6f6c 7574 696f   given resolutio
-000399e0: 6e28 546f 646f 290a 2020 2020 2020 2020  n(Todo).        
-000399f0: 2020 2020 6966 2027 6d6d 2720 696e 206c      if 'mm' in l
-00039a00: 6162 656c 3a0a 2020 2020 2020 2020 2020  abel:.          
-00039a10: 2020 2020 2020 6966 2078 6861 6c66 2e73        if xhalf.s
-00039a20: 697a 6520 213d 2030 3a0a 2020 2020 2020  ize != 0:.      
-00039a30: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
-00039a40: 7778 6861 6c66 203d 2061 6273 2878 6861  wxhalf = abs(xha
-00039a50: 6c66 202d 2031 202f 2066 6c6f 6174 2873  lf - 1 / float(s
-00039a60: 656c 662e 7265 736f 6c75 7469 6f6e 2929  elf.resolution))
-00039a70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00039a80: 2020 2020 2069 6e64 6d69 6e20 3d20 6e70       indmin = np
-00039a90: 2e61 7267 6d69 6e28 6e65 7778 6861 6c66  .argmin(newxhalf
-00039aa0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00039ab0: 2020 2020 2020 7868 616c 6620 3d20 6e70        xhalf = np
-00039ac0: 2e61 7272 6179 285b 7868 616c 665b 696e  .array([xhalf[in
-00039ad0: 646d 696e 5d5d 290a 2020 2020 2020 2020  dmin]]).        
-00039ae0: 2020 2020 2020 2020 2020 2020 7968 616c              yhal
-00039af0: 6620 3d20 6e70 2e61 7272 6179 285b 7968  f = np.array([yh
-00039b00: 616c 665b 696e 646d 696e 5d5d 290a 0a20  alf[indmin]]).. 
-00039b10: 2020 2020 2020 2020 2020 2078 6f6e 6574             xonet
-00039b20: 6872 6565 2c20 796f 6e65 7468 7265 6520  hree, yonethree 
-00039b30: 3d20 7365 6c66 2e5f 5f69 6e74 6572 706f  = self.__interpo
-00039b40: 6c61 7465 645f 696e 7465 7263 6570 7428  lated_intercept(
-00039b50: 612c 2062 2c20 6729 0a20 2020 2020 2020  a, b, g).       
-00039b60: 2020 2020 2078 676f 6c64 2c20 7967 6f6c       xgold, ygol
-00039b70: 6420 3d20 7365 6c66 2e5f 5f69 6e74 6572  d = self.__inter
-00039b80: 706f 6c61 7465 645f 696e 7465 7263 6570  polated_intercep
-00039b90: 7428 612c 2062 2c20 6829 0a0a 2020 2020  t(a, b, h)..    
-00039ba0: 2020 2020 2020 2020 2320 4173 7369 676e          # Assign
-00039bb0: 2069 6e74 6572 7365 6374 696f 6e20 7661   intersection va
-00039bc0: 6c75 6520 6173 204e 6f6e 6520 7768 656e  lue as None when
-00039bd0: 2074 6865 7265 2069 7320 6e6f 2069 6e74   there is no int
-00039be0: 6572 7365 6374 696f 6e0a 2020 2020 2020  ersection.      
-00039bf0: 2020 2020 2020 6966 2078 7468 7265 6573        if xthrees
-00039c00: 6967 2e73 697a 6520 3d3d 2030 2061 6e64  ig.size == 0 and
-00039c10: 2079 7468 7265 6573 6967 2e73 697a 6520   ythreesig.size 
-00039c20: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
-00039c30: 2020 2020 2020 7072 696e 7428 274e 6f20        print('No 
-00039c40: 696e 7465 7273 6563 7469 6f6e 2062 6574  intersection bet
-00039c50: 7765 656e 2046 5343 2061 6e64 2033 2d73  ween FSC and 3-s
-00039c60: 6967 6d61 2063 7572 7665 732e 2048 6572  igma curves. Her
-00039c70: 6520 7573 6520 7468 6520 6c61 7374 2070  e use the last p
-00039c80: 6f69 6e74 2e27 290a 2020 2020 2020 2020  oint.').        
-00039c90: 2020 2020 2020 2020 7874 6872 6565 7369          xthreesi
-00039ca0: 672c 2079 7468 7265 6573 6967 203d 204e  g, ythreesig = N
-00039cb0: 6f6e 652c 204e 6f6e 650a 2020 2020 2020  one, None.      
-00039cc0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00039cd0: 2020 2020 2020 2020 2020 2020 7874 6872              xthr
-00039ce0: 6565 7369 6720 3d20 6e70 2e72 6f75 6e64  eesig = np.round
-00039cf0: 2878 7468 7265 6573 6967 5b30 5d5b 305d  (xthreesig[0][0]
-00039d00: 2c20 3429 0a20 2020 2020 2020 2020 2020  , 4).           
-00039d10: 2020 2020 2079 7468 7265 6573 6967 203d       ythreesig =
-00039d20: 206e 702e 726f 756e 6428 7974 6872 6565   np.round(ythree
-00039d30: 7369 675b 305d 5b30 5d2c 2034 290a 0a20  sig[0][0], 4).. 
-00039d40: 2020 2020 2020 2020 2020 2069 6620 7868             if xh
-00039d50: 616c 6662 6974 2e73 697a 6520 3d3d 2030  alfbit.size == 0
-00039d60: 2061 6e64 2079 6861 6c66 6269 742e 7369   and yhalfbit.si
-00039d70: 7a65 203d 3d20 303a 0a20 2020 2020 2020  ze == 0:.       
-00039d80: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
-00039d90: 4e6f 2069 6e74 6572 7365 6374 696f 6e20  No intersection 
-00039da0: 6265 7477 6565 6e20 4653 4320 616e 6420  between FSC and 
-00039db0: 312f 322d 6269 7420 6375 7276 6573 2e20  1/2-bit curves. 
-00039dc0: 4865 7265 2075 7365 2074 6865 206c 6173  Here use the las
-00039dd0: 7420 706f 696e 742e 2729 0a20 2020 2020  t point.').     
-00039de0: 2020 2020 2020 2020 2020 2078 6861 6c66             xhalf
-00039df0: 6269 742c 2079 6861 6c66 6269 7420 3d20  bit, yhalfbit = 
-00039e00: 4e6f 6e65 2c20 4e6f 6e65 0a20 2020 2020  None, None.     
-00039e10: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00039e20: 2020 2020 2020 2020 2020 2020 2078 6861               xha
-00039e30: 6c66 6269 7420 3d20 6e70 2e72 6f75 6e64  lfbit = np.round
-00039e40: 2878 6861 6c66 6269 745b 305d 5b30 5d2c  (xhalfbit[0][0],
-00039e50: 2034 290a 2020 2020 2020 2020 2020 2020   4).            
-00039e60: 2020 2020 7968 616c 6662 6974 203d 206e      yhalfbit = n
-00039e70: 702e 726f 756e 6428 7968 616c 6662 6974  p.round(yhalfbit
-00039e80: 5b30 5d5b 305d 2c20 3429 0a0a 2020 2020  [0][0], 4)..    
-00039e90: 2020 2020 2020 2020 6966 2078 6f6e 6562          if xoneb
-00039ea0: 6974 2e73 697a 6520 3d3d 2030 2061 6e64  it.size == 0 and
-00039eb0: 2079 6f6e 6562 6974 2e73 697a 6520 3d3d   yonebit.size ==
-00039ec0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-00039ed0: 2020 2020 7072 696e 7428 274e 6f20 696e      print('No in
-00039ee0: 7465 7273 6563 7469 6f6e 2062 6574 7765  tersection betwe
-00039ef0: 656e 2046 5343 2061 6e64 2031 2d62 6974  en FSC and 1-bit
-00039f00: 2063 7572 7665 732e 2048 6572 6520 7573   curves. Here us
-00039f10: 6520 7468 6520 6c61 7374 2070 6f69 6e74  e the last point
-00039f20: 2e27 290a 2020 2020 2020 2020 2020 2020  .').            
-00039f30: 2020 2020 786f 6e65 6269 742c 2079 6f6e      xonebit, yon
-00039f40: 6562 6974 203d 204e 6f6e 652c 204e 6f6e  ebit = None, Non
-00039f50: 650a 2020 2020 2020 2020 2020 2020 656c  e.            el
-00039f60: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00039f70: 2020 2020 786f 6e65 6269 7420 3d20 6e70      xonebit = np
-00039f80: 2e72 6f75 6e64 2878 6f6e 6562 6974 5b30  .round(xonebit[0
-00039f90: 5d5b 305d 2c20 3429 0a20 2020 2020 2020  ][0], 4).       
-00039fa0: 2020 2020 2020 2020 2079 6f6e 6562 6974           yonebit
-00039fb0: 203d 206e 702e 726f 756e 6428 796f 6e65   = np.round(yone
-00039fc0: 6269 745b 305d 5b30 5d2c 2034 290a 0a20  bit[0][0], 4).. 
-00039fd0: 2020 2020 2020 2020 2020 2069 6620 786f             if xo
-00039fe0: 6e65 7468 7265 652e 7369 7a65 203d 3d20  nethree.size == 
-00039ff0: 3020 616e 6420 796f 6e65 7468 7265 652e  0 and yonethree.
-0003a000: 7369 7a65 203d 3d20 303a 0a20 2020 2020  size == 0:.     
-0003a010: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-0003a020: 2827 4e6f 2069 6e74 6572 7365 6374 696f  ('No intersectio
-0003a030: 6e20 6265 7477 6565 6e20 4653 4320 616e  n between FSC an
-0003a040: 6420 302e 3333 3320 6375 7276 6573 2e20  d 0.333 curves. 
-0003a050: 4865 7265 2075 7365 2074 6865 206c 6173  Here use the las
-0003a060: 7420 706f 696e 7427 290a 2020 2020 2020  t point').      
-0003a070: 2020 2020 2020 2020 2020 786f 6e65 7468            xoneth
-0003a080: 7265 652c 2079 6f6e 6574 6872 6565 203d  ree, yonethree =
-0003a090: 204e 6f6e 652c 204e 6f6e 650a 2020 2020   None, None.    
-0003a0a0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0003a0b0: 2020 2020 2020 2020 2020 2020 2020 786f                xo
-0003a0c0: 6e65 7468 7265 6520 3d20 6e70 2e72 6f75  nethree = np.rou
-0003a0d0: 6e64 2878 6f6e 6574 6872 6565 5b30 5d5b  nd(xonethree[0][
-0003a0e0: 305d 2c20 3429 0a20 2020 2020 2020 2020  0], 4).         
-0003a0f0: 2020 2020 2020 2079 6f6e 6574 6872 6565         yonethree
-0003a100: 203d 206e 702e 726f 756e 6428 796f 6e65   = np.round(yone
-0003a110: 7468 7265 655b 305d 5b30 5d2c 2034 290a  three[0][0], 4).
-0003a120: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0003a130: 7868 616c 662e 7369 7a65 203d 3d20 3020  xhalf.size == 0 
-0003a140: 616e 6420 7968 616c 662e 7369 7a65 203d  and yhalf.size =
-0003a150: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
-0003a160: 2020 2020 2070 7269 6e74 2827 2121 2120       print('!!! 
-0003a170: 4e6f 2069 6e74 6572 7365 6374 696f 6e20  No intersection 
-0003a180: 6265 7477 6565 6e20 4653 4320 616e 6420  between FSC and 
-0003a190: 302e 3520 6375 7276 6573 2e20 4865 7265  0.5 curves. Here
-0003a1a0: 2075 7365 2074 6865 206c 6173 7420 706f   use the last po
-0003a1b0: 696e 7427 290a 2020 2020 2020 2020 2020  int').          
-0003a1c0: 2020 2020 2020 7868 616c 662c 2079 6861        xhalf, yha
-0003a1d0: 6c66 203d 204e 6f6e 652c 204e 6f6e 650a  lf = None, None.
-0003a1e0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0003a1f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003a200: 2020 7868 616c 6620 3d20 6e70 2e72 6f75    xhalf = np.rou
-0003a210: 6e64 2878 6861 6c66 5b30 5d5b 305d 2c20  nd(xhalf[0][0], 
-0003a220: 3429 0a20 2020 2020 2020 2020 2020 2020  4).             
-0003a230: 2020 2079 6861 6c66 203d 206e 702e 726f     yhalf = np.ro
-0003a240: 756e 6428 7968 616c 665b 305d 5b30 5d2c  und(yhalf[0][0],
-0003a250: 2034 290a 2020 2020 2020 2020 2020 2020   4).            
-0003a260: 6966 2078 676f 6c64 2e73 697a 6520 3d3d  if xgold.size ==
-0003a270: 2030 2061 6e64 2079 676f 6c64 2e73 697a   0 and ygold.siz
-0003a280: 6520 3d3d 2030 3a0a 2020 2020 2020 2020  e == 0:.        
-0003a290: 2020 2020 2020 2020 7072 696e 7428 2721          print('!
-0003a2a0: 2121 204e 6f20 696e 7465 7273 6563 7469  !! No intersecti
-0003a2b0: 6f6e 2062 6574 7765 656e 2046 5343 2061  on between FSC a
-0003a2c0: 6e64 2030 2e31 3433 2063 7572 7665 732e  nd 0.143 curves.
-0003a2d0: 2048 6572 6520 7573 6520 7468 6520 6c61   Here use the la
-0003a2e0: 7374 2070 6f69 6e74 2729 0a20 2020 2020  st point').     
-0003a2f0: 2020 2020 2020 2020 2020 2078 676f 6c64             xgold
-0003a300: 2c20 7967 6f6c 6420 3d20 4e6f 6e65 2c20  , ygold = None, 
-0003a310: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-0003a320: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0003a330: 2020 2020 2020 2078 676f 6c64 203d 206e         xgold = n
-0003a340: 702e 726f 756e 6428 7867 6f6c 645b 305d  p.round(xgold[0]
-0003a350: 5b30 5d2c 2034 290a 2020 2020 2020 2020  [0], 4).        
-0003a360: 2020 2020 2020 2020 7967 6f6c 6420 3d20          ygold = 
-0003a370: 6e70 2e72 6f75 6e64 2879 676f 6c64 5b30  np.round(ygold[0
-0003a380: 5d5b 305d 2c20 3429 0a0a 0a20 2020 2020  ][0], 4)...     
-0003a390: 2020 2020 2020 2064 6174 6164 6963 7420         datadict 
-0003a3a0: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
-0003a3b0: 2020 2020 2763 7572 7665 7327 3a20 7b27      'curves': {'
-0003a3c0: 6673 6327 3a20 6e70 2e72 6f75 6e64 286e  fsc': np.round(n
-0003a3d0: 702e 7265 616c 2863 6f72 726c 6973 7429  p.real(corrlist)
-0003a3e0: 2c20 3429 2e74 6f6c 6973 7428 292c 2027  , 4).tolist(), '
-0003a3f0: 7468 7265 6573 6967 6d61 273a 206e 702e  threesigma': np.
-0003a400: 726f 756e 6428 7468 7265 6573 6967 2c20  round(threesig, 
-0003a410: 3429 2e74 6f6c 6973 7428 292c 0a20 2020  4).tolist(),.   
-0003a420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a430: 2020 2020 2020 2020 2768 616c 6662 6974          'halfbit
-0003a440: 273a 206e 702e 726f 756e 6428 6861 6c66  ': np.round(half
-0003a450: 6269 742c 2034 292e 746f 6c69 7374 2829  bit, 4).tolist()
-0003a460: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0003a470: 2020 2020 2020 2020 2020 2020 2027 6f6e               'on
-0003a480: 6562 6974 273a 206e 702e 726f 756e 6428  ebit': np.round(
-0003a490: 6f6e 6562 6974 2c20 3429 2e74 6f6c 6973  onebit, 4).tolis
-0003a4a0: 7428 292c 2027 302e 3527 3a20 662e 746f  t(), '0.5': f.to
-0003a4b0: 6c69 7374 2829 2c20 2730 2e33 3333 273a  list(), '0.333':
-0003a4c0: 2067 2e74 6f6c 6973 7428 292c 0a20 2020   g.tolist(),.   
-0003a4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a4e0: 2020 2020 2020 2020 2730 2e31 3433 273a          '0.143':
-0003a4f0: 2068 2e74 6f6c 6973 7428 292c 0a20 2020   h.tolist(),.   
-0003a500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a510: 2020 2020 2020 2020 276c 6576 656c 273a          'level':
-0003a520: 206e 702e 726f 756e 6428 696e 6469 6178   np.round(indiax
-0003a530: 6973 2c20 3429 2e74 6f6c 6973 7428 297d  is, 4).tolist()}
-0003a540: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0003a550: 2020 2769 6e74 6572 7365 6374 696f 6e73    'intersections
-0003a560: 273a 207b 2774 6872 6565 7369 6727 3a20  ': {'threesig': 
-0003a570: 7b27 7827 3a20 7874 6872 6565 7369 672c  {'x': xthreesig,
-0003a580: 2027 7927 3a20 7974 6872 6565 7369 677d   'y': ythreesig}
-0003a590: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0003a5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a5b0: 2020 2020 2768 616c 6662 6974 273a 207b      'halfbit': {
-0003a5c0: 2778 273a 2078 6861 6c66 6269 742c 2027  'x': xhalfbit, '
-0003a5d0: 7927 3a20 7968 616c 6662 6974 7d2c 0a20  y': yhalfbit},. 
-0003a5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a600: 2027 6f6e 6562 6974 273a 207b 2778 273a   'onebit': {'x':
-0003a610: 2078 6f6e 6562 6974 2c20 2779 273a 2079   xonebit, 'y': y
-0003a620: 6f6e 6562 6974 7d2c 0a20 2020 2020 2020  onebit},.       
-0003a630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a640: 2020 2020 2020 2020 2020 2027 302e 3527             '0.5'
-0003a650: 3a20 7b27 7827 3a20 7868 616c 662c 2027  : {'x': xhalf, '
-0003a660: 7927 3a20 7968 616c 667d 2c0a 2020 2020  y': yhalf},.    
-0003a670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a680: 2020 2020 2020 2020 2020 2020 2020 2730                '0
-0003a690: 2e33 3333 273a 207b 2778 273a 2078 6f6e  .333': {'x': xon
-0003a6a0: 6574 6872 6565 2c20 2779 273a 2079 6f6e  ethree, 'y': yon
-0003a6b0: 6574 6872 6565 7d2c 0a20 2020 2020 2020  ethree},.       
-0003a6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003a6d0: 2020 2020 2020 2020 2020 2027 302e 3134             '0.14
-0003a6e0: 3327 3a20 7b27 7827 3a20 7867 6f6c 642c  3': {'x': xgold,
-0003a6f0: 2027 7927 3a20 7967 6f6c 647d 7d7d 0a20   'y': ygold}}}. 
-0003a700: 2020 2020 2020 2020 2020 2066 696e 616c             final
-0003a710: 6469 6374 203d 2064 6963 7428 290a 2020  dict = dict().  
-0003a720: 2020 2020 2020 2020 2020 6669 6e61 6c64            finald
-0003a730: 6963 745b 6c61 6265 6c20 2b20 2766 7363  ict[label + 'fsc
-0003a740: 275d 203d 2064 6174 6164 6963 740a 0a20  '] = datadict.. 
-0003a750: 2020 2020 2020 2020 2020 2070 6c74 2e70             plt.p
-0003a760: 6c6f 7428 696e 6469 6178 6973 2c20 636f  lot(indiaxis, co
-0003a770: 7272 6c69 7374 2c20 6c61 6265 6c3d 6c61  rrlist, label=la
-0003a780: 6265 6c20 2b20 2746 5343 2729 0a20 2020  bel + 'FSC').   
-0003a790: 2020 2020 2020 2020 2023 2070 6c74 2e70           # plt.p
-0003a7a0: 6c6f 7428 696e 6469 6178 6973 2c20 7468  lot(indiaxis, th
-0003a7b0: 7265 6573 6967 2c20 6c61 6265 6c3d 2733  reesig, label='3
-0003a7c0: 2073 6967 6d61 2729 0a20 2020 2020 2020   sigma').       
-0003a7d0: 2020 2020 2070 6c74 2e70 6c6f 7428 696e       plt.plot(in
-0003a7e0: 6469 6178 6973 2c20 6861 6c66 6269 742c  diaxis, halfbit,
-0003a7f0: 206c 6162 656c 3d27 312f 3220 6269 7427   label='1/2 bit'
-0003a800: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
-0003a810: 706c 742e 706c 6f74 2869 6e64 6961 7869  plt.plot(indiaxi
-0003a820: 732c 206f 6e65 6269 742c 206c 6162 656c  s, onebit, label
-0003a830: 3d27 3120 6269 7427 290a 2020 2020 2020  ='1 bit').      
-0003a840: 2020 2020 2020 706c 742e 706c 6f74 2869        plt.plot(i
-0003a850: 6e64 6961 7869 732c 2066 2c20 6c61 6265  ndiaxis, f, labe
-0003a860: 6c3d 2730 2e35 272c 206c 696e 6573 7479  l='0.5', linesty
-0003a870: 6c65 3d27 3a27 290a 2020 2020 2020 2020  le=':').        
-0003a880: 2020 2020 2320 706c 742e 706c 6f74 2869      # plt.plot(i
-0003a890: 6e64 6961 7869 732c 2067 2c20 6c61 6265  ndiaxis, g, labe
-0003a8a0: 6c3d 2730 2e33 3333 272c 206c 696e 6573  l='0.333', lines
-0003a8b0: 7479 6c65 3d27 2d2d 2729 0a20 2020 2020  tyle='--').     
-0003a8c0: 2020 2020 2020 2070 6c74 2e70 6c6f 7428         plt.plot(
-0003a8d0: 696e 6469 6178 6973 2c20 682c 206c 6162  indiaxis, h, lab
-0003a8e0: 656c 3d27 302e 3134 3327 2c20 6c69 6e65  el='0.143', line
-0003a8f0: 7374 796c 653d 272d 2e27 290a 2020 2020  style='-.').    
-0003a900: 2020 2020 2020 2020 706c 742e 6c65 6765          plt.lege
-0003a910: 6e64 2829 0a20 2020 2020 2020 2020 2020  nd().           
-0003a920: 2069 6620 6c61 6265 6c3a 0a20 2020 2020   if label:.     
-0003a930: 2020 2020 2020 2020 2020 2070 6c74 2e73             plt.s
-0003a940: 6176 6566 6967 2873 656c 662e 776f 726b  avefig(self.work
-0003a950: 6469 7220 2b20 7365 6c66 2e6d 6170 6e61  dir + self.mapna
-0003a960: 6d65 202b 2027 5f27 202b 206c 6162 656c  me + '_' + label
-0003a970: 202b 2027 5f66 7363 2e70 6e67 2729 0a20   + '_fsc.png'). 
-0003a980: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0003a990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003a9a0: 2070 6c74 2e73 6176 6566 6967 2873 656c   plt.savefig(sel
-0003a9b0: 662e 776f 726b 6469 7220 2b20 7365 6c66  f.workdir + self
-0003a9c0: 2e6d 6170 6e61 6d65 202b 2027 5f66 7363  .mapname + '_fsc
-0003a9d0: 2e70 6e67 2729 0a20 2020 2020 2020 2020  .png').         
-0003a9e0: 2020 2070 6c74 2e63 6c6f 7365 2829 0a0a     plt.close()..
-0003a9f0: 2020 2020 2020 2020 6578 6365 7074 3a0a          except:.
-0003aa00: 2020 2020 2020 2020 2020 2020 6572 7220              err 
-0003aa10: 3d20 2746 5343 2063 616c 6375 6c61 7469  = 'FSC calculati
-0003aa20: 6f6e 2065 7272 6f72 3a20 7b7d 272e 666f  on error: {}'.fo
-0003aa30: 726d 6174 2873 7973 2e65 7863 5f69 6e66  rmat(sys.exc_inf
-0003aa40: 6f28 295b 315d 290a 2020 2020 2020 2020  o()[1]).        
-0003aa50: 2020 2020 6572 726c 6973 742e 6170 7065      errlist.appe
-0003aa60: 6e64 2865 7272 290a 2020 2020 2020 2020  nd(err).        
-0003aa70: 2020 2020 7379 732e 7374 6465 7272 2e77      sys.stderr.w
-0003aa80: 7269 7465 2865 7272 202b 2027 5c6e 2729  rite(err + '\n')
-0003aa90: 0a0a 2020 2020 2020 2020 6966 2065 7272  ..        if err
-0003aaa0: 6c69 7374 3a0a 2020 2020 2020 2020 2020  list:.          
-0003aab0: 2020 6461 7461 6469 6374 203d 207b 2765    datadict = {'e
-0003aac0: 7272 273a 207b 6c61 6265 6c20 2b20 2766  rr': {label + 'f
-0003aad0: 7363 5f65 7272 6f72 273a 2065 7272 6c69  sc_error': errli
-0003aae0: 7374 7d7d 0a20 2020 2020 2020 2020 2020  st}}.           
-0003aaf0: 2066 696e 616c 6469 6374 5b6c 6162 656c   finaldict[label
-0003ab00: 202b 2027 6673 6327 5d20 3d20 6461 7461   + 'fsc'] = data
-0003ab10: 6469 6374 0a20 2020 2020 2020 2065 6c73  dict.        els
-0003ab20: 653a 0a20 2020 2020 2020 2020 2020 2070  e:.            p
-0003ab30: 7269 6e74 2827 4e6f 2065 7272 6f72 2069  rint('No error i
-0003ab40: 6e20 4653 4320 6361 6c63 756c 6174 696f  n FSC calculatio
-0003ab50: 6e2e 2729 0a0a 2020 2020 2020 2020 6966  n.')..        if
-0003ab60: 2062 6f6f 6c28 6461 7461 6469 6374 2920   bool(datadict) 
-0003ab70: 616e 6420 626f 6f6c 2866 696e 616c 6469  and bool(finaldi
-0003ab80: 6374 293a 0a20 2020 2020 2020 2020 2020  ct):.           
-0003ab90: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-0003aba0: 2020 2020 2020 7769 7468 2063 6f64 6563        with codec
-0003abb0: 732e 6f70 656e 2873 656c 662e 776f 726b  s.open(self.work
-0003abc0: 6469 7220 2b20 7365 6c66 2e6d 6170 6e61  dir + self.mapna
-0003abd0: 6d65 202b 2027 5f27 202b 206c 6162 656c  me + '_' + label
-0003abe0: 202b 2027 6673 632e 6a73 6f6e 272c 2027   + 'fsc.json', '
-0003abf0: 7727 2c20 656e 636f 6469 6e67 3d27 7574  w', encoding='ut
-0003ac00: 662d 3827 2920 6173 2066 3a0a 2020 2020  f-8') as f:.    
-0003ac10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ac20: 6a73 6f6e 2e64 756d 7028 6669 6e61 6c64  json.dump(finald
-0003ac30: 6963 742c 2066 290a 2020 2020 2020 2020  ict, f).        
-0003ac40: 2020 2020 2020 2020 7072 696e 7428 2746          print('F
-0003ac50: 5343 2070 726f 6475 6365 6420 6279 2074  SC produced by t
-0003ac60: 776f 2068 616c 6620 6d61 7073 2e27 290a  wo half maps.').
-0003ac70: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-0003ac80: 7074 3a0a 2020 2020 2020 2020 2020 2020  pt:.            
-0003ac90: 2020 2020 7379 732e 7374 6465 7272 2e77      sys.stderr.w
-0003aca0: 7269 7465 2827 5772 6974 696e 6720 4653  rite('Writing FS
-0003acb0: 4320 6461 7461 2074 6f20 6a73 6f6e 2066  C data to json f
-0003acc0: 696c 6520 6572 726f 723a 207b 7d2e 272e  ile error: {}.'.
-0003acd0: 666f 726d 6174 2873 7973 2e65 7863 5f69  format(sys.exc_i
-0003ace0: 6e66 6f28 295b 315d 2929 0a20 2020 2020  nfo()[1])).     
-0003acf0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0003ad00: 2020 2020 2073 7973 2e73 7464 6572 722e       sys.stderr.
-0003ad10: 7772 6974 6528 2746 5343 2063 616c 6375  write('FSC calcu
-0003ad20: 6c61 7469 6f6e 2067 6574 206e 6f6e 6520  lation get none 
-0003ad30: 2729 0a0a 2020 2020 2020 2020 7265 7475  ')..        retu
-0003ad40: 726e 204e 6f6e 650a 0a0a 2020 2020 2320  rn None...    # 
-0003ad50: 4070 726f 6669 6c65 0a20 2020 2064 6566  @profile.    def
-0003ad60: 206e 6577 5f66 7363 2873 656c 662c 206d   new_fsc(self, m
-0003ad70: 6170 6f64 642c 206d 6170 6576 656e 2c20  apodd, mapeven, 
-0003ad80: 6173 796d 3d31 2e30 2c20 6c61 6265 6c3d  asym=1.0, label=
-0003ad90: 2727 293a 0a20 2020 2020 2020 2022 2222  ''):.        """
-0003ada0: 0a0a 2020 2020 2020 2020 2020 2020 4361  ..            Ca
-0003adb0: 6c63 756c 6174 6520 4653 4320 6261 7365  lculate FSC base
-0003adc0: 6420 6f6e 2074 6865 2074 776f 2069 6e70  d on the two inp
-0003add0: 7574 2068 616c 6620 6d61 7073 0a20 2020  ut half maps.   
-0003ade0: 2020 2020 2020 2020 2052 6573 756c 7473           Results
-0003adf0: 2077 726f 7465 2074 6f20 4a53 4f4e 2066   wrote to JSON f
-0003ae00: 696c 6520 696e 636c 7564 696e 6720 7265  ile including re
-0003ae10: 736f 6c75 7469 6f6e 2061 7420 302e 3134  solution at 0.14
-0003ae20: 332c 2030 2e33 3333 2c20 302e 3520 616e  3, 0.333, 0.5 an
-0003ae30: 6420 6e6f 6973 650a 2020 2020 2020 2020  d noise.        
-0003ae40: 2020 2020 6c65 7665 6c20 6174 2030 2e35      level at 0.5
-0003ae50: 2d62 6974 2c20 312d 6269 742c 2033 2d73  -bit, 1-bit, 3-s
-0003ae60: 6967 6d61 2e20 4120 636f 7272 6573 706f  igma. A correspo
-0003ae70: 6e64 696e 6720 706c 6f74 2069 7320 616c  nding plot is al
-0003ae80: 736f 2073 6176 6520 6173 2050 4e47 2066  so save as PNG f
-0003ae90: 696c 652e 0a0a 2020 2020 2020 2020 3a70  ile...        :p
-0003aea0: 6172 616d 206d 6170 6f64 643a 2054 454d  aram mapodd: TEM
-0003aeb0: 5079 206d 6170 2069 6e73 7461 6e63 650a  Py map instance.
-0003aec0: 2020 2020 2020 2020 3a70 6172 616d 206d          :param m
-0003aed0: 6170 6576 656e 3a20 5445 4d50 7920 6d61  apeven: TEMPy ma
-0003aee0: 7020 696e 7374 616e 6365 0a20 2020 2020  p instance.     
-0003aef0: 2020 203a 7265 7475 726e 3a20 4e6f 6e65     :return: None
-0003af00: 0a0a 2020 2020 2020 2020 2222 220a 0a20  ..        """.. 
-0003af10: 2020 2020 2020 2073 7461 7274 203d 2074         start = t
-0003af20: 696d 6569 742e 6465 6661 756c 745f 7469  imeit.default_ti
-0003af30: 6d65 7228 290a 2020 2020 2020 2020 6572  mer().        er
-0003af40: 726c 6973 7420 3d20 5b5d 0a20 2020 2020  rlist = [].     
-0003af50: 2020 2064 6174 6164 6963 7420 3d20 6469     datadict = di
-0003af60: 6374 2829 0a20 2020 2020 2020 2066 696e  ct().        fin
-0003af70: 616c 6469 6374 203d 2064 6963 7428 290a  aldict = dict().
-0003af80: 2020 2020 2020 2020 2320 6576 656e 6e61          # evenna
-0003af90: 6d65 203d 206f 732e 7061 7468 2e62 6173  me = os.path.bas
-0003afa0: 656e 616d 6528 6d61 7065 7665 6e2e 6675  ename(mapeven.fu
-0003afb0: 6c6c 6e61 6d65 290a 2020 2020 2020 2020  llname).        
-0003afc0: 2320 6f64 646e 616d 6520 3d20 6f73 2e70  # oddname = os.p
-0003afd0: 6174 682e 6261 7365 6e61 6d65 286d 6170  ath.basename(map
-0003afe0: 6f64 642e 6675 6c6c 6e61 6d65 290a 2020  odd.fullname).  
-0003aff0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0003b000: 2020 2020 2020 2061 7373 6572 7420 6d61         assert ma
-0003b010: 706f 6464 2e64 6174 612e 7368 6170 6520  podd.data.shape 
-0003b020: 3d3d 206d 6170 6576 656e 2e64 6174 612e  == mapeven.data.
-0003b030: 7368 6170 652c 2027 5468 6520 7477 6f20  shape, 'The two 
-0003b040: 6861 6c66 206d 6170 7320 646f 206e 6f74  half maps do not
-0003b050: 2068 6176 6520 7361 6d65 2073 697a 652e   have same size.
-0003b060: 270a 2020 2020 2020 2020 2020 2020 6173  '.            as
-0003b070: 7365 7274 206d 6170 6f64 642e 766f 7865  sert mapodd.voxe
-0003b080: 6c5f 7369 7a65 203d 3d20 6d61 7065 7665  l_size == mapeve
-0003b090: 6e2e 766f 7865 6c5f 7369 7a65 2c20 2754  n.voxel_size, 'T
-0003b0a0: 6865 2074 776f 2068 616c 6620 6d61 7073  he two half maps
-0003b0b0: 2064 6f20 6e6f 7420 6861 7665 2073 616d   do not have sam
-0003b0c0: 6520 6170 6978 2e27 0a20 2020 2020 2020  e apix.'.       
-0003b0d0: 2020 2020 206f 6464 6e61 6e20 3d20 6e70       oddnan = np
-0003b0e0: 2e69 736e 616e 286d 6170 6f64 642e 6461  .isnan(mapodd.da
-0003b0f0: 7461 292e 616e 7928 290a 2020 2020 2020  ta).any().      
-0003b100: 2020 2020 2020 6576 656e 6e61 6e20 3d20        evennan = 
-0003b110: 6e70 2e69 736e 616e 286d 6170 6576 656e  np.isnan(mapeven
-0003b120: 2e64 6174 6129 2e61 6e79 2829 0a20 2020  .data).any().   
-0003b130: 2020 2020 2020 2020 206e 616e 6368 6563           nanchec
-0003b140: 6b20 3d20 6f64 646e 616e 207c 2065 7665  k = oddnan | eve
-0003b150: 6e6e 616e 0a20 2020 2020 2020 2020 2020  nnan.           
-0003b160: 2061 7373 6572 7420 6e6f 7420 6e61 6e63   assert not nanc
-0003b170: 6865 636b 2c20 2754 6865 7265 2069 7320  heck, 'There is 
-0003b180: 4e61 4e20 7661 6c75 6520 696e 2068 616c  NaN value in hal
-0003b190: 6620 6d61 702e 270a 2020 2020 2020 2020  f map.'.        
-0003b1a0: 2020 2020 2320 4173 7375 6d65 2061 6c6c      # Assume all
-0003b1b0: 2064 696d 656e 7369 6f6e 2061 7265 2074   dimension are t
-0003b1c0: 6865 2073 616d 6520 7369 7a65 0a0a 2020  he same size..  
-0003b1d0: 2020 2020 2020 2020 2020 6170 6978 7320            apixs 
-0003b1e0: 3d20 7475 706c 6528 6d61 706f 6464 2e76  = tuple(mapodd.v
-0003b1f0: 6f78 656c 5f73 697a 652e 746f 6c69 7374  oxel_size.tolist
-0003b200: 2829 290a 0a20 2020 2020 2020 2020 2020  ())..           
-0003b210: 206d 6170 6f64 645f 6461 7461 203d 2066   mapodd_data = f
-0003b220: 6674 7368 6966 7428 6666 746e 286d 6170  ftshift(fftn(map
-0003b230: 6f64 642e 6461 7461 2929 0a20 2020 2020  odd.data)).     
-0003b240: 2020 2020 2020 206d 6170 6f64 642e 636c         mapodd.cl
-0003b250: 6f73 6528 290a 2020 2020 2020 2020 2020  ose().          
-0003b260: 2020 6d61 7065 7665 6e5f 6461 7461 203d    mapeven_data =
-0003b270: 2066 6674 7368 6966 7428 6666 746e 286d   fftshift(fftn(m
-0003b280: 6170 6576 656e 2e64 6174 6129 290a 2020  apeven.data)).  
-0003b290: 2020 2020 2020 2020 2020 6d61 7065 7665            mapeve
-0003b2a0: 6e2e 636c 6f73 6528 290a 0a20 2020 2020  n.close()..     
-0003b2b0: 2020 2020 2020 2073 7461 7274 203d 2074         start = t
-0003b2c0: 696d 6569 742e 6465 6661 756c 745f 7469  imeit.default_ti
-0003b2d0: 6d65 7228 2920 2d20 7374 6172 740a 2020  mer() - start.  
-0003b2e0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-0003b2f0: 2720 2d2d 2046 5343 2046 6f75 7269 6572  ' -- FSC Fourier
-0003b300: 2d74 7261 6e73 666f 726d 6174 696f 6e20  -transformation 
-0003b310: 7469 6d65 3a20 2573 2720 2520 7374 6172  time: %s' % star
-0003b320: 7429 0a0a 2020 2020 2020 2020 2020 2020  t)..            
-0003b330: 6966 2074 7970 6528 6170 6978 7329 2069  if type(apixs) i
-0003b340: 7320 7475 706c 653a 0a20 2020 2020 2020  s tuple:.       
-0003b350: 2020 2020 2020 2020 2074 6170 6978 203d           tapix =
-0003b360: 2061 7069 7873 5b30 5d0a 2020 2020 2020   apixs[0].      
-0003b370: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0003b380: 2020 2020 2020 2020 2020 2020 7461 7069              tapi
-0003b390: 7820 3d20 6170 6978 730a 0a20 2020 2020  x = apixs..     
-0003b3a0: 2020 2020 2020 2023 204c 6f6f 7069 6e67         # Looping
-0003b3b0: 2074 6872 6f75 6768 2061 6c6c 2073 6865   through all she
-0003b3c0: 6c6c 730a 2020 2020 2020 2020 2020 2020  lls.            
-0003b3d0: 636f 7272 6c69 7374 203d 205b 5d0a 2020  corrlist = [].  
-0003b3e0: 2020 2020 2020 2020 2020 7468 7265 6573            threes
-0003b3f0: 6967 203d 205b 5d0a 2020 2020 2020 2020  ig = [].        
-0003b400: 2020 2020 6861 6c66 6269 7420 3d20 5b5d      halfbit = []
-0003b410: 0a20 2020 2020 2020 2020 2020 206f 6e65  .            one
-0003b420: 6269 7420 3d20 5b5d 0a0a 2020 2020 2020  bit = []..      
-0003b430: 2020 2020 2020 2323 2061 7070 6c79 696e        ## applyin
-0003b440: 6720 6e65 7720 696e 6469 6365 7320 6675  g new indices fu
-0003b450: 6e63 7469 6f6e 0a20 2020 2020 2020 2020  nction.         
-0003b460: 2020 206d 6170 5f73 6861 7065 203d 206d     map_shape = m
-0003b470: 6170 6f64 645f 6461 7461 2e73 6861 7065  apodd_data.shape
-0003b480: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0003b490: 6d69 6e28 6d61 705f 7368 6170 6529 2025  min(map_shape) %
-0003b4a0: 2032 203d 3d20 303a 0a20 2020 2020 2020   2 == 0:.       
-0003b4b0: 2020 2020 2020 2020 206f 7267 203d 205b           org = [
-0003b4c0: 6d61 705f 7368 6170 655b 305d 202f 2032  map_shape[0] / 2
-0003b4d0: 2c20 6d61 705f 7368 6170 655b 315d 202f  , map_shape[1] /
-0003b4e0: 2032 2c20 6d61 705f 7368 6170 655b 325d   2, map_shape[2]
-0003b4f0: 202f 2032 5d0a 2020 2020 2020 2020 2020   / 2].          
-0003b500: 2020 2020 2020 696e 6469 6178 6973 203d        indiaxis =
-0003b510: 206e 702e 6c69 6e73 7061 6365 2830 2c20   np.linspace(0, 
-0003b520: 696e 7428 6d69 6e28 6f72 6729 292c 2069  int(min(org)), i
-0003b530: 6e74 286d 696e 286f 7267 2929 202b 2031  nt(min(org)) + 1
-0003b540: 2920 2f20 286d 696e 286d 6170 5f73 6861  ) / (min(map_sha
-0003b550: 7065 2920 2a20 7461 7069 7829 0a20 2020  pe) * tapix).   
-0003b560: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0003b570: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-0003b580: 7267 203d 205b 286d 6170 5f73 6861 7065  rg = [(map_shape
-0003b590: 5b30 5d20 2d20 3129 202f 2032 2c20 286d  [0] - 1) / 2, (m
-0003b5a0: 6170 5f73 6861 7065 5b31 5d20 2d20 3129  ap_shape[1] - 1)
-0003b5b0: 202f 2032 2c20 286d 6170 5f73 6861 7065   / 2, (map_shape
-0003b5c0: 5b32 5d20 2d20 3129 202f 2032 5d0a 2020  [2] - 1) / 2].  
-0003b5d0: 2020 2020 2020 2020 2020 2020 2020 696e                in
-0003b5e0: 6469 6178 6973 203d 206e 702e 6c69 6e73  diaxis = np.lins
-0003b5f0: 7061 6365 2830 2c20 696e 7428 6d69 6e28  pace(0, int(min(
-0003b600: 6f72 6729 292c 2069 6e74 286d 696e 286f  org)), int(min(o
-0003b610: 7267 2929 202b 2031 2920 2f20 286d 696e  rg)) + 1) / (min
-0003b620: 286d 6170 5f73 6861 7065 2920 2a20 7461  (map_shape) * ta
-0003b630: 7069 7829 0a20 2020 2020 2020 2020 2020  pix).           
-0003b640: 2020 2020 2069 6e64 6961 7869 7320 3d20       indiaxis = 
-0003b650: 6e70 2e61 7070 656e 6428 696e 6469 6178  np.append(indiax
-0003b660: 6973 2c20 312f 2832 202a 2074 6170 6978  is, 1/(2 * tapix
-0003b670: 2929 0a20 2020 2020 2020 2020 2020 2023  )).            #
-0003b680: 2069 6e64 6961 7869 7320 3d20 6e70 2e6c   indiaxis = np.l
-0003b690: 696e 7370 6163 6528 302c 2069 6e74 286f  inspace(0, int(o
-0003b6a0: 7267 5b30 5d29 2c20 696e 7428 6f72 675b  rg[0]), int(org[
-0003b6b0: 305d 2920 2b20 3129 202f 2028 6d61 705f  0]) + 1) / (map_
-0003b6c0: 7368 6170 655b 305d 202a 2074 6170 6978  shape[0] * tapix
-0003b6d0: 290a 2020 2020 2020 2020 2020 2020 7368  ).            sh
-0003b6e0: 656c 6c5f 7261 6e67 6520 3d20 696e 7428  ell_range = int(
-0003b6f0: 6d69 6e28 6d61 705f 7368 6170 6529 202d  min(map_shape) -
-0003b700: 206d 696e 286f 7267 2929 0a20 2020 2020   min(org)).     
-0003b710: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
-0003b720: 7261 6e67 6528 302c 2073 6865 6c6c 5f72  range(0, shell_r
-0003b730: 616e 6765 293a 0a20 2020 2020 2020 2020  ange):.         
-0003b740: 2020 2020 2020 2069 6e64 6963 6573 203d         indices =
-0003b750: 2073 656c 662e 6765 6e65 7261 7465 5f73   self.generate_s
-0003b760: 6865 6c6c 2869 2c20 6920 2b20 312c 206d  hell(i, i + 1, m
-0003b770: 6170 5f73 6861 7065 290a 2020 2020 2020  ap_shape).      
-0003b780: 2020 2020 2020 2020 2020 6f64 6472 696e            oddrin
-0003b790: 6720 3d20 6d61 706f 6464 5f64 6174 615b  g = mapodd_data[
-0003b7a0: 7475 706c 6528 696e 6469 6365 732e 5429  tuple(indices.T)
-0003b7b0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0003b7c0: 2020 6576 656e 7269 6e67 203d 206d 6170    evenring = map
-0003b7d0: 6576 656e 5f64 6174 615b 7475 706c 6528  even_data[tuple(
-0003b7e0: 696e 6469 6365 732e 5429 5d0a 2020 2020  indices.T)].    
-0003b7f0: 2020 2020 2020 2020 2020 2020 636f 7272              corr
-0003b800: 203d 2028 6f64 6472 696e 6720 2a20 6e70   = (oddring * np
-0003b810: 2e63 6f6e 6a28 6576 656e 7269 6e67 2929  .conj(evenring))
-0003b820: 2e73 756d 2829 0a20 2020 2020 2020 2020  .sum().         
-0003b830: 2020 2020 2020 2063 6f72 725f 6465 6e6f         corr_deno
-0003b840: 203d 206e 702e 7371 7274 2828 6e70 2e61   = np.sqrt((np.a
-0003b850: 6273 286f 6464 7269 6e67 2920 2a2a 2032  bs(oddring) ** 2
-0003b860: 292e 7375 6d28 2920 2a20 286e 702e 6162  ).sum() * (np.ab
-0003b870: 7328 6576 656e 7269 6e67 2920 2a2a 2032  s(evenring) ** 2
-0003b880: 292e 7375 6d28 2929 0a20 2020 2020 2020  ).sum()).       
-0003b890: 2020 2020 2020 2020 2069 6620 636f 7272           if corr
-0003b8a0: 5f64 656e 6f20 3d3d 2030 2e3a 0a20 2020  _deno == 0.:.   
-0003b8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003b8c0: 206e 6f72 636f 7272 203d 2030 2e0a 2020   norcorr = 0..  
-0003b8d0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-0003b8e0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0003b8f0: 2020 2020 2020 2020 6e6f 7263 6f72 7220          norcorr 
-0003b900: 3d20 6e70 2e72 6561 6c28 636f 7272 202f  = np.real(corr /
-0003b910: 2063 6f72 725f 6465 6e6f 290a 2020 2020   corr_deno).    
-0003b920: 2020 2020 2020 2020 2020 2020 636f 7272              corr
-0003b930: 6c69 7374 2e61 7070 656e 6428 6e6f 7263  list.append(norc
-0003b940: 6f72 7229 0a0a 2020 2020 2020 2020 2020  orr)..          
-0003b950: 2020 2020 2020 766f 6c75 6d65 6469 6666        volumediff
-0003b960: 203d 2028 342e 3020 2f20 332e 3029 202a   = (4.0 / 3.0) *
-0003b970: 2070 6920 2a20 2828 6920 2b20 3129 202a   pi * ((i + 1) *
-0003b980: 2a20 3320 2d20 6920 2a2a 2033 290a 2020  * 3 - i ** 3).  
-0003b990: 2020 2020 2020 2020 2020 2020 2020 6e76                nv
-0003b9a0: 6f78 7269 6e67 203d 2076 6f6c 756d 6564  oxring = volumed
-0003b9b0: 6966 6620 2f20 2831 202a 2a20 3329 0a20  iff / (1 ** 3). 
-0003b9c0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0003b9d0: 6666 6e76 6f78 203d 2028 6e76 6f78 7269  ffnvox = (nvoxri
-0003b9e0: 6e67 202a 2028 2831 2e35 202a 2030 2e36  ng * ((1.5 * 0.6
-0003b9f0: 3629 202a 2a20 3229 2920 2f20 2832 202a  6) ** 2)) / (2 *
-0003ba00: 2061 7379 6d29 0a20 2020 2020 2020 2020   asym).         
-0003ba10: 2020 2020 2020 2069 6620 6566 666e 766f         if effnvo
-0003ba20: 7820 3c20 312e 303a 2065 6666 6e76 6f78  x < 1.0: effnvox
-0003ba30: 203d 2031 2e30 0a20 2020 2020 2020 2020   = 1.0.         
-0003ba40: 2020 2020 2020 2073 7172 6566 666e 766f         sqreffnvo
-0003ba50: 7820 3d20 6e70 2e73 7172 7428 6566 666e  x = np.sqrt(effn
-0003ba60: 766f 7829 0a0a 2020 2020 2020 2020 2020  vox)..          
-0003ba70: 2020 2020 2020 7369 6776 616c 7565 203d        sigvalue =
-0003ba80: 2033 202f 2028 7371 7265 6666 6e76 6f78   3 / (sqreffnvox
-0003ba90: 202b 2033 2e30 202d 2031 2e30 290a 2020   + 3.0 - 1.0).  
-0003baa0: 2020 2020 2020 2020 2020 2020 2020 7468                th
-0003bab0: 7265 6573 6967 2e61 7070 656e 6428 7369  reesig.append(si
-0003bac0: 6776 616c 7565 290a 2020 2020 2020 2020  gvalue).        
-0003bad0: 2020 2020 2020 2020 6269 7476 616c 7565          bitvalue
-0003bae0: 203d 2028 302e 3230 3731 202b 2031 2e39   = (0.2071 + 1.9
-0003baf0: 3130 3220 2f20 7371 7265 6666 6e76 6f78  102 / sqreffnvox
-0003bb00: 2920 2f20 2831 2e32 3037 3120 2b20 302e  ) / (1.2071 + 0.
-0003bb10: 3931 3032 202f 2073 7172 6566 666e 766f  9102 / sqreffnvo
-0003bb20: 7829 0a20 2020 2020 2020 2020 2020 2020  x).             
-0003bb30: 2020 2068 616c 6662 6974 2e61 7070 656e     halfbit.appen
-0003bb40: 6428 6269 7476 616c 7565 290a 2020 2020  d(bitvalue).    
-0003bb50: 2020 2020 2020 2020 2020 2020 6f6e 6562              oneb
-0003bb60: 6974 7661 6c75 6520 3d20 2830 2e35 202b  itvalue = (0.5 +
-0003bb70: 2032 2e34 3134 3220 2f20 7371 7265 6666   2.4142 / sqreff
-0003bb80: 6e76 6f78 2920 2f20 2831 2e35 202b 2031  nvox) / (1.5 + 1
-0003bb90: 2e34 3134 3220 2f20 7371 7265 6666 6e76  .4142 / sqreffnv
-0003bba0: 6f78 290a 2020 2020 2020 2020 2020 2020  ox).            
-0003bbb0: 2020 2020 6f6e 6562 6974 2e61 7070 656e      onebit.appen
-0003bbc0: 6428 6f6e 6562 6974 7661 6c75 6529 0a0a  d(onebitvalue)..
-0003bbd0: 2020 2020 2020 2020 2020 2020 636f 7272              corr
-0003bbe0: 6c69 7374 2e69 6e73 6572 7428 302c 2031  list.insert(0, 1
-0003bbf0: 290a 2020 2020 2020 2020 2020 2020 7468  ).            th
-0003bc00: 7265 6573 6967 2e69 6e73 6572 7428 302c  reesig.insert(0,
-0003bc10: 2031 290a 2020 2020 2020 2020 2020 2020   1).            
-0003bc20: 6861 6c66 6269 742e 696e 7365 7274 2830  halfbit.insert(0
-0003bc30: 2c20 3129 0a20 2020 2020 2020 2020 2020  , 1).           
-0003bc40: 206f 6e65 6269 742e 696e 7365 7274 2830   onebit.insert(0
-0003bc50: 2c20 3129 0a20 2020 2020 2020 2020 2020  , 1).           
-0003bc60: 2064 656c 206d 6170 6f64 645f 6461 7461   del mapodd_data
-0003bc70: 0a20 2020 2020 2020 2020 2020 2064 656c  .            del
-0003bc80: 206d 6170 6576 656e 5f64 6174 610a 0a20   mapeven_data.. 
-0003bc90: 2020 2020 2020 2020 2020 2023 2049 6620             # If 
-0003bca0: 616e 7920 6f66 2074 6865 2066 6972 7374  any of the first
-0003bcb0: 2035 2076 616c 7565 7320 6973 206e 6567   5 values is neg
-0003bcc0: 6174 6976 652c 206d 616b 6520 6974 2074  ative, make it t
-0003bcd0: 6f20 310a 2020 2020 2020 2020 2020 2020  o 1.            
-0003bce0: 666f 7220 6920 696e 2072 616e 6765 2830  for i in range(0
-0003bcf0: 2c20 3529 3a0a 2020 2020 2020 2020 2020  , 5):.          
-0003bd00: 2020 2020 2020 6966 2063 6f72 726c 6973        if corrlis
-0003bd10: 745b 695d 203c 3d20 303a 0a20 2020 2020  t[i] <= 0:.     
-0003bd20: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0003bd30: 6f72 726c 6973 745b 695d 203d 2031 0a0a  orrlist[i] = 1..
-0003bd40: 2020 2020 2020 2020 2020 2020 6120 3d20              a = 
-0003bd50: 6e70 2e61 7361 7272 6179 2869 6e64 6961  np.asarray(india
-0003bd60: 7869 7329 0a20 2020 2020 2020 2020 2020  xis).           
-0003bd70: 2062 203d 206e 702e 6173 6172 7261 7928   b = np.asarray(
-0003bd80: 636f 7272 6c69 7374 290a 2020 2020 2020  corrlist).      
-0003bd90: 2020 2020 2020 6320 3d20 6e70 2e61 7361        c = np.asa
-0003bda0: 7272 6179 2874 6872 6565 7369 6729 0a20  rray(threesig). 
-0003bdb0: 2020 2020 2020 2020 2020 2064 203d 206e             d = n
-0003bdc0: 702e 6173 6172 7261 7928 6861 6c66 6269  p.asarray(halfbi
-0003bdd0: 7429 0a20 2020 2020 2020 2020 2020 2065  t).            e
-0003bde0: 203d 206e 702e 6173 6172 7261 7928 6f6e   = np.asarray(on
-0003bdf0: 6562 6974 290a 2020 2020 2020 2020 2020  ebit).          
-0003be00: 2020 6620 3d20 6e70 2e66 756c 6c28 286c    f = np.full((l
-0003be10: 656e 2869 6e64 6961 7869 7329 292c 2030  en(indiaxis)), 0
-0003be20: 2e35 290a 2020 2020 2020 2020 2020 2020  .5).            
-0003be30: 6720 3d20 6e70 2e66 756c 6c28 286c 656e  g = np.full((len
-0003be40: 2869 6e64 6961 7869 7329 292c 2030 2e33  (indiaxis)), 0.3
-0003be50: 3333 290a 2020 2020 2020 2020 2020 2020  33).            
-0003be60: 6820 3d20 6e70 2e66 756c 6c28 286c 656e  h = np.full((len
-0003be70: 2869 6e64 6961 7869 7329 292c 2030 2e31  (indiaxis)), 0.1
-0003be80: 3433 290a 2020 2020 2020 2020 2020 2020  43).            
-0003be90: 2320 7573 6520 5b3a 315d 2074 6f20 6967  # use [:1] to ig
-0003bea0: 6e6f 7265 2061 6c6c 2074 6865 2063 7572  nore all the cur
-0003beb0: 7665 7320 7374 6172 7420 6672 6f6d 2030  ves start from 0
-0003bec0: 2c31 0a20 2020 2020 2020 2020 2020 2078  ,1.            x
-0003bed0: 7468 7265 6573 6967 2c20 7974 6872 6565  threesig, ythree
-0003bee0: 7369 6720 3d20 7365 6c66 2e5f 5f69 6e74  sig = self.__int
-0003bef0: 6572 706f 6c61 7465 645f 696e 7465 7263  erpolated_interc
-0003bf00: 6570 7428 612c 2062 2c20 6329 0a20 2020  ept(a, b, c).   
-0003bf10: 2020 2020 2020 2020 2078 6861 6c66 6269           xhalfbi
-0003bf20: 742c 2079 6861 6c66 6269 7420 3d20 7365  t, yhalfbit = se
-0003bf30: 6c66 2e5f 5f69 6e74 6572 706f 6c61 7465  lf.__interpolate
-0003bf40: 645f 696e 7465 7263 6570 7428 612c 2062  d_intercept(a, b
-0003bf50: 2c20 6429 0a20 2020 2020 2020 2020 2020  , d).           
-0003bf60: 2078 6f6e 6562 6974 2c20 796f 6e65 6269   xonebit, yonebi
-0003bf70: 7420 3d20 7365 6c66 2e5f 5f69 6e74 6572  t = self.__inter
-0003bf80: 706f 6c61 7465 645f 696e 7465 7263 6570  polated_intercep
-0003bf90: 7428 612c 2062 2c20 6529 0a20 2020 2020  t(a, b, e).     
-0003bfa0: 2020 2020 2020 2078 6861 6c66 2c20 7968         xhalf, yh
-0003bfb0: 616c 6620 3d20 7365 6c66 2e5f 5f69 6e74  alf = self.__int
-0003bfc0: 6572 706f 6c61 7465 645f 696e 7465 7263  erpolated_interc
-0003bfd0: 6570 7428 612c 2062 2c20 6629 0a0a 2020  ept(a, b, f)..  
-0003bfe0: 2020 2020 2020 2020 2020 2320 4368 6563            # Chec
-0003bff0: 6b20 6966 206d 6d20 696e 206c 6162 656c  k if mm in label
-0003c000: 2074 6865 6e2c 2073 6565 2077 6869 6368   then, see which
-0003c010: 2069 6e74 6572 7365 6369 6f6e 2069 7320   intersecion is 
-0003c020: 7468 6520 6d6f 7374 2063 6c6f 7365 7374  the most closest
-0003c030: 2074 6f20 7468 6520 6769 7665 6e20 7265   to the given re
-0003c040: 736f 6c75 7469 6f6e 2854 6f64 6f29 0a20  solution(Todo). 
-0003c050: 2020 2020 2020 2020 2020 2069 6620 276d             if 'm
-0003c060: 6d27 2069 6e20 6c61 6265 6c3a 0a20 2020  m' in label:.   
-0003c070: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0003c080: 7868 616c 662e 7369 7a65 2021 3d20 303a  xhalf.size != 0:
-0003c090: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003c0a0: 2020 2020 206e 6577 7868 616c 6620 3d20       newxhalf = 
-0003c0b0: 6162 7328 7868 616c 6620 2d20 3120 2f20  abs(xhalf - 1 / 
-0003c0c0: 666c 6f61 7428 7365 6c66 2e72 6573 6f6c  float(self.resol
-0003c0d0: 7574 696f 6e29 290a 2020 2020 2020 2020  ution)).        
-0003c0e0: 2020 2020 2020 2020 2020 2020 696e 646d              indm
-0003c0f0: 696e 203d 206e 702e 6172 676d 696e 286e  in = np.argmin(n
-0003c100: 6577 7868 616c 6629 0a20 2020 2020 2020  ewxhalf).       
-0003c110: 2020 2020 2020 2020 2020 2020 2078 6861               xha
-0003c120: 6c66 203d 206e 702e 6172 7261 7928 5b78  lf = np.array([x
-0003c130: 6861 6c66 5b69 6e64 6d69 6e5d 5d29 0a20  half[indmin]]). 
-0003c140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c150: 2020 2079 6861 6c66 203d 206e 702e 6172     yhalf = np.ar
-0003c160: 7261 7928 5b79 6861 6c66 5b69 6e64 6d69  ray([yhalf[indmi
-0003c170: 6e5d 5d29 0a0a 2020 2020 2020 2020 2020  n]])..          
-0003c180: 2020 786f 6e65 7468 7265 652c 2079 6f6e    xonethree, yon
-0003c190: 6574 6872 6565 203d 2073 656c 662e 5f5f  ethree = self.__
-0003c1a0: 696e 7465 7270 6f6c 6174 6564 5f69 6e74  interpolated_int
-0003c1b0: 6572 6365 7074 2861 2c20 622c 2067 290a  ercept(a, b, g).
-0003c1c0: 2020 2020 2020 2020 2020 2020 7867 6f6c              xgol
-0003c1d0: 642c 2079 676f 6c64 203d 2073 656c 662e  d, ygold = self.
-0003c1e0: 5f5f 696e 7465 7270 6f6c 6174 6564 5f69  __interpolated_i
-0003c1f0: 6e74 6572 6365 7074 2861 2c20 622c 2068  ntercept(a, b, h
-0003c200: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
-0003c210: 2041 7373 6967 6e20 696e 7465 7273 6563   Assign intersec
-0003c220: 7469 6f6e 2076 616c 7565 2061 7320 4e6f  tion value as No
-0003c230: 6e65 2077 6865 6e20 7468 6572 6520 6973  ne when there is
-0003c240: 206e 6f20 696e 7465 7273 6563 7469 6f6e   no intersection
-0003c250: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0003c260: 7874 6872 6565 7369 672e 7369 7a65 203d  xthreesig.size =
-0003c270: 3d20 3020 616e 6420 7974 6872 6565 7369  = 0 and ythreesi
-0003c280: 672e 7369 7a65 203d 3d20 303a 0a20 2020  g.size == 0:.   
-0003c290: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-0003c2a0: 6e74 2827 4e6f 2069 6e74 6572 7365 6374  nt('No intersect
-0003c2b0: 696f 6e20 6265 7477 6565 6e20 4653 4320  ion between FSC 
-0003c2c0: 616e 6420 332d 7369 676d 6120 6375 7276  and 3-sigma curv
-0003c2d0: 6573 2e20 4865 7265 2075 7365 2074 6865  es. Here use the
-0003c2e0: 206c 6173 7420 706f 696e 742e 2729 0a20   last point.'). 
-0003c2f0: 2020 2020 2020 2020 2020 2020 2020 2078                 x
-0003c300: 7468 7265 6573 6967 2c20 7974 6872 6565  threesig, ythree
-0003c310: 7369 6720 3d20 4e6f 6e65 2c20 4e6f 6e65  sig = None, None
-0003c320: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-0003c330: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0003c340: 2020 2078 7468 7265 6573 6967 203d 206e     xthreesig = n
-0003c350: 702e 726f 756e 6428 7874 6872 6565 7369  p.round(xthreesi
-0003c360: 675b 305d 5b30 5d2c 2034 290a 2020 2020  g[0][0], 4).    
-0003c370: 2020 2020 2020 2020 2020 2020 7974 6872              ythr
-0003c380: 6565 7369 6720 3d20 6e70 2e72 6f75 6e64  eesig = np.round
-0003c390: 2879 7468 7265 6573 6967 5b30 5d5b 305d  (ythreesig[0][0]
-0003c3a0: 2c20 3429 0a0a 2020 2020 2020 2020 2020  , 4)..          
-0003c3b0: 2020 6966 2078 6861 6c66 6269 742e 7369    if xhalfbit.si
-0003c3c0: 7a65 203d 3d20 3020 616e 6420 7968 616c  ze == 0 and yhal
-0003c3d0: 6662 6974 2e73 697a 6520 3d3d 2030 3a0a  fbit.size == 0:.
-0003c3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c3f0: 7072 696e 7428 274e 6f20 696e 7465 7273  print('No inters
-0003c400: 6563 7469 6f6e 2062 6574 7765 656e 2046  ection between F
-0003c410: 5343 2061 6e64 2031 2f32 2d62 6974 2063  SC and 1/2-bit c
-0003c420: 7572 7665 732e 2048 6572 6520 7573 6520  urves. Here use 
-0003c430: 7468 6520 6c61 7374 2070 6f69 6e74 2e27  the last point.'
-0003c440: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0003c450: 2020 7868 616c 6662 6974 2c20 7968 616c    xhalfbit, yhal
-0003c460: 6662 6974 203d 204e 6f6e 652c 204e 6f6e  fbit = None, Non
-0003c470: 650a 2020 2020 2020 2020 2020 2020 656c  e.            el
-0003c480: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0003c490: 2020 2020 7868 616c 6662 6974 203d 206e      xhalfbit = n
-0003c4a0: 702e 726f 756e 6428 7868 616c 6662 6974  p.round(xhalfbit
-0003c4b0: 5b30 5d5b 305d 2c20 3429 0a20 2020 2020  [0][0], 4).     
-0003c4c0: 2020 2020 2020 2020 2020 2079 6861 6c66             yhalf
-0003c4d0: 6269 7420 3d20 6e70 2e72 6f75 6e64 2879  bit = np.round(y
-0003c4e0: 6861 6c66 6269 745b 305d 5b30 5d2c 2034  halfbit[0][0], 4
-0003c4f0: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
-0003c500: 6620 786f 6e65 6269 742e 7369 7a65 203d  f xonebit.size =
-0003c510: 3d20 3020 616e 6420 796f 6e65 6269 742e  = 0 and yonebit.
-0003c520: 7369 7a65 203d 3d20 303a 0a20 2020 2020  size == 0:.     
-0003c530: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-0003c540: 2827 4e6f 2069 6e74 6572 7365 6374 696f  ('No intersectio
-0003c550: 6e20 6265 7477 6565 6e20 4653 4320 616e  n between FSC an
-0003c560: 6420 312d 6269 7420 6375 7276 6573 2e20  d 1-bit curves. 
-0003c570: 4865 7265 2075 7365 2074 6865 206c 6173  Here use the las
-0003c580: 7420 706f 696e 742e 2729 0a20 2020 2020  t point.').     
-0003c590: 2020 2020 2020 2020 2020 2078 6f6e 6562             xoneb
-0003c5a0: 6974 2c20 796f 6e65 6269 7420 3d20 4e6f  it, yonebit = No
-0003c5b0: 6e65 2c20 4e6f 6e65 0a20 2020 2020 2020  ne, None.       
-0003c5c0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0003c5d0: 2020 2020 2020 2020 2020 2078 6f6e 6562             xoneb
-0003c5e0: 6974 203d 206e 702e 726f 756e 6428 786f  it = np.round(xo
-0003c5f0: 6e65 6269 745b 305d 5b30 5d2c 2034 290a  nebit[0][0], 4).
-0003c600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c610: 796f 6e65 6269 7420 3d20 6e70 2e72 6f75  yonebit = np.rou
-0003c620: 6e64 2879 6f6e 6562 6974 5b30 5d5b 305d  nd(yonebit[0][0]
-0003c630: 2c20 3429 0a0a 2020 2020 2020 2020 2020  , 4)..          
-0003c640: 2020 6966 2078 6f6e 6574 6872 6565 2e73    if xonethree.s
-0003c650: 697a 6520 3d3d 2030 2061 6e64 2079 6f6e  ize == 0 and yon
-0003c660: 6574 6872 6565 2e73 697a 6520 3d3d 2030  ethree.size == 0
-0003c670: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003c680: 2020 7072 696e 7428 274e 6f20 696e 7465    print('No inte
-0003c690: 7273 6563 7469 6f6e 2062 6574 7765 656e  rsection between
-0003c6a0: 2046 5343 2061 6e64 2030 2e33 3333 2063   FSC and 0.333 c
-0003c6b0: 7572 7665 732e 2048 6572 6520 7573 6520  urves. Here use 
-0003c6c0: 7468 6520 6c61 7374 2070 6f69 6e74 2729  the last point')
-0003c6d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003c6e0: 2078 6f6e 6574 6872 6565 2c20 796f 6e65   xonethree, yone
-0003c6f0: 7468 7265 6520 3d20 4e6f 6e65 2c20 4e6f  three = None, No
-0003c700: 6e65 0a20 2020 2020 2020 2020 2020 2065  ne.            e
-0003c710: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0003c720: 2020 2020 2078 6f6e 6574 6872 6565 203d       xonethree =
-0003c730: 206e 702e 726f 756e 6428 786f 6e65 7468   np.round(xoneth
-0003c740: 7265 655b 305d 5b30 5d2c 2034 290a 2020  ree[0][0], 4).  
-0003c750: 2020 2020 2020 2020 2020 2020 2020 796f                yo
-0003c760: 6e65 7468 7265 6520 3d20 6e70 2e72 6f75  nethree = np.rou
-0003c770: 6e64 2879 6f6e 6574 6872 6565 5b30 5d5b  nd(yonethree[0][
-0003c780: 305d 2c20 3429 0a0a 2020 2020 2020 2020  0], 4)..        
-0003c790: 2020 2020 6966 2078 6861 6c66 2e73 697a      if xhalf.siz
-0003c7a0: 6520 3d3d 2030 2061 6e64 2079 6861 6c66  e == 0 and yhalf
-0003c7b0: 2e73 697a 6520 3d3d 2030 3a0a 2020 2020  .size == 0:.    
-0003c7c0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0003c7d0: 7428 2721 2121 204e 6f20 696e 7465 7273  t('!!! No inters
-0003c7e0: 6563 7469 6f6e 2062 6574 7765 656e 2046  ection between F
-0003c7f0: 5343 2061 6e64 2030 2e35 2063 7572 7665  SC and 0.5 curve
-0003c800: 732e 2048 6572 6520 7573 6520 7468 6520  s. Here use the 
-0003c810: 6c61 7374 2070 6f69 6e74 2729 0a20 2020  last point').   
-0003c820: 2020 2020 2020 2020 2020 2020 2078 6861               xha
-0003c830: 6c66 2c20 7968 616c 6620 3d20 4e6f 6e65  lf, yhalf = None
-0003c840: 2c20 4e6f 6e65 0a20 2020 2020 2020 2020  , None.         
-0003c850: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0003c860: 2020 2020 2020 2020 2078 6861 6c66 203d           xhalf =
-0003c870: 206e 702e 726f 756e 6428 7868 616c 665b   np.round(xhalf[
-0003c880: 305d 5b30 5d2c 2034 290a 2020 2020 2020  0][0], 4).      
-0003c890: 2020 2020 2020 2020 2020 7968 616c 6620            yhalf 
-0003c8a0: 3d20 6e70 2e72 6f75 6e64 2879 6861 6c66  = np.round(yhalf
-0003c8b0: 5b30 5d5b 305d 2c20 3429 0a20 2020 2020  [0][0], 4).     
-0003c8c0: 2020 2020 2020 2069 6620 7867 6f6c 642e         if xgold.
-0003c8d0: 7369 7a65 203d 3d20 3020 616e 6420 7967  size == 0 and yg
-0003c8e0: 6f6c 642e 7369 7a65 203d 3d20 303a 0a20  old.size == 0:. 
-0003c8f0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0003c900: 7269 6e74 2827 2121 2120 4e6f 2069 6e74  rint('!!! No int
-0003c910: 6572 7365 6374 696f 6e20 6265 7477 6565  ersection betwee
-0003c920: 6e20 4653 4320 616e 6420 302e 3134 3320  n FSC and 0.143 
-0003c930: 6375 7276 6573 2e20 4865 7265 2075 7365  curves. Here use
-0003c940: 2074 6865 206c 6173 7420 706f 696e 7427   the last point'
-0003c950: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0003c960: 2020 7867 6f6c 642c 2079 676f 6c64 203d    xgold, ygold =
-0003c970: 204e 6f6e 652c 204e 6f6e 650a 2020 2020   None, None.    
-0003c980: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0003c990: 2020 2020 2020 2020 2020 2020 2020 7867                xg
-0003c9a0: 6f6c 6420 3d20 6e70 2e72 6f75 6e64 2878  old = np.round(x
-0003c9b0: 676f 6c64 5b30 5d5b 305d 2c20 3429 0a20  gold[0][0], 4). 
-0003c9c0: 2020 2020 2020 2020 2020 2020 2020 2079                 y
-0003c9d0: 676f 6c64 203d 206e 702e 726f 756e 6428  gold = np.round(
-0003c9e0: 7967 6f6c 645b 305d 5b30 5d2c 2034 290a  ygold[0][0], 4).
-0003c9f0: 0a0a 2020 2020 2020 2020 2020 2020 6461  ..            da
-0003ca00: 7461 6469 6374 203d 207b 0a20 2020 2020  tadict = {.     
-0003ca10: 2020 2020 2020 2020 2020 2027 6375 7276             'curv
-0003ca20: 6573 273a 207b 2766 7363 273a 206e 702e  es': {'fsc': np.
-0003ca30: 726f 756e 6428 6e70 2e72 6561 6c28 636f  round(np.real(co
-0003ca40: 7272 6c69 7374 292c 2034 292e 746f 6c69  rrlist), 4).toli
-0003ca50: 7374 2829 2c20 2774 6872 6565 7369 676d  st(), 'threesigm
-0003ca60: 6127 3a20 6e70 2e72 6f75 6e64 2874 6872  a': np.round(thr
-0003ca70: 6565 7369 672c 2034 292e 746f 6c69 7374  eesig, 4).tolist
-0003ca80: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
-0003ca90: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0003caa0: 6861 6c66 6269 7427 3a20 6e70 2e72 6f75  halfbit': np.rou
-0003cab0: 6e64 2868 616c 6662 6974 2c20 3429 2e74  nd(halfbit, 4).t
-0003cac0: 6f6c 6973 7428 292c 0a20 2020 2020 2020  olist(),.       
-0003cad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003cae0: 2020 2020 276f 6e65 6269 7427 3a20 6e70      'onebit': np
-0003caf0: 2e72 6f75 6e64 286f 6e65 6269 742c 2034  .round(onebit, 4
-0003cb00: 292e 746f 6c69 7374 2829 2c20 2730 2e35  ).tolist(), '0.5
-0003cb10: 273a 2066 2e74 6f6c 6973 7428 292c 2027  ': f.tolist(), '
-0003cb20: 302e 3333 3327 3a20 672e 746f 6c69 7374  0.333': g.tolist
-0003cb30: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
-0003cb40: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0003cb50: 302e 3134 3327 3a20 682e 746f 6c69 7374  0.143': h.tolist
-0003cb60: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
-0003cb70: 2020 2020 2020 2020 2020 2020 2020 2027                 '
-0003cb80: 6c65 7665 6c27 3a20 6e70 2e72 6f75 6e64  level': np.round
-0003cb90: 2869 6e64 6961 7869 732c 2034 292e 746f  (indiaxis, 4).to
-0003cba0: 6c69 7374 2829 7d2c 0a20 2020 2020 2020  list()},.       
-0003cbb0: 2020 2020 2020 2020 2027 696e 7465 7273           'inters
-0003cbc0: 6563 7469 6f6e 7327 3a20 7b27 7468 7265  ections': {'thre
-0003cbd0: 6573 6967 273a 207b 2778 273a 2078 7468  esig': {'x': xth
-0003cbe0: 7265 6573 6967 2c20 2779 273a 2079 7468  reesig, 'y': yth
-0003cbf0: 7265 6573 6967 7d2c 0a20 2020 2020 2020  reesig},.       
-0003cc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003cc10: 2020 2020 2020 2020 2020 2027 6861 6c66             'half
-0003cc20: 6269 7427 3a20 7b27 7827 3a20 7868 616c  bit': {'x': xhal
-0003cc30: 6662 6974 2c20 2779 273a 2079 6861 6c66  fbit, 'y': yhalf
-0003cc40: 6269 747d 2c0a 2020 2020 2020 2020 2020  bit},.          
-0003cc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003cc60: 2020 2020 2020 2020 276f 6e65 6269 7427          'onebit'
-0003cc70: 3a20 7b27 7827 3a20 786f 6e65 6269 742c  : {'x': xonebit,
-0003cc80: 2027 7927 3a20 796f 6e65 6269 747d 2c0a   'y': yonebit},.
-0003cc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003cca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ccb0: 2020 2730 2e35 273a 207b 2778 273a 2078    '0.5': {'x': x
-0003ccc0: 6861 6c66 2c20 2779 273a 2079 6861 6c66  half, 'y': yhalf
-0003ccd0: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
-0003cce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ccf0: 2020 2020 2027 302e 3333 3327 3a20 7b27       '0.333': {'
-0003cd00: 7827 3a20 786f 6e65 7468 7265 652c 2027  x': xonethree, '
-0003cd10: 7927 3a20 796f 6e65 7468 7265 657d 2c0a  y': yonethree},.
-0003cd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003cd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003cd40: 2020 2730 2e31 3433 273a 207b 2778 273a    '0.143': {'x':
-0003cd50: 2078 676f 6c64 2c20 2779 273a 2079 676f   xgold, 'y': ygo
-0003cd60: 6c64 7d7d 7d0a 2020 2020 2020 2020 2020  ld}}}.          
-0003cd70: 2020 6669 6e61 6c64 6963 7420 3d20 6469    finaldict = di
-0003cd80: 6374 2829 0a20 2020 2020 2020 2020 2020  ct().           
-0003cd90: 2066 696e 616c 6469 6374 5b6c 6162 656c   finaldict[label
-0003cda0: 202b 2027 6673 6327 5d20 3d20 6461 7461   + 'fsc'] = data
-0003cdb0: 6469 6374 0a0a 2020 2020 2020 2020 2020  dict..          
-0003cdc0: 2020 706c 742e 706c 6f74 2869 6e64 6961    plt.plot(india
-0003cdd0: 7869 732c 2063 6f72 726c 6973 742c 206c  xis, corrlist, l
-0003cde0: 6162 656c 3d6c 6162 656c 202b 2027 4653  abel=label + 'FS
-0003cdf0: 4327 290a 2020 2020 2020 2020 2020 2020  C').            
-0003ce00: 2320 706c 742e 706c 6f74 2869 6e64 6961  # plt.plot(india
-0003ce10: 7869 732c 2074 6872 6565 7369 672c 206c  xis, threesig, l
-0003ce20: 6162 656c 3d27 3320 7369 676d 6127 290a  abel='3 sigma').
-0003ce30: 2020 2020 2020 2020 2020 2020 706c 742e              plt.
-0003ce40: 706c 6f74 2869 6e64 6961 7869 732c 2068  plot(indiaxis, h
-0003ce50: 616c 6662 6974 2c20 6c61 6265 6c3d 2731  alfbit, label='1
-0003ce60: 2f32 2062 6974 2729 0a20 2020 2020 2020  /2 bit').       
-0003ce70: 2020 2020 2023 2070 6c74 2e70 6c6f 7428       # plt.plot(
-0003ce80: 696e 6469 6178 6973 2c20 6f6e 6562 6974  indiaxis, onebit
-0003ce90: 2c20 6c61 6265 6c3d 2731 2062 6974 2729  , label='1 bit')
-0003cea0: 0a20 2020 2020 2020 2020 2020 2070 6c74  .            plt
-0003ceb0: 2e70 6c6f 7428 696e 6469 6178 6973 2c20  .plot(indiaxis, 
-0003cec0: 662c 206c 6162 656c 3d27 302e 3527 2c20  f, label='0.5', 
-0003ced0: 6c69 6e65 7374 796c 653d 273a 2729 0a20  linestyle=':'). 
-0003cee0: 2020 2020 2020 2020 2020 2023 2070 6c74             # plt
-0003cef0: 2e70 6c6f 7428 696e 6469 6178 6973 2c20  .plot(indiaxis, 
-0003cf00: 672c 206c 6162 656c 3d27 302e 3333 3327  g, label='0.333'
-0003cf10: 2c20 6c69 6e65 7374 796c 653d 272d 2d27  , linestyle='--'
-0003cf20: 290a 2020 2020 2020 2020 2020 2020 706c  ).            pl
-0003cf30: 742e 706c 6f74 2869 6e64 6961 7869 732c  t.plot(indiaxis,
-0003cf40: 2068 2c20 6c61 6265 6c3d 2730 2e31 3433   h, label='0.143
-0003cf50: 272c 206c 696e 6573 7479 6c65 3d27 2d2e  ', linestyle='-.
-0003cf60: 2729 0a20 2020 2020 2020 2020 2020 2069  ').            i
-0003cf70: 6620 7365 6c66 2e72 6573 6f6c 7574 696f  f self.resolutio
-0003cf80: 6e20 6973 206e 6f74 204e 6f6e 653a 0a20  n is not None:. 
-0003cf90: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0003cfa0: 6c74 2e70 6c6f 7428 5b31 2f66 6c6f 6174  lt.plot([1/float
-0003cfb0: 2873 656c 662e 7265 736f 6c75 7469 6f6e  (self.resolution
-0003cfc0: 295d 202a 2031 3030 2c20 6e70 2e6c 696e  )] * 100, np.lin
-0003cfd0: 7370 6163 6528 302c 2031 2c20 3130 3029  space(0, 1, 100)
-0003cfe0: 2c20 636f 6c6f 723d 2772 6564 2729 0a20  , color='red'). 
-0003cff0: 2020 2020 2020 2020 2020 2070 6c74 2e6c             plt.l
-0003d000: 6567 656e 6428 290a 2020 2020 2020 2020  egend().        
-0003d010: 2020 2020 6966 206c 6162 656c 3a0a 2020      if label:.  
-0003d020: 2020 2020 2020 2020 2020 2020 2020 706c                pl
-0003d030: 742e 7361 7665 6669 6728 7365 6c66 2e77  t.savefig(self.w
-0003d040: 6f72 6b64 6972 202b 2073 656c 662e 6d61  orkdir + self.ma
-0003d050: 706e 616d 6520 2b20 275f 2720 2b20 6c61  pname + '_' + la
-0003d060: 6265 6c20 2b20 275f 6673 632e 706e 6727  bel + '_fsc.png'
-0003d070: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
-0003d080: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0003d090: 2020 2020 706c 742e 7361 7665 6669 6728      plt.savefig(
-0003d0a0: 7365 6c66 2e77 6f72 6b64 6972 202b 2073  self.workdir + s
-0003d0b0: 656c 662e 6d61 706e 616d 6520 2b20 275f  elf.mapname + '_
-0003d0c0: 6673 632e 706e 6727 290a 0a20 2020 2020  fsc.png')..     
-0003d0d0: 2020 2065 7863 6570 743a 0a20 2020 2020     except:.     
-0003d0e0: 2020 2020 2020 2065 7272 203d 2027 4653         err = 'FS
-0003d0f0: 4320 6361 6c63 756c 6174 696f 6e20 6572  C calculation er
-0003d100: 726f 723a 207b 7d27 2e66 6f72 6d61 7428  ror: {}'.format(
-0003d110: 7379 732e 6578 635f 696e 666f 2829 5b31  sys.exc_info()[1
-0003d120: 5d29 0a20 2020 2020 2020 2020 2020 2065  ]).            e
-0003d130: 7272 6c69 7374 2e61 7070 656e 6428 6572  rrlist.append(er
-0003d140: 7229 0a20 2020 2020 2020 2020 2020 2073  r).            s
-0003d150: 7973 2e73 7464 6572 722e 7772 6974 6528  ys.stderr.write(
-0003d160: 6572 7220 2b20 275c 6e27 290a 0a20 2020  err + '\n')..   
-0003d170: 2020 2020 2069 6620 6572 726c 6973 743a       if errlist:
-0003d180: 0a20 2020 2020 2020 2020 2020 2064 6174  .            dat
-0003d190: 6164 6963 7420 3d20 7b27 6572 7227 3a20  adict = {'err': 
-0003d1a0: 7b6c 6162 656c 202b 2027 6673 635f 6572  {label + 'fsc_er
-0003d1b0: 726f 7227 3a20 6572 726c 6973 747d 7d0a  ror': errlist}}.
-0003d1c0: 2020 2020 2020 2020 2020 2020 6669 6e61              fina
-0003d1d0: 6c64 6963 745b 6c61 6265 6c20 2b20 2766  ldict[label + 'f
-0003d1e0: 7363 275d 203d 2064 6174 6164 6963 740a  sc'] = datadict.
-0003d1f0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0003d200: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-0003d210: 274e 6f20 6572 726f 7220 696e 2046 5343  'No error in FSC
-0003d220: 2063 616c 6375 6c61 7469 6f6e 2e27 290a   calculation.').
-0003d230: 0a20 2020 2020 2020 2069 6620 626f 6f6c  .        if bool
-0003d240: 2864 6174 6164 6963 7429 2061 6e64 2062  (datadict) and b
-0003d250: 6f6f 6c28 6669 6e61 6c64 6963 7429 3a0a  ool(finaldict):.
-0003d260: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-0003d270: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003d280: 2077 6974 6820 636f 6465 6373 2e6f 7065   with codecs.ope
-0003d290: 6e28 7365 6c66 2e77 6f72 6b64 6972 202b  n(self.workdir +
-0003d2a0: 2073 656c 662e 6d61 706e 616d 6520 2b20   self.mapname + 
-0003d2b0: 275f 2720 2b20 6c61 6265 6c20 2b20 2766  '_' + label + 'f
-0003d2c0: 7363 2e6a 736f 6e27 2c20 2777 272c 2065  sc.json', 'w', e
-0003d2d0: 6e63 6f64 696e 673d 2775 7466 2d38 2729  ncoding='utf-8')
-0003d2e0: 2061 7320 663a 0a20 2020 2020 2020 2020   as f:.         
-0003d2f0: 2020 2020 2020 2020 2020 206a 736f 6e2e             json.
-0003d300: 6475 6d70 2866 696e 616c 6469 6374 2c20  dump(finaldict, 
-0003d310: 6629 0a20 2020 2020 2020 2020 2020 2020  f).             
-0003d320: 2020 2070 7269 6e74 2827 4653 4320 7072     print('FSC pr
-0003d330: 6f64 7563 6564 2062 7920 7477 6f20 6861  oduced by two ha
-0003d340: 6c66 206d 6170 732e 2729 0a20 2020 2020  lf maps.').     
-0003d350: 2020 2020 2020 2020 2020 2023 2077 6974             # wit
-0003d360: 6820 636f 6465 6373 2e6f 7065 6e28 7365  h codecs.open(se
-0003d370: 6c66 2e77 6f72 6b64 6972 202b 206f 6464  lf.workdir + odd
-0003d380: 6e61 6d65 202b 2027 5f27 202b 2065 7665  name + '_' + eve
-0003d390: 6e6e 616d 6520 2b20 275f 2720 2b20 6c61  nname + '_' + la
-0003d3a0: 6265 6c20 2b20 2766 7363 2e6a 736f 6e27  bel + 'fsc.json'
-0003d3b0: 2c20 2777 272c 2065 6e63 6f64 696e 673d  , 'w', encoding=
-0003d3c0: 2775 7466 2d38 2729 2061 7320 6e66 3a0a  'utf-8') as nf:.
-0003d3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d3e0: 2320 2020 2020 6a73 6f6e 2e64 756d 7028  #     json.dump(
-0003d3f0: 6669 6e61 6c64 6963 742c 206e 6629 0a20  finaldict, nf). 
-0003d400: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0003d410: 2070 7269 6e74 2827 326e 6420 6673 6320   print('2nd fsc 
-0003d420: 7361 7665 6427 290a 2020 2020 2020 2020  saved').        
-0003d430: 2020 2020 6578 6365 7074 3a0a 2020 2020      except:.    
-0003d440: 2020 2020 2020 2020 2020 2020 7379 732e              sys.
-0003d450: 7374 6465 7272 2e77 7269 7465 2827 5772  stderr.write('Wr
-0003d460: 6974 696e 6720 4653 4320 6461 7461 2074  iting FSC data t
-0003d470: 6f20 6a73 6f6e 2066 696c 6520 6572 726f  o json file erro
-0003d480: 723a 207b 7d2e 272e 666f 726d 6174 2873  r: {}.'.format(s
-0003d490: 7973 2e65 7863 5f69 6e66 6f28 295b 315d  ys.exc_info()[1]
-0003d4a0: 2929 0a20 2020 2020 2020 2065 6c73 653a  )).        else:
-0003d4b0: 0a20 2020 2020 2020 2020 2020 2073 7973  .            sys
-0003d4c0: 2e73 7464 6572 722e 7772 6974 6528 2746  .stderr.write('F
-0003d4d0: 5343 2063 616c 6375 6c61 7469 6f6e 2067  SC calculation g
-0003d4e0: 6574 206e 6f6e 6520 2729 0a0a 2020 2020  et none ')..    
-0003d4f0: 2020 2020 7265 7475 726e 204e 6f6e 650a      return None.
-0003d500: 0a20 2020 2040 7374 6174 6963 6d65 7468  .    @staticmeth
-0003d510: 6f64 0a20 2020 2064 6566 206d 656d 7072  od.    def mempr
-0003d520: 6564 2872 6573 756c 7466 696c 652c 2069  ed(resultfile, i
-0003d530: 6e70 7574 6669 6c65 7369 7a65 293a 0a20  nputfilesize):. 
-0003d540: 2020 2020 2020 2022 2222 0a0a 2020 2020         """..    
-0003d550: 2020 2020 2020 2020 5072 6f64 7563 6520          Produce 
-0003d560: 6d65 6d6f 7279 2070 7265 6469 6374 696f  memory predictio
-0003d570: 6e20 7265 7375 6c74 7320 7573 696e 6720  n results using 
-0003d580: 6c69 6e65 6172 2072 6567 7265 7373 696f  linear regressio
-0003d590: 6e0a 2020 2020 2020 2020 2020 2020 6261  n.            ba
-0003d5a0: 7365 6420 6f6e 2074 6865 2064 6174 6120  sed on the data 
-0003d5b0: 6672 6f6d 2070 7265 7669 6f75 7320 656e  from previous en
-0003d5c0: 7472 6965 732e 0a0a 0a20 2020 2020 2020  tries....       
-0003d5d0: 203a 7061 7261 6d20 7265 7375 6c74 6669   :param resultfi
-0003d5e0: 6c65 3a20 5072 6576 696f 7573 206d 656d  le: Previous mem
-0003d5f0: 6f72 7920 7573 6167 6520 696e 666f 726d  ory usage inform
-0003d600: 6174 696f 6e20 696e 2043 5356 2066 696c  ation in CSV fil
-0003d610: 650a 2020 2020 2020 2020 3a70 6172 616d  e.        :param
-0003d620: 2069 6e70 7574 6669 6c65 7369 7a65 3a20   inputfilesize: 
-0003d630: 5468 6520 696e 7075 7420 6465 6e73 6974  The input densit
-0003d640: 7920 6d61 7020 7369 7a65 0a20 2020 2020  y map size.     
-0003d650: 2020 203a 7265 7475 726e 3a20 3020 6f72     :return: 0 or
-0003d660: 2079 5f70 7265 6420 2874 6865 2070 7265   y_pred (the pre
-0003d670: 6469 6374 6564 206d 656d 6f72 7920 7573  dicted memory us
-0003d680: 6167 6529 0a20 2020 2020 2020 2022 2222  age).        """
-0003d690: 0a20 2020 2020 2020 2066 726f 6d20 736b  .        from sk
-0003d6a0: 6c65 6172 6e2e 6c69 6e65 6172 5f6d 6f64  learn.linear_mod
-0003d6b0: 656c 2069 6d70 6f72 7420 4c69 6e65 6172  el import Linear
-0003d6c0: 5265 6772 6573 7369 6f6e 0a20 2020 2020  Regression.     
-0003d6d0: 2020 2066 726f 6d20 736b 6c65 6172 6e2e     from sklearn.
-0003d6e0: 6d65 7472 6963 7320 696d 706f 7274 206d  metrics import m
-0003d6f0: 6561 6e5f 7371 7561 7265 645f 6572 726f  ean_squared_erro
-0003d700: 722c 2072 325f 7363 6f72 650a 2020 2020  r, r2_score.    
-0003d710: 2020 2020 6672 6f6d 2073 6b6c 6561 726e      from sklearn
-0003d720: 2e6d 6f64 656c 5f73 656c 6563 7469 6f6e  .model_selection
-0003d730: 2069 6d70 6f72 7420 7472 6169 6e5f 7465   import train_te
-0003d740: 7374 5f73 706c 6974 0a20 2020 2020 2020  st_split.       
-0003d750: 2066 726f 6d20 736b 6c65 6172 6e2e 6d6f   from sklearn.mo
-0003d760: 6465 6c5f 7365 6c65 6374 696f 6e20 696d  del_selection im
-0003d770: 706f 7274 2063 726f 7373 5f76 616c 5f73  port cross_val_s
-0003d780: 636f 7265 2c20 6372 6f73 735f 7661 6c5f  core, cross_val_
-0003d790: 7072 6564 6963 740a 0a20 2020 2020 2020  predict..       
-0003d7a0: 2064 6174 6120 3d20 7064 2e72 6561 645f   data = pd.read_
-0003d7b0: 6373 7628 7265 7375 6c74 6669 6c65 2c20  csv(resultfile, 
-0003d7c0: 6865 6164 6572 3d30 290a 2020 2020 2020  header=0).      
-0003d7d0: 2020 6461 7461 203d 2064 6174 612e 6472    data = data.dr
-0003d7e0: 6f70 6e61 2829 0a20 2020 2020 2020 2069  opna().        i
-0003d7f0: 6620 6461 7461 2e65 6d70 7479 3a0a 2020  f data.empty:.  
-0003d800: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-0003d810: 274e 6f20 7573 6566 756c 2064 6174 6120  'No useful data 
-0003d820: 696e 2074 6865 2064 6174 6166 7261 6d65  in the dataframe
-0003d830: 2e27 290a 2020 2020 2020 2020 2020 2020  .').            
-0003d840: 7265 7475 726e 204e 6f6e 650a 2020 2020  return None.    
-0003d850: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0003d860: 2020 2020 2020 6e65 7764 6174 6120 3d20        newdata = 
-0003d870: 6461 7461 2e69 6c6f 635b 3a2c 2031 3a5d  data.iloc[:, 1:]
-0003d880: 0a20 2020 2020 2020 2020 2020 2073 6f72  .            sor
-0003d890: 7464 6174 6120 3d20 6e65 7764 6174 612e  tdata = newdata.
-0003d8a0: 736f 7274 5f76 616c 7565 7328 6e65 7764  sort_values(newd
-0003d8b0: 6174 612e 636f 6c75 6d6e 735b 305d 290a  ata.columns[0]).
-0003d8c0: 2020 2020 2020 2020 2020 2020 6d65 7264              merd
-0003d8d0: 6174 6120 3d20 736f 7274 6461 7461 2e67  ata = sortdata.g
-0003d8e0: 726f 7570 6279 2873 6f72 7464 6174 612e  roupby(sortdata.
-0003d8f0: 636f 6c75 6d6e 735b 305d 2c20 6173 5f69  columns[0], as_i
-0003d900: 6e64 6578 3d46 616c 7365 292e 6d65 616e  ndex=False).mean
-0003d910: 2829 0a20 2020 2020 2020 2020 2020 2078  ().            x
-0003d920: 203d 206d 6572 6461 7461 5b27 6d61 7072   = merdata['mapr
-0003d930: 6561 6c73 697a 6527 5d0a 2020 2020 2020  ealsize'].      
-0003d940: 2020 2020 2020 7920 3d20 6d65 7264 6174        y = merdat
-0003d950: 615b 276d 656d 275d 0a20 2020 2020 2020  a['mem'].       
-0003d960: 2020 2020 2069 6620 782e 7368 6170 655b       if x.shape[
-0003d970: 305d 203c 3d20 313a 0a20 2020 2020 2020  0] <= 1:.       
-0003d980: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
-0003d990: 5361 6d70 6c65 2069 7320 746f 6f20 6c69  Sample is too li
-0003d9a0: 7474 6c65 2074 6f20 7370 6c69 742e 2729  ttle to split.')
-0003d9b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003d9c0: 2072 6574 7572 6e20 4e6f 6e65 0a20 2020   return None.   
-0003d9d0: 2020 2020 2020 2020 2058 5f74 7261 696e           X_train
-0003d9e0: 2c20 585f 7465 7374 2c20 795f 7472 6169  , X_test, y_trai
-0003d9f0: 6e2c 2079 5f74 6573 7420 3d20 7472 6169  n, y_test = trai
-0003da00: 6e5f 7465 7374 5f73 706c 6974 2878 2c20  n_test_split(x, 
-0003da10: 792c 2074 6573 745f 7369 7a65 3d30 2e32  y, test_size=0.2
-0003da20: 2c20 7261 6e64 6f6d 5f73 7461 7465 3d30  , random_state=0
-0003da30: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0003da40: 2058 5f74 7261 696e 2e65 6d70 7479 206f   X_train.empty o
-0003da50: 7220 585f 7465 7374 2e65 6d70 7479 206f  r X_test.empty o
-0003da60: 7220 795f 7472 6169 6e2e 656d 7074 7920  r y_train.empty 
-0003da70: 6f72 2079 5f74 6573 742e 656d 7074 7920  or y_test.empty 
-0003da80: 6f72 206c 656e 2878 2e69 6e64 6578 2920  or len(x.index) 
-0003da90: 3c20 3330 3a0a 2020 2020 2020 2020 2020  < 30:.          
-0003daa0: 2020 2020 2020 7072 696e 7428 2753 7061        print('Spa
-0003dab0: 7273 6520 6461 7461 2066 6f72 206d 656d  rse data for mem
-0003dac0: 6f72 7920 7072 6564 6963 7469 6f6e 2c20  ory prediction, 
-0003dad0: 7265 7375 6c74 206d 6179 206e 6f74 2061  result may not a
-0003dae0: 6363 7572 6174 652e 2729 0a20 2020 2020  ccurate.').     
-0003daf0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0003db00: 6e20 4e6f 6e65 0a20 2020 2020 2020 2020  n None.         
-0003db10: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0003db20: 2020 2020 2020 2020 206c 726d 6f64 656c           lrmodel
-0003db30: 203d 204c 696e 6561 7252 6567 7265 7373   = LinearRegress
-0003db40: 696f 6e28 6669 745f 696e 7465 7263 6570  ion(fit_intercep
-0003db50: 743d 4661 6c73 6529 0a20 2020 2020 2020  t=False).       
-0003db60: 2020 2020 2020 2020 2023 2050 6572 666f           # Perfo
-0003db70: 726d 2043 560a 2020 2020 2020 2020 2020  rm CV.          
-0003db80: 2020 2020 2020 7363 6f72 6573 203d 2063        scores = c
-0003db90: 726f 7373 5f76 616c 5f73 636f 7265 286c  ross_val_score(l
-0003dba0: 726d 6f64 656c 2c20 782e 7661 6c75 6573  rmodel, x.values
-0003dbb0: 2e72 6573 6861 7065 282d 312c 2031 292c  .reshape(-1, 1),
-0003dbc0: 2079 2c20 6376 3d36 290a 2020 2020 2020   y, cv=6).      
-0003dbd0: 2020 2020 2020 2020 2020 7072 6564 6963            predic
-0003dbe0: 7469 6f6e 7320 3d20 6372 6f73 735f 7661  tions = cross_va
-0003dbf0: 6c5f 7072 6564 6963 7428 6c72 6d6f 6465  l_predict(lrmode
-0003dc00: 6c2c 2078 2e76 616c 7565 732e 7265 7368  l, x.values.resh
-0003dc10: 6170 6528 2d31 2c20 3129 2c20 792c 2063  ape(-1, 1), y, c
-0003dc20: 763d 3629 0a0a 2020 2020 2020 2020 2020  v=6)..          
-0003dc30: 2020 2020 2020 6c72 6d6f 6465 6c2e 6669        lrmodel.fi
-0003dc40: 7428 585f 7472 6169 6e2e 7661 6c75 6573  t(X_train.values
-0003dc50: 2e72 6573 6861 7065 282d 312c 2031 292c  .reshape(-1, 1),
-0003dc60: 2079 5f74 7261 696e 290a 2020 2020 2020   y_train).      
-0003dc70: 2020 2020 2020 2020 2020 6c72 7072 6564            lrpred
-0003dc80: 6963 7420 3d20 6c72 6d6f 6465 6c2e 7072  ict = lrmodel.pr
-0003dc90: 6564 6963 7428 585f 7465 7374 2e76 616c  edict(X_test.val
-0003dca0: 7565 732e 7265 7368 6170 6528 2d31 2c20  ues.reshape(-1, 
-0003dcb0: 3129 290a 2020 2020 2020 2020 2020 2020  1)).            
-0003dcc0: 2020 2020 7072 696e 7428 2736 2d46 6f6c      print('6-Fol
-0003dcd0: 6420 4356 2073 636f 7265 733a 2573 2720  d CV scores:%s' 
-0003dce0: 2520 7363 6f72 6573 290a 2020 2020 2020  % scores).      
-0003dcf0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-0003dd00: 2743 5620 6163 6375 7261 6379 3a20 2573  'CV accuracy: %s
-0003dd10: 2720 2520 2872 325f 7363 6f72 6528 792c  ' % (r2_score(y,
-0003dd20: 2070 7265 6469 6374 696f 6e73 2929 290a   predictions))).
-0003dd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003dd40: 2320 7072 696e 7420 2753 636f 7265 3a25  # print 'Score:%
-0003dd50: 7327 2025 2028 6c72 6d6f 6465 6c2e 7363  s' % (lrmodel.sc
-0003dd60: 6f72 6528 585f 7465 7374 2e76 616c 7565  ore(X_test.value
-0003dd70: 732e 7265 7368 6170 6528 2d31 2c31 292c  s.reshape(-1,1),
-0003dd80: 2079 5f74 6573 7429 290a 2020 2020 2020   y_test)).      
-0003dd90: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-0003dda0: 274c 696e 6561 7220 6d6f 6465 6c20 636f  'Linear model co
-0003ddb0: 6566 6669 6369 656e 7473 3a20 2573 2720  efficients: %s' 
-0003ddc0: 2520 286c 726d 6f64 656c 2e63 6f65 665f  % (lrmodel.coef_
-0003ddd0: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-0003dde0: 2020 2070 7269 6e74 2827 4d53 453a 2025     print('MSE: %
-0003ddf0: 7327 2025 2028 6d65 616e 5f73 7175 6172  s' % (mean_squar
-0003de00: 6564 5f65 7272 6f72 2879 5f74 6573 742c  ed_error(y_test,
-0003de10: 206c 7270 7265 6469 6374 2929 290a 2020   lrpredict))).  
-0003de20: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-0003de30: 696e 7428 2756 6172 6961 6e63 6520 7363  int('Variance sc
-0003de40: 6f72 6528 7465 7374 2061 6363 7572 6163  ore(test accurac
-0003de50: 7929 3a20 2573 2720 2520 2872 325f 7363  y): %s' % (r2_sc
-0003de60: 6f72 6528 795f 7465 7374 2c20 6c72 7072  ore(y_test, lrpr
-0003de70: 6564 6963 7429 2929 0a20 2020 2020 2020  edict))).       
-0003de80: 2020 2020 2020 2020 2079 5f70 7265 6420           y_pred 
-0003de90: 3d20 6c72 6d6f 6465 6c2e 7072 6564 6963  = lrmodel.predic
-0003dea0: 7428 5b5b 696e 7075 7466 696c 6573 697a  t([[inputfilesiz
-0003deb0: 655d 5d29 0a0a 2020 2020 2020 2020 2020  e]])..          
-0003dec0: 2020 2020 2020 7265 7475 726e 2079 5f70        return y_p
-0003ded0: 7265 640a 0a20 2020 2040 7374 6174 6963  red..    @static
-0003dee0: 6d65 7468 6f64 0a20 2020 2064 6566 2073  method.    def s
-0003def0: 6176 6570 6561 6b6d 656d 6f72 7928 6669  avepeakmemory(fi
-0003df00: 6c65 6e61 6d65 2c20 6d61 786d 656d 293a  lename, maxmem):
-0003df10: 0a20 2020 2020 2020 2022 2222 0a0a 2020  .        """..  
-0003df20: 2020 2020 2020 2020 2020 4461 7461 2063            Data c
-0003df30: 6f6c 6c65 6374 6564 2061 6e64 2074 6f20  ollected and to 
-0003df40: 6265 2075 7365 6420 666f 7220 7072 6564  be used for pred
-0003df50: 6963 7469 6f6e 2066 6f72 206d 656d 6f72  iction for memor
-0003df60: 7920 7573 6167 650a 2020 2020 2020 2020  y usage.        
-0003df70: 2020 2020 4d65 6d6f 7279 2073 6176 6564      Memory saved
-0003df80: 2061 7320 6120 636f 6d6d 6120 7365 7061   as a comma sepa
-0003df90: 7261 7465 2043 5356 2066 696c 652e 0a0a  rate CSV file...
-0003dfa0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-0003dfb0: 6669 6c65 6e61 6d65 3a20 5374 7269 6e67  filename: String
-0003dfc0: 2066 6f72 2066 696c 6520 7768 6963 6820   for file which 
-0003dfd0: 7573 6564 2074 6f20 636f 6c6c 6563 7420  used to collect 
-0003dfe0: 6461 7461 0a20 2020 2020 2020 203a 7061  data.        :pa
-0003dff0: 7261 6d20 6d61 786d 656d 3a20 466c 6f61  ram maxmem: Floa
-0003e000: 7420 6e75 6d62 6572 2077 6869 6368 2067  t number which g
-0003e010: 6976 6573 2070 6561 6b20 6d65 6d6f 7279  ives peak memory
-0003e020: 2075 7361 6765 206f 6620 7468 6520 6669   usage of the fi
-0003e030: 6e69 7368 6564 206a 6f62 0a20 2020 2020  nished job.     
-0003e040: 2020 203a 7265 7475 726e 3a20 4e6f 6e65     :return: None
-0003e050: 0a0a 2020 2020 2020 2020 2222 220a 0a20  ..        """.. 
-0003e060: 2020 2020 2020 2063 6f6c 756d 6e6e 616d         columnnam
-0003e070: 6520 3d20 276d 656d 270a 2020 2020 2020  e = 'mem'.      
-0003e080: 2020 2320 6469 7220 3d20 4d41 505f 5345    # dir = MAP_SE
-0003e090: 5256 4552 5f50 4154 4820 6966 2073 656c  RVER_PATH if sel
-0003e0a0: 662e 656d 6469 6420 6973 206e 6f74 204e  f.emdid is not N
-0003e0b0: 6f6e 6520 656c 7365 206f 732e 7061 7468  one else os.path
-0003e0c0: 2e64 6972 6e61 6d65 286f 732e 7061 7468  .dirname(os.path
-0003e0d0: 2e64 6972 6e61 6d65 2873 656c 662e 776f  .dirname(self.wo
-0003e0e0: 726b 6469 7229 290a 2020 2020 2020 2020  rkdir)).        
-0003e0f0: 2320 6669 6c65 6e61 6d65 203d 2064 6972  # filename = dir
-0003e100: 202b 2027 696e 7075 742e 6373 7627 0a20   + 'input.csv'. 
-0003e110: 2020 2020 2020 206d 656d 7265 7375 6c74         memresult
-0003e120: 6669 6c65 203d 2066 696c 656e 616d 650a  file = filename.
-0003e130: 2020 2020 2020 2020 6466 203d 2070 642e          df = pd.
-0003e140: 7265 6164 5f63 7376 2866 696c 656e 616d  read_csv(filenam
-0003e150: 652c 2068 6561 6465 723d 302c 2073 6570  e, header=0, sep
-0003e160: 3d27 2c27 2c20 736b 6970 696e 6974 6961  =',', skipinitia
-0003e170: 6c73 7061 6365 3d54 7275 6529 0a20 2020  lspace=True).   
-0003e180: 2020 2020 2064 665b 636f 6c75 6d6e 6e61       df[columnna
-0003e190: 6d65 5d5b 6c65 6e28 6466 2e69 6e64 6578  me][len(df.index
-0003e1a0: 2920 2d20 315d 203d 206d 6178 6d65 6d0a  ) - 1] = maxmem.
-0003e1b0: 2020 2020 2020 2020 6466 2e74 6f5f 6373          df.to_cs
-0003e1c0: 7628 6d65 6d72 6573 756c 7466 696c 652c  v(memresultfile,
-0003e1d0: 2073 6570 3d27 2c27 2c20 696e 6465 783d   sep=',', index=
-0003e1e0: 4661 6c73 6529 0a0a 2020 2020 2020 2020  False)..        
-0003e1f0: 7265 7475 726e 204e 6f6e 650a 0a0a 2020  return None...  
-0003e200: 2020 2320 4070 726f 6669 6c65 0a20 2020    # @profile.   
-0003e210: 2064 6566 2073 796d 6d65 7472 7928 7365   def symmetry(se
-0003e220: 6c66 293a 0a20 2020 2020 2020 2022 2222  lf):.        """
-0003e230: 0a20 2020 2020 2020 2020 2020 2050 726f  .            Pro
-0003e240: 6475 696e 6720 7379 6d6d 6574 7279 2069  duing symmetry i
-0003e250: 6e66 6f72 6d61 7469 6f6e 206f 6620 7468  nformation of th
-0003e260: 6520 6d61 7020 6279 2075 7369 6e67 2050  e map by using P
-0003e270: 726f 7368 6164 650a 2020 2020 2020 2020  roshade.        
-0003e280: 2020 2020 5468 6973 2066 756e 6374 696f      This functio
-0003e290: 6e20 7573 696e 6720 7468 6520 6269 6e61  n using the bina
-0003e2a0: 7279 2070 726f 7368 6164 6520 7072 6f67  ry proshade prog
-0003e2b0: 7261 6d20 206e 6f74 2074 6865 2070 7974  ram  not the pyt
-0003e2c0: 686f 6e20 6170 690a 0a20 2020 2020 2020  hon api..       
-0003e2d0: 203a 7265 7475 726e 3a20 204e 6f6e 650a   :return:  None.
-0003e2e0: 2020 2020 2020 2020 2222 220a 0a20 2020          """..   
-0003e2f0: 2020 2020 2069 6620 7365 6c66 2e70 6c61       if self.pla
-0003e300: 7466 6f72 6d20 3d3d 2027 656d 6462 273a  tform == 'emdb':
-0003e310: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
-0003e320: 7274 203d 2074 696d 6569 742e 6465 6661  rt = timeit.defa
-0003e330: 756c 745f 7469 6d65 7228 290a 2020 2020  ult_timer().    
-0003e340: 2020 2020 2020 2020 6572 726c 6973 7420          errlist 
-0003e350: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
-0003e360: 2066 696e 616c 6469 6374 203d 207b 7d0a   finaldict = {}.
-0003e370: 2020 2020 2020 2020 2020 2020 7379 6d6d              symm
-0003e380: 6574 7279 5265 7320 3d20 4661 6c73 650a  etryRes = False.
-0003e390: 2020 2020 2020 2020 2020 2020 7265 7366              resf
-0003e3a0: 6163 746f 7220 3d20 312e 300a 2020 2020  actor = 1.0.    
-0003e3b0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-0003e3c0: 6d65 7420 6973 206e 6f74 204e 6f6e 6520  met is not None 
-0003e3d0: 616e 6420 7365 6c66 2e72 6573 6f6c 7574  and self.resolut
-0003e3e0: 696f 6e20 6973 206e 6f74 204e 6f6e 653a  ion is not None:
-0003e3f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003e400: 2069 6620 7365 6c66 2e6d 6574 2021 3d20   if self.met != 
-0003e410: 2774 6f6d 6f27 2061 6e64 2073 656c 662e  'tomo' and self.
-0003e420: 6d65 7420 213d 2027 6865 6c69 273a 0a20  met != 'heli':. 
-0003e430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e440: 2020 2070 726f 7368 6164 6520 3d20 4661     proshade = Fa
-0003e450: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
-0003e460: 2020 2020 2020 2020 6966 2050 524f 5348          if PROSH
-0003e470: 4144 4550 4154 483a 0a20 2020 2020 2020  ADEPATH:.       
-0003e480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e490: 2070 726f 7368 6164 6570 6174 6820 3d20   proshadepath = 
-0003e4a0: 5052 4f53 4841 4445 5041 5448 0a20 2020  PROSHADEPATH.   
-0003e4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e4c0: 2020 2020 2070 726f 7368 6164 6520 3d20       proshade = 
-0003e4d0: 5472 7565 0a0a 2020 2020 2020 2020 2020  True..          
-0003e4e0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0003e4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e500: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0003e510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e520: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0003e530: 6669 6e64 5f65 7865 6375 7461 626c 6528  find_executable(
-0003e540: 2770 726f 7368 6164 6527 2920 6973 206e  'proshade') is n
-0003e550: 6f74 204e 6f6e 650a 2020 2020 2020 2020  ot None.        
-0003e560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e570: 2020 2020 7072 6f73 6861 6465 7061 7468      proshadepath
-0003e580: 203d 2066 696e 645f 6578 6563 7574 6162   = find_executab
-0003e590: 6c65 2827 7072 6f73 6861 6465 2729 0a20  le('proshade'). 
-0003e5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e5b0: 2020 2020 2020 2020 2020 2070 726f 7368             prosh
-0003e5c0: 6164 6520 3d20 5472 7565 0a20 2020 2020  ade = True.     
-0003e5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e5e0: 2020 2065 7863 6570 7420 4173 7365 7274     except Assert
-0003e5f0: 696f 6e45 7272 6f72 3a0a 2020 2020 2020  ionError:.      
-0003e600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e610: 2020 2020 2020 7379 732e 7374 6465 7272        sys.stderr
-0003e620: 2e77 7269 7465 2827 7072 6f73 6861 6465  .write('proshade
-0003e630: 2065 7865 6375 7461 626c 6520 6973 206e   executable is n
-0003e640: 6f74 2074 6865 7265 2c20 706c 6561 7365  ot there, please
-0003e650: 2069 6e73 7461 6c6c 2070 726f 7368 6164   install proshad
-0003e660: 652e 5c6e 2729 0a20 2020 2020 2020 2020  e.\n').         
-0003e670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e680: 2020 2073 7973 2e73 7464 6572 722e 7772     sys.stderr.wr
-0003e690: 6974 6528 2753 796d 6d65 7472 7920 696e  ite('Symmetry in
-0003e6a0: 666f 726d 6174 696f 6e20 7769 6c6c 206e  formation will n
-0003e6b0: 6f74 2062 6520 7072 6f64 7563 6564 2e5c  ot be produced.\
-0003e6c0: 6e27 290a 0a20 2020 2020 2020 2020 2020  n')..           
-0003e6d0: 2020 2020 2020 2020 2069 6620 7072 6f73           if pros
-0003e6e0: 6861 6465 3a0a 2020 2020 2020 2020 2020  hade:.          
-0003e6f0: 2020 2020 2020 2020 2020 2020 2020 7472                tr
-0003e700: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-0003e710: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0003e720: 756c 6c6d 6170 7061 7468 203d 2027 7b7d  ullmappath = '{}
-0003e730: 7b7d 272e 666f 726d 6174 2873 656c 662e  {}'.format(self.
-0003e740: 776f 726b 6469 722c 2073 656c 662e 6d61  workdir, self.ma
-0003e750: 706e 616d 6529 0a20 2020 2020 2020 2020  pname).         
-0003e760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e770: 2020 2069 6620 2763 6370 656d 2720 6e6f     if 'ccpem' no
-0003e780: 7420 696e 2050 524f 5348 4144 4550 4154  t in PROSHADEPAT
-0003e790: 483a 0a20 2020 2020 2020 2020 2020 2020  H:.             
-0003e7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e7b0: 2020 2023 2063 6d64 203d 206c 6973 7428     # cmd = list(
-0003e7c0: 2850 524f 5348 4144 4550 4154 4820 2b20  (PROSHADEPATH + 
-0003e7d0: 2720 2d53 202d 6620 2720 2b20 7365 6c66  ' -S -f ' + self
-0003e7e0: 2e6d 6170 2e66 696c 656e 616d 6520 2b20  .map.filename + 
-0003e7f0: 2720 2d73 2027 202b 2073 7472 2866 6c6f  ' -s ' + str(flo
-0003e800: 6174 2873 656c 662e 7265 736f 6c75 7469  at(self.resoluti
-0003e810: 6f6e 2920 2a20 7265 7366 6163 746f 7229  on) * resfactor)
-0003e820: 292e 7370 6c69 7428 2720 2729 290a 2020  ).split(' ')).  
-0003e830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e840: 2020 2020 2020 2020 2020 2020 2020 636d                cm
-0003e850: 6420 3d20 6c69 7374 2828 5052 4f53 4841  d = list((PROSHA
-0003e860: 4445 5041 5448 202b 2027 202d 5320 2d66  DEPATH + ' -S -f
-0003e870: 2027 202b 2073 656c 662e 6d61 702e 6675   ' + self.map.fu
-0003e880: 6c6c 6e61 6d65 202b 2027 202d 7320 2720  llname + ' -s ' 
-0003e890: 2b20 7374 7228 666c 6f61 7428 7365 6c66  + str(float(self
-0003e8a0: 2e72 6573 6f6c 7574 696f 6e29 202a 2072  .resolution) * r
-0003e8b0: 6573 6661 6374 6f72 2929 2e73 706c 6974  esfactor)).split
-0003e8c0: 2827 2027 2929 0a20 2020 2020 2020 2020  (' ')).         
-0003e8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e8e0: 2020 2020 2020 2070 7269 6e74 2863 6d64         print(cmd
-0003e8f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0003e900: 2020 2020 2020 2020 2020 2020 2020 656c                el
-0003e910: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0003e920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e930: 2020 2020 7368 6172 6569 6e64 6578 203d      shareindex =
-0003e940: 205b 6964 7820 666f 7220 6964 782c 2073   [idx for idx, s
-0003e950: 2069 6e20 656e 756d 6572 6174 6528 5052   in enumerate(PR
-0003e960: 4f53 4841 4445 5041 5448 2e73 706c 6974  OSHADEPATH.split
-0003e970: 2827 2f27 2929 2069 6620 2763 6370 656d  ('/')) if 'ccpem
-0003e980: 2d27 2069 6e20 735d 5b30 5d20 2b20 310a  -' in s][0] + 1.
-0003e990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e9b0: 6265 666f 7265 7368 6172 6520 3d20 272f  beforeshare = '/
-0003e9c0: 272e 6a6f 696e 2850 524f 5348 4144 4550  '.join(PROSHADEP
-0003e9d0: 4154 482e 7370 6c69 7428 272f 2729 5b3a  ATH.split('/')[:
-0003e9e0: 7368 6172 6569 6e64 6578 5d29 0a20 2020  shareindex]).   
-0003e9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ea00: 2020 2020 2020 2020 2020 2020 2072 7670               rvp
-0003ea10: 6174 6820 3d20 277b 7d2f 7368 6172 6527  ath = '{}/share'
-0003ea20: 2e66 6f72 6d61 7428 6265 666f 7265 7368  .format(beforesh
-0003ea30: 6172 6529 0a20 2020 2020 2020 2020 2020  are).           
-0003ea40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ea50: 2020 2020 2023 2063 6d64 203d 206c 6973       # cmd = lis
-0003ea60: 7428 2850 524f 5348 4144 4550 4154 4820  t((PROSHADEPATH 
-0003ea70: 2b20 2720 2d53 202d 6620 2720 2b20 7365  + ' -S -f ' + se
-0003ea80: 6c66 2e6d 6170 2e66 696c 656e 616d 6520  lf.map.filename 
-0003ea90: 2b20 2720 2d73 2027 202b 2073 7472 2866  + ' -s ' + str(f
-0003eaa0: 6c6f 6174 2873 656c 662e 7265 736f 6c75  loat(self.resolu
-0003eab0: 7469 6f6e 292a 312e 3529 202b 2027 202d  tion)*1.5) + ' -
-0003eac0: 2d72 7670 6174 6820 2720 2b20 7276 7061  -rvpath ' + rvpa
-0003ead0: 7468 292e 7370 6c69 7428 2720 2729 290a  th).split(' ')).
-0003eae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003eaf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003eb00: 636d 6420 3d20 6c69 7374 2828 5052 4f53  cmd = list((PROS
-0003eb10: 4841 4445 5041 5448 202b 2027 202d 5320  HADEPATH + ' -S 
-0003eb20: 2d66 2027 202b 2073 656c 662e 6d61 702e  -f ' + self.map.
-0003eb30: 6675 6c6c 6e61 6d65 202b 2027 202d 7320  fullname + ' -s 
-0003eb40: 2720 2b20 7374 7228 666c 6f61 7428 7365  ' + str(float(se
-0003eb50: 6c66 2e72 6573 6f6c 7574 696f 6e29 202a  lf.resolution) *
-0003eb60: 2031 2e30 2920 2b20 2720 2d2d 7276 7061   1.0) + ' --rvpa
-0003eb70: 7468 2027 202b 2072 7670 6174 6829 2e73  th ' + rvpath).s
-0003eb80: 706c 6974 2827 2027 2929 0a20 2020 2020  plit(' ')).     
-0003eb90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003eba0: 2020 2020 2020 2070 7269 6e74 2827 5379         print('Sy
-0003ebb0: 6d6d 6574 7279 2063 6f6d 6d61 6e64 3a20  mmetry command: 
-0003ebc0: 7b7d 272e 666f 726d 6174 2827 2027 2e6a  {}'.format(' '.j
-0003ebd0: 6f69 6e28 636d 6429 2929 0a0a 2020 2020  oin(cmd)))..    
-0003ebe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ebf0: 2020 2020 2020 2020 2320 7072 6f63 6573          # proces
-0003ec00: 7320 3d20 7375 6270 726f 6365 7373 2e50  s = subprocess.P
-0003ec10: 6f70 656e 2863 6d64 2c20 7374 646f 7574  open(cmd, stdout
-0003ec20: 3d73 7562 7072 6f63 6573 732e 5049 5045  =subprocess.PIPE
-0003ec30: 2c20 7374 6465 7272 3d73 7562 7072 6f63  , stderr=subproc
-0003ec40: 6573 732e 5354 444f 5554 290a 2020 2020  ess.STDOUT).    
-0003ec50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ec60: 2020 2020 2020 2020 2320 636f 6465 203d          # code =
-0003ec70: 2070 726f 6365 7373 2e77 6169 7428 290a   process.wait().
-0003ec80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ec90: 2020 2020 2020 2020 2020 2020 2320 6f75              # ou
-0003eca0: 7470 7574 203d 2070 726f 6365 7373 2e73  tput = process.s
-0003ecb0: 7464 6f75 742e 7265 6164 2829 0a0a 2020  tdout.read()..  
-0003ecc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ecd0: 2020 2020 2020 2020 2020 7072 6f63 6573            proces
-0003ece0: 7320 3d20 7375 6270 726f 6365 7373 2e50  s = subprocess.P
-0003ecf0: 6f70 656e 2863 6d64 2c20 7374 646f 7574  open(cmd, stdout
-0003ed00: 3d73 7562 7072 6f63 6573 732e 5049 5045  =subprocess.PIPE
-0003ed10: 2c20 7374 6465 7272 3d73 7562 7072 6f63  , stderr=subproc
-0003ed20: 6573 732e 5354 444f 5554 2c20 6377 643d  ess.STDOUT, cwd=
-0003ed30: 7365 6c66 2e77 6f72 6b64 6972 290a 2020  self.workdir).  
-0003ed40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ed50: 2020 2020 2020 2020 2020 6f75 7470 7574            output
-0003ed60: 203d 2070 726f 6365 7373 2e63 6f6d 6d75   = process.commu
-0003ed70: 6e69 6361 7465 2827 6e5c 6e27 295b 305d  nicate('n\n')[0]
-0003ed80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003ed90: 2020 2020 2020 2020 2020 2020 2065 7272               err
-0003eda0: 7072 6f73 6861 6465 203d 2027 2121 2120  proshade = '!!! 
-0003edb0: 5072 6f53 4841 4445 2045 5252 4f52 2021  ProSHADE ERROR !
-0003edc0: 2121 270a 0a20 2020 2020 2020 2020 2020  !!'..           
-0003edd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ede0: 2023 2046 6f72 2070 7974 686f 6e33 206d   # For python3 m
-0003edf0: 6967 7261 7469 6f6e 2074 6f20 7079 7468  igration to pyth
-0003ee00: 6f6e 3320 7769 7468 2064 6563 6f64 6520  on3 with decode 
-0003ee10: 7072 6f62 6c65 6d20 6f66 2073 7472 696e  problem of strin
-0003ee20: 6720 746f 2062 7974 6573 0a20 2020 2020  g to bytes.     
-0003ee30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ee40: 2020 2020 2020 2069 6620 7379 732e 7665         if sys.ve
-0003ee50: 7273 696f 6e5f 696e 666f 5b30 5d20 3e3d  rsion_info[0] >=
-0003ee60: 2033 3a0a 2020 2020 2020 2020 2020 2020   3:.            
-0003ee70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ee80: 2020 2020 666f 7220 6974 656d 2069 6e20      for item in 
-0003ee90: 6f75 7470 7574 2e64 6563 6f64 6528 2775  output.decode('u
-0003eea0: 7466 2d38 2729 2e73 706c 6974 2827 5c6e  tf-8').split('\n
-0003eeb0: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
-0003eec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003eed0: 2020 2020 2020 2020 2320 6974 656d 203d          # item =
-0003eee0: 2063 6c69 6e65 2e64 6563 6f64 6528 2775   cline.decode('u
-0003eef0: 7466 2d38 2729 2e73 7472 6970 2829 0a20  tf-8').strip(). 
-0003ef00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ef10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ef20: 2020 2070 7269 6e74 2869 7465 6d29 0a20     print(item). 
-0003ef30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ef40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ef50: 2020 2069 6620 6572 7270 726f 7368 6164     if errproshad
-0003ef60: 6520 696e 2069 7465 6d3a 0a20 2020 2020  e in item:.     
-0003ef70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ef80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ef90: 2020 2065 7272 6c69 6e65 203d 2069 7465     errline = ite
-0003efa0: 6d2e 7374 7269 7028 290a 2020 2020 2020  m.strip().      
+000394f0: 6669 6e61 6c64 6963 745b 276c 6f61 645f  finaldict['load_
+00039500: 6673 6327 5d20 3d20 7b27 6572 7227 3a20  fsc'] = {'err': 
+00039510: 7b27 6c6f 6164 5f66 7363 5f65 7272 273a  {'load_fsc_err':
+00039520: 2065 7272 6c69 7374 7d7d 0a0a 2020 2020   errlist}}..    
+00039530: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00039540: 2020 2020 2020 2020 2020 2020 2077 6974               wit
+00039550: 6820 636f 6465 6373 2e6f 7065 6e28 7365  h codecs.open(se
+00039560: 6c66 2e77 6f72 6b64 6972 202b 2073 656c  lf.workdir + sel
+00039570: 662e 6d61 706e 616d 6520 2b20 275f 6c6f  f.mapname + '_lo
+00039580: 6164 6673 632e 6a73 6f6e 272c 2027 7727  adfsc.json', 'w'
+00039590: 2c20 656e 636f 6469 6e67 3d27 7574 662d  , encoding='utf-
+000395a0: 3827 2920 6173 2066 3a0a 2020 2020 2020  8') as f:.      
+000395b0: 2020 2020 2020 2020 2020 2020 2020 6a73                js
+000395c0: 6f6e 2e64 756d 7028 6669 6e61 6c64 6963  on.dump(finaldic
+000395d0: 742c 2066 290a 0a20 2020 2020 2020 2020  t, f)..         
+000395e0: 2020 2020 2020 2072 6574 7572 6e20 4e6f         return No
+000395f0: 6e65 0a20 2020 2020 2020 2020 2020 2065  ne.            e
+00039600: 7863 6570 743a 0a20 2020 2020 2020 2020  xcept:.         
+00039610: 2020 2020 2020 2073 7973 2e73 7464 6572         sys.stder
+00039620: 722e 7772 6974 6528 2753 6176 696e 6720  r.write('Saving 
+00039630: 6c6f 6164 6564 2046 5343 2074 6f20 6a73  loaded FSC to js
+00039640: 6f6e 2065 7272 6f72 3a7b 7d2e 5c6e 272e  on error:{}.\n'.
+00039650: 666f 726d 6174 2873 7973 2e65 7863 5f69  format(sys.exc_i
+00039660: 6e66 6f28 295b 315d 2929 0a20 2020 2020  nfo()[1])).     
+00039670: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00039680: 2020 2020 2070 7269 6e74 2827 4e6f 2066       print('No f
+00039690: 7363 2e78 6d6c 2066 696c 6520 6361 6e20  sc.xml file can 
+000396a0: 6265 2072 6561 6420 666f 7220 4653 4320  be read for FSC 
+000396b0: 696e 666f 726d 6174 696f 6e2e 2729 0a0a  information.')..
+000396c0: 0a20 2020 2023 2040 7072 6f66 696c 650a  .    # @profile.
+000396d0: 2020 2020 6465 6620 6673 6328 7365 6c66      def fsc(self
+000396e0: 2c20 6d61 706f 6464 2c20 6d61 7065 7665  , mapodd, mapeve
+000396f0: 6e2c 2061 7379 6d3d 312e 302c 206c 6162  n, asym=1.0, lab
+00039700: 656c 3d27 2729 3a0a 2020 2020 2020 2020  el=''):.        
+00039710: 2222 220a 0a20 2020 2020 2020 2020 2020  """..           
+00039720: 2043 616c 6375 6c61 7465 2046 5343 2062   Calculate FSC b
+00039730: 6173 6564 206f 6e20 7468 6520 7477 6f20  ased on the two 
+00039740: 696e 7075 7420 6861 6c66 206d 6170 730a  input half maps.
+00039750: 2020 2020 2020 2020 2020 2020 5265 7375              Resu
+00039760: 6c74 7320 7772 6f74 6520 746f 204a 534f  lts wrote to JSO
+00039770: 4e20 6669 6c65 2069 6e63 6c75 6469 6e67  N file including
+00039780: 2072 6573 6f6c 7574 696f 6e20 6174 2030   resolution at 0
+00039790: 2e31 3433 2c20 302e 3333 332c 2030 2e35  .143, 0.333, 0.5
+000397a0: 2061 6e64 206e 6f69 7365 0a20 2020 2020   and noise.     
+000397b0: 2020 2020 2020 206c 6576 656c 2061 7420         level at 
+000397c0: 302e 352d 6269 742c 2031 2d62 6974 2c20  0.5-bit, 1-bit, 
+000397d0: 332d 7369 676d 612e 2041 2063 6f72 7265  3-sigma. A corre
+000397e0: 7370 6f6e 6469 6e67 2070 6c6f 7420 6973  sponding plot is
+000397f0: 2061 6c73 6f20 7361 7665 2061 7320 504e   also save as PN
+00039800: 4720 6669 6c65 2e0a 0a20 2020 2020 2020  G file...       
+00039810: 203a 7061 7261 6d20 6d61 706f 6464 3a20   :param mapodd: 
+00039820: 5445 4d50 7920 6d61 7020 696e 7374 616e  TEMPy map instan
+00039830: 6365 0a20 2020 2020 2020 203a 7061 7261  ce.        :para
+00039840: 6d20 6d61 7065 7665 6e3a 2054 454d 5079  m mapeven: TEMPy
+00039850: 206d 6170 2069 6e73 7461 6e63 650a 2020   map instance.  
+00039860: 2020 2020 2020 3a72 6574 7572 6e3a 204e        :return: N
+00039870: 6f6e 650a 0a20 2020 2020 2020 2022 2222  one..        """
+00039880: 0a0a 2020 2020 2020 2020 7374 6172 7420  ..        start 
+00039890: 3d20 7469 6d65 6974 2e64 6566 6175 6c74  = timeit.default
+000398a0: 5f74 696d 6572 2829 0a20 2020 2020 2020  _timer().       
+000398b0: 2065 7272 6c69 7374 203d 205b 5d0a 2020   errlist = [].  
+000398c0: 2020 2020 2020 6461 7461 6469 6374 203d        datadict =
+000398d0: 2064 6963 7428 290a 2020 2020 2020 2020   dict().        
+000398e0: 6669 6e61 6c64 6963 7420 3d20 6469 6374  finaldict = dict
+000398f0: 2829 0a20 2020 2020 2020 2074 7279 3a0a  ().        try:.
+00039900: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00039910: 7274 206d 6170 6f64 642e 6461 7461 2e73  rt mapodd.data.s
+00039920: 6861 7065 203d 3d20 6d61 7065 7665 6e2e  hape == mapeven.
+00039930: 6461 7461 2e73 6861 7065 2c20 2754 6865  data.shape, 'The
+00039940: 2074 776f 2068 616c 6620 6d61 7073 2064   two half maps d
+00039950: 6f20 6e6f 7420 6861 7665 2073 616d 6520  o not have same 
+00039960: 7369 7a65 2e27 0a20 2020 2020 2020 2020  size.'.         
+00039970: 2020 2061 7373 6572 7420 6d61 706f 6464     assert mapodd
+00039980: 2e76 6f78 656c 5f73 697a 6520 3d3d 206d  .voxel_size == m
+00039990: 6170 6576 656e 2e76 6f78 656c 5f73 697a  apeven.voxel_siz
+000399a0: 652c 2027 5468 6520 7477 6f20 6861 6c66  e, 'The two half
+000399b0: 206d 6170 7320 646f 206e 6f74 2068 6176   maps do not hav
+000399c0: 6520 7361 6d65 2061 7069 782e 270a 2020  e same apix.'.  
+000399d0: 2020 2020 2020 2020 2020 6f64 646e 616e            oddnan
+000399e0: 203d 206e 702e 6973 6e61 6e28 6d61 706f   = np.isnan(mapo
+000399f0: 6464 2e64 6174 6129 2e61 6e79 2829 0a20  dd.data).any(). 
+00039a00: 2020 2020 2020 2020 2020 2065 7665 6e6e             evenn
+00039a10: 616e 203d 206e 702e 6973 6e61 6e28 6d61  an = np.isnan(ma
+00039a20: 7065 7665 6e2e 6461 7461 292e 616e 7928  peven.data).any(
+00039a30: 290a 2020 2020 2020 2020 2020 2020 6e61  ).            na
+00039a40: 6e63 6865 636b 203d 206f 6464 6e61 6e20  ncheck = oddnan 
+00039a50: 7c20 6576 656e 6e61 6e0a 2020 2020 2020  | evennan.      
+00039a60: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
+00039a70: 206e 616e 6368 6563 6b2c 2027 5468 6572   nancheck, 'Ther
+00039a80: 6520 6973 204e 614e 2076 616c 7565 2069  e is NaN value i
+00039a90: 6e20 6861 6c66 206d 6170 2e27 0a0a 2020  n half map.'..  
+00039aa0: 2020 2020 2020 2020 2020 6d61 705f 7a73            map_zs
+00039ab0: 697a 6520 3d20 6d61 706f 6464 2e68 6561  ize = mapodd.hea
+00039ac0: 6465 722e 6e7a 0a20 2020 2020 2020 2020  der.nz.         
+00039ad0: 2020 206d 6170 5f79 7369 7a65 203d 206d     map_ysize = m
+00039ae0: 6170 6f64 642e 6865 6164 6572 2e6e 790a  apodd.header.ny.
+00039af0: 2020 2020 2020 2020 2020 2020 6d61 705f              map_
+00039b00: 7873 697a 6520 3d20 6d61 706f 6464 2e68  xsize = mapodd.h
+00039b10: 6561 6465 722e 6e78 0a0a 2020 2020 2020  eader.nx..      
+00039b20: 2020 2020 2020 6170 6978 7320 3d20 7475        apixs = tu
+00039b30: 706c 6528 6d61 706f 6464 2e76 6f78 656c  ple(mapodd.voxel
+00039b40: 5f73 697a 652e 746f 6c69 7374 2829 290a  _size.tolist()).
+00039b50: 0a20 2020 2020 2020 2020 2020 206d 6170  .            map
+00039b60: 6f64 645f 6461 7461 203d 2066 6674 7368  odd_data = fftsh
+00039b70: 6966 7428 6666 746e 286d 6170 6f64 642e  ift(fftn(mapodd.
+00039b80: 6461 7461 2929 0a20 2020 2020 2020 2020  data)).         
+00039b90: 2020 206d 6170 6576 656e 5f64 6174 6120     mapeven_data 
+00039ba0: 3d20 6666 7473 6869 6674 2866 6674 6e28  = fftshift(fftn(
+00039bb0: 6d61 7065 7665 6e2e 6461 7461 2929 0a0a  mapeven.data))..
+00039bc0: 2020 2020 2020 2020 2020 2020 7374 6172              star
+00039bd0: 7420 3d20 7469 6d65 6974 2e64 6566 6175  t = timeit.defau
+00039be0: 6c74 5f74 696d 6572 2829 202d 2073 7461  lt_timer() - sta
+00039bf0: 7274 0a20 2020 2020 2020 2020 2020 2070  rt.            p
+00039c00: 7269 6e74 2827 202d 2d20 4653 4320 466f  rint(' -- FSC Fo
+00039c10: 7572 6965 722d 7472 616e 7366 6f72 6d61  urier-transforma
+00039c20: 7469 6f6e 2074 696d 653a 2025 7327 2025  tion time: %s' %
+00039c30: 2073 7461 7274 290a 0a20 2020 2020 2020   start)..       
+00039c40: 2020 2020 2023 2047 7269 6420 6865 7265       # Grid here
+00039c50: 2074 6f20 6765 6e65 7261 7465 2066 6f72   to generate for
+00039c60: 2074 7261 6369 6e67 2074 6865 2069 6e64   tracing the ind
+00039c70: 6963 6573 206f 6620 6772 6964 7320 7769  ices of grids wi
+00039c80: 7468 2069 6e20 7468 6520 7368 656c 6c73  th in the shells
+00039c90: 2e0a 2020 2020 2020 2020 2020 2020 7a67  ..            zg
+00039ca0: 7269 6420 3d20 6e70 2e61 7261 6e67 6528  rid = np.arange(
+00039cb0: 666c 6f6f 7228 6d61 705f 7a73 697a 6520  floor(map_zsize 
+00039cc0: 2f20 322e 3029 202a 202d 312c 2063 6569  / 2.0) * -1, cei
+00039cd0: 6c28 6d61 705f 7a73 697a 6520 2f20 322e  l(map_zsize / 2.
+00039ce0: 3029 2920 2f20 666c 6f61 7428 0a20 2020  0)) / float(.   
+00039cf0: 2020 2020 2020 2020 2020 2020 2066 6c6f               flo
+00039d00: 6f72 286d 6170 5f7a 7369 7a65 2929 0a20  or(map_zsize)). 
+00039d10: 2020 2020 2020 2020 2020 2079 6772 6964             ygrid
+00039d20: 203d 206e 702e 6172 616e 6765 2866 6c6f   = np.arange(flo
+00039d30: 6f72 286d 6170 5f79 7369 7a65 202f 2032  or(map_ysize / 2
+00039d40: 2e30 2920 2a20 2d31 2c20 6365 696c 286d  .0) * -1, ceil(m
+00039d50: 6170 5f79 7369 7a65 202f 2032 2e30 2929  ap_ysize / 2.0))
+00039d60: 202f 2066 6c6f 6174 280a 2020 2020 2020   / float(.      
+00039d70: 2020 2020 2020 2020 2020 666c 6f6f 7228            floor(
+00039d80: 6d61 705f 7973 697a 6529 290a 2020 2020  map_ysize)).    
+00039d90: 2020 2020 2020 2020 7867 7269 6420 3d20          xgrid = 
+00039da0: 6e70 2e61 7261 6e67 6528 666c 6f6f 7228  np.arange(floor(
+00039db0: 6d61 705f 7873 697a 6520 2f20 322e 3029  map_xsize / 2.0)
+00039dc0: 202a 202d 312c 2063 6569 6c28 6d61 705f   * -1, ceil(map_
+00039dd0: 7873 697a 6520 2f20 322e 3029 2920 2f20  xsize / 2.0)) / 
+00039de0: 666c 6f61 7428 0a20 2020 2020 2020 2020  float(.         
+00039df0: 2020 2020 2020 2066 6c6f 6f72 286d 6170         floor(map
+00039e00: 5f78 7369 7a65 2929 0a20 2020 2020 2020  _xsize)).       
+00039e10: 2020 2020 2078 6469 7320 3d20 7867 7269       xdis = xgri
+00039e20: 6420 2a2a 2032 0a20 2020 2020 2020 2020  d ** 2.         
+00039e30: 2020 2079 6469 7320 3d20 7967 7269 6420     ydis = ygrid 
+00039e40: 2a2a 2032 0a20 2020 2020 2020 2020 2020  ** 2.           
+00039e50: 207a 6469 7320 3d20 7a67 7269 6420 2a2a   zdis = zgrid **
+00039e60: 2032 0a20 2020 2020 2020 2020 2020 2064   2.            d
+00039e70: 6973 7420 3d20 6e70 2e73 7172 7428 7a64  ist = np.sqrt(zd
+00039e80: 6973 5b3a 2c20 4e6f 6e65 2c20 4e6f 6e65  is[:, None, None
+00039e90: 5d20 2b20 7964 6973 5b3a 2c20 4e6f 6e65  ] + ydis[:, None
+00039ea0: 5d20 2b20 7864 6973 290a 0a20 2020 2020  ] + xdis)..     
+00039eb0: 2020 2020 2020 2061 6c6c 6178 6973 203d         allaxis =
+00039ec0: 206e 702e 6172 7261 7928 5b7a 6772 6964   np.array([zgrid
+00039ed0: 2c20 7967 7269 642c 2078 6772 6964 5d29  , ygrid, xgrid])
+00039ee0: 0a20 2020 2020 2020 2020 2020 2074 6d70  .            tmp
+00039ef0: 696e 6469 6178 6973 203d 206d 6178 2861  indiaxis = max(a
+00039f00: 6c6c 6178 6973 2c20 6b65 793d 6c65 6e29  llaxis, key=len)
+00039f10: 0a20 2020 2020 2020 2020 2020 2069 6e64  .            ind
+00039f20: 6961 7869 7374 203d 2074 6d70 696e 6469  iaxist = tmpindi
+00039f30: 6178 6973 5b74 6d70 696e 6469 6178 6973  axis[tmpindiaxis
+00039f40: 203e 3d20 305d 0a20 2020 2020 2020 2020   >= 0].         
+00039f50: 2020 206c 696e 6469 203d 206c 656e 2869     lindi = len(i
+00039f60: 6e64 6961 7869 7374 290a 2020 2020 2020  ndiaxist).      
+00039f70: 2020 2020 2020 6966 2074 7970 6528 6170        if type(ap
+00039f80: 6978 7329 2069 7320 7475 706c 653a 0a20  ixs) is tuple:. 
+00039f90: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00039fa0: 6170 6978 203d 2061 7069 7873 5b30 5d0a  apix = apixs[0].
+00039fb0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00039fc0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00039fd0: 2020 7461 7069 7820 3d20 6170 6978 730a    tapix = apixs.
+00039fe0: 2020 2020 2020 2020 2020 2020 696e 6469              indi
+00039ff0: 6178 6973 203d 206e 702e 6c69 6e73 7061  axis = np.linspa
+0003a000: 6365 2830 2c20 3120 2f20 2832 202a 2074  ce(0, 1 / (2 * t
+0003a010: 6170 6978 292c 206c 696e 6469 290a 0a20  apix), lindi).. 
+0003a020: 2020 2020 2020 2020 2020 2023 204c 6f6f             # Loo
+0003a030: 7069 6e67 2074 6872 6f75 6768 2061 6c6c  ping through all
+0003a040: 2073 6865 6c6c 730a 2020 2020 2020 2020   shells.        
+0003a050: 2020 2020 636f 7272 6c69 7374 203d 205b      corrlist = [
+0003a060: 5d0a 2020 2020 2020 2020 2020 2020 7468  ].            th
+0003a070: 7265 6573 6967 203d 205b 5d0a 2020 2020  reesig = [].    
+0003a080: 2020 2020 2020 2020 6861 6c66 6269 7420          halfbit 
+0003a090: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
+0003a0a0: 206f 6e65 6269 7420 3d20 5b5d 0a20 2020   onebit = [].   
+0003a0b0: 2020 2020 2020 2020 2066 6f72 2069 2069           for i i
+0003a0c0: 6e20 7261 6e67 6528 6c65 6e28 696e 6469  n range(len(indi
+0003a0d0: 6178 6973 2929 3a0a 2020 2020 2020 2020  axis)):.        
+0003a0e0: 2020 2020 2020 2020 6966 2069 203d 3d20          if i == 
+0003a0f0: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+0003a100: 2020 2020 2020 2069 6e64 6963 6573 203d         indices =
+0003a110: 206e 702e 6172 6777 6865 7265 2864 6973   np.argwhere(dis
+0003a120: 7420 3d3d 2069 6e64 6961 7869 735b 695d  t == indiaxis[i]
+0003a130: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0003a140: 2020 2020 2020 6f64 6472 696e 6720 3d20        oddring = 
+0003a150: 6d61 706f 6464 5f64 6174 615b 7475 706c  mapodd_data[tupl
+0003a160: 6528 696e 6469 6365 732e 5429 5d0a 2020  e(indices.T)].  
+0003a170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a180: 2020 6576 656e 7269 6e67 203d 206d 6170    evenring = map
+0003a190: 6576 656e 5f64 6174 615b 7475 706c 6528  even_data[tuple(
+0003a1a0: 696e 6469 6365 732e 5429 5d0a 0a20 2020  indices.T)]..   
+0003a1b0: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
+0003a1c0: 6620 6920 213d 206c 656e 2869 6e64 6961  f i != len(india
+0003a1d0: 7869 7329 202d 2031 3a0a 2020 2020 2020  xis) - 1:.      
+0003a1e0: 2020 2020 2020 2020 2020 2020 2020 696e                in
+0003a1f0: 6469 6365 7320 3d20 6e70 2e61 7267 7768  dices = np.argwh
+0003a200: 6572 6528 2864 6973 7420 3e20 696e 6469  ere((dist > indi
+0003a210: 6178 6973 745b 695d 2920 2620 2864 6973  axist[i]) & (dis
+0003a220: 7420 3c3d 2069 6e64 6961 7869 7374 5b69  t <= indiaxist[i
+0003a230: 202b 2031 5d29 290a 2020 2020 2020 2020   + 1])).        
+0003a240: 2020 2020 2020 2020 2020 2020 6f64 6472              oddr
+0003a250: 696e 6720 3d20 6d61 706f 6464 5f64 6174  ing = mapodd_dat
+0003a260: 615b 7475 706c 6528 696e 6469 6365 732e  a[tuple(indices.
+0003a270: 5429 5d0a 2020 2020 2020 2020 2020 2020  T)].            
+0003a280: 2020 2020 2020 2020 6576 656e 7269 6e67          evenring
+0003a290: 203d 206d 6170 6576 656e 5f64 6174 615b   = mapeven_data[
+0003a2a0: 7475 706c 6528 696e 6469 6365 732e 5429  tuple(indices.T)
+0003a2b0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0003a2c0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0003a2d0: 2020 2020 2020 2020 2020 2020 7061 7373              pass
+0003a2e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003a2f0: 2063 6f72 7220 3d20 286f 6464 7269 6e67   corr = (oddring
+0003a300: 202a 206e 702e 636f 6e6a 2865 7665 6e72   * np.conj(evenr
+0003a310: 696e 6729 292e 7375 6d28 290a 2020 2020  ing)).sum().    
+0003a320: 2020 2020 2020 2020 2020 2020 636f 7272              corr
+0003a330: 5f64 656e 6f20 3d20 6e70 2e73 7172 7428  _deno = np.sqrt(
+0003a340: 286e 702e 6162 7328 6f64 6472 696e 6729  (np.abs(oddring)
+0003a350: 202a 2a20 3229 2e73 756d 2829 202a 2028   ** 2).sum() * (
+0003a360: 6e70 2e61 6273 2865 7665 6e72 696e 6729  np.abs(evenring)
+0003a370: 202a 2a20 3229 2e73 756d 2829 290a 2020   ** 2).sum()).  
+0003a380: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0003a390: 2063 6f72 725f 6465 6e6f 203d 3d20 302e   corr_deno == 0.
+0003a3a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003a3b0: 2020 2020 2020 6e6f 7263 6f72 7220 3d20        norcorr = 
+0003a3c0: 302e 0a20 2020 2020 2020 2020 2020 2020  0..             
+0003a3d0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0003a3e0: 2020 2020 2020 2020 2020 2020 206e 6f72               nor
+0003a3f0: 636f 7272 203d 206e 702e 7265 616c 2863  corr = np.real(c
+0003a400: 6f72 7220 2f20 636f 7272 5f64 656e 6f29  orr / corr_deno)
+0003a410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003a420: 2063 6f72 726c 6973 742e 6170 7065 6e64   corrlist.append
+0003a430: 286e 6f72 636f 7272 290a 0a20 2020 2020  (norcorr)..     
+0003a440: 2020 2020 2020 2020 2020 2076 6f6c 756d             volum
+0003a450: 6564 6966 6620 3d20 2834 2e30 202f 2033  ediff = (4.0 / 3
+0003a460: 2e30 2920 2a20 7069 202a 2028 2869 202b  .0) * pi * ((i +
+0003a470: 2031 2920 2a2a 2033 202d 2069 202a 2a20   1) ** 3 - i ** 
+0003a480: 3329 0a20 2020 2020 2020 2020 2020 2020  3).             
+0003a490: 2020 206e 766f 7872 696e 6720 3d20 766f     nvoxring = vo
+0003a4a0: 6c75 6d65 6469 6666 202f 2028 3120 2a2a  lumediff / (1 **
+0003a4b0: 2033 290a 2020 2020 2020 2020 2020 2020   3).            
+0003a4c0: 2020 2020 6566 666e 766f 7820 3d20 286e      effnvox = (n
+0003a4d0: 766f 7872 696e 6720 2a20 2828 312e 3520  voxring * ((1.5 
+0003a4e0: 2a20 302e 3636 2920 2a2a 2032 2929 202f  * 0.66) ** 2)) /
+0003a4f0: 2028 3220 2a20 6173 796d 290a 2020 2020   (2 * asym).    
+0003a500: 2020 2020 2020 2020 2020 2020 6966 2065              if e
+0003a510: 6666 6e76 6f78 203c 2031 2e30 3a20 6566  ffnvox < 1.0: ef
+0003a520: 666e 766f 7820 3d20 312e 300a 2020 2020  fnvox = 1.0.    
+0003a530: 2020 2020 2020 2020 2020 2020 7371 7265              sqre
+0003a540: 6666 6e76 6f78 203d 206e 702e 7371 7274  ffnvox = np.sqrt
+0003a550: 2865 6666 6e76 6f78 290a 0a0a 2020 2020  (effnvox)...    
+0003a560: 2020 2020 2020 2020 2020 2020 2320 332d              # 3-
+0003a570: 7369 676d 6120 6375 7276 650a 2020 2020  sigma curve.    
+0003a580: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+0003a590: 2021 3d20 303a 0a20 2020 2020 2020 2020   != 0:.         
+0003a5a0: 2020 2020 2020 2020 2020 2073 6967 7661             sigva
+0003a5b0: 6c75 6520 3d20 3320 2f20 2873 7172 6566  lue = 3 / (sqref
+0003a5c0: 666e 766f 7820 2b20 332e 3020 2d20 312e  fnvox + 3.0 - 1.
+0003a5d0: 3029 0a20 2020 2020 2020 2020 2020 2020  0).             
+0003a5e0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0003a5f0: 2020 2020 2020 2020 2020 2020 2073 6967               sig
+0003a600: 7661 6c75 6520 3d20 310a 2020 2020 2020  value = 1.      
+0003a610: 2020 2020 2020 2020 2020 7468 7265 6573            threes
+0003a620: 6967 2e61 7070 656e 6428 7369 6776 616c  ig.append(sigval
+0003a630: 7565 290a 0a20 2020 2020 2020 2020 2020  ue)..           
+0003a640: 2020 2020 2023 2048 616c 6620 6269 7420       # Half bit 
+0003a650: 6375 7276 650a 2020 2020 2020 2020 2020  curve.          
+0003a660: 2020 2020 2020 6966 2069 2021 3d20 303a        if i != 0:
+0003a670: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003a680: 2020 2020 2062 6974 7661 6c75 6520 3d20       bitvalue = 
+0003a690: 2830 2e32 3037 3120 2b20 312e 3931 3032  (0.2071 + 1.9102
+0003a6a0: 202f 2073 7172 6566 666e 766f 7829 202f   / sqreffnvox) /
+0003a6b0: 2028 312e 3230 3731 202b 2030 2e39 3130   (1.2071 + 0.910
+0003a6c0: 3220 2f20 7371 7265 6666 6e76 6f78 290a  2 / sqreffnvox).
+0003a6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a6e0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0003a6f0: 2020 2020 2020 2020 2020 6269 7476 616c            bitval
+0003a700: 7565 203d 2031 0a20 2020 2020 2020 2020  ue = 1.         
+0003a710: 2020 2020 2020 2068 616c 6662 6974 2e61         halfbit.a
+0003a720: 7070 656e 6428 6269 7476 616c 7565 290a  ppend(bitvalue).
+0003a730: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003a740: 2069 6620 6920 213d 2030 3a0a 2020 2020   if i != 0:.    
+0003a750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a760: 6f6e 6562 6974 7661 6c75 6520 3d20 2830  onebitvalue = (0
+0003a770: 2e35 202b 2032 2e34 3134 3220 2f20 7371  .5 + 2.4142 / sq
+0003a780: 7265 6666 6e76 6f78 2920 2f20 2831 2e35  reffnvox) / (1.5
+0003a790: 202b 2031 2e34 3134 3220 2f20 7371 7265   + 1.4142 / sqre
+0003a7a0: 6666 6e76 6f78 290a 2020 2020 2020 2020  ffnvox).        
+0003a7b0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0003a7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a7d0: 2020 6f6e 6562 6974 7661 6c75 6520 3d20    onebitvalue = 
+0003a7e0: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
+0003a7f0: 2020 6f6e 6562 6974 2e61 7070 656e 6428    onebit.append(
+0003a800: 6f6e 6562 6974 7661 6c75 6529 0a20 2020  onebitvalue).   
+0003a810: 2020 2020 2020 2020 2070 7269 6e74 2863           print(c
+0003a820: 6f72 726c 6973 7429 0a0a 2020 2020 2020  orrlist)..      
+0003a830: 2020 2020 2020 6966 2063 6f72 726c 6973        if corrlis
+0003a840: 745b 305d 203c 3d20 303a 0a20 2020 2020  t[0] <= 0:.     
+0003a850: 2020 2020 2020 2020 2020 2063 6f72 726c             corrl
+0003a860: 6973 745b 305d 203d 2031 0a20 2020 2020  ist[0] = 1.     
+0003a870: 2020 2020 2020 2061 203d 206e 702e 6173         a = np.as
+0003a880: 6172 7261 7928 696e 6469 6178 6973 290a  array(indiaxis).
+0003a890: 2020 2020 2020 2020 2020 2020 6220 3d20              b = 
+0003a8a0: 6e70 2e61 7361 7272 6179 2863 6f72 726c  np.asarray(corrl
+0003a8b0: 6973 7429 0a20 2020 2020 2020 2020 2020  ist).           
+0003a8c0: 2063 203d 206e 702e 6173 6172 7261 7928   c = np.asarray(
+0003a8d0: 7468 7265 6573 6967 290a 2020 2020 2020  threesig).      
+0003a8e0: 2020 2020 2020 6420 3d20 6e70 2e61 7361        d = np.asa
+0003a8f0: 7272 6179 2868 616c 6662 6974 290a 2020  rray(halfbit).  
+0003a900: 2020 2020 2020 2020 2020 6520 3d20 6e70            e = np
+0003a910: 2e61 7361 7272 6179 286f 6e65 6269 7429  .asarray(onebit)
+0003a920: 0a20 2020 2020 2020 2020 2020 2066 203d  .            f =
+0003a930: 206e 702e 6675 6c6c 2828 6c65 6e28 696e   np.full((len(in
+0003a940: 6469 6178 6973 2929 2c20 302e 3529 0a20  diaxis)), 0.5). 
+0003a950: 2020 2020 2020 2020 2020 2067 203d 206e             g = n
+0003a960: 702e 6675 6c6c 2828 6c65 6e28 696e 6469  p.full((len(indi
+0003a970: 6178 6973 2929 2c20 302e 3333 3329 0a20  axis)), 0.333). 
+0003a980: 2020 2020 2020 2020 2020 2068 203d 206e             h = n
+0003a990: 702e 6675 6c6c 2828 6c65 6e28 696e 6469  p.full((len(indi
+0003a9a0: 6178 6973 2929 2c20 302e 3134 3329 0a20  axis)), 0.143). 
+0003a9b0: 2020 2020 2020 2020 2020 2023 2075 7365             # use
+0003a9c0: 205b 3a31 5d20 746f 2069 676e 6f72 6520   [:1] to ignore 
+0003a9d0: 616c 6c20 7468 6520 6375 7276 6573 2073  all the curves s
+0003a9e0: 7461 7274 2066 726f 6d20 302c 310a 2020  tart from 0,1.  
+0003a9f0: 2020 2020 2020 2020 2020 7874 6872 6565            xthree
+0003aa00: 7369 672c 2079 7468 7265 6573 6967 203d  sig, ythreesig =
+0003aa10: 2073 656c 662e 5f5f 696e 7465 7270 6f6c   self.__interpol
+0003aa20: 6174 6564 5f69 6e74 6572 6365 7074 2861  ated_intercept(a
+0003aa30: 2c20 622c 2063 290a 2020 2020 2020 2020  , b, c).        
+0003aa40: 2020 2020 7868 616c 6662 6974 2c20 7968      xhalfbit, yh
+0003aa50: 616c 6662 6974 203d 2073 656c 662e 5f5f  alfbit = self.__
+0003aa60: 696e 7465 7270 6f6c 6174 6564 5f69 6e74  interpolated_int
+0003aa70: 6572 6365 7074 2861 2c20 622c 2064 290a  ercept(a, b, d).
+0003aa80: 2020 2020 2020 2020 2020 2020 786f 6e65              xone
+0003aa90: 6269 742c 2079 6f6e 6562 6974 203d 2073  bit, yonebit = s
+0003aaa0: 656c 662e 5f5f 696e 7465 7270 6f6c 6174  elf.__interpolat
+0003aab0: 6564 5f69 6e74 6572 6365 7074 2861 2c20  ed_intercept(a, 
+0003aac0: 622c 2065 290a 2020 2020 2020 2020 2020  b, e).          
+0003aad0: 2020 7868 616c 662c 2079 6861 6c66 203d    xhalf, yhalf =
+0003aae0: 2073 656c 662e 5f5f 696e 7465 7270 6f6c   self.__interpol
+0003aaf0: 6174 6564 5f69 6e74 6572 6365 7074 2861  ated_intercept(a
+0003ab00: 2c20 622c 2066 290a 0a20 2020 2020 2020  , b, f)..       
+0003ab10: 2020 2020 2023 2043 6865 636b 2069 6620       # Check if 
+0003ab20: 6d6d 2069 6e20 6c61 6265 6c20 7468 656e  mm in label then
+0003ab30: 2c20 7365 6520 7768 6963 6820 696e 7465  , see which inte
+0003ab40: 7273 6563 696f 6e20 6973 2074 6865 206d  rsecion is the m
+0003ab50: 6f73 7420 636c 6f73 6573 7420 746f 2074  ost closest to t
+0003ab60: 6865 2067 6976 656e 2072 6573 6f6c 7574  he given resolut
+0003ab70: 696f 6e28 546f 646f 290a 2020 2020 2020  ion(Todo).      
+0003ab80: 2020 2020 2020 6966 2027 6d6d 2720 696e        if 'mm' in
+0003ab90: 206c 6162 656c 3a0a 2020 2020 2020 2020   label:.        
+0003aba0: 2020 2020 2020 2020 6966 2078 6861 6c66          if xhalf
+0003abb0: 2e73 697a 6520 213d 2030 3a0a 2020 2020  .size != 0:.    
+0003abc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003abd0: 6e65 7778 6861 6c66 203d 2061 6273 2878  newxhalf = abs(x
+0003abe0: 6861 6c66 202d 2031 202f 2066 6c6f 6174  half - 1 / float
+0003abf0: 2873 656c 662e 7265 736f 6c75 7469 6f6e  (self.resolution
+0003ac00: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+0003ac10: 2020 2020 2020 2069 6e64 6d69 6e20 3d20         indmin = 
+0003ac20: 6e70 2e61 7267 6d69 6e28 6e65 7778 6861  np.argmin(newxha
+0003ac30: 6c66 290a 2020 2020 2020 2020 2020 2020  lf).            
+0003ac40: 2020 2020 2020 2020 7868 616c 6620 3d20          xhalf = 
+0003ac50: 6e70 2e61 7272 6179 285b 7868 616c 665b  np.array([xhalf[
+0003ac60: 696e 646d 696e 5d5d 290a 2020 2020 2020  indmin]]).      
+0003ac70: 2020 2020 2020 2020 2020 2020 2020 7968                yh
+0003ac80: 616c 6620 3d20 6e70 2e61 7272 6179 285b  alf = np.array([
+0003ac90: 7968 616c 665b 696e 646d 696e 5d5d 290a  yhalf[indmin]]).
+0003aca0: 0a20 2020 2020 2020 2020 2020 2078 6f6e  .            xon
+0003acb0: 6574 6872 6565 2c20 796f 6e65 7468 7265  ethree, yonethre
+0003acc0: 6520 3d20 7365 6c66 2e5f 5f69 6e74 6572  e = self.__inter
+0003acd0: 706f 6c61 7465 645f 696e 7465 7263 6570  polated_intercep
+0003ace0: 7428 612c 2062 2c20 6729 0a20 2020 2020  t(a, b, g).     
+0003acf0: 2020 2020 2020 2078 676f 6c64 2c20 7967         xgold, yg
+0003ad00: 6f6c 6420 3d20 7365 6c66 2e5f 5f69 6e74  old = self.__int
+0003ad10: 6572 706f 6c61 7465 645f 696e 7465 7263  erpolated_interc
+0003ad20: 6570 7428 612c 2062 2c20 6829 0a0a 2020  ept(a, b, h)..  
+0003ad30: 2020 2020 2020 2020 2020 2320 4173 7369            # Assi
+0003ad40: 676e 2069 6e74 6572 7365 6374 696f 6e20  gn intersection 
+0003ad50: 7661 6c75 6520 6173 204e 6f6e 6520 7768  value as None wh
+0003ad60: 656e 2074 6865 7265 2069 7320 6e6f 2069  en there is no i
+0003ad70: 6e74 6572 7365 6374 696f 6e0a 2020 2020  ntersection.    
+0003ad80: 2020 2020 2020 2020 6966 2078 7468 7265          if xthre
+0003ad90: 6573 6967 2e73 697a 6520 3d3d 2030 2061  esig.size == 0 a
+0003ada0: 6e64 2079 7468 7265 6573 6967 2e73 697a  nd ythreesig.siz
+0003adb0: 6520 3d3d 2030 3a0a 2020 2020 2020 2020  e == 0:.        
+0003adc0: 2020 2020 2020 2020 7072 696e 7428 274e          print('N
+0003add0: 6f20 696e 7465 7273 6563 7469 6f6e 2062  o intersection b
+0003ade0: 6574 7765 656e 2046 5343 2061 6e64 2033  etween FSC and 3
+0003adf0: 2d73 6967 6d61 2063 7572 7665 732e 2048  -sigma curves. H
+0003ae00: 6572 6520 7573 6520 7468 6520 6c61 7374  ere use the last
+0003ae10: 2070 6f69 6e74 2e27 290a 2020 2020 2020   point.').      
+0003ae20: 2020 2020 2020 2020 2020 7874 6872 6565            xthree
+0003ae30: 7369 672c 2079 7468 7265 6573 6967 203d  sig, ythreesig =
+0003ae40: 204e 6f6e 652c 204e 6f6e 650a 2020 2020   None, None.    
+0003ae50: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0003ae60: 2020 2020 2020 2020 2020 2020 2020 7874                xt
+0003ae70: 6872 6565 7369 6720 3d20 6e70 2e72 6f75  hreesig = np.rou
+0003ae80: 6e64 2878 7468 7265 6573 6967 5b30 5d5b  nd(xthreesig[0][
+0003ae90: 305d 2c20 3429 0a20 2020 2020 2020 2020  0], 4).         
+0003aea0: 2020 2020 2020 2079 7468 7265 6573 6967         ythreesig
+0003aeb0: 203d 206e 702e 726f 756e 6428 7974 6872   = np.round(ythr
+0003aec0: 6565 7369 675b 305d 5b30 5d2c 2034 290a  eesig[0][0], 4).
+0003aed0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0003aee0: 7868 616c 6662 6974 2e73 697a 6520 3d3d  xhalfbit.size ==
+0003aef0: 2030 2061 6e64 2079 6861 6c66 6269 742e   0 and yhalfbit.
+0003af00: 7369 7a65 203d 3d20 303a 0a20 2020 2020  size == 0:.     
+0003af10: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0003af20: 2827 4e6f 2069 6e74 6572 7365 6374 696f  ('No intersectio
+0003af30: 6e20 6265 7477 6565 6e20 4653 4320 616e  n between FSC an
+0003af40: 6420 312f 322d 6269 7420 6375 7276 6573  d 1/2-bit curves
+0003af50: 2e20 4865 7265 2075 7365 2074 6865 206c  . Here use the l
+0003af60: 6173 7420 706f 696e 742e 2729 0a20 2020  ast point.').   
+0003af70: 2020 2020 2020 2020 2020 2020 2078 6861               xha
+0003af80: 6c66 6269 742c 2079 6861 6c66 6269 7420  lfbit, yhalfbit 
+0003af90: 3d20 4e6f 6e65 2c20 4e6f 6e65 0a20 2020  = None, None.   
+0003afa0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0003afb0: 2020 2020 2020 2020 2020 2020 2020 2078                 x
+0003afc0: 6861 6c66 6269 7420 3d20 6e70 2e72 6f75  halfbit = np.rou
+0003afd0: 6e64 2878 6861 6c66 6269 745b 305d 5b30  nd(xhalfbit[0][0
+0003afe0: 5d2c 2034 290a 2020 2020 2020 2020 2020  ], 4).          
+0003aff0: 2020 2020 2020 7968 616c 6662 6974 203d        yhalfbit =
+0003b000: 206e 702e 726f 756e 6428 7968 616c 6662   np.round(yhalfb
+0003b010: 6974 5b30 5d5b 305d 2c20 3429 0a0a 2020  it[0][0], 4)..  
+0003b020: 2020 2020 2020 2020 2020 6966 2078 6f6e            if xon
+0003b030: 6562 6974 2e73 697a 6520 3d3d 2030 2061  ebit.size == 0 a
+0003b040: 6e64 2079 6f6e 6562 6974 2e73 697a 6520  nd yonebit.size 
+0003b050: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
+0003b060: 2020 2020 2020 7072 696e 7428 274e 6f20        print('No 
+0003b070: 696e 7465 7273 6563 7469 6f6e 2062 6574  intersection bet
+0003b080: 7765 656e 2046 5343 2061 6e64 2031 2d62  ween FSC and 1-b
+0003b090: 6974 2063 7572 7665 732e 2048 6572 6520  it curves. Here 
+0003b0a0: 7573 6520 7468 6520 6c61 7374 2070 6f69  use the last poi
+0003b0b0: 6e74 2e27 290a 2020 2020 2020 2020 2020  nt.').          
+0003b0c0: 2020 2020 2020 786f 6e65 6269 742c 2079        xonebit, y
+0003b0d0: 6f6e 6562 6974 203d 204e 6f6e 652c 204e  onebit = None, N
+0003b0e0: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+0003b0f0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0003b100: 2020 2020 2020 786f 6e65 6269 7420 3d20        xonebit = 
+0003b110: 6e70 2e72 6f75 6e64 2878 6f6e 6562 6974  np.round(xonebit
+0003b120: 5b30 5d5b 305d 2c20 3429 0a20 2020 2020  [0][0], 4).     
+0003b130: 2020 2020 2020 2020 2020 2079 6f6e 6562             yoneb
+0003b140: 6974 203d 206e 702e 726f 756e 6428 796f  it = np.round(yo
+0003b150: 6e65 6269 745b 305d 5b30 5d2c 2034 290a  nebit[0][0], 4).
+0003b160: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0003b170: 786f 6e65 7468 7265 652e 7369 7a65 203d  xonethree.size =
+0003b180: 3d20 3020 616e 6420 796f 6e65 7468 7265  = 0 and yonethre
+0003b190: 652e 7369 7a65 203d 3d20 303a 0a20 2020  e.size == 0:.   
+0003b1a0: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+0003b1b0: 6e74 2827 4e6f 2069 6e74 6572 7365 6374  nt('No intersect
+0003b1c0: 696f 6e20 6265 7477 6565 6e20 4653 4320  ion between FSC 
+0003b1d0: 616e 6420 302e 3333 3320 6375 7276 6573  and 0.333 curves
+0003b1e0: 2e20 4865 7265 2075 7365 2074 6865 206c  . Here use the l
+0003b1f0: 6173 7420 706f 696e 7427 290a 2020 2020  ast point').    
+0003b200: 2020 2020 2020 2020 2020 2020 786f 6e65              xone
+0003b210: 7468 7265 652c 2079 6f6e 6574 6872 6565  three, yonethree
+0003b220: 203d 204e 6f6e 652c 204e 6f6e 650a 2020   = None, None.  
+0003b230: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0003b240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b250: 786f 6e65 7468 7265 6520 3d20 6e70 2e72  xonethree = np.r
+0003b260: 6f75 6e64 2878 6f6e 6574 6872 6565 5b30  ound(xonethree[0
+0003b270: 5d5b 305d 2c20 3429 0a20 2020 2020 2020  ][0], 4).       
+0003b280: 2020 2020 2020 2020 2079 6f6e 6574 6872           yonethr
+0003b290: 6565 203d 206e 702e 726f 756e 6428 796f  ee = np.round(yo
+0003b2a0: 6e65 7468 7265 655b 305d 5b30 5d2c 2034  nethree[0][0], 4
+0003b2b0: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
+0003b2c0: 6620 7868 616c 662e 7369 7a65 203d 3d20  f xhalf.size == 
+0003b2d0: 3020 616e 6420 7968 616c 662e 7369 7a65  0 and yhalf.size
+0003b2e0: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
+0003b2f0: 2020 2020 2020 2070 7269 6e74 2827 2121         print('!!
+0003b300: 2120 4e6f 2069 6e74 6572 7365 6374 696f  ! No intersectio
+0003b310: 6e20 6265 7477 6565 6e20 4653 4320 616e  n between FSC an
+0003b320: 6420 302e 3520 6375 7276 6573 2e20 4865  d 0.5 curves. He
+0003b330: 7265 2075 7365 2074 6865 206c 6173 7420  re use the last 
+0003b340: 706f 696e 7427 290a 2020 2020 2020 2020  point').        
+0003b350: 2020 2020 2020 2020 7868 616c 662c 2079          xhalf, y
+0003b360: 6861 6c66 203d 204e 6f6e 652c 204e 6f6e  half = None, Non
+0003b370: 650a 2020 2020 2020 2020 2020 2020 656c  e.            el
+0003b380: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0003b390: 2020 2020 7868 616c 6620 3d20 6e70 2e72      xhalf = np.r
+0003b3a0: 6f75 6e64 2878 6861 6c66 5b30 5d5b 305d  ound(xhalf[0][0]
+0003b3b0: 2c20 3429 0a20 2020 2020 2020 2020 2020  , 4).           
+0003b3c0: 2020 2020 2079 6861 6c66 203d 206e 702e       yhalf = np.
+0003b3d0: 726f 756e 6428 7968 616c 665b 305d 5b30  round(yhalf[0][0
+0003b3e0: 5d2c 2034 290a 2020 2020 2020 2020 2020  ], 4).          
+0003b3f0: 2020 6966 2078 676f 6c64 2e73 697a 6520    if xgold.size 
+0003b400: 3d3d 2030 2061 6e64 2079 676f 6c64 2e73  == 0 and ygold.s
+0003b410: 697a 6520 3d3d 2030 3a0a 2020 2020 2020  ize == 0:.      
+0003b420: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0003b430: 2721 2121 204e 6f20 696e 7465 7273 6563  '!!! No intersec
+0003b440: 7469 6f6e 2062 6574 7765 656e 2046 5343  tion between FSC
+0003b450: 2061 6e64 2030 2e31 3433 2063 7572 7665   and 0.143 curve
+0003b460: 732e 2048 6572 6520 7573 6520 7468 6520  s. Here use the 
+0003b470: 6c61 7374 2070 6f69 6e74 2729 0a20 2020  last point').   
+0003b480: 2020 2020 2020 2020 2020 2020 2078 676f               xgo
+0003b490: 6c64 2c20 7967 6f6c 6420 3d20 4e6f 6e65  ld, ygold = None
+0003b4a0: 2c20 4e6f 6e65 0a20 2020 2020 2020 2020  , None.         
+0003b4b0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0003b4c0: 2020 2020 2020 2020 2078 676f 6c64 203d           xgold =
+0003b4d0: 206e 702e 726f 756e 6428 7867 6f6c 645b   np.round(xgold[
+0003b4e0: 305d 5b30 5d2c 2034 290a 2020 2020 2020  0][0], 4).      
+0003b4f0: 2020 2020 2020 2020 2020 7967 6f6c 6420            ygold 
+0003b500: 3d20 6e70 2e72 6f75 6e64 2879 676f 6c64  = np.round(ygold
+0003b510: 5b30 5d5b 305d 2c20 3429 0a0a 0a20 2020  [0][0], 4)...   
+0003b520: 2020 2020 2020 2020 2064 6174 6164 6963           datadic
+0003b530: 7420 3d20 7b0a 2020 2020 2020 2020 2020  t = {.          
+0003b540: 2020 2020 2020 2763 7572 7665 7327 3a20        'curves': 
+0003b550: 7b27 6673 6327 3a20 6e70 2e72 6f75 6e64  {'fsc': np.round
+0003b560: 286e 702e 7265 616c 2863 6f72 726c 6973  (np.real(corrlis
+0003b570: 7429 2c20 3429 2e74 6f6c 6973 7428 292c  t), 4).tolist(),
+0003b580: 2027 7468 7265 6573 6967 6d61 273a 206e   'threesigma': n
+0003b590: 702e 726f 756e 6428 7468 7265 6573 6967  p.round(threesig
+0003b5a0: 2c20 3429 2e74 6f6c 6973 7428 292c 0a20  , 4).tolist(),. 
+0003b5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b5c0: 2020 2020 2020 2020 2020 2768 616c 6662            'halfb
+0003b5d0: 6974 273a 206e 702e 726f 756e 6428 6861  it': np.round(ha
+0003b5e0: 6c66 6269 742c 2034 292e 746f 6c69 7374  lfbit, 4).tolist
+0003b5f0: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
+0003b600: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0003b610: 6f6e 6562 6974 273a 206e 702e 726f 756e  onebit': np.roun
+0003b620: 6428 6f6e 6562 6974 2c20 3429 2e74 6f6c  d(onebit, 4).tol
+0003b630: 6973 7428 292c 2027 302e 3527 3a20 662e  ist(), '0.5': f.
+0003b640: 746f 6c69 7374 2829 2c20 2730 2e33 3333  tolist(), '0.333
+0003b650: 273a 2067 2e74 6f6c 6973 7428 292c 0a20  ': g.tolist(),. 
+0003b660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b670: 2020 2020 2020 2020 2020 2730 2e31 3433            '0.143
+0003b680: 273a 2068 2e74 6f6c 6973 7428 292c 0a20  ': h.tolist(),. 
+0003b690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b6a0: 2020 2020 2020 2020 2020 276c 6576 656c            'level
+0003b6b0: 273a 206e 702e 726f 756e 6428 696e 6469  ': np.round(indi
+0003b6c0: 6178 6973 2c20 3429 2e74 6f6c 6973 7428  axis, 4).tolist(
+0003b6d0: 297d 2c0a 2020 2020 2020 2020 2020 2020  )},.            
+0003b6e0: 2020 2020 2769 6e74 6572 7365 6374 696f      'intersectio
+0003b6f0: 6e73 273a 207b 2774 6872 6565 7369 6727  ns': {'threesig'
+0003b700: 3a20 7b27 7827 3a20 7874 6872 6565 7369  : {'x': xthreesi
+0003b710: 672c 2027 7927 3a20 7974 6872 6565 7369  g, 'y': ythreesi
+0003b720: 677d 2c0a 2020 2020 2020 2020 2020 2020  g},.            
+0003b730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b740: 2020 2020 2020 2768 616c 6662 6974 273a        'halfbit':
+0003b750: 207b 2778 273a 2078 6861 6c66 6269 742c   {'x': xhalfbit,
+0003b760: 2027 7927 3a20 7968 616c 6662 6974 7d2c   'y': yhalfbit},
+0003b770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003b780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b790: 2020 2027 6f6e 6562 6974 273a 207b 2778     'onebit': {'x
+0003b7a0: 273a 2078 6f6e 6562 6974 2c20 2779 273a  ': xonebit, 'y':
+0003b7b0: 2079 6f6e 6562 6974 7d2c 0a20 2020 2020   yonebit},.     
+0003b7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b7d0: 2020 2020 2020 2020 2020 2020 2027 302e               '0.
+0003b7e0: 3527 3a20 7b27 7827 3a20 7868 616c 662c  5': {'x': xhalf,
+0003b7f0: 2027 7927 3a20 7968 616c 667d 2c0a 2020   'y': yhalf},.  
+0003b800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b820: 2730 2e33 3333 273a 207b 2778 273a 2078  '0.333': {'x': x
+0003b830: 6f6e 6574 6872 6565 2c20 2779 273a 2079  onethree, 'y': y
+0003b840: 6f6e 6574 6872 6565 7d2c 0a20 2020 2020  onethree},.     
+0003b850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003b860: 2020 2020 2020 2020 2020 2020 2027 302e               '0.
+0003b870: 3134 3327 3a20 7b27 7827 3a20 7867 6f6c  143': {'x': xgol
+0003b880: 642c 2027 7927 3a20 7967 6f6c 647d 7d7d  d, 'y': ygold}}}
+0003b890: 0a20 2020 2020 2020 2020 2020 2066 696e  .            fin
+0003b8a0: 616c 6469 6374 203d 2064 6963 7428 290a  aldict = dict().
+0003b8b0: 2020 2020 2020 2020 2020 2020 6669 6e61              fina
+0003b8c0: 6c64 6963 745b 6c61 6265 6c20 2b20 2766  ldict[label + 'f
+0003b8d0: 7363 275d 203d 2064 6174 6164 6963 740a  sc'] = datadict.
+0003b8e0: 0a20 2020 2020 2020 2020 2020 2070 6c74  .            plt
+0003b8f0: 2e70 6c6f 7428 696e 6469 6178 6973 2c20  .plot(indiaxis, 
+0003b900: 636f 7272 6c69 7374 2c20 6c61 6265 6c3d  corrlist, label=
+0003b910: 6c61 6265 6c20 2b20 2746 5343 2729 0a20  label + 'FSC'). 
+0003b920: 2020 2020 2020 2020 2020 2023 2070 6c74             # plt
+0003b930: 2e70 6c6f 7428 696e 6469 6178 6973 2c20  .plot(indiaxis, 
+0003b940: 7468 7265 6573 6967 2c20 6c61 6265 6c3d  threesig, label=
+0003b950: 2733 2073 6967 6d61 2729 0a20 2020 2020  '3 sigma').     
+0003b960: 2020 2020 2020 2070 6c74 2e70 6c6f 7428         plt.plot(
+0003b970: 696e 6469 6178 6973 2c20 6861 6c66 6269  indiaxis, halfbi
+0003b980: 742c 206c 6162 656c 3d27 312f 3220 6269  t, label='1/2 bi
+0003b990: 7427 290a 2020 2020 2020 2020 2020 2020  t').            
+0003b9a0: 2320 706c 742e 706c 6f74 2869 6e64 6961  # plt.plot(india
+0003b9b0: 7869 732c 206f 6e65 6269 742c 206c 6162  xis, onebit, lab
+0003b9c0: 656c 3d27 3120 6269 7427 290a 2020 2020  el='1 bit').    
+0003b9d0: 2020 2020 2020 2020 706c 742e 706c 6f74          plt.plot
+0003b9e0: 2869 6e64 6961 7869 732c 2066 2c20 6c61  (indiaxis, f, la
+0003b9f0: 6265 6c3d 2730 2e35 272c 206c 696e 6573  bel='0.5', lines
+0003ba00: 7479 6c65 3d27 3a27 290a 2020 2020 2020  tyle=':').      
+0003ba10: 2020 2020 2020 2320 706c 742e 706c 6f74        # plt.plot
+0003ba20: 2869 6e64 6961 7869 732c 2067 2c20 6c61  (indiaxis, g, la
+0003ba30: 6265 6c3d 2730 2e33 3333 272c 206c 696e  bel='0.333', lin
+0003ba40: 6573 7479 6c65 3d27 2d2d 2729 0a20 2020  estyle='--').   
+0003ba50: 2020 2020 2020 2020 2070 6c74 2e70 6c6f           plt.plo
+0003ba60: 7428 696e 6469 6178 6973 2c20 682c 206c  t(indiaxis, h, l
+0003ba70: 6162 656c 3d27 302e 3134 3327 2c20 6c69  abel='0.143', li
+0003ba80: 6e65 7374 796c 653d 272d 2e27 290a 2020  nestyle='-.').  
+0003ba90: 2020 2020 2020 2020 2020 706c 742e 6c65            plt.le
+0003baa0: 6765 6e64 2829 0a20 2020 2020 2020 2020  gend().         
+0003bab0: 2020 2069 6620 6c61 6265 6c3a 0a20 2020     if label:.   
+0003bac0: 2020 2020 2020 2020 2020 2020 2070 6c74               plt
+0003bad0: 2e73 6176 6566 6967 2873 656c 662e 776f  .savefig(self.wo
+0003bae0: 726b 6469 7220 2b20 7365 6c66 2e6d 6170  rkdir + self.map
+0003baf0: 6e61 6d65 202b 2027 5f27 202b 206c 6162  name + '_' + lab
+0003bb00: 656c 202b 2027 5f66 7363 2e70 6e67 2729  el + '_fsc.png')
+0003bb10: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0003bb20: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0003bb30: 2020 2070 6c74 2e73 6176 6566 6967 2873     plt.savefig(s
+0003bb40: 656c 662e 776f 726b 6469 7220 2b20 7365  elf.workdir + se
+0003bb50: 6c66 2e6d 6170 6e61 6d65 202b 2027 5f66  lf.mapname + '_f
+0003bb60: 7363 2e70 6e67 2729 0a20 2020 2020 2020  sc.png').       
+0003bb70: 2020 2020 2070 6c74 2e63 6c6f 7365 2829       plt.close()
+0003bb80: 0a0a 2020 2020 2020 2020 6578 6365 7074  ..        except
+0003bb90: 3a0a 2020 2020 2020 2020 2020 2020 6572  :.            er
+0003bba0: 7220 3d20 2746 5343 2063 616c 6375 6c61  r = 'FSC calcula
+0003bbb0: 7469 6f6e 2065 7272 6f72 3a20 7b7d 272e  tion error: {}'.
+0003bbc0: 666f 726d 6174 2873 7973 2e65 7863 5f69  format(sys.exc_i
+0003bbd0: 6e66 6f28 295b 315d 290a 2020 2020 2020  nfo()[1]).      
+0003bbe0: 2020 2020 2020 6572 726c 6973 742e 6170        errlist.ap
+0003bbf0: 7065 6e64 2865 7272 290a 2020 2020 2020  pend(err).      
+0003bc00: 2020 2020 2020 7379 732e 7374 6465 7272        sys.stderr
+0003bc10: 2e77 7269 7465 2865 7272 202b 2027 5c6e  .write(err + '\n
+0003bc20: 2729 0a0a 2020 2020 2020 2020 6966 2065  ')..        if e
+0003bc30: 7272 6c69 7374 3a0a 2020 2020 2020 2020  rrlist:.        
+0003bc40: 2020 2020 6461 7461 6469 6374 203d 207b      datadict = {
+0003bc50: 2765 7272 273a 207b 6c61 6265 6c20 2b20  'err': {label + 
+0003bc60: 2766 7363 5f65 7272 6f72 273a 2065 7272  'fsc_error': err
+0003bc70: 6c69 7374 7d7d 0a20 2020 2020 2020 2020  list}}.         
+0003bc80: 2020 2066 696e 616c 6469 6374 5b6c 6162     finaldict[lab
+0003bc90: 656c 202b 2027 6673 6327 5d20 3d20 6461  el + 'fsc'] = da
+0003bca0: 7461 6469 6374 0a20 2020 2020 2020 2065  tadict.        e
+0003bcb0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0003bcc0: 2070 7269 6e74 2827 4e6f 2065 7272 6f72   print('No error
+0003bcd0: 2069 6e20 4653 4320 6361 6c63 756c 6174   in FSC calculat
+0003bce0: 696f 6e2e 2729 0a0a 2020 2020 2020 2020  ion.')..        
+0003bcf0: 6966 2062 6f6f 6c28 6461 7461 6469 6374  if bool(datadict
+0003bd00: 2920 616e 6420 626f 6f6c 2866 696e 616c  ) and bool(final
+0003bd10: 6469 6374 293a 0a20 2020 2020 2020 2020  dict):.         
+0003bd20: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+0003bd30: 2020 2020 2020 2020 7769 7468 2063 6f64          with cod
+0003bd40: 6563 732e 6f70 656e 2873 656c 662e 776f  ecs.open(self.wo
+0003bd50: 726b 6469 7220 2b20 7365 6c66 2e6d 6170  rkdir + self.map
+0003bd60: 6e61 6d65 202b 2027 5f27 202b 206c 6162  name + '_' + lab
+0003bd70: 656c 202b 2027 6673 632e 6a73 6f6e 272c  el + 'fsc.json',
+0003bd80: 2027 7727 2c20 656e 636f 6469 6e67 3d27   'w', encoding='
+0003bd90: 7574 662d 3827 2920 6173 2066 3a0a 2020  utf-8') as f:.  
+0003bda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003bdb0: 2020 6a73 6f6e 2e64 756d 7028 6669 6e61    json.dump(fina
+0003bdc0: 6c64 6963 742c 2066 290a 2020 2020 2020  ldict, f).      
+0003bdd0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0003bde0: 2746 5343 2070 726f 6475 6365 6420 6279  'FSC produced by
+0003bdf0: 2074 776f 2068 616c 6620 6d61 7073 2e27   two half maps.'
+0003be00: 290a 2020 2020 2020 2020 2020 2020 6578  ).            ex
+0003be10: 6365 7074 3a0a 2020 2020 2020 2020 2020  cept:.          
+0003be20: 2020 2020 2020 7379 732e 7374 6465 7272        sys.stderr
+0003be30: 2e77 7269 7465 2827 5772 6974 696e 6720  .write('Writing 
+0003be40: 4653 4320 6461 7461 2074 6f20 6a73 6f6e  FSC data to json
+0003be50: 2066 696c 6520 6572 726f 723a 207b 7d2e   file error: {}.
+0003be60: 272e 666f 726d 6174 2873 7973 2e65 7863  '.format(sys.exc
+0003be70: 5f69 6e66 6f28 295b 315d 2929 0a20 2020  _info()[1])).   
+0003be80: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0003be90: 2020 2020 2020 2073 7973 2e73 7464 6572         sys.stder
+0003bea0: 722e 7772 6974 6528 2746 5343 2063 616c  r.write('FSC cal
+0003beb0: 6375 6c61 7469 6f6e 2067 6574 206e 6f6e  culation get non
+0003bec0: 6520 2729 0a0a 2020 2020 2020 2020 7265  e ')..        re
+0003bed0: 7475 726e 204e 6f6e 650a 0a0a 2020 2020  turn None...    
+0003bee0: 2320 4070 726f 6669 6c65 0a20 2020 2064  # @profile.    d
+0003bef0: 6566 206e 6577 5f66 7363 2873 656c 662c  ef new_fsc(self,
+0003bf00: 206d 6170 6f64 642c 206d 6170 6576 656e   mapodd, mapeven
+0003bf10: 2c20 6173 796d 3d31 2e30 2c20 6c61 6265  , asym=1.0, labe
+0003bf20: 6c3d 2727 293a 0a20 2020 2020 2020 2022  l=''):.        "
+0003bf30: 2222 0a0a 2020 2020 2020 2020 2020 2020  ""..            
+0003bf40: 4361 6c63 756c 6174 6520 4653 4320 6261  Calculate FSC ba
+0003bf50: 7365 6420 6f6e 2074 6865 2074 776f 2069  sed on the two i
+0003bf60: 6e70 7574 2068 616c 6620 6d61 7073 0a20  nput half maps. 
+0003bf70: 2020 2020 2020 2020 2020 2052 6573 756c             Resul
+0003bf80: 7473 2077 726f 7465 2074 6f20 4a53 4f4e  ts wrote to JSON
+0003bf90: 2066 696c 6520 696e 636c 7564 696e 6720   file including 
+0003bfa0: 7265 736f 6c75 7469 6f6e 2061 7420 302e  resolution at 0.
+0003bfb0: 3134 332c 2030 2e33 3333 2c20 302e 3520  143, 0.333, 0.5 
+0003bfc0: 616e 6420 6e6f 6973 650a 2020 2020 2020  and noise.      
+0003bfd0: 2020 2020 2020 6c65 7665 6c20 6174 2030        level at 0
+0003bfe0: 2e35 2d62 6974 2c20 312d 6269 742c 2033  .5-bit, 1-bit, 3
+0003bff0: 2d73 6967 6d61 2e20 4120 636f 7272 6573  -sigma. A corres
+0003c000: 706f 6e64 696e 6720 706c 6f74 2069 7320  ponding plot is 
+0003c010: 616c 736f 2073 6176 6520 6173 2050 4e47  also save as PNG
+0003c020: 2066 696c 652e 0a0a 2020 2020 2020 2020   file...        
+0003c030: 3a70 6172 616d 206d 6170 6f64 643a 2054  :param mapodd: T
+0003c040: 454d 5079 206d 6170 2069 6e73 7461 6e63  EMPy map instanc
+0003c050: 650a 2020 2020 2020 2020 3a70 6172 616d  e.        :param
+0003c060: 206d 6170 6576 656e 3a20 5445 4d50 7920   mapeven: TEMPy 
+0003c070: 6d61 7020 696e 7374 616e 6365 0a20 2020  map instance.   
+0003c080: 2020 2020 203a 7265 7475 726e 3a20 4e6f       :return: No
+0003c090: 6e65 0a0a 2020 2020 2020 2020 2222 220a  ne..        """.
+0003c0a0: 0a20 2020 2020 2020 2073 7461 7274 203d  .        start =
+0003c0b0: 2074 696d 6569 742e 6465 6661 756c 745f   timeit.default_
+0003c0c0: 7469 6d65 7228 290a 2020 2020 2020 2020  timer().        
+0003c0d0: 6572 726c 6973 7420 3d20 5b5d 0a20 2020  errlist = [].   
+0003c0e0: 2020 2020 2064 6174 6164 6963 7420 3d20       datadict = 
+0003c0f0: 6469 6374 2829 0a20 2020 2020 2020 2066  dict().        f
+0003c100: 696e 616c 6469 6374 203d 2064 6963 7428  inaldict = dict(
+0003c110: 290a 2020 2020 2020 2020 2320 6576 656e  ).        # even
+0003c120: 6e61 6d65 203d 206f 732e 7061 7468 2e62  name = os.path.b
+0003c130: 6173 656e 616d 6528 6d61 7065 7665 6e2e  asename(mapeven.
+0003c140: 6675 6c6c 6e61 6d65 290a 2020 2020 2020  fullname).      
+0003c150: 2020 2320 6f64 646e 616d 6520 3d20 6f73    # oddname = os
+0003c160: 2e70 6174 682e 6261 7365 6e61 6d65 286d  .path.basename(m
+0003c170: 6170 6f64 642e 6675 6c6c 6e61 6d65 290a  apodd.fullname).
+0003c180: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+0003c190: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+0003c1a0: 6d61 706f 6464 2e64 6174 612e 7368 6170  mapodd.data.shap
+0003c1b0: 6520 3d3d 206d 6170 6576 656e 2e64 6174  e == mapeven.dat
+0003c1c0: 612e 7368 6170 652c 2027 5468 6520 7477  a.shape, 'The tw
+0003c1d0: 6f20 6861 6c66 206d 6170 7320 646f 206e  o half maps do n
+0003c1e0: 6f74 2068 6176 6520 7361 6d65 2073 697a  ot have same siz
+0003c1f0: 652e 270a 2020 2020 2020 2020 2020 2020  e.'.            
+0003c200: 6173 7365 7274 206d 6170 6f64 642e 766f  assert mapodd.vo
+0003c210: 7865 6c5f 7369 7a65 203d 3d20 6d61 7065  xel_size == mape
+0003c220: 7665 6e2e 766f 7865 6c5f 7369 7a65 2c20  ven.voxel_size, 
+0003c230: 2754 6865 2074 776f 2068 616c 6620 6d61  'The two half ma
+0003c240: 7073 2064 6f20 6e6f 7420 6861 7665 2073  ps do not have s
+0003c250: 616d 6520 6170 6978 2e27 0a20 2020 2020  ame apix.'.     
+0003c260: 2020 2020 2020 206f 6464 6e61 6e20 3d20         oddnan = 
+0003c270: 6e70 2e69 736e 616e 286d 6170 6f64 642e  np.isnan(mapodd.
+0003c280: 6461 7461 292e 616e 7928 290a 2020 2020  data).any().    
+0003c290: 2020 2020 2020 2020 6576 656e 6e61 6e20          evennan 
+0003c2a0: 3d20 6e70 2e69 736e 616e 286d 6170 6576  = np.isnan(mapev
+0003c2b0: 656e 2e64 6174 6129 2e61 6e79 2829 0a20  en.data).any(). 
+0003c2c0: 2020 2020 2020 2020 2020 206e 616e 6368             nanch
+0003c2d0: 6563 6b20 3d20 6f64 646e 616e 207c 2065  eck = oddnan | e
+0003c2e0: 7665 6e6e 616e 0a20 2020 2020 2020 2020  vennan.         
+0003c2f0: 2020 2061 7373 6572 7420 6e6f 7420 6e61     assert not na
+0003c300: 6e63 6865 636b 2c20 2754 6865 7265 2069  ncheck, 'There i
+0003c310: 7320 4e61 4e20 7661 6c75 6520 696e 2068  s NaN value in h
+0003c320: 616c 6620 6d61 702e 270a 2020 2020 2020  alf map.'.      
+0003c330: 2020 2020 2020 2320 4173 7375 6d65 2061        # Assume a
+0003c340: 6c6c 2064 696d 656e 7369 6f6e 2061 7265  ll dimension are
+0003c350: 2074 6865 2073 616d 6520 7369 7a65 0a0a   the same size..
+0003c360: 2020 2020 2020 2020 2020 2020 6170 6978              apix
+0003c370: 7320 3d20 7475 706c 6528 6d61 706f 6464  s = tuple(mapodd
+0003c380: 2e76 6f78 656c 5f73 697a 652e 746f 6c69  .voxel_size.toli
+0003c390: 7374 2829 290a 0a20 2020 2020 2020 2020  st())..         
+0003c3a0: 2020 206d 6170 6f64 645f 6461 7461 203d     mapodd_data =
+0003c3b0: 2066 6674 7368 6966 7428 6666 746e 286d   fftshift(fftn(m
+0003c3c0: 6170 6f64 642e 6461 7461 2929 0a20 2020  apodd.data)).   
+0003c3d0: 2020 2020 2020 2020 206d 6170 6f64 642e           mapodd.
+0003c3e0: 636c 6f73 6528 290a 2020 2020 2020 2020  close().        
+0003c3f0: 2020 2020 6d61 7065 7665 6e5f 6461 7461      mapeven_data
+0003c400: 203d 2066 6674 7368 6966 7428 6666 746e   = fftshift(fftn
+0003c410: 286d 6170 6576 656e 2e64 6174 6129 290a  (mapeven.data)).
+0003c420: 2020 2020 2020 2020 2020 2020 6d61 7065              mape
+0003c430: 7665 6e2e 636c 6f73 6528 290a 0a20 2020  ven.close()..   
+0003c440: 2020 2020 2020 2020 2073 7461 7274 203d           start =
+0003c450: 2074 696d 6569 742e 6465 6661 756c 745f   timeit.default_
+0003c460: 7469 6d65 7228 2920 2d20 7374 6172 740a  timer() - start.
+0003c470: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0003c480: 7428 2720 2d2d 2046 5343 2046 6f75 7269  t(' -- FSC Fouri
+0003c490: 6572 2d74 7261 6e73 666f 726d 6174 696f  er-transformatio
+0003c4a0: 6e20 7469 6d65 3a20 2573 2720 2520 7374  n time: %s' % st
+0003c4b0: 6172 7429 0a0a 2020 2020 2020 2020 2020  art)..          
+0003c4c0: 2020 6966 2074 7970 6528 6170 6978 7329    if type(apixs)
+0003c4d0: 2069 7320 7475 706c 653a 0a20 2020 2020   is tuple:.     
+0003c4e0: 2020 2020 2020 2020 2020 2074 6170 6978             tapix
+0003c4f0: 203d 2061 7069 7873 5b30 5d0a 2020 2020   = apixs[0].    
+0003c500: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0003c510: 2020 2020 2020 2020 2020 2020 2020 7461                ta
+0003c520: 7069 7820 3d20 6170 6978 730a 0a20 2020  pix = apixs..   
+0003c530: 2020 2020 2020 2020 2023 204c 6f6f 7069           # Loopi
+0003c540: 6e67 2074 6872 6f75 6768 2061 6c6c 2073  ng through all s
+0003c550: 6865 6c6c 730a 2020 2020 2020 2020 2020  hells.          
+0003c560: 2020 636f 7272 6c69 7374 203d 205b 5d0a    corrlist = [].
+0003c570: 2020 2020 2020 2020 2020 2020 7468 7265              thre
+0003c580: 6573 6967 203d 205b 5d0a 2020 2020 2020  esig = [].      
+0003c590: 2020 2020 2020 6861 6c66 6269 7420 3d20        halfbit = 
+0003c5a0: 5b5d 0a20 2020 2020 2020 2020 2020 206f  [].            o
+0003c5b0: 6e65 6269 7420 3d20 5b5d 0a0a 2020 2020  nebit = []..    
+0003c5c0: 2020 2020 2020 2020 2323 2061 7070 6c79          ## apply
+0003c5d0: 696e 6720 6e65 7720 696e 6469 6365 7320  ing new indices 
+0003c5e0: 6675 6e63 7469 6f6e 0a20 2020 2020 2020  function.       
+0003c5f0: 2020 2020 206d 6170 5f73 6861 7065 203d       map_shape =
+0003c600: 206d 6170 6f64 645f 6461 7461 2e73 6861   mapodd_data.sha
+0003c610: 7065 0a20 2020 2020 2020 2020 2020 2069  pe.            i
+0003c620: 6620 6d69 6e28 6d61 705f 7368 6170 6529  f min(map_shape)
+0003c630: 2025 2032 203d 3d20 303a 0a20 2020 2020   % 2 == 0:.     
+0003c640: 2020 2020 2020 2020 2020 206f 7267 203d             org =
+0003c650: 205b 6d61 705f 7368 6170 655b 305d 202f   [map_shape[0] /
+0003c660: 2032 2c20 6d61 705f 7368 6170 655b 315d   2, map_shape[1]
+0003c670: 202f 2032 2c20 6d61 705f 7368 6170 655b   / 2, map_shape[
+0003c680: 325d 202f 2032 5d0a 2020 2020 2020 2020  2] / 2].        
+0003c690: 2020 2020 2020 2020 696e 6469 6178 6973          indiaxis
+0003c6a0: 203d 206e 702e 6c69 6e73 7061 6365 2830   = np.linspace(0
+0003c6b0: 2c20 696e 7428 6d69 6e28 6f72 6729 292c  , int(min(org)),
+0003c6c0: 2069 6e74 286d 696e 286f 7267 2929 202b   int(min(org)) +
+0003c6d0: 2031 2920 2f20 286d 696e 286d 6170 5f73   1) / (min(map_s
+0003c6e0: 6861 7065 2920 2a20 7461 7069 7829 0a20  hape) * tapix). 
+0003c6f0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0003c700: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003c710: 206f 7267 203d 205b 286d 6170 5f73 6861   org = [(map_sha
+0003c720: 7065 5b30 5d20 2d20 3129 202f 2032 2c20  pe[0] - 1) / 2, 
+0003c730: 286d 6170 5f73 6861 7065 5b31 5d20 2d20  (map_shape[1] - 
+0003c740: 3129 202f 2032 2c20 286d 6170 5f73 6861  1) / 2, (map_sha
+0003c750: 7065 5b32 5d20 2d20 3129 202f 2032 5d0a  pe[2] - 1) / 2].
+0003c760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003c770: 696e 6469 6178 6973 203d 206e 702e 6c69  indiaxis = np.li
+0003c780: 6e73 7061 6365 2830 2c20 696e 7428 6d69  nspace(0, int(mi
+0003c790: 6e28 6f72 6729 292c 2069 6e74 286d 696e  n(org)), int(min
+0003c7a0: 286f 7267 2929 202b 2031 2920 2f20 286d  (org)) + 1) / (m
+0003c7b0: 696e 286d 6170 5f73 6861 7065 2920 2a20  in(map_shape) * 
+0003c7c0: 7461 7069 7829 0a20 2020 2020 2020 2020  tapix).         
+0003c7d0: 2020 2020 2020 2069 6e64 6961 7869 7320         indiaxis 
+0003c7e0: 3d20 6e70 2e61 7070 656e 6428 696e 6469  = np.append(indi
+0003c7f0: 6178 6973 2c20 312f 2832 202a 2074 6170  axis, 1/(2 * tap
+0003c800: 6978 2929 0a20 2020 2020 2020 2020 2020  ix)).           
+0003c810: 2023 2069 6e64 6961 7869 7320 3d20 6e70   # indiaxis = np
+0003c820: 2e6c 696e 7370 6163 6528 302c 2069 6e74  .linspace(0, int
+0003c830: 286f 7267 5b30 5d29 2c20 696e 7428 6f72  (org[0]), int(or
+0003c840: 675b 305d 2920 2b20 3129 202f 2028 6d61  g[0]) + 1) / (ma
+0003c850: 705f 7368 6170 655b 305d 202a 2074 6170  p_shape[0] * tap
+0003c860: 6978 290a 2020 2020 2020 2020 2020 2020  ix).            
+0003c870: 7368 656c 6c5f 7261 6e67 6520 3d20 696e  shell_range = in
+0003c880: 7428 6d69 6e28 6d61 705f 7368 6170 6529  t(min(map_shape)
+0003c890: 202d 206d 696e 286f 7267 2929 0a20 2020   - min(org)).   
+0003c8a0: 2020 2020 2020 2020 2066 6f72 2069 2069           for i i
+0003c8b0: 6e20 7261 6e67 6528 302c 2073 6865 6c6c  n range(0, shell
+0003c8c0: 5f72 616e 6765 293a 0a20 2020 2020 2020  _range):.       
+0003c8d0: 2020 2020 2020 2020 2069 6e64 6963 6573           indices
+0003c8e0: 203d 2073 656c 662e 6765 6e65 7261 7465   = self.generate
+0003c8f0: 5f73 6865 6c6c 2869 2c20 6920 2b20 312c  _shell(i, i + 1,
+0003c900: 206d 6170 5f73 6861 7065 290a 2020 2020   map_shape).    
+0003c910: 2020 2020 2020 2020 2020 2020 6f64 6472              oddr
+0003c920: 696e 6720 3d20 6d61 706f 6464 5f64 6174  ing = mapodd_dat
+0003c930: 615b 7475 706c 6528 696e 6469 6365 732e  a[tuple(indices.
+0003c940: 5429 5d0a 2020 2020 2020 2020 2020 2020  T)].            
+0003c950: 2020 2020 6576 656e 7269 6e67 203d 206d      evenring = m
+0003c960: 6170 6576 656e 5f64 6174 615b 7475 706c  apeven_data[tupl
+0003c970: 6528 696e 6469 6365 732e 5429 5d0a 2020  e(indices.T)].  
+0003c980: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0003c990: 7272 203d 2028 6f64 6472 696e 6720 2a20  rr = (oddring * 
+0003c9a0: 6e70 2e63 6f6e 6a28 6576 656e 7269 6e67  np.conj(evenring
+0003c9b0: 2929 2e73 756d 2829 0a20 2020 2020 2020  )).sum().       
+0003c9c0: 2020 2020 2020 2020 2063 6f72 725f 6465           corr_de
+0003c9d0: 6e6f 203d 206e 702e 7371 7274 2828 6e70  no = np.sqrt((np
+0003c9e0: 2e61 6273 286f 6464 7269 6e67 2920 2a2a  .abs(oddring) **
+0003c9f0: 2032 292e 7375 6d28 2920 2a20 286e 702e   2).sum() * (np.
+0003ca00: 6162 7328 6576 656e 7269 6e67 2920 2a2a  abs(evenring) **
+0003ca10: 2032 292e 7375 6d28 2929 0a20 2020 2020   2).sum()).     
+0003ca20: 2020 2020 2020 2020 2020 2069 6620 636f             if co
+0003ca30: 7272 5f64 656e 6f20 3d3d 2030 2e3a 0a20  rr_deno == 0.:. 
+0003ca40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ca50: 2020 206e 6f72 636f 7272 203d 2030 2e0a     norcorr = 0..
+0003ca60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ca70: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0003ca80: 2020 2020 2020 2020 2020 6e6f 7263 6f72            norcor
+0003ca90: 7220 3d20 6e70 2e72 6561 6c28 636f 7272  r = np.real(corr
+0003caa0: 202f 2063 6f72 725f 6465 6e6f 290a 2020   / corr_deno).  
+0003cab0: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0003cac0: 7272 6c69 7374 2e61 7070 656e 6428 6e6f  rrlist.append(no
+0003cad0: 7263 6f72 7229 0a0a 2020 2020 2020 2020  rcorr)..        
+0003cae0: 2020 2020 2020 2020 766f 6c75 6d65 6469          volumedi
+0003caf0: 6666 203d 2028 342e 3020 2f20 332e 3029  ff = (4.0 / 3.0)
+0003cb00: 202a 2070 6920 2a20 2828 6920 2b20 3129   * pi * ((i + 1)
+0003cb10: 202a 2a20 3320 2d20 6920 2a2a 2033 290a   ** 3 - i ** 3).
+0003cb20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003cb30: 6e76 6f78 7269 6e67 203d 2076 6f6c 756d  nvoxring = volum
+0003cb40: 6564 6966 6620 2f20 2831 202a 2a20 3329  ediff / (1 ** 3)
+0003cb50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003cb60: 2065 6666 6e76 6f78 203d 2028 6e76 6f78   effnvox = (nvox
+0003cb70: 7269 6e67 202a 2028 2831 2e35 202a 2030  ring * ((1.5 * 0
+0003cb80: 2e36 3629 202a 2a20 3229 2920 2f20 2832  .66) ** 2)) / (2
+0003cb90: 202a 2061 7379 6d29 0a20 2020 2020 2020   * asym).       
+0003cba0: 2020 2020 2020 2020 2069 6620 6566 666e           if effn
+0003cbb0: 766f 7820 3c20 312e 303a 2065 6666 6e76  vox < 1.0: effnv
+0003cbc0: 6f78 203d 2031 2e30 0a20 2020 2020 2020  ox = 1.0.       
+0003cbd0: 2020 2020 2020 2020 2073 7172 6566 666e           sqreffn
+0003cbe0: 766f 7820 3d20 6e70 2e73 7172 7428 6566  vox = np.sqrt(ef
+0003cbf0: 666e 766f 7829 0a0a 2020 2020 2020 2020  fnvox)..        
+0003cc00: 2020 2020 2020 2020 7369 6776 616c 7565          sigvalue
+0003cc10: 203d 2033 202f 2028 7371 7265 6666 6e76   = 3 / (sqreffnv
+0003cc20: 6f78 202b 2033 2e30 202d 2031 2e30 290a  ox + 3.0 - 1.0).
+0003cc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003cc40: 7468 7265 6573 6967 2e61 7070 656e 6428  threesig.append(
+0003cc50: 7369 6776 616c 7565 290a 2020 2020 2020  sigvalue).      
+0003cc60: 2020 2020 2020 2020 2020 6269 7476 616c            bitval
+0003cc70: 7565 203d 2028 302e 3230 3731 202b 2031  ue = (0.2071 + 1
+0003cc80: 2e39 3130 3220 2f20 7371 7265 6666 6e76  .9102 / sqreffnv
+0003cc90: 6f78 2920 2f20 2831 2e32 3037 3120 2b20  ox) / (1.2071 + 
+0003cca0: 302e 3931 3032 202f 2073 7172 6566 666e  0.9102 / sqreffn
+0003ccb0: 766f 7829 0a20 2020 2020 2020 2020 2020  vox).           
+0003ccc0: 2020 2020 2068 616c 6662 6974 2e61 7070       halfbit.app
+0003ccd0: 656e 6428 6269 7476 616c 7565 290a 2020  end(bitvalue).  
+0003cce0: 2020 2020 2020 2020 2020 2020 2020 6f6e                on
+0003ccf0: 6562 6974 7661 6c75 6520 3d20 2830 2e35  ebitvalue = (0.5
+0003cd00: 202b 2032 2e34 3134 3220 2f20 7371 7265   + 2.4142 / sqre
+0003cd10: 6666 6e76 6f78 2920 2f20 2831 2e35 202b  ffnvox) / (1.5 +
+0003cd20: 2031 2e34 3134 3220 2f20 7371 7265 6666   1.4142 / sqreff
+0003cd30: 6e76 6f78 290a 2020 2020 2020 2020 2020  nvox).          
+0003cd40: 2020 2020 2020 6f6e 6562 6974 2e61 7070        onebit.app
+0003cd50: 656e 6428 6f6e 6562 6974 7661 6c75 6529  end(onebitvalue)
+0003cd60: 0a0a 2020 2020 2020 2020 2020 2020 636f  ..            co
+0003cd70: 7272 6c69 7374 2e69 6e73 6572 7428 302c  rrlist.insert(0,
+0003cd80: 2031 290a 2020 2020 2020 2020 2020 2020   1).            
+0003cd90: 7468 7265 6573 6967 2e69 6e73 6572 7428  threesig.insert(
+0003cda0: 302c 2031 290a 2020 2020 2020 2020 2020  0, 1).          
+0003cdb0: 2020 6861 6c66 6269 742e 696e 7365 7274    halfbit.insert
+0003cdc0: 2830 2c20 3129 0a20 2020 2020 2020 2020  (0, 1).         
+0003cdd0: 2020 206f 6e65 6269 742e 696e 7365 7274     onebit.insert
+0003cde0: 2830 2c20 3129 0a20 2020 2020 2020 2020  (0, 1).         
+0003cdf0: 2020 2064 656c 206d 6170 6f64 645f 6461     del mapodd_da
+0003ce00: 7461 0a20 2020 2020 2020 2020 2020 2064  ta.            d
+0003ce10: 656c 206d 6170 6576 656e 5f64 6174 610a  el mapeven_data.
+0003ce20: 0a20 2020 2020 2020 2020 2020 2023 2049  .            # I
+0003ce30: 6620 616e 7920 6f66 2074 6865 2066 6972  f any of the fir
+0003ce40: 7374 2035 2076 616c 7565 7320 6973 206e  st 5 values is n
+0003ce50: 6567 6174 6976 652c 206d 616b 6520 6974  egative, make it
+0003ce60: 2074 6f20 310a 2020 2020 2020 2020 2020   to 1.          
+0003ce70: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
+0003ce80: 2830 2c20 3529 3a0a 2020 2020 2020 2020  (0, 5):.        
+0003ce90: 2020 2020 2020 2020 6966 2063 6f72 726c          if corrl
+0003cea0: 6973 745b 695d 203c 3d20 303a 0a20 2020  ist[i] <= 0:.   
+0003ceb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003cec0: 2063 6f72 726c 6973 745b 695d 203d 2031   corrlist[i] = 1
+0003ced0: 0a0a 2020 2020 2020 2020 2020 2020 6120  ..            a 
+0003cee0: 3d20 6e70 2e61 7361 7272 6179 2869 6e64  = np.asarray(ind
+0003cef0: 6961 7869 7329 0a20 2020 2020 2020 2020  iaxis).         
+0003cf00: 2020 2062 203d 206e 702e 6173 6172 7261     b = np.asarra
+0003cf10: 7928 636f 7272 6c69 7374 290a 2020 2020  y(corrlist).    
+0003cf20: 2020 2020 2020 2020 6320 3d20 6e70 2e61          c = np.a
+0003cf30: 7361 7272 6179 2874 6872 6565 7369 6729  sarray(threesig)
+0003cf40: 0a20 2020 2020 2020 2020 2020 2064 203d  .            d =
+0003cf50: 206e 702e 6173 6172 7261 7928 6861 6c66   np.asarray(half
+0003cf60: 6269 7429 0a20 2020 2020 2020 2020 2020  bit).           
+0003cf70: 2065 203d 206e 702e 6173 6172 7261 7928   e = np.asarray(
+0003cf80: 6f6e 6562 6974 290a 2020 2020 2020 2020  onebit).        
+0003cf90: 2020 2020 6620 3d20 6e70 2e66 756c 6c28      f = np.full(
+0003cfa0: 286c 656e 2869 6e64 6961 7869 7329 292c  (len(indiaxis)),
+0003cfb0: 2030 2e35 290a 2020 2020 2020 2020 2020   0.5).          
+0003cfc0: 2020 6720 3d20 6e70 2e66 756c 6c28 286c    g = np.full((l
+0003cfd0: 656e 2869 6e64 6961 7869 7329 292c 2030  en(indiaxis)), 0
+0003cfe0: 2e33 3333 290a 2020 2020 2020 2020 2020  .333).          
+0003cff0: 2020 6820 3d20 6e70 2e66 756c 6c28 286c    h = np.full((l
+0003d000: 656e 2869 6e64 6961 7869 7329 292c 2030  en(indiaxis)), 0
+0003d010: 2e31 3433 290a 2020 2020 2020 2020 2020  .143).          
+0003d020: 2020 2320 7573 6520 5b3a 315d 2074 6f20    # use [:1] to 
+0003d030: 6967 6e6f 7265 2061 6c6c 2074 6865 2063  ignore all the c
+0003d040: 7572 7665 7320 7374 6172 7420 6672 6f6d  urves start from
+0003d050: 2030 2c31 0a20 2020 2020 2020 2020 2020   0,1.           
+0003d060: 2078 7468 7265 6573 6967 2c20 7974 6872   xthreesig, ythr
+0003d070: 6565 7369 6720 3d20 7365 6c66 2e5f 5f69  eesig = self.__i
+0003d080: 6e74 6572 706f 6c61 7465 645f 696e 7465  nterpolated_inte
+0003d090: 7263 6570 7428 612c 2062 2c20 6329 0a20  rcept(a, b, c). 
+0003d0a0: 2020 2020 2020 2020 2020 2078 6861 6c66             xhalf
+0003d0b0: 6269 742c 2079 6861 6c66 6269 7420 3d20  bit, yhalfbit = 
+0003d0c0: 7365 6c66 2e5f 5f69 6e74 6572 706f 6c61  self.__interpola
+0003d0d0: 7465 645f 696e 7465 7263 6570 7428 612c  ted_intercept(a,
+0003d0e0: 2062 2c20 6429 0a20 2020 2020 2020 2020   b, d).         
+0003d0f0: 2020 2078 6f6e 6562 6974 2c20 796f 6e65     xonebit, yone
+0003d100: 6269 7420 3d20 7365 6c66 2e5f 5f69 6e74  bit = self.__int
+0003d110: 6572 706f 6c61 7465 645f 696e 7465 7263  erpolated_interc
+0003d120: 6570 7428 612c 2062 2c20 6529 0a20 2020  ept(a, b, e).   
+0003d130: 2020 2020 2020 2020 2078 6861 6c66 2c20           xhalf, 
+0003d140: 7968 616c 6620 3d20 7365 6c66 2e5f 5f69  yhalf = self.__i
+0003d150: 6e74 6572 706f 6c61 7465 645f 696e 7465  nterpolated_inte
+0003d160: 7263 6570 7428 612c 2062 2c20 6629 0a0a  rcept(a, b, f)..
+0003d170: 2020 2020 2020 2020 2020 2020 2320 4368              # Ch
+0003d180: 6563 6b20 6966 206d 6d20 696e 206c 6162  eck if mm in lab
+0003d190: 656c 2074 6865 6e2c 2073 6565 2077 6869  el then, see whi
+0003d1a0: 6368 2069 6e74 6572 7365 6369 6f6e 2069  ch intersecion i
+0003d1b0: 7320 7468 6520 6d6f 7374 2063 6c6f 7365  s the most close
+0003d1c0: 7374 2074 6f20 7468 6520 6769 7665 6e20  st to the given 
+0003d1d0: 7265 736f 6c75 7469 6f6e 2854 6f64 6f29  resolution(Todo)
+0003d1e0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0003d1f0: 276d 6d27 2069 6e20 6c61 6265 6c3a 0a20  'mm' in label:. 
+0003d200: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0003d210: 6620 7868 616c 662e 7369 7a65 2021 3d20  f xhalf.size != 
+0003d220: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+0003d230: 2020 2020 2020 206e 6577 7868 616c 6620         newxhalf 
+0003d240: 3d20 6162 7328 7868 616c 6620 2d20 3120  = abs(xhalf - 1 
+0003d250: 2f20 666c 6f61 7428 7365 6c66 2e72 6573  / float(self.res
+0003d260: 6f6c 7574 696f 6e29 290a 2020 2020 2020  olution)).      
+0003d270: 2020 2020 2020 2020 2020 2020 2020 696e                in
+0003d280: 646d 696e 203d 206e 702e 6172 676d 696e  dmin = np.argmin
+0003d290: 286e 6577 7868 616c 6629 0a20 2020 2020  (newxhalf).     
+0003d2a0: 2020 2020 2020 2020 2020 2020 2020 2078                 x
+0003d2b0: 6861 6c66 203d 206e 702e 6172 7261 7928  half = np.array(
+0003d2c0: 5b78 6861 6c66 5b69 6e64 6d69 6e5d 5d29  [xhalf[indmin]])
+0003d2d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003d2e0: 2020 2020 2079 6861 6c66 203d 206e 702e       yhalf = np.
+0003d2f0: 6172 7261 7928 5b79 6861 6c66 5b69 6e64  array([yhalf[ind
+0003d300: 6d69 6e5d 5d29 0a0a 2020 2020 2020 2020  min]])..        
+0003d310: 2020 2020 786f 6e65 7468 7265 652c 2079      xonethree, y
+0003d320: 6f6e 6574 6872 6565 203d 2073 656c 662e  onethree = self.
+0003d330: 5f5f 696e 7465 7270 6f6c 6174 6564 5f69  __interpolated_i
+0003d340: 6e74 6572 6365 7074 2861 2c20 622c 2067  ntercept(a, b, g
+0003d350: 290a 2020 2020 2020 2020 2020 2020 7867  ).            xg
+0003d360: 6f6c 642c 2079 676f 6c64 203d 2073 656c  old, ygold = sel
+0003d370: 662e 5f5f 696e 7465 7270 6f6c 6174 6564  f.__interpolated
+0003d380: 5f69 6e74 6572 6365 7074 2861 2c20 622c  _intercept(a, b,
+0003d390: 2068 290a 0a20 2020 2020 2020 2020 2020   h)..           
+0003d3a0: 2023 2041 7373 6967 6e20 696e 7465 7273   # Assign inters
+0003d3b0: 6563 7469 6f6e 2076 616c 7565 2061 7320  ection value as 
+0003d3c0: 4e6f 6e65 2077 6865 6e20 7468 6572 6520  None when there 
+0003d3d0: 6973 206e 6f20 696e 7465 7273 6563 7469  is no intersecti
+0003d3e0: 6f6e 0a20 2020 2020 2020 2020 2020 2069  on.            i
+0003d3f0: 6620 7874 6872 6565 7369 672e 7369 7a65  f xthreesig.size
+0003d400: 203d 3d20 3020 616e 6420 7974 6872 6565   == 0 and ythree
+0003d410: 7369 672e 7369 7a65 203d 3d20 303a 0a20  sig.size == 0:. 
+0003d420: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0003d430: 7269 6e74 2827 4e6f 2069 6e74 6572 7365  rint('No interse
+0003d440: 6374 696f 6e20 6265 7477 6565 6e20 4653  ction between FS
+0003d450: 4320 616e 6420 332d 7369 676d 6120 6375  C and 3-sigma cu
+0003d460: 7276 6573 2e20 4865 7265 2075 7365 2074  rves. Here use t
+0003d470: 6865 206c 6173 7420 706f 696e 742e 2729  he last point.')
+0003d480: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003d490: 2078 7468 7265 6573 6967 2c20 7974 6872   xthreesig, ythr
+0003d4a0: 6565 7369 6720 3d20 4e6f 6e65 2c20 4e6f  eesig = None, No
+0003d4b0: 6e65 0a20 2020 2020 2020 2020 2020 2065  ne.            e
+0003d4c0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0003d4d0: 2020 2020 2078 7468 7265 6573 6967 203d       xthreesig =
+0003d4e0: 206e 702e 726f 756e 6428 7874 6872 6565   np.round(xthree
+0003d4f0: 7369 675b 305d 5b30 5d2c 2034 290a 2020  sig[0][0], 4).  
+0003d500: 2020 2020 2020 2020 2020 2020 2020 7974                yt
+0003d510: 6872 6565 7369 6720 3d20 6e70 2e72 6f75  hreesig = np.rou
+0003d520: 6e64 2879 7468 7265 6573 6967 5b30 5d5b  nd(ythreesig[0][
+0003d530: 305d 2c20 3429 0a0a 2020 2020 2020 2020  0], 4)..        
+0003d540: 2020 2020 6966 2078 6861 6c66 6269 742e      if xhalfbit.
+0003d550: 7369 7a65 203d 3d20 3020 616e 6420 7968  size == 0 and yh
+0003d560: 616c 6662 6974 2e73 697a 6520 3d3d 2030  alfbit.size == 0
+0003d570: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003d580: 2020 7072 696e 7428 274e 6f20 696e 7465    print('No inte
+0003d590: 7273 6563 7469 6f6e 2062 6574 7765 656e  rsection between
+0003d5a0: 2046 5343 2061 6e64 2031 2f32 2d62 6974   FSC and 1/2-bit
+0003d5b0: 2063 7572 7665 732e 2048 6572 6520 7573   curves. Here us
+0003d5c0: 6520 7468 6520 6c61 7374 2070 6f69 6e74  e the last point
+0003d5d0: 2e27 290a 2020 2020 2020 2020 2020 2020  .').            
+0003d5e0: 2020 2020 7868 616c 6662 6974 2c20 7968      xhalfbit, yh
+0003d5f0: 616c 6662 6974 203d 204e 6f6e 652c 204e  alfbit = None, N
+0003d600: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+0003d610: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0003d620: 2020 2020 2020 7868 616c 6662 6974 203d        xhalfbit =
+0003d630: 206e 702e 726f 756e 6428 7868 616c 6662   np.round(xhalfb
+0003d640: 6974 5b30 5d5b 305d 2c20 3429 0a20 2020  it[0][0], 4).   
+0003d650: 2020 2020 2020 2020 2020 2020 2079 6861               yha
+0003d660: 6c66 6269 7420 3d20 6e70 2e72 6f75 6e64  lfbit = np.round
+0003d670: 2879 6861 6c66 6269 745b 305d 5b30 5d2c  (yhalfbit[0][0],
+0003d680: 2034 290a 0a20 2020 2020 2020 2020 2020   4)..           
+0003d690: 2069 6620 786f 6e65 6269 742e 7369 7a65   if xonebit.size
+0003d6a0: 203d 3d20 3020 616e 6420 796f 6e65 6269   == 0 and yonebi
+0003d6b0: 742e 7369 7a65 203d 3d20 303a 0a20 2020  t.size == 0:.   
+0003d6c0: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+0003d6d0: 6e74 2827 4e6f 2069 6e74 6572 7365 6374  nt('No intersect
+0003d6e0: 696f 6e20 6265 7477 6565 6e20 4653 4320  ion between FSC 
+0003d6f0: 616e 6420 312d 6269 7420 6375 7276 6573  and 1-bit curves
+0003d700: 2e20 4865 7265 2075 7365 2074 6865 206c  . Here use the l
+0003d710: 6173 7420 706f 696e 742e 2729 0a20 2020  ast point.').   
+0003d720: 2020 2020 2020 2020 2020 2020 2078 6f6e               xon
+0003d730: 6562 6974 2c20 796f 6e65 6269 7420 3d20  ebit, yonebit = 
+0003d740: 4e6f 6e65 2c20 4e6f 6e65 0a20 2020 2020  None, None.     
+0003d750: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0003d760: 2020 2020 2020 2020 2020 2020 2078 6f6e               xon
+0003d770: 6562 6974 203d 206e 702e 726f 756e 6428  ebit = np.round(
+0003d780: 786f 6e65 6269 745b 305d 5b30 5d2c 2034  xonebit[0][0], 4
+0003d790: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0003d7a0: 2020 796f 6e65 6269 7420 3d20 6e70 2e72    yonebit = np.r
+0003d7b0: 6f75 6e64 2879 6f6e 6562 6974 5b30 5d5b  ound(yonebit[0][
+0003d7c0: 305d 2c20 3429 0a0a 2020 2020 2020 2020  0], 4)..        
+0003d7d0: 2020 2020 6966 2078 6f6e 6574 6872 6565      if xonethree
+0003d7e0: 2e73 697a 6520 3d3d 2030 2061 6e64 2079  .size == 0 and y
+0003d7f0: 6f6e 6574 6872 6565 2e73 697a 6520 3d3d  onethree.size ==
+0003d800: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+0003d810: 2020 2020 7072 696e 7428 274e 6f20 696e      print('No in
+0003d820: 7465 7273 6563 7469 6f6e 2062 6574 7765  tersection betwe
+0003d830: 656e 2046 5343 2061 6e64 2030 2e33 3333  en FSC and 0.333
+0003d840: 2063 7572 7665 732e 2048 6572 6520 7573   curves. Here us
+0003d850: 6520 7468 6520 6c61 7374 2070 6f69 6e74  e the last point
+0003d860: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
+0003d870: 2020 2078 6f6e 6574 6872 6565 2c20 796f     xonethree, yo
+0003d880: 6e65 7468 7265 6520 3d20 4e6f 6e65 2c20  nethree = None, 
+0003d890: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+0003d8a0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0003d8b0: 2020 2020 2020 2078 6f6e 6574 6872 6565         xonethree
+0003d8c0: 203d 206e 702e 726f 756e 6428 786f 6e65   = np.round(xone
+0003d8d0: 7468 7265 655b 305d 5b30 5d2c 2034 290a  three[0][0], 4).
+0003d8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d8f0: 796f 6e65 7468 7265 6520 3d20 6e70 2e72  yonethree = np.r
+0003d900: 6f75 6e64 2879 6f6e 6574 6872 6565 5b30  ound(yonethree[0
+0003d910: 5d5b 305d 2c20 3429 0a0a 2020 2020 2020  ][0], 4)..      
+0003d920: 2020 2020 2020 6966 2078 6861 6c66 2e73        if xhalf.s
+0003d930: 697a 6520 3d3d 2030 2061 6e64 2079 6861  ize == 0 and yha
+0003d940: 6c66 2e73 697a 6520 3d3d 2030 3a0a 2020  lf.size == 0:.  
+0003d950: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+0003d960: 696e 7428 2721 2121 204e 6f20 696e 7465  int('!!! No inte
+0003d970: 7273 6563 7469 6f6e 2062 6574 7765 656e  rsection between
+0003d980: 2046 5343 2061 6e64 2030 2e35 2063 7572   FSC and 0.5 cur
+0003d990: 7665 732e 2048 6572 6520 7573 6520 7468  ves. Here use th
+0003d9a0: 6520 6c61 7374 2070 6f69 6e74 2729 0a20  e last point'). 
+0003d9b0: 2020 2020 2020 2020 2020 2020 2020 2078                 x
+0003d9c0: 6861 6c66 2c20 7968 616c 6620 3d20 4e6f  half, yhalf = No
+0003d9d0: 6e65 2c20 4e6f 6e65 0a20 2020 2020 2020  ne, None.       
+0003d9e0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0003d9f0: 2020 2020 2020 2020 2020 2078 6861 6c66             xhalf
+0003da00: 203d 206e 702e 726f 756e 6428 7868 616c   = np.round(xhal
+0003da10: 665b 305d 5b30 5d2c 2034 290a 2020 2020  f[0][0], 4).    
+0003da20: 2020 2020 2020 2020 2020 2020 7968 616c              yhal
+0003da30: 6620 3d20 6e70 2e72 6f75 6e64 2879 6861  f = np.round(yha
+0003da40: 6c66 5b30 5d5b 305d 2c20 3429 0a20 2020  lf[0][0], 4).   
+0003da50: 2020 2020 2020 2020 2069 6620 7867 6f6c           if xgol
+0003da60: 642e 7369 7a65 203d 3d20 3020 616e 6420  d.size == 0 and 
+0003da70: 7967 6f6c 642e 7369 7a65 203d 3d20 303a  ygold.size == 0:
+0003da80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003da90: 2070 7269 6e74 2827 2121 2120 4e6f 2069   print('!!! No i
+0003daa0: 6e74 6572 7365 6374 696f 6e20 6265 7477  ntersection betw
+0003dab0: 6565 6e20 4653 4320 616e 6420 302e 3134  een FSC and 0.14
+0003dac0: 3320 6375 7276 6573 2e20 4865 7265 2075  3 curves. Here u
+0003dad0: 7365 2074 6865 206c 6173 7420 706f 696e  se the last poin
+0003dae0: 7427 290a 2020 2020 2020 2020 2020 2020  t').            
+0003daf0: 2020 2020 7867 6f6c 642c 2079 676f 6c64      xgold, ygold
+0003db00: 203d 204e 6f6e 652c 204e 6f6e 650a 2020   = None, None.  
+0003db10: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0003db20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003db30: 7867 6f6c 6420 3d20 6e70 2e72 6f75 6e64  xgold = np.round
+0003db40: 2878 676f 6c64 5b30 5d5b 305d 2c20 3429  (xgold[0][0], 4)
+0003db50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003db60: 2079 676f 6c64 203d 206e 702e 726f 756e   ygold = np.roun
+0003db70: 6428 7967 6f6c 645b 305d 5b30 5d2c 2034  d(ygold[0][0], 4
+0003db80: 290a 0a0a 2020 2020 2020 2020 2020 2020  )...            
+0003db90: 6461 7461 6469 6374 203d 207b 0a20 2020  datadict = {.   
+0003dba0: 2020 2020 2020 2020 2020 2020 2027 6375               'cu
+0003dbb0: 7276 6573 273a 207b 2766 7363 273a 206e  rves': {'fsc': n
+0003dbc0: 702e 726f 756e 6428 6e70 2e72 6561 6c28  p.round(np.real(
+0003dbd0: 636f 7272 6c69 7374 292c 2034 292e 746f  corrlist), 4).to
+0003dbe0: 6c69 7374 2829 2c20 2774 6872 6565 7369  list(), 'threesi
+0003dbf0: 676d 6127 3a20 6e70 2e72 6f75 6e64 2874  gma': np.round(t
+0003dc00: 6872 6565 7369 672c 2034 292e 746f 6c69  hreesig, 4).toli
+0003dc10: 7374 2829 2c0a 2020 2020 2020 2020 2020  st(),.          
+0003dc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003dc30: 2027 6861 6c66 6269 7427 3a20 6e70 2e72   'halfbit': np.r
+0003dc40: 6f75 6e64 2868 616c 6662 6974 2c20 3429  ound(halfbit, 4)
+0003dc50: 2e74 6f6c 6973 7428 292c 0a20 2020 2020  .tolist(),.     
+0003dc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003dc70: 2020 2020 2020 276f 6e65 6269 7427 3a20        'onebit': 
+0003dc80: 6e70 2e72 6f75 6e64 286f 6e65 6269 742c  np.round(onebit,
+0003dc90: 2034 292e 746f 6c69 7374 2829 2c20 2730   4).tolist(), '0
+0003dca0: 2e35 273a 2066 2e74 6f6c 6973 7428 292c  .5': f.tolist(),
+0003dcb0: 2027 302e 3333 3327 3a20 672e 746f 6c69   '0.333': g.toli
+0003dcc0: 7374 2829 2c0a 2020 2020 2020 2020 2020  st(),.          
+0003dcd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003dce0: 2027 302e 3134 3327 3a20 682e 746f 6c69   '0.143': h.toli
+0003dcf0: 7374 2829 2c0a 2020 2020 2020 2020 2020  st(),.          
+0003dd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003dd10: 2027 6c65 7665 6c27 3a20 6e70 2e72 6f75   'level': np.rou
+0003dd20: 6e64 2869 6e64 6961 7869 732c 2034 292e  nd(indiaxis, 4).
+0003dd30: 746f 6c69 7374 2829 7d2c 0a20 2020 2020  tolist()},.     
+0003dd40: 2020 2020 2020 2020 2020 2027 696e 7465             'inte
+0003dd50: 7273 6563 7469 6f6e 7327 3a20 7b27 7468  rsections': {'th
+0003dd60: 7265 6573 6967 273a 207b 2778 273a 2078  reesig': {'x': x
+0003dd70: 7468 7265 6573 6967 2c20 2779 273a 2079  threesig, 'y': y
+0003dd80: 7468 7265 6573 6967 7d2c 0a20 2020 2020  threesig},.     
+0003dd90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003dda0: 2020 2020 2020 2020 2020 2020 2027 6861               'ha
+0003ddb0: 6c66 6269 7427 3a20 7b27 7827 3a20 7868  lfbit': {'x': xh
+0003ddc0: 616c 6662 6974 2c20 2779 273a 2079 6861  alfbit, 'y': yha
+0003ddd0: 6c66 6269 747d 2c0a 2020 2020 2020 2020  lfbit},.        
+0003dde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ddf0: 2020 2020 2020 2020 2020 276f 6e65 6269            'onebi
+0003de00: 7427 3a20 7b27 7827 3a20 786f 6e65 6269  t': {'x': xonebi
+0003de10: 742c 2027 7927 3a20 796f 6e65 6269 747d  t, 'y': yonebit}
+0003de20: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0003de30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003de40: 2020 2020 2730 2e35 273a 207b 2778 273a      '0.5': {'x':
+0003de50: 2078 6861 6c66 2c20 2779 273a 2079 6861   xhalf, 'y': yha
+0003de60: 6c66 7d2c 0a20 2020 2020 2020 2020 2020  lf},.           
+0003de70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003de80: 2020 2020 2020 2027 302e 3333 3327 3a20         '0.333': 
+0003de90: 7b27 7827 3a20 786f 6e65 7468 7265 652c  {'x': xonethree,
+0003dea0: 2027 7927 3a20 796f 6e65 7468 7265 657d   'y': yonethree}
+0003deb0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0003dec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ded0: 2020 2020 2730 2e31 3433 273a 207b 2778      '0.143': {'x
+0003dee0: 273a 2078 676f 6c64 2c20 2779 273a 2079  ': xgold, 'y': y
+0003def0: 676f 6c64 7d7d 7d0a 2020 2020 2020 2020  gold}}}.        
+0003df00: 2020 2020 6669 6e61 6c64 6963 7420 3d20      finaldict = 
+0003df10: 6469 6374 2829 0a20 2020 2020 2020 2020  dict().         
+0003df20: 2020 2066 696e 616c 6469 6374 5b6c 6162     finaldict[lab
+0003df30: 656c 202b 2027 6673 6327 5d20 3d20 6461  el + 'fsc'] = da
+0003df40: 7461 6469 6374 0a0a 2020 2020 2020 2020  tadict..        
+0003df50: 2020 2020 706c 742e 706c 6f74 2869 6e64      plt.plot(ind
+0003df60: 6961 7869 732c 2063 6f72 726c 6973 742c  iaxis, corrlist,
+0003df70: 206c 6162 656c 3d6c 6162 656c 202b 2027   label=label + '
+0003df80: 4653 4327 290a 2020 2020 2020 2020 2020  FSC').          
+0003df90: 2020 2320 706c 742e 706c 6f74 2869 6e64    # plt.plot(ind
+0003dfa0: 6961 7869 732c 2074 6872 6565 7369 672c  iaxis, threesig,
+0003dfb0: 206c 6162 656c 3d27 3320 7369 676d 6127   label='3 sigma'
+0003dfc0: 290a 2020 2020 2020 2020 2020 2020 706c  ).            pl
+0003dfd0: 742e 706c 6f74 2869 6e64 6961 7869 732c  t.plot(indiaxis,
+0003dfe0: 2068 616c 6662 6974 2c20 6c61 6265 6c3d   halfbit, label=
+0003dff0: 2731 2f32 2062 6974 2729 0a20 2020 2020  '1/2 bit').     
+0003e000: 2020 2020 2020 2023 2070 6c74 2e70 6c6f         # plt.plo
+0003e010: 7428 696e 6469 6178 6973 2c20 6f6e 6562  t(indiaxis, oneb
+0003e020: 6974 2c20 6c61 6265 6c3d 2731 2062 6974  it, label='1 bit
+0003e030: 2729 0a20 2020 2020 2020 2020 2020 2070  ').            p
+0003e040: 6c74 2e70 6c6f 7428 696e 6469 6178 6973  lt.plot(indiaxis
+0003e050: 2c20 662c 206c 6162 656c 3d27 302e 3527  , f, label='0.5'
+0003e060: 2c20 6c69 6e65 7374 796c 653d 273a 2729  , linestyle=':')
+0003e070: 0a20 2020 2020 2020 2020 2020 2023 2070  .            # p
+0003e080: 6c74 2e70 6c6f 7428 696e 6469 6178 6973  lt.plot(indiaxis
+0003e090: 2c20 672c 206c 6162 656c 3d27 302e 3333  , g, label='0.33
+0003e0a0: 3327 2c20 6c69 6e65 7374 796c 653d 272d  3', linestyle='-
+0003e0b0: 2d27 290a 2020 2020 2020 2020 2020 2020  -').            
+0003e0c0: 706c 742e 706c 6f74 2869 6e64 6961 7869  plt.plot(indiaxi
+0003e0d0: 732c 2068 2c20 6c61 6265 6c3d 2730 2e31  s, h, label='0.1
+0003e0e0: 3433 272c 206c 696e 6573 7479 6c65 3d27  43', linestyle='
+0003e0f0: 2d2e 2729 0a20 2020 2020 2020 2020 2020  -.').           
+0003e100: 2069 6620 7365 6c66 2e72 6573 6f6c 7574   if self.resolut
+0003e110: 696f 6e20 6973 206e 6f74 204e 6f6e 653a  ion is not None:
+0003e120: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003e130: 2070 6c74 2e70 6c6f 7428 5b31 2f66 6c6f   plt.plot([1/flo
+0003e140: 6174 2873 656c 662e 7265 736f 6c75 7469  at(self.resoluti
+0003e150: 6f6e 295d 202a 2031 3030 2c20 6e70 2e6c  on)] * 100, np.l
+0003e160: 696e 7370 6163 6528 302c 2031 2c20 3130  inspace(0, 1, 10
+0003e170: 3029 2c20 636f 6c6f 723d 2772 6564 2729  0), color='red')
+0003e180: 0a20 2020 2020 2020 2020 2020 2070 6c74  .            plt
+0003e190: 2e6c 6567 656e 6428 290a 2020 2020 2020  .legend().      
+0003e1a0: 2020 2020 2020 6966 206c 6162 656c 3a0a        if label:.
+0003e1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e1c0: 706c 742e 7361 7665 6669 6728 7365 6c66  plt.savefig(self
+0003e1d0: 2e77 6f72 6b64 6972 202b 2073 656c 662e  .workdir + self.
+0003e1e0: 6d61 706e 616d 6520 2b20 275f 2720 2b20  mapname + '_' + 
+0003e1f0: 6c61 6265 6c20 2b20 275f 6673 632e 706e  label + '_fsc.pn
+0003e200: 6727 290a 2020 2020 2020 2020 2020 2020  g').            
+0003e210: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0003e220: 2020 2020 2020 706c 742e 7361 7665 6669        plt.savefi
+0003e230: 6728 7365 6c66 2e77 6f72 6b64 6972 202b  g(self.workdir +
+0003e240: 2073 656c 662e 6d61 706e 616d 6520 2b20   self.mapname + 
+0003e250: 275f 6673 632e 706e 6727 290a 0a20 2020  '_fsc.png')..   
+0003e260: 2020 2020 2065 7863 6570 743a 0a20 2020       except:.   
+0003e270: 2020 2020 2020 2020 2065 7272 203d 2027           err = '
+0003e280: 4653 4320 6361 6c63 756c 6174 696f 6e20  FSC calculation 
+0003e290: 6572 726f 723a 207b 7d27 2e66 6f72 6d61  error: {}'.forma
+0003e2a0: 7428 7379 732e 6578 635f 696e 666f 2829  t(sys.exc_info()
+0003e2b0: 5b31 5d29 0a20 2020 2020 2020 2020 2020  [1]).           
+0003e2c0: 2065 7272 6c69 7374 2e61 7070 656e 6428   errlist.append(
+0003e2d0: 6572 7229 0a20 2020 2020 2020 2020 2020  err).           
+0003e2e0: 2073 7973 2e73 7464 6572 722e 7772 6974   sys.stderr.writ
+0003e2f0: 6528 6572 7220 2b20 275c 6e27 290a 0a20  e(err + '\n').. 
+0003e300: 2020 2020 2020 2069 6620 6572 726c 6973         if errlis
+0003e310: 743a 0a20 2020 2020 2020 2020 2020 2064  t:.            d
+0003e320: 6174 6164 6963 7420 3d20 7b27 6572 7227  atadict = {'err'
+0003e330: 3a20 7b6c 6162 656c 202b 2027 6673 635f  : {label + 'fsc_
+0003e340: 6572 726f 7227 3a20 6572 726c 6973 747d  error': errlist}
+0003e350: 7d0a 2020 2020 2020 2020 2020 2020 6669  }.            fi
+0003e360: 6e61 6c64 6963 745b 6c61 6265 6c20 2b20  naldict[label + 
+0003e370: 2766 7363 275d 203d 2064 6174 6164 6963  'fsc'] = datadic
+0003e380: 740a 2020 2020 2020 2020 656c 7365 3a0a  t.        else:.
+0003e390: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0003e3a0: 7428 274e 6f20 6572 726f 7220 696e 2046  t('No error in F
+0003e3b0: 5343 2063 616c 6375 6c61 7469 6f6e 2e27  SC calculation.'
+0003e3c0: 290a 0a20 2020 2020 2020 2069 6620 626f  )..        if bo
+0003e3d0: 6f6c 2864 6174 6164 6963 7429 2061 6e64  ol(datadict) and
+0003e3e0: 2062 6f6f 6c28 6669 6e61 6c64 6963 7429   bool(finaldict)
+0003e3f0: 3a0a 2020 2020 2020 2020 2020 2020 7472  :.            tr
+0003e400: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+0003e410: 2020 2077 6974 6820 636f 6465 6373 2e6f     with codecs.o
+0003e420: 7065 6e28 7365 6c66 2e77 6f72 6b64 6972  pen(self.workdir
+0003e430: 202b 2073 656c 662e 6d61 706e 616d 6520   + self.mapname 
+0003e440: 2b20 275f 2720 2b20 6c61 6265 6c20 2b20  + '_' + label + 
+0003e450: 2766 7363 2e6a 736f 6e27 2c20 2777 272c  'fsc.json', 'w',
+0003e460: 2065 6e63 6f64 696e 673d 2775 7466 2d38   encoding='utf-8
+0003e470: 2729 2061 7320 663a 0a20 2020 2020 2020  ') as f:.       
+0003e480: 2020 2020 2020 2020 2020 2020 206a 736f               jso
+0003e490: 6e2e 6475 6d70 2866 696e 616c 6469 6374  n.dump(finaldict
+0003e4a0: 2c20 6629 0a20 2020 2020 2020 2020 2020  , f).           
+0003e4b0: 2020 2020 2070 7269 6e74 2827 4653 4320       print('FSC 
+0003e4c0: 7072 6f64 7563 6564 2062 7920 7477 6f20  produced by two 
+0003e4d0: 6861 6c66 206d 6170 732e 2729 0a20 2020  half maps.').   
+0003e4e0: 2020 2020 2020 2020 2020 2020 2023 2077               # w
+0003e4f0: 6974 6820 636f 6465 6373 2e6f 7065 6e28  ith codecs.open(
+0003e500: 7365 6c66 2e77 6f72 6b64 6972 202b 206f  self.workdir + o
+0003e510: 6464 6e61 6d65 202b 2027 5f27 202b 2065  ddname + '_' + e
+0003e520: 7665 6e6e 616d 6520 2b20 275f 2720 2b20  venname + '_' + 
+0003e530: 6c61 6265 6c20 2b20 2766 7363 2e6a 736f  label + 'fsc.jso
+0003e540: 6e27 2c20 2777 272c 2065 6e63 6f64 696e  n', 'w', encodin
+0003e550: 673d 2775 7466 2d38 2729 2061 7320 6e66  g='utf-8') as nf
+0003e560: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003e570: 2020 2320 2020 2020 6a73 6f6e 2e64 756d    #     json.dum
+0003e580: 7028 6669 6e61 6c64 6963 742c 206e 6629  p(finaldict, nf)
+0003e590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003e5a0: 2023 2070 7269 6e74 2827 326e 6420 6673   # print('2nd fs
+0003e5b0: 6320 7361 7665 6427 290a 2020 2020 2020  c saved').      
+0003e5c0: 2020 2020 2020 6578 6365 7074 3a0a 2020        except:.  
+0003e5d0: 2020 2020 2020 2020 2020 2020 2020 7379                sy
+0003e5e0: 732e 7374 6465 7272 2e77 7269 7465 2827  s.stderr.write('
+0003e5f0: 5772 6974 696e 6720 4653 4320 6461 7461  Writing FSC data
+0003e600: 2074 6f20 6a73 6f6e 2066 696c 6520 6572   to json file er
+0003e610: 726f 723a 207b 7d2e 272e 666f 726d 6174  ror: {}.'.format
+0003e620: 2873 7973 2e65 7863 5f69 6e66 6f28 295b  (sys.exc_info()[
+0003e630: 315d 2929 0a20 2020 2020 2020 2065 6c73  1])).        els
+0003e640: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
+0003e650: 7973 2e73 7464 6572 722e 7772 6974 6528  ys.stderr.write(
+0003e660: 2746 5343 2063 616c 6375 6c61 7469 6f6e  'FSC calculation
+0003e670: 2067 6574 206e 6f6e 6520 2729 0a0a 2020   get none ')..  
+0003e680: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
+0003e690: 650a 0a20 2020 2040 7374 6174 6963 6d65  e..    @staticme
+0003e6a0: 7468 6f64 0a20 2020 2064 6566 206d 656d  thod.    def mem
+0003e6b0: 7072 6564 2872 6573 756c 7466 696c 652c  pred(resultfile,
+0003e6c0: 2069 6e70 7574 6669 6c65 7369 7a65 293a   inputfilesize):
+0003e6d0: 0a20 2020 2020 2020 2022 2222 0a0a 2020  .        """..  
+0003e6e0: 2020 2020 2020 2020 2020 5072 6f64 7563            Produc
+0003e6f0: 6520 6d65 6d6f 7279 2070 7265 6469 6374  e memory predict
+0003e700: 696f 6e20 7265 7375 6c74 7320 7573 696e  ion results usin
+0003e710: 6720 6c69 6e65 6172 2072 6567 7265 7373  g linear regress
+0003e720: 696f 6e0a 2020 2020 2020 2020 2020 2020  ion.            
+0003e730: 6261 7365 6420 6f6e 2074 6865 2064 6174  based on the dat
+0003e740: 6120 6672 6f6d 2070 7265 7669 6f75 7320  a from previous 
+0003e750: 656e 7472 6965 732e 0a0a 0a20 2020 2020  entries....     
+0003e760: 2020 203a 7061 7261 6d20 7265 7375 6c74     :param result
+0003e770: 6669 6c65 3a20 5072 6576 696f 7573 206d  file: Previous m
+0003e780: 656d 6f72 7920 7573 6167 6520 696e 666f  emory usage info
+0003e790: 726d 6174 696f 6e20 696e 2043 5356 2066  rmation in CSV f
+0003e7a0: 696c 650a 2020 2020 2020 2020 3a70 6172  ile.        :par
+0003e7b0: 616d 2069 6e70 7574 6669 6c65 7369 7a65  am inputfilesize
+0003e7c0: 3a20 5468 6520 696e 7075 7420 6465 6e73  : The input dens
+0003e7d0: 6974 7920 6d61 7020 7369 7a65 0a20 2020  ity map size.   
+0003e7e0: 2020 2020 203a 7265 7475 726e 3a20 3020       :return: 0 
+0003e7f0: 6f72 2079 5f70 7265 6420 2874 6865 2070  or y_pred (the p
+0003e800: 7265 6469 6374 6564 206d 656d 6f72 7920  redicted memory 
+0003e810: 7573 6167 6529 0a20 2020 2020 2020 2022  usage).        "
+0003e820: 2222 0a20 2020 2020 2020 2066 726f 6d20  "".        from 
+0003e830: 736b 6c65 6172 6e2e 6c69 6e65 6172 5f6d  sklearn.linear_m
+0003e840: 6f64 656c 2069 6d70 6f72 7420 4c69 6e65  odel import Line
+0003e850: 6172 5265 6772 6573 7369 6f6e 0a20 2020  arRegression.   
+0003e860: 2020 2020 2066 726f 6d20 736b 6c65 6172       from sklear
+0003e870: 6e2e 6d65 7472 6963 7320 696d 706f 7274  n.metrics import
+0003e880: 206d 6561 6e5f 7371 7561 7265 645f 6572   mean_squared_er
+0003e890: 726f 722c 2072 325f 7363 6f72 650a 2020  ror, r2_score.  
+0003e8a0: 2020 2020 2020 6672 6f6d 2073 6b6c 6561        from sklea
+0003e8b0: 726e 2e6d 6f64 656c 5f73 656c 6563 7469  rn.model_selecti
+0003e8c0: 6f6e 2069 6d70 6f72 7420 7472 6169 6e5f  on import train_
+0003e8d0: 7465 7374 5f73 706c 6974 0a20 2020 2020  test_split.     
+0003e8e0: 2020 2066 726f 6d20 736b 6c65 6172 6e2e     from sklearn.
+0003e8f0: 6d6f 6465 6c5f 7365 6c65 6374 696f 6e20  model_selection 
+0003e900: 696d 706f 7274 2063 726f 7373 5f76 616c  import cross_val
+0003e910: 5f73 636f 7265 2c20 6372 6f73 735f 7661  _score, cross_va
+0003e920: 6c5f 7072 6564 6963 740a 0a20 2020 2020  l_predict..     
+0003e930: 2020 2064 6174 6120 3d20 7064 2e72 6561     data = pd.rea
+0003e940: 645f 6373 7628 7265 7375 6c74 6669 6c65  d_csv(resultfile
+0003e950: 2c20 6865 6164 6572 3d30 290a 2020 2020  , header=0).    
+0003e960: 2020 2020 6461 7461 203d 2064 6174 612e      data = data.
+0003e970: 6472 6f70 6e61 2829 0a20 2020 2020 2020  dropna().       
+0003e980: 2069 6620 6461 7461 2e65 6d70 7479 3a0a   if data.empty:.
+0003e990: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0003e9a0: 7428 274e 6f20 7573 6566 756c 2064 6174  t('No useful dat
+0003e9b0: 6120 696e 2074 6865 2064 6174 6166 7261  a in the datafra
+0003e9c0: 6d65 2e27 290a 2020 2020 2020 2020 2020  me.').          
+0003e9d0: 2020 7265 7475 726e 204e 6f6e 650a 2020    return None.  
+0003e9e0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0003e9f0: 2020 2020 2020 2020 6e65 7764 6174 6120          newdata 
+0003ea00: 3d20 6461 7461 2e69 6c6f 635b 3a2c 2031  = data.iloc[:, 1
+0003ea10: 3a5d 0a20 2020 2020 2020 2020 2020 2073  :].            s
+0003ea20: 6f72 7464 6174 6120 3d20 6e65 7764 6174  ortdata = newdat
+0003ea30: 612e 736f 7274 5f76 616c 7565 7328 6e65  a.sort_values(ne
+0003ea40: 7764 6174 612e 636f 6c75 6d6e 735b 305d  wdata.columns[0]
+0003ea50: 290a 2020 2020 2020 2020 2020 2020 6d65  ).            me
+0003ea60: 7264 6174 6120 3d20 736f 7274 6461 7461  rdata = sortdata
+0003ea70: 2e67 726f 7570 6279 2873 6f72 7464 6174  .groupby(sortdat
+0003ea80: 612e 636f 6c75 6d6e 735b 305d 2c20 6173  a.columns[0], as
+0003ea90: 5f69 6e64 6578 3d46 616c 7365 292e 6d65  _index=False).me
+0003eaa0: 616e 2829 0a20 2020 2020 2020 2020 2020  an().           
+0003eab0: 2078 203d 206d 6572 6461 7461 5b27 6d61   x = merdata['ma
+0003eac0: 7072 6561 6c73 697a 6527 5d0a 2020 2020  prealsize'].    
+0003ead0: 2020 2020 2020 2020 7920 3d20 6d65 7264          y = merd
+0003eae0: 6174 615b 276d 656d 275d 0a20 2020 2020  ata['mem'].     
+0003eaf0: 2020 2020 2020 2069 6620 782e 7368 6170         if x.shap
+0003eb00: 655b 305d 203c 3d20 313a 0a20 2020 2020  e[0] <= 1:.     
+0003eb10: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0003eb20: 2827 5361 6d70 6c65 2069 7320 746f 6f20  ('Sample is too 
+0003eb30: 6c69 7474 6c65 2074 6f20 7370 6c69 742e  little to split.
+0003eb40: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
+0003eb50: 2020 2072 6574 7572 6e20 4e6f 6e65 0a20     return None. 
+0003eb60: 2020 2020 2020 2020 2020 2058 5f74 7261             X_tra
+0003eb70: 696e 2c20 585f 7465 7374 2c20 795f 7472  in, X_test, y_tr
+0003eb80: 6169 6e2c 2079 5f74 6573 7420 3d20 7472  ain, y_test = tr
+0003eb90: 6169 6e5f 7465 7374 5f73 706c 6974 2878  ain_test_split(x
+0003eba0: 2c20 792c 2074 6573 745f 7369 7a65 3d30  , y, test_size=0
+0003ebb0: 2e32 2c20 7261 6e64 6f6d 5f73 7461 7465  .2, random_state
+0003ebc0: 3d30 290a 2020 2020 2020 2020 2020 2020  =0).            
+0003ebd0: 6966 2058 5f74 7261 696e 2e65 6d70 7479  if X_train.empty
+0003ebe0: 206f 7220 585f 7465 7374 2e65 6d70 7479   or X_test.empty
+0003ebf0: 206f 7220 795f 7472 6169 6e2e 656d 7074   or y_train.empt
+0003ec00: 7920 6f72 2079 5f74 6573 742e 656d 7074  y or y_test.empt
+0003ec10: 7920 6f72 206c 656e 2878 2e69 6e64 6578  y or len(x.index
+0003ec20: 2920 3c20 3330 3a0a 2020 2020 2020 2020  ) < 30:.        
+0003ec30: 2020 2020 2020 2020 7072 696e 7428 2753          print('S
+0003ec40: 7061 7273 6520 6461 7461 2066 6f72 206d  parse data for m
+0003ec50: 656d 6f72 7920 7072 6564 6963 7469 6f6e  emory prediction
+0003ec60: 2c20 7265 7375 6c74 206d 6179 206e 6f74  , result may not
+0003ec70: 2061 6363 7572 6174 652e 2729 0a20 2020   accurate.').   
+0003ec80: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+0003ec90: 7572 6e20 4e6f 6e65 0a20 2020 2020 2020  urn None.       
+0003eca0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0003ecb0: 2020 2020 2020 2020 2020 206c 726d 6f64             lrmod
+0003ecc0: 656c 203d 204c 696e 6561 7252 6567 7265  el = LinearRegre
+0003ecd0: 7373 696f 6e28 6669 745f 696e 7465 7263  ssion(fit_interc
+0003ece0: 6570 743d 4661 6c73 6529 0a20 2020 2020  ept=False).     
+0003ecf0: 2020 2020 2020 2020 2020 2023 2050 6572             # Per
+0003ed00: 666f 726d 2043 560a 2020 2020 2020 2020  form CV.        
+0003ed10: 2020 2020 2020 2020 7363 6f72 6573 203d          scores =
+0003ed20: 2063 726f 7373 5f76 616c 5f73 636f 7265   cross_val_score
+0003ed30: 286c 726d 6f64 656c 2c20 782e 7661 6c75  (lrmodel, x.valu
+0003ed40: 6573 2e72 6573 6861 7065 282d 312c 2031  es.reshape(-1, 1
+0003ed50: 292c 2079 2c20 6376 3d36 290a 2020 2020  ), y, cv=6).    
+0003ed60: 2020 2020 2020 2020 2020 2020 7072 6564              pred
+0003ed70: 6963 7469 6f6e 7320 3d20 6372 6f73 735f  ictions = cross_
+0003ed80: 7661 6c5f 7072 6564 6963 7428 6c72 6d6f  val_predict(lrmo
+0003ed90: 6465 6c2c 2078 2e76 616c 7565 732e 7265  del, x.values.re
+0003eda0: 7368 6170 6528 2d31 2c20 3129 2c20 792c  shape(-1, 1), y,
+0003edb0: 2063 763d 3629 0a0a 2020 2020 2020 2020   cv=6)..        
+0003edc0: 2020 2020 2020 2020 6c72 6d6f 6465 6c2e          lrmodel.
+0003edd0: 6669 7428 585f 7472 6169 6e2e 7661 6c75  fit(X_train.valu
+0003ede0: 6573 2e72 6573 6861 7065 282d 312c 2031  es.reshape(-1, 1
+0003edf0: 292c 2079 5f74 7261 696e 290a 2020 2020  ), y_train).    
+0003ee00: 2020 2020 2020 2020 2020 2020 6c72 7072              lrpr
+0003ee10: 6564 6963 7420 3d20 6c72 6d6f 6465 6c2e  edict = lrmodel.
+0003ee20: 7072 6564 6963 7428 585f 7465 7374 2e76  predict(X_test.v
+0003ee30: 616c 7565 732e 7265 7368 6170 6528 2d31  alues.reshape(-1
+0003ee40: 2c20 3129 290a 2020 2020 2020 2020 2020  , 1)).          
+0003ee50: 2020 2020 2020 7072 696e 7428 2736 2d46        print('6-F
+0003ee60: 6f6c 6420 4356 2073 636f 7265 733a 2573  old CV scores:%s
+0003ee70: 2720 2520 7363 6f72 6573 290a 2020 2020  ' % scores).    
+0003ee80: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0003ee90: 7428 2743 5620 6163 6375 7261 6379 3a20  t('CV accuracy: 
+0003eea0: 2573 2720 2520 2872 325f 7363 6f72 6528  %s' % (r2_score(
+0003eeb0: 792c 2070 7265 6469 6374 696f 6e73 2929  y, predictions))
+0003eec0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0003eed0: 2020 2320 7072 696e 7420 2753 636f 7265    # print 'Score
+0003eee0: 3a25 7327 2025 2028 6c72 6d6f 6465 6c2e  :%s' % (lrmodel.
+0003eef0: 7363 6f72 6528 585f 7465 7374 2e76 616c  score(X_test.val
+0003ef00: 7565 732e 7265 7368 6170 6528 2d31 2c31  ues.reshape(-1,1
+0003ef10: 292c 2079 5f74 6573 7429 290a 2020 2020  ), y_test)).    
+0003ef20: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0003ef30: 7428 274c 696e 6561 7220 6d6f 6465 6c20  t('Linear model 
+0003ef40: 636f 6566 6669 6369 656e 7473 3a20 2573  coefficients: %s
+0003ef50: 2720 2520 286c 726d 6f64 656c 2e63 6f65  ' % (lrmodel.coe
+0003ef60: 665f 2929 0a20 2020 2020 2020 2020 2020  f_)).           
+0003ef70: 2020 2020 2070 7269 6e74 2827 4d53 453a       print('MSE:
+0003ef80: 2025 7327 2025 2028 6d65 616e 5f73 7175   %s' % (mean_squ
+0003ef90: 6172 6564 5f65 7272 6f72 2879 5f74 6573  ared_error(y_tes
+0003efa0: 742c 206c 7270 7265 6469 6374 2929 290a  t, lrpredict))).
 0003efb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003efc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003efd0: 2020 6572 726c 6973 742e 6170 7065 6e64    errlist.append
-0003efe0: 2865 7272 6c69 6e65 290a 2020 2020 2020  (errline).      
-0003eff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f010: 2020 6173 7365 7274 2065 7272 7072 6f73    assert errpros
-0003f020: 6861 6465 206e 6f74 2069 6e20 6f75 7470  hade not in outp
-0003f030: 7574 2e64 6563 6f64 6528 2775 7466 2d38  ut.decode('utf-8
-0003f040: 2729 2c20 6572 726c 696e 650a 2020 2020  '), errline.    
-0003f050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f060: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0003f070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f080: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0003f090: 7220 6974 656d 2069 6e20 6f75 7470 7574  r item in output
-0003f0a0: 2e73 706c 6974 2827 5c6e 2729 3a0a 2020  .split('\n'):.  
-0003f0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f0d0: 2020 7072 696e 7428 6974 656d 290a 2020    print(item).  
-0003f0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f100: 2020 6966 2065 7272 7072 6f73 6861 6465    if errproshade
-0003f110: 2069 6e20 6974 656d 3a0a 2020 2020 2020   in item:.      
-0003f120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f140: 2020 6572 726c 696e 6520 3d20 6974 656d    errline = item
-0003f150: 2e73 7472 6970 2829 0a20 2020 2020 2020  .strip().       
-0003f160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f180: 2065 7272 6c69 7374 2e61 7070 656e 6428   errlist.append(
-0003f190: 6572 726c 696e 6529 0a20 2020 2020 2020  errline).       
-0003f1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f1c0: 2061 7373 6572 7420 6572 7270 726f 7368   assert errprosh
-0003f1d0: 6164 6520 6e6f 7420 696e 206f 7574 7075  ade not in outpu
-0003f1e0: 742e 6465 636f 6465 2827 7574 662d 3827  t.decode('utf-8'
-0003f1f0: 292c 2065 7272 6c69 6e65 0a0a 2020 2020  ), errline..    
-0003f200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f210: 2020 2020 2020 2020 7072 6f73 6861 6465          proshade
-0003f220: 666f 6c64 6572 203d 2073 656c 662e 776f  folder = self.wo
-0003f230: 726b 6469 7220 2b20 2770 726f 7368 6164  rkdir + 'proshad
-0003f240: 655f 7265 706f 7274 270a 2020 2020 2020  e_report'.      
-0003f250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f260: 2020 2020 2020 7379 6d5f 7461 626c 6573        sym_tables
-0003f270: 203d 2027 7b7d 2f2a 2e74 6162 6c65 272e   = '{}/*.table'.
-0003f280: 666f 726d 6174 2870 726f 7368 6164 6566  format(proshadef
-0003f290: 6f6c 6465 7229 0a20 2020 2020 2020 2020  older).         
-0003f2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f2b0: 2020 206e 6669 6c65 696e 7072 6f73 6861     nfileinprosha
-0003f2c0: 6465 203d 206c 656e 285b 6620 666f 7220  de = len([f for 
-0003f2d0: 6620 696e 2067 6c6f 622e 676c 6f62 2873  f in glob.glob(s
-0003f2e0: 796d 5f74 6162 6c65 7329 5d29 0a20 2020  ym_tables)]).   
-0003f2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f300: 2020 2020 2020 2020 2023 206e 6669 6c65           # nfile
-0003f310: 696e 7072 6f73 6861 6465 203d 206c 656e  inproshade = len
-0003f320: 285b 6620 666f 7220 6620 696e 206f 732e  ([f for f in os.
-0003f330: 6c69 7374 6469 7228 7072 6f73 6861 6465  listdir(proshade
-0003f340: 666f 6c64 6572 2920 6966 206f 732e 7061  folder) if os.pa
-0003f350: 7468 2e69 7366 696c 6528 6f73 2e70 6174  th.isfile(os.pat
-0003f360: 682e 6a6f 696e 2870 726f 7368 6164 6566  h.join(proshadef
-0003f370: 6f6c 6465 722c 2066 2929 5d29 0a20 2020  older, f))]).   
-0003f380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f390: 2020 2020 2020 2020 2069 6620 6e66 696c           if nfil
-0003f3a0: 6569 6e70 726f 7368 6164 6520 3e3d 2033  einproshade >= 3
-0003f3b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003f3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f3d0: 2020 7379 6d6d 6574 7279 5265 7320 3d20    symmetryRes = 
-0003f3e0: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
-0003f3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f400: 2023 2073 706c 7374 7220 3d20 2752 4553   # splstr = 'RES
-0003f410: 554c 5453 270a 2020 2020 2020 2020 2020  ULTS'.          
-0003f420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f430: 2020 2320 6f75 7470 7574 7370 6c20 3d20    # outputspl = 
-0003f440: 6f75 7470 7574 2e73 706c 6974 2827 4465  output.split('De
-0003f450: 7465 6374 6564 2043 7963 6c69 6320 7379  tected Cyclic sy
-0003f460: 6d6d 6574 7279 272c 2031 290a 2020 2020  mmetry', 1).    
-0003f470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f480: 2020 2020 2020 2020 2320 6f75 7470 7574          # output
-0003f490: 7370 6c20 3d20 7265 2e73 706c 6974 2827  spl = re.split('
-0003f4a0: 5245 5355 4c54 5327 2c20 6f75 7470 7574  RESULTS', output
-0003f4b0: 2e64 6563 6f64 6528 2929 0a20 2020 2020  .decode()).     
-0003f4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f4d0: 2020 2020 2020 2023 2069 6620 7370 6c73         # if spls
-0003f4e0: 7472 2069 6e20 6f75 7470 7574 2e64 6563  tr in output.dec
-0003f4f0: 6f64 6528 293a 0a20 2020 2020 2020 2020  ode():.         
-0003f500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f510: 2020 2023 2020 2020 2070 7269 6e74 286f     #     print(o
-0003f520: 7574 7075 7473 706c 5b31 5d29 0a20 2020  utputspl[1]).   
-0003f530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f540: 2020 2020 2020 2020 2023 2065 6c73 653a           # else:
-0003f550: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003f560: 2020 2020 2020 2020 2020 2020 2023 2020               #  
-0003f570: 2020 2070 7269 6e74 286f 7574 7075 7473     print(outputs
-0003f580: 706c 5b30 5d29 0a0a 2020 2020 2020 2020  pl[0])..        
-0003f590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f5a0: 2020 2020 2320 7365 6c66 2e6d 6f76 6570      # self.movep
-0003f5b0: 726f 7368 6164 6552 6573 756c 7428 290a  roshadeResult().
-0003f5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f5d0: 2020 2020 2020 2020 2020 2020 656e 6420              end 
-0003f5e0: 3d20 7469 6d65 6974 2e64 6566 6175 6c74  = timeit.default
-0003f5f0: 5f74 696d 6572 2829 0a20 2020 2020 2020  _timer().       
-0003f600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f610: 2020 2020 2070 7269 6e74 2827 5379 6d6d       print('Symm
-0003f620: 6574 7279 2074 696d 653a 2025 7327 2025  etry time: %s' %
-0003f630: 2028 656e 6420 2d20 7374 6172 7429 290a   (end - start)).
+0003efc0: 7072 696e 7428 2756 6172 6961 6e63 6520  print('Variance 
+0003efd0: 7363 6f72 6528 7465 7374 2061 6363 7572  score(test accur
+0003efe0: 6163 7929 3a20 2573 2720 2520 2872 325f  acy): %s' % (r2_
+0003eff0: 7363 6f72 6528 795f 7465 7374 2c20 6c72  score(y_test, lr
+0003f000: 7072 6564 6963 7429 2929 0a20 2020 2020  predict))).     
+0003f010: 2020 2020 2020 2020 2020 2079 5f70 7265             y_pre
+0003f020: 6420 3d20 6c72 6d6f 6465 6c2e 7072 6564  d = lrmodel.pred
+0003f030: 6963 7428 5b5b 696e 7075 7466 696c 6573  ict([[inputfiles
+0003f040: 697a 655d 5d29 0a0a 2020 2020 2020 2020  ize]])..        
+0003f050: 2020 2020 2020 2020 7265 7475 726e 2079          return y
+0003f060: 5f70 7265 640a 0a20 2020 2040 7374 6174  _pred..    @stat
+0003f070: 6963 6d65 7468 6f64 0a20 2020 2064 6566  icmethod.    def
+0003f080: 2073 6176 6570 6561 6b6d 656d 6f72 7928   savepeakmemory(
+0003f090: 6669 6c65 6e61 6d65 2c20 6d61 786d 656d  filename, maxmem
+0003f0a0: 293a 0a20 2020 2020 2020 2022 2222 0a0a  ):.        """..
+0003f0b0: 2020 2020 2020 2020 2020 2020 4461 7461              Data
+0003f0c0: 2063 6f6c 6c65 6374 6564 2061 6e64 2074   collected and t
+0003f0d0: 6f20 6265 2075 7365 6420 666f 7220 7072  o be used for pr
+0003f0e0: 6564 6963 7469 6f6e 2066 6f72 206d 656d  ediction for mem
+0003f0f0: 6f72 7920 7573 6167 650a 2020 2020 2020  ory usage.      
+0003f100: 2020 2020 2020 4d65 6d6f 7279 2073 6176        Memory sav
+0003f110: 6564 2061 7320 6120 636f 6d6d 6120 7365  ed as a comma se
+0003f120: 7061 7261 7465 2043 5356 2066 696c 652e  parate CSV file.
+0003f130: 0a0a 0a20 2020 2020 2020 203a 7061 7261  ...        :para
+0003f140: 6d20 6669 6c65 6e61 6d65 3a20 5374 7269  m filename: Stri
+0003f150: 6e67 2066 6f72 2066 696c 6520 7768 6963  ng for file whic
+0003f160: 6820 7573 6564 2074 6f20 636f 6c6c 6563  h used to collec
+0003f170: 7420 6461 7461 0a20 2020 2020 2020 203a  t data.        :
+0003f180: 7061 7261 6d20 6d61 786d 656d 3a20 466c  param maxmem: Fl
+0003f190: 6f61 7420 6e75 6d62 6572 2077 6869 6368  oat number which
+0003f1a0: 2067 6976 6573 2070 6561 6b20 6d65 6d6f   gives peak memo
+0003f1b0: 7279 2075 7361 6765 206f 6620 7468 6520  ry usage of the 
+0003f1c0: 6669 6e69 7368 6564 206a 6f62 0a20 2020  finished job.   
+0003f1d0: 2020 2020 203a 7265 7475 726e 3a20 4e6f       :return: No
+0003f1e0: 6e65 0a0a 2020 2020 2020 2020 2222 220a  ne..        """.
+0003f1f0: 0a20 2020 2020 2020 2063 6f6c 756d 6e6e  .        columnn
+0003f200: 616d 6520 3d20 276d 656d 270a 2020 2020  ame = 'mem'.    
+0003f210: 2020 2020 2320 6469 7220 3d20 4d41 505f      # dir = MAP_
+0003f220: 5345 5256 4552 5f50 4154 4820 6966 2073  SERVER_PATH if s
+0003f230: 656c 662e 656d 6469 6420 6973 206e 6f74  elf.emdid is not
+0003f240: 204e 6f6e 6520 656c 7365 206f 732e 7061   None else os.pa
+0003f250: 7468 2e64 6972 6e61 6d65 286f 732e 7061  th.dirname(os.pa
+0003f260: 7468 2e64 6972 6e61 6d65 2873 656c 662e  th.dirname(self.
+0003f270: 776f 726b 6469 7229 290a 2020 2020 2020  workdir)).      
+0003f280: 2020 2320 6669 6c65 6e61 6d65 203d 2064    # filename = d
+0003f290: 6972 202b 2027 696e 7075 742e 6373 7627  ir + 'input.csv'
+0003f2a0: 0a20 2020 2020 2020 206d 656d 7265 7375  .        memresu
+0003f2b0: 6c74 6669 6c65 203d 2066 696c 656e 616d  ltfile = filenam
+0003f2c0: 650a 2020 2020 2020 2020 6466 203d 2070  e.        df = p
+0003f2d0: 642e 7265 6164 5f63 7376 2866 696c 656e  d.read_csv(filen
+0003f2e0: 616d 652c 2068 6561 6465 723d 302c 2073  ame, header=0, s
+0003f2f0: 6570 3d27 2c27 2c20 736b 6970 696e 6974  ep=',', skipinit
+0003f300: 6961 6c73 7061 6365 3d54 7275 6529 0a20  ialspace=True). 
+0003f310: 2020 2020 2020 2064 665b 636f 6c75 6d6e         df[column
+0003f320: 6e61 6d65 5d5b 6c65 6e28 6466 2e69 6e64  name][len(df.ind
+0003f330: 6578 2920 2d20 315d 203d 206d 6178 6d65  ex) - 1] = maxme
+0003f340: 6d0a 2020 2020 2020 2020 6466 2e74 6f5f  m.        df.to_
+0003f350: 6373 7628 6d65 6d72 6573 756c 7466 696c  csv(memresultfil
+0003f360: 652c 2073 6570 3d27 2c27 2c20 696e 6465  e, sep=',', inde
+0003f370: 783d 4661 6c73 6529 0a0a 2020 2020 2020  x=False)..      
+0003f380: 2020 7265 7475 726e 204e 6f6e 650a 0a0a    return None...
+0003f390: 2020 2020 2320 4070 726f 6669 6c65 0a20      # @profile. 
+0003f3a0: 2020 2064 6566 2073 796d 6d65 7472 7928     def symmetry(
+0003f3b0: 7365 6c66 293a 0a20 2020 2020 2020 2022  self):.        "
+0003f3c0: 2222 0a20 2020 2020 2020 2020 2020 2050  "".            P
+0003f3d0: 726f 6475 696e 6720 7379 6d6d 6574 7279  roduing symmetry
+0003f3e0: 2069 6e66 6f72 6d61 7469 6f6e 206f 6620   information of 
+0003f3f0: 7468 6520 6d61 7020 6279 2075 7369 6e67  the map by using
+0003f400: 2050 726f 7368 6164 650a 2020 2020 2020   Proshade.      
+0003f410: 2020 2020 2020 5468 6973 2066 756e 6374        This funct
+0003f420: 696f 6e20 7573 696e 6720 7468 6520 6269  ion using the bi
+0003f430: 6e61 7279 2070 726f 7368 6164 6520 7072  nary proshade pr
+0003f440: 6f67 7261 6d20 206e 6f74 2074 6865 2070  ogram  not the p
+0003f450: 7974 686f 6e20 6170 690a 0a20 2020 2020  ython api..     
+0003f460: 2020 203a 7265 7475 726e 3a20 204e 6f6e     :return:  Non
+0003f470: 650a 2020 2020 2020 2020 2222 220a 0a20  e.        """.. 
+0003f480: 2020 2020 2020 2069 6620 7365 6c66 2e70         if self.p
+0003f490: 6c61 7466 6f72 6d20 3d3d 2027 656d 6462  latform == 'emdb
+0003f4a0: 273a 0a20 2020 2020 2020 2020 2020 2073  ':.            s
+0003f4b0: 7461 7274 203d 2074 696d 6569 742e 6465  tart = timeit.de
+0003f4c0: 6661 756c 745f 7469 6d65 7228 290a 2020  fault_timer().  
+0003f4d0: 2020 2020 2020 2020 2020 6572 726c 6973            errlis
+0003f4e0: 7420 3d20 5b5d 0a20 2020 2020 2020 2020  t = [].         
+0003f4f0: 2020 2066 696e 616c 6469 6374 203d 207b     finaldict = {
+0003f500: 7d0a 2020 2020 2020 2020 2020 2020 7379  }.            sy
+0003f510: 6d6d 6574 7279 5265 7320 3d20 4661 6c73  mmetryRes = Fals
+0003f520: 650a 2020 2020 2020 2020 2020 2020 7265  e.            re
+0003f530: 7366 6163 746f 7220 3d20 312e 300a 2020  sfactor = 1.0.  
+0003f540: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+0003f550: 662e 6d65 7420 6973 206e 6f74 204e 6f6e  f.met is not Non
+0003f560: 6520 616e 6420 7365 6c66 2e72 6573 6f6c  e and self.resol
+0003f570: 7574 696f 6e20 6973 206e 6f74 204e 6f6e  ution is not Non
+0003f580: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0003f590: 2020 2069 6620 7365 6c66 2e6d 6574 2021     if self.met !
+0003f5a0: 3d20 2774 6f6d 6f27 2061 6e64 2073 656c  = 'tomo' and sel
+0003f5b0: 662e 6d65 7420 213d 2027 6865 6c69 273a  f.met != 'heli':
+0003f5c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003f5d0: 2020 2020 2070 726f 7368 6164 6520 3d20       proshade = 
+0003f5e0: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
+0003f5f0: 2020 2020 2020 2020 2020 6966 2050 524f            if PRO
+0003f600: 5348 4144 4550 4154 483a 0a20 2020 2020  SHADEPATH:.     
+0003f610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f620: 2020 2070 726f 7368 6164 6570 6174 6820     proshadepath 
+0003f630: 3d20 5052 4f53 4841 4445 5041 5448 0a20  = PROSHADEPATH. 
 0003f640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f650: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0003f660: 7428 272d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  t('-------------
-0003f670: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0003f680: 2d2d 2d2d 2d2d 2d27 290a 2020 2020 2020  -------').      
-0003f690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f6a0: 2020 6578 6365 7074 3a0a 2020 2020 2020    except:.      
-0003f6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f6c0: 2020 2020 2020 6572 7220 3d20 2753 796d        err = 'Sym
-0003f6d0: 6d65 7472 7920 6361 6c63 756c 6174 696f  metry calculatio
-0003f6e0: 6e20 6572 726f 723a 207b 7d2e 272e 666f  n error: {}.'.fo
-0003f6f0: 726d 6174 2873 7973 2e65 7863 5f69 6e66  rmat(sys.exc_inf
-0003f700: 6f28 295b 315d 290a 2020 2020 2020 2020  o()[1]).        
-0003f710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f720: 2020 2020 6572 726c 6973 742e 6170 7065      errlist.appe
-0003f730: 6e64 2865 7272 290a 2020 2020 2020 2020  nd(err).        
-0003f740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f750: 2020 2020 7379 732e 7374 6465 7272 2e77      sys.stderr.w
-0003f760: 7269 7465 2865 7272 202b 2027 5c6e 2729  rite(err + '\n')
-0003f770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003f780: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-0003f790: 6e74 2827 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  nt('------------
-0003f7a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0003f7b0: 2d2d 2d2d 2d2d 2d2d 2729 0a0a 2020 2020  --------')..    
-0003f7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f7d0: 2020 2020 6966 2065 7272 6c69 7374 3a0a      if errlist:.
-0003f7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f7f0: 2020 2020 2020 2020 2020 2020 6669 6e61              fina
-0003f800: 6c64 6963 745b 2773 796d 6d65 7472 7927  ldict['symmetry'
-0003f810: 5d20 3d20 7b27 6572 7227 3a20 7b27 7379  ] = {'err': {'sy
-0003f820: 6d6d 6574 7279 5f65 7272 273a 2065 7272  mmetry_err': err
-0003f830: 6c69 7374 7d7d 0a20 2020 2020 2020 2020  list}}.         
-0003f840: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0003f850: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0003f860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f870: 2066 696e 616c 6469 6374 5b27 7379 6d6d   finaldict['symm
-0003f880: 6574 7279 275d 203d 207b 2773 796d 6d65  etry'] = {'symme
-0003f890: 7472 795f 696e 666f 273a 2073 796d 6d65  try_info': symme
-0003f8a0: 7472 7952 6573 7d0a 0a20 2020 2020 2020  tryRes}..       
-0003f8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f8c0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-0003f8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f8e0: 2020 7769 7468 2063 6f64 6563 732e 6f70    with codecs.op
-0003f8f0: 656e 2873 656c 662e 776f 726b 6469 7220  en(self.workdir 
-0003f900: 2b20 7365 6c66 2e6d 6170 6e61 6d65 202b  + self.mapname +
-0003f910: 2027 5f73 796d 6d65 7472 792e 6a73 6f6e   '_symmetry.json
-0003f920: 272c 2027 7727 2c0a 2020 2020 2020 2020  ', 'w',.        
+0003f650: 2020 2020 2020 2070 726f 7368 6164 6520         proshade 
+0003f660: 3d20 5472 7565 0a0a 2020 2020 2020 2020  = True..        
+0003f670: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0003f680: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003f690: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+0003f6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f6b0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0003f6c0: 7420 6669 6e64 5f65 7865 6375 7461 626c  t find_executabl
+0003f6d0: 6528 2770 726f 7368 6164 6527 2920 6973  e('proshade') is
+0003f6e0: 206e 6f74 204e 6f6e 650a 2020 2020 2020   not None.      
+0003f6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f700: 2020 2020 2020 7072 6f73 6861 6465 7061        proshadepa
+0003f710: 7468 203d 2066 696e 645f 6578 6563 7574  th = find_execut
+0003f720: 6162 6c65 2827 7072 6f73 6861 6465 2729  able('proshade')
+0003f730: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003f740: 2020 2020 2020 2020 2020 2020 2070 726f               pro
+0003f750: 7368 6164 6520 3d20 5472 7565 0a20 2020  shade = True.   
+0003f760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f770: 2020 2020 2065 7863 6570 7420 4173 7365       except Asse
+0003f780: 7274 696f 6e45 7272 6f72 3a0a 2020 2020  rtionError:.    
+0003f790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f7a0: 2020 2020 2020 2020 7379 732e 7374 6465          sys.stde
+0003f7b0: 7272 2e77 7269 7465 2827 7072 6f73 6861  rr.write('prosha
+0003f7c0: 6465 2065 7865 6375 7461 626c 6520 6973  de executable is
+0003f7d0: 206e 6f74 2074 6865 7265 2c20 706c 6561   not there, plea
+0003f7e0: 7365 2069 6e73 7461 6c6c 2070 726f 7368  se install prosh
+0003f7f0: 6164 652e 5c6e 2729 0a20 2020 2020 2020  ade.\n').       
+0003f800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f810: 2020 2020 2073 7973 2e73 7464 6572 722e       sys.stderr.
+0003f820: 7772 6974 6528 2753 796d 6d65 7472 7920  write('Symmetry 
+0003f830: 696e 666f 726d 6174 696f 6e20 7769 6c6c  information will
+0003f840: 206e 6f74 2062 6520 7072 6f64 7563 6564   not be produced
+0003f850: 2e5c 6e27 290a 0a20 2020 2020 2020 2020  .\n')..         
+0003f860: 2020 2020 2020 2020 2020 2069 6620 7072             if pr
+0003f870: 6f73 6861 6465 3a0a 2020 2020 2020 2020  oshade:.        
+0003f880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f890: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0003f8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f8b0: 2066 756c 6c6d 6170 7061 7468 203d 2027   fullmappath = '
+0003f8c0: 7b7d 7b7d 272e 666f 726d 6174 2873 656c  {}{}'.format(sel
+0003f8d0: 662e 776f 726b 6469 722c 2073 656c 662e  f.workdir, self.
+0003f8e0: 6d61 706e 616d 6529 0a20 2020 2020 2020  mapname).       
+0003f8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f900: 2020 2020 2069 6620 2763 6370 656d 2720       if 'ccpem' 
+0003f910: 6e6f 7420 696e 2050 524f 5348 4144 4550  not in PROSHADEP
+0003f920: 4154 483a 0a20 2020 2020 2020 2020 2020  ATH:.           
 0003f930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f950: 2020 2020 2065 6e63 6f64 696e 673d 2775       encoding='u
-0003f960: 7466 2d38 2729 2061 7320 663a 0a20 2020  tf-8') as f:.   
-0003f970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f980: 2020 2020 2020 2020 2020 2020 206a 736f               jso
-0003f990: 6e2e 6475 6d70 2866 696e 616c 6469 6374  n.dump(finaldict
-0003f9a0: 2c20 6629 0a20 2020 2020 2020 2020 2020  , f).           
-0003f9b0: 2020 2020 2020 2020 2020 2020 2065 7863               exc
-0003f9c0: 6570 7420 494f 4572 726f 7220 6173 2069  ept IOError as i
-0003f9d0: 6f65 7272 3a0a 2020 2020 2020 2020 2020  oerr:.          
-0003f9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003f9f0: 2020 7379 732e 7374 6465 7272 2e77 7269    sys.stderr.wri
-0003fa00: 7465 2827 5361 7669 6e67 2073 796d 6d65  te('Saving symme
-0003fa10: 7472 7920 696e 666f 726d 6174 696f 6e20  try information 
-0003fa20: 746f 206a 736f 6e20 6572 723a 207b 7d2e  to json err: {}.
-0003fa30: 5c6e 272e 666f 726d 6174 2869 6f65 7272  \n'.format(ioerr
-0003fa40: 2929 0a0a 0a0a 2020 2020 2020 2020 2020  ))....          
-0003fa50: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0003f940: 2020 2020 2023 2063 6d64 203d 206c 6973       # cmd = lis
+0003f950: 7428 2850 524f 5348 4144 4550 4154 4820  t((PROSHADEPATH 
+0003f960: 2b20 2720 2d53 202d 6620 2720 2b20 7365  + ' -S -f ' + se
+0003f970: 6c66 2e6d 6170 2e66 696c 656e 616d 6520  lf.map.filename 
+0003f980: 2b20 2720 2d73 2027 202b 2073 7472 2866  + ' -s ' + str(f
+0003f990: 6c6f 6174 2873 656c 662e 7265 736f 6c75  loat(self.resolu
+0003f9a0: 7469 6f6e 2920 2a20 7265 7366 6163 746f  tion) * resfacto
+0003f9b0: 7229 292e 7370 6c69 7428 2720 2729 290a  r)).split(' ')).
+0003f9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f9e0: 636d 6420 3d20 6c69 7374 2828 5052 4f53  cmd = list((PROS
+0003f9f0: 4841 4445 5041 5448 202b 2027 202d 5320  HADEPATH + ' -S 
+0003fa00: 2d66 2027 202b 2073 656c 662e 6d61 702e  -f ' + self.map.
+0003fa10: 6675 6c6c 6e61 6d65 202b 2027 202d 7320  fullname + ' -s 
+0003fa20: 2720 2b20 7374 7228 666c 6f61 7428 7365  ' + str(float(se
+0003fa30: 6c66 2e72 6573 6f6c 7574 696f 6e29 202a  lf.resolution) *
+0003fa40: 2072 6573 6661 6374 6f72 2929 2e73 706c   resfactor)).spl
+0003fa50: 6974 2827 2027 2929 0a20 2020 2020 2020  it(' ')).       
 0003fa60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003fa70: 2020 2020 2020 2020 7379 732e 7374 6465          sys.stde
-0003fa80: 7272 2e77 7269 7465 2827 5072 6f73 6861  rr.write('Prosha
-0003fa90: 6465 2069 7320 6e6f 7420 696e 7374 616c  de is not instal
-0003faa0: 6c65 642e 2054 6865 7265 2077 696c 6c20  led. There will 
-0003fab0: 6265 206e 6f20 7379 6d6d 6574 7279 2069  be no symmetry i
-0003fac0: 6e66 6f72 6d61 7469 6f6e 2e5c 6e27 290a  nformation.\n').
-0003fad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003fae0: 2020 2020 2020 2020 7072 696e 7428 272d          print('-
-0003faf0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0003fb00: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0003fb10: 2d2d 2d27 290a 0a20 2020 2020 2020 2020  ---')..         
-0003fb20: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0003fa70: 2020 2020 2020 2020 2070 7269 6e74 2863           print(c
+0003fa80: 6d64 290a 2020 2020 2020 2020 2020 2020  md).            
+0003fa90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003faa0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0003fab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fac0: 2020 2020 2020 7368 6172 6569 6e64 6578        shareindex
+0003fad0: 203d 205b 6964 7820 666f 7220 6964 782c   = [idx for idx,
+0003fae0: 2073 2069 6e20 656e 756d 6572 6174 6528   s in enumerate(
+0003faf0: 5052 4f53 4841 4445 5041 5448 2e73 706c  PROSHADEPATH.spl
+0003fb00: 6974 2827 2f27 2929 2069 6620 2763 6370  it('/')) if 'ccp
+0003fb10: 656d 2d27 2069 6e20 735d 5b30 5d20 2b20  em-' in s][0] + 
+0003fb20: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
 0003fb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003fb40: 2073 7973 2e73 7464 6572 722e 7772 6974   sys.stderr.writ
-0003fb50: 6528 2754 6869 7320 6973 2061 207b 7d20  e('This is a {} 
-0003fb60: 656e 7472 792c 2073 796d 6d65 7472 7920  entry, symmetry 
-0003fb70: 7769 6c6c 206e 6f74 2062 6520 6361 6c63  will not be calc
-0003fb80: 756c 6174 6564 2e5c 6e27 2e66 6f72 6d61  ulated.\n'.forma
-0003fb90: 7428 7365 6c66 2e6d 6574 2929 0a20 2020  t(self.met)).   
-0003fba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003fbb0: 2070 7269 6e74 2827 2d2d 2d2d 2d2d 2d2d   print('--------
-0003fbc0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0003fbd0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2729 0a0a  ------------')..
-0003fbe0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0003fbf0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003fc00: 2020 7379 732e 7374 6465 7272 2e77 7269    sys.stderr.wri
-0003fc10: 7465 2827 454d 206d 6574 686f 6420 616e  te('EM method an
-0003fc20: 6420 7265 736f 6c75 7469 6f6e 206e 6565  d resolution nee
-0003fc30: 6465 6420 746f 2063 616c 6375 6c61 7465  ded to calculate
-0003fc40: 6420 7379 6d6d 6574 7279 2069 6e66 6f72  d symmetry infor
-0003fc50: 6d61 7469 6f6e 215c 6e27 290a 2020 2020  mation!\n').    
-0003fc60: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0003fc70: 7428 272d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  t('-------------
-0003fc80: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0003fc90: 2d2d 2d2d 2d2d 2d27 290a 0a20 2020 2020  -------')..     
-0003fca0: 2020 2072 6574 7572 6e20 4e6f 6e65 0a0a     return None..
-0003fcb0: 2020 2020 2320 512d 7363 6f72 6520 7265      # Q-score re
-0003fcc0: 6c61 7465 6420 7374 6172 7465 6420 6672  lated started fr
-0003fcd0: 6f6d 2068 6572 650a 2020 2020 6465 6620  om here.    def 
-0003fce0: 6f63 6869 6d65 7261 6368 6563 6b28 7365  ochimeracheck(se
-0003fcf0: 6c66 293a 0a20 2020 2020 2020 2022 2222  lf):.        """
-0003fd00: 0a0a 2020 2020 2020 2020 2020 2020 4368  ..            Ch
-0003fd10: 6563 6b20 7768 6572 6520 6973 206f 6c64  eck where is old
-0003fd20: 2043 6869 6d65 7261 206e 6f74 2066 6f72   Chimera not for
-0003fd30: 2043 6869 6d65 7261 580a 0a20 2020 2020   ChimeraX..     
-0003fd40: 2020 203a 7265 7475 726e 3a20 7468 6520     :return: the 
-0003fd50: 7061 7468 206f 6620 6f6c 6420 4368 696d  path of old Chim
-0003fd60: 6572 6120 6f72 204e 6f6e 6520 7769 7468  era or None with
-0003fd70: 206e 6f20 4368 696d 6572 610a 2020 2020   no Chimera.    
-0003fd80: 2020 2020 2222 220a 0a20 2020 2020 2020      """..       
-0003fd90: 206f 6368 696d 6572 6161 7070 203d 204e   ochimeraapp = N
-0003fda0: 6f6e 650a 2020 2020 2020 2020 7472 793a  one.        try:
-0003fdb0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0003fdc0: 4f43 4849 4d45 5241 2069 7320 6e6f 7420  OCHIMERA is not 
-0003fdd0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0003fde0: 2020 2020 2020 6f63 6869 6d65 7261 6170        ochimeraap
-0003fdf0: 7020 3d20 4f43 4849 4d45 5241 0a20 2020  p = OCHIMERA.   
-0003fe00: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-0003fe10: 6e74 2827 4368 696d 6572 613a 207b 7d27  nt('Chimera: {}'
-0003fe20: 2e66 6f72 6d61 7428 6f63 6869 6d65 7261  .format(ochimera
-0003fe30: 6170 7029 290a 2020 2020 2020 2020 2020  app)).          
-0003fe40: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0003fe50: 2020 2020 2020 2020 6173 7365 7274 2066          assert f
-0003fe60: 696e 645f 6578 6563 7574 6162 6c65 2827  ind_executable('
-0003fe70: 6368 696d 6572 6127 2920 6973 206e 6f74  chimera') is not
-0003fe80: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
-0003fe90: 2020 2020 2020 6f63 6869 6d65 7261 6170        ochimeraap
-0003fea0: 7020 3d20 6669 6e64 5f65 7865 6375 7461  p = find_executa
-0003feb0: 626c 6528 2763 6869 6d65 7261 2729 0a20  ble('chimera'). 
-0003fec0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0003fed0: 7269 6e74 2827 4368 696d 6572 613a 207b  rint('Chimera: {
-0003fee0: 7d27 2e66 6f72 6d61 7428 6f63 6869 6d65  }'.format(ochime
-0003fef0: 7261 6170 7029 290a 0a20 2020 2020 2020  raapp))..       
-0003ff00: 2065 7863 6570 7420 4173 7365 7274 696f   except Assertio
-0003ff10: 6e45 7272 6f72 3a0a 2020 2020 2020 2020  nError:.        
-0003ff20: 2020 2020 7379 732e 7374 6465 7272 2e77      sys.stderr.w
-0003ff30: 7269 7465 2827 4368 696d 6572 6158 2065  rite('ChimeraX e
-0003ff40: 7865 6375 7461 626c 6520 6973 206e 6f74  xecutable is not
-0003ff50: 2074 6865 7265 2e5c 6e27 290a 0a20 2020   there.\n')..   
-0003ff60: 2020 2020 2072 6574 7572 6e20 6f63 6869       return ochi
-0003ff70: 6d65 7261 6170 700a 0a20 2020 2064 6566  meraapp..    def
-0003ff80: 2063 6865 636b 7173 636f 7265 2873 656c   checkqscore(sel
-0003ff90: 662c 206f 6368 696d 6572 6161 7070 293a  f, ochimeraapp):
-0003ffa0: 0a0a 2020 2020 2020 2020 2222 220a 0a20  ..        """.. 
-0003ffb0: 2020 2020 2020 2020 2020 2043 6865 636b             Check
-0003ffc0: 2069 6620 5173 636f 7265 2069 7320 7072   if Qscore is pr
-0003ffd0: 6f70 6572 6c79 2069 6e73 7461 6c6c 6564  operly installed
-0003ffe0: 0a0a 2020 2020 2020 2020 3a72 6574 7572  ..        :retur
-0003fff0: 6e3a 2051 7363 6f72 6520 6669 6c65 2066  n: Qscore file f
-00040000: 756c 6c20 7061 7468 206f 7220 4e6f 6e65  ull path or None
-00040010: 0a20 2020 2020 2020 2022 2222 0a0a 2020  .        """..  
-00040020: 2020 2020 2020 7173 636f 7265 6170 7020        qscoreapp 
-00040030: 3d20 4e6f 6e65 0a20 2020 2020 2020 2069  = None.        i
-00040040: 6620 6f63 6869 6d65 7261 6170 703a 0a20  f ochimeraapp:. 
-00040050: 2020 2020 2020 2020 2020 2023 2063 6865             # che
-00040060: 636b 2069 6620 6f63 6869 6d65 7261 6170  ck if ochimeraap
-00040070: 7020 6973 2061 2073 796d 626f 6c69 6320  p is a symbolic 
-00040080: 6c69 6e6b 0a20 2020 2020 2020 2020 2020  link.           
-00040090: 2069 6620 6f73 2e70 6174 682e 6973 6c69   if os.path.isli
-000400a0: 6e6b 286f 6368 696d 6572 6161 7070 293a  nk(ochimeraapp):
-000400b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000400c0: 2072 6561 6c63 6869 6d65 7261 6170 7020   realchimeraapp 
-000400d0: 3d20 6f73 2e70 6174 682e 7265 616c 7061  = os.path.realpa
-000400e0: 7468 2870 6174 6829 0a20 2020 2020 2020  th(path).       
-000400f0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00040100: 2020 2020 2020 2020 2020 2072 6561 6c63             realc
-00040110: 6869 6d65 7261 6170 7020 3d20 6f63 6869  himeraapp = ochi
-00040120: 6d65 7261 6170 700a 0a20 2020 2020 2020  meraapp..       
-00040130: 2020 2020 2069 6620 2743 6f6e 7465 6e74       if 'Content
-00040140: 2720 696e 2072 6561 6c63 6869 6d65 7261  ' in realchimera
-00040150: 6170 703a 0a20 2020 2020 2020 2020 2020  app:.           
-00040160: 2020 2020 2076 6f72 636f 6e74 656e 7420       vorcontent 
-00040170: 3d20 6f63 6869 6d65 7261 6170 702e 7370  = ochimeraapp.sp
-00040180: 6c69 7428 2743 6f6e 7465 6e74 2729 5b30  lit('Content')[0
-00040190: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-000401a0: 2020 6d61 7071 203d 2076 6f72 636f 6e74    mapq = vorcont
-000401b0: 656e 7420 2b20 2743 6f6e 7465 6e74 732f  ent + 'Contents/
-000401c0: 5265 736f 7572 6365 732f 7368 6172 652f  Resources/share/
-000401d0: 6d61 7071 2f6d 6170 715f 636d 642e 7079  mapq/mapq_cmd.py
-000401e0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-000401f0: 2020 7173 636f 7265 6170 7020 3d20 6d61    qscoreapp = ma
-00040200: 7071 2069 6620 6f73 2e70 6174 682e 6973  pq if os.path.is
-00040210: 6669 6c65 286d 6170 7129 2065 6c73 6520  file(mapq) else 
-00040220: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-00040230: 2065 6c69 6620 2762 696e 2720 696e 2072   elif 'bin' in r
-00040240: 6561 6c63 6869 6d65 7261 6170 703a 0a20  ealchimeraapp:. 
-00040250: 2020 2020 2020 2020 2020 2020 2020 2076                 v
-00040260: 6f72 636f 6e74 656e 7420 3d20 6f63 6869  orcontent = ochi
-00040270: 6d65 7261 6170 702e 7370 6c69 7428 2762  meraapp.split('b
-00040280: 696e 2729 5b30 5d0a 2020 2020 2020 2020  in')[0].        
-00040290: 2020 2020 2020 2020 6d61 7071 203d 2076          mapq = v
-000402a0: 6f72 636f 6e74 656e 7420 2b20 2773 6861  orcontent + 'sha
-000402b0: 7265 2f6d 6170 712f 6d61 7071 5f63 6d64  re/mapq/mapq_cmd
-000402c0: 2e70 7927 0a20 2020 2020 2020 2020 2020  .py'.           
-000402d0: 2020 2020 2071 7363 6f72 6561 7070 203d       qscoreapp =
-000402e0: 206d 6170 7120 6966 206f 732e 7061 7468   mapq if os.path
-000402f0: 2e69 7366 696c 6528 6d61 7071 2920 656c  .isfile(mapq) el
-00040300: 7365 204e 6f6e 650a 2020 2020 2020 2020  se None.        
-00040310: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00040320: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-00040330: 2743 6869 6d65 7261 2069 7320 6e6f 7420  'Chimera is not 
-00040340: 6769 7665 6e20 696e 2061 2070 726f 7065  given in a prope
-00040350: 7220 6578 6563 7574 6162 6c65 206f 7220  r executable or 
-00040360: 7379 6d62 6f6c 6963 206c 696e 6b20 666f  symbolic link fo
-00040370: 726d 6174 2e27 290a 2020 2020 2020 2020  rmat.').        
-00040380: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00040390: 2020 7072 696e 7428 2743 6869 6d65 7261    print('Chimera
-000403a0: 2077 6173 206e 6f74 2066 6f75 6e64 2e27   was not found.'
-000403b0: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-000403c0: 6e20 7173 636f 7265 6170 700a 0a20 2020  n qscoreapp..   
-000403d0: 2064 6566 2061 746f 6d5f 6e75 6d62 6572   def atom_number
-000403e0: 7328 7365 6c66 2c20 6d6f 6465 6c5f 6669  s(self, model_fi
-000403f0: 6c65 6e61 6d65 293a 0a20 2020 2020 2020  lename):.       
-00040400: 2022 2222 0a20 2020 2020 2020 2020 2020   """.           
-00040410: 2047 6574 2074 6865 206e 756d 6265 7220   Get the number 
-00040420: 6f66 2061 746f 6d73 2069 6e20 7468 6520  of atoms in the 
-00040430: 6d6f 6465 6c0a 2020 2020 2020 2020 3a70  model.        :p
-00040440: 6172 616d 206d 6f64 656c 5f66 696c 656e  aram model_filen
-00040450: 616d 653a 2073 7472 696e 6720 6f66 2066  ame: string of f
-00040460: 756c 6c20 6d6f 6465 6c20 6e61 6d65 2077  ull model name w
-00040470: 6974 6820 7061 7468 0a20 2020 2020 2020  ith path.       
-00040480: 203a 7265 7475 726e 3a20 696e 7465 6765   :return: intege
-00040490: 7220 6f66 206e 756d 6265 7220 6f66 2061  r of number of a
-000404a0: 746f 6d73 0a20 2020 2020 2020 2022 2222  toms.        """
-000404b0: 0a0a 2020 2020 2020 2020 7061 7273 6572  ..        parser
-000404c0: 203d 204d 4d43 4946 5061 7273 6572 2829   = MMCIFParser()
-000404d0: 0a20 2020 2020 2020 2073 7472 7563 7475  .        structu
-000404e0: 7265 203d 2070 6172 7365 722e 6765 745f  re = parser.get_
-000404f0: 7374 7275 6374 7572 6528 2774 272c 206d  structure('t', m
-00040500: 6f64 656c 5f66 696c 656e 616d 6529 0a20  odel_filename). 
-00040510: 2020 2020 2020 2061 746f 6d73 203d 2073         atoms = s
-00040520: 7472 7563 7475 7265 2e67 6574 5f61 746f  tructure.get_ato
-00040530: 6d73 2829 0a0a 2020 2020 2020 2020 7265  ms()..        re
-00040540: 7475 726e 2073 756d 2831 2066 6f72 205f  turn sum(1 for _
-00040550: 2069 6e20 6174 6f6d 7329 0a0a 0a0a 2020   in atoms)....  
-00040560: 2020 6465 6620 7173 636f 7265 5f62 6172    def qscore_bar
-00040570: 2873 656c 6629 3a0a 0a20 2020 2020 2020  (self):..       
-00040580: 2069 6620 6e6f 7420 7365 6c66 2e6f 6e6c   if not self.onl
-00040590: 7962 6172 3a0a 2020 2020 2020 2020 2020  ybar:.          
-000405a0: 2020 7365 6c66 2e71 7363 6f72 6528 290a    self.qscore().
-000405b0: 2020 2020 2020 2020 7365 6c66 2e67 6574          self.get
-000405c0: 5f62 6172 2873 636f 7265 5f74 7970 653d  _bar(score_type=
-000405d0: 2771 7363 6f72 6527 290a 0a20 2020 2023  'qscore')..    #
-000405e0: 2040 7072 6f66 696c 650a 2020 2020 6465   @profile.    de
-000405f0: 6620 7173 636f 7265 2873 656c 6629 3a0a  f qscore(self):.
-00040600: 2020 2020 2020 2020 2222 220a 0a20 2020          """..   
-00040610: 2020 2020 2020 2020 2043 616c 6375 6c61           Calcula
-00040620: 7465 2051 2d73 636f 7265 0a0a 2020 2020  te Q-score..    
-00040630: 2020 2020 3a72 6574 7572 6e3a 0a20 2020      :return:.   
-00040640: 2020 2020 2022 2222 0a0a 2020 2020 2020       """..      
-00040650: 2020 6572 726c 6973 7420 3d20 5b5d 0a20    errlist = []. 
-00040660: 2020 2020 2020 2071 7363 6f72 6561 7070         qscoreapp
-00040670: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-00040680: 6f63 6869 6d65 7261 6170 7020 3d20 4e6f  ochimeraapp = No
-00040690: 6e65 0a20 2020 2020 2020 206d 6170 6e61  ne.        mapna
-000406a0: 6d65 203d 204e 6f6e 650a 2020 2020 2020  me = None.      
-000406b0: 2020 6d6f 6465 6c73 203d 204e 6f6e 650a    models = None.
-000406c0: 2020 2020 2020 2020 2320 7573 6520 6120          # use a 
-000406d0: 6669 7820 7661 6c75 6520 666f 7220 6e6f  fix value for no
-000406e0: 772c 206d 6179 2063 6f6e 7369 6465 7220  w, may consider 
-000406f0: 6173 2061 2061 7267 756d 656e 7420 666f  as a argument fo
-00040700: 7220 6c61 7465 720a 2020 2020 2020 2020  r later.        
-00040710: 6e75 6d6f 6663 6f72 6573 203d 2069 6e74  numofcores = int
-00040720: 286f 732e 6370 755f 636f 756e 7428 2920  (os.cpu_count() 
-00040730: 2f20 3229 0a0a 2020 2020 2020 2020 6966  / 2)..        if
-00040740: 2073 656c 662e 706c 6174 666f 726d 203d   self.platform =
-00040750: 3d20 2765 6d64 6227 206f 7220 7365 6c66  = 'emdb' or self
-00040760: 2e72 6573 6f6c 7574 696f 6e20 6973 204e  .resolution is N
-00040770: 6f6e 6520 6f72 2066 6c6f 6174 2873 656c  one or float(sel
-00040780: 662e 7265 736f 6c75 7469 6f6e 2920 3e3d  f.resolution) >=
-00040790: 2031 2e32 353a 0a20 2020 2020 2020 2020   1.25:.         
-000407a0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-000407b0: 2020 2020 2020 2020 6f63 6869 6d65 7261          ochimera
-000407c0: 6170 7020 3d20 7365 6c66 2e6f 6368 696d  app = self.ochim
-000407d0: 6572 6163 6865 636b 2829 0a20 2020 2020  eracheck().     
-000407e0: 2020 2020 2020 2020 2020 2071 7363 6f72             qscor
-000407f0: 6561 7070 203d 2073 656c 662e 6368 6563  eapp = self.chec
-00040800: 6b71 7363 6f72 6528 6f63 6869 6d65 7261  kqscore(ochimera
-00040810: 6170 7029 0a20 2020 2020 2020 2020 2020  app).           
-00040820: 2020 2020 206d 6170 6e61 6d65 203d 2073       mapname = s
-00040830: 656c 662e 6d61 702e 6675 6c6c 6e61 6d65  elf.map.fullname
-00040840: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00040850: 2069 6620 7365 6c66 2e6d 6f64 656c 7320   if self.models 
-00040860: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00040870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040880: 206d 6f64 656c 7320 3d20 2720 272e 6a6f   models = ' '.jo
-00040890: 696e 285b 2763 6966 3d27 202b 206d 6f64  in(['cif=' + mod
-000408a0: 656c 2e66 696c 656e 616d 6520 666f 7220  el.filename for 
-000408b0: 6d6f 6465 6c20 696e 2073 656c 662e 6d6f  model in self.mo
-000408c0: 6465 6c73 5d29 0a20 2020 2020 2020 2020  dels]).         
-000408d0: 2020 2020 2020 2020 2020 2061 746f 6d5f             atom_
-000408e0: 6e75 6d62 6572 5f61 6c6c 203d 205b 5d0a  number_all = [].
-000408f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040900: 2020 2020 666f 7220 6d6f 6465 6c20 696e      for model in
-00040910: 2073 656c 662e 6d6f 6465 6c73 3a0a 2020   self.models:.  
-00040920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040930: 2020 2020 2020 2320 666f 7220 6d6f 6465        # for mode
-00040940: 6c73 2077 6974 6820 6578 7472 6120 6461  ls with extra da
-00040950: 7461 2062 6c6f 636b 730a 2020 2020 2020  ta blocks.      
-00040960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040970: 2020 6d6f 6465 7261 7465 645f 6369 6620    moderated_cif 
-00040980: 3d20 277b 7d5f 6d6f 6465 7261 7465 642e  = '{}_moderated.
-00040990: 6369 6627 2e66 6f72 6d61 7428 6f73 2e70  cif'.format(os.p
-000409a0: 6174 682e 6261 7365 6e61 6d65 286d 6f64  ath.basename(mod
-000409b0: 656c 2e66 696c 656e 616d 6529 290a 2020  el.filename)).  
-000409c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000409d0: 2020 2020 2020 6966 206f 732e 7061 7468        if os.path
-000409e0: 2e69 7366 696c 6528 7365 6c66 2e77 6f72  .isfile(self.wor
-000409f0: 6b64 6972 202b 206d 6f64 6572 6174 6564  kdir + moderated
-00040a00: 5f63 6966 293a 0a20 2020 2020 2020 2020  _cif):.         
-00040a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040a20: 2020 2061 746f 6d5f 6e75 6d62 6572 5f61     atom_number_a
-00040a30: 6c6c 2e61 7070 656e 6428 7365 6c66 2e61  ll.append(self.a
-00040a40: 746f 6d5f 6e75 6d62 6572 7328 7365 6c66  tom_numbers(self
-00040a50: 2e77 6f72 6b64 6972 202b 206d 6f64 6572  .workdir + moder
-00040a60: 6174 6564 5f63 6966 2929 0a20 2020 2020  ated_cif)).     
-00040a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040a80: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00040a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040aa0: 2020 2020 2061 746f 6d5f 6e75 6d62 6572       atom_number
-00040ab0: 5f61 6c6c 2e61 7070 656e 6428 7365 6c66  _all.append(self
-00040ac0: 2e61 746f 6d5f 6e75 6d62 6572 7328 6d6f  .atom_numbers(mo
-00040ad0: 6465 6c2e 6669 6c65 6e61 6d65 2929 0a0a  del.filename))..
-00040ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040af0: 2020 2020 6966 206e 756d 6f66 636f 7265      if numofcore
-00040b00: 7320 3e20 6d69 6e28 6174 6f6d 5f6e 756d  s > min(atom_num
-00040b10: 6265 725f 616c 6c29 3a0a 2020 2020 2020  ber_all):.      
-00040b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040b30: 2020 6e75 6d6f 6663 6f72 6573 203d 206d    numofcores = m
-00040b40: 696e 2861 746f 6d5f 6e75 6d62 6572 5f61  in(atom_number_a
-00040b50: 6c6c 290a 2020 2020 2020 2020 2020 2020  ll).            
-00040b60: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00040b70: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-00040b80: 696e 7428 274e 6f20 6669 7474 6564 206d  int('No fitted m
-00040b90: 6f64 656c 2e27 290a 0a20 2020 2020 2020  odel.')..       
-00040ba0: 2020 2020 2065 7863 6570 743a 0a20 2020       except:.   
-00040bb0: 2020 2020 2020 2020 2020 2020 2065 7272               err
-00040bc0: 203d 2027 512d 7363 6f72 6520 7072 6570   = 'Q-score prep
-00040bd0: 6172 6174 696f 6e20 6572 726f 723a 207b  aration error: {
-00040be0: 7d2e 272e 666f 726d 6174 2873 7973 2e65  }.'.format(sys.e
-00040bf0: 7863 5f69 6e66 6f28 295b 315d 290a 2020  xc_info()[1]).  
-00040c00: 2020 2020 2020 2020 2020 2020 2020 6572                er
-00040c10: 726c 6973 742e 6170 7065 6e64 2865 7272  rlist.append(err
-00040c20: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00040c30: 2020 7379 732e 7374 6465 7272 2e77 7269    sys.stderr.wri
-00040c40: 7465 2865 7272 202b 2027 5c6e 2729 0a0a  te(err + '\n')..
-00040c50: 2020 2020 2020 2020 2020 2020 2320 6d6f              # mo
-00040c60: 6465 6c73 203d 2027 2027 2e6a 6f69 6e28  dels = ' '.join(
-00040c70: 5b27 6d79 6669 7273 742e 6369 6627 2c20  ['myfirst.cif', 
-00040c80: 276d 7973 6563 6f6e 642e 6369 6627 5d29  'mysecond.cif'])
-00040c90: 2020 2020 2020 2023 2066 616b 6520 7465         # fake te
-00040ca0: 7374 2070 6f69 6e74 2066 6f72 206d 756c  st point for mul
-00040cb0: 7469 706c 6520 6369 6620 6669 6c65 730a  tiple cif files.
-00040cc0: 2020 2020 2020 2020 2020 2020 6966 2071              if q
-00040cd0: 7363 6f72 6561 7070 2061 6e64 2073 656c  scoreapp and sel
-00040ce0: 662e 6d6f 6465 6c73 3a0a 2020 2020 2020  f.models:.      
-00040cf0: 2020 2020 2020 2020 2020 2320 6f6c 6420            # old 
-00040d00: 5173 636f 7265 0a20 2020 2020 2020 2020  Qscore.         
-00040d10: 2020 2020 2020 2023 2071 7363 6f72 6563         # qscorec
-00040d20: 6d64 203d 2027 7b7d 202d 2d6e 6f67 7569  md = '{} --nogui
-00040d30: 202d 2d6e 6f73 7461 7475 7320 7b7d 207b   --nostatus {} {
-00040d40: 7d20 7b7d 272e 666f 726d 6174 286f 6368  } {}'.format(och
-00040d50: 696d 6572 6161 7070 2c20 6d61 706e 616d  imeraapp, mapnam
-00040d60: 652c 206d 6f64 656c 732c 2071 7363 6f72  e, models, qscor
-00040d70: 6561 7070 290a 2020 2020 2020 2020 2020  eapp).          
-00040d80: 2020 2020 2020 766f 7263 6f6e 7465 6e74        vorcontent
-00040d90: 7320 3d20 6f63 6869 6d65 7261 6170 702e  s = ochimeraapp.
-00040da0: 7370 6c69 7428 2743 6f6e 7465 6e74 7327  split('Contents'
-00040db0: 295b 305d 2069 6620 2743 6f6e 7465 6e74  )[0] if 'Content
-00040dc0: 7327 2069 6e20 6f63 6869 6d65 7261 6170  s' in ochimeraap
-00040dd0: 7020 656c 7365 206f 6368 696d 6572 6161  p else ochimeraa
-00040de0: 7070 2e73 706c 6974 2827 6269 6e27 295b  pp.split('bin')[
-00040df0: 305d 0a20 2020 2020 2020 2020 2020 2020  0].             
-00040e00: 2020 2071 7363 6f72 6563 6d64 203d 2027     qscorecmd = '
-00040e10: 7b7d 207b 7d20 7b7d 206d 6170 3d7b 7d20  {} {} {} map={} 
-00040e20: 7b7d 206e 703d 7b7d 2072 6573 3d7b 7d20  {} np={} res={} 
-00040e30: 7369 676d 613d 302e 3427 2e66 6f72 6d61  sigma=0.4'.forma
-00040e40: 7428 7379 732e 6578 6563 7574 6162 6c65  t(sys.executable
-00040e50: 2c20 7173 636f 7265 6170 702c 2076 6f72  , qscoreapp, vor
-00040e60: 636f 6e74 656e 7473 2c0a 2020 2020 2020  contents,.      
-00040e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040ea0: 2020 2020 2020 2020 2020 206d 6170 6e61             mapna
-00040eb0: 6d65 2c20 6d6f 6465 6c73 2c20 6e75 6d6f  me, models, numo
-00040ec0: 6663 6f72 6573 2c20 7365 6c66 2e72 6573  fcores, self.res
-00040ed0: 6f6c 7574 696f 6e29 0a20 2020 2020 2020  olution).       
-00040ee0: 2020 2020 2020 2020 2070 7269 6e74 2871           print(q
-00040ef0: 7363 6f72 6563 6d64 290a 2020 2020 2020  scorecmd).      
-00040f00: 2020 2020 2020 2020 2020 6c71 7363 6f72            lqscor
-00040f10: 6563 6d64 203d 2071 7363 6f72 6563 6d64  ecmd = qscorecmd
-00040f20: 2e73 706c 6974 2827 2027 290a 2020 2020  .split(' ').    
-00040f30: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-00040f40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00040f50: 2020 2020 2070 726f 6365 7373 203d 2073       process = s
-00040f60: 7562 7072 6f63 6573 732e 506f 7065 6e28  ubprocess.Popen(
-00040f70: 6c71 7363 6f72 6563 6d64 2c20 7374 646f  lqscorecmd, stdo
-00040f80: 7574 3d73 7562 7072 6f63 6573 732e 5049  ut=subprocess.PI
-00040f90: 5045 2c20 7374 6465 7272 3d73 7562 7072  PE, stderr=subpr
-00040fa0: 6f63 6573 732e 5354 444f 5554 2c0a 2020  ocess.STDOUT,.  
-00040fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040fd0: 2020 2020 2020 2020 2020 2020 2063 7764               cwd
-00040fe0: 3d73 656c 662e 776f 726b 6469 7229 0a20  =self.workdir). 
-00040ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041000: 2020 206f 7574 7075 7420 3d20 7072 6f63     output = proc
-00041010: 6573 732e 636f 6d6d 756e 6963 6174 6528  ess.communicate(
-00041020: 276e 5c6e 2729 5b30 5d0a 2020 2020 2020  'n\n')[0].      
-00041030: 2020 2020 2020 2020 2020 2020 2020 6572                er
-00041040: 7271 7363 6f72 6520 3d20 2765 7272 6f72  rqscore = 'error
-00041050: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00041060: 2020 2020 2020 6966 2073 7973 2e76 6572        if sys.ver
-00041070: 7369 6f6e 5f69 6e66 6f5b 305d 203e 3d20  sion_info[0] >= 
-00041080: 333a 0a20 2020 2020 2020 2020 2020 2020  3:.             
-00041090: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
-000410a0: 7465 6d20 696e 206f 7574 7075 742e 6465  tem in output.de
-000410b0: 636f 6465 2827 7574 662d 3827 292e 7370  code('utf-8').sp
-000410c0: 6c69 7428 275c 6e27 293a 0a20 2020 2020  lit('\n'):.     
-000410d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000410e0: 2020 2020 2020 2023 2069 7465 6d20 3d20         # item = 
-000410f0: 636c 696e 652e 6465 636f 6465 2827 7574  cline.decode('ut
-00041100: 662d 3827 292e 7374 7269 7028 290a 2020  f-8').strip().  
-00041110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041120: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-00041130: 6974 656d 290a 2020 2020 2020 2020 2020  item).          
-00041140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041150: 2020 6966 2065 7272 7173 636f 7265 2069    if errqscore i
-00041160: 6e20 6974 656d 2e6c 6f77 6572 2829 3a0a  n item.lower():.
-00041170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041190: 6572 726c 696e 6520 3d20 6974 656d 2e73  errline = item.s
-000411a0: 7472 6970 2829 0a20 2020 2020 2020 2020  trip().         
-000411b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000411c0: 2020 2020 2020 2065 7272 6c69 7374 2e61         errlist.a
-000411d0: 7070 656e 6428 6572 726c 696e 6529 0a20  ppend(errline). 
-000411e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000411f0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00041200: 7373 6572 7420 6572 7271 7363 6f72 6520  ssert errqscore 
-00041210: 6e6f 7420 696e 206f 7574 7075 742e 6465  not in output.de
-00041220: 636f 6465 2827 7574 662d 3827 292c 2065  code('utf-8'), e
-00041230: 7272 6c69 6e65 0a0a 2020 2020 2020 2020  rrline..        
-00041240: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00041250: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00041260: 2020 2020 2020 2020 2020 666f 7220 6974            for it
-00041270: 656d 2069 6e20 6f75 7470 7574 2e73 706c  em in output.spl
-00041280: 6974 2827 5c6e 2729 3a0a 2020 2020 2020  it('\n'):.      
-00041290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000412a0: 2020 2020 2020 7072 696e 7428 6974 656d        print(item
-000412b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000412c0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000412d0: 2065 7272 7173 636f 7265 2069 6e20 6974   errqscore in it
-000412e0: 656d 2e6c 6f77 6572 2829 3a0a 2020 2020  em.lower():.    
-000412f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041300: 2020 2020 2020 2020 2020 2020 6572 726c              errl
-00041310: 696e 6520 3d20 6974 656d 2e73 7472 6970  ine = item.strip
-00041320: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
-00041330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041340: 2020 2065 7272 6c69 7374 2e61 7070 656e     errlist.appen
-00041350: 6428 6572 726c 696e 6529 0a20 2020 2020  d(errline).     
-00041360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041370: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00041380: 7420 6572 7271 7363 6f72 6520 6e6f 7420  t errqscore not 
-00041390: 696e 206f 7574 7075 742e 6465 636f 6465  in output.decode
-000413a0: 2827 7574 662d 3827 292c 2065 7272 6c69  ('utf-8'), errli
-000413b0: 6e65 0a20 2020 2020 2020 2020 2020 2020  ne.             
-000413c0: 2020 2020 2020 2073 656c 662e 706f 7374         self.post
-000413d0: 7173 636f 7265 2829 0a0a 2020 2020 2020  qscore()..      
-000413e0: 2020 2020 2020 2020 2020 6578 6365 7074            except
-000413f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00041400: 2020 2020 2020 6572 7220 3d20 2751 2d73        err = 'Q-s
-00041410: 636f 7265 2063 616c 6375 6c61 7469 6f6e  core calculation
-00041420: 2065 7272 6f72 3a20 7b7d 272e 666f 726d   error: {}'.form
-00041430: 6174 2873 7973 2e65 7863 5f69 6e66 6f28  at(sys.exc_info(
-00041440: 295b 315d 290a 2020 2020 2020 2020 2020  )[1]).          
-00041450: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-00041460: 7472 6163 6562 6163 6b2e 666f 726d 6174  traceback.format
-00041470: 5f65 7863 2829 290a 2020 2020 2020 2020  _exc()).        
-00041480: 2020 2020 2020 2020 2020 2020 6572 726c              errl
-00041490: 6973 742e 6170 7065 6e64 2865 7272 290a  ist.append(err).
-000414a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000414b0: 2020 2020 7379 732e 7374 6465 7272 2e77      sys.stderr.w
-000414c0: 7269 7465 2865 7272 202b 2027 5c6e 2729  rite(err + '\n')
-000414d0: 0a0a 2020 2020 2020 2020 2020 2020 656c  ..            el
-000414e0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000414f0: 2020 2020 7072 696e 7428 2743 6869 6d65      print('Chime
-00041500: 7261 2069 7320 6e6f 7420 6465 7465 6374  ra is not detect
-00041510: 6564 206f 7220 6e6f 2066 6974 7465 6420  ed or no fitted 
-00041520: 6d6f 6465 6c20 666f 7220 7468 6973 2065  model for this e
-00041530: 6e74 7279 2e20 5173 636f 7265 2077 696c  ntry. Qscore wil
-00041540: 6c20 6e6f 7420 6265 2063 616c 6375 6c61  l not be calcula
-00041550: 7465 642e 2729 0a0a 2020 2020 2020 2020  ted.')..        
-00041560: 7265 7475 726e 204e 6f6e 650a 0a0a 2020  return None...  
-00041570: 2020 6465 6620 706f 7374 7173 636f 7265    def postqscore
-00041580: 2873 656c 6629 3a0a 0a20 2020 2020 2020  (self):..       
-00041590: 2023 2073 656c 662e 7265 6e61 6d65 7166   # self.renameqf
-000415a0: 696c 6573 2829 0a20 2020 2020 2020 2074  iles().        t
-000415b0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-000415c0: 7365 6c66 2e6e 6577 7265 6164 5f71 7363  self.newread_qsc
-000415d0: 6f72 6528 290a 2020 2020 2020 2020 2020  ore().          
-000415e0: 2020 7674 6b70 6163 6b2c 2063 6869 6d65    vtkpack, chime
-000415f0: 7261 6170 7020 3d20 7365 6c66 2e73 7572  raapp = self.sur
-00041600: 6661 6365 5f65 6e76 6368 6563 6b28 290a  face_envcheck().
-00041610: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00041620: 2e71 7363 6f72 6576 6965 7728 6368 696d  .qscoreview(chim
-00041630: 6572 6161 7070 290a 2020 2020 2020 2020  eraapp).        
-00041640: 6578 6365 7074 3a0a 2020 2020 2020 2020  except:.        
-00041650: 2020 2020 6572 7220 3d20 2751 2d73 636f      err = 'Q-sco
-00041660: 7265 2072 6573 756c 7473 2070 726f 6365  re results proce
-00041670: 7373 696e 6720 6661 696c 6564 3a20 7b7d  ssing failed: {}
-00041680: 272e 666f 726d 6174 2873 7973 2e65 7863  '.format(sys.exc
-00041690: 5f69 6e66 6f28 295b 315d 290a 2020 2020  _info()[1]).    
-000416a0: 2020 2020 2020 2020 7072 696e 7428 7472          print(tr
-000416b0: 6163 6562 6163 6b2e 666f 726d 6174 5f65  aceback.format_e
-000416c0: 7863 2829 290a 2020 2020 2020 2020 2020  xc()).          
-000416d0: 2020 7379 732e 7374 6465 7272 2e77 7269    sys.stderr.wri
-000416e0: 7465 2865 7272 202b 2027 5c6e 2729 0a0a  te(err + '\n')..
-000416f0: 2020 2020 2020 2020 7265 7475 726e 204e          return N
-00041700: 6f6e 650a 0a20 2020 2064 6566 2072 656e  one..    def ren
-00041710: 616d 6571 6669 6c65 7328 7365 6c66 293a  ameqfiles(self):
-00041720: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00041730: 2020 2020 2020 2020 2052 656e 616d 6520           Rename 
-00041740: 512d 7363 6f72 6520 6f75 7470 7574 2066  Q-score output f
-00041750: 696c 6573 2069 6620 696e 2d63 6173 652c  iles if in-case,
-00041760: 2074 6865 7920 7573 6520 2a5f 416c 745f   they use *_Alt_
-00041770: 412f 422e 6369 6620 746f 2070 726f 6475  A/B.cif to produ
-00041780: 6365 2074 6865 2072 6573 756c 740a 0a20  ce the result.. 
-00041790: 2020 2020 2020 203a 7265 7475 726e 3a0a         :return:.
-000417a0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-000417b0: 2020 2020 616c 7466 696c 6573 203d 2067      altfiles = g
-000417c0: 6c6f 622e 676c 6f62 2827 7b7d 2f2a 2e2a  lob.glob('{}/*.*
-000417d0: 5f41 6c74 5f2a 5f5f 515f 5f65 6d64 5f2a  _Alt_*__Q__emd_*
-000417e0: 2e70 6462 272e 666f 726d 6174 2873 656c  .pdb'.format(sel
-000417f0: 662e 776f 726b 6469 7229 290a 2020 2020  f.workdir)).    
-00041800: 2020 2020 6966 2061 6c74 6669 6c65 733a      if altfiles:
-00041810: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00041820: 2061 6c74 6669 6c65 2069 6e20 616c 7466   altfile in altf
-00041830: 696c 6573 3a0a 2020 2020 2020 2020 2020  iles:.          
-00041840: 2020 2020 2020 616c 7464 6972 203d 206f        altdir = o
-00041850: 732e 7061 7468 2e64 6972 6e61 6d65 2861  s.path.dirname(a
-00041860: 6c74 6669 6c65 290a 2020 2020 2020 2020  ltfile).        
-00041870: 2020 2020 2020 2020 616c 7470 6462 203d          altpdb =
-00041880: 206f 732e 7061 7468 2e62 6173 656e 616d   os.path.basenam
-00041890: 6528 616c 7466 696c 6529 0a20 2020 2020  e(altfile).     
-000418a0: 2020 2020 2020 2020 2020 206e 6577 7064             newpd
-000418b0: 6220 3d20 7265 2e73 7562 2827 2e63 6966  b = re.sub('.cif
-000418c0: 5f41 6c74 5f2e 272c 2027 272c 2061 6c74  _Alt_.', '', alt
-000418d0: 7064 6229 0a20 2020 2020 2020 2020 2020  pdb).           
-000418e0: 2020 2020 2061 6c74 7478 7420 3d20 277b       alttxt = '{
-000418f0: 7d5f 416c 6c2e 7478 7427 2e66 6f72 6d61  }_All.txt'.forma
-00041900: 7428 616c 7470 6462 5b3a 2d34 5d29 0a20  t(altpdb[:-4]). 
-00041910: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00041920: 6577 7478 7420 3d20 277b 7d5f 416c 6c2e  ewtxt = '{}_All.
-00041930: 7478 7427 2e66 6f72 6d61 7428 6e65 7770  txt'.format(newp
-00041940: 6462 5b3a 2d34 5d29 0a20 2020 2020 2020  db[:-4]).       
-00041950: 2020 2020 2020 2020 206f 732e 7265 6e61           os.rena
-00041960: 6d65 2827 7b7d 2f7b 7d27 2e66 6f72 6d61  me('{}/{}'.forma
-00041970: 7428 616c 7464 6972 2c20 616c 7470 6462  t(altdir, altpdb
-00041980: 292c 2027 7b7d 2f7b 7d27 2e66 6f72 6d61  ), '{}/{}'.forma
-00041990: 7428 616c 7464 6972 2c20 6e65 7770 6462  t(altdir, newpdb
-000419a0: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-000419b0: 2020 206f 732e 7265 6e61 6d65 2827 7b7d     os.rename('{}
-000419c0: 2f7b 7d27 2e66 6f72 6d61 7428 616c 7464  /{}'.format(altd
-000419d0: 6972 2c20 616c 7474 7874 292c 2027 7b7d  ir, alttxt), '{}
-000419e0: 2f7b 7d27 2e66 6f72 6d61 7428 616c 7464  /{}'.format(altd
-000419f0: 6972 2c20 6e65 7774 7874 2929 0a20 2020  ir, newtxt)).   
-00041a00: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00041a10: 2020 2020 2020 2070 7269 6e74 2827 4e6f         print('No
-00041a20: 2061 6c74 6572 6e61 7469 7665 2063 6f6f   alternative coo
-00041a30: 7264 696e 6174 6573 2065 7869 7374 2e27  rdinates exist.'
-00041a40: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-00041a50: 6e20 4e6f 6e65 0a0a 2020 2020 6465 6620  n None..    def 
-00041a60: 6e65 7772 6561 645f 7173 636f 7265 2873  newread_qscore(s
-00041a70: 656c 6629 3a0a 2020 2020 2020 2020 2222  elf):.        ""
-00041a80: 220a 0a20 2020 2020 2020 2020 2020 204c  "..            L
-00041a90: 6f61 6420 7468 6520 512d 7363 6f72 6520  oad the Q-score 
-00041aa0: 6369 6620 6669 6c65 206d 6174 6368 2074  cif file match t
-00041ab0: 6f20 5173 636f 7265 2031 2e38 2e32 2028  o Qscore 1.8.2 (
-00041ac0: 7465 6d70 6172 6172 7929 0a20 2020 2020  temparary).     
-00041ad0: 2020 2020 2020 204f 7574 7075 7420 6a73         Output js
-00041ae0: 6f6e 2066 696c 6520 7769 7468 2051 2d73  on file with Q-s
-00041af0: 636f 7265 2069 6e66 6f72 6d61 7469 6f6e  core information
-00041b00: 2064 6572 6976 6564 2066 726f 6d20 6369   derived from ci
-00041b10: 6620 6669 6c65 0a0a 2020 2020 2020 2020  f file..        
-00041b20: 3a72 6574 7572 6e3a 204e 6f6e 650a 2020  :return: None.  
-00041b30: 2020 2020 2020 2222 220a 0a20 2020 2020        """..     
-00041b40: 2020 206d 6170 6e61 6d65 203d 2073 656c     mapname = sel
-00041b50: 662e 6d61 706e 616d 650a 2020 2020 2020  f.mapname.      
-00041b60: 2020 7166 696c 6573 203d 205b 5d0a 2020    qfiles = [].  
-00041b70: 2020 2020 2020 7173 636f 7265 6572 726c        qscoreerrl
-00041b80: 6973 7420 3d20 5b5d 0a20 2020 2020 2020  ist = [].       
-00041b90: 206d 6f64 656c 6e75 6d20 3d20 300a 2020   modelnum = 0.  
-00041ba0: 2020 2020 2020 7173 636f 7265 6469 6374        qscoredict
-00041bb0: 203d 204f 7264 6572 6564 4469 6374 2829   = OrderedDict()
-00041bc0: 0a20 2020 2020 2020 2066 696e 616c 6469  .        finaldi
-00041bd0: 6374 203d 204f 7264 6572 6564 4469 6374  ct = OrderedDict
-00041be0: 2829 0a20 2020 2020 2020 2061 6c6c 6d6f  ().        allmo
-00041bf0: 6465 6c73 5f6e 756d 6265 726f 6661 746f  dels_numberofato
-00041c00: 6d73 203d 2030 0a20 2020 2020 2020 2061  ms = 0.        a
-00041c10: 6c6c 6d6f 6465 6c73 5f71 7363 6f72 6573  llmodels_qscores
-00041c20: 203d 2030 2e0a 2020 2020 2020 2020 666f   = 0..        fo
-00041c30: 7220 6d6f 6465 6c20 696e 2073 656c 662e  r model in self.
-00041c40: 6d6f 6465 6c73 3a0a 2020 2020 2020 2020  models:.        
-00041c50: 2020 2020 6f72 676d 6f64 656c 203d 206f      orgmodel = o
-00041c60: 732e 7061 7468 2e62 6173 656e 616d 6528  s.path.basename(
-00041c70: 6d6f 6465 6c2e 6669 6c65 6e61 6d65 290a  model.filename).
-00041c80: 2020 2020 2020 2020 2020 2020 6375 726d              curm
-00041c90: 6f64 656c 203d 206f 7267 6d6f 6465 6c0a  odel = orgmodel.
-00041ca0: 2020 2020 2020 2020 2020 2020 7166 696c              qfil
-00041cb0: 6520 3d20 277b 7d7b 7d5f 5f51 5f5f 7b7d  e = '{}{}__Q__{}
-00041cc0: 2e63 6966 272e 666f 726d 6174 2873 656c  .cif'.format(sel
-00041cd0: 662e 776f 726b 6469 722c 2063 7572 6d6f  f.workdir, curmo
-00041ce0: 6465 6c2c 206d 6170 6e61 6d65 290a 2020  del, mapname).  
-00041cf0: 2020 2020 2020 2020 2020 6966 206f 732e            if os.
-00041d00: 7061 7468 2e69 7366 696c 6528 7166 696c  path.isfile(qfil
-00041d10: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
-00041d20: 2020 2020 7020 3d20 4d4d 4349 4650 6172      p = MMCIFPar
-00041d30: 7365 7228 290a 2020 2020 2020 2020 2020  ser().          
-00041d40: 2020 2020 2020 702e 5f6d 6d63 6966 5f64        p._mmcif_d
-00041d50: 6963 7420 3d20 4d4d 4349 4632 4469 6374  ict = MMCIF2Dict
-00041d60: 2871 6669 6c65 290a 2020 2020 2020 2020  (qfile).        
-00041d70: 2020 2020 2020 2020 636f 6f72 6473 203d          coords =
-00041d80: 207a 6970 2870 2e5f 6d6d 6369 665f 6469   zip(p._mmcif_di
-00041d90: 6374 5b27 5f61 746f 6d5f 7369 7465 2e43  ct['_atom_site.C
-00041da0: 6172 746e 5f78 275d 2c20 702e 5f6d 6d63  artn_x'], p._mmc
-00041db0: 6966 5f64 6963 745b 275f 6174 6f6d 5f73  if_dict['_atom_s
-00041dc0: 6974 652e 4361 7274 6e5f 7927 5d2c 2070  ite.Cartn_y'], p
-00041dd0: 2e5f 6d6d 6369 665f 6469 6374 5b27 5f61  ._mmcif_dict['_a
-00041de0: 746f 6d5f 7369 7465 2e43 6172 746e 5f7a  tom_site.Cartn_z
-00041df0: 275d 290a 2020 2020 2020 2020 2020 2020  ']).            
-00041e00: 2020 2020 7173 636f 7265 7320 3d20 702e      qscores = p.
-00041e10: 5f6d 6d63 6966 5f64 6963 745b 275f 6174  _mmcif_dict['_at
-00041e20: 6f6d 5f73 6974 652e 512d 7363 6f72 6527  om_site.Q-score'
-00041e30: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00041e40: 2020 636f 6f72 6473 5f71 7363 6f72 6573    coords_qscores
-00041e50: 5f64 6963 7420 3d20 4f72 6465 7265 6444  _dict = OrderedD
-00041e60: 6963 7428 290a 2020 2020 2020 2020 2020  ict().          
-00041e70: 2020 2020 2020 666f 7220 636f 6f72 642c        for coord,
-00041e80: 2071 7363 6f72 6520 696e 207a 6970 2863   qscore in zip(c
-00041e90: 6f6f 7264 732c 2071 7363 6f72 6573 293a  oords, qscores):
-00041ea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00041eb0: 2020 2020 2066 6c6f 6174 5f63 6f6f 7264       float_coord
-00041ec0: 203d 2074 7570 6c65 286d 6170 2866 6c6f   = tuple(map(flo
-00041ed0: 6174 2c20 636f 6f72 6429 290a 2020 2020  at, coord)).    
-00041ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041ef0: 2320 6f72 675f 636f 6f72 645f 6b65 7920  # org_coord_key 
-00041f00: 3d20 7475 706c 6528 6d61 7028 6c61 6d62  = tuple(map(lamb
-00041f10: 6461 2078 3a20 6d61 7468 2e66 6c6f 6f72  da x: math.floor
-00041f20: 2878 202a 2031 3020 2a2a 2032 2920 2f20  (x * 10 ** 2) / 
-00041f30: 3130 202a 2a20 322c 2066 6c6f 6174 5f63  10 ** 2, float_c
-00041f40: 6f6f 7264 2929 0a20 2020 2020 2020 2020  oord)).         
-00041f50: 2020 2020 2020 2020 2020 206f 7267 5f63             org_c
-00041f60: 6f6f 7264 5f6b 6579 203d 2074 7570 6c65  oord_key = tuple
-00041f70: 286d 6170 286c 616d 6264 6120 783a 206d  (map(lambda x: m
-00041f80: 6174 682e 666c 6f6f 7228 7829 2c20 666c  ath.floor(x), fl
-00041f90: 6f61 745f 636f 6f72 6429 290a 2020 2020  oat_coord)).    
-00041fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041fb0: 636f 6f72 6473 5f71 7363 6f72 6573 5f64  coords_qscores_d
-00041fc0: 6963 745b 6f72 675f 636f 6f72 645f 6b65  ict[org_coord_ke
-00041fd0: 795d 203d 2066 6c6f 6174 2871 7363 6f72  y] = float(qscor
-00041fe0: 6529 2069 6620 7173 636f 7265 2021 3d20  e) if qscore != 
-00041ff0: 273f 2720 656c 7365 2030 2e0a 2020 2020  '?' else 0..    
-00042000: 2020 2020 2020 2020 2020 2020 7071 7363              pqsc
-00042010: 6f72 6563 6966 203d 2070 2e67 6574 5f73  orecif = p.get_s
-00042020: 7472 7563 7475 7265 2871 6669 6c65 2c20  tructure(qfile, 
-00042030: 7166 696c 6529 0a20 2020 2020 2020 2020  qfile).         
-00042040: 2020 2020 2020 2066 6f72 2061 746f 6d20         for atom 
-00042050: 696e 2070 7173 636f 7265 6369 662e 6765  in pqscorecif.ge
-00042060: 745f 6174 6f6d 7328 293a 0a20 2020 2020  t_atoms():.     
-00042070: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00042080: 2063 6f6f 7264 5f6b 6579 203d 2074 7570   coord_key = tup
-00042090: 6c65 286d 6170 2866 6c6f 6174 2c20 6d61  le(map(float, ma
-000420a0: 7028 7374 722c 2061 746f 6d2e 636f 6f72  p(str, atom.coor
-000420b0: 6429 2929 0a20 2020 2020 2020 2020 2020  d))).           
-000420c0: 2020 2020 2020 2020 2063 6f6f 7264 5f6b           coord_k
-000420d0: 6579 203d 2074 7570 6c65 286d 6170 2866  ey = tuple(map(f
-000420e0: 6c6f 6174 2c20 7475 706c 6528 6d61 7028  loat, tuple(map(
-000420f0: 7374 722c 2061 746f 6d2e 636f 6f72 6429  str, atom.coord)
-00042100: 2929 290a 2020 2020 2020 2020 2020 2020  ))).            
-00042110: 2020 2020 2020 2020 2320 6e65 775f 636f          # new_co
-00042120: 6f72 645f 6b65 7920 3d20 7475 706c 6528  ord_key = tuple(
-00042130: 6d61 7028 6c61 6d62 6461 2078 3a20 6d61  map(lambda x: ma
-00042140: 7468 2e66 6c6f 6f72 2878 202a 2031 3020  th.floor(x * 10 
-00042150: 2a2a 2032 2920 2f20 3130 202a 2a20 322c  ** 2) / 10 ** 2,
-00042160: 2063 6f6f 7264 5f6b 6579 2929 0a20 2020   coord_key)).   
-00042170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042180: 206e 6577 5f63 6f6f 7264 5f6b 6579 203d   new_coord_key =
-00042190: 2074 7570 6c65 286d 6170 286c 616d 6264   tuple(map(lambd
-000421a0: 6120 783a 206d 6174 682e 666c 6f6f 7228  a x: math.floor(
-000421b0: 7829 2c20 636f 6f72 645f 6b65 7929 290a  x), coord_key)).
-000421c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000421d0: 2020 2020 7365 7461 7474 7228 6174 6f6d      setattr(atom
-000421e0: 2c20 2771 7363 6f72 6527 2c20 636f 6f72  , 'qscore', coor
-000421f0: 6473 5f71 7363 6f72 6573 5f64 6963 745b  ds_qscores_dict[
-00042200: 6e65 775f 636f 6f72 645f 6b65 795d 290a  new_coord_key]).
+0003fb40: 2020 6265 666f 7265 7368 6172 6520 3d20    beforeshare = 
+0003fb50: 272f 272e 6a6f 696e 2850 524f 5348 4144  '/'.join(PROSHAD
+0003fb60: 4550 4154 482e 7370 6c69 7428 272f 2729  EPATH.split('/')
+0003fb70: 5b3a 7368 6172 6569 6e64 6578 5d29 0a20  [:shareindex]). 
+0003fb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fb90: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0003fba0: 7670 6174 6820 3d20 277b 7d2f 7368 6172  vpath = '{}/shar
+0003fbb0: 6527 2e66 6f72 6d61 7428 6265 666f 7265  e'.format(before
+0003fbc0: 7368 6172 6529 0a20 2020 2020 2020 2020  share).         
+0003fbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fbe0: 2020 2020 2020 2023 2063 6d64 203d 206c         # cmd = l
+0003fbf0: 6973 7428 2850 524f 5348 4144 4550 4154  ist((PROSHADEPAT
+0003fc00: 4820 2b20 2720 2d53 202d 6620 2720 2b20  H + ' -S -f ' + 
+0003fc10: 7365 6c66 2e6d 6170 2e66 696c 656e 616d  self.map.filenam
+0003fc20: 6520 2b20 2720 2d73 2027 202b 2073 7472  e + ' -s ' + str
+0003fc30: 2866 6c6f 6174 2873 656c 662e 7265 736f  (float(self.reso
+0003fc40: 6c75 7469 6f6e 292a 312e 3529 202b 2027  lution)*1.5) + '
+0003fc50: 202d 2d72 7670 6174 6820 2720 2b20 7276   --rvpath ' + rv
+0003fc60: 7061 7468 292e 7370 6c69 7428 2720 2729  path).split(' ')
+0003fc70: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0003fc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fc90: 2020 636d 6420 3d20 6c69 7374 2828 5052    cmd = list((PR
+0003fca0: 4f53 4841 4445 5041 5448 202b 2027 202d  OSHADEPATH + ' -
+0003fcb0: 5320 2d66 2027 202b 2073 656c 662e 6d61  S -f ' + self.ma
+0003fcc0: 702e 6675 6c6c 6e61 6d65 202b 2027 202d  p.fullname + ' -
+0003fcd0: 7320 2720 2b20 7374 7228 666c 6f61 7428  s ' + str(float(
+0003fce0: 7365 6c66 2e72 6573 6f6c 7574 696f 6e29  self.resolution)
+0003fcf0: 202a 2031 2e30 2920 2b20 2720 2d2d 7276   * 1.0) + ' --rv
+0003fd00: 7061 7468 2027 202b 2072 7670 6174 6829  path ' + rvpath)
+0003fd10: 2e73 706c 6974 2827 2027 2929 0a20 2020  .split(' ')).   
+0003fd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fd30: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
+0003fd40: 5379 6d6d 6574 7279 2063 6f6d 6d61 6e64  Symmetry command
+0003fd50: 3a20 7b7d 272e 666f 726d 6174 2827 2027  : {}'.format(' '
+0003fd60: 2e6a 6f69 6e28 636d 6429 2929 0a0a 2020  .join(cmd)))..  
+0003fd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fd80: 2020 2020 2020 2020 2020 2320 7072 6f63            # proc
+0003fd90: 6573 7320 3d20 7375 6270 726f 6365 7373  ess = subprocess
+0003fda0: 2e50 6f70 656e 2863 6d64 2c20 7374 646f  .Popen(cmd, stdo
+0003fdb0: 7574 3d73 7562 7072 6f63 6573 732e 5049  ut=subprocess.PI
+0003fdc0: 5045 2c20 7374 6465 7272 3d73 7562 7072  PE, stderr=subpr
+0003fdd0: 6f63 6573 732e 5354 444f 5554 290a 2020  ocess.STDOUT).  
+0003fde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fdf0: 2020 2020 2020 2020 2020 2320 636f 6465            # code
+0003fe00: 203d 2070 726f 6365 7373 2e77 6169 7428   = process.wait(
+0003fe10: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0003fe20: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0003fe30: 6f75 7470 7574 203d 2070 726f 6365 7373  output = process
+0003fe40: 2e73 7464 6f75 742e 7265 6164 2829 0a0a  .stdout.read()..
+0003fe50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fe60: 2020 2020 2020 2020 2020 2020 7072 6f63              proc
+0003fe70: 6573 7320 3d20 7375 6270 726f 6365 7373  ess = subprocess
+0003fe80: 2e50 6f70 656e 2863 6d64 2c20 7374 646f  .Popen(cmd, stdo
+0003fe90: 7574 3d73 7562 7072 6f63 6573 732e 5049  ut=subprocess.PI
+0003fea0: 5045 2c20 7374 6465 7272 3d73 7562 7072  PE, stderr=subpr
+0003feb0: 6f63 6573 732e 5354 444f 5554 2c20 6377  ocess.STDOUT, cw
+0003fec0: 643d 7365 6c66 2e77 6f72 6b64 6972 290a  d=self.workdir).
+0003fed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003fee0: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
+0003fef0: 7574 203d 2070 726f 6365 7373 2e63 6f6d  ut = process.com
+0003ff00: 6d75 6e69 6361 7465 2827 6e5c 6e27 295b  municate('n\n')[
+0003ff10: 305d 0a20 2020 2020 2020 2020 2020 2020  0].             
+0003ff20: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0003ff30: 7272 7072 6f73 6861 6465 203d 2027 2121  rrproshade = '!!
+0003ff40: 2120 5072 6f53 4841 4445 2045 5252 4f52  ! ProSHADE ERROR
+0003ff50: 2021 2121 270a 0a20 2020 2020 2020 2020   !!!'..         
+0003ff60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ff70: 2020 2023 2046 6f72 2070 7974 686f 6e33     # For python3
+0003ff80: 206d 6967 7261 7469 6f6e 2074 6f20 7079   migration to py
+0003ff90: 7468 6f6e 3320 7769 7468 2064 6563 6f64  thon3 with decod
+0003ffa0: 6520 7072 6f62 6c65 6d20 6f66 2073 7472  e problem of str
+0003ffb0: 696e 6720 746f 2062 7974 6573 0a20 2020  ing to bytes.   
+0003ffc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ffd0: 2020 2020 2020 2020 2069 6620 7379 732e           if sys.
+0003ffe0: 7665 7273 696f 6e5f 696e 666f 5b30 5d20  version_info[0] 
+0003fff0: 3e3d 2033 3a0a 2020 2020 2020 2020 2020  >= 3:.          
+00040000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040010: 2020 2020 2020 666f 7220 6974 656d 2069        for item i
+00040020: 6e20 6f75 7470 7574 2e64 6563 6f64 6528  n output.decode(
+00040030: 2775 7466 2d38 2729 2e73 706c 6974 2827  'utf-8').split('
+00040040: 5c6e 2729 3a0a 2020 2020 2020 2020 2020  \n'):.          
+00040050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040060: 2020 2020 2020 2020 2020 2320 6974 656d            # item
+00040070: 203d 2063 6c69 6e65 2e64 6563 6f64 6528   = cline.decode(
+00040080: 2775 7466 2d38 2729 2e73 7472 6970 2829  'utf-8').strip()
+00040090: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000400a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000400b0: 2020 2020 2070 7269 6e74 2869 7465 6d29       print(item)
+000400c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000400d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000400e0: 2020 2020 2069 6620 6572 7270 726f 7368       if errprosh
+000400f0: 6164 6520 696e 2069 7465 6d3a 0a20 2020  ade in item:.   
+00040100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040120: 2020 2020 2065 7272 6c69 6e65 203d 2069       errline = i
+00040130: 7465 6d2e 7374 7269 7028 290a 2020 2020  tem.strip().    
+00040140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040160: 2020 2020 6572 726c 6973 742e 6170 7065      errlist.appe
+00040170: 6e64 2865 7272 6c69 6e65 290a 2020 2020  nd(errline).    
+00040180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000401a0: 2020 2020 6173 7365 7274 2065 7272 7072      assert errpr
+000401b0: 6f73 6861 6465 206e 6f74 2069 6e20 6f75  oshade not in ou
+000401c0: 7470 7574 2e64 6563 6f64 6528 2775 7466  tput.decode('utf
+000401d0: 2d38 2729 2c20 6572 726c 696e 650a 2020  -8'), errline.  
+000401e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000401f0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00040200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040220: 666f 7220 6974 656d 2069 6e20 6f75 7470  for item in outp
+00040230: 7574 2e73 706c 6974 2827 5c6e 2729 3a0a  ut.split('\n'):.
+00040240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040260: 2020 2020 7072 696e 7428 6974 656d 290a      print(item).
+00040270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040290: 2020 2020 6966 2065 7272 7072 6f73 6861      if errprosha
+000402a0: 6465 2069 6e20 6974 656d 3a0a 2020 2020  de in item:.    
+000402b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000402c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000402d0: 2020 2020 6572 726c 696e 6520 3d20 6974      errline = it
+000402e0: 656d 2e73 7472 6970 2829 0a20 2020 2020  em.strip().     
+000402f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040310: 2020 2065 7272 6c69 7374 2e61 7070 656e     errlist.appen
+00040320: 6428 6572 726c 696e 6529 0a20 2020 2020  d(errline).     
+00040330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040350: 2020 2061 7373 6572 7420 6572 7270 726f     assert errpro
+00040360: 7368 6164 6520 6e6f 7420 696e 206f 7574  shade not in out
+00040370: 7075 742e 6465 636f 6465 2827 7574 662d  put.decode('utf-
+00040380: 3827 292c 2065 7272 6c69 6e65 0a0a 2020  8'), errline..  
+00040390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000403a0: 2020 2020 2020 2020 2020 7072 6f73 6861            prosha
+000403b0: 6465 666f 6c64 6572 203d 2073 656c 662e  defolder = self.
+000403c0: 776f 726b 6469 7220 2b20 2770 726f 7368  workdir + 'prosh
+000403d0: 6164 655f 7265 706f 7274 270a 2020 2020  ade_report'.    
+000403e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000403f0: 2020 2020 2020 2020 7379 6d5f 7461 626c          sym_tabl
+00040400: 6573 203d 2027 7b7d 2f2a 2e74 6162 6c65  es = '{}/*.table
+00040410: 272e 666f 726d 6174 2870 726f 7368 6164  '.format(proshad
+00040420: 6566 6f6c 6465 7229 0a20 2020 2020 2020  efolder).       
+00040430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040440: 2020 2020 206e 6669 6c65 696e 7072 6f73       nfileinpros
+00040450: 6861 6465 203d 206c 656e 285b 6620 666f  hade = len([f fo
+00040460: 7220 6620 696e 2067 6c6f 622e 676c 6f62  r f in glob.glob
+00040470: 2873 796d 5f74 6162 6c65 7329 5d29 0a20  (sym_tables)]). 
+00040480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040490: 2020 2020 2020 2020 2020 2023 206e 6669             # nfi
+000404a0: 6c65 696e 7072 6f73 6861 6465 203d 206c  leinproshade = l
+000404b0: 656e 285b 6620 666f 7220 6620 696e 206f  en([f for f in o
+000404c0: 732e 6c69 7374 6469 7228 7072 6f73 6861  s.listdir(prosha
+000404d0: 6465 666f 6c64 6572 2920 6966 206f 732e  defolder) if os.
+000404e0: 7061 7468 2e69 7366 696c 6528 6f73 2e70  path.isfile(os.p
+000404f0: 6174 682e 6a6f 696e 2870 726f 7368 6164  ath.join(proshad
+00040500: 6566 6f6c 6465 722c 2066 2929 5d29 0a20  efolder, f))]). 
+00040510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040520: 2020 2020 2020 2020 2020 2069 6620 6e66             if nf
+00040530: 696c 6569 6e70 726f 7368 6164 6520 3e3d  ileinproshade >=
+00040540: 2033 3a0a 2020 2020 2020 2020 2020 2020   3:.            
+00040550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040560: 2020 2020 7379 6d6d 6574 7279 5265 7320      symmetryRes 
+00040570: 3d20 5472 7565 0a20 2020 2020 2020 2020  = True.         
+00040580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040590: 2020 2023 2073 706c 7374 7220 3d20 2752     # splstr = 'R
+000405a0: 4553 554c 5453 270a 2020 2020 2020 2020  ESULTS'.        
+000405b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000405c0: 2020 2020 2320 6f75 7470 7574 7370 6c20      # outputspl 
+000405d0: 3d20 6f75 7470 7574 2e73 706c 6974 2827  = output.split('
+000405e0: 4465 7465 6374 6564 2043 7963 6c69 6320  Detected Cyclic 
+000405f0: 7379 6d6d 6574 7279 272c 2031 290a 2020  symmetry', 1).  
+00040600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040610: 2020 2020 2020 2020 2020 2320 6f75 7470            # outp
+00040620: 7574 7370 6c20 3d20 7265 2e73 706c 6974  utspl = re.split
+00040630: 2827 5245 5355 4c54 5327 2c20 6f75 7470  ('RESULTS', outp
+00040640: 7574 2e64 6563 6f64 6528 2929 0a20 2020  ut.decode()).   
+00040650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040660: 2020 2020 2020 2020 2023 2069 6620 7370           # if sp
+00040670: 6c73 7472 2069 6e20 6f75 7470 7574 2e64  lstr in output.d
+00040680: 6563 6f64 6528 293a 0a20 2020 2020 2020  ecode():.       
+00040690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000406a0: 2020 2020 2023 2020 2020 2070 7269 6e74       #     print
+000406b0: 286f 7574 7075 7473 706c 5b31 5d29 0a20  (outputspl[1]). 
+000406c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000406d0: 2020 2020 2020 2020 2020 2023 2065 6c73             # els
+000406e0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+000406f0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00040700: 2020 2020 2070 7269 6e74 286f 7574 7075       print(outpu
+00040710: 7473 706c 5b30 5d29 0a0a 2020 2020 2020  tspl[0])..      
+00040720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040730: 2020 2020 2020 2320 7365 6c66 2e6d 6f76        # self.mov
+00040740: 6570 726f 7368 6164 6552 6573 756c 7428  eproshadeResult(
+00040750: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00040760: 2020 2020 2020 2020 2020 2020 2020 656e                en
+00040770: 6420 3d20 7469 6d65 6974 2e64 6566 6175  d = timeit.defau
+00040780: 6c74 5f74 696d 6572 2829 0a20 2020 2020  lt_timer().     
+00040790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000407a0: 2020 2020 2020 2070 7269 6e74 2827 5379         print('Sy
+000407b0: 6d6d 6574 7279 2074 696d 653a 2025 7327  mmetry time: %s'
+000407c0: 2025 2028 656e 6420 2d20 7374 6172 7429   % (end - start)
+000407d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000407e0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+000407f0: 696e 7428 272d 2d2d 2d2d 2d2d 2d2d 2d2d  int('-----------
+00040800: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00040810: 2d2d 2d2d 2d2d 2d2d 2d27 290a 2020 2020  ---------').    
+00040820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040830: 2020 2020 6578 6365 7074 3a0a 2020 2020      except:.    
+00040840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040850: 2020 2020 2020 2020 6572 7220 3d20 2753          err = 'S
+00040860: 796d 6d65 7472 7920 6361 6c63 756c 6174  ymmetry calculat
+00040870: 696f 6e20 6572 726f 723a 207b 7d2e 272e  ion error: {}.'.
+00040880: 666f 726d 6174 2873 7973 2e65 7863 5f69  format(sys.exc_i
+00040890: 6e66 6f28 295b 315d 290a 2020 2020 2020  nfo()[1]).      
+000408a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000408b0: 2020 2020 2020 6572 726c 6973 742e 6170        errlist.ap
+000408c0: 7065 6e64 2865 7272 290a 2020 2020 2020  pend(err).      
+000408d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000408e0: 2020 2020 2020 7379 732e 7374 6465 7272        sys.stderr
+000408f0: 2e77 7269 7465 2865 7272 202b 2027 5c6e  .write(err + '\n
+00040900: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
+00040910: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00040920: 7269 6e74 2827 2d2d 2d2d 2d2d 2d2d 2d2d  rint('----------
+00040930: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00040940: 2d2d 2d2d 2d2d 2d2d 2d2d 2729 0a0a 2020  ----------')..  
+00040950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040960: 2020 2020 2020 6966 2065 7272 6c69 7374        if errlist
+00040970: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00040980: 2020 2020 2020 2020 2020 2020 2020 6669                fi
+00040990: 6e61 6c64 6963 745b 2773 796d 6d65 7472  naldict['symmetr
+000409a0: 7927 5d20 3d20 7b27 6572 7227 3a20 7b27  y'] = {'err': {'
+000409b0: 7379 6d6d 6574 7279 5f65 7272 273a 2065  symmetry_err': e
+000409c0: 7272 6c69 7374 7d7d 0a20 2020 2020 2020  rrlist}}.       
+000409d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000409e0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000409f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040a00: 2020 2066 696e 616c 6469 6374 5b27 7379     finaldict['sy
+00040a10: 6d6d 6574 7279 275d 203d 207b 2773 796d  mmetry'] = {'sym
+00040a20: 6d65 7472 795f 696e 666f 273a 2073 796d  metry_info': sym
+00040a30: 6d65 7472 7952 6573 7d0a 0a20 2020 2020  metryRes}..     
+00040a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040a50: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00040a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040a70: 2020 2020 7769 7468 2063 6f64 6563 732e      with codecs.
+00040a80: 6f70 656e 2873 656c 662e 776f 726b 6469  open(self.workdi
+00040a90: 7220 2b20 7365 6c66 2e6d 6170 6e61 6d65  r + self.mapname
+00040aa0: 202b 2027 5f73 796d 6d65 7472 792e 6a73   + '_symmetry.js
+00040ab0: 6f6e 272c 2027 7727 2c0a 2020 2020 2020  on', 'w',.      
+00040ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040ae0: 2020 2020 2020 2065 6e63 6f64 696e 673d         encoding=
+00040af0: 2775 7466 2d38 2729 2061 7320 663a 0a20  'utf-8') as f:. 
+00040b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040b10: 2020 2020 2020 2020 2020 2020 2020 206a                 j
+00040b20: 736f 6e2e 6475 6d70 2866 696e 616c 6469  son.dump(finaldi
+00040b30: 6374 2c20 6629 0a20 2020 2020 2020 2020  ct, f).         
+00040b40: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00040b50: 7863 6570 7420 494f 4572 726f 7220 6173  xcept IOError as
+00040b60: 2069 6f65 7272 3a0a 2020 2020 2020 2020   ioerr:.        
+00040b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040b80: 2020 2020 7379 732e 7374 6465 7272 2e77      sys.stderr.w
+00040b90: 7269 7465 2827 5361 7669 6e67 2073 796d  rite('Saving sym
+00040ba0: 6d65 7472 7920 696e 666f 726d 6174 696f  metry informatio
+00040bb0: 6e20 746f 206a 736f 6e20 6572 723a 207b  n to json err: {
+00040bc0: 7d2e 5c6e 272e 666f 726d 6174 2869 6f65  }.\n'.format(ioe
+00040bd0: 7272 2929 0a0a 0a0a 2020 2020 2020 2020  rr))....        
+00040be0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00040bf0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00040c00: 2020 2020 2020 2020 2020 7379 732e 7374            sys.st
+00040c10: 6465 7272 2e77 7269 7465 2827 5072 6f73  derr.write('Pros
+00040c20: 6861 6465 2069 7320 6e6f 7420 696e 7374  hade is not inst
+00040c30: 616c 6c65 642e 2054 6865 7265 2077 696c  alled. There wil
+00040c40: 6c20 6265 206e 6f20 7379 6d6d 6574 7279  l be no symmetry
+00040c50: 2069 6e66 6f72 6d61 7469 6f6e 2e5c 6e27   information.\n'
+00040c60: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00040c70: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+00040c80: 272d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  '---------------
+00040c90: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00040ca0: 2d2d 2d2d 2d27 290a 0a20 2020 2020 2020  -----')..       
+00040cb0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00040cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040cd0: 2020 2073 7973 2e73 7464 6572 722e 7772     sys.stderr.wr
+00040ce0: 6974 6528 2754 6869 7320 6973 2061 207b  ite('This is a {
+00040cf0: 7d20 656e 7472 792c 2073 796d 6d65 7472  } entry, symmetr
+00040d00: 7920 7769 6c6c 206e 6f74 2062 6520 6361  y will not be ca
+00040d10: 6c63 756c 6174 6564 2e5c 6e27 2e66 6f72  lculated.\n'.for
+00040d20: 6d61 7428 7365 6c66 2e6d 6574 2929 0a20  mat(self.met)). 
+00040d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00040d40: 2020 2070 7269 6e74 2827 2d2d 2d2d 2d2d     print('------
+00040d50: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00040d60: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2729  --------------')
+00040d70: 0a0a 2020 2020 2020 2020 2020 2020 656c  ..            el
+00040d80: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00040d90: 2020 2020 7379 732e 7374 6465 7272 2e77      sys.stderr.w
+00040da0: 7269 7465 2827 454d 206d 6574 686f 6420  rite('EM method 
+00040db0: 616e 6420 7265 736f 6c75 7469 6f6e 206e  and resolution n
+00040dc0: 6565 6465 6420 746f 2063 616c 6375 6c61  eeded to calcula
+00040dd0: 7465 6420 7379 6d6d 6574 7279 2069 6e66  ted symmetry inf
+00040de0: 6f72 6d61 7469 6f6e 215c 6e27 290a 2020  ormation!\n').  
+00040df0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+00040e00: 696e 7428 272d 2d2d 2d2d 2d2d 2d2d 2d2d  int('-----------
+00040e10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00040e20: 2d2d 2d2d 2d2d 2d2d 2d27 290a 0a20 2020  ---------')..   
+00040e30: 2020 2020 2072 6574 7572 6e20 4e6f 6e65       return None
+00040e40: 0a0a 2020 2020 2320 512d 7363 6f72 6520  ..    # Q-score 
+00040e50: 7265 6c61 7465 6420 7374 6172 7465 6420  related started 
+00040e60: 6672 6f6d 2068 6572 650a 2020 2020 6465  from here.    de
+00040e70: 6620 6f63 6869 6d65 7261 6368 6563 6b28  f ochimeracheck(
+00040e80: 7365 6c66 293a 0a20 2020 2020 2020 2022  self):.        "
+00040e90: 2222 0a0a 2020 2020 2020 2020 2020 2020  ""..            
+00040ea0: 4368 6563 6b20 7768 6572 6520 6973 206f  Check where is o
+00040eb0: 6c64 2043 6869 6d65 7261 206e 6f74 2066  ld Chimera not f
+00040ec0: 6f72 2043 6869 6d65 7261 580a 0a20 2020  or ChimeraX..   
+00040ed0: 2020 2020 203a 7265 7475 726e 3a20 7468       :return: th
+00040ee0: 6520 7061 7468 206f 6620 6f6c 6420 4368  e path of old Ch
+00040ef0: 696d 6572 6120 6f72 204e 6f6e 6520 7769  imera or None wi
+00040f00: 7468 206e 6f20 4368 696d 6572 610a 2020  th no Chimera.  
+00040f10: 2020 2020 2020 2222 220a 0a20 2020 2020        """..     
+00040f20: 2020 206f 6368 696d 6572 6161 7070 203d     ochimeraapp =
+00040f30: 204e 6f6e 650a 2020 2020 2020 2020 7472   None.        tr
+00040f40: 793a 0a20 2020 2020 2020 2020 2020 2069  y:.            i
+00040f50: 6620 4f43 4849 4d45 5241 2069 7320 6e6f  f OCHIMERA is no
+00040f60: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00040f70: 2020 2020 2020 2020 6f63 6869 6d65 7261          ochimera
+00040f80: 6170 7020 3d20 4f43 4849 4d45 5241 0a20  app = OCHIMERA. 
+00040f90: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00040fa0: 7269 6e74 2827 4368 696d 6572 613a 207b  rint('Chimera: {
+00040fb0: 7d27 2e66 6f72 6d61 7428 6f63 6869 6d65  }'.format(ochime
+00040fc0: 7261 6170 7029 290a 2020 2020 2020 2020  raapp)).        
+00040fd0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00040fe0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00040ff0: 2066 696e 645f 6578 6563 7574 6162 6c65   find_executable
+00041000: 2827 6368 696d 6572 6127 2920 6973 206e  ('chimera') is n
+00041010: 6f74 204e 6f6e 650a 2020 2020 2020 2020  ot None.        
+00041020: 2020 2020 2020 2020 6f63 6869 6d65 7261          ochimera
+00041030: 6170 7020 3d20 6669 6e64 5f65 7865 6375  app = find_execu
+00041040: 7461 626c 6528 2763 6869 6d65 7261 2729  table('chimera')
+00041050: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00041060: 2070 7269 6e74 2827 4368 696d 6572 613a   print('Chimera:
+00041070: 207b 7d27 2e66 6f72 6d61 7428 6f63 6869   {}'.format(ochi
+00041080: 6d65 7261 6170 7029 290a 0a20 2020 2020  meraapp))..     
+00041090: 2020 2065 7863 6570 7420 4173 7365 7274     except Assert
+000410a0: 696f 6e45 7272 6f72 3a0a 2020 2020 2020  ionError:.      
+000410b0: 2020 2020 2020 7379 732e 7374 6465 7272        sys.stderr
+000410c0: 2e77 7269 7465 2827 4368 696d 6572 6158  .write('ChimeraX
+000410d0: 2065 7865 6375 7461 626c 6520 6973 206e   executable is n
+000410e0: 6f74 2074 6865 7265 2e5c 6e27 290a 0a20  ot there.\n').. 
+000410f0: 2020 2020 2020 2072 6574 7572 6e20 6f63         return oc
+00041100: 6869 6d65 7261 6170 700a 0a20 2020 2064  himeraapp..    d
+00041110: 6566 2063 6865 636b 7173 636f 7265 2873  ef checkqscore(s
+00041120: 656c 662c 206f 6368 696d 6572 6161 7070  elf, ochimeraapp
+00041130: 293a 0a0a 2020 2020 2020 2020 2222 220a  ):..        """.
+00041140: 0a20 2020 2020 2020 2020 2020 2043 6865  .            Che
+00041150: 636b 2069 6620 5173 636f 7265 2069 7320  ck if Qscore is 
+00041160: 7072 6f70 6572 6c79 2069 6e73 7461 6c6c  properly install
+00041170: 6564 0a0a 2020 2020 2020 2020 3a72 6574  ed..        :ret
+00041180: 7572 6e3a 2051 7363 6f72 6520 6669 6c65  urn: Qscore file
+00041190: 2066 756c 6c20 7061 7468 206f 7220 4e6f   full path or No
+000411a0: 6e65 0a20 2020 2020 2020 2022 2222 0a0a  ne.        """..
+000411b0: 2020 2020 2020 2020 7173 636f 7265 6170          qscoreap
+000411c0: 7020 3d20 4e6f 6e65 0a20 2020 2020 2020  p = None.       
+000411d0: 2069 6620 6f63 6869 6d65 7261 6170 703a   if ochimeraapp:
+000411e0: 0a20 2020 2020 2020 2020 2020 2023 2063  .            # c
+000411f0: 6865 636b 2069 6620 6f63 6869 6d65 7261  heck if ochimera
+00041200: 6170 7020 6973 2061 2073 796d 626f 6c69  app is a symboli
+00041210: 6320 6c69 6e6b 0a20 2020 2020 2020 2020  c link.         
+00041220: 2020 2069 6620 6f73 2e70 6174 682e 6973     if os.path.is
+00041230: 6c69 6e6b 286f 6368 696d 6572 6161 7070  link(ochimeraapp
+00041240: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00041250: 2020 2072 6561 6c63 6869 6d65 7261 6170     realchimeraap
+00041260: 7020 3d20 6f73 2e70 6174 682e 7265 616c  p = os.path.real
+00041270: 7061 7468 2870 6174 6829 0a20 2020 2020  path(path).     
+00041280: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00041290: 2020 2020 2020 2020 2020 2020 2072 6561               rea
+000412a0: 6c63 6869 6d65 7261 6170 7020 3d20 6f63  lchimeraapp = oc
+000412b0: 6869 6d65 7261 6170 700a 0a20 2020 2020  himeraapp..     
+000412c0: 2020 2020 2020 2069 6620 2743 6f6e 7465         if 'Conte
+000412d0: 6e74 2720 696e 2072 6561 6c63 6869 6d65  nt' in realchime
+000412e0: 7261 6170 703a 0a20 2020 2020 2020 2020  raapp:.         
+000412f0: 2020 2020 2020 2076 6f72 636f 6e74 656e         vorconten
+00041300: 7420 3d20 6f63 6869 6d65 7261 6170 702e  t = ochimeraapp.
+00041310: 7370 6c69 7428 2743 6f6e 7465 6e74 2729  split('Content')
+00041320: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
+00041330: 2020 2020 6d61 7071 203d 2076 6f72 636f      mapq = vorco
+00041340: 6e74 656e 7420 2b20 2743 6f6e 7465 6e74  ntent + 'Content
+00041350: 732f 5265 736f 7572 6365 732f 7368 6172  s/Resources/shar
+00041360: 652f 6d61 7071 2f6d 6170 715f 636d 642e  e/mapq/mapq_cmd.
+00041370: 7079 270a 2020 2020 2020 2020 2020 2020  py'.            
+00041380: 2020 2020 7173 636f 7265 6170 7020 3d20      qscoreapp = 
+00041390: 6d61 7071 2069 6620 6f73 2e70 6174 682e  mapq if os.path.
+000413a0: 6973 6669 6c65 286d 6170 7129 2065 6c73  isfile(mapq) els
+000413b0: 6520 4e6f 6e65 0a20 2020 2020 2020 2020  e None.         
+000413c0: 2020 2065 6c69 6620 2762 696e 2720 696e     elif 'bin' in
+000413d0: 2072 6561 6c63 6869 6d65 7261 6170 703a   realchimeraapp:
+000413e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000413f0: 2076 6f72 636f 6e74 656e 7420 3d20 6f63   vorcontent = oc
+00041400: 6869 6d65 7261 6170 702e 7370 6c69 7428  himeraapp.split(
+00041410: 2762 696e 2729 5b30 5d0a 2020 2020 2020  'bin')[0].      
+00041420: 2020 2020 2020 2020 2020 6d61 7071 203d            mapq =
+00041430: 2076 6f72 636f 6e74 656e 7420 2b20 2773   vorcontent + 's
+00041440: 6861 7265 2f6d 6170 712f 6d61 7071 5f63  hare/mapq/mapq_c
+00041450: 6d64 2e70 7927 0a20 2020 2020 2020 2020  md.py'.         
+00041460: 2020 2020 2020 2071 7363 6f72 6561 7070         qscoreapp
+00041470: 203d 206d 6170 7120 6966 206f 732e 7061   = mapq if os.pa
+00041480: 7468 2e69 7366 696c 6528 6d61 7071 2920  th.isfile(mapq) 
+00041490: 656c 7365 204e 6f6e 650a 2020 2020 2020  else None.      
+000414a0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000414b0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+000414c0: 7428 2743 6869 6d65 7261 2069 7320 6e6f  t('Chimera is no
+000414d0: 7420 6769 7665 6e20 696e 2061 2070 726f  t given in a pro
+000414e0: 7065 7220 6578 6563 7574 6162 6c65 206f  per executable o
+000414f0: 7220 7379 6d62 6f6c 6963 206c 696e 6b20  r symbolic link 
+00041500: 666f 726d 6174 2e27 290a 2020 2020 2020  format.').      
+00041510: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00041520: 2020 2020 7072 696e 7428 2743 6869 6d65      print('Chime
+00041530: 7261 2077 6173 206e 6f74 2066 6f75 6e64  ra was not found
+00041540: 2e27 290a 0a20 2020 2020 2020 2072 6574  .')..        ret
+00041550: 7572 6e20 7173 636f 7265 6170 700a 0a20  urn qscoreapp.. 
+00041560: 2020 2064 6566 2061 746f 6d5f 6e75 6d62     def atom_numb
+00041570: 6572 7328 7365 6c66 2c20 6d6f 6465 6c5f  ers(self, model_
+00041580: 6669 6c65 6e61 6d65 293a 0a20 2020 2020  filename):.     
+00041590: 2020 2022 2222 0a20 2020 2020 2020 2020     """.         
+000415a0: 2020 2047 6574 2074 6865 206e 756d 6265     Get the numbe
+000415b0: 7220 6f66 2061 746f 6d73 2069 6e20 7468  r of atoms in th
+000415c0: 6520 6d6f 6465 6c0a 2020 2020 2020 2020  e model.        
+000415d0: 3a70 6172 616d 206d 6f64 656c 5f66 696c  :param model_fil
+000415e0: 656e 616d 653a 2073 7472 696e 6720 6f66  ename: string of
+000415f0: 2066 756c 6c20 6d6f 6465 6c20 6e61 6d65   full model name
+00041600: 2077 6974 6820 7061 7468 0a20 2020 2020   with path.     
+00041610: 2020 203a 7265 7475 726e 3a20 696e 7465     :return: inte
+00041620: 6765 7220 6f66 206e 756d 6265 7220 6f66  ger of number of
+00041630: 2061 746f 6d73 0a20 2020 2020 2020 2022   atoms.        "
+00041640: 2222 0a0a 2020 2020 2020 2020 7061 7273  ""..        pars
+00041650: 6572 203d 204d 4d43 4946 5061 7273 6572  er = MMCIFParser
+00041660: 2829 0a20 2020 2020 2020 2073 7472 7563  ().        struc
+00041670: 7475 7265 203d 2070 6172 7365 722e 6765  ture = parser.ge
+00041680: 745f 7374 7275 6374 7572 6528 2774 272c  t_structure('t',
+00041690: 206d 6f64 656c 5f66 696c 656e 616d 6529   model_filename)
+000416a0: 0a20 2020 2020 2020 2061 746f 6d73 203d  .        atoms =
+000416b0: 2073 7472 7563 7475 7265 2e67 6574 5f61   structure.get_a
+000416c0: 746f 6d73 2829 0a0a 2020 2020 2020 2020  toms()..        
+000416d0: 7265 7475 726e 2073 756d 2831 2066 6f72  return sum(1 for
+000416e0: 205f 2069 6e20 6174 6f6d 7329 0a0a 0a0a   _ in atoms)....
+000416f0: 2020 2020 6465 6620 7173 636f 7265 5f62      def qscore_b
+00041700: 6172 2873 656c 6629 3a0a 0a20 2020 2020  ar(self):..     
+00041710: 2020 2069 6620 6e6f 7420 7365 6c66 2e6f     if not self.o
+00041720: 6e6c 7962 6172 3a0a 2020 2020 2020 2020  nlybar:.        
+00041730: 2020 2020 7365 6c66 2e71 7363 6f72 6528      self.qscore(
+00041740: 290a 2020 2020 2020 2020 7365 6c66 2e67  ).        self.g
+00041750: 6574 5f62 6172 2873 636f 7265 5f74 7970  et_bar(score_typ
+00041760: 653d 2771 7363 6f72 6527 290a 0a20 2020  e='qscore')..   
+00041770: 2023 2040 7072 6f66 696c 650a 2020 2020   # @profile.    
+00041780: 6465 6620 7173 636f 7265 2873 656c 6629  def qscore(self)
+00041790: 3a0a 2020 2020 2020 2020 2222 220a 0a20  :.        """.. 
+000417a0: 2020 2020 2020 2020 2020 2043 616c 6375             Calcu
+000417b0: 6c61 7465 2051 2d73 636f 7265 0a0a 2020  late Q-score..  
+000417c0: 2020 2020 2020 3a72 6574 7572 6e3a 0a20        :return:. 
+000417d0: 2020 2020 2020 2022 2222 0a0a 2020 2020         """..    
+000417e0: 2020 2020 6572 726c 6973 7420 3d20 5b5d      errlist = []
+000417f0: 0a20 2020 2020 2020 2071 7363 6f72 6561  .        qscorea
+00041800: 7070 203d 204e 6f6e 650a 2020 2020 2020  pp = None.      
+00041810: 2020 6f63 6869 6d65 7261 6170 7020 3d20    ochimeraapp = 
+00041820: 4e6f 6e65 0a20 2020 2020 2020 206d 6170  None.        map
+00041830: 6e61 6d65 203d 204e 6f6e 650a 2020 2020  name = None.    
+00041840: 2020 2020 6d6f 6465 6c73 203d 204e 6f6e      models = Non
+00041850: 650a 2020 2020 2020 2020 2320 7573 6520  e.        # use 
+00041860: 6120 6669 7820 7661 6c75 6520 666f 7220  a fix value for 
+00041870: 6e6f 772c 206d 6179 2063 6f6e 7369 6465  now, may conside
+00041880: 7220 6173 2061 2061 7267 756d 656e 7420  r as a argument 
+00041890: 666f 7220 6c61 7465 720a 2020 2020 2020  for later.      
+000418a0: 2020 6e75 6d6f 6663 6f72 6573 203d 2069    numofcores = i
+000418b0: 6e74 286f 732e 6370 755f 636f 756e 7428  nt(os.cpu_count(
+000418c0: 2920 2f20 3229 0a0a 2020 2020 2020 2020  ) / 2)..        
+000418d0: 6966 2073 656c 662e 706c 6174 666f 726d  if self.platform
+000418e0: 203d 3d20 2765 6d64 6227 206f 7220 7365   == 'emdb' or se
+000418f0: 6c66 2e72 6573 6f6c 7574 696f 6e20 6973  lf.resolution is
+00041900: 204e 6f6e 6520 6f72 2073 656c 662e 7265   None or self.re
+00041910: 736f 6c75 7469 6f6e 203e 3d20 312e 3235  solution >= 1.25
+00041920: 3a0a 2020 2020 2020 2020 2020 2020 7472  :.            tr
+00041930: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00041940: 2020 206f 6368 696d 6572 6161 7070 203d     ochimeraapp =
+00041950: 2073 656c 662e 6f63 6869 6d65 7261 6368   self.ochimerach
+00041960: 6563 6b28 290a 2020 2020 2020 2020 2020  eck().          
+00041970: 2020 2020 2020 7173 636f 7265 6170 7020        qscoreapp 
+00041980: 3d20 7365 6c66 2e63 6865 636b 7173 636f  = self.checkqsco
+00041990: 7265 286f 6368 696d 6572 6161 7070 290a  re(ochimeraapp).
+000419a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000419b0: 6d61 706e 616d 6520 3d20 7365 6c66 2e6d  mapname = self.m
+000419c0: 6170 2e66 756c 6c6e 616d 650a 2020 2020  ap.fullname.    
+000419d0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+000419e0: 656c 662e 6d6f 6465 6c73 2069 7320 6e6f  elf.models is no
+000419f0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00041a00: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
+00041a10: 6c73 203d 2027 2027 2e6a 6f69 6e28 5b27  ls = ' '.join(['
+00041a20: 6369 663d 2720 2b20 6d6f 6465 6c2e 6669  cif=' + model.fi
+00041a30: 6c65 6e61 6d65 2066 6f72 206d 6f64 656c  lename for model
+00041a40: 2069 6e20 7365 6c66 2e6d 6f64 656c 735d   in self.models]
+00041a50: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00041a60: 2020 2020 2020 6174 6f6d 5f6e 756d 6265        atom_numbe
+00041a70: 725f 616c 6c20 3d20 5b5d 0a20 2020 2020  r_all = [].     
+00041a80: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00041a90: 6f72 206d 6f64 656c 2069 6e20 7365 6c66  or model in self
+00041aa0: 2e6d 6f64 656c 733a 0a20 2020 2020 2020  .models:.       
+00041ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00041ac0: 2023 2066 6f72 206d 6f64 656c 7320 7769   # for models wi
+00041ad0: 7468 2065 7874 7261 2064 6174 6120 626c  th extra data bl
+00041ae0: 6f63 6b73 0a20 2020 2020 2020 2020 2020  ocks.           
+00041af0: 2020 2020 2020 2020 2020 2020 206d 6f64               mod
+00041b00: 6572 6174 6564 5f63 6966 203d 2027 7b7d  erated_cif = '{}
+00041b10: 5f6d 6f64 6572 6174 6564 2e63 6966 272e  _moderated.cif'.
+00041b20: 666f 726d 6174 286f 732e 7061 7468 2e62  format(os.path.b
+00041b30: 6173 656e 616d 6528 6d6f 6465 6c2e 6669  asename(model.fi
+00041b40: 6c65 6e61 6d65 2929 0a20 2020 2020 2020  lename)).       
+00041b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00041b60: 2069 6620 6f73 2e70 6174 682e 6973 6669   if os.path.isfi
+00041b70: 6c65 2873 656c 662e 776f 726b 6469 7220  le(self.workdir 
+00041b80: 2b20 6d6f 6465 7261 7465 645f 6369 6629  + moderated_cif)
+00041b90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00041ba0: 2020 2020 2020 2020 2020 2020 2020 6174                at
+00041bb0: 6f6d 5f6e 756d 6265 725f 616c 6c2e 6170  om_number_all.ap
+00041bc0: 7065 6e64 2873 656c 662e 6174 6f6d 5f6e  pend(self.atom_n
+00041bd0: 756d 6265 7273 2873 656c 662e 776f 726b  umbers(self.work
+00041be0: 6469 7220 2b20 6d6f 6465 7261 7465 645f  dir + moderated_
+00041bf0: 6369 6629 290a 2020 2020 2020 2020 2020  cif)).          
+00041c00: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00041c10: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00041c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00041c30: 6174 6f6d 5f6e 756d 6265 725f 616c 6c2e  atom_number_all.
+00041c40: 6170 7065 6e64 2873 656c 662e 6174 6f6d  append(self.atom
+00041c50: 5f6e 756d 6265 7273 286d 6f64 656c 2e66  _numbers(model.f
+00041c60: 696c 656e 616d 6529 290a 0a20 2020 2020  ilename))..     
+00041c70: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00041c80: 6620 6e75 6d6f 6663 6f72 6573 203e 206d  f numofcores > m
+00041c90: 696e 2861 746f 6d5f 6e75 6d62 6572 5f61  in(atom_number_a
+00041ca0: 6c6c 293a 0a20 2020 2020 2020 2020 2020  ll):.           
+00041cb0: 2020 2020 2020 2020 2020 2020 206e 756d               num
+00041cc0: 6f66 636f 7265 7320 3d20 6d69 6e28 6174  ofcores = min(at
+00041cd0: 6f6d 5f6e 756d 6265 725f 616c 6c29 0a20  om_number_all). 
+00041ce0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00041cf0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00041d00: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
+00041d10: 4e6f 2066 6974 7465 6420 6d6f 6465 6c2e  No fitted model.
+00041d20: 2729 0a0a 2020 2020 2020 2020 2020 2020  ')..            
+00041d30: 6578 6365 7074 3a0a 2020 2020 2020 2020  except:.        
+00041d40: 2020 2020 2020 2020 6572 7220 3d20 2751          err = 'Q
+00041d50: 2d73 636f 7265 2070 7265 7061 7261 7469  -score preparati
+00041d60: 6f6e 2065 7272 6f72 3a20 7b7d 2e27 2e66  on error: {}.'.f
+00041d70: 6f72 6d61 7428 7379 732e 6578 635f 696e  ormat(sys.exc_in
+00041d80: 666f 2829 5b31 5d29 0a20 2020 2020 2020  fo()[1]).       
+00041d90: 2020 2020 2020 2020 2065 7272 6c69 7374           errlist
+00041da0: 2e61 7070 656e 6428 6572 7229 0a20 2020  .append(err).   
+00041db0: 2020 2020 2020 2020 2020 2020 2073 7973               sys
+00041dc0: 2e73 7464 6572 722e 7772 6974 6528 6572  .stderr.write(er
+00041dd0: 7220 2b20 275c 6e27 290a 0a20 2020 2020  r + '\n')..     
+00041de0: 2020 2020 2020 2023 206d 6f64 656c 7320         # models 
+00041df0: 3d20 2720 272e 6a6f 696e 285b 276d 7966  = ' '.join(['myf
+00041e00: 6972 7374 2e63 6966 272c 2027 6d79 7365  irst.cif', 'myse
+00041e10: 636f 6e64 2e63 6966 275d 2920 2020 2020  cond.cif'])     
+00041e20: 2020 2320 6661 6b65 2074 6573 7420 706f    # fake test po
+00041e30: 696e 7420 666f 7220 6d75 6c74 6970 6c65  int for multiple
+00041e40: 2063 6966 2066 696c 6573 0a20 2020 2020   cif files.     
+00041e50: 2020 2020 2020 2069 6620 7173 636f 7265         if qscore
+00041e60: 6170 7020 616e 6420 7365 6c66 2e6d 6f64  app and self.mod
+00041e70: 656c 733a 0a20 2020 2020 2020 2020 2020  els:.           
+00041e80: 2020 2020 2023 206f 6c64 2051 7363 6f72       # old Qscor
+00041e90: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00041ea0: 2020 2320 7173 636f 7265 636d 6420 3d20    # qscorecmd = 
+00041eb0: 277b 7d20 2d2d 6e6f 6775 6920 2d2d 6e6f  '{} --nogui --no
+00041ec0: 7374 6174 7573 207b 7d20 7b7d 207b 7d27  status {} {} {}'
+00041ed0: 2e66 6f72 6d61 7428 6f63 6869 6d65 7261  .format(ochimera
+00041ee0: 6170 702c 206d 6170 6e61 6d65 2c20 6d6f  app, mapname, mo
+00041ef0: 6465 6c73 2c20 7173 636f 7265 6170 7029  dels, qscoreapp)
+00041f00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00041f10: 2076 6f72 636f 6e74 656e 7473 203d 206f   vorcontents = o
+00041f20: 6368 696d 6572 6161 7070 2e73 706c 6974  chimeraapp.split
+00041f30: 2827 436f 6e74 656e 7473 2729 5b30 5d20  ('Contents')[0] 
+00041f40: 6966 2027 436f 6e74 656e 7473 2720 696e  if 'Contents' in
+00041f50: 206f 6368 696d 6572 6161 7070 2065 6c73   ochimeraapp els
+00041f60: 6520 6f63 6869 6d65 7261 6170 702e 7370  e ochimeraapp.sp
+00041f70: 6c69 7428 2762 696e 2729 5b30 5d0a 2020  lit('bin')[0].  
+00041f80: 2020 2020 2020 2020 2020 2020 2020 7173                qs
+00041f90: 636f 7265 636d 6420 3d20 277b 7d20 7b7d  corecmd = '{} {}
+00041fa0: 207b 7d20 6d61 703d 7b7d 207b 7d20 6e70   {} map={} {} np
+00041fb0: 3d7b 7d20 7265 733d 7b7d 2073 6967 6d61  ={} res={} sigma
+00041fc0: 3d30 2e34 272e 666f 726d 6174 2873 7973  =0.4'.format(sys
+00041fd0: 2e65 7865 6375 7461 626c 652c 2071 7363  .executable, qsc
+00041fe0: 6f72 6561 7070 2c20 766f 7263 6f6e 7465  oreapp, vorconte
+00041ff0: 6e74 732c 0a20 2020 2020 2020 2020 2020  nts,.           
+00042000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042030: 2020 2020 2020 6d61 706e 616d 652c 206d        mapname, m
+00042040: 6f64 656c 732c 206e 756d 6f66 636f 7265  odels, numofcore
+00042050: 732c 2073 656c 662e 7265 736f 6c75 7469  s, self.resoluti
+00042060: 6f6e 290a 2020 2020 2020 2020 2020 2020  on).            
+00042070: 2020 2020 7072 696e 7428 7173 636f 7265      print(qscore
+00042080: 636d 6429 0a20 2020 2020 2020 2020 2020  cmd).           
+00042090: 2020 2020 206c 7173 636f 7265 636d 6420       lqscorecmd 
+000420a0: 3d20 7173 636f 7265 636d 642e 7370 6c69  = qscorecmd.spli
+000420b0: 7428 2720 2729 0a20 2020 2020 2020 2020  t(' ').         
+000420c0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+000420d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000420e0: 7072 6f63 6573 7320 3d20 7375 6270 726f  process = subpro
+000420f0: 6365 7373 2e50 6f70 656e 286c 7173 636f  cess.Popen(lqsco
+00042100: 7265 636d 642c 2073 7464 6f75 743d 7375  recmd, stdout=su
+00042110: 6270 726f 6365 7373 2e50 4950 452c 2073  bprocess.PIPE, s
+00042120: 7464 6572 723d 7375 6270 726f 6365 7373  tderr=subprocess
+00042130: 2e53 5444 4f55 542c 0a20 2020 2020 2020  .STDOUT,.       
+00042140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042160: 2020 2020 2020 2020 6377 643d 7365 6c66          cwd=self
+00042170: 2e77 6f72 6b64 6972 290a 2020 2020 2020  .workdir).      
+00042180: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
+00042190: 7470 7574 203d 2070 726f 6365 7373 2e63  tput = process.c
+000421a0: 6f6d 6d75 6e69 6361 7465 2827 6e5c 6e27  ommunicate('n\n'
+000421b0: 295b 305d 0a20 2020 2020 2020 2020 2020  )[0].           
+000421c0: 2020 2020 2020 2020 2065 7272 7173 636f           errqsco
+000421d0: 7265 203d 2027 6572 726f 7227 0a20 2020  re = 'error'.   
+000421e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000421f0: 2069 6620 7379 732e 7665 7273 696f 6e5f   if sys.version_
+00042200: 696e 666f 5b30 5d20 3e3d 2033 3a0a 2020  info[0] >= 3:.  
 00042210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042220: 7173 636f 7265 6369 6620 3d20 7071 7363  qscorecif = pqsc
-00042230: 6f72 6563 6966 2069 6620 6c65 6e28 7071  orecif if len(pq
-00042240: 7363 6f72 6563 6966 2e67 6574 5f6c 6973  scorecif.get_lis
-00042250: 7428 2929 203d 3d20 3120 656c 7365 2070  t()) == 1 else p
-00042260: 7173 636f 7265 6369 665b 305d 0a20 2020  qscorecif[0].   
-00042270: 2020 2020 2020 2020 2020 2020 2071 6669               qfi
-00042280: 6c65 732e 6170 7065 6e64 2871 7363 6f72  les.append(qscor
-00042290: 6563 6966 290a 2020 2020 2020 2020 2020  ecif).          
-000422a0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-000422b0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-000422c0: 6966 6469 6374 203d 2073 656c 662e 6e65  ifdict = self.ne
-000422d0: 7763 6966 5f74 6f71 6469 6374 2871 7363  wcif_toqdict(qsc
-000422e0: 6f72 6563 6966 2c20 6f72 676d 6f64 656c  orecif, orgmodel
-000422f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00042300: 2020 2020 2020 616c 6c6d 6f64 656c 735f        allmodels_
-00042310: 6e75 6d62 6572 6f66 6174 6f6d 7320 2b3d  numberofatoms +=
-00042320: 2063 6966 6469 6374 5b27 6461 7461 275d   cifdict['data']
-00042330: 5b27 6e75 6d62 6572 6f66 6174 6f6d 7327  ['numberofatoms'
-00042340: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00042350: 2020 2020 2020 616c 6c6d 6f64 656c 735f        allmodels_
-00042360: 7173 636f 7265 7320 2b3d 2063 6966 6469  qscores += cifdi
-00042370: 6374 5b27 6461 7461 275d 5b27 6e75 6d62  ct['data']['numb
-00042380: 6572 6f66 6174 6f6d 7327 5d2a 6369 6664  erofatoms']*cifd
-00042390: 6963 745b 2764 6174 6127 5d5b 2761 7665  ict['data']['ave
-000423a0: 7261 6765 7173 636f 7265 275d 0a20 2020  rageqscore'].   
-000423b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000423c0: 2071 7363 6f72 6564 6963 745b 7374 7228   qscoredict[str(
-000423d0: 6d6f 6465 6c6e 756d 295d 203d 2063 6966  modelnum)] = cif
-000423e0: 6469 6374 0a20 2020 2020 2020 2020 2020  dict.           
-000423f0: 2020 2020 2020 2020 206d 6f64 656c 6e75           modelnu
-00042400: 6d20 2b3d 2031 0a20 2020 2020 2020 2020  m += 1.         
-00042410: 2020 2020 2020 2065 7863 6570 743a 0a20         except:. 
+00042220: 2020 2020 2020 666f 7220 6974 656d 2069        for item i
+00042230: 6e20 6f75 7470 7574 2e64 6563 6f64 6528  n output.decode(
+00042240: 2775 7466 2d38 2729 2e73 706c 6974 2827  'utf-8').split('
+00042250: 5c6e 2729 3a0a 2020 2020 2020 2020 2020  \n'):.          
+00042260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042270: 2020 2320 6974 656d 203d 2063 6c69 6e65    # item = cline
+00042280: 2e64 6563 6f64 6528 2775 7466 2d38 2729  .decode('utf-8')
+00042290: 2e73 7472 6970 2829 0a20 2020 2020 2020  .strip().       
+000422a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000422b0: 2020 2020 2070 7269 6e74 2869 7465 6d29       print(item)
+000422c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000422d0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000422e0: 6572 7271 7363 6f72 6520 696e 2069 7465  errqscore in ite
+000422f0: 6d2e 6c6f 7765 7228 293a 0a20 2020 2020  m.lower():.     
+00042300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042310: 2020 2020 2020 2020 2020 2065 7272 6c69             errli
+00042320: 6e65 203d 2069 7465 6d2e 7374 7269 7028  ne = item.strip(
+00042330: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00042340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042350: 2020 6572 726c 6973 742e 6170 7065 6e64    errlist.append
+00042360: 2865 7272 6c69 6e65 290a 2020 2020 2020  (errline).      
+00042370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042380: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00042390: 2065 7272 7173 636f 7265 206e 6f74 2069   errqscore not i
+000423a0: 6e20 6f75 7470 7574 2e64 6563 6f64 6528  n output.decode(
+000423b0: 2775 7466 2d38 2729 2c20 6572 726c 696e  'utf-8'), errlin
+000423c0: 650a 0a20 2020 2020 2020 2020 2020 2020  e..             
+000423d0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000423e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000423f0: 2020 2020 2066 6f72 2069 7465 6d20 696e       for item in
+00042400: 206f 7574 7075 742e 7370 6c69 7428 275c   output.split('\
+00042410: 6e27 293a 0a20 2020 2020 2020 2020 2020  n'):.           
 00042420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042430: 2020 2065 7272 203d 2027 5173 636f 7265     err = 'Qscore
-00042440: 2063 616c 6375 6c61 7469 6f6e 2065 7272   calculation err
-00042450: 6f72 2028 4d6f 6465 6c3a 207b 7d29 3a20  or (Model: {}): 
-00042460: 7b7d 2e27 2e66 6f72 6d61 7428 6d6f 6465  {}.'.format(mode
-00042470: 6c2e 6669 6c65 6e61 6d65 2c20 7379 732e  l.filename, sys.
-00042480: 6578 635f 696e 666f 2829 5b31 5d29 0a20  exc_info()[1]). 
-00042490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000424a0: 2020 2071 7363 6f72 6565 7272 6c69 7374     qscoreerrlist
-000424b0: 2e61 7070 656e 6428 6572 7229 0a20 2020  .append(err).   
-000424c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000424d0: 2073 7973 2e73 7464 6572 722e 7772 6974   sys.stderr.writ
-000424e0: 6528 6572 7220 2b20 275c 6e27 290a 2020  e(err + '\n').  
-000424f0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00042500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042510: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-00042520: 0a20 2020 2020 2020 2069 6620 616c 6c6d  .        if allm
-00042530: 6f64 656c 735f 6e75 6d62 6572 6f66 6174  odels_numberofat
-00042540: 6f6d 7320 213d 2030 3a0a 2020 2020 2020  oms != 0:.      
-00042550: 2020 2020 2020 616c 6c6d 6f64 656c 735f        allmodels_
-00042560: 6176 6572 6167 655f 7173 636f 7265 203d  average_qscore =
-00042570: 2061 6c6c 6d6f 6465 6c73 5f71 7363 6f72   allmodels_qscor
-00042580: 6573 202f 2061 6c6c 6d6f 6465 6c73 5f6e  es / allmodels_n
-00042590: 756d 6265 726f 6661 746f 6d73 0a20 2020  umberofatoms.   
-000425a0: 2020 2020 2020 2020 2023 2071 7363 6f72           # qscor
-000425b0: 6564 6963 742e 7570 6461 7465 287b 2761  edict.update({'a
-000425c0: 6c6c 6d6f 6465 6c73 5f61 7665 7261 6765  llmodels_average
-000425d0: 5f71 7363 6f72 6527 3a20 726f 756e 6428  _qscore': round(
-000425e0: 616c 6c6d 6f64 656c 735f 6176 6572 6167  allmodels_averag
-000425f0: 655f 7173 636f 7265 2c20 3329 7d29 0a20  e_qscore, 3)}). 
-00042600: 2020 2020 2020 2020 2020 2071 7363 6f72             qscor
-00042610: 6564 6963 745b 2761 6c6c 6d6f 6465 6c73  edict['allmodels
-00042620: 5f61 7665 7261 6765 5f71 7363 6f72 6527  _average_qscore'
-00042630: 5d20 3d20 726f 756e 6428 616c 6c6d 6f64  ] = round(allmod
-00042640: 656c 735f 6176 6572 6167 655f 7173 636f  els_average_qsco
-00042650: 7265 2c20 3329 0a20 2020 2020 2020 2069  re, 3).        i
-00042660: 6620 7173 636f 7265 6469 6374 3a0a 2020  f qscoredict:.  
-00042670: 2020 2020 2020 2020 2020 6669 6e61 6c64            finald
-00042680: 6963 745b 2771 7363 6f72 6527 5d20 3d20  ict['qscore'] = 
-00042690: 7173 636f 7265 6469 6374 0a20 2020 2020  qscoredict.     
-000426a0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-000426b0: 2020 2020 2020 2020 2020 2020 7769 7468              with
-000426c0: 2063 6f64 6563 732e 6f70 656e 2873 656c   codecs.open(sel
-000426d0: 662e 776f 726b 6469 7220 2b20 7365 6c66  f.workdir + self
-000426e0: 2e6d 6170 6e61 6d65 202b 2027 5f71 7363  .mapname + '_qsc
-000426f0: 6f72 652e 6a73 6f6e 272c 2027 7727 2c0a  ore.json', 'w',.
-00042700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042720: 2065 6e63 6f64 696e 673d 2775 7466 2d38   encoding='utf-8
-00042730: 2729 2061 7320 663a 0a20 2020 2020 2020  ') as f:.       
-00042740: 2020 2020 2020 2020 2020 2020 206a 736f               jso
-00042750: 6e2e 6475 6d70 2866 696e 616c 6469 6374  n.dump(finaldict
-00042760: 2c20 6629 0a20 2020 2020 2020 2020 2020  , f).           
-00042770: 2065 7863 6570 743a 0a20 2020 2020 2020   except:.       
-00042780: 2020 2020 2020 2020 2073 7973 2e73 7464           sys.std
-00042790: 6572 722e 7772 6974 6528 2753 6176 696e  err.write('Savin
-000427a0: 6720 746f 2051 7363 6f72 6520 6a73 6f6e  g to Qscore json
-000427b0: 2065 7272 6f72 3a20 7b7d 2e5c 6e27 2e66   error: {}.\n'.f
-000427c0: 6f72 6d61 7428 7379 732e 6578 635f 696e  ormat(sys.exc_in
-000427d0: 666f 2829 5b31 5d29 290a 2020 2020 2020  fo()[1])).      
-000427e0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000427f0: 2020 2020 7072 696e 7428 2751 7363 6f72      print('Qscor
-00042800: 6520 7761 7320 6e6f 7420 636f 6c6c 6563  e was not collec
-00042810: 7465 642c 2070 6c65 6173 6520 6368 6563  ted, please chec
-00042820: 6b21 2729 0a0a 0a20 2020 2020 2020 2072  k!')...        r
-00042830: 6574 7572 6e20 4e6f 6e65 0a0a 2020 2020  eturn None..    
-00042840: 6465 6620 6e65 7763 6966 5f74 6f71 6469  def newcif_toqdi
-00042850: 6374 2873 656c 662c 2071 7363 6f72 6563  ct(self, qscorec
-00042860: 6966 2c20 6f72 676d 6f64 656c 293a 0a20  if, orgmodel):. 
-00042870: 2020 2020 2020 2022 2222 0a0a 2020 2020         """..    
-00042880: 2020 2020 2020 2020 4769 7665 6e20 6369          Given ci
-00042890: 6620 6269 6f70 7974 686f 6e20 6f62 6a65  f biopython obje
-000428a0: 6374 2061 6e64 2063 6f6e 7665 7274 2074  ct and convert t
-000428b0: 6f20 6120 6469 6374 6f72 7920 7768 6963  o a dictory whic
-000428c0: 6820 636f 6e74 6169 6e73 2061 6c6c 2064  h contains all d
-000428d0: 6174 6120 666f 7220 4a53 4f4e 0a0a 2020  ata for JSON..  
-000428e0: 2020 2020 2020 3a72 6574 7572 6e3a 2044        :return: D
-000428f0: 4943 5420 636f 6e74 6169 6e73 2051 2d73  ICT contains Q-s
-00042900: 636f 7265 2064 6174 6120 6672 6f6d 206d  core data from m
-00042910: 6d63 6966 2028 6269 6f70 7974 686f 6e20  mcif (biopython 
-00042920: 6f62 6a65 6374 290a 2020 2020 2020 2020  object).        
-00042930: 2222 220a 0a0a 2020 2020 2020 2020 7265  """...        re
-00042940: 7369 6475 6573 203d 205b 5d0a 2020 2020  sidues = [].    
-00042950: 2020 2020 636f 6c6f 7273 203d 205b 5d0a      colors = [].
-00042960: 2020 2020 2020 2020 7173 636f 7265 7320          qscores 
-00042970: 3d20 5b5d 0a20 2020 2020 2020 2063 6861  = [].        cha
-00042980: 696e 5f71 7363 6f72 6520 3d20 7b7d 0a20  in_qscore = {}. 
-00042990: 2020 2020 2020 2071 7363 6f72 655f 6c69         qscore_li
-000429a0: 7374 203d 205b 6174 6f6d 2e71 7363 6f72  st = [atom.qscor
-000429b0: 6520 666f 7220 6174 6f6d 2069 6e20 7173  e for atom in qs
-000429c0: 636f 7265 6369 662e 6765 745f 6174 6f6d  corecif.get_atom
-000429d0: 7328 2920 6966 2061 746f 6d2e 7173 636f  s() if atom.qsco
-000429e0: 7265 203e 2031 2e30 5d0a 2020 2020 2020  re > 1.0].      
-000429f0: 2020 7072 6f74 6569 6e5f 7173 636f 7265    protein_qscore
-00042a00: 7320 3d20 5b5d 0a20 2020 2020 2020 2066  s = [].        f
-00042a10: 6f72 2061 746f 6d20 696e 2071 7363 6f72  or atom in qscor
-00042a20: 6563 6966 2e67 6574 5f61 746f 6d73 2829  ecif.get_atoms()
-00042a30: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00042a40: 2061 746f 6d2e 6e61 6d65 2e73 7461 7274   atom.name.start
-00042a50: 7377 6974 6828 2748 2729 206f 7220 6174  swith('H') or at
-00042a60: 6f6d 2e67 6574 5f70 6172 656e 7428 292e  om.get_parent().
-00042a70: 7265 736e 616d 6520 3d3d 2027 484f 4827  resname == 'HOH'
-00042a80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00042a90: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
-00042aa0: 2020 2020 2020 2070 726f 7465 696e 5f71         protein_q
-00042ab0: 7363 6f72 6573 2e61 7070 656e 6428 6174  scores.append(at
-00042ac0: 6f6d 2e71 7363 6f72 6529 0a20 2020 2020  om.qscore).     
-00042ad0: 2020 2061 7665 7261 6765 5f71 7363 6f72     average_qscor
-00042ae0: 6520 3d20 726f 756e 6428 7375 6d28 7072  e = round(sum(pr
-00042af0: 6f74 6569 6e5f 7173 636f 7265 7329 202f  otein_qscores) /
-00042b00: 206c 656e 2870 726f 7465 696e 5f71 7363   len(protein_qsc
-00042b10: 6f72 6573 292c 2033 290a 2020 2020 2020  ores), 3).      
-00042b20: 2020 6966 2071 7363 6f72 655f 6c69 7374    if qscore_list
-00042b30: 3a0a 2020 2020 2020 2020 2020 2020 6d69  :.            mi
-00042b40: 6e5f 7173 636f 7265 203d 206d 696e 2871  n_qscore = min(q
-00042b50: 7363 6f72 655f 6c69 7374 290a 2020 2020  score_list).    
-00042b60: 2020 2020 2020 2020 6d61 785f 7173 636f          max_qsco
-00042b70: 7265 203d 206d 6178 2871 7363 6f72 655f  re = max(qscore_
-00042b80: 6c69 7374 290a 2020 2020 2020 2020 666f  list).        fo
-00042b90: 7220 6368 6169 6e20 696e 2071 7363 6f72  r chain in qscor
-00042ba0: 6563 6966 2e67 6574 5f63 6861 696e 7328  ecif.get_chains(
-00042bb0: 293a 0a20 2020 2020 2020 2020 2020 2063  ):.            c
-00042bc0: 7572 6368 6169 6e5f 6e61 6d65 203d 2063  urchain_name = c
-00042bd0: 6861 696e 2e69 640a 2020 2020 2020 2020  hain.id.        
-00042be0: 2020 2020 6375 7263 6861 696e 5f71 7363      curchain_qsc
-00042bf0: 6f72 6520 3d20 5b5d 0a20 2020 2020 2020  ore = [].       
-00042c00: 2020 2020 2066 6f72 2061 746f 6d20 696e       for atom in
-00042c10: 2063 6861 696e 2e67 6574 5f61 746f 6d73   chain.get_atoms
-00042c20: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00042c30: 2020 2020 6966 2061 746f 6d2e 6e61 6d65      if atom.name
-00042c40: 2e73 7461 7274 7377 6974 6828 2748 2729  .startswith('H')
-00042c50: 206f 7220 6174 6f6d 2e67 6574 5f70 6172   or atom.get_par
-00042c60: 656e 7428 292e 7265 736e 616d 6520 3d3d  ent().resname ==
-00042c70: 2027 484f 4827 3a0a 2020 2020 2020 2020   'HOH':.        
-00042c80: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-00042c90: 696e 7565 0a20 2020 2020 2020 2020 2020  inue.           
-00042ca0: 2020 2020 2063 7572 6368 6169 6e5f 7173       curchain_qs
-00042cb0: 636f 7265 2e61 7070 656e 6428 6174 6f6d  core.append(atom
-00042cc0: 2e71 7363 6f72 6529 0a20 2020 2020 2020  .qscore).       
-00042cd0: 2020 2020 2069 6620 6e6f 7420 6375 7263       if not curc
-00042ce0: 6861 696e 5f71 7363 6f72 653a 0a20 2020  hain_qscore:.   
-00042cf0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00042d00: 7469 6e75 650a 2020 2020 2020 2020 2020  tinue.          
-00042d10: 2020 6176 6572 6167 6563 7572 6368 6169    averagecurchai
-00042d20: 6e5f 7173 636f 7265 203d 2072 6f75 6e64  n_qscore = round
-00042d30: 2873 756d 2863 7572 6368 6169 6e5f 7173  (sum(curchain_qs
-00042d40: 636f 7265 2920 2f20 6c65 6e28 6375 7263  core) / len(curc
-00042d50: 6861 696e 5f71 7363 6f72 6529 2c20 3329  hain_qscore), 3)
-00042d60: 0a20 2020 2020 2020 2020 2020 2061 746f  .            ato
-00042d70: 6d73 5f69 6e63 6861 696e 203d 2030 0a20  ms_inchain = 0. 
-00042d80: 2020 2020 2020 2020 2020 2071 7363 6f72             qscor
-00042d90: 655f 696e 6368 6169 6e20 3d20 302e 0a20  e_inchain = 0.. 
-00042da0: 2020 2020 2020 2020 2020 2066 6f72 2072             for r
-00042db0: 6573 6964 7565 2069 6e20 6368 6169 6e3a  esidue in chain:
-00042dc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00042dd0: 2063 7572 7265 735f 6e61 6d65 203d 2072   curres_name = r
-00042de0: 6573 6964 7565 2e72 6573 6e61 6d65 0a20  esidue.resname. 
-00042df0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00042e00: 6620 6375 7272 6573 5f6e 616d 6520 3d3d  f curres_name ==
-00042e10: 2027 484f 4827 3a0a 2020 2020 2020 2020   'HOH':.        
-00042e20: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-00042e30: 696e 7565 0a20 2020 2020 2020 2020 2020  inue.           
-00042e40: 2020 2020 2063 7572 7265 735f 6964 203d       curres_id =
-00042e50: 2072 6573 6964 7565 2e69 645b 315d 0a20   residue.id[1]. 
-00042e60: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00042e70: 746f 6d73 5f69 6e72 6573 6964 7565 203d  toms_inresidue =
-00042e80: 2030 0a20 2020 2020 2020 2020 2020 2020   0.             
-00042e90: 2020 2071 7363 6f72 655f 696e 7265 7369     qscore_inresi
-00042ea0: 6475 6520 3d20 302e 0a20 2020 2020 2020  due = 0..       
-00042eb0: 2020 2020 2020 2020 2066 6f72 2061 746f           for ato
-00042ec0: 6d20 696e 2072 6573 6964 7565 3a0a 2020  m in residue:.  
-00042ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042ee0: 2020 6966 2061 746f 6d2e 6e61 6d65 2e73    if atom.name.s
-00042ef0: 7461 7274 7377 6974 6828 2748 2729 206f  tartswith('H') o
-00042f00: 7220 6174 6f6d 2e67 6574 5f70 6172 656e  r atom.get_paren
-00042f10: 7428 292e 7265 736e 616d 6520 3d3d 2027  t().resname == '
-00042f20: 484f 4827 3a0a 2020 2020 2020 2020 2020  HOH':.          
-00042f30: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00042f40: 6e74 696e 7565 0a20 2020 2020 2020 2020  ntinue.         
-00042f50: 2020 2020 2020 2020 2020 2061 746f 6d73             atoms
-00042f60: 5f69 6e63 6861 696e 202b 3d20 310a 2020  _inchain += 1.  
-00042f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00042f80: 2020 6174 6f6d 735f 696e 7265 7369 6475    atoms_inresidu
-00042f90: 6520 2b3d 2031 0a20 2020 2020 2020 2020  e += 1.         
-00042fa0: 2020 2020 2020 2020 2020 2063 7572 6174             curat
-00042fb0: 6f6d 5f71 7363 6f72 6520 3d20 6174 6f6d  om_qscore = atom
-00042fc0: 2e71 7363 6f72 650a 2020 2020 2020 2020  .qscore.        
-00042fd0: 2020 2020 2020 2020 2020 2020 7173 636f              qsco
-00042fe0: 7265 5f69 6e63 6861 696e 202b 3d20 6375  re_inchain += cu
-00042ff0: 7261 746f 6d5f 7173 636f 7265 0a20 2020  ratom_qscore.   
-00043000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043010: 2071 7363 6f72 655f 696e 7265 7369 6475   qscore_inresidu
-00043020: 6520 2b3d 2063 7572 6174 6f6d 5f71 7363  e += curatom_qsc
-00043030: 6f72 650a 2020 2020 2020 2020 2020 2020  ore.            
-00043040: 2020 2020 6966 2061 746f 6d73 5f69 6e72      if atoms_inr
-00043050: 6573 6964 7565 2021 3d20 302e 3a0a 2020  esidue != 0.:.  
-00043060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043070: 2020 6375 7272 6573 5f71 7363 6f72 6520    curres_qscore 
-00043080: 3d20 726f 756e 6428 7173 636f 7265 5f69  = round(qscore_i
-00043090: 6e72 6573 6964 7565 202f 2061 746f 6d73  nresidue / atoms
-000430a0: 5f69 6e72 6573 6964 7565 2c20 3329 0a20  _inresidue, 3). 
-000430b0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-000430c0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000430d0: 2020 2020 2020 2020 2063 7572 7265 735f           curres_
-000430e0: 7173 636f 7265 203d 2030 2e0a 2020 2020  qscore = 0..    
-000430f0: 2020 2020 2020 2020 2020 2020 6966 2063              if c
-00043100: 7572 7265 735f 7173 636f 7265 203e 2031  urres_qscore > 1
-00043110: 2e30 3a0a 2020 2020 2020 2020 2020 2020  .0:.            
-00043120: 2020 2020 2020 2020 6966 206d 696e 5f71          if min_q
-00043130: 7363 6f72 6520 3d3d 206d 6178 5f71 7363  score == max_qsc
-00043140: 6f72 653a 0a20 2020 2020 2020 2020 2020  ore:.           
-00043150: 2020 2020 2020 2020 2020 2020 2063 7572               cur
-00043160: 7265 735f 636f 6c6f 7220 3d20 2723 3030  res_color = '#00
-00043170: 3030 3030 270a 2020 2020 2020 2020 2020  0000'.          
-00043180: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00043190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000431a0: 2020 2020 2020 2020 7363 616c 6564 5f71          scaled_q
-000431b0: 7363 6f72 6520 3d20 2863 7572 7265 735f  score = (curres_
-000431c0: 7173 636f 7265 202d 206d 696e 5f71 7363  qscore - min_qsc
-000431d0: 6f72 6529 202f 2028 6d61 785f 7173 636f  ore) / (max_qsco
-000431e0: 7265 202d 206d 696e 5f71 7363 6f72 6529  re - min_qscore)
-000431f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00043200: 2020 2020 2020 2020 2063 7572 7265 735f           curres_
-00043210: 636f 6c6f 7220 3d20 7365 6c66 2e5f 5f66  color = self.__f
-00043220: 6c6f 6174 6f68 6578 5f61 626f 7665 6f6e  loatohex_aboveon
-00043230: 6528 5b73 6361 6c65 645f 7173 636f 7265  e([scaled_qscore
-00043240: 5d29 5b30 5d0a 2020 2020 2020 2020 2020  ])[0].          
-00043250: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00043260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043270: 6375 7272 6573 5f63 6f6c 6f72 203d 2073  curres_color = s
-00043280: 656c 662e 5f5f 666c 6f61 746f 6865 7828  elf.__floatohex(
-00043290: 5b63 7572 7265 735f 7173 636f 7265 5d29  [curres_qscore])
-000432a0: 5b30 5d0a 0a20 2020 2020 2020 2020 2020  [0]..           
-000432b0: 2020 2020 2069 636f 6465 203d 2072 6573       icode = res
-000432c0: 6964 7565 2e69 645b 325d 0a20 2020 2020  idue.id[2].     
-000432d0: 2020 2020 2020 2020 2020 2069 6620 6963             if ic
-000432e0: 6f64 6520 213d 2027 2027 3a0a 2020 2020  ode != ' ':.    
-000432f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043300: 6375 7272 6573 5f73 7472 696e 6720 3d20  curres_string = 
-00043310: 277b 7d3a 7b7d 7b7d 207b 7d27 2e66 6f72  '{}:{}{} {}'.for
-00043320: 6d61 7428 6375 7263 6861 696e 5f6e 616d  mat(curchain_nam
-00043330: 652c 2063 7572 7265 735f 6964 2c20 6963  e, curres_id, ic
-00043340: 6f64 652c 2063 7572 7265 735f 6e61 6d65  ode, curres_name
-00043350: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00043360: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00043370: 2020 2020 2020 2020 2020 2020 6375 7272              curr
-00043380: 6573 5f73 7472 696e 6720 3d20 277b 7d3a  es_string = '{}:
-00043390: 7b7d 207b 7d27 2e66 6f72 6d61 7428 6375  {} {}'.format(cu
-000433a0: 7263 6861 696e 5f6e 616d 652c 2063 7572  rchain_name, cur
-000433b0: 7265 735f 6964 2c20 6375 7272 6573 5f6e  res_id, curres_n
-000433c0: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
-000433d0: 2020 2020 2072 6573 6964 7565 732e 6170       residues.ap
-000433e0: 7065 6e64 2863 7572 7265 735f 7374 7269  pend(curres_stri
-000433f0: 6e67 290a 2020 2020 2020 2020 2020 2020  ng).            
-00043400: 2020 2020 636f 6c6f 7273 2e61 7070 656e      colors.appen
-00043410: 6428 6375 7272 6573 5f63 6f6c 6f72 290a  d(curres_color).
-00043420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043430: 7173 636f 7265 732e 6170 7065 6e64 2863  qscores.append(c
-00043440: 7572 7265 735f 7173 636f 7265 290a 2020  urres_qscore).  
-00043450: 2020 2020 2020 2020 2020 6176 6572 6167            averag
-00043460: 6571 7363 6f72 655f 696e 636f 6c6f 7220  eqscore_incolor 
-00043470: 3d20 7365 6c66 2e5f 5f66 6c6f 6174 6f68  = self.__floatoh
-00043480: 6578 285b 6176 6572 6167 6563 7572 6368  ex([averagecurch
-00043490: 6169 6e5f 7173 636f 7265 5d29 5b30 5d0a  ain_qscore])[0].
-000434a0: 2020 2020 2020 2020 2020 2020 6368 6169              chai
-000434b0: 6e5f 7173 636f 7265 5b63 7572 6368 6169  n_qscore[curchai
-000434c0: 6e5f 6e61 6d65 5d20 3d20 7b27 7661 6c75  n_name] = {'valu
-000434d0: 6527 3a20 6176 6572 6167 6563 7572 6368  e': averagecurch
-000434e0: 6169 6e5f 7173 636f 7265 2c20 2763 6f6c  ain_qscore, 'col
-000434f0: 6f72 273a 2061 7665 7261 6765 7173 636f  or': averageqsco
-00043500: 7265 5f69 6e63 6f6c 6f72 7d0a 0a20 2020  re_incolor}..   
-00043510: 2020 2020 206c 6576 656c 7320 3d20 6e70       levels = np
-00043520: 2e6c 696e 7370 6163 6528 2d31 2c20 312c  .linspace(-1, 1,
-00043530: 2031 3030 290a 2020 2020 2020 2020 7161   100).        qa
-00043540: 7272 6179 203d 206e 702e 6172 7261 7928  rray = np.array(
-00043550: 7173 636f 7265 7329 0a20 2020 2020 2020  qscores).       
-00043560: 2068 6973 742c 2062 696e 5f65 6467 6573   hist, bin_edges
-00043570: 203d 206e 702e 6869 7374 6f67 7261 6d28   = np.histogram(
-00043580: 7161 7272 6179 2c20 6269 6e73 3d6c 6576  qarray, bins=lev
-00043590: 656c 7329 0a20 2020 2020 2020 2070 6c74  els).        plt
-000435a0: 2e70 6c6f 7428 6269 6e5f 6564 6765 735b  .plot(bin_edges[
-000435b0: 313a 5d2c 2068 6973 742f 7161 7272 6179  1:], hist/qarray
-000435c0: 2e73 697a 6529 0a0a 2020 2020 2020 2020  .size)..        
-000435d0: 7072 6f74 6569 6e5f 7161 7272 6179 203d  protein_qarray =
-000435e0: 206e 702e 6172 7261 7928 7072 6f74 6569   np.array(protei
-000435f0: 6e5f 7173 636f 7265 7329 0a20 2020 2020  n_qscores).     
-00043600: 2020 2070 6869 7374 2c20 705f 6269 6e5f     phist, p_bin_
-00043610: 6564 6765 7320 3d20 6e70 2e68 6973 746f  edges = np.histo
-00043620: 6772 616d 2870 726f 7465 696e 5f71 6172  gram(protein_qar
-00043630: 7261 792c 2062 696e 733d 6c65 7665 6c73  ray, bins=levels
-00043640: 290a 2020 2020 2020 2020 706c 742e 706c  ).        plt.pl
-00043650: 6f74 2870 5f62 696e 5f65 6467 6573 5b31  ot(p_bin_edges[1
-00043660: 3a5d 2c20 7068 6973 742f 7072 6f74 6569  :], phist/protei
-00043670: 6e5f 7161 7272 6179 2e73 697a 6529 0a20  n_qarray.size). 
-00043680: 2020 2020 2020 2070 6c74 2e78 6c61 6265         plt.xlabe
-00043690: 6c28 2751 2d73 636f 7265 2729 0a20 2020  l('Q-score').   
-000436a0: 2020 2020 2070 6c74 2e79 6c61 6265 6c28       plt.ylabel(
-000436b0: 2746 7261 6374 696f 6e27 290a 2020 2020  'Fraction').    
-000436c0: 2020 2020 706c 742e 6c65 6765 6e64 2828      plt.legend((
-000436d0: 2752 6573 6964 7565 3a20 2720 2b20 2728  'Residue: ' + '(
-000436e0: 2720 2b20 7374 7228 7161 7272 6179 2e73  ' + str(qarray.s
-000436f0: 697a 6529 202b 2027 2927 2c20 2741 746f  ize) + ')', 'Ato
-00043700: 6d3a 2027 202b 2027 2827 202b 2073 7472  m: ' + '(' + str
-00043710: 2870 726f 7465 696e 5f71 6172 7261 792e  (protein_qarray.
-00043720: 7369 7a65 2920 2b20 2729 2729 2c20 6c6f  size) + ')'), lo
-00043730: 633d 2775 7070 6572 206c 6566 7427 2c20  c='upper left', 
-00043740: 7368 6164 6f77 3d54 7275 6529 0a20 2020  shadow=True).   
-00043750: 2020 2020 2069 6620 7365 6c66 2e6d 6170       if self.map
-00043760: 6e61 6d65 2061 6e64 2073 656c 662e 7265  name and self.re
-00043770: 736f 6c75 7469 6f6e 3a0a 2020 2020 2020  solution:.      
-00043780: 2020 2020 2020 706c 742e 7469 746c 6528        plt.title(
-00043790: 274d 6170 3a20 2720 2b20 7365 6c66 2e6d  'Map: ' + self.m
-000437a0: 6170 6e61 6d65 202b 2027 2061 743a 2027  apname + ' at: '
-000437b0: 202b 2073 7472 2873 656c 662e 7265 736f   + str(self.reso
-000437c0: 6c75 7469 6f6e 2920 2b20 27c3 8527 290a  lution) + '..').
-000437d0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-000437e0: 2020 2020 2020 2020 2020 706c 742e 7469            plt.ti
-000437f0: 746c 6528 274d 6170 2051 2d73 636f 7265  tle('Map Q-score
-00043800: 2027 290a 2020 2020 2020 2020 706c 742e   ').        plt.
-00043810: 7361 7665 6669 6728 7365 6c66 2e77 6f72  savefig(self.wor
-00043820: 6b64 6972 202b 2073 656c 662e 6d61 706e  kdir + self.mapn
-00043830: 616d 6520 2b20 275f 7173 636f 7265 2e70  ame + '_qscore.p
-00043840: 6e67 2729 0a20 2020 2020 2020 2070 6c74  ng').        plt
-00043850: 2e63 6c6f 7365 2829 0a20 2020 2020 2020  .close().       
-00043860: 2071 5f72 6573 6964 7565 5f66 7261 6374   q_residue_fract
-00043870: 696f 6e73 203d 206c 6973 7428 6e70 2e61  ions = list(np.a
-00043880: 726f 756e 6428 6869 7374 2f71 6172 7261  round(hist/qarra
-00043890: 792e 7369 7a65 2c20 3329 290a 2020 2020  y.size, 3)).    
-000438a0: 2020 2020 715f 7072 6f74 6569 6e5f 6672      q_protein_fr
-000438b0: 6163 7469 6f6e 7320 3d20 6c69 7374 286e  actions = list(n
-000438c0: 702e 6172 6f75 6e64 2870 6869 7374 2f70  p.around(phist/p
-000438d0: 726f 7465 696e 5f71 6172 7261 792e 7369  rotein_qarray.si
-000438e0: 7a65 2c20 3329 290a 2020 2020 2020 2020  ze, 3)).        
-000438f0: 7166 7261 6374 696f 6e73 203d 207b 2771  qfractions = {'q
-00043900: 4c65 7665 6c73 273a 206c 6973 7428 6e70  Levels': list(np
-00043910: 2e61 726f 756e 6428 6c65 7665 6c73 5b31  .around(levels[1
-00043920: 3a5d 2c20 3329 292c 2027 7152 6573 6964  :], 3)), 'qResid
-00043930: 7565 4672 6163 7469 6f6e 7327 3a20 715f  ueFractions': q_
-00043940: 7265 7369 6475 655f 6672 6163 7469 6f6e  residue_fraction
-00043950: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-00043960: 2020 2020 2020 2020 2027 7141 746f 6d46           'qAtomF
-00043970: 7261 6374 696f 6e73 273a 2071 5f70 726f  ractions': q_pro
-00043980: 7465 696e 5f66 7261 6374 696f 6e73 7d0a  tein_fractions}.
-00043990: 0a20 2020 2020 2020 2023 2073 636f 7265  .        # score
-000439a0: 5f74 7970 6520 3d20 2771 7363 6f72 6527  _type = 'qscore'
-000439b0: 0a20 2020 2020 2020 2023 206e 6577 5f64  .        # new_d
-000439c0: 6963 7420 3d20 7b27 6964 273a 2073 656c  ict = {'id': sel
-000439d0: 662e 656d 6469 642c 2027 7265 736f 6c75  f.emdid, 'resolu
-000439e0: 7469 6f6e 273a 2066 6c6f 6174 2873 656c  tion': float(sel
-000439f0: 662e 7265 736f 6c75 7469 6f6e 292c 2027  f.resolution), '
-00043a00: 6e61 6d65 273a 206f 7267 6d6f 6465 6c2c  name': orgmodel,
-00043a10: 2073 636f 7265 5f74 7970 653a 2061 7665   score_type: ave
-00043a20: 7261 6765 5f71 7363 6f72 657d 0a20 2020  rage_qscore}.   
-00043a30: 2020 2020 2023 2070 6c6f 745f 6e61 6d65       # plot_name
-00043a40: 203d 2027 7b7d 5f7b 7d5f 7b7d 5f62 6172   = '{}_{}_{}_bar
-00043a50: 2e70 6e67 272e 666f 726d 6174 2873 656c  .png'.format(sel
-00043a60: 662e 6d61 706e 616d 652c 206f 7267 6d6f  f.mapname, orgmo
-00043a70: 6465 6c2c 2073 636f 7265 5f74 7970 6529  del, score_type)
-00043a80: 0a20 2020 2020 2020 2023 2073 636f 7265  .        # score
-00043a90: 5f64 6972 203d 206f 732e 7061 7468 2e64  _dir = os.path.d
-00043aa0: 6972 6e61 6d65 2876 612e 5f5f 6669 6c65  irname(va.__file
-00043ab0: 5f5f 290a 2020 2020 2020 2020 2320 7265  __).        # re
-00043ac0: 6c61 7469 7665 5f74 6f77 686f 6c65 2c20  lative_towhole, 
-00043ad0: 7265 6c61 7469 7665 5f74 6f74 776f 203d  relative_totwo =
-00043ae0: 2062 6172 286e 6577 5f64 6963 742c 2073   bar(new_dict, s
-00043af0: 636f 7265 5f74 7970 652c 2073 656c 662e  core_type, self.
-00043b00: 776f 726b 6469 722c 2073 636f 7265 5f64  workdir, score_d
-00043b10: 6972 2c20 706c 6f74 5f6e 616d 6529 0a20  ir, plot_name). 
-00043b20: 2020 2020 2020 2023 2071 6261 7220 3d20         # qbar = 
-00043b30: 7b27 7768 6f6c 6527 3a20 7265 6c61 7469  {'whole': relati
-00043b40: 7665 5f74 6f77 686f 6c65 2c20 2772 656c  ve_towhole, 'rel
-00043b50: 6174 6976 6527 3a20 7265 6c61 7469 7665  ative': relative
-00043b60: 5f74 6f74 776f 7d0a 0a20 2020 2020 2020  _totwo}..       
-00043b70: 2074 6469 6374 203d 204f 7264 6572 6564   tdict = Ordered
-00043b80: 4469 6374 285b 0a20 2020 2020 2020 2020  Dict([.         
-00043b90: 2020 2028 2761 7665 7261 6765 7173 636f     ('averageqsco
-00043ba0: 7265 272c 2061 7665 7261 6765 5f71 7363  re', average_qsc
-00043bb0: 6f72 6529 2c0a 2020 2020 2020 2020 2020  ore),.          
-00043bc0: 2020 2827 6176 6572 6167 6571 7363 6f72    ('averageqscor
-00043bd0: 655f 636f 6c6f 7227 2c20 7365 6c66 2e5f  e_color', self._
-00043be0: 5f66 6c6f 6174 6f68 6578 285b 6176 6572  _floatohex([aver
-00043bf0: 6167 655f 7173 636f 7265 5d29 5b30 5d29  age_qscore])[0])
-00043c00: 2c0a 2020 2020 2020 2020 2020 2020 2320  ,.            # 
-00043c10: 2827 7173 636f 7265 5f62 6172 272c 2071  ('qscore_bar', q
-00043c20: 6261 7229 2c0a 2020 2020 2020 2020 2020  bar),.          
-00043c30: 2020 2827 6e75 6d62 6572 6f66 6174 6f6d    ('numberofatom
-00043c40: 7327 2c20 6c65 6e28 7072 6f74 6569 6e5f  s', len(protein_
-00043c50: 7173 636f 7265 7329 292c 0a20 2020 2020  qscores)),.     
-00043c60: 2020 2020 2020 2028 2763 6f6c 6f72 272c         ('color',
-00043c70: 2063 6f6c 6f72 7329 2c0a 2020 2020 2020   colors),.      
-00043c80: 2020 2020 2020 2827 696e 636c 7573 696f        ('inclusio
-00043c90: 6e27 2c20 7173 636f 7265 7329 2c0a 2020  n', qscores),.  
-00043ca0: 2020 2020 2020 2020 2020 2827 7173 636f            ('qsco
-00043cb0: 7265 272c 2071 7363 6f72 6573 292c 0a20  re', qscores),. 
-00043cc0: 2020 2020 2020 2020 2020 2028 2772 6573             ('res
-00043cd0: 6964 7565 272c 2072 6573 6964 7565 7329  idue', residues)
-00043ce0: 2c0a 2020 2020 2020 2020 2020 2020 2827  ,.            ('
-00043cf0: 6368 6169 6e71 7363 6f72 6527 2c20 6368  chainqscore', ch
-00043d00: 6169 6e5f 7173 636f 7265 292c 0a20 2020  ain_qscore),.   
-00043d10: 2020 2020 2020 2020 2028 2771 4672 6163           ('qFrac
-00043d20: 7469 6f6e 4469 7374 7269 6275 7469 6f6e  tionDistribution
-00043d30: 272c 2071 6672 6163 7469 6f6e 7329 0a20  ', qfractions). 
-00043d40: 2020 2020 2020 205d 290a 0a0a 2020 2020         ])...    
-00043d50: 2020 2020 7265 7375 6c74 6469 6374 203d      resultdict =
-00043d60: 204f 7264 6572 6564 4469 6374 285b 2827   OrderedDict([('
-00043d70: 6e61 6d65 272c 206f 7267 6d6f 6465 6c29  name', orgmodel)
-00043d80: 2c20 2827 6461 7461 272c 2074 6469 6374  , ('data', tdict
-00043d90: 295d 290a 0a20 2020 2020 2020 2072 6574  )])..        ret
-00043da0: 7572 6e20 7265 7375 6c74 6469 6374 0a0a  urn resultdict..
-00043db0: 0a20 2020 2064 6566 2072 6561 6471 7363  .    def readqsc
-00043dc0: 6f72 6528 7365 6c66 293a 0a20 2020 2020  ore(self):.     
-00043dd0: 2020 2022 2222 0a0a 2020 2020 2020 2020     """..        
-00043de0: 2020 2020 4c6f 6164 2074 6865 2051 2d73      Load the Q-s
-00043df0: 636f 7265 2070 6462 2066 696c 6528 7465  core pdb file(te
-00043e00: 6d70 6172 6172 7929 0a0a 2020 2020 2020  mparary)..      
-00043e10: 2020 3a72 6574 7572 6e3a 0a20 2020 2020    :return:.     
-00043e20: 2020 2022 2222 0a0a 2020 2020 2020 2020     """..        
-00043e30: 6d61 706e 616d 6520 3d20 7365 6c66 2e6d  mapname = self.m
-00043e40: 6170 6e61 6d65 5b3a 2d34 5d0a 2020 2020  apname[:-4].    
-00043e50: 2020 2020 7166 696c 6573 203d 205b 5d0a      qfiles = [].
-00043e60: 2020 2020 2020 2020 7173 636f 7265 6572          qscoreer
-00043e70: 726c 6973 7420 3d20 5b5d 0a20 2020 2020  rlist = [].     
-00043e80: 2020 2072 6573 756c 7420 3d20 7b7d 0a20     result = {}. 
-00043e90: 2020 2020 2020 206d 6f64 656c 6e75 6d20         modelnum 
-00043ea0: 3d20 300a 2020 2020 2020 2020 7173 636f  = 0.        qsco
-00043eb0: 7265 6469 6374 203d 204f 7264 6572 6564  redict = Ordered
-00043ec0: 4469 6374 2829 0a20 2020 2020 2020 2066  Dict().        f
-00043ed0: 696e 616c 6469 6374 203d 204f 7264 6572  inaldict = Order
-00043ee0: 6564 4469 6374 2829 0a20 2020 2020 2020  edDict().       
-00043ef0: 2066 6f72 206d 6f64 656c 2069 6e20 7365   for model in se
-00043f00: 6c66 2e6d 6f64 656c 733a 0a20 2020 2020  lf.models:.     
-00043f10: 2020 2020 2020 206f 7267 6d6f 6465 6c20         orgmodel 
-00043f20: 3d20 6f73 2e70 6174 682e 6261 7365 6e61  = os.path.basena
-00043f30: 6d65 286d 6f64 656c 2e66 696c 656e 616d  me(model.filenam
-00043f40: 6529 0a20 2020 2020 2020 2020 2020 2063  e).            c
-00043f50: 7572 6d6f 6465 6c20 3d20 6f72 676d 6f64  urmodel = orgmod
-00043f60: 656c 5b3a 2d34 5d0a 2020 2020 2020 2020  el[:-4].        
-00043f70: 2020 2020 7166 696c 6520 3d20 277b 7d7b      qfile = '{}{
-00043f80: 7d5f 5f51 5f5f 7b7d 2e70 6462 272e 666f  }__Q__{}.pdb'.fo
-00043f90: 726d 6174 2873 656c 662e 776f 726b 6469  rmat(self.workdi
-00043fa0: 722c 2063 7572 6d6f 6465 6c2c 206d 6170  r, curmodel, map
-00043fb0: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
-00043fc0: 2020 6966 206f 732e 7061 7468 2e69 7366    if os.path.isf
-00043fd0: 696c 6528 7166 696c 6529 3a0a 2020 2020  ile(qfile):.    
-00043fe0: 2020 2020 2020 2020 2020 2020 7020 3d20              p = 
-00043ff0: 6f72 6750 4442 5061 7273 6572 2829 0a20  orgPDBParser(). 
-00044000: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00044010: 7173 636f 7265 7064 6220 3d20 702e 6765  qscorepdb = p.ge
-00044020: 745f 7374 7275 6374 7572 6528 276d 7971  t_structure('myq
-00044030: 6669 6c65 272c 2071 6669 6c65 290a 2020  file', qfile).  
-00044040: 2020 2020 2020 2020 2020 2020 2020 7173                qs
-00044050: 636f 7265 7064 6220 3d20 7071 7363 6f72  corepdb = pqscor
-00044060: 6570 6462 2069 6620 6c65 6e28 7071 7363  epdb if len(pqsc
-00044070: 6f72 6570 6462 2e67 6574 5f6c 6973 7428  orepdb.get_list(
-00044080: 2929 203d 3d20 3120 656c 7365 2070 7173  )) == 1 else pqs
-00044090: 636f 7265 7064 625b 305d 0a20 2020 2020  corepdb[0].     
-000440a0: 2020 2020 2020 2020 2020 2071 6669 6c65             qfile
-000440b0: 732e 6170 7065 6e64 2871 7363 6f72 6570  s.append(qscorep
-000440c0: 6462 290a 2020 2020 2020 2020 2020 2020  db).            
-000440d0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-000440e0: 2020 2020 2020 2020 2020 2020 2023 2071               # q
-000440f0: 7363 6f72 6564 6963 745b 7374 7228 6d6f  scoredict[str(mo
-00044100: 6465 6c6e 756d 295d 203d 2073 656c 662e  delnum)] = self.
-00044110: 7064 6274 6f71 6469 6374 2871 7363 6f72  pdbtoqdict(qscor
-00044120: 6570 6462 2c20 6f72 676d 6f64 656c 290a  epdb, orgmodel).
-00044130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00044140: 2020 2020 7173 636f 7265 6469 6374 5b73      qscoredict[s
-00044150: 7472 286d 6f64 656c 6e75 6d29 5d20 3d20  tr(modelnum)] = 
-00044160: 7365 6c66 2e6e 6577 7064 6274 6f71 6469  self.newpdbtoqdi
-00044170: 6374 2871 7363 6f72 6570 6462 2c20 6f72  ct(qscorepdb, or
-00044180: 676d 6f64 656c 290a 2020 2020 2020 2020  gmodel).        
-00044190: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
-000441a0: 6c6e 756d 202b 3d20 310a 2020 2020 2020  lnum += 1.      
-000441b0: 2020 2020 2020 2020 2020 6578 6365 7074            except
-000441c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000441d0: 2020 2020 2020 6572 7220 3d20 2751 7363        err = 'Qsc
-000441e0: 6f72 6520 6361 6c63 756c 6174 696f 6e20  ore calculation 
-000441f0: 6572 726f 7220 284d 6f64 656c 3a20 7b7d  error (Model: {}
-00044200: 293a 207b 7d2e 272e 666f 726d 6174 286d  ): {}.'.format(m
-00044210: 6f64 656c 2e66 696c 656e 616d 652c 2073  odel.filename, s
-00044220: 7973 2e65 7863 5f69 6e66 6f28 295b 315d  ys.exc_info()[1]
-00044230: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00044240: 2020 2020 2020 7173 636f 7265 6572 726c        qscoreerrl
-00044250: 6973 742e 6170 7065 6e64 2865 7272 290a  ist.append(err).
-00044260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00044270: 2020 2020 7379 732e 7374 6465 7272 2e77      sys.stderr.w
-00044280: 7269 7465 2865 7272 202b 2027 5c6e 2729  rite(err + '\n')
-00044290: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-000442a0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-000442b0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-000442c0: 726f 720a 0a20 2020 2020 2020 2069 6620  ror..        if 
-000442d0: 7173 636f 7265 6469 6374 3a0a 2020 2020  qscoredict:.    
-000442e0: 2020 2020 2020 2020 6669 6e61 6c64 6963          finaldic
-000442f0: 745b 2771 7363 6f72 6527 5d20 3d20 7173  t['qscore'] = qs
-00044300: 636f 7265 6469 6374 0a20 2020 2020 2020  coredict.       
-00044310: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00044320: 2020 2020 2020 2020 2020 7769 7468 2063            with c
-00044330: 6f64 6563 732e 6f70 656e 2873 656c 662e  odecs.open(self.
-00044340: 776f 726b 6469 7220 2b20 7365 6c66 2e6d  workdir + self.m
-00044350: 6170 6e61 6d65 202b 2027 5f71 7363 6f72  apname + '_qscor
-00044360: 652e 6a73 6f6e 272c 2027 7727 2c0a 2020  e.json', 'w',.  
-00044370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00044380: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00044390: 6e63 6f64 696e 673d 2775 7466 2d38 2729  ncoding='utf-8')
-000443a0: 2061 7320 663a 0a20 2020 2020 2020 2020   as f:.         
-000443b0: 2020 2020 2020 2020 2020 206a 736f 6e2e             json.
-000443c0: 6475 6d70 2866 696e 616c 6469 6374 2c20  dump(finaldict, 
-000443d0: 6629 0a20 2020 2020 2020 2020 2020 2065  f).            e
-000443e0: 7863 6570 743a 0a20 2020 2020 2020 2020  xcept:.         
-000443f0: 2020 2020 2020 2073 7973 2e73 7464 6572         sys.stder
-00044400: 722e 7772 6974 6528 2753 6176 696e 6720  r.write('Saving 
-00044410: 746f 2051 7363 6f72 6520 6a73 6f6e 2065  to Qscore json e
-00044420: 7272 6f72 3a20 7b7d 2e5c 6e27 2e66 6f72  rror: {}.\n'.for
-00044430: 6d61 7428 7379 732e 6578 635f 696e 666f  mat(sys.exc_info
-00044440: 2829 5b31 5d29 290a 2020 2020 2020 2020  ()[1])).        
-00044450: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00044460: 2020 7072 696e 7428 2751 7363 6f72 6520    print('Qscore 
-00044470: 7761 7320 6e6f 7420 636f 6c6c 6563 7465  was not collecte
-00044480: 642c 2070 6c65 6173 6520 6368 6563 6b21  d, please check!
-00044490: 2729 0a0a 0a20 2020 2020 2020 2072 6574  ')...        ret
-000444a0: 7572 6e20 4e6f 6e65 0a0a 2020 2020 6465  urn None..    de
-000444b0: 6620 6e65 7770 6462 746f 7164 6963 7428  f newpdbtoqdict(
-000444c0: 7365 6c66 2c20 7173 636f 7265 7064 622c  self, qscorepdb,
-000444d0: 206f 7267 6d6f 6465 6c29 3a0a 2020 2020   orgmodel):.    
-000444e0: 2020 2020 2222 220a 0a20 2020 2020 2020      """..       
-000444f0: 2020 2020 2047 6976 656e 2070 6462 2062       Given pdb b
-00044500: 696f 7079 7468 6f6e 206f 626a 6563 7420  iopython object 
-00044510: 616e 6420 636f 6e76 6572 7420 746f 2061  and convert to a
-00044520: 2064 6963 7420 7768 6963 6820 636f 6e74   dict which cont
-00044530: 6169 6e73 2061 6c6c 2064 6174 6120 666f  ains all data fo
-00044540: 7220 4a53 4f4e 0a0a 2020 2020 2020 2020  r JSON..        
-00044550: 3a72 6574 7572 6e3a 2044 4943 5420 636f  :return: DICT co
-00044560: 6e74 6169 6e73 2061 6c6c 2064 6174 610a  ntains all data.
-00044570: 2020 2020 2020 2020 2222 220a 0a20 2020          """..   
-00044580: 2020 2020 2072 6573 6964 7565 7320 3d20       residues = 
-00044590: 5b5d 0a20 2020 2020 2020 2063 6f6c 6f72  [].        color
-000445a0: 7320 3d20 5b5d 0a20 2020 2020 2020 2071  s = [].        q
-000445b0: 7363 6f72 6573 203d 205b 5d0a 2020 2020  scores = [].    
-000445c0: 2020 2020 6368 6169 6e5f 7173 636f 7265      chain_qscore
-000445d0: 203d 207b 7d0a 2020 2020 2020 2020 7173   = {}.        qs
-000445e0: 636f 7265 5f6c 6973 7420 3d20 5b61 746f  core_list = [ato
-000445f0: 6d2e 6266 6163 746f 7220 666f 7220 6174  m.bfactor for at
-00044600: 6f6d 2069 6e20 7173 636f 7265 7064 622e  om in qscorepdb.
-00044610: 6765 745f 6174 6f6d 7328 2920 6966 2061  get_atoms() if a
-00044620: 746f 6d2e 6266 6163 746f 7220 3e20 312e  tom.bfactor > 1.
-00044630: 305d 0a20 2020 2020 2020 2070 726f 7465  0].        prote
-00044640: 696e 5f71 7363 6f72 6573 203d 205b 5d0a  in_qscores = [].
-00044650: 2020 2020 2020 2020 666f 7220 6174 6f6d          for atom
-00044660: 2069 6e20 7173 636f 7265 7064 622e 6765   in qscorepdb.ge
-00044670: 745f 6174 6f6d 7328 293a 0a20 2020 2020  t_atoms():.     
-00044680: 2020 2020 2020 2069 6620 6174 6f6d 2e6e         if atom.n
-00044690: 616d 652e 7374 6172 7473 7769 7468 2827  ame.startswith('
-000446a0: 4827 2920 6f72 2061 746f 6d2e 6765 745f  H') or atom.get_
-000446b0: 7061 7265 6e74 2829 2e72 6573 6e61 6d65  parent().resname
-000446c0: 203d 3d20 2748 4f48 2720 6f72 2061 746f   == 'HOH' or ato
-000446d0: 6d2e 6266 6163 746f 7220 3e3d 2031 2e30  m.bfactor >= 1.0
-000446e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000446f0: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
-00044700: 2020 2020 2020 2070 726f 7465 696e 5f71         protein_q
-00044710: 7363 6f72 6573 2e61 7070 656e 6428 6174  scores.append(at
-00044720: 6f6d 2e62 6661 6374 6f72 290a 2020 2020  om.bfactor).    
-00044730: 2020 2020 6176 6572 6167 655f 7173 636f      average_qsco
-00044740: 7265 203d 2072 6f75 6e64 2873 756d 2870  re = round(sum(p
-00044750: 726f 7465 696e 5f71 7363 6f72 6573 2920  rotein_qscores) 
-00044760: 2f20 6c65 6e28 7072 6f74 6569 6e5f 7173  / len(protein_qs
-00044770: 636f 7265 7329 2c20 3329 0a20 2020 2020  cores), 3).     
-00044780: 2020 2069 6620 7173 636f 7265 5f6c 6973     if qscore_lis
-00044790: 743a 0a20 2020 2020 2020 2020 2020 206d  t:.            m
-000447a0: 696e 5f71 7363 6f72 6520 3d20 6d69 6e28  in_qscore = min(
-000447b0: 7173 636f 7265 5f6c 6973 7429 0a20 2020  qscore_list).   
-000447c0: 2020 2020 2020 2020 206d 6178 5f71 7363           max_qsc
-000447d0: 6f72 6520 3d20 6d61 7828 7173 636f 7265  ore = max(qscore
-000447e0: 5f6c 6973 7429 0a20 2020 2020 2020 2066  _list).        f
-000447f0: 6f72 2063 6861 696e 2069 6e20 7173 636f  or chain in qsco
-00044800: 7265 7064 622e 6765 745f 6368 6169 6e73  repdb.get_chains
-00044810: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00044820: 6375 7263 6861 696e 5f6e 616d 6520 3d20  curchain_name = 
-00044830: 6368 6169 6e2e 6964 0a20 2020 2020 2020  chain.id.       
-00044840: 2020 2020 2063 7572 6368 6169 6e5f 7173       curchain_qs
-00044850: 636f 7265 203d 205b 5d0a 2020 2020 2020  core = [].      
-00044860: 2020 2020 2020 666f 7220 6174 6f6d 2069        for atom i
-00044870: 6e20 6368 6169 6e2e 6765 745f 6174 6f6d  n chain.get_atom
-00044880: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-00044890: 2020 2020 2069 6620 6174 6f6d 2e6e 616d       if atom.nam
-000448a0: 652e 7374 6172 7473 7769 7468 2827 4827  e.startswith('H'
-000448b0: 2920 6f72 2061 746f 6d2e 6765 745f 7061  ) or atom.get_pa
-000448c0: 7265 6e74 2829 2e72 6573 6e61 6d65 203d  rent().resname =
-000448d0: 3d20 2748 4f48 2720 6f72 2061 746f 6d2e  = 'HOH' or atom.
-000448e0: 6266 6163 746f 7220 3e3d 2031 2e30 3a0a  bfactor >= 1.0:.
-000448f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00044900: 2020 2020 636f 6e74 696e 7565 0a20 2020      continue.   
-00044910: 2020 2020 2020 2020 2020 2020 2063 7572               cur
-00044920: 6368 6169 6e5f 7173 636f 7265 2e61 7070  chain_qscore.app
-00044930: 656e 6428 6174 6f6d 2e62 6661 6374 6f72  end(atom.bfactor
-00044940: 290a 2020 2020 2020 2020 2020 2020 6176  ).            av
-00044950: 6572 6167 6563 7572 6368 6169 6e5f 7173  eragecurchain_qs
-00044960: 636f 7265 203d 2072 6f75 6e64 2873 756d  core = round(sum
-00044970: 2863 7572 6368 6169 6e5f 7173 636f 7265  (curchain_qscore
-00044980: 2920 2f20 6c65 6e28 6375 7263 6861 696e  ) / len(curchain
-00044990: 5f71 7363 6f72 6529 2c20 3329 0a20 2020  _qscore), 3).   
-000449a0: 2020 2020 2020 2020 2061 746f 6d73 5f69           atoms_i
-000449b0: 6e63 6861 696e 203d 2030 0a20 2020 2020  nchain = 0.     
-000449c0: 2020 2020 2020 2071 7363 6f72 655f 696e         qscore_in
-000449d0: 6368 6169 6e20 3d20 302e 0a20 2020 2020  chain = 0..     
-000449e0: 2020 2020 2020 2066 6f72 2072 6573 6964         for resid
-000449f0: 7565 2069 6e20 6368 6169 6e3a 0a20 2020  ue in chain:.   
-00044a00: 2020 2020 2020 2020 2020 2020 2063 7572               cur
-00044a10: 7265 735f 6e61 6d65 203d 2072 6573 6964  res_name = resid
-00044a20: 7565 2e72 6573 6e61 6d65 0a20 2020 2020  ue.resname.     
-00044a30: 2020 2020 2020 2020 2020 2069 6620 6375             if cu
-00044a40: 7272 6573 5f6e 616d 6520 3d3d 2027 484f  rres_name == 'HO
-00044a50: 4827 3a0a 2020 2020 2020 2020 2020 2020  H':.            
-00044a60: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
-00044a70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00044a80: 2063 7572 7265 735f 6964 203d 2072 6573   curres_id = res
-00044a90: 6964 7565 2e69 645b 315d 0a20 2020 2020  idue.id[1].     
-00044aa0: 2020 2020 2020 2020 2020 2061 746f 6d73             atoms
-00044ab0: 5f69 6e72 6573 6964 7565 203d 2030 0a20  _inresidue = 0. 
-00044ac0: 2020 2020 2020 2020 2020 2020 2020 2071                 q
-00044ad0: 7363 6f72 655f 696e 7265 7369 6475 6520  score_inresidue 
-00044ae0: 3d20 302e 0a20 2020 2020 2020 2020 2020  = 0..           
-00044af0: 2020 2020 2066 6f72 2061 746f 6d20 696e       for atom in
-00044b00: 2072 6573 6964 7565 3a0a 2020 2020 2020   residue:.      
-00044b10: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00044b20: 2061 746f 6d2e 6e61 6d65 2e73 7461 7274   atom.name.start
-00044b30: 7377 6974 6828 2748 2729 206f 7220 6174  swith('H') or at
-00044b40: 6f6d 2e67 6574 5f70 6172 656e 7428 292e  om.get_parent().
-00044b50: 7265 736e 616d 6520 3d3d 2027 484f 4827  resname == 'HOH'
-00044b60: 206f 7220 6174 6f6d 2e62 6661 6374 6f72   or atom.bfactor
-00044b70: 203e 3d20 312e 303a 0a20 2020 2020 2020   >= 1.0:.       
-00044b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00044b90: 2063 6f6e 7469 6e75 650a 2020 2020 2020   continue.      
-00044ba0: 2020 2020 2020 2020 2020 2020 2020 6174                at
-00044bb0: 6f6d 735f 696e 6368 6169 6e20 2b3d 2031  oms_inchain += 1
-00044bc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00044bd0: 2020 2020 2061 746f 6d73 5f69 6e72 6573       atoms_inres
-00044be0: 6964 7565 202b 3d20 310a 2020 2020 2020  idue += 1.      
-00044bf0: 2020 2020 2020 2020 2020 2020 2020 6375                cu
-00044c00: 7261 746f 6d5f 7173 636f 7265 203d 2061  ratom_qscore = a
-00044c10: 746f 6d2e 6266 6163 746f 720a 2020 2020  tom.bfactor.    
-00044c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00044c30: 7173 636f 7265 5f69 6e63 6861 696e 202b  qscore_inchain +
-00044c40: 3d20 6375 7261 746f 6d5f 7173 636f 7265  = curatom_qscore
-00044c50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00044c60: 2020 2020 2071 7363 6f72 655f 696e 7265       qscore_inre
-00044c70: 7369 6475 6520 2b3d 2063 7572 6174 6f6d  sidue += curatom
-00044c80: 5f71 7363 6f72 650a 2020 2020 2020 2020  _qscore.        
-00044c90: 2020 2020 2020 2020 6375 7272 6573 5f71          curres_q
-00044ca0: 7363 6f72 6520 3d20 726f 756e 6428 7173  score = round(qs
-00044cb0: 636f 7265 5f69 6e72 6573 6964 7565 202f  core_inresidue /
-00044cc0: 2061 746f 6d73 5f69 6e72 6573 6964 7565   atoms_inresidue
-00044cd0: 2c20 3329 0a20 2020 2020 2020 2020 2020  , 3).           
-00044ce0: 2020 2020 2069 6620 6375 7272 6573 5f71       if curres_q
-00044cf0: 7363 6f72 6520 3e20 312e 303a 0a20 2020  score > 1.0:.   
-00044d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00044d10: 2069 6620 6d69 6e5f 7173 636f 7265 203d   if min_qscore =
-00044d20: 3d20 6d61 785f 7173 636f 7265 3a0a 2020  = max_qscore:.  
-00044d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00044d40: 2020 2020 2020 6375 7272 6573 5f63 6f6c        curres_col
-00044d50: 6f72 203d 2027 2330 3030 3030 3027 0a20  or = '#000000'. 
-00044d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00044d70: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00044d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00044d90: 2073 6361 6c65 645f 7173 636f 7265 203d   scaled_qscore =
-00044da0: 2028 6375 7272 6573 5f71 7363 6f72 6520   (curres_qscore 
-00044db0: 2d20 6d69 6e5f 7173 636f 7265 2920 2f20  - min_qscore) / 
-00044dc0: 286d 6178 5f71 7363 6f72 6520 2d20 6d69  (max_qscore - mi
-00044dd0: 6e5f 7173 636f 7265 290a 2020 2020 2020  n_qscore).      
-00044de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00044df0: 2020 6375 7272 6573 5f63 6f6c 6f72 203d    curres_color =
-00044e00: 2073 656c 662e 5f5f 666c 6f61 746f 6865   self.__floatohe
-00044e10: 785f 6162 6f76 656f 6e65 285b 7363 616c  x_aboveone([scal
-00044e20: 6564 5f71 7363 6f72 655d 295b 305d 0a20  ed_qscore])[0]. 
-00044e30: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00044e40: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00044e50: 2020 2020 2020 2020 2063 7572 7265 735f           curres_
-00044e60: 636f 6c6f 7220 3d20 7365 6c66 2e5f 5f66  color = self.__f
-00044e70: 6c6f 6174 6f68 6578 285b 6375 7272 6573  loatohex([curres
-00044e80: 5f71 7363 6f72 655d 295b 305d 0a0a 2020  _qscore])[0]..  
-00044e90: 2020 2020 2020 2020 2020 2020 2020 6963                ic
-00044ea0: 6f64 6520 3d20 7265 7369 6475 652e 6964  ode = residue.id
-00044eb0: 5b32 5d0a 2020 2020 2020 2020 2020 2020  [2].            
-00044ec0: 2020 2020 6966 2069 636f 6465 3a0a 2020      if icode:.  
-00044ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00044ee0: 2020 6375 7272 6573 5f73 7472 696e 6720    curres_string 
-00044ef0: 3d20 277b 7d3a 7b7d 7b7d 7b7d 272e 666f  = '{}:{}{}{}'.fo
-00044f00: 726d 6174 2863 7572 6368 6169 6e5f 6e61  rmat(curchain_na
-00044f10: 6d65 2c20 6375 7272 6573 5f69 642c 2069  me, curres_id, i
-00044f20: 636f 6465 2c20 6375 7272 6573 5f6e 616d  code, curres_nam
-00044f30: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-00044f40: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00044f50: 2020 2020 2020 2020 2020 2020 2063 7572               cur
-00044f60: 7265 735f 7374 7269 6e67 203d 2027 7b7d  res_string = '{}
-00044f70: 3a7b 7d7b 7d27 2e66 6f72 6d61 7428 6375  :{}{}'.format(cu
-00044f80: 7263 6861 696e 5f6e 616d 652c 2063 7572  rchain_name, cur
-00044f90: 7265 735f 6964 2c20 6375 7272 6573 5f6e  res_id, curres_n
-00044fa0: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
-00044fb0: 2020 2020 2072 6573 6964 7565 732e 6170       residues.ap
-00044fc0: 7065 6e64 2863 7572 7265 735f 7374 7269  pend(curres_stri
-00044fd0: 6e67 290a 2020 2020 2020 2020 2020 2020  ng).            
-00044fe0: 2020 2020 636f 6c6f 7273 2e61 7070 656e      colors.appen
-00044ff0: 6428 6375 7272 6573 5f63 6f6c 6f72 290a  d(curres_color).
-00045000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00045010: 7173 636f 7265 732e 6170 7065 6e64 2863  qscores.append(c
-00045020: 7572 7265 735f 7173 636f 7265 290a 2020  urres_qscore).  
-00045030: 2020 2020 2020 2020 2020 6176 6572 6167            averag
-00045040: 6571 7363 6f72 655f 696e 636f 6c6f 7220  eqscore_incolor 
-00045050: 3d20 7365 6c66 2e5f 5f66 6c6f 6174 6f68  = self.__floatoh
-00045060: 6578 285b 6176 6572 6167 6563 7572 6368  ex([averagecurch
-00045070: 6169 6e5f 7173 636f 7265 5d29 5b30 5d0a  ain_qscore])[0].
-00045080: 2020 2020 2020 2020 2020 2020 6368 6169              chai
-00045090: 6e5f 7173 636f 7265 5b63 7572 6368 6169  n_qscore[curchai
-000450a0: 6e5f 6e61 6d65 5d20 3d20 7b27 7661 6c75  n_name] = {'valu
-000450b0: 6527 3a20 6176 6572 6167 6563 7572 6368  e': averagecurch
-000450c0: 6169 6e5f 7173 636f 7265 2c20 2763 6f6c  ain_qscore, 'col
-000450d0: 6f72 273a 2061 7665 7261 6765 7173 636f  or': averageqsco
-000450e0: 7265 5f69 6e63 6f6c 6f72 7d0a 0a20 2020  re_incolor}..   
-000450f0: 2020 2020 2074 6469 6374 203d 204f 7264       tdict = Ord
-00045100: 6572 6564 4469 6374 285b 0a20 2020 2020  eredDict([.     
-00045110: 2020 2020 2020 2028 2761 7665 7261 6765         ('average
-00045120: 7173 636f 7265 272c 2061 7665 7261 6765  qscore', average
-00045130: 5f71 7363 6f72 6529 2c20 2827 636f 6c6f  _qscore), ('colo
-00045140: 7227 2c20 636f 6c6f 7273 292c 0a20 2020  r', colors),.   
-00045150: 2020 2020 2020 2020 2028 2769 6e63 6c75           ('inclu
-00045160: 7369 6f6e 272c 2071 7363 6f72 6573 292c  sion', qscores),
-00045170: 0a20 2020 2020 2020 2020 2020 2028 2772  .            ('r
-00045180: 6573 6964 7565 272c 2072 6573 6964 7565  esidue', residue
-00045190: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
-000451a0: 2827 6368 6169 6e71 7363 6f72 6527 2c20  ('chainqscore', 
-000451b0: 6368 6169 6e5f 7173 636f 7265 290a 0a20  chain_qscore).. 
-000451c0: 2020 2020 2020 205d 290a 0a20 2020 2020         ])..     
-000451d0: 2020 2072 6573 756c 7464 6963 7420 3d20     resultdict = 
-000451e0: 4f72 6465 7265 6444 6963 7428 5b28 276e  OrderedDict([('n
-000451f0: 616d 6527 2c20 6f72 676d 6f64 656c 292c  ame', orgmodel),
-00045200: 2028 2764 6174 6127 2c20 7464 6963 7429   ('data', tdict)
-00045210: 5d29 0a0a 2020 2020 2020 2020 7265 7475  ])..        retu
-00045220: 726e 2072 6573 756c 7464 6963 740a 0a20  rn resultdict.. 
-00045230: 2020 2064 6566 2070 6462 746f 7164 6963     def pdbtoqdic
-00045240: 7428 7365 6c66 2c20 7173 636f 7265 7064  t(self, qscorepd
-00045250: 622c 206f 7267 6d6f 6465 6c29 3a0a 2020  b, orgmodel):.  
-00045260: 2020 2020 2020 2222 220a 0a20 2020 2020        """..     
-00045270: 2020 2020 2020 2047 6976 656e 2070 6462         Given pdb
-00045280: 2062 696f 7079 7468 6f6e 206f 626a 6563   biopython objec
-00045290: 7420 616e 6420 636f 6e76 6572 7420 746f  t and convert to
-000452a0: 2061 2064 6963 7420 7768 6963 6820 636f   a dict which co
-000452b0: 6e74 6169 6e73 2061 6c6c 2064 6174 6120  ntains all data 
-000452c0: 666f 7220 4a53 4f4e 0a0a 2020 2020 2020  for JSON..      
-000452d0: 2020 3a72 6574 7572 6e3a 2044 4943 5420    :return: DICT 
-000452e0: 636f 6e74 6169 6e73 2061 6c6c 2064 6174  contains all dat
-000452f0: 610a 2020 2020 2020 2020 2222 220a 0a20  a.        """.. 
-00045300: 2020 2020 2020 2061 6c6c 6b65 7973 203d         allkeys =
-00045310: 205b 5d0a 2020 2020 2020 2020 616c 6c76   [].        allv
-00045320: 616c 7565 7320 3d20 5b5d 0a20 2020 2020  alues = [].     
-00045330: 2020 2070 7265 7265 7369 6420 3d20 300a     preresid = 0.
-00045340: 2020 2020 2020 2020 7072 6563 6861 696e          prechain
-00045350: 203d 2027 270a 2020 2020 2020 2020 6169   = ''.        ai
-00045360: 7072 6563 6861 696e 203d 2027 270a 2020  prechain = ''.  
-00045370: 2020 2020 2020 7072 6572 6573 203d 2027        preres = '
-00045380: 270a 2020 2020 2020 2020 7265 7363 6f75  '.        rescou
-00045390: 6e74 203d 2031 0a20 2020 2020 2020 2061  nt = 1.        a
-000453a0: 746f 6d63 6f75 6e74 203d 2030 0a20 2020  tomcount = 0.   
-000453b0: 2020 2020 2063 6861 696e 6174 6f6d 636f       chainatomco
-000453c0: 756e 7420 3d20 300a 2020 2020 2020 2020  unt = 0.        
-000453d0: 7265 736f 6363 203d 2030 2e0a 2020 2020  resocc = 0..    
-000453e0: 2020 2020 616c 6c61 746f 6d73 203d 2030      allatoms = 0
-000453f0: 0a20 2020 2020 2020 2061 6c6c 6f63 6320  .        allocc 
-00045400: 3d20 302e 0a20 2020 2020 2020 2063 6861  = 0..        cha
-00045410: 696e 6f63 6320 3d20 302e 0a20 2020 2020  inocc = 0..     
-00045420: 2020 2063 6861 696e 636f 756e 7420 3d20     chaincount = 
-00045430: 310a 2020 2020 2020 2020 6368 6169 6e61  1.        chaina
-00045440: 746f 6d73 203d 2030 0a20 2020 2020 2020  toms = 0.       
-00045450: 2063 6861 696e 7173 636f 7265 203d 207b   chainqscore = {
-00045460: 7d0a 2020 2020 2020 2020 666f 7220 6174  }.        for at
-00045470: 6f6d 2069 6e20 7173 636f 7265 7064 623a  om in qscorepdb:
-00045480: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00045490: 6e6f 7420 6174 6f6d 2e61 746f 6d5f 6e61  not atom.atom_na
-000454a0: 6d65 2e73 7461 7274 7377 6974 6828 2748  me.startswith('H
-000454b0: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
-000454c0: 2020 2020 616c 6c61 746f 6d73 202b 3d20      allatoms += 
-000454d0: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
-000454e0: 2020 616c 6c6f 6363 202b 3d20 6174 6f6d    allocc += atom
-000454f0: 2e74 656d 705f 6661 630a 2020 2020 2020  .temp_fac.      
-00045500: 2020 2020 2020 2020 2020 6174 6f6d 636f            atomco
-00045510: 756e 7420 2b3d 2031 0a20 2020 2020 2020  unt += 1.       
-00045520: 2020 2020 2020 2020 2063 6861 696e 6174           chainat
-00045530: 6f6d 636f 756e 7420 2b3d 2031 0a20 2020  omcount += 1.   
-00045540: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00045550: 2861 746f 6d63 6f75 6e74 203d 3d20 3129  (atomcount == 1)
-00045560: 206f 7220 2861 746f 6d2e 7265 735f 6e6f   or (atom.res_no
-00045570: 203d 3d20 7072 6572 6573 6964 2061 6e64   == preresid and
-00045580: 2061 746f 6d2e 6368 6169 6e20 3d3d 2070   atom.chain == p
-00045590: 7265 6368 6169 6e29 3a0a 2020 2020 2020  rechain):.      
-000455a0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-000455b0: 6572 6573 6964 203d 2061 746f 6d2e 7265  eresid = atom.re
-000455c0: 735f 6e6f 0a20 2020 2020 2020 2020 2020  s_no.           
-000455d0: 2020 2020 2020 2020 2070 7265 6368 6169           prechai
-000455e0: 6e20 3d20 6174 6f6d 2e63 6861 696e 0a20  n = atom.chain. 
-000455f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00045600: 2020 2070 7265 7265 7320 3d20 6174 6f6d     preres = atom
-00045610: 2e72 6573 0a20 2020 2020 2020 2020 2020  .res.           
-00045620: 2020 2020 2020 2020 2072 6573 6f63 6320           resocc 
-00045630: 2b3d 2061 746f 6d2e 7465 6d70 5f66 6163  += atom.temp_fac
-00045640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00045650: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00045660: 2020 2020 2020 2020 2020 2061 746f 6d63             atomc
-00045670: 6f75 6e74 202d 3d20 310a 2020 2020 2020  ount -= 1.      
-00045680: 2020 2020 2020 2020 2020 2020 2020 6b65                ke
-00045690: 7973 7472 203d 2070 7265 6368 6169 6e20  ystr = prechain 
-000456a0: 2b20 273a 2720 2b20 7374 7228 7072 6572  + ':' + str(prer
-000456b0: 6573 6964 2920 2b20 7072 6572 6573 0a20  esid) + preres. 
-000456c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000456d0: 2020 2061 6c6c 6b65 7973 2e61 7070 656e     allkeys.appen
-000456e0: 6428 6b65 7973 7472 290a 2020 2020 2020  d(keystr).      
-000456f0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00045700: 736f 6363 7661 6c75 6520 3d20 7265 736f  soccvalue = reso
-00045710: 6363 202f 2061 746f 6d63 6f75 6e74 0a20  cc / atomcount. 
-00045720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00045730: 2020 2061 6c6c 7661 6c75 6573 2e61 7070     allvalues.app
-00045740: 656e 6428 7265 736f 6363 7661 6c75 6529  end(resoccvalue)
-00045750: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00045760: 2020 2020 2070 7265 7265 7369 6420 3d20       preresid = 
-00045770: 6174 6f6d 2e72 6573 5f6e 6f0a 2020 2020  atom.res_no.    
-00045780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00045790: 7072 6563 6861 696e 203d 2061 746f 6d2e  prechain = atom.
-000457a0: 6368 6169 6e0a 2020 2020 2020 2020 2020  chain.          
-000457b0: 2020 2020 2020 2020 2020 7072 6572 6573            preres
-000457c0: 203d 2061 746f 6d2e 7265 730a 2020 2020   = atom.res.    
-000457d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000457e0: 6174 6f6d 636f 756e 7420 3d20 310a 2020  atomcount = 1.  
-000457f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00045800: 2020 7265 7363 6f75 6e74 202b 3d20 310a    rescount += 1.
-00045810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00045820: 2020 2020 7265 736f 6363 203d 2061 746f      resocc = ato
-00045830: 6d2e 7465 6d70 5f66 6163 0a20 2020 2020  m.temp_fac.     
-00045840: 2020 2020 2020 2020 2020 2069 6620 2863             if (c
-00045850: 6861 696e 6174 6f6d 636f 756e 7420 3d3d  hainatomcount ==
-00045860: 2031 2920 6f72 2028 6174 6f6d 2e63 6861   1) or (atom.cha
-00045870: 696e 203d 3d20 6169 7072 6563 6861 696e  in == aiprechain
-00045880: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00045890: 2020 2020 2020 2063 6861 696e 6174 6f6d         chainatom
-000458a0: 7320 2b3d 2031 0a20 2020 2020 2020 2020  s += 1.         
-000458b0: 2020 2020 2020 2020 2020 2061 6970 7265             aipre
-000458c0: 6368 6169 6e20 3d20 6174 6f6d 2e63 6861  chain = atom.cha
-000458d0: 696e 0a20 2020 2020 2020 2020 2020 2020  in.             
-000458e0: 2020 2020 2020 2063 6861 696e 6f63 6320         chainocc 
-000458f0: 2b3d 2061 746f 6d2e 7465 6d70 5f66 6163  += atom.temp_fac
-00045900: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00045910: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00045920: 2020 2020 2020 2020 2020 2071 7661 6c75             qvalu
-00045930: 6520 3d20 726f 756e 6428 6368 6169 6e6f  e = round(chaino
-00045940: 6363 202f 2063 6861 696e 6174 6f6d 732c  cc / chainatoms,
-00045950: 2033 290a 2020 2020 2020 2020 2020 2020   3).            
-00045960: 2020 2020 2020 2020 7163 6f6c 6f72 203d          qcolor =
-00045970: 2073 656c 662e 5f5f 666c 6f61 746f 6865   self.__floatohe
-00045980: 7828 5b71 7661 6c75 655d 295b 305d 0a20  x([qvalue])[0]. 
-00045990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000459a0: 2020 2023 2063 6861 696e 7173 636f 7265     # chainqscore
-000459b0: 5b61 6970 7265 6368 6169 6e5d 203d 207b  [aiprechain] = {
-000459c0: 2776 616c 7565 273a 2071 7661 6c75 652c  'value': qvalue,
-000459d0: 2027 636f 6c6f 7227 3a20 7163 6f6c 6f72   'color': qcolor
-000459e0: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-000459f0: 2020 2020 2020 6966 2061 6970 7265 6368        if aiprech
-00045a00: 6169 6e20 696e 2063 6861 696e 7173 636f  ain in chainqsco
-00045a10: 7265 2e6b 6579 7328 293a 0a20 2020 2020  re.keys():.     
-00045a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00045a30: 2020 2023 2063 6861 696e 7173 636f 7265     # chainqscore
-00045a40: 5b70 7265 6368 6169 6e20 2b20 275f 2720  [prechain + '_' 
-00045a50: 2b20 7374 7228 6169 7661 6c75 6529 5d20  + str(aivalue)] 
-00045a60: 3d20 7b27 7661 6c75 6527 3a20 6169 7661  = {'value': aiva
-00045a70: 6c75 652c 2027 636f 6c6f 7227 3a20 6169  lue, 'color': ai
-00045a80: 636f 6c6f 727d 0a20 2020 2020 2020 2020  color}.         
-00045a90: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00045aa0: 6173 730a 2020 2020 2020 2020 2020 2020  ass.            
-00045ab0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00045ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00045ad0: 2020 2020 2020 6368 6169 6e71 7363 6f72        chainqscor
-00045ae0: 655b 6169 7072 6563 6861 696e 5d20 3d20  e[aiprechain] = 
-00045af0: 7b27 7661 6c75 6527 3a20 7176 616c 7565  {'value': qvalue
-00045b00: 2c20 2763 6f6c 6f72 273a 2071 636f 6c6f  , 'color': qcolo
-00045b10: 727d 0a20 2020 2020 2020 2020 2020 2020  r}.             
-00045b20: 2020 2020 2020 2063 6861 696e 6174 6f6d         chainatom
-00045b30: 7320 3d20 310a 2020 2020 2020 2020 2020  s = 1.          
-00045b40: 2020 2020 2020 2020 2020 6368 6169 6e6f            chaino
-00045b50: 6363 203d 2061 746f 6d2e 7465 6d70 5f66  cc = atom.temp_f
-00045b60: 6163 0a20 2020 2020 2020 2020 2020 2020  ac.             
-00045b70: 2020 2020 2020 2061 6970 7265 6368 6169         aiprechai
-00045b80: 6e20 3d20 6174 6f6d 2e63 6861 696e 0a20  n = atom.chain. 
-00045b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00045ba0: 2020 2063 6861 696e 636f 756e 7420 2b3d     chaincount +=
-00045bb0: 2031 0a0a 2020 2020 2020 2020 7176 616c   1..        qval
-00045bc0: 7565 203d 2072 6f75 6e64 2863 6861 696e  ue = round(chain
-00045bd0: 6f63 6320 2f20 6368 6169 6e61 746f 6d73  occ / chainatoms
-00045be0: 2c20 3329 0a20 2020 2020 2020 2071 636f  , 3).        qco
-00045bf0: 6c6f 7220 3d20 7365 6c66 2e5f 5f66 6c6f  lor = self.__flo
-00045c00: 6174 6f68 6578 285b 7176 616c 7565 5d29  atohex([qvalue])
-00045c10: 5b30 5d0a 2020 2020 2020 2020 6966 2061  [0].        if a
-00045c20: 6970 7265 6368 6169 6e20 696e 2063 6861  iprechain in cha
-00045c30: 696e 7173 636f 7265 2e6b 6579 7328 293a  inqscore.keys():
-00045c40: 0a20 2020 2020 2020 2020 2020 2023 2063  .            # c
-00045c50: 6861 696e 7173 636f 7265 5b70 7265 6368  hainqscore[prech
-00045c60: 6169 6e20 2b20 275f 2720 2b20 7374 7228  ain + '_' + str(
-00045c70: 6169 7661 6c75 6529 5d20 3d20 7b27 7661  aivalue)] = {'va
-00045c80: 6c75 6527 3a20 6169 7661 6c75 652c 2027  lue': aivalue, '
-00045c90: 636f 6c6f 7227 3a20 6169 636f 6c6f 727d  color': aicolor}
-00045ca0: 0a20 2020 2020 2020 2020 2020 2070 6173  .            pas
-00045cb0: 730a 2020 2020 2020 2020 656c 7365 3a0a  s.        else:.
-00045cc0: 2020 2020 2020 2020 2020 2020 6368 6169              chai
-00045cd0: 6e71 7363 6f72 655b 6169 7072 6563 6861  nqscore[aiprecha
-00045ce0: 696e 5d20 3d20 7b27 7661 6c75 6527 3a20  in] = {'value': 
-00045cf0: 7176 616c 7565 2c20 2763 6f6c 6f72 273a  qvalue, 'color':
-00045d00: 2071 636f 6c6f 727d 0a20 2020 2020 2020   qcolor}.       
-00045d10: 206c 6173 7476 616c 7565 203d 2072 6573   lastvalue = res
-00045d20: 6f63 6320 2f20 6174 6f6d 636f 756e 740a  occ / atomcount.
-00045d30: 2020 2020 2020 2020 6b65 7973 7472 203d          keystr =
-00045d40: 2070 7265 6368 6169 6e20 2b20 273a 2720   prechain + ':' 
-00045d50: 2b20 7374 7228 7072 6572 6573 6964 2920  + str(preresid) 
-00045d60: 2b20 7072 6572 6573 0a20 2020 2020 2020  + preres.       
-00045d70: 2061 6c6c 6b65 7973 2e61 7070 656e 6428   allkeys.append(
-00045d80: 6b65 7973 7472 290a 2020 2020 2020 2020  keystr).        
-00045d90: 616c 6c76 616c 7565 732e 6170 7065 6e64  allvalues.append
-00045da0: 286c 6173 7476 616c 7565 290a 2020 2020  (lastvalue).    
-00045db0: 2020 2020 636f 6c6f 7572 7320 3d20 7365      colours = se
-00045dc0: 6c66 2e5f 5f66 6c6f 6174 6f68 6578 285b  lf.__floatohex([
-00045dd0: 6920 666f 7220 6920 696e 2061 6c6c 7661  i for i in allva
-00045de0: 6c75 6573 5d29 0a20 2020 2020 2020 2061  lues]).        a
-00045df0: 7665 7261 6765 6f63 6320 3d20 616c 6c6f  verageocc = allo
-00045e00: 6363 202f 2061 6c6c 6174 6f6d 730a 0a20  cc / allatoms.. 
-00045e10: 2020 2020 2020 2074 6469 6374 203d 204f         tdict = O
-00045e20: 7264 6572 6564 4469 6374 285b 0a20 2020  rderedDict([.   
-00045e30: 2020 2020 2020 2020 2028 2761 7665 7261           ('avera
-00045e40: 6765 6f63 6327 2c20 726f 756e 6428 6176  geocc', round(av
-00045e50: 6572 6167 656f 6363 2c20 3629 292c 2028  erageocc, 6)), (
-00045e60: 2763 6f6c 6f72 272c 2063 6f6c 6f75 7273  'color', colours
-00045e70: 292c 0a20 2020 2020 2020 2020 2020 2028  ),.            (
-00045e80: 2769 6e63 6c75 7369 6f6e 272c 205b 726f  'inclusion', [ro
-00045e90: 756e 6428 656c 656d 2c20 3629 2066 6f72  und(elem, 6) for
-00045ea0: 2065 6c65 6d20 696e 2061 6c6c 7661 6c75   elem in allvalu
-00045eb0: 6573 5d29 2c0a 2020 2020 2020 2020 2020  es]),.          
-00045ec0: 2020 2827 7265 7369 6475 6527 2c20 616c    ('residue', al
-00045ed0: 6c6b 6579 7329 2c0a 2020 2020 2020 2020  lkeys),.        
-00045ee0: 2020 2020 2827 6368 6169 6e71 7363 6f72      ('chainqscor
-00045ef0: 6527 2c20 6368 6169 6e71 7363 6f72 6529  e', chainqscore)
-00045f00: 0a0a 2020 2020 2020 2020 5d29 0a0a 2020  ..        ])..  
-00045f10: 2020 2020 2020 7265 7375 6c74 6469 6374        resultdict
-00045f20: 203d 204f 7264 6572 6564 4469 6374 285b   = OrderedDict([
-00045f30: 2827 6e61 6d65 272c 206f 7267 6d6f 6465  ('name', orgmode
-00045f40: 6c29 2c20 2827 6461 7461 272c 2074 6469  l), ('data', tdi
-00045f50: 6374 295d 290a 0a20 2020 2020 2020 2072  ct)])..        r
-00045f60: 6574 7572 6e20 7265 7375 6c74 6469 6374  eturn resultdict
-00045f70: 0a0a 2020 2020 6465 6620 7173 636f 7265  ..    def qscore
-00045f80: 7669 6577 2873 656c 662c 2063 6869 6d65  view(self, chime
-00045f90: 7261 6170 7029 3a0a 2020 2020 2020 2020  raapp):.        
-00045fa0: 2222 220a 0a20 2020 2020 2020 2020 2020  """..           
-00045fb0: 2058 2c20 592c 205a 2069 6d61 6765 7320   X, Y, Z images 
-00045fc0: 7768 6963 6820 6d6f 6465 6c20 7761 7320  which model was 
-00045fd0: 636f 6c6f 7265 6420 6279 2051 2d73 636f  colored by Q-sco
-00045fe0: 7265 0a0a 2020 2020 2020 2020 3a72 6574  re..        :ret
-00045ff0: 7572 6e3a 0a20 2020 2020 2020 2022 2222  urn:.        """
-00046000: 0a0a 2020 2020 2020 2020 2320 7265 6164  ..        # read
-00046010: 206a 736f 6e0a 2020 2020 2020 2020 7374   json.        st
-00046020: 6172 7420 3d20 7469 6d65 6974 2e64 6566  art = timeit.def
-00046030: 6175 6c74 5f74 696d 6572 2829 0a20 2020  ault_timer().   
-00046040: 2020 2020 2069 6e6a 736f 6e20 3d20 676c       injson = gl
-00046050: 6f62 2e67 6c6f 6228 7365 6c66 2e77 6f72  ob.glob(self.wor
-00046060: 6b64 6972 202b 2027 2a5f 7173 636f 7265  kdir + '*_qscore
-00046070: 2e6a 736f 6e27 290a 2020 2020 2020 2020  .json').        
-00046080: 6261 7365 6469 7220 3d20 7365 6c66 2e77  basedir = self.w
-00046090: 6f72 6b64 6972 0a20 2020 2020 2020 206d  orkdir.        m
-000460a0: 6170 6e61 6d65 203d 2073 656c 662e 6d61  apname = self.ma
-000460b0: 706e 616d 650a 2020 2020 2020 2020 6c6f  pname.        lo
-000460c0: 6343 4849 4d45 5241 203d 2063 6869 6d65  cCHIMERA = chime
-000460d0: 7261 6170 700a 2020 2020 2020 2020 6269  raapp.        bi
-000460e0: 6e64 6973 706c 6179 203d 206f 732e 6765  ndisplay = os.ge
-000460f0: 7465 6e76 2827 4449 5350 4c41 5927 290a  tenv('DISPLAY').
-00046100: 2020 2020 2020 2020 6572 726c 6973 7420          errlist 
-00046110: 3d20 5b5d 0a0a 2020 2020 2020 2020 6675  = []..        fu
-00046120: 6c69 6e6a 736f 6e20 3d20 696e 6a73 6f6e  linjson = injson
-00046130: 5b30 5d20 6966 2069 6e6a 736f 6e20 656c  [0] if injson el
-00046140: 7365 204e 6f6e 650a 2020 2020 2020 2020  se None.        
-00046150: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00046160: 2069 6620 6675 6c69 6e6a 736f 6e3a 0a20   if fulinjson:. 
-00046170: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-00046180: 6974 6820 6f70 656e 2866 756c 696e 6a73  ith open(fulinjs
-00046190: 6f6e 2c20 2772 2729 2061 7320 663a 0a20  on, 'r') as f:. 
-000461a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000461b0: 2020 2061 7267 7320 3d20 6a73 6f6e 2e6c     args = json.l
-000461c0: 6f61 6428 6629 0a20 2020 2020 2020 2020  oad(f).         
-000461d0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000461e0: 2020 2020 2020 2020 2061 7267 7320 3d20           args = 
-000461f0: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-00046200: 2020 2020 2070 7269 6e74 2827 5468 6572       print('Ther
-00046210: 6520 6973 206e 6f20 5173 636f 7265 206a  e is no Qscore j
-00046220: 736f 6e20 6669 6c65 2e27 290a 2020 2020  son file.').    
-00046230: 2020 2020 6578 6365 7074 2054 7970 6545      except TypeE
-00046240: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
-00046250: 2020 6572 7220 3d20 274f 7065 6e20 5173    err = 'Open Qs
-00046260: 636f 7265 204a 534f 4e20 6572 726f 723a  core JSON error:
-00046270: 207b 7d2e 272e 666f 726d 6174 2873 7973   {}.'.format(sys
-00046280: 2e65 7863 5f69 6e66 6f28 295b 315d 290a  .exc_info()[1]).
-00046290: 2020 2020 2020 2020 2020 2020 6572 726c              errl
-000462a0: 6973 742e 6170 7065 6e64 2865 7272 290a  ist.append(err).
-000462b0: 2020 2020 2020 2020 2020 2020 7379 732e              sys.
-000462c0: 7374 6465 7272 2e77 7269 7465 2865 7272  stderr.write(err
-000462d0: 202b 2027 5c6e 2729 0a20 2020 2020 2020   + '\n').       
-000462e0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000462f0: 2020 2069 6620 6172 6773 2069 7320 6e6f     if args is no
-00046300: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-00046310: 2020 2020 2020 2020 6d6f 6465 6c73 203d          models =
-00046320: 2061 7267 735b 2771 7363 6f72 6527 5d0a   args['qscore'].
-00046330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046340: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00046350: 2020 2020 2020 2020 2064 656c 206d 6f64           del mod
-00046360: 656c 735b 2765 7272 275d 0a20 2020 2020  els['err'].     
-00046370: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-00046380: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
-00046390: 2020 2020 2020 2070 7269 6e74 2827 5173         print('Qs
-000463a0: 636f 7265 206a 736f 6e20 7265 7375 6c74  core json result
-000463b0: 2069 7320 636f 7272 6563 7427 290a 0a20   is correct').. 
-000463c0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-000463d0: 7269 6e74 2827 5468 6572 6520 6973 2f61  rint('There is/a
-000463e0: 7265 2025 7320 6d6f 6465 6c28 7329 2e27  re %s model(s).'
-000463f0: 2025 206c 656e 286d 6f64 656c 7329 290a   % len(models)).
-00046400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046410: 666f 7220 286b 6579 2c20 7661 6c75 6529  for (key, value)
-00046420: 2069 6e20 6974 6572 6974 656d 7328 6d6f   in iteritems(mo
-00046430: 6465 6c73 293a 0a20 2020 2020 2020 2020  dels):.         
-00046440: 2020 2020 2020 2020 2020 2023 2066 6f72             # for
-00046450: 2028 6b65 7932 2c20 7661 6c75 6532 2920   (key2, value2) 
-00046460: 696e 2069 7465 7269 7465 6d73 2876 616c  in iteritems(val
-00046470: 7565 293a 0a20 2020 2020 2020 2020 2020  ue):.           
-00046480: 2020 2020 2020 2020 2069 6620 7479 7065           if type
-00046490: 2876 616c 7565 2920 6973 2066 6c6f 6174  (value) is float
-000464a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000464b0: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
-000464c0: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
-000464d0: 2020 2020 2020 206b 6579 6c69 7374 203d         keylist =
-000464e0: 206c 6973 7428 7661 6c75 6529 0a20 2020   list(value).   
-000464f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046500: 2066 6f72 206b 6579 2069 6e20 6b65 796c   for key in keyl
-00046510: 6973 743a 0a20 2020 2020 2020 2020 2020  ist:.           
-00046520: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00046530: 6b65 7920 213d 2027 6e61 6d65 273a 0a20  key != 'name':. 
-00046540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046550: 2020 2020 2020 2020 2020 2063 6f6c 6f72             color
-00046560: 7320 3d20 7661 6c75 655b 6b65 795d 5b27  s = value[key]['
-00046570: 636f 6c6f 7227 5d0a 2020 2020 2020 2020  color'].        
-00046580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046590: 2020 2020 7265 7369 6475 6573 203d 2076      residues = v
-000465a0: 616c 7565 5b6b 6579 5d5b 2772 6573 6964  alue[key]['resid
-000465b0: 7565 275d 0a20 2020 2020 2020 2020 2020  ue'].           
-000465c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000465d0: 2071 7363 6f72 6573 203d 2076 616c 7565   qscores = value
-000465e0: 5b6b 6579 5d5b 2769 6e63 6c75 7369 6f6e  [key]['inclusion
-000465f0: 275d 0a20 2020 2020 2020 2020 2020 2020  '].             
-00046600: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00046610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00046620: 2020 2020 2020 2020 2020 2020 206d 6f64               mod
-00046630: 656c 6e61 6d65 203d 2076 616c 7565 5b6b  elname = value[k
-00046640: 6579 5d0a 2020 2020 2020 2020 2020 2020  ey].            
-00046650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046660: 6d6f 6465 6c20 3d20 7365 6c66 2e77 6f72  model = self.wor
-00046670: 6b64 6972 202b 206d 6f64 656c 6e61 6d65  kdir + modelname
-00046680: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00046690: 2020 2020 2020 2020 2020 2020 2063 6869               chi
-000466a0: 6d65 7261 666e 616d 6520 3d20 277b 7d5f  merafname = '{}_
-000466b0: 7b7d 5f71 7363 6f72 655f 6368 696d 6572  {}_qscore_chimer
-000466c0: 612e 6378 6327 2e66 6f72 6d61 7428 6d6f  a.cxc'.format(mo
-000466d0: 6465 6c6e 616d 652c 206d 6170 6e61 6d65  delname, mapname
-000466e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000466f0: 2020 2020 2020 2020 2020 2020 2020 7375                su
-00046700: 7266 6163 6566 6e20 3d20 277b 7d7b 7d5f  rfacefn = '{}{}_
-00046710: 7b7d 272e 666f 726d 6174 2862 6173 6564  {}'.format(based
-00046720: 6972 2c20 6d6f 6465 6c6e 616d 652c 206d  ir, modelname, m
-00046730: 6170 6e61 6d65 290a 2020 2020 2020 2020  apname).        
-00046740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046750: 2020 2020 6368 696d 6572 6163 6d64 203d      chimeracmd =
-00046760: 2063 6869 6d65 7261 666e 616d 650a 2020   chimerafname.  
-00046770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046780: 2020 2020 2020 2020 2020 2320 7064 626d            # pdbm
-00046790: 6f64 656c 6e61 6d65 203d 2027 7b7d 7b7d  odelname = '{}{}
-000467a0: 5f5f 515f 5f7b 7d2e 7064 6227 2e66 6f72  __Q__{}.pdb'.for
-000467b0: 6d61 7428 6261 7365 6469 722c 206d 6f64  mat(basedir, mod
-000467c0: 656c 6e61 6d65 5b3a 2d34 5d2c 206d 6170  elname[:-4], map
-000467d0: 6e61 6d65 5b3a 2d34 5d29 0a20 2020 2020  name[:-4]).     
-000467e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000467f0: 2020 2020 2020 2070 6462 6d6f 6465 6c6e         pdbmodeln
-00046800: 616d 6520 3d20 277b 7d7b 7d5f 5f51 5f5f  ame = '{}{}__Q__
-00046810: 7b7d 2e63 6966 272e 666f 726d 6174 2862  {}.cif'.format(b
-00046820: 6173 6564 6972 2c20 6d6f 6465 6c6e 616d  asedir, modelnam
-00046830: 652c 206d 6170 6e61 6d65 290a 0a20 2020  e, mapname)..   
-00046840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046850: 2077 6974 6820 6f70 656e 2873 656c 662e   with open(self.
-00046860: 776f 726b 6469 7220 2b20 6368 696d 6572  workdir + chimer
-00046870: 6163 6d64 2c20 2777 2729 2061 7320 6670  acmd, 'w') as fp
-00046880: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00046890: 2020 2020 2020 2020 2020 6670 2e77 7269            fp.wri
-000468a0: 7465 2822 6f70 656e 2022 202b 2073 7472  te("open " + str
-000468b0: 2870 6462 6d6f 6465 6c6e 616d 6529 202b  (pdbmodelname) +
-000468c0: 2022 2066 6f72 6d61 7420 6d6d 6369 6622   " format mmcif"
-000468d0: 202b 2027 5c6e 2729 0a20 2020 2020 2020   + '\n').       
+00042430: 2070 7269 6e74 2869 7465 6d29 0a20 2020   print(item).   
+00042440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042450: 2020 2020 2020 2020 2069 6620 6572 7271           if errq
+00042460: 7363 6f72 6520 696e 2069 7465 6d2e 6c6f  score in item.lo
+00042470: 7765 7228 293a 0a20 2020 2020 2020 2020  wer():.         
+00042480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042490: 2020 2020 2020 2065 7272 6c69 6e65 203d         errline =
+000424a0: 2069 7465 6d2e 7374 7269 7028 290a 2020   item.strip().  
+000424b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000424c0: 2020 2020 2020 2020 2020 2020 2020 6572                er
+000424d0: 726c 6973 742e 6170 7065 6e64 2865 7272  rlist.append(err
+000424e0: 6c69 6e65 290a 2020 2020 2020 2020 2020  line).          
+000424f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042500: 2020 2020 2020 6173 7365 7274 2065 7272        assert err
+00042510: 7173 636f 7265 206e 6f74 2069 6e20 6f75  qscore not in ou
+00042520: 7470 7574 2e64 6563 6f64 6528 2775 7466  tput.decode('utf
+00042530: 2d38 2729 2c20 6572 726c 696e 650a 2020  -8'), errline.  
+00042540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042550: 2020 7365 6c66 2e70 6f73 7471 7363 6f72    self.postqscor
+00042560: 6528 290a 0a20 2020 2020 2020 2020 2020  e()..           
+00042570: 2020 2020 2065 7863 6570 743a 0a20 2020       except:.   
+00042580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042590: 2065 7272 203d 2027 512d 7363 6f72 6520   err = 'Q-score 
+000425a0: 6361 6c63 756c 6174 696f 6e20 6572 726f  calculation erro
+000425b0: 723a 207b 7d27 2e66 6f72 6d61 7428 7379  r: {}'.format(sy
+000425c0: 732e 6578 635f 696e 666f 2829 5b31 5d29  s.exc_info()[1])
+000425d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000425e0: 2020 2020 2070 7269 6e74 2874 7261 6365       print(trace
+000425f0: 6261 636b 2e66 6f72 6d61 745f 6578 6328  back.format_exc(
+00042600: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+00042610: 2020 2020 2020 2065 7272 6c69 7374 2e61         errlist.a
+00042620: 7070 656e 6428 6572 7229 0a20 2020 2020  ppend(err).     
+00042630: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00042640: 7973 2e73 7464 6572 722e 7772 6974 6528  ys.stderr.write(
+00042650: 6572 7220 2b20 275c 6e27 290a 0a20 2020  err + '\n')..   
+00042660: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00042670: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00042680: 7269 6e74 2827 4368 696d 6572 6120 6973  rint('Chimera is
+00042690: 206e 6f74 2064 6574 6563 7465 6420 6f72   not detected or
+000426a0: 206e 6f20 6669 7474 6564 206d 6f64 656c   no fitted model
+000426b0: 2066 6f72 2074 6869 7320 656e 7472 792e   for this entry.
+000426c0: 2051 7363 6f72 6520 7769 6c6c 206e 6f74   Qscore will not
+000426d0: 2062 6520 6361 6c63 756c 6174 6564 2e27   be calculated.'
+000426e0: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+000426f0: 6e20 4e6f 6e65 0a0a 0a20 2020 2064 6566  n None...    def
+00042700: 2070 6f73 7471 7363 6f72 6528 7365 6c66   postqscore(self
+00042710: 293a 0a0a 2020 2020 2020 2020 2320 7365  ):..        # se
+00042720: 6c66 2e72 656e 616d 6571 6669 6c65 7328  lf.renameqfiles(
+00042730: 290a 2020 2020 2020 2020 7472 793a 0a20  ).        try:. 
+00042740: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00042750: 6e65 7772 6561 645f 7173 636f 7265 2829  newread_qscore()
+00042760: 0a20 2020 2020 2020 2020 2020 2076 746b  .            vtk
+00042770: 7061 636b 2c20 6368 696d 6572 6161 7070  pack, chimeraapp
+00042780: 203d 2073 656c 662e 7375 7266 6163 655f   = self.surface_
+00042790: 656e 7663 6865 636b 2829 0a20 2020 2020  envcheck().     
+000427a0: 2020 2020 2020 2073 656c 662e 7173 636f         self.qsco
+000427b0: 7265 7669 6577 2863 6869 6d65 7261 6170  review(chimeraap
+000427c0: 7029 0a20 2020 2020 2020 2065 7863 6570  p).        excep
+000427d0: 743a 0a20 2020 2020 2020 2020 2020 2065  t:.            e
+000427e0: 7272 203d 2027 512d 7363 6f72 6520 7265  rr = 'Q-score re
+000427f0: 7375 6c74 7320 7072 6f63 6573 7369 6e67  sults processing
+00042800: 2066 6169 6c65 643a 207b 7d27 2e66 6f72   failed: {}'.for
+00042810: 6d61 7428 7379 732e 6578 635f 696e 666f  mat(sys.exc_info
+00042820: 2829 5b31 5d29 0a20 2020 2020 2020 2020  ()[1]).         
+00042830: 2020 2070 7269 6e74 2874 7261 6365 6261     print(traceba
+00042840: 636b 2e66 6f72 6d61 745f 6578 6328 2929  ck.format_exc())
+00042850: 0a20 2020 2020 2020 2020 2020 2073 7973  .            sys
+00042860: 2e73 7464 6572 722e 7772 6974 6528 6572  .stderr.write(er
+00042870: 7220 2b20 275c 6e27 290a 0a20 2020 2020  r + '\n')..     
+00042880: 2020 2072 6574 7572 6e20 4e6f 6e65 0a0a     return None..
+00042890: 2020 2020 6465 6620 7265 6e61 6d65 7166      def renameqf
+000428a0: 696c 6573 2873 656c 6629 3a0a 2020 2020  iles(self):.    
+000428b0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+000428c0: 2020 2020 5265 6e61 6d65 2051 2d73 636f      Rename Q-sco
+000428d0: 7265 206f 7574 7075 7420 6669 6c65 7320  re output files 
+000428e0: 6966 2069 6e2d 6361 7365 2c20 7468 6579  if in-case, they
+000428f0: 2075 7365 202a 5f41 6c74 5f41 2f42 2e63   use *_Alt_A/B.c
+00042900: 6966 2074 6f20 7072 6f64 7563 6520 7468  if to produce th
+00042910: 6520 7265 7375 6c74 0a0a 2020 2020 2020  e result..      
+00042920: 2020 3a72 6574 7572 6e3a 0a20 2020 2020    :return:.     
+00042930: 2020 2022 2222 0a20 2020 2020 2020 2061     """.        a
+00042940: 6c74 6669 6c65 7320 3d20 676c 6f62 2e67  ltfiles = glob.g
+00042950: 6c6f 6228 277b 7d2f 2a2e 2a5f 416c 745f  lob('{}/*.*_Alt_
+00042960: 2a5f 5f51 5f5f 656d 645f 2a2e 7064 6227  *__Q__emd_*.pdb'
+00042970: 2e66 6f72 6d61 7428 7365 6c66 2e77 6f72  .format(self.wor
+00042980: 6b64 6972 2929 0a20 2020 2020 2020 2069  kdir)).        i
+00042990: 6620 616c 7466 696c 6573 3a0a 2020 2020  f altfiles:.    
+000429a0: 2020 2020 2020 2020 666f 7220 616c 7466          for altf
+000429b0: 696c 6520 696e 2061 6c74 6669 6c65 733a  ile in altfiles:
+000429c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000429d0: 2061 6c74 6469 7220 3d20 6f73 2e70 6174   altdir = os.pat
+000429e0: 682e 6469 726e 616d 6528 616c 7466 696c  h.dirname(altfil
+000429f0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+00042a00: 2020 2061 6c74 7064 6220 3d20 6f73 2e70     altpdb = os.p
+00042a10: 6174 682e 6261 7365 6e61 6d65 2861 6c74  ath.basename(alt
+00042a20: 6669 6c65 290a 2020 2020 2020 2020 2020  file).          
+00042a30: 2020 2020 2020 6e65 7770 6462 203d 2072        newpdb = r
+00042a40: 652e 7375 6228 272e 6369 665f 416c 745f  e.sub('.cif_Alt_
+00042a50: 2e27 2c20 2727 2c20 616c 7470 6462 290a  .', '', altpdb).
+00042a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042a70: 616c 7474 7874 203d 2027 7b7d 5f41 6c6c  alttxt = '{}_All
+00042a80: 2e74 7874 272e 666f 726d 6174 2861 6c74  .txt'.format(alt
+00042a90: 7064 625b 3a2d 345d 290a 2020 2020 2020  pdb[:-4]).      
+00042aa0: 2020 2020 2020 2020 2020 6e65 7774 7874            newtxt
+00042ab0: 203d 2027 7b7d 5f41 6c6c 2e74 7874 272e   = '{}_All.txt'.
+00042ac0: 666f 726d 6174 286e 6577 7064 625b 3a2d  format(newpdb[:-
+00042ad0: 345d 290a 2020 2020 2020 2020 2020 2020  4]).            
+00042ae0: 2020 2020 6f73 2e72 656e 616d 6528 277b      os.rename('{
+00042af0: 7d2f 7b7d 272e 666f 726d 6174 2861 6c74  }/{}'.format(alt
+00042b00: 6469 722c 2061 6c74 7064 6229 2c20 277b  dir, altpdb), '{
+00042b10: 7d2f 7b7d 272e 666f 726d 6174 2861 6c74  }/{}'.format(alt
+00042b20: 6469 722c 206e 6577 7064 6229 290a 2020  dir, newpdb)).  
+00042b30: 2020 2020 2020 2020 2020 2020 2020 6f73                os
+00042b40: 2e72 656e 616d 6528 277b 7d2f 7b7d 272e  .rename('{}/{}'.
+00042b50: 666f 726d 6174 2861 6c74 6469 722c 2061  format(altdir, a
+00042b60: 6c74 7478 7429 2c20 277b 7d2f 7b7d 272e  lttxt), '{}/{}'.
+00042b70: 666f 726d 6174 2861 6c74 6469 722c 206e  format(altdir, n
+00042b80: 6577 7478 7429 290a 2020 2020 2020 2020  ewtxt)).        
+00042b90: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00042ba0: 2020 7072 696e 7428 274e 6f20 616c 7465    print('No alte
+00042bb0: 726e 6174 6976 6520 636f 6f72 6469 6e61  rnative coordina
+00042bc0: 7465 7320 6578 6973 742e 2729 0a0a 2020  tes exist.')..  
+00042bd0: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
+00042be0: 650a 0a20 2020 2064 6566 206e 6577 7265  e..    def newre
+00042bf0: 6164 5f71 7363 6f72 6528 7365 6c66 293a  ad_qscore(self):
+00042c00: 0a20 2020 2020 2020 2022 2222 0a0a 2020  .        """..  
+00042c10: 2020 2020 2020 2020 2020 4c6f 6164 2074            Load t
+00042c20: 6865 2051 2d73 636f 7265 2063 6966 2066  he Q-score cif f
+00042c30: 696c 6520 6d61 7463 6820 746f 2051 7363  ile match to Qsc
+00042c40: 6f72 6520 312e 382e 3220 2874 656d 7061  ore 1.8.2 (tempa
+00042c50: 7261 7279 290a 2020 2020 2020 2020 2020  rary).          
+00042c60: 2020 4f75 7470 7574 206a 736f 6e20 6669    Output json fi
+00042c70: 6c65 2077 6974 6820 512d 7363 6f72 6520  le with Q-score 
+00042c80: 696e 666f 726d 6174 696f 6e20 6465 7269  information deri
+00042c90: 7665 6420 6672 6f6d 2063 6966 2066 696c  ved from cif fil
+00042ca0: 650a 0a20 2020 2020 2020 203a 7265 7475  e..        :retu
+00042cb0: 726e 3a20 4e6f 6e65 0a20 2020 2020 2020  rn: None.       
+00042cc0: 2022 2222 0a0a 2020 2020 2020 2020 6d61   """..        ma
+00042cd0: 706e 616d 6520 3d20 7365 6c66 2e6d 6170  pname = self.map
+00042ce0: 6e61 6d65 0a20 2020 2020 2020 2071 6669  name.        qfi
+00042cf0: 6c65 7320 3d20 5b5d 0a20 2020 2020 2020  les = [].       
+00042d00: 2071 7363 6f72 6565 7272 6c69 7374 203d   qscoreerrlist =
+00042d10: 205b 5d0a 2020 2020 2020 2020 6d6f 6465   [].        mode
+00042d20: 6c6e 756d 203d 2030 0a20 2020 2020 2020  lnum = 0.       
+00042d30: 2071 7363 6f72 6564 6963 7420 3d20 4f72   qscoredict = Or
+00042d40: 6465 7265 6444 6963 7428 290a 2020 2020  deredDict().    
+00042d50: 2020 2020 6669 6e61 6c64 6963 7420 3d20      finaldict = 
+00042d60: 4f72 6465 7265 6444 6963 7428 290a 2020  OrderedDict().  
+00042d70: 2020 2020 2020 616c 6c6d 6f64 656c 735f        allmodels_
+00042d80: 6e75 6d62 6572 6f66 6174 6f6d 7320 3d20  numberofatoms = 
+00042d90: 300a 2020 2020 2020 2020 616c 6c6d 6f64  0.        allmod
+00042da0: 656c 735f 7173 636f 7265 7320 3d20 302e  els_qscores = 0.
+00042db0: 0a20 2020 2020 2020 2066 6f72 206d 6f64  .        for mod
+00042dc0: 656c 2069 6e20 7365 6c66 2e6d 6f64 656c  el in self.model
+00042dd0: 733a 0a20 2020 2020 2020 2020 2020 206f  s:.            o
+00042de0: 7267 6d6f 6465 6c20 3d20 6f73 2e70 6174  rgmodel = os.pat
+00042df0: 682e 6261 7365 6e61 6d65 286d 6f64 656c  h.basename(model
+00042e00: 2e66 696c 656e 616d 6529 0a20 2020 2020  .filename).     
+00042e10: 2020 2020 2020 2063 7572 6d6f 6465 6c20         curmodel 
+00042e20: 3d20 6f72 676d 6f64 656c 0a20 2020 2020  = orgmodel.     
+00042e30: 2020 2020 2020 2071 6669 6c65 203d 2027         qfile = '
+00042e40: 7b7d 7b7d 5f5f 515f 5f7b 7d2e 6369 6627  {}{}__Q__{}.cif'
+00042e50: 2e66 6f72 6d61 7428 7365 6c66 2e77 6f72  .format(self.wor
+00042e60: 6b64 6972 2c20 6375 726d 6f64 656c 2c20  kdir, curmodel, 
+00042e70: 6d61 706e 616d 6529 0a20 2020 2020 2020  mapname).       
+00042e80: 2020 2020 2069 6620 6f73 2e70 6174 682e       if os.path.
+00042e90: 6973 6669 6c65 2871 6669 6c65 293a 0a20  isfile(qfile):. 
+00042ea0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00042eb0: 203d 204d 4d43 4946 5061 7273 6572 2829   = MMCIFParser()
+00042ec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00042ed0: 2070 2e5f 6d6d 6369 665f 6469 6374 203d   p._mmcif_dict =
+00042ee0: 204d 4d43 4946 3244 6963 7428 7166 696c   MMCIF2Dict(qfil
+00042ef0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+00042f00: 2020 2063 6f6f 7264 7320 3d20 7a69 7028     coords = zip(
+00042f10: 702e 5f6d 6d63 6966 5f64 6963 745b 275f  p._mmcif_dict['_
+00042f20: 6174 6f6d 5f73 6974 652e 4361 7274 6e5f  atom_site.Cartn_
+00042f30: 7827 5d2c 2070 2e5f 6d6d 6369 665f 6469  x'], p._mmcif_di
+00042f40: 6374 5b27 5f61 746f 6d5f 7369 7465 2e43  ct['_atom_site.C
+00042f50: 6172 746e 5f79 275d 2c20 702e 5f6d 6d63  artn_y'], p._mmc
+00042f60: 6966 5f64 6963 745b 275f 6174 6f6d 5f73  if_dict['_atom_s
+00042f70: 6974 652e 4361 7274 6e5f 7a27 5d29 0a20  ite.Cartn_z']). 
+00042f80: 2020 2020 2020 2020 2020 2020 2020 2071                 q
+00042f90: 7363 6f72 6573 203d 2070 2e5f 6d6d 6369  scores = p._mmci
+00042fa0: 665f 6469 6374 5b27 5f61 746f 6d5f 7369  f_dict['_atom_si
+00042fb0: 7465 2e51 2d73 636f 7265 275d 0a20 2020  te.Q-score'].   
+00042fc0: 2020 2020 2020 2020 2020 2020 2063 6f6f               coo
+00042fd0: 7264 735f 7173 636f 7265 735f 6469 6374  rds_qscores_dict
+00042fe0: 203d 204f 7264 6572 6564 4469 6374 2829   = OrderedDict()
+00042ff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00043000: 2066 6f72 2063 6f6f 7264 2c20 7173 636f   for coord, qsco
+00043010: 7265 2069 6e20 7a69 7028 636f 6f72 6473  re in zip(coords
+00043020: 2c20 7173 636f 7265 7329 3a0a 2020 2020  , qscores):.    
+00043030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043040: 666c 6f61 745f 636f 6f72 6420 3d20 7475  float_coord = tu
+00043050: 706c 6528 6d61 7028 666c 6f61 742c 2063  ple(map(float, c
+00043060: 6f6f 7264 2929 0a20 2020 2020 2020 2020  oord)).         
+00043070: 2020 2020 2020 2020 2020 2023 206f 7267             # org
+00043080: 5f63 6f6f 7264 5f6b 6579 203d 2074 7570  _coord_key = tup
+00043090: 6c65 286d 6170 286c 616d 6264 6120 783a  le(map(lambda x:
+000430a0: 206d 6174 682e 666c 6f6f 7228 7820 2a20   math.floor(x * 
+000430b0: 3130 202a 2a20 3229 202f 2031 3020 2a2a  10 ** 2) / 10 **
+000430c0: 2032 2c20 666c 6f61 745f 636f 6f72 6429   2, float_coord)
+000430d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000430e0: 2020 2020 2020 6f72 675f 636f 6f72 645f        org_coord_
+000430f0: 6b65 7920 3d20 7475 706c 6528 6d61 7028  key = tuple(map(
+00043100: 6c61 6d62 6461 2078 3a20 6d61 7468 2e66  lambda x: math.f
+00043110: 6c6f 6f72 2878 292c 2066 6c6f 6174 5f63  loor(x), float_c
+00043120: 6f6f 7264 2929 0a20 2020 2020 2020 2020  oord)).         
+00043130: 2020 2020 2020 2020 2020 2063 6f6f 7264             coord
+00043140: 735f 7173 636f 7265 735f 6469 6374 5b6f  s_qscores_dict[o
+00043150: 7267 5f63 6f6f 7264 5f6b 6579 5d20 3d20  rg_coord_key] = 
+00043160: 666c 6f61 7428 7173 636f 7265 2920 6966  float(qscore) if
+00043170: 2071 7363 6f72 6520 213d 2027 3f27 2065   qscore != '?' e
+00043180: 6c73 6520 302e 0a20 2020 2020 2020 2020  lse 0..         
+00043190: 2020 2020 2020 2070 7173 636f 7265 6369         pqscoreci
+000431a0: 6620 3d20 702e 6765 745f 7374 7275 6374  f = p.get_struct
+000431b0: 7572 6528 7166 696c 652c 2071 6669 6c65  ure(qfile, qfile
+000431c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000431d0: 2020 666f 7220 6174 6f6d 2069 6e20 7071    for atom in pq
+000431e0: 7363 6f72 6563 6966 2e67 6574 5f61 746f  scorecif.get_ato
+000431f0: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
+00043200: 2020 2020 2020 2020 2020 2320 636f 6f72            # coor
+00043210: 645f 6b65 7920 3d20 7475 706c 6528 6d61  d_key = tuple(ma
+00043220: 7028 666c 6f61 742c 206d 6170 2873 7472  p(float, map(str
+00043230: 2c20 6174 6f6d 2e63 6f6f 7264 2929 290a  , atom.coord))).
+00043240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043250: 2020 2020 636f 6f72 645f 6b65 7920 3d20      coord_key = 
+00043260: 7475 706c 6528 6d61 7028 666c 6f61 742c  tuple(map(float,
+00043270: 2074 7570 6c65 286d 6170 2873 7472 2c20   tuple(map(str, 
+00043280: 6174 6f6d 2e63 6f6f 7264 2929 2929 0a20  atom.coord)))). 
+00043290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000432a0: 2020 2023 206e 6577 5f63 6f6f 7264 5f6b     # new_coord_k
+000432b0: 6579 203d 2074 7570 6c65 286d 6170 286c  ey = tuple(map(l
+000432c0: 616d 6264 6120 783a 206d 6174 682e 666c  ambda x: math.fl
+000432d0: 6f6f 7228 7820 2a20 3130 202a 2a20 3229  oor(x * 10 ** 2)
+000432e0: 202f 2031 3020 2a2a 2032 2c20 636f 6f72   / 10 ** 2, coor
+000432f0: 645f 6b65 7929 290a 2020 2020 2020 2020  d_key)).        
+00043300: 2020 2020 2020 2020 2020 2020 6e65 775f              new_
+00043310: 636f 6f72 645f 6b65 7920 3d20 7475 706c  coord_key = tupl
+00043320: 6528 6d61 7028 6c61 6d62 6461 2078 3a20  e(map(lambda x: 
+00043330: 6d61 7468 2e66 6c6f 6f72 2878 292c 2063  math.floor(x), c
+00043340: 6f6f 7264 5f6b 6579 2929 0a20 2020 2020  oord_key)).     
+00043350: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00043360: 6574 6174 7472 2861 746f 6d2c 2027 7173  etattr(atom, 'qs
+00043370: 636f 7265 272c 2063 6f6f 7264 735f 7173  core', coords_qs
+00043380: 636f 7265 735f 6469 6374 5b6e 6577 5f63  cores_dict[new_c
+00043390: 6f6f 7264 5f6b 6579 5d29 0a20 2020 2020  oord_key]).     
+000433a0: 2020 2020 2020 2020 2020 2071 7363 6f72             qscor
+000433b0: 6563 6966 203d 2070 7173 636f 7265 6369  ecif = pqscoreci
+000433c0: 6620 6966 206c 656e 2870 7173 636f 7265  f if len(pqscore
+000433d0: 6369 662e 6765 745f 6c69 7374 2829 2920  cif.get_list()) 
+000433e0: 3d3d 2031 2065 6c73 6520 7071 7363 6f72  == 1 else pqscor
+000433f0: 6563 6966 5b30 5d0a 2020 2020 2020 2020  ecif[0].        
+00043400: 2020 2020 2020 2020 7166 696c 6573 2e61          qfiles.a
+00043410: 7070 656e 6428 7173 636f 7265 6369 6629  ppend(qscorecif)
+00043420: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00043430: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+00043440: 2020 2020 2020 2020 2020 6369 6664 6963            cifdic
+00043450: 7420 3d20 7365 6c66 2e6e 6577 6369 665f  t = self.newcif_
+00043460: 746f 7164 6963 7428 7173 636f 7265 6369  toqdict(qscoreci
+00043470: 662c 206f 7267 6d6f 6465 6c29 0a20 2020  f, orgmodel).   
+00043480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043490: 2061 6c6c 6d6f 6465 6c73 5f6e 756d 6265   allmodels_numbe
+000434a0: 726f 6661 746f 6d73 202b 3d20 6369 6664  rofatoms += cifd
+000434b0: 6963 745b 2764 6174 6127 5d5b 276e 756d  ict['data']['num
+000434c0: 6265 726f 6661 746f 6d73 275d 0a20 2020  berofatoms'].   
+000434d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000434e0: 2061 6c6c 6d6f 6465 6c73 5f71 7363 6f72   allmodels_qscor
+000434f0: 6573 202b 3d20 6369 6664 6963 745b 2764  es += cifdict['d
+00043500: 6174 6127 5d5b 276e 756d 6265 726f 6661  ata']['numberofa
+00043510: 746f 6d73 275d 2a63 6966 6469 6374 5b27  toms']*cifdict['
+00043520: 6461 7461 275d 5b27 6176 6572 6167 6571  data']['averageq
+00043530: 7363 6f72 6527 5d0a 2020 2020 2020 2020  score'].        
+00043540: 2020 2020 2020 2020 2020 2020 7173 636f              qsco
+00043550: 7265 6469 6374 5b73 7472 286d 6f64 656c  redict[str(model
+00043560: 6e75 6d29 5d20 3d20 6369 6664 6963 740a  num)] = cifdict.
+00043570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043580: 2020 2020 6d6f 6465 6c6e 756d 202b 3d20      modelnum += 
+00043590: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
+000435a0: 2020 6578 6365 7074 3a0a 2020 2020 2020    except:.      
+000435b0: 2020 2020 2020 2020 2020 2020 2020 6572                er
+000435c0: 7220 3d20 2751 7363 6f72 6520 6361 6c63  r = 'Qscore calc
+000435d0: 756c 6174 696f 6e20 6572 726f 7220 284d  ulation error (M
+000435e0: 6f64 656c 3a20 7b7d 293a 207b 7d2e 272e  odel: {}): {}.'.
+000435f0: 666f 726d 6174 286d 6f64 656c 2e66 696c  format(model.fil
+00043600: 656e 616d 652c 2073 7973 2e65 7863 5f69  ename, sys.exc_i
+00043610: 6e66 6f28 295b 315d 290a 2020 2020 2020  nfo()[1]).      
+00043620: 2020 2020 2020 2020 2020 2020 2020 7173                qs
+00043630: 636f 7265 6572 726c 6973 742e 6170 7065  coreerrlist.appe
+00043640: 6e64 2865 7272 290a 2020 2020 2020 2020  nd(err).        
+00043650: 2020 2020 2020 2020 2020 2020 7379 732e              sys.
+00043660: 7374 6465 7272 2e77 7269 7465 2865 7272  stderr.write(err
+00043670: 202b 2027 5c6e 2729 0a20 2020 2020 2020   + '\n').       
+00043680: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00043690: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+000436a0: 2056 616c 7565 4572 726f 720a 2020 2020   ValueError.    
+000436b0: 2020 2020 6966 2061 6c6c 6d6f 6465 6c73      if allmodels
+000436c0: 5f6e 756d 6265 726f 6661 746f 6d73 2021  _numberofatoms !
+000436d0: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
+000436e0: 2061 6c6c 6d6f 6465 6c73 5f61 7665 7261   allmodels_avera
+000436f0: 6765 5f71 7363 6f72 6520 3d20 616c 6c6d  ge_qscore = allm
+00043700: 6f64 656c 735f 7173 636f 7265 7320 2f20  odels_qscores / 
+00043710: 616c 6c6d 6f64 656c 735f 6e75 6d62 6572  allmodels_number
+00043720: 6f66 6174 6f6d 730a 2020 2020 2020 2020  ofatoms.        
+00043730: 2020 2020 2320 7173 636f 7265 6469 6374      # qscoredict
+00043740: 2e75 7064 6174 6528 7b27 616c 6c6d 6f64  .update({'allmod
+00043750: 656c 735f 6176 6572 6167 655f 7173 636f  els_average_qsco
+00043760: 7265 273a 2072 6f75 6e64 2861 6c6c 6d6f  re': round(allmo
+00043770: 6465 6c73 5f61 7665 7261 6765 5f71 7363  dels_average_qsc
+00043780: 6f72 652c 2033 297d 290a 2020 2020 2020  ore, 3)}).      
+00043790: 2020 2020 2020 7173 636f 7265 6469 6374        qscoredict
+000437a0: 5b27 616c 6c6d 6f64 656c 735f 6176 6572  ['allmodels_aver
+000437b0: 6167 655f 7173 636f 7265 275d 203d 2072  age_qscore'] = r
+000437c0: 6f75 6e64 2861 6c6c 6d6f 6465 6c73 5f61  ound(allmodels_a
+000437d0: 7665 7261 6765 5f71 7363 6f72 652c 2033  verage_qscore, 3
+000437e0: 290a 2020 2020 2020 2020 6966 2071 7363  ).        if qsc
+000437f0: 6f72 6564 6963 743a 0a20 2020 2020 2020  oredict:.       
+00043800: 2020 2020 2066 696e 616c 6469 6374 5b27       finaldict['
+00043810: 7173 636f 7265 275d 203d 2071 7363 6f72  qscore'] = qscor
+00043820: 6564 6963 740a 2020 2020 2020 2020 2020  edict.          
+00043830: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00043840: 2020 2020 2020 2077 6974 6820 636f 6465         with code
+00043850: 6373 2e6f 7065 6e28 7365 6c66 2e77 6f72  cs.open(self.wor
+00043860: 6b64 6972 202b 2073 656c 662e 6d61 706e  kdir + self.mapn
+00043870: 616d 6520 2b20 275f 7173 636f 7265 2e6a  ame + '_qscore.j
+00043880: 736f 6e27 2c20 2777 272c 0a20 2020 2020  son', 'w',.     
+00043890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000438a0: 2020 2020 2020 2020 2020 2020 656e 636f              enco
+000438b0: 6469 6e67 3d27 7574 662d 3827 2920 6173  ding='utf-8') as
+000438c0: 2066 3a0a 2020 2020 2020 2020 2020 2020   f:.            
+000438d0: 2020 2020 2020 2020 6a73 6f6e 2e64 756d          json.dum
+000438e0: 7028 6669 6e61 6c64 6963 742c 2066 290a  p(finaldict, f).
+000438f0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+00043900: 7074 3a0a 2020 2020 2020 2020 2020 2020  pt:.            
+00043910: 2020 2020 7379 732e 7374 6465 7272 2e77      sys.stderr.w
+00043920: 7269 7465 2827 5361 7669 6e67 2074 6f20  rite('Saving to 
+00043930: 5173 636f 7265 206a 736f 6e20 6572 726f  Qscore json erro
+00043940: 723a 207b 7d2e 5c6e 272e 666f 726d 6174  r: {}.\n'.format
+00043950: 2873 7973 2e65 7863 5f69 6e66 6f28 295b  (sys.exc_info()[
+00043960: 315d 2929 0a20 2020 2020 2020 2065 6c73  1])).        els
+00043970: 653a 0a20 2020 2020 2020 2020 2020 2070  e:.            p
+00043980: 7269 6e74 2827 5173 636f 7265 2077 6173  rint('Qscore was
+00043990: 206e 6f74 2063 6f6c 6c65 6374 6564 2c20   not collected, 
+000439a0: 706c 6561 7365 2063 6865 636b 2127 290a  please check!').
+000439b0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+000439c0: 204e 6f6e 650a 0a20 2020 2064 6566 206e   None..    def n
+000439d0: 6577 6369 665f 746f 7164 6963 7428 7365  ewcif_toqdict(se
+000439e0: 6c66 2c20 7173 636f 7265 6369 662c 206f  lf, qscorecif, o
+000439f0: 7267 6d6f 6465 6c29 3a0a 2020 2020 2020  rgmodel):.      
+00043a00: 2020 2222 220a 0a20 2020 2020 2020 2020    """..         
+00043a10: 2020 2047 6976 656e 2063 6966 2062 696f     Given cif bio
+00043a20: 7079 7468 6f6e 206f 626a 6563 7420 616e  python object an
+00043a30: 6420 636f 6e76 6572 7420 746f 2061 2064  d convert to a d
+00043a40: 6963 746f 7279 2077 6869 6368 2063 6f6e  ictory which con
+00043a50: 7461 696e 7320 616c 6c20 6461 7461 2066  tains all data f
+00043a60: 6f72 204a 534f 4e0a 0a20 2020 2020 2020  or JSON..       
+00043a70: 203a 7265 7475 726e 3a20 4449 4354 2063   :return: DICT c
+00043a80: 6f6e 7461 696e 7320 512d 7363 6f72 6520  ontains Q-score 
+00043a90: 6461 7461 2066 726f 6d20 6d6d 6369 6620  data from mmcif 
+00043aa0: 2862 696f 7079 7468 6f6e 206f 626a 6563  (biopython objec
+00043ab0: 7429 0a20 2020 2020 2020 2022 2222 0a0a  t).        """..
+00043ac0: 0a20 2020 2020 2020 2072 6573 6964 7565  .        residue
+00043ad0: 7320 3d20 5b5d 0a20 2020 2020 2020 2063  s = [].        c
+00043ae0: 6f6c 6f72 7320 3d20 5b5d 0a20 2020 2020  olors = [].     
+00043af0: 2020 2071 7363 6f72 6573 203d 205b 5d0a     qscores = [].
+00043b00: 2020 2020 2020 2020 6368 6169 6e5f 7173          chain_qs
+00043b10: 636f 7265 203d 207b 7d0a 2020 2020 2020  core = {}.      
+00043b20: 2020 7173 636f 7265 5f6c 6973 7420 3d20    qscore_list = 
+00043b30: 5b61 746f 6d2e 7173 636f 7265 2066 6f72  [atom.qscore for
+00043b40: 2061 746f 6d20 696e 2071 7363 6f72 6563   atom in qscorec
+00043b50: 6966 2e67 6574 5f61 746f 6d73 2829 2069  if.get_atoms() i
+00043b60: 6620 6174 6f6d 2e71 7363 6f72 6520 3e20  f atom.qscore > 
+00043b70: 312e 305d 0a20 2020 2020 2020 2070 726f  1.0].        pro
+00043b80: 7465 696e 5f71 7363 6f72 6573 203d 205b  tein_qscores = [
+00043b90: 5d0a 2020 2020 2020 2020 666f 7220 6174  ].        for at
+00043ba0: 6f6d 2069 6e20 7173 636f 7265 6369 662e  om in qscorecif.
+00043bb0: 6765 745f 6174 6f6d 7328 293a 0a20 2020  get_atoms():.   
+00043bc0: 2020 2020 2020 2020 2069 6620 6174 6f6d           if atom
+00043bd0: 2e6e 616d 652e 7374 6172 7473 7769 7468  .name.startswith
+00043be0: 2827 4827 2920 6f72 2061 746f 6d2e 6765  ('H') or atom.ge
+00043bf0: 745f 7061 7265 6e74 2829 2e72 6573 6e61  t_parent().resna
+00043c00: 6d65 203d 3d20 2748 4f48 273a 0a20 2020  me == 'HOH':.   
+00043c10: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+00043c20: 7469 6e75 650a 2020 2020 2020 2020 2020  tinue.          
+00043c30: 2020 7072 6f74 6569 6e5f 7173 636f 7265    protein_qscore
+00043c40: 732e 6170 7065 6e64 2861 746f 6d2e 7173  s.append(atom.qs
+00043c50: 636f 7265 290a 2020 2020 2020 2020 6176  core).        av
+00043c60: 6572 6167 655f 7173 636f 7265 203d 2072  erage_qscore = r
+00043c70: 6f75 6e64 2873 756d 2870 726f 7465 696e  ound(sum(protein
+00043c80: 5f71 7363 6f72 6573 2920 2f20 6c65 6e28  _qscores) / len(
+00043c90: 7072 6f74 6569 6e5f 7173 636f 7265 7329  protein_qscores)
+00043ca0: 2c20 3329 0a20 2020 2020 2020 2069 6620  , 3).        if 
+00043cb0: 7173 636f 7265 5f6c 6973 743a 0a20 2020  qscore_list:.   
+00043cc0: 2020 2020 2020 2020 206d 696e 5f71 7363           min_qsc
+00043cd0: 6f72 6520 3d20 6d69 6e28 7173 636f 7265  ore = min(qscore
+00043ce0: 5f6c 6973 7429 0a20 2020 2020 2020 2020  _list).         
+00043cf0: 2020 206d 6178 5f71 7363 6f72 6520 3d20     max_qscore = 
+00043d00: 6d61 7828 7173 636f 7265 5f6c 6973 7429  max(qscore_list)
+00043d10: 0a20 2020 2020 2020 2066 6f72 2063 6861  .        for cha
+00043d20: 696e 2069 6e20 7173 636f 7265 6369 662e  in in qscorecif.
+00043d30: 6765 745f 6368 6169 6e73 2829 3a0a 2020  get_chains():.  
+00043d40: 2020 2020 2020 2020 2020 6375 7263 6861            curcha
+00043d50: 696e 5f6e 616d 6520 3d20 6368 6169 6e2e  in_name = chain.
+00043d60: 6964 0a20 2020 2020 2020 2020 2020 2063  id.            c
+00043d70: 7572 6368 6169 6e5f 7173 636f 7265 203d  urchain_qscore =
+00043d80: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
+00043d90: 666f 7220 6174 6f6d 2069 6e20 6368 6169  for atom in chai
+00043da0: 6e2e 6765 745f 6174 6f6d 7328 293a 0a20  n.get_atoms():. 
+00043db0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00043dc0: 6620 6174 6f6d 2e6e 616d 652e 7374 6172  f atom.name.star
+00043dd0: 7473 7769 7468 2827 4827 2920 6f72 2061  tswith('H') or a
+00043de0: 746f 6d2e 6765 745f 7061 7265 6e74 2829  tom.get_parent()
+00043df0: 2e72 6573 6e61 6d65 203d 3d20 2748 4f48  .resname == 'HOH
+00043e00: 273a 0a20 2020 2020 2020 2020 2020 2020  ':.             
+00043e10: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
+00043e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043e30: 6375 7263 6861 696e 5f71 7363 6f72 652e  curchain_qscore.
+00043e40: 6170 7065 6e64 2861 746f 6d2e 7173 636f  append(atom.qsco
+00043e50: 7265 290a 2020 2020 2020 2020 2020 2020  re).            
+00043e60: 6966 206e 6f74 2063 7572 6368 6169 6e5f  if not curchain_
+00043e70: 7173 636f 7265 3a0a 2020 2020 2020 2020  qscore:.        
+00043e80: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
+00043e90: 0a20 2020 2020 2020 2020 2020 2061 7665  .            ave
+00043ea0: 7261 6765 6375 7263 6861 696e 5f71 7363  ragecurchain_qsc
+00043eb0: 6f72 6520 3d20 726f 756e 6428 7375 6d28  ore = round(sum(
+00043ec0: 6375 7263 6861 696e 5f71 7363 6f72 6529  curchain_qscore)
+00043ed0: 202f 206c 656e 2863 7572 6368 6169 6e5f   / len(curchain_
+00043ee0: 7173 636f 7265 292c 2033 290a 2020 2020  qscore), 3).    
+00043ef0: 2020 2020 2020 2020 6174 6f6d 735f 696e          atoms_in
+00043f00: 6368 6169 6e20 3d20 300a 2020 2020 2020  chain = 0.      
+00043f10: 2020 2020 2020 7173 636f 7265 5f69 6e63        qscore_inc
+00043f20: 6861 696e 203d 2030 2e0a 2020 2020 2020  hain = 0..      
+00043f30: 2020 2020 2020 666f 7220 7265 7369 6475        for residu
+00043f40: 6520 696e 2063 6861 696e 3a0a 2020 2020  e in chain:.    
+00043f50: 2020 2020 2020 2020 2020 2020 6375 7272              curr
+00043f60: 6573 5f6e 616d 6520 3d20 7265 7369 6475  es_name = residu
+00043f70: 652e 7265 736e 616d 650a 2020 2020 2020  e.resname.      
+00043f80: 2020 2020 2020 2020 2020 6966 2063 7572            if cur
+00043f90: 7265 735f 6e61 6d65 203d 3d20 2748 4f48  res_name == 'HOH
+00043fa0: 273a 0a20 2020 2020 2020 2020 2020 2020  ':.             
+00043fb0: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
+00043fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00043fd0: 6375 7272 6573 5f69 6420 3d20 7265 7369  curres_id = resi
+00043fe0: 6475 652e 6964 5b31 5d0a 2020 2020 2020  due.id[1].      
+00043ff0: 2020 2020 2020 2020 2020 6174 6f6d 735f            atoms_
+00044000: 696e 7265 7369 6475 6520 3d20 300a 2020  inresidue = 0.  
+00044010: 2020 2020 2020 2020 2020 2020 2020 7173                qs
+00044020: 636f 7265 5f69 6e72 6573 6964 7565 203d  core_inresidue =
+00044030: 2030 2e0a 2020 2020 2020 2020 2020 2020   0..            
+00044040: 2020 2020 666f 7220 6174 6f6d 2069 6e20      for atom in 
+00044050: 7265 7369 6475 653a 0a20 2020 2020 2020  residue:.       
+00044060: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00044070: 6174 6f6d 2e6e 616d 652e 7374 6172 7473  atom.name.starts
+00044080: 7769 7468 2827 4827 2920 6f72 2061 746f  with('H') or ato
+00044090: 6d2e 6765 745f 7061 7265 6e74 2829 2e72  m.get_parent().r
+000440a0: 6573 6e61 6d65 203d 3d20 2748 4f48 273a  esname == 'HOH':
+000440b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000440c0: 2020 2020 2020 2020 2063 6f6e 7469 6e75           continu
+000440d0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+000440e0: 2020 2020 2020 6174 6f6d 735f 696e 6368        atoms_inch
+000440f0: 6169 6e20 2b3d 2031 0a20 2020 2020 2020  ain += 1.       
+00044100: 2020 2020 2020 2020 2020 2020 2061 746f               ato
+00044110: 6d73 5f69 6e72 6573 6964 7565 202b 3d20  ms_inresidue += 
+00044120: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
+00044130: 2020 2020 2020 6375 7261 746f 6d5f 7173        curatom_qs
+00044140: 636f 7265 203d 2061 746f 6d2e 7173 636f  core = atom.qsco
+00044150: 7265 0a20 2020 2020 2020 2020 2020 2020  re.             
+00044160: 2020 2020 2020 2071 7363 6f72 655f 696e         qscore_in
+00044170: 6368 6169 6e20 2b3d 2063 7572 6174 6f6d  chain += curatom
+00044180: 5f71 7363 6f72 650a 2020 2020 2020 2020  _qscore.        
+00044190: 2020 2020 2020 2020 2020 2020 7173 636f              qsco
+000441a0: 7265 5f69 6e72 6573 6964 7565 202b 3d20  re_inresidue += 
+000441b0: 6375 7261 746f 6d5f 7173 636f 7265 0a20  curatom_qscore. 
+000441c0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000441d0: 6620 6174 6f6d 735f 696e 7265 7369 6475  f atoms_inresidu
+000441e0: 6520 213d 2030 2e3a 0a20 2020 2020 2020  e != 0.:.       
+000441f0: 2020 2020 2020 2020 2020 2020 2063 7572               cur
+00044200: 7265 735f 7173 636f 7265 203d 2072 6f75  res_qscore = rou
+00044210: 6e64 2871 7363 6f72 655f 696e 7265 7369  nd(qscore_inresi
+00044220: 6475 6520 2f20 6174 6f6d 735f 696e 7265  due / atoms_inre
+00044230: 7369 6475 652c 2033 290a 2020 2020 2020  sidue, 3).      
+00044240: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00044250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044260: 2020 2020 6375 7272 6573 5f71 7363 6f72      curres_qscor
+00044270: 6520 3d20 302e 0a20 2020 2020 2020 2020  e = 0..         
+00044280: 2020 2020 2020 2069 6620 6375 7272 6573         if curres
+00044290: 5f71 7363 6f72 6520 3e20 312e 303a 0a20  _qscore > 1.0:. 
+000442a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000442b0: 2020 2069 6620 6d69 6e5f 7173 636f 7265     if min_qscore
+000442c0: 203d 3d20 6d61 785f 7173 636f 7265 3a0a   == max_qscore:.
+000442d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000442e0: 2020 2020 2020 2020 6375 7272 6573 5f63          curres_c
+000442f0: 6f6c 6f72 203d 2027 2330 3030 3030 3027  olor = '#000000'
+00044300: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00044310: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00044320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044330: 2020 2073 6361 6c65 645f 7173 636f 7265     scaled_qscore
+00044340: 203d 2028 6375 7272 6573 5f71 7363 6f72   = (curres_qscor
+00044350: 6520 2d20 6d69 6e5f 7173 636f 7265 2920  e - min_qscore) 
+00044360: 2f20 286d 6178 5f71 7363 6f72 6520 2d20  / (max_qscore - 
+00044370: 6d69 6e5f 7173 636f 7265 290a 2020 2020  min_qscore).    
+00044380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044390: 2020 2020 6375 7272 6573 5f63 6f6c 6f72      curres_color
+000443a0: 203d 2073 656c 662e 5f5f 666c 6f61 746f   = self.__floato
+000443b0: 6865 785f 6162 6f76 656f 6e65 285b 7363  hex_aboveone([sc
+000443c0: 616c 6564 5f71 7363 6f72 655d 295b 305d  aled_qscore])[0]
+000443d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000443e0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000443f0: 2020 2020 2020 2020 2020 2063 7572 7265             curre
+00044400: 735f 636f 6c6f 7220 3d20 7365 6c66 2e5f  s_color = self._
+00044410: 5f66 6c6f 6174 6f68 6578 285b 6375 7272  _floatohex([curr
+00044420: 6573 5f71 7363 6f72 655d 295b 305d 0a0a  es_qscore])[0]..
+00044430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044440: 6963 6f64 6520 3d20 7265 7369 6475 652e  icode = residue.
+00044450: 6964 5b32 5d0a 2020 2020 2020 2020 2020  id[2].          
+00044460: 2020 2020 2020 6966 2069 636f 6465 2021        if icode !
+00044470: 3d20 2720 273a 0a20 2020 2020 2020 2020  = ' ':.         
+00044480: 2020 2020 2020 2020 2020 2063 7572 7265             curre
+00044490: 735f 7374 7269 6e67 203d 2027 7b7d 3a7b  s_string = '{}:{
+000444a0: 7d7b 7d20 7b7d 272e 666f 726d 6174 2863  }{} {}'.format(c
+000444b0: 7572 6368 6169 6e5f 6e61 6d65 2c20 6375  urchain_name, cu
+000444c0: 7272 6573 5f69 642c 2069 636f 6465 2c20  rres_id, icode, 
+000444d0: 6375 7272 6573 5f6e 616d 6529 0a20 2020  curres_name).   
+000444e0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+000444f0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00044500: 2020 2020 2020 2063 7572 7265 735f 7374         curres_st
+00044510: 7269 6e67 203d 2027 7b7d 3a7b 7d20 7b7d  ring = '{}:{} {}
+00044520: 272e 666f 726d 6174 2863 7572 6368 6169  '.format(curchai
+00044530: 6e5f 6e61 6d65 2c20 6375 7272 6573 5f69  n_name, curres_i
+00044540: 642c 2063 7572 7265 735f 6e61 6d65 290a  d, curres_name).
+00044550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044560: 7265 7369 6475 6573 2e61 7070 656e 6428  residues.append(
+00044570: 6375 7272 6573 5f73 7472 696e 6729 0a20  curres_string). 
+00044580: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00044590: 6f6c 6f72 732e 6170 7065 6e64 2863 7572  olors.append(cur
+000445a0: 7265 735f 636f 6c6f 7229 0a20 2020 2020  res_color).     
+000445b0: 2020 2020 2020 2020 2020 2071 7363 6f72             qscor
+000445c0: 6573 2e61 7070 656e 6428 6375 7272 6573  es.append(curres
+000445d0: 5f71 7363 6f72 6529 0a20 2020 2020 2020  _qscore).       
+000445e0: 2020 2020 2061 7665 7261 6765 7173 636f       averageqsco
+000445f0: 7265 5f69 6e63 6f6c 6f72 203d 2073 656c  re_incolor = sel
+00044600: 662e 5f5f 666c 6f61 746f 6865 7828 5b61  f.__floatohex([a
+00044610: 7665 7261 6765 6375 7263 6861 696e 5f71  veragecurchain_q
+00044620: 7363 6f72 655d 295b 305d 0a20 2020 2020  score])[0].     
+00044630: 2020 2020 2020 2063 6861 696e 5f71 7363         chain_qsc
+00044640: 6f72 655b 6375 7263 6861 696e 5f6e 616d  ore[curchain_nam
+00044650: 655d 203d 207b 2776 616c 7565 273a 2061  e] = {'value': a
+00044660: 7665 7261 6765 6375 7263 6861 696e 5f71  veragecurchain_q
+00044670: 7363 6f72 652c 2027 636f 6c6f 7227 3a20  score, 'color': 
+00044680: 6176 6572 6167 6571 7363 6f72 655f 696e  averageqscore_in
+00044690: 636f 6c6f 727d 0a0a 2020 2020 2020 2020  color}..        
+000446a0: 6c65 7665 6c73 203d 206e 702e 6c69 6e73  levels = np.lins
+000446b0: 7061 6365 282d 312c 2031 2c20 3130 3029  pace(-1, 1, 100)
+000446c0: 0a20 2020 2020 2020 2071 6172 7261 7920  .        qarray 
+000446d0: 3d20 6e70 2e61 7272 6179 2871 7363 6f72  = np.array(qscor
+000446e0: 6573 290a 2020 2020 2020 2020 6869 7374  es).        hist
+000446f0: 2c20 6269 6e5f 6564 6765 7320 3d20 6e70  , bin_edges = np
+00044700: 2e68 6973 746f 6772 616d 2871 6172 7261  .histogram(qarra
+00044710: 792c 2062 696e 733d 6c65 7665 6c73 290a  y, bins=levels).
+00044720: 2020 2020 2020 2020 706c 742e 706c 6f74          plt.plot
+00044730: 2862 696e 5f65 6467 6573 5b31 3a5d 2c20  (bin_edges[1:], 
+00044740: 6869 7374 2f71 6172 7261 792e 7369 7a65  hist/qarray.size
+00044750: 290a 0a20 2020 2020 2020 2070 726f 7465  )..        prote
+00044760: 696e 5f71 6172 7261 7920 3d20 6e70 2e61  in_qarray = np.a
+00044770: 7272 6179 2870 726f 7465 696e 5f71 7363  rray(protein_qsc
+00044780: 6f72 6573 290a 2020 2020 2020 2020 7068  ores).        ph
+00044790: 6973 742c 2070 5f62 696e 5f65 6467 6573  ist, p_bin_edges
+000447a0: 203d 206e 702e 6869 7374 6f67 7261 6d28   = np.histogram(
+000447b0: 7072 6f74 6569 6e5f 7161 7272 6179 2c20  protein_qarray, 
+000447c0: 6269 6e73 3d6c 6576 656c 7329 0a20 2020  bins=levels).   
+000447d0: 2020 2020 2070 6c74 2e70 6c6f 7428 705f       plt.plot(p_
+000447e0: 6269 6e5f 6564 6765 735b 313a 5d2c 2070  bin_edges[1:], p
+000447f0: 6869 7374 2f70 726f 7465 696e 5f71 6172  hist/protein_qar
+00044800: 7261 792e 7369 7a65 290a 2020 2020 2020  ray.size).      
+00044810: 2020 706c 742e 786c 6162 656c 2827 512d    plt.xlabel('Q-
+00044820: 7363 6f72 6527 290a 2020 2020 2020 2020  score').        
+00044830: 706c 742e 796c 6162 656c 2827 4672 6163  plt.ylabel('Frac
+00044840: 7469 6f6e 2729 0a20 2020 2020 2020 2070  tion').        p
+00044850: 6c74 2e6c 6567 656e 6428 2827 5265 7369  lt.legend(('Resi
+00044860: 6475 653a 2027 202b 2027 2827 202b 2073  due: ' + '(' + s
+00044870: 7472 2871 6172 7261 792e 7369 7a65 2920  tr(qarray.size) 
+00044880: 2b20 2729 272c 2027 4174 6f6d 3a20 2720  + ')', 'Atom: ' 
+00044890: 2b20 2728 2720 2b20 7374 7228 7072 6f74  + '(' + str(prot
+000448a0: 6569 6e5f 7161 7272 6179 2e73 697a 6529  ein_qarray.size)
+000448b0: 202b 2027 2927 292c 206c 6f63 3d27 7570   + ')'), loc='up
+000448c0: 7065 7220 6c65 6674 272c 2073 6861 646f  per left', shado
+000448d0: 773d 5472 7565 290a 2020 2020 2020 2020  w=True).        
+000448e0: 6966 2073 656c 662e 6d61 706e 616d 6520  if self.mapname 
+000448f0: 616e 6420 7365 6c66 2e72 6573 6f6c 7574  and self.resolut
+00044900: 696f 6e3a 0a20 2020 2020 2020 2020 2020  ion:.           
+00044910: 2070 6c74 2e74 6974 6c65 2827 4d61 703a   plt.title('Map:
+00044920: 2027 202b 2073 656c 662e 6d61 706e 616d   ' + self.mapnam
+00044930: 6520 2b20 2720 6174 3a20 2720 2b20 7374  e + ' at: ' + st
+00044940: 7228 7365 6c66 2e72 6573 6f6c 7574 696f  r(self.resolutio
+00044950: 6e29 202b 2027 c385 2729 0a20 2020 2020  n) + '..').     
+00044960: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00044970: 2020 2020 2070 6c74 2e74 6974 6c65 2827       plt.title('
+00044980: 4d61 7020 512d 7363 6f72 6520 2729 0a20  Map Q-score '). 
+00044990: 2020 2020 2020 2070 6c74 2e73 6176 6566         plt.savef
+000449a0: 6967 2873 656c 662e 776f 726b 6469 7220  ig(self.workdir 
+000449b0: 2b20 7365 6c66 2e6d 6170 6e61 6d65 202b  + self.mapname +
+000449c0: 2027 5f71 7363 6f72 652e 706e 6727 290a   '_qscore.png').
+000449d0: 2020 2020 2020 2020 706c 742e 636c 6f73          plt.clos
+000449e0: 6528 290a 2020 2020 2020 2020 715f 7265  e().        q_re
+000449f0: 7369 6475 655f 6672 6163 7469 6f6e 7320  sidue_fractions 
+00044a00: 3d20 6c69 7374 286e 702e 6172 6f75 6e64  = list(np.around
+00044a10: 2868 6973 742f 7161 7272 6179 2e73 697a  (hist/qarray.siz
+00044a20: 652c 2033 2929 0a20 2020 2020 2020 2071  e, 3)).        q
+00044a30: 5f70 726f 7465 696e 5f66 7261 6374 696f  _protein_fractio
+00044a40: 6e73 203d 206c 6973 7428 6e70 2e61 726f  ns = list(np.aro
+00044a50: 756e 6428 7068 6973 742f 7072 6f74 6569  und(phist/protei
+00044a60: 6e5f 7161 7272 6179 2e73 697a 652c 2033  n_qarray.size, 3
+00044a70: 2929 0a20 2020 2020 2020 2071 6672 6163  )).        qfrac
+00044a80: 7469 6f6e 7320 3d20 7b27 714c 6576 656c  tions = {'qLevel
+00044a90: 7327 3a20 6c69 7374 286e 702e 6172 6f75  s': list(np.arou
+00044aa0: 6e64 286c 6576 656c 735b 313a 5d2c 2033  nd(levels[1:], 3
+00044ab0: 2929 2c20 2771 5265 7369 6475 6546 7261  )), 'qResidueFra
+00044ac0: 6374 696f 6e73 273a 2071 5f72 6573 6964  ctions': q_resid
+00044ad0: 7565 5f66 7261 6374 696f 6e73 2c0a 2020  ue_fractions,.  
+00044ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00044af0: 2020 2020 2771 4174 6f6d 4672 6163 7469      'qAtomFracti
+00044b00: 6f6e 7327 3a20 715f 7072 6f74 6569 6e5f  ons': q_protein_
+00044b10: 6672 6163 7469 6f6e 737d 0a0a 2020 2020  fractions}..    
+00044b20: 2020 2020 2320 7363 6f72 655f 7479 7065      # score_type
+00044b30: 203d 2027 7173 636f 7265 270a 2020 2020   = 'qscore'.    
+00044b40: 2020 2020 2320 6e65 775f 6469 6374 203d      # new_dict =
+00044b50: 207b 2769 6427 3a20 7365 6c66 2e65 6d64   {'id': self.emd
+00044b60: 6964 2c20 2772 6573 6f6c 7574 696f 6e27  id, 'resolution'
+00044b70: 3a20 666c 6f61 7428 7365 6c66 2e72 6573  : float(self.res
+00044b80: 6f6c 7574 696f 6e29 2c20 276e 616d 6527  olution), 'name'
+00044b90: 3a20 6f72 676d 6f64 656c 2c20 7363 6f72  : orgmodel, scor
+00044ba0: 655f 7479 7065 3a20 6176 6572 6167 655f  e_type: average_
+00044bb0: 7173 636f 7265 7d0a 2020 2020 2020 2020  qscore}.        
+00044bc0: 2320 706c 6f74 5f6e 616d 6520 3d20 277b  # plot_name = '{
+00044bd0: 7d5f 7b7d 5f7b 7d5f 6261 722e 706e 6727  }_{}_{}_bar.png'
+00044be0: 2e66 6f72 6d61 7428 7365 6c66 2e6d 6170  .format(self.map
+00044bf0: 6e61 6d65 2c20 6f72 676d 6f64 656c 2c20  name, orgmodel, 
+00044c00: 7363 6f72 655f 7479 7065 290a 2020 2020  score_type).    
+00044c10: 2020 2020 2320 7363 6f72 655f 6469 7220      # score_dir 
+00044c20: 3d20 6f73 2e70 6174 682e 6469 726e 616d  = os.path.dirnam
+00044c30: 6528 7661 2e5f 5f66 696c 655f 5f29 0a20  e(va.__file__). 
+00044c40: 2020 2020 2020 2023 2072 656c 6174 6976         # relativ
+00044c50: 655f 746f 7768 6f6c 652c 2072 656c 6174  e_towhole, relat
+00044c60: 6976 655f 746f 7477 6f20 3d20 6261 7228  ive_totwo = bar(
+00044c70: 6e65 775f 6469 6374 2c20 7363 6f72 655f  new_dict, score_
+00044c80: 7479 7065 2c20 7365 6c66 2e77 6f72 6b64  type, self.workd
+00044c90: 6972 2c20 7363 6f72 655f 6469 722c 2070  ir, score_dir, p
+00044ca0: 6c6f 745f 6e61 6d65 290a 2020 2020 2020  lot_name).      
+00044cb0: 2020 2320 7162 6172 203d 207b 2777 686f    # qbar = {'who
+00044cc0: 6c65 273a 2072 656c 6174 6976 655f 746f  le': relative_to
+00044cd0: 7768 6f6c 652c 2027 7265 6c61 7469 7665  whole, 'relative
+00044ce0: 273a 2072 656c 6174 6976 655f 746f 7477  ': relative_totw
+00044cf0: 6f7d 0a0a 2020 2020 2020 2020 7464 6963  o}..        tdic
+00044d00: 7420 3d20 4f72 6465 7265 6444 6963 7428  t = OrderedDict(
+00044d10: 5b0a 2020 2020 2020 2020 2020 2020 2827  [.            ('
+00044d20: 6176 6572 6167 6571 7363 6f72 6527 2c20  averageqscore', 
+00044d30: 6176 6572 6167 655f 7173 636f 7265 292c  average_qscore),
+00044d40: 0a20 2020 2020 2020 2020 2020 2028 2761  .            ('a
+00044d50: 7665 7261 6765 7173 636f 7265 5f63 6f6c  verageqscore_col
+00044d60: 6f72 272c 2073 656c 662e 5f5f 666c 6f61  or', self.__floa
+00044d70: 746f 6865 7828 5b61 7665 7261 6765 5f71  tohex([average_q
+00044d80: 7363 6f72 655d 295b 305d 292c 0a20 2020  score])[0]),.   
+00044d90: 2020 2020 2020 2020 2023 2028 2771 7363           # ('qsc
+00044da0: 6f72 655f 6261 7227 2c20 7162 6172 292c  ore_bar', qbar),
+00044db0: 0a20 2020 2020 2020 2020 2020 2028 276e  .            ('n
+00044dc0: 756d 6265 726f 6661 746f 6d73 272c 206c  umberofatoms', l
+00044dd0: 656e 2870 726f 7465 696e 5f71 7363 6f72  en(protein_qscor
+00044de0: 6573 2929 2c0a 2020 2020 2020 2020 2020  es)),.          
+00044df0: 2020 2827 636f 6c6f 7227 2c20 636f 6c6f    ('color', colo
+00044e00: 7273 292c 0a20 2020 2020 2020 2020 2020  rs),.           
+00044e10: 2028 2769 6e63 6c75 7369 6f6e 272c 2071   ('inclusion', q
+00044e20: 7363 6f72 6573 292c 0a20 2020 2020 2020  scores),.       
+00044e30: 2020 2020 2028 2771 7363 6f72 6527 2c20       ('qscore', 
+00044e40: 7173 636f 7265 7329 2c0a 2020 2020 2020  qscores),.      
+00044e50: 2020 2020 2020 2827 7265 7369 6475 6527        ('residue'
+00044e60: 2c20 7265 7369 6475 6573 292c 0a20 2020  , residues),.   
+00044e70: 2020 2020 2020 2020 2028 2763 6861 696e           ('chain
+00044e80: 7173 636f 7265 272c 2063 6861 696e 5f71  qscore', chain_q
+00044e90: 7363 6f72 6529 2c0a 2020 2020 2020 2020  score),.        
+00044ea0: 2020 2020 2827 7146 7261 6374 696f 6e44      ('qFractionD
+00044eb0: 6973 7472 6962 7574 696f 6e27 2c20 7166  istribution', qf
+00044ec0: 7261 6374 696f 6e73 290a 2020 2020 2020  ractions).      
+00044ed0: 2020 5d29 0a0a 0a20 2020 2020 2020 2072    ])...        r
+00044ee0: 6573 756c 7464 6963 7420 3d20 4f72 6465  esultdict = Orde
+00044ef0: 7265 6444 6963 7428 5b28 276e 616d 6527  redDict([('name'
+00044f00: 2c20 6f72 676d 6f64 656c 292c 2028 2764  , orgmodel), ('d
+00044f10: 6174 6127 2c20 7464 6963 7429 5d29 0a0a  ata', tdict)])..
+00044f20: 2020 2020 2020 2020 7265 7475 726e 2072          return r
+00044f30: 6573 756c 7464 6963 740a 0a0a 2020 2020  esultdict...    
+00044f40: 6465 6620 7265 6164 7173 636f 7265 2873  def readqscore(s
+00044f50: 656c 6629 3a0a 2020 2020 2020 2020 2222  elf):.        ""
+00044f60: 220a 0a20 2020 2020 2020 2020 2020 204c  "..            L
+00044f70: 6f61 6420 7468 6520 512d 7363 6f72 6520  oad the Q-score 
+00044f80: 7064 6220 6669 6c65 2874 656d 7061 7261  pdb file(tempara
+00044f90: 7279 290a 0a20 2020 2020 2020 203a 7265  ry)..        :re
+00044fa0: 7475 726e 3a0a 2020 2020 2020 2020 2222  turn:.        ""
+00044fb0: 220a 0a20 2020 2020 2020 206d 6170 6e61  "..        mapna
+00044fc0: 6d65 203d 2073 656c 662e 6d61 706e 616d  me = self.mapnam
+00044fd0: 655b 3a2d 345d 0a20 2020 2020 2020 2071  e[:-4].        q
+00044fe0: 6669 6c65 7320 3d20 5b5d 0a20 2020 2020  files = [].     
+00044ff0: 2020 2071 7363 6f72 6565 7272 6c69 7374     qscoreerrlist
+00045000: 203d 205b 5d0a 2020 2020 2020 2020 7265   = [].        re
+00045010: 7375 6c74 203d 207b 7d0a 2020 2020 2020  sult = {}.      
+00045020: 2020 6d6f 6465 6c6e 756d 203d 2030 0a20    modelnum = 0. 
+00045030: 2020 2020 2020 2071 7363 6f72 6564 6963         qscoredic
+00045040: 7420 3d20 4f72 6465 7265 6444 6963 7428  t = OrderedDict(
+00045050: 290a 2020 2020 2020 2020 6669 6e61 6c64  ).        finald
+00045060: 6963 7420 3d20 4f72 6465 7265 6444 6963  ict = OrderedDic
+00045070: 7428 290a 2020 2020 2020 2020 666f 7220  t().        for 
+00045080: 6d6f 6465 6c20 696e 2073 656c 662e 6d6f  model in self.mo
+00045090: 6465 6c73 3a0a 2020 2020 2020 2020 2020  dels:.          
+000450a0: 2020 6f72 676d 6f64 656c 203d 206f 732e    orgmodel = os.
+000450b0: 7061 7468 2e62 6173 656e 616d 6528 6d6f  path.basename(mo
+000450c0: 6465 6c2e 6669 6c65 6e61 6d65 290a 2020  del.filename).  
+000450d0: 2020 2020 2020 2020 2020 6375 726d 6f64            curmod
+000450e0: 656c 203d 206f 7267 6d6f 6465 6c5b 3a2d  el = orgmodel[:-
+000450f0: 345d 0a20 2020 2020 2020 2020 2020 2071  4].            q
+00045100: 6669 6c65 203d 2027 7b7d 7b7d 5f5f 515f  file = '{}{}__Q_
+00045110: 5f7b 7d2e 7064 6227 2e66 6f72 6d61 7428  _{}.pdb'.format(
+00045120: 7365 6c66 2e77 6f72 6b64 6972 2c20 6375  self.workdir, cu
+00045130: 726d 6f64 656c 2c20 6d61 706e 616d 6529  rmodel, mapname)
+00045140: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00045150: 6f73 2e70 6174 682e 6973 6669 6c65 2871  os.path.isfile(q
+00045160: 6669 6c65 293a 0a20 2020 2020 2020 2020  file):.         
+00045170: 2020 2020 2020 2070 203d 206f 7267 5044         p = orgPD
+00045180: 4250 6172 7365 7228 290a 2020 2020 2020  BParser().      
+00045190: 2020 2020 2020 2020 2020 7071 7363 6f72            pqscor
+000451a0: 6570 6462 203d 2070 2e67 6574 5f73 7472  epdb = p.get_str
+000451b0: 7563 7475 7265 2827 6d79 7166 696c 6527  ucture('myqfile'
+000451c0: 2c20 7166 696c 6529 0a20 2020 2020 2020  , qfile).       
+000451d0: 2020 2020 2020 2020 2071 7363 6f72 6570           qscorep
+000451e0: 6462 203d 2070 7173 636f 7265 7064 6220  db = pqscorepdb 
+000451f0: 6966 206c 656e 2870 7173 636f 7265 7064  if len(pqscorepd
+00045200: 622e 6765 745f 6c69 7374 2829 2920 3d3d  b.get_list()) ==
+00045210: 2031 2065 6c73 6520 7071 7363 6f72 6570   1 else pqscorep
+00045220: 6462 5b30 5d0a 2020 2020 2020 2020 2020  db[0].          
+00045230: 2020 2020 2020 7166 696c 6573 2e61 7070        qfiles.app
+00045240: 656e 6428 7173 636f 7265 7064 6229 0a20  end(qscorepdb). 
+00045250: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00045260: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00045270: 2020 2020 2020 2020 2320 7173 636f 7265          # qscore
+00045280: 6469 6374 5b73 7472 286d 6f64 656c 6e75  dict[str(modelnu
+00045290: 6d29 5d20 3d20 7365 6c66 2e70 6462 746f  m)] = self.pdbto
+000452a0: 7164 6963 7428 7173 636f 7265 7064 622c  qdict(qscorepdb,
+000452b0: 206f 7267 6d6f 6465 6c29 0a20 2020 2020   orgmodel).     
+000452c0: 2020 2020 2020 2020 2020 2020 2020 2071                 q
+000452d0: 7363 6f72 6564 6963 745b 7374 7228 6d6f  scoredict[str(mo
+000452e0: 6465 6c6e 756d 295d 203d 2073 656c 662e  delnum)] = self.
+000452f0: 6e65 7770 6462 746f 7164 6963 7428 7173  newpdbtoqdict(qs
+00045300: 636f 7265 7064 622c 206f 7267 6d6f 6465  corepdb, orgmode
+00045310: 6c29 0a20 2020 2020 2020 2020 2020 2020  l).             
+00045320: 2020 2020 2020 206d 6f64 656c 6e75 6d20         modelnum 
+00045330: 2b3d 2031 0a20 2020 2020 2020 2020 2020  += 1.           
+00045340: 2020 2020 2065 7863 6570 743a 0a20 2020       except:.   
+00045350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00045360: 2065 7272 203d 2027 5173 636f 7265 2063   err = 'Qscore c
+00045370: 616c 6375 6c61 7469 6f6e 2065 7272 6f72  alculation error
+00045380: 2028 4d6f 6465 6c3a 207b 7d29 3a20 7b7d   (Model: {}): {}
+00045390: 2e27 2e66 6f72 6d61 7428 6d6f 6465 6c2e  .'.format(model.
+000453a0: 6669 6c65 6e61 6d65 2c20 7379 732e 6578  filename, sys.ex
+000453b0: 635f 696e 666f 2829 5b31 5d29 0a20 2020  c_info()[1]).   
+000453c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000453d0: 2071 7363 6f72 6565 7272 6c69 7374 2e61   qscoreerrlist.a
+000453e0: 7070 656e 6428 6572 7229 0a20 2020 2020  ppend(err).     
+000453f0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00045400: 7973 2e73 7464 6572 722e 7772 6974 6528  ys.stderr.write(
+00045410: 6572 7220 2b20 275c 6e27 290a 2020 2020  err + '\n').    
+00045420: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00045430: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+00045440: 6973 6520 5661 6c75 6545 7272 6f72 0a0a  ise ValueError..
+00045450: 2020 2020 2020 2020 6966 2071 7363 6f72          if qscor
+00045460: 6564 6963 743a 0a20 2020 2020 2020 2020  edict:.         
+00045470: 2020 2066 696e 616c 6469 6374 5b27 7173     finaldict['qs
+00045480: 636f 7265 275d 203d 2071 7363 6f72 6564  core'] = qscored
+00045490: 6963 740a 2020 2020 2020 2020 2020 2020  ict.            
+000454a0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+000454b0: 2020 2020 2077 6974 6820 636f 6465 6373       with codecs
+000454c0: 2e6f 7065 6e28 7365 6c66 2e77 6f72 6b64  .open(self.workd
+000454d0: 6972 202b 2073 656c 662e 6d61 706e 616d  ir + self.mapnam
+000454e0: 6520 2b20 275f 7173 636f 7265 2e6a 736f  e + '_qscore.jso
+000454f0: 6e27 2c20 2777 272c 0a20 2020 2020 2020  n', 'w',.       
+00045500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00045510: 2020 2020 2020 2020 2020 656e 636f 6469            encodi
+00045520: 6e67 3d27 7574 662d 3827 2920 6173 2066  ng='utf-8') as f
+00045530: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00045540: 2020 2020 2020 6a73 6f6e 2e64 756d 7028        json.dump(
+00045550: 6669 6e61 6c64 6963 742c 2066 290a 2020  finaldict, f).  
+00045560: 2020 2020 2020 2020 2020 6578 6365 7074            except
+00045570: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00045580: 2020 7379 732e 7374 6465 7272 2e77 7269    sys.stderr.wri
+00045590: 7465 2827 5361 7669 6e67 2074 6f20 5173  te('Saving to Qs
+000455a0: 636f 7265 206a 736f 6e20 6572 726f 723a  core json error:
+000455b0: 207b 7d2e 5c6e 272e 666f 726d 6174 2873   {}.\n'.format(s
+000455c0: 7973 2e65 7863 5f69 6e66 6f28 295b 315d  ys.exc_info()[1]
+000455d0: 2929 0a20 2020 2020 2020 2065 6c73 653a  )).        else:
+000455e0: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
+000455f0: 6e74 2827 5173 636f 7265 2077 6173 206e  nt('Qscore was n
+00045600: 6f74 2063 6f6c 6c65 6374 6564 2c20 706c  ot collected, pl
+00045610: 6561 7365 2063 6865 636b 2127 290a 0a0a  ease check!')...
+00045620: 2020 2020 2020 2020 7265 7475 726e 204e          return N
+00045630: 6f6e 650a 0a20 2020 2064 6566 206e 6577  one..    def new
+00045640: 7064 6274 6f71 6469 6374 2873 656c 662c  pdbtoqdict(self,
+00045650: 2071 7363 6f72 6570 6462 2c20 6f72 676d   qscorepdb, orgm
+00045660: 6f64 656c 293a 0a20 2020 2020 2020 2022  odel):.        "
+00045670: 2222 0a0a 2020 2020 2020 2020 2020 2020  ""..            
+00045680: 4769 7665 6e20 7064 6220 6269 6f70 7974  Given pdb biopyt
+00045690: 686f 6e20 6f62 6a65 6374 2061 6e64 2063  hon object and c
+000456a0: 6f6e 7665 7274 2074 6f20 6120 6469 6374  onvert to a dict
+000456b0: 2077 6869 6368 2063 6f6e 7461 696e 7320   which contains 
+000456c0: 616c 6c20 6461 7461 2066 6f72 204a 534f  all data for JSO
+000456d0: 4e0a 0a20 2020 2020 2020 203a 7265 7475  N..        :retu
+000456e0: 726e 3a20 4449 4354 2063 6f6e 7461 696e  rn: DICT contain
+000456f0: 7320 616c 6c20 6461 7461 0a20 2020 2020  s all data.     
+00045700: 2020 2022 2222 0a0a 2020 2020 2020 2020     """..        
+00045710: 7265 7369 6475 6573 203d 205b 5d0a 2020  residues = [].  
+00045720: 2020 2020 2020 636f 6c6f 7273 203d 205b        colors = [
+00045730: 5d0a 2020 2020 2020 2020 7173 636f 7265  ].        qscore
+00045740: 7320 3d20 5b5d 0a20 2020 2020 2020 2063  s = [].        c
+00045750: 6861 696e 5f71 7363 6f72 6520 3d20 7b7d  hain_qscore = {}
+00045760: 0a20 2020 2020 2020 2071 7363 6f72 655f  .        qscore_
+00045770: 6c69 7374 203d 205b 6174 6f6d 2e62 6661  list = [atom.bfa
+00045780: 6374 6f72 2066 6f72 2061 746f 6d20 696e  ctor for atom in
+00045790: 2071 7363 6f72 6570 6462 2e67 6574 5f61   qscorepdb.get_a
+000457a0: 746f 6d73 2829 2069 6620 6174 6f6d 2e62  toms() if atom.b
+000457b0: 6661 6374 6f72 203e 2031 2e30 5d0a 2020  factor > 1.0].  
+000457c0: 2020 2020 2020 7072 6f74 6569 6e5f 7173        protein_qs
+000457d0: 636f 7265 7320 3d20 5b5d 0a20 2020 2020  cores = [].     
+000457e0: 2020 2066 6f72 2061 746f 6d20 696e 2071     for atom in q
+000457f0: 7363 6f72 6570 6462 2e67 6574 5f61 746f  scorepdb.get_ato
+00045800: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
+00045810: 2020 6966 2061 746f 6d2e 6e61 6d65 2e73    if atom.name.s
+00045820: 7461 7274 7377 6974 6828 2748 2729 206f  tartswith('H') o
+00045830: 7220 6174 6f6d 2e67 6574 5f70 6172 656e  r atom.get_paren
+00045840: 7428 292e 7265 736e 616d 6520 3d3d 2027  t().resname == '
+00045850: 484f 4827 206f 7220 6174 6f6d 2e62 6661  HOH' or atom.bfa
+00045860: 6374 6f72 203e 3d20 312e 303a 0a20 2020  ctor >= 1.0:.   
+00045870: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+00045880: 7469 6e75 650a 2020 2020 2020 2020 2020  tinue.          
+00045890: 2020 7072 6f74 6569 6e5f 7173 636f 7265    protein_qscore
+000458a0: 732e 6170 7065 6e64 2861 746f 6d2e 6266  s.append(atom.bf
+000458b0: 6163 746f 7229 0a20 2020 2020 2020 2061  actor).        a
+000458c0: 7665 7261 6765 5f71 7363 6f72 6520 3d20  verage_qscore = 
+000458d0: 726f 756e 6428 7375 6d28 7072 6f74 6569  round(sum(protei
+000458e0: 6e5f 7173 636f 7265 7329 202f 206c 656e  n_qscores) / len
+000458f0: 2870 726f 7465 696e 5f71 7363 6f72 6573  (protein_qscores
+00045900: 292c 2033 290a 2020 2020 2020 2020 6966  ), 3).        if
+00045910: 2071 7363 6f72 655f 6c69 7374 3a0a 2020   qscore_list:.  
+00045920: 2020 2020 2020 2020 2020 6d69 6e5f 7173            min_qs
+00045930: 636f 7265 203d 206d 696e 2871 7363 6f72  core = min(qscor
+00045940: 655f 6c69 7374 290a 2020 2020 2020 2020  e_list).        
+00045950: 2020 2020 6d61 785f 7173 636f 7265 203d      max_qscore =
+00045960: 206d 6178 2871 7363 6f72 655f 6c69 7374   max(qscore_list
+00045970: 290a 2020 2020 2020 2020 666f 7220 6368  ).        for ch
+00045980: 6169 6e20 696e 2071 7363 6f72 6570 6462  ain in qscorepdb
+00045990: 2e67 6574 5f63 6861 696e 7328 293a 0a20  .get_chains():. 
+000459a0: 2020 2020 2020 2020 2020 2063 7572 6368             curch
+000459b0: 6169 6e5f 6e61 6d65 203d 2063 6861 696e  ain_name = chain
+000459c0: 2e69 640a 2020 2020 2020 2020 2020 2020  .id.            
+000459d0: 6375 7263 6861 696e 5f71 7363 6f72 6520  curchain_qscore 
+000459e0: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
+000459f0: 2066 6f72 2061 746f 6d20 696e 2063 6861   for atom in cha
+00045a00: 696e 2e67 6574 5f61 746f 6d73 2829 3a0a  in.get_atoms():.
+00045a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00045a20: 6966 2061 746f 6d2e 6e61 6d65 2e73 7461  if atom.name.sta
+00045a30: 7274 7377 6974 6828 2748 2729 206f 7220  rtswith('H') or 
+00045a40: 6174 6f6d 2e67 6574 5f70 6172 656e 7428  atom.get_parent(
+00045a50: 292e 7265 736e 616d 6520 3d3d 2027 484f  ).resname == 'HO
+00045a60: 4827 206f 7220 6174 6f6d 2e62 6661 6374  H' or atom.bfact
+00045a70: 6f72 203e 3d20 312e 303a 0a20 2020 2020  or >= 1.0:.     
+00045a80: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00045a90: 6f6e 7469 6e75 650a 2020 2020 2020 2020  ontinue.        
+00045aa0: 2020 2020 2020 2020 6375 7263 6861 696e          curchain
+00045ab0: 5f71 7363 6f72 652e 6170 7065 6e64 2861  _qscore.append(a
+00045ac0: 746f 6d2e 6266 6163 746f 7229 0a20 2020  tom.bfactor).   
+00045ad0: 2020 2020 2020 2020 2061 7665 7261 6765           average
+00045ae0: 6375 7263 6861 696e 5f71 7363 6f72 6520  curchain_qscore 
+00045af0: 3d20 726f 756e 6428 7375 6d28 6375 7263  = round(sum(curc
+00045b00: 6861 696e 5f71 7363 6f72 6529 202f 206c  hain_qscore) / l
+00045b10: 656e 2863 7572 6368 6169 6e5f 7173 636f  en(curchain_qsco
+00045b20: 7265 292c 2033 290a 2020 2020 2020 2020  re), 3).        
+00045b30: 2020 2020 6174 6f6d 735f 696e 6368 6169      atoms_inchai
+00045b40: 6e20 3d20 300a 2020 2020 2020 2020 2020  n = 0.          
+00045b50: 2020 7173 636f 7265 5f69 6e63 6861 696e    qscore_inchain
+00045b60: 203d 2030 2e0a 2020 2020 2020 2020 2020   = 0..          
+00045b70: 2020 666f 7220 7265 7369 6475 6520 696e    for residue in
+00045b80: 2063 6861 696e 3a0a 2020 2020 2020 2020   chain:.        
+00045b90: 2020 2020 2020 2020 6375 7272 6573 5f6e          curres_n
+00045ba0: 616d 6520 3d20 7265 7369 6475 652e 7265  ame = residue.re
+00045bb0: 736e 616d 650a 2020 2020 2020 2020 2020  sname.          
+00045bc0: 2020 2020 2020 6966 2063 7572 7265 735f        if curres_
+00045bd0: 6e61 6d65 203d 3d20 2748 4f48 273a 0a20  name == 'HOH':. 
+00045be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00045bf0: 2020 2063 6f6e 7469 6e75 650a 2020 2020     continue.    
+00045c00: 2020 2020 2020 2020 2020 2020 6375 7272              curr
+00045c10: 6573 5f69 6420 3d20 7265 7369 6475 652e  es_id = residue.
+00045c20: 6964 5b31 5d0a 2020 2020 2020 2020 2020  id[1].          
+00045c30: 2020 2020 2020 6174 6f6d 735f 696e 7265        atoms_inre
+00045c40: 7369 6475 6520 3d20 300a 2020 2020 2020  sidue = 0.      
+00045c50: 2020 2020 2020 2020 2020 7173 636f 7265            qscore
+00045c60: 5f69 6e72 6573 6964 7565 203d 2030 2e0a  _inresidue = 0..
+00045c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00045c80: 666f 7220 6174 6f6d 2069 6e20 7265 7369  for atom in resi
+00045c90: 6475 653a 0a20 2020 2020 2020 2020 2020  due:.           
+00045ca0: 2020 2020 2020 2020 2069 6620 6174 6f6d           if atom
+00045cb0: 2e6e 616d 652e 7374 6172 7473 7769 7468  .name.startswith
+00045cc0: 2827 4827 2920 6f72 2061 746f 6d2e 6765  ('H') or atom.ge
+00045cd0: 745f 7061 7265 6e74 2829 2e72 6573 6e61  t_parent().resna
+00045ce0: 6d65 203d 3d20 2748 4f48 2720 6f72 2061  me == 'HOH' or a
+00045cf0: 746f 6d2e 6266 6163 746f 7220 3e3d 2031  tom.bfactor >= 1
+00045d00: 2e30 3a0a 2020 2020 2020 2020 2020 2020  .0:.            
+00045d10: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+00045d20: 696e 7565 0a20 2020 2020 2020 2020 2020  inue.           
+00045d30: 2020 2020 2020 2020 2061 746f 6d73 5f69           atoms_i
+00045d40: 6e63 6861 696e 202b 3d20 310a 2020 2020  nchain += 1.    
+00045d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00045d60: 6174 6f6d 735f 696e 7265 7369 6475 6520  atoms_inresidue 
+00045d70: 2b3d 2031 0a20 2020 2020 2020 2020 2020  += 1.           
+00045d80: 2020 2020 2020 2020 2063 7572 6174 6f6d           curatom
+00045d90: 5f71 7363 6f72 6520 3d20 6174 6f6d 2e62  _qscore = atom.b
+00045da0: 6661 6374 6f72 0a20 2020 2020 2020 2020  factor.         
+00045db0: 2020 2020 2020 2020 2020 2071 7363 6f72             qscor
+00045dc0: 655f 696e 6368 6169 6e20 2b3d 2063 7572  e_inchain += cur
+00045dd0: 6174 6f6d 5f71 7363 6f72 650a 2020 2020  atom_qscore.    
+00045de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00045df0: 7173 636f 7265 5f69 6e72 6573 6964 7565  qscore_inresidue
+00045e00: 202b 3d20 6375 7261 746f 6d5f 7173 636f   += curatom_qsco
+00045e10: 7265 0a20 2020 2020 2020 2020 2020 2020  re.             
+00045e20: 2020 2063 7572 7265 735f 7173 636f 7265     curres_qscore
+00045e30: 203d 2072 6f75 6e64 2871 7363 6f72 655f   = round(qscore_
+00045e40: 696e 7265 7369 6475 6520 2f20 6174 6f6d  inresidue / atom
+00045e50: 735f 696e 7265 7369 6475 652c 2033 290a  s_inresidue, 3).
+00045e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00045e70: 6966 2063 7572 7265 735f 7173 636f 7265  if curres_qscore
+00045e80: 203e 2031 2e30 3a0a 2020 2020 2020 2020   > 1.0:.        
+00045e90: 2020 2020 2020 2020 2020 2020 6966 206d              if m
+00045ea0: 696e 5f71 7363 6f72 6520 3d3d 206d 6178  in_qscore == max
+00045eb0: 5f71 7363 6f72 653a 0a20 2020 2020 2020  _qscore:.       
+00045ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00045ed0: 2063 7572 7265 735f 636f 6c6f 7220 3d20   curres_color = 
+00045ee0: 2723 3030 3030 3030 270a 2020 2020 2020  '#000000'.      
+00045ef0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00045f00: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00045f10: 2020 2020 2020 2020 2020 2020 7363 616c              scal
+00045f20: 6564 5f71 7363 6f72 6520 3d20 2863 7572  ed_qscore = (cur
+00045f30: 7265 735f 7173 636f 7265 202d 206d 696e  res_qscore - min
+00045f40: 5f71 7363 6f72 6529 202f 2028 6d61 785f  _qscore) / (max_
+00045f50: 7173 636f 7265 202d 206d 696e 5f71 7363  qscore - min_qsc
+00045f60: 6f72 6529 0a20 2020 2020 2020 2020 2020  ore).           
+00045f70: 2020 2020 2020 2020 2020 2020 2063 7572               cur
+00045f80: 7265 735f 636f 6c6f 7220 3d20 7365 6c66  res_color = self
+00045f90: 2e5f 5f66 6c6f 6174 6f68 6578 5f61 626f  .__floatohex_abo
+00045fa0: 7665 6f6e 6528 5b73 6361 6c65 645f 7173  veone([scaled_qs
+00045fb0: 636f 7265 5d29 5b30 5d0a 2020 2020 2020  core])[0].      
+00045fc0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00045fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00045fe0: 2020 2020 6375 7272 6573 5f63 6f6c 6f72      curres_color
+00045ff0: 203d 2073 656c 662e 5f5f 666c 6f61 746f   = self.__floato
+00046000: 6865 7828 5b63 7572 7265 735f 7173 636f  hex([curres_qsco
+00046010: 7265 5d29 5b30 5d0a 0a20 2020 2020 2020  re])[0]..       
+00046020: 2020 2020 2020 2020 2069 636f 6465 203d           icode =
+00046030: 2072 6573 6964 7565 2e69 645b 325d 0a20   residue.id[2]. 
+00046040: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00046050: 6620 6963 6f64 653a 0a20 2020 2020 2020  f icode:.       
+00046060: 2020 2020 2020 2020 2020 2020 2063 7572               cur
+00046070: 7265 735f 7374 7269 6e67 203d 2027 7b7d  res_string = '{}
+00046080: 3a7b 7d7b 7d7b 7d27 2e66 6f72 6d61 7428  :{}{}{}'.format(
+00046090: 6375 7263 6861 696e 5f6e 616d 652c 2063  curchain_name, c
+000460a0: 7572 7265 735f 6964 2c20 6963 6f64 652c  urres_id, icode,
+000460b0: 2063 7572 7265 735f 6e61 6d65 290a 2020   curres_name).  
+000460c0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+000460d0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000460e0: 2020 2020 2020 2020 6375 7272 6573 5f73          curres_s
+000460f0: 7472 696e 6720 3d20 277b 7d3a 7b7d 7b7d  tring = '{}:{}{}
+00046100: 272e 666f 726d 6174 2863 7572 6368 6169  '.format(curchai
+00046110: 6e5f 6e61 6d65 2c20 6375 7272 6573 5f69  n_name, curres_i
+00046120: 642c 2063 7572 7265 735f 6e61 6d65 290a  d, curres_name).
+00046130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00046140: 7265 7369 6475 6573 2e61 7070 656e 6428  residues.append(
+00046150: 6375 7272 6573 5f73 7472 696e 6729 0a20  curres_string). 
+00046160: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00046170: 6f6c 6f72 732e 6170 7065 6e64 2863 7572  olors.append(cur
+00046180: 7265 735f 636f 6c6f 7229 0a20 2020 2020  res_color).     
+00046190: 2020 2020 2020 2020 2020 2071 7363 6f72             qscor
+000461a0: 6573 2e61 7070 656e 6428 6375 7272 6573  es.append(curres
+000461b0: 5f71 7363 6f72 6529 0a20 2020 2020 2020  _qscore).       
+000461c0: 2020 2020 2061 7665 7261 6765 7173 636f       averageqsco
+000461d0: 7265 5f69 6e63 6f6c 6f72 203d 2073 656c  re_incolor = sel
+000461e0: 662e 5f5f 666c 6f61 746f 6865 7828 5b61  f.__floatohex([a
+000461f0: 7665 7261 6765 6375 7263 6861 696e 5f71  veragecurchain_q
+00046200: 7363 6f72 655d 295b 305d 0a20 2020 2020  score])[0].     
+00046210: 2020 2020 2020 2063 6861 696e 5f71 7363         chain_qsc
+00046220: 6f72 655b 6375 7263 6861 696e 5f6e 616d  ore[curchain_nam
+00046230: 655d 203d 207b 2776 616c 7565 273a 2061  e] = {'value': a
+00046240: 7665 7261 6765 6375 7263 6861 696e 5f71  veragecurchain_q
+00046250: 7363 6f72 652c 2027 636f 6c6f 7227 3a20  score, 'color': 
+00046260: 6176 6572 6167 6571 7363 6f72 655f 696e  averageqscore_in
+00046270: 636f 6c6f 727d 0a0a 2020 2020 2020 2020  color}..        
+00046280: 7464 6963 7420 3d20 4f72 6465 7265 6444  tdict = OrderedD
+00046290: 6963 7428 5b0a 2020 2020 2020 2020 2020  ict([.          
+000462a0: 2020 2827 6176 6572 6167 6571 7363 6f72    ('averageqscor
+000462b0: 6527 2c20 6176 6572 6167 655f 7173 636f  e', average_qsco
+000462c0: 7265 292c 2028 2763 6f6c 6f72 272c 2063  re), ('color', c
+000462d0: 6f6c 6f72 7329 2c0a 2020 2020 2020 2020  olors),.        
+000462e0: 2020 2020 2827 696e 636c 7573 696f 6e27      ('inclusion'
+000462f0: 2c20 7173 636f 7265 7329 2c0a 2020 2020  , qscores),.    
+00046300: 2020 2020 2020 2020 2827 7265 7369 6475          ('residu
+00046310: 6527 2c20 7265 7369 6475 6573 292c 0a20  e', residues),. 
+00046320: 2020 2020 2020 2020 2020 2028 2763 6861             ('cha
+00046330: 696e 7173 636f 7265 272c 2063 6861 696e  inqscore', chain
+00046340: 5f71 7363 6f72 6529 0a0a 2020 2020 2020  _qscore)..      
+00046350: 2020 5d29 0a0a 2020 2020 2020 2020 7265    ])..        re
+00046360: 7375 6c74 6469 6374 203d 204f 7264 6572  sultdict = Order
+00046370: 6564 4469 6374 285b 2827 6e61 6d65 272c  edDict([('name',
+00046380: 206f 7267 6d6f 6465 6c29 2c20 2827 6461   orgmodel), ('da
+00046390: 7461 272c 2074 6469 6374 295d 290a 0a20  ta', tdict)]).. 
+000463a0: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+000463b0: 7375 6c74 6469 6374 0a0a 2020 2020 6465  sultdict..    de
+000463c0: 6620 7064 6274 6f71 6469 6374 2873 656c  f pdbtoqdict(sel
+000463d0: 662c 2071 7363 6f72 6570 6462 2c20 6f72  f, qscorepdb, or
+000463e0: 676d 6f64 656c 293a 0a20 2020 2020 2020  gmodel):.       
+000463f0: 2022 2222 0a0a 2020 2020 2020 2020 2020   """..          
+00046400: 2020 4769 7665 6e20 7064 6220 6269 6f70    Given pdb biop
+00046410: 7974 686f 6e20 6f62 6a65 6374 2061 6e64  ython object and
+00046420: 2063 6f6e 7665 7274 2074 6f20 6120 6469   convert to a di
+00046430: 6374 2077 6869 6368 2063 6f6e 7461 696e  ct which contain
+00046440: 7320 616c 6c20 6461 7461 2066 6f72 204a  s all data for J
+00046450: 534f 4e0a 0a20 2020 2020 2020 203a 7265  SON..        :re
+00046460: 7475 726e 3a20 4449 4354 2063 6f6e 7461  turn: DICT conta
+00046470: 696e 7320 616c 6c20 6461 7461 0a20 2020  ins all data.   
+00046480: 2020 2020 2022 2222 0a0a 2020 2020 2020       """..      
+00046490: 2020 616c 6c6b 6579 7320 3d20 5b5d 0a20    allkeys = []. 
+000464a0: 2020 2020 2020 2061 6c6c 7661 6c75 6573         allvalues
+000464b0: 203d 205b 5d0a 2020 2020 2020 2020 7072   = [].        pr
+000464c0: 6572 6573 6964 203d 2030 0a20 2020 2020  eresid = 0.     
+000464d0: 2020 2070 7265 6368 6169 6e20 3d20 2727     prechain = ''
+000464e0: 0a20 2020 2020 2020 2061 6970 7265 6368  .        aiprech
+000464f0: 6169 6e20 3d20 2727 0a20 2020 2020 2020  ain = ''.       
+00046500: 2070 7265 7265 7320 3d20 2727 0a20 2020   preres = ''.   
+00046510: 2020 2020 2072 6573 636f 756e 7420 3d20       rescount = 
+00046520: 310a 2020 2020 2020 2020 6174 6f6d 636f  1.        atomco
+00046530: 756e 7420 3d20 300a 2020 2020 2020 2020  unt = 0.        
+00046540: 6368 6169 6e61 746f 6d63 6f75 6e74 203d  chainatomcount =
+00046550: 2030 0a20 2020 2020 2020 2072 6573 6f63   0.        resoc
+00046560: 6320 3d20 302e 0a20 2020 2020 2020 2061  c = 0..        a
+00046570: 6c6c 6174 6f6d 7320 3d20 300a 2020 2020  llatoms = 0.    
+00046580: 2020 2020 616c 6c6f 6363 203d 2030 2e0a      allocc = 0..
+00046590: 2020 2020 2020 2020 6368 6169 6e6f 6363          chainocc
+000465a0: 203d 2030 2e0a 2020 2020 2020 2020 6368   = 0..        ch
+000465b0: 6169 6e63 6f75 6e74 203d 2031 0a20 2020  aincount = 1.   
+000465c0: 2020 2020 2063 6861 696e 6174 6f6d 7320       chainatoms 
+000465d0: 3d20 300a 2020 2020 2020 2020 6368 6169  = 0.        chai
+000465e0: 6e71 7363 6f72 6520 3d20 7b7d 0a20 2020  nqscore = {}.   
+000465f0: 2020 2020 2066 6f72 2061 746f 6d20 696e       for atom in
+00046600: 2071 7363 6f72 6570 6462 3a0a 2020 2020   qscorepdb:.    
+00046610: 2020 2020 2020 2020 6966 206e 6f74 2061          if not a
+00046620: 746f 6d2e 6174 6f6d 5f6e 616d 652e 7374  tom.atom_name.st
+00046630: 6172 7473 7769 7468 2827 4827 293a 0a20  artswith('H'):. 
+00046640: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00046650: 6c6c 6174 6f6d 7320 2b3d 2031 0a20 2020  llatoms += 1.   
+00046660: 2020 2020 2020 2020 2020 2020 2061 6c6c               all
+00046670: 6f63 6320 2b3d 2061 746f 6d2e 7465 6d70  occ += atom.temp
+00046680: 5f66 6163 0a20 2020 2020 2020 2020 2020  _fac.           
+00046690: 2020 2020 2061 746f 6d63 6f75 6e74 202b       atomcount +
+000466a0: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
+000466b0: 2020 2020 6368 6169 6e61 746f 6d63 6f75      chainatomcou
+000466c0: 6e74 202b 3d20 310a 2020 2020 2020 2020  nt += 1.        
+000466d0: 2020 2020 2020 2020 6966 2028 6174 6f6d          if (atom
+000466e0: 636f 756e 7420 3d3d 2031 2920 6f72 2028  count == 1) or (
+000466f0: 6174 6f6d 2e72 6573 5f6e 6f20 3d3d 2070  atom.res_no == p
+00046700: 7265 7265 7369 6420 616e 6420 6174 6f6d  reresid and atom
+00046710: 2e63 6861 696e 203d 3d20 7072 6563 6861  .chain == precha
+00046720: 696e 293a 0a20 2020 2020 2020 2020 2020  in):.           
+00046730: 2020 2020 2020 2020 2070 7265 7265 7369           preresi
+00046740: 6420 3d20 6174 6f6d 2e72 6573 5f6e 6f0a  d = atom.res_no.
+00046750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00046760: 2020 2020 7072 6563 6861 696e 203d 2061      prechain = a
+00046770: 746f 6d2e 6368 6169 6e0a 2020 2020 2020  tom.chain.      
+00046780: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+00046790: 6572 6573 203d 2061 746f 6d2e 7265 730a  eres = atom.res.
+000467a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000467b0: 2020 2020 7265 736f 6363 202b 3d20 6174      resocc += at
+000467c0: 6f6d 2e74 656d 705f 6661 630a 2020 2020  om.temp_fac.    
+000467d0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+000467e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000467f0: 2020 2020 2020 6174 6f6d 636f 756e 7420        atomcount 
+00046800: 2d3d 2031 0a20 2020 2020 2020 2020 2020  -= 1.           
+00046810: 2020 2020 2020 2020 206b 6579 7374 7220           keystr 
+00046820: 3d20 7072 6563 6861 696e 202b 2027 3a27  = prechain + ':'
+00046830: 202b 2073 7472 2870 7265 7265 7369 6429   + str(preresid)
+00046840: 202b 2070 7265 7265 730a 2020 2020 2020   + preres.      
+00046850: 2020 2020 2020 2020 2020 2020 2020 616c                al
+00046860: 6c6b 6579 732e 6170 7065 6e64 286b 6579  lkeys.append(key
+00046870: 7374 7229 0a20 2020 2020 2020 2020 2020  str).           
+00046880: 2020 2020 2020 2020 2072 6573 6f63 6376           resoccv
+00046890: 616c 7565 203d 2072 6573 6f63 6320 2f20  alue = resocc / 
+000468a0: 6174 6f6d 636f 756e 740a 2020 2020 2020  atomcount.      
+000468b0: 2020 2020 2020 2020 2020 2020 2020 616c                al
+000468c0: 6c76 616c 7565 732e 6170 7065 6e64 2872  lvalues.append(r
+000468d0: 6573 6f63 6376 616c 7565 290a 2020 2020  esoccvalue).    
 000468e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000468f0: 2023 2066 702e 7772 6974 6528 226f 7065   # fp.write("ope
-00046900: 6e20 2220 2b20 7374 7228 7064 626d 6f64  n " + str(pdbmod
-00046910: 656c 6e61 6d65 2920 2b20 2220 666f 726d  elname) + " form
-00046920: 6174 2070 6462 2220 2b20 275c 6e27 290a  at pdb" + '\n').
-00046930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046940: 2020 2020 2020 2020 6670 2e77 7269 7465          fp.write
-00046950: 2827 7368 6f77 2073 656c 4174 6f6d 7320  ('show selAtoms 
-00046960: 7269 6262 6f6e 7327 202b 2027 5c6e 2729  ribbons' + '\n')
-00046970: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00046980: 2020 2020 2020 2020 2066 702e 7772 6974           fp.writ
-00046990: 6528 2768 6964 6520 7365 6c41 746f 6d73  e('hide selAtoms
-000469a0: 2720 2b20 275c 6e27 290a 0a20 2020 2020  ' + '\n')..     
-000469b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000469c0: 2020 2066 6f72 2028 636f 6c6f 722c 2072     for (color, r
-000469d0: 6573 6964 7565 2c20 7173 636f 7265 2920  esidue, qscore) 
-000469e0: 696e 207a 6970 2863 6f6c 6f72 732c 2072  in zip(colors, r
-000469f0: 6573 6964 7565 732c 2071 7363 6f72 6573  esidues, qscores
-00046a00: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00046a10: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00046a20: 6861 696e 2c20 7265 7374 6d70 203d 2072  hain, restmp = r
-00046a30: 6573 6964 7565 2e73 706c 6974 2827 3a27  esidue.split(':'
-00046a40: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00046a50: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00046a60: 4e6f 7420 7375 7265 2069 6620 616c 6c20  Not sure if all 
-00046a70: 7468 6520 6c65 7474 6572 7320 7368 6f75  the letters shou
-00046a80: 6c64 2062 6520 7265 706c 6163 6564 0a20  ld be replaced. 
-00046a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046aa0: 2020 2020 2020 2020 2020 2023 2031 7374             # 1st
-00046ab0: 2077 6179 206f 6620 6765 7474 696e 6720   way of getting 
-00046ac0: 7265 735f 6964 0a20 2020 2020 2020 2020  res_id.         
-00046ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046ae0: 2020 2023 2072 6573 5f69 6420 3d20 7265     # res_id = re
-00046af0: 2e73 7562 2822 5c44 222c 2022 222c 2072  .sub("\D", "", r
-00046b00: 6573 746d 7029 0a20 2020 2020 2020 2020  estmp).         
-00046b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046b20: 2020 2023 2032 6e64 2077 6179 206f 6620     # 2nd way of 
-00046b30: 6765 7474 696e 6720 7265 730a 2020 2020  getting res.    
-00046b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046b50: 2020 2020 2020 2020 7265 735f 6964 203d          res_id =
-00046b60: 2072 652e 6669 6e64 616c 6c28 7227 2d3f   re.findall(r'-?
-00046b70: 5c64 2b27 2c20 7265 7374 6d70 295b 305d  \d+', restmp)[0]
-00046b80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00046b90: 2020 2020 2020 2020 2020 2020 2066 702e               fp.
-00046ba0: 7772 6974 6528 0a20 2020 2020 2020 2020  write(.         
-00046bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046bc0: 2020 2020 2020 2027 636f 6c6f 7220 2f27         'color /'
-00046bd0: 202b 2063 6861 696e 202b 2027 3a27 202b   + chain + ':' +
-00046be0: 2072 6573 5f69 6420 2b20 2720 2720 2b20   res_id + ' ' + 
-00046bf0: 636f 6c6f 7220 2b20 275c 6e27 0a20 2020  color + '\n'.   
-00046c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046c10: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00046c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046c30: 2020 2020 2020 2069 6620 7173 636f 7265         if qscore
-00046c40: 203e 2031 2e30 3a0a 2020 2020 2020 2020   > 1.0:.        
+000468f0: 7072 6572 6573 6964 203d 2061 746f 6d2e  preresid = atom.
+00046900: 7265 735f 6e6f 0a20 2020 2020 2020 2020  res_no.         
+00046910: 2020 2020 2020 2020 2020 2070 7265 6368             prech
+00046920: 6169 6e20 3d20 6174 6f6d 2e63 6861 696e  ain = atom.chain
+00046930: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00046940: 2020 2020 2070 7265 7265 7320 3d20 6174       preres = at
+00046950: 6f6d 2e72 6573 0a20 2020 2020 2020 2020  om.res.         
+00046960: 2020 2020 2020 2020 2020 2061 746f 6d63             atomc
+00046970: 6f75 6e74 203d 2031 0a20 2020 2020 2020  ount = 1.       
+00046980: 2020 2020 2020 2020 2020 2020 2072 6573               res
+00046990: 636f 756e 7420 2b3d 2031 0a20 2020 2020  count += 1.     
+000469a0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000469b0: 6573 6f63 6320 3d20 6174 6f6d 2e74 656d  esocc = atom.tem
+000469c0: 705f 6661 630a 2020 2020 2020 2020 2020  p_fac.          
+000469d0: 2020 2020 2020 6966 2028 6368 6169 6e61        if (chaina
+000469e0: 746f 6d63 6f75 6e74 203d 3d20 3129 206f  tomcount == 1) o
+000469f0: 7220 2861 746f 6d2e 6368 6169 6e20 3d3d  r (atom.chain ==
+00046a00: 2061 6970 7265 6368 6169 6e29 3a0a 2020   aiprechain):.  
+00046a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00046a20: 2020 6368 6169 6e61 746f 6d73 202b 3d20    chainatoms += 
+00046a30: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
+00046a40: 2020 2020 2020 6169 7072 6563 6861 696e        aiprechain
+00046a50: 203d 2061 746f 6d2e 6368 6169 6e0a 2020   = atom.chain.  
+00046a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00046a70: 2020 6368 6169 6e6f 6363 202b 3d20 6174    chainocc += at
+00046a80: 6f6d 2e74 656d 705f 6661 630a 2020 2020  om.temp_fac.    
+00046a90: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00046aa0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00046ab0: 2020 2020 2020 7176 616c 7565 203d 2072        qvalue = r
+00046ac0: 6f75 6e64 2863 6861 696e 6f63 6320 2f20  ound(chainocc / 
+00046ad0: 6368 6169 6e61 746f 6d73 2c20 3329 0a20  chainatoms, 3). 
+00046ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00046af0: 2020 2071 636f 6c6f 7220 3d20 7365 6c66     qcolor = self
+00046b00: 2e5f 5f66 6c6f 6174 6f68 6578 285b 7176  .__floatohex([qv
+00046b10: 616c 7565 5d29 5b30 5d0a 2020 2020 2020  alue])[0].      
+00046b20: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00046b30: 6368 6169 6e71 7363 6f72 655b 6169 7072  chainqscore[aipr
+00046b40: 6563 6861 696e 5d20 3d20 7b27 7661 6c75  echain] = {'valu
+00046b50: 6527 3a20 7176 616c 7565 2c20 2763 6f6c  e': qvalue, 'col
+00046b60: 6f72 273a 2071 636f 6c6f 727d 0a20 2020  or': qcolor}.   
+00046b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00046b80: 2069 6620 6169 7072 6563 6861 696e 2069   if aiprechain i
+00046b90: 6e20 6368 6169 6e71 7363 6f72 652e 6b65  n chainqscore.ke
+00046ba0: 7973 2829 3a0a 2020 2020 2020 2020 2020  ys():.          
+00046bb0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00046bc0: 6368 6169 6e71 7363 6f72 655b 7072 6563  chainqscore[prec
+00046bd0: 6861 696e 202b 2027 5f27 202b 2073 7472  hain + '_' + str
+00046be0: 2861 6976 616c 7565 295d 203d 207b 2776  (aivalue)] = {'v
+00046bf0: 616c 7565 273a 2061 6976 616c 7565 2c20  alue': aivalue, 
+00046c00: 2763 6f6c 6f72 273a 2061 6963 6f6c 6f72  'color': aicolor
+00046c10: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+00046c20: 2020 2020 2020 2020 2020 7061 7373 0a20            pass. 
+00046c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00046c40: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
 00046c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046c60: 2020 2020 2020 2020 6670 2e77 7269 7465          fp.write
-00046c70: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00046c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046c90: 2020 2020 2020 2773 686f 7720 2f27 202b        'show /' +
-00046ca0: 2063 6861 696e 202b 2027 3a27 202b 2072   chain + ':' + r
-00046cb0: 6573 5f69 6420 2b20 2720 6174 6f6d 7327  es_id + ' atoms'
-00046cc0: 202b 2027 5c6e 270a 2020 2020 2020 2020   + '\n'.        
-00046cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046ce0: 2020 2020 2020 2020 2020 2020 2773 7479              'sty
-00046cf0: 6c65 202f 2720 2b20 6368 6169 6e20 2b20  le /' + chain + 
-00046d00: 273a 2720 2b20 7265 735f 6964 202b 2027  ':' + res_id + '
-00046d10: 2073 7469 636b 2720 2b20 275c 6e27 0a20   stick' + '\n'. 
-00046d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046d30: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00046d40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00046d50: 2020 2020 2020 2020 2066 702e 7772 6974           fp.writ
-00046d60: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
-00046d70: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00046d80: 7365 7420 6267 436f 6c6f 7220 7768 6974  set bgColor whit
-00046d90: 6522 202b 2027 5c6e 270a 2020 2020 2020  e" + '\n'.      
-00046da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046db0: 2020 2020 2020 226c 6967 6874 696e 6720        "lighting 
-00046dc0: 736f 6674 2220 2b20 275c 6e27 0a20 2020  soft" + '\n'.   
-00046dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046de0: 2020 2020 2020 2020 2022 7669 6577 2063           "view c
-00046df0: 6f66 7220 5472 7565 2220 2b20 275c 6e27  ofr True" + '\n'
-00046e00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00046e10: 2020 2020 2020 2020 2020 2020 2022 7361               "sa
-00046e20: 7665 2022 202b 2073 7472 2873 7572 6661  ve " + str(surfa
-00046e30: 6365 666e 2920 2b20 225f 7a71 7363 6f72  cefn) + "_zqscor
-00046e40: 6573 7572 6661 6365 2e6a 7065 6722 202b  esurface.jpeg" +
-00046e50: 2022 2073 7570 6572 7361 6d70 6c65 2033   " supersample 3
-00046e60: 2077 6964 7468 2031 3230 3020 6865 6967   width 1200 heig
-00046e70: 6874 2031 3230 3022 202b 2027 5c6e 270a  ht 1200" + '\n'.
-00046e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046e90: 2020 2020 2020 2020 2020 2020 2274 7572              "tur
-00046ea0: 6e20 7820 2d39 3022 202b 2027 5c6e 270a  n x -90" + '\n'.
-00046eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046ec0: 2020 2020 2020 2020 2020 2020 2274 7572              "tur
-00046ed0: 6e20 7920 2d39 3022 202b 2027 5c6e 270a  n y -90" + '\n'.
-00046ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046ef0: 2020 2020 2020 2020 2020 2020 2276 6965              "vie
-00046f00: 7720 636f 6672 2054 7275 6522 202b 2027  w cofr True" + '
-00046f10: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
-00046f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046f30: 2273 6176 6520 2220 2b20 7374 7228 7375  "save " + str(su
-00046f40: 7266 6163 6566 6e29 202b 2022 5f78 7173  rfacefn) + "_xqs
-00046f50: 636f 7265 7375 7266 6163 652e 6a70 6567  coresurface.jpeg
-00046f60: 2220 2b20 2220 7375 7065 7273 616d 706c  " + " supersampl
-00046f70: 6520 3320 7769 6474 6820 3132 3030 2068  e 3 width 1200 h
-00046f80: 6569 6768 7420 3132 3030 2220 2b20 275c  eight 1200" + '\
-00046f90: 6e27 0a20 2020 2020 2020 2020 2020 2020  n'.             
-00046fa0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00046fb0: 7669 6577 206f 7269 656e 7422 202b 2027  view orient" + '
-00046fc0: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
-00046fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00046fe0: 2274 7572 6e20 7820 3930 2220 2b20 275c  "turn x 90" + '\
-00046ff0: 6e27 0a20 2020 2020 2020 2020 2020 2020  n'.             
-00047000: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00047010: 7475 726e 207a 2039 3022 202b 2027 5c6e  turn z 90" + '\n
-00047020: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-00047030: 2020 2020 2020 2020 2020 2020 2020 2276                "v
-00047040: 6965 7720 636f 6672 2054 7275 6522 202b  iew cofr True" +
-00047050: 2027 5c6e 270a 2020 2020 2020 2020 2020   '\n'.          
-00047060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047070: 2020 2273 6176 6520 2220 2b20 7374 7228    "save " + str(
-00047080: 7375 7266 6163 6566 6e29 202b 2022 5f79  surfacefn) + "_y
-00047090: 7173 636f 7265 7375 7266 6163 652e 6a70  qscoresurface.jp
-000470a0: 6567 2220 2b20 2220 7375 7065 7273 616d  eg" + " supersam
-000470b0: 706c 6520 3320 7769 6474 6820 3132 3030  ple 3 width 1200
-000470c0: 2068 6569 6768 7420 3132 3030 2220 2b20   height 1200" + 
-000470d0: 275c 6e27 0a20 2020 2020 2020 2020 2020  '\n'.           
-000470e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000470f0: 2022 636c 6f73 6520 616c 6c22 202b 2022   "close all" + "
-00047100: 5c6e 220a 2020 2020 2020 2020 2020 2020  \n".            
-00047110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047120: 2265 7869 7422 0a20 2020 2020 2020 2020  "exit".         
-00047130: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00047140: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00047150: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00047160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047170: 2020 6966 206e 6f74 2062 696e 6469 7370    if not bindisp
-00047180: 6c61 793a 0a20 2020 2020 2020 2020 2020  lay:.           
-00047190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000471a0: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
-000471b0: 6b5f 6361 6c6c 286c 6f63 4348 494d 4552  k_call(locCHIMER
-000471c0: 4120 2b20 2220 2d2d 6f66 6673 6372 6565  A + " --offscree
-000471d0: 6e20 2d2d 6e6f 6775 6920 2220 2b20 7365  n --nogui " + se
-000471e0: 6c66 2e77 6f72 6b64 6972 202b 2063 6869  lf.workdir + chi
-000471f0: 6d65 7261 636d 642c 0a20 2020 2020 2020  meracmd,.       
-00047200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047220: 2020 2020 2020 2020 2020 2063 7764 3d73             cwd=s
-00047230: 656c 662e 776f 726b 6469 722c 2073 6865  elf.workdir, she
-00047240: 6c6c 3d54 7275 6529 0a20 2020 2020 2020  ll=True).       
-00047250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047260: 2020 2020 2070 7269 6e74 2827 436f 6c6f       print('Colo
-00047270: 7265 6420 6d6f 6465 6c73 2062 6173 6564  red models based
-00047280: 206f 6e20 5173 636f 7265 2077 6572 6520   on Qscore were 
-00047290: 7072 6f64 7563 6564 2e27 290a 2020 2020  produced.').    
-000472a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000472b0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000472c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000472d0: 2020 2020 2020 7375 6270 726f 6365 7373        subprocess
-000472e0: 2e63 6865 636b 5f63 616c 6c28 6c6f 6343  .check_call(locC
-000472f0: 4849 4d45 5241 202b 2022 2022 202b 2073  HIMERA + " " + s
-00047300: 656c 662e 776f 726b 6469 7220 2b20 6368  elf.workdir + ch
-00047310: 696d 6572 6163 6d64 2c20 6377 643d 7365  imeracmd, cwd=se
-00047320: 6c66 2e77 6f72 6b64 6972 2c0a 2020 2020  lf.workdir,.    
-00047330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047350: 2020 2020 2020 2020 2020 2020 2020 7368                sh
-00047360: 656c 6c3d 5472 7565 290a 2020 2020 2020  ell=True).      
-00047370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047380: 2020 2020 2020 7072 696e 7428 2743 6f6c        print('Col
-00047390: 6f72 6564 206d 6f64 656c 7320 6261 7365  ored models base
-000473a0: 6420 6f6e 2051 7363 6f72 6520 7765 7265  d on Qscore were
-000473b0: 2070 726f 6475 6365 642e 2729 0a20 2020   produced.').   
-000473c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000473d0: 2065 7863 6570 7420 7375 6270 726f 6365   except subproce
-000473e0: 7373 2e43 616c 6c65 6450 726f 6365 7373  ss.CalledProcess
-000473f0: 4572 726f 7220 6173 2073 7562 6572 723a  Error as suberr:
-00047400: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00047410: 2020 2020 2020 2020 2065 7272 203d 2027           err = '
-00047420: 5361 7669 6e67 206d 6f64 656c 207b 7d20  Saving model {} 
-00047430: 5173 636f 7265 2076 6965 7720 6572 726f  Qscore view erro
-00047440: 723a 207b 7d2e 272e 666f 726d 6174 286d  r: {}.'.format(m
-00047450: 6f64 656c 6e61 6d65 2c20 7375 6265 7272  odelname, suberr
-00047460: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00047470: 2020 2020 2020 2020 2020 6572 726c 6973            errlis
-00047480: 742e 6170 7065 6e64 2865 7272 290a 2020  t.append(err).  
-00047490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000474a0: 2020 2020 2020 7379 732e 7374 6465 7272        sys.stderr
-000474b0: 2e77 7269 7465 2865 7272 202b 2027 5c6e  .write(err + '\n
-000474c0: 2729 0a0a 2020 2020 2020 2020 2020 2020  ')..            
-000474d0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-000474e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000474f0: 2020 2020 2073 656c 662e 7363 616c 655f       self.scale_
-00047500: 7375 7266 6163 6576 6965 7728 290a 2020  surfaceview().  
+00046c60: 2063 6861 696e 7173 636f 7265 5b61 6970   chainqscore[aip
+00046c70: 7265 6368 6169 6e5d 203d 207b 2776 616c  rechain] = {'val
+00046c80: 7565 273a 2071 7661 6c75 652c 2027 636f  ue': qvalue, 'co
+00046c90: 6c6f 7227 3a20 7163 6f6c 6f72 7d0a 2020  lor': qcolor}.  
+00046ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00046cb0: 2020 6368 6169 6e61 746f 6d73 203d 2031    chainatoms = 1
+00046cc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00046cd0: 2020 2020 2063 6861 696e 6f63 6320 3d20       chainocc = 
+00046ce0: 6174 6f6d 2e74 656d 705f 6661 630a 2020  atom.temp_fac.  
+00046cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00046d00: 2020 6169 7072 6563 6861 696e 203d 2061    aiprechain = a
+00046d10: 746f 6d2e 6368 6169 6e0a 2020 2020 2020  tom.chain.      
+00046d20: 2020 2020 2020 2020 2020 2020 2020 6368                ch
+00046d30: 6169 6e63 6f75 6e74 202b 3d20 310a 0a20  aincount += 1.. 
+00046d40: 2020 2020 2020 2071 7661 6c75 6520 3d20         qvalue = 
+00046d50: 726f 756e 6428 6368 6169 6e6f 6363 202f  round(chainocc /
+00046d60: 2063 6861 696e 6174 6f6d 732c 2033 290a   chainatoms, 3).
+00046d70: 2020 2020 2020 2020 7163 6f6c 6f72 203d          qcolor =
+00046d80: 2073 656c 662e 5f5f 666c 6f61 746f 6865   self.__floatohe
+00046d90: 7828 5b71 7661 6c75 655d 295b 305d 0a20  x([qvalue])[0]. 
+00046da0: 2020 2020 2020 2069 6620 6169 7072 6563         if aiprec
+00046db0: 6861 696e 2069 6e20 6368 6169 6e71 7363  hain in chainqsc
+00046dc0: 6f72 652e 6b65 7973 2829 3a0a 2020 2020  ore.keys():.    
+00046dd0: 2020 2020 2020 2020 2320 6368 6169 6e71          # chainq
+00046de0: 7363 6f72 655b 7072 6563 6861 696e 202b  score[prechain +
+00046df0: 2027 5f27 202b 2073 7472 2861 6976 616c   '_' + str(aival
+00046e00: 7565 295d 203d 207b 2776 616c 7565 273a  ue)] = {'value':
+00046e10: 2061 6976 616c 7565 2c20 2763 6f6c 6f72   aivalue, 'color
+00046e20: 273a 2061 6963 6f6c 6f72 7d0a 2020 2020  ': aicolor}.    
+00046e30: 2020 2020 2020 2020 7061 7373 0a20 2020          pass.   
+00046e40: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00046e50: 2020 2020 2020 2063 6861 696e 7173 636f         chainqsco
+00046e60: 7265 5b61 6970 7265 6368 6169 6e5d 203d  re[aiprechain] =
+00046e70: 207b 2776 616c 7565 273a 2071 7661 6c75   {'value': qvalu
+00046e80: 652c 2027 636f 6c6f 7227 3a20 7163 6f6c  e, 'color': qcol
+00046e90: 6f72 7d0a 2020 2020 2020 2020 6c61 7374  or}.        last
+00046ea0: 7661 6c75 6520 3d20 7265 736f 6363 202f  value = resocc /
+00046eb0: 2061 746f 6d63 6f75 6e74 0a20 2020 2020   atomcount.     
+00046ec0: 2020 206b 6579 7374 7220 3d20 7072 6563     keystr = prec
+00046ed0: 6861 696e 202b 2027 3a27 202b 2073 7472  hain + ':' + str
+00046ee0: 2870 7265 7265 7369 6429 202b 2070 7265  (preresid) + pre
+00046ef0: 7265 730a 2020 2020 2020 2020 616c 6c6b  res.        allk
+00046f00: 6579 732e 6170 7065 6e64 286b 6579 7374  eys.append(keyst
+00046f10: 7229 0a20 2020 2020 2020 2061 6c6c 7661  r).        allva
+00046f20: 6c75 6573 2e61 7070 656e 6428 6c61 7374  lues.append(last
+00046f30: 7661 6c75 6529 0a20 2020 2020 2020 2063  value).        c
+00046f40: 6f6c 6f75 7273 203d 2073 656c 662e 5f5f  olours = self.__
+00046f50: 666c 6f61 746f 6865 7828 5b69 2066 6f72  floatohex([i for
+00046f60: 2069 2069 6e20 616c 6c76 616c 7565 735d   i in allvalues]
+00046f70: 290a 2020 2020 2020 2020 6176 6572 6167  ).        averag
+00046f80: 656f 6363 203d 2061 6c6c 6f63 6320 2f20  eocc = allocc / 
+00046f90: 616c 6c61 746f 6d73 0a0a 2020 2020 2020  allatoms..      
+00046fa0: 2020 7464 6963 7420 3d20 4f72 6465 7265    tdict = Ordere
+00046fb0: 6444 6963 7428 5b0a 2020 2020 2020 2020  dDict([.        
+00046fc0: 2020 2020 2827 6176 6572 6167 656f 6363      ('averageocc
+00046fd0: 272c 2072 6f75 6e64 2861 7665 7261 6765  ', round(average
+00046fe0: 6f63 632c 2036 2929 2c20 2827 636f 6c6f  occ, 6)), ('colo
+00046ff0: 7227 2c20 636f 6c6f 7572 7329 2c0a 2020  r', colours),.  
+00047000: 2020 2020 2020 2020 2020 2827 696e 636c            ('incl
+00047010: 7573 696f 6e27 2c20 5b72 6f75 6e64 2865  usion', [round(e
+00047020: 6c65 6d2c 2036 2920 666f 7220 656c 656d  lem, 6) for elem
+00047030: 2069 6e20 616c 6c76 616c 7565 735d 292c   in allvalues]),
+00047040: 0a20 2020 2020 2020 2020 2020 2028 2772  .            ('r
+00047050: 6573 6964 7565 272c 2061 6c6c 6b65 7973  esidue', allkeys
+00047060: 292c 0a20 2020 2020 2020 2020 2020 2028  ),.            (
+00047070: 2763 6861 696e 7173 636f 7265 272c 2063  'chainqscore', c
+00047080: 6861 696e 7173 636f 7265 290a 0a20 2020  hainqscore)..   
+00047090: 2020 2020 205d 290a 0a20 2020 2020 2020       ])..       
+000470a0: 2072 6573 756c 7464 6963 7420 3d20 4f72   resultdict = Or
+000470b0: 6465 7265 6444 6963 7428 5b28 276e 616d  deredDict([('nam
+000470c0: 6527 2c20 6f72 676d 6f64 656c 292c 2028  e', orgmodel), (
+000470d0: 2764 6174 6127 2c20 7464 6963 7429 5d29  'data', tdict)])
+000470e0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+000470f0: 2072 6573 756c 7464 6963 740a 0a20 2020   resultdict..   
+00047100: 2064 6566 2071 7363 6f72 6576 6965 7728   def qscoreview(
+00047110: 7365 6c66 2c20 6368 696d 6572 6161 7070  self, chimeraapp
+00047120: 293a 0a20 2020 2020 2020 2022 2222 0a0a  ):.        """..
+00047130: 2020 2020 2020 2020 2020 2020 582c 2059              X, Y
+00047140: 2c20 5a20 696d 6167 6573 2077 6869 6368  , Z images which
+00047150: 206d 6f64 656c 2077 6173 2063 6f6c 6f72   model was color
+00047160: 6564 2062 7920 512d 7363 6f72 650a 0a20  ed by Q-score.. 
+00047170: 2020 2020 2020 203a 7265 7475 726e 3a0a         :return:.
+00047180: 2020 2020 2020 2020 2222 220a 0a20 2020          """..   
+00047190: 2020 2020 2023 2072 6561 6420 6a73 6f6e       # read json
+000471a0: 0a20 2020 2020 2020 2073 7461 7274 203d  .        start =
+000471b0: 2074 696d 6569 742e 6465 6661 756c 745f   timeit.default_
+000471c0: 7469 6d65 7228 290a 2020 2020 2020 2020  timer().        
+000471d0: 696e 6a73 6f6e 203d 2067 6c6f 622e 676c  injson = glob.gl
+000471e0: 6f62 2873 656c 662e 776f 726b 6469 7220  ob(self.workdir 
+000471f0: 2b20 272a 5f71 7363 6f72 652e 6a73 6f6e  + '*_qscore.json
+00047200: 2729 0a20 2020 2020 2020 2062 6173 6564  ').        based
+00047210: 6972 203d 2073 656c 662e 776f 726b 6469  ir = self.workdi
+00047220: 720a 2020 2020 2020 2020 6d61 706e 616d  r.        mapnam
+00047230: 6520 3d20 7365 6c66 2e6d 6170 6e61 6d65  e = self.mapname
+00047240: 0a20 2020 2020 2020 206c 6f63 4348 494d  .        locCHIM
+00047250: 4552 4120 3d20 6368 696d 6572 6161 7070  ERA = chimeraapp
+00047260: 0a20 2020 2020 2020 2062 696e 6469 7370  .        bindisp
+00047270: 6c61 7920 3d20 6f73 2e67 6574 656e 7628  lay = os.getenv(
+00047280: 2744 4953 504c 4159 2729 0a20 2020 2020  'DISPLAY').     
+00047290: 2020 2065 7272 6c69 7374 203d 205b 5d0a     errlist = [].
+000472a0: 0a20 2020 2020 2020 2066 756c 696e 6a73  .        fulinjs
+000472b0: 6f6e 203d 2069 6e6a 736f 6e5b 305d 2069  on = injson[0] i
+000472c0: 6620 696e 6a73 6f6e 2065 6c73 6520 4e6f  f injson else No
+000472d0: 6e65 0a20 2020 2020 2020 2074 7279 3a0a  ne.        try:.
+000472e0: 2020 2020 2020 2020 2020 2020 6966 2066              if f
+000472f0: 756c 696e 6a73 6f6e 3a0a 2020 2020 2020  ulinjson:.      
+00047300: 2020 2020 2020 2020 2020 7769 7468 206f            with o
+00047310: 7065 6e28 6675 6c69 6e6a 736f 6e2c 2027  pen(fulinjson, '
+00047320: 7227 2920 6173 2066 3a0a 2020 2020 2020  r') as f:.      
+00047330: 2020 2020 2020 2020 2020 2020 2020 6172                ar
+00047340: 6773 203d 206a 736f 6e2e 6c6f 6164 2866  gs = json.load(f
+00047350: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+00047360: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00047370: 2020 2020 6172 6773 203d 204e 6f6e 650a      args = None.
+00047380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047390: 7072 696e 7428 2754 6865 7265 2069 7320  print('There is 
+000473a0: 6e6f 2051 7363 6f72 6520 6a73 6f6e 2066  no Qscore json f
+000473b0: 696c 652e 2729 0a20 2020 2020 2020 2065  ile.').        e
+000473c0: 7863 6570 7420 5479 7065 4572 726f 723a  xcept TypeError:
+000473d0: 0a20 2020 2020 2020 2020 2020 2065 7272  .            err
+000473e0: 203d 2027 4f70 656e 2051 7363 6f72 6520   = 'Open Qscore 
+000473f0: 4a53 4f4e 2065 7272 6f72 3a20 7b7d 2e27  JSON error: {}.'
+00047400: 2e66 6f72 6d61 7428 7379 732e 6578 635f  .format(sys.exc_
+00047410: 696e 666f 2829 5b31 5d29 0a20 2020 2020  info()[1]).     
+00047420: 2020 2020 2020 2065 7272 6c69 7374 2e61         errlist.a
+00047430: 7070 656e 6428 6572 7229 0a20 2020 2020  ppend(err).     
+00047440: 2020 2020 2020 2073 7973 2e73 7464 6572         sys.stder
+00047450: 722e 7772 6974 6528 6572 7220 2b20 275c  r.write(err + '\
+00047460: 6e27 290a 2020 2020 2020 2020 656c 7365  n').        else
+00047470: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00047480: 2061 7267 7320 6973 206e 6f74 204e 6f6e   args is not Non
+00047490: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+000474a0: 2020 206d 6f64 656c 7320 3d20 6172 6773     models = args
+000474b0: 5b27 7173 636f 7265 275d 0a20 2020 2020  ['qscore'].     
+000474c0: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+000474d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000474e0: 2020 2020 6465 6c20 6d6f 6465 6c73 5b27      del models['
+000474f0: 6572 7227 5d0a 2020 2020 2020 2020 2020  err'].          
+00047500: 2020 2020 2020 6578 6365 7074 3a0a 2020        except:.  
 00047510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047520: 2020 6578 6365 7074 3a0a 2020 2020 2020    except:.      
-00047530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047540: 2020 6572 7220 3d20 2753 6361 6c69 6e67    err = 'Scaling
-00047550: 206d 6f64 656c 2051 7363 6f72 6520 7669   model Qscore vi
-00047560: 6577 2065 7272 6f72 3a20 7b7d 2e27 2e66  ew error: {}.'.f
-00047570: 6f72 6d61 7428 7379 732e 6578 635f 696e  ormat(sys.exc_in
-00047580: 666f 2829 5b31 5d29 0a20 2020 2020 2020  fo()[1]).       
-00047590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000475a0: 2065 7272 6c69 7374 2e61 7070 656e 6428   errlist.append(
-000475b0: 6572 7229 0a20 2020 2020 2020 2020 2020  err).           
-000475c0: 2020 2020 2020 2020 2020 2020 2073 7973               sys
-000475d0: 2e73 7464 6572 722e 7772 6974 6528 6572  .stderr.write(er
-000475e0: 7220 2b20 275c 6e27 290a 0a20 2020 2020  r + '\n')..     
-000475f0: 2020 2020 2020 2020 2020 2020 2020 206a                 j
-00047600: 7065 6773 203d 2067 6c6f 622e 676c 6f62  pegs = glob.glob
-00047610: 2873 656c 662e 776f 726b 6469 7220 2b20  (self.workdir + 
-00047620: 272f 2a73 7572 6661 6365 2e6a 7065 6727  '/*surface.jpeg'
-00047630: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00047640: 2020 2020 2020 6d6f 6465 6c73 7572 6620        modelsurf 
-00047650: 3d20 6469 6374 2829 0a20 2020 2020 2020  = dict().       
-00047660: 2020 2020 2020 2020 2020 2020 2066 696e               fin
-00047670: 616c 6d6d 6469 6374 203d 2064 6963 7428  almmdict = dict(
-00047680: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00047690: 2020 2020 2020 6966 2073 656c 662e 6d6f        if self.mo
-000476a0: 6465 6c73 3a0a 2020 2020 2020 2020 2020  dels:.          
-000476b0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-000476c0: 7072 696e 7420 2273 656c 662e 6d6f 6465  print "self.mode
-000476d0: 6c73 3a25 7322 2025 2073 656c 662e 6d6f  ls:%s" % self.mo
-000476e0: 6465 6c73 0a20 2020 2020 2020 2020 2020  dels.           
-000476f0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00047700: 206d 6f64 656c 2069 6e20 7365 6c66 2e6d   model in self.m
-00047710: 6f64 656c 733a 0a20 2020 2020 2020 2020  odels:.         
-00047720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047730: 2020 206d 6f64 656c 6e61 6d65 203d 206f     modelname = o
-00047740: 732e 7061 7468 2e62 6173 656e 616d 6528  s.path.basename(
-00047750: 6d6f 6465 6c2e 6669 6c65 6e61 6d65 290a  model.filename).
-00047760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047770: 2020 2020 2020 2020 2020 2020 7375 7266              surf
-00047780: 6163 6566 6e20 3d20 277b 7d5f 7b7d 272e  acefn = '{}_{}'.
-00047790: 666f 726d 6174 286d 6f64 656c 6e61 6d65  format(modelname
-000477a0: 2c20 7365 6c66 2e6d 6170 6e61 6d65 290a  , self.mapname).
-000477b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000477c0: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
-000477d0: 6c6d 6170 7375 7266 6163 6520 3d20 6469  lmapsurface = di
-000477e0: 6374 2829 0a20 2020 2020 2020 2020 2020  ct().           
-000477f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047800: 2066 6f72 206a 7065 6720 696e 206a 7065   for jpeg in jpe
-00047810: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
-00047820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047830: 2020 2020 6966 206d 6f64 656c 6e61 6d65      if modelname
-00047840: 2069 6e20 6a70 6567 2061 6e64 2027 7871   in jpeg and 'xq
-00047850: 7363 6f72 6527 2069 6e20 6a70 6567 3a0a  score' in jpeg:.
-00047860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047520: 2020 7072 696e 7428 2751 7363 6f72 6520    print('Qscore 
+00047530: 6a73 6f6e 2072 6573 756c 7420 6973 2063  json result is c
+00047540: 6f72 7265 6374 2729 0a0a 2020 2020 2020  orrect')..      
+00047550: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+00047560: 2754 6865 7265 2069 732f 6172 6520 2573  'There is/are %s
+00047570: 206d 6f64 656c 2873 292e 2720 2520 6c65   model(s).' % le
+00047580: 6e28 6d6f 6465 6c73 2929 0a20 2020 2020  n(models)).     
+00047590: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
+000475a0: 6b65 792c 2076 616c 7565 2920 696e 2069  key, value) in i
+000475b0: 7465 7269 7465 6d73 286d 6f64 656c 7329  teritems(models)
+000475c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000475d0: 2020 2020 2020 2320 666f 7220 286b 6579        # for (key
+000475e0: 322c 2076 616c 7565 3229 2069 6e20 6974  2, value2) in it
+000475f0: 6572 6974 656d 7328 7661 6c75 6529 3a0a  eritems(value):.
+00047600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047610: 2020 2020 6966 2074 7970 6528 7661 6c75      if type(valu
+00047620: 6529 2069 7320 666c 6f61 743a 0a20 2020  e) is float:.   
+00047630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047640: 2020 2020 2063 6f6e 7469 6e75 650a 2020       continue.  
+00047650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047660: 2020 6b65 796c 6973 7420 3d20 6c69 7374    keylist = list
+00047670: 2876 616c 7565 290a 2020 2020 2020 2020  (value).        
+00047680: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00047690: 6b65 7920 696e 206b 6579 6c69 7374 3a0a  key in keylist:.
+000476a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000476b0: 2020 2020 2020 2020 6966 206b 6579 2021          if key !
+000476c0: 3d20 276e 616d 6527 3a0a 2020 2020 2020  = 'name':.      
+000476d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000476e0: 2020 2020 2020 636f 6c6f 7273 203d 2076        colors = v
+000476f0: 616c 7565 5b6b 6579 5d5b 2763 6f6c 6f72  alue[key]['color
+00047700: 275d 0a20 2020 2020 2020 2020 2020 2020  '].             
+00047710: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00047720: 6573 6964 7565 7320 3d20 7661 6c75 655b  esidues = value[
+00047730: 6b65 795d 5b27 7265 7369 6475 6527 5d0a  key]['residue'].
+00047740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047750: 2020 2020 2020 2020 2020 2020 7173 636f              qsco
+00047760: 7265 7320 3d20 7661 6c75 655b 6b65 795d  res = value[key]
+00047770: 5b27 696e 636c 7573 696f 6e27 5d0a 2020  ['inclusion'].  
+00047780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047790: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000477a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000477b0: 2020 2020 2020 2020 6d6f 6465 6c6e 616d          modelnam
+000477c0: 6520 3d20 7661 6c75 655b 6b65 795d 0a20  e = value[key]. 
+000477d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000477e0: 2020 2020 2020 2020 2020 206d 6f64 656c             model
+000477f0: 203d 2073 656c 662e 776f 726b 6469 7220   = self.workdir 
+00047800: 2b20 6d6f 6465 6c6e 616d 650a 2020 2020  + modelname.    
+00047810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047820: 2020 2020 2020 2020 6368 696d 6572 6166          chimeraf
+00047830: 6e61 6d65 203d 2027 7b7d 5f7b 7d5f 7173  name = '{}_{}_qs
+00047840: 636f 7265 5f63 6869 6d65 7261 2e63 7863  core_chimera.cxc
+00047850: 272e 666f 726d 6174 286d 6f64 656c 6e61  '.format(modelna
+00047860: 6d65 2c20 6d61 706e 616d 6529 0a20 2020  me, mapname).   
 00047870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047880: 2020 2020 6d6f 6465 6c6d 6170 7375 7266      modelmapsurf
-00047890: 6163 655b 2778 275d 203d 2073 7472 2873  ace['x'] = str(s
-000478a0: 7572 6661 6365 666e 2920 2b20 275f 7363  urfacefn) + '_sc
-000478b0: 616c 6564 5f78 7173 636f 7265 7375 7266  aled_xqscoresurf
-000478c0: 6163 652e 6a70 6567 270a 2020 2020 2020  ace.jpeg'.      
-000478d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000478e0: 2020 2020 2020 2020 2020 6966 206d 6f64            if mod
-000478f0: 656c 6e61 6d65 2069 6e20 6a70 6567 2061  elname in jpeg a
-00047900: 6e64 2027 7971 7363 6f72 6527 2069 6e20  nd 'yqscore' in 
-00047910: 6a70 6567 3a0a 2020 2020 2020 2020 2020  jpeg:.          
-00047920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047930: 2020 2020 2020 2020 2020 6d6f 6465 6c6d            modelm
-00047940: 6170 7375 7266 6163 655b 2779 275d 203d  apsurface['y'] =
-00047950: 2073 7472 2873 7572 6661 6365 666e 2920   str(surfacefn) 
-00047960: 2b20 275f 7363 616c 6564 5f79 7173 636f  + '_scaled_yqsco
-00047970: 7265 7375 7266 6163 652e 6a70 6567 270a  resurface.jpeg'.
-00047980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000479a0: 6966 206d 6f64 656c 6e61 6d65 2069 6e20  if modelname in 
-000479b0: 6a70 6567 2061 6e64 2027 7a71 7363 6f72  jpeg and 'zqscor
-000479c0: 6527 2069 6e20 6a70 6567 3a0a 2020 2020  e' in jpeg:.    
-000479d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000479e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000479f0: 6d6f 6465 6c6d 6170 7375 7266 6163 655b  modelmapsurface[
-00047a00: 277a 275d 203d 2073 7472 2873 7572 6661  'z'] = str(surfa
-00047a10: 6365 666e 2920 2b20 275f 7363 616c 6564  cefn) + '_scaled
-00047a20: 5f7a 7173 636f 7265 7375 7266 6163 652e  _zqscoresurface.
-00047a30: 6a70 6567 270a 2020 2020 2020 2020 2020  jpeg'.          
-00047a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047a50: 2020 6966 2065 7272 6c69 7374 3a0a 2020    if errlist:.  
-00047a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047a70: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
-00047a80: 6465 6c6d 6170 7375 7266 6163 655b 2765  delmapsurface['e
-00047a90: 7272 275d 203d 207b 276d 6f64 656c 5f66  rr'] = {'model_f
-00047aa0: 6974 5f65 7272 273a 2065 7272 6c69 7374  it_err': errlist
-00047ab0: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-00047ac0: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
-00047ad0: 6465 6c73 7572 665b 6d6f 6465 6c6e 616d  delsurf[modelnam
-00047ae0: 655d 203d 206d 6f64 656c 6d61 7073 7572  e] = modelmapsur
-00047af0: 6661 6365 0a20 2020 2020 2020 2020 2020  face.           
-00047b00: 2020 2020 2020 2020 2020 2020 2066 696e               fin
-00047b10: 616c 6d6d 6469 6374 5b27 7173 636f 7265  almmdict['qscore
-00047b20: 5f73 7572 6661 6365 275d 203d 206d 6f64  _surface'] = mod
-00047b30: 656c 7375 7266 0a0a 2020 2020 2020 2020  elsurf..        
-00047b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047b50: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00047b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047b70: 2077 6974 6820 636f 6465 6373 2e6f 7065   with codecs.ope
-00047b80: 6e28 7365 6c66 2e77 6f72 6b64 6972 202b  n(self.workdir +
-00047b90: 2073 656c 662e 6d61 706e 616d 6520 2b20   self.mapname + 
-00047ba0: 275f 7173 636f 7265 7669 6577 2e6a 736f  '_qscoreview.jso
-00047bb0: 6e27 2c20 2777 272c 0a20 2020 2020 2020  n', 'w',.       
-00047bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047880: 2020 2020 2020 2020 2073 7572 6661 6365           surface
+00047890: 666e 203d 2027 7b7d 7b7d 5f7b 7d27 2e66  fn = '{}{}_{}'.f
+000478a0: 6f72 6d61 7428 6261 7365 6469 722c 206d  ormat(basedir, m
+000478b0: 6f64 656c 6e61 6d65 2c20 6d61 706e 616d  odelname, mapnam
+000478c0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+000478d0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000478e0: 6869 6d65 7261 636d 6420 3d20 6368 696d  himeracmd = chim
+000478f0: 6572 6166 6e61 6d65 0a20 2020 2020 2020  erafname.       
+00047900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047910: 2020 2020 2023 2070 6462 6d6f 6465 6c6e       # pdbmodeln
+00047920: 616d 6520 3d20 277b 7d7b 7d5f 5f51 5f5f  ame = '{}{}__Q__
+00047930: 7b7d 2e70 6462 272e 666f 726d 6174 2862  {}.pdb'.format(b
+00047940: 6173 6564 6972 2c20 6d6f 6465 6c6e 616d  asedir, modelnam
+00047950: 655b 3a2d 345d 2c20 6d61 706e 616d 655b  e[:-4], mapname[
+00047960: 3a2d 345d 290a 2020 2020 2020 2020 2020  :-4]).          
+00047970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047980: 2020 7064 626d 6f64 656c 6e61 6d65 203d    pdbmodelname =
+00047990: 2027 7b7d 7b7d 5f5f 515f 5f7b 7d2e 6369   '{}{}__Q__{}.ci
+000479a0: 6627 2e66 6f72 6d61 7428 6261 7365 6469  f'.format(basedi
+000479b0: 722c 206d 6f64 656c 6e61 6d65 2c20 6d61  r, modelname, ma
+000479c0: 706e 616d 6529 0a0a 2020 2020 2020 2020  pname)..        
+000479d0: 2020 2020 2020 2020 2020 2020 7769 7468              with
+000479e0: 206f 7065 6e28 7365 6c66 2e77 6f72 6b64   open(self.workd
+000479f0: 6972 202b 2063 6869 6d65 7261 636d 642c  ir + chimeracmd,
+00047a00: 2027 7727 2920 6173 2066 703a 0a20 2020   'w') as fp:.   
+00047a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047a20: 2020 2020 2066 702e 7772 6974 6528 226f       fp.write("o
+00047a30: 7065 6e20 2220 2b20 7374 7228 7064 626d  pen " + str(pdbm
+00047a40: 6f64 656c 6e61 6d65 2920 2b20 2220 666f  odelname) + " fo
+00047a50: 726d 6174 206d 6d63 6966 2220 2b20 275c  rmat mmcif" + '\
+00047a60: 6e27 290a 2020 2020 2020 2020 2020 2020  n').            
+00047a70: 2020 2020 2020 2020 2020 2020 2320 6670              # fp
+00047a80: 2e77 7269 7465 2822 6f70 656e 2022 202b  .write("open " +
+00047a90: 2073 7472 2870 6462 6d6f 6465 6c6e 616d   str(pdbmodelnam
+00047aa0: 6529 202b 2022 2066 6f72 6d61 7420 7064  e) + " format pd
+00047ab0: 6222 202b 2027 5c6e 2729 0a20 2020 2020  b" + '\n').     
+00047ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047ad0: 2020 2066 702e 7772 6974 6528 2773 686f     fp.write('sho
+00047ae0: 7720 7365 6c41 746f 6d73 2072 6962 626f  w selAtoms ribbo
+00047af0: 6e73 2720 2b20 275c 6e27 290a 2020 2020  ns' + '\n').    
+00047b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047b10: 2020 2020 6670 2e77 7269 7465 2827 6869      fp.write('hi
+00047b20: 6465 2073 656c 4174 6f6d 7327 202b 2027  de selAtoms' + '
+00047b30: 5c6e 2729 0a0a 2020 2020 2020 2020 2020  \n')..          
+00047b40: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00047b50: 7220 2863 6f6c 6f72 2c20 7265 7369 6475  r (color, residu
+00047b60: 652c 2071 7363 6f72 6529 2069 6e20 7a69  e, qscore) in zi
+00047b70: 7028 636f 6c6f 7273 2c20 7265 7369 6475  p(colors, residu
+00047b80: 6573 2c20 7173 636f 7265 7329 3a0a 2020  es, qscores):.  
+00047b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047ba0: 2020 2020 2020 2020 2020 6368 6169 6e2c            chain,
+00047bb0: 2072 6573 746d 7020 3d20 7265 7369 6475   restmp = residu
+00047bc0: 652e 7370 6c69 7428 273a 2729 0a20 2020  e.split(':').   
 00047bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047be0: 2020 2020 2020 656e 636f 6469 6e67 3d27        encoding='
-00047bf0: 7574 662d 3827 2920 6173 2066 3a0a 2020  utf-8') as f:.  
-00047c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047c10: 2020 2020 2020 2020 2020 2020 2020 6a73                js
-00047c20: 6f6e 2e64 756d 7028 6669 6e61 6c6d 6d64  on.dump(finalmmd
-00047c30: 6963 742c 2066 290a 2020 2020 2020 2020  ict, f).        
-00047c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047c50: 6578 6365 7074 3a0a 2020 2020 2020 2020  except:.        
-00047c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047c70: 2020 2020 7379 732e 7374 6465 7272 2e77      sys.stderr.w
-00047c80: 7269 7465 280a 2020 2020 2020 2020 2020  rite(.          
-00047c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047ca0: 2020 2020 2020 2753 6176 696e 6720 5173        'Saving Qs
-00047cb0: 636f 7265 2076 6965 7720 746f 204a 534f  core view to JSO
-00047cc0: 4e20 6572 726f 723a 207b 7d2e 5c6e 272e  N error: {}.\n'.
-00047cd0: 666f 726d 6174 2873 7973 2e65 7863 5f69  format(sys.exc_i
-00047ce0: 6e66 6f28 295b 315d 2929 0a0a 2020 2020  nfo()[1]))..    
-00047cf0: 2020 2020 2020 2020 2020 2020 656e 6420              end 
-00047d00: 3d20 7469 6d65 6974 2e64 6566 6175 6c74  = timeit.default
-00047d10: 5f74 696d 6572 2829 0a20 2020 2020 2020  _timer().       
-00047d20: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
-00047d30: 5173 636f 7265 2073 7572 6661 6365 2074  Qscore surface t
-00047d40: 696d 653a 2025 7327 2025 2028 656e 6420  ime: %s' % (end 
-00047d50: 2d20 7374 6172 7429 290a 2020 2020 2020  - start)).      
-00047d60: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-00047d70: 272d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  '---------------
-00047d80: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00047d90: 2d2d 2d2d 2d27 290a 0a20 2020 2064 6566  -----')..    def
-00047da0: 206d 6f76 6570 726f 7368 6164 6552 6573   moveproshadeRes
-00047db0: 756c 7428 7365 6c66 293a 0a0a 2020 2020  ult(self):..    
-00047dc0: 2020 2020 696d 706f 7274 2073 6875 7469      import shuti
-00047dd0: 6c0a 0a20 2020 2020 2020 2063 7764 203d  l..        cwd =
-00047de0: 206f 732e 6765 7463 7764 2829 0a20 2020   os.getcwd().   
-00047df0: 2020 2020 2073 7263 6469 7220 3d20 277b       srcdir = '{
-00047e00: 7d2f 7072 6f73 6861 6465 5f72 6570 6f72  }/proshade_repor
-00047e10: 7427 2e66 6f72 6d61 7428 6377 6429 0a20  t'.format(cwd). 
-00047e20: 2020 2020 2020 2064 6573 6469 7220 3d20         desdir = 
-00047e30: 7365 6c66 2e77 6f72 6b64 6972 0a20 2020  self.workdir.   
-00047e40: 2020 2020 2064 6573 7072 6f64 6972 203d       desprodir =
-00047e50: 2027 7b7d 2f70 726f 7368 6164 655f 7265   '{}/proshade_re
-00047e60: 706f 7274 272e 666f 726d 6174 2864 6573  port'.format(des
-00047e70: 6469 7229 0a20 2020 2020 2020 2069 6620  dir).        if 
-00047e80: 6f73 2e70 6174 682e 6973 6469 7228 6465  os.path.isdir(de
-00047e90: 7370 726f 6469 7229 3a0a 2020 2020 2020  sprodir):.      
-00047ea0: 2020 2020 2020 7368 7574 696c 2e72 6d74        shutil.rmt
-00047eb0: 7265 6528 6465 7370 726f 6469 7229 0a20  ree(desprodir). 
-00047ec0: 2020 2020 2020 2069 6620 6f73 2e70 6174         if os.pat
-00047ed0: 682e 6973 6469 7228 7372 6364 6972 293a  h.isdir(srcdir):
-00047ee0: 0a20 2020 2020 2020 2020 2020 2064 6573  .            des
-00047ef0: 7420 3d20 7368 7574 696c 2e6d 6f76 6528  t = shutil.move(
-00047f00: 7372 6364 6972 2c20 6465 7364 6972 290a  srcdir, desdir).
-00047f10: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00047f20: 2020 2020 2020 2020 2020 6465 7374 203d            dest =
-00047f30: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
-00047f40: 2020 7072 696e 7428 274e 6f20 7072 6f73    print('No pros
-00047f50: 6861 6465 2072 6573 756c 7420 746f 2062  hade result to b
-00047f60: 6520 6d6f 7665 642e 2729 0a0a 2020 2020  e moved.')..    
-00047f70: 2020 2020 7265 7475 726e 2064 6573 740a      return dest.
-00047f80: 0a20 2020 2064 6566 2073 796d 6d65 7472  .    def symmetr
-00047f90: 7974 6f6a 736f 6e28 7365 6c66 2c20 6f75  ytojson(self, ou
-00047fa0: 7470 7574 293a 0a20 2020 2020 2020 2022  tput):.        "
-00047fb0: 2222 0a0a 2020 2020 2020 2020 2020 2020  ""..            
-00047fc0: 436f 6e76 6572 7420 7468 6520 6f75 7470  Convert the outp
-00047fd0: 7574 206f 6620 7072 6f73 6861 6465 2073  ut of proshade s
-00047fe0: 796d 6d65 7472 7920 6361 6c63 756c 6174  ymmetry calculat
-00047ff0: 696f 6e20 746f 206a 736f 6e20 7768 6963  ion to json whic
-00048000: 6820 6361 6e20 6265 2075 7365 6420 6675  h can be used fu
-00048010: 7274 6865 720a 0a20 2020 2020 2020 203a  rther..        :
-00048020: 7061 7261 6d20 6f75 7470 7574 3a0a 2020  param output:.  
-00048030: 2020 2020 2020 3a72 6574 7572 6e3a 0a20        :return:. 
-00048040: 2020 2020 2020 2022 2222 0a0a 2020 2020         """..    
-00048050: 2020 2020 7061 7373 0a0a 2020 2020 6465      pass..    de
-00048060: 6620 7374 7275 6465 6c28 7365 6c66 293a  f strudel(self):
-00048070: 0a20 2020 2020 2020 2022 2222 0a0a 2020  .        """..  
-00048080: 2020 2020 2020 3a72 6574 7572 6e3a 0a20        :return:. 
-00048090: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-000480a0: 2020 2069 6620 7365 6c66 2e70 6c61 7466     if self.platf
-000480b0: 6f72 6d20 3d3d 2027 656d 6462 2720 616e  orm == 'emdb' an
-000480c0: 6420 7365 6c66 2e6d 6574 2021 3d20 2774  d self.met != 't
-000480d0: 6f6d 6f27 3a0a 2020 2020 2020 2020 2020  omo':.          
-000480e0: 2020 6572 726c 6973 7420 3d20 5b5d 0a20    errlist = []. 
-000480f0: 2020 2020 2020 2020 2020 2066 696e 616c             final
-00048100: 5f72 616e 6765 203d 204e 6f6e 650a 2020  _range = None.  
-00048110: 2020 2020 2020 2020 2020 7265 735f 7261            res_ra
-00048120: 6e67 6573 203d 205b 5b32 2e30 2c20 322e  nges = [[2.0, 2.
-00048130: 335d 2c20 5b32 2e33 2c20 322e 355d 2c20  3], [2.3, 2.5], 
-00048140: 5b32 2e35 2c20 322e 385d 2c20 5b32 2e38  [2.5, 2.8], [2.8
-00048150: 2c20 332e 305d 2c20 5b33 2e30 2c20 332e  , 3.0], [3.0, 3.
-00048160: 325d 2c20 5b33 2e32 2c20 332e 355d 2c20  2], [3.2, 3.5], 
-00048170: 5b33 2e35 2c20 342e 305d 5d0a 2020 2020  [3.5, 4.0]].    
-00048180: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00048190: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-000481a0: 2069 6478 2c20 6372 616e 6765 2069 6e20   idx, crange in 
-000481b0: 656e 756d 6572 6174 6528 7265 735f 7261  enumerate(res_ra
-000481c0: 6e67 6573 293a 0a20 2020 2020 2020 2020  nges):.         
-000481d0: 2020 2020 2020 2020 2020 2069 6620 6372             if cr
-000481e0: 616e 6765 5b30 5d20 3c20 666c 6f61 7428  ange[0] < float(
-000481f0: 7365 6c66 2e72 6573 6f6c 7574 696f 6e29  self.resolution)
-00048200: 203c 3d20 6372 616e 6765 5b31 5d3a 0a20   <= crange[1]:. 
-00048210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048220: 2020 2020 2020 2066 696e 616c 5f72 616e         final_ran
-00048230: 6765 203d 2063 7261 6e67 650a 2020 2020  ge = crange.    
-00048240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048250: 2020 2020 6272 6561 6b0a 2020 2020 2020      break.      
-00048260: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00048270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048280: 2020 2020 7072 696e 7428 274d 6170 2064      print('Map d
-00048290: 6964 206e 6f74 2066 616c 6c20 696e 746f  id not fall into
-000482a0: 2061 6e79 2061 7661 696c 6162 6c65 2072   any available r
-000482b0: 6573 6f6c 7574 696f 6e20 7261 6e67 652e  esolution range.
-000482c0: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
-000482d0: 2020 2020 2020 2070 7269 6e74 2827 2d2d         print('--
-000482e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000482f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00048300: 2d2d 2729 0a20 2020 2020 2020 2020 2020  --').           
-00048310: 2065 7863 6570 743a 0a20 2020 2020 2020   except:.       
-00048320: 2020 2020 2020 2020 2065 7272 203d 2027           err = '
-00048330: 5374 7275 6465 6c20 6d6f 7469 6620 6c69  Strudel motif li
-00048340: 6220 7265 736f 6c75 7469 6f6e 2072 616e  b resolution ran
-00048350: 6765 2063 6865 636b 2065 7272 6f72 3a20  ge check error: 
-00048360: 7b7d 2e27 2e66 6f72 6d61 7428 7379 732e  {}.'.format(sys.
-00048370: 6578 635f 696e 666f 2829 5b31 5d29 0a20  exc_info()[1]). 
-00048380: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00048390: 7272 6c69 7374 2e61 7070 656e 6428 6572  rrlist.append(er
-000483a0: 7229 0a20 2020 2020 2020 2020 2020 2020  r).             
-000483b0: 2020 2073 7973 2e73 7464 6572 722e 7772     sys.stderr.wr
-000483c0: 6974 6528 6572 7220 2b20 275c 6e27 290a  ite(err + '\n').
-000483d0: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
-000483e0: 7564 656c 6170 7020 3d20 4e6f 6e65 0a20  udelapp = None. 
-000483f0: 2020 2020 2020 2020 2020 2023 2075 7365             # use
-00048400: 2061 2066 6978 2076 616c 7565 2066 6f72   a fix value for
-00048410: 206e 6f77 2c20 6d61 7920 636f 6e73 6964   now, may consid
-00048420: 6572 2061 7320 6120 6172 6775 6d65 6e74  er as a argument
-00048430: 2066 6f72 206c 6174 6572 0a20 2020 2020   for later.     
-00048440: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00048450: 2020 2020 2020 2020 2020 2020 2320 7374              # st
-00048460: 7275 6465 6c61 7070 203d 2073 656c 662e  rudelapp = self.
-00048470: 6368 6563 6b73 7472 7564 656c 7363 6f72  checkstrudelscor
-00048480: 6528 6f63 6869 6d65 7261 6170 7029 0a20  e(ochimeraapp). 
-00048490: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-000484a0: 6170 6e61 6d65 203d 2073 656c 662e 6d61  apname = self.ma
-000484b0: 702e 6675 6c6c 6e61 6d65 0a20 2020 2020  p.fullname.     
-000484c0: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-000484d0: 6c66 2e6d 6f64 656c 7320 6973 206e 6f74  lf.models is not
-000484e0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-000484f0: 2020 2020 2020 2020 2020 206d 6f64 656c             model
-00048500: 7320 3d20 2720 272e 6a6f 696e 285b 6d6f  s = ' '.join([mo
-00048510: 6465 6c2e 6669 6c65 6e61 6d65 2066 6f72  del.filename for
-00048520: 206d 6f64 656c 2069 6e20 7365 6c66 2e6d   model in self.m
-00048530: 6f64 656c 735d 290a 2020 2020 2020 2020  odels]).        
-00048540: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00048550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048560: 2020 7072 696e 7428 274e 6f20 6669 7474    print('No fitt
-00048570: 6564 206d 6f64 656c 2066 6f72 2053 7472  ed model for Str
-00048580: 7564 656c 2063 616c 6375 6c61 7469 6f6e  udel calculation
-00048590: 2e27 290a 2020 2020 2020 2020 2020 2020  .').            
-000485a0: 2020 2020 2020 2020 7072 696e 7428 272d          print('-
-000485b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000485c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000485d0: 2d2d 2d27 290a 0a20 2020 2020 2020 2020  ---')..         
-000485e0: 2020 2065 7863 6570 743a 0a20 2020 2020     except:.     
-000485f0: 2020 2020 2020 2020 2020 2065 7272 203d             err =
-00048600: 2027 5374 7275 6465 6c20 7072 6570 6172   'Strudel prepar
-00048610: 6174 696f 6e20 6572 726f 723a 207b 7d2e  ation error: {}.
-00048620: 272e 666f 726d 6174 2873 7973 2e65 7863  '.format(sys.exc
-00048630: 5f69 6e66 6f28 295b 315d 290a 2020 2020  _info()[1]).    
-00048640: 2020 2020 2020 2020 2020 2020 6572 726c              errl
-00048650: 6973 742e 6170 7065 6e64 2865 7272 290a  ist.append(err).
-00048660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048670: 7379 732e 7374 6465 7272 2e77 7269 7465  sys.stderr.write
-00048680: 2865 7272 202b 2027 5c6e 2729 0a0a 2020  (err + '\n')..  
-00048690: 2020 2020 2020 2020 2020 6c69 625f 726f            lib_ro
-000486a0: 6f74 203d 204e 6f6e 650a 2020 2020 2020  ot = None.      
-000486b0: 2020 2020 2020 6966 204c 4942 5f53 5452        if LIB_STR
-000486c0: 5544 454c 5f52 4f4f 5420 6973 206e 6f74  UDEL_ROOT is not
-000486d0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-000486e0: 2020 2020 2020 206c 6962 5f72 6f6f 7420         lib_root 
-000486f0: 3d20 4c49 425f 5354 5255 4445 4c5f 524f  = LIB_STRUDEL_RO
-00048700: 4f54 0a20 2020 2020 2020 2020 2020 2065  OT.            e
-00048710: 6c69 6620 4c49 425f 5354 5255 4445 4c5f  lif LIB_STRUDEL_
-00048720: 524f 4f54 2069 7320 4e6f 6e65 2061 6e64  ROOT is None and
-00048730: 2073 656c 662e 7374 7275 6465 6c6c 6962   self.strudellib
-00048740: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00048750: 2020 2020 2020 2020 2020 2020 2020 6c69                li
-00048760: 625f 726f 6f74 203d 2073 656c 662e 7374  b_root = self.st
-00048770: 7275 6465 6c6c 6962 0a20 2020 2020 2020  rudellib.       
-00048780: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00048790: 2020 2020 2020 2020 2020 206c 6962 5f72             lib_r
-000487a0: 6f6f 7420 3d20 4e6f 6e65 0a0a 2020 2020  oot = None..    
-000487b0: 2020 2020 2020 2020 2320 6966 2073 7472          # if str
-000487c0: 7564 656c 6170 7020 616e 6420 7365 6c66  udelapp and self
-000487d0: 2e6d 6f64 656c 733a 0a20 2020 2020 2020  .models:.       
-000487e0: 2020 2020 2069 6620 6669 6e61 6c5f 7261       if final_ra
-000487f0: 6e67 6520 616e 6420 7365 6c66 2e6d 6f64  nge and self.mod
-00048800: 656c 733a 0a20 2020 2020 2020 2020 2020  els:.           
-00048810: 2020 2020 2066 6f72 206d 6f64 656c 2069       for model i
-00048820: 6e20 7365 6c66 2e6d 6f64 656c 733a 0a20  n self.models:. 
-00048830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048840: 2020 2066 756c 6c5f 6d6f 6465 6c20 3d20     full_model = 
-00048850: 277b 7d7b 7d27 2e66 6f72 6d61 7428 7365  '{}{}'.format(se
-00048860: 6c66 2e77 6f72 6b64 6972 2c20 6f73 2e70  lf.workdir, os.p
-00048870: 6174 682e 6261 7365 6e61 6d65 286d 6f64  ath.basename(mod
-00048880: 656c 2e66 696c 656e 616d 6529 290a 2020  el.filename)).  
-00048890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000488a0: 2020 6675 6c6c 5f6d 6170 203d 2027 7b7d    full_map = '{}
-000488b0: 7b7d 272e 666f 726d 6174 2873 656c 662e  {}'.format(self.
-000488c0: 776f 726b 6469 722c 2073 656c 662e 6d61  workdir, self.ma
-000488d0: 706e 616d 6529 0a20 2020 2020 2020 2020  pname).         
-000488e0: 2020 2020 2020 2020 2020 206c 6962 5f70             lib_p
-000488f0: 6174 6820 3d20 277b 7d2f 6d6f 7469 6673  ath = '{}/motifs
-00048900: 5f7b 7d2d 7b7d 272e 666f 726d 6174 286c  _{}-{}'.format(l
-00048910: 6962 5f72 6f6f 742c 2066 696e 616c 5f72  ib_root, final_r
-00048920: 616e 6765 5b30 5d2c 2066 696e 616c 5f72  ange[0], final_r
-00048930: 616e 6765 5b31 5d29 0a20 2020 2020 2020  ange[1]).       
-00048940: 2020 2020 2020 2020 2020 2020 206f 7574               out
-00048950: 5f70 6174 6820 3d20 277b 7d5f 7374 7275  _path = '{}_stru
-00048960: 6465 6c27 2e66 6f72 6d61 7428 6675 6c6c  del'.format(full
-00048970: 5f6d 6f64 656c 290a 0a20 2020 2020 2020  _model)..       
-00048980: 2020 2020 2020 2020 2020 2020 2072 6572               rer
-00048990: 7220 3d20 7275 6e5f 7374 7275 6465 6c28  r = run_strudel(
-000489a0: 6675 6c6c 5f6d 6f64 656c 2c20 6675 6c6c  full_model, full
-000489b0: 5f6d 6170 2c20 6c69 625f 7061 7468 2c20  _map, lib_path, 
-000489c0: 6f75 745f 7061 7468 2c20 7365 6c66 2e70  out_path, self.p
-000489d0: 6c61 7466 6f72 6d29 0a20 2020 2020 2020  latform).       
-000489e0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000489f0: 7265 7272 3a0a 2020 2020 2020 2020 2020  rerr:.          
-00048a00: 2020 2020 2020 2020 2020 2020 2020 6572                er
-00048a10: 7220 3d20 2753 7472 7564 656c 2063 616c  r = 'Strudel cal
-00048a20: 6375 6c61 7469 6f6e 2065 7272 6f72 3a20  culation error: 
-00048a30: 7b7d 272e 666f 726d 6174 2872 6572 7229  {}'.format(rerr)
-00048a40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00048a50: 2020 2020 2020 2020 2065 7272 6c69 7374           errlist
-00048a60: 2e61 7070 656e 6428 6572 7229 0a20 2020  .append(err).   
-00048a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048a80: 2020 2020 2073 7973 2e73 7464 6572 722e       sys.stderr.
-00048a90: 7772 6974 6528 6572 7220 2b20 275c 6e27  write(err + '\n'
-00048aa0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00048ab0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-00048ac0: 272d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  '---------------
-00048ad0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00048ae0: 2d2d 2d2d 2d27 290a 0a20 2020 2020 2020  -----')..       
-00048af0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00048b00: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00048b10: 2827 4e6f 206d 6f64 656c 206f 7220 7265  ('No model or re
-00048b20: 736f 6c75 7469 6f6e 2069 7320 6e6f 7420  solution is not 
-00048b30: 636f 7665 7265 6420 696e 2074 6865 206d  covered in the m
-00048b40: 6f74 6966 206c 6962 7261 7279 2028 3c34  otif library (<4
-00048b50: 2e30 c385 2920 2729 0a20 2020 2020 2020  .0..) ').       
-00048b60: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
-00048b70: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00048b80: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00048b90: 2d2d 2d2d 2729 0a0a 2020 2020 2020 2020  ----')..        
-00048ba0: 7265 7475 726e 204e 6f6e 650a 0a0a 0a0a  return None.....
-00048bb0: 2020 2020 6465 6620 7265 616c 5f6d 6d63      def real_mmc
-00048bc0: 6328 7365 6c66 293a 0a20 2020 2020 2020  c(self):.       
-00048bd0: 2022 2222 0a20 2020 2020 2020 2020 2020   """.           
-00048be0: 2043 616c 6375 6c61 7469 6f6e 2072 6561   Calculation rea
-00048bf0: 6c20 7370 6163 6520 6372 6f73 732d 636f  l space cross-co
-00048c00: 7272 656c 6174 696f 6e20 6265 7477 6565  rrelation betwee
-00048c10: 6e20 7072 696d 6172 7920 6d61 7020 616e  n primary map an
-00048c20: 6420 6d6f 6465 6c2d 6d61 7020 2852 6566  d model-map (Ref
-00048c30: 6d61 6329 0a0a 2020 2020 2020 2020 3a72  mac)..        :r
-00048c40: 6574 7572 6e3a 0a20 2020 2020 2020 2022  eturn:.        "
-00048c50: 2222 0a0a 2020 2020 2020 2020 6966 2073  ""..        if s
-00048c60: 656c 662e 6d6f 6465 6c73 6d61 7073 2061  elf.modelsmaps a
-00048c70: 6e64 2073 656c 662e 706c 6174 666f 726d  nd self.platform
-00048c80: 203d 3d20 2765 6d64 6227 3a0a 2020 2020   == 'emdb':.    
-00048c90: 2020 2020 2020 2020 7374 6172 7420 3d20          start = 
-00048ca0: 7469 6d65 6974 2e64 6566 6175 6c74 5f74  timeit.default_t
-00048cb0: 696d 6572 2829 0a20 2020 2020 2020 2020  imer().         
-00048cc0: 2020 2072 6d6d 6363 6320 3d20 7b7d 0a20     rmmccc = {}. 
-00048cd0: 2020 2020 2020 2020 2020 206d 6d63 635f             mmcc_
-00048ce0: 6469 6374 203d 207b 7d0a 2020 2020 2020  dict = {}.      
-00048cf0: 2020 2020 2020 6572 726c 6973 7420 3d20        errlist = 
-00048d00: 5b5d 0a20 2020 2020 2020 2020 2020 2066  [].            f
-00048d10: 6f72 206d 6f64 656c 6d61 7020 696e 2073  or modelmap in s
-00048d20: 656c 662e 6d6f 6465 6c73 6d61 7073 3a0a  elf.modelsmaps:.
-00048d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048d40: 7072 696e 7428 6d6f 6465 6c6d 6170 290a  print(modelmap).
+00047be0: 2020 2020 2020 2020 2023 204e 6f74 2073           # Not s
+00047bf0: 7572 6520 6966 2061 6c6c 2074 6865 206c  ure if all the l
+00047c00: 6574 7465 7273 2073 686f 756c 6420 6265  etters should be
+00047c10: 2072 6570 6c61 6365 640a 2020 2020 2020   replaced.      
+00047c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047c30: 2020 2020 2020 2320 3173 7420 7761 7920        # 1st way 
+00047c40: 6f66 2067 6574 7469 6e67 2072 6573 5f69  of getting res_i
+00047c50: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+00047c60: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00047c70: 7265 735f 6964 203d 2072 652e 7375 6228  res_id = re.sub(
+00047c80: 225c 4422 2c20 2222 2c20 7265 7374 6d70  "\D", "", restmp
+00047c90: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00047ca0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00047cb0: 326e 6420 7761 7920 6f66 2067 6574 7469  2nd way of getti
+00047cc0: 6e67 2072 6573 0a20 2020 2020 2020 2020  ng res.         
+00047cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047ce0: 2020 2072 6573 5f69 6420 3d20 7265 2e66     res_id = re.f
+00047cf0: 696e 6461 6c6c 2872 272d 3f5c 642b 272c  indall(r'-?\d+',
+00047d00: 2072 6573 746d 7029 5b30 5d0a 2020 2020   restmp)[0].    
+00047d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047d20: 2020 2020 2020 2020 6670 2e77 7269 7465          fp.write
+00047d30: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00047d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047d50: 2020 2763 6f6c 6f72 202f 2720 2b20 6368    'color /' + ch
+00047d60: 6169 6e20 2b20 273a 2720 2b20 7265 735f  ain + ':' + res_
+00047d70: 6964 202b 2027 2027 202b 2063 6f6c 6f72  id + ' ' + color
+00047d80: 202b 2027 5c6e 270a 2020 2020 2020 2020   + '\n'.        
+00047d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047da0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00047db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047dc0: 2020 6966 2071 7363 6f72 6520 3e20 312e    if qscore > 1.
+00047dd0: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+00047de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047df0: 2020 2066 702e 7772 6974 6528 0a20 2020     fp.write(.   
+00047e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047e20: 2027 7368 6f77 202f 2720 2b20 6368 6169   'show /' + chai
+00047e30: 6e20 2b20 273a 2720 2b20 7265 735f 6964  n + ':' + res_id
+00047e40: 202b 2027 2061 746f 6d73 2720 2b20 275c   + ' atoms' + '\
+00047e50: 6e27 0a20 2020 2020 2020 2020 2020 2020  n'.             
+00047e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047e70: 2020 2020 2020 2027 7374 796c 6520 2f27         'style /'
+00047e80: 202b 2063 6861 696e 202b 2027 3a27 202b   + chain + ':' +
+00047e90: 2072 6573 5f69 6420 2b20 2720 7374 6963   res_id + ' stic
+00047ea0: 6b27 202b 2027 5c6e 270a 2020 2020 2020  k' + '\n'.      
+00047eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047ec0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00047ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047ee0: 2020 2020 6670 2e77 7269 7465 280a 2020      fp.write(.  
+00047ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047f00: 2020 2020 2020 2020 2020 2273 6574 2062            "set b
+00047f10: 6743 6f6c 6f72 2077 6869 7465 2220 2b20  gColor white" + 
+00047f20: 275c 6e27 0a20 2020 2020 2020 2020 2020  '\n'.           
+00047f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047f40: 2022 6c69 6768 7469 6e67 2073 6f66 7422   "lighting soft"
+00047f50: 202b 2027 5c6e 270a 2020 2020 2020 2020   + '\n'.        
+00047f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047f70: 2020 2020 2276 6965 7720 636f 6672 2054      "view cofr T
+00047f80: 7275 6522 202b 2027 5c6e 270a 2020 2020  rue" + '\n'.    
+00047f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00047fa0: 2020 2020 2020 2020 2273 6176 6520 2220          "save " 
+00047fb0: 2b20 7374 7228 7375 7266 6163 6566 6e29  + str(surfacefn)
+00047fc0: 202b 2022 5f7a 7173 636f 7265 7375 7266   + "_zqscoresurf
+00047fd0: 6163 652e 6a70 6567 2220 2b20 2220 7375  ace.jpeg" + " su
+00047fe0: 7065 7273 616d 706c 6520 3320 7769 6474  persample 3 widt
+00047ff0: 6820 3132 3030 2068 6569 6768 7420 3132  h 1200 height 12
+00048000: 3030 2220 2b20 275c 6e27 0a20 2020 2020  00" + '\n'.     
+00048010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048020: 2020 2020 2020 2022 7475 726e 2078 202d         "turn x -
+00048030: 3930 2220 2b20 275c 6e27 0a20 2020 2020  90" + '\n'.     
+00048040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048050: 2020 2020 2020 2022 7475 726e 2079 202d         "turn y -
+00048060: 3930 2220 2b20 275c 6e27 0a20 2020 2020  90" + '\n'.     
+00048070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048080: 2020 2020 2020 2022 7669 6577 2063 6f66         "view cof
+00048090: 7220 5472 7565 2220 2b20 275c 6e27 0a20  r True" + '\n'. 
+000480a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000480b0: 2020 2020 2020 2020 2020 2022 7361 7665             "save
+000480c0: 2022 202b 2073 7472 2873 7572 6661 6365   " + str(surface
+000480d0: 666e 2920 2b20 225f 7871 7363 6f72 6573  fn) + "_xqscores
+000480e0: 7572 6661 6365 2e6a 7065 6722 202b 2022  urface.jpeg" + "
+000480f0: 2073 7570 6572 7361 6d70 6c65 2033 2077   supersample 3 w
+00048100: 6964 7468 2031 3230 3020 6865 6967 6874  idth 1200 height
+00048110: 2031 3230 3022 202b 2027 5c6e 270a 2020   1200" + '\n'.  
+00048120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048130: 2020 2020 2020 2020 2020 2276 6965 7720            "view 
+00048140: 6f72 6965 6e74 2220 2b20 275c 6e27 0a20  orient" + '\n'. 
+00048150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048160: 2020 2020 2020 2020 2020 2022 7475 726e             "turn
+00048170: 2078 2039 3022 202b 2027 5c6e 270a 2020   x 90" + '\n'.  
+00048180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048190: 2020 2020 2020 2020 2020 2274 7572 6e20            "turn 
+000481a0: 7a20 3930 2220 2b20 275c 6e27 0a20 2020  z 90" + '\n'.   
+000481b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000481c0: 2020 2020 2020 2020 2022 7669 6577 2063           "view c
+000481d0: 6f66 7220 5472 7565 2220 2b20 275c 6e27  ofr True" + '\n'
+000481e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000481f0: 2020 2020 2020 2020 2020 2020 2022 7361               "sa
+00048200: 7665 2022 202b 2073 7472 2873 7572 6661  ve " + str(surfa
+00048210: 6365 666e 2920 2b20 225f 7971 7363 6f72  cefn) + "_yqscor
+00048220: 6573 7572 6661 6365 2e6a 7065 6722 202b  esurface.jpeg" +
+00048230: 2022 2073 7570 6572 7361 6d70 6c65 2033   " supersample 3
+00048240: 2077 6964 7468 2031 3230 3020 6865 6967   width 1200 heig
+00048250: 6874 2031 3230 3022 202b 2027 5c6e 270a  ht 1200" + '\n'.
+00048260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048270: 2020 2020 2020 2020 2020 2020 2263 6c6f              "clo
+00048280: 7365 2061 6c6c 2220 2b20 225c 6e22 0a20  se all" + "\n". 
+00048290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000482a0: 2020 2020 2020 2020 2020 2022 6578 6974             "exit
+000482b0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+000482c0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+000482d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000482e0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+000482f0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00048300: 6e6f 7420 6269 6e64 6973 706c 6179 3a0a  not bindisplay:.
+00048310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048320: 2020 2020 2020 2020 2020 2020 7375 6270              subp
+00048330: 726f 6365 7373 2e63 6865 636b 5f63 616c  rocess.check_cal
+00048340: 6c28 6c6f 6343 4849 4d45 5241 202b 2022  l(locCHIMERA + "
+00048350: 202d 2d6f 6666 7363 7265 656e 202d 2d6e   --offscreen --n
+00048360: 6f67 7569 2022 202b 2073 656c 662e 776f  ogui " + self.wo
+00048370: 726b 6469 7220 2b20 6368 696d 6572 6163  rkdir + chimerac
+00048380: 6d64 2c0a 2020 2020 2020 2020 2020 2020  md,.            
+00048390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000483a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000483b0: 2020 2020 2020 6377 643d 7365 6c66 2e77        cwd=self.w
+000483c0: 6f72 6b64 6972 2c20 7368 656c 6c3d 5472  orkdir, shell=Tr
+000483d0: 7565 290a 2020 2020 2020 2020 2020 2020  ue).            
+000483e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000483f0: 7072 696e 7428 2743 6f6c 6f72 6564 206d  print('Colored m
+00048400: 6f64 656c 7320 6261 7365 6420 6f6e 2051  odels based on Q
+00048410: 7363 6f72 6520 7765 7265 2070 726f 6475  score were produ
+00048420: 6365 642e 2729 0a20 2020 2020 2020 2020  ced.').         
+00048430: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00048440: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00048450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048460: 2073 7562 7072 6f63 6573 732e 6368 6563   subprocess.chec
+00048470: 6b5f 6361 6c6c 286c 6f63 4348 494d 4552  k_call(locCHIMER
+00048480: 4120 2b20 2220 2220 2b20 7365 6c66 2e77  A + " " + self.w
+00048490: 6f72 6b64 6972 202b 2063 6869 6d65 7261  orkdir + chimera
+000484a0: 636d 642c 2063 7764 3d73 656c 662e 776f  cmd, cwd=self.wo
+000484b0: 726b 6469 722c 0a20 2020 2020 2020 2020  rkdir,.         
+000484c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000484d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000484e0: 2020 2020 2020 2020 2073 6865 6c6c 3d54           shell=T
+000484f0: 7275 6529 0a20 2020 2020 2020 2020 2020  rue).           
+00048500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048510: 2070 7269 6e74 2827 436f 6c6f 7265 6420   print('Colored 
+00048520: 6d6f 6465 6c73 2062 6173 6564 206f 6e20  models based on 
+00048530: 5173 636f 7265 2077 6572 6520 7072 6f64  Qscore were prod
+00048540: 7563 6564 2e27 290a 2020 2020 2020 2020  uced.').        
+00048550: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+00048560: 7074 2073 7562 7072 6f63 6573 732e 4361  pt subprocess.Ca
+00048570: 6c6c 6564 5072 6f63 6573 7345 7272 6f72  lledProcessError
+00048580: 2061 7320 7375 6265 7272 3a0a 2020 2020   as suberr:.    
+00048590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000485a0: 2020 2020 6572 7220 3d20 2753 6176 696e      err = 'Savin
+000485b0: 6720 6d6f 6465 6c20 7b7d 2051 7363 6f72  g model {} Qscor
+000485c0: 6520 7669 6577 2065 7272 6f72 3a20 7b7d  e view error: {}
+000485d0: 2e27 2e66 6f72 6d61 7428 6d6f 6465 6c6e  .'.format(modeln
+000485e0: 616d 652c 2073 7562 6572 7229 0a20 2020  ame, suberr).   
+000485f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048600: 2020 2020 2065 7272 6c69 7374 2e61 7070       errlist.app
+00048610: 656e 6428 6572 7229 0a20 2020 2020 2020  end(err).       
+00048620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048630: 2073 7973 2e73 7464 6572 722e 7772 6974   sys.stderr.writ
+00048640: 6528 6572 7220 2b20 275c 6e27 290a 0a20  e(err + '\n').. 
+00048650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048660: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00048670: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048680: 7365 6c66 2e73 6361 6c65 5f73 7572 6661  self.scale_surfa
+00048690: 6365 7669 6577 2829 0a20 2020 2020 2020  ceview().       
+000486a0: 2020 2020 2020 2020 2020 2020 2065 7863               exc
+000486b0: 6570 743a 0a20 2020 2020 2020 2020 2020  ept:.           
+000486c0: 2020 2020 2020 2020 2020 2020 2065 7272               err
+000486d0: 203d 2027 5363 616c 696e 6720 6d6f 6465   = 'Scaling mode
+000486e0: 6c20 5173 636f 7265 2076 6965 7720 6572  l Qscore view er
+000486f0: 726f 723a 207b 7d2e 272e 666f 726d 6174  ror: {}.'.format
+00048700: 2873 7973 2e65 7863 5f69 6e66 6f28 295b  (sys.exc_info()[
+00048710: 315d 290a 2020 2020 2020 2020 2020 2020  1]).            
+00048720: 2020 2020 2020 2020 2020 2020 6572 726c              errl
+00048730: 6973 742e 6170 7065 6e64 2865 7272 290a  ist.append(err).
+00048740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048750: 2020 2020 2020 2020 7379 732e 7374 6465          sys.stde
+00048760: 7272 2e77 7269 7465 2865 7272 202b 2027  rr.write(err + '
+00048770: 5c6e 2729 0a0a 2020 2020 2020 2020 2020  \n')..          
+00048780: 2020 2020 2020 2020 2020 6a70 6567 7320            jpegs 
+00048790: 3d20 676c 6f62 2e67 6c6f 6228 7365 6c66  = glob.glob(self
+000487a0: 2e77 6f72 6b64 6972 202b 2027 2f2a 7375  .workdir + '/*su
+000487b0: 7266 6163 652e 6a70 6567 2729 0a20 2020  rface.jpeg').   
+000487c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000487d0: 206d 6f64 656c 7375 7266 203d 2064 6963   modelsurf = dic
+000487e0: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
+000487f0: 2020 2020 2020 2020 6669 6e61 6c6d 6d64          finalmmd
+00048800: 6963 7420 3d20 6469 6374 2829 0a20 2020  ict = dict().   
+00048810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048820: 2069 6620 7365 6c66 2e6d 6f64 656c 733a   if self.models:
+00048830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00048840: 2020 2020 2020 2020 2023 2070 7269 6e74           # print
+00048850: 2022 7365 6c66 2e6d 6f64 656c 733a 2573   "self.models:%s
+00048860: 2220 2520 7365 6c66 2e6d 6f64 656c 730a  " % self.models.
+00048870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048880: 2020 2020 2020 2020 666f 7220 6d6f 6465          for mode
+00048890: 6c20 696e 2073 656c 662e 6d6f 6465 6c73  l in self.models
+000488a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000488b0: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
+000488c0: 6465 6c6e 616d 6520 3d20 6f73 2e70 6174  delname = os.pat
+000488d0: 682e 6261 7365 6e61 6d65 286d 6f64 656c  h.basename(model
+000488e0: 2e66 696c 656e 616d 6529 0a20 2020 2020  .filename).     
+000488f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048900: 2020 2020 2020 2073 7572 6661 6365 666e         surfacefn
+00048910: 203d 2027 7b7d 5f7b 7d27 2e66 6f72 6d61   = '{}_{}'.forma
+00048920: 7428 6d6f 6465 6c6e 616d 652c 2073 656c  t(modelname, sel
+00048930: 662e 6d61 706e 616d 6529 0a20 2020 2020  f.mapname).     
+00048940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048950: 2020 2020 2020 206d 6f64 656c 6d61 7073         modelmaps
+00048960: 7572 6661 6365 203d 2064 6963 7428 290a  urface = dict().
+00048970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048980: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00048990: 6a70 6567 2069 6e20 6a70 6567 733a 0a20  jpeg in jpegs:. 
+000489a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000489b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000489c0: 6620 6d6f 6465 6c6e 616d 6520 696e 206a  f modelname in j
+000489d0: 7065 6720 616e 6420 2778 7173 636f 7265  peg and 'xqscore
+000489e0: 2720 696e 206a 7065 673a 0a20 2020 2020  ' in jpeg:.     
+000489f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048a00: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00048a10: 6f64 656c 6d61 7073 7572 6661 6365 5b27  odelmapsurface['
+00048a20: 7827 5d20 3d20 7374 7228 7375 7266 6163  x'] = str(surfac
+00048a30: 6566 6e29 202b 2027 5f73 6361 6c65 645f  efn) + '_scaled_
+00048a40: 7871 7363 6f72 6573 7572 6661 6365 2e6a  xqscoresurface.j
+00048a50: 7065 6727 0a20 2020 2020 2020 2020 2020  peg'.           
+00048a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048a70: 2020 2020 2069 6620 6d6f 6465 6c6e 616d       if modelnam
+00048a80: 6520 696e 206a 7065 6720 616e 6420 2779  e in jpeg and 'y
+00048a90: 7173 636f 7265 2720 696e 206a 7065 673a  qscore' in jpeg:
+00048aa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00048ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048ac0: 2020 2020 206d 6f64 656c 6d61 7073 7572       modelmapsur
+00048ad0: 6661 6365 5b27 7927 5d20 3d20 7374 7228  face['y'] = str(
+00048ae0: 7375 7266 6163 6566 6e29 202b 2027 5f73  surfacefn) + '_s
+00048af0: 6361 6c65 645f 7971 7363 6f72 6573 7572  caled_yqscoresur
+00048b00: 6661 6365 2e6a 7065 6727 0a20 2020 2020  face.jpeg'.     
+00048b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048b20: 2020 2020 2020 2020 2020 2069 6620 6d6f             if mo
+00048b30: 6465 6c6e 616d 6520 696e 206a 7065 6720  delname in jpeg 
+00048b40: 616e 6420 277a 7173 636f 7265 2720 696e  and 'zqscore' in
+00048b50: 206a 7065 673a 0a20 2020 2020 2020 2020   jpeg:.         
+00048b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048b70: 2020 2020 2020 2020 2020 206d 6f64 656c             model
+00048b80: 6d61 7073 7572 6661 6365 5b27 7a27 5d20  mapsurface['z'] 
+00048b90: 3d20 7374 7228 7375 7266 6163 6566 6e29  = str(surfacefn)
+00048ba0: 202b 2027 5f73 6361 6c65 645f 7a71 7363   + '_scaled_zqsc
+00048bb0: 6f72 6573 7572 6661 6365 2e6a 7065 6727  oresurface.jpeg'
+00048bc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00048bd0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00048be0: 6572 726c 6973 743a 0a20 2020 2020 2020  errlist:.       
+00048bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048c00: 2020 2020 2020 2020 206d 6f64 656c 6d61           modelma
+00048c10: 7073 7572 6661 6365 5b27 6572 7227 5d20  psurface['err'] 
+00048c20: 3d20 7b27 6d6f 6465 6c5f 6669 745f 6572  = {'model_fit_er
+00048c30: 7227 3a20 6572 726c 6973 747d 0a20 2020  r': errlist}.   
+00048c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048c50: 2020 2020 2020 2020 206d 6f64 656c 7375           modelsu
+00048c60: 7266 5b6d 6f64 656c 6e61 6d65 5d20 3d20  rf[modelname] = 
+00048c70: 6d6f 6465 6c6d 6170 7375 7266 6163 650a  modelmapsurface.
+00048c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048c90: 2020 2020 2020 2020 6669 6e61 6c6d 6d64          finalmmd
+00048ca0: 6963 745b 2771 7363 6f72 655f 7375 7266  ict['qscore_surf
+00048cb0: 6163 6527 5d20 3d20 6d6f 6465 6c73 7572  ace'] = modelsur
+00048cc0: 660a 0a20 2020 2020 2020 2020 2020 2020  f..             
+00048cd0: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+00048ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048cf0: 2020 2020 2020 2020 2020 2020 7769 7468              with
+00048d00: 2063 6f64 6563 732e 6f70 656e 2873 656c   codecs.open(sel
+00048d10: 662e 776f 726b 6469 7220 2b20 7365 6c66  f.workdir + self
+00048d20: 2e6d 6170 6e61 6d65 202b 2027 5f71 7363  .mapname + '_qsc
+00048d30: 6f72 6576 6965 772e 6a73 6f6e 272c 2027  oreview.json', '
+00048d40: 7727 2c0a 2020 2020 2020 2020 2020 2020  w',.            
 00048d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048d60: 6d6f 6465 6c6d 6170 5f6e 616d 6520 3d20  modelmap_name = 
-00048d70: 6f73 2e70 6174 682e 6261 7365 6e61 6d65  os.path.basename
-00048d80: 286d 6f64 656c 6d61 7029 0a20 2020 2020  (modelmap).     
-00048d90: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-00048da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048db0: 2020 2020 6d6d 6170 203d 206d 7263 6669      mmap = mrcfi
-00048dc0: 6c65 2e6d 6d61 7028 6d6f 6465 6c6d 6170  le.mmap(modelmap
-00048dd0: 2c20 6d6f 6465 3d27 7227 290a 2020 2020  , mode='r').    
-00048de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048df0: 6d6d 6170 6461 7461 203d 206d 6d61 702e  mmapdata = mmap.
-00048e00: 6461 7461 0a20 2020 2020 2020 2020 2020  data.           
-00048e10: 2020 2020 2020 2020 206d 6d63 6320 3d20           mmcc = 
-00048e20: 7275 6e5f 7265 616c 6d6d 6363 2873 656c  run_realmmcc(sel
-00048e30: 662e 6d61 702e 6461 7461 2c20 6d6d 6170  f.map.data, mmap
-00048e40: 6461 7461 295b 315d 0a20 2020 2020 2020  data)[1].       
-00048e50: 2020 2020 2020 2020 2020 2020 206d 6d63               mmc
-00048e60: 635f 6469 6374 5b6d 6f64 656c 6d61 705f  c_dict[modelmap_
-00048e70: 6e61 6d65 5d20 3d20 6d6d 6363 0a20 2020  name] = mmcc.   
-00048e80: 2020 2020 2020 2020 2020 2020 2065 7863               exc
-00048e90: 6570 743a 0a20 2020 2020 2020 2020 2020  ept:.           
-00048ea0: 2020 2020 2020 2020 2065 7272 203d 2027           err = '
-00048eb0: 4d61 7020 616e 6420 6d6f 6465 6c20 7b7d  Map and model {}
-00048ec0: 2072 6561 6c20 7370 6163 6520 4343 2063   real space CC c
-00048ed0: 616c 6375 6c61 7469 6f6e 2065 7272 6f72  alculation error
-00048ee0: 3a20 7b7d 2e27 2e66 6f72 6d61 7428 6d6f  : {}.'.format(mo
-00048ef0: 6465 6c6d 6170 5f6e 616d 652c 2073 7973  delmap_name, sys
-00048f00: 2e65 7863 5f69 6e66 6f28 295b 315d 290a  .exc_info()[1]).
-00048f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00048f20: 2020 2020 6572 726c 6973 742e 6170 7065      errlist.appe
-00048f30: 6e64 2865 7272 290a 2020 2020 2020 2020  nd(err).        
-00048f40: 2020 2020 2020 2020 2020 2020 7379 732e              sys.
-00048f50: 7374 6465 7272 2e77 7269 7465 2865 7272  stderr.write(err
-00048f60: 202b 2027 5c6e 2729 0a0a 2020 2020 2020   + '\n')..      
-00048f70: 2020 2020 2020 6966 2065 7272 6c69 7374        if errlist
-00048f80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00048f90: 2020 726d 6d63 6363 5b27 6572 7227 5d20    rmmccc['err'] 
-00048fa0: 3d20 7b27 726d 6d63 6363 5f65 7272 273a  = {'rmmccc_err':
-00048fb0: 2065 7272 6c69 7374 7d0a 2020 2020 2020   errlist}.      
-00048fc0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00048fd0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-00048fe0: 7428 274e 6f20 6572 726f 7220 696e 2072  t('No error in r
-00048ff0: 6d6d 6363 6320 6361 6c63 756c 6174 696f  mmccc calculatio
-00049000: 6e2e 2729 0a0a 2020 2020 2020 2020 2020  n.')..          
-00049010: 2020 726d 6d63 6363 5b27 726d 6d63 6363    rmmccc['rmmccc
-00049020: 275d 203d 206d 6d63 635f 6469 6374 0a20  '] = mmcc_dict. 
-00049030: 2020 2020 2020 2020 2020 2069 6620 726d             if rm
-00049040: 6d63 6363 3a0a 2020 2020 2020 2020 2020  mccc:.          
-00049050: 2020 2020 2020 7769 7468 2063 6f64 6563        with codec
-00049060: 732e 6f70 656e 2873 656c 662e 776f 726b  s.open(self.work
-00049070: 6469 7220 2b20 7365 6c66 2e6d 6170 6e61  dir + self.mapna
-00049080: 6d65 202b 2027 5f72 6d6d 6363 7363 6f72  me + '_rmmccscor
-00049090: 652e 6a73 6f6e 272c 2027 7727 2c20 656e  e.json', 'w', en
-000490a0: 636f 6469 6e67 3d27 7574 662d 3827 2920  coding='utf-8') 
-000490b0: 6173 2066 3a0a 2020 2020 2020 2020 2020  as f:.          
-000490c0: 2020 2020 2020 2020 2020 6a73 6f6e 2e64            json.d
-000490d0: 756d 7028 726d 6d63 6363 2c20 6629 0a20  ump(rmmccc, f). 
-000490e0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-000490f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00049100: 2070 7269 6e74 2827 4e6f 206d 6f64 656c   print('No model
-00049110: 206d 6170 2043 4320 6973 2063 616c 6375   map CC is calcu
-00049120: 6c61 7465 642c 2063 6865 636b 2074 6865  lated, check the
-00049130: 2065 7272 6f72 2069 6e66 6f72 6d61 7469   error informati
-00049140: 6f6e 2e27 290a 0a20 2020 2020 2020 2020  on.')..         
-00049150: 2020 2065 6e64 203d 2074 696d 6569 742e     end = timeit.
-00049160: 6465 6661 756c 745f 7469 6d65 7228 290a  default_timer().
-00049170: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-00049180: 7428 2752 6561 6c20 7370 6163 6520 6d6f  t('Real space mo
-00049190: 6465 6c20 616e 6420 6d61 7020 4372 6f73  del and map Cros
-000491a0: 732d 436f 7272 656c 6174 696f 6e20 436f  s-Correlation Co
-000491b0: 6566 6669 6369 656e 7420 7469 6d65 3a20  efficient time: 
-000491c0: 2573 2720 2520 2865 6e64 202d 2073 7461  %s' % (end - sta
-000491d0: 7274 2929 0a20 2020 2020 2020 2020 2020  rt)).           
-000491e0: 2070 7269 6e74 2827 2d2d 2d2d 2d2d 2d2d   print('--------
-000491f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00049200: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2729 0a0a  ------------')..
-00049210: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00049220: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-00049230: 274e 6f20 6d6f 6465 6c20 6d61 7020 666f  'No model map fo
-00049240: 7220 6d6f 6465 6c20 616e 6420 6d61 7020  r model and map 
-00049250: 7265 616c 2073 7061 6365 2063 726f 7373  real space cross
-00049260: 2d63 6f72 7265 6c61 7469 6f6e 2063 616c  -correlation cal
-00049270: 6375 6c61 7469 6f6e 2e27 290a 2020 2020  culation.').    
-00049280: 2020 2020 2020 2020 7072 696e 7428 272d          print('-
-00049290: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000492a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000492b0: 2d2d 2d27 290a 0a20 2020 2020 2020 2072  ---')..        r
-000492c0: 6574 7572 6e20 4e6f 6e65 0a0a 0a20 2020  eturn None...   
-000492d0: 2064 6566 2073 6d6f 635f 6261 7228 7365   def smoc_bar(se
-000492e0: 6c66 293a 0a20 2020 2020 2020 2022 2222  lf):.        """
-000492f0: 0a20 2020 2020 2020 2073 6d6f 6320 6361  .        smoc ca
-00049300: 6c63 7561 6c74 696f 6e20 616e 6420 6261  lcualtion and ba
-00049310: 720a 2020 2020 2020 2020 2222 220a 0a20  r.        """.. 
-00049320: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
-00049330: 6c66 2e6f 6e6c 7962 6172 3a0a 2020 2020  lf.onlybar:.    
-00049340: 2020 2020 2020 2020 7365 6c66 2e73 6d6f          self.smo
-00049350: 6328 290a 2020 2020 2020 2020 7365 6c66  c().        self
-00049360: 2e67 6574 5f62 6172 2873 636f 7265 5f74  .get_bar(score_t
-00049370: 7970 653d 2773 6d6f 6327 290a 0a20 2020  ype='smoc')..   
-00049380: 2023 2075 7365 206c 6174 6573 7420 5445   # use latest TE
-00049390: 4d50 7920 322e 3020 666f 7220 736d 6f63  MPy 2.0 for smoc
-000493a0: 2063 616c 6375 6c61 7469 6f6e 0a20 2020   calculation.   
-000493b0: 2064 6566 2073 6d6f 6328 7365 6c66 293a   def smoc(self):
-000493c0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-000493d0: 2020 2020 2020 2020 2072 756e 2073 6d6f           run smo
-000493e0: 630a 2020 2020 2020 2020 3a72 6574 7572  c.        :retur
-000493f0: 6e3a 0a20 2020 2020 2020 2022 2222 0a20  n:.        """. 
-00049400: 2020 2020 2020 2069 6620 7365 6c66 2e70         if self.p
-00049410: 6c61 7466 6f72 6d20 3d3d 2027 656d 6462  latform == 'emdb
-00049420: 2720 616e 6420 7365 6c66 2e6d 6574 2021  ' and self.met !
-00049430: 3d20 2774 6f6d 6f27 3a0a 2020 2020 2020  = 'tomo':.      
-00049440: 2020 2020 2020 7374 6172 7420 3d20 7469        start = ti
-00049450: 6d65 6974 2e64 6566 6175 6c74 5f74 696d  meit.default_tim
-00049460: 6572 2829 0a20 2020 2020 2020 2020 2020  er().           
-00049470: 2065 7272 6c69 7374 203d 205b 5d0a 2020   errlist = [].  
-00049480: 2020 2020 2020 2020 2020 7265 7375 6c74            result
-00049490: 5f64 6963 7420 3d20 7b7d 0a20 2020 2020  _dict = {}.     
-000494a0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-000494b0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-000494c0: 656c 662e 6d6f 6465 6c73 3a0a 2020 2020  elf.models:.    
-000494d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000494e0: 636f 756e 7420 3d20 300a 2020 2020 2020  count = 0.      
-000494f0: 2020 2020 2020 2020 2020 2020 2020 6669                fi
-00049500: 6e61 6c5f 6469 6374 203d 207b 7d0a 2020  nal_dict = {}.  
-00049510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049520: 2020 6f75 745f 7061 7468 203d 2027 7b7d    out_path = '{}
-00049530: 2f73 6d6f 6327 2e66 6f72 6d61 7428 7365  /smoc'.format(se
-00049540: 6c66 2e77 6f72 6b64 6972 290a 2020 2020  lf.workdir).    
-00049550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049560: 666f 7220 6d6f 6465 6c20 696e 2073 656c  for model in sel
-00049570: 662e 6d6f 6465 6c73 3a0a 2020 2020 2020  f.models:.      
-00049580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049590: 2020 6675 6c6c 5f6d 6f64 656c 203d 2027    full_model = '
-000495a0: 7b7d 7b7d 272e 666f 726d 6174 2873 656c  {}{}'.format(sel
-000495b0: 662e 776f 726b 6469 722c 206f 732e 7061  f.workdir, os.pa
-000495c0: 7468 2e62 6173 656e 616d 6528 6d6f 6465  th.basename(mode
-000495d0: 6c2e 6669 6c65 6e61 6d65 2929 0a20 2020  l.filename)).   
-000495e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000495f0: 2020 2020 2066 756c 6c5f 6d61 7020 3d20       full_map = 
-00049600: 277b 7d7b 7d27 2e66 6f72 6d61 7428 7365  '{}{}'.format(se
-00049610: 6c66 2e77 6f72 6b64 6972 2c20 7365 6c66  lf.workdir, self
-00049620: 2e6d 6170 6e61 6d65 290a 2020 2020 2020  .mapname).      
-00049630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049640: 2020 7265 7320 3d20 7365 6c66 2e72 6573    res = self.res
-00049650: 6f6c 7574 696f 6e0a 0a20 2020 2020 2020  olution..       
-00049660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049670: 2072 6469 6374 2c20 7265 7272 203d 2072   rdict, rerr = r
-00049680: 756e 5f73 6d6f 6328 6675 6c6c 5f6d 6f64  un_smoc(full_mod
-00049690: 656c 2c20 6675 6c6c 5f6d 6170 2c20 7265  el, full_map, re
-000496a0: 732c 206f 7574 5f70 6174 6829 0a20 2020  s, out_path).   
-000496b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000496c0: 2020 2020 2069 6620 7264 6963 743a 0a0a       if rdict:..
-000496d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000496e0: 2020 2020 2020 2020 2020 2020 6669 6e61              fina
-000496f0: 6c5f 6469 6374 5b73 7472 2863 6f75 6e74  l_dict[str(count
-00049700: 295d 203d 2072 6469 6374 0a20 2020 2020  )] = rdict.     
-00049710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049720: 2020 2020 2020 2063 6f75 6e74 202b 3d20         count += 
-00049730: 310a 0a20 2020 2020 2020 2020 2020 2020  1..             
-00049740: 2020 2020 2020 2020 2020 2065 6e64 203d             end =
-00049750: 2074 696d 6569 742e 6465 6661 756c 745f   timeit.default_
-00049760: 7469 6d65 7228 290a 2020 2020 2020 2020  timer().        
-00049770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049780: 7072 696e 7428 2753 4d4f 4320 7469 6d65  print('SMOC time
-00049790: 3a20 2573 2720 2520 2865 6e64 202d 2073  : %s' % (end - s
-000497a0: 7461 7274 2929 0a20 2020 2020 2020 2020  tart)).         
-000497b0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-000497c0: 7269 6e74 2827 2d2d 2d2d 2d2d 2d2d 2d2d  rint('----------
-000497d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000497e0: 2d2d 2d2d 2d2d 2d2d 2d2d 2729 0a20 2020  ----------').   
-000497f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049800: 2020 2020 2069 6620 7265 7272 3a0a 2020       if rerr:.  
-00049810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049820: 2020 2020 2020 2020 2020 6572 7220 3d20            err = 
-00049830: 2753 4d4f 4320 6361 6c63 756c 6174 696f  'SMOC calculatio
-00049840: 6e20 6572 726f 723a 207b 7d27 2e66 6f72  n error: {}'.for
-00049850: 6d61 7428 7265 7272 290a 2020 2020 2020  mat(rerr).      
-00049860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049870: 2020 2020 2020 6572 726c 6973 742e 6170        errlist.ap
-00049880: 7065 6e64 2865 7272 290a 2020 2020 2020  pend(err).      
-00049890: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000498a0: 2020 2020 2020 7379 732e 7374 6465 7272        sys.stderr
-000498b0: 2e77 7269 7465 2865 7272 202b 2027 5c6e  .write(err + '\n
-000498c0: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
-000498d0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-000498e0: 7269 6e74 2827 2d2d 2d2d 2d2d 2d2d 2d2d  rint('----------
-000498f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00049900: 2d2d 2d2d 2d2d 2d2d 2d2d 2729 0a0a 2020  ----------')..  
-00049910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049920: 2020 6966 2066 696e 616c 5f64 6963 743a    if final_dict:
-00049930: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00049940: 2020 2020 2020 2020 2072 6573 756c 745f           result_
-00049950: 6469 6374 5b27 736d 6f63 275d 203d 2066  dict['smoc'] = f
-00049960: 696e 616c 5f64 6963 740a 0a20 2020 2020  inal_dict..     
-00049970: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00049980: 6620 6572 726c 6973 743a 0a20 2020 2020  f errlist:.     
-00049990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000499a0: 2020 2072 6573 756c 745f 6469 6374 5b27     result_dict['
-000499b0: 6572 7227 5d20 3d20 6572 726c 6973 740a  err'] = errlist.
-000499c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000499d0: 2020 2020 2069 6620 7265 7375 6c74 5f64       if result_d
-000499e0: 6963 743a 0a20 2020 2020 2020 2020 2020  ict:.           
-000499f0: 2020 2020 2020 2020 2020 2020 2074 7279               try
-00049a00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00049a10: 2020 2020 2020 2020 2020 2020 2020 7769                wi
-00049a20: 7468 2063 6f64 6563 732e 6f70 656e 2873  th codecs.open(s
-00049a30: 656c 662e 776f 726b 6469 7220 2b20 7365  elf.workdir + se
-00049a40: 6c66 2e6d 6170 6e61 6d65 202b 2027 5f73  lf.mapname + '_s
-00049a50: 6d6f 632e 6a73 6f6e 272c 2027 7727 2c0a  moc.json', 'w',.
-00049a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049a80: 2020 2020 2020 2020 2020 2020 2065 6e63               enc
-00049a90: 6f64 696e 673d 2775 7466 2d38 2729 2061  oding='utf-8') a
-00049aa0: 7320 663a 0a20 2020 2020 2020 2020 2020  s f:.           
-00049ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049ac0: 2020 2020 206a 736f 6e2e 6475 6d70 2872       json.dump(r
-00049ad0: 6573 756c 745f 6469 6374 2c20 6629 0a0a  esult_dict, f)..
-00049ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049af0: 2020 2020 2020 2020 2020 2020 7769 7468              with
-00049b00: 2063 6f64 6563 732e 6f70 656e 286f 7574   codecs.open(out
-00049b10: 5f70 6174 6820 2b20 272f 2720 2b20 7365  _path + '/' + se
-00049b20: 6c66 2e6d 6170 6e61 6d65 202b 2027 5f73  lf.mapname + '_s
-00049b30: 6d6f 632e 6a73 6f6e 272c 2027 7727 2c20  moc.json', 'w', 
-00049b40: 656e 636f 6469 6e67 3d27 7574 662d 3827  encoding='utf-8'
-00049b50: 2920 6173 2066 663a 0a20 2020 2020 2020  ) as ff:.       
-00049b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049b70: 2020 2020 2020 2020 206a 736f 6e2e 6475           json.du
-00049b80: 6d70 2872 6573 756c 745f 6469 6374 2c20  mp(result_dict, 
-00049b90: 6666 290a 2020 2020 2020 2020 2020 2020  ff).            
-00049ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049bb0: 7365 6c66 2e73 6d6f 635f 7375 7266 6163  self.smoc_surfac
-00049bc0: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
-00049bd0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-00049be0: 7074 3a0a 2020 2020 2020 2020 2020 2020  pt:.            
-00049bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049c00: 7379 732e 7374 6465 7272 2e77 7269 7465  sys.stderr.write
-00049c10: 2827 5361 7669 6e67 2074 6f20 534d 4f43  ('Saving to SMOC
-00049c20: 206a 736f 6e20 6572 726f 723a 207b 7d2e   json error: {}.
-00049c30: 5c6e 272e 666f 726d 6174 2873 7973 2e65  \n'.format(sys.e
-00049c40: 7863 5f69 6e66 6f28 295b 315d 2929 0a20  xc_info()[1])). 
-00049c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049c60: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00049c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049c80: 2070 7269 6e74 2827 534d 4f43 2077 6173   print('SMOC was
-00049c90: 206e 6f74 2063 6f6c 6c65 6374 6564 2c20   not collected, 
-00049ca0: 706c 6561 7365 2063 6865 636b 2127 290a  please check!').
-00049cb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00049cc0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00049cd0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00049ce0: 2827 4e6f 206d 6f64 656c 206f 7220 736f  ('No model or so
-00049cf0: 6d65 7468 696e 6720 7772 6f6e 6720 7769  mething wrong wi
-00049d00: 7468 206d 6f64 656c 206c 6f61 6469 6e67  th model loading
-00049d10: 2e27 290a 2020 2020 2020 2020 2020 2020  .').            
-00049d20: 2020 2020 2020 2020 7072 696e 7428 272d          print('-
-00049d30: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00049d40: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00049d50: 2d2d 2d27 290a 2020 2020 2020 2020 2020  ---').          
-00049d60: 2020 6578 6365 7074 3a0a 2020 2020 2020    except:.      
-00049d70: 2020 2020 2020 2020 2020 6572 7220 3d20            err = 
-00049d80: 2753 4d4f 4320 6361 6c63 756c 6174 696f  'SMOC calculatio
-00049d90: 6e20 6572 726f 723a 207b 7d2e 272e 666f  n error: {}.'.fo
-00049da0: 726d 6174 2873 7973 2e65 7863 5f69 6e66  rmat(sys.exc_inf
-00049db0: 6f28 295b 315d 290a 2020 2020 2020 2020  o()[1]).        
-00049dc0: 2020 2020 2020 2020 6572 726c 6973 742e          errlist.
-00049dd0: 6170 7065 6e64 2865 7272 290a 2020 2020  append(err).    
-00049de0: 2020 2020 2020 2020 2020 2020 7379 732e              sys.
-00049df0: 7374 6465 7272 2e77 7269 7465 2865 7272  stderr.write(err
-00049e00: 202b 2027 5c6e 2729 0a0a 0a20 2020 2020   + '\n')...     
-00049e10: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00049e20: 2020 2020 2070 7269 6e74 2827 4368 6563       print('Chec
-00049e30: 6b20 7468 6520 656e 7472 792c 2074 6865  k the entry, the
-00049e40: 7265 2069 7320 6e6f 2053 4d4f 4320 666f  re is no SMOC fo
-00049e50: 7220 7468 6973 2065 6e74 7279 2e27 290a  r this entry.').
-00049e60: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00049e70: 4e6f 6e65 0a0a 2020 2020 6465 6620 6765  None..    def ge
-00049e80: 745f 6261 7228 7365 6c66 2c20 7363 6f72  t_bar(self, scor
-00049e90: 655f 7479 7065 293a 0a0a 0a20 2020 2020  e_type):...     
-00049ea0: 2020 2073 636f 7265 5f6c 6973 7420 3d20     score_list = 
-00049eb0: 5b27 6363 6327 2c20 2743 4343 272c 2027  ['ccc', 'CCC', '
-00049ec0: 6174 6f6d 5f69 6e63 6c75 7369 6f6e 5f62  atom_inclusion_b
-00049ed0: 795f 6c65 7665 6c27 2c20 2773 6d6f 6327  y_level', 'smoc'
-00049ee0: 2c20 2771 7363 6f72 6527 5d0a 2020 2020  , 'qscore'].    
-00049ef0: 2020 2020 6669 6c65 5f6e 616d 6520 3d20      file_name = 
-00049f00: 4e6f 6e65 0a20 2020 2020 2020 2069 6620  None.        if 
-00049f10: 7363 6f72 655f 7479 7065 203d 3d20 2773  score_type == 's
-00049f20: 6d6f 6327 3a0a 2020 2020 2020 2020 2020  moc':.          
-00049f30: 2020 6669 6c65 5f6e 616d 6520 3d20 277b    file_name = '{
-00049f40: 7d2f 7b7d 5f7b 7d2e 6a73 6f6e 272e 666f  }/{}_{}.json'.fo
-00049f50: 726d 6174 2873 656c 662e 776f 726b 6469  rmat(self.workdi
-00049f60: 722c 2073 656c 662e 6d61 706e 616d 652c  r, self.mapname,
-00049f70: 2073 636f 7265 5f74 7970 6529 0a20 2020   score_type).   
-00049f80: 2020 2020 2065 6c69 6620 7363 6f72 655f       elif score_
-00049f90: 7479 7065 203d 3d20 2763 6363 273a 0a20  type == 'ccc':. 
-00049fa0: 2020 2020 2020 2020 2020 2066 696c 655f             file_
-00049fb0: 6e61 6d65 203d 2027 7b7d 2f7b 7d5f 7265  name = '{}/{}_re
-00049fc0: 737b 7d2e 6a73 6f6e 272e 666f 726d 6174  s{}.json'.format
-00049fd0: 2873 656c 662e 776f 726b 6469 722c 2073  (self.workdir, s
-00049fe0: 656c 662e 6d61 706e 616d 652c 2073 636f  elf.mapname, sco
-00049ff0: 7265 5f74 7970 6529 0a20 2020 2020 2020  re_type).       
-0004a000: 2065 6c69 6620 7363 6f72 655f 7479 7065   elif score_type
-0004a010: 203d 3d20 2771 7363 6f72 6527 3a0a 2020   == 'qscore':.  
-0004a020: 2020 2020 2020 2020 2020 6669 6c65 5f6e            file_n
-0004a030: 616d 6520 3d20 277b 7d2f 7b7d 5f7b 7d2e  ame = '{}/{}_{}.
-0004a040: 6a73 6f6e 272e 666f 726d 6174 2873 656c  json'.format(sel
-0004a050: 662e 776f 726b 6469 722c 2073 656c 662e  f.workdir, self.
-0004a060: 6d61 706e 616d 652c 2073 636f 7265 5f74  mapname, score_t
-0004a070: 7970 6529 0a20 2020 2020 2020 2065 6c69  ype).        eli
-0004a080: 6620 7363 6f72 655f 7479 7065 203d 3d20  f score_type == 
-0004a090: 2761 746f 6d5f 696e 636c 7573 696f 6e27  'atom_inclusion'
-0004a0a0: 3a0a 2020 2020 2020 2020 2020 2020 6669  :.            fi
-0004a0b0: 6c65 5f6e 616d 6520 3d20 277b 7d2f 7b7d  le_name = '{}/{}
-0004a0c0: 5f7b 7d2e 6a73 6f6e 272e 666f 726d 6174  _{}.json'.format
-0004a0d0: 2873 656c 662e 776f 726b 6469 722c 2073  (self.workdir, s
-0004a0e0: 656c 662e 6d61 706e 616d 652c 2073 636f  elf.mapname, sco
-0004a0f0: 7265 5f74 7970 6529 0a0a 2020 2020 2020  re_type)..      
-0004a100: 2020 6966 2066 696c 655f 6e61 6d65 2061    if file_name a
-0004a110: 6e64 206f 732e 7061 7468 2e69 7366 696c  nd os.path.isfil
-0004a120: 6528 6669 6c65 5f6e 616d 6529 3a0a 2020  e(file_name):.  
-0004a130: 2020 2020 2020 2020 2020 7769 7468 206f            with o
-0004a140: 7065 6e28 6669 6c65 5f6e 616d 652c 2027  pen(file_name, '
-0004a150: 7227 2920 6173 206a 736f 6e5f 6669 6c65  r') as json_file
-0004a160: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0004a170: 2020 6375 725f 6a73 6f6e 203d 206a 736f    cur_json = jso
-0004a180: 6e2e 6c6f 6164 286a 736f 6e5f 6669 6c65  n.load(json_file
-0004a190: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0004a1a0: 2061 6e79 2869 7465 6d20 696e 2063 7572   any(item in cur
-0004a1b0: 5f6a 736f 6e20 666f 7220 6974 656d 2069  _json for item i
-0004a1c0: 6e20 7363 6f72 655f 6c69 7374 293a 0a20  n score_list):. 
-0004a1d0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0004a1e0: 6620 7363 6f72 655f 7479 7065 203d 3d20  f score_type == 
-0004a1f0: 2761 746f 6d5f 696e 636c 7573 696f 6e27  'atom_inclusion'
-0004a200: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0004a210: 2020 2020 2020 736d 6f63 5f64 6174 6120        smoc_data 
-0004a220: 3d20 6375 725f 6a73 6f6e 5b66 277b 7363  = cur_json[f'{sc
-0004a230: 6f72 655f 7479 7065 7d5f 6279 5f6c 6576  ore_type}_by_lev
-0004a240: 656c 275d 0a20 2020 2020 2020 2020 2020  el'].           
-0004a250: 2020 2020 2065 6c69 6620 7363 6f72 655f       elif score_
-0004a260: 7479 7065 203d 3d20 2763 6363 273a 0a20  type == 'ccc':. 
-0004a270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a280: 2020 2069 6620 2763 6363 2720 696e 2063     if 'ccc' in c
-0004a290: 7572 5f6a 736f 6e2e 6b65 7973 2829 3a0a  ur_json.keys():.
-0004a2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a2b0: 2020 2020 2020 2020 736d 6f63 5f64 6174          smoc_dat
-0004a2c0: 6120 3d20 6375 725f 6a73 6f6e 5b27 6363  a = cur_json['cc
-0004a2d0: 6327 5d0a 2020 2020 2020 2020 2020 2020  c'].            
-0004a2e0: 2020 2020 2020 2020 656c 6966 2027 4343          elif 'CC
-0004a2f0: 4327 2069 6e20 6375 725f 6a73 6f6e 2e6b  C' in cur_json.k
-0004a300: 6579 7328 293a 0a20 2020 2020 2020 2020  eys():.         
-0004a310: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0004a320: 6d6f 635f 6461 7461 203d 2063 7572 5f6a  moc_data = cur_j
-0004a330: 736f 6e5b 2743 4343 275d 0a20 2020 2020  son['CCC'].     
-0004a340: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0004a350: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0004a360: 2020 2020 2020 2020 2020 2020 2073 6d6f               smo
-0004a370: 635f 6461 7461 203d 204e 6f6e 650a 2020  c_data = None.  
-0004a380: 2020 2020 2020 2020 2020 2020 2020 656c                el
-0004a390: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0004a3a0: 2020 2020 2020 2020 736d 6f63 5f64 6174          smoc_dat
-0004a3b0: 6120 3d20 6375 725f 6a73 6f6e 5b73 636f  a = cur_json[sco
-0004a3c0: 7265 5f74 7970 655d 0a20 2020 2020 2020  re_type].       
-0004a3d0: 2020 2020 2020 2020 2069 6620 7363 6f72           if scor
-0004a3e0: 655f 7479 7065 203d 3d20 2761 746f 6d5f  e_type == 'atom_
-0004a3f0: 696e 636c 7573 696f 6e27 3a0a 2020 2020  inclusion':.    
-0004a400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a410: 6966 2027 6176 6572 6167 655f 6169 5f61  if 'average_ai_a
-0004a420: 6c6c 6d6f 6465 6c73 2720 696e 2073 6d6f  llmodels' in smo
-0004a430: 635f 6461 7461 2e6b 6579 7328 293a 0a20  c_data.keys():. 
-0004a440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a450: 2020 2020 2020 206d 6f64 656c 5f6e 756d         model_num
-0004a460: 6265 7273 203d 206c 656e 2873 6d6f 635f  bers = len(smoc_
-0004a470: 6461 7461 2920 2d20 310a 2020 2020 2020  data) - 1.      
-0004a480: 2020 2020 2020 2020 2020 2020 2020 656c                el
-0004a490: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0004a4a0: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
-0004a4b0: 6c5f 6e75 6d62 6572 7320 3d20 6c65 6e28  l_numbers = len(
-0004a4c0: 736d 6f63 5f64 6174 6129 0a20 2020 2020  smoc_data).     
-0004a4d0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0004a4e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004a4f0: 2020 2020 206d 6f64 656c 5f6e 756d 6265       model_numbe
-0004a500: 7273 203d 206c 656e 2873 6d6f 635f 6461  rs = len(smoc_da
-0004a510: 7461 290a 2020 2020 2020 2020 2020 2020  ta).            
-0004a520: 2020 2020 6669 6e61 6c5f 6469 6374 203d      final_dict =
-0004a530: 207b 7d0a 2020 2020 2020 2020 2020 2020   {}.            
-0004a540: 2020 2020 6461 7461 203d 207b 7d0a 2020      data = {}.  
-0004a550: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0004a560: 7220 6920 696e 2072 616e 6765 2830 2c20  r i in range(0, 
-0004a570: 6d6f 6465 6c5f 6e75 6d62 6572 7329 3a0a  model_numbers):.
-0004a580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a590: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-0004a5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a5b0: 2063 7572 5f73 6d6f 635f 6461 7461 203d   cur_smoc_data =
-0004a5c0: 2073 6d6f 635f 6461 7461 5b73 7472 2869   smoc_data[str(i
-0004a5d0: 295d 0a20 2020 2020 2020 2020 2020 2020  )].             
-0004a5e0: 2020 2020 2020 2065 7863 6570 7420 4b65         except Ke
-0004a5f0: 7945 7272 6f72 3a0a 2020 2020 2020 2020  yError:.        
-0004a600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a610: 7072 696e 7428 6627 4b65 793a 207b 697d  print(f'Key: {i}
-0004a620: 3a20 7b6c 6973 7428 736d 6f63 5f64 6174  : {list(smoc_dat
-0004a630: 612e 6b65 7973 2829 295b 695d 7d20 736b  a.keys())[i]} sk
-0004a640: 6970 7065 642e 2729 0a20 2020 2020 2020  ipped.').       
-0004a650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a660: 2063 6f6e 7469 6e75 650a 2020 2020 2020   continue.      
-0004a670: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
-0004a680: 6465 6c5f 6e61 6d65 203d 2063 7572 5f73  del_name = cur_s
-0004a690: 6d6f 635f 6461 7461 5b27 6e61 6d65 275d  moc_data['name']
-0004a6a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004a6b0: 2020 2020 2069 6620 7363 6f72 655f 7479       if score_ty
-0004a6c0: 7065 203d 3d20 2763 6363 273a 0a20 2020  pe == 'ccc':.   
-0004a6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a6e0: 2020 2020 206e 6577 5f64 6963 7420 3d20       new_dict = 
-0004a6f0: 7b27 6964 273a 2073 656c 662e 656d 6469  {'id': self.emdi
-0004a700: 642c 2027 7265 736f 6c75 7469 6f6e 273a  d, 'resolution':
-0004a710: 2066 6c6f 6174 2873 656c 662e 7265 736f   float(self.reso
-0004a720: 6c75 7469 6f6e 292c 2027 6e61 6d65 273a  lution), 'name':
-0004a730: 206d 6f64 656c 5f6e 616d 652c 0a20 2020   model_name,.   
-0004a740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a750: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a760: 2073 636f 7265 5f74 7970 653a 2072 6f75   score_type: rou
-0004a770: 6e64 2863 7572 5f73 6d6f 635f 6461 7461  nd(cur_smoc_data
-0004a780: 5b27 6461 7461 275d 5b27 6176 6572 6167  ['data']['averag
-0004a790: 6563 6327 5d2c 2033 297d 0a20 2020 2020  ecc'], 3)}.     
-0004a7a0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0004a7b0: 6c69 6620 7363 6f72 655f 7479 7065 203d  lif score_type =
-0004a7c0: 3d20 2761 746f 6d5f 696e 636c 7573 696f  = 'atom_inclusio
-0004a7d0: 6e27 3a0a 2020 2020 2020 2020 2020 2020  n':.            
-0004a7e0: 2020 2020 2020 2020 2020 2020 6e65 775f              new_
-0004a7f0: 6469 6374 203d 207b 2769 6427 3a20 7365  dict = {'id': se
-0004a800: 6c66 2e65 6d64 6964 2c20 2772 6573 6f6c  lf.emdid, 'resol
-0004a810: 7574 696f 6e27 3a20 666c 6f61 7428 7365  ution': float(se
-0004a820: 6c66 2e72 6573 6f6c 7574 696f 6e29 2c20  lf.resolution), 
-0004a830: 276e 616d 6527 3a20 6d6f 6465 6c5f 6e61  'name': model_na
-0004a840: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
-0004a850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a860: 2020 2020 2020 2020 2761 6927 3a20 726f          'ai': ro
-0004a870: 756e 6428 6375 725f 736d 6f63 5f64 6174  und(cur_smoc_dat
-0004a880: 615b 2761 7665 7261 6765 5f61 695f 6d6f  a['average_ai_mo
-0004a890: 6465 6c27 5d2c 2033 297d 0a20 2020 2020  del'], 3)}.     
-0004a8a0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0004a8b0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0004a8c0: 2020 2020 2020 2020 2020 2020 206e 6577               new
-0004a8d0: 5f64 6963 7420 3d20 7b27 6964 273a 2073  _dict = {'id': s
-0004a8e0: 656c 662e 656d 6469 642c 2027 7265 736f  elf.emdid, 'reso
-0004a8f0: 6c75 7469 6f6e 273a 2066 6c6f 6174 2873  lution': float(s
-0004a900: 656c 662e 7265 736f 6c75 7469 6f6e 292c  elf.resolution),
-0004a910: 2027 6e61 6d65 273a 206d 6f64 656c 5f6e   'name': model_n
-0004a920: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
-0004a930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a940: 2020 2020 2020 2020 2073 636f 7265 5f74           score_t
-0004a950: 7970 653a 2072 6f75 6e64 2863 7572 5f73  ype: round(cur_s
-0004a960: 6d6f 635f 6461 7461 5b27 6461 7461 275d  moc_data['data']
-0004a970: 5b66 2761 7665 7261 6765 7b73 636f 7265  [f'average{score
-0004a980: 5f74 7970 657d 275d 2c20 3329 7d0a 2020  _type}'], 3)}.  
-0004a990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004a9a0: 2020 706c 6f74 5f6e 616d 6520 3d20 277b    plot_name = '{
-0004a9b0: 7d5f 7b7d 5f7b 7d5f 6261 722e 706e 6727  }_{}_{}_bar.png'
-0004a9c0: 2e66 6f72 6d61 7428 7365 6c66 2e6d 6170  .format(self.map
-0004a9d0: 6e61 6d65 2c20 6d6f 6465 6c5f 6e61 6d65  name, model_name
-0004a9e0: 2c20 7363 6f72 655f 7479 7065 290a 2020  , score_type).  
-0004a9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004aa00: 2020 7363 6f72 655f 6469 7220 3d20 6f73    score_dir = os
-0004aa10: 2e70 6174 682e 6469 726e 616d 6528 7661  .path.dirname(va
-0004aa20: 2e5f 5f66 696c 655f 5f29 0a20 2020 2020  .__file__).     
-0004aa30: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0004aa40: 6620 7363 6f72 655f 7479 7065 203d 3d20  f score_type == 
-0004aa50: 2761 746f 6d5f 696e 636c 7573 696f 6e27  'atom_inclusion'
-0004aa60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0004aa70: 2020 2020 2020 2020 2020 7265 6c61 7469            relati
-0004aa80: 7665 5f74 6f77 686f 6c65 2c20 7265 6c61  ve_towhole, rela
-0004aa90: 7469 7665 5f74 6f74 776f 203d 2062 6172  tive_totwo = bar
-0004aaa0: 286e 6577 5f64 6963 742c 2027 6169 272c  (new_dict, 'ai',
-0004aab0: 2073 656c 662e 776f 726b 6469 722c 2073   self.workdir, s
-0004aac0: 636f 7265 5f64 6972 2c20 706c 6f74 5f6e  core_dir, plot_n
-0004aad0: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
-0004aae0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0004aaf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ab00: 2020 2020 2020 2072 656c 6174 6976 655f         relative_
-0004ab10: 746f 7768 6f6c 652c 2072 656c 6174 6976  towhole, relativ
-0004ab20: 655f 746f 7477 6f20 3d20 6261 7228 6e65  e_totwo = bar(ne
-0004ab30: 775f 6469 6374 2c20 7363 6f72 655f 7479  w_dict, score_ty
-0004ab40: 7065 2c20 7365 6c66 2e77 6f72 6b64 6972  pe, self.workdir
-0004ab50: 2c20 7363 6f72 655f 6469 722c 2070 6c6f  , score_dir, plo
-0004ab60: 745f 6e61 6d65 290a 2020 2020 2020 2020  t_name).        
-0004ab70: 2020 2020 2020 2020 2020 2020 736d 6f63              smoc
-0004ab80: 5f62 6172 203d 207b 2777 686f 6c65 273a  _bar = {'whole':
-0004ab90: 2072 656c 6174 6976 655f 746f 7768 6f6c   relative_towhol
-0004aba0: 652c 2027 7265 6c61 7469 7665 273a 2072  e, 'relative': r
-0004abb0: 656c 6174 6976 655f 746f 7477 6f7d 0a20  elative_totwo}. 
-0004abc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004abd0: 2020 2069 6620 7363 6f72 655f 7479 7065     if score_type
-0004abe0: 203d 3d20 2761 746f 6d5f 696e 636c 7573   == 'atom_inclus
-0004abf0: 696f 6e27 3a0a 2020 2020 2020 2020 2020  ion':.          
-0004ac00: 2020 2020 2020 2020 2020 2020 2020 6461                da
-0004ac10: 7461 5b73 7472 2869 295d 203d 207b 276e  ta[str(i)] = {'n
-0004ac20: 616d 6527 3a20 6d6f 6465 6c5f 6e61 6d65  ame': model_name
-0004ac30: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-0004ac40: 2020 2020 2020 2020 2020 6461 7461 5b73            data[s
-0004ac50: 7472 2869 295d 203d 207b 2761 695f 6261  tr(i)] = {'ai_ba
-0004ac60: 7227 3a20 736d 6f63 5f62 6172 7d0a 2020  r': smoc_bar}.  
-0004ac70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ac80: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0004ac90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004aca0: 6461 7461 5b73 7472 2869 295d 203d 207b  data[str(i)] = {
-0004acb0: 276e 616d 6527 3a20 6d6f 6465 6c5f 6e61  'name': model_na
-0004acc0: 6d65 7d0a 2020 2020 2020 2020 2020 2020  me}.            
-0004acd0: 2020 2020 2020 2020 2020 2020 6461 7461              data
-0004ace0: 5b73 7472 2869 295d 203d 207b 2764 6174  [str(i)] = {'dat
-0004acf0: 6127 3a20 7b66 277b 7363 6f72 655f 7479  a': {f'{score_ty
-0004ad00: 7065 7d5f 6261 7227 3a20 736d 6f63 5f62  pe}_bar': smoc_b
-0004ad10: 6172 7d7d 0a20 2020 2020 2020 2020 2020  ar}}.           
-0004ad20: 2020 2020 2069 6620 7363 6f72 655f 7479       if score_ty
-0004ad30: 7065 203d 3d20 2761 746f 6d5f 696e 636c  pe == 'atom_incl
-0004ad40: 7573 696f 6e27 3a0a 2020 2020 2020 2020  usion':.        
-0004ad50: 2020 2020 2020 2020 2020 2020 6669 6e61              fina
-0004ad60: 6c5f 6469 6374 5b27 6174 6f6d 5f69 6e63  l_dict['atom_inc
-0004ad70: 6c75 7369 6f6e 5f62 795f 6c65 7665 6c27  lusion_by_level'
-0004ad80: 5d20 3d20 6461 7461 0a20 2020 2020 2020  ] = data.       
-0004ad90: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0004ada0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004adb0: 2020 2066 696e 616c 5f64 6963 745b 7363     final_dict[sc
-0004adc0: 6f72 655f 7479 7065 5d20 3d20 6461 7461  ore_type] = data
-0004add0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0004ade0: 2020 6966 2073 636f 7265 5f74 7970 6520    if score_type 
-0004adf0: 3d3d 2027 6174 6f6d 5f69 6e63 6c75 7369  == 'atom_inclusi
-0004ae00: 6f6e 273a 0a20 2020 2020 2020 2020 2020  on':.           
-0004ae10: 2020 2020 2020 2020 2062 6172 5f6a 736f           bar_jso
-0004ae20: 6e20 3d20 277b 7d2f 7b7d 5f61 6962 6172  n = '{}/{}_aibar
-0004ae30: 2e6a 736f 6e27 2e66 6f72 6d61 7428 7365  .json'.format(se
-0004ae40: 6c66 2e77 6f72 6b64 6972 2c20 7365 6c66  lf.workdir, self
-0004ae50: 2e6d 6170 6e61 6d65 290a 2020 2020 2020  .mapname).      
-0004ae60: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0004ae70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ae80: 2020 2020 6261 725f 6a73 6f6e 203d 2027      bar_json = '
-0004ae90: 7b7d 2f7b 7d5f 7b7d 6261 722e 6a73 6f6e  {}/{}_{}bar.json
-0004aea0: 272e 666f 726d 6174 2873 656c 662e 776f  '.format(self.wo
-0004aeb0: 726b 6469 722c 2073 656c 662e 6d61 706e  rkdir, self.mapn
-0004aec0: 616d 652c 2073 636f 7265 5f74 7970 6529  ame, score_type)
-0004aed0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004aee0: 2069 6620 6669 6e61 6c5f 6469 6374 3a0a   if final_dict:.
-0004aef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004af00: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-0004af10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004af20: 2077 6974 6820 636f 6465 6373 2e6f 7065   with codecs.ope
-0004af30: 6e28 6261 725f 6a73 6f6e 2c20 2777 272c  n(bar_json, 'w',
-0004af40: 2065 6e63 6f64 696e 673d 2775 7466 2d38   encoding='utf-8
-0004af50: 2729 2061 7320 663a 0a20 2020 2020 2020  ') as f:.       
+00048d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048d70: 2065 6e63 6f64 696e 673d 2775 7466 2d38   encoding='utf-8
+00048d80: 2729 2061 7320 663a 0a20 2020 2020 2020  ') as f:.       
+00048d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048da0: 2020 2020 2020 2020 206a 736f 6e2e 6475           json.du
+00048db0: 6d70 2866 696e 616c 6d6d 6469 6374 2c20  mp(finalmmdict, 
+00048dc0: 6629 0a20 2020 2020 2020 2020 2020 2020  f).             
+00048dd0: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+00048de0: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+00048df0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00048e00: 7973 2e73 7464 6572 722e 7772 6974 6528  ys.stderr.write(
+00048e10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00048e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048e30: 2027 5361 7669 6e67 2051 7363 6f72 6520   'Saving Qscore 
+00048e40: 7669 6577 2074 6f20 4a53 4f4e 2065 7272  view to JSON err
+00048e50: 6f72 3a20 7b7d 2e5c 6e27 2e66 6f72 6d61  or: {}.\n'.forma
+00048e60: 7428 7379 732e 6578 635f 696e 666f 2829  t(sys.exc_info()
+00048e70: 5b31 5d29 290a 0a20 2020 2020 2020 2020  [1]))..         
+00048e80: 2020 2020 2020 2065 6e64 203d 2074 696d         end = tim
+00048e90: 6569 742e 6465 6661 756c 745f 7469 6d65  eit.default_time
+00048ea0: 7228 290a 2020 2020 2020 2020 2020 2020  r().            
+00048eb0: 2020 2020 7072 696e 7428 2751 7363 6f72      print('Qscor
+00048ec0: 6520 7375 7266 6163 6520 7469 6d65 3a20  e surface time: 
+00048ed0: 2573 2720 2520 2865 6e64 202d 2073 7461  %s' % (end - sta
+00048ee0: 7274 2929 0a20 2020 2020 2020 2020 2020  rt)).           
+00048ef0: 2020 2020 2070 7269 6e74 2827 2d2d 2d2d       print('----
+00048f00: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00048f10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00048f20: 2729 0a0a 2020 2020 6465 6620 7173 636f  ')..    def qsco
+00048f30: 7265 6a73 6f6e 2873 656c 6629 3a0a 2020  rejson(self):.  
+00048f40: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00048f50: 2020 2020 2020 5173 636f 7265 206a 736f        Qscore jso
+00048f60: 6e20 6669 6c65 2066 6565 6420 696e 746f  n file feed into
+00048f70: 2074 6865 2070 6167 650a 0a20 2020 2020   the page..     
+00048f80: 2020 203a 7265 7475 726e 3a0a 2020 2020     :return:.    
+00048f90: 2020 2020 2222 220a 0a20 2020 2020 2020      """..       
+00048fa0: 2070 6173 730a 0a20 2020 2064 6566 2071   pass..    def q
+00048fb0: 7363 6f72 655f 7363 616c 6562 6172 2873  score_scalebar(s
+00048fc0: 656c 662c 2069 6e70 7574 5f66 696c 652c  elf, input_file,
+00048fd0: 2029 3a0a 2020 2020 2020 2020 2222 220a   ):.        """.
+00048fe0: 2020 2020 2020 2020 4675 6e63 7469 6f6e          Function
+00048ff0: 2068 6572 6520 6973 2074 6f20 7072 6f64   here is to prod
+00049000: 7563 6520 7468 6520 512d 7363 6f72 6520  uce the Q-score 
+00049010: 7363 616c 6520 6261 7220 706c 6f74 0a20  scale bar plot. 
+00049020: 2020 2020 2020 2022 2222 0a0a 2020 2020         """..    
+00049030: 2020 2020 696e 7075 745f 6669 6c65 203d      input_file =
+00049040: 2027 2f55 7365 7273 2f7a 6865 2f44 6f77   '/Users/zhe/Dow
+00049050: 6e6c 6f61 6473 2f61 6c6c 7465 6d70 6d61  nloads/alltempma
+00049060: 7073 2f71 7363 6f72 6573 2e63 7376 270a  ps/qscores.csv'.
+00049070: 2020 2020 2020 2020 6e65 775f 656e 7472          new_entr
+00049080: 795f 6469 6374 203d 207b 2769 6473 273a  y_dict = {'ids':
+00049090: 2027 3831 3137 272c 2027 7265 736f 6c75   '8117', 'resolu
+000490a0: 7469 6f6e 273a 2032 2e39 352c 2027 6e61  tion': 2.95, 'na
+000490b0: 6d65 7327 3a20 2735 6972 782e 6369 6627  mes': '5irx.cif'
+000490c0: 2c20 2771 7363 6f72 6573 273a 2030 2e35  , 'qscores': 0.5
+000490d0: 3231 7d0a 2020 2020 2020 2020 6466 203d  21}.        df =
+000490e0: 206c 6f61 645f 7173 636f 7265 2869 6e70   load_qscore(inp
+000490f0: 7574 5f66 696c 652c 206e 6577 5f65 6e74  ut_file, new_ent
+00049100: 7279 5f64 6963 7429 0a20 2020 2020 2020  ry_dict).       
+00049110: 2069 6e64 6578 203d 2064 665b 6466 5b27   index = df[df['
+00049120: 6964 7327 5d20 3d3d 2027 3030 3030 3027  ids'] == '00000'
+00049130: 5d2e 696e 6465 780a 2020 2020 2020 2020  ].index.        
+00049140: 726f 7720 3d20 6466 2e69 6c6f 635b 696e  row = df.iloc[in
+00049150: 6465 782c 5d0a 2020 2020 2020 2020 2871  dex,].        (q
+00049160: 6d69 6e2c 2071 6d61 7829 2c20 6f72 6967  min, qmax), orig
+00049170: 696e 616c 5f76 616c 7565 203d 2067 6574  inal_value = get
+00049180: 5f71 7363 6f72 6573 2864 662c 206e 6577  _qscores(df, new
+00049190: 5f65 6e74 7279 5f64 6963 745b 2771 7363  _entry_dict['qsc
+000491a0: 6f72 6573 275d 290a 2020 2020 2020 2020  ores']).        
+000491b0: 7461 7267 6574 5f76 616c 7565 203d 2069  target_value = i
+000491c0: 6e74 286d 6174 6368 5f74 6f5f 6e65 7773  nt(match_to_news
+000491d0: 6361 6c65 2828 302c 2073 756d 286f 7269  cale((0, sum(ori
+000491e0: 6769 6e61 6c5f 7661 6c75 6529 292c 2028  ginal_value)), (
+000491f0: 302c 2031 3939 292c 206f 7269 6769 6e61  0, 199), origina
+00049200: 6c5f 7661 6c75 655b 305d 2929 0a0a 2020  l_value[0]))..  
+00049210: 2020 2020 2020 6466 3130 3030 203d 2067        df1000 = g
+00049220: 6574 5f6e 6561 7265 7374 5f6f 6e65 7468  et_nearest_oneth
+00049230: 6f75 7361 6e64 286e 6577 5f65 6e74 7279  ousand(new_entry
+00049240: 5f64 6963 742c 2064 662c 2035 3030 290a  _dict, df, 500).
+00049250: 2020 2020 2020 2020 2873 716d 696e 2c20          (sqmin, 
+00049260: 7371 6d61 7829 2c20 6f76 616c 7565 203d  sqmax), ovalue =
+00049270: 2067 6574 5f71 7363 6f72 6573 2864 6631   get_qscores(df1
+00049280: 3030 302c 206e 6577 5f65 6e74 7279 5f64  000, new_entry_d
+00049290: 6963 745b 2771 7363 6f72 6573 275d 290a  ict['qscores']).
+000492a0: 2020 2020 2020 2020 7072 696e 7428 7371          print(sq
+000492b0: 6d69 6e2c 2073 716d 6178 290a 2020 2020  min, sqmax).    
+000492c0: 2020 2020 7072 696e 7428 6f76 616c 7565      print(ovalue
+000492d0: 290a 2020 2020 2020 2020 7461 7267 6574  ).        target
+000492e0: 5f76 616c 7565 5f34 3020 3d20 696e 7428  _value_40 = int(
+000492f0: 6d61 7463 685f 746f 5f6e 6577 7363 616c  match_to_newscal
+00049300: 6528 2830 2c20 7375 6d28 6f76 616c 7565  e((0, sum(ovalue
+00049310: 2929 2c20 2830 2c20 3139 3929 2c20 6f76  )), (0, 199), ov
+00049320: 616c 7565 5b30 5d29 290a 2020 2020 2020  alue[0])).      
+00049330: 2020 7072 696e 7428 7461 7267 6574 5f76    print(target_v
+00049340: 616c 7565 290a 2020 2020 2020 2020 7072  alue).        pr
+00049350: 696e 7428 7461 7267 6574 5f76 616c 7565  int(target_value
+00049360: 5f34 3029 0a20 2020 2020 2020 2070 6c6f  _40).        plo
+00049370: 745f 6261 725f 6d61 7428 7461 7267 6574  t_bar_mat(target
+00049380: 5f76 616c 7565 2c20 7461 7267 6574 5f76  _value, target_v
+00049390: 616c 7565 5f34 302c 2071 6d69 6e2c 2071  alue_40, qmin, q
+000493a0: 6d61 7829 0a0a 2020 2020 2320 5173 636f  max)..    # Qsco
+000493b0: 7265 2072 656c 6174 6564 2065 6e64 6564  re related ended
+000493c0: 2068 6572 650a 0a20 2020 2064 6566 206d   here..    def m
+000493d0: 6f76 6570 726f 7368 6164 6552 6573 756c  oveproshadeResul
+000493e0: 7428 7365 6c66 293a 0a0a 2020 2020 2020  t(self):..      
+000493f0: 2020 696d 706f 7274 2073 6875 7469 6c0a    import shutil.
+00049400: 0a20 2020 2020 2020 2063 7764 203d 206f  .        cwd = o
+00049410: 732e 6765 7463 7764 2829 0a20 2020 2020  s.getcwd().     
+00049420: 2020 2073 7263 6469 7220 3d20 277b 7d2f     srcdir = '{}/
+00049430: 7072 6f73 6861 6465 5f72 6570 6f72 7427  proshade_report'
+00049440: 2e66 6f72 6d61 7428 6377 6429 0a20 2020  .format(cwd).   
+00049450: 2020 2020 2064 6573 6469 7220 3d20 7365       desdir = se
+00049460: 6c66 2e77 6f72 6b64 6972 0a20 2020 2020  lf.workdir.     
+00049470: 2020 2064 6573 7072 6f64 6972 203d 2027     desprodir = '
+00049480: 7b7d 2f70 726f 7368 6164 655f 7265 706f  {}/proshade_repo
+00049490: 7274 272e 666f 726d 6174 2864 6573 6469  rt'.format(desdi
+000494a0: 7229 0a20 2020 2020 2020 2069 6620 6f73  r).        if os
+000494b0: 2e70 6174 682e 6973 6469 7228 6465 7370  .path.isdir(desp
+000494c0: 726f 6469 7229 3a0a 2020 2020 2020 2020  rodir):.        
+000494d0: 2020 2020 7368 7574 696c 2e72 6d74 7265      shutil.rmtre
+000494e0: 6528 6465 7370 726f 6469 7229 0a20 2020  e(desprodir).   
+000494f0: 2020 2020 2069 6620 6f73 2e70 6174 682e       if os.path.
+00049500: 6973 6469 7228 7372 6364 6972 293a 0a20  isdir(srcdir):. 
+00049510: 2020 2020 2020 2020 2020 2064 6573 7420             dest 
+00049520: 3d20 7368 7574 696c 2e6d 6f76 6528 7372  = shutil.move(sr
+00049530: 6364 6972 2c20 6465 7364 6972 290a 2020  cdir, desdir).  
+00049540: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00049550: 2020 2020 2020 2020 6465 7374 203d 204e          dest = N
+00049560: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+00049570: 7072 696e 7428 274e 6f20 7072 6f73 6861  print('No prosha
+00049580: 6465 2072 6573 756c 7420 746f 2062 6520  de result to be 
+00049590: 6d6f 7665 642e 2729 0a0a 2020 2020 2020  moved.')..      
+000495a0: 2020 7265 7475 726e 2064 6573 740a 0a20    return dest.. 
+000495b0: 2020 2064 6566 2073 796d 6d65 7472 7974     def symmetryt
+000495c0: 6f6a 736f 6e28 7365 6c66 2c20 6f75 7470  ojson(self, outp
+000495d0: 7574 293a 0a20 2020 2020 2020 2022 2222  ut):.        """
+000495e0: 0a0a 2020 2020 2020 2020 2020 2020 436f  ..            Co
+000495f0: 6e76 6572 7420 7468 6520 6f75 7470 7574  nvert the output
+00049600: 206f 6620 7072 6f73 6861 6465 2073 796d   of proshade sym
+00049610: 6d65 7472 7920 6361 6c63 756c 6174 696f  metry calculatio
+00049620: 6e20 746f 206a 736f 6e20 7768 6963 6820  n to json which 
+00049630: 6361 6e20 6265 2075 7365 6420 6675 7274  can be used furt
+00049640: 6865 720a 0a20 2020 2020 2020 203a 7061  her..        :pa
+00049650: 7261 6d20 6f75 7470 7574 3a0a 2020 2020  ram output:.    
+00049660: 2020 2020 3a72 6574 7572 6e3a 0a20 2020      :return:.   
+00049670: 2020 2020 2022 2222 0a0a 2020 2020 2020       """..      
+00049680: 2020 7061 7373 0a0a 2020 2020 6465 6620    pass..    def 
+00049690: 7374 7275 6465 6c28 7365 6c66 293a 0a20  strudel(self):. 
+000496a0: 2020 2020 2020 2022 2222 0a0a 2020 2020         """..    
+000496b0: 2020 2020 3a72 6574 7572 6e3a 0a20 2020      :return:.   
+000496c0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+000496d0: 2069 6620 7365 6c66 2e70 6c61 7466 6f72   if self.platfor
+000496e0: 6d20 3d3d 2027 656d 6462 2720 616e 6420  m == 'emdb' and 
+000496f0: 7365 6c66 2e6d 6574 2021 3d20 2774 6f6d  self.met != 'tom
+00049700: 6f27 3a0a 2020 2020 2020 2020 2020 2020  o':.            
+00049710: 6572 726c 6973 7420 3d20 5b5d 0a20 2020  errlist = [].   
+00049720: 2020 2020 2020 2020 2066 696e 616c 5f72           final_r
+00049730: 616e 6765 203d 204e 6f6e 650a 2020 2020  ange = None.    
+00049740: 2020 2020 2020 2020 7265 735f 7261 6e67          res_rang
+00049750: 6573 203d 205b 5b32 2e30 2c20 322e 335d  es = [[2.0, 2.3]
+00049760: 2c20 5b32 2e33 2c20 322e 355d 2c20 5b32  , [2.3, 2.5], [2
+00049770: 2e35 2c20 322e 385d 2c20 5b32 2e38 2c20  .5, 2.8], [2.8, 
+00049780: 332e 305d 2c20 5b33 2e30 2c20 332e 325d  3.0], [3.0, 3.2]
+00049790: 2c20 5b33 2e32 2c20 332e 355d 2c20 5b33  , [3.2, 3.5], [3
+000497a0: 2e35 2c20 342e 305d 5d0a 2020 2020 2020  .5, 4.0]].      
+000497b0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+000497c0: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
+000497d0: 6478 2c20 6372 616e 6765 2069 6e20 656e  dx, crange in en
+000497e0: 756d 6572 6174 6528 7265 735f 7261 6e67  umerate(res_rang
+000497f0: 6573 293a 0a20 2020 2020 2020 2020 2020  es):.           
+00049800: 2020 2020 2020 2020 2069 6620 6372 616e           if cran
+00049810: 6765 5b30 5d20 3c20 666c 6f61 7428 7365  ge[0] < float(se
+00049820: 6c66 2e72 6573 6f6c 7574 696f 6e29 203c  lf.resolution) <
+00049830: 3d20 6372 616e 6765 5b31 5d3a 0a20 2020  = crange[1]:.   
+00049840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049850: 2020 2020 2066 696e 616c 5f72 616e 6765       final_range
+00049860: 203d 2063 7261 6e67 650a 2020 2020 2020   = crange.      
+00049870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049880: 2020 6272 6561 6b0a 2020 2020 2020 2020    break.        
+00049890: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+000498a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000498b0: 2020 7072 696e 7428 274d 6170 2064 6964    print('Map did
+000498c0: 206e 6f74 2066 616c 6c20 696e 746f 2061   not fall into a
+000498d0: 6e79 2061 7661 696c 6162 6c65 2072 6573  ny available res
+000498e0: 6f6c 7574 696f 6e20 7261 6e67 652e 2729  olution range.')
+000498f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00049900: 2020 2020 2070 7269 6e74 2827 2d2d 2d2d       print('----
+00049910: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00049920: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00049930: 2729 0a20 2020 2020 2020 2020 2020 2065  ').            e
+00049940: 7863 6570 743a 0a20 2020 2020 2020 2020  xcept:.         
+00049950: 2020 2020 2020 2065 7272 203d 2027 5374         err = 'St
+00049960: 7275 6465 6c20 6d6f 7469 6620 6c69 6220  rudel motif lib 
+00049970: 7265 736f 6c75 7469 6f6e 2072 616e 6765  resolution range
+00049980: 2063 6865 636b 2065 7272 6f72 3a20 7b7d   check error: {}
+00049990: 2e27 2e66 6f72 6d61 7428 7379 732e 6578  .'.format(sys.ex
+000499a0: 635f 696e 666f 2829 5b31 5d29 0a20 2020  c_info()[1]).   
+000499b0: 2020 2020 2020 2020 2020 2020 2065 7272               err
+000499c0: 6c69 7374 2e61 7070 656e 6428 6572 7229  list.append(err)
+000499d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000499e0: 2073 7973 2e73 7464 6572 722e 7772 6974   sys.stderr.writ
+000499f0: 6528 6572 7220 2b20 275c 6e27 290a 0a20  e(err + '\n').. 
+00049a00: 2020 2020 2020 2020 2020 2073 7472 7564             strud
+00049a10: 656c 6170 7020 3d20 4e6f 6e65 0a20 2020  elapp = None.   
+00049a20: 2020 2020 2020 2020 2023 2075 7365 2061           # use a
+00049a30: 2066 6978 2076 616c 7565 2066 6f72 206e   fix value for n
+00049a40: 6f77 2c20 6d61 7920 636f 6e73 6964 6572  ow, may consider
+00049a50: 2061 7320 6120 6172 6775 6d65 6e74 2066   as a argument f
+00049a60: 6f72 206c 6174 6572 0a20 2020 2020 2020  or later.       
+00049a70: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00049a80: 2020 2020 2020 2020 2020 2320 7374 7275            # stru
+00049a90: 6465 6c61 7070 203d 2073 656c 662e 6368  delapp = self.ch
+00049aa0: 6563 6b73 7472 7564 656c 7363 6f72 6528  eckstrudelscore(
+00049ab0: 6f63 6869 6d65 7261 6170 7029 0a20 2020  ochimeraapp).   
+00049ac0: 2020 2020 2020 2020 2020 2020 206d 6170               map
+00049ad0: 6e61 6d65 203d 2073 656c 662e 6d61 702e  name = self.map.
+00049ae0: 6675 6c6c 6e61 6d65 0a20 2020 2020 2020  fullname.       
+00049af0: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+00049b00: 2e6d 6f64 656c 7320 6973 206e 6f74 204e  .models is not N
+00049b10: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00049b20: 2020 2020 2020 2020 206d 6f64 656c 7320           models 
+00049b30: 3d20 2720 272e 6a6f 696e 285b 6d6f 6465  = ' '.join([mode
+00049b40: 6c2e 6669 6c65 6e61 6d65 2066 6f72 206d  l.filename for m
+00049b50: 6f64 656c 2069 6e20 7365 6c66 2e6d 6f64  odel in self.mod
+00049b60: 656c 735d 290a 2020 2020 2020 2020 2020  els]).          
+00049b70: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00049b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049b90: 7072 696e 7428 274e 6f20 6669 7474 6564  print('No fitted
+00049ba0: 206d 6f64 656c 2066 6f72 2053 7472 7564   model for Strud
+00049bb0: 656c 2063 616c 6375 6c61 7469 6f6e 2e27  el calculation.'
+00049bc0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00049bd0: 2020 2020 2020 7072 696e 7428 272d 2d2d        print('---
+00049be0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00049bf0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00049c00: 2d27 290a 0a20 2020 2020 2020 2020 2020  -')..           
+00049c10: 2065 7863 6570 743a 0a20 2020 2020 2020   except:.       
+00049c20: 2020 2020 2020 2020 2065 7272 203d 2027           err = '
+00049c30: 5374 7275 6465 6c20 7072 6570 6172 6174  Strudel preparat
+00049c40: 696f 6e20 6572 726f 723a 207b 7d2e 272e  ion error: {}.'.
+00049c50: 666f 726d 6174 2873 7973 2e65 7863 5f69  format(sys.exc_i
+00049c60: 6e66 6f28 295b 315d 290a 2020 2020 2020  nfo()[1]).      
+00049c70: 2020 2020 2020 2020 2020 6572 726c 6973            errlis
+00049c80: 742e 6170 7065 6e64 2865 7272 290a 2020  t.append(err).  
+00049c90: 2020 2020 2020 2020 2020 2020 2020 7379                sy
+00049ca0: 732e 7374 6465 7272 2e77 7269 7465 2865  s.stderr.write(e
+00049cb0: 7272 202b 2027 5c6e 2729 0a0a 2020 2020  rr + '\n')..    
+00049cc0: 2020 2020 2020 2020 6c69 625f 726f 6f74          lib_root
+00049cd0: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+00049ce0: 2020 2020 6966 204c 4942 5f53 5452 5544      if LIB_STRUD
+00049cf0: 454c 5f52 4f4f 5420 6973 206e 6f74 204e  EL_ROOT is not N
+00049d00: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00049d10: 2020 2020 206c 6962 5f72 6f6f 7420 3d20       lib_root = 
+00049d20: 4c49 425f 5354 5255 4445 4c5f 524f 4f54  LIB_STRUDEL_ROOT
+00049d30: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+00049d40: 6620 4c49 425f 5354 5255 4445 4c5f 524f  f LIB_STRUDEL_RO
+00049d50: 4f54 2069 7320 4e6f 6e65 2061 6e64 2073  OT is None and s
+00049d60: 656c 662e 7374 7275 6465 6c6c 6962 2069  elf.strudellib i
+00049d70: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00049d80: 2020 2020 2020 2020 2020 2020 6c69 625f              lib_
+00049d90: 726f 6f74 203d 2073 656c 662e 7374 7275  root = self.stru
+00049da0: 6465 6c6c 6962 0a20 2020 2020 2020 2020  dellib.         
+00049db0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00049dc0: 2020 2020 2020 2020 206c 6962 5f72 6f6f           lib_roo
+00049dd0: 7420 3d20 4e6f 6e65 0a0a 2020 2020 2020  t = None..      
+00049de0: 2020 2020 2020 2320 6966 2073 7472 7564        # if strud
+00049df0: 656c 6170 7020 616e 6420 7365 6c66 2e6d  elapp and self.m
+00049e00: 6f64 656c 733a 0a20 2020 2020 2020 2020  odels:.         
+00049e10: 2020 2069 6620 6669 6e61 6c5f 7261 6e67     if final_rang
+00049e20: 6520 616e 6420 7365 6c66 2e6d 6f64 656c  e and self.model
+00049e30: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+00049e40: 2020 2066 6f72 206d 6f64 656c 2069 6e20     for model in 
+00049e50: 7365 6c66 2e6d 6f64 656c 733a 0a20 2020  self.models:.   
+00049e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049e70: 2066 756c 6c5f 6d6f 6465 6c20 3d20 277b   full_model = '{
+00049e80: 7d7b 7d27 2e66 6f72 6d61 7428 7365 6c66  }{}'.format(self
+00049e90: 2e77 6f72 6b64 6972 2c20 6f73 2e70 6174  .workdir, os.pat
+00049ea0: 682e 6261 7365 6e61 6d65 286d 6f64 656c  h.basename(model
+00049eb0: 2e66 696c 656e 616d 6529 290a 2020 2020  .filename)).    
+00049ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049ed0: 6675 6c6c 5f6d 6170 203d 2027 7b7d 7b7d  full_map = '{}{}
+00049ee0: 272e 666f 726d 6174 2873 656c 662e 776f  '.format(self.wo
+00049ef0: 726b 6469 722c 2073 656c 662e 6d61 706e  rkdir, self.mapn
+00049f00: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
+00049f10: 2020 2020 2020 2020 206c 6962 5f70 6174           lib_pat
+00049f20: 6820 3d20 277b 7d2f 6d6f 7469 6673 5f7b  h = '{}/motifs_{
+00049f30: 7d2d 7b7d 272e 666f 726d 6174 286c 6962  }-{}'.format(lib
+00049f40: 5f72 6f6f 742c 2066 696e 616c 5f72 616e  _root, final_ran
+00049f50: 6765 5b30 5d2c 2066 696e 616c 5f72 616e  ge[0], final_ran
+00049f60: 6765 5b31 5d29 0a20 2020 2020 2020 2020  ge[1]).         
+00049f70: 2020 2020 2020 2020 2020 206f 7574 5f70             out_p
+00049f80: 6174 6820 3d20 277b 7d5f 7374 7275 6465  ath = '{}_strude
+00049f90: 6c27 2e66 6f72 6d61 7428 6675 6c6c 5f6d  l'.format(full_m
+00049fa0: 6f64 656c 290a 0a20 2020 2020 2020 2020  odel)..         
+00049fb0: 2020 2020 2020 2020 2020 2072 6572 7220             rerr 
+00049fc0: 3d20 7275 6e5f 7374 7275 6465 6c28 6675  = run_strudel(fu
+00049fd0: 6c6c 5f6d 6f64 656c 2c20 6675 6c6c 5f6d  ll_model, full_m
+00049fe0: 6170 2c20 6c69 625f 7061 7468 2c20 6f75  ap, lib_path, ou
+00049ff0: 745f 7061 7468 2c20 7365 6c66 2e70 6c61  t_path, self.pla
+0004a000: 7466 6f72 6d29 0a20 2020 2020 2020 2020  tform).         
+0004a010: 2020 2020 2020 2020 2020 2069 6620 7265             if re
+0004a020: 7272 3a0a 2020 2020 2020 2020 2020 2020  rr:.            
+0004a030: 2020 2020 2020 2020 2020 2020 6572 7220              err 
+0004a040: 3d20 2753 7472 7564 656c 2063 616c 6375  = 'Strudel calcu
+0004a050: 6c61 7469 6f6e 2065 7272 6f72 3a20 7b7d  lation error: {}
+0004a060: 272e 666f 726d 6174 2872 6572 7229 0a20  '.format(rerr). 
+0004a070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a080: 2020 2020 2020 2065 7272 6c69 7374 2e61         errlist.a
+0004a090: 7070 656e 6428 6572 7229 0a20 2020 2020  ppend(err).     
+0004a0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a0b0: 2020 2073 7973 2e73 7464 6572 722e 7772     sys.stderr.wr
+0004a0c0: 6974 6528 6572 7220 2b20 275c 6e27 290a  ite(err + '\n').
+0004a0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a0e0: 2020 2020 2020 2020 7072 696e 7428 272d          print('-
+0004a0f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0004a100: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0004a110: 2d2d 2d27 290a 0a20 2020 2020 2020 2020  ---')..         
+0004a120: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0004a130: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
+0004a140: 4e6f 206d 6f64 656c 206f 7220 7265 736f  No model or reso
+0004a150: 6c75 7469 6f6e 2069 7320 6e6f 7420 636f  lution is not co
+0004a160: 7665 7265 6420 696e 2074 6865 206d 6f74  vered in the mot
+0004a170: 6966 206c 6962 7261 7279 2028 3c34 2e30  if library (<4.0
+0004a180: c385 2920 2729 0a20 2020 2020 2020 2020  ..) ').         
+0004a190: 2020 2020 2020 2070 7269 6e74 2827 2d2d         print('--
+0004a1a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0004a1b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0004a1c0: 2d2d 2729 0a0a 2020 2020 2020 2020 7265  --')..        re
+0004a1d0: 7475 726e 204e 6f6e 650a 0a0a 0a0a 2020  turn None.....  
+0004a1e0: 2020 6465 6620 7265 616c 5f6d 6d63 6328    def real_mmcc(
+0004a1f0: 7365 6c66 293a 0a20 2020 2020 2020 2022  self):.        "
+0004a200: 2222 0a20 2020 2020 2020 2020 2020 2043  "".            C
+0004a210: 616c 6375 6c61 7469 6f6e 2072 6561 6c20  alculation real 
+0004a220: 7370 6163 6520 6372 6f73 732d 636f 7272  space cross-corr
+0004a230: 656c 6174 696f 6e20 6265 7477 6565 6e20  elation between 
+0004a240: 7072 696d 6172 7920 6d61 7020 616e 6420  primary map and 
+0004a250: 6d6f 6465 6c2d 6d61 7020 2852 6566 6d61  model-map (Refma
+0004a260: 6329 0a0a 2020 2020 2020 2020 3a72 6574  c)..        :ret
+0004a270: 7572 6e3a 0a20 2020 2020 2020 2022 2222  urn:.        """
+0004a280: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+0004a290: 662e 6d6f 6465 6c73 6d61 7073 2061 6e64  f.modelsmaps and
+0004a2a0: 2073 656c 662e 706c 6174 666f 726d 203d   self.platform =
+0004a2b0: 3d20 2765 6d64 6227 3a0a 2020 2020 2020  = 'emdb':.      
+0004a2c0: 2020 2020 2020 7374 6172 7420 3d20 7469        start = ti
+0004a2d0: 6d65 6974 2e64 6566 6175 6c74 5f74 696d  meit.default_tim
+0004a2e0: 6572 2829 0a20 2020 2020 2020 2020 2020  er().           
+0004a2f0: 2072 6d6d 6363 6320 3d20 7b7d 0a20 2020   rmmccc = {}.   
+0004a300: 2020 2020 2020 2020 206d 6d63 635f 6469           mmcc_di
+0004a310: 6374 203d 207b 7d0a 2020 2020 2020 2020  ct = {}.        
+0004a320: 2020 2020 6572 726c 6973 7420 3d20 5b5d      errlist = []
+0004a330: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+0004a340: 206d 6f64 656c 6d61 7020 696e 2073 656c   modelmap in sel
+0004a350: 662e 6d6f 6465 6c73 6d61 7073 3a0a 2020  f.modelsmaps:.  
+0004a360: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+0004a370: 696e 7428 6d6f 6465 6c6d 6170 290a 2020  int(modelmap).  
+0004a380: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
+0004a390: 6465 6c6d 6170 5f6e 616d 6520 3d20 6f73  delmap_name = os
+0004a3a0: 2e70 6174 682e 6261 7365 6e61 6d65 286d  .path.basename(m
+0004a3b0: 6f64 656c 6d61 7029 0a20 2020 2020 2020  odelmap).       
+0004a3c0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+0004a3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a3e0: 2020 6d6d 6170 203d 206d 7263 6669 6c65    mmap = mrcfile
+0004a3f0: 2e6d 6d61 7028 6d6f 6465 6c6d 6170 2c20  .mmap(modelmap, 
+0004a400: 6d6f 6465 3d27 7227 290a 2020 2020 2020  mode='r').      
+0004a410: 2020 2020 2020 2020 2020 2020 2020 6d6d                mm
+0004a420: 6170 6461 7461 203d 206d 6d61 702e 6461  apdata = mmap.da
+0004a430: 7461 0a20 2020 2020 2020 2020 2020 2020  ta.             
+0004a440: 2020 2020 2020 206d 6d63 6320 3d20 7275         mmcc = ru
+0004a450: 6e5f 7265 616c 6d6d 6363 2873 656c 662e  n_realmmcc(self.
+0004a460: 6d61 702e 6461 7461 2c20 6d6d 6170 6461  map.data, mmapda
+0004a470: 7461 295b 315d 0a20 2020 2020 2020 2020  ta)[1].         
+0004a480: 2020 2020 2020 2020 2020 206d 6d63 635f             mmcc_
+0004a490: 6469 6374 5b6d 6f64 656c 6d61 705f 6e61  dict[modelmap_na
+0004a4a0: 6d65 5d20 3d20 6d6d 6363 0a20 2020 2020  me] = mmcc.     
+0004a4b0: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+0004a4c0: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+0004a4d0: 2020 2020 2020 2065 7272 203d 2027 4d61         err = 'Ma
+0004a4e0: 7020 616e 6420 6d6f 6465 6c20 7b7d 2072  p and model {} r
+0004a4f0: 6561 6c20 7370 6163 6520 4343 2063 616c  eal space CC cal
+0004a500: 6375 6c61 7469 6f6e 2065 7272 6f72 3a20  culation error: 
+0004a510: 7b7d 2e27 2e66 6f72 6d61 7428 6d6f 6465  {}.'.format(mode
+0004a520: 6c6d 6170 5f6e 616d 652c 2073 7973 2e65  lmap_name, sys.e
+0004a530: 7863 5f69 6e66 6f28 295b 315d 290a 2020  xc_info()[1]).  
+0004a540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a550: 2020 6572 726c 6973 742e 6170 7065 6e64    errlist.append
+0004a560: 2865 7272 290a 2020 2020 2020 2020 2020  (err).          
+0004a570: 2020 2020 2020 2020 2020 7379 732e 7374            sys.st
+0004a580: 6465 7272 2e77 7269 7465 2865 7272 202b  derr.write(err +
+0004a590: 2027 5c6e 2729 0a0a 2020 2020 2020 2020   '\n')..        
+0004a5a0: 2020 2020 6966 2065 7272 6c69 7374 3a0a      if errlist:.
+0004a5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a5c0: 726d 6d63 6363 5b27 6572 7227 5d20 3d20  rmmccc['err'] = 
+0004a5d0: 7b27 726d 6d63 6363 5f65 7272 273a 2065  {'rmmccc_err': e
+0004a5e0: 7272 6c69 7374 7d0a 2020 2020 2020 2020  rrlist}.        
+0004a5f0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0004a600: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0004a610: 274e 6f20 6572 726f 7220 696e 2072 6d6d  'No error in rmm
+0004a620: 6363 6320 6361 6c63 756c 6174 696f 6e2e  ccc calculation.
+0004a630: 2729 0a0a 2020 2020 2020 2020 2020 2020  ')..            
+0004a640: 726d 6d63 6363 5b27 726d 6d63 6363 275d  rmmccc['rmmccc']
+0004a650: 203d 206d 6d63 635f 6469 6374 0a20 2020   = mmcc_dict.   
+0004a660: 2020 2020 2020 2020 2069 6620 726d 6d63           if rmmc
+0004a670: 6363 3a0a 2020 2020 2020 2020 2020 2020  cc:.            
+0004a680: 2020 2020 7769 7468 2063 6f64 6563 732e      with codecs.
+0004a690: 6f70 656e 2873 656c 662e 776f 726b 6469  open(self.workdi
+0004a6a0: 7220 2b20 7365 6c66 2e6d 6170 6e61 6d65  r + self.mapname
+0004a6b0: 202b 2027 5f72 6d6d 6363 7363 6f72 652e   + '_rmmccscore.
+0004a6c0: 6a73 6f6e 272c 2027 7727 2c20 656e 636f  json', 'w', enco
+0004a6d0: 6469 6e67 3d27 7574 662d 3827 2920 6173  ding='utf-8') as
+0004a6e0: 2066 3a0a 2020 2020 2020 2020 2020 2020   f:.            
+0004a6f0: 2020 2020 2020 2020 6a73 6f6e 2e64 756d          json.dum
+0004a700: 7028 726d 6d63 6363 2c20 6629 0a20 2020  p(rmmccc, f).   
+0004a710: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0004a720: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0004a730: 7269 6e74 2827 4e6f 206d 6f64 656c 206d  rint('No model m
+0004a740: 6170 2043 4320 6973 2063 616c 6375 6c61  ap CC is calcula
+0004a750: 7465 642c 2063 6865 636b 2074 6865 2065  ted, check the e
+0004a760: 7272 6f72 2069 6e66 6f72 6d61 7469 6f6e  rror information
+0004a770: 2e27 290a 0a20 2020 2020 2020 2020 2020  .')..           
+0004a780: 2065 6e64 203d 2074 696d 6569 742e 6465   end = timeit.de
+0004a790: 6661 756c 745f 7469 6d65 7228 290a 2020  fault_timer().  
+0004a7a0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0004a7b0: 2752 6561 6c20 7370 6163 6520 6d6f 6465  'Real space mode
+0004a7c0: 6c20 616e 6420 6d61 7020 4372 6f73 732d  l and map Cross-
+0004a7d0: 436f 7272 656c 6174 696f 6e20 436f 6566  Correlation Coef
+0004a7e0: 6669 6369 656e 7420 7469 6d65 3a20 2573  ficient time: %s
+0004a7f0: 2720 2520 2865 6e64 202d 2073 7461 7274  ' % (end - start
+0004a800: 2929 0a20 2020 2020 2020 2020 2020 2070  )).            p
+0004a810: 7269 6e74 2827 2d2d 2d2d 2d2d 2d2d 2d2d  rint('----------
+0004a820: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0004a830: 2d2d 2d2d 2d2d 2d2d 2d2d 2729 0a0a 2020  ----------')..  
+0004a840: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0004a850: 2020 2020 2020 2020 7072 696e 7428 274e          print('N
+0004a860: 6f20 6d6f 6465 6c20 6d61 7020 666f 7220  o model map for 
+0004a870: 6d6f 6465 6c20 616e 6420 6d61 7020 7265  model and map re
+0004a880: 616c 2073 7061 6365 2063 726f 7373 2d63  al space cross-c
+0004a890: 6f72 7265 6c61 7469 6f6e 2063 616c 6375  orrelation calcu
+0004a8a0: 6c61 7469 6f6e 2e27 290a 2020 2020 2020  lation.').      
+0004a8b0: 2020 2020 2020 7072 696e 7428 272d 2d2d        print('---
+0004a8c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0004a8d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0004a8e0: 2d27 290a 0a20 2020 2020 2020 2072 6574  -')..        ret
+0004a8f0: 7572 6e20 4e6f 6e65 0a0a 0a20 2020 2064  urn None...    d
+0004a900: 6566 2073 6d6f 635f 6261 7228 7365 6c66  ef smoc_bar(self
+0004a910: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
+0004a920: 2020 2020 2020 2073 6d6f 6320 6361 6c63         smoc calc
+0004a930: 7561 6c74 696f 6e20 616e 6420 6261 720a  ualtion and bar.
+0004a940: 2020 2020 2020 2020 2222 220a 0a20 2020          """..   
+0004a950: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
+0004a960: 2e6f 6e6c 7962 6172 3a0a 2020 2020 2020  .onlybar:.      
+0004a970: 2020 2020 2020 7365 6c66 2e73 6d6f 6328        self.smoc(
+0004a980: 290a 2020 2020 2020 2020 7365 6c66 2e67  ).        self.g
+0004a990: 6574 5f62 6172 2873 636f 7265 5f74 7970  et_bar(score_typ
+0004a9a0: 653d 2773 6d6f 6327 290a 0a20 2020 2023  e='smoc')..    #
+0004a9b0: 2075 7365 206c 6174 6573 7420 5445 4d50   use latest TEMP
+0004a9c0: 7920 322e 3020 666f 7220 736d 6f63 2063  y 2.0 for smoc c
+0004a9d0: 616c 6375 6c61 7469 6f6e 0a20 2020 2064  alculation.    d
+0004a9e0: 6566 2073 6d6f 6328 7365 6c66 293a 0a20  ef smoc(self):. 
+0004a9f0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0004aa00: 2020 2020 2020 2072 756e 2073 6d6f 630a         run smoc.
+0004aa10: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
+0004aa20: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0004aa30: 2020 2020 2069 6620 7365 6c66 2e70 6c61       if self.pla
+0004aa40: 7466 6f72 6d20 3d3d 2027 656d 6462 2720  tform == 'emdb' 
+0004aa50: 616e 6420 7365 6c66 2e6d 6574 2021 3d20  and self.met != 
+0004aa60: 2774 6f6d 6f27 3a0a 2020 2020 2020 2020  'tomo':.        
+0004aa70: 2020 2020 7374 6172 7420 3d20 7469 6d65      start = time
+0004aa80: 6974 2e64 6566 6175 6c74 5f74 696d 6572  it.default_timer
+0004aa90: 2829 0a20 2020 2020 2020 2020 2020 2065  ().            e
+0004aaa0: 7272 6c69 7374 203d 205b 5d0a 2020 2020  rrlist = [].    
+0004aab0: 2020 2020 2020 2020 7265 7375 6c74 5f64          result_d
+0004aac0: 6963 7420 3d20 7b7d 0a20 2020 2020 2020  ict = {}.       
+0004aad0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+0004aae0: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+0004aaf0: 662e 6d6f 6465 6c73 3a0a 2020 2020 2020  f.models:.      
+0004ab00: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0004ab10: 756e 7420 3d20 300a 2020 2020 2020 2020  unt = 0.        
+0004ab20: 2020 2020 2020 2020 2020 2020 6669 6e61              fina
+0004ab30: 6c5f 6469 6374 203d 207b 7d0a 2020 2020  l_dict = {}.    
+0004ab40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ab50: 6f75 745f 7061 7468 203d 2027 7b7d 2f73  out_path = '{}/s
+0004ab60: 6d6f 6327 2e66 6f72 6d61 7428 7365 6c66  moc'.format(self
+0004ab70: 2e77 6f72 6b64 6972 290a 2020 2020 2020  .workdir).      
+0004ab80: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+0004ab90: 7220 6d6f 6465 6c20 696e 2073 656c 662e  r model in self.
+0004aba0: 6d6f 6465 6c73 3a0a 2020 2020 2020 2020  models:.        
+0004abb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004abc0: 6675 6c6c 5f6d 6f64 656c 203d 2027 7b7d  full_model = '{}
+0004abd0: 7b7d 272e 666f 726d 6174 2873 656c 662e  {}'.format(self.
+0004abe0: 776f 726b 6469 722c 206f 732e 7061 7468  workdir, os.path
+0004abf0: 2e62 6173 656e 616d 6528 6d6f 6465 6c2e  .basename(model.
+0004ac00: 6669 6c65 6e61 6d65 2929 0a20 2020 2020  filename)).     
+0004ac10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ac20: 2020 2066 756c 6c5f 6d61 7020 3d20 277b     full_map = '{
+0004ac30: 7d7b 7d27 2e66 6f72 6d61 7428 7365 6c66  }{}'.format(self
+0004ac40: 2e77 6f72 6b64 6972 2c20 7365 6c66 2e6d  .workdir, self.m
+0004ac50: 6170 6e61 6d65 290a 2020 2020 2020 2020  apname).        
+0004ac60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ac70: 7265 7320 3d20 7365 6c66 2e72 6573 6f6c  res = self.resol
+0004ac80: 7574 696f 6e0a 0a20 2020 2020 2020 2020  ution..         
+0004ac90: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0004aca0: 6469 6374 2c20 7265 7272 203d 2072 756e  dict, rerr = run
+0004acb0: 5f73 6d6f 6328 6675 6c6c 5f6d 6f64 656c  _smoc(full_model
+0004acc0: 2c20 6675 6c6c 5f6d 6170 2c20 7265 732c  , full_map, res,
+0004acd0: 206f 7574 5f70 6174 6829 0a20 2020 2020   out_path).     
+0004ace0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004acf0: 2020 2069 6620 7264 6963 743a 0a0a 2020     if rdict:..  
+0004ad00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ad10: 2020 2020 2020 2020 2020 6669 6e61 6c5f            final_
+0004ad20: 6469 6374 5b73 7472 2863 6f75 6e74 295d  dict[str(count)]
+0004ad30: 203d 2072 6469 6374 0a20 2020 2020 2020   = rdict.       
+0004ad40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ad50: 2020 2020 2063 6f75 6e74 202b 3d20 310a       count += 1.
+0004ad60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004ad70: 2020 2020 2020 2020 2065 6e64 203d 2074           end = t
+0004ad80: 696d 6569 742e 6465 6661 756c 745f 7469  imeit.default_ti
+0004ad90: 6d65 7228 290a 2020 2020 2020 2020 2020  mer().          
+0004ada0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+0004adb0: 696e 7428 2753 4d4f 4320 7469 6d65 3a20  int('SMOC time: 
+0004adc0: 2573 2720 2520 2865 6e64 202d 2073 7461  %s' % (end - sta
+0004add0: 7274 2929 0a20 2020 2020 2020 2020 2020  rt)).           
+0004ade0: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+0004adf0: 6e74 2827 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  nt('------------
+0004ae00: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0004ae10: 2d2d 2d2d 2d2d 2d2d 2729 0a20 2020 2020  --------').     
+0004ae20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ae30: 2020 2069 6620 7265 7272 3a0a 2020 2020     if rerr:.    
+0004ae40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ae50: 2020 2020 2020 2020 6572 7220 3d20 2753          err = 'S
+0004ae60: 4d4f 4320 6361 6c63 756c 6174 696f 6e20  MOC calculation 
+0004ae70: 6572 726f 723a 207b 7d27 2e66 6f72 6d61  error: {}'.forma
+0004ae80: 7428 7265 7272 290a 2020 2020 2020 2020  t(rerr).        
+0004ae90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004aea0: 2020 2020 6572 726c 6973 742e 6170 7065      errlist.appe
+0004aeb0: 6e64 2865 7272 290a 2020 2020 2020 2020  nd(err).        
+0004aec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004aed0: 2020 2020 7379 732e 7374 6465 7272 2e77      sys.stderr.w
+0004aee0: 7269 7465 2865 7272 202b 2027 5c6e 2729  rite(err + '\n')
+0004aef0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004af00: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+0004af10: 6e74 2827 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  nt('------------
+0004af20: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0004af30: 2d2d 2d2d 2d2d 2d2d 2729 0a0a 2020 2020  --------')..    
+0004af40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004af50: 6966 2066 696e 616c 5f64 6963 743a 0a20  if final_dict:. 
 0004af60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004af70: 2020 2020 206a 736f 6e2e 6475 6d70 2866       json.dump(f
-0004af80: 696e 616c 5f64 6963 742c 2066 290a 0a20  inal_dict, f).. 
-0004af90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004afa0: 2020 2065 7863 6570 743a 0a20 2020 2020     except:.     
-0004afb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004afc0: 2020 2073 7973 2e73 7464 6572 722e 7772     sys.stderr.wr
-0004afd0: 6974 6528 2753 6176 696e 6720 746f 2053  ite('Saving to S
-0004afe0: 4d4f 4320 6a73 6f6e 2065 7272 6f72 3a20  MOC json error: 
-0004aff0: 7b7d 2e5c 6e27 2e66 6f72 6d61 7428 7379  {}.\n'.format(sy
-0004b000: 732e 6578 635f 696e 666f 2829 5b31 5d29  s.exc_info()[1])
-0004b010: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0004b020: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0004b030: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0004b040: 7428 2753 4d4f 4320 7761 7320 6e6f 7420  t('SMOC was not 
-0004b050: 636f 6c6c 6563 7465 642c 2070 6c65 6173  collected, pleas
-0004b060: 6520 6368 6563 6b21 2729 0a20 2020 2020  e check!').     
-0004b070: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0004b080: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-0004b090: 6e74 2866 277b 7363 6f72 655f 7479 7065  nt(f'{score_type
-0004b0a0: 7d20 4a53 4f4e 2065 7869 7374 2062 7574  } JSON exist but
-0004b0b0: 2063 6f72 7265 7370 6f6e 6469 6e67 2073   corresponding s
-0004b0c0: 636f 7265 2064 6f65 7320 6e6f 7420 6578  core does not ex
-0004b0d0: 6973 742e 2043 6865 636b 2074 6865 2065  ist. Check the e
-0004b0e0: 7272 6f72 2e27 290a 2020 2020 2020 2020  rror.').        
-0004b0f0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0004b100: 2020 7072 696e 7428 2753 4d4f 4320 4a53    print('SMOC JS
-0004b110: 4f4e 2072 6573 756c 7473 2064 6f65 7320  ON results does 
-0004b120: 6e6f 7420 6578 6973 742e 2043 6865 636b  not exist. Check
-0004b130: 2053 4d4f 4320 7275 6e2e 2729 0a0a 2020   SMOC run.')..  
-0004b140: 2020 6465 6620 736d 6f63 5f76 6965 7728    def smoc_view(
-0004b150: 7365 6c66 2c20 6368 696d 6572 6161 7070  self, chimeraapp
-0004b160: 293a 0a20 2020 2020 2020 2022 2222 0a0a  ):.        """..
-0004b170: 2020 2020 2020 2020 2020 2020 582c 2059              X, Y
-0004b180: 2c20 5a20 696d 6167 6573 2077 6869 6368  , Z images which
-0004b190: 206d 6f64 656c 2077 6173 2063 6f6c 6f72   model was color
-0004b1a0: 6564 2062 7920 534d 4f43 0a0a 2020 2020  ed by SMOC..    
-0004b1b0: 2020 2020 3a72 6574 7572 6e3a 0a20 2020      :return:.   
-0004b1c0: 2020 2020 2022 2222 0a0a 2020 2020 2020       """..      
-0004b1d0: 2020 2320 7265 6164 206a 736f 6e0a 2020    # read json.  
-0004b1e0: 2020 2020 2020 7374 6172 7420 3d20 7469        start = ti
-0004b1f0: 6d65 6974 2e64 6566 6175 6c74 5f74 696d  meit.default_tim
-0004b200: 6572 2829 0a20 2020 2020 2020 2069 6e6a  er().        inj
-0004b210: 736f 6e20 3d20 676c 6f62 2e67 6c6f 6228  son = glob.glob(
-0004b220: 7365 6c66 2e77 6f72 6b64 6972 202b 2027  self.workdir + '
-0004b230: 2a5f 736d 6f63 2e6a 736f 6e27 290a 2020  *_smoc.json').  
-0004b240: 2020 2020 2020 6261 7365 6469 7220 3d20        basedir = 
-0004b250: 7365 6c66 2e77 6f72 6b64 6972 0a20 2020  self.workdir.   
-0004b260: 2020 2020 206d 6170 6e61 6d65 203d 2073       mapname = s
-0004b270: 656c 662e 6d61 706e 616d 650a 2020 2020  elf.mapname.    
-0004b280: 2020 2020 6c6f 6343 4849 4d45 5241 203d      locCHIMERA =
-0004b290: 2063 6869 6d65 7261 6170 700a 2020 2020   chimeraapp.    
-0004b2a0: 2020 2020 6269 6e64 6973 706c 6179 203d      bindisplay =
-0004b2b0: 206f 732e 6765 7465 6e76 2827 4449 5350   os.getenv('DISP
-0004b2c0: 4c41 5927 290a 2020 2020 2020 2020 6572  LAY').        er
-0004b2d0: 726c 6973 7420 3d20 5b5d 0a0a 2020 2020  rlist = []..    
-0004b2e0: 2020 2020 6675 6c69 6e6a 736f 6e20 3d20      fulinjson = 
-0004b2f0: 696e 6a73 6f6e 5b30 5d20 6966 2069 6e6a  injson[0] if inj
-0004b300: 736f 6e20 656c 7365 204e 6f6e 650a 2020  son else None.  
-0004b310: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0004b320: 2020 2020 2020 2069 6620 6675 6c69 6e6a         if fulinj
-0004b330: 736f 6e3a 0a20 2020 2020 2020 2020 2020  son:.           
-0004b340: 2020 2020 2077 6974 6820 6f70 656e 2866       with open(f
-0004b350: 756c 696e 6a73 6f6e 2c20 2772 2729 2061  ulinjson, 'r') a
-0004b360: 7320 663a 0a20 2020 2020 2020 2020 2020  s f:.           
-0004b370: 2020 2020 2020 2020 2061 7267 7320 3d20           args = 
-0004b380: 6a73 6f6e 2e6c 6f61 6428 6629 0a20 2020  json.load(f).   
-0004b390: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0004b3a0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0004b3b0: 7267 7320 3d20 4e6f 6e65 0a20 2020 2020  rgs = None.     
-0004b3c0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-0004b3d0: 2827 5468 6572 6520 6973 206e 6f20 534d  ('There is no SM
-0004b3e0: 4f43 206a 736f 6e20 6669 6c65 2e27 290a  OC json file.').
-0004b3f0: 2020 2020 2020 2020 6578 6365 7074 2054          except T
-0004b400: 7970 6545 7272 6f72 3a0a 2020 2020 2020  ypeError:.      
-0004b410: 2020 2020 2020 6572 7220 3d20 274f 7065        err = 'Ope
-0004b420: 6e20 534d 4f43 204a 534f 4e20 6572 726f  n SMOC JSON erro
-0004b430: 723a 207b 7d2e 272e 666f 726d 6174 2873  r: {}.'.format(s
-0004b440: 7973 2e65 7863 5f69 6e66 6f28 295b 315d  ys.exc_info()[1]
-0004b450: 290a 2020 2020 2020 2020 2020 2020 6572  ).            er
-0004b460: 726c 6973 742e 6170 7065 6e64 2865 7272  rlist.append(err
-0004b470: 290a 2020 2020 2020 2020 2020 2020 7379  ).            sy
-0004b480: 732e 7374 6465 7272 2e77 7269 7465 2865  s.stderr.write(e
-0004b490: 7272 202b 2027 5c6e 2729 0a20 2020 2020  rr + '\n').     
-0004b4a0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0004b4b0: 2020 2020 2069 6620 6172 6773 2069 7320       if args is 
-0004b4c0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-0004b4d0: 2020 2020 2020 2020 2020 6d6f 6465 6c73            models
-0004b4e0: 203d 2061 7267 735b 2773 6d6f 6327 5d0a   = args['smoc'].
-0004b4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b500: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-0004b510: 2020 2020 2020 2020 2064 656c 206d 6f64           del mod
-0004b520: 656c 735b 2765 7272 275d 0a20 2020 2020  els['err'].     
-0004b530: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-0004b540: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
-0004b550: 2020 2020 2020 2070 7269 6e74 2827 534d         print('SM
-0004b560: 4f43 206a 736f 6e20 7265 7375 6c74 2069  OC json result i
-0004b570: 7320 636f 7272 6563 7427 290a 0a20 2020  s correct')..   
-0004b580: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-0004b590: 6e74 2827 5468 6572 6520 6973 2f61 7265  nt('There is/are
-0004b5a0: 2025 7320 6d6f 6465 6c28 7329 2e27 2025   %s model(s).' %
-0004b5b0: 206c 656e 286d 6f64 656c 7329 290a 2020   len(models)).  
-0004b5c0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0004b5d0: 7220 286b 6579 2c20 7661 6c75 6529 2069  r (key, value) i
-0004b5e0: 6e20 6974 6572 6974 656d 7328 6d6f 6465  n iteritems(mode
-0004b5f0: 6c73 293a 0a20 2020 2020 2020 2020 2020  ls):.           
-0004b600: 2020 2020 2020 2020 2023 2066 6f72 2028           # for (
-0004b610: 6b65 7932 2c20 7661 6c75 6532 2920 696e  key2, value2) in
-0004b620: 2069 7465 7269 7465 6d73 2876 616c 7565   iteritems(value
-0004b630: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0004b640: 2020 2020 2020 2069 6620 7479 7065 2876         if type(v
-0004b650: 616c 7565 2920 6973 2066 6c6f 6174 3a0a  alue) is float:.
-0004b660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b670: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
-0004b680: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004b690: 2020 2020 206b 6579 6c69 7374 203d 206c       keylist = l
-0004b6a0: 6973 7428 7661 6c75 6529 0a20 2020 2020  ist(value).     
-0004b6b0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0004b6c0: 6f72 206b 6579 2069 6e20 6b65 796c 6973  or key in keylis
-0004b6d0: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
-0004b6e0: 2020 2020 2020 2020 2020 2069 6620 6b65             if ke
-0004b6f0: 7920 213d 2027 6e61 6d65 273a 0a20 2020  y != 'name':.   
-0004b700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b710: 2020 2020 2020 2020 2063 6f6c 6f72 7320           colors 
-0004b720: 3d20 7661 6c75 655b 6b65 795d 5b27 636f  = value[key]['co
-0004b730: 6c6f 7227 5d0a 2020 2020 2020 2020 2020  lor'].          
-0004b740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b750: 2020 7265 7369 6475 6573 203d 2076 616c    residues = val
-0004b760: 7565 5b6b 6579 5d5b 2772 6573 6964 7565  ue[key]['residue
-0004b770: 275d 0a20 2020 2020 2020 2020 2020 2020  '].             
-0004b780: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0004b790: 6d6f 6373 203d 2076 616c 7565 5b6b 6579  mocs = value[key
-0004b7a0: 5d5b 2773 6d6f 635f 7363 6f72 6573 275d  ]['smoc_scores']
-0004b7b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004b7c0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0004b7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b7e0: 2020 2020 2020 2020 2020 206d 6f64 656c             model
-0004b7f0: 6e61 6d65 203d 2076 616c 7565 5b6b 6579  name = value[key
-0004b800: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0004b810: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
-0004b820: 6465 6c20 3d20 7365 6c66 2e77 6f72 6b64  del = self.workd
-0004b830: 6972 202b 206d 6f64 656c 6e61 6d65 0a20  ir + modelname. 
-0004b840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b850: 2020 2020 2020 2020 2020 2063 6869 6d65             chime
-0004b860: 7261 666e 616d 6520 3d20 277b 7d5f 7b7d  rafname = '{}_{}
-0004b870: 5f73 6d6f 635f 6368 696d 6572 612e 6378  _smoc_chimera.cx
-0004b880: 6327 2e66 6f72 6d61 7428 6d6f 6465 6c6e  c'.format(modeln
-0004b890: 616d 652c 206d 6170 6e61 6d65 290a 2020  ame, mapname).  
+0004af70: 2020 2020 2020 2072 6573 756c 745f 6469         result_di
+0004af80: 6374 5b27 736d 6f63 275d 203d 2066 696e  ct['smoc'] = fin
+0004af90: 616c 5f64 6963 740a 0a20 2020 2020 2020  al_dict..       
+0004afa0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0004afb0: 6572 726c 6973 743a 0a20 2020 2020 2020  errlist:.       
+0004afc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004afd0: 2072 6573 756c 745f 6469 6374 5b27 6572   result_dict['er
+0004afe0: 7227 5d20 3d20 6572 726c 6973 740a 0a20  r'] = errlist.. 
+0004aff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b000: 2020 2069 6620 7265 7375 6c74 5f64 6963     if result_dic
+0004b010: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+0004b020: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+0004b030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b040: 2020 2020 2020 2020 2020 2020 7769 7468              with
+0004b050: 2063 6f64 6563 732e 6f70 656e 2873 656c   codecs.open(sel
+0004b060: 662e 776f 726b 6469 7220 2b20 7365 6c66  f.workdir + self
+0004b070: 2e6d 6170 6e61 6d65 202b 2027 5f73 6d6f  .mapname + '_smo
+0004b080: 632e 6a73 6f6e 272c 2027 7727 2c0a 2020  c.json', 'w',.  
+0004b090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b0b0: 2020 2020 2020 2020 2020 2065 6e63 6f64             encod
+0004b0c0: 696e 673d 2775 7466 2d38 2729 2061 7320  ing='utf-8') as 
+0004b0d0: 663a 0a20 2020 2020 2020 2020 2020 2020  f:.             
+0004b0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b0f0: 2020 206a 736f 6e2e 6475 6d70 2872 6573     json.dump(res
+0004b100: 756c 745f 6469 6374 2c20 6629 0a0a 2020  ult_dict, f)..  
+0004b110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b120: 2020 2020 2020 2020 2020 7769 7468 2063            with c
+0004b130: 6f64 6563 732e 6f70 656e 286f 7574 5f70  odecs.open(out_p
+0004b140: 6174 6820 2b20 272f 2720 2b20 7365 6c66  ath + '/' + self
+0004b150: 2e6d 6170 6e61 6d65 202b 2027 5f73 6d6f  .mapname + '_smo
+0004b160: 632e 6a73 6f6e 272c 2027 7727 2c20 656e  c.json', 'w', en
+0004b170: 636f 6469 6e67 3d27 7574 662d 3827 2920  coding='utf-8') 
+0004b180: 6173 2066 663a 0a20 2020 2020 2020 2020  as ff:.         
+0004b190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b1a0: 2020 2020 2020 206a 736f 6e2e 6475 6d70         json.dump
+0004b1b0: 2872 6573 756c 745f 6469 6374 2c20 6666  (result_dict, ff
+0004b1c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0004b1d0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0004b1e0: 6c66 2e73 6d6f 635f 7375 7266 6163 6528  lf.smoc_surface(
+0004b1f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0004b200: 2020 2020 2020 2020 2020 6578 6365 7074            except
+0004b210: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0004b220: 2020 2020 2020 2020 2020 2020 2020 7379                sy
+0004b230: 732e 7374 6465 7272 2e77 7269 7465 2827  s.stderr.write('
+0004b240: 5361 7669 6e67 2074 6f20 534d 4f43 206a  Saving to SMOC j
+0004b250: 736f 6e20 6572 726f 723a 207b 7d2e 5c6e  son error: {}.\n
+0004b260: 272e 666f 726d 6174 2873 7973 2e65 7863  '.format(sys.exc
+0004b270: 5f69 6e66 6f28 295b 315d 2929 0a20 2020  _info()[1])).   
+0004b280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b290: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0004b2a0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0004b2b0: 7269 6e74 2827 534d 4f43 2077 6173 206e  rint('SMOC was n
+0004b2c0: 6f74 2063 6f6c 6c65 6374 6564 2c20 706c  ot collected, pl
+0004b2d0: 6561 7365 2063 6865 636b 2127 290a 0a20  ease check!').. 
+0004b2e0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0004b2f0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0004b300: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
+0004b310: 4e6f 206d 6f64 656c 206f 7220 736f 6d65  No model or some
+0004b320: 7468 696e 6720 7772 6f6e 6720 7769 7468  thing wrong with
+0004b330: 206d 6f64 656c 206c 6f61 6469 6e67 2e27   model loading.'
+0004b340: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0004b350: 2020 2020 2020 7072 696e 7428 272d 2d2d        print('---
+0004b360: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0004b370: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0004b380: 2d27 290a 2020 2020 2020 2020 2020 2020  -').            
+0004b390: 6578 6365 7074 3a0a 2020 2020 2020 2020  except:.        
+0004b3a0: 2020 2020 2020 2020 6572 7220 3d20 2753          err = 'S
+0004b3b0: 4d4f 4320 6361 6c63 756c 6174 696f 6e20  MOC calculation 
+0004b3c0: 6572 726f 723a 207b 7d2e 272e 666f 726d  error: {}.'.form
+0004b3d0: 6174 2873 7973 2e65 7863 5f69 6e66 6f28  at(sys.exc_info(
+0004b3e0: 295b 315d 290a 2020 2020 2020 2020 2020  )[1]).          
+0004b3f0: 2020 2020 2020 6572 726c 6973 742e 6170        errlist.ap
+0004b400: 7065 6e64 2865 7272 290a 2020 2020 2020  pend(err).      
+0004b410: 2020 2020 2020 2020 2020 7379 732e 7374            sys.st
+0004b420: 6465 7272 2e77 7269 7465 2865 7272 202b  derr.write(err +
+0004b430: 2027 5c6e 2729 0a0a 0a20 2020 2020 2020   '\n')...       
+0004b440: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0004b450: 2020 2070 7269 6e74 2827 4368 6563 6b20     print('Check 
+0004b460: 7468 6520 656e 7472 792c 2074 6865 7265  the entry, there
+0004b470: 2069 7320 6e6f 2053 4d4f 4320 666f 7220   is no SMOC for 
+0004b480: 7468 6973 2065 6e74 7279 2e27 290a 0a20  this entry.').. 
+0004b490: 2020 2020 2020 2072 6574 7572 6e20 4e6f         return No
+0004b4a0: 6e65 0a0a 2020 2020 6465 6620 6765 745f  ne..    def get_
+0004b4b0: 6261 7228 7365 6c66 2c20 7363 6f72 655f  bar(self, score_
+0004b4c0: 7479 7065 293a 0a0a 0a20 2020 2020 2020  type):...       
+0004b4d0: 2073 636f 7265 5f6c 6973 7420 3d20 5b27   score_list = ['
+0004b4e0: 6363 6327 2c20 2743 4343 272c 2027 6174  ccc', 'CCC', 'at
+0004b4f0: 6f6d 5f69 6e63 6c75 7369 6f6e 5f62 795f  om_inclusion_by_
+0004b500: 6c65 7665 6c27 2c20 2773 6d6f 6327 2c20  level', 'smoc', 
+0004b510: 2771 7363 6f72 6527 5d0a 2020 2020 2020  'qscore'].      
+0004b520: 2020 6669 6c65 5f6e 616d 6520 3d20 4e6f    file_name = No
+0004b530: 6e65 0a20 2020 2020 2020 2069 6620 7363  ne.        if sc
+0004b540: 6f72 655f 7479 7065 203d 3d20 2773 6d6f  ore_type == 'smo
+0004b550: 6327 3a0a 2020 2020 2020 2020 2020 2020  c':.            
+0004b560: 6669 6c65 5f6e 616d 6520 3d20 277b 7d2f  file_name = '{}/
+0004b570: 7b7d 5f7b 7d2e 6a73 6f6e 272e 666f 726d  {}_{}.json'.form
+0004b580: 6174 2873 656c 662e 776f 726b 6469 722c  at(self.workdir,
+0004b590: 2073 656c 662e 6d61 706e 616d 652c 2073   self.mapname, s
+0004b5a0: 636f 7265 5f74 7970 6529 0a20 2020 2020  core_type).     
+0004b5b0: 2020 2065 6c69 6620 7363 6f72 655f 7479     elif score_ty
+0004b5c0: 7065 203d 3d20 2763 6363 273a 0a20 2020  pe == 'ccc':.   
+0004b5d0: 2020 2020 2020 2020 2066 696c 655f 6e61           file_na
+0004b5e0: 6d65 203d 2027 7b7d 2f7b 7d5f 7265 737b  me = '{}/{}_res{
+0004b5f0: 7d2e 6a73 6f6e 272e 666f 726d 6174 2873  }.json'.format(s
+0004b600: 656c 662e 776f 726b 6469 722c 2073 656c  elf.workdir, sel
+0004b610: 662e 6d61 706e 616d 652c 2073 636f 7265  f.mapname, score
+0004b620: 5f74 7970 6529 0a20 2020 2020 2020 2065  _type).        e
+0004b630: 6c69 6620 7363 6f72 655f 7479 7065 203d  lif score_type =
+0004b640: 3d20 2771 7363 6f72 6527 3a0a 2020 2020  = 'qscore':.    
+0004b650: 2020 2020 2020 2020 6669 6c65 5f6e 616d          file_nam
+0004b660: 6520 3d20 277b 7d2f 7b7d 5f7b 7d2e 6a73  e = '{}/{}_{}.js
+0004b670: 6f6e 272e 666f 726d 6174 2873 656c 662e  on'.format(self.
+0004b680: 776f 726b 6469 722c 2073 656c 662e 6d61  workdir, self.ma
+0004b690: 706e 616d 652c 2073 636f 7265 5f74 7970  pname, score_typ
+0004b6a0: 6529 0a20 2020 2020 2020 2065 6c69 6620  e).        elif 
+0004b6b0: 7363 6f72 655f 7479 7065 203d 3d20 2761  score_type == 'a
+0004b6c0: 746f 6d5f 696e 636c 7573 696f 6e27 3a0a  tom_inclusion':.
+0004b6d0: 2020 2020 2020 2020 2020 2020 6669 6c65              file
+0004b6e0: 5f6e 616d 6520 3d20 277b 7d2f 7b7d 5f7b  _name = '{}/{}_{
+0004b6f0: 7d2e 6a73 6f6e 272e 666f 726d 6174 2873  }.json'.format(s
+0004b700: 656c 662e 776f 726b 6469 722c 2073 656c  elf.workdir, sel
+0004b710: 662e 6d61 706e 616d 652c 2073 636f 7265  f.mapname, score
+0004b720: 5f74 7970 6529 0a0a 2020 2020 2020 2020  _type)..        
+0004b730: 6966 2066 696c 655f 6e61 6d65 2061 6e64  if file_name and
+0004b740: 206f 732e 7061 7468 2e69 7366 696c 6528   os.path.isfile(
+0004b750: 6669 6c65 5f6e 616d 6529 3a0a 2020 2020  file_name):.    
+0004b760: 2020 2020 2020 2020 7769 7468 206f 7065          with ope
+0004b770: 6e28 6669 6c65 5f6e 616d 652c 2027 7227  n(file_name, 'r'
+0004b780: 2920 6173 206a 736f 6e5f 6669 6c65 3a0a  ) as json_file:.
+0004b790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b7a0: 6375 725f 6a73 6f6e 203d 206a 736f 6e2e  cur_json = json.
+0004b7b0: 6c6f 6164 286a 736f 6e5f 6669 6c65 290a  load(json_file).
+0004b7c0: 2020 2020 2020 2020 2020 2020 6966 2061              if a
+0004b7d0: 6e79 2869 7465 6d20 696e 2063 7572 5f6a  ny(item in cur_j
+0004b7e0: 736f 6e20 666f 7220 6974 656d 2069 6e20  son for item in 
+0004b7f0: 7363 6f72 655f 6c69 7374 293a 0a20 2020  score_list):.   
+0004b800: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0004b810: 7363 6f72 655f 7479 7065 203d 3d20 2761  score_type == 'a
+0004b820: 746f 6d5f 696e 636c 7573 696f 6e27 3a0a  tom_inclusion':.
+0004b830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b840: 2020 2020 736d 6f63 5f64 6174 6120 3d20      smoc_data = 
+0004b850: 6375 725f 6a73 6f6e 5b66 277b 7363 6f72  cur_json[f'{scor
+0004b860: 655f 7479 7065 7d5f 6279 5f6c 6576 656c  e_type}_by_level
+0004b870: 275d 0a20 2020 2020 2020 2020 2020 2020  '].             
+0004b880: 2020 2065 6c69 6620 7363 6f72 655f 7479     elif score_ty
+0004b890: 7065 203d 3d20 2763 6363 273a 0a20 2020  pe == 'ccc':.   
 0004b8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b8b0: 2020 2020 2020 2020 2020 7375 7266 6163            surfac
-0004b8c0: 6566 6e20 3d20 277b 7d7b 7d5f 7b7d 272e  efn = '{}{}_{}'.
-0004b8d0: 666f 726d 6174 2862 6173 6564 6972 2c20  format(basedir, 
-0004b8e0: 6d6f 6465 6c6e 616d 652c 206d 6170 6e61  modelname, mapna
-0004b8f0: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
-0004b900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b910: 6368 696d 6572 6163 6d64 203d 2063 6869  chimeracmd = chi
-0004b920: 6d65 7261 666e 616d 650a 2020 2020 2020  merafname.      
-0004b930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b940: 2020 2020 2020 2320 7064 626d 6f64 656c        # pdbmodel
-0004b950: 6e61 6d65 203d 2027 7b7d 7b7d 5f5f 515f  name = '{}{}__Q_
-0004b960: 5f7b 7d2e 7064 6227 2e66 6f72 6d61 7428  _{}.pdb'.format(
-0004b970: 6261 7365 6469 722c 206d 6f64 656c 6e61  basedir, modelna
-0004b980: 6d65 5b3a 2d34 5d2c 206d 6170 6e61 6d65  me[:-4], mapname
-0004b990: 5b3a 2d34 5d29 0a20 2020 2020 2020 2020  [:-4]).         
-0004b9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004b9b0: 2020 2070 6462 6d6f 6465 6c6e 616d 6520     pdbmodelname 
-0004b9c0: 3d20 277b 7d7b 7d27 2e66 6f72 6d61 7428  = '{}{}'.format(
-0004b9d0: 6261 7365 6469 722c 206d 6f64 656c 6e61  basedir, modelna
-0004b9e0: 6d65 290a 0a20 2020 2020 2020 2020 2020  me)..           
-0004b9f0: 2020 2020 2020 2020 2077 6974 6820 6f70           with op
-0004ba00: 656e 2873 656c 662e 776f 726b 6469 7220  en(self.workdir 
-0004ba10: 2b20 6368 696d 6572 6163 6d64 2c20 2777  + chimeracmd, 'w
-0004ba20: 2729 2061 7320 6670 3a0a 2020 2020 2020  ') as fp:.      
-0004ba30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ba40: 2020 6670 2e77 7269 7465 2822 6f70 656e    fp.write("open
-0004ba50: 2022 202b 2073 7472 2870 6462 6d6f 6465   " + str(pdbmode
-0004ba60: 6c6e 616d 6529 202b 2022 2066 6f72 6d61  lname) + " forma
-0004ba70: 7420 6d6d 6369 6622 202b 2027 5c6e 2729  t mmcif" + '\n')
-0004ba80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004ba90: 2020 2020 2020 2020 2023 2066 702e 7772           # fp.wr
-0004baa0: 6974 6528 226f 7065 6e20 2220 2b20 7374  ite("open " + st
-0004bab0: 7228 7064 626d 6f64 656c 6e61 6d65 2920  r(pdbmodelname) 
-0004bac0: 2b20 2220 666f 726d 6174 2070 6462 2220  + " format pdb" 
-0004bad0: 2b20 275c 6e27 290a 2020 2020 2020 2020  + '\n').        
-0004bae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004baf0: 6670 2e77 7269 7465 2827 7368 6f77 2073  fp.write('show s
-0004bb00: 656c 4174 6f6d 7320 7269 6262 6f6e 7327  elAtoms ribbons'
-0004bb10: 202b 2027 5c6e 2729 0a20 2020 2020 2020   + '\n').       
-0004bb20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bb30: 2066 702e 7772 6974 6528 2768 6964 6520   fp.write('hide 
-0004bb40: 7365 6c41 746f 6d73 2720 2b20 275c 6e27  selAtoms' + '\n'
-0004bb50: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-0004bb60: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
-0004bb70: 636f 6c6f 722c 2072 6573 6964 7565 2c20  color, residue, 
-0004bb80: 736d 6f63 7363 6f72 6529 2069 6e20 7a69  smocscore) in zi
-0004bb90: 7028 636f 6c6f 7273 2c20 7265 7369 6475  p(colors, residu
-0004bba0: 6573 2c20 736d 6f63 7329 3a0a 2020 2020  es, smocs):.    
+0004b8b0: 2069 6620 2763 6363 2720 696e 2063 7572   if 'ccc' in cur
+0004b8c0: 5f6a 736f 6e2e 6b65 7973 2829 3a0a 2020  _json.keys():.  
+0004b8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b8e0: 2020 2020 2020 736d 6f63 5f64 6174 6120        smoc_data 
+0004b8f0: 3d20 6375 725f 6a73 6f6e 5b27 6363 6327  = cur_json['ccc'
+0004b900: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0004b910: 2020 2020 2020 656c 6966 2027 4343 4327        elif 'CCC'
+0004b920: 2069 6e20 6375 725f 6a73 6f6e 2e6b 6579   in cur_json.key
+0004b930: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+0004b940: 2020 2020 2020 2020 2020 2020 2073 6d6f               smo
+0004b950: 635f 6461 7461 203d 2063 7572 5f6a 736f  c_data = cur_jso
+0004b960: 6e5b 2743 4343 275d 0a20 2020 2020 2020  n['CCC'].       
+0004b970: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+0004b980: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0004b990: 2020 2020 2020 2020 2020 2073 6d6f 635f             smoc_
+0004b9a0: 6461 7461 203d 204e 6f6e 650a 2020 2020  data = None.    
+0004b9b0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0004b9c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0004b9d0: 2020 2020 2020 736d 6f63 5f64 6174 6120        smoc_data 
+0004b9e0: 3d20 6375 725f 6a73 6f6e 5b73 636f 7265  = cur_json[score
+0004b9f0: 5f74 7970 655d 0a20 2020 2020 2020 2020  _type].         
+0004ba00: 2020 2020 2020 2069 6620 7363 6f72 655f         if score_
+0004ba10: 7479 7065 203d 3d20 2761 746f 6d5f 696e  type == 'atom_in
+0004ba20: 636c 7573 696f 6e27 3a0a 2020 2020 2020  clusion':.      
+0004ba30: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0004ba40: 2027 6176 6572 6167 655f 6169 5f61 6c6c   'average_ai_all
+0004ba50: 6d6f 6465 6c73 2720 696e 2073 6d6f 635f  models' in smoc_
+0004ba60: 6461 7461 2e6b 6579 7328 293a 0a20 2020  data.keys():.   
+0004ba70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ba80: 2020 2020 206d 6f64 656c 5f6e 756d 6265       model_numbe
+0004ba90: 7273 203d 206c 656e 2873 6d6f 635f 6461  rs = len(smoc_da
+0004baa0: 7461 2920 2d20 310a 2020 2020 2020 2020  ta) - 1.        
+0004bab0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0004bac0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0004bad0: 2020 2020 2020 2020 2020 6d6f 6465 6c5f            model_
+0004bae0: 6e75 6d62 6572 7320 3d20 6c65 6e28 736d  numbers = len(sm
+0004baf0: 6f63 5f64 6174 6129 0a20 2020 2020 2020  oc_data).       
+0004bb00: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0004bb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004bb20: 2020 206d 6f64 656c 5f6e 756d 6265 7273     model_numbers
+0004bb30: 203d 206c 656e 2873 6d6f 635f 6461 7461   = len(smoc_data
+0004bb40: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0004bb50: 2020 6669 6e61 6c5f 6469 6374 203d 207b    final_dict = {
+0004bb60: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+0004bb70: 2020 6461 7461 203d 207b 7d0a 2020 2020    data = {}.    
+0004bb80: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0004bb90: 6920 696e 2072 616e 6765 2830 2c20 6d6f  i in range(0, mo
+0004bba0: 6465 6c5f 6e75 6d62 6572 7329 3a0a 2020  del_numbers):.  
 0004bbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bbc0: 2020 2020 2020 2020 6368 6169 6e2c 2072          chain, r
-0004bbd0: 6573 746d 7020 3d20 7265 7369 6475 652e  estmp = residue.
-0004bbe0: 7370 6c69 7428 273a 2729 0a20 2020 2020  split(':').     
-0004bbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bc00: 2020 2020 2020 2023 204e 6f74 2073 7572         # Not sur
-0004bc10: 6520 6966 2061 6c6c 2074 6865 206c 6574  e if all the let
-0004bc20: 7465 7273 2073 686f 756c 6420 6265 2072  ters should be r
-0004bc30: 6570 6c61 6365 640a 2020 2020 2020 2020  eplaced.        
-0004bc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bc50: 2020 2020 2320 3173 7420 7761 7920 6f66      # 1st way of
-0004bc60: 2067 6574 7469 6e67 2072 6573 5f69 640a   getting res_id.
-0004bc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bc80: 2020 2020 2020 2020 2020 2020 2320 7265              # re
-0004bc90: 735f 6964 203d 2072 652e 7375 6228 225c  s_id = re.sub("\
-0004bca0: 4422 2c20 2222 2c20 7265 7374 6d70 290a  D", "", restmp).
-0004bcb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bcc0: 2020 2020 2020 2020 2020 2020 2320 326e              # 2n
-0004bcd0: 6420 7761 7920 6f66 2067 6574 7469 6e67  d way of getting
-0004bce0: 2072 6573 0a20 2020 2020 2020 2020 2020   res.           
-0004bcf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bd00: 2072 6573 5f69 6420 3d20 7265 2e66 696e   res_id = re.fin
-0004bd10: 6461 6c6c 2872 272d 3f5c 642b 272c 2072  dall(r'-?\d+', r
-0004bd20: 6573 746d 7029 5b30 5d0a 2020 2020 2020  estmp)[0].      
-0004bd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bd40: 2020 2020 2020 6670 2e77 7269 7465 280a        fp.write(.
-0004bd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bd70: 2763 6f6c 6f72 202f 2720 2b20 6368 6169  'color /' + chai
-0004bd80: 6e20 2b20 273a 2720 2b20 7265 735f 6964  n + ':' + res_id
-0004bd90: 202b 2027 2027 202b 2063 6f6c 6f72 202b   + ' ' + color +
-0004bda0: 2027 5c6e 270a 2020 2020 2020 2020 2020   '\n'.          
-0004bdb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bdc0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0004bdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bde0: 6966 2073 6d6f 6373 636f 7265 203e 2031  if smocscore > 1
-0004bdf0: 2e30 3a0a 2020 2020 2020 2020 2020 2020  .0:.            
-0004be00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004be10: 2020 2020 6670 2e77 7269 7465 280a 2020      fp.write(.  
-0004be20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004be30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004be40: 2020 2773 686f 7720 2f27 202b 2063 6861    'show /' + cha
-0004be50: 696e 202b 2027 3a27 202b 2072 6573 5f69  in + ':' + res_i
-0004be60: 6420 2b20 2720 6174 6f6d 7327 202b 2027  d + ' atoms' + '
-0004be70: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
+0004bbc0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+0004bbd0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0004bbe0: 7572 5f73 6d6f 635f 6461 7461 203d 2073  ur_smoc_data = s
+0004bbf0: 6d6f 635f 6461 7461 5b73 7472 2869 295d  moc_data[str(i)]
+0004bc00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004bc10: 2020 2020 2065 7863 6570 7420 4b65 7945       except KeyE
+0004bc20: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
+0004bc30: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+0004bc40: 696e 7428 6627 4b65 793a 207b 697d 3a20  int(f'Key: {i}: 
+0004bc50: 7b6c 6973 7428 736d 6f63 5f64 6174 612e  {list(smoc_data.
+0004bc60: 6b65 7973 2829 295b 695d 7d20 736b 6970  keys())[i]} skip
+0004bc70: 7065 642e 2729 0a20 2020 2020 2020 2020  ped.').         
+0004bc80: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0004bc90: 6f6e 7469 6e75 650a 2020 2020 2020 2020  ontinue.        
+0004bca0: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
+0004bcb0: 6c5f 6e61 6d65 203d 2063 7572 5f73 6d6f  l_name = cur_smo
+0004bcc0: 635f 6461 7461 5b27 6e61 6d65 275d 0a20  c_data['name']. 
+0004bcd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004bce0: 2020 2069 6620 7363 6f72 655f 7479 7065     if score_type
+0004bcf0: 203d 3d20 2763 6363 273a 0a20 2020 2020   == 'ccc':.     
+0004bd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004bd10: 2020 206e 6577 5f64 6963 7420 3d20 7b27     new_dict = {'
+0004bd20: 6964 273a 2073 656c 662e 656d 6469 642c  id': self.emdid,
+0004bd30: 2027 7265 736f 6c75 7469 6f6e 273a 2066   'resolution': f
+0004bd40: 6c6f 6174 2873 656c 662e 7265 736f 6c75  loat(self.resolu
+0004bd50: 7469 6f6e 292c 2027 6e61 6d65 273a 206d  tion), 'name': m
+0004bd60: 6f64 656c 5f6e 616d 652c 0a20 2020 2020  odel_name,.     
+0004bd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004bd80: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0004bd90: 636f 7265 5f74 7970 653a 2072 6f75 6e64  core_type: round
+0004bda0: 2863 7572 5f73 6d6f 635f 6461 7461 5b27  (cur_smoc_data['
+0004bdb0: 6461 7461 275d 5b27 6176 6572 6167 6563  data']['averagec
+0004bdc0: 6327 5d2c 2033 297d 0a20 2020 2020 2020  c'], 3)}.       
+0004bdd0: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
+0004bde0: 6620 7363 6f72 655f 7479 7065 203d 3d20  f score_type == 
+0004bdf0: 2761 746f 6d5f 696e 636c 7573 696f 6e27  'atom_inclusion'
+0004be00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0004be10: 2020 2020 2020 2020 2020 6e65 775f 6469            new_di
+0004be20: 6374 203d 207b 2769 6427 3a20 7365 6c66  ct = {'id': self
+0004be30: 2e65 6d64 6964 2c20 2772 6573 6f6c 7574  .emdid, 'resolut
+0004be40: 696f 6e27 3a20 666c 6f61 7428 7365 6c66  ion': float(self
+0004be50: 2e72 6573 6f6c 7574 696f 6e29 2c20 276e  .resolution), 'n
+0004be60: 616d 6527 3a20 6d6f 6465 6c5f 6e61 6d65  ame': model_name
+0004be70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
 0004be80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004be90: 2020 2020 2020 2020 2773 7479 6c65 202f          'style /
-0004bea0: 2720 2b20 6368 6169 6e20 2b20 273a 2720  ' + chain + ':' 
-0004beb0: 2b20 7265 735f 6964 202b 2027 2073 7469  + res_id + ' sti
-0004bec0: 636b 2720 2b20 275c 6e27 0a20 2020 2020  ck' + '\n'.     
-0004bed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bee0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0004bef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bf00: 2020 2020 2066 702e 7772 6974 6528 0a20       fp.write(. 
-0004bf10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bf20: 2020 2020 2020 2020 2020 2022 7365 7420             "set 
-0004bf30: 6267 436f 6c6f 7220 7768 6974 6522 202b  bgColor white" +
-0004bf40: 2027 5c6e 270a 2020 2020 2020 2020 2020   '\n'.          
-0004bf50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bf60: 2020 226c 6967 6874 696e 6720 736f 6674    "lighting soft
-0004bf70: 2220 2b20 275c 6e27 0a20 2020 2020 2020  " + '\n'.       
-0004bf80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bf90: 2020 2020 2022 7669 6577 2063 6f66 7220       "view cofr 
-0004bfa0: 5472 7565 2220 2b20 275c 6e27 0a20 2020  True" + '\n'.   
-0004bfb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004bfc0: 2020 2020 2020 2020 2022 7361 7665 2022           "save "
-0004bfd0: 202b 2073 7472 2873 7572 6661 6365 666e   + str(surfacefn
-0004bfe0: 2920 2b20 225f 7a73 6d6f 6373 7572 6661  ) + "_zsmocsurfa
-0004bff0: 6365 2e6a 7065 6722 202b 2022 2073 7570  ce.jpeg" + " sup
-0004c000: 6572 7361 6d70 6c65 2033 2077 6964 7468  ersample 3 width
-0004c010: 2031 3230 3020 6865 6967 6874 2031 3230   1200 height 120
-0004c020: 3022 202b 2027 5c6e 270a 2020 2020 2020  0" + '\n'.      
-0004c030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c040: 2020 2020 2020 2274 7572 6e20 7820 2d39        "turn x -9
-0004c050: 3022 202b 2027 5c6e 270a 2020 2020 2020  0" + '\n'.      
-0004c060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c070: 2020 2020 2020 2274 7572 6e20 7920 2d39        "turn y -9
-0004c080: 3022 202b 2027 5c6e 270a 2020 2020 2020  0" + '\n'.      
+0004be90: 2020 2020 2020 2761 6927 3a20 726f 756e        'ai': roun
+0004bea0: 6428 6375 725f 736d 6f63 5f64 6174 615b  d(cur_smoc_data[
+0004beb0: 2761 7665 7261 6765 5f61 695f 6d6f 6465  'average_ai_mode
+0004bec0: 6c27 5d2c 2033 297d 0a20 2020 2020 2020  l'], 3)}.       
+0004bed0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+0004bee0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0004bef0: 2020 2020 2020 2020 2020 206e 6577 5f64             new_d
+0004bf00: 6963 7420 3d20 7b27 6964 273a 2073 656c  ict = {'id': sel
+0004bf10: 662e 656d 6469 642c 2027 7265 736f 6c75  f.emdid, 'resolu
+0004bf20: 7469 6f6e 273a 2066 6c6f 6174 2873 656c  tion': float(sel
+0004bf30: 662e 7265 736f 6c75 7469 6f6e 292c 2027  f.resolution), '
+0004bf40: 6e61 6d65 273a 206d 6f64 656c 5f6e 616d  name': model_nam
+0004bf50: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+0004bf60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004bf70: 2020 2020 2020 2073 636f 7265 5f74 7970         score_typ
+0004bf80: 653a 2072 6f75 6e64 2863 7572 5f73 6d6f  e: round(cur_smo
+0004bf90: 635f 6461 7461 5b27 6461 7461 275d 5b66  c_data['data'][f
+0004bfa0: 2761 7665 7261 6765 7b73 636f 7265 5f74  'average{score_t
+0004bfb0: 7970 657d 275d 2c20 3329 7d0a 2020 2020  ype}'], 3)}.    
+0004bfc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004bfd0: 706c 6f74 5f6e 616d 6520 3d20 277b 7d5f  plot_name = '{}_
+0004bfe0: 7b7d 5f7b 7d5f 6261 722e 706e 6727 2e66  {}_{}_bar.png'.f
+0004bff0: 6f72 6d61 7428 7365 6c66 2e6d 6170 6e61  ormat(self.mapna
+0004c000: 6d65 2c20 6d6f 6465 6c5f 6e61 6d65 2c20  me, model_name, 
+0004c010: 7363 6f72 655f 7479 7065 290a 2020 2020  score_type).    
+0004c020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c030: 7363 6f72 655f 6469 7220 3d20 6f73 2e70  score_dir = os.p
+0004c040: 6174 682e 6469 726e 616d 6528 7661 2e5f  ath.dirname(va._
+0004c050: 5f66 696c 655f 5f29 0a20 2020 2020 2020  _file__).       
+0004c060: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0004c070: 7363 6f72 655f 7479 7065 203d 3d20 2761  score_type == 'a
+0004c080: 746f 6d5f 696e 636c 7573 696f 6e27 3a0a  tom_inclusion':.
 0004c090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c0a0: 2020 2020 2020 2276 6965 7720 636f 6672        "view cofr
-0004c0b0: 2054 7275 6522 202b 2027 5c6e 270a 2020   True" + '\n'.  
-0004c0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c0d0: 2020 2020 2020 2020 2020 2273 6176 6520            "save 
-0004c0e0: 2220 2b20 7374 7228 7375 7266 6163 6566  " + str(surfacef
-0004c0f0: 6e29 202b 2022 5f78 736d 6f63 7375 7266  n) + "_xsmocsurf
-0004c100: 6163 652e 6a70 6567 2220 2b20 2220 7375  ace.jpeg" + " su
-0004c110: 7065 7273 616d 706c 6520 3320 7769 6474  persample 3 widt
-0004c120: 6820 3132 3030 2068 6569 6768 7420 3132  h 1200 height 12
-0004c130: 3030 2220 2b20 275c 6e27 0a20 2020 2020  00" + '\n'.     
-0004c140: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c150: 2020 2020 2020 2022 7669 6577 206f 7269         "view ori
-0004c160: 656e 7422 202b 2027 5c6e 270a 2020 2020  ent" + '\n'.    
-0004c170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c180: 2020 2020 2020 2020 2274 7572 6e20 7820          "turn x 
-0004c190: 3930 2220 2b20 275c 6e27 0a20 2020 2020  90" + '\n'.     
-0004c1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c1b0: 2020 2020 2020 2022 7475 726e 207a 2039         "turn z 9
-0004c1c0: 3022 202b 2027 5c6e 270a 2020 2020 2020  0" + '\n'.      
-0004c1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c1e0: 2020 2020 2020 2276 6965 7720 636f 6672        "view cofr
-0004c1f0: 2054 7275 6522 202b 2027 5c6e 270a 2020   True" + '\n'.  
-0004c200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c210: 2020 2020 2020 2020 2020 2273 6176 6520            "save 
-0004c220: 2220 2b20 7374 7228 7375 7266 6163 6566  " + str(surfacef
-0004c230: 6e29 202b 2022 5f79 736d 6f63 7375 7266  n) + "_ysmocsurf
-0004c240: 6163 652e 6a70 6567 2220 2b20 2220 7375  ace.jpeg" + " su
-0004c250: 7065 7273 616d 706c 6520 3320 7769 6474  persample 3 widt
-0004c260: 6820 3132 3030 2068 6569 6768 7420 3132  h 1200 height 12
-0004c270: 3030 2220 2b20 275c 6e27 0a20 2020 2020  00" + '\n'.     
-0004c280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c290: 2020 2020 2020 2022 636c 6f73 6520 616c         "close al
-0004c2a0: 6c22 202b 2022 5c6e 220a 2020 2020 2020  l" + "\n".      
-0004c2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c2c0: 2020 2020 2020 2265 7869 7422 0a20 2020        "exit".   
-0004c2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c2e0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-0004c2f0: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-0004c300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c310: 2020 2020 2020 2020 6966 206e 6f74 2062          if not b
-0004c320: 696e 6469 7370 6c61 793a 0a20 2020 2020  indisplay:.     
-0004c330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c340: 2020 2020 2020 2073 7562 7072 6f63 6573         subproces
-0004c350: 732e 6368 6563 6b5f 6361 6c6c 286c 6f63  s.check_call(loc
-0004c360: 4348 494d 4552 4120 2b20 2220 2d2d 6f66  CHIMERA + " --of
-0004c370: 6673 6372 6565 6e20 2d2d 6e6f 6775 6920  fscreen --nogui 
-0004c380: 2220 2b20 7365 6c66 2e77 6f72 6b64 6972  " + self.workdir
-0004c390: 202b 2063 6869 6d65 7261 636d 642c 0a20   + chimeracmd,. 
-0004c3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c3d0: 2063 7764 3d73 656c 662e 776f 726b 6469   cwd=self.workdi
-0004c3e0: 722c 2073 6865 6c6c 3d54 7275 6529 0a20  r, shell=True). 
-0004c3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c400: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-0004c410: 2827 436f 6c6f 7265 6420 6d6f 6465 6c73  ('Colored models
-0004c420: 2062 6173 6564 206f 6e20 534d 4f43 2077   based on SMOC w
-0004c430: 6572 6520 7072 6f64 7563 6564 2e27 290a  ere produced.').
-0004c440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c450: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0004c460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c470: 2020 2020 2020 2020 2020 7375 6270 726f            subpro
-0004c480: 6365 7373 2e63 6865 636b 5f63 616c 6c28  cess.check_call(
-0004c490: 6c6f 6343 4849 4d45 5241 202b 2022 2022  locCHIMERA + " "
-0004c4a0: 202b 2073 656c 662e 776f 726b 6469 7220   + self.workdir 
-0004c4b0: 2b20 6368 696d 6572 6163 6d64 2c20 6377  + chimeracmd, cw
-0004c4c0: 643d 7365 6c66 2e77 6f72 6b64 6972 2c0a  d=self.workdir,.
-0004c4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c500: 2020 7368 656c 6c3d 5472 7565 290a 2020    shell=True).  
-0004c510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c520: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-0004c530: 2743 6f6c 6f72 6564 206d 6f64 656c 7320  'Colored models 
-0004c540: 6261 7365 6420 6f6e 2053 4d4f 4320 7765  based on SMOC we
-0004c550: 7265 2070 726f 6475 6365 642e 2729 0a20  re produced.'). 
-0004c560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c570: 2020 2065 7863 6570 7420 7375 6270 726f     except subpro
-0004c580: 6365 7373 2e43 616c 6c65 6450 726f 6365  cess.CalledProce
-0004c590: 7373 4572 726f 7220 6173 2073 7562 6572  ssError as suber
-0004c5a0: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
-0004c5b0: 2020 2020 2020 2020 2020 2065 7272 203d             err =
-0004c5c0: 2027 5361 7669 6e67 206d 6f64 656c 207b   'Saving model {
-0004c5d0: 7d20 534d 4f43 2076 6965 7720 6572 726f  } SMOC view erro
-0004c5e0: 723a 207b 7d2e 272e 666f 726d 6174 286d  r: {}.'.format(m
-0004c5f0: 6f64 656c 6e61 6d65 2c20 7375 6265 7272  odelname, suberr
-0004c600: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0004c610: 2020 2020 2020 2020 2020 6572 726c 6973            errlis
-0004c620: 742e 6170 7065 6e64 2865 7272 290a 2020  t.append(err).  
-0004c630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c640: 2020 2020 2020 7379 732e 7374 6465 7272        sys.stderr
-0004c650: 2e77 7269 7465 2865 7272 202b 2027 5c6e  .write(err + '\n
-0004c660: 2729 0a0a 2020 2020 2020 2020 2020 2020  ')..            
-0004c670: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0004c680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c690: 2020 2020 2073 656c 662e 7363 616c 655f       self.scale_
-0004c6a0: 7375 7266 6163 6576 6965 7728 290a 2020  surfaceview().  
-0004c6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c6c0: 2020 6578 6365 7074 3a0a 2020 2020 2020    except:.      
-0004c6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c6e0: 2020 6572 7220 3d20 2753 6361 6c69 6e67    err = 'Scaling
-0004c6f0: 206d 6f64 656c 2053 4d4f 4320 7669 6577   model SMOC view
-0004c700: 2065 7272 6f72 3a20 7b7d 2e27 2e66 6f72   error: {}.'.for
-0004c710: 6d61 7428 7379 732e 6578 635f 696e 666f  mat(sys.exc_info
-0004c720: 2829 5b31 5d29 0a20 2020 2020 2020 2020  ()[1]).         
-0004c730: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0004c740: 7272 6c69 7374 2e61 7070 656e 6428 6572  rrlist.append(er
-0004c750: 7229 0a20 2020 2020 2020 2020 2020 2020  r).             
-0004c760: 2020 2020 2020 2020 2020 2073 7973 2e73             sys.s
-0004c770: 7464 6572 722e 7772 6974 6528 6572 7220  tderr.write(err 
-0004c780: 2b20 275c 6e27 290a 0a20 2020 2020 2020  + '\n')..       
-0004c790: 2020 2020 2020 2020 2020 2020 206a 7065               jpe
-0004c7a0: 6773 203d 2067 6c6f 622e 676c 6f62 2873  gs = glob.glob(s
-0004c7b0: 656c 662e 776f 726b 6469 7220 2b20 272f  elf.workdir + '/
-0004c7c0: 2a73 6d6f 6373 7572 6661 6365 2e6a 7065  *smocsurface.jpe
-0004c7d0: 6727 290a 2020 2020 2020 2020 2020 2020  g').            
-0004c7e0: 2020 2020 2020 2020 6d6f 6465 6c73 7572          modelsur
-0004c7f0: 6620 3d20 6469 6374 2829 0a20 2020 2020  f = dict().     
-0004c800: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0004c810: 696e 616c 6d6d 6469 6374 203d 2064 6963  inalmmdict = dic
-0004c820: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
-0004c830: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-0004c840: 6d6f 6465 6c73 3a0a 2020 2020 2020 2020  models:.        
-0004c850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c860: 2320 7072 696e 7420 2273 656c 662e 6d6f  # print "self.mo
-0004c870: 6465 6c73 3a25 7322 2025 2073 656c 662e  dels:%s" % self.
-0004c880: 6d6f 6465 6c73 0a20 2020 2020 2020 2020  models.         
-0004c890: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0004c8a0: 6f72 206d 6f64 656c 2069 6e20 7365 6c66  or model in self
-0004c8b0: 2e6d 6f64 656c 733a 0a20 2020 2020 2020  .models:.       
-0004c8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c8d0: 2020 2020 206d 6f64 656c 6e61 6d65 203d       modelname =
-0004c8e0: 206f 732e 7061 7468 2e62 6173 656e 616d   os.path.basenam
-0004c8f0: 6528 6d6f 6465 6c2e 6669 6c65 6e61 6d65  e(model.filename
-0004c900: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0004c910: 2020 2020 2020 2020 2020 2020 2020 7375                su
-0004c920: 7266 6163 6566 6e20 3d20 277b 7d5f 7b7d  rfacefn = '{}_{}
-0004c930: 272e 666f 726d 6174 286d 6f64 656c 6e61  '.format(modelna
-0004c940: 6d65 2c20 7365 6c66 2e6d 6170 6e61 6d65  me, self.mapname
-0004c950: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0004c960: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
-0004c970: 6465 6c6d 6170 7375 7266 6163 6520 3d20  delmapsurface = 
-0004c980: 6469 6374 2829 0a20 2020 2020 2020 2020  dict().         
-0004c990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c9a0: 2020 2066 6f72 206a 7065 6720 696e 206a     for jpeg in j
-0004c9b0: 7065 6773 3a0a 2020 2020 2020 2020 2020  pegs:.          
-0004c9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c9d0: 2020 2020 2020 6966 206d 6f64 656c 6e61        if modelna
-0004c9e0: 6d65 2069 6e20 6a70 6567 2061 6e64 2027  me in jpeg and '
-0004c9f0: 7873 6d6f 6327 2069 6e20 6a70 6567 3a0a  xsmoc' in jpeg:.
-0004ca00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ca10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ca20: 2020 2020 6d6f 6465 6c6d 6170 7375 7266      modelmapsurf
-0004ca30: 6163 655b 2778 275d 203d 2073 7472 2873  ace['x'] = str(s
-0004ca40: 7572 6661 6365 666e 2920 2b20 275f 7363  urfacefn) + '_sc
-0004ca50: 616c 6564 5f78 736d 6f63 7375 7266 6163  aled_xsmocsurfac
-0004ca60: 652e 6a70 6567 270a 2020 2020 2020 2020  e.jpeg'.        
-0004ca70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ca80: 2020 2020 2020 2020 6966 206d 6f64 656c          if model
-0004ca90: 6e61 6d65 2069 6e20 6a70 6567 2061 6e64  name in jpeg and
-0004caa0: 2027 7973 6d6f 6327 2069 6e20 6a70 6567   'ysmoc' in jpeg
-0004cab0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0004cac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004cad0: 2020 2020 2020 6d6f 6465 6c6d 6170 7375        modelmapsu
-0004cae0: 7266 6163 655b 2779 275d 203d 2073 7472  rface['y'] = str
-0004caf0: 2873 7572 6661 6365 666e 2920 2b20 275f  (surfacefn) + '_
-0004cb00: 7363 616c 6564 5f79 736d 6f63 7375 7266  scaled_ysmocsurf
-0004cb10: 6163 652e 6a70 6567 270a 2020 2020 2020  ace.jpeg'.      
-0004cb20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004cb30: 2020 2020 2020 2020 2020 6966 206d 6f64            if mod
-0004cb40: 656c 6e61 6d65 2069 6e20 6a70 6567 2061  elname in jpeg a
-0004cb50: 6e64 2027 7a73 6d6f 6327 2069 6e20 6a70  nd 'zsmoc' in jp
-0004cb60: 6567 3a0a 2020 2020 2020 2020 2020 2020  eg:.            
-0004cb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004cb80: 2020 2020 2020 2020 6d6f 6465 6c6d 6170          modelmap
-0004cb90: 7375 7266 6163 655b 277a 275d 203d 2073  surface['z'] = s
-0004cba0: 7472 2873 7572 6661 6365 666e 2920 2b20  tr(surfacefn) + 
-0004cbb0: 275f 7363 616c 6564 5f7a 736d 6f63 7375  '_scaled_zsmocsu
-0004cbc0: 7266 6163 652e 6a70 6567 270a 2020 2020  rface.jpeg'.    
-0004cbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004cbe0: 2020 2020 2020 2020 6966 2065 7272 6c69          if errli
-0004cbf0: 7374 3a0a 2020 2020 2020 2020 2020 2020  st:.            
-0004cc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004cc10: 2020 2020 6d6f 6465 6c6d 6170 7375 7266      modelmapsurf
-0004cc20: 6163 655b 2765 7272 275d 203d 207b 276d  ace['err'] = {'m
-0004cc30: 6f64 656c 5f66 6974 5f65 7272 273a 2065  odel_fit_err': e
-0004cc40: 7272 6c69 7374 7d0a 2020 2020 2020 2020  rrlist}.        
-0004cc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004cc60: 2020 2020 6d6f 6465 6c73 7572 665b 6d6f      modelsurf[mo
-0004cc70: 6465 6c6e 616d 655d 203d 206d 6f64 656c  delname] = model
-0004cc80: 6d61 7073 7572 6661 6365 0a20 2020 2020  mapsurface.     
+0004c0a0: 2020 2020 2020 2020 7265 6c61 7469 7665          relative
+0004c0b0: 5f74 6f77 686f 6c65 2c20 7265 6c61 7469  _towhole, relati
+0004c0c0: 7665 5f74 6f74 776f 203d 2062 6172 286e  ve_totwo = bar(n
+0004c0d0: 6577 5f64 6963 742c 2027 6169 272c 2073  ew_dict, 'ai', s
+0004c0e0: 656c 662e 776f 726b 6469 722c 2073 636f  elf.workdir, sco
+0004c0f0: 7265 5f64 6972 2c20 706c 6f74 5f6e 616d  re_dir, plot_nam
+0004c100: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+0004c110: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0004c120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c130: 2020 2020 2072 656c 6174 6976 655f 746f       relative_to
+0004c140: 7768 6f6c 652c 2072 656c 6174 6976 655f  whole, relative_
+0004c150: 746f 7477 6f20 3d20 6261 7228 6e65 775f  totwo = bar(new_
+0004c160: 6469 6374 2c20 7363 6f72 655f 7479 7065  dict, score_type
+0004c170: 2c20 7365 6c66 2e77 6f72 6b64 6972 2c20  , self.workdir, 
+0004c180: 7363 6f72 655f 6469 722c 2070 6c6f 745f  score_dir, plot_
+0004c190: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
+0004c1a0: 2020 2020 2020 2020 2020 736d 6f63 5f62            smoc_b
+0004c1b0: 6172 203d 207b 2777 686f 6c65 273a 2072  ar = {'whole': r
+0004c1c0: 656c 6174 6976 655f 746f 7768 6f6c 652c  elative_towhole,
+0004c1d0: 2027 7265 6c61 7469 7665 273a 2072 656c   'relative': rel
+0004c1e0: 6174 6976 655f 746f 7477 6f7d 0a20 2020  ative_totwo}.   
+0004c1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c200: 2069 6620 7363 6f72 655f 7479 7065 203d   if score_type =
+0004c210: 3d20 2761 746f 6d5f 696e 636c 7573 696f  = 'atom_inclusio
+0004c220: 6e27 3a0a 2020 2020 2020 2020 2020 2020  n':.            
+0004c230: 2020 2020 2020 2020 2020 2020 6461 7461              data
+0004c240: 5b73 7472 2869 295d 203d 207b 276e 616d  [str(i)] = {'nam
+0004c250: 6527 3a20 6d6f 6465 6c5f 6e61 6d65 7d0a  e': model_name}.
+0004c260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c270: 2020 2020 2020 2020 6461 7461 5b73 7472          data[str
+0004c280: 2869 295d 203d 207b 2761 695f 6261 7227  (i)] = {'ai_bar'
+0004c290: 3a20 736d 6f63 5f62 6172 7d0a 2020 2020  : smoc_bar}.    
+0004c2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c2b0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0004c2c0: 2020 2020 2020 2020 2020 2020 2020 6461                da
+0004c2d0: 7461 5b73 7472 2869 295d 203d 207b 276e  ta[str(i)] = {'n
+0004c2e0: 616d 6527 3a20 6d6f 6465 6c5f 6e61 6d65  ame': model_name
+0004c2f0: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+0004c300: 2020 2020 2020 2020 2020 6461 7461 5b73            data[s
+0004c310: 7472 2869 295d 203d 207b 2764 6174 6127  tr(i)] = {'data'
+0004c320: 3a20 7b66 277b 7363 6f72 655f 7479 7065  : {f'{score_type
+0004c330: 7d5f 6261 7227 3a20 736d 6f63 5f62 6172  }_bar': smoc_bar
+0004c340: 7d7d 0a20 2020 2020 2020 2020 2020 2020  }}.             
+0004c350: 2020 2069 6620 7363 6f72 655f 7479 7065     if score_type
+0004c360: 203d 3d20 2761 746f 6d5f 696e 636c 7573   == 'atom_inclus
+0004c370: 696f 6e27 3a0a 2020 2020 2020 2020 2020  ion':.          
+0004c380: 2020 2020 2020 2020 2020 6669 6e61 6c5f            final_
+0004c390: 6469 6374 5b27 6174 6f6d 5f69 6e63 6c75  dict['atom_inclu
+0004c3a0: 7369 6f6e 5f62 795f 6c65 7665 6c27 5d20  sion_by_level'] 
+0004c3b0: 3d20 6461 7461 0a20 2020 2020 2020 2020  = data.         
+0004c3c0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0004c3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c3e0: 2066 696e 616c 5f64 6963 745b 7363 6f72   final_dict[scor
+0004c3f0: 655f 7479 7065 5d20 3d20 6461 7461 0a0a  e_type] = data..
+0004c400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c410: 6966 2073 636f 7265 5f74 7970 6520 3d3d  if score_type ==
+0004c420: 2027 6174 6f6d 5f69 6e63 6c75 7369 6f6e   'atom_inclusion
+0004c430: 273a 0a20 2020 2020 2020 2020 2020 2020  ':.             
+0004c440: 2020 2020 2020 2062 6172 5f6a 736f 6e20         bar_json 
+0004c450: 3d20 277b 7d2f 7b7d 5f61 6962 6172 2e6a  = '{}/{}_aibar.j
+0004c460: 736f 6e27 2e66 6f72 6d61 7428 7365 6c66  son'.format(self
+0004c470: 2e77 6f72 6b64 6972 2c20 7365 6c66 2e6d  .workdir, self.m
+0004c480: 6170 6e61 6d65 290a 2020 2020 2020 2020  apname).        
+0004c490: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0004c4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c4b0: 2020 6261 725f 6a73 6f6e 203d 2027 7b7d    bar_json = '{}
+0004c4c0: 2f7b 7d5f 7b7d 6261 722e 6a73 6f6e 272e  /{}_{}bar.json'.
+0004c4d0: 666f 726d 6174 2873 656c 662e 776f 726b  format(self.work
+0004c4e0: 6469 722c 2073 656c 662e 6d61 706e 616d  dir, self.mapnam
+0004c4f0: 652c 2073 636f 7265 5f74 7970 6529 0a20  e, score_type). 
+0004c500: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0004c510: 6620 6669 6e61 6c5f 6469 6374 3a0a 2020  f final_dict:.  
+0004c520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c530: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+0004c540: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+0004c550: 6974 6820 636f 6465 6373 2e6f 7065 6e28  ith codecs.open(
+0004c560: 6261 725f 6a73 6f6e 2c20 2777 272c 2065  bar_json, 'w', e
+0004c570: 6e63 6f64 696e 673d 2775 7466 2d38 2729  ncoding='utf-8')
+0004c580: 2061 7320 663a 0a20 2020 2020 2020 2020   as f:.         
+0004c590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c5a0: 2020 206a 736f 6e2e 6475 6d70 2866 696e     json.dump(fin
+0004c5b0: 616c 5f64 6963 742c 2066 290a 0a20 2020  al_dict, f)..   
+0004c5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c5d0: 2065 7863 6570 743a 0a20 2020 2020 2020   except:.       
+0004c5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c5f0: 2073 7973 2e73 7464 6572 722e 7772 6974   sys.stderr.writ
+0004c600: 6528 2753 6176 696e 6720 746f 2053 4d4f  e('Saving to SMO
+0004c610: 4320 6a73 6f6e 2065 7272 6f72 3a20 7b7d  C json error: {}
+0004c620: 2e5c 6e27 2e66 6f72 6d61 7428 7379 732e  .\n'.format(sys.
+0004c630: 6578 635f 696e 666f 2829 5b31 5d29 290a  exc_info()[1])).
+0004c640: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004c650: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0004c660: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0004c670: 2753 4d4f 4320 7761 7320 6e6f 7420 636f  'SMOC was not co
+0004c680: 6c6c 6563 7465 642c 2070 6c65 6173 6520  llected, please 
+0004c690: 6368 6563 6b21 2729 0a20 2020 2020 2020  check!').       
+0004c6a0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0004c6b0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0004c6c0: 2866 277b 7363 6f72 655f 7479 7065 7d20  (f'{score_type} 
+0004c6d0: 4a53 4f4e 2065 7869 7374 2062 7574 2063  JSON exist but c
+0004c6e0: 6f72 7265 7370 6f6e 6469 6e67 2073 636f  orresponding sco
+0004c6f0: 7265 2064 6f65 7320 6e6f 7420 6578 6973  re does not exis
+0004c700: 742e 2043 6865 636b 2074 6865 2065 7272  t. Check the err
+0004c710: 6f72 2e27 290a 2020 2020 2020 2020 656c  or.').        el
+0004c720: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0004c730: 7072 696e 7428 2753 4d4f 4320 4a53 4f4e  print('SMOC JSON
+0004c740: 2072 6573 756c 7473 2064 6f65 7320 6e6f   results does no
+0004c750: 7420 6578 6973 742e 2043 6865 636b 2053  t exist. Check S
+0004c760: 4d4f 4320 7275 6e2e 2729 0a0a 2020 2020  MOC run.')..    
+0004c770: 6465 6620 736d 6f63 5f76 6965 7728 7365  def smoc_view(se
+0004c780: 6c66 2c20 6368 696d 6572 6161 7070 293a  lf, chimeraapp):
+0004c790: 0a20 2020 2020 2020 2022 2222 0a0a 2020  .        """..  
+0004c7a0: 2020 2020 2020 2020 2020 582c 2059 2c20            X, Y, 
+0004c7b0: 5a20 696d 6167 6573 2077 6869 6368 206d  Z images which m
+0004c7c0: 6f64 656c 2077 6173 2063 6f6c 6f72 6564  odel was colored
+0004c7d0: 2062 7920 534d 4f43 0a0a 2020 2020 2020   by SMOC..      
+0004c7e0: 2020 3a72 6574 7572 6e3a 0a20 2020 2020    :return:.     
+0004c7f0: 2020 2022 2222 0a0a 2020 2020 2020 2020     """..        
+0004c800: 2320 7265 6164 206a 736f 6e0a 2020 2020  # read json.    
+0004c810: 2020 2020 7374 6172 7420 3d20 7469 6d65      start = time
+0004c820: 6974 2e64 6566 6175 6c74 5f74 696d 6572  it.default_timer
+0004c830: 2829 0a20 2020 2020 2020 2069 6e6a 736f  ().        injso
+0004c840: 6e20 3d20 676c 6f62 2e67 6c6f 6228 7365  n = glob.glob(se
+0004c850: 6c66 2e77 6f72 6b64 6972 202b 2027 2a5f  lf.workdir + '*_
+0004c860: 736d 6f63 2e6a 736f 6e27 290a 2020 2020  smoc.json').    
+0004c870: 2020 2020 6261 7365 6469 7220 3d20 7365      basedir = se
+0004c880: 6c66 2e77 6f72 6b64 6972 0a20 2020 2020  lf.workdir.     
+0004c890: 2020 206d 6170 6e61 6d65 203d 2073 656c     mapname = sel
+0004c8a0: 662e 6d61 706e 616d 650a 2020 2020 2020  f.mapname.      
+0004c8b0: 2020 6c6f 6343 4849 4d45 5241 203d 2063    locCHIMERA = c
+0004c8c0: 6869 6d65 7261 6170 700a 2020 2020 2020  himeraapp.      
+0004c8d0: 2020 6269 6e64 6973 706c 6179 203d 206f    bindisplay = o
+0004c8e0: 732e 6765 7465 6e76 2827 4449 5350 4c41  s.getenv('DISPLA
+0004c8f0: 5927 290a 2020 2020 2020 2020 6572 726c  Y').        errl
+0004c900: 6973 7420 3d20 5b5d 0a0a 2020 2020 2020  ist = []..      
+0004c910: 2020 6675 6c69 6e6a 736f 6e20 3d20 696e    fulinjson = in
+0004c920: 6a73 6f6e 5b30 5d20 6966 2069 6e6a 736f  json[0] if injso
+0004c930: 6e20 656c 7365 204e 6f6e 650a 2020 2020  n else None.    
+0004c940: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0004c950: 2020 2020 2069 6620 6675 6c69 6e6a 736f       if fulinjso
+0004c960: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
+0004c970: 2020 2077 6974 6820 6f70 656e 2866 756c     with open(ful
+0004c980: 696e 6a73 6f6e 2c20 2772 2729 2061 7320  injson, 'r') as 
+0004c990: 663a 0a20 2020 2020 2020 2020 2020 2020  f:.             
+0004c9a0: 2020 2020 2020 2061 7267 7320 3d20 6a73         args = js
+0004c9b0: 6f6e 2e6c 6f61 6428 6629 0a20 2020 2020  on.load(f).     
+0004c9c0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0004c9d0: 2020 2020 2020 2020 2020 2020 2061 7267               arg
+0004c9e0: 7320 3d20 4e6f 6e65 0a20 2020 2020 2020  s = None.       
+0004c9f0: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
+0004ca00: 5468 6572 6520 6973 206e 6f20 534d 4f43  There is no SMOC
+0004ca10: 206a 736f 6e20 6669 6c65 2e27 290a 2020   json file.').  
+0004ca20: 2020 2020 2020 6578 6365 7074 2054 7970        except Typ
+0004ca30: 6545 7272 6f72 3a0a 2020 2020 2020 2020  eError:.        
+0004ca40: 2020 2020 6572 7220 3d20 274f 7065 6e20      err = 'Open 
+0004ca50: 534d 4f43 204a 534f 4e20 6572 726f 723a  SMOC JSON error:
+0004ca60: 207b 7d2e 272e 666f 726d 6174 2873 7973   {}.'.format(sys
+0004ca70: 2e65 7863 5f69 6e66 6f28 295b 315d 290a  .exc_info()[1]).
+0004ca80: 2020 2020 2020 2020 2020 2020 6572 726c              errl
+0004ca90: 6973 742e 6170 7065 6e64 2865 7272 290a  ist.append(err).
+0004caa0: 2020 2020 2020 2020 2020 2020 7379 732e              sys.
+0004cab0: 7374 6465 7272 2e77 7269 7465 2865 7272  stderr.write(err
+0004cac0: 202b 2027 5c6e 2729 0a20 2020 2020 2020   + '\n').       
+0004cad0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0004cae0: 2020 2069 6620 6172 6773 2069 7320 6e6f     if args is no
+0004caf0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+0004cb00: 2020 2020 2020 2020 6d6f 6465 6c73 203d          models =
+0004cb10: 2061 7267 735b 2773 6d6f 6327 5d0a 2020   args['smoc'].  
+0004cb20: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+0004cb30: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+0004cb40: 2020 2020 2020 2064 656c 206d 6f64 656c         del model
+0004cb50: 735b 2765 7272 275d 0a20 2020 2020 2020  s['err'].       
+0004cb60: 2020 2020 2020 2020 2065 7863 6570 743a           except:
+0004cb70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004cb80: 2020 2020 2070 7269 6e74 2827 534d 4f43       print('SMOC
+0004cb90: 206a 736f 6e20 7265 7375 6c74 2069 7320   json result is 
+0004cba0: 636f 7272 6563 7427 290a 0a20 2020 2020  correct')..     
+0004cbb0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0004cbc0: 2827 5468 6572 6520 6973 2f61 7265 2025  ('There is/are %
+0004cbd0: 7320 6d6f 6465 6c28 7329 2e27 2025 206c  s model(s).' % l
+0004cbe0: 656e 286d 6f64 656c 7329 290a 2020 2020  en(models)).    
+0004cbf0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0004cc00: 286b 6579 2c20 7661 6c75 6529 2069 6e20  (key, value) in 
+0004cc10: 6974 6572 6974 656d 7328 6d6f 6465 6c73  iteritems(models
+0004cc20: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0004cc30: 2020 2020 2020 2023 2066 6f72 2028 6b65         # for (ke
+0004cc40: 7932 2c20 7661 6c75 6532 2920 696e 2069  y2, value2) in i
+0004cc50: 7465 7269 7465 6d73 2876 616c 7565 293a  teritems(value):
+0004cc60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004cc70: 2020 2020 2069 6620 7479 7065 2876 616c       if type(val
+0004cc80: 7565 2920 6973 2066 6c6f 6174 3a0a 2020  ue) is float:.  
 0004cc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004cca0: 2020 2066 696e 616c 6d6d 6469 6374 5b27     finalmmdict['
-0004ccb0: 736d 6f63 7363 6f72 655f 7375 7266 6163  smocscore_surfac
-0004ccc0: 6527 5d20 3d20 6d6f 6465 6c73 7572 660a  e'] = modelsurf.
-0004ccd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004cce0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-0004ccf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004cd00: 2020 2020 2020 2020 2020 7769 7468 2063            with c
-0004cd10: 6f64 6563 732e 6f70 656e 2873 656c 662e  odecs.open(self.
-0004cd20: 776f 726b 6469 7220 2b20 7365 6c66 2e6d  workdir + self.m
-0004cd30: 6170 6e61 6d65 202b 2027 5f73 6d6f 6376  apname + '_smocv
-0004cd40: 6965 772e 6a73 6f6e 272c 2027 7727 2c0a  iew.json', 'w',.
-0004cd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004cd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004cd70: 2020 2020 2020 2020 2020 2020 2065 6e63               enc
-0004cd80: 6f64 696e 673d 2775 7466 2d38 2729 2061  oding='utf-8') a
-0004cd90: 7320 663a 0a20 2020 2020 2020 2020 2020  s f:.           
-0004cda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004cdb0: 2020 2020 206a 736f 6e2e 6475 6d70 2866       json.dump(f
-0004cdc0: 696e 616c 6d6d 6469 6374 2c20 6629 0a20  inalmmdict, f). 
-0004cdd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004cde0: 2020 2020 2020 2065 7863 6570 743a 0a20         except:. 
-0004cdf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ce00: 2020 2020 2020 2020 2020 2073 7973 2e73             sys.s
-0004ce10: 7464 6572 722e 7772 6974 6528 0a20 2020  tderr.write(.   
-0004ce20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ce30: 2020 2020 2020 2020 2020 2020 2027 5361               'Sa
-0004ce40: 7669 6e67 2053 4d4f 4320 7669 6577 2074  ving SMOC view t
-0004ce50: 6f20 4a53 4f4e 2065 7272 6f72 3a20 7b7d  o JSON error: {}
-0004ce60: 2e5c 6e27 2e66 6f72 6d61 7428 7379 732e  .\n'.format(sys.
-0004ce70: 6578 635f 696e 666f 2829 5b31 5d29 290a  exc_info()[1])).
-0004ce80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004ce90: 2065 6e64 203d 2074 696d 6569 742e 6465   end = timeit.de
-0004cea0: 6661 756c 745f 7469 6d65 7228 290a 2020  fault_timer().  
-0004ceb0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-0004cec0: 696e 7428 2753 4d4f 4320 7375 7266 6163  int('SMOC surfac
-0004ced0: 6520 7469 6d65 3a20 2573 2720 2520 2865  e time: %s' % (e
-0004cee0: 6e64 202d 2073 7461 7274 2929 0a20 2020  nd - start)).   
-0004cef0: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-0004cf00: 6e74 2827 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  nt('------------
-0004cf10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0004cf20: 2d2d 2d2d 2d2d 2d2d 2729 0a0a 2020 2020  --------')..    
-0004cf30: 6465 6620 736d 6f63 5f73 7572 6661 6365  def smoc_surface
-0004cf40: 2873 656c 6629 3a0a 0a20 2020 2020 2020  (self):..       
-0004cf50: 2023 2073 656c 662e 7265 6e61 6d65 7166   # self.renameqf
-0004cf60: 696c 6573 2829 0a20 2020 2020 2020 2074  iles().        t
-0004cf70: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-0004cf80: 7674 6b70 6163 6b2c 2063 6869 6d65 7261  vtkpack, chimera
-0004cf90: 6170 7020 3d20 7365 6c66 2e73 7572 6661  app = self.surfa
-0004cfa0: 6365 5f65 6e76 6368 6563 6b28 290a 2020  ce_envcheck().  
-0004cfb0: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
-0004cfc0: 6d6f 635f 7669 6577 2863 6869 6d65 7261  moc_view(chimera
-0004cfd0: 6170 7029 0a20 2020 2020 2020 2065 7863  app).        exc
-0004cfe0: 6570 743a 0a20 2020 2020 2020 2020 2020  ept:.           
-0004cff0: 2065 7272 203d 2027 534d 4f43 2073 7572   err = 'SMOC sur
-0004d000: 6661 6365 2076 6965 7720 6661 696c 6564  face view failed
-0004d010: 3a20 7b7d 272e 666f 726d 6174 2873 7973  : {}'.format(sys
-0004d020: 2e65 7863 5f69 6e66 6f28 295b 315d 290a  .exc_info()[1]).
-0004d030: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0004d040: 7428 7472 6163 6562 6163 6b2e 666f 726d  t(traceback.form
-0004d050: 6174 5f65 7863 2829 290a 2020 2020 2020  at_exc()).      
-0004d060: 2020 2020 2020 7379 732e 7374 6465 7272        sys.stderr
-0004d070: 2e77 7269 7465 2865 7272 202b 2027 5c6e  .write(err + '\n
-0004d080: 2729 0a0a 0a20 2020 2064 6566 2063 6363  ')...    def ccc
-0004d090: 5f62 6172 2873 656c 6629 3a0a 0a0a 2020  _bar(self):...  
-0004d0a0: 2020 2020 2020 6966 206e 6f74 2073 656c        if not sel
-0004d0b0: 662e 6f6e 6c79 6261 723a 0a20 2020 2020  f.onlybar:.     
-0004d0c0: 2020 2020 2020 2073 656c 662e 7068 656e         self.phen
-0004d0d0: 6978 5f72 6573 6363 6328 290a 2020 2020  ix_resccc().    
-0004d0e0: 2020 2020 7365 6c66 2e67 6574 5f62 6172      self.get_bar
-0004d0f0: 2873 636f 7265 5f74 7970 653d 2763 6363  (score_type='ccc
-0004d100: 2729 0a0a 0a20 2020 2064 6566 2070 6865  ')...    def phe
-0004d110: 6e69 785f 7265 7363 6363 2873 656c 6629  nix_resccc(self)
-0004d120: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-0004d130: 2020 2020 2020 2020 2020 5275 6e20 5068            Run Ph
-0004d140: 656e 6978 2072 6573 6964 7565 2d77 6973  enix residue-wis
-0004d150: 6520 4343 4320 6361 6c63 7561 7469 6f6e  e CCC calcuation
-0004d160: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-0004d170: 3a0a 2020 2020 2020 2020 2222 220a 0a20  :.        """.. 
-0004d180: 2020 2020 2020 2069 6620 7365 6c66 2e70         if self.p
-0004d190: 6c61 7466 6f72 6d20 3d3d 2027 656d 6462  latform == 'emdb
-0004d1a0: 2720 616e 6420 7365 6c66 2e6d 6574 2021  ' and self.met !
-0004d1b0: 3d20 2774 6f6d 6f27 3a0a 2020 2020 2020  = 'tomo':.      
-0004d1c0: 2020 2020 2020 7374 6172 7420 3d20 7469        start = ti
-0004d1d0: 6d65 6974 2e64 6566 6175 6c74 5f74 696d  meit.default_tim
-0004d1e0: 6572 2829 0a20 2020 2020 2020 2020 2020  er().           
-0004d1f0: 2065 7272 6c69 7374 203d 205b 5d0a 2020   errlist = [].  
-0004d200: 2020 2020 2020 2020 2020 7265 7375 6c74            result
-0004d210: 5f64 6963 7420 3d20 7b7d 0a20 2020 2020  _dict = {}.     
-0004d220: 2020 2020 2020 2023 2069 6620 7374 7275         # if stru
-0004d230: 6465 6c61 7070 2061 6e64 2073 656c 662e  delapp and self.
-0004d240: 6d6f 6465 6c73 3a0a 2020 2020 2020 2020  models:.        
-0004d250: 2020 2020 6966 2073 656c 662e 6d6f 6465      if self.mode
-0004d260: 6c73 3a0a 2020 2020 2020 2020 2020 2020  ls:.            
-0004d270: 2020 2020 6e75 6d6d 6f64 656c 7320 3d20      nummodels = 
-0004d280: 300a 2020 2020 2020 2020 2020 2020 2020  0.              
-0004d290: 2020 616c 6c72 6573 756c 7473 203d 207b    allresults = {
-0004d2a0: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-0004d2b0: 2020 666f 7220 6d6f 6465 6c20 696e 2073    for model in s
-0004d2c0: 656c 662e 6d6f 6465 6c73 3a0a 2020 2020  elf.models:.    
-0004d2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004d2e0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-0004d2f0: 2020 2020 2020 2020 2020 2020 2066 756c               ful
-0004d300: 6c5f 6d6f 6465 6c20 3d20 277b 7d7b 7d27  l_model = '{}{}'
-0004d310: 2e66 6f72 6d61 7428 7365 6c66 2e77 6f72  .format(self.wor
-0004d320: 6b64 6972 2c20 6f73 2e70 6174 682e 6261  kdir, os.path.ba
-0004d330: 7365 6e61 6d65 286d 6f64 656c 2e66 696c  sename(model.fil
-0004d340: 656e 616d 6529 290a 2020 2020 2020 2020  ename)).        
-0004d350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004d360: 6675 6c6c 5f6d 6170 203d 2027 7b7d 7b7d  full_map = '{}{}
-0004d370: 272e 666f 726d 6174 2873 656c 662e 776f  '.format(self.wo
-0004d380: 726b 6469 722c 2073 656c 662e 6d61 706e  rkdir, self.mapn
-0004d390: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
-0004d3a0: 2020 2020 2020 2020 2020 2020 206f 7574               out
-0004d3b0: 5f70 6174 6820 3d20 277b 7d5f 7068 656e  _path = '{}_phen
-0004d3c0: 6978 272e 666f 726d 6174 2866 756c 6c5f  ix'.format(full_
-0004d3d0: 6d6f 6465 6c29 0a0a 2020 2020 2020 2020  model)..        
+0004cca0: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
+0004ccb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ccc0: 2020 206b 6579 6c69 7374 203d 206c 6973     keylist = lis
+0004ccd0: 7428 7661 6c75 6529 0a20 2020 2020 2020  t(value).       
+0004cce0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0004ccf0: 206b 6579 2069 6e20 6b65 796c 6973 743a   key in keylist:
+0004cd00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004cd10: 2020 2020 2020 2020 2069 6620 6b65 7920           if key 
+0004cd20: 213d 2027 6e61 6d65 273a 0a20 2020 2020  != 'name':.     
+0004cd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004cd40: 2020 2020 2020 2063 6f6c 6f72 7320 3d20         colors = 
+0004cd50: 7661 6c75 655b 6b65 795d 5b27 636f 6c6f  value[key]['colo
+0004cd60: 7227 5d0a 2020 2020 2020 2020 2020 2020  r'].            
+0004cd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004cd80: 7265 7369 6475 6573 203d 2076 616c 7565  residues = value
+0004cd90: 5b6b 6579 5d5b 2772 6573 6964 7565 275d  [key]['residue']
+0004cda0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004cdb0: 2020 2020 2020 2020 2020 2020 2073 6d6f               smo
+0004cdc0: 6373 203d 2076 616c 7565 5b6b 6579 5d5b  cs = value[key][
+0004cdd0: 2773 6d6f 635f 7363 6f72 6573 275d 0a20  'smoc_scores']. 
+0004cde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004cdf0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0004ce00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ce10: 2020 2020 2020 2020 206d 6f64 656c 6e61           modelna
+0004ce20: 6d65 203d 2076 616c 7565 5b6b 6579 5d0a  me = value[key].
+0004ce30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ce40: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
+0004ce50: 6c20 3d20 7365 6c66 2e77 6f72 6b64 6972  l = self.workdir
+0004ce60: 202b 206d 6f64 656c 6e61 6d65 0a20 2020   + modelname.   
+0004ce70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ce80: 2020 2020 2020 2020 2063 6869 6d65 7261           chimera
+0004ce90: 666e 616d 6520 3d20 277b 7d5f 7b7d 5f73  fname = '{}_{}_s
+0004cea0: 6d6f 635f 6368 696d 6572 612e 6378 6327  moc_chimera.cxc'
+0004ceb0: 2e66 6f72 6d61 7428 6d6f 6465 6c6e 616d  .format(modelnam
+0004cec0: 652c 206d 6170 6e61 6d65 290a 2020 2020  e, mapname).    
+0004ced0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004cee0: 2020 2020 2020 2020 7375 7266 6163 6566          surfacef
+0004cef0: 6e20 3d20 277b 7d7b 7d5f 7b7d 272e 666f  n = '{}{}_{}'.fo
+0004cf00: 726d 6174 2862 6173 6564 6972 2c20 6d6f  rmat(basedir, mo
+0004cf10: 6465 6c6e 616d 652c 206d 6170 6e61 6d65  delname, mapname
+0004cf20: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0004cf30: 2020 2020 2020 2020 2020 2020 2020 6368                ch
+0004cf40: 696d 6572 6163 6d64 203d 2063 6869 6d65  imeracmd = chime
+0004cf50: 7261 666e 616d 650a 2020 2020 2020 2020  rafname.        
+0004cf60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004cf70: 2020 2020 2320 7064 626d 6f64 656c 6e61      # pdbmodelna
+0004cf80: 6d65 203d 2027 7b7d 7b7d 5f5f 515f 5f7b  me = '{}{}__Q__{
+0004cf90: 7d2e 7064 6227 2e66 6f72 6d61 7428 6261  }.pdb'.format(ba
+0004cfa0: 7365 6469 722c 206d 6f64 656c 6e61 6d65  sedir, modelname
+0004cfb0: 5b3a 2d34 5d2c 206d 6170 6e61 6d65 5b3a  [:-4], mapname[:
+0004cfc0: 2d34 5d29 0a20 2020 2020 2020 2020 2020  -4]).           
+0004cfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004cfe0: 2070 6462 6d6f 6465 6c6e 616d 6520 3d20   pdbmodelname = 
+0004cff0: 277b 7d7b 7d27 2e66 6f72 6d61 7428 6261  '{}{}'.format(ba
+0004d000: 7365 6469 722c 206d 6f64 656c 6e61 6d65  sedir, modelname
+0004d010: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+0004d020: 2020 2020 2020 2077 6974 6820 6f70 656e         with open
+0004d030: 2873 656c 662e 776f 726b 6469 7220 2b20  (self.workdir + 
+0004d040: 6368 696d 6572 6163 6d64 2c20 2777 2729  chimeracmd, 'w')
+0004d050: 2061 7320 6670 3a0a 2020 2020 2020 2020   as fp:.        
+0004d060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004d070: 6670 2e77 7269 7465 2822 6f70 656e 2022  fp.write("open "
+0004d080: 202b 2073 7472 2870 6462 6d6f 6465 6c6e   + str(pdbmodeln
+0004d090: 616d 6529 202b 2022 2066 6f72 6d61 7420  ame) + " format 
+0004d0a0: 6d6d 6369 6622 202b 2027 5c6e 2729 0a20  mmcif" + '\n'). 
+0004d0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004d0c0: 2020 2020 2020 2023 2066 702e 7772 6974         # fp.writ
+0004d0d0: 6528 226f 7065 6e20 2220 2b20 7374 7228  e("open " + str(
+0004d0e0: 7064 626d 6f64 656c 6e61 6d65 2920 2b20  pdbmodelname) + 
+0004d0f0: 2220 666f 726d 6174 2070 6462 2220 2b20  " format pdb" + 
+0004d100: 275c 6e27 290a 2020 2020 2020 2020 2020  '\n').          
+0004d110: 2020 2020 2020 2020 2020 2020 2020 6670                fp
+0004d120: 2e77 7269 7465 2827 7368 6f77 2073 656c  .write('show sel
+0004d130: 4174 6f6d 7320 7269 6262 6f6e 7327 202b  Atoms ribbons' +
+0004d140: 2027 5c6e 2729 0a20 2020 2020 2020 2020   '\n').         
+0004d150: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0004d160: 702e 7772 6974 6528 2768 6964 6520 7365  p.write('hide se
+0004d170: 6c41 746f 6d73 2720 2b20 275c 6e27 290a  lAtoms' + '\n').
+0004d180: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004d190: 2020 2020 2020 2020 2066 6f72 2028 636f           for (co
+0004d1a0: 6c6f 722c 2072 6573 6964 7565 2c20 736d  lor, residue, sm
+0004d1b0: 6f63 7363 6f72 6529 2069 6e20 7a69 7028  ocscore) in zip(
+0004d1c0: 636f 6c6f 7273 2c20 7265 7369 6475 6573  colors, residues
+0004d1d0: 2c20 736d 6f63 7329 3a0a 2020 2020 2020  , smocs):.      
+0004d1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004d1f0: 2020 2020 2020 6368 6169 6e2c 2072 6573        chain, res
+0004d200: 746d 7020 3d20 7265 7369 6475 652e 7370  tmp = residue.sp
+0004d210: 6c69 7428 273a 2729 0a20 2020 2020 2020  lit(':').       
+0004d220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004d230: 2020 2020 2023 204e 6f74 2073 7572 6520       # Not sure 
+0004d240: 6966 2061 6c6c 2074 6865 206c 6574 7465  if all the lette
+0004d250: 7273 2073 686f 756c 6420 6265 2072 6570  rs should be rep
+0004d260: 6c61 6365 640a 2020 2020 2020 2020 2020  laced.          
+0004d270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004d280: 2020 2320 3173 7420 7761 7920 6f66 2067    # 1st way of g
+0004d290: 6574 7469 6e67 2072 6573 5f69 640a 2020  etting res_id.  
+0004d2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004d2b0: 2020 2020 2020 2020 2020 2320 7265 735f            # res_
+0004d2c0: 6964 203d 2072 652e 7375 6228 225c 4422  id = re.sub("\D"
+0004d2d0: 2c20 2222 2c20 7265 7374 6d70 290a 2020  , "", restmp).  
+0004d2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004d2f0: 2020 2020 2020 2020 2020 2320 326e 6420            # 2nd 
+0004d300: 7761 7920 6f66 2067 6574 7469 6e67 2072  way of getting r
+0004d310: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
+0004d320: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0004d330: 6573 5f69 6420 3d20 7265 2e66 696e 6461  es_id = re.finda
+0004d340: 6c6c 2872 272d 3f5c 642b 272c 2072 6573  ll(r'-?\d+', res
+0004d350: 746d 7029 5b30 5d0a 2020 2020 2020 2020  tmp)[0].        
+0004d360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004d370: 2020 2020 6670 2e77 7269 7465 280a 2020      fp.write(.  
+0004d380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004d390: 2020 2020 2020 2020 2020 2020 2020 2763                'c
+0004d3a0: 6f6c 6f72 202f 2720 2b20 6368 6169 6e20  olor /' + chain 
+0004d3b0: 2b20 273a 2720 2b20 7265 735f 6964 202b  + ':' + res_id +
+0004d3c0: 2027 2027 202b 2063 6f6c 6f72 202b 2027   ' ' + color + '
+0004d3d0: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
 0004d3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004d3f0: 7265 7272 203d 2072 756e 5f70 6865 6e69  rerr = run_pheni
-0004d400: 7863 6328 6675 6c6c 5f6d 6f64 656c 2c20  xcc(full_model, 
-0004d410: 6675 6c6c 5f6d 6170 2c20 7365 6c66 2e72  full_map, self.r
-0004d420: 6573 6f6c 7574 696f 6e2c 206f 7574 5f70  esolution, out_p
-0004d430: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
-0004d440: 2020 2020 2020 2020 2020 2020 2065 6e64               end
-0004d450: 203d 2074 696d 6569 742e 6465 6661 756c   = timeit.defaul
-0004d460: 745f 7469 6d65 7228 290a 2020 2020 2020  t_timer().      
-0004d470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004d480: 2020 7072 696e 7428 2750 6865 6e69 7820    print('Phenix 
-0004d490: 4343 4320 7469 6d65 3a20 2573 2720 2520  CCC time: %s' % 
-0004d4a0: 2865 6e64 202d 2073 7461 7274 2929 0a20  (end - start)). 
+0004d3f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0004d400: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0004d410: 2073 6d6f 6373 636f 7265 203e 2031 2e30   smocscore > 1.0
+0004d420: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0004d430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004d440: 2020 6670 2e77 7269 7465 280a 2020 2020    fp.write(.    
+0004d450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004d460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004d470: 2773 686f 7720 2f27 202b 2063 6861 696e  'show /' + chain
+0004d480: 202b 2027 3a27 202b 2072 6573 5f69 6420   + ':' + res_id 
+0004d490: 2b20 2720 6174 6f6d 7327 202b 2027 5c6e  + ' atoms' + '\n
+0004d4a0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
 0004d4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004d4c0: 2020 2020 2020 2063 636c 6f67 203d 2027         cclog = '
-0004d4d0: 7b7d 2f63 635f 7065 725f 7265 7369 6475  {}/cc_per_residu
-0004d4e0: 652e 6c6f 6727 2e66 6f72 6d61 7428 6f75  e.log'.format(ou
-0004d4f0: 745f 7061 7468 290a 2020 2020 2020 2020  t_path).        
+0004d4c0: 2020 2020 2020 2773 7479 6c65 202f 2720        'style /' 
+0004d4d0: 2b20 6368 6169 6e20 2b20 273a 2720 2b20  + chain + ':' + 
+0004d4e0: 7265 735f 6964 202b 2027 2073 7469 636b  res_id + ' stick
+0004d4f0: 2720 2b20 275c 6e27 0a20 2020 2020 2020  ' + '\n'.       
 0004d500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004d510: 7072 696e 7428 6363 6c6f 672c 2072 6572  print(cclog, rer
-0004d520: 7229 0a20 2020 2020 2020 2020 2020 2020  r).             
-0004d530: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-0004d540: 2827 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ('--------------
-0004d550: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0004d560: 2d2d 2d2d 2d2d 2729 0a20 2020 2020 2020  ------').       
-0004d570: 2020 2020 2020 2020 2020 2020 2065 7863               exc
-0004d580: 6570 743a 0a20 2020 2020 2020 2020 2020  ept:.           
-0004d590: 2020 2020 2020 2020 2020 2020 2065 7272               err
-0004d5a0: 203d 2027 5068 656e 6978 2043 4343 2063   = 'Phenix CCC c
-0004d5b0: 616c 6375 6c61 7469 6f6e 2065 7272 6f72  alculation error
-0004d5c0: 3a20 7b7d 2e27 2e66 6f72 6d61 7428 7379  : {}.'.format(sy
-0004d5d0: 732e 6578 635f 696e 666f 2829 5b31 5d29  s.exc_info()[1])
-0004d5e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004d5f0: 2020 2020 2020 2020 2065 7272 6c69 7374           errlist
-0004d600: 2e61 7070 656e 6428 6572 7229 0a20 2020  .append(err).   
-0004d610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004d620: 2020 2020 2073 7973 2e73 7464 6572 722e       sys.stderr.
-0004d630: 7772 6974 6528 6572 7220 2b20 275c 6e27  write(err + '\n'
-0004d640: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0004d650: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+0004d510: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0004d520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004d530: 2020 2066 702e 7772 6974 6528 0a20 2020     fp.write(.   
+0004d540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004d550: 2020 2020 2020 2020 2022 7365 7420 6267           "set bg
+0004d560: 436f 6c6f 7220 7768 6974 6522 202b 2027  Color white" + '
+0004d570: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
+0004d580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004d590: 226c 6967 6874 696e 6720 736f 6674 2220  "lighting soft" 
+0004d5a0: 2b20 275c 6e27 0a20 2020 2020 2020 2020  + '\n'.         
+0004d5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004d5c0: 2020 2022 7669 6577 2063 6f66 7220 5472     "view cofr Tr
+0004d5d0: 7565 2220 2b20 275c 6e27 0a20 2020 2020  ue" + '\n'.     
+0004d5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004d5f0: 2020 2020 2020 2022 7361 7665 2022 202b         "save " +
+0004d600: 2073 7472 2873 7572 6661 6365 666e 2920   str(surfacefn) 
+0004d610: 2b20 225f 7a73 6d6f 6373 7572 6661 6365  + "_zsmocsurface
+0004d620: 2e6a 7065 6722 202b 2022 2073 7570 6572  .jpeg" + " super
+0004d630: 7361 6d70 6c65 2033 2077 6964 7468 2031  sample 3 width 1
+0004d640: 3230 3020 6865 6967 6874 2031 3230 3022  200 height 1200"
+0004d650: 202b 2027 5c6e 270a 2020 2020 2020 2020   + '\n'.        
 0004d660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004d670: 2020 2064 6620 3d20 7265 6164 5f63 6328     df = read_cc(
-0004d680: 6363 6c6f 672c 2072 6572 7229 0a20 2020  cclog, rerr).   
+0004d670: 2020 2020 2274 7572 6e20 7820 2d39 3022      "turn x -90"
+0004d680: 202b 2027 5c6e 270a 2020 2020 2020 2020   + '\n'.        
 0004d690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004d6a0: 2020 2020 2063 6364 6963 7420 3d20 6363       ccdict = cc
-0004d6b0: 6466 5f74 6f64 6963 7428 6466 290a 0a20  df_todict(df).. 
+0004d6a0: 2020 2020 2274 7572 6e20 7920 2d39 3022      "turn y -90"
+0004d6b0: 202b 2027 5c6e 270a 2020 2020 2020 2020   + '\n'.        
 0004d6c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004d6d0: 2020 2020 2020 2061 6c6c 7265 7375 6c74         allresult
-0004d6e0: 735b 7374 7228 6e75 6d6d 6f64 656c 7329  s[str(nummodels)
-0004d6f0: 5d20 3d20 7b27 6e61 6d65 273a 206f 732e  ] = {'name': os.
-0004d700: 7061 7468 2e62 6173 656e 616d 6528 6d6f  path.basename(mo
-0004d710: 6465 6c2e 6669 6c65 6e61 6d65 292c 0a20  del.filename),. 
-0004d720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004d730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004d740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004d750: 2020 2020 2027 6461 7461 273a 2063 6364       'data': ccd
-0004d760: 6963 747d 0a0a 2020 2020 2020 2020 2020  ict}..          
-0004d770: 2020 2020 2020 2020 2020 6578 6365 7074            except
-0004d780: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0004d790: 2020 2020 2020 2020 2020 6572 7220 3d20            err = 
-0004d7a0: 2753 6176 6520 5068 656e 6978 2043 4343  'Save Phenix CCC
-0004d7b0: 2064 6174 6120 6572 726f 723a 207b 7d2e   data error: {}.
-0004d7c0: 272e 666f 726d 6174 2873 7973 2e65 7863  '.format(sys.exc
-0004d7d0: 5f69 6e66 6f28 295b 315d 290a 2020 2020  _info()[1]).    
-0004d7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004d7f0: 2020 2020 6572 726c 6973 742e 6170 7065      errlist.appe
-0004d800: 6e64 2865 7272 290a 2020 2020 2020 2020  nd(err).        
-0004d810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004d820: 7379 732e 7374 6465 7272 2e77 7269 7465  sys.stderr.write
-0004d830: 2865 7272 202b 2027 5c6e 2729 0a20 2020  (err + '\n').   
-0004d840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004d850: 206e 756d 6d6f 6465 6c73 202b 3d20 310a   nummodels += 1.
-0004d860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004d870: 2069 6620 616c 6c72 6573 756c 7473 3a0a   if allresults:.
-0004d880: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004d890: 2020 2020 7265 7375 6c74 5f64 6963 745b      result_dict[
-0004d8a0: 2763 6363 275d 203d 2061 6c6c 7265 7375  'ccc'] = allresu
-0004d8b0: 6c74 730a 0a20 2020 2020 2020 2020 2020  lts..           
-0004d8c0: 2020 2020 2069 6620 6572 726c 6973 743a       if errlist:
-0004d8d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004d8e0: 2020 2020 2072 6573 756c 745f 6469 6374       result_dict
-0004d8f0: 5b27 6572 7227 5d20 3d20 6572 726c 6973  ['err'] = errlis
-0004d900: 740a 0a20 2020 2020 2020 2020 2020 2020  t..             
-0004d910: 2020 2069 6620 6c65 6e28 7265 7375 6c74     if len(result
-0004d920: 5f64 6963 7429 203d 3d20 3120 616e 6420  _dict) == 1 and 
-0004d930: 2763 6363 2720 696e 2072 6573 756c 745f  'ccc' in result_
-0004d940: 6469 6374 3a0a 2020 2020 2020 2020 2020  dict:.          
-0004d950: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+0004d6d0: 2020 2020 2276 6965 7720 636f 6672 2054      "view cofr T
+0004d6e0: 7275 6522 202b 2027 5c6e 270a 2020 2020  rue" + '\n'.    
+0004d6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004d700: 2020 2020 2020 2020 2273 6176 6520 2220          "save " 
+0004d710: 2b20 7374 7228 7375 7266 6163 6566 6e29  + str(surfacefn)
+0004d720: 202b 2022 5f78 736d 6f63 7375 7266 6163   + "_xsmocsurfac
+0004d730: 652e 6a70 6567 2220 2b20 2220 7375 7065  e.jpeg" + " supe
+0004d740: 7273 616d 706c 6520 3320 7769 6474 6820  rsample 3 width 
+0004d750: 3132 3030 2068 6569 6768 7420 3132 3030  1200 height 1200
+0004d760: 2220 2b20 275c 6e27 0a20 2020 2020 2020  " + '\n'.       
+0004d770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004d780: 2020 2020 2022 7669 6577 206f 7269 656e       "view orien
+0004d790: 7422 202b 2027 5c6e 270a 2020 2020 2020  t" + '\n'.      
+0004d7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004d7b0: 2020 2020 2020 2274 7572 6e20 7820 3930        "turn x 90
+0004d7c0: 2220 2b20 275c 6e27 0a20 2020 2020 2020  " + '\n'.       
+0004d7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004d7e0: 2020 2020 2022 7475 726e 207a 2039 3022       "turn z 90"
+0004d7f0: 202b 2027 5c6e 270a 2020 2020 2020 2020   + '\n'.        
+0004d800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004d810: 2020 2020 2276 6965 7720 636f 6672 2054      "view cofr T
+0004d820: 7275 6522 202b 2027 5c6e 270a 2020 2020  rue" + '\n'.    
+0004d830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004d840: 2020 2020 2020 2020 2273 6176 6520 2220          "save " 
+0004d850: 2b20 7374 7228 7375 7266 6163 6566 6e29  + str(surfacefn)
+0004d860: 202b 2022 5f79 736d 6f63 7375 7266 6163   + "_ysmocsurfac
+0004d870: 652e 6a70 6567 2220 2b20 2220 7375 7065  e.jpeg" + " supe
+0004d880: 7273 616d 706c 6520 3320 7769 6474 6820  rsample 3 width 
+0004d890: 3132 3030 2068 6569 6768 7420 3132 3030  1200 height 1200
+0004d8a0: 2220 2b20 275c 6e27 0a20 2020 2020 2020  " + '\n'.       
+0004d8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004d8c0: 2020 2020 2022 636c 6f73 6520 616c 6c22       "close all"
+0004d8d0: 202b 2022 5c6e 220a 2020 2020 2020 2020   + "\n".        
+0004d8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004d8f0: 2020 2020 2265 7869 7422 0a20 2020 2020      "exit".     
+0004d900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004d910: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0004d920: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+0004d930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004d940: 2020 2020 2020 6966 206e 6f74 2062 696e        if not bin
+0004d950: 6469 7370 6c61 793a 0a20 2020 2020 2020  display:.       
 0004d960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004d970: 2020 2020 2020 2077 6974 6820 636f 6465         with code
-0004d980: 6373 2e6f 7065 6e28 7365 6c66 2e77 6f72  cs.open(self.wor
-0004d990: 6b64 6972 202b 2073 656c 662e 6d61 706e  kdir + self.mapn
-0004d9a0: 616d 6520 2b20 275f 7265 7363 6363 2e6a  ame + '_resccc.j
-0004d9b0: 736f 6e27 2c20 2777 272c 0a20 2020 2020  son', 'w',.     
-0004d9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004d970: 2020 2020 2073 7562 7072 6f63 6573 732e       subprocess.
+0004d980: 6368 6563 6b5f 6361 6c6c 286c 6f63 4348  check_call(locCH
+0004d990: 494d 4552 4120 2b20 2220 2d2d 6f66 6673  IMERA + " --offs
+0004d9a0: 6372 6565 6e20 2d2d 6e6f 6775 6920 2220  creen --nogui " 
+0004d9b0: 2b20 7365 6c66 2e77 6f72 6b64 6972 202b  + self.workdir +
+0004d9c0: 2063 6869 6d65 7261 636d 642c 0a20 2020   chimeracmd,.   
 0004d9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004d9e0: 2020 2020 656e 636f 6469 6e67 3d27 7574      encoding='ut
-0004d9f0: 662d 3827 2920 6173 2066 3a0a 2020 2020  f-8') as f:.    
-0004da00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004da10: 2020 2020 2020 2020 6a73 6f6e 2e64 756d          json.dum
-0004da20: 7028 7265 7375 6c74 5f64 6963 742c 2066  p(result_dict, f
-0004da30: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0004da40: 2020 2020 2020 6578 6365 7074 3a0a 2020        except:.  
-0004da50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004da60: 2020 2020 2020 7379 732e 7374 6465 7272        sys.stderr
-0004da70: 2e77 7269 7465 2827 5361 7669 6e67 2074  .write('Saving t
-0004da80: 6f20 4343 4320 6a73 6f6e 2065 7272 6f72  o CCC json error
-0004da90: 3a20 7b7d 2e5c 6e27 2e66 6f72 6d61 7428  : {}.\n'.format(
-0004daa0: 7379 732e 6578 635f 696e 666f 2829 5b31  sys.exc_info()[1
-0004dab0: 5d29 290a 0a20 2020 2020 2020 2020 2020  ]))..           
-0004dac0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-0004dad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004dae0: 2020 2020 2020 7365 6c66 2e63 635f 7375        self.cc_su
-0004daf0: 7266 6163 6528 290a 2020 2020 2020 2020  rface().        
-0004db00: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-0004db10: 7074 3a0a 2020 2020 2020 2020 2020 2020  pt:.            
+0004d9e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004d9f0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0004da00: 7764 3d73 656c 662e 776f 726b 6469 722c  wd=self.workdir,
+0004da10: 2073 6865 6c6c 3d54 7275 6529 0a20 2020   shell=True).   
+0004da20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004da30: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
+0004da40: 436f 6c6f 7265 6420 6d6f 6465 6c73 2062  Colored models b
+0004da50: 6173 6564 206f 6e20 534d 4f43 2077 6572  ased on SMOC wer
+0004da60: 6520 7072 6f64 7563 6564 2e27 290a 2020  e produced.').  
+0004da70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004da80: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0004da90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004daa0: 2020 2020 2020 2020 7375 6270 726f 6365          subproce
+0004dab0: 7373 2e63 6865 636b 5f63 616c 6c28 6c6f  ss.check_call(lo
+0004dac0: 6343 4849 4d45 5241 202b 2022 2022 202b  cCHIMERA + " " +
+0004dad0: 2073 656c 662e 776f 726b 6469 7220 2b20   self.workdir + 
+0004dae0: 6368 696d 6572 6163 6d64 2c20 6377 643d  chimeracmd, cwd=
+0004daf0: 7365 6c66 2e77 6f72 6b64 6972 2c0a 2020  self.workdir,.  
+0004db00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004db10: 2020 2020 2020 2020 2020 2020 2020 2020                  
 0004db20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004db30: 7379 732e 7374 6465 7272 2e77 7269 7465  sys.stderr.write
-0004db40: 2827 4343 4320 7375 7266 6163 6520 6572  ('CCC surface er
-0004db50: 726f 723a 207b 7d2e 5c6e 272e 666f 726d  ror: {}.\n'.form
-0004db60: 6174 2873 7973 2e65 7863 5f69 6e66 6f28  at(sys.exc_info(
-0004db70: 295b 315d 2929 0a20 2020 2020 2020 2020  )[1])).         
-0004db80: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0004db30: 7368 656c 6c3d 5472 7565 290a 2020 2020  shell=True).    
+0004db40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004db50: 2020 2020 2020 2020 7072 696e 7428 2743          print('C
+0004db60: 6f6c 6f72 6564 206d 6f64 656c 7320 6261  olored models ba
+0004db70: 7365 6420 6f6e 2053 4d4f 4320 7765 7265  sed on SMOC were
+0004db80: 2070 726f 6475 6365 642e 2729 0a20 2020   produced.').   
 0004db90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004dba0: 2070 7269 6e74 2827 4343 4320 7761 7320   print('CCC was 
-0004dbb0: 6e6f 7420 636f 6c6c 6563 7465 642c 2070  not collected, p
-0004dbc0: 6c65 6173 6520 6368 6563 6b20 7468 6520  lease check the 
-0004dbd0: 6572 726f 7221 2729 0a0a 2020 2020 2020  error!')..      
-0004dbe0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0004dbf0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-0004dc00: 7428 274e 6f20 6d6f 6465 6c20 6f72 2072  t('No model or r
-0004dc10: 6573 6f6c 7574 696f 6e20 6973 206e 6f74  esolution is not
-0004dc20: 2063 6f76 6572 6564 2069 6e20 7468 6520   covered in the 
-0004dc30: 6d6f 7469 6620 6c69 6272 6172 7920 283c  motif library (<
-0004dc40: 342e 30c3 8529 2027 290a 2020 2020 2020  4.0..) ').      
-0004dc50: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-0004dc60: 272d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  '---------------
-0004dc70: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0004dc80: 2d2d 2d2d 2d27 290a 0a20 2020 2020 2020  -----')..       
-0004dc90: 2072 6574 7572 6e20 4e6f 6e65 0a0a 2020   return None..  
-0004dca0: 2020 6465 6620 6363 7363 6f72 6576 6965    def ccscorevie
-0004dcb0: 7728 7365 6c66 2c20 6368 696d 6572 6161  w(self, chimeraa
-0004dcc0: 7070 293a 0a20 2020 2020 2020 2022 2222  pp):.        """
-0004dcd0: 0a0a 2020 2020 2020 2020 2020 2020 582c  ..            X,
-0004dce0: 2059 2c20 5a20 696d 6167 6573 2077 6869   Y, Z images whi
-0004dcf0: 6368 206d 6f64 656c 2077 6173 2063 6f6c  ch model was col
-0004dd00: 6f72 6564 2062 7920 7265 7369 6475 652d  ored by residue-
-0004dd10: 7769 7365 2043 4343 0a0a 2020 2020 2020  wise CCC..      
-0004dd20: 2020 3a72 6574 7572 6e3a 0a20 2020 2020    :return:.     
-0004dd30: 2020 2022 2222 0a0a 2020 2020 2020 2020     """..        
-0004dd40: 2320 7265 6164 206a 736f 6e0a 2020 2020  # read json.    
-0004dd50: 2020 2020 7374 6172 7420 3d20 7469 6d65      start = time
-0004dd60: 6974 2e64 6566 6175 6c74 5f74 696d 6572  it.default_timer
-0004dd70: 2829 0a20 2020 2020 2020 2069 6e6a 736f  ().        injso
-0004dd80: 6e20 3d20 676c 6f62 2e67 6c6f 6228 7365  n = glob.glob(se
-0004dd90: 6c66 2e77 6f72 6b64 6972 202b 2027 2a5f  lf.workdir + '*_
-0004dda0: 7265 7363 6363 2e6a 736f 6e27 290a 2020  resccc.json').  
-0004ddb0: 2020 2020 2020 6261 7365 6469 7220 3d20        basedir = 
-0004ddc0: 7365 6c66 2e77 6f72 6b64 6972 0a20 2020  self.workdir.   
-0004ddd0: 2020 2020 206d 6170 6e61 6d65 203d 2073       mapname = s
-0004dde0: 656c 662e 6d61 706e 616d 650a 2020 2020  elf.mapname.    
-0004ddf0: 2020 2020 6c6f 6343 4849 4d45 5241 203d      locCHIMERA =
-0004de00: 2063 6869 6d65 7261 6170 700a 2020 2020   chimeraapp.    
-0004de10: 2020 2020 6269 6e64 6973 706c 6179 203d      bindisplay =
-0004de20: 206f 732e 6765 7465 6e76 2827 4449 5350   os.getenv('DISP
-0004de30: 4c41 5927 290a 2020 2020 2020 2020 6572  LAY').        er
-0004de40: 726c 6973 7420 3d20 5b5d 0a0a 2020 2020  rlist = []..    
-0004de50: 2020 2020 6675 6c69 6e6a 736f 6e20 3d20      fulinjson = 
-0004de60: 696e 6a73 6f6e 5b30 5d20 6966 2069 6e6a  injson[0] if inj
-0004de70: 736f 6e20 656c 7365 204e 6f6e 650a 2020  son else None.  
-0004de80: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0004de90: 2020 2020 2020 2069 6620 6675 6c69 6e6a         if fulinj
-0004dea0: 736f 6e3a 0a20 2020 2020 2020 2020 2020  son:.           
-0004deb0: 2020 2020 2077 6974 6820 6f70 656e 2866       with open(f
-0004dec0: 756c 696e 6a73 6f6e 2c20 2772 2729 2061  ulinjson, 'r') a
-0004ded0: 7320 663a 0a20 2020 2020 2020 2020 2020  s f:.           
-0004dee0: 2020 2020 2020 2020 2061 7267 7320 3d20           args = 
-0004def0: 6a73 6f6e 2e6c 6f61 6428 6629 0a20 2020  json.load(f).   
-0004df00: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0004df10: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0004df20: 7267 7320 3d20 4e6f 6e65 0a20 2020 2020  rgs = None.     
-0004df30: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-0004df40: 2827 5468 6572 6520 6973 206e 6f20 4343  ('There is no CC
-0004df50: 4320 6a73 6f6e 2066 696c 652e 2729 0a20  C json file.'). 
-0004df60: 2020 2020 2020 2065 7863 6570 7420 5479         except Ty
-0004df70: 7065 4572 726f 723a 0a20 2020 2020 2020  peError:.       
-0004df80: 2020 2020 2065 7272 203d 2027 4f70 656e       err = 'Open
-0004df90: 2043 4343 204a 534f 4e20 6572 726f 723a   CCC JSON error:
-0004dfa0: 207b 7d2e 272e 666f 726d 6174 2873 7973   {}.'.format(sys
-0004dfb0: 2e65 7863 5f69 6e66 6f28 295b 315d 290a  .exc_info()[1]).
-0004dfc0: 2020 2020 2020 2020 2020 2020 6572 726c              errl
-0004dfd0: 6973 742e 6170 7065 6e64 2865 7272 290a  ist.append(err).
-0004dfe0: 2020 2020 2020 2020 2020 2020 7379 732e              sys.
-0004dff0: 7374 6465 7272 2e77 7269 7465 2865 7272  stderr.write(err
-0004e000: 202b 2027 5c6e 2729 0a20 2020 2020 2020   + '\n').       
-0004e010: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0004e020: 2020 2069 6620 6172 6773 2069 7320 6e6f     if args is no
-0004e030: 7420 4e6f 6e65 2061 6e64 2027 6363 6327  t None and 'ccc'
-0004e040: 2069 6e20 6172 6773 2e6b 6579 7328 293a   in args.keys():
-0004e050: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004e060: 206d 6f64 656c 7320 3d20 6172 6773 5b27   models = args['
-0004e070: 6363 6327 5d0a 2020 2020 2020 2020 2020  ccc'].          
-0004e080: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0004e090: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0004e0a0: 656c 206d 6f64 656c 735b 2765 7272 275d  el models['err']
-0004e0b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004e0c0: 2065 7863 6570 743a 0a20 2020 2020 2020   except:.       
-0004e0d0: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-0004e0e0: 6e74 2827 4343 4320 6a73 6f6e 2072 6573  nt('CCC json res
-0004e0f0: 756c 7420 6973 2063 6f72 7265 6374 2729  ult is correct')
-0004e100: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0004e110: 2020 7072 696e 7428 2754 6865 7265 2069    print('There i
-0004e120: 732f 6172 6520 2573 206d 6f64 656c 2873  s/are %s model(s
-0004e130: 292e 2720 2520 6c65 6e28 6d6f 6465 6c73  ).' % len(models
-0004e140: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-0004e150: 2020 2066 6f72 2028 6b65 792c 2076 616c     for (key, val
-0004e160: 7565 2920 696e 2069 7465 7269 7465 6d73  ue) in iteritems
-0004e170: 286d 6f64 656c 7329 3a0a 2020 2020 2020  (models):.      
-0004e180: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0004e190: 666f 7220 286b 6579 322c 2076 616c 7565  for (key2, value
-0004e1a0: 3229 2069 6e20 6974 6572 6974 656d 7328  2) in iteritems(
-0004e1b0: 7661 6c75 6529 3a0a 2020 2020 2020 2020  value):.        
-0004e1c0: 2020 2020 2020 2020 2020 2020 6966 2074              if t
-0004e1d0: 7970 6528 7661 6c75 6529 2069 7320 666c  ype(value) is fl
-0004e1e0: 6f61 743a 0a20 2020 2020 2020 2020 2020  oat:.           
-0004e1f0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-0004e200: 7469 6e75 650a 2020 2020 2020 2020 2020  tinue.          
-0004e210: 2020 2020 2020 2020 2020 6b65 796c 6973            keylis
-0004e220: 7420 3d20 6c69 7374 2876 616c 7565 290a  t = list(value).
+0004dba0: 2065 7863 6570 7420 7375 6270 726f 6365   except subproce
+0004dbb0: 7373 2e43 616c 6c65 6450 726f 6365 7373  ss.CalledProcess
+0004dbc0: 4572 726f 7220 6173 2073 7562 6572 723a  Error as suberr:
+0004dbd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004dbe0: 2020 2020 2020 2020 2065 7272 203d 2027           err = '
+0004dbf0: 5361 7669 6e67 206d 6f64 656c 207b 7d20  Saving model {} 
+0004dc00: 534d 4f43 2076 6965 7720 6572 726f 723a  SMOC view error:
+0004dc10: 207b 7d2e 272e 666f 726d 6174 286d 6f64   {}.'.format(mod
+0004dc20: 656c 6e61 6d65 2c20 7375 6265 7272 290a  elname, suberr).
+0004dc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004dc40: 2020 2020 2020 2020 6572 726c 6973 742e          errlist.
+0004dc50: 6170 7065 6e64 2865 7272 290a 2020 2020  append(err).    
+0004dc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004dc70: 2020 2020 7379 732e 7374 6465 7272 2e77      sys.stderr.w
+0004dc80: 7269 7465 2865 7272 202b 2027 5c6e 2729  rite(err + '\n')
+0004dc90: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0004dca0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+0004dcb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004dcc0: 2020 2073 656c 662e 7363 616c 655f 7375     self.scale_su
+0004dcd0: 7266 6163 6576 6965 7728 290a 2020 2020  rfaceview().    
+0004dce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004dcf0: 6578 6365 7074 3a0a 2020 2020 2020 2020  except:.        
+0004dd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004dd10: 6572 7220 3d20 2753 6361 6c69 6e67 206d  err = 'Scaling m
+0004dd20: 6f64 656c 2053 4d4f 4320 7669 6577 2065  odel SMOC view e
+0004dd30: 7272 6f72 3a20 7b7d 2e27 2e66 6f72 6d61  rror: {}.'.forma
+0004dd40: 7428 7379 732e 6578 635f 696e 666f 2829  t(sys.exc_info()
+0004dd50: 5b31 5d29 0a20 2020 2020 2020 2020 2020  [1]).           
+0004dd60: 2020 2020 2020 2020 2020 2020 2065 7272               err
+0004dd70: 6c69 7374 2e61 7070 656e 6428 6572 7229  list.append(err)
+0004dd80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004dd90: 2020 2020 2020 2020 2073 7973 2e73 7464           sys.std
+0004dda0: 6572 722e 7772 6974 6528 6572 7220 2b20  err.write(err + 
+0004ddb0: 275c 6e27 290a 0a20 2020 2020 2020 2020  '\n')..         
+0004ddc0: 2020 2020 2020 2020 2020 206a 7065 6773             jpegs
+0004ddd0: 203d 2067 6c6f 622e 676c 6f62 2873 656c   = glob.glob(sel
+0004dde0: 662e 776f 726b 6469 7220 2b20 272f 2a73  f.workdir + '/*s
+0004ddf0: 6d6f 6373 7572 6661 6365 2e6a 7065 6727  mocsurface.jpeg'
+0004de00: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0004de10: 2020 2020 2020 6d6f 6465 6c73 7572 6620        modelsurf 
+0004de20: 3d20 6469 6374 2829 0a20 2020 2020 2020  = dict().       
+0004de30: 2020 2020 2020 2020 2020 2020 2066 696e               fin
+0004de40: 616c 6d6d 6469 6374 203d 2064 6963 7428  almmdict = dict(
+0004de50: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0004de60: 2020 2020 2020 6966 2073 656c 662e 6d6f        if self.mo
+0004de70: 6465 6c73 3a0a 2020 2020 2020 2020 2020  dels:.          
+0004de80: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0004de90: 7072 696e 7420 2273 656c 662e 6d6f 6465  print "self.mode
+0004dea0: 6c73 3a25 7322 2025 2073 656c 662e 6d6f  ls:%s" % self.mo
+0004deb0: 6465 6c73 0a20 2020 2020 2020 2020 2020  dels.           
+0004dec0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0004ded0: 206d 6f64 656c 2069 6e20 7365 6c66 2e6d   model in self.m
+0004dee0: 6f64 656c 733a 0a20 2020 2020 2020 2020  odels:.         
+0004def0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004df00: 2020 206d 6f64 656c 6e61 6d65 203d 206f     modelname = o
+0004df10: 732e 7061 7468 2e62 6173 656e 616d 6528  s.path.basename(
+0004df20: 6d6f 6465 6c2e 6669 6c65 6e61 6d65 290a  model.filename).
+0004df30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004df40: 2020 2020 2020 2020 2020 2020 7375 7266              surf
+0004df50: 6163 6566 6e20 3d20 277b 7d5f 7b7d 272e  acefn = '{}_{}'.
+0004df60: 666f 726d 6174 286d 6f64 656c 6e61 6d65  format(modelname
+0004df70: 2c20 7365 6c66 2e6d 6170 6e61 6d65 290a  , self.mapname).
+0004df80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004df90: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
+0004dfa0: 6c6d 6170 7375 7266 6163 6520 3d20 6469  lmapsurface = di
+0004dfb0: 6374 2829 0a20 2020 2020 2020 2020 2020  ct().           
+0004dfc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004dfd0: 2066 6f72 206a 7065 6720 696e 206a 7065   for jpeg in jpe
+0004dfe0: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
+0004dff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004e000: 2020 2020 6966 206d 6f64 656c 6e61 6d65      if modelname
+0004e010: 2069 6e20 6a70 6567 2061 6e64 2027 7873   in jpeg and 'xs
+0004e020: 6d6f 6327 2069 6e20 6a70 6567 3a0a 2020  moc' in jpeg:.  
+0004e030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004e040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004e050: 2020 6d6f 6465 6c6d 6170 7375 7266 6163    modelmapsurfac
+0004e060: 655b 2778 275d 203d 2073 7472 2873 7572  e['x'] = str(sur
+0004e070: 6661 6365 666e 2920 2b20 275f 7363 616c  facefn) + '_scal
+0004e080: 6564 5f78 736d 6f63 7375 7266 6163 652e  ed_xsmocsurface.
+0004e090: 6a70 6567 270a 2020 2020 2020 2020 2020  jpeg'.          
+0004e0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004e0b0: 2020 2020 2020 6966 206d 6f64 656c 6e61        if modelna
+0004e0c0: 6d65 2069 6e20 6a70 6567 2061 6e64 2027  me in jpeg and '
+0004e0d0: 7973 6d6f 6327 2069 6e20 6a70 6567 3a0a  ysmoc' in jpeg:.
+0004e0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004e0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004e100: 2020 2020 6d6f 6465 6c6d 6170 7375 7266      modelmapsurf
+0004e110: 6163 655b 2779 275d 203d 2073 7472 2873  ace['y'] = str(s
+0004e120: 7572 6661 6365 666e 2920 2b20 275f 7363  urfacefn) + '_sc
+0004e130: 616c 6564 5f79 736d 6f63 7375 7266 6163  aled_ysmocsurfac
+0004e140: 652e 6a70 6567 270a 2020 2020 2020 2020  e.jpeg'.        
+0004e150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004e160: 2020 2020 2020 2020 6966 206d 6f64 656c          if model
+0004e170: 6e61 6d65 2069 6e20 6a70 6567 2061 6e64  name in jpeg and
+0004e180: 2027 7a73 6d6f 6327 2069 6e20 6a70 6567   'zsmoc' in jpeg
+0004e190: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0004e1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004e1b0: 2020 2020 2020 6d6f 6465 6c6d 6170 7375        modelmapsu
+0004e1c0: 7266 6163 655b 277a 275d 203d 2073 7472  rface['z'] = str
+0004e1d0: 2873 7572 6661 6365 666e 2920 2b20 275f  (surfacefn) + '_
+0004e1e0: 7363 616c 6564 5f7a 736d 6f63 7375 7266  scaled_zsmocsurf
+0004e1f0: 6163 652e 6a70 6567 270a 2020 2020 2020  ace.jpeg'.      
+0004e200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004e210: 2020 2020 2020 6966 2065 7272 6c69 7374        if errlist
+0004e220: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
 0004e230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004e240: 2020 2020 666f 7220 6b65 7920 696e 206b      for key in k
-0004e250: 6579 6c69 7374 3a0a 2020 2020 2020 2020  eylist:.        
-0004e260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004e270: 6966 206b 6579 2021 3d20 276e 616d 6527  if key != 'name'
-0004e280: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0004e290: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0004e2a0: 6c6f 7273 203d 2076 616c 7565 5b6b 6579  lors = value[key
-0004e2b0: 5d5b 2763 6f6c 6f72 275d 0a20 2020 2020  ]['color'].     
+0004e240: 2020 6d6f 6465 6c6d 6170 7375 7266 6163    modelmapsurfac
+0004e250: 655b 2765 7272 275d 203d 207b 276d 6f64  e['err'] = {'mod
+0004e260: 656c 5f66 6974 5f65 7272 273a 2065 7272  el_fit_err': err
+0004e270: 6c69 7374 7d0a 2020 2020 2020 2020 2020  list}.          
+0004e280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004e290: 2020 6d6f 6465 6c73 7572 665b 6d6f 6465    modelsurf[mode
+0004e2a0: 6c6e 616d 655d 203d 206d 6f64 656c 6d61  lname] = modelma
+0004e2b0: 7073 7572 6661 6365 0a20 2020 2020 2020  psurface.       
 0004e2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004e2d0: 2020 2020 2020 2072 6573 6964 7565 7320         residues 
-0004e2e0: 3d20 7661 6c75 655b 6b65 795d 5b27 7265  = value[key]['re
-0004e2f0: 7369 6475 6527 5d0a 2020 2020 2020 2020  sidue'].        
+0004e2d0: 2066 696e 616c 6d6d 6469 6374 5b27 736d   finalmmdict['sm
+0004e2e0: 6f63 7363 6f72 655f 7375 7266 6163 6527  ocscore_surface'
+0004e2f0: 5d20 3d20 6d6f 6465 6c73 7572 660a 0a20  ] = modelsurf.. 
 0004e300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004e310: 2020 2020 736d 6f63 7320 3d20 7661 6c75      smocs = valu
-0004e320: 655b 6b65 795d 5b27 6363 7363 6f72 6527  e[key]['ccscore'
-0004e330: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0004e340: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0004e350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004e360: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
-0004e370: 6c6e 616d 6520 3d20 7661 6c75 655b 6b65  lname = value[ke
-0004e380: 795d 0a20 2020 2020 2020 2020 2020 2020  y].             
-0004e390: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0004e3a0: 6f64 656c 203d 2073 656c 662e 776f 726b  odel = self.work
-0004e3b0: 6469 7220 2b20 6d6f 6465 6c6e 616d 650a  dir + modelname.
-0004e3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004e3d0: 2020 2020 2020 2020 2020 2020 6368 696d              chim
-0004e3e0: 6572 6166 6e61 6d65 203d 2027 7b7d 5f7b  erafname = '{}_{
-0004e3f0: 7d5f 6363 635f 6368 696d 6572 612e 6378  }_ccc_chimera.cx
-0004e400: 6327 2e66 6f72 6d61 7428 6d6f 6465 6c6e  c'.format(modeln
-0004e410: 616d 652c 206d 6170 6e61 6d65 290a 2020  ame, mapname).  
+0004e310: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+0004e320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004e330: 2020 2020 2020 2020 7769 7468 2063 6f64          with cod
+0004e340: 6563 732e 6f70 656e 2873 656c 662e 776f  ecs.open(self.wo
+0004e350: 726b 6469 7220 2b20 7365 6c66 2e6d 6170  rkdir + self.map
+0004e360: 6e61 6d65 202b 2027 5f73 6d6f 6376 6965  name + '_smocvie
+0004e370: 772e 6a73 6f6e 272c 2027 7727 2c0a 2020  w.json', 'w',.  
+0004e380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004e390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004e3a0: 2020 2020 2020 2020 2020 2065 6e63 6f64             encod
+0004e3b0: 696e 673d 2775 7466 2d38 2729 2061 7320  ing='utf-8') as 
+0004e3c0: 663a 0a20 2020 2020 2020 2020 2020 2020  f:.             
+0004e3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004e3e0: 2020 206a 736f 6e2e 6475 6d70 2866 696e     json.dump(fin
+0004e3f0: 616c 6d6d 6469 6374 2c20 6629 0a20 2020  almmdict, f).   
+0004e400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004e410: 2020 2020 2065 7863 6570 743a 0a20 2020       except:.   
 0004e420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004e430: 2020 2020 2020 2020 2020 7375 7266 6163            surfac
-0004e440: 6566 6e20 3d20 277b 7d7b 7d5f 7b7d 272e  efn = '{}{}_{}'.
-0004e450: 666f 726d 6174 2862 6173 6564 6972 2c20  format(basedir, 
-0004e460: 6d6f 6465 6c6e 616d 652c 206d 6170 6e61  modelname, mapna
-0004e470: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
-0004e480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004e490: 6368 696d 6572 6163 6d64 203d 2063 6869  chimeracmd = chi
-0004e4a0: 6d65 7261 666e 616d 650a 2020 2020 2020  merafname.      
-0004e4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004e4c0: 2020 2020 2020 2320 7064 626d 6f64 656c        # pdbmodel
-0004e4d0: 6e61 6d65 203d 2027 7b7d 7b7d 5f5f 515f  name = '{}{}__Q_
-0004e4e0: 5f7b 7d2e 7064 6227 2e66 6f72 6d61 7428  _{}.pdb'.format(
-0004e4f0: 6261 7365 6469 722c 206d 6f64 656c 6e61  basedir, modelna
-0004e500: 6d65 5b3a 2d34 5d2c 206d 6170 6e61 6d65  me[:-4], mapname
-0004e510: 5b3a 2d34 5d29 0a20 2020 2020 2020 2020  [:-4]).         
-0004e520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004e530: 2020 2070 6462 6d6f 6465 6c6e 616d 6520     pdbmodelname 
-0004e540: 3d20 277b 7d7b 7d27 2e66 6f72 6d61 7428  = '{}{}'.format(
-0004e550: 6261 7365 6469 722c 206d 6f64 656c 6e61  basedir, modelna
-0004e560: 6d65 290a 0a20 2020 2020 2020 2020 2020  me)..           
-0004e570: 2020 2020 2020 2020 2077 6974 6820 6f70           with op
-0004e580: 656e 2873 656c 662e 776f 726b 6469 7220  en(self.workdir 
-0004e590: 2b20 6368 696d 6572 6163 6d64 2c20 2777  + chimeracmd, 'w
-0004e5a0: 2729 2061 7320 6670 3a0a 2020 2020 2020  ') as fp:.      
-0004e5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004e5c0: 2020 6670 2e77 7269 7465 2822 6f70 656e    fp.write("open
-0004e5d0: 2022 202b 2073 7472 2870 6462 6d6f 6465   " + str(pdbmode
-0004e5e0: 6c6e 616d 6529 202b 2022 2066 6f72 6d61  lname) + " forma
-0004e5f0: 7420 6d6d 6369 6622 202b 2027 5c6e 2729  t mmcif" + '\n')
-0004e600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004e610: 2020 2020 2020 2020 2023 2066 702e 7772           # fp.wr
-0004e620: 6974 6528 226f 7065 6e20 2220 2b20 7374  ite("open " + st
-0004e630: 7228 7064 626d 6f64 656c 6e61 6d65 2920  r(pdbmodelname) 
-0004e640: 2b20 2220 666f 726d 6174 2070 6462 2220  + " format pdb" 
-0004e650: 2b20 275c 6e27 290a 2020 2020 2020 2020  + '\n').        
-0004e660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004e670: 6670 2e77 7269 7465 2827 7368 6f77 2073  fp.write('show s
-0004e680: 656c 4174 6f6d 7320 7269 6262 6f6e 7327  elAtoms ribbons'
-0004e690: 202b 2027 5c6e 2729 0a20 2020 2020 2020   + '\n').       
-0004e6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004e6b0: 2066 702e 7772 6974 6528 2768 6964 6520   fp.write('hide 
-0004e6c0: 7365 6c41 746f 6d73 2720 2b20 275c 6e27  selAtoms' + '\n'
-0004e6d0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-0004e6e0: 2020 2020 2020 2020 2020 2066 6f72 2028             for (
-0004e6f0: 636f 6c6f 722c 2072 6573 6964 7565 2c20  color, residue, 
-0004e700: 736d 6f63 7363 6f72 6529 2069 6e20 7a69  smocscore) in zi
-0004e710: 7028 636f 6c6f 7273 2c20 7265 7369 6475  p(colors, residu
-0004e720: 6573 2c20 736d 6f63 7329 3a0a 2020 2020  es, smocs):.    
-0004e730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004e740: 2020 2020 2020 2020 6368 6169 6e2c 2072          chain, r
-0004e750: 6573 746d 7020 3d20 7265 7369 6475 652e  estmp = residue.
-0004e760: 7370 6c69 7428 273a 2729 0a20 2020 2020  split(':').     
-0004e770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004e780: 2020 2020 2020 2023 204e 6f74 2073 7572         # Not sur
-0004e790: 6520 6966 2061 6c6c 2074 6865 206c 6574  e if all the let
-0004e7a0: 7465 7273 2073 686f 756c 6420 6265 2072  ters should be r
-0004e7b0: 6570 6c61 6365 640a 2020 2020 2020 2020  eplaced.        
-0004e7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004e7d0: 2020 2020 2320 3173 7420 7761 7920 6f66      # 1st way of
-0004e7e0: 2067 6574 7469 6e67 2072 6573 5f69 640a   getting res_id.
-0004e7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004e800: 2020 2020 2020 2020 2020 2020 2320 7265              # re
-0004e810: 735f 6964 203d 2072 652e 7375 6228 225c  s_id = re.sub("\
-0004e820: 4422 2c20 2222 2c20 7265 7374 6d70 290a  D", "", restmp).
-0004e830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004e840: 2020 2020 2020 2020 2020 2020 2320 326e              # 2n
-0004e850: 6420 7761 7920 6f66 2067 6574 7469 6e67  d way of getting
-0004e860: 2072 6573 0a20 2020 2020 2020 2020 2020   res.           
-0004e870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004e880: 2072 6573 5f69 6420 3d20 7265 2e66 696e   res_id = re.fin
-0004e890: 6461 6c6c 2872 272d 3f5c 642b 272c 2072  dall(r'-?\d+', r
-0004e8a0: 6573 746d 7029 5b30 5d0a 2020 2020 2020  estmp)[0].      
+0004e430: 2020 2020 2020 2020 2073 7973 2e73 7464           sys.std
+0004e440: 6572 722e 7772 6974 6528 0a20 2020 2020  err.write(.     
+0004e450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004e460: 2020 2020 2020 2020 2020 2027 5361 7669             'Savi
+0004e470: 6e67 2053 4d4f 4320 7669 6577 2074 6f20  ng SMOC view to 
+0004e480: 4a53 4f4e 2065 7272 6f72 3a20 7b7d 2e5c  JSON error: {}.\
+0004e490: 6e27 2e66 6f72 6d61 7428 7379 732e 6578  n'.format(sys.ex
+0004e4a0: 635f 696e 666f 2829 5b31 5d29 290a 0a20  c_info()[1])).. 
+0004e4b0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0004e4c0: 6e64 203d 2074 696d 6569 742e 6465 6661  nd = timeit.defa
+0004e4d0: 756c 745f 7469 6d65 7228 290a 2020 2020  ult_timer().    
+0004e4e0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+0004e4f0: 7428 2753 4d4f 4320 7375 7266 6163 6520  t('SMOC surface 
+0004e500: 7469 6d65 3a20 2573 2720 2520 2865 6e64  time: %s' % (end
+0004e510: 202d 2073 7461 7274 2929 0a20 2020 2020   - start)).     
+0004e520: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0004e530: 2827 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ('--------------
+0004e540: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0004e550: 2d2d 2d2d 2d2d 2729 0a0a 2020 2020 6465  ------')..    de
+0004e560: 6620 736d 6f63 5f73 7572 6661 6365 2873  f smoc_surface(s
+0004e570: 656c 6629 3a0a 0a20 2020 2020 2020 2023  elf):..        #
+0004e580: 2073 656c 662e 7265 6e61 6d65 7166 696c   self.renameqfil
+0004e590: 6573 2829 0a20 2020 2020 2020 2074 7279  es().        try
+0004e5a0: 3a0a 2020 2020 2020 2020 2020 2020 7674  :.            vt
+0004e5b0: 6b70 6163 6b2c 2063 6869 6d65 7261 6170  kpack, chimeraap
+0004e5c0: 7020 3d20 7365 6c66 2e73 7572 6661 6365  p = self.surface
+0004e5d0: 5f65 6e76 6368 6563 6b28 290a 2020 2020  _envcheck().    
+0004e5e0: 2020 2020 2020 2020 7365 6c66 2e73 6d6f          self.smo
+0004e5f0: 635f 7669 6577 2863 6869 6d65 7261 6170  c_view(chimeraap
+0004e600: 7029 0a20 2020 2020 2020 2065 7863 6570  p).        excep
+0004e610: 743a 0a20 2020 2020 2020 2020 2020 2065  t:.            e
+0004e620: 7272 203d 2027 534d 4f43 2073 7572 6661  rr = 'SMOC surfa
+0004e630: 6365 2076 6965 7720 6661 696c 6564 3a20  ce view failed: 
+0004e640: 7b7d 272e 666f 726d 6174 2873 7973 2e65  {}'.format(sys.e
+0004e650: 7863 5f69 6e66 6f28 295b 315d 290a 2020  xc_info()[1]).  
+0004e660: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0004e670: 7472 6163 6562 6163 6b2e 666f 726d 6174  traceback.format
+0004e680: 5f65 7863 2829 290a 2020 2020 2020 2020  _exc()).        
+0004e690: 2020 2020 7379 732e 7374 6465 7272 2e77      sys.stderr.w
+0004e6a0: 7269 7465 2865 7272 202b 2027 5c6e 2729  rite(err + '\n')
+0004e6b0: 0a0a 0a20 2020 2064 6566 2063 6363 5f62  ...    def ccc_b
+0004e6c0: 6172 2873 656c 6629 3a0a 0a0a 2020 2020  ar(self):...    
+0004e6d0: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
+0004e6e0: 6f6e 6c79 6261 723a 0a20 2020 2020 2020  onlybar:.       
+0004e6f0: 2020 2020 2073 656c 662e 7068 656e 6978       self.phenix
+0004e700: 5f72 6573 6363 6328 290a 2020 2020 2020  _resccc().      
+0004e710: 2020 7365 6c66 2e67 6574 5f62 6172 2873    self.get_bar(s
+0004e720: 636f 7265 5f74 7970 653d 2763 6363 2729  core_type='ccc')
+0004e730: 0a0a 0a20 2020 2064 6566 2070 6865 6e69  ...    def pheni
+0004e740: 785f 7265 7363 6363 2873 656c 6629 3a0a  x_resccc(self):.
+0004e750: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0004e760: 2020 2020 2020 2020 5275 6e20 5068 656e          Run Phen
+0004e770: 6978 2072 6573 6964 7565 2d77 6973 6520  ix residue-wise 
+0004e780: 4343 4320 6361 6c63 7561 7469 6f6e 0a20  CCC calcuation. 
+0004e790: 2020 2020 2020 203a 7265 7475 726e 3a0a         :return:.
+0004e7a0: 2020 2020 2020 2020 2222 220a 0a20 2020          """..   
+0004e7b0: 2020 2020 2069 6620 7365 6c66 2e70 6c61       if self.pla
+0004e7c0: 7466 6f72 6d20 3d3d 2027 656d 6462 2720  tform == 'emdb' 
+0004e7d0: 616e 6420 7365 6c66 2e6d 6574 2021 3d20  and self.met != 
+0004e7e0: 2774 6f6d 6f27 3a0a 2020 2020 2020 2020  'tomo':.        
+0004e7f0: 2020 2020 7374 6172 7420 3d20 7469 6d65      start = time
+0004e800: 6974 2e64 6566 6175 6c74 5f74 696d 6572  it.default_timer
+0004e810: 2829 0a20 2020 2020 2020 2020 2020 2065  ().            e
+0004e820: 7272 6c69 7374 203d 205b 5d0a 2020 2020  rrlist = [].    
+0004e830: 2020 2020 2020 2020 7265 7375 6c74 5f64          result_d
+0004e840: 6963 7420 3d20 7b7d 0a20 2020 2020 2020  ict = {}.       
+0004e850: 2020 2020 2023 2069 6620 7374 7275 6465       # if strude
+0004e860: 6c61 7070 2061 6e64 2073 656c 662e 6d6f  lapp and self.mo
+0004e870: 6465 6c73 3a0a 2020 2020 2020 2020 2020  dels:.          
+0004e880: 2020 6966 2073 656c 662e 6d6f 6465 6c73    if self.models
+0004e890: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0004e8a0: 2020 6e75 6d6d 6f64 656c 7320 3d20 300a    nummodels = 0.
 0004e8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004e8c0: 2020 2020 2020 6670 2e77 7269 7465 280a        fp.write(.
+0004e8c0: 616c 6c72 6573 756c 7473 203d 207b 7d0a  allresults = {}.
 0004e8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004e8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004e8f0: 2763 6f6c 6f72 202f 2720 2b20 6368 6169  'color /' + chai
-0004e900: 6e20 2b20 273a 2720 2b20 7265 735f 6964  n + ':' + res_id
-0004e910: 202b 2027 2027 202b 2063 6f6c 6f72 202b   + ' ' + color +
-0004e920: 2027 5c6e 270a 2020 2020 2020 2020 2020   '\n'.          
-0004e930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004e940: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0004e950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004e960: 6966 2073 6d6f 6373 636f 7265 203e 2031  if smocscore > 1
-0004e970: 2e30 3a0a 2020 2020 2020 2020 2020 2020  .0:.            
-0004e980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004e990: 2020 2020 6670 2e77 7269 7465 280a 2020      fp.write(.  
-0004e9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004e9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004e9c0: 2020 2773 686f 7720 2f27 202b 2063 6861    'show /' + cha
-0004e9d0: 696e 202b 2027 3a27 202b 2072 6573 5f69  in + ':' + res_i
-0004e9e0: 6420 2b20 2720 6174 6f6d 7327 202b 2027  d + ' atoms' + '
-0004e9f0: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
-0004ea00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ea10: 2020 2020 2020 2020 2773 7479 6c65 202f          'style /
-0004ea20: 2720 2b20 6368 6169 6e20 2b20 273a 2720  ' + chain + ':' 
-0004ea30: 2b20 7265 735f 6964 202b 2027 2073 7469  + res_id + ' sti
-0004ea40: 636b 2720 2b20 275c 6e27 0a20 2020 2020  ck' + '\n'.     
-0004ea50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ea60: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0004ea70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ea80: 2020 2020 2066 702e 7772 6974 6528 0a20       fp.write(. 
-0004ea90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004eaa0: 2020 2020 2020 2020 2020 2022 7365 7420             "set 
-0004eab0: 6267 436f 6c6f 7220 7768 6974 6522 202b  bgColor white" +
-0004eac0: 2027 5c6e 270a 2020 2020 2020 2020 2020   '\n'.          
-0004ead0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004eae0: 2020 226c 6967 6874 696e 6720 736f 6674    "lighting soft
-0004eaf0: 2220 2b20 275c 6e27 0a20 2020 2020 2020  " + '\n'.       
-0004eb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004eb10: 2020 2020 2022 7669 6577 2063 6f66 7220       "view cofr 
-0004eb20: 5472 7565 2220 2b20 275c 6e27 0a20 2020  True" + '\n'.   
-0004eb30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004eb40: 2020 2020 2020 2020 2022 7361 7665 2022           "save "
-0004eb50: 202b 2073 7472 2873 7572 6661 6365 666e   + str(surfacefn
-0004eb60: 2920 2b20 225f 7a63 6363 7375 7266 6163  ) + "_zcccsurfac
-0004eb70: 652e 6a70 6567 2220 2b20 2220 7375 7065  e.jpeg" + " supe
-0004eb80: 7273 616d 706c 6520 3320 7769 6474 6820  rsample 3 width 
-0004eb90: 3132 3030 2068 6569 6768 7420 3132 3030  1200 height 1200
-0004eba0: 2220 2b20 275c 6e27 0a20 2020 2020 2020  " + '\n'.       
-0004ebb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ebc0: 2020 2020 2022 7475 726e 2078 202d 3930       "turn x -90
-0004ebd0: 2220 2b20 275c 6e27 0a20 2020 2020 2020  " + '\n'.       
-0004ebe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ebf0: 2020 2020 2022 7475 726e 2079 202d 3930       "turn y -90
-0004ec00: 2220 2b20 275c 6e27 0a20 2020 2020 2020  " + '\n'.       
+0004e8e0: 666f 7220 6d6f 6465 6c20 696e 2073 656c  for model in sel
+0004e8f0: 662e 6d6f 6465 6c73 3a0a 2020 2020 2020  f.models:.      
+0004e900: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+0004e910: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+0004e920: 2020 2020 2020 2020 2020 2066 756c 6c5f             full_
+0004e930: 6d6f 6465 6c20 3d20 277b 7d7b 7d27 2e66  model = '{}{}'.f
+0004e940: 6f72 6d61 7428 7365 6c66 2e77 6f72 6b64  ormat(self.workd
+0004e950: 6972 2c20 6f73 2e70 6174 682e 6261 7365  ir, os.path.base
+0004e960: 6e61 6d65 286d 6f64 656c 2e66 696c 656e  name(model.filen
+0004e970: 616d 6529 290a 2020 2020 2020 2020 2020  ame)).          
+0004e980: 2020 2020 2020 2020 2020 2020 2020 6675                fu
+0004e990: 6c6c 5f6d 6170 203d 2027 7b7d 7b7d 272e  ll_map = '{}{}'.
+0004e9a0: 666f 726d 6174 2873 656c 662e 776f 726b  format(self.work
+0004e9b0: 6469 722c 2073 656c 662e 6d61 706e 616d  dir, self.mapnam
+0004e9c0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+0004e9d0: 2020 2020 2020 2020 2020 206f 7574 5f70             out_p
+0004e9e0: 6174 6820 3d20 277b 7d5f 7068 656e 6978  ath = '{}_phenix
+0004e9f0: 272e 666f 726d 6174 2866 756c 6c5f 6d6f  '.format(full_mo
+0004ea00: 6465 6c29 0a0a 2020 2020 2020 2020 2020  del)..          
+0004ea10: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0004ea20: 7272 203d 2072 756e 5f70 6865 6e69 7863  rr = run_phenixc
+0004ea30: 6328 6675 6c6c 5f6d 6f64 656c 2c20 6675  c(full_model, fu
+0004ea40: 6c6c 5f6d 6170 2c20 7365 6c66 2e72 6573  ll_map, self.res
+0004ea50: 6f6c 7574 696f 6e2c 206f 7574 5f70 6174  olution, out_pat
+0004ea60: 6829 0a20 2020 2020 2020 2020 2020 2020  h).             
+0004ea70: 2020 2020 2020 2020 2020 2065 6e64 203d             end =
+0004ea80: 2074 696d 6569 742e 6465 6661 756c 745f   timeit.default_
+0004ea90: 7469 6d65 7228 290a 2020 2020 2020 2020  timer().        
+0004eaa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004eab0: 7072 696e 7428 2750 6865 6e69 7820 4343  print('Phenix CC
+0004eac0: 4320 7469 6d65 3a20 2573 2720 2520 2865  C time: %s' % (e
+0004ead0: 6e64 202d 2073 7461 7274 2929 0a20 2020  nd - start)).   
+0004eae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004eaf0: 2020 2020 2063 636c 6f67 203d 2027 7b7d       cclog = '{}
+0004eb00: 2f63 635f 7065 725f 7265 7369 6475 652e  /cc_per_residue.
+0004eb10: 6c6f 6727 2e66 6f72 6d61 7428 6f75 745f  log'.format(out_
+0004eb20: 7061 7468 290a 2020 2020 2020 2020 2020  path).          
+0004eb30: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+0004eb40: 696e 7428 6363 6c6f 672c 2072 6572 7229  int(cclog, rerr)
+0004eb50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004eb60: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
+0004eb70: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0004eb80: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0004eb90: 2d2d 2d2d 2729 0a20 2020 2020 2020 2020  ----').         
+0004eba0: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+0004ebb0: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+0004ebc0: 2020 2020 2020 2020 2020 2065 7272 203d             err =
+0004ebd0: 2027 5068 656e 6978 2043 4343 2063 616c   'Phenix CCC cal
+0004ebe0: 6375 6c61 7469 6f6e 2065 7272 6f72 3a20  culation error: 
+0004ebf0: 7b7d 2e27 2e66 6f72 6d61 7428 7379 732e  {}.'.format(sys.
+0004ec00: 6578 635f 696e 666f 2829 5b31 5d29 0a20  exc_info()[1]). 
 0004ec10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ec20: 2020 2020 2022 7669 6577 2063 6f66 7220       "view cofr 
-0004ec30: 5472 7565 2220 2b20 275c 6e27 0a20 2020  True" + '\n'.   
+0004ec20: 2020 2020 2020 2065 7272 6c69 7374 2e61         errlist.a
+0004ec30: 7070 656e 6428 6572 7229 0a20 2020 2020  ppend(err).     
 0004ec40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ec50: 2020 2020 2020 2020 2022 7361 7665 2022           "save "
-0004ec60: 202b 2073 7472 2873 7572 6661 6365 666e   + str(surfacefn
-0004ec70: 2920 2b20 225f 7863 6363 7375 7266 6163  ) + "_xcccsurfac
-0004ec80: 652e 6a70 6567 2220 2b20 2220 7375 7065  e.jpeg" + " supe
-0004ec90: 7273 616d 706c 6520 3320 7769 6474 6820  rsample 3 width 
-0004eca0: 3132 3030 2068 6569 6768 7420 3132 3030  1200 height 1200
-0004ecb0: 2220 2b20 275c 6e27 0a20 2020 2020 2020  " + '\n'.       
+0004ec50: 2020 2073 7973 2e73 7464 6572 722e 7772     sys.stderr.wr
+0004ec60: 6974 6528 6572 7220 2b20 275c 6e27 290a  ite(err + '\n').
+0004ec70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ec80: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0004ec90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004eca0: 2064 6620 3d20 7265 6164 5f63 6328 6363   df = read_cc(cc
+0004ecb0: 6c6f 672c 2072 6572 7229 0a20 2020 2020  log, rerr).     
 0004ecc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ecd0: 2020 2020 2022 7669 6577 206f 7269 656e       "view orien
-0004ece0: 7422 202b 2027 5c6e 270a 2020 2020 2020  t" + '\n'.      
+0004ecd0: 2020 2063 6364 6963 7420 3d20 6363 6466     ccdict = ccdf
+0004ece0: 5f74 6f64 6963 7428 6466 290a 0a20 2020  _todict(df)..   
 0004ecf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ed00: 2020 2020 2020 2274 7572 6e20 7820 3930        "turn x 90
-0004ed10: 2220 2b20 275c 6e27 0a20 2020 2020 2020  " + '\n'.       
-0004ed20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ed30: 2020 2020 2022 7475 726e 207a 2039 3022       "turn z 90"
-0004ed40: 202b 2027 5c6e 270a 2020 2020 2020 2020   + '\n'.        
+0004ed00: 2020 2020 2061 6c6c 7265 7375 6c74 735b       allresults[
+0004ed10: 7374 7228 6e75 6d6d 6f64 656c 7329 5d20  str(nummodels)] 
+0004ed20: 3d20 7b27 6e61 6d65 273a 206f 732e 7061  = {'name': os.pa
+0004ed30: 7468 2e62 6173 656e 616d 6528 6d6f 6465  th.basename(mode
+0004ed40: 6c2e 6669 6c65 6e61 6d65 292c 0a20 2020  l.filename),.   
 0004ed50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ed60: 2020 2020 2276 6965 7720 636f 6672 2054      "view cofr T
-0004ed70: 7275 6522 202b 2027 5c6e 270a 2020 2020  rue" + '\n'.    
-0004ed80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ed90: 2020 2020 2020 2020 2273 6176 6520 2220          "save " 
-0004eda0: 2b20 7374 7228 7375 7266 6163 6566 6e29  + str(surfacefn)
-0004edb0: 202b 2022 5f79 6363 6373 7572 6661 6365   + "_ycccsurface
-0004edc0: 2e6a 7065 6722 202b 2022 2073 7570 6572  .jpeg" + " super
-0004edd0: 7361 6d70 6c65 2033 2077 6964 7468 2031  sample 3 width 1
-0004ede0: 3230 3020 6865 6967 6874 2031 3230 3022  200 height 1200"
-0004edf0: 202b 2027 5c6e 270a 2020 2020 2020 2020   + '\n'.        
-0004ee00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ee10: 2020 2020 2263 6c6f 7365 2061 6c6c 2220      "close all" 
-0004ee20: 2b20 225c 6e22 0a20 2020 2020 2020 2020  + "\n".         
-0004ee30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ee40: 2020 2022 6578 6974 220a 2020 2020 2020     "exit".      
-0004ee50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ee60: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0004ee70: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0004ee80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ee90: 2020 2020 2069 6620 6e6f 7420 6269 6e64       if not bind
-0004eea0: 6973 706c 6179 3a0a 2020 2020 2020 2020  isplay:.        
+0004ed60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ed70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ed80: 2020 2027 6461 7461 273a 2063 6364 6963     'data': ccdic
+0004ed90: 747d 0a0a 2020 2020 2020 2020 2020 2020  t}..            
+0004eda0: 2020 2020 2020 2020 6578 6365 7074 3a0a          except:.
+0004edb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004edc0: 2020 2020 2020 2020 6572 7220 3d20 2753          err = 'S
+0004edd0: 6176 6520 5068 656e 6978 2043 4343 2064  ave Phenix CCC d
+0004ede0: 6174 6120 6572 726f 723a 207b 7d2e 272e  ata error: {}.'.
+0004edf0: 666f 726d 6174 2873 7973 2e65 7863 5f69  format(sys.exc_i
+0004ee00: 6e66 6f28 295b 315d 290a 2020 2020 2020  nfo()[1]).      
+0004ee10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ee20: 2020 6572 726c 6973 742e 6170 7065 6e64    errlist.append
+0004ee30: 2865 7272 290a 2020 2020 2020 2020 2020  (err).          
+0004ee40: 2020 2020 2020 2020 2020 2020 2020 7379                sy
+0004ee50: 732e 7374 6465 7272 2e77 7269 7465 2865  s.stderr.write(e
+0004ee60: 7272 202b 2027 5c6e 2729 0a20 2020 2020  rr + '\n').     
+0004ee70: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0004ee80: 756d 6d6f 6465 6c73 202b 3d20 310a 0a20  ummodels += 1.. 
+0004ee90: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0004eea0: 6620 616c 6c72 6573 756c 7473 3a0a 2020  f allresults:.  
 0004eeb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004eec0: 2020 2020 7375 6270 726f 6365 7373 2e63      subprocess.c
-0004eed0: 6865 636b 5f63 616c 6c28 6c6f 6343 4849  heck_call(locCHI
-0004eee0: 4d45 5241 202b 2022 202d 2d6f 6666 7363  MERA + " --offsc
-0004eef0: 7265 656e 202d 2d6e 6f67 7569 2022 202b  reen --nogui " +
-0004ef00: 2073 656c 662e 776f 726b 6469 7220 2b20   self.workdir + 
-0004ef10: 6368 696d 6572 6163 6d64 2c0a 2020 2020  chimeracmd,.    
-0004ef20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ef30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ef40: 2020 2020 2020 2020 2020 2020 2020 6377                cw
-0004ef50: 643d 7365 6c66 2e77 6f72 6b64 6972 2c20  d=self.workdir, 
-0004ef60: 7368 656c 6c3d 5472 7565 290a 2020 2020  shell=True).    
-0004ef70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ef80: 2020 2020 2020 2020 7072 696e 7428 2743          print('C
-0004ef90: 6f6c 6f72 6564 206d 6f64 656c 7320 6261  olored models ba
-0004efa0: 7365 6420 6f6e 2043 4343 2077 6572 6520  sed on CCC were 
-0004efb0: 7072 6f64 7563 6564 2e27 290a 2020 2020  produced.').    
-0004efc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004efd0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0004efe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004eff0: 2020 2020 2020 7375 6270 726f 6365 7373        subprocess
-0004f000: 2e63 6865 636b 5f63 616c 6c28 6c6f 6343  .check_call(locC
-0004f010: 4849 4d45 5241 202b 2022 2022 202b 2073  HIMERA + " " + s
-0004f020: 656c 662e 776f 726b 6469 7220 2b20 6368  elf.workdir + ch
-0004f030: 696d 6572 6163 6d64 2c20 6377 643d 7365  imeracmd, cwd=se
-0004f040: 6c66 2e77 6f72 6b64 6972 2c0a 2020 2020  lf.workdir,.    
-0004f050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004eec0: 2020 7265 7375 6c74 5f64 6963 745b 2763    result_dict['c
+0004eed0: 6363 275d 203d 2061 6c6c 7265 7375 6c74  cc'] = allresult
+0004eee0: 730a 0a20 2020 2020 2020 2020 2020 2020  s..             
+0004eef0: 2020 2069 6620 6572 726c 6973 743a 0a20     if errlist:. 
+0004ef00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ef10: 2020 2072 6573 756c 745f 6469 6374 5b27     result_dict['
+0004ef20: 6572 7227 5d20 3d20 6572 726c 6973 740a  err'] = errlist.
+0004ef30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004ef40: 2069 6620 6c65 6e28 7265 7375 6c74 5f64   if len(result_d
+0004ef50: 6963 7429 203d 3d20 3120 616e 6420 2763  ict) == 1 and 'c
+0004ef60: 6363 2720 696e 2072 6573 756c 745f 6469  cc' in result_di
+0004ef70: 6374 3a0a 2020 2020 2020 2020 2020 2020  ct:.            
+0004ef80: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+0004ef90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004efa0: 2020 2020 2077 6974 6820 636f 6465 6373       with codecs
+0004efb0: 2e6f 7065 6e28 7365 6c66 2e77 6f72 6b64  .open(self.workd
+0004efc0: 6972 202b 2073 656c 662e 6d61 706e 616d  ir + self.mapnam
+0004efd0: 6520 2b20 275f 7265 7363 6363 2e6a 736f  e + '_resccc.jso
+0004efe0: 6e27 2c20 2777 272c 0a20 2020 2020 2020  n', 'w',.       
+0004eff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004f000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004f010: 2020 656e 636f 6469 6e67 3d27 7574 662d    encoding='utf-
+0004f020: 3827 2920 6173 2066 3a0a 2020 2020 2020  8') as f:.      
+0004f030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004f040: 2020 2020 2020 6a73 6f6e 2e64 756d 7028        json.dump(
+0004f050: 7265 7375 6c74 5f64 6963 742c 2066 290a  result_dict, f).
 0004f060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f070: 2020 2020 2020 2020 2020 2020 2020 7368                sh
-0004f080: 656c 6c3d 5472 7565 290a 2020 2020 2020  ell=True).      
-0004f090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f0a0: 2020 2020 2020 7072 696e 7428 2743 6f6c        print('Col
-0004f0b0: 6f72 6564 206d 6f64 656c 7320 6261 7365  ored models base
-0004f0c0: 6420 6f6e 2043 4343 2077 6572 6520 7072  d on CCC were pr
-0004f0d0: 6f64 7563 6564 2e27 290a 2020 2020 2020  oduced.').      
-0004f0e0: 2020 2020 2020 2020 2020 2020 2020 6578                ex
-0004f0f0: 6365 7074 2073 7562 7072 6f63 6573 732e  cept subprocess.
-0004f100: 4361 6c6c 6564 5072 6f63 6573 7345 7272  CalledProcessErr
-0004f110: 6f72 2061 7320 7375 6265 7272 3a0a 2020  or as suberr:.  
-0004f120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f130: 2020 2020 2020 6572 7220 3d20 2753 6176        err = 'Sav
-0004f140: 696e 6720 6d6f 6465 6c20 7b7d 2043 4343  ing model {} CCC
-0004f150: 2076 6965 7720 6572 726f 723a 207b 7d2e   view error: {}.
-0004f160: 272e 666f 726d 6174 286d 6f64 656c 6e61  '.format(modelna
-0004f170: 6d65 2c20 7375 6265 7272 290a 2020 2020  me, suberr).    
-0004f180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f190: 2020 2020 6572 726c 6973 742e 6170 7065      errlist.appe
-0004f1a0: 6e64 2865 7272 290a 2020 2020 2020 2020  nd(err).        
-0004f1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f1c0: 7379 732e 7374 6465 7272 2e77 7269 7465  sys.stderr.write
-0004f1d0: 2865 7272 202b 2027 5c6e 2729 0a0a 2020  (err + '\n')..  
-0004f1e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f1f0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-0004f200: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0004f210: 656c 662e 7363 616c 655f 7375 7266 6163  elf.scale_surfac
-0004f220: 6576 6965 7728 290a 2020 2020 2020 2020  eview().        
-0004f230: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-0004f240: 7074 3a0a 2020 2020 2020 2020 2020 2020  pt:.            
-0004f250: 2020 2020 2020 2020 2020 2020 6572 7220              err 
-0004f260: 3d20 2753 6361 6c69 6e67 206d 6f64 656c  = 'Scaling model
-0004f270: 2043 4343 2076 6965 7720 6572 726f 723a   CCC view error:
-0004f280: 207b 7d2e 272e 666f 726d 6174 2873 7973   {}.'.format(sys
-0004f290: 2e65 7863 5f69 6e66 6f28 295b 315d 290a  .exc_info()[1]).
-0004f2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f2b0: 2020 2020 2020 2020 6572 726c 6973 742e          errlist.
-0004f2c0: 6170 7065 6e64 2865 7272 290a 2020 2020  append(err).    
-0004f2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f2e0: 2020 2020 7379 732e 7374 6465 7272 2e77      sys.stderr.w
-0004f2f0: 7269 7465 2865 7272 202b 2027 5c6e 2729  rite(err + '\n')
-0004f300: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0004f310: 2020 2020 2020 6a70 6567 7320 3d20 676c        jpegs = gl
-0004f320: 6f62 2e67 6c6f 6228 7365 6c66 2e77 6f72  ob.glob(self.wor
-0004f330: 6b64 6972 202b 2027 2f2a 6363 6373 7572  kdir + '/*cccsur
-0004f340: 6661 6365 2e6a 7065 6727 290a 2020 2020  face.jpeg').    
-0004f350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f360: 6d6f 6465 6c73 7572 6620 3d20 6469 6374  modelsurf = dict
-0004f370: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
-0004f380: 2020 2020 2020 2066 696e 616c 6d6d 6469         finalmmdi
-0004f390: 6374 203d 2064 6963 7428 290a 2020 2020  ct = dict().    
-0004f3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f3b0: 6966 2073 656c 662e 6d6f 6465 6c73 3a0a  if self.models:.
-0004f3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f3d0: 2020 2020 2020 2020 2320 7072 696e 7420          # print 
-0004f3e0: 2273 656c 662e 6d6f 6465 6c73 3a25 7322  "self.models:%s"
-0004f3f0: 2025 2073 656c 662e 6d6f 6465 6c73 0a20   % self.models. 
-0004f400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f410: 2020 2020 2020 2066 6f72 206d 6f64 656c         for model
-0004f420: 2069 6e20 7365 6c66 2e6d 6f64 656c 733a   in self.models:
-0004f430: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004f440: 2020 2020 2020 2020 2020 2020 206d 6f64               mod
-0004f450: 656c 6e61 6d65 203d 206f 732e 7061 7468  elname = os.path
-0004f460: 2e62 6173 656e 616d 6528 6d6f 6465 6c2e  .basename(model.
-0004f470: 6669 6c65 6e61 6d65 290a 2020 2020 2020  filename).      
-0004f480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f490: 2020 2020 2020 7375 7266 6163 6566 6e20        surfacefn 
-0004f4a0: 3d20 277b 7d5f 7b7d 272e 666f 726d 6174  = '{}_{}'.format
-0004f4b0: 286d 6f64 656c 6e61 6d65 2c20 7365 6c66  (modelname, self
-0004f4c0: 2e6d 6170 6e61 6d65 290a 2020 2020 2020  .mapname).      
-0004f4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f4e0: 2020 2020 2020 6d6f 6465 6c6d 6170 7375        modelmapsu
-0004f4f0: 7266 6163 6520 3d20 6469 6374 2829 0a20  rface = dict(). 
-0004f500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f510: 2020 2020 2020 2020 2020 2066 6f72 206a             for j
-0004f520: 7065 6720 696e 206a 7065 6773 3a0a 2020  peg in jpegs:.  
-0004f530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f540: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0004f550: 206d 6f64 656c 6e61 6d65 2069 6e20 6a70   modelname in jp
-0004f560: 6567 2061 6e64 2027 7863 6363 2720 696e  eg and 'xccc' in
-0004f570: 206a 7065 673a 0a20 2020 2020 2020 2020   jpeg:.         
-0004f580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f590: 2020 2020 2020 2020 2020 206d 6f64 656c             model
-0004f5a0: 6d61 7073 7572 6661 6365 5b27 7827 5d20  mapsurface['x'] 
-0004f5b0: 3d20 7374 7228 7375 7266 6163 6566 6e29  = str(surfacefn)
-0004f5c0: 202b 2027 5f73 6361 6c65 645f 7863 6363   + '_scaled_xccc
-0004f5d0: 7375 7266 6163 652e 6a70 6567 270a 2020  surface.jpeg'.  
-0004f5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f5f0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0004f600: 206d 6f64 656c 6e61 6d65 2069 6e20 6a70   modelname in jp
-0004f610: 6567 2061 6e64 2027 7963 6363 2720 696e  eg and 'yccc' in
-0004f620: 206a 7065 673a 0a20 2020 2020 2020 2020   jpeg:.         
-0004f630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f640: 2020 2020 2020 2020 2020 206d 6f64 656c             model
-0004f650: 6d61 7073 7572 6661 6365 5b27 7927 5d20  mapsurface['y'] 
-0004f660: 3d20 7374 7228 7375 7266 6163 6566 6e29  = str(surfacefn)
-0004f670: 202b 2027 5f73 6361 6c65 645f 7963 6363   + '_scaled_yccc
-0004f680: 7375 7266 6163 652e 6a70 6567 270a 2020  surface.jpeg'.  
-0004f690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f6a0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0004f6b0: 206d 6f64 656c 6e61 6d65 2069 6e20 6a70   modelname in jp
-0004f6c0: 6567 2061 6e64 2027 7a63 6363 2720 696e  eg and 'zccc' in
-0004f6d0: 206a 7065 673a 0a20 2020 2020 2020 2020   jpeg:.         
-0004f6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f6f0: 2020 2020 2020 2020 2020 206d 6f64 656c             model
-0004f700: 6d61 7073 7572 6661 6365 5b27 7a27 5d20  mapsurface['z'] 
-0004f710: 3d20 7374 7228 7375 7266 6163 6566 6e29  = str(surfacefn)
-0004f720: 202b 2027 5f73 6361 6c65 645f 7a63 6363   + '_scaled_zccc
-0004f730: 7375 7266 6163 652e 6a70 6567 270a 2020  surface.jpeg'.  
-0004f740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f750: 2020 2020 2020 2020 2020 6966 2065 7272            if err
-0004f760: 6c69 7374 3a0a 2020 2020 2020 2020 2020  list:.          
-0004f770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f780: 2020 2020 2020 6d6f 6465 6c6d 6170 7375        modelmapsu
-0004f790: 7266 6163 655b 2765 7272 275d 203d 207b  rface['err'] = {
-0004f7a0: 2763 6363 5f65 7272 273a 2065 7272 6c69  'ccc_err': errli
-0004f7b0: 7374 7d0a 2020 2020 2020 2020 2020 2020  st}.            
-0004f7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f7d0: 6d6f 6465 6c73 7572 665b 6d6f 6465 6c6e  modelsurf[modeln
-0004f7e0: 616d 655d 203d 206d 6f64 656c 6d61 7073  ame] = modelmaps
-0004f7f0: 7572 6661 6365 0a20 2020 2020 2020 2020  urface.         
-0004f800: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0004f810: 696e 616c 6d6d 6469 6374 5b27 6363 6373  inalmmdict['cccs
-0004f820: 636f 7265 5f73 7572 6661 6365 275d 203d  core_surface'] =
-0004f830: 206d 6f64 656c 7375 7266 0a0a 2020 2020   modelsurf..    
-0004f840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f850: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0004f070: 2020 2020 6578 6365 7074 3a0a 2020 2020      except:.    
+0004f080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004f090: 2020 2020 7379 732e 7374 6465 7272 2e77      sys.stderr.w
+0004f0a0: 7269 7465 2827 5361 7669 6e67 2074 6f20  rite('Saving to 
+0004f0b0: 4343 4320 6a73 6f6e 2065 7272 6f72 3a20  CCC json error: 
+0004f0c0: 7b7d 2e5c 6e27 2e66 6f72 6d61 7428 7379  {}.\n'.format(sy
+0004f0d0: 732e 6578 635f 696e 666f 2829 5b31 5d29  s.exc_info()[1])
+0004f0e0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+0004f0f0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+0004f100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004f110: 2020 2020 7365 6c66 2e63 635f 7375 7266      self.cc_surf
+0004f120: 6163 6528 290a 2020 2020 2020 2020 2020  ace().          
+0004f130: 2020 2020 2020 2020 2020 6578 6365 7074            except
+0004f140: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0004f150: 2020 2020 2020 2020 2020 2020 2020 7379                sy
+0004f160: 732e 7374 6465 7272 2e77 7269 7465 2827  s.stderr.write('
+0004f170: 4343 4320 7375 7266 6163 6520 6572 726f  CCC surface erro
+0004f180: 723a 207b 7d2e 5c6e 272e 666f 726d 6174  r: {}.\n'.format
+0004f190: 2873 7973 2e65 7863 5f69 6e66 6f28 295b  (sys.exc_info()[
+0004f1a0: 315d 2929 0a20 2020 2020 2020 2020 2020  1])).           
+0004f1b0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0004f1c0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0004f1d0: 7269 6e74 2827 4343 4320 7761 7320 6e6f  rint('CCC was no
+0004f1e0: 7420 636f 6c6c 6563 7465 642c 2070 6c65  t collected, ple
+0004f1f0: 6173 6520 6368 6563 6b20 7468 6520 6572  ase check the er
+0004f200: 726f 7221 2729 0a0a 2020 2020 2020 2020  ror!')..        
+0004f210: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0004f220: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+0004f230: 274e 6f20 6d6f 6465 6c20 6f72 2072 6573  'No model or res
+0004f240: 6f6c 7574 696f 6e20 6973 206e 6f74 2063  olution is not c
+0004f250: 6f76 6572 6564 2069 6e20 7468 6520 6d6f  overed in the mo
+0004f260: 7469 6620 6c69 6272 6172 7920 283c 342e  tif library (<4.
+0004f270: 30c3 8529 2027 290a 2020 2020 2020 2020  0..) ').        
+0004f280: 2020 2020 2020 2020 7072 696e 7428 272d          print('-
+0004f290: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0004f2a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0004f2b0: 2d2d 2d27 290a 0a20 2020 2020 2020 2072  ---')..        r
+0004f2c0: 6574 7572 6e20 4e6f 6e65 0a0a 2020 2020  eturn None..    
+0004f2d0: 6465 6620 6363 7363 6f72 6576 6965 7728  def ccscoreview(
+0004f2e0: 7365 6c66 2c20 6368 696d 6572 6161 7070  self, chimeraapp
+0004f2f0: 293a 0a20 2020 2020 2020 2022 2222 0a0a  ):.        """..
+0004f300: 2020 2020 2020 2020 2020 2020 582c 2059              X, Y
+0004f310: 2c20 5a20 696d 6167 6573 2077 6869 6368  , Z images which
+0004f320: 206d 6f64 656c 2077 6173 2063 6f6c 6f72   model was color
+0004f330: 6564 2062 7920 7265 7369 6475 652d 7769  ed by residue-wi
+0004f340: 7365 2043 4343 0a0a 2020 2020 2020 2020  se CCC..        
+0004f350: 3a72 6574 7572 6e3a 0a20 2020 2020 2020  :return:.       
+0004f360: 2022 2222 0a0a 2020 2020 2020 2020 2320   """..        # 
+0004f370: 7265 6164 206a 736f 6e0a 2020 2020 2020  read json.      
+0004f380: 2020 7374 6172 7420 3d20 7469 6d65 6974    start = timeit
+0004f390: 2e64 6566 6175 6c74 5f74 696d 6572 2829  .default_timer()
+0004f3a0: 0a20 2020 2020 2020 2069 6e6a 736f 6e20  .        injson 
+0004f3b0: 3d20 676c 6f62 2e67 6c6f 6228 7365 6c66  = glob.glob(self
+0004f3c0: 2e77 6f72 6b64 6972 202b 2027 2a5f 7265  .workdir + '*_re
+0004f3d0: 7363 6363 2e6a 736f 6e27 290a 2020 2020  sccc.json').    
+0004f3e0: 2020 2020 6261 7365 6469 7220 3d20 7365      basedir = se
+0004f3f0: 6c66 2e77 6f72 6b64 6972 0a20 2020 2020  lf.workdir.     
+0004f400: 2020 206d 6170 6e61 6d65 203d 2073 656c     mapname = sel
+0004f410: 662e 6d61 706e 616d 650a 2020 2020 2020  f.mapname.      
+0004f420: 2020 6c6f 6343 4849 4d45 5241 203d 2063    locCHIMERA = c
+0004f430: 6869 6d65 7261 6170 700a 2020 2020 2020  himeraapp.      
+0004f440: 2020 6269 6e64 6973 706c 6179 203d 206f    bindisplay = o
+0004f450: 732e 6765 7465 6e76 2827 4449 5350 4c41  s.getenv('DISPLA
+0004f460: 5927 290a 2020 2020 2020 2020 6572 726c  Y').        errl
+0004f470: 6973 7420 3d20 5b5d 0a0a 2020 2020 2020  ist = []..      
+0004f480: 2020 6675 6c69 6e6a 736f 6e20 3d20 696e    fulinjson = in
+0004f490: 6a73 6f6e 5b30 5d20 6966 2069 6e6a 736f  json[0] if injso
+0004f4a0: 6e20 656c 7365 204e 6f6e 650a 2020 2020  n else None.    
+0004f4b0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0004f4c0: 2020 2020 2069 6620 6675 6c69 6e6a 736f       if fulinjso
+0004f4d0: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
+0004f4e0: 2020 2077 6974 6820 6f70 656e 2866 756c     with open(ful
+0004f4f0: 696e 6a73 6f6e 2c20 2772 2729 2061 7320  injson, 'r') as 
+0004f500: 663a 0a20 2020 2020 2020 2020 2020 2020  f:.             
+0004f510: 2020 2020 2020 2061 7267 7320 3d20 6a73         args = js
+0004f520: 6f6e 2e6c 6f61 6428 6629 0a20 2020 2020  on.load(f).     
+0004f530: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0004f540: 2020 2020 2020 2020 2020 2020 2061 7267               arg
+0004f550: 7320 3d20 4e6f 6e65 0a20 2020 2020 2020  s = None.       
+0004f560: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
+0004f570: 5468 6572 6520 6973 206e 6f20 4343 4320  There is no CCC 
+0004f580: 6a73 6f6e 2066 696c 652e 2729 0a20 2020  json file.').   
+0004f590: 2020 2020 2065 7863 6570 7420 5479 7065       except Type
+0004f5a0: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
+0004f5b0: 2020 2065 7272 203d 2027 4f70 656e 2043     err = 'Open C
+0004f5c0: 4343 204a 534f 4e20 6572 726f 723a 207b  CC JSON error: {
+0004f5d0: 7d2e 272e 666f 726d 6174 2873 7973 2e65  }.'.format(sys.e
+0004f5e0: 7863 5f69 6e66 6f28 295b 315d 290a 2020  xc_info()[1]).  
+0004f5f0: 2020 2020 2020 2020 2020 6572 726c 6973            errlis
+0004f600: 742e 6170 7065 6e64 2865 7272 290a 2020  t.append(err).  
+0004f610: 2020 2020 2020 2020 2020 7379 732e 7374            sys.st
+0004f620: 6465 7272 2e77 7269 7465 2865 7272 202b  derr.write(err +
+0004f630: 2027 5c6e 2729 0a20 2020 2020 2020 2065   '\n').        e
+0004f640: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0004f650: 2069 6620 6172 6773 2069 7320 6e6f 7420   if args is not 
+0004f660: 4e6f 6e65 2061 6e64 2027 6363 6327 2069  None and 'ccc' i
+0004f670: 6e20 6172 6773 2e6b 6579 7328 293a 0a20  n args.keys():. 
+0004f680: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0004f690: 6f64 656c 7320 3d20 6172 6773 5b27 6363  odels = args['cc
+0004f6a0: 6327 5d0a 2020 2020 2020 2020 2020 2020  c'].            
+0004f6b0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0004f6c0: 2020 2020 2020 2020 2020 2020 2064 656c               del
+0004f6d0: 206d 6f64 656c 735b 2765 7272 275d 0a20   models['err']. 
+0004f6e0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0004f6f0: 7863 6570 743a 0a20 2020 2020 2020 2020  xcept:.         
+0004f700: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+0004f710: 2827 4343 4320 6a73 6f6e 2072 6573 756c  ('CCC json resul
+0004f720: 7420 6973 2063 6f72 7265 6374 2729 0a0a  t is correct')..
+0004f730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004f740: 7072 696e 7428 2754 6865 7265 2069 732f  print('There is/
+0004f750: 6172 6520 2573 206d 6f64 656c 2873 292e  are %s model(s).
+0004f760: 2720 2520 6c65 6e28 6d6f 6465 6c73 2929  ' % len(models))
+0004f770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004f780: 2066 6f72 2028 6b65 792c 2076 616c 7565   for (key, value
+0004f790: 2920 696e 2069 7465 7269 7465 6d73 286d  ) in iteritems(m
+0004f7a0: 6f64 656c 7329 3a0a 2020 2020 2020 2020  odels):.        
+0004f7b0: 2020 2020 2020 2020 2020 2020 2320 666f              # fo
+0004f7c0: 7220 286b 6579 322c 2076 616c 7565 3229  r (key2, value2)
+0004f7d0: 2069 6e20 6974 6572 6974 656d 7328 7661   in iteritems(va
+0004f7e0: 6c75 6529 3a0a 2020 2020 2020 2020 2020  lue):.          
+0004f7f0: 2020 2020 2020 2020 2020 6966 2074 7970            if typ
+0004f800: 6528 7661 6c75 6529 2069 7320 666c 6f61  e(value) is floa
+0004f810: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+0004f820: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
+0004f830: 6e75 650a 2020 2020 2020 2020 2020 2020  nue.            
+0004f840: 2020 2020 2020 2020 6b65 796c 6973 7420          keylist 
+0004f850: 3d20 6c69 7374 2876 616c 7565 290a 2020  = list(value).  
 0004f860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f870: 2020 2020 2077 6974 6820 636f 6465 6373       with codecs
-0004f880: 2e6f 7065 6e28 7365 6c66 2e77 6f72 6b64  .open(self.workd
-0004f890: 6972 202b 2073 656c 662e 6d61 706e 616d  ir + self.mapnam
-0004f8a0: 6520 2b20 275f 6363 6376 6965 772e 6a73  e + '_cccview.js
-0004f8b0: 6f6e 272c 2027 7727 2c0a 2020 2020 2020  on', 'w',.      
-0004f8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f8d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f8e0: 2020 2020 2020 2065 6e63 6f64 696e 673d         encoding=
-0004f8f0: 2775 7466 2d38 2729 2061 7320 663a 0a20  'utf-8') as f:. 
-0004f900: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f910: 2020 2020 2020 2020 2020 2020 2020 206a                 j
-0004f920: 736f 6e2e 6475 6d70 2866 696e 616c 6d6d  son.dump(finalmm
-0004f930: 6469 6374 2c20 6629 0a20 2020 2020 2020  dict, f).       
-0004f940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f950: 2065 7863 6570 743a 0a20 2020 2020 2020   except:.       
+0004f870: 2020 666f 7220 6b65 7920 696e 206b 6579    for key in key
+0004f880: 6c69 7374 3a0a 2020 2020 2020 2020 2020  list:.          
+0004f890: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0004f8a0: 206b 6579 2021 3d20 276e 616d 6527 3a0a   key != 'name':.
+0004f8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004f8c0: 2020 2020 2020 2020 2020 2020 636f 6c6f              colo
+0004f8d0: 7273 203d 2076 616c 7565 5b6b 6579 5d5b  rs = value[key][
+0004f8e0: 2763 6f6c 6f72 275d 0a20 2020 2020 2020  'color'].       
+0004f8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004f900: 2020 2020 2072 6573 6964 7565 7320 3d20       residues = 
+0004f910: 7661 6c75 655b 6b65 795d 5b27 7265 7369  value[key]['resi
+0004f920: 6475 6527 5d0a 2020 2020 2020 2020 2020  due'].          
+0004f930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004f940: 2020 736d 6f63 7320 3d20 7661 6c75 655b    smocs = value[
+0004f950: 6b65 795d 5b27 6363 7363 6f72 6527 5d0a  key]['ccscore'].
 0004f960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f970: 2020 2020 2073 7973 2e73 7464 6572 722e       sys.stderr.
-0004f980: 7772 6974 6528 0a20 2020 2020 2020 2020  write(.         
-0004f990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004f9a0: 2020 2020 2020 2027 5361 7669 6e67 2043         'Saving C
-0004f9b0: 4343 2076 6965 7720 746f 204a 534f 4e20  CC view to JSON 
-0004f9c0: 6572 726f 723a 207b 7d2e 5c6e 272e 666f  error: {}.\n'.fo
-0004f9d0: 726d 6174 2873 7973 2e65 7863 5f69 6e66  rmat(sys.exc_inf
-0004f9e0: 6f28 295b 315d 2929 0a0a 2020 2020 2020  o()[1]))..      
-0004f9f0: 2020 2020 2020 2020 2020 656e 6420 3d20            end = 
-0004fa00: 7469 6d65 6974 2e64 6566 6175 6c74 5f74  timeit.default_t
-0004fa10: 696d 6572 2829 0a20 2020 2020 2020 2020  imer().         
-0004fa20: 2020 2020 2020 2070 7269 6e74 2827 4343         print('CC
-0004fa30: 4320 7375 7266 6163 6520 7469 6d65 3a20  C surface time: 
-0004fa40: 2573 2720 2520 2865 6e64 202d 2073 7461  %s' % (end - sta
-0004fa50: 7274 2929 0a20 2020 2020 2020 2020 2020  rt)).           
-0004fa60: 2020 2020 2070 7269 6e74 2827 2d2d 2d2d       print('----
-0004fa70: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0004fa80: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-0004fa90: 2729 0a0a 2020 2020 6465 6620 6363 5f73  ')..    def cc_s
-0004faa0: 7572 6661 6365 2873 656c 6629 3a0a 2020  urface(self):.  
-0004fab0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0004fac0: 2020 2020 2020 2076 746b 7061 636b 2c20         vtkpack, 
-0004fad0: 6368 696d 6572 6161 7070 203d 2073 656c  chimeraapp = sel
-0004fae0: 662e 7375 7266 6163 655f 656e 7663 6865  f.surface_envche
-0004faf0: 636b 2829 0a20 2020 2020 2020 2020 2020  ck().           
-0004fb00: 2073 656c 662e 6363 7363 6f72 6576 6965   self.ccscorevie
-0004fb10: 7728 6368 696d 6572 6161 7070 290a 2020  w(chimeraapp).  
-0004fb20: 2020 2020 2020 6578 6365 7074 3a0a 2020        except:.  
-0004fb30: 2020 2020 2020 2020 2020 6572 7220 3d20            err = 
-0004fb40: 2743 4343 2073 7572 6661 6365 2076 6965  'CCC surface vie
-0004fb50: 7720 6661 696c 6564 3a20 7b7d 272e 666f  w failed: {}'.fo
-0004fb60: 726d 6174 2873 7973 2e65 7863 5f69 6e66  rmat(sys.exc_inf
-0004fb70: 6f28 295b 315d 290a 2020 2020 2020 2020  o()[1]).        
-0004fb80: 2020 2020 7072 696e 7428 7472 6163 6562      print(traceb
-0004fb90: 6163 6b2e 666f 726d 6174 5f65 7863 2829  ack.format_exc()
-0004fba0: 290a 2020 2020 2020 2020 2020 2020 7379  ).            sy
-0004fbb0: 732e 7374 6465 7272 2e77 7269 7465 2865  s.stderr.write(e
-0004fbc0: 7272 202b 2027 5c6e 2729 0a0a 2020 2020  rr + '\n')..    
-0004fbd0: 6465 6620 7068 656e 6978 5f6d 6d66 7363  def phenix_mmfsc
-0004fbe0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
-0004fbf0: 2222 220a 2020 2020 2020 2020 2020 2020  """.            
-0004fc00: 5275 6e20 5068 656e 6978 206d 6170 2d6d  Run Phenix map-m
-0004fc10: 6f64 656c 2046 5343 2063 616c 6375 6c61  odel FSC calcula
-0004fc20: 7469 6f6e 0a20 2020 2020 2020 203a 7265  tion.        :re
-0004fc30: 7475 726e 3a0a 2020 2020 2020 2020 2222  turn:.        ""
-0004fc40: 220a 0a20 2020 2020 2020 2069 6620 7365  "..        if se
-0004fc50: 6c66 2e70 6c61 7466 6f72 6d20 3d3d 2027  lf.platform == '
-0004fc60: 656d 6462 2720 616e 6420 7365 6c66 2e6d  emdb' and self.m
-0004fc70: 6574 2021 3d20 2774 6f6d 6f27 2061 6e64  et != 'tomo' and
-0004fc80: 2073 656c 662e 6d65 7420 213d 2027 6372   self.met != 'cr
-0004fc90: 7973 2720 3a0a 2020 2020 2020 2020 2020  ys' :.          
-0004fca0: 2020 7374 6172 7420 3d20 7469 6d65 6974    start = timeit
-0004fcb0: 2e64 6566 6175 6c74 5f74 696d 6572 2829  .default_timer()
-0004fcc0: 0a20 2020 2020 2020 2020 2020 2065 7272  .            err
-0004fcd0: 6c69 7374 203d 205b 5d0a 2020 2020 2020  list = [].      
-0004fce0: 2020 2020 2020 7265 7375 6c74 5f64 6963        result_dic
-0004fcf0: 7420 3d20 7b7d 0a20 2020 2020 2020 2020  t = {}.         
-0004fd00: 2020 2072 6177 5f72 6573 756c 745f 6469     raw_result_di
-0004fd10: 6374 203d 207b 7d0a 2020 2020 2020 2020  ct = {}.        
-0004fd20: 2020 2020 2320 6966 2073 7472 7564 656c      # if strudel
-0004fd30: 6170 7020 616e 6420 7365 6c66 2e6d 6f64  app and self.mod
-0004fd40: 656c 733a 0a20 2020 2020 2020 2020 2020  els:.           
-0004fd50: 2069 6620 7365 6c66 2e6d 6f64 656c 733a   if self.models:
-0004fd60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004fd70: 206e 756d 6d6f 6465 6c73 203d 2030 0a20   nummodels = 0. 
-0004fd80: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0004fd90: 6c6c 7265 7375 6c74 7320 3d20 7b7d 0a20  llresults = {}. 
-0004fda0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0004fdb0: 6177 5f61 6c6c 7265 7375 6c74 7320 3d20  aw_allresults = 
-0004fdc0: 7b7d 0a20 2020 2020 2020 2020 2020 2020  {}.             
-0004fdd0: 2020 2066 6f72 206d 6f64 656c 2069 6e20     for model in 
-0004fde0: 7365 6c66 2e6d 6f64 656c 733a 0a20 2020  self.models:.   
+0004f970: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0004f980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004f990: 2020 2020 2020 2020 2020 6d6f 6465 6c6e            modeln
+0004f9a0: 616d 6520 3d20 7661 6c75 655b 6b65 795d  ame = value[key]
+0004f9b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004f9c0: 2020 2020 2020 2020 2020 2020 206d 6f64               mod
+0004f9d0: 656c 203d 2073 656c 662e 776f 726b 6469  el = self.workdi
+0004f9e0: 7220 2b20 6d6f 6465 6c6e 616d 650a 2020  r + modelname.  
+0004f9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004fa00: 2020 2020 2020 2020 2020 6368 696d 6572            chimer
+0004fa10: 6166 6e61 6d65 203d 2027 7b7d 5f7b 7d5f  afname = '{}_{}_
+0004fa20: 6363 635f 6368 696d 6572 612e 6378 6327  ccc_chimera.cxc'
+0004fa30: 2e66 6f72 6d61 7428 6d6f 6465 6c6e 616d  .format(modelnam
+0004fa40: 652c 206d 6170 6e61 6d65 290a 2020 2020  e, mapname).    
+0004fa50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004fa60: 2020 2020 2020 2020 7375 7266 6163 6566          surfacef
+0004fa70: 6e20 3d20 277b 7d7b 7d5f 7b7d 272e 666f  n = '{}{}_{}'.fo
+0004fa80: 726d 6174 2862 6173 6564 6972 2c20 6d6f  rmat(basedir, mo
+0004fa90: 6465 6c6e 616d 652c 206d 6170 6e61 6d65  delname, mapname
+0004faa0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0004fab0: 2020 2020 2020 2020 2020 2020 2020 6368                ch
+0004fac0: 696d 6572 6163 6d64 203d 2063 6869 6d65  imeracmd = chime
+0004fad0: 7261 666e 616d 650a 2020 2020 2020 2020  rafname.        
+0004fae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004faf0: 2020 2020 2320 7064 626d 6f64 656c 6e61      # pdbmodelna
+0004fb00: 6d65 203d 2027 7b7d 7b7d 5f5f 515f 5f7b  me = '{}{}__Q__{
+0004fb10: 7d2e 7064 6227 2e66 6f72 6d61 7428 6261  }.pdb'.format(ba
+0004fb20: 7365 6469 722c 206d 6f64 656c 6e61 6d65  sedir, modelname
+0004fb30: 5b3a 2d34 5d2c 206d 6170 6e61 6d65 5b3a  [:-4], mapname[:
+0004fb40: 2d34 5d29 0a20 2020 2020 2020 2020 2020  -4]).           
+0004fb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004fb60: 2070 6462 6d6f 6465 6c6e 616d 6520 3d20   pdbmodelname = 
+0004fb70: 277b 7d7b 7d27 2e66 6f72 6d61 7428 6261  '{}{}'.format(ba
+0004fb80: 7365 6469 722c 206d 6f64 656c 6e61 6d65  sedir, modelname
+0004fb90: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+0004fba0: 2020 2020 2020 2077 6974 6820 6f70 656e         with open
+0004fbb0: 2873 656c 662e 776f 726b 6469 7220 2b20  (self.workdir + 
+0004fbc0: 6368 696d 6572 6163 6d64 2c20 2777 2729  chimeracmd, 'w')
+0004fbd0: 2061 7320 6670 3a0a 2020 2020 2020 2020   as fp:.        
+0004fbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004fbf0: 6670 2e77 7269 7465 2822 6f70 656e 2022  fp.write("open "
+0004fc00: 202b 2073 7472 2870 6462 6d6f 6465 6c6e   + str(pdbmodeln
+0004fc10: 616d 6529 202b 2022 2066 6f72 6d61 7420  ame) + " format 
+0004fc20: 6d6d 6369 6622 202b 2027 5c6e 2729 0a20  mmcif" + '\n'). 
+0004fc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004fc40: 2020 2020 2020 2023 2066 702e 7772 6974         # fp.writ
+0004fc50: 6528 226f 7065 6e20 2220 2b20 7374 7228  e("open " + str(
+0004fc60: 7064 626d 6f64 656c 6e61 6d65 2920 2b20  pdbmodelname) + 
+0004fc70: 2220 666f 726d 6174 2070 6462 2220 2b20  " format pdb" + 
+0004fc80: 275c 6e27 290a 2020 2020 2020 2020 2020  '\n').          
+0004fc90: 2020 2020 2020 2020 2020 2020 2020 6670                fp
+0004fca0: 2e77 7269 7465 2827 7368 6f77 2073 656c  .write('show sel
+0004fcb0: 4174 6f6d 7320 7269 6262 6f6e 7327 202b  Atoms ribbons' +
+0004fcc0: 2027 5c6e 2729 0a20 2020 2020 2020 2020   '\n').         
+0004fcd0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0004fce0: 702e 7772 6974 6528 2768 6964 6520 7365  p.write('hide se
+0004fcf0: 6c41 746f 6d73 2720 2b20 275c 6e27 290a  lAtoms' + '\n').
+0004fd00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004fd10: 2020 2020 2020 2020 2066 6f72 2028 636f           for (co
+0004fd20: 6c6f 722c 2072 6573 6964 7565 2c20 736d  lor, residue, sm
+0004fd30: 6f63 7363 6f72 6529 2069 6e20 7a69 7028  ocscore) in zip(
+0004fd40: 636f 6c6f 7273 2c20 7265 7369 6475 6573  colors, residues
+0004fd50: 2c20 736d 6f63 7329 3a0a 2020 2020 2020  , smocs):.      
+0004fd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004fd70: 2020 2020 2020 6368 6169 6e2c 2072 6573        chain, res
+0004fd80: 746d 7020 3d20 7265 7369 6475 652e 7370  tmp = residue.sp
+0004fd90: 6c69 7428 273a 2729 0a20 2020 2020 2020  lit(':').       
+0004fda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004fdb0: 2020 2020 2023 204e 6f74 2073 7572 6520       # Not sure 
+0004fdc0: 6966 2061 6c6c 2074 6865 206c 6574 7465  if all the lette
+0004fdd0: 7273 2073 686f 756c 6420 6265 2072 6570  rs should be rep
+0004fde0: 6c61 6365 640a 2020 2020 2020 2020 2020  laced.          
 0004fdf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004fe00: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-0004fe10: 2020 2020 2020 2020 2020 2020 2020 6675                fu
-0004fe20: 6c6c 5f6d 6f64 656c 203d 2027 7b7d 7b7d  ll_model = '{}{}
-0004fe30: 272e 666f 726d 6174 2873 656c 662e 776f  '.format(self.wo
-0004fe40: 726b 6469 722c 206f 732e 7061 7468 2e62  rkdir, os.path.b
-0004fe50: 6173 656e 616d 6528 6d6f 6465 6c2e 6669  asename(model.fi
-0004fe60: 6c65 6e61 6d65 2929 0a20 2020 2020 2020  lename)).       
-0004fe70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004fe80: 2066 756c 6c5f 6d61 7020 3d20 277b 7d7b   full_map = '{}{
-0004fe90: 7d27 2e66 6f72 6d61 7428 7365 6c66 2e77  }'.format(self.w
-0004fea0: 6f72 6b64 6972 2c20 7365 6c66 2e6d 6170  orkdir, self.map
-0004feb0: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
-0004fec0: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
-0004fed0: 745f 7061 7468 203d 2027 7b7d 5f70 6865  t_path = '{}_phe
-0004fee0: 6e69 7827 2e66 6f72 6d61 7428 6675 6c6c  nix'.format(full
-0004fef0: 5f6d 6f64 656c 290a 2020 2020 2020 2020  _model).        
+0004fe00: 2020 2320 3173 7420 7761 7920 6f66 2067    # 1st way of g
+0004fe10: 6574 7469 6e67 2072 6573 5f69 640a 2020  etting res_id.  
+0004fe20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004fe30: 2020 2020 2020 2020 2020 2320 7265 735f            # res_
+0004fe40: 6964 203d 2072 652e 7375 6228 225c 4422  id = re.sub("\D"
+0004fe50: 2c20 2222 2c20 7265 7374 6d70 290a 2020  , "", restmp).  
+0004fe60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004fe70: 2020 2020 2020 2020 2020 2320 326e 6420            # 2nd 
+0004fe80: 7761 7920 6f66 2067 6574 7469 6e67 2072  way of getting r
+0004fe90: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
+0004fea0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0004feb0: 6573 5f69 6420 3d20 7265 2e66 696e 6461  es_id = re.finda
+0004fec0: 6c6c 2872 272d 3f5c 642b 272c 2072 6573  ll(r'-?\d+', res
+0004fed0: 746d 7029 5b30 5d0a 2020 2020 2020 2020  tmp)[0].        
+0004fee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004fef0: 2020 2020 6670 2e77 7269 7465 280a 2020      fp.write(.  
 0004ff00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ff10: 7265 7272 203d 2072 756e 5f70 6865 6e69  rerr = run_pheni
-0004ff20: 786d 6d66 7363 2866 756c 6c5f 6d6f 6465  xmmfsc(full_mode
-0004ff30: 6c2c 2066 756c 6c5f 6d61 702c 206f 7574  l, full_map, out
-0004ff40: 5f70 6174 6829 0a20 2020 2020 2020 2020  _path).         
-0004ff50: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0004ff60: 6d6d 6673 636c 6f67 203d 2027 7b7d 2f66  mmfsclog = '{}/f
-0004ff70: 7363 5f6d 6f64 656c 2e75 6e6d 6173 6b65  sc_model.unmaske
-0004ff80: 642e 6d74 7269 6167 652e 6c6f 6727 2e66  d.mtriage.log'.f
-0004ff90: 6f72 6d61 7428 6f75 745f 7061 7468 290a  ormat(out_path).
-0004ffa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ffb0: 2020 2020 2020 2020 6d6d 6673 636c 6f67          mmfsclog
-0004ffc0: 203d 2027 7b7d 2f66 7363 5f6d 6f64 656c   = '{}/fsc_model
-0004ffd0: 2e75 6e6d 6173 6b65 642e 6d74 7269 6167  .unmasked.mtriag
-0004ffe0: 655f 7b7d 2e6c 6f67 272e 666f 726d 6174  e_{}.log'.format
-0004fff0: 286f 7574 5f70 6174 682c 2073 656c 662e  (out_path, self.
-00050000: 6d61 706e 616d 6529 0a20 2020 2020 2020  mapname).       
-00050010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050020: 2063 6861 6e67 655f 6669 6c65 6e61 6d65   change_filename
-00050030: 2874 6d6d 6673 636c 6f67 2c20 6d6d 6673  (tmmfsclog, mmfs
-00050040: 636c 6f67 290a 2020 2020 2020 2020 2020  clog).          
-00050050: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-00050060: 775f 6d6d 6673 636c 6f67 203d 204e 6f6e  w_mmfsclog = Non
-00050070: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00050080: 2020 2020 2020 2020 2020 7261 775f 7265            raw_re
-00050090: 7272 203d 204e 6f6e 650a 2020 2020 2020  rr = None.      
+0004ff10: 2020 2020 2020 2020 2020 2020 2020 2763                'c
+0004ff20: 6f6c 6f72 202f 2720 2b20 6368 6169 6e20  olor /' + chain 
+0004ff30: 2b20 273a 2720 2b20 7265 735f 6964 202b  + ':' + res_id +
+0004ff40: 2027 2027 202b 2063 6f6c 6f72 202b 2027   ' ' + color + '
+0004ff50: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
+0004ff60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ff70: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0004ff80: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0004ff90: 2073 6d6f 6373 636f 7265 203e 2031 2e30   smocscore > 1.0
+0004ffa0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0004ffb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ffc0: 2020 6670 2e77 7269 7465 280a 2020 2020    fp.write(.    
+0004ffd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004ffe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004fff0: 2773 686f 7720 2f27 202b 2063 6861 696e  'show /' + chain
+00050000: 202b 2027 3a27 202b 2072 6573 5f69 6420   + ':' + res_id 
+00050010: 2b20 2720 6174 6f6d 7327 202b 2027 5c6e  + ' atoms' + '\n
+00050020: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
+00050030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050040: 2020 2020 2020 2773 7479 6c65 202f 2720        'style /' 
+00050050: 2b20 6368 6169 6e20 2b20 273a 2720 2b20  + chain + ':' + 
+00050060: 7265 735f 6964 202b 2027 2073 7469 636b  res_id + ' stick
+00050070: 2720 2b20 275c 6e27 0a20 2020 2020 2020  ' + '\n'.       
+00050080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050090: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
 000500a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000500b0: 2020 6966 2073 656c 662e 686d 6f64 6420    if self.hmodd 
-000500c0: 616e 6420 7365 6c66 2e68 6d65 7665 6e3a  and self.hmeven:
-000500d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000500e0: 2020 2020 2020 2020 2020 2020 2072 6177               raw
-000500f0: 5f66 756c 6c5f 6d61 7020 3d20 7365 6c66  _full_map = self
-00050100: 2e72 6177 6d61 702e 6675 6c6c 6e61 6d65  .rawmap.fullname
-00050110: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00050120: 2020 2020 2020 2020 2020 2020 2072 6177               raw
-00050130: 5f6d 6170 6e61 6d65 203d 206f 732e 7061  _mapname = os.pa
-00050140: 7468 2e62 6173 656e 616d 6528 7261 775f  th.basename(raw_
-00050150: 6675 6c6c 5f6d 6170 290a 2020 2020 2020  full_map).      
+000500b0: 2020 2066 702e 7772 6974 6528 0a20 2020     fp.write(.   
+000500c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000500d0: 2020 2020 2020 2020 2022 7365 7420 6267           "set bg
+000500e0: 436f 6c6f 7220 7768 6974 6522 202b 2027  Color white" + '
+000500f0: 5c6e 270a 2020 2020 2020 2020 2020 2020  \n'.            
+00050100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050110: 226c 6967 6874 696e 6720 736f 6674 2220  "lighting soft" 
+00050120: 2b20 275c 6e27 0a20 2020 2020 2020 2020  + '\n'.         
+00050130: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050140: 2020 2022 7669 6577 2063 6f66 7220 5472     "view cofr Tr
+00050150: 7565 2220 2b20 275c 6e27 0a20 2020 2020  ue" + '\n'.     
 00050160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050170: 2020 2020 2020 7261 775f 7265 7272 203d        raw_rerr =
-00050180: 2072 756e 5f70 6865 6e69 786d 6d66 7363   run_phenixmmfsc
-00050190: 2866 756c 6c5f 6d6f 6465 6c2c 2072 6177  (full_model, raw
-000501a0: 5f66 756c 6c5f 6d61 702c 206f 7574 5f70  _full_map, out_p
-000501b0: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
-000501c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000501d0: 2072 6177 5f6d 6d66 7363 6c6f 6720 3d20   raw_mmfsclog = 
-000501e0: 277b 7d2f 6673 635f 6d6f 6465 6c2e 756e  '{}/fsc_model.un
-000501f0: 6d61 736b 6564 2e6d 7472 6961 6765 5f7b  masked.mtriage_{
-00050200: 7d2e 6c6f 6727 2e66 6f72 6d61 7428 6f75  }.log'.format(ou
-00050210: 745f 7061 7468 2c20 7261 775f 6d61 706e  t_path, raw_mapn
-00050220: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
-00050230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050240: 2063 6861 6e67 655f 6669 6c65 6e61 6d65   change_filename
-00050250: 2874 6d6d 6673 636c 6f67 2c20 7261 775f  (tmmfsclog, raw_
-00050260: 6d6d 6673 636c 6f67 290a 2020 2020 2020  mmfsclog).      
+00050170: 2020 2020 2020 2022 7361 7665 2022 202b         "save " +
+00050180: 2073 7472 2873 7572 6661 6365 666e 2920   str(surfacefn) 
+00050190: 2b20 225f 7a63 6363 7375 7266 6163 652e  + "_zcccsurface.
+000501a0: 6a70 6567 2220 2b20 2220 7375 7065 7273  jpeg" + " supers
+000501b0: 616d 706c 6520 3320 7769 6474 6820 3132  ample 3 width 12
+000501c0: 3030 2068 6569 6768 7420 3132 3030 2220  00 height 1200" 
+000501d0: 2b20 275c 6e27 0a20 2020 2020 2020 2020  + '\n'.         
+000501e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000501f0: 2020 2022 7475 726e 2078 202d 3930 2220     "turn x -90" 
+00050200: 2b20 275c 6e27 0a20 2020 2020 2020 2020  + '\n'.         
+00050210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050220: 2020 2022 7475 726e 2079 202d 3930 2220     "turn y -90" 
+00050230: 2b20 275c 6e27 0a20 2020 2020 2020 2020  + '\n'.         
+00050240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050250: 2020 2022 7669 6577 2063 6f66 7220 5472     "view cofr Tr
+00050260: 7565 2220 2b20 275c 6e27 0a20 2020 2020  ue" + '\n'.     
 00050270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050280: 2020 656e 6420 3d20 7469 6d65 6974 2e64    end = timeit.d
-00050290: 6566 6175 6c74 5f74 696d 6572 2829 0a20  efault_timer(). 
-000502a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000502b0: 2020 2020 2020 2070 7269 6e74 2827 5068         print('Ph
-000502c0: 656e 6978 206d 6d46 5343 2074 696d 653a  enix mmFSC time:
-000502d0: 2025 7327 2025 2028 656e 6420 2d20 7374   %s' % (end - st
-000502e0: 6172 7429 290a 2020 2020 2020 2020 2020  art)).          
-000502f0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-00050300: 696e 7428 272d 2d2d 2d2d 2d2d 2d2d 2d2d  int('-----------
-00050310: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00050320: 2d2d 2d2d 2d2d 2d2d 2d27 290a 2020 2020  ---------').    
-00050330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050340: 6578 6365 7074 3a0a 2020 2020 2020 2020  except:.        
+00050280: 2020 2020 2020 2022 7361 7665 2022 202b         "save " +
+00050290: 2073 7472 2873 7572 6661 6365 666e 2920   str(surfacefn) 
+000502a0: 2b20 225f 7863 6363 7375 7266 6163 652e  + "_xcccsurface.
+000502b0: 6a70 6567 2220 2b20 2220 7375 7065 7273  jpeg" + " supers
+000502c0: 616d 706c 6520 3320 7769 6474 6820 3132  ample 3 width 12
+000502d0: 3030 2068 6569 6768 7420 3132 3030 2220  00 height 1200" 
+000502e0: 2b20 275c 6e27 0a20 2020 2020 2020 2020  + '\n'.         
+000502f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050300: 2020 2022 7669 6577 206f 7269 656e 7422     "view orient"
+00050310: 202b 2027 5c6e 270a 2020 2020 2020 2020   + '\n'.        
+00050320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050330: 2020 2020 2274 7572 6e20 7820 3930 2220      "turn x 90" 
+00050340: 2b20 275c 6e27 0a20 2020 2020 2020 2020  + '\n'.         
 00050350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050360: 6572 7220 3d20 2750 6865 6e69 7820 6d6d  err = 'Phenix mm
-00050370: 4653 4320 6361 6c63 756c 6174 696f 6e20  FSC calculation 
-00050380: 6572 726f 723a 207b 7d2e 272e 666f 726d  error: {}.'.form
-00050390: 6174 2873 7973 2e65 7863 5f69 6e66 6f28  at(sys.exc_info(
-000503a0: 295b 315d 290a 2020 2020 2020 2020 2020  )[1]).          
-000503b0: 2020 2020 2020 2020 2020 2020 2020 6572                er
-000503c0: 726c 6973 742e 6170 7065 6e64 2865 7272  rlist.append(err
-000503d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000503e0: 2020 2020 2020 2020 2020 7379 732e 7374            sys.st
-000503f0: 6465 7272 2e77 7269 7465 2865 7272 202b  derr.write(err +
-00050400: 2027 5c6e 2729 0a20 2020 2020 2020 2020   '\n').         
-00050410: 2020 2020 2020 2020 2020 206e 7971 7569             nyqui
-00050420: 7374 203d 2031 202f 2028 3220 2a20 7365  st = 1 / (2 * se
-00050430: 6c66 2e6d 6170 2e76 6f78 656c 5f73 697a  lf.map.voxel_siz
-00050440: 652e 746f 6c69 7374 2829 5b30 5d29 0a20  e.tolist()[0]). 
-00050450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050460: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00050470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050480: 6466 203d 2072 6561 645f 6d6d 6673 6328  df = read_mmfsc(
-00050490: 6d6d 6673 636c 6f67 2c20 7265 7272 290a  mmfsclog, rerr).
-000504a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000504b0: 2020 2020 2020 2020 6d6d 6673 6364 6963          mmfscdic
-000504c0: 7420 3d20 6d6d 6673 6364 665f 746f 6469  t = mmfscdf_todi
-000504d0: 6374 2864 662c 206e 7971 7569 7374 290a  ct(df, nyquist).
-000504e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000504f0: 2020 2020 2020 2020 2061 6c6c 7265 7375           allresu
-00050500: 6c74 735b 7374 7228 6e75 6d6d 6f64 656c  lts[str(nummodel
-00050510: 7329 5d20 3d20 7b27 6e61 6d65 273a 206f  s)] = {'name': o
-00050520: 732e 7061 7468 2e62 6173 656e 616d 6528  s.path.basename(
-00050530: 6d6f 6465 6c2e 6669 6c65 6e61 6d65 292c  model.filename),
-00050540: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00050360: 2020 2022 7475 726e 207a 2039 3022 202b     "turn z 90" +
+00050370: 2027 5c6e 270a 2020 2020 2020 2020 2020   '\n'.          
+00050380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050390: 2020 2276 6965 7720 636f 6672 2054 7275    "view cofr Tru
+000503a0: 6522 202b 2027 5c6e 270a 2020 2020 2020  e" + '\n'.      
+000503b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000503c0: 2020 2020 2020 2273 6176 6520 2220 2b20        "save " + 
+000503d0: 7374 7228 7375 7266 6163 6566 6e29 202b  str(surfacefn) +
+000503e0: 2022 5f79 6363 6373 7572 6661 6365 2e6a   "_ycccsurface.j
+000503f0: 7065 6722 202b 2022 2073 7570 6572 7361  peg" + " supersa
+00050400: 6d70 6c65 2033 2077 6964 7468 2031 3230  mple 3 width 120
+00050410: 3020 6865 6967 6874 2031 3230 3022 202b  0 height 1200" +
+00050420: 2027 5c6e 270a 2020 2020 2020 2020 2020   '\n'.          
+00050430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050440: 2020 2263 6c6f 7365 2061 6c6c 2220 2b20    "close all" + 
+00050450: 225c 6e22 0a20 2020 2020 2020 2020 2020  "\n".           
+00050460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050470: 2022 6578 6974 220a 2020 2020 2020 2020   "exit".        
+00050480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050490: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000504a0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+000504b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000504c0: 2020 2069 6620 6e6f 7420 6269 6e64 6973     if not bindis
+000504d0: 706c 6179 3a0a 2020 2020 2020 2020 2020  play:.          
+000504e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000504f0: 2020 7375 6270 726f 6365 7373 2e63 6865    subprocess.che
+00050500: 636b 5f63 616c 6c28 6c6f 6343 4849 4d45  ck_call(locCHIME
+00050510: 5241 202b 2022 202d 2d6f 6666 7363 7265  RA + " --offscre
+00050520: 656e 202d 2d6e 6f67 7569 2022 202b 2073  en --nogui " + s
+00050530: 656c 662e 776f 726b 6469 7220 2b20 6368  elf.workdir + ch
+00050540: 696d 6572 6163 6d64 2c0a 2020 2020 2020  imeracmd,.      
 00050550: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00050560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050570: 2020 2020 2020 2027 6461 7461 273a 206d         'data': m
-00050580: 6d66 7363 6469 6374 7d0a 0a20 2020 2020  mfscdict}..     
-00050590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000505a0: 2020 2069 6620 7365 6c66 2e68 6d6f 6464     if self.hmodd
-000505b0: 2061 6e64 2073 656c 662e 686d 6576 656e   and self.hmeven
-000505c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000505d0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-000505e0: 775f 6466 203d 2072 6561 645f 6d6d 6673  w_df = read_mmfs
-000505f0: 6328 7261 775f 6d6d 6673 636c 6f67 2c20  c(raw_mmfsclog, 
-00050600: 7261 775f 7265 7272 290a 2020 2020 2020  raw_rerr).      
+00050570: 2020 2020 2020 2020 2020 2020 6377 643d              cwd=
+00050580: 7365 6c66 2e77 6f72 6b64 6972 2c20 7368  self.workdir, sh
+00050590: 656c 6c3d 5472 7565 290a 2020 2020 2020  ell=True).      
+000505a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000505b0: 2020 2020 2020 7072 696e 7428 2743 6f6c        print('Col
+000505c0: 6f72 6564 206d 6f64 656c 7320 6261 7365  ored models base
+000505d0: 6420 6f6e 2043 4343 2077 6572 6520 7072  d on CCC were pr
+000505e0: 6f64 7563 6564 2e27 290a 2020 2020 2020  oduced.').      
+000505f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050600: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
 00050610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050620: 2020 2020 2020 7261 775f 6d6d 6673 6364        raw_mmfscd
-00050630: 6963 7420 3d20 6d6d 6673 6364 665f 746f  ict = mmfscdf_to
-00050640: 6469 6374 2872 6177 5f64 662c 206e 7971  dict(raw_df, nyq
-00050650: 7569 7374 290a 0a20 2020 2020 2020 2020  uist)..         
-00050660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050670: 2020 2072 6177 5f61 6c6c 7265 7375 6c74     raw_allresult
-00050680: 735b 7374 7228 6e75 6d6d 6f64 656c 7329  s[str(nummodels)
-00050690: 5d20 3d20 7b27 6e61 6d65 273a 206f 732e  ] = {'name': os.
-000506a0: 7061 7468 2e62 6173 656e 616d 6528 6d6f  path.basename(mo
-000506b0: 6465 6c2e 6669 6c65 6e61 6d65 292c 0a20  del.filename),. 
+00050620: 2020 2020 7375 6270 726f 6365 7373 2e63      subprocess.c
+00050630: 6865 636b 5f63 616c 6c28 6c6f 6343 4849  heck_call(locCHI
+00050640: 4d45 5241 202b 2022 2022 202b 2073 656c  MERA + " " + sel
+00050650: 662e 776f 726b 6469 7220 2b20 6368 696d  f.workdir + chim
+00050660: 6572 6163 6d64 2c20 6377 643d 7365 6c66  eracmd, cwd=self
+00050670: 2e77 6f72 6b64 6972 2c0a 2020 2020 2020  .workdir,.      
+00050680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000506a0: 2020 2020 2020 2020 2020 2020 7368 656c              shel
+000506b0: 6c3d 5472 7565 290a 2020 2020 2020 2020  l=True).        
 000506c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000506d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000506e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000506f0: 2020 2020 2020 2020 2020 2020 2027 6461               'da
-00050700: 7461 273a 2072 6177 5f6d 6d66 7363 6469  ta': raw_mmfscdi
-00050710: 6374 7d0a 0a20 2020 2020 2020 2020 2020  ct}..           
-00050720: 2020 2020 2020 2020 2065 7863 6570 743a           except:
-00050730: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00050740: 2020 2020 2020 2020 2065 7272 203d 2027           err = '
-00050750: 5361 7665 2050 6865 6e69 7820 6d6d 4653  Save Phenix mmFS
-00050760: 4320 6461 7461 2065 7272 6f72 3a20 7b7d  C data error: {}
-00050770: 2e27 2e66 6f72 6d61 7428 7379 732e 6578  .'.format(sys.ex
-00050780: 635f 696e 666f 2829 5b31 5d29 0a20 2020  c_info()[1]).   
-00050790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000507a0: 2020 2020 2065 7272 6c69 7374 2e61 7070       errlist.app
-000507b0: 656e 6428 6572 7229 0a20 2020 2020 2020  end(err).       
-000507c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000507d0: 2073 7973 2e73 7464 6572 722e 7772 6974   sys.stderr.writ
-000507e0: 6528 6572 7220 2b20 275c 6e27 290a 2020  e(err + '\n').  
-000507f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050800: 2020 6e75 6d6d 6f64 656c 7320 2b3d 2031    nummodels += 1
-00050810: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00050820: 2020 6966 2061 6c6c 7265 7375 6c74 733a    if allresults:
-00050830: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00050840: 2020 2020 2072 6573 756c 745f 6469 6374       result_dict
-00050850: 5b27 6d6d 6673 6327 5d20 3d20 616c 6c72  ['mmfsc'] = allr
-00050860: 6573 756c 7473 0a20 2020 2020 2020 2020  esults.         
-00050870: 2020 2020 2020 2069 6620 7261 775f 616c         if raw_al
-00050880: 6c72 6573 756c 7473 3a0a 2020 2020 2020  lresults:.      
-00050890: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-000508a0: 775f 7265 7375 6c74 5f64 6963 745b 2772  w_result_dict['r
-000508b0: 6177 5f6d 6d66 7363 275d 203d 2072 6177  aw_mmfsc'] = raw
-000508c0: 5f61 6c6c 7265 7375 6c74 730a 0a20 2020  _allresults..   
-000508d0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000508e0: 6572 726c 6973 743a 0a20 2020 2020 2020  errlist:.       
-000508f0: 2020 2020 2020 2020 2020 2020 2072 6573               res
-00050900: 756c 745f 6469 6374 5b27 6572 7227 5d20  ult_dict['err'] 
-00050910: 3d20 6572 726c 6973 740a 0a20 2020 2020  = errlist..     
-00050920: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
-00050930: 6e28 7265 7375 6c74 5f64 6963 7429 203d  n(result_dict) =
-00050940: 3d20 3120 616e 6420 276d 6d66 7363 2720  = 1 and 'mmfsc' 
-00050950: 696e 2072 6573 756c 745f 6469 6374 3a0a  in result_dict:.
-00050960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050970: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00050980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050990: 2077 6974 6820 636f 6465 6373 2e6f 7065   with codecs.ope
-000509a0: 6e28 7365 6c66 2e77 6f72 6b64 6972 202b  n(self.workdir +
-000509b0: 2073 656c 662e 6d61 706e 616d 6520 2b20   self.mapname + 
-000509c0: 275f 6d6d 6673 632e 6a73 6f6e 272c 2027  '_mmfsc.json', '
-000509d0: 7727 2c0a 2020 2020 2020 2020 2020 2020  w',.            
-000509e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000509f0: 2020 2020 2020 2020 2020 2020 2065 6e63               enc
-00050a00: 6f64 696e 673d 2775 7466 2d38 2729 2061  oding='utf-8') a
-00050a10: 7320 663a 0a20 2020 2020 2020 2020 2020  s f:.           
-00050a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050a30: 206a 736f 6e2e 6475 6d70 2872 6573 756c   json.dump(resul
-00050a40: 745f 6469 6374 2c20 6629 0a20 2020 2020  t_dict, f).     
-00050a50: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00050a60: 7863 6570 743a 0a20 2020 2020 2020 2020  xcept:.         
-00050a70: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00050a80: 7973 2e73 7464 6572 722e 7772 6974 6528  ys.stderr.write(
-00050a90: 2753 6176 696e 6720 746f 206d 6d46 5343  'Saving to mmFSC
-00050aa0: 206a 736f 6e20 6572 726f 723a 207b 7d2e   json error: {}.
-00050ab0: 5c6e 272e 666f 726d 6174 2873 7973 2e65  \n'.format(sys.e
-00050ac0: 7863 5f69 6e66 6f28 295b 315d 2929 0a0a  xc_info()[1]))..
-00050ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050ae0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00050af0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-00050b00: 276d 6d46 5343 2077 6173 206e 6f74 2063  'mmFSC was not c
-00050b10: 6f6c 6c65 6374 6564 2c20 706c 6561 7365  ollected, please
-00050b20: 2063 6865 636b 2074 6865 2065 7272 6f72   check the error
-00050b30: 2127 290a 0a20 2020 2020 2020 2020 2020  !')..           
-00050b40: 2020 2020 2069 6620 6c65 6e28 7261 775f       if len(raw_
-00050b50: 7265 7375 6c74 5f64 6963 7429 203d 3d20  result_dict) == 
-00050b60: 3120 616e 6420 2772 6177 5f6d 6d66 7363  1 and 'raw_mmfsc
-00050b70: 2720 696e 2072 6177 5f72 6573 756c 745f  ' in raw_result_
-00050b80: 6469 6374 3a0a 2020 2020 2020 2020 2020  dict:.          
-00050b90: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
-00050ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050bb0: 2020 2020 2020 2077 6974 6820 636f 6465         with code
-00050bc0: 6373 2e6f 7065 6e28 7365 6c66 2e77 6f72  cs.open(self.wor
-00050bd0: 6b64 6972 202b 2073 656c 662e 6d61 706e  kdir + self.mapn
-00050be0: 616d 6520 2b20 275f 7261 775f 6d6d 6673  ame + '_raw_mmfs
-00050bf0: 632e 6a73 6f6e 272c 2027 7727 2c0a 2020  c.json', 'w',.  
-00050c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000506d0: 2020 2020 7072 696e 7428 2743 6f6c 6f72      print('Color
+000506e0: 6564 206d 6f64 656c 7320 6261 7365 6420  ed models based 
+000506f0: 6f6e 2043 4343 2077 6572 6520 7072 6f64  on CCC were prod
+00050700: 7563 6564 2e27 290a 2020 2020 2020 2020  uced.').        
+00050710: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+00050720: 7074 2073 7562 7072 6f63 6573 732e 4361  pt subprocess.Ca
+00050730: 6c6c 6564 5072 6f63 6573 7345 7272 6f72  lledProcessError
+00050740: 2061 7320 7375 6265 7272 3a0a 2020 2020   as suberr:.    
+00050750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050760: 2020 2020 6572 7220 3d20 2753 6176 696e      err = 'Savin
+00050770: 6720 6d6f 6465 6c20 7b7d 2043 4343 2076  g model {} CCC v
+00050780: 6965 7720 6572 726f 723a 207b 7d2e 272e  iew error: {}.'.
+00050790: 666f 726d 6174 286d 6f64 656c 6e61 6d65  format(modelname
+000507a0: 2c20 7375 6265 7272 290a 2020 2020 2020  , suberr).      
+000507b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000507c0: 2020 6572 726c 6973 742e 6170 7065 6e64    errlist.append
+000507d0: 2865 7272 290a 2020 2020 2020 2020 2020  (err).          
+000507e0: 2020 2020 2020 2020 2020 2020 2020 7379                sy
+000507f0: 732e 7374 6465 7272 2e77 7269 7465 2865  s.stderr.write(e
+00050800: 7272 202b 2027 5c6e 2729 0a0a 2020 2020  rr + '\n')..    
+00050810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050820: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00050830: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00050840: 662e 7363 616c 655f 7375 7266 6163 6576  f.scale_surfacev
+00050850: 6965 7728 290a 2020 2020 2020 2020 2020  iew().          
+00050860: 2020 2020 2020 2020 2020 6578 6365 7074            except
+00050870: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00050880: 2020 2020 2020 2020 2020 6572 7220 3d20            err = 
+00050890: 2753 6361 6c69 6e67 206d 6f64 656c 2043  'Scaling model C
+000508a0: 4343 2076 6965 7720 6572 726f 723a 207b  CC view error: {
+000508b0: 7d2e 272e 666f 726d 6174 2873 7973 2e65  }.'.format(sys.e
+000508c0: 7863 5f69 6e66 6f28 295b 315d 290a 2020  xc_info()[1]).  
+000508d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000508e0: 2020 2020 2020 6572 726c 6973 742e 6170        errlist.ap
+000508f0: 7065 6e64 2865 7272 290a 2020 2020 2020  pend(err).      
+00050900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050910: 2020 7379 732e 7374 6465 7272 2e77 7269    sys.stderr.wri
+00050920: 7465 2865 7272 202b 2027 5c6e 2729 0a0a  te(err + '\n')..
+00050930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050940: 2020 2020 6a70 6567 7320 3d20 676c 6f62      jpegs = glob
+00050950: 2e67 6c6f 6228 7365 6c66 2e77 6f72 6b64  .glob(self.workd
+00050960: 6972 202b 2027 2f2a 6363 6373 7572 6661  ir + '/*cccsurfa
+00050970: 6365 2e6a 7065 6727 290a 2020 2020 2020  ce.jpeg').      
+00050980: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
+00050990: 6465 6c73 7572 6620 3d20 6469 6374 2829  delsurf = dict()
+000509a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000509b0: 2020 2020 2066 696e 616c 6d6d 6469 6374       finalmmdict
+000509c0: 203d 2064 6963 7428 290a 2020 2020 2020   = dict().      
+000509d0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+000509e0: 2073 656c 662e 6d6f 6465 6c73 3a0a 2020   self.models:.  
+000509f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050a00: 2020 2020 2020 2320 7072 696e 7420 2273        # print "s
+00050a10: 656c 662e 6d6f 6465 6c73 3a25 7322 2025  elf.models:%s" %
+00050a20: 2073 656c 662e 6d6f 6465 6c73 0a20 2020   self.models.   
+00050a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050a40: 2020 2020 2066 6f72 206d 6f64 656c 2069       for model i
+00050a50: 6e20 7365 6c66 2e6d 6f64 656c 733a 0a20  n self.models:. 
+00050a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050a70: 2020 2020 2020 2020 2020 206d 6f64 656c             model
+00050a80: 6e61 6d65 203d 206f 732e 7061 7468 2e62  name = os.path.b
+00050a90: 6173 656e 616d 6528 6d6f 6465 6c2e 6669  asename(model.fi
+00050aa0: 6c65 6e61 6d65 290a 2020 2020 2020 2020  lename).        
+00050ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050ac0: 2020 2020 7375 7266 6163 6566 6e20 3d20      surfacefn = 
+00050ad0: 277b 7d5f 7b7d 272e 666f 726d 6174 286d  '{}_{}'.format(m
+00050ae0: 6f64 656c 6e61 6d65 2c20 7365 6c66 2e6d  odelname, self.m
+00050af0: 6170 6e61 6d65 290a 2020 2020 2020 2020  apname).        
+00050b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050b10: 2020 2020 6d6f 6465 6c6d 6170 7375 7266      modelmapsurf
+00050b20: 6163 6520 3d20 6469 6374 2829 0a20 2020  ace = dict().   
+00050b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050b40: 2020 2020 2020 2020 2066 6f72 206a 7065           for jpe
+00050b50: 6720 696e 206a 7065 6773 3a0a 2020 2020  g in jpegs:.    
+00050b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050b70: 2020 2020 2020 2020 2020 2020 6966 206d              if m
+00050b80: 6f64 656c 6e61 6d65 2069 6e20 6a70 6567  odelname in jpeg
+00050b90: 2061 6e64 2027 7863 6363 2720 696e 206a   and 'xccc' in j
+00050ba0: 7065 673a 0a20 2020 2020 2020 2020 2020  peg:.           
+00050bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050bc0: 2020 2020 2020 2020 206d 6f64 656c 6d61           modelma
+00050bd0: 7073 7572 6661 6365 5b27 7827 5d20 3d20  psurface['x'] = 
+00050be0: 7374 7228 7375 7266 6163 6566 6e29 202b  str(surfacefn) +
+00050bf0: 2027 5f73 6361 6c65 645f 7863 6363 7375   '_scaled_xcccsu
+00050c00: 7266 6163 652e 6a70 6567 270a 2020 2020  rface.jpeg'.    
 00050c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050c20: 2020 2020 2020 2065 6e63 6f64 696e 673d         encoding=
-00050c30: 2775 7466 2d38 2729 2061 7320 663a 0a20  'utf-8') as f:. 
-00050c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050c50: 2020 2020 2020 2020 2020 206a 736f 6e2e             json.
-00050c60: 6475 6d70 2872 6177 5f72 6573 756c 745f  dump(raw_result_
-00050c70: 6469 6374 2c20 6629 0a20 2020 2020 2020  dict, f).       
-00050c80: 2020 2020 2020 2020 2020 2020 2065 7863               exc
-00050c90: 6570 743a 0a20 2020 2020 2020 2020 2020  ept:.           
-00050ca0: 2020 2020 2020 2020 2020 2020 2073 7973               sys
-00050cb0: 2e73 7464 6572 722e 7772 6974 6528 2753  .stderr.write('S
-00050cc0: 6176 696e 6720 746f 2072 6177 206d 6d46  aving to raw mmF
-00050cd0: 5343 206a 736f 6e20 6572 726f 723a 207b  SC json error: {
-00050ce0: 7d2e 5c6e 272e 666f 726d 6174 2873 7973  }.\n'.format(sys
-00050cf0: 2e65 7863 5f69 6e66 6f28 295b 315d 2929  .exc_info()[1]))
-00050d00: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00050d10: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00050d20: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-00050d30: 7428 2752 6177 206d 6170 206d 6d46 5343  t('Raw map mmFSC
-00050d40: 2077 6173 206e 6f74 2063 6f6c 6c65 6374   was not collect
-00050d50: 6564 2c20 706c 6561 7365 2063 6865 636b  ed, please check
-00050d60: 2074 6865 2065 7272 6f72 2127 290a 0a20   the error!').. 
-00050d70: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00050d80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00050d90: 2070 7269 6e74 2827 4e6f 206d 6f64 656c   print('No model
-00050da0: 2121 2729 0a20 2020 2020 2020 2020 2020  !!').           
-00050db0: 2020 2020 2070 7269 6e74 2827 2d2d 2d2d       print('----
-00050dc0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00050dd0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00050de0: 2729 0a0a 2020 2020 2020 2020 7265 7475  ')..        retu
-00050df0: 726e 204e 6f6e 650a 0a20 2020 2064 6566  rn None..    def
-00050e00: 206c 6f63 7265 735f 7265 736d 6170 2873   locres_resmap(s
-00050e10: 656c 6629 3a0a 2020 2020 2020 2020 2222  elf):.        ""
-00050e20: 220a 2020 2020 2020 2020 2020 2020 4361  ".            Ca
-00050e30: 6c63 756c 6174 6520 6c6f 6361 6c20 7265  lculate local re
-00050e40: 736f 6c75 7469 6f6e 2062 7920 7573 696e  solution by usin
-00050e50: 6720 5265 736d 6170 0a20 2020 2020 2020  g Resmap.       
-00050e60: 203a 7265 7475 726e 3a0a 2020 2020 2020   :return:.      
-00050e70: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
-00050e80: 2073 656c 662e 706c 6174 666f 726d 203d   self.platform =
-00050e90: 3d20 2765 6d64 6227 2061 6e64 2073 656c  = 'emdb' and sel
-00050ea0: 662e 6d65 7420 213d 2027 746f 6d6f 273a  f.met != 'tomo':
-00050eb0: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
-00050ec0: 7274 203d 2074 696d 6569 742e 6465 6661  rt = timeit.defa
-00050ed0: 756c 745f 7469 6d65 7228 290a 2020 2020  ult_timer().    
-00050ee0: 2020 2020 2020 2020 6572 726c 6973 7420          errlist 
-00050ef0: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
-00050f00: 2072 6573 756c 745f 6469 6374 203d 207b   result_dict = {
-00050f10: 7d0a 2020 2020 2020 2020 2020 2020 2320  }.            # 
-00050f20: 6966 2073 7472 7564 656c 6170 7020 616e  if strudelapp an
-00050f30: 6420 7365 6c66 2e6d 6f64 656c 733a 0a20  d self.models:. 
-00050f40: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-00050f50: 6c66 2e68 6d65 7665 6e20 616e 6420 7365  lf.hmeven and se
-00050f60: 6c66 2e68 6d6f 6464 3a0a 2020 2020 2020  lf.hmodd:.      
-00050f70: 2020 2020 2020 2020 2020 6576 656e 203d            even =
-00050f80: 2073 656c 662e 686d 6576 656e 2e66 756c   self.hmeven.ful
-00050f90: 6c6e 616d 650a 2020 2020 2020 2020 2020  lname.          
-00050fa0: 2020 2020 2020 6f64 6420 3d20 7365 6c66        odd = self
-00050fb0: 2e68 6d6f 6464 2e66 756c 6c6e 616d 650a  .hmodd.fullname.
+00050c20: 2020 2020 2020 2020 2020 2020 6966 206d              if m
+00050c30: 6f64 656c 6e61 6d65 2069 6e20 6a70 6567  odelname in jpeg
+00050c40: 2061 6e64 2027 7963 6363 2720 696e 206a   and 'yccc' in j
+00050c50: 7065 673a 0a20 2020 2020 2020 2020 2020  peg:.           
+00050c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050c70: 2020 2020 2020 2020 206d 6f64 656c 6d61           modelma
+00050c80: 7073 7572 6661 6365 5b27 7927 5d20 3d20  psurface['y'] = 
+00050c90: 7374 7228 7375 7266 6163 6566 6e29 202b  str(surfacefn) +
+00050ca0: 2027 5f73 6361 6c65 645f 7963 6363 7375   '_scaled_ycccsu
+00050cb0: 7266 6163 652e 6a70 6567 270a 2020 2020  rface.jpeg'.    
+00050cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050cd0: 2020 2020 2020 2020 2020 2020 6966 206d              if m
+00050ce0: 6f64 656c 6e61 6d65 2069 6e20 6a70 6567  odelname in jpeg
+00050cf0: 2061 6e64 2027 7a63 6363 2720 696e 206a   and 'zccc' in j
+00050d00: 7065 673a 0a20 2020 2020 2020 2020 2020  peg:.           
+00050d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050d20: 2020 2020 2020 2020 206d 6f64 656c 6d61           modelma
+00050d30: 7073 7572 6661 6365 5b27 7a27 5d20 3d20  psurface['z'] = 
+00050d40: 7374 7228 7375 7266 6163 6566 6e29 202b  str(surfacefn) +
+00050d50: 2027 5f73 6361 6c65 645f 7a63 6363 7375   '_scaled_zcccsu
+00050d60: 7266 6163 652e 6a70 6567 270a 2020 2020  rface.jpeg'.    
+00050d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050d80: 2020 2020 2020 2020 6966 2065 7272 6c69          if errli
+00050d90: 7374 3a0a 2020 2020 2020 2020 2020 2020  st:.            
+00050da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050db0: 2020 2020 6d6f 6465 6c6d 6170 7375 7266      modelmapsurf
+00050dc0: 6163 655b 2765 7272 275d 203d 207b 2763  ace['err'] = {'c
+00050dd0: 6363 5f65 7272 273a 2065 7272 6c69 7374  cc_err': errlist
+00050de0: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+00050df0: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
+00050e00: 6465 6c73 7572 665b 6d6f 6465 6c6e 616d  delsurf[modelnam
+00050e10: 655d 203d 206d 6f64 656c 6d61 7073 7572  e] = modelmapsur
+00050e20: 6661 6365 0a20 2020 2020 2020 2020 2020  face.           
+00050e30: 2020 2020 2020 2020 2020 2020 2066 696e               fin
+00050e40: 616c 6d6d 6469 6374 5b27 6363 6373 636f  almmdict['cccsco
+00050e50: 7265 5f73 7572 6661 6365 275d 203d 206d  re_surface'] = m
+00050e60: 6f64 656c 7375 7266 0a0a 2020 2020 2020  odelsurf..      
+00050e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050e80: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00050e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050ea0: 2020 2077 6974 6820 636f 6465 6373 2e6f     with codecs.o
+00050eb0: 7065 6e28 7365 6c66 2e77 6f72 6b64 6972  pen(self.workdir
+00050ec0: 202b 2073 656c 662e 6d61 706e 616d 6520   + self.mapname 
+00050ed0: 2b20 275f 6363 6376 6965 772e 6a73 6f6e  + '_cccview.json
+00050ee0: 272c 2027 7727 2c0a 2020 2020 2020 2020  ', 'w',.        
+00050ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050f10: 2020 2020 2065 6e63 6f64 696e 673d 2775       encoding='u
+00050f20: 7466 2d38 2729 2061 7320 663a 0a20 2020  tf-8') as f:.   
+00050f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050f40: 2020 2020 2020 2020 2020 2020 206a 736f               jso
+00050f50: 6e2e 6475 6d70 2866 696e 616c 6d6d 6469  n.dump(finalmmdi
+00050f60: 6374 2c20 6629 0a20 2020 2020 2020 2020  ct, f).         
+00050f70: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00050f80: 7863 6570 743a 0a20 2020 2020 2020 2020  xcept:.         
+00050f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00050fa0: 2020 2073 7973 2e73 7464 6572 722e 7772     sys.stderr.wr
+00050fb0: 6974 6528 0a20 2020 2020 2020 2020 2020  ite(.           
 00050fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00050fd0: 6675 6c6c 5f6d 6170 203d 2027 7b7d 7b7d  full_map = '{}{}
-00050fe0: 272e 666f 726d 6174 2873 656c 662e 776f  '.format(self.wo
-00050ff0: 726b 6469 722c 2073 656c 662e 6d61 706e  rkdir, self.mapn
-00051000: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
-00051010: 2020 2020 206f 7574 5f70 6174 6820 3d20       out_path = 
-00051020: 277b 7d5f 7265 6c69 6f6e 272e 666f 726d  '{}_relion'.form
-00051030: 6174 2866 756c 6c5f 6d61 7029 0a20 2020  at(full_map).   
-00051040: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-00051050: 6e74 286f 7574 5f70 6174 6829 0a20 2020  nt(out_path).   
-00051060: 2020 2020 2020 2020 2020 2020 2061 6c6c               all
-00051070: 7265 7375 6c74 7320 3d20 7b7d 0a20 2020  results = {}.   
-00051080: 2020 2020 2020 2020 2020 2020 2074 7279               try
-00051090: 3a0a 0a20 2020 2020 2020 2020 2020 2020  :..             
-000510a0: 2020 2020 2020 2023 2072 6572 7220 3d20         # rerr = 
-000510b0: 7275 6e5f 7265 736d 6170 286f 6464 2c20  run_resmap(odd, 
-000510c0: 6576 656e 2c20 6f75 745f 7061 7468 2c20  even, out_path, 
-000510d0: 5245 534d 4150 290a 2020 2020 2020 2020  RESMAP).        
-000510e0: 2020 2020 2020 2020 2020 2020 7265 7272              rerr
-000510f0: 203d 2072 756e 5f6c 6f63 7265 7328 6f64   = run_locres(od
-00051100: 642c 2065 7665 6e2c 206f 7574 5f70 6174  d, even, out_pat
-00051110: 682c 2052 4553 4d41 5029 0a20 2020 2020  h, RESMAP).     
-00051120: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00051130: 6e64 203d 2074 696d 6569 742e 6465 6661  nd = timeit.defa
-00051140: 756c 745f 7469 6d65 7228 290a 2020 2020  ult_timer().    
-00051150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051160: 7072 696e 7428 274c 6f63 616c 2072 6573  print('Local res
-00051170: 6f6c 7574 696f 6e20 5265 734d 6170 2074  olution ResMap t
-00051180: 696d 653a 2025 7327 2025 2028 656e 6420  ime: %s' % (end 
-00051190: 2d20 7374 6172 7429 290a 2020 2020 2020  - start)).      
-000511a0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-000511b0: 696e 7428 272d 2d2d 2d2d 2d2d 2d2d 2d2d  int('-----------
-000511c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-000511d0: 2d2d 2d2d 2d2d 2d2d 2d27 290a 2020 2020  ---------').    
-000511e0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-000511f0: 7074 3a0a 2020 2020 2020 2020 2020 2020  pt:.            
-00051200: 2020 2020 2020 2020 6572 7220 3d20 2752          err = 'R
-00051210: 6573 4d61 7020 6361 6c63 756c 6174 696f  esMap calculatio
-00051220: 6e20 6572 726f 723a 207b 7d2e 272e 666f  n error: {}.'.fo
-00051230: 726d 6174 2873 7973 2e65 7863 5f69 6e66  rmat(sys.exc_inf
-00051240: 6f28 295b 315d 290a 2020 2020 2020 2020  o()[1]).        
-00051250: 2020 2020 2020 2020 2020 2020 6572 726c              errl
-00051260: 6973 742e 6170 7065 6e64 2865 7272 290a  ist.append(err).
-00051270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051280: 2020 2020 7379 732e 7374 6465 7272 2e77      sys.stderr.w
-00051290: 7269 7465 2865 7272 202b 2027 5c6e 2729  rite(err + '\n')
-000512a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000512b0: 2023 2063 6865 636b 203d 2072 6573 6d61   # check = resma
-000512c0: 705f 6669 6c65 6368 6563 6b28 6f64 642c  p_filecheck(odd,
-000512d0: 2073 656c 662e 776f 726b 6469 7229 0a20   self.workdir). 
-000512e0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-000512f0: 6865 636b 203d 206c 6f63 7265 735f 6669  heck = locres_fi
-00051300: 6c65 6368 6563 6b28 6f64 642c 2065 7665  lecheck(odd, eve
-00051310: 6e2c 206f 7574 5f70 6174 6829 0a20 2020  n, out_path).   
-00051320: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00051330: 6368 6563 6b3a 0a20 2020 2020 2020 2020  check:.         
-00051340: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-00051350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051360: 2020 2020 2020 2020 7265 736d 6170 5f63          resmap_c
-00051370: 6869 6d65 7261 785f 6669 6c65 203d 2072  himerax_file = r
-00051380: 6573 6d61 705f 6368 696d 6572 6178 286f  esmap_chimerax(o
-00051390: 6464 2c20 7365 6c66 2e77 6f72 6b64 6972  dd, self.workdir
-000513a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000513b0: 2020 2020 2020 2020 2020 6966 206f 732e            if os.
-000513c0: 7061 7468 2e69 7366 696c 6528 7265 736d  path.isfile(resm
-000513d0: 6170 5f63 6869 6d65 7261 785f 6669 6c65  ap_chimerax_file
-000513e0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000513f0: 2020 2020 2020 2020 2020 2020 2020 2076                 v
-00051400: 746b 7061 636b 2c20 6368 696d 6572 6161  tkpack, chimeraa
-00051410: 7070 203d 2073 656c 662e 7375 7266 6163  pp = self.surfac
-00051420: 655f 656e 7663 6865 636b 2829 0a20 2020  e_envcheck().   
-00051430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051440: 2020 2020 2020 2020 2062 696e 6469 7370           bindisp
-00051450: 6c61 7920 3d20 6f73 2e67 6574 656e 7628  lay = os.getenv(
-00051460: 2744 4953 504c 4159 2729 0a20 2020 2020  'DISPLAY').     
-00051470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051480: 2020 2020 2020 2072 756e 5f72 6573 6d61         run_resma
-00051490: 705f 6368 696d 6572 6178 2862 696e 6469  p_chimerax(bindi
-000514a0: 7370 6c61 792c 2063 6869 6d65 7261 6170  splay, chimeraap
-000514b0: 702c 2072 6573 6d61 705f 6368 696d 6572  p, resmap_chimer
-000514c0: 6178 5f66 696c 6529 0a20 2020 2020 2020  ax_file).       
-000514d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000514e0: 2020 2020 2023 2072 6573 6d61 7020 3d20       # resmap = 
-000514f0: 277b 7d5f 6f72 695f 7265 736d 6170 2e6d  '{}_ori_resmap.m
-00051500: 6170 272e 666f 726d 6174 286f 6464 5b3a  ap'.format(odd[:
-00051510: 2d34 5d29 0a20 2020 2020 2020 2020 2020  -4]).           
-00051520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051530: 2023 206f 7574 7075 745f 6a73 6f6e 203d   # output_json =
-00051540: 2027 7b7d 7b7d 5f72 6573 6d61 702e 6a73   '{}{}_resmap.js
-00051550: 6f6e 272e 666f 726d 6174 2873 656c 662e  on'.format(self.
-00051560: 776f 726b 6469 722c 2073 656c 662e 6d61  workdir, self.ma
-00051570: 706e 616d 6529 0a20 2020 2020 2020 2020  pname).         
-00051580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051590: 2020 2023 2073 6176 655f 696d 6167 6573     # save_images
-000515a0: 746f 6a73 6f6e 2872 6573 6d61 702c 206f  tojson(resmap, o
-000515b0: 7574 7075 745f 6a73 6f6e 290a 2020 2020  utput_json).    
-000515c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000515d0: 6578 6365 7074 3a0a 2020 2020 2020 2020  except:.        
-000515e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000515f0: 6572 7220 3d20 2752 6573 4d61 7020 7669  err = 'ResMap vi
-00051600: 6577 7320 6572 726f 723a 207b 7d2e 272e  ews error: {}.'.
-00051610: 666f 726d 6174 2873 7973 2e65 7863 5f69  format(sys.exc_i
-00051620: 6e66 6f28 295b 315d 290a 2020 2020 2020  nfo()[1]).      
-00051630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051640: 2020 6572 726c 6973 742e 6170 7065 6e64    errlist.append
-00051650: 2865 7272 290a 2020 2020 2020 2020 2020  (err).          
-00051660: 2020 2020 2020 2020 2020 2020 2020 7379                sy
-00051670: 732e 7374 6465 7272 2e77 7269 7465 2865  s.stderr.write(e
-00051680: 7272 202b 2027 5c6e 2729 0a20 2020 2020  rr + '\n').     
-00051690: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-000516a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000516b0: 2020 2020 2070 7269 6e74 2827 4368 696d       print('Chim
-000516c0: 6572 6178 2066 696c 6520 646f 6573 206e  erax file does n
-000516d0: 6f74 2065 7869 7374 2e20 4368 6563 6b21  ot exist. Check!
-000516e0: 2127 290a 0a20 2020 2020 2020 2020 2020  !')..           
-000516f0: 2020 2020 2069 6620 6572 726c 6973 743a       if errlist:
-00051700: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00051710: 2020 2020 2072 6573 756c 745f 6469 6374       result_dict
-00051720: 5b27 6572 7227 5d20 3d20 6572 726c 6973  ['err'] = errlis
-00051730: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
-00051740: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00051750: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-00051760: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00051770: 2020 2020 2020 2020 2072 6573 6d61 7020           resmap 
-00051780: 3d20 277b 7d5f 6f72 695f 7265 736d 6170  = '{}_ori_resmap
-00051790: 2e6d 6170 272e 666f 726d 6174 286f 6464  .map'.format(odd
-000517a0: 5b3a 2d34 5d29 0a20 2020 2020 2020 2020  [:-4]).         
-000517b0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-000517c0: 7574 7075 745f 6a73 6f6e 203d 2027 7b7d  utput_json = '{}
-000517d0: 7b7d 5f72 6573 6d61 702e 6a73 6f6e 272e  {}_resmap.json'.
-000517e0: 666f 726d 6174 2873 656c 662e 776f 726b  format(self.work
-000517f0: 6469 722c 2073 656c 662e 6d61 706e 616d  dir, self.mapnam
-00051800: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-00051810: 2020 2020 2020 2020 2020 2073 6176 655f             save_
-00051820: 696d 6167 6573 746f 6a73 6f6e 2872 6573  imagestojson(res
-00051830: 6d61 702c 206f 7574 7075 745f 6a73 6f6e  map, output_json
-00051840: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00051850: 2020 2020 2020 6578 6365 7074 3a0a 2020        except:.  
-00051860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051870: 2020 2020 2020 7379 732e 7374 6465 7272        sys.stderr
-00051880: 2e77 7269 7465 2827 5361 7669 6e67 2074  .write('Saving t
-00051890: 6f20 7265 736d 6170 206a 736f 6e20 6572  o resmap json er
-000518a0: 726f 723a 207b 7d2e 5c6e 272e 666f 726d  ror: {}.\n'.form
-000518b0: 6174 2873 7973 2e65 7863 5f69 6e66 6f28  at(sys.exc_info(
-000518c0: 295b 315d 2929 0a20 2020 2020 2020 2020  )[1])).         
-000518d0: 2020 2020 2020 2065 6e64 203d 2074 696d         end = tim
-000518e0: 6569 742e 6465 6661 756c 745f 7469 6d65  eit.default_time
-000518f0: 7228 290a 2020 2020 2020 2020 2020 2020  r().            
-00051900: 2020 2020 7072 696e 7428 2757 686f 6c65      print('Whole
-00051910: 2052 6573 4d61 7020 6c6f 6361 6c20 7265   ResMap local re
-00051920: 736f 6c75 7469 6f6e 2074 696d 653a 2025  solution time: %
-00051930: 7327 2025 2028 656e 6420 2d20 7374 6172  s' % (end - star
-00051940: 7429 290a 2020 2020 2020 2020 2020 2020  t)).            
-00051950: 2020 2020 7072 696e 7428 272d 2d2d 2d2d      print('-----
-00051960: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00051970: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d27  ---------------'
-00051980: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
-00051990: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-000519a0: 2020 2020 7072 696e 7428 274e 6f20 6861      print('No ha
-000519b0: 6c66 206d 6170 7320 5265 734d 6170 206c  lf maps ResMap l
-000519c0: 6f63 616c 2072 6573 6f6c 7574 696f 6e20  ocal resolution 
-000519d0: 7769 6c6c 206e 6f74 2062 6520 6361 6c63  will not be calc
-000519e0: 756c 6174 6564 2e20 2729 0a20 2020 2020  ulated. ').     
-000519f0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00051a00: 2827 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ('--------------
-00051a10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00051a20: 2d2d 2d2d 2d2d 2729 0a0a 2020 2020 2020  ------')..      
-00051a30: 2020 7265 7475 726e 204e 6f6e 650a 0a0a    return None...
-00051a40: 2020 2020 6465 6620 6c6f 6372 6573 5f68      def locres_h
-00051a50: 6973 746f 2873 656c 6629 3a0a 2020 2020  isto(self):.    
-00051a60: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00051a70: 2020 2020 5072 6f64 7563 6520 6c6f 6361      Produce loca
-00051a80: 6c20 7265 736f 6c75 7469 6f6e 2068 6973  l resolution his
-00051a90: 746f 6772 616d 2069 6e66 6f72 6d61 7469  togram informati
-00051aa0: 6f6e 0a20 2020 2020 2020 2022 2222 0a0a  on.        """..
-00051ab0: 2020 2020 2020 2020 7265 7375 6c74 5f64          result_d
-00051ac0: 6963 7420 3d20 7b7d 0a20 2020 2020 2020  ict = {}.       
-00051ad0: 2065 7272 6c69 7374 203d 205b 5d0a 2020   errlist = [].  
-00051ae0: 2020 2020 2020 7374 6172 7420 3d20 7469        start = ti
-00051af0: 6d65 6974 2e64 6566 6175 6c74 5f74 696d  meit.default_tim
-00051b00: 6572 2829 0a20 2020 2020 2020 2069 6620  er().        if 
-00051b10: 7365 6c66 2e70 6c61 7466 6f72 6d20 3d3d  self.platform ==
-00051b20: 2027 656d 6462 2720 616e 6420 7365 6c66   'emdb' and self
-00051b30: 2e6d 6574 2021 3d20 2774 6f6d 6f27 2061  .met != 'tomo' a
-00051b40: 6e64 2073 656c 662e 686d 6f64 6420 616e  nd self.hmodd an
-00051b50: 6420 7365 6c66 2e68 6d65 7665 6e3a 0a20  d self.hmeven:. 
-00051b60: 2020 2020 2020 2020 2020 206c 6f63 616c             local
-00051b70: 5f72 6573 203d 206c 6f63 616c 7265 735f  _res = localres_
-00051b80: 6869 7374 6f67 7261 6d28 7365 6c66 2e68  histogram(self.h
-00051b90: 6d6f 6464 2e66 756c 6c6e 616d 652c 2073  modd.fullname, s
-00051ba0: 656c 662e 6d61 706e 616d 652c 2066 6c6f  elf.mapname, flo
-00051bb0: 6174 2873 656c 662e 7265 736f 6c75 7469  at(self.resoluti
-00051bc0: 6f6e 2929 0a20 2020 2020 2020 2065 6c73  on)).        els
-00051bd0: 653a 0a20 2020 2020 2020 2020 2020 206c  e:.            l
-00051be0: 6f63 616c 5f72 6573 203d 204e 6f6e 650a  ocal_res = None.
-00051bf0: 0a20 2020 2020 2020 2069 6620 6c6f 6361  .        if loca
-00051c00: 6c5f 7265 733a 0a20 2020 2020 2020 2020  l_res:.         
-00051c10: 2020 2072 6573 756c 745f 6469 6374 5b27     result_dict['
-00051c20: 6c6f 6361 6c5f 7265 735f 6869 7374 6f67  local_res_histog
-00051c30: 7261 6d27 5d20 3d20 6c6f 6361 6c5f 7265  ram'] = local_re
-00051c40: 730a 2020 2020 2020 2020 2020 2020 7472  s.            tr
-00051c50: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-00051c60: 2020 2077 6974 6820 636f 6465 6373 2e6f     with codecs.o
-00051c70: 7065 6e28 7365 6c66 2e77 6f72 6b64 6972  pen(self.workdir
-00051c80: 202b 2073 656c 662e 6d61 706e 616d 6520   + self.mapname 
-00051c90: 2b20 275f 6c6f 6361 6c72 6573 5f68 6973  + '_localres_his
-00051ca0: 746f 2e6a 736f 6e27 2c20 2777 272c 0a20  to.json', 'w',. 
-00051cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00051cd0: 656e 636f 6469 6e67 3d27 7574 662d 3827  encoding='utf-8'
-00051ce0: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
-00051cf0: 2020 2020 2020 2020 2020 2020 6a73 6f6e              json
-00051d00: 2e64 756d 7028 7265 7375 6c74 5f64 6963  .dump(result_dic
-00051d10: 742c 2066 290a 2020 2020 2020 2020 2020  t, f).          
-00051d20: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
-00051d30: 6f6e 2061 7320 653a 0a20 2020 2020 2020  on as e:.       
-00051d40: 2020 2020 2020 2020 206a 736f 6e65 7272           jsonerr
-00051d50: 203d 2027 5361 7669 6e67 206c 6f63 616c   = 'Saving local
-00051d60: 2072 6573 6f6c 7574 696f 6e20 6869 7374   resolution hist
-00051d70: 6f67 7261 6d20 746f 206a 736f 6e20 6572  ogram to json er
-00051d80: 726f 723a 207b 7d27 2e66 6f72 6d61 7428  ror: {}'.format(
-00051d90: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-00051da0: 2020 2065 7272 6c69 7374 2e61 7070 656e     errlist.appen
-00051db0: 6428 6a73 6f6e 6572 7229 0a20 2020 2020  d(jsonerr).     
-00051dc0: 2020 2020 2020 2020 2020 2073 7973 2e73             sys.s
-00051dd0: 7464 6572 722e 7772 6974 6528 6a73 6f6e  tderr.write(json
-00051de0: 6572 7220 2b20 275c 6e27 290a 2020 2020  err + '\n').    
-00051df0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00051e00: 2020 2020 2020 7072 696e 7428 274e 6f20        print('No 
-00051e10: 6c6f 6361 6c20 7265 736f 6c75 7469 6f6e  local resolution
-00051e20: 2068 6973 746f 6772 616d 2066 6f72 2074   histogram for t
-00051e30: 6869 7320 656e 7472 792c 2063 6865 636b  his entry, check
-00051e40: 2068 616c 6620 6d61 7073 2e27 290a 2020   half maps.').  
-00051e50: 2020 2020 2020 656e 6420 3d20 7469 6d65        end = time
-00051e60: 6974 2e64 6566 6175 6c74 5f74 696d 6572  it.default_timer
-00051e70: 2829 0a20 2020 2020 2020 2070 7269 6e74  ().        print
-00051e80: 2866 274c 6f63 616c 2072 6573 6f6c 7574  (f'Local resolut
-00051e90: 696f 6e20 7469 6d65 3a20 7b65 6e64 202d  ion time: {end -
-00051ea0: 2073 7461 7274 7d27 290a 2020 2020 2020   start}').      
-00051eb0: 2020 7072 696e 7428 272d 2d2d 2d2d 2d2d    print('-------
-00051ec0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00051ed0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d27 290a  -------------').
-00051ee0: 0a20 2020 2023 2050 6861 7365 2072 616e  .    # Phase ran
-00051ef0: 6469 6d69 7a61 7469 6f6e 0a20 2020 2064  dimization.    d
-00051f00: 6566 2070 6872 616e 6428 7365 6c66 293a  ef phrand(self):
-00051f10: 0a0a 2020 2020 2020 2020 7068 6173 6572  ..        phaser
-00051f20: 616e 646f 6d69 7a61 7469 6f6e 2873 656c  andomization(sel
-00051f30: 662e 6d61 706e 616d 652c 2073 656c 662e  f.mapname, self.
-00051f40: 686d 6f64 642e 6675 6c6c 6e61 6d65 2c20  hmodd.fullname, 
-00051f50: 7365 6c66 2e68 6d65 7665 6e2e 6675 6c6c  self.hmeven.full
-00051f60: 6e61 6d65 2c20 7365 6c66 2e77 6f72 6b64  name, self.workd
-00051f70: 6972 290a 0a0a 2020 2020 6465 6620 636c  ir)...    def cl
-00051f80: 5f70 7265 6469 6374 696f 6e28 7365 6c66  _prediction(self
-00051f90: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
-00051fa0: 2020 2020 2020 2020 2020 2054 6f20 7072             To pr
-00051fb0: 6564 6963 6174 6520 636f 6e74 6f75 7220  edicate contour 
-00051fc0: 6c65 7665 6c20 666f 7220 626f 7468 2070  level for both p
-00051fd0: 7269 6d61 7279 206d 6170 2061 6e64 2072  rimary map and r
-00051fe0: 6177 206d 6170 206f 7574 7075 7420 6173  aw map output as
-00051ff0: 206a 736f 6e20 6669 6c65 0a20 2020 2020   json file.     
-00052000: 2020 2022 2222 0a0a 2020 2020 2020 2020     """..        
-00052010: 7072 6564 5f70 7269 6d61 7279 203d 207b  pred_primary = {
-00052020: 7d0a 2020 2020 2020 2020 7072 6564 5f72  }.        pred_r
-00052030: 6177 203d 207b 7d0a 2020 2020 2020 2020  aw = {}.        
-00052040: 6966 2073 656c 662e 6d61 702e 6675 6c6c  if self.map.full
-00052050: 6e61 6d65 3a0a 2020 2020 2020 2020 2020  name:.          
-00052060: 2020 6d20 3d20 6d72 6366 696c 652e 6f70    m = mrcfile.op
-00052070: 656e 2873 656c 662e 6d61 702e 6675 6c6c  en(self.map.full
-00052080: 6e61 6d65 290a 2020 2020 2020 2020 2020  name).          
-00052090: 2020 6420 3d20 6d2e 6461 7461 0a20 2020    d = m.data.   
-000520a0: 2020 2020 2020 2020 206e 6f72 6d5f 7072           norm_pr
-000520b0: 6564 203d 2063 616c 635f 6c65 7665 6c5f  ed = calc_level_
-000520c0: 6465 7628 6429 5b30 5d0a 2020 2020 2020  dev(d)[0].      
-000520d0: 2020 2020 2020 7072 6564 5f70 7269 6d61        pred_prima
-000520e0: 7279 5b27 7072 696d 6172 7927 5d20 3d20  ry['primary'] = 
-000520f0: 6b65 6570 5f74 6872 6565 5f73 6967 6e69  keep_three_signi
-00052100: 6669 6361 6e74 5f64 6967 6974 7328 666c  ficant_digits(fl
-00052110: 6f61 7428 6e6f 726d 5f70 7265 6429 290a  oat(norm_pred)).
-00052120: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00052130: 2e72 6177 6d61 703a 0a20 2020 2020 2020  .rawmap:.       
-00052140: 2020 2020 206d 203d 206d 7263 6669 6c65       m = mrcfile
-00052150: 2e6f 7065 6e28 7365 6c66 2e72 6177 6d61  .open(self.rawma
-00052160: 702e 6675 6c6c 6e61 6d65 290a 2020 2020  p.fullname).    
-00052170: 2020 2020 2020 2020 6420 3d20 6d2e 6461          d = m.da
-00052180: 7461 0a20 2020 2020 2020 2020 2020 206e  ta.            n
-00052190: 6f72 6d5f 7072 6564 203d 2063 616c 635f  orm_pred = calc_
-000521a0: 6c65 7665 6c5f 6465 7628 6429 5b30 5d0a  level_dev(d)[0].
-000521b0: 2020 2020 2020 2020 2020 2020 7072 6564              pred
-000521c0: 5f72 6177 5b27 7261 7727 5d20 3d20 6b65  _raw['raw'] = ke
-000521d0: 6570 5f74 6872 6565 5f73 6967 6e69 6669  ep_three_signifi
-000521e0: 6361 6e74 5f64 6967 6974 7328 666c 6f61  cant_digits(floa
-000521f0: 7428 6e6f 726d 5f70 7265 6429 290a 0a20  t(norm_pred)).. 
-00052200: 2020 2020 2020 2072 6573 756c 745f 6469         result_di
-00052210: 6374 203d 207b 7d0a 2020 2020 2020 2020  ct = {}.        
-00052220: 6966 2070 7265 645f 7072 696d 6172 7920  if pred_primary 
-00052230: 6f72 2070 7265 645f 7261 773a 0a20 2020  or pred_raw:.   
-00052240: 2020 2020 2020 2020 2072 6573 756c 745f           result_
-00052250: 6469 6374 5b27 7072 6564 6963 6174 6564  dict['predicated
-00052260: 5f63 6f6e 746f 7572 5f6c 6576 656c 275d  _contour_level']
-00052270: 203d 207b 2a2a 7072 6564 5f70 7269 6d61   = {**pred_prima
-00052280: 7279 2c20 2a2a 7072 6564 5f72 6177 7d20  ry, **pred_raw} 
-00052290: 6966 2070 7265 645f 7072 696d 6172 7920  if pred_primary 
-000522a0: 616e 6420 7072 6564 5f72 6177 205c 0a20  and pred_raw \. 
-000522b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000522c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000522d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000522e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000522f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052300: 2020 2065 6c73 6520 7072 6564 5f70 7269     else pred_pri
-00052310: 6d61 7279 206f 7220 7072 6564 5f72 6177  mary or pred_raw
-00052320: 0a20 2020 2020 2020 2020 2020 2070 7269  .            pri
-00052330: 6e74 2872 6573 756c 745f 6469 6374 290a  nt(result_dict).
-00052340: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00050fd0: 2020 2020 2027 5361 7669 6e67 2043 4343       'Saving CCC
+00050fe0: 2076 6965 7720 746f 204a 534f 4e20 6572   view to JSON er
+00050ff0: 726f 723a 207b 7d2e 5c6e 272e 666f 726d  ror: {}.\n'.form
+00051000: 6174 2873 7973 2e65 7863 5f69 6e66 6f28  at(sys.exc_info(
+00051010: 295b 315d 2929 0a0a 2020 2020 2020 2020  )[1]))..        
+00051020: 2020 2020 2020 2020 656e 6420 3d20 7469          end = ti
+00051030: 6d65 6974 2e64 6566 6175 6c74 5f74 696d  meit.default_tim
+00051040: 6572 2829 0a20 2020 2020 2020 2020 2020  er().           
+00051050: 2020 2020 2070 7269 6e74 2827 4343 4320       print('CCC 
+00051060: 7375 7266 6163 6520 7469 6d65 3a20 2573  surface time: %s
+00051070: 2720 2520 2865 6e64 202d 2073 7461 7274  ' % (end - start
+00051080: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+00051090: 2020 2070 7269 6e74 2827 2d2d 2d2d 2d2d     print('------
+000510a0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000510b0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2729  --------------')
+000510c0: 0a0a 2020 2020 6465 6620 6363 5f73 7572  ..    def cc_sur
+000510d0: 6661 6365 2873 656c 6629 3a0a 2020 2020  face(self):.    
+000510e0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+000510f0: 2020 2020 2076 746b 7061 636b 2c20 6368       vtkpack, ch
+00051100: 696d 6572 6161 7070 203d 2073 656c 662e  imeraapp = self.
+00051110: 7375 7266 6163 655f 656e 7663 6865 636b  surface_envcheck
+00051120: 2829 0a20 2020 2020 2020 2020 2020 2073  ().            s
+00051130: 656c 662e 6363 7363 6f72 6576 6965 7728  elf.ccscoreview(
+00051140: 6368 696d 6572 6161 7070 290a 2020 2020  chimeraapp).    
+00051150: 2020 2020 6578 6365 7074 3a0a 2020 2020      except:.    
+00051160: 2020 2020 2020 2020 6572 7220 3d20 2743          err = 'C
+00051170: 4343 2073 7572 6661 6365 2076 6965 7720  CC surface view 
+00051180: 6661 696c 6564 3a20 7b7d 272e 666f 726d  failed: {}'.form
+00051190: 6174 2873 7973 2e65 7863 5f69 6e66 6f28  at(sys.exc_info(
+000511a0: 295b 315d 290a 2020 2020 2020 2020 2020  )[1]).          
+000511b0: 2020 7072 696e 7428 7472 6163 6562 6163    print(tracebac
+000511c0: 6b2e 666f 726d 6174 5f65 7863 2829 290a  k.format_exc()).
+000511d0: 2020 2020 2020 2020 2020 2020 7379 732e              sys.
+000511e0: 7374 6465 7272 2e77 7269 7465 2865 7272  stderr.write(err
+000511f0: 202b 2027 5c6e 2729 0a0a 2020 2020 6465   + '\n')..    de
+00051200: 6620 7068 656e 6978 5f6d 6d66 7363 2873  f phenix_mmfsc(s
+00051210: 656c 6629 3a0a 2020 2020 2020 2020 2222  elf):.        ""
+00051220: 220a 2020 2020 2020 2020 2020 2020 5275  ".            Ru
+00051230: 6e20 5068 656e 6978 206d 6170 2d6d 6f64  n Phenix map-mod
+00051240: 656c 2046 5343 2063 616c 6375 6c61 7469  el FSC calculati
+00051250: 6f6e 0a20 2020 2020 2020 203a 7265 7475  on.        :retu
+00051260: 726e 3a0a 2020 2020 2020 2020 2222 220a  rn:.        """.
+00051270: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+00051280: 2e70 6c61 7466 6f72 6d20 3d3d 2027 656d  .platform == 'em
+00051290: 6462 2720 616e 6420 7365 6c66 2e6d 6574  db' and self.met
+000512a0: 2021 3d20 2774 6f6d 6f27 2061 6e64 2073   != 'tomo' and s
+000512b0: 656c 662e 6d65 7420 213d 2027 6372 7973  elf.met != 'crys
+000512c0: 2720 3a0a 2020 2020 2020 2020 2020 2020  ' :.            
+000512d0: 7374 6172 7420 3d20 7469 6d65 6974 2e64  start = timeit.d
+000512e0: 6566 6175 6c74 5f74 696d 6572 2829 0a20  efault_timer(). 
+000512f0: 2020 2020 2020 2020 2020 2065 7272 6c69             errli
+00051300: 7374 203d 205b 5d0a 2020 2020 2020 2020  st = [].        
+00051310: 2020 2020 7265 7375 6c74 5f64 6963 7420      result_dict 
+00051320: 3d20 7b7d 0a20 2020 2020 2020 2020 2020  = {}.           
+00051330: 2072 6177 5f72 6573 756c 745f 6469 6374   raw_result_dict
+00051340: 203d 207b 7d0a 2020 2020 2020 2020 2020   = {}.          
+00051350: 2020 2320 6966 2073 7472 7564 656c 6170    # if strudelap
+00051360: 7020 616e 6420 7365 6c66 2e6d 6f64 656c  p and self.model
+00051370: 733a 0a20 2020 2020 2020 2020 2020 2069  s:.            i
+00051380: 6620 7365 6c66 2e6d 6f64 656c 733a 0a20  f self.models:. 
+00051390: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+000513a0: 756d 6d6f 6465 6c73 203d 2030 0a20 2020  ummodels = 0.   
+000513b0: 2020 2020 2020 2020 2020 2020 2061 6c6c               all
+000513c0: 7265 7375 6c74 7320 3d20 7b7d 0a20 2020  results = {}.   
+000513d0: 2020 2020 2020 2020 2020 2020 2072 6177               raw
+000513e0: 5f61 6c6c 7265 7375 6c74 7320 3d20 7b7d  _allresults = {}
+000513f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00051400: 2066 6f72 206d 6f64 656c 2069 6e20 7365   for model in se
+00051410: 6c66 2e6d 6f64 656c 733a 0a20 2020 2020  lf.models:.     
+00051420: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00051430: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00051440: 2020 2020 2020 2020 2020 2020 6675 6c6c              full
+00051450: 5f6d 6f64 656c 203d 2027 7b7d 7b7d 272e  _model = '{}{}'.
+00051460: 666f 726d 6174 2873 656c 662e 776f 726b  format(self.work
+00051470: 6469 722c 206f 732e 7061 7468 2e62 6173  dir, os.path.bas
+00051480: 656e 616d 6528 6d6f 6465 6c2e 6669 6c65  ename(model.file
+00051490: 6e61 6d65 2929 0a20 2020 2020 2020 2020  name)).         
+000514a0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000514b0: 756c 6c5f 6d61 7020 3d20 277b 7d7b 7d27  ull_map = '{}{}'
+000514c0: 2e66 6f72 6d61 7428 7365 6c66 2e77 6f72  .format(self.wor
+000514d0: 6b64 6972 2c20 7365 6c66 2e6d 6170 6e61  kdir, self.mapna
+000514e0: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
+000514f0: 2020 2020 2020 2020 2020 2020 6f75 745f              out_
+00051500: 7061 7468 203d 2027 7b7d 5f70 6865 6e69  path = '{}_pheni
+00051510: 7827 2e66 6f72 6d61 7428 6675 6c6c 5f6d  x'.format(full_m
+00051520: 6f64 656c 290a 2020 2020 2020 2020 2020  odel).          
+00051530: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00051540: 7272 203d 2072 756e 5f70 6865 6e69 786d  rr = run_phenixm
+00051550: 6d66 7363 2866 756c 6c5f 6d6f 6465 6c2c  mfsc(full_model,
+00051560: 2066 756c 6c5f 6d61 702c 206f 7574 5f70   full_map, out_p
+00051570: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
+00051580: 2020 2020 2020 2020 2020 2020 2074 6d6d               tmm
+00051590: 6673 636c 6f67 203d 2027 7b7d 2f66 7363  fsclog = '{}/fsc
+000515a0: 5f6d 6f64 656c 2e75 6e6d 6173 6b65 642e  _model.unmasked.
+000515b0: 6d74 7269 6167 652e 6c6f 6727 2e66 6f72  mtriage.log'.for
+000515c0: 6d61 7428 6f75 745f 7061 7468 290a 2020  mat(out_path).  
+000515d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000515e0: 2020 2020 2020 6d6d 6673 636c 6f67 203d        mmfsclog =
+000515f0: 2027 7b7d 2f66 7363 5f6d 6f64 656c 2e75   '{}/fsc_model.u
+00051600: 6e6d 6173 6b65 642e 6d74 7269 6167 655f  nmasked.mtriage_
+00051610: 7b7d 2e6c 6f67 272e 666f 726d 6174 286f  {}.log'.format(o
+00051620: 7574 5f70 6174 682c 2073 656c 662e 6d61  ut_path, self.ma
+00051630: 706e 616d 6529 0a20 2020 2020 2020 2020  pname).         
+00051640: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00051650: 6861 6e67 655f 6669 6c65 6e61 6d65 2874  hange_filename(t
+00051660: 6d6d 6673 636c 6f67 2c20 6d6d 6673 636c  mmfsclog, mmfscl
+00051670: 6f67 290a 2020 2020 2020 2020 2020 2020  og).            
+00051680: 2020 2020 2020 2020 2020 2020 7261 775f              raw_
+00051690: 6d6d 6673 636c 6f67 203d 204e 6f6e 650a  mmfsclog = None.
+000516a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000516b0: 2020 2020 2020 2020 7261 775f 7265 7272          raw_rerr
+000516c0: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+000516d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000516e0: 6966 2073 656c 662e 686d 6f64 6420 616e  if self.hmodd an
+000516f0: 6420 7365 6c66 2e68 6d65 7665 6e3a 0a20  d self.hmeven:. 
+00051700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051710: 2020 2020 2020 2020 2020 2072 6177 5f66             raw_f
+00051720: 756c 6c5f 6d61 7020 3d20 7365 6c66 2e72  ull_map = self.r
+00051730: 6177 6d61 702e 6675 6c6c 6e61 6d65 0a20  awmap.fullname. 
+00051740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051750: 2020 2020 2020 2020 2020 2072 6177 5f6d             raw_m
+00051760: 6170 6e61 6d65 203d 206f 732e 7061 7468  apname = os.path
+00051770: 2e62 6173 656e 616d 6528 7261 775f 6675  .basename(raw_fu
+00051780: 6c6c 5f6d 6170 290a 2020 2020 2020 2020  ll_map).        
+00051790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000517a0: 2020 2020 7261 775f 7265 7272 203d 2072      raw_rerr = r
+000517b0: 756e 5f70 6865 6e69 786d 6d66 7363 2866  un_phenixmmfsc(f
+000517c0: 756c 6c5f 6d6f 6465 6c2c 2072 6177 5f66  ull_model, raw_f
+000517d0: 756c 6c5f 6d61 702c 206f 7574 5f70 6174  ull_map, out_pat
+000517e0: 6829 0a20 2020 2020 2020 2020 2020 2020  h).             
+000517f0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00051800: 6177 5f6d 6d66 7363 6c6f 6720 3d20 277b  aw_mmfsclog = '{
+00051810: 7d2f 6673 635f 6d6f 6465 6c2e 756e 6d61  }/fsc_model.unma
+00051820: 736b 6564 2e6d 7472 6961 6765 5f7b 7d2e  sked.mtriage_{}.
+00051830: 6c6f 6727 2e66 6f72 6d61 7428 6f75 745f  log'.format(out_
+00051840: 7061 7468 2c20 7261 775f 6d61 706e 616d  path, raw_mapnam
+00051850: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+00051860: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00051870: 6861 6e67 655f 6669 6c65 6e61 6d65 2874  hange_filename(t
+00051880: 6d6d 6673 636c 6f67 2c20 7261 775f 6d6d  mmfsclog, raw_mm
+00051890: 6673 636c 6f67 290a 2020 2020 2020 2020  fsclog).        
+000518a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000518b0: 656e 6420 3d20 7469 6d65 6974 2e64 6566  end = timeit.def
+000518c0: 6175 6c74 5f74 696d 6572 2829 0a20 2020  ault_timer().   
+000518d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000518e0: 2020 2020 2070 7269 6e74 2827 5068 656e       print('Phen
+000518f0: 6978 206d 6d46 5343 2074 696d 653a 2025  ix mmFSC time: %
+00051900: 7327 2025 2028 656e 6420 2d20 7374 6172  s' % (end - star
+00051910: 7429 290a 2020 2020 2020 2020 2020 2020  t)).            
+00051920: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+00051930: 7428 272d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  t('-------------
+00051940: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00051950: 2d2d 2d2d 2d2d 2d27 290a 2020 2020 2020  -------').      
+00051960: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+00051970: 6365 7074 3a0a 2020 2020 2020 2020 2020  cept:.          
+00051980: 2020 2020 2020 2020 2020 2020 2020 6572                er
+00051990: 7220 3d20 2750 6865 6e69 7820 6d6d 4653  r = 'Phenix mmFS
+000519a0: 4320 6361 6c63 756c 6174 696f 6e20 6572  C calculation er
+000519b0: 726f 723a 207b 7d2e 272e 666f 726d 6174  ror: {}.'.format
+000519c0: 2873 7973 2e65 7863 5f69 6e66 6f28 295b  (sys.exc_info()[
+000519d0: 315d 290a 2020 2020 2020 2020 2020 2020  1]).            
+000519e0: 2020 2020 2020 2020 2020 2020 6572 726c              errl
+000519f0: 6973 742e 6170 7065 6e64 2865 7272 290a  ist.append(err).
+00051a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051a10: 2020 2020 2020 2020 7379 732e 7374 6465          sys.stde
+00051a20: 7272 2e77 7269 7465 2865 7272 202b 2027  rr.write(err + '
+00051a30: 5c6e 2729 0a20 2020 2020 2020 2020 2020  \n').           
+00051a40: 2020 2020 2020 2020 206e 7971 7569 7374           nyquist
+00051a50: 203d 2031 202f 2028 3220 2a20 7365 6c66   = 1 / (2 * self
+00051a60: 2e6d 6170 2e76 6f78 656c 5f73 697a 652e  .map.voxel_size.
+00051a70: 746f 6c69 7374 2829 5b30 5d29 0a20 2020  tolist()[0]).   
+00051a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051a90: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+00051aa0: 2020 2020 2020 2020 2020 2020 2020 6466                df
+00051ab0: 203d 2072 6561 645f 6d6d 6673 6328 6d6d   = read_mmfsc(mm
+00051ac0: 6673 636c 6f67 2c20 7265 7272 290a 2020  fsclog, rerr).  
+00051ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051ae0: 2020 2020 2020 6d6d 6673 6364 6963 7420        mmfscdict 
+00051af0: 3d20 6d6d 6673 6364 665f 746f 6469 6374  = mmfscdf_todict
+00051b00: 2864 662c 206e 7971 7569 7374 290a 0a20  (df, nyquist).. 
+00051b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051b20: 2020 2020 2020 2061 6c6c 7265 7375 6c74         allresult
+00051b30: 735b 7374 7228 6e75 6d6d 6f64 656c 7329  s[str(nummodels)
+00051b40: 5d20 3d20 7b27 6e61 6d65 273a 206f 732e  ] = {'name': os.
+00051b50: 7061 7468 2e62 6173 656e 616d 6528 6d6f  path.basename(mo
+00051b60: 6465 6c2e 6669 6c65 6e61 6d65 292c 0a20  del.filename),. 
+00051b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051ba0: 2020 2020 2027 6461 7461 273a 206d 6d66       'data': mmf
+00051bb0: 7363 6469 6374 7d0a 0a20 2020 2020 2020  scdict}..       
+00051bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051bd0: 2069 6620 7365 6c66 2e68 6d6f 6464 2061   if self.hmodd a
+00051be0: 6e64 2073 656c 662e 686d 6576 656e 3a0a  nd self.hmeven:.
+00051bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051c00: 2020 2020 2020 2020 2020 2020 7261 775f              raw_
+00051c10: 6466 203d 2072 6561 645f 6d6d 6673 6328  df = read_mmfsc(
+00051c20: 7261 775f 6d6d 6673 636c 6f67 2c20 7261  raw_mmfsclog, ra
+00051c30: 775f 7265 7272 290a 2020 2020 2020 2020  w_rerr).        
+00051c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051c50: 2020 2020 7261 775f 6d6d 6673 6364 6963      raw_mmfscdic
+00051c60: 7420 3d20 6d6d 6673 6364 665f 746f 6469  t = mmfscdf_todi
+00051c70: 6374 2872 6177 5f64 662c 206e 7971 7569  ct(raw_df, nyqui
+00051c80: 7374 290a 0a20 2020 2020 2020 2020 2020  st)..           
+00051c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051ca0: 2072 6177 5f61 6c6c 7265 7375 6c74 735b   raw_allresults[
+00051cb0: 7374 7228 6e75 6d6d 6f64 656c 7329 5d20  str(nummodels)] 
+00051cc0: 3d20 7b27 6e61 6d65 273a 206f 732e 7061  = {'name': os.pa
+00051cd0: 7468 2e62 6173 656e 616d 6528 6d6f 6465  th.basename(mode
+00051ce0: 6c2e 6669 6c65 6e61 6d65 292c 0a20 2020  l.filename),.   
+00051cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051d00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051d20: 2020 2020 2020 2020 2020 2027 6461 7461             'data
+00051d30: 273a 2072 6177 5f6d 6d66 7363 6469 6374  ': raw_mmfscdict
+00051d40: 7d0a 0a20 2020 2020 2020 2020 2020 2020  }..             
+00051d50: 2020 2020 2020 2065 7863 6570 743a 0a20         except:. 
+00051d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051d70: 2020 2020 2020 2065 7272 203d 2027 5361         err = 'Sa
+00051d80: 7665 2050 6865 6e69 7820 6d6d 4653 4320  ve Phenix mmFSC 
+00051d90: 6461 7461 2065 7272 6f72 3a20 7b7d 2e27  data error: {}.'
+00051da0: 2e66 6f72 6d61 7428 7379 732e 6578 635f  .format(sys.exc_
+00051db0: 696e 666f 2829 5b31 5d29 0a20 2020 2020  info()[1]).     
+00051dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051dd0: 2020 2065 7272 6c69 7374 2e61 7070 656e     errlist.appen
+00051de0: 6428 6572 7229 0a20 2020 2020 2020 2020  d(err).         
+00051df0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00051e00: 7973 2e73 7464 6572 722e 7772 6974 6528  ys.stderr.write(
+00051e10: 6572 7220 2b20 275c 6e27 290a 2020 2020  err + '\n').    
+00051e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051e30: 6e75 6d6d 6f64 656c 7320 2b3d 2031 0a0a  nummodels += 1..
+00051e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051e50: 6966 2061 6c6c 7265 7375 6c74 733a 0a20  if allresults:. 
+00051e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051e70: 2020 2072 6573 756c 745f 6469 6374 5b27     result_dict['
+00051e80: 6d6d 6673 6327 5d20 3d20 616c 6c72 6573  mmfsc'] = allres
+00051e90: 756c 7473 0a20 2020 2020 2020 2020 2020  ults.           
+00051ea0: 2020 2020 2069 6620 7261 775f 616c 6c72       if raw_allr
+00051eb0: 6573 756c 7473 3a0a 2020 2020 2020 2020  esults:.        
+00051ec0: 2020 2020 2020 2020 2020 2020 7261 775f              raw_
+00051ed0: 7265 7375 6c74 5f64 6963 745b 2772 6177  result_dict['raw
+00051ee0: 5f6d 6d66 7363 275d 203d 2072 6177 5f61  _mmfsc'] = raw_a
+00051ef0: 6c6c 7265 7375 6c74 730a 0a20 2020 2020  llresults..     
+00051f00: 2020 2020 2020 2020 2020 2069 6620 6572             if er
+00051f10: 726c 6973 743a 0a20 2020 2020 2020 2020  rlist:.         
+00051f20: 2020 2020 2020 2020 2020 2072 6573 756c             resul
+00051f30: 745f 6469 6374 5b27 6572 7227 5d20 3d20  t_dict['err'] = 
+00051f40: 6572 726c 6973 740a 0a20 2020 2020 2020  errlist..       
+00051f50: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
+00051f60: 7265 7375 6c74 5f64 6963 7429 203d 3d20  result_dict) == 
+00051f70: 3120 616e 6420 276d 6d66 7363 2720 696e  1 and 'mmfsc' in
+00051f80: 2072 6573 756c 745f 6469 6374 3a0a 2020   result_dict:.  
+00051f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00051fa0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00051fb0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+00051fc0: 6974 6820 636f 6465 6373 2e6f 7065 6e28  ith codecs.open(
+00051fd0: 7365 6c66 2e77 6f72 6b64 6972 202b 2073  self.workdir + s
+00051fe0: 656c 662e 6d61 706e 616d 6520 2b20 275f  elf.mapname + '_
+00051ff0: 6d6d 6673 632e 6a73 6f6e 272c 2027 7727  mmfsc.json', 'w'
+00052000: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00052010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052020: 2020 2020 2020 2020 2020 2065 6e63 6f64             encod
+00052030: 696e 673d 2775 7466 2d38 2729 2061 7320  ing='utf-8') as 
+00052040: 663a 0a20 2020 2020 2020 2020 2020 2020  f:.             
+00052050: 2020 2020 2020 2020 2020 2020 2020 206a                 j
+00052060: 736f 6e2e 6475 6d70 2872 6573 756c 745f  son.dump(result_
+00052070: 6469 6374 2c20 6629 0a20 2020 2020 2020  dict, f).       
+00052080: 2020 2020 2020 2020 2020 2020 2065 7863               exc
+00052090: 6570 743a 0a20 2020 2020 2020 2020 2020  ept:.           
+000520a0: 2020 2020 2020 2020 2020 2020 2073 7973               sys
+000520b0: 2e73 7464 6572 722e 7772 6974 6528 2753  .stderr.write('S
+000520c0: 6176 696e 6720 746f 206d 6d46 5343 206a  aving to mmFSC j
+000520d0: 736f 6e20 6572 726f 723a 207b 7d2e 5c6e  son error: {}.\n
+000520e0: 272e 666f 726d 6174 2873 7973 2e65 7863  '.format(sys.exc
+000520f0: 5f69 6e66 6f28 295b 315d 2929 0a0a 2020  _info()[1]))..  
+00052100: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00052110: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00052120: 2020 2020 2020 2020 7072 696e 7428 276d          print('m
+00052130: 6d46 5343 2077 6173 206e 6f74 2063 6f6c  mFSC was not col
+00052140: 6c65 6374 6564 2c20 706c 6561 7365 2063  lected, please c
+00052150: 6865 636b 2074 6865 2065 7272 6f72 2127  heck the error!'
+00052160: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+00052170: 2020 2069 6620 6c65 6e28 7261 775f 7265     if len(raw_re
+00052180: 7375 6c74 5f64 6963 7429 203d 3d20 3120  sult_dict) == 1 
+00052190: 616e 6420 2772 6177 5f6d 6d66 7363 2720  and 'raw_mmfsc' 
+000521a0: 696e 2072 6177 5f72 6573 756c 745f 6469  in raw_result_di
+000521b0: 6374 3a0a 2020 2020 2020 2020 2020 2020  ct:.            
+000521c0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+000521d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000521e0: 2020 2020 2077 6974 6820 636f 6465 6373       with codecs
+000521f0: 2e6f 7065 6e28 7365 6c66 2e77 6f72 6b64  .open(self.workd
+00052200: 6972 202b 2073 656c 662e 6d61 706e 616d  ir + self.mapnam
+00052210: 6520 2b20 275f 7261 775f 6d6d 6673 632e  e + '_raw_mmfsc.
+00052220: 6a73 6f6e 272c 2027 7727 2c0a 2020 2020  json', 'w',.    
+00052230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052250: 2020 2020 2065 6e63 6f64 696e 673d 2775       encoding='u
+00052260: 7466 2d38 2729 2061 7320 663a 0a20 2020  tf-8') as f:.   
+00052270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052280: 2020 2020 2020 2020 206a 736f 6e2e 6475           json.du
+00052290: 6d70 2872 6177 5f72 6573 756c 745f 6469  mp(raw_result_di
+000522a0: 6374 2c20 6629 0a20 2020 2020 2020 2020  ct, f).         
+000522b0: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+000522c0: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+000522d0: 2020 2020 2020 2020 2020 2073 7973 2e73             sys.s
+000522e0: 7464 6572 722e 7772 6974 6528 2753 6176  tderr.write('Sav
+000522f0: 696e 6720 746f 2072 6177 206d 6d46 5343  ing to raw mmFSC
+00052300: 206a 736f 6e20 6572 726f 723a 207b 7d2e   json error: {}.
+00052310: 5c6e 272e 666f 726d 6174 2873 7973 2e65  \n'.format(sys.e
+00052320: 7863 5f69 6e66 6f28 295b 315d 2929 0a0a  xc_info()[1]))..
+00052330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052340: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
 00052350: 2020 2020 2020 2020 2020 7072 696e 7428            print(
-00052360: 2750 7265 6469 6361 7465 6420 636f 6e74  'Predicated cont
-00052370: 6f75 7220 6c65 7665 6c20 646f 6573 206e  our level does n
-00052380: 6f74 2065 7869 7374 2066 6f72 2065 6974  ot exist for eit
-00052390: 6865 7220 7072 696d 6172 7920 6f72 2072  her primary or r
-000523a0: 6177 206d 6170 2e27 290a 0a20 2020 2020  aw map.')..     
-000523b0: 2020 2069 6620 7265 7375 6c74 5f64 6963     if result_dic
-000523c0: 743a 0a20 2020 2020 2020 2020 2020 2066  t:.            f
-000523d0: 696c 655f 6e61 6d65 203d 2066 277b 7365  ile_name = f'{se
-000523e0: 6c66 2e77 6f72 6b64 6972 7d7b 7365 6c66  lf.workdir}{self
-000523f0: 2e6d 6170 6e61 6d65 7d5f 7072 6564 6963  .mapname}_predic
-00052400: 6174 6564 5f63 6f6e 746f 7572 5f6c 6576  ated_contour_lev
-00052410: 656c 2e6a 736f 6e27 0a20 2020 2020 2020  el.json'.       
-00052420: 2020 2020 206f 7574 5f6a 736f 6e28 7265       out_json(re
-00052430: 7375 6c74 5f64 6963 742c 2066 696c 655f  sult_dict, file_
-00052440: 6e61 6d65 290a 0a0a 2020 2020 6465 6620  name)...    def 
-00052450: 656d 7269 6e67 6572 2873 656c 6629 3a0a  emringer(self):.
-00052460: 2020 2020 2020 2020 2222 220a 0a20 2020          """..   
-00052470: 2020 2020 2020 2020 2045 6d72 696e 6765           Emringe
-00052480: 7220 7363 6f72 650a 0a20 2020 2020 2020  r score..       
-00052490: 203a 7265 7475 726e 3a0a 2020 2020 2020   :return:.      
-000524a0: 2020 2222 220a 0a20 2020 2020 2020 2069    """..        i
-000524b0: 6620 7365 6c66 2e70 6c61 7466 6f72 6d20  f self.platform 
-000524c0: 3d3d 2027 656d 6462 2720 616e 6420 7365  == 'emdb' and se
-000524d0: 6c66 2e6d 6574 2021 3d20 2774 6f6d 6f27  lf.met != 'tomo'
-000524e0: 3a0a 2020 2020 2020 2020 2020 2020 7374  :.            st
-000524f0: 6172 7420 3d20 7469 6d65 6974 2e64 6566  art = timeit.def
-00052500: 6175 6c74 5f74 696d 6572 2829 0a20 2020  ault_timer().   
-00052510: 2020 2020 2020 2020 2065 7272 6c69 7374           errlist
-00052520: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
-00052530: 2020 2320 6966 2073 7472 7564 656c 6170    # if strudelap
-00052540: 7020 616e 6420 7365 6c66 2e6d 6f64 656c  p and self.model
-00052550: 733a 0a20 2020 2020 2020 2020 2020 2069  s:.            i
-00052560: 6620 7365 6c66 2e6d 6f64 656c 733a 0a20  f self.models:. 
-00052570: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00052580: 6f72 206d 6f64 656c 2069 6e20 7365 6c66  or model in self
-00052590: 2e6d 6f64 656c 733a 0a20 2020 2020 2020  .models:.       
-000525a0: 2020 2020 2020 2020 2020 2020 2066 756c               ful
-000525b0: 6c5f 6d6f 6465 6c20 3d20 277b 7d7b 7d27  l_model = '{}{}'
-000525c0: 2e66 6f72 6d61 7428 7365 6c66 2e77 6f72  .format(self.wor
-000525d0: 6b64 6972 2c20 6f73 2e70 6174 682e 6261  kdir, os.path.ba
-000525e0: 7365 6e61 6d65 286d 6f64 656c 2e66 696c  sename(model.fil
-000525f0: 656e 616d 6529 290a 2020 2020 2020 2020  ename)).        
-00052600: 2020 2020 2020 2020 2020 2020 6675 6c6c              full
-00052610: 5f6d 6170 203d 2027 7b7d 7b7d 272e 666f  _map = '{}{}'.fo
-00052620: 726d 6174 2873 656c 662e 776f 726b 6469  rmat(self.workdi
-00052630: 722c 2073 656c 662e 6d61 706e 616d 6529  r, self.mapname)
-00052640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00052650: 2020 2020 206f 7574 5f70 6174 6820 3d20       out_path = 
-00052660: 277b 7d5f 656d 7269 6e67 6572 272e 666f  '{}_emringer'.fo
-00052670: 726d 6174 2866 756c 6c5f 6d6f 6465 6c29  rmat(full_model)
-00052680: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00052690: 2020 2020 2020 7265 7272 203d 2072 756e        rerr = run
-000526a0: 5f65 6d72 696e 6765 7228 6675 6c6c 5f6d  _emringer(full_m
-000526b0: 6f64 656c 2c20 6675 6c6c 5f6d 6170 2c20  odel, full_map, 
-000526c0: 6f75 745f 7061 7468 290a 2020 2020 2020  out_path).      
-000526d0: 2020 2020 2020 2020 2020 2020 2020 656e                en
-000526e0: 6420 3d20 7469 6d65 6974 2e64 6566 6175  d = timeit.defau
-000526f0: 6c74 5f74 696d 6572 2829 0a20 2020 2020  lt_timer().     
-00052700: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00052710: 7269 6e74 2827 454d 5269 6e67 6572 2074  rint('EMRinger t
-00052720: 696d 653a 2025 7327 2025 2028 656e 6420  ime: %s' % (end 
-00052730: 2d20 7374 6172 7429 290a 2020 2020 2020  - start)).      
-00052740: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-00052750: 696e 7428 272d 2d2d 2d2d 2d2d 2d2d 2d2d  int('-----------
-00052760: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00052770: 2d2d 2d2d 2d2d 2d2d 2d27 290a 2020 2020  ---------').    
-00052780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052790: 6966 2072 6572 723a 0a20 2020 2020 2020  if rerr:.       
-000527a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000527b0: 2065 7272 203d 2027 5374 7275 6465 6c20   err = 'Strudel 
-000527c0: 6361 6c63 756c 6174 696f 6e20 6572 726f  calculation erro
-000527d0: 723a 207b 7d27 2e66 6f72 6d61 7428 7265  r: {}'.format(re
-000527e0: 7272 290a 2020 2020 2020 2020 2020 2020  rr).            
-000527f0: 2020 2020 2020 2020 2020 2020 6572 726c              errl
-00052800: 6973 742e 6170 7065 6e64 2865 7272 290a  ist.append(err).
-00052810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052820: 2020 2020 2020 2020 7379 732e 7374 6465          sys.stde
-00052830: 7272 2e77 7269 7465 2865 7272 202b 2027  rr.write(err + '
-00052840: 5c6e 2729 0a20 2020 2020 2020 2020 2020  \n').           
-00052850: 2020 2020 2020 2020 2020 2020 2070 7269               pri
-00052860: 6e74 2827 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  nt('------------
-00052870: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00052880: 2d2d 2d2d 2d2d 2d2d 2729 0a0a 2020 2020  --------')..    
-00052890: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-000528a0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-000528b0: 696e 7428 274e 6f20 6d6f 6465 6c20 6f72  int('No model or
-000528c0: 2072 6573 6f6c 7574 696f 6e20 6973 206e   resolution is n
-000528d0: 6f74 2063 6f76 6572 6564 2069 6e20 7468  ot covered in th
-000528e0: 6520 6d6f 7469 6620 6c69 6272 6172 7920  e motif library 
-000528f0: 283c 342e 30c3 8529 2027 290a 2020 2020  (<4.0..) ').    
-00052900: 2020 2020 2020 2020 2020 2020 7072 696e              prin
-00052910: 7428 272d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  t('-------------
-00052920: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00052930: 2d2d 2d2d 2d2d 2d27 290a 0a20 2020 2020  -------')..     
-00052940: 2020 2072 6574 7572 6e20 4e6f 6e65 0a0a     return None..
-00052950: 0a20 2020 2064 6566 2074 6872 6565 6466  .    def threedf
-00052960: 7363 2873 656c 6629 3a0a 2020 2020 2020  sc(self):.      
-00052970: 2020 2222 220a 0a20 2020 2020 2020 2020    """..         
-00052980: 2020 2045 6d72 696e 6765 7220 7363 6f72     Emringer scor
-00052990: 650a 0a20 2020 2020 2020 203a 7265 7475  e..        :retu
-000529a0: 726e 3a0a 2020 2020 2020 2020 2222 220a  rn:.        """.
-000529b0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-000529c0: 2e70 6c61 7466 6f72 6d20 3d3d 2027 656d  .platform == 'em
-000529d0: 6462 2720 616e 6420 7365 6c66 2e6d 6574  db' and self.met
-000529e0: 2021 3d20 2774 6f6d 6f27 3a0a 2020 2020   != 'tomo':.    
-000529f0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00052a00: 7468 7265 6564 6673 6364 6972 2069 7320  threedfscdir is 
-00052a10: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00052a20: 2020 2020 2020 2020 2020 7374 6172 7420            start 
-00052a30: 3d20 7469 6d65 6974 2e64 6566 6175 6c74  = timeit.default
-00052a40: 5f74 696d 6572 2829 0a20 2020 2020 2020  _timer().       
-00052a50: 2020 2020 2020 2020 2065 7272 6c69 7374           errlist
-00052a60: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
-00052a70: 2020 2020 2020 6966 2073 656c 662e 686d        if self.hm
-00052a80: 6f64 6420 6973 206e 6f74 204e 6f6e 6520  odd is not None 
-00052a90: 616e 6420 7365 6c66 2e68 6d65 7665 6e20  and self.hmeven 
-00052aa0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00052ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052ac0: 206f 7574 5f70 6174 6820 3d20 277b 7d5f   out_path = '{}_
-00052ad0: 3364 6673 6327 2e66 6f72 6d61 7428 7365  3dfsc'.format(se
-00052ae0: 6c66 2e6d 6170 2e66 756c 6c6e 616d 6529  lf.map.fullname)
-00052af0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00052b00: 2020 2020 2076 7873 697a 6573 203d 2073       vxsizes = s
-00052b10: 656c 662e 6d61 702e 766f 7865 6c5f 7369  elf.map.voxel_si
-00052b20: 7a65 0a20 2020 2020 2020 2020 2020 2020  ze.             
-00052b30: 2020 2020 2020 2069 6620 7678 7369 7a65         if vxsize
-00052b40: 732e 7820 3d3d 2076 7873 697a 6573 2e79  s.x == vxsizes.y
-00052b50: 203d 3d20 7678 7369 7a65 732e 7a20 616e   == vxsizes.z an
-00052b60: 6420 7365 6c66 2e68 6d6f 6464 2e76 6f78  d self.hmodd.vox
-00052b70: 656c 5f73 697a 6520 3d3d 2073 656c 662e  el_size == self.
-00052b80: 686d 6576 656e 2e76 6f78 656c 5f73 697a  hmeven.voxel_siz
-00052b90: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00052ba0: 2020 2020 2020 2020 2020 2072 6572 7220             rerr 
-00052bb0: 3d20 7275 6e5f 7468 7265 6564 6673 6328  = run_threedfsc(
-00052bc0: 7365 6c66 2e68 6d6f 6464 2e66 756c 6c6e  self.hmodd.fulln
-00052bd0: 616d 652c 2073 656c 662e 686d 6576 656e  ame, self.hmeven
-00052be0: 2e66 756c 6c6e 616d 652c 2073 656c 662e  .fullname, self.
-00052bf0: 6d61 702e 6675 6c6c 6e61 6d65 2c0a 2020  map.fullname,.  
-00052c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052c10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052c20: 2020 2020 2020 2020 2020 2076 7873 697a             vxsiz
-00052c30: 6573 2e78 2c20 6f75 745f 7061 7468 2c20  es.x, out_path, 
-00052c40: 7365 6c66 2e74 6872 6565 6466 7363 6469  self.threedfscdi
-00052c50: 7229 0a20 2020 2020 2020 2020 2020 2020  r).             
-00052c60: 2020 2020 2020 2020 2020 2065 6e64 203d             end =
-00052c70: 2074 696d 6569 742e 6465 6661 756c 745f   timeit.default_
-00052c80: 7469 6d65 7228 290a 2020 2020 2020 2020  timer().        
-00052c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052ca0: 7072 696e 7428 2733 4446 5343 2074 696d  print('3DFSC tim
-00052cb0: 653a 2025 7327 2025 2028 656e 6420 2d20  e: %s' % (end - 
-00052cc0: 7374 6172 7429 290a 2020 2020 2020 2020  start)).        
+00052360: 2752 6177 206d 6170 206d 6d46 5343 2077  'Raw map mmFSC w
+00052370: 6173 206e 6f74 2063 6f6c 6c65 6374 6564  as not collected
+00052380: 2c20 706c 6561 7365 2063 6865 636b 2074  , please check t
+00052390: 6865 2065 7272 6f72 2127 290a 0a20 2020  he error!')..   
+000523a0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+000523b0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+000523c0: 7269 6e74 2827 4e6f 206d 6f64 656c 2121  rint('No model!!
+000523d0: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
+000523e0: 2020 2070 7269 6e74 2827 2d2d 2d2d 2d2d     print('------
+000523f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00052400: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2729  --------------')
+00052410: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00052420: 204e 6f6e 650a 0a20 2020 2064 6566 206c   None..    def l
+00052430: 6f63 7265 735f 7265 736d 6170 2873 656c  ocres_resmap(sel
+00052440: 6629 3a0a 2020 2020 2020 2020 2222 220a  f):.        """.
+00052450: 2020 2020 2020 2020 2020 2020 4361 6c63              Calc
+00052460: 756c 6174 6520 6c6f 6361 6c20 7265 736f  ulate local reso
+00052470: 6c75 7469 6f6e 2062 7920 7573 696e 6720  lution by using 
+00052480: 5265 736d 6170 0a20 2020 2020 2020 203a  Resmap.        :
+00052490: 7265 7475 726e 3a0a 2020 2020 2020 2020  return:.        
+000524a0: 2222 220a 2020 2020 2020 2020 6966 2073  """.        if s
+000524b0: 656c 662e 706c 6174 666f 726d 203d 3d20  elf.platform == 
+000524c0: 2765 6d64 6227 2061 6e64 2073 656c 662e  'emdb' and self.
+000524d0: 6d65 7420 213d 2027 746f 6d6f 273a 0a20  met != 'tomo':. 
+000524e0: 2020 2020 2020 2020 2020 2073 7461 7274             start
+000524f0: 203d 2074 696d 6569 742e 6465 6661 756c   = timeit.defaul
+00052500: 745f 7469 6d65 7228 290a 2020 2020 2020  t_timer().      
+00052510: 2020 2020 2020 6572 726c 6973 7420 3d20        errlist = 
+00052520: 5b5d 0a20 2020 2020 2020 2020 2020 2072  [].            r
+00052530: 6573 756c 745f 6469 6374 203d 207b 7d0a  esult_dict = {}.
+00052540: 2020 2020 2020 2020 2020 2020 2320 6966              # if
+00052550: 2073 7472 7564 656c 6170 7020 616e 6420   strudelapp and 
+00052560: 7365 6c66 2e6d 6f64 656c 733a 0a20 2020  self.models:.   
+00052570: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+00052580: 2e68 6d65 7665 6e20 616e 6420 7365 6c66  .hmeven and self
+00052590: 2e68 6d6f 6464 3a0a 2020 2020 2020 2020  .hmodd:.        
+000525a0: 2020 2020 2020 2020 6576 656e 203d 2073          even = s
+000525b0: 656c 662e 686d 6576 656e 2e66 756c 6c6e  elf.hmeven.fulln
+000525c0: 616d 650a 2020 2020 2020 2020 2020 2020  ame.            
+000525d0: 2020 2020 6f64 6420 3d20 7365 6c66 2e68      odd = self.h
+000525e0: 6d6f 6464 2e66 756c 6c6e 616d 650a 2020  modd.fullname.  
+000525f0: 2020 2020 2020 2020 2020 2020 2020 6675                fu
+00052600: 6c6c 5f6d 6170 203d 2027 7b7d 7b7d 272e  ll_map = '{}{}'.
+00052610: 666f 726d 6174 2873 656c 662e 776f 726b  format(self.work
+00052620: 6469 722c 2073 656c 662e 6d61 706e 616d  dir, self.mapnam
+00052630: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+00052640: 2020 206f 7574 5f70 6174 6820 3d20 277b     out_path = '{
+00052650: 7d5f 7265 6c69 6f6e 272e 666f 726d 6174  }_relion'.format
+00052660: 2866 756c 6c5f 6d61 7029 0a20 2020 2020  (full_map).     
+00052670: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+00052680: 286f 7574 5f70 6174 6829 0a20 2020 2020  (out_path).     
+00052690: 2020 2020 2020 2020 2020 2061 6c6c 7265             allre
+000526a0: 7375 6c74 7320 3d20 7b7d 0a20 2020 2020  sults = {}.     
+000526b0: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+000526c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000526d0: 2020 2020 2023 2072 6572 7220 3d20 7275       # rerr = ru
+000526e0: 6e5f 7265 736d 6170 286f 6464 2c20 6576  n_resmap(odd, ev
+000526f0: 656e 2c20 6f75 745f 7061 7468 2c20 5245  en, out_path, RE
+00052700: 534d 4150 290a 2020 2020 2020 2020 2020  SMAP).          
+00052710: 2020 2020 2020 2020 2020 7265 7272 203d            rerr =
+00052720: 2072 756e 5f6c 6f63 7265 7328 6f64 642c   run_locres(odd,
+00052730: 2065 7665 6e2c 206f 7574 5f70 6174 682c   even, out_path,
+00052740: 2052 4553 4d41 5029 0a20 2020 2020 2020   RESMAP).       
+00052750: 2020 2020 2020 2020 2020 2020 2065 6e64               end
+00052760: 203d 2074 696d 6569 742e 6465 6661 756c   = timeit.defaul
+00052770: 745f 7469 6d65 7228 290a 2020 2020 2020  t_timer().      
+00052780: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+00052790: 696e 7428 274c 6f63 616c 2072 6573 6f6c  int('Local resol
+000527a0: 7574 696f 6e20 5265 734d 6170 2074 696d  ution ResMap tim
+000527b0: 653a 2025 7327 2025 2028 656e 6420 2d20  e: %s' % (end - 
+000527c0: 7374 6172 7429 290a 2020 2020 2020 2020  start)).        
+000527d0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+000527e0: 7428 272d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  t('-------------
+000527f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00052800: 2d2d 2d2d 2d2d 2d27 290a 2020 2020 2020  -------').      
+00052810: 2020 2020 2020 2020 2020 6578 6365 7074            except
+00052820: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00052830: 2020 2020 2020 6572 7220 3d20 2752 6573        err = 'Res
+00052840: 4d61 7020 6361 6c63 756c 6174 696f 6e20  Map calculation 
+00052850: 6572 726f 723a 207b 7d2e 272e 666f 726d  error: {}.'.form
+00052860: 6174 2873 7973 2e65 7863 5f69 6e66 6f28  at(sys.exc_info(
+00052870: 295b 315d 290a 2020 2020 2020 2020 2020  )[1]).          
+00052880: 2020 2020 2020 2020 2020 6572 726c 6973            errlis
+00052890: 742e 6170 7065 6e64 2865 7272 290a 2020  t.append(err).  
+000528a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000528b0: 2020 7379 732e 7374 6465 7272 2e77 7269    sys.stderr.wri
+000528c0: 7465 2865 7272 202b 2027 5c6e 2729 0a20  te(err + '\n'). 
+000528d0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+000528e0: 2063 6865 636b 203d 2072 6573 6d61 705f   check = resmap_
+000528f0: 6669 6c65 6368 6563 6b28 6f64 642c 2073  filecheck(odd, s
+00052900: 656c 662e 776f 726b 6469 7229 0a20 2020  elf.workdir).   
+00052910: 2020 2020 2020 2020 2020 2020 2063 6865               che
+00052920: 636b 203d 206c 6f63 7265 735f 6669 6c65  ck = locres_file
+00052930: 6368 6563 6b28 6f64 642c 2065 7665 6e2c  check(odd, even,
+00052940: 206f 7574 5f70 6174 6829 0a20 2020 2020   out_path).     
+00052950: 2020 2020 2020 2020 2020 2069 6620 6368             if ch
+00052960: 6563 6b3a 0a20 2020 2020 2020 2020 2020  eck:.           
+00052970: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+00052980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052990: 2020 2020 2020 7265 736d 6170 5f63 6869        resmap_chi
+000529a0: 6d65 7261 785f 6669 6c65 203d 2072 6573  merax_file = res
+000529b0: 6d61 705f 6368 696d 6572 6178 286f 6464  map_chimerax(odd
+000529c0: 2c20 7365 6c66 2e77 6f72 6b64 6972 290a  , self.workdir).
+000529d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000529e0: 2020 2020 2020 2020 6966 206f 732e 7061          if os.pa
+000529f0: 7468 2e69 7366 696c 6528 7265 736d 6170  th.isfile(resmap
+00052a00: 5f63 6869 6d65 7261 785f 6669 6c65 293a  _chimerax_file):
+00052a10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00052a20: 2020 2020 2020 2020 2020 2020 2076 746b               vtk
+00052a30: 7061 636b 2c20 6368 696d 6572 6161 7070  pack, chimeraapp
+00052a40: 203d 2073 656c 662e 7375 7266 6163 655f   = self.surface_
+00052a50: 656e 7663 6865 636b 2829 0a20 2020 2020  envcheck().     
+00052a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052a70: 2020 2020 2020 2062 696e 6469 7370 6c61         bindispla
+00052a80: 7920 3d20 6f73 2e67 6574 656e 7628 2744  y = os.getenv('D
+00052a90: 4953 504c 4159 2729 0a20 2020 2020 2020  ISPLAY').       
+00052aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052ab0: 2020 2020 2072 756e 5f72 6573 6d61 705f       run_resmap_
+00052ac0: 6368 696d 6572 6178 2862 696e 6469 7370  chimerax(bindisp
+00052ad0: 6c61 792c 2063 6869 6d65 7261 6170 702c  lay, chimeraapp,
+00052ae0: 2072 6573 6d61 705f 6368 696d 6572 6178   resmap_chimerax
+00052af0: 5f66 696c 6529 0a20 2020 2020 2020 2020  _file).         
+00052b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052b10: 2020 2023 2072 6573 6d61 7020 3d20 277b     # resmap = '{
+00052b20: 7d5f 6f72 695f 7265 736d 6170 2e6d 6170  }_ori_resmap.map
+00052b30: 272e 666f 726d 6174 286f 6464 5b3a 2d34  '.format(odd[:-4
+00052b40: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
+00052b50: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00052b60: 206f 7574 7075 745f 6a73 6f6e 203d 2027   output_json = '
+00052b70: 7b7d 7b7d 5f72 6573 6d61 702e 6a73 6f6e  {}{}_resmap.json
+00052b80: 272e 666f 726d 6174 2873 656c 662e 776f  '.format(self.wo
+00052b90: 726b 6469 722c 2073 656c 662e 6d61 706e  rkdir, self.mapn
+00052ba0: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
+00052bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052bc0: 2023 2073 6176 655f 696d 6167 6573 746f   # save_imagesto
+00052bd0: 6a73 6f6e 2872 6573 6d61 702c 206f 7574  json(resmap, out
+00052be0: 7075 745f 6a73 6f6e 290a 2020 2020 2020  put_json).      
+00052bf0: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+00052c00: 6365 7074 3a0a 2020 2020 2020 2020 2020  cept:.          
+00052c10: 2020 2020 2020 2020 2020 2020 2020 6572                er
+00052c20: 7220 3d20 2752 6573 4d61 7020 7669 6577  r = 'ResMap view
+00052c30: 7320 6572 726f 723a 207b 7d2e 272e 666f  s error: {}.'.fo
+00052c40: 726d 6174 2873 7973 2e65 7863 5f69 6e66  rmat(sys.exc_inf
+00052c50: 6f28 295b 315d 290a 2020 2020 2020 2020  o()[1]).        
+00052c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052c70: 6572 726c 6973 742e 6170 7065 6e64 2865  errlist.append(e
+00052c80: 7272 290a 2020 2020 2020 2020 2020 2020  rr).            
+00052c90: 2020 2020 2020 2020 2020 2020 7379 732e              sys.
+00052ca0: 7374 6465 7272 2e77 7269 7465 2865 7272  stderr.write(err
+00052cb0: 202b 2027 5c6e 2729 0a20 2020 2020 2020   + '\n').       
+00052cc0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
 00052cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052ce0: 6966 2072 6572 723a 0a20 2020 2020 2020  if rerr:.       
-00052cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052d00: 2020 2020 2065 7272 203d 2027 3344 4653       err = '3DFS
-00052d10: 4320 6361 6c63 756c 6174 696f 6e20 6572  C calculation er
-00052d20: 726f 723a 207b 7d27 2e66 6f72 6d61 7428  ror: {}'.format(
-00052d30: 7265 7272 290a 2020 2020 2020 2020 2020  rerr).          
-00052d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052d50: 2020 6572 726c 6973 742e 6170 7065 6e64    errlist.append
-00052d60: 2865 7272 290a 2020 2020 2020 2020 2020  (err).          
-00052d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052d80: 2020 7379 732e 7374 6465 7272 2e77 7269    sys.stderr.wri
-00052d90: 7465 2865 7272 202b 2027 5c6e 2729 0a20  te(err + '\n'). 
-00052da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052db0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00052dc0: 2827 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ('--------------
-00052dd0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00052de0: 2d2d 2d2d 2d2d 2729 0a20 2020 2020 2020  ------').       
-00052df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052e00: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00052e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052e20: 2020 2070 7269 6e74 2827 2d2d 2d2d 2d2d     print('------
-00052e30: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00052e40: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2729  --------------')
-00052e50: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00052e60: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00052ce0: 2020 2070 7269 6e74 2827 4368 696d 6572     print('Chimer
+00052cf0: 6178 2066 696c 6520 646f 6573 206e 6f74  ax file does not
+00052d00: 2065 7869 7374 2e20 4368 6563 6b21 2127   exist. Check!!'
+00052d10: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+00052d20: 2020 2069 6620 6572 726c 6973 743a 0a20     if errlist:. 
+00052d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052d40: 2020 2072 6573 756c 745f 6469 6374 5b27     result_dict['
+00052d50: 6572 7227 5d20 3d20 6572 726c 6973 740a  err'] = errlist.
+00052d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052d70: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00052d80: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+00052d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052da0: 2020 2020 2020 2072 6573 6d61 7020 3d20         resmap = 
+00052db0: 277b 7d5f 6f72 695f 7265 736d 6170 2e6d  '{}_ori_resmap.m
+00052dc0: 6170 272e 666f 726d 6174 286f 6464 5b3a  ap'.format(odd[:
+00052dd0: 2d34 5d29 0a20 2020 2020 2020 2020 2020  -4]).           
+00052de0: 2020 2020 2020 2020 2020 2020 206f 7574               out
+00052df0: 7075 745f 6a73 6f6e 203d 2027 7b7d 7b7d  put_json = '{}{}
+00052e00: 5f72 6573 6d61 702e 6a73 6f6e 272e 666f  _resmap.json'.fo
+00052e10: 726d 6174 2873 656c 662e 776f 726b 6469  rmat(self.workdi
+00052e20: 722c 2073 656c 662e 6d61 706e 616d 6529  r, self.mapname)
+00052e30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00052e40: 2020 2020 2020 2020 2073 6176 655f 696d           save_im
+00052e50: 6167 6573 746f 6a73 6f6e 2872 6573 6d61  agestojson(resma
+00052e60: 702c 206f 7574 7075 745f 6a73 6f6e 290a  p, output_json).
 00052e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052e80: 2020 2020 7072 696e 7428 2733 4446 5343      print('3DFSC
-00052e90: 2069 6e70 7574 206d 6170 206e 6565 6420   input map need 
-00052ea0: 746f 2062 6520 6375 6269 6320 616e 6420  to be cubic and 
-00052eb0: 7477 6f20 6861 6c66 206d 6170 7320 6e65  two half maps ne
-00052ec0: 6564 2074 6f20 6861 7665 2073 616d 6520  ed to have same 
-00052ed0: 766f 7865 6c20 7369 7a65 2e27 290a 2020  voxel size.').  
-00052ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00052ef0: 2020 2020 2020 7072 696e 7428 272d 2d2d        print('---
-00052f00: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00052f10: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00052f20: 2d27 290a 0a20 2020 2020 2020 2020 2020  -')..           
-00052f30: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00052f40: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00052f50: 7269 6e74 2827 4e6f 2068 616c 6620 6d61  rint('No half ma
-00052f60: 7020 696e 666f 726d 6174 696f 6e20 666f  p information fo
-00052f70: 7220 3344 4653 4320 6361 6c63 756c 6174  r 3DFSC calculat
-00052f80: 696f 6e2e 2729 0a20 2020 2020 2020 2020  ion.').         
-00052f90: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00052fa0: 2827 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ('--------------
-00052fb0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
-00052fc0: 2d2d 2d2d 2d2d 2729 0a20 2020 2020 2020  ------').       
-00052fd0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00052fe0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
-00052ff0: 2827 4e6f 2074 6872 6565 6466 7363 2069  ('No threedfsc i
-00053000: 6e66 6f72 6d61 7469 6f6e 2070 726f 7669  nformation provi
-00053010: 6465 642c 2075 7365 202d 2d74 6872 6565  ded, use --three
-00053020: 6464 6972 2f2d 7468 7265 6564 6420 3c66  ddir/-threedd <f
-00053030: 756c 6c20 6669 6c65 2070 6174 683e 2e27  ull file path>.'
-00053040: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-00053050: 6e20 4e6f 6e65 0a                        n None.
+00052e80: 2020 2020 6578 6365 7074 3a0a 2020 2020      except:.    
+00052e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00052ea0: 2020 2020 7379 732e 7374 6465 7272 2e77      sys.stderr.w
+00052eb0: 7269 7465 2827 5361 7669 6e67 2074 6f20  rite('Saving to 
+00052ec0: 7265 736d 6170 206a 736f 6e20 6572 726f  resmap json erro
+00052ed0: 723a 207b 7d2e 5c6e 272e 666f 726d 6174  r: {}.\n'.format
+00052ee0: 2873 7973 2e65 7863 5f69 6e66 6f28 295b  (sys.exc_info()[
+00052ef0: 315d 2929 0a20 2020 2020 2020 2020 2020  1])).           
+00052f00: 2020 2020 2065 6e64 203d 2074 696d 6569       end = timei
+00052f10: 742e 6465 6661 756c 745f 7469 6d65 7228  t.default_timer(
+00052f20: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00052f30: 2020 7072 696e 7428 2757 686f 6c65 2052    print('Whole R
+00052f40: 6573 4d61 7020 6c6f 6361 6c20 7265 736f  esMap local reso
+00052f50: 6c75 7469 6f6e 2074 696d 653a 2025 7327  lution time: %s'
+00052f60: 2025 2028 656e 6420 2d20 7374 6172 7429   % (end - start)
+00052f70: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00052f80: 2020 7072 696e 7428 272d 2d2d 2d2d 2d2d    print('-------
+00052f90: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00052fa0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d27 290a  -------------').
+00052fb0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00052fc0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00052fd0: 2020 7072 696e 7428 274e 6f20 6861 6c66    print('No half
+00052fe0: 206d 6170 7320 5265 734d 6170 206c 6f63   maps ResMap loc
+00052ff0: 616c 2072 6573 6f6c 7574 696f 6e20 7769  al resolution wi
+00053000: 6c6c 206e 6f74 2062 6520 6361 6c63 756c  ll not be calcul
+00053010: 6174 6564 2e20 2729 0a20 2020 2020 2020  ated. ').       
+00053020: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
+00053030: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00053040: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00053050: 2d2d 2d2d 2729 0a0a 2020 2020 2020 2020  ----')..        
+00053060: 7265 7475 726e 204e 6f6e 650a 0a0a 2020  return None...  
+00053070: 2020 6465 6620 6c6f 6372 6573 5f68 6973    def locres_his
+00053080: 746f 2873 656c 6629 3a0a 2020 2020 2020  to(self):.      
+00053090: 2020 2222 220a 2020 2020 2020 2020 2020    """.          
+000530a0: 2020 5072 6f64 7563 6520 6c6f 6361 6c20    Produce local 
+000530b0: 7265 736f 6c75 7469 6f6e 2068 6973 746f  resolution histo
+000530c0: 6772 616d 2069 6e66 6f72 6d61 7469 6f6e  gram information
+000530d0: 0a20 2020 2020 2020 2022 2222 0a0a 2020  .        """..  
+000530e0: 2020 2020 2020 7265 7375 6c74 5f64 6963        result_dic
+000530f0: 7420 3d20 7b7d 0a20 2020 2020 2020 2065  t = {}.        e
+00053100: 7272 6c69 7374 203d 205b 5d0a 2020 2020  rrlist = [].    
+00053110: 2020 2020 7374 6172 7420 3d20 7469 6d65      start = time
+00053120: 6974 2e64 6566 6175 6c74 5f74 696d 6572  it.default_timer
+00053130: 2829 0a20 2020 2020 2020 2069 6620 7365  ().        if se
+00053140: 6c66 2e70 6c61 7466 6f72 6d20 3d3d 2027  lf.platform == '
+00053150: 656d 6462 2720 616e 6420 7365 6c66 2e6d  emdb' and self.m
+00053160: 6574 2021 3d20 2774 6f6d 6f27 2061 6e64  et != 'tomo' and
+00053170: 2073 656c 662e 686d 6f64 6420 616e 6420   self.hmodd and 
+00053180: 7365 6c66 2e68 6d65 7665 6e3a 0a20 2020  self.hmeven:.   
+00053190: 2020 2020 2020 2020 206c 6f63 616c 5f72           local_r
+000531a0: 6573 203d 206c 6f63 616c 7265 735f 6869  es = localres_hi
+000531b0: 7374 6f67 7261 6d28 7365 6c66 2e68 6d6f  stogram(self.hmo
+000531c0: 6464 2e66 756c 6c6e 616d 652c 2073 656c  dd.fullname, sel
+000531d0: 662e 6d61 706e 616d 652c 2066 6c6f 6174  f.mapname, float
+000531e0: 2873 656c 662e 7265 736f 6c75 7469 6f6e  (self.resolution
+000531f0: 2929 0a20 2020 2020 2020 2065 6c73 653a  )).        else:
+00053200: 0a20 2020 2020 2020 2020 2020 206c 6f63  .            loc
+00053210: 616c 5f72 6573 203d 204e 6f6e 650a 0a20  al_res = None.. 
+00053220: 2020 2020 2020 2069 6620 6c6f 6361 6c5f         if local_
+00053230: 7265 733a 0a20 2020 2020 2020 2020 2020  res:.           
+00053240: 2072 6573 756c 745f 6469 6374 5b27 6c6f   result_dict['lo
+00053250: 6361 6c5f 7265 735f 6869 7374 6f67 7261  cal_res_histogra
+00053260: 6d27 5d20 3d20 6c6f 6361 6c5f 7265 730a  m'] = local_res.
+00053270: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+00053280: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00053290: 2077 6974 6820 636f 6465 6373 2e6f 7065   with codecs.ope
+000532a0: 6e28 7365 6c66 2e77 6f72 6b64 6972 202b  n(self.workdir +
+000532b0: 2073 656c 662e 6d61 706e 616d 6520 2b20   self.mapname + 
+000532c0: 275f 6c6f 6361 6c72 6573 5f68 6973 746f  '_localres_histo
+000532d0: 2e6a 736f 6e27 2c20 2777 272c 0a20 2020  .json', 'w',.   
+000532e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000532f0: 2020 2020 2020 2020 2020 2020 2020 656e                en
+00053300: 636f 6469 6e67 3d27 7574 662d 3827 2920  coding='utf-8') 
+00053310: 6173 2066 3a0a 2020 2020 2020 2020 2020  as f:.          
+00053320: 2020 2020 2020 2020 2020 6a73 6f6e 2e64            json.d
+00053330: 756d 7028 7265 7375 6c74 5f64 6963 742c  ump(result_dict,
+00053340: 2066 290a 2020 2020 2020 2020 2020 2020   f).            
+00053350: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
+00053360: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
+00053370: 2020 2020 2020 206a 736f 6e65 7272 203d         jsonerr =
+00053380: 2027 5361 7669 6e67 206c 6f63 616c 2072   'Saving local r
+00053390: 6573 6f6c 7574 696f 6e20 6869 7374 6f67  esolution histog
+000533a0: 7261 6d20 746f 206a 736f 6e20 6572 726f  ram to json erro
+000533b0: 723a 207b 7d27 2e66 6f72 6d61 7428 6529  r: {}'.format(e)
+000533c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000533d0: 2065 7272 6c69 7374 2e61 7070 656e 6428   errlist.append(
+000533e0: 6a73 6f6e 6572 7229 0a20 2020 2020 2020  jsonerr).       
+000533f0: 2020 2020 2020 2020 2073 7973 2e73 7464           sys.std
+00053400: 6572 722e 7772 6974 6528 6a73 6f6e 6572  err.write(jsoner
+00053410: 7220 2b20 275c 6e27 290a 2020 2020 2020  r + '\n').      
+00053420: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00053430: 2020 2020 7072 696e 7428 274e 6f20 6c6f      print('No lo
+00053440: 6361 6c20 7265 736f 6c75 7469 6f6e 2068  cal resolution h
+00053450: 6973 746f 6772 616d 2066 6f72 2074 6869  istogram for thi
+00053460: 7320 656e 7472 792c 2063 6865 636b 2068  s entry, check h
+00053470: 616c 6620 6d61 7073 2e27 290a 2020 2020  alf maps.').    
+00053480: 2020 2020 656e 6420 3d20 7469 6d65 6974      end = timeit
+00053490: 2e64 6566 6175 6c74 5f74 696d 6572 2829  .default_timer()
+000534a0: 0a20 2020 2020 2020 2070 7269 6e74 2866  .        print(f
+000534b0: 274c 6f63 616c 2072 6573 6f6c 7574 696f  'Local resolutio
+000534c0: 6e20 7469 6d65 3a20 7b65 6e64 202d 2073  n time: {end - s
+000534d0: 7461 7274 7d27 290a 2020 2020 2020 2020  tart}').        
+000534e0: 7072 696e 7428 272d 2d2d 2d2d 2d2d 2d2d  print('---------
+000534f0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00053500: 2d2d 2d2d 2d2d 2d2d 2d2d 2d27 290a 0a20  -----------').. 
+00053510: 2020 2023 2050 6861 7365 2072 616e 6469     # Phase randi
+00053520: 6d69 7a61 7469 6f6e 0a20 2020 2064 6566  mization.    def
+00053530: 2070 6872 616e 6428 7365 6c66 293a 0a0a   phrand(self):..
+00053540: 2020 2020 2020 2020 7068 6173 6572 616e          phaseran
+00053550: 646f 6d69 7a61 7469 6f6e 2873 656c 662e  domization(self.
+00053560: 6d61 706e 616d 652c 2073 656c 662e 686d  mapname, self.hm
+00053570: 6f64 642e 6675 6c6c 6e61 6d65 2c20 7365  odd.fullname, se
+00053580: 6c66 2e68 6d65 7665 6e2e 6675 6c6c 6e61  lf.hmeven.fullna
+00053590: 6d65 2c20 7365 6c66 2e77 6f72 6b64 6972  me, self.workdir
+000535a0: 290a 0a0a 0a20 2020 2064 6566 2065 6d72  )....    def emr
+000535b0: 696e 6765 7228 7365 6c66 293a 0a20 2020  inger(self):.   
+000535c0: 2020 2020 2022 2222 0a0a 2020 2020 2020       """..      
+000535d0: 2020 2020 2020 456d 7269 6e67 6572 2073        Emringer s
+000535e0: 636f 7265 0a0a 2020 2020 2020 2020 3a72  core..        :r
+000535f0: 6574 7572 6e3a 0a20 2020 2020 2020 2022  eturn:.        "
+00053600: 2222 0a0a 2020 2020 2020 2020 6966 2073  ""..        if s
+00053610: 656c 662e 706c 6174 666f 726d 203d 3d20  elf.platform == 
+00053620: 2765 6d64 6227 2061 6e64 2073 656c 662e  'emdb' and self.
+00053630: 6d65 7420 213d 2027 746f 6d6f 273a 0a20  met != 'tomo':. 
+00053640: 2020 2020 2020 2020 2020 2073 7461 7274             start
+00053650: 203d 2074 696d 6569 742e 6465 6661 756c   = timeit.defaul
+00053660: 745f 7469 6d65 7228 290a 2020 2020 2020  t_timer().      
+00053670: 2020 2020 2020 6572 726c 6973 7420 3d20        errlist = 
+00053680: 5b5d 0a20 2020 2020 2020 2020 2020 2023  [].            #
+00053690: 2069 6620 7374 7275 6465 6c61 7070 2061   if strudelapp a
+000536a0: 6e64 2073 656c 662e 6d6f 6465 6c73 3a0a  nd self.models:.
+000536b0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+000536c0: 656c 662e 6d6f 6465 6c73 3a0a 2020 2020  elf.models:.    
+000536d0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+000536e0: 6d6f 6465 6c20 696e 2073 656c 662e 6d6f  model in self.mo
+000536f0: 6465 6c73 3a0a 2020 2020 2020 2020 2020  dels:.          
+00053700: 2020 2020 2020 2020 2020 6675 6c6c 5f6d            full_m
+00053710: 6f64 656c 203d 2027 7b7d 7b7d 272e 666f  odel = '{}{}'.fo
+00053720: 726d 6174 2873 656c 662e 776f 726b 6469  rmat(self.workdi
+00053730: 722c 206f 732e 7061 7468 2e62 6173 656e  r, os.path.basen
+00053740: 616d 6528 6d6f 6465 6c2e 6669 6c65 6e61  ame(model.filena
+00053750: 6d65 2929 0a20 2020 2020 2020 2020 2020  me)).           
+00053760: 2020 2020 2020 2020 2066 756c 6c5f 6d61           full_ma
+00053770: 7020 3d20 277b 7d7b 7d27 2e66 6f72 6d61  p = '{}{}'.forma
+00053780: 7428 7365 6c66 2e77 6f72 6b64 6972 2c20  t(self.workdir, 
+00053790: 7365 6c66 2e6d 6170 6e61 6d65 290a 2020  self.mapname).  
+000537a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000537b0: 2020 6f75 745f 7061 7468 203d 2027 7b7d    out_path = '{}
+000537c0: 5f65 6d72 696e 6765 7227 2e66 6f72 6d61  _emringer'.forma
+000537d0: 7428 6675 6c6c 5f6d 6f64 656c 290a 0a20  t(full_model).. 
+000537e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000537f0: 2020 2072 6572 7220 3d20 7275 6e5f 656d     rerr = run_em
+00053800: 7269 6e67 6572 2866 756c 6c5f 6d6f 6465  ringer(full_mode
+00053810: 6c2c 2066 756c 6c5f 6d61 702c 206f 7574  l, full_map, out
+00053820: 5f70 6174 6829 0a20 2020 2020 2020 2020  _path).         
+00053830: 2020 2020 2020 2020 2020 2065 6e64 203d             end =
+00053840: 2074 696d 6569 742e 6465 6661 756c 745f   timeit.default_
+00053850: 7469 6d65 7228 290a 2020 2020 2020 2020  timer().        
+00053860: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+00053870: 7428 2745 4d52 696e 6765 7220 7469 6d65  t('EMRinger time
+00053880: 3a20 2573 2720 2520 2865 6e64 202d 2073  : %s' % (end - s
+00053890: 7461 7274 2929 0a20 2020 2020 2020 2020  tart)).         
+000538a0: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+000538b0: 2827 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ('--------------
+000538c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000538d0: 2d2d 2d2d 2d2d 2729 0a20 2020 2020 2020  ------').       
+000538e0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000538f0: 7265 7272 3a0a 2020 2020 2020 2020 2020  rerr:.          
+00053900: 2020 2020 2020 2020 2020 2020 2020 6572                er
+00053910: 7220 3d20 2753 7472 7564 656c 2063 616c  r = 'Strudel cal
+00053920: 6375 6c61 7469 6f6e 2065 7272 6f72 3a20  culation error: 
+00053930: 7b7d 272e 666f 726d 6174 2872 6572 7229  {}'.format(rerr)
+00053940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00053950: 2020 2020 2020 2020 2065 7272 6c69 7374           errlist
+00053960: 2e61 7070 656e 6428 6572 7229 0a20 2020  .append(err).   
+00053970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053980: 2020 2020 2073 7973 2e73 7464 6572 722e       sys.stderr.
+00053990: 7772 6974 6528 6572 7220 2b20 275c 6e27  write(err + '\n'
+000539a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000539b0: 2020 2020 2020 2020 2020 7072 696e 7428            print(
+000539c0: 272d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  '---------------
+000539d0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+000539e0: 2d2d 2d2d 2d27 290a 0a20 2020 2020 2020  -----')..       
+000539f0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00053a00: 2020 2020 2020 2020 2020 2070 7269 6e74             print
+00053a10: 2827 4e6f 206d 6f64 656c 206f 7220 7265  ('No model or re
+00053a20: 736f 6c75 7469 6f6e 2069 7320 6e6f 7420  solution is not 
+00053a30: 636f 7665 7265 6420 696e 2074 6865 206d  covered in the m
+00053a40: 6f74 6966 206c 6962 7261 7279 2028 3c34  otif library (<4
+00053a50: 2e30 c385 2920 2729 0a20 2020 2020 2020  .0..) ').       
+00053a60: 2020 2020 2020 2020 2070 7269 6e74 2827           print('
+00053a70: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00053a80: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00053a90: 2d2d 2d2d 2729 0a0a 2020 2020 2020 2020  ----')..        
+00053aa0: 7265 7475 726e 204e 6f6e 650a 0a0a 2020  return None...  
+00053ab0: 2020 6465 6620 7468 7265 6564 6673 6328    def threedfsc(
+00053ac0: 7365 6c66 293a 0a20 2020 2020 2020 2022  self):.        "
+00053ad0: 2222 0a0a 2020 2020 2020 2020 2020 2020  ""..            
+00053ae0: 456d 7269 6e67 6572 2073 636f 7265 0a0a  Emringer score..
+00053af0: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
+00053b00: 0a20 2020 2020 2020 2022 2222 0a0a 2020  .        """..  
+00053b10: 2020 2020 2020 6966 2073 656c 662e 706c        if self.pl
+00053b20: 6174 666f 726d 203d 3d20 2765 6d64 6227  atform == 'emdb'
+00053b30: 2061 6e64 2073 656c 662e 6d65 7420 213d   and self.met !=
+00053b40: 2027 746f 6d6f 273a 0a20 2020 2020 2020   'tomo':.       
+00053b50: 2020 2020 2069 6620 7365 6c66 2e74 6872       if self.thr
+00053b60: 6565 6466 7363 6469 7220 6973 206e 6f74  eedfscdir is not
+00053b70: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00053b80: 2020 2020 2020 2073 7461 7274 203d 2074         start = t
+00053b90: 696d 6569 742e 6465 6661 756c 745f 7469  imeit.default_ti
+00053ba0: 6d65 7228 290a 2020 2020 2020 2020 2020  mer().          
+00053bb0: 2020 2020 2020 6572 726c 6973 7420 3d20        errlist = 
+00053bc0: 5b5d 0a20 2020 2020 2020 2020 2020 2020  [].             
+00053bd0: 2020 2069 6620 7365 6c66 2e68 6d6f 6464     if self.hmodd
+00053be0: 2069 7320 6e6f 7420 4e6f 6e65 2061 6e64   is not None and
+00053bf0: 2073 656c 662e 686d 6576 656e 2069 7320   self.hmeven is 
+00053c00: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+00053c10: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
+00053c20: 745f 7061 7468 203d 2027 7b7d 5f33 6466  t_path = '{}_3df
+00053c30: 7363 272e 666f 726d 6174 2873 656c 662e  sc'.format(self.
+00053c40: 6d61 702e 6675 6c6c 6e61 6d65 290a 2020  map.fullname).  
+00053c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053c60: 2020 7678 7369 7a65 7320 3d20 7365 6c66    vxsizes = self
+00053c70: 2e6d 6170 2e76 6f78 656c 5f73 697a 650a  .map.voxel_size.
+00053c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053c90: 2020 2020 6966 2076 7873 697a 6573 2e78      if vxsizes.x
+00053ca0: 203d 3d20 7678 7369 7a65 732e 7920 3d3d   == vxsizes.y ==
+00053cb0: 2076 7873 697a 6573 2e7a 2061 6e64 2073   vxsizes.z and s
+00053cc0: 656c 662e 686d 6f64 642e 766f 7865 6c5f  elf.hmodd.voxel_
+00053cd0: 7369 7a65 203d 3d20 7365 6c66 2e68 6d65  size == self.hme
+00053ce0: 7665 6e2e 766f 7865 6c5f 7369 7a65 3a0a  ven.voxel_size:.
+00053cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053d00: 2020 2020 2020 2020 7265 7272 203d 2072          rerr = r
+00053d10: 756e 5f74 6872 6565 6466 7363 2873 656c  un_threedfsc(sel
+00053d20: 662e 686d 6f64 642e 6675 6c6c 6e61 6d65  f.hmodd.fullname
+00053d30: 2c20 7365 6c66 2e68 6d65 7665 6e2e 6675  , self.hmeven.fu
+00053d40: 6c6c 6e61 6d65 2c20 7365 6c66 2e6d 6170  llname, self.map
+00053d50: 2e66 756c 6c6e 616d 652c 0a20 2020 2020  .fullname,.     
+00053d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053d80: 2020 2020 2020 2020 7678 7369 7a65 732e          vxsizes.
+00053d90: 782c 206f 7574 5f70 6174 682c 2073 656c  x, out_path, sel
+00053da0: 662e 7468 7265 6564 6673 6364 6972 290a  f.threedfscdir).
+00053db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053dc0: 2020 2020 2020 2020 656e 6420 3d20 7469          end = ti
+00053dd0: 6d65 6974 2e64 6566 6175 6c74 5f74 696d  meit.default_tim
+00053de0: 6572 2829 0a20 2020 2020 2020 2020 2020  er().           
+00053df0: 2020 2020 2020 2020 2020 2020 2070 7269               pri
+00053e00: 6e74 2827 3344 4653 4320 7469 6d65 3a20  nt('3DFSC time: 
+00053e10: 2573 2720 2520 2865 6e64 202d 2073 7461  %s' % (end - sta
+00053e20: 7274 2929 0a20 2020 2020 2020 2020 2020  rt)).           
+00053e30: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00053e40: 7265 7272 3a0a 2020 2020 2020 2020 2020  rerr:.          
+00053e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053e60: 2020 6572 7220 3d20 2733 4446 5343 2063    err = '3DFSC c
+00053e70: 616c 6375 6c61 7469 6f6e 2065 7272 6f72  alculation error
+00053e80: 3a20 7b7d 272e 666f 726d 6174 2872 6572  : {}'.format(rer
+00053e90: 7229 0a20 2020 2020 2020 2020 2020 2020  r).             
+00053ea0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00053eb0: 7272 6c69 7374 2e61 7070 656e 6428 6572  rrlist.append(er
+00053ec0: 7229 0a20 2020 2020 2020 2020 2020 2020  r).             
+00053ed0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00053ee0: 7973 2e73 7464 6572 722e 7772 6974 6528  ys.stderr.write(
+00053ef0: 6572 7220 2b20 275c 6e27 290a 2020 2020  err + '\n').    
+00053f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053f10: 2020 2020 2020 2020 7072 696e 7428 272d          print('-
+00053f20: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00053f30: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00053f40: 2d2d 2d27 290a 2020 2020 2020 2020 2020  ---').          
+00053f50: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00053f60: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00053f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053f80: 7072 696e 7428 272d 2d2d 2d2d 2d2d 2d2d  print('---------
+00053f90: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00053fa0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d27 290a 0a20  -----------').. 
+00053fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053fc0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00053fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00053fe0: 2070 7269 6e74 2827 3344 4653 4320 696e   print('3DFSC in
+00053ff0: 7075 7420 6d61 7020 6e65 6564 2074 6f20  put map need to 
+00054000: 6265 2063 7562 6963 2061 6e64 2074 776f  be cubic and two
+00054010: 2068 616c 6620 6d61 7073 206e 6565 6420   half maps need 
+00054020: 746f 2068 6176 6520 7361 6d65 2076 6f78  to have same vox
+00054030: 656c 2073 697a 652e 2729 0a20 2020 2020  el size.').     
+00054040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00054050: 2020 2070 7269 6e74 2827 2d2d 2d2d 2d2d     print('------
+00054060: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00054070: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2729  --------------')
+00054080: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00054090: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000540a0: 2020 2020 2020 2020 2020 2020 7072 696e              prin
+000540b0: 7428 274e 6f20 6861 6c66 206d 6170 2069  t('No half map i
+000540c0: 6e66 6f72 6d61 7469 6f6e 2066 6f72 2033  nformation for 3
+000540d0: 4446 5343 2063 616c 6375 6c61 7469 6f6e  DFSC calculation
+000540e0: 2e27 290a 2020 2020 2020 2020 2020 2020  .').            
+000540f0: 2020 2020 2020 2020 7072 696e 7428 272d          print('-
+00054100: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00054110: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+00054120: 2d2d 2d27 290a 2020 2020 2020 2020 2020  ---').          
+00054130: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00054140: 2020 2020 2020 2020 7072 696e 7428 274e          print('N
+00054150: 6f20 7468 7265 6564 6673 6320 696e 666f  o threedfsc info
+00054160: 726d 6174 696f 6e20 7072 6f76 6964 6564  rmation provided
+00054170: 2c20 7573 6520 2d2d 7468 7265 6564 6469  , use --threeddi
+00054180: 722f 2d74 6872 6565 6464 203c 6675 6c6c  r/-threedd <full
+00054190: 2066 696c 6520 7061 7468 3e2e 2729 0a0a   file path>.')..
+000541a0: 2020 2020 2020 2020 7265 7475 726e 204e          return N
+000541b0: 6f6e 650a                                one.
```

### Comparing `emdbva-0.0.1.dev2/va/version.py` & `emdbva-0.1.2.dev1/va/version.py`

 * *Files 1% similar despite different names*

```diff
@@ -24,8 +24,8 @@
 an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 KIND, either express or implied. See the License for the
 specific language governing permissions and limitations
 under the License.
 
 """
 
-__version__ = '0.0.1.dev02'
+__version__ = '0.0.1.dev98'
```

