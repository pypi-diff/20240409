# Comparing `tmp/mindnlp-0.2.3-py3-none-any.whl.zip` & `tmp/mindnlp-0.2.4-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,856 +1,1004 @@
-Zip file size: 2963491 bytes, number of entries: 854
--r--------  2.0 unx     1162 b- defN 24-Mar-28 23:57 mindnlp/__init__.py
--r--------  2.0 unx     2170 b- defN 24-Mar-28 23:57 mindnlp/configs.py
--r--------  2.0 unx    37100 b- defN 24-Mar-28 23:57 mindnlp/injection.py
--r--------  2.0 unx     7940 b- defN 24-Mar-28 23:57 mindnlp/_csrc/cuda/wkv.cu
--r--------  2.0 unx      707 b- defN 24-Mar-28 23:57 mindnlp/_legacy/__init__.py
--r--------  2.0 unx     7978 b- defN 24-Mar-28 23:57 mindnlp/_legacy/amp.py
--r--------  2.0 unx    67590 b- defN 24-Mar-28 23:57 mindnlp/_legacy/functional.py
--r--------  2.0 unx     2633 b- defN 24-Mar-28 23:57 mindnlp/_legacy/initializer.py
--r--------  2.0 unx     3284 b- defN 24-Mar-28 23:57 mindnlp/_legacy/utils.py
--r--------  2.0 unx      883 b- defN 24-Mar-28 23:57 mindnlp/_legacy/hypercomplex/__init__.py
--r--------  2.0 unx     1755 b- defN 24-Mar-28 23:57 mindnlp/_legacy/hypercomplex/utils.py
--r--------  2.0 unx      882 b- defN 24-Mar-28 23:57 mindnlp/_legacy/hypercomplex/complex/__init__.py
--r--------  2.0 unx     6981 b- defN 24-Mar-28 23:57 mindnlp/_legacy/hypercomplex/complex/_complex_bn_impl.py
--r--------  2.0 unx    11071 b- defN 24-Mar-28 23:57 mindnlp/_legacy/hypercomplex/complex/_complex_conv_impl.py
--r--------  2.0 unx     5878 b- defN 24-Mar-28 23:57 mindnlp/_legacy/hypercomplex/complex/_complex_dense_impl.py
--r--------  2.0 unx     2146 b- defN 24-Mar-28 23:57 mindnlp/_legacy/hypercomplex/complex/_complex_relu.py
--r--------  2.0 unx    65137 b- defN 24-Mar-28 23:57 mindnlp/_legacy/hypercomplex/complex/complex_operators.py
--r--------  2.0 unx     2195 b- defN 24-Mar-28 23:57 mindnlp/_legacy/hypercomplex/complex/complex_relu.py
--r--------  2.0 unx      882 b- defN 24-Mar-28 23:57 mindnlp/_legacy/hypercomplex/double/__init__.py
--r--------  2.0 unx    12850 b- defN 24-Mar-28 23:57 mindnlp/_legacy/hypercomplex/double/_double_bn_impl.py
--r--------  2.0 unx     6638 b- defN 24-Mar-28 23:57 mindnlp/_legacy/hypercomplex/double/_double_conv_impl.py
--r--------  2.0 unx     5749 b- defN 24-Mar-28 23:57 mindnlp/_legacy/hypercomplex/double/_double_dense_impl.py
--r--------  2.0 unx    74411 b- defN 24-Mar-28 23:57 mindnlp/_legacy/hypercomplex/double/double_operators.py
--r--------  2.0 unx     2535 b- defN 24-Mar-28 23:57 mindnlp/_legacy/hypercomplex/double/double_relu.py
--r--------  2.0 unx      870 b- defN 24-Mar-28 23:57 mindnlp/_legacy/hypercomplex/dual/__init__.py
--r--------  2.0 unx     6955 b- defN 24-Mar-28 23:57 mindnlp/_legacy/hypercomplex/dual/_dual_bn_impl.py
--r--------  2.0 unx     7365 b- defN 24-Mar-28 23:57 mindnlp/_legacy/hypercomplex/dual/_dual_conv_impl.py
--r--------  2.0 unx     3132 b- defN 24-Mar-28 23:57 mindnlp/_legacy/hypercomplex/dual/_dual_dense_impl.py
--r--------  2.0 unx     2667 b- defN 24-Mar-28 23:57 mindnlp/_legacy/hypercomplex/dual/dual_functions.py
--r--------  2.0 unx    55061 b- defN 24-Mar-28 23:57 mindnlp/_legacy/hypercomplex/dual/dual_operators.py
--r--------  2.0 unx      191 b- defN 24-Mar-28 23:57 mindnlp/_legacy/hypercomplex/hypercomplex/__init__.py
--r--------  2.0 unx    17631 b- defN 24-Mar-28 23:57 mindnlp/_legacy/hypercomplex/hypercomplex/_hc_bn_impl.py
--r--------  2.0 unx     5893 b- defN 24-Mar-28 23:57 mindnlp/_legacy/hypercomplex/hypercomplex/_hc_conv_impl.py
--r--------  2.0 unx     5140 b- defN 24-Mar-28 23:57 mindnlp/_legacy/hypercomplex/hypercomplex/_hc_dense_impl.py
--r--------  2.0 unx    36029 b- defN 24-Mar-28 23:57 mindnlp/_legacy/hypercomplex/hypercomplex/hc_bn.py
--r--------  2.0 unx    49241 b- defN 24-Mar-28 23:57 mindnlp/_legacy/hypercomplex/hypercomplex/hc_conv.py
--r--------  2.0 unx    11082 b- defN 24-Mar-28 23:57 mindnlp/_legacy/hypercomplex/hypercomplex/hc_dense.py
--r--------  2.0 unx    44353 b- defN 24-Mar-28 23:57 mindnlp/_legacy/hypercomplex/hypercomplex/hc_pool.py
--r--------  2.0 unx     1691 b- defN 24-Mar-28 23:57 mindnlp/_legacy/hypercomplex/hypercomplex/uniform_operator.py
--r--------  2.0 unx     1092 b- defN 24-Mar-28 23:57 mindnlp/_legacy/nn/__init__.py
--r--------  2.0 unx     3367 b- defN 24-Mar-28 23:57 mindnlp/_legacy/nn/dropout.py
--r--------  2.0 unx      896 b- defN 24-Mar-28 23:57 mindnlp/_legacy/nn/half_op.py
--r--------  2.0 unx    33081 b- defN 24-Mar-28 23:57 mindnlp/_legacy/nn/transformer.py
--r--------  2.0 unx      797 b- defN 24-Mar-28 23:57 mindnlp/_legacy/ops/__init__.py
--r--------  2.0 unx     1196 b- defN 24-Mar-28 23:57 mindnlp/_legacy/ops/parallel.py
--r--------  2.0 unx      872 b- defN 24-Mar-28 23:57 mindnlp/_legacy/transforms/__init__.py
--r--------  2.0 unx     2110 b- defN 24-Mar-28 23:57 mindnlp/_legacy/transforms/add_token.py
--r--------  2.0 unx     1880 b- defN 24-Mar-28 23:57 mindnlp/_legacy/transforms/truncate.py
--r--------  2.0 unx      822 b- defN 24-Mar-28 23:57 mindnlp/abc/__init__.py
--r--------  2.0 unx     2926 b- defN 24-Mar-28 23:57 mindnlp/abc/callback.py
--r--------  2.0 unx     5945 b- defN 24-Mar-28 23:57 mindnlp/abc/container.py
--r--------  2.0 unx     2870 b- defN 24-Mar-28 23:57 mindnlp/abc/metric.py
--r--------  2.0 unx     1466 b- defN 24-Mar-28 23:57 mindnlp/abc/register.py
--r--------  2.0 unx      823 b- defN 24-Mar-28 23:57 mindnlp/abc/models/__init__.py
--r--------  2.0 unx     6023 b- defN 24-Mar-28 23:57 mindnlp/abc/models/base_model.py
--r--------  2.0 unx     3414 b- defN 24-Mar-28 23:57 mindnlp/abc/models/seq2seq_model.py
--r--------  2.0 unx     2934 b- defN 24-Mar-28 23:57 mindnlp/abc/models/seq2vec_model.py
--r--------  2.0 unx      811 b- defN 24-Mar-28 23:57 mindnlp/abc/modules/__init__.py
--r--------  2.0 unx     2816 b- defN 24-Mar-28 23:57 mindnlp/abc/modules/decoder.py
--r--------  2.0 unx     2408 b- defN 24-Mar-28 23:57 mindnlp/abc/modules/embedding.py
--r--------  2.0 unx     2360 b- defN 24-Mar-28 23:57 mindnlp/abc/modules/encoder.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/abc/modules/generator.py
--r--------  2.0 unx      790 b- defN 24-Mar-28 23:57 mindnlp/data/__init__.py
--r--------  2.0 unx      736 b- defN 24-Mar-28 23:57 mindnlp/data/io/__init__.py
--r--------  2.0 unx    34595 b- defN 24-Mar-28 23:57 mindnlp/data/io/audio.py
--r--------  2.0 unx      768 b- defN 24-Mar-28 23:57 mindnlp/data/processors/__init__.py
--r--------  2.0 unx    20407 b- defN 24-Mar-28 23:57 mindnlp/data/processors/squad.py
--r--------  2.0 unx      720 b- defN 24-Mar-28 23:57 mindnlp/dataset/__init__.py
--r--------  2.0 unx    13264 b- defN 24-Mar-28 23:57 mindnlp/dataset/load.py
--r--------  2.0 unx     1921 b- defN 24-Mar-28 23:57 mindnlp/dataset/utils.py
--r--------  2.0 unx     1150 b- defN 24-Mar-28 23:57 mindnlp/dataset/transforms/__init__.py
--r--------  2.0 unx     9716 b- defN 24-Mar-28 23:57 mindnlp/dataset/transforms/basic_tokenizer.py
--r--------  2.0 unx     2508 b- defN 24-Mar-28 23:57 mindnlp/dataset/transforms/lookup.py
--r--------  2.0 unx     2548 b- defN 24-Mar-28 23:57 mindnlp/dataset/transforms/pad_transform.py
--r--------  2.0 unx      779 b- defN 24-Mar-28 23:57 mindnlp/engine/__init__.py
--r--------  2.0 unx     8106 b- defN 24-Mar-28 23:57 mindnlp/engine/evaluator.py
--r--------  2.0 unx      770 b- defN 24-Mar-28 23:57 mindnlp/engine/export.py
--r--------  2.0 unx      807 b- defN 24-Mar-28 23:57 mindnlp/engine/train_args.py
--r--------  2.0 unx     1125 b- defN 24-Mar-28 23:57 mindnlp/engine/utils.py
--r--------  2.0 unx      927 b- defN 24-Mar-28 23:57 mindnlp/engine/callbacks/__init__.py
--r--------  2.0 unx     5118 b- defN 24-Mar-28 23:57 mindnlp/engine/callbacks/best_model_callback.py
--r--------  2.0 unx     4086 b- defN 24-Mar-28 23:57 mindnlp/engine/callbacks/callback_manager.py
--r--------  2.0 unx     4156 b- defN 24-Mar-28 23:57 mindnlp/engine/callbacks/checkpoint_callback.py
--r--------  2.0 unx     2464 b- defN 24-Mar-28 23:57 mindnlp/engine/callbacks/earlystop_callback.py
--r--------  2.0 unx     6079 b- defN 24-Mar-28 23:57 mindnlp/engine/callbacks/timer_callback.py
--r--------  2.0 unx      753 b- defN 24-Mar-28 23:57 mindnlp/engine/trainer/__init__.py
--r--------  2.0 unx    16949 b- defN 24-Mar-28 23:57 mindnlp/engine/trainer/base.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/engine/trainer/ppo.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/engine/trainer/rm.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/engine/trainer/sft.py
--r--------  2.0 unx     3704 b- defN 24-Mar-28 23:57 mindnlp/engine/trainer/utils.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/evaluate/__init__.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/evaluate/suite.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/evaluate/evaluator/__init__.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/evaluate/evaluator/audio_classification.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/evaluate/evaluator/automatic_speech_recognition.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/evaluate/evaluator/base.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/evaluate/evaluator/image_classification.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/evaluate/evaluator/question_answering.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/evaluate/evaluator/text2text_generation.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/evaluate/evaluator/text_classification.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/evaluate/evaluator/text_generation.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/evaluate/evaluator/token_classification.py
--r--------  2.0 unx     1590 b- defN 24-Mar-28 23:57 mindnlp/metrics/__init__.py
--r--------  2.0 unx     7525 b- defN 24-Mar-28 23:57 mindnlp/metrics/accuracy.py
--r--------  2.0 unx    10364 b- defN 24-Mar-28 23:57 mindnlp/metrics/bleu.py
--r--------  2.0 unx     6201 b- defN 24-Mar-28 23:57 mindnlp/metrics/confusion_matrix.py
--r--------  2.0 unx     4231 b- defN 24-Mar-28 23:57 mindnlp/metrics/distinct.py
--r--------  2.0 unx     6130 b- defN 24-Mar-28 23:57 mindnlp/metrics/em_score.py
--r--------  2.0 unx     8006 b- defN 24-Mar-28 23:57 mindnlp/metrics/f1.py
--r--------  2.0 unx     7665 b- defN 24-Mar-28 23:57 mindnlp/metrics/matthews.py
--r--------  2.0 unx     7280 b- defN 24-Mar-28 23:57 mindnlp/metrics/pearson.py
--r--------  2.0 unx     9898 b- defN 24-Mar-28 23:57 mindnlp/metrics/perplexity.py
--r--------  2.0 unx     7040 b- defN 24-Mar-28 23:57 mindnlp/metrics/precision.py
--r--------  2.0 unx     6746 b- defN 24-Mar-28 23:57 mindnlp/metrics/recall.py
--r--------  2.0 unx    12329 b- defN 24-Mar-28 23:57 mindnlp/metrics/rouge.py
--r--------  2.0 unx     6735 b- defN 24-Mar-28 23:57 mindnlp/metrics/spearman.py
--r--------  2.0 unx     4407 b- defN 24-Mar-28 23:57 mindnlp/metrics/utils.py
--r--------  2.0 unx     2229 b- defN 24-Mar-28 23:57 mindnlp/modules/__init__.py
--r--------  2.0 unx     1966 b- defN 24-Mar-28 23:57 mindnlp/modules/accumulator.py
--r--------  2.0 unx    22547 b- defN 24-Mar-28 23:57 mindnlp/modules/attentions.py
--r--------  2.0 unx    13033 b- defN 24-Mar-28 23:57 mindnlp/modules/crf.py
--r--------  2.0 unx     6458 b- defN 24-Mar-28 23:57 mindnlp/modules/loss.py
--r--------  2.0 unx    22885 b- defN 24-Mar-28 23:57 mindnlp/modules/rnns.py
--r--------  2.0 unx     7084 b- defN 24-Mar-28 23:57 mindnlp/modules/weight_norm.py
--r--------  2.0 unx      702 b- defN 24-Mar-28 23:57 mindnlp/modules/custom/__init__.py
--r--------  2.0 unx      773 b- defN 24-Mar-28 23:57 mindnlp/modules/decoder/__init__.py
--r--------  2.0 unx    10869 b- defN 24-Mar-28 23:57 mindnlp/modules/decoder/rnn_decoder.py
--r--------  2.0 unx      801 b- defN 24-Mar-28 23:57 mindnlp/modules/embeddings/__init__.py
--r--------  2.0 unx     8276 b- defN 24-Mar-28 23:57 mindnlp/modules/embeddings/fasttext_embedding.py
--r--------  2.0 unx     8267 b- defN 24-Mar-28 23:57 mindnlp/modules/embeddings/glove_embedding.py
--r--------  2.0 unx      824 b- defN 24-Mar-28 23:57 mindnlp/modules/encoder/__init__.py
--r--------  2.0 unx     4712 b- defN 24-Mar-28 23:57 mindnlp/modules/encoder/cnn_encoder.py
--r--------  2.0 unx     4145 b- defN 24-Mar-28 23:57 mindnlp/modules/encoder/rnn_encoder.py
--r--------  2.0 unx      762 b- defN 24-Mar-28 23:57 mindnlp/modules/functional/__init__.py
--r--------  2.0 unx     2705 b- defN 24-Mar-28 23:57 mindnlp/modules/functional/graph_func.py
--r--------  2.0 unx      985 b- defN 24-Mar-28 23:57 mindnlp/modules/functional/neural_network.py
--r--------  2.0 unx     3298 b- defN 24-Mar-28 23:57 mindnlp/modules/functional/weight_norm.py
--r--------  2.0 unx      846 b- defN 24-Mar-28 23:57 mindnlp/parallel/__init__.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/parallel/pipeline_parallel/__init__.py
--r--------  2.0 unx      818 b- defN 24-Mar-28 23:57 mindnlp/parallel/tensor_parallel/__init__.py
--r--------  2.0 unx    11750 b- defN 24-Mar-28 23:57 mindnlp/parallel/tensor_parallel/layers.py
--r--------  2.0 unx     4587 b- defN 24-Mar-28 23:57 mindnlp/parallel/tensor_parallel/mappings.py
--r--------  2.0 unx     3369 b- defN 24-Mar-28 23:57 mindnlp/parallel/tensor_parallel/utils.py
--r--------  2.0 unx     1594 b- defN 24-Mar-28 23:57 mindnlp/peft/__init__.py
--r--------  2.0 unx     6758 b- defN 24-Mar-28 23:57 mindnlp/peft/config.py
--r--------  2.0 unx     3322 b- defN 24-Mar-28 23:57 mindnlp/peft/mapping.py
--r--------  2.0 unx    37352 b- defN 24-Mar-28 23:57 mindnlp/peft/peft_model.py
--r--------  2.0 unx      738 b- defN 24-Mar-28 23:57 mindnlp/peft/tuners/__init__.py
--r--------  2.0 unx    37392 b- defN 24-Mar-28 23:57 mindnlp/peft/tuners/lora.py
--r--------  2.0 unx    11619 b- defN 24-Mar-28 23:57 mindnlp/peft/tuners/tuners_utils.py
--r--------  2.0 unx     1756 b- defN 24-Mar-28 23:57 mindnlp/peft/utils/__init__.py
--r--------  2.0 unx    11128 b- defN 24-Mar-28 23:57 mindnlp/peft/utils/other.py
--r--------  2.0 unx     1242 b- defN 24-Mar-28 23:57 mindnlp/peft/utils/peft_types.py
--r--------  2.0 unx     5767 b- defN 24-Mar-28 23:57 mindnlp/peft/utils/save_and_load.py
--r--------  2.0 unx     1287 b- defN 24-Mar-28 23:57 mindnlp/transformers/__init__.py
--r--------  2.0 unx     2295 b- defN 24-Mar-28 23:57 mindnlp/transformers/activations.py
--r--------  2.0 unx    29318 b- defN 24-Mar-28 23:57 mindnlp/transformers/audio_utils.py
--r--------  2.0 unx    20239 b- defN 24-Mar-28 23:57 mindnlp/transformers/cache_utils.py
--r--------  2.0 unx    35012 b- defN 24-Mar-28 23:57 mindnlp/transformers/configuration_utils.py
--r--------  2.0 unx    53285 b- defN 24-Mar-28 23:57 mindnlp/transformers/convert_slow_tokenizer.py
--r--------  2.0 unx    18222 b- defN 24-Mar-28 23:57 mindnlp/transformers/feature_extraction_sequence_utils.py
--r--------  2.0 unx    26672 b- defN 24-Mar-28 23:57 mindnlp/transformers/feature_extraction_utils.py
--r--------  2.0 unx    33187 b- defN 24-Mar-28 23:57 mindnlp/transformers/image_processing_utils.py
--r--------  2.0 unx    32924 b- defN 24-Mar-28 23:57 mindnlp/transformers/image_transforms.py
--r--------  2.0 unx    29937 b- defN 24-Mar-28 23:57 mindnlp/transformers/image_utils.py
--r--------  2.0 unx     2939 b- defN 24-Mar-28 23:57 mindnlp/transformers/kernel_utils.py
--r--------  2.0 unx    10957 b- defN 24-Mar-28 23:57 mindnlp/transformers/modeling_attn_mask_utils.py
--r--------  2.0 unx   111179 b- defN 24-Mar-28 23:57 mindnlp/transformers/modeling_outputs.py
--r--------  2.0 unx    96544 b- defN 24-Mar-28 23:57 mindnlp/transformers/modeling_utils.py
--r--------  2.0 unx     8657 b- defN 24-Mar-28 23:57 mindnlp/transformers/ms_utils.py
--r--------  2.0 unx    10219 b- defN 24-Mar-28 23:57 mindnlp/transformers/processing_utils.py
--r--------  2.0 unx     6636 b- defN 24-Mar-28 23:57 mindnlp/transformers/time_series_utils.py
--r--------  2.0 unx    44063 b- defN 24-Mar-28 23:57 mindnlp/transformers/tokenization_utils.py
--r--------  2.0 unx   175003 b- defN 24-Mar-28 23:57 mindnlp/transformers/tokenization_utils_base.py
--r--------  2.0 unx    37089 b- defN 24-Mar-28 23:57 mindnlp/transformers/tokenization_utils_fast.py
--r--------  2.0 unx      829 b- defN 24-Mar-28 23:57 mindnlp/transformers/generation/__init__.py
--r--------  2.0 unx    19732 b- defN 24-Mar-28 23:57 mindnlp/transformers/generation/beam_constraints.py
--r--------  2.0 unx    43463 b- defN 24-Mar-28 23:57 mindnlp/transformers/generation/beam_search.py
--r--------  2.0 unx    32032 b- defN 24-Mar-28 23:57 mindnlp/transformers/generation/configuration_utils.py
--r--------  2.0 unx    66891 b- defN 24-Mar-28 23:57 mindnlp/transformers/generation/logits_process.py
--r--------  2.0 unx     5067 b- defN 24-Mar-28 23:57 mindnlp/transformers/generation/stopping_criteria.py
--r--------  2.0 unx     9287 b- defN 24-Mar-28 23:57 mindnlp/transformers/generation/streamers.py
--r--------  2.0 unx   250613 b- defN 24-Mar-28 23:57 mindnlp/transformers/generation/utils.py
--r--------  2.0 unx     6206 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/__init__.py
--r--------  2.0 unx     1120 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/albert/__init__.py
--r--------  2.0 unx     8303 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/albert/configuration_albert.py
--r--------  2.0 unx    48840 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/albert/modeling_albert.py
--r--------  2.0 unx    15804 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/albert/tokenization_albert.py
--r--------  2.0 unx    11024 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/albert/tokenization_albert_fast.py
--r--------  2.0 unx      989 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/align/__init__.py
--r--------  2.0 unx    18320 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/align/configuration_align.py
--r--------  2.0 unx    63750 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/align/modeling_align.py
--r--------  2.0 unx     6222 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/align/processing_align.py
--r--------  2.0 unx     1007 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/altclip/__init__.py
--r--------  2.0 unx    19999 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/altclip/configuration_altclip.py
--r--------  2.0 unx    73075 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/altclip/modeling_altclip.py
--r--------  2.0 unx     6589 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/altclip/processing_altclip.py
--r--------  2.0 unx     1252 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/audio_spectrogram_transformer/__init__.py
--r--------  2.0 unx     5830 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/audio_spectrogram_transformer/configuration_audio_spectrogram_transformer.py
--r--------  2.0 unx     9478 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/audio_spectrogram_transformer/feature_extraction_audio_spectrogram_transformer.py
--r--------  2.0 unx    22723 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/audio_spectrogram_transformer/modeling_audio_spectrogram_transformer.py
--r--------  2.0 unx     6545 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/auto/__init__.py
--r--------  2.0 unx    10729 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/auto/auto_factory.py
--r--------  2.0 unx    40009 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/auto/configuration_auto.py
--r--------  2.0 unx    18666 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/auto/feature_extraction_auto.py
--r--------  2.0 unx    20881 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/auto/image_processing_auto.py
--r--------  2.0 unx    40237 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/auto/modeling_auto.py
--r--------  2.0 unx    12314 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/auto/modeling_graph_auto.py
--r--------  2.0 unx    15357 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/auto/processing_auto.py
--r--------  2.0 unx    39369 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/auto/tokenization_auto.py
--r--------  2.0 unx      935 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/autoformer/__init__.py
--r--------  2.0 unx    12462 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/autoformer/configuration_autoformer.py
--r--------  2.0 unx    97091 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/autoformer/modeling_autoformer.py
--r--------  2.0 unx     1028 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/baichuan/__init__.py
--r--------  2.0 unx     2461 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/baichuan/configuration_baichuan.py
--r--------  2.0 unx    43284 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/baichuan/modeling_baichuan.py
--r--------  2.0 unx     9639 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/baichuan/tokenization_baichuan.py
--r--------  2.0 unx     1118 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bark/__init__.py
--r--------  2.0 unx    10961 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bark/configuration_bark.py
--r--------  2.0 unx    15088 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bark/generation_configuration_bark.py
--r--------  2.0 unx    62439 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bark/modeling_bark.py
--r--------  2.0 unx    12929 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bark/processing_bark.py
--r--------  2.0 unx     1097 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bart/__init__.py
--r--------  2.0 unx     8553 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bart/configuration_bart.py
--r--------  2.0 unx    75827 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bart/modeling_bart.py
--r--------  2.0 unx    18082 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bart/tokenization_bart.py
--r--------  2.0 unx    14266 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bart/tokenization_bart_fast.py
--r--------  2.0 unx      940 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/barthez/__init__.py
--r--------  2.0 unx    12831 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/barthez/tokenization_barthez.py
--r--------  2.0 unx     8996 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/barthez/tokenization_barthez_fast.py
--r--------  2.0 unx      822 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bartpho/__init__.py
--r--------  2.0 unx    14087 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bartpho/tokenization_bartpho.py
--r--------  2.0 unx      999 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/beit/__init__.py
--r--------  2.0 unx    11381 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/beit/configuration_beit.py
--r--------  2.0 unx    25144 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/beit/image_processing_beit.py
--r--------  2.0 unx    56500 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/beit/modeling_beit.py
--r--------  2.0 unx     1196 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bert/__init__.py
--r--------  2.0 unx     2598 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bert/configuration_bert.py
--r--------  2.0 unx    93194 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bert/modeling_bert.py
--r--------  2.0 unx    24981 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bert/modeling_graph_bert.py
--r--------  2.0 unx    25179 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bert/tokenization_bert.py
--r--------  2.0 unx    14885 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bert/tokenization_bert_fast.py
--r--------  2.0 unx     1086 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bert_generation/__init__.py
--r--------  2.0 unx     6377 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bert_generation/configuration_bert_generation.py
--r--------  2.0 unx    40308 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bert_generation/modeling_bert_generation.py
--r--------  2.0 unx     7122 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bert_generation/tokenization_bert_generation.py
--r--------  2.0 unx      835 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bert_japanese/__init__.py
--r--------  2.0 unx    38994 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bert_japanese/tokenization_bert_japanese.py
--r--------  2.0 unx      820 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bertweet/__init__.py
--r--------  2.0 unx    27025 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bertweet/tokenization_bertweet.py
--r--------  2.0 unx      907 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bge_m3/__init__.py
--r--------  2.0 unx     2659 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bge_m3/configuration_bge_m3.py
--r--------  2.0 unx     8066 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bge_m3/modeling_bge_m3.py
--r--------  2.0 unx     1190 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/big_bird/__init__.py
--r--------  2.0 unx     7904 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/big_bird/configuration_big_bird.py
--r--------  2.0 unx   131230 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/big_bird/modeling_big_bird.py
--r--------  2.0 unx    15561 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/big_bird/tokenization_big_bird.py
--r--------  2.0 unx    11973 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/big_bird/tokenization_big_bird_fast.py
--r--------  2.0 unx      997 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bigbird_pegasus/__init__.py
--r--------  2.0 unx     8577 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bigbird_pegasus/configuration_bigbird_pegasus.py
--r--------  2.0 unx   134694 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bigbird_pegasus/modeling_bigbird_pegasus.py
--r--------  2.0 unx     1005 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/biogpt/__init__.py
--r--------  2.0 unx     6499 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/biogpt/configuration_biogpt.py
--r--------  2.0 unx    34793 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/biogpt/modeling_biogpt.py
--r--------  2.0 unx    13838 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/biogpt/tokenization_biogpt.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bit/__init__.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bit/configuration_bit.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bit/image_processing_bit.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bit/modeling_bit.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/blenderbot/__init__.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/blenderbot/configuration_blenderbot.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/blenderbot/modeling_blenderbot.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/blenderbot/tokenization_blenderbot.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/blenderbot/tokenization_blenderbot_fast.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/blenderbot_small/__init__.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/blenderbot_small/configuration_blenderbot_small.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/blenderbot_small/modeling_blenderbot_small.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/blenderbot_small/tokenization_blenderbot_small.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/blenderbot_small/tokenization_blenderbot_small_fast.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/blip/__init__.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/blip/configuration_blip.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/blip/image_processing_blip.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/blip/modeling_blip.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/blip/modeling_blip_text.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/blip/processing_blip.py
--r--------  2.0 unx      689 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/blip_2/__init__.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/blip_2/configuration_blip_2.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/blip_2/modeling_blip_2.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/blip_2/processing_blip_2.py
--r--------  2.0 unx     1012 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bloom/__init__.py
--r--------  2.0 unx     7089 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bloom/configuration_bloom.py
--r--------  2.0 unx    45166 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bloom/modeling_bloom.py
--r--------  2.0 unx     8034 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bloom/tokenization_bloom_fast.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bridgetower/__init__.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bridgetower/configuration_bridgetower.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bridgetower/image_processing_bridgetower.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bridgetower/modeling_bridgetower.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bridgetower/processing_bridgetower.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bros/__init__.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bros/configuration_bros.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bros/modeling_bros.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/bros/processing_bros.py
--r--------  2.0 unx      809 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/byt5/__init__.py
--r--------  2.0 unx    10025 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/byt5/tokenization_byt5.py
--r--------  2.0 unx     1131 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/chatglm/__init__.py
--r--------  2.0 unx     4956 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/chatglm/configuration_chatglm.py
--r--------  2.0 unx    47697 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/chatglm/modeling_chatglm.py
--r--------  2.0 unx    45162 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/chatglm/modeling_graph_chatglm.py
--r--------  2.0 unx    17674 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/chatglm/tokenization_chatglm.py
--r--------  2.0 unx     1031 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/chatglm2/__init__.py
--r--------  2.0 unx     3087 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/chatglm2/configuration_chatglm2.py
--r--------  2.0 unx    51372 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/chatglm2/modeling_chatglm2.py
--r--------  2.0 unx    10845 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/chatglm2/tokenization_chatglm2.py
--r--------  2.0 unx     1043 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/chatglm3/__init__.py
--r--------  2.0 unx    12016 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/chatglm3/modeling_chatglm3.py
--r--------  2.0 unx    13744 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/chatglm3/tokenization_chatglm3.py
--r--------  2.0 unx     1290 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/clip/__init__.py
--r--------  2.0 unx    19554 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/clip/configuration_clip.py
--r--------  2.0 unx    16649 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/clip/image_processing_clip.py
--r--------  2.0 unx    54023 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/clip/modeling_clip.py
--r--------  2.0 unx     6983 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/clip/processing_clip.py
--r--------  2.0 unx    21283 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/clip/tokenization_clip.py
--r--------  2.0 unx     7387 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/clip/tokenization_clip_fast.py
--r--------  2.0 unx     1239 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/codegen/__init__.py
--r--------  2.0 unx     7710 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/codegen/configuration_codegen.py
--r--------  2.0 unx    26987 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/codegen/modeling_codegen.py
--r--------  2.0 unx    15302 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/codegen/tokenization_codegen.py
--r--------  2.0 unx    10395 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/codegen/tokenization_codegen_fast.py
--r--------  2.0 unx      691 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/convbert/__init__.py
--r--------  2.0 unx     1013 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/cpm/__init__.py
--r--------  2.0 unx    15403 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/cpm/tokenization_cpm.py
--r--------  2.0 unx    10855 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/cpm/tokenization_cpm_fast.py
--r--------  2.0 unx     1110 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/cpmant/__init__.py
--r--------  2.0 unx     5439 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/cpmant/configuration_cpmant.py
--r--------  2.0 unx    35004 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/cpmant/modeling_cpmant.py
--r--------  2.0 unx    10166 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/cpmant/tokenization_cpmant.py
--r--------  2.0 unx     1110 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/cpmbee/__init__.py
--r--------  2.0 unx     6080 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/cpmbee/configuration_cpmbee.py
--r--------  2.0 unx    92050 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/cpmbee/modeling_cpmbee.py
--r--------  2.0 unx    39889 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/cpmbee/tokenization_cpmbee.py
--r--------  2.0 unx     1139 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/deberta/__init__.py
--r--------  2.0 unx     7765 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/deberta/configuration_deberta.py
--r--------  2.0 unx    50218 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/deberta/modeling_deberta.py
--r--------  2.0 unx    19193 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/deberta/tokenization_deberta.py
--r--------  2.0 unx    12810 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/deberta/tokenization_deberta_fast.py
--r--------  2.0 unx     1168 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/distilbert/__init__.py
--r--------  2.0 unx     6538 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/distilbert/configuration_distilbert.py
--r--------  2.0 unx    45504 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/distilbert/modeling_distilbert.py
--r--------  2.0 unx    23792 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/distilbert/tokenization_distilbert.py
--r--------  2.0 unx    10831 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/distilbert/tokenization_distilbert_fast.py
--r--------  2.0 unx      177 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/efficientnet/__init__.py
--r--------  2.0 unx    18993 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/efficientnet/image_processing_efficientnet.py
--r--------  2.0 unx      721 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/electra/__init__.py
--r--------  2.0 unx     1037 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/encodec/__init__.py
--r--------  2.0 unx     8843 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/encodec/configuration_encodec.py
--r--------  2.0 unx     9976 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/encodec/feature_extraction_encodec.py
--r--------  2.0 unx    30861 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/encodec/modeling_encodec.py
--r--------  2.0 unx     1007 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/ernie/__init__.py
--r--------  2.0 unx     8387 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/ernie/configuration_ernie.py
--r--------  2.0 unx    82282 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/ernie/modeling_ernie.py
--r--------  2.0 unx    72732 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/ernie/modeling_graph_ernie.py
--r--------  2.0 unx     1129 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/ernie_m/__init__.py
--r--------  2.0 unx     6341 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/ernie_m/configuration_ernie_m.py
--r--------  2.0 unx    45836 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/ernie_m/modeling_ernie_m.py
--r--------  2.0 unx    41160 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/ernie_m/modeling_graph_ernie_m.py
--r--------  2.0 unx    17469 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/ernie_m/tokenization_ernie_m.py
--r--------  2.0 unx     1072 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/esm/__init__.py
--r--------  2.0 unx    14702 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/esm/configuration_esm.py
--r--------  2.0 unx    50040 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/esm/modeling_esm.py
--r--------  2.0 unx    80557 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/esm/modeling_esmfold.py
--r--------  2.0 unx     6019 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/esm/tokenization_esm.py
--r--------  2.0 unx     1132 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/esm/openfold_utils/__init__.py
--r--------  2.0 unx    14496 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/esm/openfold_utils/chunk_utils.py
--r--------  2.0 unx     3754 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/esm/openfold_utils/data_transforms.py
--r--------  2.0 unx     8417 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/esm/openfold_utils/feats.py
--r--------  2.0 unx     3782 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/esm/openfold_utils/loss.py
--r--------  2.0 unx    11534 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/esm/openfold_utils/protein.py
--r--------  2.0 unx    37942 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/esm/openfold_utils/residue_constants.py
--r--------  2.0 unx    38685 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/esm/openfold_utils/rigid_utils.py
--r--------  2.0 unx     4870 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/esm/openfold_utils/tensor_utils.py
--r--------  2.0 unx      909 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/falcon/__init__.py
--r--------  2.0 unx     4835 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/falcon/configuration_falcon.py
--r--------  2.0 unx    62192 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/falcon/modeling_falcon.py
--r--------  2.0 unx     1112 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/gemma/__init__.py
--r--------  2.0 unx     6787 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/gemma/configuration_gemma.py
--r--------  2.0 unx    37813 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/gemma/modeling_gemma.py
--r--------  2.0 unx    14094 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/gemma/tokenization_gemma.py
--r--------  2.0 unx     8333 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/gemma/tokenization_gemma_fast.py
--r--------  2.0 unx     1084 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/gpt/__init__.py
--r--------  2.0 unx     7187 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/gpt/configuration_gpt.py
--r--------  2.0 unx    28682 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/gpt/modeling_gpt.py
--r--------  2.0 unx    19898 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/gpt/modeling_graph_gpt.py
--r--------  2.0 unx    15578 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/gpt/tokenization_gpt.py
--r--------  2.0 unx     3059 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/gpt/tokenization_gpt_fast.py
--r--------  2.0 unx     1129 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/gpt2/__init__.py
--r--------  2.0 unx     9357 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/gpt2/configuration_gpt2.py
--r--------  2.0 unx    54753 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/gpt2/modeling_gpt2.py
--r--------  2.0 unx    38645 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/gpt2/modeling_graph_gpt2.py
--r--------  2.0 unx    15005 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/gpt2/tokenization_gpt2.py
--r--------  2.0 unx     8162 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/gpt2/tokenization_gpt2_fast.py
--r--------  2.0 unx     1002 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/gpt_bigcode/__init__.py
--r--------  2.0 unx    41443 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/gpt_bigcode/gpt_bigcode.py
--r--------  2.0 unx     2866 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/gpt_bigcode/gpt_bigcode_config.py
--r--------  2.0 unx     3451 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/gpt_bigcode/gpt_bigcode_tokenizer.py
--r--------  2.0 unx      893 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/gpt_neo/__init__.py
--r--------  2.0 unx    31296 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/gpt_neo/gpt_neo.py
--r--------  2.0 unx     3658 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/gpt_neo/gpt_neo_config.py
--r--------  2.0 unx      989 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/gpt_neox/__init__.py
--r--------  2.0 unx     4201 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/gpt_neox/configuration_gpt_neox.py
--r--------  2.0 unx    47248 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/gpt_neox/modeling_gpt_neox.py
--r--------  2.0 unx     6036 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/gpt_neox/tokenization_gpt_neox_fast.py
--r--------  2.0 unx     1035 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/gpt_pangu/__init__.py
--r--------  2.0 unx     2478 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/gpt_pangu/configuration_gptpangu.py
--r--------  2.0 unx    22225 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/gpt_pangu/modeling_gptpangu.py
--r--------  2.0 unx     5069 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/gpt_pangu/tokenization_gptpangu.py
--r--------  2.0 unx     1105 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/graphormer/__init__.py
--r--------  2.0 unx     3633 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/graphormer/algos_graphormer.pyx
--r--------  2.0 unx     7817 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/graphormer/collating_graphormer.py
--r--------  2.0 unx    10646 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/graphormer/configuration_graphormer.py
--r--------  2.0 unx    37098 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/graphormer/modeling_graphormer.py
--r--------  2.0 unx     1555 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/graphormer/utils.py
--r--------  2.0 unx     1039 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/hubert/__init__.py
--r--------  2.0 unx    14985 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/hubert/configuration_hubert.py
--r--------  2.0 unx    50925 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/hubert/modeling_hubert.py
--r--------  2.0 unx      875 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/layoutlm/__init__.py
--r--------  2.0 unx     2450 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/layoutlm/configuration_layoutlm.py
--r--------  2.0 unx    54421 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/layoutlm/modeling_layoutlm.py
--r--------  2.0 unx    22005 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/layoutlm/tokenization_layoutlm.py
--r--------  2.0 unx     9082 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/layoutlm/tokenization_layoutlm_fast.py
--r--------  2.0 unx     1365 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/layoutlmv2/__init__.py
--r--------  2.0 unx    13789 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/layoutlmv2/configuration_layoutlmv2.py
--r--------  2.0 unx    14101 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/layoutlmv2/image_processing_layoutlmv2.py
--r--------  2.0 unx    54245 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/layoutlmv2/modeling_layoutlmv2.py
--r--------  2.0 unx     9900 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/layoutlmv2/processing_layoutlmv2.py
--r--------  2.0 unx    73385 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/layoutlmv2/tokenization_layoutlmv2.py
--r--------  2.0 unx    38073 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/layoutlmv2/tokenization_layoutlmv2_fast.py
--r--------  2.0 unx    23537 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/layoutlmv2/visual_backbone.py
--r--------  2.0 unx     1457 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/llama/__init__.py
--r--------  2.0 unx     9417 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/llama/configuration_llama.py
--r--------  2.0 unx    37351 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/llama/modeling_llama.py
--r--------  2.0 unx    23580 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/llama/tokenization_code_llama.py
--r--------  2.0 unx    19760 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/llama/tokenization_code_llama_fast.py
--r--------  2.0 unx    22019 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/llama/tokenization_llama.py
--r--------  2.0 unx    13087 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/llama/tokenization_llama_fast.py
--r--------  2.0 unx     1173 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/longformer/__init__.py
--r--------  2.0 unx     7354 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/longformer/configuration_longformer.py
--r--------  2.0 unx   107905 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/longformer/modeling_longformer.py
--r--------  2.0 unx    19034 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/longformer/tokenization_longformer.py
--r--------  2.0 unx    14789 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/longformer/tokenization_longformer_fast.py
--r--------  2.0 unx     1012 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/longt5/__init__.py
--r--------  2.0 unx     7520 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/longt5/configuration_longt5.py
--r--------  2.0 unx    84899 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/longt5/modeling_longt5.py
--r--------  2.0 unx    16754 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/longt5/tokenization_longt5.py
--r--------  2.0 unx     1042 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/luke/__init__.py
--r--------  2.0 unx    59689 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/luke/luke.py
--r--------  2.0 unx     2725 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/luke/luke_config.py
--r--------  2.0 unx    84793 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/luke/tokenization_luke.py
--r--------  2.0 unx     1003 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/mamba/__init__.py
--r--------  2.0 unx     7241 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/mamba/configuration_mamba.py
--r--------  2.0 unx    20727 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/mamba/modeling_graph_mamba.py
--r--------  2.0 unx    22627 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/mamba/modeling_mamba.py
--r--------  2.0 unx      891 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/maskformer/__init__.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/maskformer/maskformer.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/maskformer/maskformer_config.py
--r--------  2.0 unx     1109 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/mbart/__init__.py
--r--------  2.0 unx     3514 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/mbart/configuration_mbart.py
--r--------  2.0 unx    60039 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/mbart/modeling_mbart.py
--r--------  2.0 unx    13994 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/mbart/tokenization_mbart.py
--r--------  2.0 unx    12171 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/mbart/tokenization_mbart_fast.py
--r--------  2.0 unx     1044 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/megatron_bert/__init__.py
--r--------  2.0 unx     6610 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/megatron_bert/configuration_megatron_bert.py
--r--------  2.0 unx    72730 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/megatron_bert/modeling_megatron_bert.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/megatron_gpt2/__init__.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/megatron_gpt2/megatron_gpt2.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/megatron_gpt2/megatron_gpt2_config.py
--r--------  2.0 unx      912 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/minicpm/__init__.py
--r--------  2.0 unx     9726 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/minicpm/configuration_minicpm.py
--r--------  2.0 unx    42349 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/minicpm/modeling_minicpm.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/minicpm/modeling_minicpmv.py
--r--------  2.0 unx      645 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/minigpt4/__init__.py
--r--------  2.0 unx     1014 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/mistral/__init__.py
--r--------  2.0 unx     7200 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/mistral/configuration_mistral.py
--r--------  2.0 unx    34808 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/mistral/modeling_mistral.py
--r--------  2.0 unx     1014 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/mixtral/__init__.py
--r--------  2.0 unx     8160 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/mixtral/configuration_mixtral.py
--r--------  2.0 unx    44559 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/mixtral/modeling_mixtral.py
--r--------  2.0 unx     1096 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/mobilebert/__init__.py
--r--------  2.0 unx    57813 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/mobilebert/mobilebert.py
--r--------  2.0 unx     3205 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/mobilebert/mobilebert_config.py
--r--------  2.0 unx     5687 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/mobilebert/mobilebert_tokenizer.py
--r--------  2.0 unx      778 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/moss/__init__.py
--r--------  2.0 unx    32778 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/moss/moss.py
--r--------  2.0 unx     2838 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/moss/moss_configuration.py
--r--------  2.0 unx      867 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/moss/moss_tokenization.py
--r--------  2.0 unx      889 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/mt5/__init__.py
--r--------  2.0 unx     6755 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/mt5/configuration_mt5.py
--r--------  2.0 unx    81209 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/mt5/modeling_mt5.py
--r--------  2.0 unx     1025 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/musicgen/__init__.py
--r--------  2.0 unx    10700 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/musicgen/configuration_musicgen.py
--r--------  2.0 unx   110242 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/musicgen/modeling_musicgen.py
--r--------  2.0 unx     5684 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/musicgen/processing_musicgen.py
--r--------  2.0 unx      945 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/nezha/__init__.py
--r--------  2.0 unx    47907 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/nezha/nezha.py
--r--------  2.0 unx     2431 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/nezha/nezha_config.py
--r--------  2.0 unx     2953 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/nezha/nezha_tokenizer.py
--r--------  2.0 unx      891 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/opt/__init__.py
--r--------  2.0 unx     7373 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/opt/configuration_opt.py
--r--------  2.0 unx    47645 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/opt/modeling_opt.py
--r--------  2.0 unx      943 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/pegasus/__init__.py
--r--------  2.0 unx    13184 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/pegasus/tokenization_pegasus.py
--r--------  2.0 unx     9982 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/pegasus/tokenization_pegasus_fast.py
--r--------  2.0 unx      892 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/phi/__init__.py
--r--------  2.0 unx     9266 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/phi/configuration_phi.py
--r--------  2.0 unx    42961 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/phi/modeling_phi.py
--r--------  2.0 unx      600 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/pop2piano/__init__.py
--r--------  2.0 unx     6241 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/pop2piano/configuration_pop2piano.py
--r--------  2.0 unx    20121 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/pop2piano/feature_extraction_pop2piano.py
--r--------  2.0 unx    60570 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/pop2piano/modeling_pop2piano.py
--r--------  2.0 unx     5589 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/pop2piano/processing_pop2piano.py
--r--------  2.0 unx    32281 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/pop2piano/tokenization_pop2piano.py
--r--------  2.0 unx     1108 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/qwen2/__init__.py
--r--------  2.0 unx     6840 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/qwen2/configuration_qwen2.py
--r--------  2.0 unx    35438 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/qwen2/modeling_qwen2.py
--r--------  2.0 unx    14338 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/qwen2/tokenization_qwen2.py
--r--------  2.0 unx     5700 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/qwen2/tokenization_qwen2_fast.py
--r--------  2.0 unx     1148 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/reformer/__init__.py
--r--------  2.0 unx    13575 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/reformer/configuration_reformer.py
--r--------  2.0 unx   107482 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/reformer/modeling_reformer.py
--r--------  2.0 unx     7289 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/reformer/tokenization_reformer.py
--r--------  2.0 unx     5004 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/reformer/tokenization_reformer_fast.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/regnet/__init__.py
--r--------  2.0 unx     1133 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/roberta/__init__.py
--r--------  2.0 unx     2420 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/roberta/configuration_roberta.py
--r--------  2.0 unx    12078 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/roberta/modeling_graph_roberta.py
--r--------  2.0 unx    60971 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/roberta/modeling_roberta.py
--r--------  2.0 unx    18177 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/roberta/tokenization_roberta.py
--r--------  2.0 unx    13885 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/roberta/tokenization_roberta_fast.py
--r--------  2.0 unx      995 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/rwkv/__init__.py
--r--------  2.0 unx     6303 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/rwkv/configuration_rwkv.py
--r--------  2.0 unx    28862 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/rwkv/modeling_rwkv.py
--r--------  2.0 unx     1459 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/seamless_m4t/__init__.py
--r--------  2.0 unx    23758 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/seamless_m4t/configuration_seamless_m4t.py
--r--------  2.0 unx    13061 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/seamless_m4t/feature_extraction_seamless_m4t.py
--r--------  2.0 unx   189385 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/seamless_m4t/modeling_seamless_m4t.py
--r--------  2.0 unx     5891 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/seamless_m4t/processing_seamless_m4t.py
--r--------  2.0 unx    25979 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/seamless_m4t/tokenization_seamless_m4t.py
--r--------  2.0 unx    20489 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/seamless_m4t/tokenization_seamless_m4t_fast.py
--r--------  2.0 unx      974 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/seamless_m4t_v2/__init__.py
--r--------  2.0 unx    24474 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/seamless_m4t_v2/configuration_seamless_m4t_v2.py
--r--------  2.0 unx   211331 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/seamless_m4t_v2/modeling_seamless_m4t_v2.py
--r--------  2.0 unx      934 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/starcoder2/__init__.py
--r--------  2.0 unx     6919 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/starcoder2/configuration_starcoder2.py
--r--------  2.0 unx    36584 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/starcoder2/modeling_starcoder2.py
--r--------  2.0 unx     1171 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/t5/__init__.py
--r--------  2.0 unx     4419 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/t5/chatyuan_tokenizer.py
--r--------  2.0 unx     6772 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/t5/configuration_t5.py
--r--------  2.0 unx    70760 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/t5/modeling_t5.py
--r--------  2.0 unx    20403 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/t5/tokenization_t5.py
--r--------  2.0 unx    10806 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/t5/tokenization_t5_fast.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/timesformer/__init__.py
--r--------  2.0 unx      879 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/tinybert/__init__.py
--r--------  2.0 unx    25866 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/tinybert/tinybert.py
--r--------  2.0 unx     3520 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/tinybert/tinybert_config.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/transformer/__init__.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/transformer/transformer.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/transformer/transformer_config.py
--r--------  2.0 unx     1598 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/wav2vec2/__init__.py
--r--------  2.0 unx    20372 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/wav2vec2/configuration_wav2vec2.py
--r--------  2.0 unx    11553 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/wav2vec2/feature_extraction_wav2vec2.py
--r--------  2.0 unx    97015 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/wav2vec2/modeling_wav2vec2.py
--r--------  2.0 unx     7177 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/wav2vec2/processing_wav2vec2.py
--r--------  2.0 unx    36485 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/wav2vec2/tokenization_wav2vec2.py
--r--------  2.0 unx      860 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/wav2vec2_with_lm/__init__.py
--r--------  2.0 unx    29591 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/wav2vec2_with_lm/processing_wav2vec2_with_lm.py
--r--------  2.0 unx     1356 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/whisper/__init__.py
--r--------  2.0 unx    14562 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/whisper/configuration_whisper.py
--r--------  2.0 unx    22879 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/whisper/english_normalizer.py
--r--------  2.0 unx    11806 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/whisper/feature_extraction_whisper.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/whisper/modeling_graph_whisper.py
--r--------  2.0 unx    96893 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/whisper/modeling_whisper.py
--r--------  2.0 unx     3961 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/whisper/processing_whisper.py
--r--------  2.0 unx    53819 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/whisper/tokenization_whisper.py
--r--------  2.0 unx    32375 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/whisper/tokenization_whisper_fast.py
--r--------  2.0 unx      983 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/xlm/__init__.py
--r--------  2.0 unx    11328 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/xlm/configuration_xlm.py
--r--------  2.0 unx    46629 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/xlm/modeling_xlm.py
--r--------  2.0 unx    34991 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/xlm/tokenization_xlm.py
--r--------  2.0 unx     1192 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/xlm_roberta/__init__.py
--r--------  2.0 unx     6980 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/xlm_roberta/configuration_xlm_roberta.py
--r--------  2.0 unx    63314 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/xlm_roberta/modeling_xlm_roberta.py
--r--------  2.0 unx    14289 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/xlm_roberta/tokenization_xlm_roberta.py
--r--------  2.0 unx    10433 b- defN 24-Mar-28 23:57 mindnlp/transformers/models/xlm_roberta/tokenization_xlm_roberta_fast.py
--r--------  2.0 unx    26016 b- defN 24-Mar-28 23:57 mindnlp/transformers/pipelines/__init__.py
--r--------  2.0 unx     9793 b- defN 24-Mar-28 23:57 mindnlp/transformers/pipelines/audio_utils.py
--r--------  2.0 unx    37518 b- defN 24-Mar-28 23:57 mindnlp/transformers/pipelines/automatic_speech_recognition.py
--r--------  2.0 unx    35984 b- defN 24-Mar-28 23:57 mindnlp/transformers/pipelines/base.py
--r--------  2.0 unx    27144 b- defN 24-Mar-28 23:57 mindnlp/transformers/pipelines/document_question_answering.py
--r--------  2.0 unx    28511 b- defN 24-Mar-28 23:57 mindnlp/transformers/pipelines/question_answering.py
--r--------  2.0 unx    17651 b- defN 24-Mar-28 23:57 mindnlp/transformers/pipelines/text2text_generation.py
--r--------  2.0 unx     9640 b- defN 24-Mar-28 23:57 mindnlp/transformers/pipelines/text_classification.py
--r--------  2.0 unx    15366 b- defN 24-Mar-28 23:57 mindnlp/transformers/pipelines/text_generation.py
--r--------  2.0 unx    13013 b- defN 24-Mar-28 23:57 mindnlp/transformers/pipelines/zero_shot_classification.py
--r--------  2.0 unx     1510 b- defN 24-Mar-28 23:57 mindnlp/utils/__init__.py
--r--------  2.0 unx    16335 b- defN 24-Mar-28 23:57 mindnlp/utils/backbone_utils.py
--r--------  2.0 unx     1458 b- defN 24-Mar-28 23:57 mindnlp/utils/compatibility.py
--r--------  2.0 unx     2916 b- defN 24-Mar-28 23:57 mindnlp/utils/decompress.py
--r--------  2.0 unx    32202 b- defN 24-Mar-28 23:57 mindnlp/utils/download.py
--r--------  2.0 unx    12029 b- defN 24-Mar-28 23:57 mindnlp/utils/errors.py
--r--------  2.0 unx    11747 b- defN 24-Mar-28 23:57 mindnlp/utils/generic.py
--r--------  2.0 unx    14008 b- defN 24-Mar-28 23:57 mindnlp/utils/import_utils.py
--r--------  2.0 unx    11478 b- defN 24-Mar-28 23:57 mindnlp/utils/logging.py
--r--------  2.0 unx     4451 b- defN 24-Mar-28 23:57 mindnlp/utils/peft_utils.py
--r--------  2.0 unx     1898 b- defN 24-Mar-28 23:57 mindnlp/utils/save.py
--r--------  2.0 unx    21524 b- defN 24-Mar-28 23:57 mindnlp/utils/serialization.py
--r--------  2.0 unx    49805 b- defN 24-Mar-28 23:57 mindnlp/utils/testing_utils.py
--r--------  2.0 unx      712 b- defN 24-Mar-28 23:57 mindnlp/vocab/__init__.py
--r--------  2.0 unx    11522 b- defN 24-Mar-28 23:57 mindnlp/vocab/vocab.py
--r--------  2.0 unx      768 b- defN 24-Mar-28 23:57 mindnlp/workflow/__init__.py
--r--------  2.0 unx     5813 b- defN 24-Mar-28 23:57 mindnlp/workflow/utils.py
--r--------  2.0 unx     7577 b- defN 24-Mar-28 23:57 mindnlp/workflow/work.py
--r--------  2.0 unx     7103 b- defN 24-Mar-28 23:57 mindnlp/workflow/workflow.py
--r--------  2.0 unx      757 b- defN 24-Mar-28 23:57 mindnlp/workflow/downstream/__init__.py
--r--------  2.0 unx     1557 b- defN 24-Mar-28 23:57 mindnlp/workflow/downstream/sentiment_analysis_model.py
--r--------  2.0 unx      780 b- defN 24-Mar-28 23:57 mindnlp/workflow/works/__init__.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/workflow/works/classification.py
--r--------  2.0 unx    26028 b- defN 24-Mar-28 23:57 mindnlp/workflow/works/information_extraction.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/workflow/works/ner.py
--r--------  2.0 unx        0 b- defN 24-Mar-28 23:57 mindnlp/workflow/works/qa.py
--r--------  2.0 unx     6032 b- defN 24-Mar-28 23:57 mindnlp/workflow/works/sentiment_analysis.py
--rw-r--r--  2.0 unx      708 b- defN 24-Mar-28 23:57 tests/__init__.py
--rw-r--r--  2.0 unx      147 b- defN 24-Mar-28 23:57 tests/common.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/st/__init__.py
--rw-r--r--  2.0 unx     2834 b- defN 24-Mar-28 23:57 tests/st/test_bilstm_imdb.py
--rw-r--r--  2.0 unx     2110 b- defN 24-Mar-28 23:57 tests/st/test_longformer.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/test_module/__init__.py
--rw-r--r--  2.0 unx      387 b- defN 24-Mar-28 23:57 tests/test_module/custom_configuration.py
--rw-r--r--  2.0 unx      777 b- defN 24-Mar-28 23:57 tests/test_module/custom_modeling.py
--rw-r--r--  2.0 unx     1117 b- defN 24-Mar-28 23:57 tests/test_module/custom_pipeline.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/__init__.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/dataset/__init__.py
--rw-r--r--  2.0 unx     2423 b- defN 24-Mar-28 23:57 tests/ut/dataset/test_imdb.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/dataset/transforms/__init__.py
--rw-r--r--  2.0 unx     2555 b- defN 24-Mar-28 23:57 tests/ut/dataset/transforms/test_add_token.py
--rw-r--r--  2.0 unx     1235 b- defN 24-Mar-28 23:57 tests/ut/dataset/transforms/test_lookup.py
--rw-r--r--  2.0 unx     2560 b- defN 24-Mar-28 23:57 tests/ut/dataset/transforms/test_pad_transform.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/engine/__init__.py
--rw-r--r--  2.0 unx     2248 b- defN 24-Mar-28 23:57 tests/ut/engine/test_callback.py
--rw-r--r--  2.0 unx     2352 b- defN 24-Mar-28 23:57 tests/ut/engine/test_evaluator.py
--rw-r--r--  2.0 unx     6878 b- defN 24-Mar-28 23:57 tests/ut/engine/test_trainer.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/legacy/__init__.py
--rw-r--r--  2.0 unx      845 b- defN 24-Mar-28 23:57 tests/ut/legacy/test_einsum.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/metrics/__init__.py
--rw-r--r--  2.0 unx    32965 b- defN 24-Mar-28 23:57 tests/ut/metrics/test_metrics_class.py
--rw-r--r--  2.0 unx    19939 b- defN 24-Mar-28 23:57 tests/ut/metrics/test_metrics_fn.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/modules/__init__.py
--rw-r--r--  2.0 unx    13357 b- defN 24-Mar-28 23:57 tests/ut/modules/test_crf.py
--rw-r--r--  2.0 unx     5675 b- defN 24-Mar-28 23:57 tests/ut/modules/test_decoder.py
--rw-r--r--  2.0 unx     4267 b- defN 24-Mar-28 23:57 tests/ut/modules/test_encoder.py
--rw-r--r--  2.0 unx     1422 b- defN 24-Mar-28 23:57 tests/ut/modules/test_fasttext_embedding.py
--rw-r--r--  2.0 unx     1356 b- defN 24-Mar-28 23:57 tests/ut/modules/test_glove_embedding.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/modules/attentions/__init__.py
--rw-r--r--  2.0 unx     1809 b- defN 24-Mar-28 23:57 tests/ut/modules/attentions/test_additive_attention.py
--rw-r--r--  2.0 unx     1784 b- defN 24-Mar-28 23:57 tests/ut/modules/attentions/test_binary_attention.py
--rw-r--r--  2.0 unx     1779 b- defN 24-Mar-28 23:57 tests/ut/modules/attentions/test_cosine_attention.py
--rw-r--r--  2.0 unx     1831 b- defN 24-Mar-28 23:57 tests/ut/modules/attentions/test_linear_attention.py
--rw-r--r--  2.0 unx     1540 b- defN 24-Mar-28 23:57 tests/ut/modules/attentions/test_scaled_dot_attention.py
--rw-r--r--  2.0 unx     2276 b- defN 24-Mar-28 23:57 tests/ut/modules/attentions/test_self_attention.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/modules/generation/__init__.py
--rw-r--r--  2.0 unx     1784 b- defN 24-Mar-28 23:57 tests/ut/modules/generation/test_generation_config.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/modules/loss/__init__.py
--rw-r--r--  2.0 unx     2296 b- defN 24-Mar-28 23:57 tests/ut/modules/loss/test_cmrc2018loss.py
--rw-r--r--  2.0 unx     2385 b- defN 24-Mar-28 23:57 tests/ut/modules/loss/test_rdrop_loss.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/modules/rnns/__init__.py
--rw-r--r--  2.0 unx     4872 b- defN 24-Mar-28 23:57 tests/ut/modules/rnns/test_gru.py
--rw-r--r--  2.0 unx     5180 b- defN 24-Mar-28 23:57 tests/ut/modules/rnns/test_lstm.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/modules/transformer/__init__.py
--rw-r--r--  2.0 unx     3775 b- defN 24-Mar-28 23:57 tests/ut/modules/transformer/test_multi_head_attention.py
--rw-r--r--  2.0 unx     2187 b- defN 24-Mar-28 23:57 tests/ut/modules/transformer/test_transformer_encoder.py
--rw-r--r--  2.0 unx     1434 b- defN 24-Mar-28 23:57 tests/ut/modules/transformer/test_transformer_encoder_layer.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/peft/__init__.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/peft/test_config.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/__init__.py
--rw-r--r--  2.0 unx    10140 b- defN 24-Mar-28 23:57 tests/ut/transformers/test_backbone_common.py
--rw-r--r--  2.0 unx     8097 b- defN 24-Mar-28 23:57 tests/ut/transformers/test_configuration_common.py
--rw-r--r--  2.0 unx    73183 b- defN 24-Mar-28 23:57 tests/ut/transformers/test_modeling_common.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/test_pipeline_mixin.py
--rw-r--r--  2.0 unx   206613 b- defN 24-Mar-28 23:57 tests/ut/transformers/test_tokenization_common.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/generation/__init__.py
--rw-r--r--  2.0 unx    28522 b- defN 24-Mar-28 23:57 tests/ut/transformers/generation/test_framework_agnostic.py
--rw-r--r--  2.0 unx   123394 b- defN 24-Mar-28 23:57 tests/ut/transformers/generation/test_utils.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/__init__.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/albert/__init__.py
--rw-r--r--  2.0 unx    14176 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/albert/test_modeling_albert.py
--rw-r--r--  2.0 unx     8039 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/albert/test_tokenization_albert.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/align/__init__.py
--rw-r--r--  2.0 unx    21247 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/align/test_modeling_align.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/altclip/__init__.py
--rw-r--r--  2.0 unx    20018 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/altclip/test_modeling_altclip.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/audio_spectrogram_transformer/__init__.py
--rw-r--r--  2.0 unx     9381 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/audio_spectrogram_transformer/test_modeling_audio_spectrogram_transformer.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/auto/__init__.py
--rw-r--r--  2.0 unx     3723 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/auto/test_configuration_auto.py
--rw-r--r--  2.0 unx    15231 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/auto/test_modeling_auto.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/autoformer/__init__.py
--rw-r--r--  2.0 unx    19293 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/autoformer/test_modeling_autoformer.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/baichuan/__init__.py
--rw-r--r--  2.0 unx     2793 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/baichuan/test_modeling_baichuan.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/bark/__init__.py
--rw-r--r--  2.0 unx    44187 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/bark/test_modeling_bark.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/bart/__init__.py
--rw-r--r--  2.0 unx    95343 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/bart/test_modeling_bart.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/beit/__init__.py
--rw-r--r--  2.0 unx    19837 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/beit/test_modeling_beit.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/bert/__init__.py
--rw-r--r--  2.0 unx    25734 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/bert/test_modeling_bert.py
--rw-r--r--  2.0 unx     2048 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/bert/test_modeling_graph_bert.py
--rw-r--r--  2.0 unx    14288 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/bert/test_tokenization_bert.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/bert_generation/__init__.py
--rw-r--r--  2.0 unx    12696 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/bert_generation/test_modeling_bert_generation.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/big_bird/__init__.py
--rw-r--r--  2.0 unx    46579 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/big_bird/test_modeling_big_bird.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/bigbird_pegasus/__init__.py
--rw-r--r--  2.0 unx   110760 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/bigbird_pegasus/test_modeling_bigbird_pegasus.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/biogpt/__init__.py
--rw-r--r--  2.0 unx    19717 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/biogpt/test_modeling_biogpt.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/bloom/__init__.py
--rw-r--r--  2.0 unx    35152 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/bloom/test_modeling_bloom.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/chatglm/__init__.py
--rw-r--r--  2.0 unx    13895 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/chatglm/test_modeling_chatglm.py
--rw-r--r--  2.0 unx    13970 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/chatglm/test_modeling_graph_chatglm.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/clip/__init__.py
--rw-r--r--  2.0 unx    25666 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/clip/test_modeling_clip.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/codegen/__init__.py
--rw-r--r--  2.0 unx    23368 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/codegen/test_modeling_codegen.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/cpmant/__init__.py
--rw-r--r--  2.0 unx     9906 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/cpmant/test_modeling_cpmant.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/cpmbee/__init__.py
--rw-r--r--  2.0 unx     8443 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/cpmbee/test_modeling_cpmbee.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/deberta/__init__.py
--rw-r--r--  2.0 unx    12019 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/deberta/test_modeling_deberta.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/encodec/__init__.py
--rw-r--r--  2.0 unx    20901 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/encodec/test_modeling_encodec.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/ernie/__init__.py
--rw-r--r--  2.0 unx    22370 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/ernie/test_modeling_ernie.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/ernie_m/__init__.py
--rw-r--r--  2.0 unx    12542 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/ernie_m/test_modeling_ernie_m.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/esm/__init__.py
--rw-r--r--  2.0 unx    13068 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/esm/test_modeling_esm.py
--rw-r--r--  2.0 unx    10139 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/esm/test_modeling_esmfold.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/falcon/__init__.py
--rw-r--r--  2.0 unx    22507 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/falcon/test_modeling_falcon.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/gemma/__init__.py
--rw-r--r--  2.0 unx    22221 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/gemma/test_modeling_gemma.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/gpt/__init__.py
--rw-r--r--  2.0 unx    11432 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/gpt/test_modeling_gpt.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/gpt2/__init__.py
--rw-r--r--  2.0 unx    36548 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/gpt2/test_modeling_gpt2.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/gpt_bigcode/__init__.py
--rw-r--r--  2.0 unx    25963 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/gpt_bigcode/test_modeling_gpt_bigcode.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/gpt_neo/__init__.py
--rw-r--r--  2.0 unx     4504 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/gpt_neo/test_gpt_neo.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/gpt_neox/__init__.py
--rw-r--r--  2.0 unx    16620 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/gpt_neox/test_gpt_neox.py
--rw-r--r--  2.0 unx      691 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/graphormer/__init__.py
--rw-r--r--  2.0 unx     6947 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/graphormer/test_graphormer_cells.py
--rw-r--r--  2.0 unx    65804 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/graphormer/test_modeling_graphormer.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/hubert/__init__.py
--rw-r--r--  2.0 unx    29210 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/hubert/test_modeling_hubert.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/layoutlm/__init__.py
--rw-r--r--  2.0 unx    17742 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/layoutlm/test_modeling_layoutlm.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/layoutlmv2/__init__.py
--rw-r--r--  2.0 unx    28358 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/layoutlmv2/test_modeling_layoutlmv2.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/llama/__init__.py
--rw-r--r--  2.0 unx    27045 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/llama/test_modeling_llama.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/longformer/__init__.py
--rw-r--r--  2.0 unx    31552 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/longformer/test_modeling_longformer.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/luke/__init__.py
--rw-r--r--  2.0 unx    11176 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/luke/test_modeling_luke.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/mamba/__init__.py
--rw-r--r--  2.0 unx     5356 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/mamba/test_modeling_graph_mamba.py
--rw-r--r--  2.0 unx    19188 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/mamba/test_modeling_mamba.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/mbart/__init__.py
--rw-r--r--  2.0 unx    29265 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/mbart/test_modeling_mbart.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/megatron_bert/__init__.py
--rw-r--r--  2.0 unx    16043 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/megatron_bert/test_modeling_megatron_bert.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/mistral/__init__.py
--rw-r--r--  2.0 unx    17577 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/mistral/test_modeling_mistral.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/mixtral/__init__.py
--rw-r--r--  2.0 unx    19377 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/mixtral/test_modeling_mixtral.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/mobilebert/__init__.py
--rw-r--r--  2.0 unx    12087 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/mobilebert/test_mobilebert.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/moss/__init__.py
--rw-r--r--  2.0 unx     3681 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/moss/test_modeling_moss.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/mt5/__init__.py
--rw-r--r--  2.0 unx     2095 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/mt5/test_modeling_mt5.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/musicgen/__init__.py
--rw-r--r--  2.0 unx    45744 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/musicgen/test_modeling_musicgen.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/nezha/__init__.py
--rw-r--r--  2.0 unx    10126 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/nezha/test_modeling_nezha.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/opt/__init__.py
--rw-r--r--  2.0 unx    23041 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/opt/test_modeling_opt.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/phi/__init__.py
--rw-r--r--  2.0 unx    18965 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/phi/test_modeling_phi.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/pop2piano/__init__.py
--rw-r--r--  2.0 unx    31317 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/pop2piano/test_modeling_pop2piano.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/qwen2/__init__.py
--rw-r--r--  2.0 unx    19480 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/qwen2/test_modeling_qwen2.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/reformer/__init__.py
--rw-r--r--  2.0 unx    43606 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/reformer/test_modeling_reformer.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/roberta/__init__.py
--rw-r--r--  2.0 unx    22751 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/roberta/test_modeling_roberta.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/rwkv/__init__.py
--rw-r--r--  2.0 unx    17034 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/rwkv/test_modeling_rwkv.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/seamless_m4t/__init__.py
--rw-r--r--  2.0 unx    45139 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/seamless_m4t/test_modeling_seamless_m4t.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/seamless_m4t_v2/__init__.py
--rw-r--r--  2.0 unx    48018 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/seamless_m4t_v2/test_modeling_seamless_m4t_v2.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/starcoder2/__init__.py
--rw-r--r--  2.0 unx    16333 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/starcoder2/test_modeling_starcoder2.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/t5/__init__.py
--rw-r--r--  2.0 unx    74031 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/t5/test_modeling_t5.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/tinybert/__init__.py
--rw-r--r--  2.0 unx    15357 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/tinybert/test_tinybert.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/wav2vec2/__init__.py
--rw-r--r--  2.0 unx    10497 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/wav2vec2/test_feature_extraction_wav2vec2.py
--rw-r--r--  2.0 unx    72157 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/wav2vec2/test_modeling_wav2vec2.py
--rw-r--r--  2.0 unx     6366 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/wav2vec2/test_processor_wav2vec2.py
--rw-r--r--  2.0 unx    40919 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/wav2vec2/test_tokenization_wav2vec2.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/whisper/__init__.py
--rw-r--r--  2.0 unx    77595 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/whisper/test_modeling_whisper.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/xlm/__init__.py
--rw-r--r--  2.0 unx    19441 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/xlm/test_modeling_xlm.py
--rw-r--r--  2.0 unx     3300 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/xlm/test_tokenization_xlm.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/xlm_roberta/__init__.py
--rw-r--r--  2.0 unx     2827 b- defN 24-Mar-28 23:57 tests/ut/transformers/models/xlm_roberta/test_modeling_xlm_roberta.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/transformers/pipelines/__init__.py
--rw-r--r--  2.0 unx    18027 b- defN 24-Mar-28 23:57 tests/ut/transformers/pipelines/test_pipelines_common.py
--rw-r--r--  2.0 unx    12467 b- defN 24-Mar-28 23:57 tests/ut/transformers/pipelines/test_pipelines_document_question_answering.py
--rw-r--r--  2.0 unx    25446 b- defN 24-Mar-28 23:57 tests/ut/transformers/pipelines/test_pipelines_question_answering.py
--rw-r--r--  2.0 unx     3661 b- defN 24-Mar-28 23:57 tests/ut/transformers/pipelines/test_pipelines_text2text_generation.py
--rw-r--r--  2.0 unx     6805 b- defN 24-Mar-28 23:57 tests/ut/transformers/pipelines/test_pipelines_text_classification.py
--rw-r--r--  2.0 unx    13706 b- defN 24-Mar-28 23:57 tests/ut/transformers/pipelines/test_pipelines_text_generation.py
--rw-r--r--  2.0 unx    11105 b- defN 24-Mar-28 23:57 tests/ut/transformers/pipelines/test_pipelines_zero_shot_classification.py
--rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 23:57 tests/ut/vocab/__init__.py
--rw-r--r--  2.0 unx     2076 b- defN 24-Mar-28 23:57 tests/ut/vocab/test_vocab.py
--rw-r--r--  2.0 unx     1029 b- defN 24-Mar-28 23:57 tests/ut/vocab/test_vocab_fasttext.py
--rw-r--r--  2.0 unx     1238 b- defN 24-Mar-28 23:57 tests/ut/vocab/test_vocab_glove.py
--rw-r--r--  2.0 unx    11357 b- defN 24-Mar-28 23:57 mindnlp-0.2.3.dist-info/LICENSE
--rw-r--r--  2.0 unx      805 b- defN 24-Mar-28 23:57 mindnlp-0.2.3.dist-info/METADATA
--rw-r--r--  2.0 unx       57 b- defN 24-Mar-28 23:57 mindnlp-0.2.3.dist-info/NOTICE
--rw-r--r--  2.0 unx       92 b- defN 24-Mar-28 23:57 mindnlp-0.2.3.dist-info/WHEEL
--r--------  2.0 unx       14 b- defN 24-Mar-28 23:57 mindnlp-0.2.3.dist-info/top_level.txt
--rw-rw-r--  2.0 unx    90688 b- defN 24-Mar-28 23:57 mindnlp-0.2.3.dist-info/RECORD
-854 files, 12907156 bytes uncompressed, 2814043 bytes compressed:  78.2%
+Zip file size: 5267764 bytes, number of entries: 1002
+-r--------  2.0 unx     1162 b- defN 24-Mar-25 11:12 mindnlp/__init__.py
+-r--------  2.0 unx     2170 b- defN 24-Mar-20 16:25 mindnlp/configs.py
+-r--------  2.0 unx    37726 b- defN 24-Apr-09 06:51 mindnlp/injection.py
+-r--------  2.0 unx        0 b- defN 24-Mar-29 08:44 mindnlp/readme.md
+-r--------  2.0 unx     5132 b- defN 24-Mar-29 07:53 mindnlp/_csrc/cuda/flash.cu
+-r--------  2.0 unx     7940 b- defN 23-Jun-01 14:35 mindnlp/_csrc/cuda/wkv.cu
+-r--------  2.0 unx      707 b- defN 23-Mar-22 09:42 mindnlp/_legacy/__init__.py
+-r--------  2.0 unx     7978 b- defN 24-Mar-25 11:12 mindnlp/_legacy/amp.py
+-r--------  2.0 unx    67590 b- defN 24-Mar-25 11:12 mindnlp/_legacy/functional.py
+-r--------  2.0 unx     2633 b- defN 24-Mar-25 11:12 mindnlp/_legacy/initializer.py
+-r--------  2.0 unx     3284 b- defN 24-Mar-25 11:12 mindnlp/_legacy/utils.py
+-r--------  2.0 unx      883 b- defN 24-Mar-25 11:12 mindnlp/_legacy/hypercomplex/__init__.py
+-r--------  2.0 unx     1755 b- defN 24-Mar-25 11:12 mindnlp/_legacy/hypercomplex/utils.py
+-r--------  2.0 unx      882 b- defN 24-Mar-16 11:41 mindnlp/_legacy/hypercomplex/complex/__init__.py
+-r--------  2.0 unx     6981 b- defN 24-Mar-16 11:41 mindnlp/_legacy/hypercomplex/complex/_complex_bn_impl.py
+-r--------  2.0 unx    11071 b- defN 24-Mar-25 11:12 mindnlp/_legacy/hypercomplex/complex/_complex_conv_impl.py
+-r--------  2.0 unx     5878 b- defN 24-Mar-25 11:12 mindnlp/_legacy/hypercomplex/complex/_complex_dense_impl.py
+-r--------  2.0 unx     2146 b- defN 24-Mar-16 11:41 mindnlp/_legacy/hypercomplex/complex/_complex_relu.py
+-r--------  2.0 unx    65137 b- defN 24-Mar-25 11:12 mindnlp/_legacy/hypercomplex/complex/complex_operators.py
+-r--------  2.0 unx     2195 b- defN 24-Mar-16 11:41 mindnlp/_legacy/hypercomplex/complex/complex_relu.py
+-r--------  2.0 unx      882 b- defN 24-Mar-16 11:41 mindnlp/_legacy/hypercomplex/double/__init__.py
+-r--------  2.0 unx    12850 b- defN 24-Mar-16 11:41 mindnlp/_legacy/hypercomplex/double/_double_bn_impl.py
+-r--------  2.0 unx     6638 b- defN 24-Mar-25 11:12 mindnlp/_legacy/hypercomplex/double/_double_conv_impl.py
+-r--------  2.0 unx     5749 b- defN 24-Mar-25 11:12 mindnlp/_legacy/hypercomplex/double/_double_dense_impl.py
+-r--------  2.0 unx    74411 b- defN 24-Mar-25 11:12 mindnlp/_legacy/hypercomplex/double/double_operators.py
+-r--------  2.0 unx     2535 b- defN 24-Mar-25 11:12 mindnlp/_legacy/hypercomplex/double/double_relu.py
+-r--------  2.0 unx      870 b- defN 24-Mar-16 11:41 mindnlp/_legacy/hypercomplex/dual/__init__.py
+-r--------  2.0 unx     6955 b- defN 24-Mar-16 11:41 mindnlp/_legacy/hypercomplex/dual/_dual_bn_impl.py
+-r--------  2.0 unx     7365 b- defN 24-Mar-25 11:12 mindnlp/_legacy/hypercomplex/dual/_dual_conv_impl.py
+-r--------  2.0 unx     3132 b- defN 24-Mar-25 11:12 mindnlp/_legacy/hypercomplex/dual/_dual_dense_impl.py
+-r--------  2.0 unx     2667 b- defN 24-Mar-25 11:12 mindnlp/_legacy/hypercomplex/dual/dual_functions.py
+-r--------  2.0 unx    55061 b- defN 24-Mar-25 11:12 mindnlp/_legacy/hypercomplex/dual/dual_operators.py
+-r--------  2.0 unx      191 b- defN 24-Mar-16 11:41 mindnlp/_legacy/hypercomplex/hypercomplex/__init__.py
+-r--------  2.0 unx    17631 b- defN 24-Mar-25 11:12 mindnlp/_legacy/hypercomplex/hypercomplex/_hc_bn_impl.py
+-r--------  2.0 unx     5893 b- defN 24-Mar-16 11:41 mindnlp/_legacy/hypercomplex/hypercomplex/_hc_conv_impl.py
+-r--------  2.0 unx     5140 b- defN 24-Mar-16 11:41 mindnlp/_legacy/hypercomplex/hypercomplex/_hc_dense_impl.py
+-r--------  2.0 unx    36029 b- defN 24-Mar-25 11:12 mindnlp/_legacy/hypercomplex/hypercomplex/hc_bn.py
+-r--------  2.0 unx    49241 b- defN 24-Mar-25 11:12 mindnlp/_legacy/hypercomplex/hypercomplex/hc_conv.py
+-r--------  2.0 unx    11082 b- defN 24-Mar-25 11:12 mindnlp/_legacy/hypercomplex/hypercomplex/hc_dense.py
+-r--------  2.0 unx    44353 b- defN 24-Mar-25 11:12 mindnlp/_legacy/hypercomplex/hypercomplex/hc_pool.py
+-r--------  2.0 unx     1691 b- defN 24-Mar-25 11:12 mindnlp/_legacy/hypercomplex/hypercomplex/uniform_operator.py
+-r--------  2.0 unx     2915 b- defN 24-Apr-09 08:22 mindnlp/_legacy/hypercomplex/tensor_decomposition/hypercomplex_td.py
+-r--------  2.0 unx     4383 b- defN 24-Apr-09 08:22 mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/algorithm/dual_svd.py
+-r--------  2.0 unx     4886 b- defN 24-Apr-09 08:22 mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/algorithm/qr.py
+-r--------  2.0 unx      802 b- defN 24-Apr-09 08:22 mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/algorithm/star_svd.py
+-r--------  2.0 unx     3728 b- defN 24-Apr-09 08:22 mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/algorithm/svd.py
+-r--------  2.0 unx      800 b- defN 24-Apr-09 08:22 mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/algorithm/t_svd.py
+-r--------  2.0 unx     6592 b- defN 24-Apr-09 08:22 mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/matrix.py
+-r--------  2.0 unx     1431 b- defN 24-Apr-09 08:22 mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/scalar.py
+-r--------  2.0 unx      593 b- defN 24-Apr-09 08:22 mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/scalar_visitor.py
+-r--------  2.0 unx     4859 b- defN 24-Apr-09 08:22 mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/vector.py
+-r--------  2.0 unx     3088 b- defN 24-Apr-09 08:22 mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/complex/_complex_algebra_impl.py
+-r--------  2.0 unx      894 b- defN 24-Apr-09 08:22 mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/complex/complex_algebra_factory.py
+-r--------  2.0 unx     2640 b- defN 24-Apr-09 08:22 mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/dual/_dual_algebra_impl.py
+-r--------  2.0 unx      873 b- defN 24-Apr-09 08:22 mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/dual/dual_algebra_factory.py
+-r--------  2.0 unx      594 b- defN 24-Apr-09 08:22 mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/hypercomplex/_hc_math_obj_impl.py
+-r--------  2.0 unx      456 b- defN 24-Apr-09 08:22 mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/hypercomplex/_hc_matrix_impl.py
+-r--------  2.0 unx      858 b- defN 24-Apr-09 08:22 mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/hypercomplex/_hc_scalar_impl.py
+-r--------  2.0 unx      481 b- defN 24-Apr-09 08:22 mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/hypercomplex/_hc_vector_impl.py
+-r--------  2.0 unx      653 b- defN 24-Apr-09 08:22 mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/hypercomplex/hc_algebra_factory.py
+-r--------  2.0 unx    13424 b- defN 24-Apr-09 08:22 mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/hypercomplex/hc_matrix.py
+-r--------  2.0 unx     3020 b- defN 24-Apr-09 08:22 mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/hypercomplex/hc_scalar.py
+-r--------  2.0 unx     9501 b- defN 24-Apr-09 08:22 mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/hypercomplex/hc_vector.py
+-r--------  2.0 unx     6240 b- defN 24-Apr-09 08:22 mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/real/real_matrix.py
+-r--------  2.0 unx     1650 b- defN 24-Apr-09 08:22 mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/real/real_scalar.py
+-r--------  2.0 unx     4089 b- defN 24-Apr-09 08:22 mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/real/real_vector.py
+-r--------  2.0 unx     1092 b- defN 23-Jun-01 14:35 mindnlp/_legacy/nn/__init__.py
+-r--------  2.0 unx     3367 b- defN 24-Mar-25 11:12 mindnlp/_legacy/nn/dropout.py
+-r--------  2.0 unx      896 b- defN 24-Mar-25 11:12 mindnlp/_legacy/nn/half_op.py
+-r--------  2.0 unx    33081 b- defN 24-Mar-25 11:12 mindnlp/_legacy/nn/transformer.py
+-r--------  2.0 unx      797 b- defN 23-Jun-01 14:35 mindnlp/_legacy/ops/__init__.py
+-r--------  2.0 unx     1196 b- defN 23-Jun-01 14:35 mindnlp/_legacy/ops/parallel.py
+-r--------  2.0 unx      872 b- defN 23-Mar-22 09:42 mindnlp/_legacy/transforms/__init__.py
+-r--------  2.0 unx     2110 b- defN 23-Nov-14 09:23 mindnlp/_legacy/transforms/add_token.py
+-r--------  2.0 unx     1880 b- defN 24-Mar-25 11:12 mindnlp/_legacy/transforms/truncate.py
+-r--------  2.0 unx      822 b- defN 24-Feb-29 06:56 mindnlp/abc/__init__.py
+-r--------  2.0 unx     2926 b- defN 23-Mar-22 09:42 mindnlp/abc/callback.py
+-r--------  2.0 unx     5945 b- defN 24-Mar-25 11:12 mindnlp/abc/container.py
+-r--------  2.0 unx     2870 b- defN 23-Mar-22 09:42 mindnlp/abc/metric.py
+-r--------  2.0 unx     1466 b- defN 23-Mar-22 09:42 mindnlp/abc/register.py
+-r--------  2.0 unx      823 b- defN 24-Feb-29 06:56 mindnlp/abc/models/__init__.py
+-r--------  2.0 unx     6023 b- defN 23-Jun-01 14:35 mindnlp/abc/models/base_model.py
+-r--------  2.0 unx     3414 b- defN 24-Mar-25 11:12 mindnlp/abc/models/seq2seq_model.py
+-r--------  2.0 unx     2934 b- defN 24-Mar-25 11:12 mindnlp/abc/models/seq2vec_model.py
+-r--------  2.0 unx      811 b- defN 23-Mar-22 09:42 mindnlp/abc/modules/__init__.py
+-r--------  2.0 unx     2816 b- defN 23-Mar-22 09:42 mindnlp/abc/modules/decoder.py
+-r--------  2.0 unx     2408 b- defN 23-Jun-01 14:35 mindnlp/abc/modules/embedding.py
+-r--------  2.0 unx     2360 b- defN 23-Mar-22 09:42 mindnlp/abc/modules/encoder.py
+-r--------  2.0 unx        0 b- defN 23-Mar-22 09:42 mindnlp/abc/modules/generator.py
+-r--------  2.0 unx      790 b- defN 24-Mar-25 11:12 mindnlp/data/__init__.py
+-r--------  2.0 unx      736 b- defN 24-Mar-19 16:41 mindnlp/data/io/__init__.py
+-r--------  2.0 unx    34595 b- defN 24-Mar-25 11:12 mindnlp/data/io/audio.py
+-r--------  2.0 unx      768 b- defN 24-Mar-19 16:41 mindnlp/data/processors/__init__.py
+-r--------  2.0 unx    20407 b- defN 24-Mar-25 11:49 mindnlp/data/processors/squad.py
+-r--------  2.0 unx      720 b- defN 24-Feb-29 06:56 mindnlp/dataset/__init__.py
+-r--------  2.0 unx    13264 b- defN 24-Mar-28 15:57 mindnlp/dataset/load.py
+-r--------  2.0 unx     1921 b- defN 23-Mar-22 09:42 mindnlp/dataset/utils.py
+-r--------  2.0 unx     1211 b- defN 24-Apr-01 15:36 mindnlp/dataset/transforms/__init__.py
+-r--------  2.0 unx     9716 b- defN 24-Mar-25 11:12 mindnlp/dataset/transforms/basic_tokenizer.py
+-r--------  2.0 unx     1608 b- defN 24-Apr-01 15:36 mindnlp/dataset/transforms/jieba_tokenizer.py
+-r--------  2.0 unx     2508 b- defN 24-Feb-29 06:56 mindnlp/dataset/transforms/lookup.py
+-r--------  2.0 unx     2548 b- defN 24-Feb-29 06:56 mindnlp/dataset/transforms/pad_transform.py
+-r--------  2.0 unx        0 b- defN 24-Apr-08 10:49 mindnlp/diffusers/__init__.py
+-r--------  2.0 unx        0 b- defN 24-Apr-08 14:16 mindnlp/diffusers/loaders/__init__.py
+-r--------  2.0 unx        0 b- defN 24-Apr-08 14:16 mindnlp/diffusers/models/__init__.py
+-r--------  2.0 unx        0 b- defN 24-Apr-08 14:16 mindnlp/diffusers/pipelines/__init__.py
+-r--------  2.0 unx        0 b- defN 24-Apr-08 14:16 mindnlp/diffusers/schedulers/__init__.py
+-r--------  2.0 unx        0 b- defN 24-Apr-08 14:16 mindnlp/diffusers/utils/__init__.py
+-r--------  2.0 unx      779 b- defN 24-Mar-20 16:25 mindnlp/engine/__init__.py
+-r--------  2.0 unx     8106 b- defN 24-Mar-20 16:25 mindnlp/engine/evaluator.py
+-r--------  2.0 unx      770 b- defN 23-Mar-22 09:42 mindnlp/engine/export.py
+-r--------  2.0 unx      807 b- defN 24-Mar-20 16:25 mindnlp/engine/train_args.py
+-r--------  2.0 unx     1125 b- defN 24-Mar-25 11:12 mindnlp/engine/utils.py
+-r--------  2.0 unx      927 b- defN 24-Mar-20 16:25 mindnlp/engine/callbacks/__init__.py
+-r--------  2.0 unx     5118 b- defN 24-Mar-20 16:25 mindnlp/engine/callbacks/best_model_callback.py
+-r--------  2.0 unx     4086 b- defN 24-Mar-20 16:25 mindnlp/engine/callbacks/callback_manager.py
+-r--------  2.0 unx     4156 b- defN 24-Mar-20 16:25 mindnlp/engine/callbacks/checkpoint_callback.py
+-r--------  2.0 unx     2464 b- defN 24-Mar-20 16:25 mindnlp/engine/callbacks/earlystop_callback.py
+-r--------  2.0 unx     6079 b- defN 24-Mar-20 16:25 mindnlp/engine/callbacks/timer_callback.py
+-r--------  2.0 unx      753 b- defN 24-Mar-25 11:12 mindnlp/engine/trainer/__init__.py
+-r--------  2.0 unx    16949 b- defN 24-Mar-25 11:12 mindnlp/engine/trainer/base.py
+-r--------  2.0 unx        0 b- defN 24-Mar-20 16:25 mindnlp/engine/trainer/ppo.py
+-r--------  2.0 unx        0 b- defN 23-Jun-01 14:35 mindnlp/engine/trainer/rm.py
+-r--------  2.0 unx        0 b- defN 24-Mar-20 16:25 mindnlp/engine/trainer/sft.py
+-r--------  2.0 unx     3704 b- defN 24-Mar-20 16:25 mindnlp/engine/trainer/utils.py
+-r--------  2.0 unx        0 b- defN 24-Mar-19 16:41 mindnlp/evaluate/__init__.py
+-r--------  2.0 unx        0 b- defN 24-Mar-19 16:41 mindnlp/evaluate/suite.py
+-r--------  2.0 unx        0 b- defN 24-Mar-19 16:41 mindnlp/evaluate/evaluator/__init__.py
+-r--------  2.0 unx        0 b- defN 24-Mar-19 16:41 mindnlp/evaluate/evaluator/audio_classification.py
+-r--------  2.0 unx        0 b- defN 24-Mar-19 16:41 mindnlp/evaluate/evaluator/automatic_speech_recognition.py
+-r--------  2.0 unx        0 b- defN 24-Mar-19 16:41 mindnlp/evaluate/evaluator/base.py
+-r--------  2.0 unx        0 b- defN 24-Mar-19 16:41 mindnlp/evaluate/evaluator/image_classification.py
+-r--------  2.0 unx        0 b- defN 24-Mar-19 16:41 mindnlp/evaluate/evaluator/question_answering.py
+-r--------  2.0 unx        0 b- defN 24-Mar-19 16:41 mindnlp/evaluate/evaluator/text2text_generation.py
+-r--------  2.0 unx        0 b- defN 24-Mar-19 16:41 mindnlp/evaluate/evaluator/text_classification.py
+-r--------  2.0 unx        0 b- defN 24-Mar-19 16:41 mindnlp/evaluate/evaluator/text_generation.py
+-r--------  2.0 unx        0 b- defN 24-Mar-19 16:41 mindnlp/evaluate/evaluator/token_classification.py
+-r--------  2.0 unx     1590 b- defN 23-Mar-22 09:42 mindnlp/metrics/__init__.py
+-r--------  2.0 unx     7525 b- defN 23-Mar-22 09:42 mindnlp/metrics/accuracy.py
+-r--------  2.0 unx    10364 b- defN 23-Mar-22 09:42 mindnlp/metrics/bleu.py
+-r--------  2.0 unx     6201 b- defN 23-Mar-22 09:42 mindnlp/metrics/confusion_matrix.py
+-r--------  2.0 unx     4231 b- defN 23-Mar-22 09:42 mindnlp/metrics/distinct.py
+-r--------  2.0 unx     6130 b- defN 23-Mar-22 09:42 mindnlp/metrics/em_score.py
+-r--------  2.0 unx     8006 b- defN 23-Mar-22 09:42 mindnlp/metrics/f1.py
+-r--------  2.0 unx     7665 b- defN 23-Mar-22 09:42 mindnlp/metrics/matthews.py
+-r--------  2.0 unx     7280 b- defN 23-Mar-22 09:42 mindnlp/metrics/pearson.py
+-r--------  2.0 unx     9898 b- defN 23-Mar-22 09:42 mindnlp/metrics/perplexity.py
+-r--------  2.0 unx     7040 b- defN 23-Mar-22 09:42 mindnlp/metrics/precision.py
+-r--------  2.0 unx     6746 b- defN 23-Mar-22 09:42 mindnlp/metrics/recall.py
+-r--------  2.0 unx    12329 b- defN 24-Feb-29 06:56 mindnlp/metrics/rouge.py
+-r--------  2.0 unx     6735 b- defN 23-Mar-22 09:42 mindnlp/metrics/spearman.py
+-r--------  2.0 unx     4407 b- defN 23-Mar-22 09:42 mindnlp/metrics/utils.py
+-r--------  2.0 unx     2229 b- defN 24-Mar-25 11:12 mindnlp/modules/__init__.py
+-r--------  2.0 unx     1966 b- defN 24-Mar-25 11:12 mindnlp/modules/accumulator.py
+-r--------  2.0 unx    22547 b- defN 24-Feb-29 06:56 mindnlp/modules/attentions.py
+-r--------  2.0 unx    13033 b- defN 24-Mar-25 11:12 mindnlp/modules/crf.py
+-r--------  2.0 unx     6458 b- defN 24-Mar-25 11:12 mindnlp/modules/loss.py
+-r--------  2.0 unx    22885 b- defN 24-Mar-25 11:12 mindnlp/modules/rnns.py
+-r--------  2.0 unx     7136 b- defN 24-Mar-30 02:04 mindnlp/modules/weight_norm.py
+-r--------  2.0 unx      702 b- defN 23-Jun-01 14:35 mindnlp/modules/custom/__init__.py
+-r--------  2.0 unx      773 b- defN 23-Mar-22 09:42 mindnlp/modules/decoder/__init__.py
+-r--------  2.0 unx    10869 b- defN 24-Mar-25 11:12 mindnlp/modules/decoder/rnn_decoder.py
+-r--------  2.0 unx      801 b- defN 23-Mar-22 09:42 mindnlp/modules/embeddings/__init__.py
+-r--------  2.0 unx     8276 b- defN 24-Feb-29 06:56 mindnlp/modules/embeddings/fasttext_embedding.py
+-r--------  2.0 unx     8267 b- defN 24-Feb-29 06:56 mindnlp/modules/embeddings/glove_embedding.py
+-r--------  2.0 unx      824 b- defN 23-Mar-22 09:42 mindnlp/modules/encoder/__init__.py
+-r--------  2.0 unx     4712 b- defN 24-Mar-25 11:12 mindnlp/modules/encoder/cnn_encoder.py
+-r--------  2.0 unx     4145 b- defN 24-Mar-25 11:12 mindnlp/modules/encoder/rnn_encoder.py
+-r--------  2.0 unx      787 b- defN 24-Apr-08 07:41 mindnlp/modules/functional/__init__.py
+-r--------  2.0 unx     2705 b- defN 24-Mar-25 11:12 mindnlp/modules/functional/graph_func.py
+-r--------  2.0 unx      985 b- defN 24-Feb-29 06:56 mindnlp/modules/functional/neural_network.py
+-r--------  2.0 unx      838 b- defN 24-Apr-08 07:40 mindnlp/modules/functional/normalize.py
+-r--------  2.0 unx     3298 b- defN 24-Mar-25 11:12 mindnlp/modules/functional/weight_norm.py
+-r--------  2.0 unx      846 b- defN 24-Feb-29 06:56 mindnlp/parallel/__init__.py
+-r--------  2.0 unx        0 b- defN 24-Feb-29 06:56 mindnlp/parallel/pipeline_parallel/__init__.py
+-r--------  2.0 unx      818 b- defN 24-Feb-29 06:56 mindnlp/parallel/tensor_parallel/__init__.py
+-r--------  2.0 unx    11750 b- defN 24-Mar-25 11:12 mindnlp/parallel/tensor_parallel/layers.py
+-r--------  2.0 unx     4587 b- defN 24-Mar-25 11:12 mindnlp/parallel/tensor_parallel/mappings.py
+-r--------  2.0 unx     3369 b- defN 24-Feb-29 06:56 mindnlp/parallel/tensor_parallel/utils.py
+-r--------  2.0 unx     1594 b- defN 24-Feb-29 06:56 mindnlp/peft/__init__.py
+-r--------  2.0 unx     6758 b- defN 24-Mar-25 11:12 mindnlp/peft/config.py
+-r--------  2.0 unx     3322 b- defN 24-Mar-25 11:12 mindnlp/peft/mapping.py
+-r--------  2.0 unx    37352 b- defN 24-Mar-25 11:12 mindnlp/peft/peft_model.py
+-r--------  2.0 unx      738 b- defN 23-Jul-16 07:16 mindnlp/peft/tuners/__init__.py
+-r--------  2.0 unx    37392 b- defN 24-Mar-25 11:12 mindnlp/peft/tuners/lora.py
+-r--------  2.0 unx    11619 b- defN 24-Mar-25 11:12 mindnlp/peft/tuners/tuners_utils.py
+-r--------  2.0 unx     1756 b- defN 24-Feb-29 06:56 mindnlp/peft/utils/__init__.py
+-r--------  2.0 unx    11128 b- defN 24-Mar-25 11:12 mindnlp/peft/utils/other.py
+-r--------  2.0 unx     1242 b- defN 24-Feb-29 06:56 mindnlp/peft/utils/peft_types.py
+-r--------  2.0 unx     5767 b- defN 24-Mar-25 11:12 mindnlp/peft/utils/save_and_load.py
+-r--------  2.0 unx      763 b- defN 24-Apr-01 15:36 mindnlp/text2vec/__init__.py
+-r--------  2.0 unx     8215 b- defN 24-Apr-01 15:36 mindnlp/text2vec/sentence_model.py
+-r--------  2.0 unx     6109 b- defN 24-Apr-01 15:36 mindnlp/text2vec/word2vec.py
+-r--------  2.0 unx     1287 b- defN 24-Feb-29 06:56 mindnlp/transformers/__init__.py
+-r--------  2.0 unx     5438 b- defN 24-Apr-08 07:11 mindnlp/transformers/activations.py
+-r--------  2.0 unx    33460 b- defN 24-Mar-31 16:52 mindnlp/transformers/audio_utils.py
+-r--------  2.0 unx    20239 b- defN 24-Mar-25 11:12 mindnlp/transformers/cache_utils.py
+-r--------  2.0 unx    35706 b- defN 24-Apr-02 08:27 mindnlp/transformers/configuration_utils.py
+-r--------  2.0 unx    53285 b- defN 24-Mar-25 11:12 mindnlp/transformers/convert_slow_tokenizer.py
+-r--------  2.0 unx    18222 b- defN 24-Feb-29 06:56 mindnlp/transformers/feature_extraction_sequence_utils.py
+-r--------  2.0 unx    26772 b- defN 24-Apr-02 15:06 mindnlp/transformers/feature_extraction_utils.py
+-r--------  2.0 unx    33187 b- defN 24-Mar-28 15:57 mindnlp/transformers/image_processing_utils.py
+-r--------  2.0 unx    32924 b- defN 24-Mar-25 11:12 mindnlp/transformers/image_transforms.py
+-r--------  2.0 unx    29937 b- defN 24-Mar-28 15:57 mindnlp/transformers/image_utils.py
+-r--------  2.0 unx     3025 b- defN 24-Mar-31 10:53 mindnlp/transformers/kernel_utils.py
+-r--------  2.0 unx    10957 b- defN 24-Mar-12 03:14 mindnlp/transformers/modeling_attn_mask_utils.py
+-r--------  2.0 unx   111179 b- defN 24-Mar-12 03:14 mindnlp/transformers/modeling_outputs.py
+-r--------  2.0 unx    96613 b- defN 24-Apr-09 05:34 mindnlp/transformers/modeling_utils.py
+-r--------  2.0 unx     8657 b- defN 24-Mar-25 11:12 mindnlp/transformers/ms_utils.py
+-r--------  2.0 unx    10219 b- defN 24-Mar-28 15:57 mindnlp/transformers/processing_utils.py
+-r--------  2.0 unx     6636 b- defN 24-Mar-25 11:12 mindnlp/transformers/time_series_utils.py
+-r--------  2.0 unx    44063 b- defN 24-Mar-25 11:12 mindnlp/transformers/tokenization_utils.py
+-r--------  2.0 unx   175003 b- defN 24-Mar-28 15:57 mindnlp/transformers/tokenization_utils_base.py
+-r--------  2.0 unx    37089 b- defN 24-Mar-25 11:12 mindnlp/transformers/tokenization_utils_fast.py
+-r--------  2.0 unx      829 b- defN 24-Mar-26 08:37 mindnlp/transformers/generation/__init__.py
+-r--------  2.0 unx    19732 b- defN 24-Mar-25 11:12 mindnlp/transformers/generation/beam_constraints.py
+-r--------  2.0 unx    43463 b- defN 24-Mar-25 11:12 mindnlp/transformers/generation/beam_search.py
+-r--------  2.0 unx    32343 b- defN 24-Apr-08 06:51 mindnlp/transformers/generation/configuration_utils.py
+-r--------  2.0 unx    66891 b- defN 24-Mar-28 15:57 mindnlp/transformers/generation/logits_process.py
+-r--------  2.0 unx     5067 b- defN 24-Feb-29 06:56 mindnlp/transformers/generation/stopping_criteria.py
+-r--------  2.0 unx     9287 b- defN 24-Mar-25 11:12 mindnlp/transformers/generation/streamers.py
+-r--------  2.0 unx   252173 b- defN 24-Apr-08 15:07 mindnlp/transformers/generation/utils.py
+-r--------  2.0 unx     7060 b- defN 24-Apr-08 11:52 mindnlp/transformers/models/__init__.py
+-r--------  2.0 unx     1120 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/albert/__init__.py
+-r--------  2.0 unx     8303 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/albert/configuration_albert.py
+-r--------  2.0 unx    48840 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/albert/modeling_albert.py
+-r--------  2.0 unx    15804 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/albert/tokenization_albert.py
+-r--------  2.0 unx    11024 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/albert/tokenization_albert_fast.py
+-r--------  2.0 unx      989 b- defN 24-Mar-20 16:25 mindnlp/transformers/models/align/__init__.py
+-r--------  2.0 unx    18320 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/align/configuration_align.py
+-r--------  2.0 unx    63750 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/align/modeling_align.py
+-r--------  2.0 unx     6222 b- defN 24-Mar-20 16:25 mindnlp/transformers/models/align/processing_align.py
+-r--------  2.0 unx     1007 b- defN 24-Mar-20 16:25 mindnlp/transformers/models/altclip/__init__.py
+-r--------  2.0 unx    19999 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/altclip/configuration_altclip.py
+-r--------  2.0 unx    73075 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/altclip/modeling_altclip.py
+-r--------  2.0 unx     6589 b- defN 24-Mar-20 16:25 mindnlp/transformers/models/altclip/processing_altclip.py
+-r--------  2.0 unx     1252 b- defN 24-Mar-20 16:25 mindnlp/transformers/models/audio_spectrogram_transformer/__init__.py
+-r--------  2.0 unx     5830 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/audio_spectrogram_transformer/configuration_audio_spectrogram_transformer.py
+-r--------  2.0 unx     9478 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/audio_spectrogram_transformer/feature_extraction_audio_spectrogram_transformer.py
+-r--------  2.0 unx    22723 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/audio_spectrogram_transformer/modeling_audio_spectrogram_transformer.py
+-r--------  2.0 unx     6545 b- defN 24-Mar-25 06:16 mindnlp/transformers/models/auto/__init__.py
+-r--------  2.0 unx    10729 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/auto/auto_factory.py
+-r--------  2.0 unx    40590 b- defN 24-Apr-08 11:48 mindnlp/transformers/models/auto/configuration_auto.py
+-r--------  2.0 unx    18666 b- defN 24-Mar-31 13:25 mindnlp/transformers/models/auto/feature_extraction_auto.py
+-r--------  2.0 unx    20881 b- defN 24-Mar-31 12:04 mindnlp/transformers/models/auto/image_processing_auto.py
+-r--------  2.0 unx    41547 b- defN 24-Apr-08 11:48 mindnlp/transformers/models/auto/modeling_auto.py
+-r--------  2.0 unx    12314 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/auto/modeling_graph_auto.py
+-r--------  2.0 unx    15357 b- defN 24-Apr-02 15:21 mindnlp/transformers/models/auto/processing_auto.py
+-r--------  2.0 unx    39882 b- defN 24-Apr-08 11:45 mindnlp/transformers/models/auto/tokenization_auto.py
+-r--------  2.0 unx      935 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/autoformer/__init__.py
+-r--------  2.0 unx    12462 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/autoformer/configuration_autoformer.py
+-r--------  2.0 unx    97091 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/autoformer/modeling_autoformer.py
+-r--------  2.0 unx     1028 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/baichuan/__init__.py
+-r--------  2.0 unx     2461 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/baichuan/configuration_baichuan.py
+-r--------  2.0 unx    43284 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/baichuan/modeling_baichuan.py
+-r--------  2.0 unx     9639 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/baichuan/tokenization_baichuan.py
+-r--------  2.0 unx     1118 b- defN 24-Mar-03 07:54 mindnlp/transformers/models/bark/__init__.py
+-r--------  2.0 unx    10961 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/bark/configuration_bark.py
+-r--------  2.0 unx    15088 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/bark/generation_configuration_bark.py
+-r--------  2.0 unx    62439 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/bark/modeling_bark.py
+-r--------  2.0 unx    12929 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/bark/processing_bark.py
+-r--------  2.0 unx     1097 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/bart/__init__.py
+-r--------  2.0 unx     8553 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/bart/configuration_bart.py
+-r--------  2.0 unx    75827 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/bart/modeling_bart.py
+-r--------  2.0 unx    18082 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/bart/tokenization_bart.py
+-r--------  2.0 unx    14266 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/bart/tokenization_bart_fast.py
+-r--------  2.0 unx      940 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/barthez/__init__.py
+-r--------  2.0 unx    12831 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/barthez/tokenization_barthez.py
+-r--------  2.0 unx     8996 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/barthez/tokenization_barthez_fast.py
+-r--------  2.0 unx      822 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/bartpho/__init__.py
+-r--------  2.0 unx    14087 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/bartpho/tokenization_bartpho.py
+-r--------  2.0 unx      999 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/beit/__init__.py
+-r--------  2.0 unx    11381 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/beit/configuration_beit.py
+-r--------  2.0 unx    25144 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/beit/image_processing_beit.py
+-r--------  2.0 unx    56500 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/beit/modeling_beit.py
+-r--------  2.0 unx     1196 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/bert/__init__.py
+-r--------  2.0 unx     2598 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/bert/configuration_bert.py
+-r--------  2.0 unx    93194 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/bert/modeling_bert.py
+-r--------  2.0 unx    24981 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/bert/modeling_graph_bert.py
+-r--------  2.0 unx    25179 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/bert/tokenization_bert.py
+-r--------  2.0 unx    14885 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/bert/tokenization_bert_fast.py
+-r--------  2.0 unx     1086 b- defN 24-Mar-25 13:50 mindnlp/transformers/models/bert_generation/__init__.py
+-r--------  2.0 unx     6377 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/bert_generation/configuration_bert_generation.py
+-r--------  2.0 unx    40308 b- defN 24-Mar-25 13:50 mindnlp/transformers/models/bert_generation/modeling_bert_generation.py
+-r--------  2.0 unx     7122 b- defN 24-Mar-25 13:50 mindnlp/transformers/models/bert_generation/tokenization_bert_generation.py
+-r--------  2.0 unx      835 b- defN 24-Mar-25 13:50 mindnlp/transformers/models/bert_japanese/__init__.py
+-r--------  2.0 unx    38994 b- defN 24-Mar-25 13:50 mindnlp/transformers/models/bert_japanese/tokenization_bert_japanese.py
+-r--------  2.0 unx      820 b- defN 24-Mar-25 13:50 mindnlp/transformers/models/bertweet/__init__.py
+-r--------  2.0 unx    27025 b- defN 24-Mar-25 13:50 mindnlp/transformers/models/bertweet/tokenization_bertweet.py
+-r--------  2.0 unx      907 b- defN 24-Mar-25 15:01 mindnlp/transformers/models/bge_m3/__init__.py
+-r--------  2.0 unx     2659 b- defN 24-Mar-25 16:33 mindnlp/transformers/models/bge_m3/configuration_bge_m3.py
+-r--------  2.0 unx     8066 b- defN 24-Mar-25 16:33 mindnlp/transformers/models/bge_m3/modeling_bge_m3.py
+-r--------  2.0 unx     1190 b- defN 24-Mar-10 01:17 mindnlp/transformers/models/big_bird/__init__.py
+-r--------  2.0 unx     7904 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/big_bird/configuration_big_bird.py
+-r--------  2.0 unx   131230 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/big_bird/modeling_big_bird.py
+-r--------  2.0 unx    15561 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/big_bird/tokenization_big_bird.py
+-r--------  2.0 unx    11973 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/big_bird/tokenization_big_bird_fast.py
+-r--------  2.0 unx      997 b- defN 24-Mar-28 02:11 mindnlp/transformers/models/bigbird_pegasus/__init__.py
+-r--------  2.0 unx     8577 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/bigbird_pegasus/configuration_bigbird_pegasus.py
+-r--------  2.0 unx   134691 b- defN 24-Mar-31 10:53 mindnlp/transformers/models/bigbird_pegasus/modeling_bigbird_pegasus.py
+-r--------  2.0 unx     1007 b- defN 24-Mar-31 12:01 mindnlp/transformers/models/biogpt/__init__.py
+-r--------  2.0 unx     6499 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/biogpt/configuration_biogpt.py
+-r--------  2.0 unx    34793 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/biogpt/modeling_biogpt.py
+-r--------  2.0 unx    13838 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/biogpt/tokenization_biogpt.py
+-r--------  2.0 unx      989 b- defN 24-Mar-31 12:01 mindnlp/transformers/models/bit/__init__.py
+-r--------  2.0 unx     6297 b- defN 24-Mar-31 11:53 mindnlp/transformers/models/bit/configuration_bit.py
+-r--------  2.0 unx    16448 b- defN 24-Mar-31 11:54 mindnlp/transformers/models/bit/image_processing_bit.py
+-r--------  2.0 unx    29567 b- defN 24-Mar-31 12:44 mindnlp/transformers/models/bit/modeling_bit.py
+-r--------  2.0 unx     1174 b- defN 24-Apr-02 03:19 mindnlp/transformers/models/blenderbot/__init__.py
+-r--------  2.0 unx     7560 b- defN 24-Apr-02 03:19 mindnlp/transformers/models/blenderbot/configuration_blenderbot.py
+-r--------  2.0 unx    64667 b- defN 24-Apr-02 03:19 mindnlp/transformers/models/blenderbot/modeling_blenderbot.py
+-r--------  2.0 unx    19111 b- defN 24-Apr-02 03:19 mindnlp/transformers/models/blenderbot/tokenization_blenderbot.py
+-r--------  2.0 unx    19111 b- defN 24-Apr-02 03:19 mindnlp/transformers/models/blenderbot/tokenization_blenderbot_fast.py
+-r--------  2.0 unx     1252 b- defN 24-Apr-02 08:27 mindnlp/transformers/models/blenderbot_small/__init__.py
+-r--------  2.0 unx     7547 b- defN 24-Apr-02 08:27 mindnlp/transformers/models/blenderbot_small/configuration_blenderbot_small.py
+-r--------  2.0 unx    65461 b- defN 24-Apr-02 08:27 mindnlp/transformers/models/blenderbot_small/modeling_blenderbot_small.py
+-r--------  2.0 unx     9002 b- defN 24-Apr-02 08:27 mindnlp/transformers/models/blenderbot_small/tokenization_blenderbot_small.py
+-r--------  2.0 unx     4354 b- defN 24-Apr-02 08:27 mindnlp/transformers/models/blenderbot_small/tokenization_blenderbot_small_fast.py
+-r--------  2.0 unx     1087 b- defN 24-Apr-02 15:06 mindnlp/transformers/models/blip/__init__.py
+-r--------  2.0 unx    16456 b- defN 24-Apr-02 15:06 mindnlp/transformers/models/blip/configuration_blip.py
+-r--------  2.0 unx    15742 b- defN 24-Apr-02 15:06 mindnlp/transformers/models/blip/image_processing_blip.py
+-r--------  2.0 unx    53787 b- defN 24-Apr-02 15:06 mindnlp/transformers/models/blip/modeling_blip.py
+-r--------  2.0 unx    43537 b- defN 24-Apr-02 15:06 mindnlp/transformers/models/blip/modeling_blip_text.py
+-r--------  2.0 unx     6235 b- defN 24-Apr-02 15:06 mindnlp/transformers/models/blip/processing_blip.py
+-r--------  2.0 unx     1000 b- defN 24-Apr-08 06:51 mindnlp/transformers/models/blip_2/__init__.py
+-r--------  2.0 unx    16475 b- defN 24-Apr-08 06:51 mindnlp/transformers/models/blip_2/configuration_blip_2.py
+-r--------  2.0 unx    71527 b- defN 24-Apr-08 06:51 mindnlp/transformers/models/blip_2/modeling_blip_2.py
+-r--------  2.0 unx     6730 b- defN 24-Apr-08 06:51 mindnlp/transformers/models/blip_2/processing_blip_2.py
+-r--------  2.0 unx     1012 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/bloom/__init__.py
+-r--------  2.0 unx     7089 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/bloom/configuration_bloom.py
+-r--------  2.0 unx    45166 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/bloom/modeling_bloom.py
+-r--------  2.0 unx     8034 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/bloom/tokenization_bloom_fast.py
+-r--------  2.0 unx     1178 b- defN 24-Apr-08 07:51 mindnlp/transformers/models/bridgetower/__init__.py
+-r--------  2.0 unx    16296 b- defN 24-Apr-08 07:02 mindnlp/transformers/models/bridgetower/configuration_bridgetower.py
+-r--------  2.0 unx    26920 b- defN 24-Apr-08 09:27 mindnlp/transformers/models/bridgetower/image_processing_bridgetower.py
+-r--------  2.0 unx    81582 b- defN 24-Apr-08 09:28 mindnlp/transformers/models/bridgetower/modeling_bridgetower.py
+-r--------  2.0 unx     5094 b- defN 24-Apr-08 07:04 mindnlp/transformers/models/bridgetower/processing_bridgetower.py
+-r--------  2.0 unx      981 b- defN 24-Apr-08 08:35 mindnlp/transformers/models/bros/__init__.py
+-r--------  2.0 unx     6419 b- defN 24-Apr-08 08:21 mindnlp/transformers/models/bros/configuration_bros.py
+-r--------  2.0 unx    51532 b- defN 24-Apr-08 09:31 mindnlp/transformers/models/bros/modeling_bros.py
+-r--------  2.0 unx     4223 b- defN 24-Apr-08 08:21 mindnlp/transformers/models/bros/processing_bros.py
+-r--------  2.0 unx      809 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/byt5/__init__.py
+-r--------  2.0 unx    10025 b- defN 24-Mar-25 09:13 mindnlp/transformers/models/byt5/tokenization_byt5.py
+-r--------  2.0 unx     1131 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/chatglm/__init__.py
+-r--------  2.0 unx     4956 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/chatglm/configuration_chatglm.py
+-r--------  2.0 unx    47697 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/chatglm/modeling_chatglm.py
+-r--------  2.0 unx    45162 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/chatglm/modeling_graph_chatglm.py
+-r--------  2.0 unx    17674 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/chatglm/tokenization_chatglm.py
+-r--------  2.0 unx     1031 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/chatglm2/__init__.py
+-r--------  2.0 unx     3087 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/chatglm2/configuration_chatglm2.py
+-r--------  2.0 unx    51372 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/chatglm2/modeling_chatglm2.py
+-r--------  2.0 unx    10845 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/chatglm2/tokenization_chatglm2.py
+-r--------  2.0 unx     1043 b- defN 24-Feb-29 23:52 mindnlp/transformers/models/chatglm3/__init__.py
+-r--------  2.0 unx    12016 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/chatglm3/modeling_chatglm3.py
+-r--------  2.0 unx    13744 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/chatglm3/tokenization_chatglm3.py
+-r--------  2.0 unx     1290 b- defN 24-Mar-01 12:40 mindnlp/transformers/models/clip/__init__.py
+-r--------  2.0 unx    19554 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/clip/configuration_clip.py
+-r--------  2.0 unx    16649 b- defN 24-Mar-01 12:40 mindnlp/transformers/models/clip/image_processing_clip.py
+-r--------  2.0 unx    54023 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/clip/modeling_clip.py
+-r--------  2.0 unx     6983 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/clip/processing_clip.py
+-r--------  2.0 unx    21283 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/clip/tokenization_clip.py
+-r--------  2.0 unx     7387 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/clip/tokenization_clip_fast.py
+-r--------  2.0 unx     1239 b- defN 24-Mar-03 07:54 mindnlp/transformers/models/codegen/__init__.py
+-r--------  2.0 unx     7710 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/codegen/configuration_codegen.py
+-r--------  2.0 unx    26987 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/codegen/modeling_codegen.py
+-r--------  2.0 unx    15302 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/codegen/tokenization_codegen.py
+-r--------  2.0 unx    10395 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/codegen/tokenization_codegen_fast.py
+-r--------  2.0 unx     1082 b- defN 24-Apr-08 06:51 mindnlp/transformers/models/convbert/__init__.py
+-r--------  2.0 unx    47131 b- defN 24-Apr-08 06:51 mindnlp/transformers/models/convbert/convbert.py
+-r--------  2.0 unx     3138 b- defN 24-Apr-08 06:51 mindnlp/transformers/models/convbert/convbert_config.py
+-r--------  2.0 unx    21854 b- defN 24-Apr-08 06:51 mindnlp/transformers/models/convbert/convbert_tokenizer.py
+-r--------  2.0 unx     8790 b- defN 24-Apr-08 06:51 mindnlp/transformers/models/convbert/convbert_tokenizer_fast.py
+-r--------  2.0 unx     1013 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/cpm/__init__.py
+-r--------  2.0 unx    15403 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/cpm/tokenization_cpm.py
+-r--------  2.0 unx    10855 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/cpm/tokenization_cpm_fast.py
+-r--------  2.0 unx     1110 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/cpmant/__init__.py
+-r--------  2.0 unx     5439 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/cpmant/configuration_cpmant.py
+-r--------  2.0 unx    35004 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/cpmant/modeling_cpmant.py
+-r--------  2.0 unx    10166 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/cpmant/tokenization_cpmant.py
+-r--------  2.0 unx     1110 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/cpmbee/__init__.py
+-r--------  2.0 unx     6080 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/cpmbee/configuration_cpmbee.py
+-r--------  2.0 unx    92050 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/cpmbee/modeling_cpmbee.py
+-r--------  2.0 unx    39889 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/cpmbee/tokenization_cpmbee.py
+-r--------  2.0 unx     1139 b- defN 24-Mar-19 16:41 mindnlp/transformers/models/deberta/__init__.py
+-r--------  2.0 unx     7765 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/deberta/configuration_deberta.py
+-r--------  2.0 unx    50218 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/deberta/modeling_deberta.py
+-r--------  2.0 unx    19193 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/deberta/tokenization_deberta.py
+-r--------  2.0 unx    12810 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/deberta/tokenization_deberta_fast.py
+-r--------  2.0 unx     1168 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/distilbert/__init__.py
+-r--------  2.0 unx     6538 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/distilbert/configuration_distilbert.py
+-r--------  2.0 unx    45504 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/distilbert/modeling_distilbert.py
+-r--------  2.0 unx    23792 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/distilbert/tokenization_distilbert.py
+-r--------  2.0 unx    10831 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/distilbert/tokenization_distilbert_fast.py
+-r--------  2.0 unx      177 b- defN 24-Mar-20 16:25 mindnlp/transformers/models/efficientnet/__init__.py
+-r--------  2.0 unx    18993 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/efficientnet/image_processing_efficientnet.py
+-r--------  2.0 unx      721 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/electra/__init__.py
+-r--------  2.0 unx     1037 b- defN 24-Mar-26 13:06 mindnlp/transformers/models/encodec/__init__.py
+-r--------  2.0 unx     8843 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/encodec/configuration_encodec.py
+-r--------  2.0 unx     9976 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/encodec/feature_extraction_encodec.py
+-r--------  2.0 unx    30861 b- defN 24-Mar-31 10:53 mindnlp/transformers/models/encodec/modeling_encodec.py
+-r--------  2.0 unx     1007 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/ernie/__init__.py
+-r--------  2.0 unx     8387 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/ernie/configuration_ernie.py
+-r--------  2.0 unx    82282 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/ernie/modeling_ernie.py
+-r--------  2.0 unx    72732 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/ernie/modeling_graph_ernie.py
+-r--------  2.0 unx     1129 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/ernie_m/__init__.py
+-r--------  2.0 unx     6341 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/ernie_m/configuration_ernie_m.py
+-r--------  2.0 unx    45836 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/ernie_m/modeling_ernie_m.py
+-r--------  2.0 unx    41160 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/ernie_m/modeling_graph_ernie_m.py
+-r--------  2.0 unx    17469 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/ernie_m/tokenization_ernie_m.py
+-r--------  2.0 unx     1072 b- defN 24-Mar-03 07:54 mindnlp/transformers/models/esm/__init__.py
+-r--------  2.0 unx    14702 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/esm/configuration_esm.py
+-r--------  2.0 unx    50040 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/esm/modeling_esm.py
+-r--------  2.0 unx    80557 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/esm/modeling_esmfold.py
+-r--------  2.0 unx     6019 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/esm/tokenization_esm.py
+-r--------  2.0 unx     1132 b- defN 24-Mar-03 07:54 mindnlp/transformers/models/esm/openfold_utils/__init__.py
+-r--------  2.0 unx    14496 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/esm/openfold_utils/chunk_utils.py
+-r--------  2.0 unx     3754 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/esm/openfold_utils/data_transforms.py
+-r--------  2.0 unx     8417 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/esm/openfold_utils/feats.py
+-r--------  2.0 unx     3782 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/esm/openfold_utils/loss.py
+-r--------  2.0 unx    11534 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/esm/openfold_utils/protein.py
+-r--------  2.0 unx    37942 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/esm/openfold_utils/residue_constants.py
+-r--------  2.0 unx    38685 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/esm/openfold_utils/rigid_utils.py
+-r--------  2.0 unx     4870 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/esm/openfold_utils/tensor_utils.py
+-r--------  2.0 unx      909 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/falcon/__init__.py
+-r--------  2.0 unx     4835 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/falcon/configuration_falcon.py
+-r--------  2.0 unx    62192 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/falcon/modeling_falcon.py
+-r--------  2.0 unx     1112 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/gemma/__init__.py
+-r--------  2.0 unx     6787 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/gemma/configuration_gemma.py
+-r--------  2.0 unx    37813 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/gemma/modeling_gemma.py
+-r--------  2.0 unx    14094 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/gemma/tokenization_gemma.py
+-r--------  2.0 unx     8333 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/gemma/tokenization_gemma_fast.py
+-r--------  2.0 unx     1084 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/gpt/__init__.py
+-r--------  2.0 unx     7187 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/gpt/configuration_gpt.py
+-r--------  2.0 unx    28682 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/gpt/modeling_gpt.py
+-r--------  2.0 unx    19898 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/gpt/modeling_graph_gpt.py
+-r--------  2.0 unx    15578 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/gpt/tokenization_gpt.py
+-r--------  2.0 unx     3059 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/gpt/tokenization_gpt_fast.py
+-r--------  2.0 unx     1129 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/gpt2/__init__.py
+-r--------  2.0 unx     9357 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/gpt2/configuration_gpt2.py
+-r--------  2.0 unx    54753 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/gpt2/modeling_gpt2.py
+-r--------  2.0 unx    38645 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/gpt2/modeling_graph_gpt2.py
+-r--------  2.0 unx    15005 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/gpt2/tokenization_gpt2.py
+-r--------  2.0 unx     8162 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/gpt2/tokenization_gpt2_fast.py
+-r--------  2.0 unx     1002 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/gpt_bigcode/__init__.py
+-r--------  2.0 unx    41443 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/gpt_bigcode/gpt_bigcode.py
+-r--------  2.0 unx     2866 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/gpt_bigcode/gpt_bigcode_config.py
+-r--------  2.0 unx     3451 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/gpt_bigcode/gpt_bigcode_tokenizer.py
+-r--------  2.0 unx      893 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/gpt_neo/__init__.py
+-r--------  2.0 unx    31296 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/gpt_neo/gpt_neo.py
+-r--------  2.0 unx     3658 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/gpt_neo/gpt_neo_config.py
+-r--------  2.0 unx      989 b- defN 24-Mar-25 13:55 mindnlp/transformers/models/gpt_neox/__init__.py
+-r--------  2.0 unx     4201 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/gpt_neox/configuration_gpt_neox.py
+-r--------  2.0 unx    47248 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/gpt_neox/modeling_gpt_neox.py
+-r--------  2.0 unx     6036 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/gpt_neox/tokenization_gpt_neox_fast.py
+-r--------  2.0 unx     1035 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/gpt_pangu/__init__.py
+-r--------  2.0 unx     2478 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/gpt_pangu/configuration_gptpangu.py
+-r--------  2.0 unx    22225 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/gpt_pangu/modeling_gptpangu.py
+-r--------  2.0 unx     5069 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/gpt_pangu/tokenization_gptpangu.py
+-r--------  2.0 unx     1105 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/graphormer/__init__.py
+-r--------  2.0 unx     3633 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/graphormer/algos_graphormer.pyx
+-r--------  2.0 unx     7817 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/graphormer/collating_graphormer.py
+-r--------  2.0 unx    10646 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/graphormer/configuration_graphormer.py
+-r--------  2.0 unx    37098 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/graphormer/modeling_graphormer.py
+-r--------  2.0 unx     1555 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/graphormer/utils.py
+-r--------  2.0 unx     1039 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/hubert/__init__.py
+-r--------  2.0 unx    14985 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/hubert/configuration_hubert.py
+-r--------  2.0 unx    50925 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/hubert/modeling_hubert.py
+-r--------  2.0 unx     1028 b- defN 24-Mar-29 11:32 mindnlp/transformers/models/internlm/__init__.py
+-r--------  2.0 unx     5010 b- defN 24-Mar-29 11:31 mindnlp/transformers/models/internlm/configuration_internlm.py
+-r--------  2.0 unx    34104 b- defN 24-Mar-29 11:45 mindnlp/transformers/models/internlm/modeling_internlm.py
+-r--------  2.0 unx     9764 b- defN 24-Mar-29 11:30 mindnlp/transformers/models/internlm/tokenization_internlm.py
+-r--------  2.0 unx      900 b- defN 24-Mar-31 10:53 mindnlp/transformers/models/jamba/__init__.py
+-r--------  2.0 unx    11241 b- defN 24-Mar-31 10:53 mindnlp/transformers/models/jamba/configuration_jamba.py
+-r--------  2.0 unx    65061 b- defN 24-Mar-31 10:57 mindnlp/transformers/models/jamba/modeling_jamba.py
+-r--------  2.0 unx      907 b- defN 24-Apr-08 11:34 mindnlp/transformers/models/jetmoe/__init__.py
+-r--------  2.0 unx     6280 b- defN 24-Apr-08 14:10 mindnlp/transformers/models/jetmoe/configuration_jetmoe.py
+-r--------  2.0 unx    42819 b- defN 24-Apr-09 06:51 mindnlp/transformers/models/jetmoe/modeling_jetmoe.py
+-r--------  2.0 unx       83 b- defN 24-Apr-09 06:53 mindnlp/transformers/models/jetmoe/utils/__init__.py
+-r--------  2.0 unx     4097 b- defN 24-Apr-09 06:50 mindnlp/transformers/models/jetmoe/utils/gate.py
+-r--------  2.0 unx     9590 b- defN 24-Apr-09 06:53 mindnlp/transformers/models/jetmoe/utils/moe.py
+-r--------  2.0 unx     3474 b- defN 24-Apr-09 06:50 mindnlp/transformers/models/jetmoe/utils/parallel_experts.py
+-r--------  2.0 unx      875 b- defN 24-Mar-16 11:41 mindnlp/transformers/models/layoutlm/__init__.py
+-r--------  2.0 unx     2450 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/layoutlm/configuration_layoutlm.py
+-r--------  2.0 unx    54421 b- defN 24-Mar-28 15:43 mindnlp/transformers/models/layoutlm/modeling_layoutlm.py
+-r--------  2.0 unx    22005 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/layoutlm/tokenization_layoutlm.py
+-r--------  2.0 unx     9082 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/layoutlm/tokenization_layoutlm_fast.py
+-r--------  2.0 unx     1365 b- defN 24-Mar-27 18:05 mindnlp/transformers/models/layoutlmv2/__init__.py
+-r--------  2.0 unx    13789 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/layoutlmv2/configuration_layoutlmv2.py
+-r--------  2.0 unx    14101 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/layoutlmv2/image_processing_layoutlmv2.py
+-r--------  2.0 unx    54245 b- defN 24-Mar-28 15:43 mindnlp/transformers/models/layoutlmv2/modeling_layoutlmv2.py
+-r--------  2.0 unx     9900 b- defN 24-Mar-24 20:22 mindnlp/transformers/models/layoutlmv2/processing_layoutlmv2.py
+-r--------  2.0 unx    73385 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/layoutlmv2/tokenization_layoutlmv2.py
+-r--------  2.0 unx    38073 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/layoutlmv2/tokenization_layoutlmv2_fast.py
+-r--------  2.0 unx    23537 b- defN 24-Mar-28 15:43 mindnlp/transformers/models/layoutlmv2/visual_backbone.py
+-r--------  2.0 unx     1457 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/llama/__init__.py
+-r--------  2.0 unx     9417 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/llama/configuration_llama.py
+-r--------  2.0 unx    37351 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/llama/modeling_llama.py
+-r--------  2.0 unx    23580 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/llama/tokenization_code_llama.py
+-r--------  2.0 unx    19760 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/llama/tokenization_code_llama_fast.py
+-r--------  2.0 unx    22019 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/llama/tokenization_llama.py
+-r--------  2.0 unx    13087 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/llama/tokenization_llama_fast.py
+-r--------  2.0 unx     1173 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/longformer/__init__.py
+-r--------  2.0 unx     7354 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/longformer/configuration_longformer.py
+-r--------  2.0 unx   107905 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/longformer/modeling_longformer.py
+-r--------  2.0 unx    19034 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/longformer/tokenization_longformer.py
+-r--------  2.0 unx    14789 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/longformer/tokenization_longformer_fast.py
+-r--------  2.0 unx     1012 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/longt5/__init__.py
+-r--------  2.0 unx     7520 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/longt5/configuration_longt5.py
+-r--------  2.0 unx    84899 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/longt5/modeling_longt5.py
+-r--------  2.0 unx    16754 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/longt5/tokenization_longt5.py
+-r--------  2.0 unx     1042 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/luke/__init__.py
+-r--------  2.0 unx    59689 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/luke/luke.py
+-r--------  2.0 unx     2725 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/luke/luke_config.py
+-r--------  2.0 unx    84793 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/luke/tokenization_luke.py
+-r--------  2.0 unx     1003 b- defN 24-Mar-16 11:41 mindnlp/transformers/models/mamba/__init__.py
+-r--------  2.0 unx     7241 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/mamba/configuration_mamba.py
+-r--------  2.0 unx    20727 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/mamba/modeling_graph_mamba.py
+-r--------  2.0 unx    22627 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/mamba/modeling_mamba.py
+-r--------  2.0 unx      891 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/maskformer/__init__.py
+-r--------  2.0 unx        0 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/maskformer/maskformer.py
+-r--------  2.0 unx        0 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/maskformer/maskformer_config.py
+-r--------  2.0 unx     1109 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/mbart/__init__.py
+-r--------  2.0 unx     3514 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/mbart/configuration_mbart.py
+-r--------  2.0 unx    60039 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/mbart/modeling_mbart.py
+-r--------  2.0 unx    13994 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/mbart/tokenization_mbart.py
+-r--------  2.0 unx    12171 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/mbart/tokenization_mbart_fast.py
+-r--------  2.0 unx     1044 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/megatron_bert/__init__.py
+-r--------  2.0 unx     6610 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/megatron_bert/configuration_megatron_bert.py
+-r--------  2.0 unx    72730 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/megatron_bert/modeling_megatron_bert.py
+-r--------  2.0 unx        0 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/megatron_gpt2/__init__.py
+-r--------  2.0 unx        0 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/megatron_gpt2/megatron_gpt2.py
+-r--------  2.0 unx        0 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/megatron_gpt2/megatron_gpt2_config.py
+-r--------  2.0 unx      912 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/minicpm/__init__.py
+-r--------  2.0 unx     9726 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/minicpm/configuration_minicpm.py
+-r--------  2.0 unx    42349 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/minicpm/modeling_minicpm.py
+-r--------  2.0 unx        0 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/minicpm/modeling_minicpmv.py
+-r--------  2.0 unx      645 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/minigpt4/__init__.py
+-r--------  2.0 unx     1014 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/mistral/__init__.py
+-r--------  2.0 unx     7200 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/mistral/configuration_mistral.py
+-r--------  2.0 unx    34808 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/mistral/modeling_mistral.py
+-r--------  2.0 unx     1014 b- defN 24-Mar-12 03:14 mindnlp/transformers/models/mixtral/__init__.py
+-r--------  2.0 unx     8160 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/mixtral/configuration_mixtral.py
+-r--------  2.0 unx    44559 b- defN 24-Mar-29 12:34 mindnlp/transformers/models/mixtral/modeling_mixtral.py
+-r--------  2.0 unx     1096 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/mobilebert/__init__.py
+-r--------  2.0 unx    57813 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/mobilebert/mobilebert.py
+-r--------  2.0 unx     3205 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/mobilebert/mobilebert_config.py
+-r--------  2.0 unx     5687 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/mobilebert/mobilebert_tokenizer.py
+-r--------  2.0 unx      778 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/moss/__init__.py
+-r--------  2.0 unx    32778 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/moss/moss.py
+-r--------  2.0 unx     2838 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/moss/moss_configuration.py
+-r--------  2.0 unx      867 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/moss/moss_tokenization.py
+-r--------  2.0 unx      889 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/mt5/__init__.py
+-r--------  2.0 unx     6755 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/mt5/configuration_mt5.py
+-r--------  2.0 unx    81209 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/mt5/modeling_mt5.py
+-r--------  2.0 unx     1025 b- defN 24-Mar-31 12:57 mindnlp/transformers/models/musicgen/__init__.py
+-r--------  2.0 unx    10700 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/musicgen/configuration_musicgen.py
+-r--------  2.0 unx   110242 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/musicgen/modeling_musicgen.py
+-r--------  2.0 unx     5684 b- defN 24-Mar-26 12:58 mindnlp/transformers/models/musicgen/processing_musicgen.py
+-r--------  2.0 unx     1240 b- defN 24-Mar-31 16:52 mindnlp/transformers/models/musicgen_melody/__init__.py
+-r--------  2.0 unx    11975 b- defN 24-Mar-31 16:52 mindnlp/transformers/models/musicgen_melody/configuration_musicgen_melody.py
+-r--------  2.0 unx    15630 b- defN 24-Mar-31 16:52 mindnlp/transformers/models/musicgen_melody/feature_extraction_musicgen_melody.py
+-r--------  2.0 unx   106734 b- defN 24-Mar-31 16:52 mindnlp/transformers/models/musicgen_melody/modeling_musicgen_melody.py
+-r--------  2.0 unx     8653 b- defN 24-Mar-31 16:52 mindnlp/transformers/models/musicgen_melody/processing_musicgen_melody.py
+-r--------  2.0 unx      945 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/nezha/__init__.py
+-r--------  2.0 unx    47907 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/nezha/nezha.py
+-r--------  2.0 unx     2431 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/nezha/nezha_config.py
+-r--------  2.0 unx     2953 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/nezha/nezha_tokenizer.py
+-r--------  2.0 unx      891 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/opt/__init__.py
+-r--------  2.0 unx     7373 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/opt/configuration_opt.py
+-r--------  2.0 unx    47645 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/opt/modeling_opt.py
+-r--------  2.0 unx      943 b- defN 24-Mar-28 03:04 mindnlp/transformers/models/pegasus/__init__.py
+-r--------  2.0 unx    13184 b- defN 24-Mar-28 06:06 mindnlp/transformers/models/pegasus/tokenization_pegasus.py
+-r--------  2.0 unx     9982 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/pegasus/tokenization_pegasus_fast.py
+-r--------  2.0 unx      892 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/phi/__init__.py
+-r--------  2.0 unx     9266 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/phi/configuration_phi.py
+-r--------  2.0 unx    42961 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/phi/modeling_phi.py
+-r--------  2.0 unx      600 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/pop2piano/__init__.py
+-r--------  2.0 unx     6241 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/pop2piano/configuration_pop2piano.py
+-r--------  2.0 unx    20121 b- defN 24-Mar-28 06:07 mindnlp/transformers/models/pop2piano/feature_extraction_pop2piano.py
+-r--------  2.0 unx    60570 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/pop2piano/modeling_pop2piano.py
+-r--------  2.0 unx     5589 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/pop2piano/processing_pop2piano.py
+-r--------  2.0 unx    32281 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/pop2piano/tokenization_pop2piano.py
+-r--------  2.0 unx     1108 b- defN 24-Mar-04 00:35 mindnlp/transformers/models/qwen2/__init__.py
+-r--------  2.0 unx     6840 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/qwen2/configuration_qwen2.py
+-r--------  2.0 unx    35438 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/qwen2/modeling_qwen2.py
+-r--------  2.0 unx    14338 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/qwen2/tokenization_qwen2.py
+-r--------  2.0 unx     5700 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/qwen2/tokenization_qwen2_fast.py
+-r--------  2.0 unx      927 b- defN 24-Mar-29 10:52 mindnlp/transformers/models/qwen2_moe/__init__.py
+-r--------  2.0 unx     8573 b- defN 24-Mar-29 10:32 mindnlp/transformers/models/qwen2_moe/configuration_qwen2_moe.py
+-r--------  2.0 unx    45282 b- defN 24-Mar-29 13:12 mindnlp/transformers/models/qwen2_moe/modeling_qwen2_moe.py
+-r--------  2.0 unx     1148 b- defN 24-Mar-19 16:41 mindnlp/transformers/models/reformer/__init__.py
+-r--------  2.0 unx    13575 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/reformer/configuration_reformer.py
+-r--------  2.0 unx   107482 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/reformer/modeling_reformer.py
+-r--------  2.0 unx     7289 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/reformer/tokenization_reformer.py
+-r--------  2.0 unx     5004 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/reformer/tokenization_reformer_fast.py
+-r--------  2.0 unx        0 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/regnet/__init__.py
+-r--------  2.0 unx     1133 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/roberta/__init__.py
+-r--------  2.0 unx     2420 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/roberta/configuration_roberta.py
+-r--------  2.0 unx    12078 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/roberta/modeling_graph_roberta.py
+-r--------  2.0 unx    60971 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/roberta/modeling_roberta.py
+-r--------  2.0 unx    18177 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/roberta/tokenization_roberta.py
+-r--------  2.0 unx    13885 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/roberta/tokenization_roberta_fast.py
+-r--------  2.0 unx      995 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/rwkv/__init__.py
+-r--------  2.0 unx     6303 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/rwkv/configuration_rwkv.py
+-r--------  2.0 unx    28881 b- defN 24-Mar-29 07:53 mindnlp/transformers/models/rwkv/modeling_rwkv.py
+-r--------  2.0 unx     1459 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/seamless_m4t/__init__.py
+-r--------  2.0 unx    23758 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/seamless_m4t/configuration_seamless_m4t.py
+-r--------  2.0 unx    13061 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/seamless_m4t/feature_extraction_seamless_m4t.py
+-r--------  2.0 unx   189385 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/seamless_m4t/modeling_seamless_m4t.py
+-r--------  2.0 unx     5891 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/seamless_m4t/processing_seamless_m4t.py
+-r--------  2.0 unx    25979 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/seamless_m4t/tokenization_seamless_m4t.py
+-r--------  2.0 unx    20489 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/seamless_m4t/tokenization_seamless_m4t_fast.py
+-r--------  2.0 unx      974 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/seamless_m4t_v2/__init__.py
+-r--------  2.0 unx    24474 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/seamless_m4t_v2/configuration_seamless_m4t_v2.py
+-r--------  2.0 unx   211331 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/seamless_m4t_v2/modeling_seamless_m4t_v2.py
+-r--------  2.0 unx      934 b- defN 24-Mar-09 17:05 mindnlp/transformers/models/starcoder2/__init__.py
+-r--------  2.0 unx     6919 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/starcoder2/configuration_starcoder2.py
+-r--------  2.0 unx    36584 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/starcoder2/modeling_starcoder2.py
+-r--------  2.0 unx     1171 b- defN 24-Mar-24 20:22 mindnlp/transformers/models/t5/__init__.py
+-r--------  2.0 unx     4419 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/t5/chatyuan_tokenizer.py
+-r--------  2.0 unx     6772 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/t5/configuration_t5.py
+-r--------  2.0 unx    70759 b- defN 24-Mar-31 10:53 mindnlp/transformers/models/t5/modeling_t5.py
+-r--------  2.0 unx    20403 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/t5/tokenization_t5.py
+-r--------  2.0 unx    10806 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/t5/tokenization_t5_fast.py
+-r--------  2.0 unx      694 b- defN 24-Mar-31 10:53 mindnlp/transformers/models/table_transformer/__init__.py
+-r--------  2.0 unx        0 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/timesformer/__init__.py
+-r--------  2.0 unx      879 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/tinybert/__init__.py
+-r--------  2.0 unx    25866 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/tinybert/tinybert.py
+-r--------  2.0 unx     3520 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/tinybert/tinybert_config.py
+-r--------  2.0 unx        0 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/transformer/__init__.py
+-r--------  2.0 unx        0 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/transformer/transformer.py
+-r--------  2.0 unx        0 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/transformer/transformer_config.py
+-r--------  2.0 unx     1598 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/wav2vec2/__init__.py
+-r--------  2.0 unx    20372 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/wav2vec2/configuration_wav2vec2.py
+-r--------  2.0 unx    11553 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/wav2vec2/feature_extraction_wav2vec2.py
+-r--------  2.0 unx    97015 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/wav2vec2/modeling_wav2vec2.py
+-r--------  2.0 unx     7177 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/wav2vec2/processing_wav2vec2.py
+-r--------  2.0 unx    36485 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/wav2vec2/tokenization_wav2vec2.py
+-r--------  2.0 unx      860 b- defN 24-Mar-19 16:41 mindnlp/transformers/models/wav2vec2_with_lm/__init__.py
+-r--------  2.0 unx    29591 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/wav2vec2_with_lm/processing_wav2vec2_with_lm.py
+-r--------  2.0 unx     1356 b- defN 24-Mar-20 16:25 mindnlp/transformers/models/whisper/__init__.py
+-r--------  2.0 unx    14562 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/whisper/configuration_whisper.py
+-r--------  2.0 unx    22879 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/whisper/english_normalizer.py
+-r--------  2.0 unx    11806 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/whisper/feature_extraction_whisper.py
+-r--------  2.0 unx        0 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/whisper/modeling_graph_whisper.py
+-r--------  2.0 unx    96893 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/whisper/modeling_whisper.py
+-r--------  2.0 unx     3961 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/whisper/processing_whisper.py
+-r--------  2.0 unx    53819 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/whisper/tokenization_whisper.py
+-r--------  2.0 unx    32375 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/whisper/tokenization_whisper_fast.py
+-r--------  2.0 unx      983 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/xlm/__init__.py
+-r--------  2.0 unx    11328 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/xlm/configuration_xlm.py
+-r--------  2.0 unx    46629 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/xlm/modeling_xlm.py
+-r--------  2.0 unx    34991 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/xlm/tokenization_xlm.py
+-r--------  2.0 unx     1192 b- defN 24-Feb-29 06:56 mindnlp/transformers/models/xlm_roberta/__init__.py
+-r--------  2.0 unx     6980 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/xlm_roberta/configuration_xlm_roberta.py
+-r--------  2.0 unx    63314 b- defN 24-Mar-25 11:12 mindnlp/transformers/models/xlm_roberta/modeling_xlm_roberta.py
+-r--------  2.0 unx    14289 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/xlm_roberta/tokenization_xlm_roberta.py
+-r--------  2.0 unx    10433 b- defN 24-Mar-28 15:57 mindnlp/transformers/models/xlm_roberta/tokenization_xlm_roberta_fast.py
+-r--------  2.0 unx     1109 b- defN 24-Apr-08 06:51 mindnlp/transformers/models/xlnet/__init__.py
+-r--------  2.0 unx     4735 b- defN 24-Apr-08 06:51 mindnlp/transformers/models/xlnet/configuration_xlnet.py
+-r--------  2.0 unx    85973 b- defN 24-Apr-08 06:51 mindnlp/transformers/models/xlnet/modeling_xlnet.py
+-r--------  2.0 unx    16395 b- defN 24-Apr-08 06:51 mindnlp/transformers/models/xlnet/tokenization_xlnet.py
+-r--------  2.0 unx    10222 b- defN 24-Apr-08 06:51 mindnlp/transformers/models/xlnet/tokenization_xlnet_fast.py
+-r--------  2.0 unx    26016 b- defN 24-Mar-28 00:49 mindnlp/transformers/pipelines/__init__.py
+-r--------  2.0 unx     9793 b- defN 24-Mar-25 11:56 mindnlp/transformers/pipelines/audio_utils.py
+-r--------  2.0 unx    37518 b- defN 24-Mar-28 15:57 mindnlp/transformers/pipelines/automatic_speech_recognition.py
+-r--------  2.0 unx    35984 b- defN 24-Mar-25 11:55 mindnlp/transformers/pipelines/base.py
+-r--------  2.0 unx    27144 b- defN 24-Mar-28 15:57 mindnlp/transformers/pipelines/document_question_answering.py
+-r--------  2.0 unx    28511 b- defN 24-Mar-28 15:57 mindnlp/transformers/pipelines/question_answering.py
+-r--------  2.0 unx    17651 b- defN 24-Mar-28 15:57 mindnlp/transformers/pipelines/text2text_generation.py
+-r--------  2.0 unx     9640 b- defN 24-Mar-28 15:57 mindnlp/transformers/pipelines/text_classification.py
+-r--------  2.0 unx    15366 b- defN 24-Mar-28 15:57 mindnlp/transformers/pipelines/text_generation.py
+-r--------  2.0 unx    13013 b- defN 24-Mar-28 15:57 mindnlp/transformers/pipelines/zero_shot_classification.py
+-r--------  2.0 unx     1510 b- defN 24-Mar-25 13:50 mindnlp/utils/__init__.py
+-r--------  2.0 unx    16335 b- defN 24-Mar-25 11:49 mindnlp/utils/backbone_utils.py
+-r--------  2.0 unx     1458 b- defN 24-Feb-29 06:56 mindnlp/utils/compatibility.py
+-r--------  2.0 unx     2916 b- defN 23-Mar-22 09:42 mindnlp/utils/decompress.py
+-r--------  2.0 unx    32202 b- defN 24-Mar-28 15:57 mindnlp/utils/download.py
+-r--------  2.0 unx    12029 b- defN 24-Mar-28 15:57 mindnlp/utils/errors.py
+-r--------  2.0 unx    11747 b- defN 24-Mar-25 11:12 mindnlp/utils/generic.py
+-r--------  2.0 unx    14008 b- defN 24-Mar-27 18:05 mindnlp/utils/import_utils.py
+-r--------  2.0 unx    11478 b- defN 24-Mar-25 12:05 mindnlp/utils/logging.py
+-r--------  2.0 unx     4451 b- defN 24-Mar-28 15:57 mindnlp/utils/peft_utils.py
+-r--------  2.0 unx     1898 b- defN 24-Mar-25 11:12 mindnlp/utils/save.py
+-r--------  2.0 unx    21582 b- defN 24-Apr-02 03:19 mindnlp/utils/serialization.py
+-r--------  2.0 unx    50268 b- defN 24-Mar-30 01:45 mindnlp/utils/testing_utils.py
+-r--------  2.0 unx      712 b- defN 23-Mar-22 09:42 mindnlp/vocab/__init__.py
+-r--------  2.0 unx    11522 b- defN 24-Apr-01 15:34 mindnlp/vocab/vocab.py
+-r--------  2.0 unx      768 b- defN 23-Mar-22 09:42 mindnlp/workflow/__init__.py
+-r--------  2.0 unx     5813 b- defN 23-Jul-15 13:56 mindnlp/workflow/utils.py
+-r--------  2.0 unx     7577 b- defN 24-Mar-25 11:12 mindnlp/workflow/work.py
+-r--------  2.0 unx     7103 b- defN 23-Jul-15 13:56 mindnlp/workflow/workflow.py
+-r--------  2.0 unx      757 b- defN 23-Mar-22 09:42 mindnlp/workflow/downstream/__init__.py
+-r--------  2.0 unx     1557 b- defN 24-Mar-25 11:12 mindnlp/workflow/downstream/sentiment_analysis_model.py
+-r--------  2.0 unx      780 b- defN 23-Jul-15 13:56 mindnlp/workflow/works/__init__.py
+-r--------  2.0 unx        0 b- defN 23-Mar-22 09:42 mindnlp/workflow/works/classification.py
+-r--------  2.0 unx    26028 b- defN 24-Mar-25 11:12 mindnlp/workflow/works/information_extraction.py
+-r--------  2.0 unx        0 b- defN 23-Mar-22 09:42 mindnlp/workflow/works/ner.py
+-r--------  2.0 unx        0 b- defN 23-Mar-22 09:42 mindnlp/workflow/works/qa.py
+-r--------  2.0 unx     6032 b- defN 24-Feb-29 06:56 mindnlp/workflow/works/sentiment_analysis.py
+-rw-r--r--  2.0 unx       65 b- defN 23-Mar-22 09:42 tests/README.md
+-rw-r--r--  2.0 unx      708 b- defN 23-Mar-22 09:42 tests/__init__.py
+-rw-r--r--  2.0 unx      147 b- defN 24-Feb-29 06:56 tests/common.py
+-rw-r--r--  2.0 unx      129 b- defN 23-Jul-15 13:56 tests/pytest.ini
+-rw-r--r--  2.0 unx      504 b- defN 24-Feb-29 06:56 tests/fixtures/add_distilbert_like_config.json
+-rw-r--r--  2.0 unx       29 b- defN 24-Feb-29 06:56 tests/fixtures/dummy-config.json
+-rw-r--r--  2.0 unx      101 b- defN 24-Feb-29 06:56 tests/fixtures/dummy_feature_extractor_config.json
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/fixtures/empty.txt
+-rw-r--r--  2.0 unx       52 b- defN 24-Feb-29 06:56 tests/fixtures/input.txt
+-rw-r--r--  2.0 unx       36 b- defN 24-Feb-29 06:56 tests/fixtures/merges.txt
+-rw-r--r--  2.0 unx      100 b- defN 24-Feb-29 06:56 tests/fixtures/preprocessor_config.json
+-rw-r--r--  2.0 unx     4394 b- defN 24-Feb-29 06:56 tests/fixtures/sample_text.txt
+-rw-r--r--  2.0 unx     4284 b- defN 24-Feb-29 06:56 tests/fixtures/sample_text_no_unicode.txt
+-rw-r--r--  2.0 unx   760289 b- defN 24-Feb-29 06:56 tests/fixtures/spiece.model
+-rw-r--r--  2.0 unx       76 b- defN 24-Feb-29 06:56 tests/fixtures/test_entity_vocab.json
+-rw-r--r--  2.0 unx   253154 b- defN 24-Feb-29 06:56 tests/fixtures/test_sentencepiece.model
+-rw-r--r--  2.0 unx   251527 b- defN 24-Feb-29 06:56 tests/fixtures/test_sentencepiece_bpe.model
+-rw-r--r--  2.0 unx   238473 b- defN 24-Feb-29 06:56 tests/fixtures/test_sentencepiece_bpe_char.model
+-rw-r--r--  2.0 unx   253134 b- defN 24-Feb-29 06:56 tests/fixtures/test_sentencepiece_no_bos.model
+-rw-r--r--  2.0 unx   270096 b- defN 24-Feb-29 06:56 tests/fixtures/test_sentencepiece_with_bytefallback.model
+-rw-r--r--  2.0 unx      228 b- defN 24-Feb-29 06:56 tests/fixtures/vocab.json
+-rw-r--r--  2.0 unx       85 b- defN 24-Feb-29 06:56 tests/fixtures/vocab.txt
+-rw-r--r--  2.0 unx       52 b- defN 24-Mar-25 11:12 tests/fixtures/tests_samples/.gitignore
+-rw-r--r--  2.0 unx   694498 b- defN 24-Mar-25 11:12 tests/fixtures/tests_samples/COCO/000000039769.png
+-rw-r--r--  2.0 unx     4075 b- defN 24-Mar-25 11:12 tests/fixtures/tests_samples/COCO/coco_annotations.txt
+-rw-r--r--  2.0 unx      555 b- defN 24-Mar-25 11:12 tests/fixtures/tests_samples/COCO/coco_panoptic_annotations.txt
+-rw-r--r--  2.0 unx     8269 b- defN 24-Mar-25 11:12 tests/fixtures/tests_samples/COCO/coco_panoptic/000000039769.png
+-rw-r--r--  2.0 unx     1718 b- defN 24-Mar-25 11:12 tests/fixtures/tests_samples/GermEval/dev.txt
+-rw-r--r--  2.0 unx      218 b- defN 24-Mar-25 11:12 tests/fixtures/tests_samples/GermEval/labels.txt
+-rw-r--r--  2.0 unx     1779 b- defN 24-Mar-25 11:12 tests/fixtures/tests_samples/GermEval/train.txt
+-rw-r--r--  2.0 unx     1354 b- defN 24-Mar-25 11:12 tests/fixtures/tests_samples/MRPC/dev.csv
+-rw-r--r--  2.0 unx     1386 b- defN 24-Mar-25 11:12 tests/fixtures/tests_samples/MRPC/dev.tsv
+-rw-r--r--  2.0 unx     1354 b- defN 24-Mar-25 11:12 tests/fixtures/tests_samples/MRPC/train.csv
+-rw-r--r--  2.0 unx     1386 b- defN 24-Mar-25 11:12 tests/fixtures/tests_samples/MRPC/train.tsv
+-rw-r--r--  2.0 unx    17233 b- defN 24-Mar-25 11:12 tests/fixtures/tests_samples/SQUAD/sample.json
+-rw-r--r--  2.0 unx     1126 b- defN 24-Mar-25 11:12 tests/fixtures/tests_samples/STS-B/dev.tsv
+-rw-r--r--  2.0 unx     1121 b- defN 24-Mar-25 11:12 tests/fixtures/tests_samples/STS-B/train.tsv
+-rw-r--r--  2.0 unx     3001 b- defN 24-Mar-25 11:12 tests/fixtures/tests_samples/conll/sample.json
+-rw-r--r--  2.0 unx     3522 b- defN 24-Mar-25 11:12 tests/fixtures/tests_samples/swag/sample.json
+-rw-r--r--  2.0 unx    79924 b- defN 24-Mar-25 11:12 tests/fixtures/tests_samples/wiki_text/wiki_00
+-rw-r--r--  2.0 unx     1423 b- defN 24-Mar-25 11:12 tests/fixtures/tests_samples/wmt16/sample.json
+-rw-r--r--  2.0 unx    27417 b- defN 24-Mar-25 11:12 tests/fixtures/tests_samples/wmt_en_ro/test.json
+-rw-r--r--  2.0 unx    11234 b- defN 24-Mar-25 11:12 tests/fixtures/tests_samples/wmt_en_ro/train.json
+-rw-r--r--  2.0 unx    21699 b- defN 24-Mar-25 11:12 tests/fixtures/tests_samples/wmt_en_ro/val.json
+-rw-r--r--  2.0 unx    15601 b- defN 24-Mar-25 11:12 tests/fixtures/tests_samples/xsum/sample.json
+-rw-r--r--  2.0 unx        0 b- defN 23-Mar-22 09:42 tests/st/__init__.py
+-rw-r--r--  2.0 unx     2834 b- defN 23-Jun-01 14:35 tests/st/test_bilstm_imdb.py
+-rw-r--r--  2.0 unx     2110 b- defN 24-Feb-29 06:56 tests/st/test_longformer.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/test_module/__init__.py
+-rw-r--r--  2.0 unx      387 b- defN 24-Feb-29 06:56 tests/test_module/custom_configuration.py
+-rw-r--r--  2.0 unx      777 b- defN 24-Feb-29 06:56 tests/test_module/custom_modeling.py
+-rw-r--r--  2.0 unx     1117 b- defN 24-Feb-29 06:56 tests/test_module/custom_pipeline.py
+-rw-r--r--  2.0 unx        0 b- defN 23-Mar-22 09:42 tests/ut/__init__.py
+-rw-r--r--  2.0 unx        0 b- defN 23-Mar-22 09:42 tests/ut/dataset/__init__.py
+-rw-r--r--  2.0 unx     2423 b- defN 24-Feb-29 06:56 tests/ut/dataset/test_imdb.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/dataset/transforms/__init__.py
+-rw-r--r--  2.0 unx     2555 b- defN 24-Feb-29 06:56 tests/ut/dataset/transforms/test_add_token.py
+-rw-r--r--  2.0 unx     1235 b- defN 24-Feb-29 06:56 tests/ut/dataset/transforms/test_lookup.py
+-rw-r--r--  2.0 unx     2560 b- defN 24-Feb-29 06:56 tests/ut/dataset/transforms/test_pad_transform.py
+-rw-r--r--  2.0 unx        0 b- defN 23-Mar-22 09:42 tests/ut/engine/__init__.py
+-rw-r--r--  2.0 unx     2248 b- defN 24-Mar-20 16:25 tests/ut/engine/test_callback.py
+-rw-r--r--  2.0 unx     2352 b- defN 24-Mar-20 16:25 tests/ut/engine/test_evaluator.py
+-rw-r--r--  2.0 unx     6878 b- defN 24-Mar-20 16:25 tests/ut/engine/test_trainer.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/legacy/__init__.py
+-rw-r--r--  2.0 unx      845 b- defN 24-Feb-29 06:56 tests/ut/legacy/test_einsum.py
+-rw-r--r--  2.0 unx        0 b- defN 23-Mar-22 09:42 tests/ut/metrics/__init__.py
+-rw-r--r--  2.0 unx    32965 b- defN 23-Jul-15 13:56 tests/ut/metrics/test_metrics_class.py
+-rw-r--r--  2.0 unx    19939 b- defN 23-Mar-22 09:42 tests/ut/metrics/test_metrics_fn.py
+-rw-r--r--  2.0 unx        0 b- defN 23-Mar-22 09:42 tests/ut/modules/__init__.py
+-rw-r--r--  2.0 unx    13357 b- defN 24-Feb-29 06:56 tests/ut/modules/test_crf.py
+-rw-r--r--  2.0 unx     5675 b- defN 24-Feb-29 06:56 tests/ut/modules/test_decoder.py
+-rw-r--r--  2.0 unx     4267 b- defN 24-Feb-29 06:56 tests/ut/modules/test_encoder.py
+-rw-r--r--  2.0 unx     1422 b- defN 23-Nov-13 07:20 tests/ut/modules/test_fasttext_embedding.py
+-rw-r--r--  2.0 unx     3216 b- defN 24-Mar-30 02:03 tests/ut/modules/test_flashattention.py
+-rw-r--r--  2.0 unx     1356 b- defN 24-Feb-29 06:56 tests/ut/modules/test_glove_embedding.py
+-rw-r--r--  2.0 unx        0 b- defN 23-Mar-22 09:42 tests/ut/modules/attentions/__init__.py
+-rw-r--r--  2.0 unx     1809 b- defN 24-Feb-29 06:56 tests/ut/modules/attentions/test_additive_attention.py
+-rw-r--r--  2.0 unx     1784 b- defN 24-Feb-29 06:56 tests/ut/modules/attentions/test_binary_attention.py
+-rw-r--r--  2.0 unx     1779 b- defN 24-Feb-29 06:56 tests/ut/modules/attentions/test_cosine_attention.py
+-rw-r--r--  2.0 unx     1831 b- defN 24-Feb-29 06:56 tests/ut/modules/attentions/test_linear_attention.py
+-rw-r--r--  2.0 unx     1540 b- defN 24-Feb-29 06:56 tests/ut/modules/attentions/test_scaled_dot_attention.py
+-rw-r--r--  2.0 unx     2276 b- defN 24-Feb-29 06:56 tests/ut/modules/attentions/test_self_attention.py
+-rw-r--r--  2.0 unx        0 b- defN 23-Jun-01 14:35 tests/ut/modules/generation/__init__.py
+-rw-r--r--  2.0 unx     1784 b- defN 24-Feb-29 06:56 tests/ut/modules/generation/test_generation_config.py
+-rw-r--r--  2.0 unx        0 b- defN 23-Mar-22 09:42 tests/ut/modules/loss/__init__.py
+-rw-r--r--  2.0 unx     2296 b- defN 24-Feb-29 06:56 tests/ut/modules/loss/test_cmrc2018loss.py
+-rw-r--r--  2.0 unx     2385 b- defN 24-Feb-29 06:56 tests/ut/modules/loss/test_rdrop_loss.py
+-rw-r--r--  2.0 unx        0 b- defN 23-Mar-22 09:42 tests/ut/modules/rnns/__init__.py
+-rw-r--r--  2.0 unx     4872 b- defN 24-Feb-29 06:56 tests/ut/modules/rnns/test_gru.py
+-rw-r--r--  2.0 unx     5180 b- defN 24-Feb-29 06:56 tests/ut/modules/rnns/test_lstm.py
+-rw-r--r--  2.0 unx        0 b- defN 23-Mar-22 09:42 tests/ut/modules/transformer/__init__.py
+-rw-r--r--  2.0 unx     3775 b- defN 24-Feb-29 06:56 tests/ut/modules/transformer/test_multi_head_attention.py
+-rw-r--r--  2.0 unx     2187 b- defN 24-Feb-29 06:56 tests/ut/modules/transformer/test_transformer_encoder.py
+-rw-r--r--  2.0 unx     1434 b- defN 24-Feb-29 06:56 tests/ut/modules/transformer/test_transformer_encoder_layer.py
+-rw-r--r--  2.0 unx        0 b- defN 23-Jul-16 07:16 tests/ut/peft/__init__.py
+-rw-r--r--  2.0 unx        0 b- defN 23-Jul-16 07:16 tests/ut/peft/test_config.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Apr-01 15:36 tests/ut/text2vec/__init__.py
+-rw-r--r--  2.0 unx     2756 b- defN 24-Apr-01 15:36 tests/ut/text2vec/test_sbert_embeddings.py
+-rw-r--r--  2.0 unx     2078 b- defN 24-Apr-01 15:36 tests/ut/text2vec/test_w2v_embeddings.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/__init__.py
+-rw-r--r--  2.0 unx    10140 b- defN 24-Mar-25 11:12 tests/ut/transformers/test_backbone_common.py
+-rw-r--r--  2.0 unx     8097 b- defN 24-Feb-29 06:56 tests/ut/transformers/test_configuration_common.py
+-rw-r--r--  2.0 unx     2231 b- defN 24-Mar-31 16:52 tests/ut/transformers/test_feature_extraction_common.py
+-rw-r--r--  2.0 unx    73183 b- defN 24-Mar-31 10:53 tests/ut/transformers/test_modeling_common.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Mar-25 11:12 tests/ut/transformers/test_pipeline_mixin.py
+-rw-r--r--  2.0 unx    16663 b- defN 24-Mar-31 16:52 tests/ut/transformers/test_sequence_feature_extraction_common.py
+-rw-r--r--  2.0 unx   206613 b- defN 24-Feb-29 06:56 tests/ut/transformers/test_tokenization_common.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/generation/__init__.py
+-rw-r--r--  2.0 unx    28522 b- defN 24-Feb-29 06:56 tests/ut/transformers/generation/test_framework_agnostic.py
+-rw-r--r--  2.0 unx   123394 b- defN 24-Mar-14 17:04 tests/ut/transformers/generation/test_utils.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/__init__.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/albert/__init__.py
+-rw-r--r--  2.0 unx    14176 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/albert/test_modeling_albert.py
+-rw-r--r--  2.0 unx     8039 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/albert/test_tokenization_albert.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Mar-20 16:25 tests/ut/transformers/models/align/__init__.py
+-rw-r--r--  2.0 unx    21247 b- defN 24-Mar-27 18:05 tests/ut/transformers/models/align/test_modeling_align.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Mar-20 16:25 tests/ut/transformers/models/altclip/__init__.py
+-rw-r--r--  2.0 unx    20018 b- defN 24-Mar-20 16:25 tests/ut/transformers/models/altclip/test_modeling_altclip.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Mar-20 16:25 tests/ut/transformers/models/audio_spectrogram_transformer/__init__.py
+-rw-r--r--  2.0 unx     9381 b- defN 24-Mar-20 16:25 tests/ut/transformers/models/audio_spectrogram_transformer/test_modeling_audio_spectrogram_transformer.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/auto/__init__.py
+-rw-r--r--  2.0 unx     3723 b- defN 24-Mar-04 15:11 tests/ut/transformers/models/auto/test_configuration_auto.py
+-rw-r--r--  2.0 unx    15231 b- defN 24-Mar-20 16:25 tests/ut/transformers/models/auto/test_modeling_auto.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/autoformer/__init__.py
+-rw-r--r--  2.0 unx    19293 b- defN 24-Mar-04 15:11 tests/ut/transformers/models/autoformer/test_modeling_autoformer.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/baichuan/__init__.py
+-rw-r--r--  2.0 unx     2793 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/baichuan/test_modeling_baichuan.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/bark/__init__.py
+-rw-r--r--  2.0 unx    44187 b- defN 24-Mar-19 16:41 tests/ut/transformers/models/bark/test_modeling_bark.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/bart/__init__.py
+-rw-r--r--  2.0 unx    95343 b- defN 24-Mar-04 15:11 tests/ut/transformers/models/bart/test_modeling_bart.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Mar-25 11:12 tests/ut/transformers/models/beit/__init__.py
+-rw-r--r--  2.0 unx    19837 b- defN 24-Mar-25 11:12 tests/ut/transformers/models/beit/test_modeling_beit.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/bert/__init__.py
+-rw-r--r--  2.0 unx    25734 b- defN 24-Mar-04 15:11 tests/ut/transformers/models/bert/test_modeling_bert.py
+-rw-r--r--  2.0 unx     2048 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/bert/test_modeling_graph_bert.py
+-rw-r--r--  2.0 unx    14288 b- defN 24-Mar-04 15:11 tests/ut/transformers/models/bert/test_tokenization_bert.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Mar-25 13:50 tests/ut/transformers/models/bert_generation/__init__.py
+-rw-r--r--  2.0 unx    12696 b- defN 24-Mar-25 13:50 tests/ut/transformers/models/bert_generation/test_modeling_bert_generation.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Mar-09 17:05 tests/ut/transformers/models/big_bird/__init__.py
+-rw-r--r--  2.0 unx    46579 b- defN 24-Mar-19 16:41 tests/ut/transformers/models/big_bird/test_modeling_big_bird.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Mar-28 03:06 tests/ut/transformers/models/bigbird_pegasus/__init__.py
+-rw-r--r--  2.0 unx   110760 b- defN 24-Mar-28 06:03 tests/ut/transformers/models/bigbird_pegasus/test_modeling_bigbird_pegasus.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Mar-19 16:41 tests/ut/transformers/models/biogpt/__init__.py
+-rw-r--r--  2.0 unx    19717 b- defN 24-Mar-19 16:44 tests/ut/transformers/models/biogpt/test_modeling_biogpt.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Mar-31 12:05 tests/ut/transformers/models/bit/__init__.py
+-rw-r--r--  2.0 unx    11755 b- defN 24-Mar-31 12:35 tests/ut/transformers/models/bit/test_modeling_bit.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Apr-02 03:19 tests/ut/transformers/models/blenderbot/__init__.py
+-rw-r--r--  2.0 unx    22474 b- defN 24-Apr-02 03:19 tests/ut/transformers/models/blenderbot/test_modeling_blenderbot.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Apr-02 08:27 tests/ut/transformers/models/blenderbot_small/__init__.py
+-rw-r--r--  2.0 unx    22787 b- defN 24-Apr-08 06:51 tests/ut/transformers/models/blenderbot_small/test_modeling_blenderbot_small.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Apr-02 15:06 tests/ut/transformers/models/blip/__init__.py
+-rw-r--r--  2.0 unx    42838 b- defN 24-Apr-02 15:06 tests/ut/transformers/models/blip/test_modeling_blip.py
+-rw-r--r--  2.0 unx     6896 b- defN 24-Apr-02 15:06 tests/ut/transformers/models/blip/test_modeling_blip_text.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Apr-08 06:51 tests/ut/transformers/models/blip_2/__init__.py
+-rw-r--r--  2.0 unx    39138 b- defN 24-Apr-08 06:51 tests/ut/transformers/models/blip_2/test_modeling_blip_2.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/bloom/__init__.py
+-rw-r--r--  2.0 unx    35152 b- defN 24-Mar-28 15:57 tests/ut/transformers/models/bloom/test_modeling_bloom.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Apr-08 07:55 tests/ut/transformers/models/bridgetower/__init__.py
+-rw-r--r--  2.0 unx    23014 b- defN 24-Apr-08 08:29 tests/ut/transformers/models/bridgetower/test_modeling_bridgetower.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Apr-08 08:41 tests/ut/transformers/models/bros/__init__.py
+-rw-r--r--  2.0 unx    16094 b- defN 24-Apr-08 09:16 tests/ut/transformers/models/bros/test_modeling_bros.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/chatglm/__init__.py
+-rw-r--r--  2.0 unx    13895 b- defN 24-Mar-04 15:11 tests/ut/transformers/models/chatglm/test_modeling_chatglm.py
+-rw-r--r--  2.0 unx    13970 b- defN 24-Mar-19 16:41 tests/ut/transformers/models/chatglm/test_modeling_graph_chatglm.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/clip/__init__.py
+-rw-r--r--  2.0 unx    25666 b- defN 24-Mar-03 07:54 tests/ut/transformers/models/clip/test_modeling_clip.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/codegen/__init__.py
+-rw-r--r--  2.0 unx    23368 b- defN 24-Mar-03 07:54 tests/ut/transformers/models/codegen/test_modeling_codegen.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Apr-08 06:51 tests/ut/transformers/models/convbert/__init__.py
+-rw-r--r--  2.0 unx    19793 b- defN 24-Apr-08 06:51 tests/ut/transformers/models/convbert/test_modeling_convbert.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/cpmant/__init__.py
+-rw-r--r--  2.0 unx     9906 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/cpmant/test_modeling_cpmant.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/cpmbee/__init__.py
+-rw-r--r--  2.0 unx     8443 b- defN 24-Mar-18 02:46 tests/ut/transformers/models/cpmbee/test_modeling_cpmbee.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Mar-19 16:41 tests/ut/transformers/models/deberta/__init__.py
+-rw-r--r--  2.0 unx    12019 b- defN 24-Mar-19 16:41 tests/ut/transformers/models/deberta/test_modeling_deberta.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/encodec/__init__.py
+-rw-r--r--  2.0 unx    20901 b- defN 24-Mar-27 05:46 tests/ut/transformers/models/encodec/test_modeling_encodec.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/ernie/__init__.py
+-rw-r--r--  2.0 unx    22370 b- defN 24-Mar-04 15:11 tests/ut/transformers/models/ernie/test_modeling_ernie.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/ernie_m/__init__.py
+-rw-r--r--  2.0 unx    12542 b- defN 24-Mar-04 15:11 tests/ut/transformers/models/ernie_m/test_modeling_ernie_m.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Mar-03 07:54 tests/ut/transformers/models/esm/__init__.py
+-rw-r--r--  2.0 unx    13068 b- defN 24-Mar-03 07:54 tests/ut/transformers/models/esm/test_modeling_esm.py
+-rw-r--r--  2.0 unx    10139 b- defN 24-Mar-04 00:35 tests/ut/transformers/models/esm/test_modeling_esmfold.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/falcon/__init__.py
+-rw-r--r--  2.0 unx    22507 b- defN 24-Mar-04 15:11 tests/ut/transformers/models/falcon/test_modeling_falcon.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/gemma/__init__.py
+-rw-r--r--  2.0 unx    22221 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/gemma/test_modeling_gemma.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/gpt/__init__.py
+-rw-r--r--  2.0 unx    11432 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/gpt/test_modeling_gpt.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/gpt2/__init__.py
+-rw-r--r--  2.0 unx    36548 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/gpt2/test_modeling_gpt2.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/gpt_bigcode/__init__.py
+-rw-r--r--  2.0 unx    25963 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/gpt_bigcode/test_modeling_gpt_bigcode.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/gpt_neo/__init__.py
+-rw-r--r--  2.0 unx     4504 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/gpt_neo/test_gpt_neo.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Mar-25 13:55 tests/ut/transformers/models/gpt_neox/__init__.py
+-rw-r--r--  2.0 unx    16620 b- defN 24-Mar-25 13:55 tests/ut/transformers/models/gpt_neox/test_gpt_neox.py
+-rw-r--r--  2.0 unx      691 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/graphormer/__init__.py
+-rw-r--r--  2.0 unx     6947 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/graphormer/test_graphormer_cells.py
+-rw-r--r--  2.0 unx    65804 b- defN 24-Mar-04 15:11 tests/ut/transformers/models/graphormer/test_modeling_graphormer.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/hubert/__init__.py
+-rw-r--r--  2.0 unx    29210 b- defN 24-Mar-04 15:11 tests/ut/transformers/models/hubert/test_modeling_hubert.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Mar-29 07:53 tests/ut/transformers/models/internlm/__init__.py
+-rw-r--r--  2.0 unx     1601 b- defN 24-Mar-29 07:53 tests/ut/transformers/models/internlm/test_modeling_internlm.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Mar-16 11:41 tests/ut/transformers/models/layoutlm/__init__.py
+-rw-r--r--  2.0 unx    17742 b- defN 24-Mar-28 15:43 tests/ut/transformers/models/layoutlm/test_modeling_layoutlm.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Mar-24 20:22 tests/ut/transformers/models/layoutlmv2/__init__.py
+-rw-r--r--  2.0 unx    28358 b- defN 24-Mar-27 18:05 tests/ut/transformers/models/layoutlmv2/test_modeling_layoutlmv2.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/llama/__init__.py
+-rw-r--r--  2.0 unx    27045 b- defN 24-Mar-04 15:11 tests/ut/transformers/models/llama/test_modeling_llama.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/longformer/__init__.py
+-rw-r--r--  2.0 unx    31552 b- defN 24-Mar-04 15:11 tests/ut/transformers/models/longformer/test_modeling_longformer.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/luke/__init__.py
+-rw-r--r--  2.0 unx    11176 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/luke/test_modeling_luke.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Mar-16 11:41 tests/ut/transformers/models/mamba/__init__.py
+-rw-r--r--  2.0 unx     5356 b- defN 24-Mar-16 11:41 tests/ut/transformers/models/mamba/test_modeling_graph_mamba.py
+-rw-r--r--  2.0 unx    19188 b- defN 24-Mar-16 11:41 tests/ut/transformers/models/mamba/test_modeling_mamba.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/mbart/__init__.py
+-rw-r--r--  2.0 unx    29265 b- defN 24-Mar-04 15:11 tests/ut/transformers/models/mbart/test_modeling_mbart.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/megatron_bert/__init__.py
+-rw-r--r--  2.0 unx    16043 b- defN 24-Mar-04 15:11 tests/ut/transformers/models/megatron_bert/test_modeling_megatron_bert.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/mistral/__init__.py
+-rw-r--r--  2.0 unx    17577 b- defN 24-Mar-04 15:11 tests/ut/transformers/models/mistral/test_modeling_mistral.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Mar-12 03:14 tests/ut/transformers/models/mixtral/__init__.py
+-rw-r--r--  2.0 unx    19377 b- defN 24-Mar-19 16:41 tests/ut/transformers/models/mixtral/test_modeling_mixtral.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/mobilebert/__init__.py
+-rw-r--r--  2.0 unx    12087 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/mobilebert/test_mobilebert.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/moss/__init__.py
+-rw-r--r--  2.0 unx     3681 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/moss/test_modeling_moss.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/mt5/__init__.py
+-rw-r--r--  2.0 unx     2095 b- defN 24-Mar-04 15:11 tests/ut/transformers/models/mt5/test_modeling_mt5.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Mar-26 08:18 tests/ut/transformers/models/musicgen/__init__.py
+-rw-r--r--  2.0 unx    45746 b- defN 24-Mar-31 10:53 tests/ut/transformers/models/musicgen/test_modeling_musicgen.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Mar-31 16:52 tests/ut/transformers/models/musicgen_melody/__init__.py
+-rw-r--r--  2.0 unx     9926 b- defN 24-Mar-31 16:52 tests/ut/transformers/models/musicgen_melody/test_feature_extraction_musicgen_melody.py
+-rw-r--r--  2.0 unx    46150 b- defN 24-Mar-31 16:52 tests/ut/transformers/models/musicgen_melody/test_modeling_musicgen_melody.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Mar-31 16:52 tests/ut/transformers/models/musicgen_melody/test_processor_musicgen_melody.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/nezha/__init__.py
+-rw-r--r--  2.0 unx    10126 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/nezha/test_modeling_nezha.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/opt/__init__.py
+-rw-r--r--  2.0 unx    23125 b- defN 24-Apr-08 06:51 tests/ut/transformers/models/opt/test_modeling_opt.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/phi/__init__.py
+-rw-r--r--  2.0 unx    18965 b- defN 24-Mar-04 15:11 tests/ut/transformers/models/phi/test_modeling_phi.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/pop2piano/__init__.py
+-rw-r--r--  2.0 unx    31317 b- defN 24-Mar-04 15:11 tests/ut/transformers/models/pop2piano/test_modeling_pop2piano.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Mar-04 00:35 tests/ut/transformers/models/qwen2/__init__.py
+-rw-r--r--  2.0 unx    19480 b- defN 24-Mar-04 00:35 tests/ut/transformers/models/qwen2/test_modeling_qwen2.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Mar-29 11:29 tests/ut/transformers/models/qwen2_moe/__init__.py
+-rw-r--r--  2.0 unx    22239 b- defN 24-Mar-30 00:11 tests/ut/transformers/models/qwen2_moe/test_modeling_qwen2_moe.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Mar-19 16:41 tests/ut/transformers/models/reformer/__init__.py
+-rw-r--r--  2.0 unx    43606 b- defN 24-Mar-25 11:12 tests/ut/transformers/models/reformer/test_modeling_reformer.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/roberta/__init__.py
+-rw-r--r--  2.0 unx    22751 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/roberta/test_modeling_roberta.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/rwkv/__init__.py
+-rw-r--r--  2.0 unx    17034 b- defN 24-Mar-04 15:11 tests/ut/transformers/models/rwkv/test_modeling_rwkv.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/seamless_m4t/__init__.py
+-rw-r--r--  2.0 unx    45139 b- defN 24-Mar-04 15:11 tests/ut/transformers/models/seamless_m4t/test_modeling_seamless_m4t.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/seamless_m4t_v2/__init__.py
+-rw-r--r--  2.0 unx    48018 b- defN 24-Mar-04 15:11 tests/ut/transformers/models/seamless_m4t_v2/test_modeling_seamless_m4t_v2.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Mar-09 17:05 tests/ut/transformers/models/starcoder2/__init__.py
+-rw-r--r--  2.0 unx    16333 b- defN 24-Mar-09 17:05 tests/ut/transformers/models/starcoder2/test_modeling_starcoder2.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/t5/__init__.py
+-rw-r--r--  2.0 unx    74031 b- defN 24-Mar-04 15:11 tests/ut/transformers/models/t5/test_modeling_t5.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/tinybert/__init__.py
+-rw-r--r--  2.0 unx    15357 b- defN 24-Mar-04 15:11 tests/ut/transformers/models/tinybert/test_tinybert.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/wav2vec2/__init__.py
+-rw-r--r--  2.0 unx    10497 b- defN 24-Mar-04 15:11 tests/ut/transformers/models/wav2vec2/test_feature_extraction_wav2vec2.py
+-rw-r--r--  2.0 unx    72157 b- defN 24-Mar-04 15:11 tests/ut/transformers/models/wav2vec2/test_modeling_wav2vec2.py
+-rw-r--r--  2.0 unx     6366 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/wav2vec2/test_processor_wav2vec2.py
+-rw-r--r--  2.0 unx    40919 b- defN 24-Mar-28 15:57 tests/ut/transformers/models/wav2vec2/test_tokenization_wav2vec2.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/whisper/__init__.py
+-rw-r--r--  2.0 unx    77595 b- defN 24-Mar-19 12:41 tests/ut/transformers/models/whisper/test_modeling_whisper.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/xlm/__init__.py
+-rw-r--r--  2.0 unx    19441 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/xlm/test_modeling_xlm.py
+-rw-r--r--  2.0 unx     3300 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/xlm/test_tokenization_xlm.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/models/xlm_roberta/__init__.py
+-rw-r--r--  2.0 unx     2827 b- defN 24-Mar-04 15:11 tests/ut/transformers/models/xlm_roberta/test_modeling_xlm_roberta.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Apr-08 06:51 tests/ut/transformers/models/xlnet/__init__.py
+-rw-r--r--  2.0 unx    28446 b- defN 24-Apr-08 06:51 tests/ut/transformers/models/xlnet/test_modeling_xlnet.py
+-rw-r--r--  2.0 unx    12729 b- defN 24-Apr-08 06:51 tests/ut/transformers/models/xlnet/test_tokenization_xlnet.py
+-rw-r--r--  2.0 unx        0 b- defN 24-Feb-29 06:56 tests/ut/transformers/pipelines/__init__.py
+-rw-r--r--  2.0 unx    18027 b- defN 24-Feb-29 06:56 tests/ut/transformers/pipelines/test_pipelines_common.py
+-rw-r--r--  2.0 unx    12486 b- defN 24-Mar-31 10:53 tests/ut/transformers/pipelines/test_pipelines_document_question_answering.py
+-rw-r--r--  2.0 unx    25446 b- defN 24-Mar-16 11:41 tests/ut/transformers/pipelines/test_pipelines_question_answering.py
+-rw-r--r--  2.0 unx     3661 b- defN 24-Mar-16 11:41 tests/ut/transformers/pipelines/test_pipelines_text2text_generation.py
+-rw-r--r--  2.0 unx     6805 b- defN 24-Feb-29 06:56 tests/ut/transformers/pipelines/test_pipelines_text_classification.py
+-rw-r--r--  2.0 unx    13706 b- defN 24-Mar-16 11:41 tests/ut/transformers/pipelines/test_pipelines_text_generation.py
+-rw-r--r--  2.0 unx    11105 b- defN 24-Mar-24 20:22 tests/ut/transformers/pipelines/test_pipelines_zero_shot_classification.py
+-rw-r--r--  2.0 unx     1996 b- defN 23-Jul-16 07:16 tests/ut/utils/test_download.py
+-rw-r--r--  2.0 unx        0 b- defN 23-Mar-22 09:42 tests/ut/vocab/__init__.py
+-rw-r--r--  2.0 unx     2076 b- defN 23-Mar-22 09:42 tests/ut/vocab/test_vocab.py
+-rw-r--r--  2.0 unx     1029 b- defN 23-Jun-01 14:35 tests/ut/vocab/test_vocab_fasttext.py
+-rw-r--r--  2.0 unx     1238 b- defN 23-Jun-01 14:35 tests/ut/vocab/test_vocab_glove.py
+-rw-r--r--  2.0 unx    11357 b- defN 24-Apr-09 08:37 mindnlp-0.2.4.dist-info/LICENSE
+-rw-r--r--  2.0 unx      804 b- defN 24-Apr-09 08:37 mindnlp-0.2.4.dist-info/METADATA
+-rw-r--r--  2.0 unx       57 b- defN 24-Apr-09 08:37 mindnlp-0.2.4.dist-info/NOTICE
+-rw-r--r--  2.0 unx       92 b- defN 24-Apr-09 08:37 mindnlp-0.2.4.dist-info/WHEEL
+-r--------  2.0 unx       14 b- defN 24-Apr-09 08:37 mindnlp-0.2.4.dist-info/top_level.txt
+-rw-rw-r--  2.0 unx   107234 b- defN 24-Apr-09 08:37 mindnlp-0.2.4.dist-info/RECORD
+1002 files, 17604563 bytes uncompressed, 5090958 bytes compressed:  71.1%
```

## zipnote {}

```diff
@@ -3,14 +3,20 @@
 
 Filename: mindnlp/configs.py
 Comment: 
 
 Filename: mindnlp/injection.py
 Comment: 
 
+Filename: mindnlp/readme.md
+Comment: 
+
+Filename: mindnlp/_csrc/cuda/flash.cu
+Comment: 
+
 Filename: mindnlp/_csrc/cuda/wkv.cu
 Comment: 
 
 Filename: mindnlp/_legacy/__init__.py
 Comment: 
 
 Filename: mindnlp/_legacy/amp.py
@@ -111,14 +117,89 @@
 
 Filename: mindnlp/_legacy/hypercomplex/hypercomplex/hc_pool.py
 Comment: 
 
 Filename: mindnlp/_legacy/hypercomplex/hypercomplex/uniform_operator.py
 Comment: 
 
+Filename: mindnlp/_legacy/hypercomplex/tensor_decomposition/hypercomplex_td.py
+Comment: 
+
+Filename: mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/algorithm/dual_svd.py
+Comment: 
+
+Filename: mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/algorithm/qr.py
+Comment: 
+
+Filename: mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/algorithm/star_svd.py
+Comment: 
+
+Filename: mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/algorithm/svd.py
+Comment: 
+
+Filename: mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/algorithm/t_svd.py
+Comment: 
+
+Filename: mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/matrix.py
+Comment: 
+
+Filename: mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/scalar.py
+Comment: 
+
+Filename: mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/scalar_visitor.py
+Comment: 
+
+Filename: mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/vector.py
+Comment: 
+
+Filename: mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/complex/_complex_algebra_impl.py
+Comment: 
+
+Filename: mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/complex/complex_algebra_factory.py
+Comment: 
+
+Filename: mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/dual/_dual_algebra_impl.py
+Comment: 
+
+Filename: mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/dual/dual_algebra_factory.py
+Comment: 
+
+Filename: mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/hypercomplex/_hc_math_obj_impl.py
+Comment: 
+
+Filename: mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/hypercomplex/_hc_matrix_impl.py
+Comment: 
+
+Filename: mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/hypercomplex/_hc_scalar_impl.py
+Comment: 
+
+Filename: mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/hypercomplex/_hc_vector_impl.py
+Comment: 
+
+Filename: mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/hypercomplex/hc_algebra_factory.py
+Comment: 
+
+Filename: mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/hypercomplex/hc_matrix.py
+Comment: 
+
+Filename: mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/hypercomplex/hc_scalar.py
+Comment: 
+
+Filename: mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/hypercomplex/hc_vector.py
+Comment: 
+
+Filename: mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/real/real_matrix.py
+Comment: 
+
+Filename: mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/real/real_scalar.py
+Comment: 
+
+Filename: mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/real/real_vector.py
+Comment: 
+
 Filename: mindnlp/_legacy/nn/__init__.py
 Comment: 
 
 Filename: mindnlp/_legacy/nn/dropout.py
 Comment: 
 
 Filename: mindnlp/_legacy/nn/half_op.py
@@ -210,20 +291,41 @@
 
 Filename: mindnlp/dataset/transforms/__init__.py
 Comment: 
 
 Filename: mindnlp/dataset/transforms/basic_tokenizer.py
 Comment: 
 
+Filename: mindnlp/dataset/transforms/jieba_tokenizer.py
+Comment: 
+
 Filename: mindnlp/dataset/transforms/lookup.py
 Comment: 
 
 Filename: mindnlp/dataset/transforms/pad_transform.py
 Comment: 
 
+Filename: mindnlp/diffusers/__init__.py
+Comment: 
+
+Filename: mindnlp/diffusers/loaders/__init__.py
+Comment: 
+
+Filename: mindnlp/diffusers/models/__init__.py
+Comment: 
+
+Filename: mindnlp/diffusers/pipelines/__init__.py
+Comment: 
+
+Filename: mindnlp/diffusers/schedulers/__init__.py
+Comment: 
+
+Filename: mindnlp/diffusers/utils/__init__.py
+Comment: 
+
 Filename: mindnlp/engine/__init__.py
 Comment: 
 
 Filename: mindnlp/engine/evaluator.py
 Comment: 
 
 Filename: mindnlp/engine/export.py
@@ -405,14 +507,17 @@
 
 Filename: mindnlp/modules/functional/graph_func.py
 Comment: 
 
 Filename: mindnlp/modules/functional/neural_network.py
 Comment: 
 
+Filename: mindnlp/modules/functional/normalize.py
+Comment: 
+
 Filename: mindnlp/modules/functional/weight_norm.py
 Comment: 
 
 Filename: mindnlp/parallel/__init__.py
 Comment: 
 
 Filename: mindnlp/parallel/pipeline_parallel/__init__.py
@@ -459,14 +564,23 @@
 
 Filename: mindnlp/peft/utils/peft_types.py
 Comment: 
 
 Filename: mindnlp/peft/utils/save_and_load.py
 Comment: 
 
+Filename: mindnlp/text2vec/__init__.py
+Comment: 
+
+Filename: mindnlp/text2vec/sentence_model.py
+Comment: 
+
+Filename: mindnlp/text2vec/word2vec.py
+Comment: 
+
 Filename: mindnlp/transformers/__init__.py
 Comment: 
 
 Filename: mindnlp/transformers/activations.py
 Comment: 
 
 Filename: mindnlp/transformers/audio_utils.py
@@ -984,14 +1098,26 @@
 
 Filename: mindnlp/transformers/models/codegen/tokenization_codegen_fast.py
 Comment: 
 
 Filename: mindnlp/transformers/models/convbert/__init__.py
 Comment: 
 
+Filename: mindnlp/transformers/models/convbert/convbert.py
+Comment: 
+
+Filename: mindnlp/transformers/models/convbert/convbert_config.py
+Comment: 
+
+Filename: mindnlp/transformers/models/convbert/convbert_tokenizer.py
+Comment: 
+
+Filename: mindnlp/transformers/models/convbert/convbert_tokenizer_fast.py
+Comment: 
+
 Filename: mindnlp/transformers/models/cpm/__init__.py
 Comment: 
 
 Filename: mindnlp/transformers/models/cpm/tokenization_cpm.py
 Comment: 
 
 Filename: mindnlp/transformers/models/cpm/tokenization_cpm_fast.py
@@ -1269,14 +1395,56 @@
 
 Filename: mindnlp/transformers/models/hubert/configuration_hubert.py
 Comment: 
 
 Filename: mindnlp/transformers/models/hubert/modeling_hubert.py
 Comment: 
 
+Filename: mindnlp/transformers/models/internlm/__init__.py
+Comment: 
+
+Filename: mindnlp/transformers/models/internlm/configuration_internlm.py
+Comment: 
+
+Filename: mindnlp/transformers/models/internlm/modeling_internlm.py
+Comment: 
+
+Filename: mindnlp/transformers/models/internlm/tokenization_internlm.py
+Comment: 
+
+Filename: mindnlp/transformers/models/jamba/__init__.py
+Comment: 
+
+Filename: mindnlp/transformers/models/jamba/configuration_jamba.py
+Comment: 
+
+Filename: mindnlp/transformers/models/jamba/modeling_jamba.py
+Comment: 
+
+Filename: mindnlp/transformers/models/jetmoe/__init__.py
+Comment: 
+
+Filename: mindnlp/transformers/models/jetmoe/configuration_jetmoe.py
+Comment: 
+
+Filename: mindnlp/transformers/models/jetmoe/modeling_jetmoe.py
+Comment: 
+
+Filename: mindnlp/transformers/models/jetmoe/utils/__init__.py
+Comment: 
+
+Filename: mindnlp/transformers/models/jetmoe/utils/gate.py
+Comment: 
+
+Filename: mindnlp/transformers/models/jetmoe/utils/moe.py
+Comment: 
+
+Filename: mindnlp/transformers/models/jetmoe/utils/parallel_experts.py
+Comment: 
+
 Filename: mindnlp/transformers/models/layoutlm/__init__.py
 Comment: 
 
 Filename: mindnlp/transformers/models/layoutlm/configuration_layoutlm.py
 Comment: 
 
 Filename: mindnlp/transformers/models/layoutlm/modeling_layoutlm.py
@@ -1500,14 +1668,29 @@
 
 Filename: mindnlp/transformers/models/musicgen/modeling_musicgen.py
 Comment: 
 
 Filename: mindnlp/transformers/models/musicgen/processing_musicgen.py
 Comment: 
 
+Filename: mindnlp/transformers/models/musicgen_melody/__init__.py
+Comment: 
+
+Filename: mindnlp/transformers/models/musicgen_melody/configuration_musicgen_melody.py
+Comment: 
+
+Filename: mindnlp/transformers/models/musicgen_melody/feature_extraction_musicgen_melody.py
+Comment: 
+
+Filename: mindnlp/transformers/models/musicgen_melody/modeling_musicgen_melody.py
+Comment: 
+
+Filename: mindnlp/transformers/models/musicgen_melody/processing_musicgen_melody.py
+Comment: 
+
 Filename: mindnlp/transformers/models/nezha/__init__.py
 Comment: 
 
 Filename: mindnlp/transformers/models/nezha/nezha.py
 Comment: 
 
 Filename: mindnlp/transformers/models/nezha/nezha_config.py
@@ -1572,14 +1755,23 @@
 
 Filename: mindnlp/transformers/models/qwen2/tokenization_qwen2.py
 Comment: 
 
 Filename: mindnlp/transformers/models/qwen2/tokenization_qwen2_fast.py
 Comment: 
 
+Filename: mindnlp/transformers/models/qwen2_moe/__init__.py
+Comment: 
+
+Filename: mindnlp/transformers/models/qwen2_moe/configuration_qwen2_moe.py
+Comment: 
+
+Filename: mindnlp/transformers/models/qwen2_moe/modeling_qwen2_moe.py
+Comment: 
+
 Filename: mindnlp/transformers/models/reformer/__init__.py
 Comment: 
 
 Filename: mindnlp/transformers/models/reformer/configuration_reformer.py
 Comment: 
 
 Filename: mindnlp/transformers/models/reformer/modeling_reformer.py
@@ -1674,14 +1866,17 @@
 
 Filename: mindnlp/transformers/models/t5/tokenization_t5.py
 Comment: 
 
 Filename: mindnlp/transformers/models/t5/tokenization_t5_fast.py
 Comment: 
 
+Filename: mindnlp/transformers/models/table_transformer/__init__.py
+Comment: 
+
 Filename: mindnlp/transformers/models/timesformer/__init__.py
 Comment: 
 
 Filename: mindnlp/transformers/models/tinybert/__init__.py
 Comment: 
 
 Filename: mindnlp/transformers/models/tinybert/tinybert.py
@@ -1773,14 +1968,29 @@
 
 Filename: mindnlp/transformers/models/xlm_roberta/tokenization_xlm_roberta.py
 Comment: 
 
 Filename: mindnlp/transformers/models/xlm_roberta/tokenization_xlm_roberta_fast.py
 Comment: 
 
+Filename: mindnlp/transformers/models/xlnet/__init__.py
+Comment: 
+
+Filename: mindnlp/transformers/models/xlnet/configuration_xlnet.py
+Comment: 
+
+Filename: mindnlp/transformers/models/xlnet/modeling_xlnet.py
+Comment: 
+
+Filename: mindnlp/transformers/models/xlnet/tokenization_xlnet.py
+Comment: 
+
+Filename: mindnlp/transformers/models/xlnet/tokenization_xlnet_fast.py
+Comment: 
+
 Filename: mindnlp/transformers/pipelines/__init__.py
 Comment: 
 
 Filename: mindnlp/transformers/pipelines/audio_utils.py
 Comment: 
 
 Filename: mindnlp/transformers/pipelines/automatic_speech_recognition.py
@@ -1884,20 +2094,149 @@
 
 Filename: mindnlp/workflow/works/qa.py
 Comment: 
 
 Filename: mindnlp/workflow/works/sentiment_analysis.py
 Comment: 
 
+Filename: tests/README.md
+Comment: 
+
 Filename: tests/__init__.py
 Comment: 
 
 Filename: tests/common.py
 Comment: 
 
+Filename: tests/pytest.ini
+Comment: 
+
+Filename: tests/fixtures/add_distilbert_like_config.json
+Comment: 
+
+Filename: tests/fixtures/dummy-config.json
+Comment: 
+
+Filename: tests/fixtures/dummy_feature_extractor_config.json
+Comment: 
+
+Filename: tests/fixtures/empty.txt
+Comment: 
+
+Filename: tests/fixtures/input.txt
+Comment: 
+
+Filename: tests/fixtures/merges.txt
+Comment: 
+
+Filename: tests/fixtures/preprocessor_config.json
+Comment: 
+
+Filename: tests/fixtures/sample_text.txt
+Comment: 
+
+Filename: tests/fixtures/sample_text_no_unicode.txt
+Comment: 
+
+Filename: tests/fixtures/spiece.model
+Comment: 
+
+Filename: tests/fixtures/test_entity_vocab.json
+Comment: 
+
+Filename: tests/fixtures/test_sentencepiece.model
+Comment: 
+
+Filename: tests/fixtures/test_sentencepiece_bpe.model
+Comment: 
+
+Filename: tests/fixtures/test_sentencepiece_bpe_char.model
+Comment: 
+
+Filename: tests/fixtures/test_sentencepiece_no_bos.model
+Comment: 
+
+Filename: tests/fixtures/test_sentencepiece_with_bytefallback.model
+Comment: 
+
+Filename: tests/fixtures/vocab.json
+Comment: 
+
+Filename: tests/fixtures/vocab.txt
+Comment: 
+
+Filename: tests/fixtures/tests_samples/.gitignore
+Comment: 
+
+Filename: tests/fixtures/tests_samples/COCO/000000039769.png
+Comment: 
+
+Filename: tests/fixtures/tests_samples/COCO/coco_annotations.txt
+Comment: 
+
+Filename: tests/fixtures/tests_samples/COCO/coco_panoptic_annotations.txt
+Comment: 
+
+Filename: tests/fixtures/tests_samples/COCO/coco_panoptic/000000039769.png
+Comment: 
+
+Filename: tests/fixtures/tests_samples/GermEval/dev.txt
+Comment: 
+
+Filename: tests/fixtures/tests_samples/GermEval/labels.txt
+Comment: 
+
+Filename: tests/fixtures/tests_samples/GermEval/train.txt
+Comment: 
+
+Filename: tests/fixtures/tests_samples/MRPC/dev.csv
+Comment: 
+
+Filename: tests/fixtures/tests_samples/MRPC/dev.tsv
+Comment: 
+
+Filename: tests/fixtures/tests_samples/MRPC/train.csv
+Comment: 
+
+Filename: tests/fixtures/tests_samples/MRPC/train.tsv
+Comment: 
+
+Filename: tests/fixtures/tests_samples/SQUAD/sample.json
+Comment: 
+
+Filename: tests/fixtures/tests_samples/STS-B/dev.tsv
+Comment: 
+
+Filename: tests/fixtures/tests_samples/STS-B/train.tsv
+Comment: 
+
+Filename: tests/fixtures/tests_samples/conll/sample.json
+Comment: 
+
+Filename: tests/fixtures/tests_samples/swag/sample.json
+Comment: 
+
+Filename: tests/fixtures/tests_samples/wiki_text/wiki_00
+Comment: 
+
+Filename: tests/fixtures/tests_samples/wmt16/sample.json
+Comment: 
+
+Filename: tests/fixtures/tests_samples/wmt_en_ro/test.json
+Comment: 
+
+Filename: tests/fixtures/tests_samples/wmt_en_ro/train.json
+Comment: 
+
+Filename: tests/fixtures/tests_samples/wmt_en_ro/val.json
+Comment: 
+
+Filename: tests/fixtures/tests_samples/xsum/sample.json
+Comment: 
+
 Filename: tests/st/__init__.py
 Comment: 
 
 Filename: tests/st/test_bilstm_imdb.py
 Comment: 
 
 Filename: tests/st/test_longformer.py
@@ -1974,14 +2313,17 @@
 
 Filename: tests/ut/modules/test_encoder.py
 Comment: 
 
 Filename: tests/ut/modules/test_fasttext_embedding.py
 Comment: 
 
+Filename: tests/ut/modules/test_flashattention.py
+Comment: 
+
 Filename: tests/ut/modules/test_glove_embedding.py
 Comment: 
 
 Filename: tests/ut/modules/attentions/__init__.py
 Comment: 
 
 Filename: tests/ut/modules/attentions/test_additive_attention.py
@@ -2040,29 +2382,44 @@
 
 Filename: tests/ut/peft/__init__.py
 Comment: 
 
 Filename: tests/ut/peft/test_config.py
 Comment: 
 
+Filename: tests/ut/text2vec/__init__.py
+Comment: 
+
+Filename: tests/ut/text2vec/test_sbert_embeddings.py
+Comment: 
+
+Filename: tests/ut/text2vec/test_w2v_embeddings.py
+Comment: 
+
 Filename: tests/ut/transformers/__init__.py
 Comment: 
 
 Filename: tests/ut/transformers/test_backbone_common.py
 Comment: 
 
 Filename: tests/ut/transformers/test_configuration_common.py
 Comment: 
 
+Filename: tests/ut/transformers/test_feature_extraction_common.py
+Comment: 
+
 Filename: tests/ut/transformers/test_modeling_common.py
 Comment: 
 
 Filename: tests/ut/transformers/test_pipeline_mixin.py
 Comment: 
 
+Filename: tests/ut/transformers/test_sequence_feature_extraction_common.py
+Comment: 
+
 Filename: tests/ut/transformers/test_tokenization_common.py
 Comment: 
 
 Filename: tests/ut/transformers/generation/__init__.py
 Comment: 
 
 Filename: tests/ut/transformers/generation/test_framework_agnostic.py
@@ -2172,20 +2529,65 @@
 
 Filename: tests/ut/transformers/models/biogpt/__init__.py
 Comment: 
 
 Filename: tests/ut/transformers/models/biogpt/test_modeling_biogpt.py
 Comment: 
 
+Filename: tests/ut/transformers/models/bit/__init__.py
+Comment: 
+
+Filename: tests/ut/transformers/models/bit/test_modeling_bit.py
+Comment: 
+
+Filename: tests/ut/transformers/models/blenderbot/__init__.py
+Comment: 
+
+Filename: tests/ut/transformers/models/blenderbot/test_modeling_blenderbot.py
+Comment: 
+
+Filename: tests/ut/transformers/models/blenderbot_small/__init__.py
+Comment: 
+
+Filename: tests/ut/transformers/models/blenderbot_small/test_modeling_blenderbot_small.py
+Comment: 
+
+Filename: tests/ut/transformers/models/blip/__init__.py
+Comment: 
+
+Filename: tests/ut/transformers/models/blip/test_modeling_blip.py
+Comment: 
+
+Filename: tests/ut/transformers/models/blip/test_modeling_blip_text.py
+Comment: 
+
+Filename: tests/ut/transformers/models/blip_2/__init__.py
+Comment: 
+
+Filename: tests/ut/transformers/models/blip_2/test_modeling_blip_2.py
+Comment: 
+
 Filename: tests/ut/transformers/models/bloom/__init__.py
 Comment: 
 
 Filename: tests/ut/transformers/models/bloom/test_modeling_bloom.py
 Comment: 
 
+Filename: tests/ut/transformers/models/bridgetower/__init__.py
+Comment: 
+
+Filename: tests/ut/transformers/models/bridgetower/test_modeling_bridgetower.py
+Comment: 
+
+Filename: tests/ut/transformers/models/bros/__init__.py
+Comment: 
+
+Filename: tests/ut/transformers/models/bros/test_modeling_bros.py
+Comment: 
+
 Filename: tests/ut/transformers/models/chatglm/__init__.py
 Comment: 
 
 Filename: tests/ut/transformers/models/chatglm/test_modeling_chatglm.py
 Comment: 
 
 Filename: tests/ut/transformers/models/chatglm/test_modeling_graph_chatglm.py
@@ -2199,14 +2601,20 @@
 
 Filename: tests/ut/transformers/models/codegen/__init__.py
 Comment: 
 
 Filename: tests/ut/transformers/models/codegen/test_modeling_codegen.py
 Comment: 
 
+Filename: tests/ut/transformers/models/convbert/__init__.py
+Comment: 
+
+Filename: tests/ut/transformers/models/convbert/test_modeling_convbert.py
+Comment: 
+
 Filename: tests/ut/transformers/models/cpmant/__init__.py
 Comment: 
 
 Filename: tests/ut/transformers/models/cpmant/test_modeling_cpmant.py
 Comment: 
 
 Filename: tests/ut/transformers/models/cpmbee/__init__.py
@@ -2301,14 +2709,20 @@
 
 Filename: tests/ut/transformers/models/hubert/__init__.py
 Comment: 
 
 Filename: tests/ut/transformers/models/hubert/test_modeling_hubert.py
 Comment: 
 
+Filename: tests/ut/transformers/models/internlm/__init__.py
+Comment: 
+
+Filename: tests/ut/transformers/models/internlm/test_modeling_internlm.py
+Comment: 
+
 Filename: tests/ut/transformers/models/layoutlm/__init__.py
 Comment: 
 
 Filename: tests/ut/transformers/models/layoutlm/test_modeling_layoutlm.py
 Comment: 
 
 Filename: tests/ut/transformers/models/layoutlmv2/__init__.py
@@ -2388,14 +2802,26 @@
 
 Filename: tests/ut/transformers/models/musicgen/__init__.py
 Comment: 
 
 Filename: tests/ut/transformers/models/musicgen/test_modeling_musicgen.py
 Comment: 
 
+Filename: tests/ut/transformers/models/musicgen_melody/__init__.py
+Comment: 
+
+Filename: tests/ut/transformers/models/musicgen_melody/test_feature_extraction_musicgen_melody.py
+Comment: 
+
+Filename: tests/ut/transformers/models/musicgen_melody/test_modeling_musicgen_melody.py
+Comment: 
+
+Filename: tests/ut/transformers/models/musicgen_melody/test_processor_musicgen_melody.py
+Comment: 
+
 Filename: tests/ut/transformers/models/nezha/__init__.py
 Comment: 
 
 Filename: tests/ut/transformers/models/nezha/test_modeling_nezha.py
 Comment: 
 
 Filename: tests/ut/transformers/models/opt/__init__.py
@@ -2418,14 +2844,20 @@
 
 Filename: tests/ut/transformers/models/qwen2/__init__.py
 Comment: 
 
 Filename: tests/ut/transformers/models/qwen2/test_modeling_qwen2.py
 Comment: 
 
+Filename: tests/ut/transformers/models/qwen2_moe/__init__.py
+Comment: 
+
+Filename: tests/ut/transformers/models/qwen2_moe/test_modeling_qwen2_moe.py
+Comment: 
+
 Filename: tests/ut/transformers/models/reformer/__init__.py
 Comment: 
 
 Filename: tests/ut/transformers/models/reformer/test_modeling_reformer.py
 Comment: 
 
 Filename: tests/ut/transformers/models/roberta/__init__.py
@@ -2502,14 +2934,23 @@
 
 Filename: tests/ut/transformers/models/xlm_roberta/__init__.py
 Comment: 
 
 Filename: tests/ut/transformers/models/xlm_roberta/test_modeling_xlm_roberta.py
 Comment: 
 
+Filename: tests/ut/transformers/models/xlnet/__init__.py
+Comment: 
+
+Filename: tests/ut/transformers/models/xlnet/test_modeling_xlnet.py
+Comment: 
+
+Filename: tests/ut/transformers/models/xlnet/test_tokenization_xlnet.py
+Comment: 
+
 Filename: tests/ut/transformers/pipelines/__init__.py
 Comment: 
 
 Filename: tests/ut/transformers/pipelines/test_pipelines_common.py
 Comment: 
 
 Filename: tests/ut/transformers/pipelines/test_pipelines_document_question_answering.py
@@ -2526,38 +2967,41 @@
 
 Filename: tests/ut/transformers/pipelines/test_pipelines_text_generation.py
 Comment: 
 
 Filename: tests/ut/transformers/pipelines/test_pipelines_zero_shot_classification.py
 Comment: 
 
+Filename: tests/ut/utils/test_download.py
+Comment: 
+
 Filename: tests/ut/vocab/__init__.py
 Comment: 
 
 Filename: tests/ut/vocab/test_vocab.py
 Comment: 
 
 Filename: tests/ut/vocab/test_vocab_fasttext.py
 Comment: 
 
 Filename: tests/ut/vocab/test_vocab_glove.py
 Comment: 
 
-Filename: mindnlp-0.2.3.dist-info/LICENSE
+Filename: mindnlp-0.2.4.dist-info/LICENSE
 Comment: 
 
-Filename: mindnlp-0.2.3.dist-info/METADATA
+Filename: mindnlp-0.2.4.dist-info/METADATA
 Comment: 
 
-Filename: mindnlp-0.2.3.dist-info/NOTICE
+Filename: mindnlp-0.2.4.dist-info/NOTICE
 Comment: 
 
-Filename: mindnlp-0.2.3.dist-info/WHEEL
+Filename: mindnlp-0.2.4.dist-info/WHEEL
 Comment: 
 
-Filename: mindnlp-0.2.3.dist-info/top_level.txt
+Filename: mindnlp-0.2.4.dist-info/top_level.txt
 Comment: 
 
-Filename: mindnlp-0.2.3.dist-info/RECORD
+Filename: mindnlp-0.2.4.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## mindnlp/injection.py

```diff
@@ -15,15 +15,17 @@
 """
 Injection mindspore.nn for MindNLP
 """
 import operator
 from typing import OrderedDict
 from functools import reduce, partial
 import math
+from uuid import uuid4
 from packaging import version
+
 import numpy as np
 import mindspore
 import mindspore.common.dtype as mstype
 from mindspore import nn, ops, Tensor, Parameter
 from mindspore.common._stub_tensor import StubTensor
 from mindspore.nn.layer.conv import _Conv, _deconv_output_length
 from mindspore.common.initializer import initializer, Normal, HeUniform, Uniform, _calculate_fan_in_and_fan_out
@@ -184,23 +186,27 @@
 ops.conv1d = fp16_patch_decorator(ops.conv1d)
 
 def _ones(*size, dtype=None):
     if dtype is None:
         dtype = mindspore.float32
     if isinstance(size[0], tuple):
         size = size[0]
+    elif isinstance(size[0], list):
+        size = tuple(size[0])
     return ops.fill(dtype, size, 1)
 
 ops.ones = _ones
 
 def _zeros(*size, dtype=None):
     if dtype is None:
         dtype = mindspore.float32
     if isinstance(size[0], tuple):
         size = size[0]
+    elif isinstance(size[0], list):
+        size = tuple(size[0])
     return ops.fill(dtype, size, 0)
 
 ops.zeros = _zeros
 
 # cross_entropy
 def _cross_entropy(input, target, weight=None, ignore_index=-100, reduction='mean', label_smoothing=0.0):
     if weight is None:
@@ -396,14 +402,27 @@
     if self.dtype == mstype.bool_ or (isinstance(other, Tensor) and other.dtype == mstype.bool_):
         self = self.to(mstype.int32)
         other = other.to(mstype.int32)
     return ops.eq(self, other)
 
 Parameter.__eq__ = _eq
 
+
+def _initialize(self, init_method):
+    self.set_data(initializer(init_method, self.shape, self.dtype))
+
+Parameter.initialize = _initialize
+
+old_param_init = Parameter.__init__
+def _param_new_init(self, default_input, name=None, requires_grad=True, layerwise_parallel=False, parallel_optimizer=True):
+    old_param_init(self, default_input, name, requires_grad, layerwise_parallel, parallel_optimizer)
+    self.uuid = uuid4().hex
+
+Parameter.__init__ = _param_new_init
+
 old_repeat = Tensor.repeat
 def new_repeat_interleave(input, repeats, axis=None):
     """new repeat_interleave"""
     if axis is None:
         input = input.reshape(-1)
         axis = 0
     if isinstance(repeats, Tensor):
```

## mindnlp/dataset/transforms/__init__.py

```diff
@@ -23,11 +23,12 @@
     from mindnlp._legacy.transforms import Truncate, AddToken
 else:
     from mindspore.dataset.text import Truncate, AddToken
 
 from .lookup import Lookup
 from .basic_tokenizer import BasicTokenizer
 from .pad_transform import PadTransform
+from .jieba_tokenizer import JiebaTokenizer
 
 __all__ = [
-    'Truncate', 'AddToken', 'Lookup', 'PadTransform', 'BasicTokenizer',
+    'Truncate', 'AddToken', 'Lookup', 'PadTransform', 'BasicTokenizer', 'JiebaTokenizer'
 ]
```

## mindnlp/modules/weight_norm.py

```diff
@@ -10,28 +10,29 @@
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
 # ============================================================================
 r"""Weight Normalization from https://arxiv.org/abs/1602.07868."""
 from typing import Any, TypeVar
-from mindspore import Parameter, nn
+from mindspore import Parameter, nn, ops
 from mindspore import numpy as mnp
 
 __all__ = ['WeightNorm', 'weight_norm', 'remove_weight_norm']
 
 def norm_except_dim(weight_v, pows, dim):
     r"""
     calculte g/||weight_v|| * weight_v method 
     """
     if dim == -1:
         return mnp.norm(weight_v, pows)
     if dim == 0:
-        output_size = (weight_v.shape[0],) + (1,) * (weight_v.ndim - 1)
-        return mnp.norm(weight_v.view((weight_v.shape[0], -1)), pows, 1).view(output_size)
+        w_shape_v = ops.shape(weight_v)[0] # avoid macOS error
+        output_size = (w_shape_v,) + (1,) * (weight_v.ndim - 1)
+        return mnp.norm(weight_v.view((w_shape_v, -1)), pows, 1).view(output_size)
     if dim == (weight_v.ndim - 1):
         output_size = (1,) * (weight_v.ndim - 1) + (weight_v.shape[weight_v.ndim - 1])
         return mnp.norm(weight_v.view((-1, weight_v.shape[weight_v.ndim - 1])), pows, 0).view(output_size)
     return norm_except_dim(weight_v.swapaxes(0, dim), pows, dim).swapaxes(0, dim)
 
 def _weight_norm(weight_v, weight_g, dim):
     r"""
```

## mindnlp/modules/functional/__init__.py

```diff
@@ -12,7 +12,8 @@
 # See the License for the specific language governing permissions and
 # limitations under the License.
 # ============================================================================
 """functional modules init"""
 
 from .neural_network import embedding
 from .graph_func import *
+from .normalize import *
```

## mindnlp/transformers/activations.py

```diff
@@ -9,18 +9,112 @@
 # Unless required by applicable law or agreed to in writing, software
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
 # ============================================================================
 """MindNLP Activations"""
-
+import math
 from functools import partial
 from collections import OrderedDict
-from mindspore import nn, ops
+from mindspore import nn, ops, Tensor
+
+
+class QuickGELUActivation(nn.Cell):
+    """
+    Applies GELU approximation that is fast but somewhat inaccurate. See: https://github.com/hendrycks/GELUs
+    """
+
+    def construct(self, input: Tensor) -> Tensor:
+        return input * ops.sigmoid(1.702 * input)
+
+
+class ClippedGELUActivation(nn.Cell):
+    """
+    Clip the range of possible GeLU outputs between [min, max]. This is especially useful for quantization purpose, as
+    it allows mapping negatives values in the GeLU spectrum. For more information on this trick, please refer to
+    https://arxiv.org/abs/2004.09602.
+
+    Gaussian Error Linear Unit. Original Implementation of the gelu activation function in Google Bert repo when
+    initially created.
+
+    For information: OpenAI GPT's gelu is slightly different (and gives slightly different results): 0.5 * x * (1 +
+    torch.tanh(math.sqrt(2 / math.pi) * (x + 0.044715 * torch.pow(x, 3)))). See https://arxiv.org/abs/1606.08415
+    """
+
+    def __init__(self, min: float, max: float):
+        if min > max:
+            raise ValueError(f"min should be < max (got min: {min}, max: {max})")
+
+        super().__init__()
+        self.min = min
+        self.max = max
+
+    def construct(self, x: Tensor) -> Tensor:
+        return ops.clip(gelu(x), self.min, self.max)
+
+
+class AccurateGELUActivation(nn.Cell):
+    """
+    Applies GELU approximation that is faster than default and more accurate than QuickGELU. See:
+    https://github.com/hendrycks/GELUs
+
+    Implemented along with MEGA (Moving Average Equipped Gated Attention)
+    """
+
+    def __init__(self):
+        super().__init__()
+        self.precomputed_constant = math.sqrt(2 / math.pi)
+
+    def construct(self, input: Tensor) -> Tensor:
+        return 0.5 * input * (1 + ops.tanh(self.precomputed_constant * (input + 0.044715 * ops.pow(input, 3))))
+
+
+class MishActivation(nn.Cell):
+    """
+    See Mish: A Self-Regularized Non-Monotonic Activation Function (Misra., https://arxiv.org/abs/1908.08681). Also
+    visit the official repository for the paper: https://github.com/digantamisra98/Mish
+    """
+
+    def construct(self, input: Tensor) -> Tensor:
+        return input * ops.tanh(ops.softplus(input))
+
+
+class LinearActivation(nn.Cell):
+    """
+    Applies the linear activation function, i.e. forwarding input directly to output.
+    """
+
+    def construct(self, input: Tensor) -> Tensor:
+        return input
+
+
+class LaplaceActivation(nn.Cell):
+    """
+    Applies elementwise activation based on Laplace function, introduced in MEGA as an attention activation. See
+    https://arxiv.org/abs/2209.10655
+
+    Inspired by squared relu, but with bounded range and gradient for better stability
+    """
+
+    def construct(self, input, mu=0.707107, sigma=0.282095):
+        input = (input - mu).div(sigma * math.sqrt(2.0))
+        return 0.5 * (1.0 + ops.erf(input))
+
+
+class ReLUSquaredActivation(nn.Cell):
+    """
+    Applies the relu^2 activation introduced in https://arxiv.org/abs/2109.08668v2
+    """
+
+    def construct(self, input):
+        relu_applied = ops.relu(input)
+        squared = ops.square(relu_applied)
+        return squared
+
 
 
 class ClassInstantier(OrderedDict):
     r"""
     Class Instantier
     """
```

## mindnlp/transformers/audio_utils.py

```diff
@@ -15,15 +15,15 @@
 # ============================================================================
 # pylint: disable=redefined-outer-name
 """
 Audio processing functions to extract features from audio waveforms. This code is pure numpy to support all frameworks
 and remove unnecessary dependencies.
 """
 import warnings
-from typing import Optional, Union
+from typing import Optional, Union, Tuple
 
 import numpy as np
 
 
 def hertz_to_mel(freq: Union[float, np.ndarray], mel_scale: str = "htk") -> Union[float, np.ndarray]:
     """
     Convert frequency from hertz to mels.
@@ -114,14 +114,112 @@
     filter_diff = np.diff(filter_freqs)
     slopes = np.expand_dims(filter_freqs, 0) - np.expand_dims(fft_freqs, 1)
     down_slopes = -slopes[:, :-2] / filter_diff[:-1]
     up_slopes = slopes[:, 2:] / filter_diff[1:]
     return np.maximum(np.zeros(1), np.minimum(down_slopes, up_slopes))
 
 
+
+def hertz_to_octave(
+    freq: Union[float, np.ndarray], tuning: Optional[float] = 0.0, bins_per_octave: Optional[int] = 12
+):
+    """
+    Convert frequency from hertz to fractional octave numbers.
+    Adapted from *librosa*.
+
+    Args:
+        freq (`float` or `np.ndarray`):
+            The frequency, or multiple frequencies, in hertz (Hz).
+        tuning (`float`, defaults to `0.`):
+            Tuning deviation from the Stuttgart pitch (A440) in (fractional) bins per octave.
+        bins_per_octave (`int`, defaults to `12`):
+            Number of bins per octave.
+
+    Returns:
+        `float` or `np.ndarray`: The frequencies on the octave scale.
+    """
+    stuttgart_pitch = 440.0 * 2.0 ** (tuning / bins_per_octave)
+    octave = np.log2(freq / (float(stuttgart_pitch) / 16))
+    return octave
+
+
+def chroma_filter_bank(
+    num_frequency_bins: int,
+    num_chroma: int,
+    sampling_rate: int,
+    tuning: float = 0.0,
+    power: Optional[float] = 2.0,
+    weighting_parameters: Optional[Tuple[float]] = (5.0, 2),
+    start_at_c_chroma: Optional[bool] = True,
+):
+    """
+    Creates a chroma filter bank, i.e a linear transformation to project spectrogram bins onto chroma bins.
+
+    Adapted from *librosa*.
+
+    Args:
+        num_frequency_bins (`int`):
+            Number of frequencies used to compute the spectrogram (should be the same as in `stft`).
+        num_chroma (`int`):
+            Number of chroma bins (i.e pitch classes).
+        sampling_rate (`float`):
+            Sample rate of the audio waveform.
+        tuning (`float`):
+            Tuning deviation from A440 in fractions of a chroma bin.
+        power (`float`, *optional*, defaults to 2.0):
+            If 12.0, normalizes each column with their L2 norm. If 1.0, normalizes each column with their L1 norm.
+        weighting_parameters (`Tuple[float]`, *optional*, defaults to `(5., 2.)`):
+            If specified, apply a Gaussian weighting parameterized by the first element of the tuple being the center and
+            the second element being the Gaussian half-width.
+        start_at_c_chroma (`float`, *optional*, defaults to `True`):
+            If True, the filter bank will start at the 'C' pitch class. Otherwise, it will start at 'A'.
+    Returns:
+        `np.ndarray` of shape `(num_frequency_bins, num_chroma)`
+    """
+    # Get the FFT bins, not counting the DC component
+    frequencies = np.linspace(0, sampling_rate, num_frequency_bins, endpoint=False)[1:]
+
+    freq_bins = num_chroma * hertz_to_octave(frequencies, tuning=tuning, bins_per_octave=num_chroma)
+
+    # make up a value for the 0 Hz bin = 1.5 octaves below bin 1
+    # (so chroma is 50% rotated from bin 1, and bin width is broad)
+    freq_bins = np.concatenate(([freq_bins[0] - 1.5 * num_chroma], freq_bins))
+
+    bins_width = np.concatenate((np.maximum(freq_bins[1:] - freq_bins[:-1], 1.0), [1]))
+
+    chroma_filters = np.subtract.outer(freq_bins, np.arange(0, num_chroma, dtype="d")).T
+
+    num_chroma2 = np.round(float(num_chroma) / 2)
+
+    # Project into range -num_chroma/2 .. num_chroma/2
+    # add on fixed offset of 10*num_chroma to ensure all values passed to
+    # rem are positive
+    chroma_filters = np.remainder(chroma_filters + num_chroma2 + 10 * num_chroma, num_chroma) - num_chroma2
+
+    # Gaussian bumps - 2*D to make them narrower
+    chroma_filters = np.exp(-0.5 * (2 * chroma_filters / np.tile(bins_width, (num_chroma, 1))) ** 2)
+
+    # normalize each column
+    if power is not None:
+        chroma_filters = chroma_filters / np.sum(chroma_filters**power, axis=0, keepdims=True) ** (1.0 / power)
+
+    # Maybe apply scaling for fft bins
+    if weighting_parameters is not None:
+        center, half_width = weighting_parameters
+        chroma_filters *= np.tile(
+            np.exp(-0.5 * (((freq_bins / num_chroma - center) / half_width) ** 2)),
+            (num_chroma, 1),
+        )
+
+    if start_at_c_chroma:
+        chroma_filters = np.roll(chroma_filters, -3 * (num_chroma // 12), axis=0)
+
+    # remove aliasing columns, copy to ensure row-contiguity
+    return np.ascontiguousarray(chroma_filters[:, : int(1 + num_frequency_bins / 2)])
+
 def mel_filter_bank(
     num_frequency_bins: int,
     num_mel_filters: int,
     min_frequency: float,
     max_frequency: float,
     sampling_rate: int,
     norm: Optional[str] = None,
```

## mindnlp/transformers/configuration_utils.py

```diff
@@ -637,14 +637,30 @@
 
     @num_labels.setter
     def num_labels(self, num_labels: int):
         if not hasattr(self, "id2label") or self.id2label is None or len(self.id2label) != num_labels:
             self.id2label = {i: f"LABEL_{i}" for i in range(num_labels)}
             self.label2id = dict(zip(self.id2label.values(), self.id2label.keys()))
 
+    @property
+    def _attn_implementation(self):
+        # This property is made private for now (as it cannot be changed and a PreTrainedModel.use_attn_implementation method needs to be implemented.)
+        if hasattr(self, "_attn_implementation_internal"):
+            if self._attn_implementation_internal is None:
+                # `config.attn_implementation` should never be None, for backward compatibility.
+                return "eager"
+            else:
+                return self._attn_implementation_internal
+        else:
+            return "eager"
+
+    @_attn_implementation.setter
+    def _attn_implementation(self, value):
+        self._attn_implementation_internal = value
+
 
 class EncoderDecoderConfig(PretrainedConfig):
     r"""
     [`EncoderDecoderConfig`] is the configuration class to store the configuration of a [`EncoderDecoderModel`]. It is
     used to instantiate an Encoder Decoder model according to the specified arguments, defining the encoder and decoder
     configs.
```

## mindnlp/transformers/feature_extraction_utils.py

```diff
@@ -119,21 +119,22 @@
             def as_tensor(value):
                 if isinstance(value, (list, tuple)) and len(value) > 0 and isinstance(value[0], np.ndarray):
                     value = np.array(value)
                 return mindspore.tensor(value)
 
             is_tensor = ops.is_tensor
         else:
-
             def as_tensor(value, dtype=None):
                 if isinstance(value, (list, tuple)) and isinstance(value[0], (list, tuple, np.ndarray)):
                     value_lens = [len(val) for val in value]
                     if len(set(value_lens)) > 1 and dtype is None:
                         # we have a ragged list so handle explicitly
                         value = as_tensor([np.asarray(val) for val in value], dtype=object)
+                elif isinstance(value, mindspore.Tensor):
+                    return value.asnumpy()
                 return np.asarray(value, dtype=dtype)
 
             is_tensor = is_numpy_array
         return is_tensor, as_tensor
 
     def convert_to_tensors(self, tensor_type: Optional[Union[str, TensorType]] = None):
         """
@@ -150,24 +151,22 @@
         is_tensor, as_tensor = self._get_is_as_tensor_fns(tensor_type)
 
         # Do the tensor conversion in batch
         for key, value in self.items():
             try:
                 if not is_tensor(value):
                     tensor = as_tensor(value)
-
                     self[key] = tensor
             except Exception as exc:  # noqa E722
                 if key == "overflowing_values":
                     raise ValueError("Unable to create tensor returning overflowing values of different lengths. ") from exc
                 raise ValueError(
                     "Unable to create tensor, you should probably activate padding "
                     "with 'padding=True' to have batched tensors with the same length."
                 ) from exc
-
         return self
 
     def to(self, *args, **kwargs) -> "BatchFeature":
         """
         Send all values to device by calling `v.to(*args, **kwargs)` (PyTorch only). This should support casting in
         different `dtypes` and sending the `BatchFeature` to a different `device`.
 
@@ -183,15 +182,15 @@
         requires_backends(self, ["mindspore"])
 
         new_data = {}
         # Check if the args are a device or a dtype
         if len(args) > 0:
             # device should be always the first argument
             arg = args[0]
-            if isinstance(arg, mindspore.common.dtype.TensorType):
+            if isinstance(arg, mindspore._c_expression.typing.Type):
                 # The first argument is a dtype
                 pass
             else:
                 # it's something else
                 raise ValueError(f"Attempting to cast a BatchFeature to type {str(arg)}. This is not supported.")
         # We cast only floating point tensors to avoid issues with tokenizers casting `LongTensor` to `FloatTensor`
         for k, v in self.items():
```

## mindnlp/transformers/kernel_utils.py

```diff
@@ -13,50 +13,51 @@
 # limitations under the License.
 # ============================================================================
 """utils for kernel compile"""
 
 import os
 import subprocess
 from pathlib import Path
+import mindspore
 from mindnlp.utils import logging
 
 logger = logging.get_logger(__name__)
 
 
 def _find_cuda_home():
     cuda_home = os.environ.get('CUDA_HOME') or os.environ.get('CUDA_PATH')
     if cuda_home is None:
         try:
             nvcc = subprocess.check_output(['which', 'nvcc']).decode().rstrip('\r\n')
             cuda_home = os.path.dirname(os.path.dirname(nvcc))
         except subprocess.CalledProcessError as exc:
-            raise RuntimeError('NVCC Not Available') from exc
+            logger.warning("CUDA Not Available")
     return cuda_home
 
 
 def _get_nvcc_info(cuda_home):
     nvcc = None
     if cuda_home is not None and os.path.isdir(cuda_home):
         try:
             nvcc = os.path.join(cuda_home, 'bin/nvcc')
             subprocess.check_output(f"{nvcc} -V", shell=True)
         except subprocess.SubprocessError as exc:
-            raise RuntimeError("NVCC Not Available") from exc
+            logger.warning("NVCC Not Available")
     return nvcc
 
 ENV_INFO = {}
-CUDA_HOME = _find_cuda_home()
+CUDA_HOME = _find_cuda_home() if mindspore.get_context('device_target') =='GPU' else None
 ENV_INFO['cuda_home'] = CUDA_HOME
 ENV_INFO['NVCC'] = _get_nvcc_info(CUDA_HOME)
 
-def compile_kernel(**kwargs):
+def compile_kernel(kernel_name, **kwargs):
     """compile kernel and return so file path"""
     kernel_folder = Path(__file__).resolve().parent.parent / "_csrc" / "cuda"
-    cuda_kernel_file = kernel_folder / "wkv.cu"
-    cuda_so_file = kernel_folder / 'wkv.so'
+    cuda_kernel_file = kernel_folder / f'{kernel_name}.cu'
+    cuda_so_file = kernel_folder / f'{kernel_name}.so'
     if cuda_so_file.exists():
         return cuda_so_file
 
     flags = [
         "--shared",
         "-Xcompiler",
         "-fPIC",
```

## mindnlp/transformers/modeling_utils.py

```diff
@@ -251,21 +251,21 @@
             for _ in range(num_hidden_layers):
                 head_mask += (None,)
 
         return head_mask
 
     def _convert_head_mask_to_5d(self, head_mask, num_hidden_layers):
         """-> [num_hidden_layers x batch x num_heads x seq_length x seq_length]"""
-        if head_mask.dim() == 1:
+        if head_mask.ndim == 1:
             head_mask = head_mask.expand_dims(0).expand_dims(0).expand_dims(-1).expand_dims(-1)
             head_mask = head_mask.broadcast_to(num_hidden_layers, -1, -1, -1, -1)
-        elif head_mask.dim() == 2:
+        elif head_mask.ndim == 2:
             head_mask = head_mask.expand_dims(1).expand_dims(-1)\
                 .expand_dims(-1)  # We can specify head_mask for each layer
-        assert head_mask.dim() == 5, f"head_mask.dim != 5, instead {head_mask.dim()}"
+        assert head_mask.ndim == 5, f"head_mask.dim != 5, instead {head_mask.ndim}"
         head_mask = head_mask.astype(dtype=self.dtype)  # switch to float if need + fp16 compatibility
         return head_mask
 
 
 class PreTrainedModel(nn.Cell, CellUtilMixin, GenerationMixin):
     """
     Abstract class for Pretrained models
@@ -1044,39 +1044,38 @@
         ptrs = collections.defaultdict(list)
         for name, tensor in model.parameters_dict().items():
             id_tensor = id(tensor)
             ptrs[id_tensor].append(name)
 
         # These are all the pointers of shared tensors.
         tied_params = [names for _, names in ptrs.items() if len(names) > 1]
-
         def load_ckpt(resolved_archive_file):
             if 'ckpt' not in resolved_archive_file:
-                if use_safetensors:
+                if use_safetensors or 'safetensors' in resolved_archive_file:
                     from safetensors.numpy import load_file
                     origin_state_dict = load_file(resolved_archive_file)
                     if use_fp16:
                         logger.warning_once("MindSpore do not support bfloat16 dtype, we will automaticlly convert to float16")
-                    state_dict = {k: Parameter(v.astype(np.float32).astype(usage_dtype)) for k, v in origin_state_dict.items()}
+                    new_state_dict = {k: Parameter(Tensor.from_numpy(v.astype(usage_dtype))) for k, v in origin_state_dict.items()}
                 else:
-                    state_dict = load(resolved_archive_file)
+                    new_state_dict = load(resolved_archive_file)
             else:
                 try:
                     state_dict = load_checkpoint(str(resolved_archive_file))
                 except Exception as exc:
                     raise OSError(
                         f"Unable to load weights from mindspore checkpoint file '{resolved_archive_file}'. "
                     ) from exc
 
-            new_state_dict = {}
-            for key, value in state_dict.items():
-                key = key.replace('gamma', 'weight').replace('beta', 'bias').replace('embedding_table', 'weight')
-                value.name = value.name.replace('gamma', 'weight').replace('beta', 'bias')\
-                    .replace('embedding_table', 'weight')
-                new_state_dict[key] = value
+                new_state_dict = {}
+                for key, value in state_dict.items():
+                    key = key.replace('gamma', 'weight').replace('beta', 'bias').replace('embedding_table', 'weight')
+                    value.name = value.name.replace('gamma', 'weight').replace('beta', 'bias')\
+                        .replace('embedding_table', 'weight')
+                    new_state_dict[key] = value
             return new_state_dict
 
         keys_missing = list(model.parameters_dict().keys())
         param_id_set = set()
 
         use_keep_in_fp32_modules = False
         if model._keep_in_fp32_modules:
@@ -1110,15 +1109,15 @@
                 if add_prefix_to_model:
                     param_name = prefix + '.' + pname_in_net
                 elif remove_prefix_from_model:
                     param_name = pname_in_net.replace(f'{prefix}.', '')
                 else:
                     param_name = pname_in_net
 
-                if id(param) in param_id_set:
+                if param.uuid in param_id_set:
                     # for tied params
                     if param_name in keys_unexpected:
                         keys_unexpected.remove(param_name)
                     continue
 
                 new_param = param_dict.pop(param_name, None)
 
@@ -1157,15 +1156,15 @@
                             replace_references(param, new_param)
                         else:
                             replace_references(param, Parameter(new_param, requires_grad=param.requires_grad, name=param.name))
                     else:
                         param.set_data(new_param)
                     keys_unexpected.remove(param_name)
                     keys_missing.remove(pname_in_net)
-                    param_id_set.add(id(param))
+                    param_id_set.add(param.uuid)
                 else:
                     # fix missing value parameter dtype cast.
                     if ms_dtype and ms_dtype != param.dtype:
                         new_param = param.astype(ms_dtype)
                         replace_references(param, Parameter(new_param, name=param.name, requires_grad=param.requires_grad))
 
             # NOTE: monkey patching weight_norm
@@ -1241,15 +1240,15 @@
                     proxies=proxies,
                     local_files_only=local_files_only,
                     subfolder=subfolder,
                     revision=revision,
                     **kwargs,
                 )
             except OSError:
-                logger.warning(
+                logger.info(
                     "Generation config file not found, using a generation config created from the model config."
                 )
 
         if output_loading_info:
             loading_info = {
                 "missing_keys": keys_missing,
                 "unexpected_keys": all_keys_unexpected,
@@ -1354,15 +1353,15 @@
 
 
     def num_parameters(self, only_trainable=False):
         """return parameters count"""
         total = 0
         param_set = set()
         for param in self.get_parameters():
-            param_id = id(param)
+            param_id = param.uuid
             if param_id not in param_set and (only_trainable or param.requires_grad):
                 total += param.size
             param_set.add(param_id)
         return total
 
 
     def trainable_params(self, recurse=True):
```

## mindnlp/transformers/generation/configuration_utils.py

```diff
@@ -96,14 +96,21 @@
         self.encoder_no_repeat_ngram_size = kwargs.pop("encoder_no_repeat_ngram_size", 0)
         self.decoder_start_token_id = kwargs.pop("decoder_start_token_id", None)
 
         # Assistant generation
         self.num_assistant_tokens = kwargs.pop("num_assistant_tokens", 5)
         self.num_assistant_tokens_schedule = kwargs.pop("num_assistant_tokens_schedule", "heuristic")
 
+        # Cache implementation
+        self.cache_implementation = kwargs.pop("cache_implementation", None)
+
+        # Prompt lookup decoding
+        self.prompt_lookup_num_tokens = kwargs.pop("prompt_lookup_num_tokens", None)
+        self.max_matching_ngram_size = kwargs.pop("max_matching_ngram_size", None)
+
         # Wild card
         self.generation_kwargs = kwargs.pop("generation_kwargs", {})
 
         # The remaining attributes do not parametrize `.generate()`, but are informative and/or used by the hub
         # interface.
         self._from_model_config = kwargs.pop("_from_model_config", False)
         self._commit_hash = kwargs.pop("_commit_hash", None)
```

## mindnlp/transformers/generation/utils.py

```diff
@@ -27,14 +27,15 @@
 
 import mindspore
 from mindspore import ops
 
 from mindnlp.utils import ModelOutput, logging, ExplicitEnum, no_grad
 from .configuration_utils import GenerationConfig
 from ..modeling_outputs import CausalLMOutputWithPast, Seq2SeqLMOutput
+from ..cache_utils import StaticCache
 
 from .logits_process import (
     EncoderNoRepeatNGramLogitsProcessor,
     EncoderRepetitionPenaltyLogitsProcessor,
     EpsilonLogitsWarper,
     EtaLogitsWarper,
     ExponentialDecayLengthPenalty,
@@ -71,14 +72,18 @@
     StoppingCriteriaList,
     validate_stopping_criteria,
 )
 
 
 logger = logging.get_logger(__name__)
 
+NEED_SETUP_CACHE_CLASSES_MAPPING = {
+    "static": StaticCache,
+}
+
 @dataclass
 class GenerateDecoderOnlyOutput(ModelOutput):
     """
     Outputs of decoder-only generation models, when using non-beam methods.
 
     Args:
         sequences (`mindspore.Tensor` of shape `(batch_size, sequence_length)`):
@@ -1518,14 +1523,39 @@
                 logger.warning(
                     f"Both `max_new_tokens` (={generation_config.max_new_tokens}) and `max_length`(="
                     f"{generation_config.max_length}) seem to have been set. `max_new_tokens` will take precedence. "
                     "Please refer to the documentation for more information. "
                     "(https://hf-mirror.com/docs/transformers/main/en/main_classes/text_generation)"
                 )
             generation_config.max_length = generation_config.max_new_tokens + input_ids_length
+
+        # otherwise the total length [inputs-embeds-len + new-tokens-len] will go beyond indicated `max_length``
+        elif (
+            model_input_name == "inputs_embeds"
+            and inputs_tensor.shape[:-1] != input_ids.shape
+            and not self.config.is_encoder_decoder
+        ):
+            generation_config.max_length -= inputs_tensor.shape[1]
+            generation_config.min_length = max(generation_config.min_length - inputs_tensor.shape[1], 0)
+
+        if generation_config.cache_implementation in NEED_SETUP_CACHE_CLASSES_MAPPING:
+            if generation_config.cache_implementation == "static":
+                if model_kwargs.get("past_key_values", False) is not False:
+                    raise ValueError(
+                        "Using `past_key_values` argument with `generate()` when using a static KV cache is not supported. Please open an issue in Transformers GitHub repository."
+                    )
+                cache_cls = NEED_SETUP_CACHE_CLASSES_MAPPING["static"]
+                if not callable(getattr(self, "_setup_cache", None)):
+                    raise ValueError(
+                        "The `generation_config` defines a `cache_implementation` that is not compatible with this model."
+                        " Make sure it has a `_setup_cache` function."
+                    )
+                self._setup_cache(cache_cls, max_batch_size=batch_size, max_cache_len=generation_config.max_length)
+
+
         self._validate_generated_length(generation_config, input_ids_length, has_default_max_length)
 
         # 7. determine generation mode
         generation_mode = self._get_generation_mode(generation_config, assistant_model)
         if streamer is not None and (generation_config.num_beams > 1):
             raise ValueError(
                 "`streamer` cannot be used with beam search (yet!). Make sure that `num_beams` is set to 1."
```

## mindnlp/transformers/models/__init__.py

```diff
@@ -32,18 +32,26 @@
     bert_generation,
     bert_japanese,
     bertweet,
     bge_m3,
     big_bird,
     bigbird_pegasus,
     biogpt,
+    bit,
+    blenderbot,
+    blenderbot_small,
+    blip,
+    blip_2,
     bloom,
+    bridgetower,
+    bros,
     byt5,
     clip,
     codegen,
+    convbert,
     cpm,
     cpmant,
     cpmbee,
     deberta,
     distilbert,
     efficientnet,
     electra,
@@ -59,46 +67,50 @@
     gpt2,
     gpt_bigcode,
     gpt_neo,
     gpt_neox,
     gpt_pangu,
     graphormer,
     hubert,
+    jetmoe,
     layoutlm,
     layoutlmv2,
     llama,
     longformer,
     luke,
     mamba,
     mbart,
     megatron_bert,
     minicpm,
     mistral,
     mixtral,
     mobilebert,
     musicgen,
+    musicgen_melody,
     nezha,
     opt,
     pegasus,
     phi,
     pop2piano,
     qwen2,
+    qwen2_moe,
     reformer,
     roberta,
     rwkv,
     seamless_m4t,
     seamless_m4t_v2,
     starcoder2,
     t5,
     tinybert,
     wav2vec2,
     wav2vec2_with_lm,
     whisper,
     xlm,
     xlm_roberta,
+    xlnet
 )
 
 from .albert import *
 from .align import *
 from .altclip import *
 from .audio_spectrogram_transformer import *
 from .auto import *
@@ -113,18 +125,26 @@
 from .bert_generation import *
 from .bert_japanese import *
 from .bertweet import *
 from .bge_m3 import *
 from .big_bird import *
 from .bigbird_pegasus import *
 from .biogpt import *
+from .bit import *
+from .blenderbot import *
+from .blenderbot_small import *
+from .blip import *
+from .blip_2 import *
 from .bloom import *
+from .bridgetower import *
+from .bros import *
 from .byt5 import *
 from .clip import *
 from .codegen import *
+from .convbert import *
 from .cpm import *
 from .cpmant import *
 from .cpmbee import *
 from .deberta import *
 from .distilbert import *
 from .efficientnet import *
 from .electra import *
@@ -140,46 +160,50 @@
 from .gpt_neo import *
 from .gpt_neox import *
 from .gpt_bigcode import *
 from .gpt_pangu import *
 from .gpt2 import *
 from .graphormer import *
 from .hubert import *
+from .jetmoe import *
 from .layoutlm import *
 from .layoutlmv2 import *
 from .llama import *
 from .longformer import *
 from .luke import *
 from .mamba import *
 from .mbart import *
 from .megatron_bert import *
 from .minicpm import *
 from .mistral import *
 from .mixtral import *
 from .mobilebert import *
 from .musicgen import *
+from .musicgen_melody import *
 from .nezha import *
 from .opt import *
 from .pegasus import *
 from .phi import *
 from .pop2piano import *
 from .qwen2 import *
+from .qwen2_moe import *
 from .reformer import *
 from .roberta import *
 from .rwkv import *
 from .seamless_m4t import *
 from .seamless_m4t_v2 import *
 from .starcoder2 import *
 from .tinybert import *
 from .t5 import *
 from .whisper import *
 from .wav2vec2 import *
 from .wav2vec2_with_lm import *
 from .xlm import *
 from .xlm_roberta import *
+from .xlnet import *
 
 __all__ = []
 __all__.extend(albert.__all__)
 __all__.extend(align.__all__)
 __all__.extend(altclip.__all__)
 __all__.extend(audio_spectrogram_transformer.__all__)
 __all__.extend(auto.__all__)
@@ -194,18 +218,26 @@
 __all__.extend(bert_generation.__all__)
 __all__.extend(bert_japanese.__all__)
 __all__.extend(bertweet.__all__)
 __all__.extend(bge_m3.__all__)
 __all__.extend(big_bird.__all__)
 __all__.extend(bigbird_pegasus.__all__)
 __all__.extend(biogpt.__all__)
+__all__.extend(bit.__all__)
+__all__.extend(blenderbot.__all__)
+__all__.extend(blenderbot_small.__all__)
+__all__.extend(blip.__all__)
+__all__.extend(blip_2.__all__)
 __all__.extend(bloom.__all__)
+__all__.extend(bridgetower.__all__)
+__all__.extend(bros.__all__)
 __all__.extend(byt5.__all__)
 __all__.extend(clip.__all__)
 __all__.extend(codegen.__all__)
+__all__.extend(convbert.__all__)
 __all__.extend(cpm.__all__)
 __all__.extend(cpmant.__all__)
 __all__.extend(cpmbee.__all__)
 __all__.extend(deberta.__all__)
 __all__.extend(distilbert.__all__)
 __all__.extend(efficientnet.__all__)
 __all__.extend(electra.__all__)
@@ -221,39 +253,43 @@
 __all__.extend(gpt_neo.__all__)
 __all__.extend(gpt_neox.__all__)
 __all__.extend(gpt_pangu.__all__)
 __all__.extend(gpt_bigcode.__all__)
 __all__.extend(gpt2.__all__)
 __all__.extend(graphormer.__all__)
 __all__.extend(hubert.__all__)
+__all__.extend(jetmoe.__all__)
 __all__.extend(layoutlm.__all__)
 __all__.extend(layoutlmv2.__all__)
 __all__.extend(llama.__all__)
 __all__.extend(longformer.__all__)
 __all__.extend(luke.__all__)
 __all__.extend(mamba.__all__)
 __all__.extend(mbart.__all__)
 __all__.extend(megatron_bert.__all__)
 __all__.extend(minicpm.__all__)
 __all__.extend(mistral.__all__)
 __all__.extend(mixtral.__all__)
 __all__.extend(mobilebert.__all__)
 __all__.extend(musicgen.__all__)
+__all__.extend(musicgen_melody.__all__)
 __all__.extend(nezha.__all__)
 __all__.extend(opt.__all__)
 __all__.extend(pegasus.__all__)
 __all__.extend(phi.__all__)
 __all__.extend(pop2piano.__all__)
 __all__.extend(qwen2.__all__)
+__all__.extend(qwen2_moe.__all__)
 __all__.extend(reformer.__all__)
 __all__.extend(roberta.__all__)
 __all__.extend(rwkv.__all__)
 __all__.extend(seamless_m4t.__all__)
 __all__.extend(seamless_m4t_v2.__all__)
 __all__.extend(starcoder2.__all__)
 __all__.extend(tinybert.__all__)
 __all__.extend(t5.__all__)
 __all__.extend(whisper.__all__)
 __all__.extend(wav2vec2.__all__)
 __all__.extend(wav2vec2_with_lm.__all__)
 __all__.extend(xlm.__all__)
 __all__.extend(xlm_roberta.__all__)
+__all__.extend(xlnet.__all__)
```

## mindnlp/transformers/models/auto/configuration_auto.py

```diff
@@ -38,15 +38,22 @@
         ("beit", "BeitConfig"),
         ("bert", "BertConfig"),
         ("bert-generation", "BertGenerationConfig"),
         ("bge-m3", "BgeM3Config"),
         ("big_bird", "BigBirdConfig"),
         ("bigbird_pegasus", "BigBirdPegasusConfig"),
         ("biogpt", "BioGptConfig"),
+        ("bit", "BitConfig"),
+        ("blenderbot", "BlenderbotConfig"),
+        ("blenderbot-small", "BlenderbotSmallConfig"),
+        ("blip", "BlipConfig"),
+        ("blip-2", "Blip2Config"),
         ("bloom", "BloomConfig"),
+        ("bridgetower", "BridgeTowerConfig"),
+        ("bros", "BrosConfig"),
         ('chatglm', 'ChatGLMConfig'),
         ("clip", "CLIPConfig"),
         ("clip_vision_model", "CLIPVisionConfig"),
         ("codegen", "CodeGenConfig"),
         ("cpmant", "CpmAntConfig"),
         ("cpmbee", "CpmBeeConfig"),
         ("deberta", "DebertaConfig"),
@@ -55,31 +62,36 @@
         ("esm", "EsmConfig"),
         ("falcon", "FalconConfig"),
         ("gemma", "GemmaConfig"),
         ("gpt2", "GPT2Config"),
         ('gpt_bigcode', 'GPTBigCodeConfig'),
         ("gpt_pangu", "GPTPanguConfig"),
         ('hubert', 'HubertConfig'),
+        ('jetmoe', 'JetMoEConfig'),
         ("mamba", "MambaConfig"),
         ("mbart", "MBartConfig"),
         ('minicpm', 'MiniCPMConfig'),
         ("mistral", "MistralConfig"),
         ("mixtral", "MixtralConfig"),
         ("musicgen", "MusicgenConfig"),
+        ("musicgen_melody", "MusicgenMelodyConfig"),
         ('mt5', 'MT5Config'),
+        ("opt", 'OPTConfig'),
         ("phi", "PhiConfig"),
         ("qwen2", "Qwen2Config"),
+        ("qwen2_moe", "Qwen2MoeConfig"),
         ("reformer", "ReformerConfig"),
         ("roberta", "RobertaConfig"),
         ("starcoder2", "Starcoder2Config"),
         ('t5', 'T5Config'),
         ('wav2vec2', 'Wav2Vec2Config'),
         ("whisper", "WhisperConfig"),
         ('xlm-roberta', 'XLMRobertaConfig'),
         ("layoutlmv2", "LayoutLMv2Config"),
+        ("xlnet", "XLNetConfig"),
     ]
 )
 
 CONFIG_ARCHIVE_MAP_MAPPING_NAMES = OrderedDict(
     [
         # Add archive maps here)
         ("albert", "ALBERT_PRETRAINED_CONFIG_ARCHIVE_MAP"),
@@ -391,14 +403,15 @@
         ("hubert", "Hubert"),
         ("ibert", "I-BERT"),
         ("idefics", "IDEFICS"),
         ("imagegpt", "ImageGPT"),
         ("informer", "Informer"),
         ("instructblip", "InstructBLIP"),
         ("jukebox", "Jukebox"),
+        ("jetmoe", "JetMoE"),
         ("kosmos-2", "KOSMOS-2"),
         ("layoutlm", "LayoutLM"),
         ("layoutlmv2", "LayoutLMv2"),
         ("layoutlmv3", "LayoutLMv3"),
         ("layoutxlm", "LayoutXLM"),
         ("led", "LED"),
         ("levit", "LeViT"),
@@ -435,14 +448,15 @@
         ("mobilevit", "MobileViT"),
         ("mobilevitv2", "MobileViTV2"),
         ("mpnet", "MPNet"),
         ("mpt", "MPT"),
         ("mra", "MRA"),
         ("mt5", "MT5"),
         ("musicgen", "MusicGen"),
+        ("musicgen_melody", "MusicGen Melody"),
         ("mvp", "MVP"),
         ("nat", "NAT"),
         ("nezha", "Nezha"),
         ("nllb", "NLLB"),
         ("nllb-moe", "NLLB-MOE"),
         ("nougat", "Nougat"),
         ("nystromformer", "Nyströmformer"),
@@ -462,14 +476,15 @@
         ("plbart", "PLBart"),
         ("poolformer", "PoolFormer"),
         ("pop2piano", "Pop2Piano"),
         ("prophetnet", "ProphetNet"),
         ("pvt", "PVT"),
         ("qdqbert", "QDQBert"),
         ("qwen2", "Qwen2"),
+        ("qwen2_moe", "Qwen2MoE"),
         ("rag", "RAG"),
         ("realm", "REALM"),
         ("reformer", "Reformer"),
         ("regnet", "RegNet"),
         ("rembert", "RemBERT"),
         ("resnet", "ResNet"),
         ("retribert", "RetriBERT"),
```

## mindnlp/transformers/models/auto/modeling_auto.py

```diff
@@ -40,48 +40,60 @@
         ("beit", "BeitModel"),
         ("bert", "BertModel"),
         ("bert-generation", "BertGenerationEncoder"),
         ("bge-m3", "BgeM3Model"),
         ("big_bird", "BigBirdModel"),
         ("bigbird_pegasus", "BigBirdPegasusModel"),
         ("biogpt", "BioGptModel"),
+        ("bit", "BitModel"),
+        ("blenderbot", "BlenderbotModel"),
+        ("blenderbot-small", "BlenderbotSmallModel"),
+        ("blip", "BlipModel"),
+        ("blip-2", "Blip2Model"),
         ("bloom", "BloomModel"),
+        ("bridgetower", "BridgeTowerModel"),
+        ("bros", "BrosModel"),
         ("codegen", "CodeGenModel"),
         ("cpmant", "CpmAntModel"),
         ("cpmbee", "CpmBeeModel"),
         ("chatglm", "ChatGLMModel"),
         ("clip", "CLIPModel"),
         ("clip_vision_model", "CLIPVisionModel"),
+        ("convbert", "ConvBertModel"),
         ("deberta", "DebertaModel"),
-        ('encodec','EncodecModel'),
+        ('encodec', 'EncodecModel'),
         ("esm", "EsmModel"),
         ("ernie", "ErnieModel"),
         ("ernie_m", "ErnieMModel"),
         ("falcon", "FalconModel"),
         ("gemma", "GemmaModel"),
         ("gpt_bigcode", "GPTBigCodeModel"),
         ("gpt", "GPTModel"),
         ("gpt2", "GPT2Model"),
         ("gpt_pangu", "GPTPanguModel"),
         ("layoutlmv2", "LayoutLMv2Model"),
         ("longformer", "LongformerModel"),
+        ("jetmoe", "JetMoEModel"),
         ("mamba", "MambaModel"),
-        ('mbart','MBartModel'),
+        ('mbart', 'MBartModel'),
         ('minicpm', 'MiniCPMModel'),
         ("mistral", "MistralModel"),
         ("mixtral", "MixtralModel"),
+        ("opt", "OPTModel"),
         ("phi", "PhiModel"),
         ("qwen2", "Qwen2Model"),
+        ("qwen2_moe", "Qwen2MoeModel"),
         ("reformer", "ReformerModel"),
         ("roberta", "RobertaModel"),
         ("rwkv", "RwkvModel"),
         ("starcoder2", "Starcoder2Model"),
         ("t5", "T5Model"),
         ("whisper", "WhisperModel"),
         ("xlm-roberta", "XLMRobertaModel"),
+	("xlnet", "XLNetModel"),
     ]
 )
 
 MODEL_FOR_PRETRAINING_MAPPING_NAMES = OrderedDict(
     [
         # Model for pre-training mapping
         ("albert", "AlbertForPreTraining"),
@@ -90,72 +102,82 @@
         ("bloom", "BloomForCausalLM"),
         ("deberta", "DebertaForMaskedLM"),
         ("gpt_pangu", "GPTPanguForCausalLM"),
         ("mamba", "MambaForCausalLM"),
         ('minicpm', 'MiniCPMForCausalLM'),
         ("rwkv", "RwkvForCausalLM"),
         ("xlm-roberta", "XLMRobertaForMaskedLM"),
+	("xlnet", "XLNetLMHeadModel"),
     ]
 )
 
 MODEL_WITH_LM_HEAD_MAPPING_NAMES = OrderedDict(
     [
         # Model with LM heads mapping
         ("albert", "AlbertForMaskedLM"),
         ("bert", "BertForMaskedLM"),
         ("big_bird", "BigBirdForMaskedLM"),
         ("bigbird_pegasus", "BigBirdPegasusForConditionalGeneration"),
+        ("blenderbot-small", "BlenderbotSmallForConditionalGeneration"),
         ("bloom", "BloomForCausalLM"),
         ("codegen", "CodeGenForCausalLM"),
         ("cpmant", "CpmAntForCausalLM"),
         ("cpmbee", "CpmBeeForCausalLM"),
         ("deberta", "DebertaForMaskedLM"),
         ("esm", "EsmForMaskedLM"),
         ("gpt_pangu", "GPTPanguForCausalLM"),
         ("mamba", "MambaForCausalLM"),
         ('minicpm', 'MiniCPMForCausalLM'),
         ("reformer", "ReformerModelWithLMHead"),
         ("roberta", "RobertaForMaskedLM"),
         ("rwkv", "RwkvForCausalLM"),
         ("whisper", "WhisperForConditionalGeneration"),
         ("xlm-roberta", "XLMRobertaForMaskedLM"),
+	("xlnet", "XLNetLMHeadModel"),
     ]
 )
 
 MODEL_FOR_CAUSAL_LM_MAPPING_NAMES = OrderedDict(
     [
         # Model for Causal LM mapping
         ("bart", "BartForCausalLM"),
         ("bert", "BertLMHeadModel"),
         ("bert-generation", "BertGenerationDecoder"),
         ("bigbird_pegasus", "BigBirdPegasusForCausalLM"),
         ("big_bird", "BigBirdForCausalLM"),
         ("biogpt", "BioGptForCausalLM"),
+        ("blenderbot", "BlenderbotForCausalLM"),
+        ("blenderbot-small", "BlenderbotSmallForCausalLM"),
         ("bloom", "BloomForCausalLM"),
         ("codegen", "CodeGenForCausalLM"),
         ("cpmant", "CpmAntForCausalLM"),
         ("cpmbee", "CpmBeeForCausalLM"),
         ("gemma", "GemmaForCausalLM"),
         ("gpt2", "GPT2LMHeadModel"),
         ("gpt_pangu", "GPTPanguForCausalLM"),
         ("falcon", "FalconForCausalLM"),
         ("gpt_bigcode", "GPTBigCodeForCausalLM"),
+        ("jetmoe", "JetMoEForCausalLM"),
         ("mamba", "MambaForCausalLM"),
         ('minicpm', 'MiniCPMForCausalLM'),
         ("mistral", "MistralForCausalLM"),
         ("mixtral", "MixtralForCausalLM"),
         ("musicgen", "MusicgenForCausalLM"),
+        ("musicgen_melody", "MusicgenMelodyForCausalLM"),
+        ("opt", "OPTForCausalLM"),
         ("phi", "PhiForCausalLM"),
         ("qwen2", "Qwen2ForCausalLM"),
+        ("qwen2_moe", "Qwen2MoeForCausalLM"),
         ("reformer", "ReformerModelWithLMHead"),
         ("roberta", "RobertaLMHeadModel"),
         ("rwkv", "RwkvForCausalLM"),
         ("starcoder2", "Starcoder2ForCausalLM"),
         ("whisper", "WhisperForCausalLM"),
         ("xlm-roberta", "XLMRobertaForCausalLM"),
+	("xlnet", "XLNetLMHeadModel"),
     ]
 )
 
 
 MODEL_FOR_IMAGE_CLASSIFICATION_MAPPING_NAMES = OrderedDict(
     [
         # Model for Image Classification mapping
@@ -346,22 +368,26 @@
         ("biogpt", "BioGptForSequenceClassification"),
         ("bloom", "BloomForSequenceClassification"),
         ("deberta", "DebertaForSequenceClassification"),
         ("distilbert", "DistilBertForSequenceClassification"),
         ("esm", "EsmForSequenceClassification"),
         ("falcon", "FalconForSequenceClassification"),
         ("layoutlmv2", "LayoutLMv2ForSequenceClassification"),
+        ("jetmoe", "JetMoEForSequenceClassification"),
         ('minicpm', 'MiniCPMForSequenceClassification'),
         ("mistral", "MistralForSequenceClassification"),
         ("mixtral", "MixtralForSequenceClassification"),
+        ("opt", "OPTForSequenceClassification"),
         ("phi", "PhiForSequenceClassification"),
         ("qwen2", "Qwen2ForSequenceClassification"),
+        ("qwen2_moe", "Qwen2MoeForSequenceClassification"),
         ("reformer", "ReformerForSequenceClassification"),
         ("starcoder2", "Starcoder2ForSequenceClassification"),
         ("xlm-roberta", "XLMRobertaForSequenceClassification"),
+	("xlnet", "XLNetForSequenceClassification"),
     ]
 )
 
 MODEL_FOR_QUESTION_ANSWERING_MAPPING_NAMES = OrderedDict(
     [
         # Model for Question Answering mapping
         ("albert", "AlbertForQuestionAnswering"),
@@ -434,14 +460,15 @@
         # Model for Table Question Answering mapping
         ("tapas", "TapasForQuestionAnswering"),
     ]
 )
 
 MODEL_FOR_VISUAL_QUESTION_ANSWERING_MAPPING_NAMES = OrderedDict(
     [
+        ("blip", "BlipForQuestionAnswering"),
         ("blip-2", "Blip2ForConditionalGeneration"),
         ("vilt", "ViltForQuestionAnswering"),
     ]
 )
 
 MODEL_FOR_DOCUMENT_QUESTION_ANSWERING_MAPPING_NAMES = OrderedDict(
     [
@@ -633,14 +660,15 @@
 )
 
 MODEL_FOR_TEXT_TO_WAVEFORM_MAPPING_NAMES = OrderedDict(
     [
         # Model for Text-To-Waveform mapping
         ("bark", "BarkModel"),
         ("musicgen", "MusicgenForConditionalGeneration"),
+        ("musicgen_melody", "MusicgenMelodyForConditionalGeneration"),
         ("seamless_m4t", "SeamlessM4TForTextToSpeech"),
         ("vits", "VitsModel"),
     ]
 )
 
 MODEL_FOR_ZERO_SHOT_IMAGE_CLASSIFICATION_MAPPING_NAMES = OrderedDict(
     [
@@ -780,17 +808,20 @@
         ("mobilevitv2", "MobileViTV2ForSemanticSegmentation"),
         ("segformer", "SegformerForSemanticSegmentation"),
         ("upernet", "UperNetForSemanticSegmentation"),
     ]
 )
 
 MODEL_MAPPING = _LazyAutoMapping(CONFIG_MAPPING_NAMES, MODEL_MAPPING_NAMES)
-MODEL_FOR_PRETRAINING_MAPPING = _LazyAutoMapping(CONFIG_MAPPING_NAMES, MODEL_FOR_PRETRAINING_MAPPING_NAMES)
-MODEL_WITH_LM_HEAD_MAPPING = _LazyAutoMapping(CONFIG_MAPPING_NAMES, MODEL_WITH_LM_HEAD_MAPPING_NAMES)
-MODEL_FOR_CAUSAL_LM_MAPPING = _LazyAutoMapping(CONFIG_MAPPING_NAMES, MODEL_FOR_CAUSAL_LM_MAPPING_NAMES)
+MODEL_FOR_PRETRAINING_MAPPING = _LazyAutoMapping(
+    CONFIG_MAPPING_NAMES, MODEL_FOR_PRETRAINING_MAPPING_NAMES)
+MODEL_WITH_LM_HEAD_MAPPING = _LazyAutoMapping(
+    CONFIG_MAPPING_NAMES, MODEL_WITH_LM_HEAD_MAPPING_NAMES)
+MODEL_FOR_CAUSAL_LM_MAPPING = _LazyAutoMapping(
+    CONFIG_MAPPING_NAMES, MODEL_FOR_CAUSAL_LM_MAPPING_NAMES)
 
 MODEL_FOR_IMAGE_CLASSIFICATION_MAPPING = _LazyAutoMapping(
     CONFIG_MAPPING_NAMES, MODEL_FOR_IMAGE_CLASSIFICATION_MAPPING_NAMES
 )
 
 MODEL_FOR_ZERO_SHOT_IMAGE_CLASSIFICATION_MAPPING = _LazyAutoMapping(
     CONFIG_MAPPING_NAMES, MODEL_FOR_ZERO_SHOT_IMAGE_CLASSIFICATION_MAPPING_NAMES
@@ -801,28 +832,32 @@
 )
 MODEL_FOR_UNIVERSAL_SEGMENTATION_MAPPING = _LazyAutoMapping(
     CONFIG_MAPPING_NAMES, MODEL_FOR_UNIVERSAL_SEGMENTATION_MAPPING_NAMES
 )
 MODEL_FOR_VIDEO_CLASSIFICATION_MAPPING = _LazyAutoMapping(
     CONFIG_MAPPING_NAMES, MODEL_FOR_VIDEO_CLASSIFICATION_MAPPING_NAMES
 )
-MODEL_FOR_VISION_2_SEQ_MAPPING = _LazyAutoMapping(CONFIG_MAPPING_NAMES, MODEL_FOR_VISION_2_SEQ_MAPPING_NAMES)
+MODEL_FOR_VISION_2_SEQ_MAPPING = _LazyAutoMapping(
+    CONFIG_MAPPING_NAMES, MODEL_FOR_VISION_2_SEQ_MAPPING_NAMES)
 MODEL_FOR_VISUAL_QUESTION_ANSWERING_MAPPING = _LazyAutoMapping(
     CONFIG_MAPPING_NAMES, MODEL_FOR_VISUAL_QUESTION_ANSWERING_MAPPING_NAMES
 )
 MODEL_FOR_DOCUMENT_QUESTION_ANSWERING_MAPPING = _LazyAutoMapping(
     CONFIG_MAPPING_NAMES, MODEL_FOR_DOCUMENT_QUESTION_ANSWERING_MAPPING_NAMES
 )
-MODEL_FOR_MASKED_LM_MAPPING = _LazyAutoMapping(CONFIG_MAPPING_NAMES, MODEL_FOR_MASKED_LM_MAPPING_NAMES)
+MODEL_FOR_MASKED_LM_MAPPING = _LazyAutoMapping(
+    CONFIG_MAPPING_NAMES, MODEL_FOR_MASKED_LM_MAPPING_NAMES)
 
-MODEL_FOR_OBJECT_DETECTION_MAPPING = _LazyAutoMapping(CONFIG_MAPPING_NAMES, MODEL_FOR_OBJECT_DETECTION_MAPPING_NAMES)
+MODEL_FOR_OBJECT_DETECTION_MAPPING = _LazyAutoMapping(
+    CONFIG_MAPPING_NAMES, MODEL_FOR_OBJECT_DETECTION_MAPPING_NAMES)
 MODEL_FOR_ZERO_SHOT_OBJECT_DETECTION_MAPPING = _LazyAutoMapping(
     CONFIG_MAPPING_NAMES, MODEL_FOR_ZERO_SHOT_OBJECT_DETECTION_MAPPING_NAMES
 )
-MODEL_FOR_DEPTH_ESTIMATION_MAPPING = _LazyAutoMapping(CONFIG_MAPPING_NAMES, MODEL_FOR_DEPTH_ESTIMATION_MAPPING_NAMES)
+MODEL_FOR_DEPTH_ESTIMATION_MAPPING = _LazyAutoMapping(
+    CONFIG_MAPPING_NAMES, MODEL_FOR_DEPTH_ESTIMATION_MAPPING_NAMES)
 MODEL_FOR_SEQ_TO_SEQ_CAUSAL_LM_MAPPING = _LazyAutoMapping(
     CONFIG_MAPPING_NAMES, MODEL_FOR_SEQ_TO_SEQ_CAUSAL_LM_MAPPING_NAMES
 )
 MODEL_FOR_SEQUENCE_CLASSIFICATION_MAPPING = _LazyAutoMapping(
     CONFIG_MAPPING_NAMES, MODEL_FOR_SEQUENCE_CLASSIFICATION_MAPPING_NAMES
 )
 MODEL_FOR_QUESTION_ANSWERING_MAPPING = _LazyAutoMapping(
@@ -830,48 +865,59 @@
 )
 MODEL_FOR_TABLE_QUESTION_ANSWERING_MAPPING = _LazyAutoMapping(
     CONFIG_MAPPING_NAMES, MODEL_FOR_TABLE_QUESTION_ANSWERING_MAPPING_NAMES
 )
 MODEL_FOR_TOKEN_CLASSIFICATION_MAPPING = _LazyAutoMapping(
     CONFIG_MAPPING_NAMES, MODEL_FOR_TOKEN_CLASSIFICATION_MAPPING_NAMES
 )
-MODEL_FOR_MULTIPLE_CHOICE_MAPPING = _LazyAutoMapping(CONFIG_MAPPING_NAMES, MODEL_FOR_MULTIPLE_CHOICE_MAPPING_NAMES)
+MODEL_FOR_MULTIPLE_CHOICE_MAPPING = _LazyAutoMapping(
+    CONFIG_MAPPING_NAMES, MODEL_FOR_MULTIPLE_CHOICE_MAPPING_NAMES)
 MODEL_FOR_NEXT_SENTENCE_PREDICTION_MAPPING = _LazyAutoMapping(
     CONFIG_MAPPING_NAMES, MODEL_FOR_NEXT_SENTENCE_PREDICTION_MAPPING_NAMES
 )
 MODEL_FOR_AUDIO_CLASSIFICATION_MAPPING = _LazyAutoMapping(
     CONFIG_MAPPING_NAMES, MODEL_FOR_AUDIO_CLASSIFICATION_MAPPING_NAMES
 )
-MODEL_FOR_CTC_MAPPING = _LazyAutoMapping(CONFIG_MAPPING_NAMES, MODEL_FOR_CTC_MAPPING_NAMES)
-MODEL_FOR_SPEECH_SEQ_2_SEQ_MAPPING = _LazyAutoMapping(CONFIG_MAPPING_NAMES, MODEL_FOR_SPEECH_SEQ_2_SEQ_MAPPING_NAMES)
+MODEL_FOR_CTC_MAPPING = _LazyAutoMapping(
+    CONFIG_MAPPING_NAMES, MODEL_FOR_CTC_MAPPING_NAMES)
+MODEL_FOR_SPEECH_SEQ_2_SEQ_MAPPING = _LazyAutoMapping(
+    CONFIG_MAPPING_NAMES, MODEL_FOR_SPEECH_SEQ_2_SEQ_MAPPING_NAMES)
 MODEL_FOR_AUDIO_FRAME_CLASSIFICATION_MAPPING = _LazyAutoMapping(
     CONFIG_MAPPING_NAMES, MODEL_FOR_AUDIO_FRAME_CLASSIFICATION_MAPPING_NAMES
 )
-MODEL_FOR_AUDIO_XVECTOR_MAPPING = _LazyAutoMapping(CONFIG_MAPPING_NAMES, MODEL_FOR_AUDIO_XVECTOR_MAPPING_NAMES)
+MODEL_FOR_AUDIO_XVECTOR_MAPPING = _LazyAutoMapping(
+    CONFIG_MAPPING_NAMES, MODEL_FOR_AUDIO_XVECTOR_MAPPING_NAMES)
 
 MODEL_FOR_TEXT_TO_SPECTROGRAM_MAPPING = _LazyAutoMapping(
     CONFIG_MAPPING_NAMES, MODEL_FOR_TEXT_TO_SPECTROGRAM_MAPPING_NAMES
 )
 
-MODEL_FOR_TEXT_TO_WAVEFORM_MAPPING = _LazyAutoMapping(CONFIG_MAPPING_NAMES, MODEL_FOR_TEXT_TO_WAVEFORM_MAPPING_NAMES)
+MODEL_FOR_TEXT_TO_WAVEFORM_MAPPING = _LazyAutoMapping(
+    CONFIG_MAPPING_NAMES, MODEL_FOR_TEXT_TO_WAVEFORM_MAPPING_NAMES)
 
-MODEL_FOR_BACKBONE_MAPPING = _LazyAutoMapping(CONFIG_MAPPING_NAMES, MODEL_FOR_BACKBONE_MAPPING_NAMES)
+MODEL_FOR_BACKBONE_MAPPING = _LazyAutoMapping(
+    CONFIG_MAPPING_NAMES, MODEL_FOR_BACKBONE_MAPPING_NAMES)
 
-MODEL_FOR_MASK_GENERATION_MAPPING = _LazyAutoMapping(CONFIG_MAPPING_NAMES, MODEL_FOR_MASK_GENERATION_MAPPING_NAMES)
+MODEL_FOR_MASK_GENERATION_MAPPING = _LazyAutoMapping(
+    CONFIG_MAPPING_NAMES, MODEL_FOR_MASK_GENERATION_MAPPING_NAMES)
 
-MODEL_FOR_TEXT_ENCODING_MAPPING = _LazyAutoMapping(CONFIG_MAPPING_NAMES, MODEL_FOR_TEXT_ENCODING_MAPPING_NAMES)
+MODEL_FOR_TEXT_ENCODING_MAPPING = _LazyAutoMapping(
+    CONFIG_MAPPING_NAMES, MODEL_FOR_TEXT_ENCODING_MAPPING_NAMES)
 
-MODEL_FOR_IMAGE_TO_IMAGE_MAPPING = _LazyAutoMapping(CONFIG_MAPPING_NAMES, MODEL_FOR_IMAGE_TO_IMAGE_MAPPING_NAMES)
+MODEL_FOR_IMAGE_TO_IMAGE_MAPPING = _LazyAutoMapping(
+    CONFIG_MAPPING_NAMES, MODEL_FOR_IMAGE_TO_IMAGE_MAPPING_NAMES)
 
-MODEL_FOR_IMAGE_MAPPING = _LazyAutoMapping(CONFIG_MAPPING_NAMES, MODEL_FOR_IMAGE_MAPPING_NAMES)
+MODEL_FOR_IMAGE_MAPPING = _LazyAutoMapping(
+    CONFIG_MAPPING_NAMES, MODEL_FOR_IMAGE_MAPPING_NAMES)
 
 MODEL_FOR_SEMANTIC_SEGMENTATION_MAPPING = _LazyAutoMapping(
     CONFIG_MAPPING_NAMES, MODEL_FOR_SEMANTIC_SEGMENTATION_MAPPING_NAMES
 )
 
+
 class AutoModelForMaskGeneration(_BaseAutoModelClass):
     _model_mapping = MODEL_FOR_MASK_GENERATION_MAPPING
 
 
 class AutoModelForTextEncoding(_BaseAutoModelClass):
     _model_mapping = MODEL_FOR_TEXT_ENCODING_MAPPING
 
@@ -884,14 +930,16 @@
     _model_mapping = MODEL_MAPPING
 
 
 class AutoModelForPreTraining(_BaseAutoModelClass):
     _model_mapping = MODEL_FOR_PRETRAINING_MAPPING
 
 # Private on purpose, the public class will add the deprecation warnings.
+
+
 class _AutoModelWithLMHead(_BaseAutoModelClass):
     _model_mapping = MODEL_WITH_LM_HEAD_MAPPING
 
 
 class AutoModelForCausalLM(_BaseAutoModelClass):
     _model_mapping = MODEL_FOR_CAUSAL_LM_MAPPING
 
@@ -920,15 +968,14 @@
     _model_mapping = MODEL_FOR_VISUAL_QUESTION_ANSWERING_MAPPING
 
 
 class AutoModelForDocumentQuestionAnswering(_BaseAutoModelClass):
     _model_mapping = MODEL_FOR_DOCUMENT_QUESTION_ANSWERING_MAPPING
 
 
-
 class AutoModelForTokenClassification(_BaseAutoModelClass):
     _model_mapping = MODEL_FOR_TOKEN_CLASSIFICATION_MAPPING
 
 
 class AutoModelForMultipleChoice(_BaseAutoModelClass):
     _model_mapping = MODEL_FOR_MULTIPLE_CHOICE_MAPPING
```

## mindnlp/transformers/models/auto/tokenization_auto.py

```diff
@@ -185,14 +185,21 @@
         ("gptsan-japanese", ("GPTSanJapaneseTokenizer", None)),
         ("groupvit", ("CLIPTokenizer", "CLIPTokenizerFast" if is_tokenizers_available() else None)),
         ("herbert", ("HerbertTokenizer", "HerbertTokenizerFast" if is_tokenizers_available() else None)),
         ("hubert", ("Wav2Vec2CTCTokenizer", None)),
         ("ibert", ("RobertaTokenizer", "RobertaTokenizerFast" if is_tokenizers_available() else None)),
         # ("idefics", (None, "LlamaTokenizerFast" if is_tokenizers_available() else None)),
         ("instructblip", ("GPT2Tokenizer", "GPT2TokenizerFast" if is_tokenizers_available() else None)),
+        (
+            "jetmoe",
+            (
+                "LlamaTokenizer" if is_sentencepiece_available() else None,
+                "LlamaTokenizerFast" if is_tokenizers_available() else None,
+            ),
+        ),
         ("jukebox", ("JukeboxTokenizer", None)),
         # (
         #     "kosmos-2",
         #     (
         #         "XLMRobertaTokenizer" if is_sentencepiece_available() else None,
         #         "XLMRobertaTokenizerFast" if is_tokenizers_available() else None,
         #     ),
@@ -268,15 +275,16 @@
         (
             "mt5",
             (
                 "MT5Tokenizer" if is_sentencepiece_available() else None,
                 "MT5TokenizerFast" if is_tokenizers_available() else None,
             ),
         ),
-        # ("musicgen", ("T5Tokenizer", "T5TokenizerFast" if is_tokenizers_available() else None)),
+        ("musicgen", ("T5Tokenizer", "T5TokenizerFast" if is_tokenizers_available() else None)),
+        ("musicgen_melody", ("T5Tokenizer", "T5TokenizerFast" if is_tokenizers_available() else None)),
         ("mvp", ("MvpTokenizer", "MvpTokenizerFast" if is_tokenizers_available() else None)),
         ("nezha", ("BertTokenizer", "BertTokenizerFast" if is_tokenizers_available() else None)),
         (
             "nllb",
             (
                 "NllbTokenizer" if is_sentencepiece_available() else None,
                 "NllbTokenizerFast" if is_tokenizers_available() else None,
@@ -338,14 +346,21 @@
         (
             "qwen2",
             (
                 "Qwen2Tokenizer",
                 "Qwen2TokenizerFast" if is_tokenizers_available() else None,
             ),
         ),
+        (
+            "qwen2_moe",
+            (
+                "Qwen2Tokenizer",
+                "Qwen2TokenizerFast" if is_tokenizers_available() else None,
+            ),
+        ),
         ("rag", ("RagTokenizer", None)),
         ("realm", ("RealmTokenizer", "RealmTokenizerFast" if is_tokenizers_available() else None)),
         (
             "reformer",
             (
                 "ReformerTokenizer" if is_sentencepiece_available() else None,
                 "ReformerTokenizerFast" if is_tokenizers_available() else None,
```

## mindnlp/transformers/models/bigbird_pegasus/modeling_bigbird_pegasus.py

```diff
@@ -2496,15 +2496,15 @@
         )
         hidden_states = outputs[0]  # last hidden state
 
         eos_mask = input_ids.eq(self.config.eos_token_id)
 
         if len(ops.unique_consecutive(eos_mask.sum(1))) > 1:
             raise ValueError("All examples must have the same number of <eos> tokens.")
-        sentence_representation = hidden_states[eos_mask, :].view(hidden_states.shape[0], -1, hidden_states.shape[-1])[
+        sentence_representation = hidden_states[eos_mask].view(hidden_states.shape[0], -1, hidden_states.shape[-1])[
             :, -1, :
         ]
         logits = self.classification_head(sentence_representation)
 
         loss = None
         if labels is not None:
             if self.config.problem_type is None:
```

## mindnlp/transformers/models/biogpt/__init__.py

```diff
@@ -9,15 +9,15 @@
 # Unless required by applicable law or agreed to in writing, software
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
 # ============================================================================
 """
-Bert Model.
+BioGPT Model.
 """
 from . import configuration_biogpt, modeling_biogpt, tokenization_biogpt
 from .configuration_biogpt import *
 from .modeling_biogpt import *
 from .tokenization_biogpt import *
 
 __all__ = []
```

## mindnlp/transformers/models/bit/__init__.py

```diff
@@ -0,0 +1,62 @@
+00000000: 2320 436f 7079 7269 6768 7420 3230 3234  # Copyright 2024
+00000010: 2048 7561 7765 6920 5465 6368 6e6f 6c6f   Huawei Technolo
+00000020: 6769 6573 2043 6f2e 2c20 4c74 640a 230a  gies Co., Ltd.#.
+00000030: 2320 4c69 6365 6e73 6564 2075 6e64 6572  # Licensed under
+00000040: 2074 6865 2041 7061 6368 6520 4c69 6365   the Apache Lice
+00000050: 6e73 652c 2056 6572 7369 6f6e 2032 2e30  nse, Version 2.0
+00000060: 2028 7468 6520 224c 6963 656e 7365 2229   (the "License")
+00000070: 3b0a 2320 796f 7520 6d61 7920 6e6f 7420  ;.# you may not 
+00000080: 7573 6520 7468 6973 2066 696c 6520 6578  use this file ex
+00000090: 6365 7074 2069 6e20 636f 6d70 6c69 616e  cept in complian
+000000a0: 6365 2077 6974 6820 7468 6520 4c69 6365  ce with the Lice
+000000b0: 6e73 652e 0a23 2059 6f75 206d 6179 206f  nse..# You may o
+000000c0: 6274 6169 6e20 6120 636f 7079 206f 6620  btain a copy of 
+000000d0: 7468 6520 4c69 6365 6e73 6520 6174 0a23  the License at.#
+000000e0: 0a23 2068 7474 703a 2f2f 7777 772e 6170  .# http://www.ap
+000000f0: 6163 6865 2e6f 7267 2f6c 6963 656e 7365  ache.org/license
+00000100: 732f 4c49 4345 4e53 452d 322e 300a 230a  s/LICENSE-2.0.#.
+00000110: 2320 556e 6c65 7373 2072 6571 7569 7265  # Unless require
+00000120: 6420 6279 2061 7070 6c69 6361 626c 6520  d by applicable 
+00000130: 6c61 7720 6f72 2061 6772 6565 6420 746f  law or agreed to
+00000140: 2069 6e20 7772 6974 696e 672c 2073 6f66   in writing, sof
+00000150: 7477 6172 650a 2320 6469 7374 7269 6275  tware.# distribu
+00000160: 7465 6420 756e 6465 7220 7468 6520 4c69  ted under the Li
+00000170: 6365 6e73 6520 6973 2064 6973 7472 6962  cense is distrib
+00000180: 7574 6564 206f 6e20 616e 2022 4153 2049  uted on an "AS I
+00000190: 5322 2042 4153 4953 2c0a 2320 5749 5448  S" BASIS,.# WITH
+000001a0: 4f55 5420 5741 5252 414e 5449 4553 204f  OUT WARRANTIES O
+000001b0: 5220 434f 4e44 4954 494f 4e53 204f 4620  R CONDITIONS OF 
+000001c0: 414e 5920 4b49 4e44 2c20 6569 7468 6572  ANY KIND, either
+000001d0: 2065 7870 7265 7373 206f 7220 696d 706c   express or impl
+000001e0: 6965 642e 0a23 2053 6565 2074 6865 204c  ied..# See the L
+000001f0: 6963 656e 7365 2066 6f72 2074 6865 2073  icense for the s
+00000200: 7065 6369 6669 6320 6c61 6e67 7561 6765  pecific language
+00000210: 2067 6f76 6572 6e69 6e67 2070 6572 6d69   governing permi
+00000220: 7373 696f 6e73 2061 6e64 0a23 206c 696d  ssions and.# lim
+00000230: 6974 6174 696f 6e73 2075 6e64 6572 2074  itations under t
+00000240: 6865 204c 6963 656e 7365 2e0a 2320 3d3d  he License..# ==
+00000250: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00000260: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00000270: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00000280: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00000290: 3d3d 3d3d 3d3d 3d3d 3d3d 0a22 2222 0a42  ==========.""".B
+000002a0: 6974 204d 6f64 656c 2e0a 2222 220a 6672  it Model..""".fr
+000002b0: 6f6d 202e 2069 6d70 6f72 7420 636f 6e66  om . import conf
+000002c0: 6967 7572 6174 696f 6e5f 6269 742c 206d  iguration_bit, m
+000002d0: 6f64 656c 696e 675f 6269 742c 2069 6d61  odeling_bit, ima
+000002e0: 6765 5f70 726f 6365 7373 696e 675f 6269  ge_processing_bi
+000002f0: 740a 6672 6f6d 202e 636f 6e66 6967 7572  t.from .configur
+00000300: 6174 696f 6e5f 6269 7420 696d 706f 7274  ation_bit import
+00000310: 202a 0a66 726f 6d20 2e6d 6f64 656c 696e   *.from .modelin
+00000320: 675f 6269 7420 696d 706f 7274 202a 0a66  g_bit import *.f
+00000330: 726f 6d20 2e69 6d61 6765 5f70 726f 6365  rom .image_proce
+00000340: 7373 696e 675f 6269 7420 696d 706f 7274  ssing_bit import
+00000350: 202a 0a0a 5f5f 616c 6c5f 5f20 3d20 5b5d   *..__all__ = []
+00000360: 0a5f 5f61 6c6c 5f5f 2e65 7874 656e 6428  .__all__.extend(
+00000370: 636f 6e66 6967 7572 6174 696f 6e5f 6269  configuration_bi
+00000380: 742e 5f5f 616c 6c5f 5f29 0a5f 5f61 6c6c  t.__all__).__all
+00000390: 5f5f 2e65 7874 656e 6428 6d6f 6465 6c69  __.extend(modeli
+000003a0: 6e67 5f62 6974 2e5f 5f61 6c6c 5f5f 290a  ng_bit.__all__).
+000003b0: 5f5f 616c 6c5f 5f2e 6578 7465 6e64 2869  __all__.extend(i
+000003c0: 6d61 6765 5f70 726f 6365 7373 696e 675f  mage_processing_
+000003d0: 6269 742e 5f5f 616c 6c5f 5f29 0a         bit.__all__).
```

## mindnlp/transformers/models/bit/configuration_bit.py

```diff
@@ -0,0 +1,394 @@
+00000000: 2320 636f 6469 6e67 3d75 7466 2d38 0a23  # coding=utf-8.#
+00000010: 2043 6f70 7972 6967 6874 2032 3032 3220   Copyright 2022 
+00000020: 5468 6520 4875 6767 696e 6746 6163 6520  The HuggingFace 
+00000030: 496e 632e 2074 6561 6d2e 2041 6c6c 2072  Inc. team. All r
+00000040: 6967 6874 7320 7265 7365 7276 6564 2e0a  ights reserved..
+00000050: 230a 2320 4c69 6365 6e73 6564 2075 6e64  #.# Licensed und
+00000060: 6572 2074 6865 2041 7061 6368 6520 4c69  er the Apache Li
+00000070: 6365 6e73 652c 2056 6572 7369 6f6e 2032  cense, Version 2
+00000080: 2e30 2028 7468 6520 224c 6963 656e 7365  .0 (the "License
+00000090: 2229 3b0a 2320 796f 7520 6d61 7920 6e6f  ");.# you may no
+000000a0: 7420 7573 6520 7468 6973 2066 696c 6520  t use this file 
+000000b0: 6578 6365 7074 2069 6e20 636f 6d70 6c69  except in compli
+000000c0: 616e 6365 2077 6974 6820 7468 6520 4c69  ance with the Li
+000000d0: 6365 6e73 652e 0a23 2059 6f75 206d 6179  cense..# You may
+000000e0: 206f 6274 6169 6e20 6120 636f 7079 206f   obtain a copy o
+000000f0: 6620 7468 6520 4c69 6365 6e73 6520 6174  f the License at
+00000100: 0a23 0a23 2020 2020 2068 7474 703a 2f2f  .#.#     http://
+00000110: 7777 772e 6170 6163 6865 2e6f 7267 2f6c  www.apache.org/l
+00000120: 6963 656e 7365 732f 4c49 4345 4e53 452d  icenses/LICENSE-
+00000130: 322e 300a 230a 2320 556e 6c65 7373 2072  2.0.#.# Unless r
+00000140: 6571 7569 7265 6420 6279 2061 7070 6c69  equired by appli
+00000150: 6361 626c 6520 6c61 7720 6f72 2061 6772  cable law or agr
+00000160: 6565 6420 746f 2069 6e20 7772 6974 696e  eed to in writin
+00000170: 672c 2073 6f66 7477 6172 650a 2320 6469  g, software.# di
+00000180: 7374 7269 6275 7465 6420 756e 6465 7220  stributed under 
+00000190: 7468 6520 4c69 6365 6e73 6520 6973 2064  the License is d
+000001a0: 6973 7472 6962 7574 6564 206f 6e20 616e  istributed on an
+000001b0: 2022 4153 2049 5322 2042 4153 4953 2c0a   "AS IS" BASIS,.
+000001c0: 2320 5749 5448 4f55 5420 5741 5252 414e  # WITHOUT WARRAN
+000001d0: 5449 4553 204f 5220 434f 4e44 4954 494f  TIES OR CONDITIO
+000001e0: 4e53 204f 4620 414e 5920 4b49 4e44 2c20  NS OF ANY KIND, 
+000001f0: 6569 7468 6572 2065 7870 7265 7373 206f  either express o
+00000200: 7220 696d 706c 6965 642e 0a23 2053 6565  r implied..# See
+00000210: 2074 6865 204c 6963 656e 7365 2066 6f72   the License for
+00000220: 2074 6865 2073 7065 6369 6669 6320 6c61   the specific la
+00000230: 6e67 7561 6765 2067 6f76 6572 6e69 6e67  nguage governing
+00000240: 2070 6572 6d69 7373 696f 6e73 2061 6e64   permissions and
+00000250: 0a23 206c 696d 6974 6174 696f 6e73 2075  .# limitations u
+00000260: 6e64 6572 2074 6865 204c 6963 656e 7365  nder the License
+00000270: 2e0a 2222 2220 4269 5420 6d6f 6465 6c20  ..""" BiT model 
+00000280: 636f 6e66 6967 7572 6174 696f 6e22 2222  configuration"""
+00000290: 0a0a 6672 6f6d 202e 2e2e 636f 6e66 6967  ..from ...config
+000002a0: 7572 6174 696f 6e5f 7574 696c 7320 696d  uration_utils im
+000002b0: 706f 7274 2050 7265 7472 6169 6e65 6443  port PretrainedC
+000002c0: 6f6e 6669 670a 6672 6f6d 202e 2e2e 2e75  onfig.from ....u
+000002d0: 7469 6c73 2069 6d70 6f72 7420 6c6f 6767  tils import logg
+000002e0: 696e 670a 6672 6f6d 202e 2e2e 2e75 7469  ing.from ....uti
+000002f0: 6c73 2e62 6163 6b62 6f6e 655f 7574 696c  ls.backbone_util
+00000300: 7320 696d 706f 7274 2042 6163 6b62 6f6e  s import Backbon
+00000310: 6543 6f6e 6669 674d 6978 696e 2c20 6765  eConfigMixin, ge
+00000320: 745f 616c 6967 6e65 645f 6f75 7470 7574  t_aligned_output
+00000330: 5f66 6561 7475 7265 735f 6f75 7470 7574  _features_output
+00000340: 5f69 6e64 6963 6573 0a0a 0a6c 6f67 6765  _indices...logge
+00000350: 7220 3d20 6c6f 6767 696e 672e 6765 745f  r = logging.get_
+00000360: 6c6f 6767 6572 285f 5f6e 616d 655f 5f29  logger(__name__)
+00000370: 0a0a 0a63 6c61 7373 2042 6974 436f 6e66  ...class BitConf
+00000380: 6967 2842 6163 6b62 6f6e 6543 6f6e 6669  ig(BackboneConfi
+00000390: 674d 6978 696e 2c20 5072 6574 7261 696e  gMixin, Pretrain
+000003a0: 6564 436f 6e66 6967 293a 0a20 2020 2072  edConfig):.    r
+000003b0: 2222 220a 2020 2020 5468 6973 2069 7320  """.    This is 
+000003c0: 7468 6520 636f 6e66 6967 7572 6174 696f  the configuratio
+000003d0: 6e20 636c 6173 7320 746f 2073 746f 7265  n class to store
+000003e0: 2074 6865 2063 6f6e 6669 6775 7261 7469   the configurati
+000003f0: 6f6e 206f 6620 6120 5b60 4269 744d 6f64  on of a [`BitMod
+00000400: 656c 605d 2e20 4974 2069 7320 7573 6564  el`]. It is used
+00000410: 2074 6f20 696e 7374 616e 7469 6174 6520   to instantiate 
+00000420: 616e 2042 6954 0a20 2020 206d 6f64 656c  an BiT.    model
+00000430: 2061 6363 6f72 6469 6e67 2074 6f20 7468   according to th
+00000440: 6520 7370 6563 6966 6965 6420 6172 6775  e specified argu
+00000450: 6d65 6e74 732c 2064 6566 696e 696e 6720  ments, defining 
+00000460: 7468 6520 6d6f 6465 6c20 6172 6368 6974  the model archit
+00000470: 6563 7475 7265 2e20 496e 7374 616e 7469  ecture. Instanti
+00000480: 6174 696e 6720 6120 636f 6e66 6967 7572  ating a configur
+00000490: 6174 696f 6e20 7769 7468 2074 6865 0a20  ation with the. 
+000004a0: 2020 2064 6566 6175 6c74 7320 7769 6c6c     defaults will
+000004b0: 2079 6965 6c64 2061 2073 696d 696c 6172   yield a similar
+000004c0: 2063 6f6e 6669 6775 7261 7469 6f6e 2074   configuration t
+000004d0: 6f20 7468 6174 206f 6620 7468 6520 4269  o that of the Bi
+000004e0: 540a 2020 2020 5b67 6f6f 676c 652f 6269  T.    [google/bi
+000004f0: 742d 3530 5d28 6874 7470 733a 2f2f 6875  t-50](https://hu
+00000500: 6767 696e 6766 6163 652e 636f 2f67 6f6f  ggingface.co/goo
+00000510: 676c 652f 6269 742d 3530 2920 6172 6368  gle/bit-50) arch
+00000520: 6974 6563 7475 7265 2e0a 0a20 2020 2043  itecture...    C
+00000530: 6f6e 6669 6775 7261 7469 6f6e 206f 626a  onfiguration obj
+00000540: 6563 7473 2069 6e68 6572 6974 2066 726f  ects inherit fro
+00000550: 6d20 5b60 5072 6574 7261 696e 6564 436f  m [`PretrainedCo
+00000560: 6e66 6967 605d 2061 6e64 2063 616e 2062  nfig`] and can b
+00000570: 6520 7573 6564 2074 6f20 636f 6e74 726f  e used to contro
+00000580: 6c20 7468 6520 6d6f 6465 6c20 6f75 7470  l the model outp
+00000590: 7574 732e 2052 6561 6420 7468 650a 2020  uts. Read the.  
+000005a0: 2020 646f 6375 6d65 6e74 6174 696f 6e20    documentation 
+000005b0: 6672 6f6d 205b 6050 7265 7472 6169 6e65  from [`Pretraine
+000005c0: 6443 6f6e 6669 6760 5d20 666f 7220 6d6f  dConfig`] for mo
+000005d0: 7265 2069 6e66 6f72 6d61 7469 6f6e 2e0a  re information..
+000005e0: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
+000005f0: 2020 206e 756d 5f63 6861 6e6e 656c 7320     num_channels 
+00000600: 2860 696e 7460 2c20 2a6f 7074 696f 6e61  (`int`, *optiona
+00000610: 6c2a 2c20 6465 6661 756c 7473 2074 6f20  l*, defaults to 
+00000620: 3329 3a0a 2020 2020 2020 2020 2020 2020  3):.            
+00000630: 5468 6520 6e75 6d62 6572 206f 6620 696e  The number of in
+00000640: 7075 7420 6368 616e 6e65 6c73 2e0a 2020  put channels..  
+00000650: 2020 2020 2020 656d 6265 6464 696e 675f        embedding_
+00000660: 7369 7a65 2028 6069 6e74 602c 202a 6f70  size (`int`, *op
+00000670: 7469 6f6e 616c 2a2c 2064 6566 6175 6c74  tional*, default
+00000680: 7320 746f 2036 3429 3a0a 2020 2020 2020  s to 64):.      
+00000690: 2020 2020 2020 4469 6d65 6e73 696f 6e61        Dimensiona
+000006a0: 6c69 7479 2028 6869 6464 656e 2073 697a  lity (hidden siz
+000006b0: 6529 2066 6f72 2074 6865 2065 6d62 6564  e) for the embed
+000006c0: 6469 6e67 206c 6179 6572 2e0a 2020 2020  ding layer..    
+000006d0: 2020 2020 6869 6464 656e 5f73 697a 6573      hidden_sizes
+000006e0: 2028 604c 6973 745b 696e 745d 602c 202a   (`List[int]`, *
+000006f0: 6f70 7469 6f6e 616c 2a2c 2064 6566 6175  optional*, defau
+00000700: 6c74 7320 746f 2060 5b32 3536 2c20 3531  lts to `[256, 51
+00000710: 322c 2031 3032 342c 2032 3034 385d 6029  2, 1024, 2048]`)
+00000720: 3a0a 2020 2020 2020 2020 2020 2020 4469  :.            Di
+00000730: 6d65 6e73 696f 6e61 6c69 7479 2028 6869  mensionality (hi
+00000740: 6464 656e 2073 697a 6529 2061 7420 6561  dden size) at ea
+00000750: 6368 2073 7461 6765 2e0a 2020 2020 2020  ch stage..      
+00000760: 2020 6465 7074 6873 2028 604c 6973 745b    depths (`List[
+00000770: 696e 745d 602c 202a 6f70 7469 6f6e 616c  int]`, *optional
+00000780: 2a2c 2064 6566 6175 6c74 7320 746f 2060  *, defaults to `
+00000790: 5b33 2c20 342c 2036 2c20 335d 6029 3a0a  [3, 4, 6, 3]`):.
+000007a0: 2020 2020 2020 2020 2020 2020 4465 7074              Dept
+000007b0: 6820 286e 756d 6265 7220 6f66 206c 6179  h (number of lay
+000007c0: 6572 7329 2066 6f72 2065 6163 6820 7374  ers) for each st
+000007d0: 6167 652e 0a20 2020 2020 2020 206c 6179  age..        lay
+000007e0: 6572 5f74 7970 6520 2860 7374 7260 2c20  er_type (`str`, 
+000007f0: 2a6f 7074 696f 6e61 6c2a 2c20 6465 6661  *optional*, defa
+00000800: 756c 7473 2074 6f20 6022 7072 6561 6374  ults to `"preact
+00000810: 6976 6174 696f 6e22 6029 3a0a 2020 2020  ivation"`):.    
+00000820: 2020 2020 2020 2020 5468 6520 6c61 7965          The laye
+00000830: 7220 746f 2075 7365 2c20 6974 2063 616e  r to use, it can
+00000840: 2062 6520 6569 7468 6572 2060 2270 7265   be either `"pre
+00000850: 6163 7469 7661 7469 6f6e 2260 206f 7220  activation"` or 
+00000860: 6022 626f 7474 6c65 6e65 636b 2260 2e0a  `"bottleneck"`..
+00000870: 2020 2020 2020 2020 6869 6464 656e 5f61          hidden_a
+00000880: 6374 2028 6073 7472 602c 202a 6f70 7469  ct (`str`, *opti
+00000890: 6f6e 616c 2a2c 2064 6566 6175 6c74 7320  onal*, defaults 
+000008a0: 746f 2060 2272 656c 7522 6029 3a0a 2020  to `"relu"`):.  
+000008b0: 2020 2020 2020 2020 2020 5468 6520 6e6f            The no
+000008c0: 6e2d 6c69 6e65 6172 2061 6374 6976 6174  n-linear activat
+000008d0: 696f 6e20 6675 6e63 7469 6f6e 2069 6e20  ion function in 
+000008e0: 6561 6368 2062 6c6f 636b 2e20 4966 2073  each block. If s
+000008f0: 7472 696e 672c 2060 2267 656c 7522 602c  tring, `"gelu"`,
+00000900: 2060 2272 656c 7522 602c 2060 2273 656c   `"relu"`, `"sel
+00000910: 7522 6020 616e 6420 6022 6765 6c75 5f6e  u"` and `"gelu_n
+00000920: 6577 2260 0a20 2020 2020 2020 2020 2020  ew"`.           
+00000930: 2061 7265 2073 7570 706f 7274 6564 2e0a   are supported..
+00000940: 2020 2020 2020 2020 676c 6f62 616c 5f70          global_p
+00000950: 6164 6469 6e67 2028 6073 7472 602c 202a  adding (`str`, *
+00000960: 6f70 7469 6f6e 616c 2a29 3a0a 2020 2020  optional*):.    
+00000970: 2020 2020 2020 2020 5061 6464 696e 6720          Padding 
+00000980: 7374 7261 7465 6779 2074 6f20 7573 6520  strategy to use 
+00000990: 666f 7220 7468 6520 636f 6e76 6f6c 7574  for the convolut
+000009a0: 696f 6e61 6c20 6c61 7965 7273 2e20 4361  ional layers. Ca
+000009b0: 6e20 6265 2065 6974 6865 7220 6022 7661  n be either `"va
+000009c0: 6c69 6422 602c 2060 2273 616d 6522 602c  lid"`, `"same"`,
+000009d0: 206f 7220 604e 6f6e 6560 2e0a 2020 2020   or `None`..    
+000009e0: 2020 2020 6e75 6d5f 6772 6f75 7073 2028      num_groups (
+000009f0: 6069 6e74 602c 202a 6f70 7469 6f6e 616c  `int`, *optional
+00000a00: 2a2c 2064 6566 6175 6c74 7320 746f 2033  *, defaults to 3
+00000a10: 3229 3a0a 2020 2020 2020 2020 2020 2020  2):.            
+00000a20: 4e75 6d62 6572 206f 6620 6772 6f75 7073  Number of groups
+00000a30: 2075 7365 6420 666f 7220 7468 6520 6042   used for the `B
+00000a40: 6974 4772 6f75 704e 6f72 6d41 6374 6976  itGroupNormActiv
+00000a50: 6174 696f 6e60 206c 6179 6572 732e 0a20  ation` layers.. 
+00000a60: 2020 2020 2020 2064 726f 705f 7061 7468         drop_path
+00000a70: 5f72 6174 6520 2860 666c 6f61 7460 2c20  _rate (`float`, 
+00000a80: 2a6f 7074 696f 6e61 6c2a 2c20 6465 6661  *optional*, defa
+00000a90: 756c 7473 2074 6f20 302e 3029 3a0a 2020  ults to 0.0):.  
+00000aa0: 2020 2020 2020 2020 2020 5468 6520 6472            The dr
+00000ab0: 6f70 2070 6174 6820 7261 7465 2066 6f72  op path rate for
+00000ac0: 2074 6865 2073 746f 6368 6173 7469 6320   the stochastic 
+00000ad0: 6465 7074 682e 0a20 2020 2020 2020 2065  depth..        e
+00000ae0: 6d62 6564 6469 6e67 5f64 796e 616d 6963  mbedding_dynamic
+00000af0: 5f70 6164 6469 6e67 2028 6062 6f6f 6c60  _padding (`bool`
+00000b00: 2c20 2a6f 7074 696f 6e61 6c2a 2c20 6465  , *optional*, de
+00000b10: 6661 756c 7473 2074 6f20 6046 616c 7365  faults to `False
+00000b20: 6029 3a0a 2020 2020 2020 2020 2020 2020  `):.            
+00000b30: 5768 6574 6865 7220 6f72 206e 6f74 2074  Whether or not t
+00000b40: 6f20 6d61 6b65 2075 7365 206f 6620 6479  o make use of dy
+00000b50: 6e61 6d69 6320 7061 6464 696e 6720 666f  namic padding fo
+00000b60: 7220 7468 6520 656d 6265 6464 696e 6720  r the embedding 
+00000b70: 6c61 7965 722e 0a20 2020 2020 2020 206f  layer..        o
+00000b80: 7574 7075 745f 7374 7269 6465 2028 6069  utput_stride (`i
+00000b90: 6e74 602c 202a 6f70 7469 6f6e 616c 2a2c  nt`, *optional*,
+00000ba0: 2064 6566 6175 6c74 7320 746f 2033 3229   defaults to 32)
+00000bb0: 3a0a 2020 2020 2020 2020 2020 2020 5468  :.            Th
+00000bc0: 6520 6f75 7470 7574 2073 7472 6964 6520  e output stride 
+00000bd0: 6f66 2074 6865 206d 6f64 656c 2e0a 2020  of the model..  
+00000be0: 2020 2020 2020 7769 6474 685f 6661 6374        width_fact
+00000bf0: 6f72 2028 6069 6e74 602c 202a 6f70 7469  or (`int`, *opti
+00000c00: 6f6e 616c 2a2c 2064 6566 6175 6c74 7320  onal*, defaults 
+00000c10: 746f 2031 293a 0a20 2020 2020 2020 2020  to 1):.         
+00000c20: 2020 2054 6865 2077 6964 7468 2066 6163     The width fac
+00000c30: 746f 7220 666f 7220 7468 6520 6d6f 6465  tor for the mode
+00000c40: 6c2e 0a20 2020 2020 2020 206f 7574 5f66  l..        out_f
+00000c50: 6561 7475 7265 7320 2860 4c69 7374 5b73  eatures (`List[s
+00000c60: 7472 5d60 2c20 2a6f 7074 696f 6e61 6c2a  tr]`, *optional*
+00000c70: 293a 0a20 2020 2020 2020 2020 2020 2049  ):.            I
+00000c80: 6620 7573 6564 2061 7320 6261 636b 626f  f used as backbo
+00000c90: 6e65 2c20 6c69 7374 206f 6620 6665 6174  ne, list of feat
+00000ca0: 7572 6573 2074 6f20 6f75 7470 7574 2e20  ures to output. 
+00000cb0: 4361 6e20 6265 2061 6e79 206f 6620 6022  Can be any of `"
+00000cc0: 7374 656d 2260 2c20 6022 7374 6167 6531  stem"`, `"stage1
+00000cd0: 2260 2c20 6022 7374 6167 6532 2260 2c20  "`, `"stage2"`, 
+00000ce0: 6574 632e 0a20 2020 2020 2020 2020 2020  etc..           
+00000cf0: 2028 6465 7065 6e64 696e 6720 6f6e 2068   (depending on h
+00000d00: 6f77 206d 616e 7920 7374 6167 6573 2074  ow many stages t
+00000d10: 6865 206d 6f64 656c 2068 6173 292e 2049  he model has). I
+00000d20: 6620 756e 7365 7420 616e 6420 606f 7574  f unset and `out
+00000d30: 5f69 6e64 6963 6573 6020 6973 2073 6574  _indices` is set
+00000d40: 2c20 7769 6c6c 2064 6566 6175 6c74 2074  , will default t
+00000d50: 6f20 7468 650a 2020 2020 2020 2020 2020  o the.          
+00000d60: 2020 636f 7272 6573 706f 6e64 696e 6720    corresponding 
+00000d70: 7374 6167 6573 2e20 4966 2075 6e73 6574  stages. If unset
+00000d80: 2061 6e64 2060 6f75 745f 696e 6469 6365   and `out_indice
+00000d90: 7360 2069 7320 756e 7365 742c 2077 696c  s` is unset, wil
+00000da0: 6c20 6465 6661 756c 7420 746f 2074 6865  l default to the
+00000db0: 206c 6173 7420 7374 6167 652e 204d 7573   last stage. Mus
+00000dc0: 7420 6265 2069 6e20 7468 650a 2020 2020  t be in the.    
+00000dd0: 2020 2020 2020 2020 7361 6d65 206f 7264          same ord
+00000de0: 6572 2061 7320 6465 6669 6e65 6420 696e  er as defined in
+00000df0: 2074 6865 2060 7374 6167 655f 6e61 6d65   the `stage_name
+00000e00: 7360 2061 7474 7269 6275 7465 2e0a 2020  s` attribute..  
+00000e10: 2020 2020 2020 6f75 745f 696e 6469 6365        out_indice
+00000e20: 7320 2860 4c69 7374 5b69 6e74 5d60 2c20  s (`List[int]`, 
+00000e30: 2a6f 7074 696f 6e61 6c2a 293a 0a20 2020  *optional*):.   
+00000e40: 2020 2020 2020 2020 2049 6620 7573 6564           If used
+00000e50: 2061 7320 6261 636b 626f 6e65 2c20 6c69   as backbone, li
+00000e60: 7374 206f 6620 696e 6469 6365 7320 6f66  st of indices of
+00000e70: 2066 6561 7475 7265 7320 746f 206f 7574   features to out
+00000e80: 7075 742e 2043 616e 2062 6520 616e 7920  put. Can be any 
+00000e90: 6f66 2030 2c20 312c 2032 2c20 6574 632e  of 0, 1, 2, etc.
+00000ea0: 2028 6465 7065 6e64 696e 6720 6f6e 2068   (depending on h
+00000eb0: 6f77 0a20 2020 2020 2020 2020 2020 206d  ow.            m
+00000ec0: 616e 7920 7374 6167 6573 2074 6865 206d  any stages the m
+00000ed0: 6f64 656c 2068 6173 292e 2049 6620 756e  odel has). If un
+00000ee0: 7365 7420 616e 6420 606f 7574 5f66 6561  set and `out_fea
+00000ef0: 7475 7265 7360 2069 7320 7365 742c 2077  tures` is set, w
+00000f00: 696c 6c20 6465 6661 756c 7420 746f 2074  ill default to t
+00000f10: 6865 2063 6f72 7265 7370 6f6e 6469 6e67  he corresponding
+00000f20: 2073 7461 6765 732e 0a20 2020 2020 2020   stages..       
+00000f30: 2020 2020 2049 6620 756e 7365 7420 616e       If unset an
+00000f40: 6420 606f 7574 5f66 6561 7475 7265 7360  d `out_features`
+00000f50: 2069 7320 756e 7365 742c 2077 696c 6c20   is unset, will 
+00000f60: 6465 6661 756c 7420 746f 2074 6865 206c  default to the l
+00000f70: 6173 7420 7374 6167 652e 204d 7573 7420  ast stage. Must 
+00000f80: 6265 2069 6e20 7468 650a 2020 2020 2020  be in the.      
+00000f90: 2020 2020 2020 7361 6d65 206f 7264 6572        same order
+00000fa0: 2061 7320 6465 6669 6e65 6420 696e 2074   as defined in t
+00000fb0: 6865 2060 7374 6167 655f 6e61 6d65 7360  he `stage_names`
+00000fc0: 2061 7474 7269 6275 7465 2e0a 0a20 2020   attribute...   
+00000fd0: 2045 7861 6d70 6c65 3a0a 2020 2020 6060   Example:.    ``
+00000fe0: 6070 7974 686f 6e0a 2020 2020 3e3e 3e20  `python.    >>> 
+00000ff0: 6672 6f6d 2074 7261 6e73 666f 726d 6572  from transformer
+00001000: 7320 696d 706f 7274 2042 6974 436f 6e66  s import BitConf
+00001010: 6967 2c20 4269 744d 6f64 656c 0a0a 2020  ig, BitModel..  
+00001020: 2020 3e3e 3e20 2320 496e 6974 6961 6c69    >>> # Initiali
+00001030: 7a69 6e67 2061 2042 6954 2062 6974 2d35  zing a BiT bit-5
+00001040: 3020 7374 796c 6520 636f 6e66 6967 7572  0 style configur
+00001050: 6174 696f 6e0a 2020 2020 3e3e 3e20 636f  ation.    >>> co
+00001060: 6e66 6967 7572 6174 696f 6e20 3d20 4269  nfiguration = Bi
+00001070: 7443 6f6e 6669 6728 290a 0a20 2020 203e  tConfig()..    >
+00001080: 3e3e 2023 2049 6e69 7469 616c 697a 696e  >> # Initializin
+00001090: 6720 6120 6d6f 6465 6c20 2877 6974 6820  g a model (with 
+000010a0: 7261 6e64 6f6d 2077 6569 6768 7473 2920  random weights) 
+000010b0: 6672 6f6d 2074 6865 2062 6974 2d35 3020  from the bit-50 
+000010c0: 7374 796c 6520 636f 6e66 6967 7572 6174  style configurat
+000010d0: 696f 6e0a 2020 2020 3e3e 3e20 6d6f 6465  ion.    >>> mode
+000010e0: 6c20 3d20 4269 744d 6f64 656c 2863 6f6e  l = BitModel(con
+000010f0: 6669 6775 7261 7469 6f6e 290a 0a20 2020  figuration)..   
+00001100: 203e 3e3e 2023 2041 6363 6573 7369 6e67   >>> # Accessing
+00001110: 2074 6865 206d 6f64 656c 2063 6f6e 6669   the model confi
+00001120: 6775 7261 7469 6f6e 0a20 2020 203e 3e3e  guration.    >>>
+00001130: 2063 6f6e 6669 6775 7261 7469 6f6e 203d   configuration =
+00001140: 206d 6f64 656c 2e63 6f6e 6669 670a 2020   model.config.  
+00001150: 2020 6060 600a 2020 2020 2222 220a 0a20    ```.    """.. 
+00001160: 2020 206d 6f64 656c 5f74 7970 6520 3d20     model_type = 
+00001170: 2262 6974 220a 2020 2020 6c61 7965 725f  "bit".    layer_
+00001180: 7479 7065 7320 3d20 5b22 7072 6561 6374  types = ["preact
+00001190: 6976 6174 696f 6e22 2c20 2262 6f74 746c  ivation", "bottl
+000011a0: 656e 6563 6b22 5d0a 2020 2020 7375 7070  eneck"].    supp
+000011b0: 6f72 7465 645f 7061 6464 696e 6720 3d20  orted_padding = 
+000011c0: 5b22 5341 4d45 222c 2022 5641 4c49 4422  ["SAME", "VALID"
+000011d0: 5d0a 0a20 2020 2064 6566 205f 5f69 6e69  ]..    def __ini
+000011e0: 745f 5f28 0a20 2020 2020 2020 2073 656c  t__(.        sel
+000011f0: 662c 0a20 2020 2020 2020 206e 756d 5f63  f,.        num_c
+00001200: 6861 6e6e 656c 733d 332c 0a20 2020 2020  hannels=3,.     
+00001210: 2020 2065 6d62 6564 6469 6e67 5f73 697a     embedding_siz
+00001220: 653d 3634 2c0a 2020 2020 2020 2020 6869  e=64,.        hi
+00001230: 6464 656e 5f73 697a 6573 3d5b 3235 362c  dden_sizes=[256,
+00001240: 2035 3132 2c20 3130 3234 2c20 3230 3438   512, 1024, 2048
+00001250: 5d2c 0a20 2020 2020 2020 2064 6570 7468  ],.        depth
+00001260: 733d 5b33 2c20 342c 2036 2c20 335d 2c0a  s=[3, 4, 6, 3],.
+00001270: 2020 2020 2020 2020 6c61 7965 725f 7479          layer_ty
+00001280: 7065 3d22 7072 6561 6374 6976 6174 696f  pe="preactivatio
+00001290: 6e22 2c0a 2020 2020 2020 2020 6869 6464  n",.        hidd
+000012a0: 656e 5f61 6374 3d22 7265 6c75 222c 0a20  en_act="relu",. 
+000012b0: 2020 2020 2020 2067 6c6f 6261 6c5f 7061         global_pa
+000012c0: 6464 696e 673d 4e6f 6e65 2c0a 2020 2020  dding=None,.    
+000012d0: 2020 2020 6e75 6d5f 6772 6f75 7073 3d33      num_groups=3
+000012e0: 322c 0a20 2020 2020 2020 2064 726f 705f  2,.        drop_
+000012f0: 7061 7468 5f72 6174 653d 302e 302c 0a20  path_rate=0.0,. 
+00001300: 2020 2020 2020 2065 6d62 6564 6469 6e67         embedding
+00001310: 5f64 796e 616d 6963 5f70 6164 6469 6e67  _dynamic_padding
+00001320: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
+00001330: 6f75 7470 7574 5f73 7472 6964 653d 3332  output_stride=32
+00001340: 2c0a 2020 2020 2020 2020 7769 6474 685f  ,.        width_
+00001350: 6661 6374 6f72 3d31 2c0a 2020 2020 2020  factor=1,.      
+00001360: 2020 6f75 745f 6665 6174 7572 6573 3d4e    out_features=N
+00001370: 6f6e 652c 0a20 2020 2020 2020 206f 7574  one,.        out
+00001380: 5f69 6e64 6963 6573 3d4e 6f6e 652c 0a20  _indices=None,. 
+00001390: 2020 2020 2020 202a 2a6b 7761 7267 732c         **kwargs,
+000013a0: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
+000013b0: 7375 7065 7228 292e 5f5f 696e 6974 5f5f  super().__init__
+000013c0: 282a 2a6b 7761 7267 7329 0a20 2020 2020  (**kwargs).     
+000013d0: 2020 2069 6620 6c61 7965 725f 7479 7065     if layer_type
+000013e0: 206e 6f74 2069 6e20 7365 6c66 2e6c 6179   not in self.lay
+000013f0: 6572 5f74 7970 6573 3a0a 2020 2020 2020  er_types:.      
+00001400: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
+00001410: 6545 7272 6f72 2866 226c 6179 6572 5f74  eError(f"layer_t
+00001420: 7970 653d 7b6c 6179 6572 5f74 7970 657d  ype={layer_type}
+00001430: 2069 7320 6e6f 7420 6f6e 6520 6f66 207b   is not one of {
+00001440: 272c 272e 6a6f 696e 2873 656c 662e 6c61  ','.join(self.la
+00001450: 7965 725f 7479 7065 7329 7d22 290a 2020  yer_types)}").  
+00001460: 2020 2020 2020 6966 2067 6c6f 6261 6c5f        if global_
+00001470: 7061 6464 696e 6720 6973 206e 6f74 204e  padding is not N
+00001480: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00001490: 2069 6620 676c 6f62 616c 5f70 6164 6469   if global_paddi
+000014a0: 6e67 2e75 7070 6572 2829 2069 6e20 7365  ng.upper() in se
+000014b0: 6c66 2e73 7570 706f 7274 6564 5f70 6164  lf.supported_pad
+000014c0: 6469 6e67 3a0a 2020 2020 2020 2020 2020  ding:.          
+000014d0: 2020 2020 2020 676c 6f62 616c 5f70 6164        global_pad
+000014e0: 6469 6e67 203d 2067 6c6f 6261 6c5f 7061  ding = global_pa
+000014f0: 6464 696e 672e 7570 7065 7228 290a 2020  dding.upper().  
+00001500: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00001510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001520: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+00001530: 2866 2250 6164 6469 6e67 2073 7472 6174  (f"Padding strat
+00001540: 6567 7920 7b67 6c6f 6261 6c5f 7061 6464  egy {global_padd
+00001550: 696e 677d 206e 6f74 2073 7570 706f 7274  ing} not support
+00001560: 6564 2229 0a20 2020 2020 2020 2073 656c  ed").        sel
+00001570: 662e 6e75 6d5f 6368 616e 6e65 6c73 203d  f.num_channels =
+00001580: 206e 756d 5f63 6861 6e6e 656c 730a 2020   num_channels.  
+00001590: 2020 2020 2020 7365 6c66 2e65 6d62 6564        self.embed
+000015a0: 6469 6e67 5f73 697a 6520 3d20 656d 6265  ding_size = embe
+000015b0: 6464 696e 675f 7369 7a65 0a20 2020 2020  dding_size.     
+000015c0: 2020 2073 656c 662e 6869 6464 656e 5f73     self.hidden_s
+000015d0: 697a 6573 203d 2068 6964 6465 6e5f 7369  izes = hidden_si
+000015e0: 7a65 730a 2020 2020 2020 2020 7365 6c66  zes.        self
+000015f0: 2e64 6570 7468 7320 3d20 6465 7074 6873  .depths = depths
+00001600: 0a20 2020 2020 2020 2073 656c 662e 6c61  .        self.la
+00001610: 7965 725f 7479 7065 203d 206c 6179 6572  yer_type = layer
+00001620: 5f74 7970 650a 2020 2020 2020 2020 7365  _type.        se
+00001630: 6c66 2e68 6964 6465 6e5f 6163 7420 3d20  lf.hidden_act = 
+00001640: 6869 6464 656e 5f61 6374 0a20 2020 2020  hidden_act.     
+00001650: 2020 2073 656c 662e 676c 6f62 616c 5f70     self.global_p
+00001660: 6164 6469 6e67 203d 2067 6c6f 6261 6c5f  adding = global_
+00001670: 7061 6464 696e 670a 2020 2020 2020 2020  padding.        
+00001680: 7365 6c66 2e6e 756d 5f67 726f 7570 7320  self.num_groups 
+00001690: 3d20 6e75 6d5f 6772 6f75 7073 0a20 2020  = num_groups.   
+000016a0: 2020 2020 2073 656c 662e 6472 6f70 5f70       self.drop_p
+000016b0: 6174 685f 7261 7465 203d 2064 726f 705f  ath_rate = drop_
+000016c0: 7061 7468 5f72 6174 650a 2020 2020 2020  path_rate.      
+000016d0: 2020 7365 6c66 2e65 6d62 6564 6469 6e67    self.embedding
+000016e0: 5f64 796e 616d 6963 5f70 6164 6469 6e67  _dynamic_padding
+000016f0: 203d 2065 6d62 6564 6469 6e67 5f64 796e   = embedding_dyn
+00001700: 616d 6963 5f70 6164 6469 6e67 0a20 2020  amic_padding.   
+00001710: 2020 2020 2073 656c 662e 6f75 7470 7574       self.output
+00001720: 5f73 7472 6964 6520 3d20 6f75 7470 7574  _stride = output
+00001730: 5f73 7472 6964 650a 2020 2020 2020 2020  _stride.        
+00001740: 7365 6c66 2e77 6964 7468 5f66 6163 746f  self.width_facto
+00001750: 7220 3d20 7769 6474 685f 6661 6374 6f72  r = width_factor
+00001760: 0a0a 2020 2020 2020 2020 7365 6c66 2e73  ..        self.s
+00001770: 7461 6765 5f6e 616d 6573 203d 205b 2273  tage_names = ["s
+00001780: 7465 6d22 5d20 2b20 5b66 2273 7461 6765  tem"] + [f"stage
+00001790: 7b69 6478 7d22 2066 6f72 2069 6478 2069  {idx}" for idx i
+000017a0: 6e20 7261 6e67 6528 312c 206c 656e 2864  n range(1, len(d
+000017b0: 6570 7468 7329 202b 2031 295d 0a20 2020  epths) + 1)].   
+000017c0: 2020 2020 2073 656c 662e 5f6f 7574 5f66       self._out_f
+000017d0: 6561 7475 7265 732c 2073 656c 662e 5f6f  eatures, self._o
+000017e0: 7574 5f69 6e64 6963 6573 203d 2067 6574  ut_indices = get
+000017f0: 5f61 6c69 676e 6564 5f6f 7574 7075 745f  _aligned_output_
+00001800: 6665 6174 7572 6573 5f6f 7574 7075 745f  features_output_
+00001810: 696e 6469 6365 7328 0a20 2020 2020 2020  indices(.       
+00001820: 2020 2020 206f 7574 5f66 6561 7475 7265       out_feature
+00001830: 733d 6f75 745f 6665 6174 7572 6573 2c20  s=out_features, 
+00001840: 6f75 745f 696e 6469 6365 733d 6f75 745f  out_indices=out_
+00001850: 696e 6469 6365 732c 2073 7461 6765 5f6e  indices, stage_n
+00001860: 616d 6573 3d73 656c 662e 7374 6167 655f  ames=self.stage_
+00001870: 6e61 6d65 730a 2020 2020 2020 2020 290a  names.        ).
+00001880: 0a5f 5f61 6c6c 5f5f 203d 205b 2742 6974  .__all__ = ['Bit
+00001890: 436f 6e66 6967 275d 0a                   Config'].
```

## mindnlp/transformers/models/bit/image_processing_bit.py

```diff
@@ -0,0 +1,1028 @@
+00000000: 2320 636f 6469 6e67 3d75 7466 2d38 0a23  # coding=utf-8.#
+00000010: 2043 6f70 7972 6967 6874 2032 3032 3220   Copyright 2022 
+00000020: 5468 6520 4875 6767 696e 6746 6163 6520  The HuggingFace 
+00000030: 496e 632e 2074 6561 6d2e 2041 6c6c 2072  Inc. team. All r
+00000040: 6967 6874 7320 7265 7365 7276 6564 2e0a  ights reserved..
+00000050: 230a 2320 4c69 6365 6e73 6564 2075 6e64  #.# Licensed und
+00000060: 6572 2074 6865 2041 7061 6368 6520 4c69  er the Apache Li
+00000070: 6365 6e73 652c 2056 6572 7369 6f6e 2032  cense, Version 2
+00000080: 2e30 2028 7468 6520 224c 6963 656e 7365  .0 (the "License
+00000090: 2229 3b0a 2320 796f 7520 6d61 7920 6e6f  ");.# you may no
+000000a0: 7420 7573 6520 7468 6973 2066 696c 6520  t use this file 
+000000b0: 6578 6365 7074 2069 6e20 636f 6d70 6c69  except in compli
+000000c0: 616e 6365 2077 6974 6820 7468 6520 4c69  ance with the Li
+000000d0: 6365 6e73 652e 0a23 2059 6f75 206d 6179  cense..# You may
+000000e0: 206f 6274 6169 6e20 6120 636f 7079 206f   obtain a copy o
+000000f0: 6620 7468 6520 4c69 6365 6e73 6520 6174  f the License at
+00000100: 0a23 0a23 2020 2020 2068 7474 703a 2f2f  .#.#     http://
+00000110: 7777 772e 6170 6163 6865 2e6f 7267 2f6c  www.apache.org/l
+00000120: 6963 656e 7365 732f 4c49 4345 4e53 452d  icenses/LICENSE-
+00000130: 322e 300a 230a 2320 556e 6c65 7373 2072  2.0.#.# Unless r
+00000140: 6571 7569 7265 6420 6279 2061 7070 6c69  equired by appli
+00000150: 6361 626c 6520 6c61 7720 6f72 2061 6772  cable law or agr
+00000160: 6565 6420 746f 2069 6e20 7772 6974 696e  eed to in writin
+00000170: 672c 2073 6f66 7477 6172 650a 2320 6469  g, software.# di
+00000180: 7374 7269 6275 7465 6420 756e 6465 7220  stributed under 
+00000190: 7468 6520 4c69 6365 6e73 6520 6973 2064  the License is d
+000001a0: 6973 7472 6962 7574 6564 206f 6e20 616e  istributed on an
+000001b0: 2022 4153 2049 5322 2042 4153 4953 2c0a   "AS IS" BASIS,.
+000001c0: 2320 5749 5448 4f55 5420 5741 5252 414e  # WITHOUT WARRAN
+000001d0: 5449 4553 204f 5220 434f 4e44 4954 494f  TIES OR CONDITIO
+000001e0: 4e53 204f 4620 414e 5920 4b49 4e44 2c20  NS OF ANY KIND, 
+000001f0: 6569 7468 6572 2065 7870 7265 7373 206f  either express o
+00000200: 7220 696d 706c 6965 642e 0a23 2053 6565  r implied..# See
+00000210: 2074 6865 204c 6963 656e 7365 2066 6f72   the License for
+00000220: 2074 6865 2073 7065 6369 6669 6320 6c61   the specific la
+00000230: 6e67 7561 6765 2067 6f76 6572 6e69 6e67  nguage governing
+00000240: 2070 6572 6d69 7373 696f 6e73 2061 6e64   permissions and
+00000250: 0a23 206c 696d 6974 6174 696f 6e73 2075  .# limitations u
+00000260: 6e64 6572 2074 6865 204c 6963 656e 7365  nder the License
+00000270: 2e0a 2222 2249 6d61 6765 2070 726f 6365  .."""Image proce
+00000280: 7373 6f72 2063 6c61 7373 2066 6f72 2042  ssor class for B
+00000290: 6954 2e22 2222 0a0a 6672 6f6d 2074 7970  iT."""..from typ
+000002a0: 696e 6720 696d 706f 7274 2044 6963 742c  ing import Dict,
+000002b0: 204c 6973 742c 204f 7074 696f 6e61 6c2c   List, Optional,
+000002c0: 2055 6e69 6f6e 0a0a 696d 706f 7274 206e   Union..import n
+000002d0: 756d 7079 2061 7320 6e70 0a0a 6672 6f6d  umpy as np..from
+000002e0: 206d 696e 646e 6c70 2e63 6f6e 6669 6773   mindnlp.configs
+000002f0: 2069 6d70 6f72 7420 4f50 454e 4149 5f43   import OPENAI_C
+00000300: 4c49 505f 4d45 414e 2c20 4f50 454e 4149  LIP_MEAN, OPENAI
+00000310: 5f43 4c49 505f 5354 440a 6672 6f6d 202e  _CLIP_STD.from .
+00000320: 2e2e 696d 6167 655f 7072 6f63 6573 7369  ..image_processi
+00000330: 6e67 5f75 7469 6c73 2069 6d70 6f72 7420  ng_utils import 
+00000340: 4261 7365 496d 6167 6550 726f 6365 7373  BaseImageProcess
+00000350: 6f72 2c20 4261 7463 6846 6561 7475 7265  or, BatchFeature
+00000360: 2c20 6765 745f 7369 7a65 5f64 6963 740a  , get_size_dict.
+00000370: 6672 6f6d 202e 2e2e 696d 6167 655f 7472  from ...image_tr
+00000380: 616e 7366 6f72 6d73 2069 6d70 6f72 7420  ansforms import 
+00000390: 280a 2020 2020 636f 6e76 6572 745f 746f  (.    convert_to
+000003a0: 5f72 6762 2c0a 2020 2020 6765 745f 7265  _rgb,.    get_re
+000003b0: 7369 7a65 5f6f 7574 7075 745f 696d 6167  size_output_imag
+000003c0: 655f 7369 7a65 2c0a 2020 2020 7265 7369  e_size,.    resi
+000003d0: 7a65 2c0a 2020 2020 746f 5f63 6861 6e6e  ze,.    to_chann
+000003e0: 656c 5f64 696d 656e 7369 6f6e 5f66 6f72  el_dimension_for
+000003f0: 6d61 742c 0a29 0a66 726f 6d20 2e2e 2e69  mat,.).from ...i
+00000400: 6d61 6765 5f75 7469 6c73 2069 6d70 6f72  mage_utils impor
+00000410: 7420 280a 2020 2020 4368 616e 6e65 6c44  t (.    ChannelD
+00000420: 696d 656e 7369 6f6e 2c0a 2020 2020 496d  imension,.    Im
+00000430: 6167 6549 6e70 7574 2c0a 2020 2020 5049  ageInput,.    PI
+00000440: 4c49 6d61 6765 5265 7361 6d70 6c69 6e67  LImageResampling
+00000450: 2c0a 2020 2020 696e 6665 725f 6368 616e  ,.    infer_chan
+00000460: 6e65 6c5f 6469 6d65 6e73 696f 6e5f 666f  nel_dimension_fo
+00000470: 726d 6174 2c0a 2020 2020 6973 5f73 6361  rmat,.    is_sca
+00000480: 6c65 645f 696d 6167 652c 0a20 2020 206d  led_image,.    m
+00000490: 616b 655f 6c69 7374 5f6f 665f 696d 6167  ake_list_of_imag
+000004a0: 6573 2c0a 2020 2020 746f 5f6e 756d 7079  es,.    to_numpy
+000004b0: 5f61 7272 6179 2c0a 2020 2020 7661 6c69  _array,.    vali
+000004c0: 645f 696d 6167 6573 2c0a 2020 2020 7661  d_images,.    va
+000004d0: 6c69 6461 7465 5f6b 7761 7267 732c 0a20  lidate_kwargs,. 
+000004e0: 2020 2076 616c 6964 6174 655f 7072 6570     validate_prep
+000004f0: 726f 6365 7373 5f61 7267 756d 656e 7473  rocess_arguments
+00000500: 2c0a 290a 6672 6f6d 202e 2e2e 2e75 7469  ,.).from ....uti
+00000510: 6c73 2069 6d70 6f72 7420 5465 6e73 6f72  ls import Tensor
+00000520: 5479 7065 2c20 6973 5f76 6973 696f 6e5f  Type, is_vision_
+00000530: 6176 6169 6c61 626c 652c 206c 6f67 6769  available, loggi
+00000540: 6e67 0a0a 0a6c 6f67 6765 7220 3d20 6c6f  ng...logger = lo
+00000550: 6767 696e 672e 6765 745f 6c6f 6767 6572  gging.get_logger
+00000560: 285f 5f6e 616d 655f 5f29 0a0a 0a69 6620  (__name__)...if 
+00000570: 6973 5f76 6973 696f 6e5f 6176 6169 6c61  is_vision_availa
+00000580: 626c 6528 293a 0a20 2020 2069 6d70 6f72  ble():.    impor
+00000590: 7420 5049 4c0a 0a0a 636c 6173 7320 4269  t PIL...class Bi
+000005a0: 7449 6d61 6765 5072 6f63 6573 736f 7228  tImageProcessor(
+000005b0: 4261 7365 496d 6167 6550 726f 6365 7373  BaseImageProcess
+000005c0: 6f72 293a 0a20 2020 2072 2222 220a 2020  or):.    r""".  
+000005d0: 2020 436f 6e73 7472 7563 7473 2061 2042    Constructs a B
+000005e0: 6954 2069 6d61 6765 2070 726f 6365 7373  iT image process
+000005f0: 6f72 2e0a 0a20 2020 2041 7267 733a 0a20  or...    Args:. 
+00000600: 2020 2020 2020 2064 6f5f 7265 7369 7a65         do_resize
+00000610: 2028 6062 6f6f 6c60 2c20 2a6f 7074 696f   (`bool`, *optio
+00000620: 6e61 6c2a 2c20 6465 6661 756c 7473 2074  nal*, defaults t
+00000630: 6f20 6054 7275 6560 293a 0a20 2020 2020  o `True`):.     
+00000640: 2020 2020 2020 2057 6865 7468 6572 2074         Whether t
+00000650: 6f20 7265 7369 7a65 2074 6865 2069 6d61  o resize the ima
+00000660: 6765 2773 2028 6865 6967 6874 2c20 7769  ge's (height, wi
+00000670: 6474 6829 2064 696d 656e 7369 6f6e 7320  dth) dimensions 
+00000680: 746f 2074 6865 2073 7065 6369 6669 6564  to the specified
+00000690: 2060 7369 7a65 602e 2043 616e 2062 6520   `size`. Can be 
+000006a0: 6f76 6572 7269 6464 656e 2062 790a 2020  overridden by.  
+000006b0: 2020 2020 2020 2020 2020 6064 6f5f 7265            `do_re
+000006c0: 7369 7a65 6020 696e 2074 6865 2060 7072  size` in the `pr
+000006d0: 6570 726f 6365 7373 6020 6d65 7468 6f64  eprocess` method
+000006e0: 2e0a 2020 2020 2020 2020 7369 7a65 2028  ..        size (
+000006f0: 6044 6963 745b 7374 722c 2069 6e74 5d60  `Dict[str, int]`
+00000700: 202a 6f70 7469 6f6e 616c 2a2c 2064 6566   *optional*, def
+00000710: 6175 6c74 7320 746f 2060 7b22 7368 6f72  aults to `{"shor
+00000720: 7465 7374 5f65 6467 6522 3a20 3232 347d  test_edge": 224}
+00000730: 6029 3a0a 2020 2020 2020 2020 2020 2020  `):.            
+00000740: 5369 7a65 206f 6620 7468 6520 696d 6167  Size of the imag
+00000750: 6520 6166 7465 7220 7265 7369 7a69 6e67  e after resizing
+00000760: 2e20 5468 6520 7368 6f72 7465 7374 2065  . The shortest e
+00000770: 6467 6520 6f66 2074 6865 2069 6d61 6765  dge of the image
+00000780: 2069 7320 7265 7369 7a65 6420 746f 2073   is resized to s
+00000790: 697a 655b 2273 686f 7274 6573 745f 6564  ize["shortest_ed
+000007a0: 6765 225d 2c20 7769 7468 0a20 2020 2020  ge"], with.     
+000007b0: 2020 2020 2020 2074 6865 206c 6f6e 6765         the longe
+000007c0: 7374 2065 6467 6520 7265 7369 7a65 6420  st edge resized 
+000007d0: 746f 206b 6565 7020 7468 6520 696e 7075  to keep the inpu
+000007e0: 7420 6173 7065 6374 2072 6174 696f 2e20  t aspect ratio. 
+000007f0: 4361 6e20 6265 206f 7665 7272 6964 6465  Can be overridde
+00000800: 6e20 6279 2060 7369 7a65 6020 696e 2074  n by `size` in t
+00000810: 6865 2060 7072 6570 726f 6365 7373 600a  he `preprocess`.
+00000820: 2020 2020 2020 2020 2020 2020 6d65 7468              meth
+00000830: 6f64 2e0a 2020 2020 2020 2020 7265 7361  od..        resa
+00000840: 6d70 6c65 2028 6050 494c 496d 6167 6552  mple (`PILImageR
+00000850: 6573 616d 706c 696e 6760 2c20 2a6f 7074  esampling`, *opt
+00000860: 696f 6e61 6c2a 2c20 6465 6661 756c 7473  ional*, defaults
+00000870: 2074 6f20 6050 494c 496d 6167 6552 6573   to `PILImageRes
+00000880: 616d 706c 696e 672e 4249 4355 4249 4360  ampling.BICUBIC`
+00000890: 293a 0a20 2020 2020 2020 2020 2020 2052  ):.            R
+000008a0: 6573 616d 706c 696e 6720 6669 6c74 6572  esampling filter
+000008b0: 2074 6f20 7573 6520 6966 2072 6573 697a   to use if resiz
+000008c0: 696e 6720 7468 6520 696d 6167 652e 2043  ing the image. C
+000008d0: 616e 2062 6520 6f76 6572 7269 6464 656e  an be overridden
+000008e0: 2062 7920 6072 6573 616d 706c 6560 2069   by `resample` i
+000008f0: 6e20 7468 6520 6070 7265 7072 6f63 6573  n the `preproces
+00000900: 7360 206d 6574 686f 642e 0a20 2020 2020  s` method..     
+00000910: 2020 2064 6f5f 6365 6e74 6572 5f63 726f     do_center_cro
+00000920: 7020 2860 626f 6f6c 602c 202a 6f70 7469  p (`bool`, *opti
+00000930: 6f6e 616c 2a2c 2064 6566 6175 6c74 7320  onal*, defaults 
+00000940: 746f 2060 5472 7565 6029 3a0a 2020 2020  to `True`):.    
+00000950: 2020 2020 2020 2020 5768 6574 6865 7220          Whether 
+00000960: 746f 2063 656e 7465 7220 6372 6f70 2074  to center crop t
+00000970: 6865 2069 6d61 6765 2074 6f20 7468 6520  he image to the 
+00000980: 7370 6563 6966 6965 6420 6063 726f 705f  specified `crop_
+00000990: 7369 7a65 602e 2043 616e 2062 6520 6f76  size`. Can be ov
+000009a0: 6572 7269 6464 656e 2062 7920 6064 6f5f  erridden by `do_
+000009b0: 6365 6e74 6572 5f63 726f 7060 2069 6e20  center_crop` in 
+000009c0: 7468 650a 2020 2020 2020 2020 2020 2020  the.            
+000009d0: 6070 7265 7072 6f63 6573 7360 206d 6574  `preprocess` met
+000009e0: 686f 642e 0a20 2020 2020 2020 2063 726f  hod..        cro
+000009f0: 705f 7369 7a65 2028 6044 6963 745b 7374  p_size (`Dict[st
+00000a00: 722c 2069 6e74 5d60 202a 6f70 7469 6f6e  r, int]` *option
+00000a10: 616c 2a2c 2064 6566 6175 6c74 7320 746f  al*, defaults to
+00000a20: 2032 3234 293a 0a20 2020 2020 2020 2020   224):.         
+00000a30: 2020 2053 697a 6520 6f66 2074 6865 206f     Size of the o
+00000a40: 7574 7075 7420 696d 6167 6520 6166 7465  utput image afte
+00000a50: 7220 6170 706c 7969 6e67 2060 6365 6e74  r applying `cent
+00000a60: 6572 5f63 726f 7060 2e20 4361 6e20 6265  er_crop`. Can be
+00000a70: 206f 7665 7272 6964 6465 6e20 6279 2060   overridden by `
+00000a80: 6372 6f70 5f73 697a 6560 2069 6e20 7468  crop_size` in th
+00000a90: 6520 6070 7265 7072 6f63 6573 7360 0a20  e `preprocess`. 
+00000aa0: 2020 2020 2020 2020 2020 206d 6574 686f             metho
+00000ab0: 642e 0a20 2020 2020 2020 2064 6f5f 7265  d..        do_re
+00000ac0: 7363 616c 6520 2860 626f 6f6c 602c 202a  scale (`bool`, *
+00000ad0: 6f70 7469 6f6e 616c 2a2c 2064 6566 6175  optional*, defau
+00000ae0: 6c74 7320 746f 2060 5472 7565 6029 3a0a  lts to `True`):.
+00000af0: 2020 2020 2020 2020 2020 2020 5768 6574              Whet
+00000b00: 6865 7220 746f 2072 6573 6361 6c65 2074  her to rescale t
+00000b10: 6865 2069 6d61 6765 2062 7920 7468 6520  he image by the 
+00000b20: 7370 6563 6966 6965 6420 7363 616c 6520  specified scale 
+00000b30: 6072 6573 6361 6c65 5f66 6163 746f 7260  `rescale_factor`
+00000b40: 2e20 4361 6e20 6265 206f 7665 7272 6964  . Can be overrid
+00000b50: 6465 6e20 6279 2060 646f 5f72 6573 6361  den by `do_resca
+00000b60: 6c65 6020 696e 0a20 2020 2020 2020 2020  le` in.         
+00000b70: 2020 2074 6865 2060 7072 6570 726f 6365     the `preproce
+00000b80: 7373 6020 6d65 7468 6f64 2e0a 2020 2020  ss` method..    
+00000b90: 2020 2020 7265 7363 616c 655f 6661 6374      rescale_fact
+00000ba0: 6f72 2028 6069 6e74 6020 6f72 2060 666c  or (`int` or `fl
+00000bb0: 6f61 7460 2c20 2a6f 7074 696f 6e61 6c2a  oat`, *optional*
+00000bc0: 2c20 6465 6661 756c 7473 2074 6f20 6031  , defaults to `1
+00000bd0: 2f32 3535 6029 3a0a 2020 2020 2020 2020  /255`):.        
+00000be0: 2020 2020 5363 616c 6520 6661 6374 6f72      Scale factor
+00000bf0: 2074 6f20 7573 6520 6966 2072 6573 6361   to use if resca
+00000c00: 6c69 6e67 2074 6865 2069 6d61 6765 2e20  ling the image. 
+00000c10: 4361 6e20 6265 206f 7665 7272 6964 6465  Can be overridde
+00000c20: 6e20 6279 2060 7265 7363 616c 655f 6661  n by `rescale_fa
+00000c30: 6374 6f72 6020 696e 2074 6865 2060 7072  ctor` in the `pr
+00000c40: 6570 726f 6365 7373 600a 2020 2020 2020  eprocess`.      
+00000c50: 2020 2020 2020 6d65 7468 6f64 2e0a 2020        method..  
+00000c60: 2020 2020 2020 646f 5f6e 6f72 6d61 6c69        do_normali
+00000c70: 7a65 3a0a 2020 2020 2020 2020 2020 2020  ze:.            
+00000c80: 5768 6574 6865 7220 746f 206e 6f72 6d61  Whether to norma
+00000c90: 6c69 7a65 2074 6865 2069 6d61 6765 2e20  lize the image. 
+00000ca0: 4361 6e20 6265 206f 7665 7272 6964 6465  Can be overridde
+00000cb0: 6e20 6279 2060 646f 5f6e 6f72 6d61 6c69  n by `do_normali
+00000cc0: 7a65 6020 696e 2074 6865 2060 7072 6570  ze` in the `prep
+00000cd0: 726f 6365 7373 6020 6d65 7468 6f64 2e0a  rocess` method..
+00000ce0: 2020 2020 2020 2020 696d 6167 655f 6d65          image_me
+00000cf0: 616e 2028 6066 6c6f 6174 6020 6f72 2060  an (`float` or `
+00000d00: 4c69 7374 5b66 6c6f 6174 5d60 2c20 2a6f  List[float]`, *o
+00000d10: 7074 696f 6e61 6c2a 2c20 6465 6661 756c  ptional*, defaul
+00000d20: 7473 2074 6f20 604f 5045 4e41 495f 434c  ts to `OPENAI_CL
+00000d30: 4950 5f4d 4541 4e60 293a 0a20 2020 2020  IP_MEAN`):.     
+00000d40: 2020 2020 2020 204d 6561 6e20 746f 2075         Mean to u
+00000d50: 7365 2069 6620 6e6f 726d 616c 697a 696e  se if normalizin
+00000d60: 6720 7468 6520 696d 6167 652e 2054 6869  g the image. Thi
+00000d70: 7320 6973 2061 2066 6c6f 6174 206f 7220  s is a float or 
+00000d80: 6c69 7374 206f 6620 666c 6f61 7473 2074  list of floats t
+00000d90: 6865 206c 656e 6774 6820 6f66 2074 6865  he length of the
+00000da0: 206e 756d 6265 7220 6f66 0a20 2020 2020   number of.     
+00000db0: 2020 2020 2020 2063 6861 6e6e 656c 7320         channels 
+00000dc0: 696e 2074 6865 2069 6d61 6765 2e20 4361  in the image. Ca
+00000dd0: 6e20 6265 206f 7665 7272 6964 6465 6e20  n be overridden 
+00000de0: 6279 2074 6865 2060 696d 6167 655f 6d65  by the `image_me
+00000df0: 616e 6020 7061 7261 6d65 7465 7220 696e  an` parameter in
+00000e00: 2074 6865 2060 7072 6570 726f 6365 7373   the `preprocess
+00000e10: 6020 6d65 7468 6f64 2e0a 2020 2020 2020  ` method..      
+00000e20: 2020 696d 6167 655f 7374 6420 2860 666c    image_std (`fl
+00000e30: 6f61 7460 206f 7220 604c 6973 745b 666c  oat` or `List[fl
+00000e40: 6f61 745d 602c 202a 6f70 7469 6f6e 616c  oat]`, *optional
+00000e50: 2a2c 2064 6566 6175 6c74 7320 746f 2060  *, defaults to `
+00000e60: 4f50 454e 4149 5f43 4c49 505f 4d45 414e  OPENAI_CLIP_MEAN
+00000e70: 6029 3a0a 2020 2020 2020 2020 2020 2020  `):.            
+00000e80: 5374 616e 6461 7264 2064 6576 6961 7469  Standard deviati
+00000e90: 6f6e 2074 6f20 7573 6520 6966 206e 6f72  on to use if nor
+00000ea0: 6d61 6c69 7a69 6e67 2074 6865 2069 6d61  malizing the ima
+00000eb0: 6765 2e20 5468 6973 2069 7320 6120 666c  ge. This is a fl
+00000ec0: 6f61 7420 6f72 206c 6973 7420 6f66 2066  oat or list of f
+00000ed0: 6c6f 6174 7320 7468 6520 6c65 6e67 7468  loats the length
+00000ee0: 206f 6620 7468 650a 2020 2020 2020 2020   of the.        
+00000ef0: 2020 2020 6e75 6d62 6572 206f 6620 6368      number of ch
+00000f00: 616e 6e65 6c73 2069 6e20 7468 6520 696d  annels in the im
+00000f10: 6167 652e 2043 616e 2062 6520 6f76 6572  age. Can be over
+00000f20: 7269 6464 656e 2062 7920 7468 6520 6069  ridden by the `i
+00000f30: 6d61 6765 5f73 7464 6020 7061 7261 6d65  mage_std` parame
+00000f40: 7465 7220 696e 2074 6865 2060 7072 6570  ter in the `prep
+00000f50: 726f 6365 7373 6020 6d65 7468 6f64 2e0a  rocess` method..
+00000f60: 2020 2020 2020 2020 2020 2020 4361 6e20              Can 
+00000f70: 6265 206f 7665 7272 6964 6465 6e20 6279  be overridden by
+00000f80: 2074 6865 2060 696d 6167 655f 7374 6460   the `image_std`
+00000f90: 2070 6172 616d 6574 6572 2069 6e20 7468   parameter in th
+00000fa0: 6520 6070 7265 7072 6f63 6573 7360 206d  e `preprocess` m
+00000fb0: 6574 686f 642e 0a20 2020 2020 2020 2064  ethod..        d
+00000fc0: 6f5f 636f 6e76 6572 745f 7267 6220 2860  o_convert_rgb (`
+00000fd0: 626f 6f6c 602c 202a 6f70 7469 6f6e 616c  bool`, *optional
+00000fe0: 2a2c 2064 6566 6175 6c74 7320 746f 2060  *, defaults to `
+00000ff0: 5472 7565 6029 3a0a 2020 2020 2020 2020  True`):.        
+00001000: 2020 2020 5768 6574 6865 7220 746f 2063      Whether to c
+00001010: 6f6e 7665 7274 2074 6865 2069 6d61 6765  onvert the image
+00001020: 2074 6f20 5247 422e 0a20 2020 2022 2222   to RGB..    """
+00001030: 0a0a 2020 2020 6d6f 6465 6c5f 696e 7075  ..    model_inpu
+00001040: 745f 6e61 6d65 7320 3d20 5b22 7069 7865  t_names = ["pixe
+00001050: 6c5f 7661 6c75 6573 225d 0a0a 2020 2020  l_values"]..    
+00001060: 6465 6620 5f5f 696e 6974 5f5f 280a 2020  def __init__(.  
+00001070: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+00001080: 2020 2020 646f 5f72 6573 697a 653a 2062      do_resize: b
+00001090: 6f6f 6c20 3d20 5472 7565 2c0a 2020 2020  ool = True,.    
+000010a0: 2020 2020 7369 7a65 3a20 4469 6374 5b73      size: Dict[s
+000010b0: 7472 2c20 696e 745d 203d 204e 6f6e 652c  tr, int] = None,
+000010c0: 0a20 2020 2020 2020 2072 6573 616d 706c  .        resampl
+000010d0: 653a 2050 494c 496d 6167 6552 6573 616d  e: PILImageResam
+000010e0: 706c 696e 6720 3d20 5049 4c49 6d61 6765  pling = PILImage
+000010f0: 5265 7361 6d70 6c69 6e67 2e42 4943 5542  Resampling.BICUB
+00001100: 4943 2c0a 2020 2020 2020 2020 646f 5f63  IC,.        do_c
+00001110: 656e 7465 725f 6372 6f70 3a20 626f 6f6c  enter_crop: bool
+00001120: 203d 2054 7275 652c 0a20 2020 2020 2020   = True,.       
+00001130: 2063 726f 705f 7369 7a65 3a20 4469 6374   crop_size: Dict
+00001140: 5b73 7472 2c20 696e 745d 203d 204e 6f6e  [str, int] = Non
+00001150: 652c 0a20 2020 2020 2020 2064 6f5f 7265  e,.        do_re
+00001160: 7363 616c 653a 2062 6f6f 6c20 3d20 5472  scale: bool = Tr
+00001170: 7565 2c0a 2020 2020 2020 2020 7265 7363  ue,.        resc
+00001180: 616c 655f 6661 6374 6f72 3a20 556e 696f  ale_factor: Unio
+00001190: 6e5b 696e 742c 2066 6c6f 6174 5d20 3d20  n[int, float] = 
+000011a0: 3120 2f20 3235 352c 0a20 2020 2020 2020  1 / 255,.       
+000011b0: 2064 6f5f 6e6f 726d 616c 697a 653a 2062   do_normalize: b
+000011c0: 6f6f 6c20 3d20 5472 7565 2c0a 2020 2020  ool = True,.    
+000011d0: 2020 2020 696d 6167 655f 6d65 616e 3a20      image_mean: 
+000011e0: 4f70 7469 6f6e 616c 5b55 6e69 6f6e 5b66  Optional[Union[f
+000011f0: 6c6f 6174 2c20 4c69 7374 5b66 6c6f 6174  loat, List[float
+00001200: 5d5d 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ]]] = None,.    
+00001210: 2020 2020 696d 6167 655f 7374 643a 204f      image_std: O
+00001220: 7074 696f 6e61 6c5b 556e 696f 6e5b 666c  ptional[Union[fl
+00001230: 6f61 742c 204c 6973 745b 666c 6f61 745d  oat, List[float]
+00001240: 5d5d 203d 204e 6f6e 652c 0a20 2020 2020  ]] = None,.     
+00001250: 2020 2064 6f5f 636f 6e76 6572 745f 7267     do_convert_rg
+00001260: 623a 2062 6f6f 6c20 3d20 5472 7565 2c0a  b: bool = True,.
+00001270: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
+00001280: 2c0a 2020 2020 2920 2d3e 204e 6f6e 653a  ,.    ) -> None:
+00001290: 0a20 2020 2020 2020 2073 7570 6572 2829  .        super()
+000012a0: 2e5f 5f69 6e69 745f 5f28 2a2a 6b77 6172  .__init__(**kwar
+000012b0: 6773 290a 2020 2020 2020 2020 7369 7a65  gs).        size
+000012c0: 203d 2073 697a 6520 6966 2073 697a 6520   = size if size 
+000012d0: 6973 206e 6f74 204e 6f6e 6520 656c 7365  is not None else
+000012e0: 207b 2273 686f 7274 6573 745f 6564 6765   {"shortest_edge
+000012f0: 223a 2032 3234 7d0a 2020 2020 2020 2020  ": 224}.        
+00001300: 7369 7a65 203d 2067 6574 5f73 697a 655f  size = get_size_
+00001310: 6469 6374 2873 697a 652c 2064 6566 6175  dict(size, defau
+00001320: 6c74 5f74 6f5f 7371 7561 7265 3d46 616c  lt_to_square=Fal
+00001330: 7365 290a 2020 2020 2020 2020 6372 6f70  se).        crop
+00001340: 5f73 697a 6520 3d20 6372 6f70 5f73 697a  _size = crop_siz
+00001350: 6520 6966 2063 726f 705f 7369 7a65 2069  e if crop_size i
+00001360: 7320 6e6f 7420 4e6f 6e65 2065 6c73 6520  s not None else 
+00001370: 7b22 6865 6967 6874 223a 2032 3234 2c20  {"height": 224, 
+00001380: 2277 6964 7468 223a 2032 3234 7d0a 2020  "width": 224}.  
+00001390: 2020 2020 2020 6372 6f70 5f73 697a 6520        crop_size 
+000013a0: 3d20 6765 745f 7369 7a65 5f64 6963 7428  = get_size_dict(
+000013b0: 6372 6f70 5f73 697a 652c 2064 6566 6175  crop_size, defau
+000013c0: 6c74 5f74 6f5f 7371 7561 7265 3d54 7275  lt_to_square=Tru
+000013d0: 652c 2070 6172 616d 5f6e 616d 653d 2263  e, param_name="c
+000013e0: 726f 705f 7369 7a65 2229 0a0a 2020 2020  rop_size")..    
+000013f0: 2020 2020 7365 6c66 2e64 6f5f 7265 7369      self.do_resi
+00001400: 7a65 203d 2064 6f5f 7265 7369 7a65 0a20  ze = do_resize. 
+00001410: 2020 2020 2020 2073 656c 662e 7369 7a65         self.size
+00001420: 203d 2073 697a 650a 2020 2020 2020 2020   = size.        
+00001430: 7365 6c66 2e72 6573 616d 706c 6520 3d20  self.resample = 
+00001440: 7265 7361 6d70 6c65 0a20 2020 2020 2020  resample.       
+00001450: 2073 656c 662e 646f 5f63 656e 7465 725f   self.do_center_
+00001460: 6372 6f70 203d 2064 6f5f 6365 6e74 6572  crop = do_center
+00001470: 5f63 726f 700a 2020 2020 2020 2020 7365  _crop.        se
+00001480: 6c66 2e63 726f 705f 7369 7a65 203d 2063  lf.crop_size = c
+00001490: 726f 705f 7369 7a65 0a20 2020 2020 2020  rop_size.       
+000014a0: 2073 656c 662e 646f 5f72 6573 6361 6c65   self.do_rescale
+000014b0: 203d 2064 6f5f 7265 7363 616c 650a 2020   = do_rescale.  
+000014c0: 2020 2020 2020 7365 6c66 2e72 6573 6361        self.resca
+000014d0: 6c65 5f66 6163 746f 7220 3d20 7265 7363  le_factor = resc
+000014e0: 616c 655f 6661 6374 6f72 0a20 2020 2020  ale_factor.     
+000014f0: 2020 2073 656c 662e 646f 5f6e 6f72 6d61     self.do_norma
+00001500: 6c69 7a65 203d 2064 6f5f 6e6f 726d 616c  lize = do_normal
+00001510: 697a 650a 2020 2020 2020 2020 7365 6c66  ize.        self
+00001520: 2e69 6d61 6765 5f6d 6561 6e20 3d20 696d  .image_mean = im
+00001530: 6167 655f 6d65 616e 2069 6620 696d 6167  age_mean if imag
+00001540: 655f 6d65 616e 2069 7320 6e6f 7420 4e6f  e_mean is not No
+00001550: 6e65 2065 6c73 6520 4f50 454e 4149 5f43  ne else OPENAI_C
+00001560: 4c49 505f 4d45 414e 0a20 2020 2020 2020  LIP_MEAN.       
+00001570: 2073 656c 662e 696d 6167 655f 7374 6420   self.image_std 
+00001580: 3d20 696d 6167 655f 7374 6420 6966 2069  = image_std if i
+00001590: 6d61 6765 5f73 7464 2069 7320 6e6f 7420  mage_std is not 
+000015a0: 4e6f 6e65 2065 6c73 6520 4f50 454e 4149  None else OPENAI
+000015b0: 5f43 4c49 505f 5354 440a 2020 2020 2020  _CLIP_STD.      
+000015c0: 2020 7365 6c66 2e64 6f5f 636f 6e76 6572    self.do_conver
+000015d0: 745f 7267 6220 3d20 646f 5f63 6f6e 7665  t_rgb = do_conve
+000015e0: 7274 5f72 6762 0a20 2020 2020 2020 2073  rt_rgb.        s
+000015f0: 656c 662e 5f76 616c 6964 5f70 726f 6365  elf._valid_proce
+00001600: 7373 6f72 5f6b 6579 7320 3d20 5b0a 2020  ssor_keys = [.  
+00001610: 2020 2020 2020 2020 2020 2269 6d61 6765            "image
+00001620: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
+00001630: 2264 6f5f 7265 7369 7a65 222c 0a20 2020  "do_resize",.   
+00001640: 2020 2020 2020 2020 2022 7369 7a65 222c           "size",
+00001650: 0a20 2020 2020 2020 2020 2020 2022 7265  .            "re
+00001660: 7361 6d70 6c65 222c 0a20 2020 2020 2020  sample",.       
+00001670: 2020 2020 2022 646f 5f63 656e 7465 725f       "do_center_
+00001680: 6372 6f70 222c 0a20 2020 2020 2020 2020  crop",.         
+00001690: 2020 2022 6372 6f70 5f73 697a 6522 2c0a     "crop_size",.
+000016a0: 2020 2020 2020 2020 2020 2020 2264 6f5f              "do_
+000016b0: 7265 7363 616c 6522 2c0a 2020 2020 2020  rescale",.      
+000016c0: 2020 2020 2020 2272 6573 6361 6c65 5f66        "rescale_f
+000016d0: 6163 746f 7222 2c0a 2020 2020 2020 2020  actor",.        
+000016e0: 2020 2020 2264 6f5f 6e6f 726d 616c 697a      "do_normaliz
+000016f0: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
+00001700: 2269 6d61 6765 5f6d 6561 6e22 2c0a 2020  "image_mean",.  
+00001710: 2020 2020 2020 2020 2020 2269 6d61 6765            "image
+00001720: 5f73 7464 222c 0a20 2020 2020 2020 2020  _std",.         
+00001730: 2020 2022 646f 5f63 6f6e 7665 7274 5f72     "do_convert_r
+00001740: 6762 222c 0a20 2020 2020 2020 2020 2020  gb",.           
+00001750: 2022 7265 7475 726e 5f74 656e 736f 7273   "return_tensors
+00001760: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
+00001770: 6461 7461 5f66 6f72 6d61 7422 2c0a 2020  data_format",.  
+00001780: 2020 2020 2020 2020 2020 2269 6e70 7574            "input
+00001790: 5f64 6174 615f 666f 726d 6174 222c 0a20  _data_format",. 
+000017a0: 2020 2020 2020 205d 0a0a 2020 2020 2320         ]..    # 
+000017b0: 436f 7069 6564 2066 726f 6d20 7472 616e  Copied from tran
+000017c0: 7366 6f72 6d65 7273 2e6d 6f64 656c 732e  sformers.models.
+000017d0: 636c 6970 2e69 6d61 6765 5f70 726f 6365  clip.image_proce
+000017e0: 7373 696e 675f 636c 6970 2e43 4c49 5049  ssing_clip.CLIPI
+000017f0: 6d61 6765 5072 6f63 6573 736f 722e 7265  mageProcessor.re
+00001800: 7369 7a65 0a20 2020 2064 6566 2072 6573  size.    def res
+00001810: 697a 6528 0a20 2020 2020 2020 2073 656c  ize(.        sel
+00001820: 662c 0a20 2020 2020 2020 2069 6d61 6765  f,.        image
+00001830: 3a20 6e70 2e6e 6461 7272 6179 2c0a 2020  : np.ndarray,.  
+00001840: 2020 2020 2020 7369 7a65 3a20 4469 6374        size: Dict
+00001850: 5b73 7472 2c20 696e 745d 2c0a 2020 2020  [str, int],.    
+00001860: 2020 2020 7265 7361 6d70 6c65 3a20 5049      resample: PI
+00001870: 4c49 6d61 6765 5265 7361 6d70 6c69 6e67  LImageResampling
+00001880: 203d 2050 494c 496d 6167 6552 6573 616d   = PILImageResam
+00001890: 706c 696e 672e 4249 4355 4249 432c 0a20  pling.BICUBIC,. 
+000018a0: 2020 2020 2020 2064 6174 615f 666f 726d         data_form
+000018b0: 6174 3a20 4f70 7469 6f6e 616c 5b55 6e69  at: Optional[Uni
+000018c0: 6f6e 5b73 7472 2c20 4368 616e 6e65 6c44  on[str, ChannelD
+000018d0: 696d 656e 7369 6f6e 5d5d 203d 204e 6f6e  imension]] = Non
+000018e0: 652c 0a20 2020 2020 2020 2069 6e70 7574  e,.        input
+000018f0: 5f64 6174 615f 666f 726d 6174 3a20 4f70  _data_format: Op
+00001900: 7469 6f6e 616c 5b55 6e69 6f6e 5b73 7472  tional[Union[str
+00001910: 2c20 4368 616e 6e65 6c44 696d 656e 7369  , ChannelDimensi
+00001920: 6f6e 5d5d 203d 204e 6f6e 652c 0a20 2020  on]] = None,.   
+00001930: 2020 2020 202a 2a6b 7761 7267 732c 0a20       **kwargs,. 
+00001940: 2020 2029 202d 3e20 6e70 2e6e 6461 7272     ) -> np.ndarr
+00001950: 6179 3a0a 2020 2020 2020 2020 2222 220a  ay:.        """.
+00001960: 2020 2020 2020 2020 5265 7369 7a65 2061          Resize a
+00001970: 6e20 696d 6167 652e 2054 6865 2073 686f  n image. The sho
+00001980: 7274 6573 7420 6564 6765 206f 6620 7468  rtest edge of th
+00001990: 6520 696d 6167 6520 6973 2072 6573 697a  e image is resiz
+000019a0: 6564 2074 6f20 7369 7a65 5b22 7368 6f72  ed to size["shor
+000019b0: 7465 7374 5f65 6467 6522 5d2c 2077 6974  test_edge"], wit
+000019c0: 6820 7468 6520 6c6f 6e67 6573 7420 6564  h the longest ed
+000019d0: 6765 0a20 2020 2020 2020 2072 6573 697a  ge.        resiz
+000019e0: 6564 2074 6f20 6b65 6570 2074 6865 2069  ed to keep the i
+000019f0: 6e70 7574 2061 7370 6563 7420 7261 7469  nput aspect rati
+00001a00: 6f2e 0a0a 2020 2020 2020 2020 4172 6773  o...        Args
+00001a10: 3a0a 2020 2020 2020 2020 2020 2020 696d  :.            im
+00001a20: 6167 6520 2860 6e70 2e6e 6461 7272 6179  age (`np.ndarray
+00001a30: 6029 3a0a 2020 2020 2020 2020 2020 2020  `):.            
+00001a40: 2020 2020 496d 6167 6520 746f 2072 6573      Image to res
+00001a50: 697a 652e 0a20 2020 2020 2020 2020 2020  ize..           
+00001a60: 2073 697a 6520 2860 4469 6374 5b73 7472   size (`Dict[str
+00001a70: 2c20 696e 745d 6029 3a0a 2020 2020 2020  , int]`):.      
+00001a80: 2020 2020 2020 2020 2020 5369 7a65 206f            Size o
+00001a90: 6620 7468 6520 6f75 7470 7574 2069 6d61  f the output ima
+00001aa0: 6765 2e0a 2020 2020 2020 2020 2020 2020  ge..            
+00001ab0: 7265 7361 6d70 6c65 2028 6050 494c 496d  resample (`PILIm
+00001ac0: 6167 6552 6573 616d 706c 696e 6760 2c20  ageResampling`, 
+00001ad0: 2a6f 7074 696f 6e61 6c2a 2c20 6465 6661  *optional*, defa
+00001ae0: 756c 7473 2074 6f20 6050 494c 496d 6167  ults to `PILImag
+00001af0: 6552 6573 616d 706c 696e 672e 4249 4355  eResampling.BICU
+00001b00: 4249 4360 293a 0a20 2020 2020 2020 2020  BIC`):.         
+00001b10: 2020 2020 2020 2052 6573 616d 706c 696e         Resamplin
+00001b20: 6720 6669 6c74 6572 2074 6f20 7573 6520  g filter to use 
+00001b30: 7768 656e 2072 6573 6969 7a69 6e67 2074  when resiizing t
+00001b40: 6865 2069 6d61 6765 2e0a 2020 2020 2020  he image..      
+00001b50: 2020 2020 2020 6461 7461 5f66 6f72 6d61        data_forma
+00001b60: 7420 2860 7374 7260 206f 7220 6043 6861  t (`str` or `Cha
+00001b70: 6e6e 656c 4469 6d65 6e73 696f 6e60 2c20  nnelDimension`, 
+00001b80: 2a6f 7074 696f 6e61 6c2a 293a 0a20 2020  *optional*):.   
+00001b90: 2020 2020 2020 2020 2020 2020 2054 6865               The
+00001ba0: 2063 6861 6e6e 656c 2064 696d 656e 7369   channel dimensi
+00001bb0: 6f6e 2066 6f72 6d61 7420 6f66 2074 6865  on format of the
+00001bc0: 2069 6d61 6765 2e20 4966 206e 6f74 2070   image. If not p
+00001bd0: 726f 7669 6465 642c 2069 7420 7769 6c6c  rovided, it will
+00001be0: 2062 6520 7468 6520 7361 6d65 2061 7320   be the same as 
+00001bf0: 7468 6520 696e 7075 7420 696d 6167 652e  the input image.
+00001c00: 0a20 2020 2020 2020 2020 2020 2069 6e70  .            inp
+00001c10: 7574 5f64 6174 615f 666f 726d 6174 2028  ut_data_format (
+00001c20: 6043 6861 6e6e 656c 4469 6d65 6e73 696f  `ChannelDimensio
+00001c30: 6e60 206f 7220 6073 7472 602c 202a 6f70  n` or `str`, *op
+00001c40: 7469 6f6e 616c 2a29 3a0a 2020 2020 2020  tional*):.      
+00001c50: 2020 2020 2020 2020 2020 5468 6520 6368            The ch
+00001c60: 616e 6e65 6c20 6469 6d65 6e73 696f 6e20  annel dimension 
+00001c70: 666f 726d 6174 206f 6620 7468 6520 696e  format of the in
+00001c80: 7075 7420 696d 6167 652e 2049 6620 6e6f  put image. If no
+00001c90: 7420 7072 6f76 6964 6564 2c20 6974 2077  t provided, it w
+00001ca0: 696c 6c20 6265 2069 6e66 6572 7265 642e  ill be inferred.
+00001cb0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00001cc0: 2020 2020 2064 6566 6175 6c74 5f74 6f5f       default_to_
+00001cd0: 7371 7561 7265 203d 2054 7275 650a 2020  square = True.  
+00001ce0: 2020 2020 2020 6966 2022 7368 6f72 7465        if "shorte
+00001cf0: 7374 5f65 6467 6522 2069 6e20 7369 7a65  st_edge" in size
+00001d00: 3a0a 2020 2020 2020 2020 2020 2020 7369  :.            si
+00001d10: 7a65 203d 2073 697a 655b 2273 686f 7274  ze = size["short
+00001d20: 6573 745f 6564 6765 225d 0a20 2020 2020  est_edge"].     
+00001d30: 2020 2020 2020 2064 6566 6175 6c74 5f74         default_t
+00001d40: 6f5f 7371 7561 7265 203d 2046 616c 7365  o_square = False
+00001d50: 0a20 2020 2020 2020 2065 6c69 6620 2268  .        elif "h
+00001d60: 6569 6768 7422 2069 6e20 7369 7a65 2061  eight" in size a
+00001d70: 6e64 2022 7769 6474 6822 2069 6e20 7369  nd "width" in si
+00001d80: 7a65 3a0a 2020 2020 2020 2020 2020 2020  ze:.            
+00001d90: 7369 7a65 203d 2028 7369 7a65 5b22 6865  size = (size["he
+00001da0: 6967 6874 225d 2c20 7369 7a65 5b22 7769  ight"], size["wi
+00001db0: 6474 6822 5d29 0a20 2020 2020 2020 2065  dth"]).        e
+00001dc0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00001dd0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+00001de0: 7228 2253 697a 6520 6d75 7374 2063 6f6e  r("Size must con
+00001df0: 7461 696e 2065 6974 6865 7220 2773 686f  tain either 'sho
+00001e00: 7274 6573 745f 6564 6765 2720 6f72 2027  rtest_edge' or '
+00001e10: 6865 6967 6874 2720 616e 6420 2777 6964  height' and 'wid
+00001e20: 7468 272e 2229 0a0a 2020 2020 2020 2020  th'.")..        
+00001e30: 6f75 7470 7574 5f73 697a 6520 3d20 6765  output_size = ge
+00001e40: 745f 7265 7369 7a65 5f6f 7574 7075 745f  t_resize_output_
+00001e50: 696d 6167 655f 7369 7a65 280a 2020 2020  image_size(.    
+00001e60: 2020 2020 2020 2020 696d 6167 652c 0a20          image,. 
+00001e70: 2020 2020 2020 2020 2020 2073 697a 653d             size=
+00001e80: 7369 7a65 2c0a 2020 2020 2020 2020 2020  size,.          
+00001e90: 2020 6465 6661 756c 745f 746f 5f73 7175    default_to_squ
+00001ea0: 6172 653d 6465 6661 756c 745f 746f 5f73  are=default_to_s
+00001eb0: 7175 6172 652c 0a20 2020 2020 2020 2020  quare,.         
+00001ec0: 2020 2069 6e70 7574 5f64 6174 615f 666f     input_data_fo
+00001ed0: 726d 6174 3d69 6e70 7574 5f64 6174 615f  rmat=input_data_
+00001ee0: 666f 726d 6174 2c0a 2020 2020 2020 2020  format,.        
+00001ef0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00001f00: 2072 6573 697a 6528 0a20 2020 2020 2020   resize(.       
+00001f10: 2020 2020 2069 6d61 6765 2c0a 2020 2020       image,.    
+00001f20: 2020 2020 2020 2020 7369 7a65 3d6f 7574          size=out
+00001f30: 7075 745f 7369 7a65 2c0a 2020 2020 2020  put_size,.      
+00001f40: 2020 2020 2020 7265 7361 6d70 6c65 3d72        resample=r
+00001f50: 6573 616d 706c 652c 0a20 2020 2020 2020  esample,.       
+00001f60: 2020 2020 2064 6174 615f 666f 726d 6174       data_format
+00001f70: 3d64 6174 615f 666f 726d 6174 2c0a 2020  =data_format,.  
+00001f80: 2020 2020 2020 2020 2020 696e 7075 745f            input_
+00001f90: 6461 7461 5f66 6f72 6d61 743d 696e 7075  data_format=inpu
+00001fa0: 745f 6461 7461 5f66 6f72 6d61 742c 0a20  t_data_format,. 
+00001fb0: 2020 2020 2020 2020 2020 202a 2a6b 7761             **kwa
+00001fc0: 7267 732c 0a20 2020 2020 2020 2029 0a0a  rgs,.        )..
+00001fd0: 2020 2020 6465 6620 7072 6570 726f 6365      def preproce
+00001fe0: 7373 280a 2020 2020 2020 2020 7365 6c66  ss(.        self
+00001ff0: 2c0a 2020 2020 2020 2020 696d 6167 6573  ,.        images
+00002000: 3a20 496d 6167 6549 6e70 7574 2c0a 2020  : ImageInput,.  
+00002010: 2020 2020 2020 646f 5f72 6573 697a 653a        do_resize:
+00002020: 2062 6f6f 6c20 3d20 4e6f 6e65 2c0a 2020   bool = None,.  
+00002030: 2020 2020 2020 7369 7a65 3a20 4469 6374        size: Dict
+00002040: 5b73 7472 2c20 696e 745d 203d 204e 6f6e  [str, int] = Non
+00002050: 652c 0a20 2020 2020 2020 2072 6573 616d  e,.        resam
+00002060: 706c 653a 2050 494c 496d 6167 6552 6573  ple: PILImageRes
+00002070: 616d 706c 696e 6720 3d20 4e6f 6e65 2c0a  ampling = None,.
+00002080: 2020 2020 2020 2020 646f 5f63 656e 7465          do_cente
+00002090: 725f 6372 6f70 3a20 626f 6f6c 203d 204e  r_crop: bool = N
+000020a0: 6f6e 652c 0a20 2020 2020 2020 2063 726f  one,.        cro
+000020b0: 705f 7369 7a65 3a20 696e 7420 3d20 4e6f  p_size: int = No
+000020c0: 6e65 2c0a 2020 2020 2020 2020 646f 5f72  ne,.        do_r
+000020d0: 6573 6361 6c65 3a20 626f 6f6c 203d 204e  escale: bool = N
+000020e0: 6f6e 652c 0a20 2020 2020 2020 2072 6573  one,.        res
+000020f0: 6361 6c65 5f66 6163 746f 723a 2066 6c6f  cale_factor: flo
+00002100: 6174 203d 204e 6f6e 652c 0a20 2020 2020  at = None,.     
+00002110: 2020 2064 6f5f 6e6f 726d 616c 697a 653a     do_normalize:
+00002120: 2062 6f6f 6c20 3d20 4e6f 6e65 2c0a 2020   bool = None,.  
+00002130: 2020 2020 2020 696d 6167 655f 6d65 616e        image_mean
+00002140: 3a20 4f70 7469 6f6e 616c 5b55 6e69 6f6e  : Optional[Union
+00002150: 5b66 6c6f 6174 2c20 4c69 7374 5b66 6c6f  [float, List[flo
+00002160: 6174 5d5d 5d20 3d20 4e6f 6e65 2c0a 2020  at]]] = None,.  
+00002170: 2020 2020 2020 696d 6167 655f 7374 643a        image_std:
+00002180: 204f 7074 696f 6e61 6c5b 556e 696f 6e5b   Optional[Union[
+00002190: 666c 6f61 742c 204c 6973 745b 666c 6f61  float, List[floa
+000021a0: 745d 5d5d 203d 204e 6f6e 652c 0a20 2020  t]]] = None,.   
+000021b0: 2020 2020 2064 6f5f 636f 6e76 6572 745f       do_convert_
+000021c0: 7267 623a 2062 6f6f 6c20 3d20 4e6f 6e65  rgb: bool = None
+000021d0: 2c0a 2020 2020 2020 2020 7265 7475 726e  ,.        return
+000021e0: 5f74 656e 736f 7273 3a20 4f70 7469 6f6e  _tensors: Option
+000021f0: 616c 5b55 6e69 6f6e 5b73 7472 2c20 5465  al[Union[str, Te
+00002200: 6e73 6f72 5479 7065 5d5d 203d 204e 6f6e  nsorType]] = Non
+00002210: 652c 0a20 2020 2020 2020 2064 6174 615f  e,.        data_
+00002220: 666f 726d 6174 3a20 4f70 7469 6f6e 616c  format: Optional
+00002230: 5b43 6861 6e6e 656c 4469 6d65 6e73 696f  [ChannelDimensio
+00002240: 6e5d 203d 2043 6861 6e6e 656c 4469 6d65  n] = ChannelDime
+00002250: 6e73 696f 6e2e 4649 5253 542c 0a20 2020  nsion.FIRST,.   
+00002260: 2020 2020 2069 6e70 7574 5f64 6174 615f       input_data_
+00002270: 666f 726d 6174 3a20 4f70 7469 6f6e 616c  format: Optional
+00002280: 5b55 6e69 6f6e 5b73 7472 2c20 4368 616e  [Union[str, Chan
+00002290: 6e65 6c44 696d 656e 7369 6f6e 5d5d 203d  nelDimension]] =
+000022a0: 204e 6f6e 652c 0a20 2020 2020 2020 202a   None,.        *
+000022b0: 2a6b 7761 7267 732c 0a20 2020 2029 202d  *kwargs,.    ) -
+000022c0: 3e20 5049 4c2e 496d 6167 652e 496d 6167  > PIL.Image.Imag
+000022d0: 653a 0a20 2020 2020 2020 2022 2222 0a20  e:.        """. 
+000022e0: 2020 2020 2020 2050 7265 7072 6f63 6573         Preproces
+000022f0: 7320 616e 2069 6d61 6765 206f 7220 6261  s an image or ba
+00002300: 7463 6820 6f66 2069 6d61 6765 732e 0a0a  tch of images...
+00002310: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
+00002320: 2020 2020 2020 2020 2020 696d 6167 6573            images
+00002330: 2028 6049 6d61 6765 496e 7075 7460 293a   (`ImageInput`):
+00002340: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00002350: 2049 6d61 6765 2074 6f20 7072 6570 726f   Image to prepro
+00002360: 6365 7373 2e20 4578 7065 6374 7320 6120  cess. Expects a 
+00002370: 7369 6e67 6c65 206f 7220 6261 7463 6820  single or batch 
+00002380: 6f66 2069 6d61 6765 7320 7769 7468 2070  of images with p
+00002390: 6978 656c 2076 616c 7565 7320 7261 6e67  ixel values rang
+000023a0: 696e 6720 6672 6f6d 2030 2074 6f20 3235  ing from 0 to 25
+000023b0: 352e 2049 660a 2020 2020 2020 2020 2020  5. If.          
+000023c0: 2020 2020 2020 7061 7373 696e 6720 696e        passing in
+000023d0: 2069 6d61 6765 7320 7769 7468 2070 6978   images with pix
+000023e0: 656c 2076 616c 7565 7320 6265 7477 6565  el values betwee
+000023f0: 6e20 3020 616e 6420 312c 2073 6574 2060  n 0 and 1, set `
+00002400: 646f 5f72 6573 6361 6c65 3d46 616c 7365  do_rescale=False
+00002410: 602e 0a20 2020 2020 2020 2020 2020 2064  `..            d
+00002420: 6f5f 7265 7369 7a65 2028 6062 6f6f 6c60  o_resize (`bool`
+00002430: 2c20 2a6f 7074 696f 6e61 6c2a 2c20 6465  , *optional*, de
+00002440: 6661 756c 7473 2074 6f20 6073 656c 662e  faults to `self.
+00002450: 646f 5f72 6573 697a 6560 293a 0a20 2020  do_resize`):.   
+00002460: 2020 2020 2020 2020 2020 2020 2057 6865               Whe
+00002470: 7468 6572 2074 6f20 7265 7369 7a65 2074  ther to resize t
+00002480: 6865 2069 6d61 6765 2e0a 2020 2020 2020  he image..      
+00002490: 2020 2020 2020 7369 7a65 2028 6044 6963        size (`Dic
+000024a0: 745b 7374 722c 2069 6e74 5d60 2c20 2a6f  t[str, int]`, *o
+000024b0: 7074 696f 6e61 6c2a 2c20 6465 6661 756c  ptional*, defaul
+000024c0: 7473 2074 6f20 6073 656c 662e 7369 7a65  ts to `self.size
+000024d0: 6029 3a0a 2020 2020 2020 2020 2020 2020  `):.            
+000024e0: 2020 2020 5369 7a65 206f 6620 7468 6520      Size of the 
+000024f0: 696d 6167 6520 6166 7465 7220 7265 7369  image after resi
+00002500: 7a69 6e67 2e20 5368 6f72 7465 7374 2065  zing. Shortest e
+00002510: 6467 6520 6f66 2074 6865 2069 6d61 6765  dge of the image
+00002520: 2069 7320 7265 7369 7a65 6420 746f 2073   is resized to s
+00002530: 697a 655b 2273 686f 7274 6573 745f 6564  ize["shortest_ed
+00002540: 6765 225d 2c20 7769 7468 0a20 2020 2020  ge"], with.     
+00002550: 2020 2020 2020 2020 2020 2074 6865 206c             the l
+00002560: 6f6e 6765 7374 2065 6467 6520 7265 7369  ongest edge resi
+00002570: 7a65 6420 746f 206b 6565 7020 7468 6520  zed to keep the 
+00002580: 696e 7075 7420 6173 7065 6374 2072 6174  input aspect rat
+00002590: 696f 2e0a 2020 2020 2020 2020 2020 2020  io..            
+000025a0: 7265 7361 6d70 6c65 2028 6069 6e74 602c  resample (`int`,
+000025b0: 202a 6f70 7469 6f6e 616c 2a2c 2064 6566   *optional*, def
+000025c0: 6175 6c74 7320 746f 2060 7365 6c66 2e72  aults to `self.r
+000025d0: 6573 616d 706c 6560 293a 0a20 2020 2020  esample`):.     
+000025e0: 2020 2020 2020 2020 2020 2052 6573 616d             Resam
+000025f0: 706c 696e 6720 6669 6c74 6572 2074 6f20  pling filter to 
+00002600: 7573 6520 6966 2072 6573 697a 696e 6720  use if resizing 
+00002610: 7468 6520 696d 6167 652e 2054 6869 7320  the image. This 
+00002620: 6361 6e20 6265 206f 6e65 206f 6620 7468  can be one of th
+00002630: 6520 656e 756d 2060 5049 4c49 6d61 6765  e enum `PILImage
+00002640: 5265 7361 6d70 6c69 6e67 602e 204f 6e6c  Resampling`. Onl
+00002650: 790a 2020 2020 2020 2020 2020 2020 2020  y.              
+00002660: 2020 6861 7320 616e 2065 6666 6563 7420    has an effect 
+00002670: 6966 2060 646f 5f72 6573 697a 6560 2069  if `do_resize` i
+00002680: 7320 7365 7420 746f 2060 5472 7565 602e  s set to `True`.
+00002690: 0a20 2020 2020 2020 2020 2020 2064 6f5f  .            do_
+000026a0: 6365 6e74 6572 5f63 726f 7020 2860 626f  center_crop (`bo
+000026b0: 6f6c 602c 202a 6f70 7469 6f6e 616c 2a2c  ol`, *optional*,
+000026c0: 2064 6566 6175 6c74 7320 746f 2060 7365   defaults to `se
+000026d0: 6c66 2e64 6f5f 6365 6e74 6572 5f63 726f  lf.do_center_cro
+000026e0: 7060 293a 0a20 2020 2020 2020 2020 2020  p`):.           
+000026f0: 2020 2020 2057 6865 7468 6572 2074 6f20       Whether to 
+00002700: 6365 6e74 6572 2063 726f 7020 7468 6520  center crop the 
+00002710: 696d 6167 652e 0a20 2020 2020 2020 2020  image..         
+00002720: 2020 2063 726f 705f 7369 7a65 2028 6044     crop_size (`D
+00002730: 6963 745b 7374 722c 2069 6e74 5d60 2c20  ict[str, int]`, 
+00002740: 2a6f 7074 696f 6e61 6c2a 2c20 6465 6661  *optional*, defa
+00002750: 756c 7473 2074 6f20 6073 656c 662e 6372  ults to `self.cr
+00002760: 6f70 5f73 697a 6560 293a 0a20 2020 2020  op_size`):.     
+00002770: 2020 2020 2020 2020 2020 2053 697a 6520             Size 
+00002780: 6f66 2074 6865 2063 656e 7465 7220 6372  of the center cr
+00002790: 6f70 2e20 4f6e 6c79 2068 6173 2061 6e20  op. Only has an 
+000027a0: 6566 6665 6374 2069 6620 6064 6f5f 6365  effect if `do_ce
+000027b0: 6e74 6572 5f63 726f 7060 2069 7320 7365  nter_crop` is se
+000027c0: 7420 746f 2060 5472 7565 602e 0a20 2020  t to `True`..   
+000027d0: 2020 2020 2020 2020 2064 6f5f 7265 7363           do_resc
+000027e0: 616c 6520 2860 626f 6f6c 602c 202a 6f70  ale (`bool`, *op
+000027f0: 7469 6f6e 616c 2a2c 2064 6566 6175 6c74  tional*, default
+00002800: 7320 746f 2060 7365 6c66 2e64 6f5f 7265  s to `self.do_re
+00002810: 7363 616c 6560 293a 0a20 2020 2020 2020  scale`):.       
+00002820: 2020 2020 2020 2020 2057 6865 7468 6572           Whether
+00002830: 2074 6f20 7265 7363 616c 6520 7468 6520   to rescale the 
+00002840: 696d 6167 652e 0a20 2020 2020 2020 2020  image..         
+00002850: 2020 2072 6573 6361 6c65 5f66 6163 746f     rescale_facto
+00002860: 7220 2860 666c 6f61 7460 2c20 2a6f 7074  r (`float`, *opt
+00002870: 696f 6e61 6c2a 2c20 6465 6661 756c 7473  ional*, defaults
+00002880: 2074 6f20 6073 656c 662e 7265 7363 616c   to `self.rescal
+00002890: 655f 6661 6374 6f72 6029 3a0a 2020 2020  e_factor`):.    
+000028a0: 2020 2020 2020 2020 2020 2020 5265 7363              Resc
+000028b0: 616c 6520 6661 6374 6f72 2074 6f20 7265  ale factor to re
+000028c0: 7363 616c 6520 7468 6520 696d 6167 6520  scale the image 
+000028d0: 6279 2069 6620 6064 6f5f 7265 7363 616c  by if `do_rescal
+000028e0: 6560 2069 7320 7365 7420 746f 2060 5472  e` is set to `Tr
+000028f0: 7565 602e 0a20 2020 2020 2020 2020 2020  ue`..           
+00002900: 2064 6f5f 6e6f 726d 616c 697a 6520 2860   do_normalize (`
+00002910: 626f 6f6c 602c 202a 6f70 7469 6f6e 616c  bool`, *optional
+00002920: 2a2c 2064 6566 6175 6c74 7320 746f 2060  *, defaults to `
+00002930: 7365 6c66 2e64 6f5f 6e6f 726d 616c 697a  self.do_normaliz
+00002940: 6560 293a 0a20 2020 2020 2020 2020 2020  e`):.           
+00002950: 2020 2020 2057 6865 7468 6572 2074 6f20       Whether to 
+00002960: 6e6f 726d 616c 697a 6520 7468 6520 696d  normalize the im
+00002970: 6167 652e 0a20 2020 2020 2020 2020 2020  age..           
+00002980: 2069 6d61 6765 5f6d 6561 6e20 2860 666c   image_mean (`fl
+00002990: 6f61 7460 206f 7220 604c 6973 745b 666c  oat` or `List[fl
+000029a0: 6f61 745d 602c 202a 6f70 7469 6f6e 616c  oat]`, *optional
+000029b0: 2a2c 2064 6566 6175 6c74 7320 746f 2060  *, defaults to `
+000029c0: 7365 6c66 2e69 6d61 6765 5f6d 6561 6e60  self.image_mean`
+000029d0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000029e0: 2020 2049 6d61 6765 206d 6561 6e20 746f     Image mean to
+000029f0: 2075 7365 2066 6f72 206e 6f72 6d61 6c69   use for normali
+00002a00: 7a61 7469 6f6e 2e20 4f6e 6c79 2068 6173  zation. Only has
+00002a10: 2061 6e20 6566 6665 6374 2069 6620 6064   an effect if `d
+00002a20: 6f5f 6e6f 726d 616c 697a 6560 2069 7320  o_normalize` is 
+00002a30: 7365 7420 746f 2060 5472 7565 602e 0a20  set to `True`.. 
+00002a40: 2020 2020 2020 2020 2020 2069 6d61 6765             image
+00002a50: 5f73 7464 2028 6066 6c6f 6174 6020 6f72  _std (`float` or
+00002a60: 2060 4c69 7374 5b66 6c6f 6174 5d60 2c20   `List[float]`, 
+00002a70: 2a6f 7074 696f 6e61 6c2a 2c20 6465 6661  *optional*, defa
+00002a80: 756c 7473 2074 6f20 6073 656c 662e 696d  ults to `self.im
+00002a90: 6167 655f 7374 6460 293a 0a20 2020 2020  age_std`):.     
+00002aa0: 2020 2020 2020 2020 2020 2049 6d61 6765             Image
+00002ab0: 2073 7461 6e64 6172 6420 6465 7669 6174   standard deviat
+00002ac0: 696f 6e20 746f 2075 7365 2066 6f72 206e  ion to use for n
+00002ad0: 6f72 6d61 6c69 7a61 7469 6f6e 2e20 4f6e  ormalization. On
+00002ae0: 6c79 2068 6173 2061 6e20 6566 6665 6374  ly has an effect
+00002af0: 2069 6620 6064 6f5f 6e6f 726d 616c 697a   if `do_normaliz
+00002b00: 6560 2069 7320 7365 7420 746f 0a20 2020  e` is set to.   
+00002b10: 2020 2020 2020 2020 2020 2020 2060 5472               `Tr
+00002b20: 7565 602e 0a20 2020 2020 2020 2020 2020  ue`..           
+00002b30: 2064 6f5f 636f 6e76 6572 745f 7267 6220   do_convert_rgb 
+00002b40: 2860 626f 6f6c 602c 202a 6f70 7469 6f6e  (`bool`, *option
+00002b50: 616c 2a2c 2064 6566 6175 6c74 7320 746f  al*, defaults to
+00002b60: 2060 7365 6c66 2e64 6f5f 636f 6e76 6572   `self.do_conver
+00002b70: 745f 7267 6260 293a 0a20 2020 2020 2020  t_rgb`):.       
+00002b80: 2020 2020 2020 2020 2057 6865 7468 6572           Whether
+00002b90: 2074 6f20 636f 6e76 6572 7420 7468 6520   to convert the 
+00002ba0: 696d 6167 6520 746f 2052 4742 2e0a 2020  image to RGB..  
+00002bb0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00002bc0: 5f74 656e 736f 7273 2028 6073 7472 6020  _tensors (`str` 
+00002bd0: 6f72 2060 5465 6e73 6f72 5479 7065 602c  or `TensorType`,
+00002be0: 202a 6f70 7469 6f6e 616c 2a29 3a0a 2020   *optional*):.  
+00002bf0: 2020 2020 2020 2020 2020 2020 2020 5468                Th
+00002c00: 6520 7479 7065 206f 6620 7465 6e73 6f72  e type of tensor
+00002c10: 7320 746f 2072 6574 7572 6e2e 2043 616e  s to return. Can
+00002c20: 2062 6520 6f6e 6520 6f66 3a0a 2020 2020   be one of:.    
+00002c30: 2020 2020 2020 2020 2020 2020 2d20 556e              - Un
+00002c40: 7365 743a 2052 6574 7572 6e20 6120 6c69  set: Return a li
+00002c50: 7374 206f 6620 606e 702e 6e64 6172 7261  st of `np.ndarra
+00002c60: 7960 2e0a 2020 2020 2020 2020 2020 2020  y`..            
+00002c70: 2020 2020 2d20 6054 656e 736f 7254 7970      - `TensorTyp
+00002c80: 652e 5445 4e53 4f52 464c 4f57 6020 6f72  e.TENSORFLOW` or
+00002c90: 2060 2774 6627 603a 2052 6574 7572 6e20   `'tf'`: Return 
+00002ca0: 6120 6261 7463 6820 6f66 2074 7970 6520  a batch of type 
+00002cb0: 6074 662e 5465 6e73 6f72 602e 0a20 2020  `tf.Tensor`..   
+00002cc0: 2020 2020 2020 2020 2020 2020 202d 2060               - `
+00002cd0: 5465 6e73 6f72 5479 7065 2e50 5954 4f52  TensorType.PYTOR
+00002ce0: 4348 6020 6f72 2060 2770 7427 603a 2052  CH` or `'pt'`: R
+00002cf0: 6574 7572 6e20 6120 6261 7463 6820 6f66  eturn a batch of
+00002d00: 2074 7970 6520 6074 6f72 6368 2e54 656e   type `torch.Ten
+00002d10: 736f 7260 2e0a 2020 2020 2020 2020 2020  sor`..          
+00002d20: 2020 2020 2020 2d20 6054 656e 736f 7254        - `TensorT
+00002d30: 7970 652e 4e55 4d50 5960 206f 7220 6027  ype.NUMPY` or `'
+00002d40: 6e70 2760 3a20 5265 7475 726e 2061 2062  np'`: Return a b
+00002d50: 6174 6368 206f 6620 7479 7065 2060 6e70  atch of type `np
+00002d60: 2e6e 6461 7272 6179 602e 0a20 2020 2020  .ndarray`..     
+00002d70: 2020 2020 2020 2020 2020 202d 2060 5465             - `Te
+00002d80: 6e73 6f72 5479 7065 2e4a 4158 6020 6f72  nsorType.JAX` or
+00002d90: 2060 276a 6178 2760 3a20 5265 7475 726e   `'jax'`: Return
+00002da0: 2061 2062 6174 6368 206f 6620 7479 7065   a batch of type
+00002db0: 2060 6a61 782e 6e75 6d70 792e 6e64 6172   `jax.numpy.ndar
+00002dc0: 7261 7960 2e0a 2020 2020 2020 2020 2020  ray`..          
+00002dd0: 2020 6461 7461 5f66 6f72 6d61 7420 2860    data_format (`
+00002de0: 4368 616e 6e65 6c44 696d 656e 7369 6f6e  ChannelDimension
+00002df0: 6020 6f72 2060 7374 7260 2c20 2a6f 7074  ` or `str`, *opt
+00002e00: 696f 6e61 6c2a 2c20 6465 6661 756c 7473  ional*, defaults
+00002e10: 2074 6f20 6043 6861 6e6e 656c 4469 6d65   to `ChannelDime
+00002e20: 6e73 696f 6e2e 4649 5253 5460 293a 0a20  nsion.FIRST`):. 
+00002e30: 2020 2020 2020 2020 2020 2020 2020 2054                 T
+00002e40: 6865 2063 6861 6e6e 656c 2064 696d 656e  he channel dimen
+00002e50: 7369 6f6e 2066 6f72 6d61 7420 666f 7220  sion format for 
+00002e60: 7468 6520 6f75 7470 7574 2069 6d61 6765  the output image
+00002e70: 2e20 4361 6e20 6265 206f 6e65 206f 663a  . Can be one of:
+00002e80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00002e90: 202d 2060 2263 6861 6e6e 656c 735f 6669   - `"channels_fi
+00002ea0: 7273 7422 6020 6f72 2060 4368 616e 6e65  rst"` or `Channe
+00002eb0: 6c44 696d 656e 7369 6f6e 2e46 4952 5354  lDimension.FIRST
+00002ec0: 603a 2069 6d61 6765 2069 6e20 286e 756d  `: image in (num
+00002ed0: 5f63 6861 6e6e 656c 732c 2068 6569 6768  _channels, heigh
+00002ee0: 742c 2077 6964 7468 2920 666f 726d 6174  t, width) format
+00002ef0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00002f00: 2020 2d20 6022 6368 616e 6e65 6c73 5f6c    - `"channels_l
+00002f10: 6173 7422 6020 6f72 2060 4368 616e 6e65  ast"` or `Channe
+00002f20: 6c44 696d 656e 7369 6f6e 2e4c 4153 5460  lDimension.LAST`
+00002f30: 3a20 696d 6167 6520 696e 2028 6865 6967  : image in (heig
+00002f40: 6874 2c20 7769 6474 682c 206e 756d 5f63  ht, width, num_c
+00002f50: 6861 6e6e 656c 7329 2066 6f72 6d61 742e  hannels) format.
+00002f60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00002f70: 202d 2055 6e73 6574 3a20 5573 6520 7468   - Unset: Use th
+00002f80: 6520 6368 616e 6e65 6c20 6469 6d65 6e73  e channel dimens
+00002f90: 696f 6e20 666f 726d 6174 206f 6620 7468  ion format of th
+00002fa0: 6520 696e 7075 7420 696d 6167 652e 0a20  e input image.. 
+00002fb0: 2020 2020 2020 2020 2020 2069 6e70 7574             input
+00002fc0: 5f64 6174 615f 666f 726d 6174 2028 6043  _data_format (`C
+00002fd0: 6861 6e6e 656c 4469 6d65 6e73 696f 6e60  hannelDimension`
+00002fe0: 206f 7220 6073 7472 602c 202a 6f70 7469   or `str`, *opti
+00002ff0: 6f6e 616c 2a29 3a0a 2020 2020 2020 2020  onal*):.        
+00003000: 2020 2020 2020 2020 5468 6520 6368 616e          The chan
+00003010: 6e65 6c20 6469 6d65 6e73 696f 6e20 666f  nel dimension fo
+00003020: 726d 6174 2066 6f72 2074 6865 2069 6e70  rmat for the inp
+00003030: 7574 2069 6d61 6765 2e20 4966 2075 6e73  ut image. If uns
+00003040: 6574 2c20 7468 6520 6368 616e 6e65 6c20  et, the channel 
+00003050: 6469 6d65 6e73 696f 6e20 666f 726d 6174  dimension format
+00003060: 2069 7320 696e 6665 7272 6564 0a20 2020   is inferred.   
+00003070: 2020 2020 2020 2020 2020 2020 2066 726f               fro
+00003080: 6d20 7468 6520 696e 7075 7420 696d 6167  m the input imag
+00003090: 652e 2043 616e 2062 6520 6f6e 6520 6f66  e. Can be one of
+000030a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000030b0: 2020 2d20 6022 6368 616e 6e65 6c73 5f66    - `"channels_f
+000030c0: 6972 7374 2260 206f 7220 6043 6861 6e6e  irst"` or `Chann
+000030d0: 656c 4469 6d65 6e73 696f 6e2e 4649 5253  elDimension.FIRS
+000030e0: 5460 3a20 696d 6167 6520 696e 2028 6e75  T`: image in (nu
+000030f0: 6d5f 6368 616e 6e65 6c73 2c20 6865 6967  m_channels, heig
+00003100: 6874 2c20 7769 6474 6829 2066 6f72 6d61  ht, width) forma
+00003110: 742e 0a20 2020 2020 2020 2020 2020 2020  t..             
+00003120: 2020 202d 2060 2263 6861 6e6e 656c 735f     - `"channels_
+00003130: 6c61 7374 2260 206f 7220 6043 6861 6e6e  last"` or `Chann
+00003140: 656c 4469 6d65 6e73 696f 6e2e 4c41 5354  elDimension.LAST
+00003150: 603a 2069 6d61 6765 2069 6e20 2868 6569  `: image in (hei
+00003160: 6768 742c 2077 6964 7468 2c20 6e75 6d5f  ght, width, num_
+00003170: 6368 616e 6e65 6c73 2920 666f 726d 6174  channels) format
+00003180: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00003190: 2020 2d20 6022 6e6f 6e65 2260 206f 7220    - `"none"` or 
+000031a0: 6043 6861 6e6e 656c 4469 6d65 6e73 696f  `ChannelDimensio
+000031b0: 6e2e 4e4f 4e45 603a 2069 6d61 6765 2069  n.NONE`: image i
+000031c0: 6e20 2868 6569 6768 742c 2077 6964 7468  n (height, width
+000031d0: 2920 666f 726d 6174 2e0a 2020 2020 2020  ) format..      
+000031e0: 2020 2222 220a 2020 2020 2020 2020 646f    """.        do
+000031f0: 5f72 6573 697a 6520 3d20 646f 5f72 6573  _resize = do_res
+00003200: 697a 6520 6966 2064 6f5f 7265 7369 7a65  ize if do_resize
+00003210: 2069 7320 6e6f 7420 4e6f 6e65 2065 6c73   is not None els
+00003220: 6520 7365 6c66 2e64 6f5f 7265 7369 7a65  e self.do_resize
+00003230: 0a20 2020 2020 2020 2073 697a 6520 3d20  .        size = 
+00003240: 7369 7a65 2069 6620 7369 7a65 2069 7320  size if size is 
+00003250: 6e6f 7420 4e6f 6e65 2065 6c73 6520 7365  not None else se
+00003260: 6c66 2e73 697a 650a 2020 2020 2020 2020  lf.size.        
+00003270: 7369 7a65 203d 2067 6574 5f73 697a 655f  size = get_size_
+00003280: 6469 6374 2873 697a 652c 2070 6172 616d  dict(size, param
+00003290: 5f6e 616d 653d 2273 697a 6522 2c20 6465  _name="size", de
+000032a0: 6661 756c 745f 746f 5f73 7175 6172 653d  fault_to_square=
+000032b0: 4661 6c73 6529 0a20 2020 2020 2020 2072  False).        r
+000032c0: 6573 616d 706c 6520 3d20 7265 7361 6d70  esample = resamp
+000032d0: 6c65 2069 6620 7265 7361 6d70 6c65 2069  le if resample i
+000032e0: 7320 6e6f 7420 4e6f 6e65 2065 6c73 6520  s not None else 
+000032f0: 7365 6c66 2e72 6573 616d 706c 650a 2020  self.resample.  
+00003300: 2020 2020 2020 646f 5f63 656e 7465 725f        do_center_
+00003310: 6372 6f70 203d 2064 6f5f 6365 6e74 6572  crop = do_center
+00003320: 5f63 726f 7020 6966 2064 6f5f 6365 6e74  _crop if do_cent
+00003330: 6572 5f63 726f 7020 6973 206e 6f74 204e  er_crop is not N
+00003340: 6f6e 6520 656c 7365 2073 656c 662e 646f  one else self.do
+00003350: 5f63 656e 7465 725f 6372 6f70 0a20 2020  _center_crop.   
+00003360: 2020 2020 2063 726f 705f 7369 7a65 203d       crop_size =
+00003370: 2063 726f 705f 7369 7a65 2069 6620 6372   crop_size if cr
+00003380: 6f70 5f73 697a 6520 6973 206e 6f74 204e  op_size is not N
+00003390: 6f6e 6520 656c 7365 2073 656c 662e 6372  one else self.cr
+000033a0: 6f70 5f73 697a 650a 2020 2020 2020 2020  op_size.        
+000033b0: 6372 6f70 5f73 697a 6520 3d20 6765 745f  crop_size = get_
+000033c0: 7369 7a65 5f64 6963 7428 6372 6f70 5f73  size_dict(crop_s
+000033d0: 697a 652c 2070 6172 616d 5f6e 616d 653d  ize, param_name=
+000033e0: 2263 726f 705f 7369 7a65 222c 2064 6566  "crop_size", def
+000033f0: 6175 6c74 5f74 6f5f 7371 7561 7265 3d54  ault_to_square=T
+00003400: 7275 6529 0a20 2020 2020 2020 2064 6f5f  rue).        do_
+00003410: 7265 7363 616c 6520 3d20 646f 5f72 6573  rescale = do_res
+00003420: 6361 6c65 2069 6620 646f 5f72 6573 6361  cale if do_resca
+00003430: 6c65 2069 7320 6e6f 7420 4e6f 6e65 2065  le is not None e
+00003440: 6c73 6520 7365 6c66 2e64 6f5f 7265 7363  lse self.do_resc
+00003450: 616c 650a 2020 2020 2020 2020 7265 7363  ale.        resc
+00003460: 616c 655f 6661 6374 6f72 203d 2072 6573  ale_factor = res
+00003470: 6361 6c65 5f66 6163 746f 7220 6966 2072  cale_factor if r
+00003480: 6573 6361 6c65 5f66 6163 746f 7220 6973  escale_factor is
+00003490: 206e 6f74 204e 6f6e 6520 656c 7365 2073   not None else s
+000034a0: 656c 662e 7265 7363 616c 655f 6661 6374  elf.rescale_fact
+000034b0: 6f72 0a20 2020 2020 2020 2064 6f5f 6e6f  or.        do_no
+000034c0: 726d 616c 697a 6520 3d20 646f 5f6e 6f72  rmalize = do_nor
+000034d0: 6d61 6c69 7a65 2069 6620 646f 5f6e 6f72  malize if do_nor
+000034e0: 6d61 6c69 7a65 2069 7320 6e6f 7420 4e6f  malize is not No
+000034f0: 6e65 2065 6c73 6520 7365 6c66 2e64 6f5f  ne else self.do_
+00003500: 6e6f 726d 616c 697a 650a 2020 2020 2020  normalize.      
+00003510: 2020 696d 6167 655f 6d65 616e 203d 2069    image_mean = i
+00003520: 6d61 6765 5f6d 6561 6e20 6966 2069 6d61  mage_mean if ima
+00003530: 6765 5f6d 6561 6e20 6973 206e 6f74 204e  ge_mean is not N
+00003540: 6f6e 6520 656c 7365 2073 656c 662e 696d  one else self.im
+00003550: 6167 655f 6d65 616e 0a20 2020 2020 2020  age_mean.       
+00003560: 2069 6d61 6765 5f73 7464 203d 2069 6d61   image_std = ima
+00003570: 6765 5f73 7464 2069 6620 696d 6167 655f  ge_std if image_
+00003580: 7374 6420 6973 206e 6f74 204e 6f6e 6520  std is not None 
+00003590: 656c 7365 2073 656c 662e 696d 6167 655f  else self.image_
+000035a0: 7374 640a 2020 2020 2020 2020 646f 5f63  std.        do_c
+000035b0: 6f6e 7665 7274 5f72 6762 203d 2064 6f5f  onvert_rgb = do_
+000035c0: 636f 6e76 6572 745f 7267 6220 6966 2064  convert_rgb if d
+000035d0: 6f5f 636f 6e76 6572 745f 7267 6220 6973  o_convert_rgb is
+000035e0: 206e 6f74 204e 6f6e 6520 656c 7365 2073   not None else s
+000035f0: 656c 662e 646f 5f63 6f6e 7665 7274 5f72  elf.do_convert_r
+00003600: 6762 0a0a 2020 2020 2020 2020 7661 6c69  gb..        vali
+00003610: 6461 7465 5f6b 7761 7267 7328 6361 7074  date_kwargs(capt
+00003620: 7572 6564 5f6b 7761 7267 733d 6b77 6172  ured_kwargs=kwar
+00003630: 6773 2e6b 6579 7328 292c 2076 616c 6964  gs.keys(), valid
+00003640: 5f70 726f 6365 7373 6f72 5f6b 6579 733d  _processor_keys=
+00003650: 7365 6c66 2e5f 7661 6c69 645f 7072 6f63  self._valid_proc
+00003660: 6573 736f 725f 6b65 7973 290a 0a20 2020  essor_keys)..   
+00003670: 2020 2020 2069 6d61 6765 7320 3d20 6d61       images = ma
+00003680: 6b65 5f6c 6973 745f 6f66 5f69 6d61 6765  ke_list_of_image
+00003690: 7328 696d 6167 6573 290a 0a20 2020 2020  s(images)..     
+000036a0: 2020 2069 6620 6e6f 7420 7661 6c69 645f     if not valid_
+000036b0: 696d 6167 6573 2869 6d61 6765 7329 3a0a  images(images):.
+000036c0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+000036d0: 6520 5661 6c75 6545 7272 6f72 280a 2020  e ValueError(.  
+000036e0: 2020 2020 2020 2020 2020 2020 2020 2249                "I
+000036f0: 6e76 616c 6964 2069 6d61 6765 2074 7970  nvalid image typ
+00003700: 652e 204d 7573 7420 6265 206f 6620 7479  e. Must be of ty
+00003710: 7065 2050 494c 2e49 6d61 6765 2e49 6d61  pe PIL.Image.Ima
+00003720: 6765 2c20 6e75 6d70 792e 6e64 6172 7261  ge, numpy.ndarra
+00003730: 792c 2022 0a20 2020 2020 2020 2020 2020  y, ".           
+00003740: 2020 2020 2022 746f 7263 682e 5465 6e73       "torch.Tens
+00003750: 6f72 2c20 7466 2e54 656e 736f 7220 6f72  or, tf.Tensor or
+00003760: 206a 6178 2e6e 6461 7272 6179 2e22 0a20   jax.ndarray.". 
+00003770: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00003780: 2020 2020 2020 7661 6c69 6461 7465 5f70        validate_p
+00003790: 7265 7072 6f63 6573 735f 6172 6775 6d65  reprocess_argume
+000037a0: 6e74 7328 0a20 2020 2020 2020 2020 2020  nts(.           
+000037b0: 2064 6f5f 7265 7363 616c 653d 646f 5f72   do_rescale=do_r
+000037c0: 6573 6361 6c65 2c0a 2020 2020 2020 2020  escale,.        
+000037d0: 2020 2020 7265 7363 616c 655f 6661 6374      rescale_fact
+000037e0: 6f72 3d72 6573 6361 6c65 5f66 6163 746f  or=rescale_facto
+000037f0: 722c 0a20 2020 2020 2020 2020 2020 2064  r,.            d
+00003800: 6f5f 6e6f 726d 616c 697a 653d 646f 5f6e  o_normalize=do_n
+00003810: 6f72 6d61 6c69 7a65 2c0a 2020 2020 2020  ormalize,.      
+00003820: 2020 2020 2020 696d 6167 655f 6d65 616e        image_mean
+00003830: 3d69 6d61 6765 5f6d 6561 6e2c 0a20 2020  =image_mean,.   
+00003840: 2020 2020 2020 2020 2069 6d61 6765 5f73           image_s
+00003850: 7464 3d69 6d61 6765 5f73 7464 2c0a 2020  td=image_std,.  
+00003860: 2020 2020 2020 2020 2020 646f 5f63 656e            do_cen
+00003870: 7465 725f 6372 6f70 3d64 6f5f 6365 6e74  ter_crop=do_cent
+00003880: 6572 5f63 726f 702c 0a20 2020 2020 2020  er_crop,.       
+00003890: 2020 2020 2063 726f 705f 7369 7a65 3d63       crop_size=c
+000038a0: 726f 705f 7369 7a65 2c0a 2020 2020 2020  rop_size,.      
+000038b0: 2020 2020 2020 646f 5f72 6573 697a 653d        do_resize=
+000038c0: 646f 5f72 6573 697a 652c 0a20 2020 2020  do_resize,.     
+000038d0: 2020 2020 2020 2073 697a 653d 7369 7a65         size=size
+000038e0: 2c0a 2020 2020 2020 2020 2020 2020 7265  ,.            re
+000038f0: 7361 6d70 6c65 3d72 6573 616d 706c 652c  sample=resample,
+00003900: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00003910: 2020 2020 2320 5049 4c20 5247 4241 2069      # PIL RGBA i
+00003920: 6d61 6765 7320 6172 6520 636f 6e76 6572  mages are conver
+00003930: 7465 6420 746f 2052 4742 0a20 2020 2020  ted to RGB.     
+00003940: 2020 2069 6620 646f 5f63 6f6e 7665 7274     if do_convert
+00003950: 5f72 6762 3a0a 2020 2020 2020 2020 2020  _rgb:.          
+00003960: 2020 696d 6167 6573 203d 205b 636f 6e76    images = [conv
+00003970: 6572 745f 746f 5f72 6762 2869 6d61 6765  ert_to_rgb(image
+00003980: 2920 666f 7220 696d 6167 6520 696e 2069  ) for image in i
+00003990: 6d61 6765 735d 0a0a 2020 2020 2020 2020  mages]..        
+000039a0: 2320 416c 6c20 7472 616e 7366 6f72 6d61  # All transforma
+000039b0: 7469 6f6e 7320 6578 7065 6374 206e 756d  tions expect num
+000039c0: 7079 2061 7272 6179 732e 0a20 2020 2020  py arrays..     
+000039d0: 2020 2069 6d61 6765 7320 3d20 5b74 6f5f     images = [to_
+000039e0: 6e75 6d70 795f 6172 7261 7928 696d 6167  numpy_array(imag
+000039f0: 6529 2066 6f72 2069 6d61 6765 2069 6e20  e) for image in 
+00003a00: 696d 6167 6573 5d0a 0a20 2020 2020 2020  images]..       
+00003a10: 2069 6620 6973 5f73 6361 6c65 645f 696d   if is_scaled_im
+00003a20: 6167 6528 696d 6167 6573 5b30 5d29 2061  age(images[0]) a
+00003a30: 6e64 2064 6f5f 7265 7363 616c 653a 0a20  nd do_rescale:. 
+00003a40: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+00003a50: 722e 7761 726e 696e 675f 6f6e 6365 280a  r.warning_once(.
+00003a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003a70: 2249 7420 6c6f 6f6b 7320 6c69 6b65 2079  "It looks like y
+00003a80: 6f75 2061 7265 2074 7279 696e 6720 746f  ou are trying to
+00003a90: 2072 6573 6361 6c65 2061 6c72 6561 6479   rescale already
+00003aa0: 2072 6573 6361 6c65 6420 696d 6167 6573   rescaled images
+00003ab0: 2e20 4966 2074 6865 2069 6e70 7574 220a  . If the input".
+00003ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003ad0: 2220 696d 6167 6573 2068 6176 6520 7069  " images have pi
+00003ae0: 7865 6c20 7661 6c75 6573 2062 6574 7765  xel values betwe
+00003af0: 656e 2030 2061 6e64 2031 2c20 7365 7420  en 0 and 1, set 
+00003b00: 6064 6f5f 7265 7363 616c 653d 4661 6c73  `do_rescale=Fals
+00003b10: 6560 2074 6f20 6176 6f69 6420 7265 7363  e` to avoid resc
+00003b20: 616c 696e 6720 7468 656d 2061 6761 696e  aling them again
+00003b30: 2e22 0a20 2020 2020 2020 2020 2020 2029  .".            )
+00003b40: 0a0a 2020 2020 2020 2020 6966 2069 6e70  ..        if inp
+00003b50: 7574 5f64 6174 615f 666f 726d 6174 2069  ut_data_format i
+00003b60: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+00003b70: 2020 2020 2320 5765 2061 7373 756d 6520      # We assume 
+00003b80: 7468 6174 2061 6c6c 2069 6d61 6765 7320  that all images 
+00003b90: 6861 7665 2074 6865 2073 616d 6520 6368  have the same ch
+00003ba0: 616e 6e65 6c20 6469 6d65 6e73 696f 6e20  annel dimension 
+00003bb0: 666f 726d 6174 2e0a 2020 2020 2020 2020  format..        
+00003bc0: 2020 2020 696e 7075 745f 6461 7461 5f66      input_data_f
+00003bd0: 6f72 6d61 7420 3d20 696e 6665 725f 6368  ormat = infer_ch
+00003be0: 616e 6e65 6c5f 6469 6d65 6e73 696f 6e5f  annel_dimension_
+00003bf0: 666f 726d 6174 2869 6d61 6765 735b 305d  format(images[0]
+00003c00: 290a 0a20 2020 2020 2020 2069 6620 646f  )..        if do
+00003c10: 5f72 6573 697a 653a 0a20 2020 2020 2020  _resize:.       
+00003c20: 2020 2020 2069 6d61 6765 7320 3d20 5b0a       images = [.
+00003c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003c40: 7365 6c66 2e72 6573 697a 6528 696d 6167  self.resize(imag
+00003c50: 653d 696d 6167 652c 2073 697a 653d 7369  e=image, size=si
+00003c60: 7a65 2c20 7265 7361 6d70 6c65 3d72 6573  ze, resample=res
+00003c70: 616d 706c 652c 2069 6e70 7574 5f64 6174  ample, input_dat
+00003c80: 615f 666f 726d 6174 3d69 6e70 7574 5f64  a_format=input_d
+00003c90: 6174 615f 666f 726d 6174 290a 2020 2020  ata_format).    
+00003ca0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00003cb0: 696d 6167 6520 696e 2069 6d61 6765 730a  image in images.
+00003cc0: 2020 2020 2020 2020 2020 2020 5d0a 0a20              ].. 
+00003cd0: 2020 2020 2020 2069 6620 646f 5f63 656e         if do_cen
+00003ce0: 7465 725f 6372 6f70 3a0a 2020 2020 2020  ter_crop:.      
+00003cf0: 2020 2020 2020 696d 6167 6573 203d 205b        images = [
+00003d00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003d10: 2073 656c 662e 6365 6e74 6572 5f63 726f   self.center_cro
+00003d20: 7028 696d 6167 653d 696d 6167 652c 2073  p(image=image, s
+00003d30: 697a 653d 6372 6f70 5f73 697a 652c 2069  ize=crop_size, i
+00003d40: 6e70 7574 5f64 6174 615f 666f 726d 6174  nput_data_format
+00003d50: 3d69 6e70 7574 5f64 6174 615f 666f 726d  =input_data_form
+00003d60: 6174 2920 666f 7220 696d 6167 6520 696e  at) for image in
+00003d70: 2069 6d61 6765 730a 2020 2020 2020 2020   images.        
+00003d80: 2020 2020 5d0a 0a20 2020 2020 2020 2069      ]..        i
+00003d90: 6620 646f 5f72 6573 6361 6c65 3a0a 2020  f do_rescale:.  
+00003da0: 2020 2020 2020 2020 2020 696d 6167 6573            images
+00003db0: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
+00003dc0: 2020 2020 2073 656c 662e 7265 7363 616c       self.rescal
+00003dd0: 6528 696d 6167 653d 696d 6167 652c 2073  e(image=image, s
+00003de0: 6361 6c65 3d72 6573 6361 6c65 5f66 6163  cale=rescale_fac
+00003df0: 746f 722c 2069 6e70 7574 5f64 6174 615f  tor, input_data_
+00003e00: 666f 726d 6174 3d69 6e70 7574 5f64 6174  format=input_dat
+00003e10: 615f 666f 726d 6174 290a 2020 2020 2020  a_format).      
+00003e20: 2020 2020 2020 2020 2020 666f 7220 696d            for im
+00003e30: 6167 6520 696e 2069 6d61 6765 730a 2020  age in images.  
+00003e40: 2020 2020 2020 2020 2020 5d0a 0a20 2020            ]..   
+00003e50: 2020 2020 2069 6620 646f 5f6e 6f72 6d61       if do_norma
+00003e60: 6c69 7a65 3a0a 2020 2020 2020 2020 2020  lize:.          
+00003e70: 2020 696d 6167 6573 203d 205b 0a20 2020    images = [.   
+00003e80: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00003e90: 662e 6e6f 726d 616c 697a 6528 696d 6167  f.normalize(imag
+00003ea0: 653d 696d 6167 652c 206d 6561 6e3d 696d  e=image, mean=im
+00003eb0: 6167 655f 6d65 616e 2c20 7374 643d 696d  age_mean, std=im
+00003ec0: 6167 655f 7374 642c 2069 6e70 7574 5f64  age_std, input_d
+00003ed0: 6174 615f 666f 726d 6174 3d69 6e70 7574  ata_format=input
+00003ee0: 5f64 6174 615f 666f 726d 6174 290a 2020  _data_format).  
+00003ef0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00003f00: 7220 696d 6167 6520 696e 2069 6d61 6765  r image in image
+00003f10: 730a 2020 2020 2020 2020 2020 2020 5d0a  s.            ].
+00003f20: 0a20 2020 2020 2020 2069 6d61 6765 7320  .        images 
+00003f30: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+00003f40: 746f 5f63 6861 6e6e 656c 5f64 696d 656e  to_channel_dimen
+00003f50: 7369 6f6e 5f66 6f72 6d61 7428 696d 6167  sion_format(imag
+00003f60: 652c 2064 6174 615f 666f 726d 6174 2c20  e, data_format, 
+00003f70: 696e 7075 745f 6368 616e 6e65 6c5f 6469  input_channel_di
+00003f80: 6d3d 696e 7075 745f 6461 7461 5f66 6f72  m=input_data_for
+00003f90: 6d61 7429 2066 6f72 2069 6d61 6765 2069  mat) for image i
+00003fa0: 6e20 696d 6167 6573 0a20 2020 2020 2020  n images.       
+00003fb0: 205d 0a0a 2020 2020 2020 2020 6461 7461   ]..        data
+00003fc0: 203d 207b 2270 6978 656c 5f76 616c 7565   = {"pixel_value
+00003fd0: 7322 3a20 696d 6167 6573 7d0a 2020 2020  s": images}.    
+00003fe0: 2020 2020 7265 7475 726e 2042 6174 6368      return Batch
+00003ff0: 4665 6174 7572 6528 6461 7461 3d64 6174  Feature(data=dat
+00004000: 612c 2074 656e 736f 725f 7479 7065 3d72  a, tensor_type=r
+00004010: 6574 7572 6e5f 7465 6e73 6f72 7329 0a0a  eturn_tensors)..
+00004020: 5f5f 616c 6c5f 5f20 3d20 5b27 4269 7449  __all__ = ['BitI
+00004030: 6d61 6765 5072 6f63 6573 736f 7227 5d0a  mageProcessor'].
```

## mindnlp/transformers/models/bit/modeling_bit.py

```diff
@@ -0,0 +1,1848 @@
+00000000: 2320 636f 6469 6e67 3d75 7466 2d38 0a23  # coding=utf-8.#
+00000010: 2043 6f70 7972 6967 6874 2032 3032 3220   Copyright 2022 
+00000020: 476f 6f67 6c65 2041 4920 616e 6420 5468  Google AI and Th
+00000030: 6520 4875 6767 696e 6746 6163 6520 496e  e HuggingFace In
+00000040: 632e 2074 6561 6d2e 2041 6c6c 2072 6967  c. team. All rig
+00000050: 6874 7320 7265 7365 7276 6564 2e0a 230a  hts reserved..#.
+00000060: 2320 4c69 6365 6e73 6564 2075 6e64 6572  # Licensed under
+00000070: 2074 6865 2041 7061 6368 6520 4c69 6365   the Apache Lice
+00000080: 6e73 652c 2056 6572 7369 6f6e 2032 2e30  nse, Version 2.0
+00000090: 2028 7468 6520 224c 6963 656e 7365 2229   (the "License")
+000000a0: 3b0a 2320 796f 7520 6d61 7920 6e6f 7420  ;.# you may not 
+000000b0: 7573 6520 7468 6973 2066 696c 6520 6578  use this file ex
+000000c0: 6365 7074 2069 6e20 636f 6d70 6c69 616e  cept in complian
+000000d0: 6365 2077 6974 6820 7468 6520 4c69 6365  ce with the Lice
+000000e0: 6e73 652e 0a23 2059 6f75 206d 6179 206f  nse..# You may o
+000000f0: 6274 6169 6e20 6120 636f 7079 206f 6620  btain a copy of 
+00000100: 7468 6520 4c69 6365 6e73 6520 6174 0a23  the License at.#
+00000110: 0a23 2020 2020 2068 7474 703a 2f2f 7777  .#     http://ww
+00000120: 772e 6170 6163 6865 2e6f 7267 2f6c 6963  w.apache.org/lic
+00000130: 656e 7365 732f 4c49 4345 4e53 452d 322e  enses/LICENSE-2.
+00000140: 300a 230a 2320 556e 6c65 7373 2072 6571  0.#.# Unless req
+00000150: 7569 7265 6420 6279 2061 7070 6c69 6361  uired by applica
+00000160: 626c 6520 6c61 7720 6f72 2061 6772 6565  ble law or agree
+00000170: 6420 746f 2069 6e20 7772 6974 696e 672c  d to in writing,
+00000180: 2073 6f66 7477 6172 650a 2320 6469 7374   software.# dist
+00000190: 7269 6275 7465 6420 756e 6465 7220 7468  ributed under th
+000001a0: 6520 4c69 6365 6e73 6520 6973 2064 6973  e License is dis
+000001b0: 7472 6962 7574 6564 206f 6e20 616e 2022  tributed on an "
+000001c0: 4153 2049 5322 2042 4153 4953 2c0a 2320  AS IS" BASIS,.# 
+000001d0: 5749 5448 4f55 5420 5741 5252 414e 5449  WITHOUT WARRANTI
+000001e0: 4553 204f 5220 434f 4e44 4954 494f 4e53  ES OR CONDITIONS
+000001f0: 204f 4620 414e 5920 4b49 4e44 2c20 6569   OF ANY KIND, ei
+00000200: 7468 6572 2065 7870 7265 7373 206f 7220  ther express or 
+00000210: 696d 706c 6965 642e 0a23 2053 6565 2074  implied..# See t
+00000220: 6865 204c 6963 656e 7365 2066 6f72 2074  he License for t
+00000230: 6865 2073 7065 6369 6669 6320 6c61 6e67  he specific lang
+00000240: 7561 6765 2067 6f76 6572 6e69 6e67 2070  uage governing p
+00000250: 6572 6d69 7373 696f 6e73 2061 6e64 0a23  ermissions and.#
+00000260: 206c 696d 6974 6174 696f 6e73 2075 6e64   limitations und
+00000270: 6572 2074 6865 204c 6963 656e 7365 2e0a  er the License..
+00000280: 2222 2220 4d69 6e64 5370 6f72 6520 4269  """ MindSpore Bi
+00000290: 5420 6d6f 6465 6c2e 2041 6c73 6f20 7375  T model. Also su
+000002a0: 7070 6f72 7473 2062 6163 6b62 6f6e 6520  pports backbone 
+000002b0: 666f 7220 5669 5420 6879 6272 6964 2e22  for ViT hybrid."
+000002c0: 2222 0a0a 696d 706f 7274 2063 6f6c 6c65  ""..import colle
+000002d0: 6374 696f 6e73 0a69 6d70 6f72 7420 6d61  ctions.import ma
+000002e0: 7468 0a66 726f 6d20 7479 7069 6e67 2069  th.from typing i
+000002f0: 6d70 6f72 7420 4f70 7469 6f6e 616c 2c20  mport Optional, 
+00000300: 5475 706c 650a 0a69 6d70 6f72 7420 6e75  Tuple..import nu
+00000310: 6d70 7920 6173 206e 700a 696d 706f 7274  mpy as np.import
+00000320: 206d 696e 6473 706f 7265 0a66 726f 6d20   mindspore.from 
+00000330: 6d69 6e64 7370 6f72 6520 696d 706f 7274  mindspore import
+00000340: 206e 6e2c 206f 7073 0a66 726f 6d20 6d69   nn, ops.from mi
+00000350: 6e64 7370 6f72 652e 636f 6d6d 6f6e 2e69  ndspore.common.i
+00000360: 6e69 7469 616c 697a 6572 2069 6d70 6f72  nitializer impor
+00000370: 7420 696e 6974 6961 6c69 7a65 722c 2048  t initializer, H
+00000380: 654e 6f72 6d61 6c0a 0a66 726f 6d20 2e2e  eNormal..from ..
+00000390: 2e61 6374 6976 6174 696f 6e73 2069 6d70  .activations imp
+000003a0: 6f72 7420 4143 5432 464e 0a66 726f 6d20  ort ACT2FN.from 
+000003b0: 2e2e 2e6d 6f64 656c 696e 675f 6f75 7470  ...modeling_outp
+000003c0: 7574 7320 696d 706f 7274 2028 0a20 2020  uts import (.   
+000003d0: 2042 6163 6b62 6f6e 654f 7574 7075 742c   BackboneOutput,
+000003e0: 0a20 2020 2042 6173 654d 6f64 656c 4f75  .    BaseModelOu
+000003f0: 7470 7574 5769 7468 4e6f 4174 7465 6e74  tputWithNoAttent
+00000400: 696f 6e2c 0a20 2020 2042 6173 654d 6f64  ion,.    BaseMod
+00000410: 656c 4f75 7470 7574 5769 7468 506f 6f6c  elOutputWithPool
+00000420: 696e 6741 6e64 4e6f 4174 7465 6e74 696f  ingAndNoAttentio
+00000430: 6e2c 0a20 2020 2049 6d61 6765 436c 6173  n,.    ImageClas
+00000440: 7369 6669 6572 4f75 7470 7574 5769 7468  sifierOutputWith
+00000450: 4e6f 4174 7465 6e74 696f 6e2c 0a29 0a66  NoAttention,.).f
+00000460: 726f 6d20 2e2e 2e6d 6f64 656c 696e 675f  rom ...modeling_
+00000470: 7574 696c 7320 696d 706f 7274 2050 7265  utils import Pre
+00000480: 5472 6169 6e65 644d 6f64 656c 0a66 726f  TrainedModel.fro
+00000490: 6d20 2e2e 2e2e 7574 696c 7320 696d 706f  m ....utils impo
+000004a0: 7274 206c 6f67 6769 6e67 0a66 726f 6d20  rt logging.from 
+000004b0: 2e2e 2e2e 7574 696c 732e 6261 636b 626f  ....utils.backbo
+000004c0: 6e65 5f75 7469 6c73 2069 6d70 6f72 7420  ne_utils import 
+000004d0: 4261 636b 626f 6e65 4d69 7869 6e0a 6672  BackboneMixin.fr
+000004e0: 6f6d 202e 636f 6e66 6967 7572 6174 696f  om .configuratio
+000004f0: 6e5f 6269 7420 696d 706f 7274 2042 6974  n_bit import Bit
+00000500: 436f 6e66 6967 0a0a 0a6c 6f67 6765 7220  Config...logger 
+00000510: 3d20 6c6f 6767 696e 672e 6765 745f 6c6f  = logging.get_lo
+00000520: 6767 6572 285f 5f6e 616d 655f 5f29 0a0a  gger(__name__)..
+00000530: 2320 4765 6e65 7261 6c20 646f 6373 7472  # General docstr
+00000540: 696e 670a 5f43 4f4e 4649 475f 464f 525f  ing._CONFIG_FOR_
+00000550: 444f 4320 3d20 2242 6974 436f 6e66 6967  DOC = "BitConfig
+00000560: 220a 0a23 2042 6173 6520 646f 6373 7472  "..# Base docstr
+00000570: 696e 670a 5f43 4845 434b 504f 494e 545f  ing._CHECKPOINT_
+00000580: 464f 525f 444f 4320 3d20 2267 6f6f 676c  FOR_DOC = "googl
+00000590: 652f 6269 742d 3530 220a 5f45 5850 4543  e/bit-50"._EXPEC
+000005a0: 5445 445f 4f55 5450 5554 5f53 4841 5045  TED_OUTPUT_SHAPE
+000005b0: 203d 205b 312c 2032 3034 382c 2037 2c20   = [1, 2048, 7, 
+000005c0: 375d 0a0a 2320 496d 6167 6520 636c 6173  7]..# Image clas
+000005d0: 7369 6669 6361 7469 6f6e 2064 6f63 7374  sification docst
+000005e0: 7269 6e67 0a5f 494d 4147 455f 434c 4153  ring._IMAGE_CLAS
+000005f0: 535f 4348 4543 4b50 4f49 4e54 203d 2022  S_CHECKPOINT = "
+00000600: 676f 6f67 6c65 2f62 6974 2d35 3022 0a5f  google/bit-50"._
+00000610: 494d 4147 455f 434c 4153 535f 4558 5045  IMAGE_CLASS_EXPE
+00000620: 4354 4544 5f4f 5554 5055 5420 3d20 2274  CTED_OUTPUT = "t
+00000630: 6967 6572 2063 6174 220a 0a0a 0a64 6566  iger cat"....def
+00000640: 2067 6574 5f70 6164 6469 6e67 5f76 616c   get_padding_val
+00000650: 7565 2870 6164 6469 6e67 3d4e 6f6e 652c  ue(padding=None,
+00000660: 206b 6572 6e65 6c5f 7369 7a65 3d37 2c20   kernel_size=7, 
+00000670: 7374 7269 6465 3d31 2c20 6469 6c61 7469  stride=1, dilati
+00000680: 6f6e 3d31 2920 2d3e 2054 7570 6c65 5b54  on=1) -> Tuple[T
+00000690: 7570 6c65 2c20 626f 6f6c 5d3a 0a20 2020  uple, bool]:.   
+000006a0: 2072 2222 220a 2020 2020 5574 696c 6974   r""".    Utilit
+000006b0: 7920 6675 6e63 7469 6f6e 2074 6f20 6765  y function to ge
+000006c0: 7420 7468 6520 7475 706c 6520 7061 6464  t the tuple padd
+000006d0: 696e 6720 7661 6c75 6520 6769 7665 6e20  ing value given 
+000006e0: 7468 6520 6b65 726e 656c 5f73 697a 6520  the kernel_size 
+000006f0: 616e 6420 7061 6464 696e 672e 0a0a 2020  and padding...  
+00000700: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+00000710: 7061 6464 696e 6720 2855 6e69 6f6e 5b60  padding (Union[`
+00000720: 7374 7260 2c20 6069 6e74 605d 2c20 2a6f  str`, `int`], *o
+00000730: 7074 696f 6e61 6c2a 293a 0a20 2020 2020  ptional*):.     
+00000740: 2020 2020 2020 2050 6164 6469 6e67 2076         Padding v
+00000750: 616c 7565 2c20 6361 6e20 6265 2065 6974  alue, can be eit
+00000760: 6865 7220 6022 7361 6d65 2260 2c20 6022  her `"same"`, `"
+00000770: 7661 6c69 6422 602e 2049 6620 6120 6469  valid"`. If a di
+00000780: 6666 6572 656e 7420 7661 6c75 6520 6973  fferent value is
+00000790: 2070 726f 7669 6465 6420 7468 6520 6465   provided the de
+000007a0: 6661 756c 7420 7061 6464 696e 6720 6672  fault padding fr
+000007b0: 6f6d 0a20 2020 2020 2020 2020 2020 2050  om.            P
+000007c0: 7954 6f72 6368 2069 7320 7573 6564 2e0a  yTorch is used..
+000007d0: 2020 2020 2020 2020 6b65 726e 656c 5f73          kernel_s
+000007e0: 697a 6520 2860 696e 7460 2c20 2a6f 7074  ize (`int`, *opt
+000007f0: 696f 6e61 6c2a 2c20 6465 6661 756c 7473  ional*, defaults
+00000800: 2074 6f20 3729 3a0a 2020 2020 2020 2020   to 7):.        
+00000810: 2020 2020 4b65 726e 656c 2073 697a 6520      Kernel size 
+00000820: 6f66 2074 6865 2063 6f6e 766f 6c75 7469  of the convoluti
+00000830: 6f6e 206c 6179 6572 732e 0a20 2020 2020  on layers..     
+00000840: 2020 2073 7472 6964 6520 2860 696e 7460     stride (`int`
+00000850: 2c20 2a6f 7074 696f 6e61 6c2a 2c20 6465  , *optional*, de
+00000860: 6661 756c 7473 2074 6f20 3129 3a0a 2020  faults to 1):.  
+00000870: 2020 2020 2020 2020 2020 5374 7269 6465            Stride
+00000880: 2076 616c 7565 206f 6620 7468 6520 636f   value of the co
+00000890: 6e76 6f6c 7574 696f 6e20 6c61 7965 7273  nvolution layers
+000008a0: 2e0a 2020 2020 2020 2020 6469 6c61 7469  ..        dilati
+000008b0: 6f6e 2028 6069 6e74 602c 202a 6f70 7469  on (`int`, *opti
+000008c0: 6f6e 616c 2a2c 2064 6566 6175 6c74 7320  onal*, defaults 
+000008d0: 746f 2031 293a 0a20 2020 2020 2020 2020  to 1):.         
+000008e0: 2020 2044 696c 6174 696f 6e20 7661 6c75     Dilation valu
+000008f0: 6520 6f66 2074 6865 2063 6f6e 766f 6c75  e of the convolu
+00000900: 7469 6f6e 206c 6179 6572 732e 0a20 2020  tion layers..   
+00000910: 2022 2222 0a20 2020 2064 796e 616d 6963   """.    dynamic
+00000920: 203d 2046 616c 7365 0a20 2020 2069 6620   = False.    if 
+00000930: 7061 6464 696e 6720 6973 204e 6f6e 653a  padding is None:
+00000940: 0a20 2020 2020 2020 2070 6164 6469 6e67  .        padding
+00000950: 203d 2028 2873 7472 6964 6520 2d20 3129   = ((stride - 1)
+00000960: 202b 2064 696c 6174 696f 6e20 2a20 286b   + dilation * (k
+00000970: 6572 6e65 6c5f 7369 7a65 202d 2031 2929  ernel_size - 1))
+00000980: 202f 2f20 320a 2020 2020 2020 2020 7265   // 2.        re
+00000990: 7475 726e 2070 6164 6469 6e67 2c20 6479  turn padding, dy
+000009a0: 6e61 6d69 630a 0a20 2020 2069 6620 6973  namic..    if is
+000009b0: 696e 7374 616e 6365 2870 6164 6469 6e67  instance(padding
+000009c0: 2c20 7374 7229 3a0a 2020 2020 2020 2020  , str):.        
+000009d0: 2320 666f 7220 616e 7920 7374 7269 6e67  # for any string
+000009e0: 2070 6164 6469 6e67 2c20 7468 6520 7061   padding, the pa
+000009f0: 6464 696e 6720 7769 6c6c 2062 6520 6361  dding will be ca
+00000a00: 6c63 756c 6174 6564 2066 6f72 2079 6f75  lculated for you
+00000a10: 2c20 6f6e 6520 6f66 2074 6872 6565 2077  , one of three w
+00000a20: 6179 730a 2020 2020 2020 2020 7061 6464  ays.        padd
+00000a30: 696e 6720 3d20 7061 6464 696e 672e 6c6f  ing = padding.lo
+00000a40: 7765 7228 290a 2020 2020 2020 2020 6966  wer().        if
+00000a50: 2070 6164 6469 6e67 203d 3d20 2273 616d   padding == "sam
+00000a60: 6522 3a0a 2020 2020 2020 2020 2020 2020  e":.            
+00000a70: 2320 5446 2063 6f6d 7061 7469 626c 6520  # TF compatible 
+00000a80: 2753 414d 4527 2070 6164 6469 6e67 2c20  'SAME' padding, 
+00000a90: 6861 7320 6120 7065 7266 6f72 6d61 6e63  has a performanc
+00000aa0: 6520 616e 6420 4750 5520 6d65 6d6f 7279  e and GPU memory
+00000ab0: 2061 6c6c 6f63 6174 696f 6e20 696d 7061   allocation impa
+00000ac0: 6374 0a20 2020 2020 2020 2020 2020 2069  ct.            i
+00000ad0: 6620 7374 7269 6465 203d 3d20 3120 616e  f stride == 1 an
+00000ae0: 6420 2864 696c 6174 696f 6e20 2a20 286b  d (dilation * (k
+00000af0: 6572 6e65 6c5f 7369 7a65 202d 2031 2929  ernel_size - 1))
+00000b00: 2025 2032 203d 3d20 303a 0a20 2020 2020   % 2 == 0:.     
+00000b10: 2020 2020 2020 2020 2020 2023 2073 7461             # sta
+00000b20: 7469 6320 6361 7365 2c20 6e6f 2065 7874  tic case, no ext
+00000b30: 7261 206f 7665 7268 6561 640a 2020 2020  ra overhead.    
+00000b40: 2020 2020 2020 2020 2020 2020 7061 6464              padd
+00000b50: 696e 6720 3d20 2828 7374 7269 6465 202d  ing = ((stride -
+00000b60: 2031 2920 2b20 6469 6c61 7469 6f6e 202a   1) + dilation *
+00000b70: 2028 6b65 726e 656c 5f73 697a 6520 2d20   (kernel_size - 
+00000b80: 3129 2920 2f2f 2032 0a20 2020 2020 2020  1)) // 2.       
+00000b90: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00000ba0: 2020 2020 2020 2020 2020 2023 2064 796e             # dyn
+00000bb0: 616d 6963 2027 5341 4d45 2720 7061 6464  amic 'SAME' padd
+00000bc0: 696e 672c 2068 6173 2072 756e 7469 6d65  ing, has runtime
+00000bd0: 2f47 5055 206d 656d 6f72 7920 6f76 6572  /GPU memory over
+00000be0: 6865 6164 0a20 2020 2020 2020 2020 2020  head.           
+00000bf0: 2020 2020 2070 6164 6469 6e67 203d 2030       padding = 0
+00000c00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00000c10: 2064 796e 616d 6963 203d 2054 7275 650a   dynamic = True.
+00000c20: 2020 2020 2020 2020 656c 6966 2070 6164          elif pad
+00000c30: 6469 6e67 203d 3d20 2276 616c 6964 223a  ding == "valid":
+00000c40: 0a20 2020 2020 2020 2020 2020 2023 2027  .            # '
+00000c50: 5641 4c49 4427 2070 6164 6469 6e67 2c20  VALID' padding, 
+00000c60: 7361 6d65 2061 7320 7061 6464 696e 673d  same as padding=
+00000c70: 300a 2020 2020 2020 2020 2020 2020 7061  0.            pa
+00000c80: 6464 696e 6720 3d20 300a 2020 2020 2020  dding = 0.      
+00000c90: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00000ca0: 2020 2020 2320 4465 6661 756c 7420 746f      # Default to
+00000cb0: 2050 7954 6f72 6368 2073 7479 6c65 2027   PyTorch style '
+00000cc0: 7361 6d65 272d 6973 6820 7379 6d6d 6574  same'-ish symmet
+00000cd0: 7269 6320 7061 6464 696e 670a 2020 2020  ric padding.    
+00000ce0: 2020 2020 2020 2020 7061 6464 696e 6720          padding 
+00000cf0: 3d20 2828 7374 7269 6465 202d 2031 2920  = ((stride - 1) 
+00000d00: 2b20 6469 6c61 7469 6f6e 202a 2028 6b65  + dilation * (ke
+00000d10: 726e 656c 5f73 697a 6520 2d20 3129 2920  rnel_size - 1)) 
+00000d20: 2f2f 2032 0a20 2020 2072 6574 7572 6e20  // 2.    return 
+00000d30: 7061 6464 696e 672c 2064 796e 616d 6963  padding, dynamic
+00000d40: 0a0a 0a63 6c61 7373 2057 6569 6768 7453  ...class WeightS
+00000d50: 7461 6e64 6172 6469 7a65 6443 6f6e 7632  tandardizedConv2
+00000d60: 6428 6e6e 2e43 6f6e 7632 6429 3a0a 2020  d(nn.Conv2d):.  
+00000d70: 2020 2222 2243 6f6e 7632 6420 7769 7468    """Conv2d with
+00000d80: 2057 6569 6768 7420 5374 616e 6461 7264   Weight Standard
+00000d90: 697a 6174 696f 6e2e 2049 6e63 6c75 6465  ization. Include
+00000da0: 7320 6d69 6e64 7370 6f72 652e 5465 6e73  s mindspore.Tens
+00000db0: 6f72 466c 6f77 2063 6f6d 7061 7469 626c  orFlow compatibl
+00000dc0: 6520 5341 4d45 2070 6164 6469 6e67 2e20  e SAME padding. 
+00000dd0: 5573 6564 2066 6f72 2056 6954 2048 7962  Used for ViT Hyb
+00000de0: 7269 6420 6d6f 6465 6c2e 0a0a 2020 2020  rid model...    
+00000df0: 5061 7065 723a 205b 4d69 6372 6f2d 4261  Paper: [Micro-Ba
+00000e00: 7463 6820 5472 6169 6e69 6e67 2077 6974  tch Training wit
+00000e10: 6820 4261 7463 682d 4368 616e 6e65 6c20  h Batch-Channel 
+00000e20: 4e6f 726d 616c 697a 6174 696f 6e20 616e  Normalization an
+00000e30: 6420 5765 6967 6874 0a20 2020 2053 7461  d Weight.    Sta
+00000e40: 6e64 6172 6469 7a61 7469 6f6e 5d28 6874  ndardization](ht
+00000e50: 7470 733a 2f2f 6172 7869 762e 6f72 672f  tps://arxiv.org/
+00000e60: 6162 732f 3139 3033 2e31 3035 3230 7632  abs/1903.10520v2
+00000e70: 290a 2020 2020 2222 220a 0a20 2020 2064  ).    """..    d
+00000e80: 6566 205f 5f69 6e69 745f 5f28 0a20 2020  ef __init__(.   
+00000e90: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+00000ea0: 2020 2069 6e5f 6368 616e 6e65 6c2c 0a20     in_channel,. 
+00000eb0: 2020 2020 2020 206f 7574 5f63 6861 6e6e         out_chann
+00000ec0: 656c 732c 0a20 2020 2020 2020 206b 6572  els,.        ker
+00000ed0: 6e65 6c5f 7369 7a65 2c0a 2020 2020 2020  nel_size,.      
+00000ee0: 2020 7374 7269 6465 3d31 2c0a 2020 2020    stride=1,.    
+00000ef0: 2020 2020 7061 6464 696e 673d 302c 0a20      padding=0,. 
+00000f00: 2020 2020 2020 2064 696c 6174 696f 6e3d         dilation=
+00000f10: 312c 0a20 2020 2020 2020 2067 726f 7570  1,.        group
+00000f20: 733d 312c 0a20 2020 2020 2020 2062 6961  s=1,.        bia
+00000f30: 733d 4661 6c73 652c 0a20 2020 2020 2020  s=False,.       
+00000f40: 2065 7073 3d31 652d 362c 0a20 2020 2029   eps=1e-6,.    )
+00000f50: 3a0a 2020 2020 2020 2020 7061 6464 696e  :.        paddin
+00000f60: 672c 2069 735f 6479 6e61 6d69 6320 3d20  g, is_dynamic = 
+00000f70: 6765 745f 7061 6464 696e 675f 7661 6c75  get_padding_valu
+00000f80: 6528 7061 6464 696e 672c 206b 6572 6e65  e(padding, kerne
+00000f90: 6c5f 7369 7a65 2c20 7374 7269 6465 3d73  l_size, stride=s
+00000fa0: 7472 6964 652c 2064 696c 6174 696f 6e3d  tride, dilation=
+00000fb0: 6469 6c61 7469 6f6e 290a 2020 2020 2020  dilation).      
+00000fc0: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
+00000fd0: 5f5f 280a 2020 2020 2020 2020 2020 2020  __(.            
+00000fe0: 696e 5f63 6861 6e6e 656c 2c0a 2020 2020  in_channel,.    
+00000ff0: 2020 2020 2020 2020 6f75 745f 6368 616e          out_chan
+00001000: 6e65 6c73 2c0a 2020 2020 2020 2020 2020  nels,.          
+00001010: 2020 6b65 726e 656c 5f73 697a 652c 0a20    kernel_size,. 
+00001020: 2020 2020 2020 2020 2020 2073 7472 6964             strid
+00001030: 653d 7374 7269 6465 2c0a 2020 2020 2020  e=stride,.      
+00001040: 2020 2020 2020 7061 645f 6d6f 6465 3d27        pad_mode='
+00001050: 7061 6427 2069 6620 7061 6464 696e 6720  pad' if padding 
+00001060: 213d 2030 2065 6c73 6520 2773 616d 6527  != 0 else 'same'
+00001070: 2c0a 2020 2020 2020 2020 2020 2020 7061  ,.            pa
+00001080: 6464 696e 673d 7061 6464 696e 672c 0a20  dding=padding,. 
+00001090: 2020 2020 2020 2020 2020 2064 696c 6174             dilat
+000010a0: 696f 6e3d 6469 6c61 7469 6f6e 2c0a 2020  ion=dilation,.  
+000010b0: 2020 2020 2020 2020 2020 6772 6f75 703d            group=
+000010c0: 6772 6f75 7073 2c0a 2020 2020 2020 2020  groups,.        
+000010d0: 2020 2020 6861 735f 6269 6173 3d62 6961      has_bias=bia
+000010e0: 732c 0a20 2020 2020 2020 2029 0a20 2020  s,.        ).   
+000010f0: 2020 2020 2069 6620 6973 5f64 796e 616d       if is_dynam
+00001100: 6963 3a0a 2020 2020 2020 2020 2020 2020  ic:.            
+00001110: 7365 6c66 2e70 6164 203d 2044 796e 616d  self.pad = Dynam
+00001120: 6963 5061 6432 6428 6b65 726e 656c 5f73  icPad2d(kernel_s
+00001130: 697a 652c 2073 7472 6964 652c 2064 696c  ize, stride, dil
+00001140: 6174 696f 6e29 0a20 2020 2020 2020 2065  ation).        e
+00001150: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00001160: 2073 656c 662e 7061 6420 3d20 4e6f 6e65   self.pad = None
+00001170: 0a20 2020 2020 2020 2073 656c 662e 6570  .        self.ep
+00001180: 7320 3d20 6570 730a 0a20 2020 2064 6566  s = eps..    def
+00001190: 2063 6f6e 7374 7275 6374 2873 656c 662c   construct(self,
+000011a0: 2068 6964 6465 6e5f 7374 6174 6529 3a0a   hidden_state):.
+000011b0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+000011c0: 7061 6420 6973 206e 6f74 204e 6f6e 653a  pad is not None:
+000011d0: 0a20 2020 2020 2020 2020 2020 2068 6964  .            hid
+000011e0: 6465 6e5f 7374 6174 6520 3d20 7365 6c66  den_state = self
+000011f0: 2e70 6164 2868 6964 6465 6e5f 7374 6174  .pad(hidden_stat
+00001200: 6529 0a20 2020 2020 2020 2069 6e70 7574  e).        input
+00001210: 5f77 6569 6768 7420 3d20 7365 6c66 2e77  _weight = self.w
+00001220: 6569 6768 742e 7265 7368 6170 6528 312c  eight.reshape(1,
+00001230: 2073 656c 662e 6f75 745f 6368 616e 6e65   self.out_channe
+00001240: 6c73 2c20 2d31 290a 2020 2020 2020 2020  ls, -1).        
+00001250: 7765 6967 6874 203d 206f 7073 2e62 6174  weight = ops.bat
+00001260: 6368 5f6e 6f72 6d28 0a20 2020 2020 2020  ch_norm(.       
+00001270: 2020 2020 2069 6e70 7574 5f77 6569 6768       input_weigh
+00001280: 742c 206f 7073 2e6f 6e65 7328 7365 6c66  t, ops.ones(self
+00001290: 2e6f 7574 5f63 6861 6e6e 656c 7329 2c20  .out_channels), 
+000012a0: 6f70 732e 7a65 726f 7328 7365 6c66 2e6f  ops.zeros(self.o
+000012b0: 7574 5f63 6861 6e6e 656c 7329 2c0a 2020  ut_channels),.  
+000012c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000012d0: 2020 2020 2020 2020 2020 2020 2020 6f70                op
+000012e0: 732e 6f6e 6573 2873 656c 662e 6f75 745f  s.ones(self.out_
+000012f0: 6368 616e 6e65 6c73 292c 206f 7073 2e7a  channels), ops.z
+00001300: 6572 6f73 2873 656c 662e 6f75 745f 6368  eros(self.out_ch
+00001310: 616e 6e65 6c73 292c 0a20 2020 2020 2020  annels),.       
+00001320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001330: 2020 2020 2020 2020 2074 7261 696e 696e           trainin
+00001340: 673d 5472 7565 2c20 6d6f 6d65 6e74 756d  g=True, momentum
+00001350: 3d30 2e30 2c20 6570 733d 7365 6c66 2e65  =0.0, eps=self.e
+00001360: 7073 0a20 2020 2020 2020 2029 2e72 6573  ps.        ).res
+00001370: 6861 7065 5f61 7328 7365 6c66 2e77 6569  hape_as(self.wei
+00001380: 6768 7429 0a20 2020 2020 2020 2068 6964  ght).        hid
+00001390: 6465 6e5f 7374 6174 6520 3d20 6f70 732e  den_state = ops.
+000013a0: 636f 6e76 3264 280a 2020 2020 2020 2020  conv2d(.        
+000013b0: 2020 2020 6869 6464 656e 5f73 7461 7465      hidden_state
+000013c0: 2c20 7765 6967 6874 2c20 7365 6c66 2e62  , weight, self.b
+000013d0: 6961 732c 2073 656c 662e 7374 7269 6465  ias, self.stride
+000013e0: 2c20 7365 6c66 2e70 6164 5f6d 6f64 652c  , self.pad_mode,
+000013f0: 2073 656c 662e 7061 6464 696e 672c 2073   self.padding, s
+00001400: 656c 662e 6469 6c61 7469 6f6e 2c20 7365  elf.dilation, se
+00001410: 6c66 2e67 726f 7570 0a20 2020 2020 2020  lf.group.       
+00001420: 2029 0a20 2020 2020 2020 2072 6574 7572   ).        retur
+00001430: 6e20 6869 6464 656e 5f73 7461 7465 0a0a  n hidden_state..
+00001440: 0a63 6c61 7373 2042 6974 4772 6f75 704e  .class BitGroupN
+00001450: 6f72 6d41 6374 6976 6174 696f 6e28 6e6e  ormActivation(nn
+00001460: 2e47 726f 7570 4e6f 726d 293a 0a20 2020  .GroupNorm):.   
+00001470: 2072 2222 220a 2020 2020 4120 6d6f 6475   r""".    A modu
+00001480: 6c65 2074 6861 7420 636f 6d62 696e 6573  le that combines
+00001490: 2067 726f 7570 206e 6f72 6d61 6c69 7a61   group normaliza
+000014a0: 7469 6f6e 2077 6974 6820 616e 2061 6374  tion with an act
+000014b0: 6976 6174 696f 6e20 6675 6e63 7469 6f6e  ivation function
+000014c0: 2e0a 2020 2020 2222 220a 0a20 2020 2064  ..    """..    d
+000014d0: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
+000014e0: 2c20 636f 6e66 6967 2c20 6e75 6d5f 6368  , config, num_ch
+000014f0: 616e 6e65 6c73 2c20 6570 733d 3165 2d35  annels, eps=1e-5
+00001500: 2c20 6166 6669 6e65 3d54 7275 652c 2061  , affine=True, a
+00001510: 7070 6c79 5f61 6374 6976 6174 696f 6e3d  pply_activation=
+00001520: 5472 7565 293a 0a20 2020 2020 2020 2073  True):.        s
+00001530: 7570 6572 2842 6974 4772 6f75 704e 6f72  uper(BitGroupNor
+00001540: 6d41 6374 6976 6174 696f 6e2c 2073 656c  mActivation, sel
+00001550: 6629 2e5f 5f69 6e69 745f 5f28 636f 6e66  f).__init__(conf
+00001560: 6967 2e6e 756d 5f67 726f 7570 732c 206e  ig.num_groups, n
+00001570: 756d 5f63 6861 6e6e 656c 732c 2065 7073  um_channels, eps
+00001580: 3d65 7073 2c20 6166 6669 6e65 3d61 6666  =eps, affine=aff
+00001590: 696e 6529 0a20 2020 2020 2020 2069 6620  ine).        if 
+000015a0: 6170 706c 795f 6163 7469 7661 7469 6f6e  apply_activation
+000015b0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+000015c0: 6c66 2e61 6374 6976 6174 696f 6e20 3d20  lf.activation = 
+000015d0: 4143 5432 464e 5b63 6f6e 6669 672e 6869  ACT2FN[config.hi
+000015e0: 6464 656e 5f61 6374 5d0a 2020 2020 2020  dden_act].      
+000015f0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00001600: 2020 2020 7365 6c66 2e61 6374 6976 6174      self.activat
+00001610: 696f 6e20 3d20 6e6e 2e49 6465 6e74 6974  ion = nn.Identit
+00001620: 7928 290a 0a20 2020 2064 6566 2063 6f6e  y()..    def con
+00001630: 7374 7275 6374 2873 656c 662c 2068 6964  struct(self, hid
+00001640: 6465 6e5f 7374 6174 6529 3a0a 2020 2020  den_state):.    
+00001650: 2020 2020 6869 6464 656e 5f73 7461 7465      hidden_state
+00001660: 203d 2073 656c 662e 5f63 616c 5f6f 7574   = self._cal_out
+00001670: 7075 7428 6869 6464 656e 5f73 7461 7465  put(hidden_state
+00001680: 290a 2020 2020 2020 2020 6869 6464 656e  ).        hidden
+00001690: 5f73 7461 7465 203d 2073 656c 662e 6163  _state = self.ac
+000016a0: 7469 7661 7469 6f6e 2868 6964 6465 6e5f  tivation(hidden_
+000016b0: 7374 6174 6529 0a20 2020 2020 2020 2072  state).        r
+000016c0: 6574 7572 6e20 6869 6464 656e 5f73 7461  eturn hidden_sta
+000016d0: 7465 0a0a 0a63 6c61 7373 2044 796e 616d  te...class Dynam
+000016e0: 6963 5061 6432 6428 6e6e 2e43 656c 6c29  icPad2d(nn.Cell)
+000016f0: 3a0a 2020 2020 7222 2222 0a20 2020 2041  :.    r""".    A
+00001700: 206d 6f64 756c 6520 7468 6174 2077 7261   module that wra
+00001710: 7073 2064 796e 616d 6963 2070 6164 6469  ps dynamic paddi
+00001720: 6e67 206f 6620 616e 7920 696e 7075 742c  ng of any input,
+00001730: 2067 6976 656e 2074 6865 2070 6172 616d   given the param
+00001740: 6574 6572 7320 6f66 2074 6865 2063 6f6e  eters of the con
+00001750: 766f 6c75 7469 6f6e 616c 206c 6179 6572  volutional layer
+00001760: 2061 6e64 2074 6865 2069 6e70 7574 0a20   and the input. 
+00001770: 2020 2068 6964 6465 6e20 7374 6174 6573     hidden states
+00001780: 2e0a 2020 2020 2222 220a 0a20 2020 2064  ..    """..    d
+00001790: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
+000017a0: 2c20 6b65 726e 656c 5f73 697a 652c 2073  , kernel_size, s
+000017b0: 7472 6964 652c 2064 696c 6174 696f 6e2c  tride, dilation,
+000017c0: 2076 616c 7565 3d30 293a 0a20 2020 2020   value=0):.     
+000017d0: 2020 2073 7570 6572 2829 2e5f 5f69 6e69     super().__ini
+000017e0: 745f 5f28 290a 2020 2020 2020 2020 2320  t__().        # 
+000017f0: 5361 6665 7479 2063 6865 636b 6572 730a  Safety checkers.
+00001800: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+00001810: 7461 6e63 6528 6b65 726e 656c 5f73 697a  tance(kernel_siz
+00001820: 652c 2069 6e74 293a 0a20 2020 2020 2020  e, int):.       
+00001830: 2020 2020 206b 6572 6e65 6c5f 7369 7a65       kernel_size
+00001840: 203d 2028 6b65 726e 656c 5f73 697a 652c   = (kernel_size,
+00001850: 206b 6572 6e65 6c5f 7369 7a65 290a 0a20   kernel_size).. 
+00001860: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+00001870: 616e 6365 2873 7472 6964 652c 2069 6e74  ance(stride, int
+00001880: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
+00001890: 7472 6964 6520 3d20 2873 7472 6964 652c  tride = (stride,
+000018a0: 2073 7472 6964 6529 0a0a 2020 2020 2020   stride)..      
+000018b0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+000018c0: 6469 6c61 7469 6f6e 2c20 696e 7429 3a0a  dilation, int):.
+000018d0: 2020 2020 2020 2020 2020 2020 6469 6c61              dila
+000018e0: 7469 6f6e 203d 2028 6469 6c61 7469 6f6e  tion = (dilation
+000018f0: 2c20 6469 6c61 7469 6f6e 290a 0a20 2020  , dilation)..   
+00001900: 2020 2020 2073 656c 662e 6b65 726e 656c       self.kernel
+00001910: 5f73 697a 6520 3d20 6b65 726e 656c 5f73  _size = kernel_s
+00001920: 697a 650a 2020 2020 2020 2020 7365 6c66  ize.        self
+00001930: 2e73 7472 6964 6520 3d20 7374 7269 6465  .stride = stride
+00001940: 0a20 2020 2020 2020 2073 656c 662e 6469  .        self.di
+00001950: 6c61 7469 6f6e 203d 2064 696c 6174 696f  lation = dilatio
+00001960: 6e0a 2020 2020 2020 2020 7365 6c66 2e76  n.        self.v
+00001970: 616c 7565 203d 2076 616c 7565 0a0a 2020  alue = value..  
+00001980: 2020 2020 2020 6465 6620 636f 6d70 7574        def comput
+00001990: 655f 7061 6464 696e 6728 782c 206b 6572  e_padding(x, ker
+000019a0: 6e65 6c5f 7369 7a65 2c20 7374 7269 6465  nel_size, stride
+000019b0: 2c20 6469 6c61 7469 6f6e 293a 0a20 2020  , dilation):.   
+000019c0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000019d0: 6d61 7828 286d 6174 682e 6365 696c 2878  max((math.ceil(x
+000019e0: 202f 2073 7472 6964 6529 202d 2031 2920   / stride) - 1) 
+000019f0: 2a20 7374 7269 6465 202b 2028 6b65 726e  * stride + (kern
+00001a00: 656c 5f73 697a 6520 2d20 3129 202a 2064  el_size - 1) * d
+00001a10: 696c 6174 696f 6e20 2b20 3120 2d20 782c  ilation + 1 - x,
+00001a20: 2030 290a 0a20 2020 2020 2020 2073 656c   0)..        sel
+00001a30: 662e 636f 6d70 7574 655f 7061 6464 696e  f.compute_paddin
+00001a40: 6720 3d20 636f 6d70 7574 655f 7061 6464  g = compute_padd
+00001a50: 696e 670a 0a20 2020 2064 6566 205f 5f63  ing..    def __c
+00001a60: 616c 6c5f 5f28 7365 6c66 2c20 696e 7075  all__(self, inpu
+00001a70: 7429 3a0a 2020 2020 2020 2020 2320 4765  t):.        # Ge
+00001a80: 7420 7769 6474 6820 616e 6420 6865 6967  t width and heig
+00001a90: 6874 0a20 2020 2020 2020 2069 6e70 7574  ht.        input
+00001aa0: 5f68 6569 6768 742c 2069 6e70 7574 5f77  _height, input_w
+00001ab0: 6964 7468 203d 2069 6e70 7574 2e73 6861  idth = input.sha
+00001ac0: 7065 5b2d 323a 5d0a 0a20 2020 2020 2020  pe[-2:]..       
+00001ad0: 2023 2043 6f6d 7075 7465 2074 6865 2070   # Compute the p
+00001ae0: 6164 6469 6e67 2076 616c 7565 730a 2020  adding values.  
+00001af0: 2020 2020 2020 7061 6464 696e 675f 6865        padding_he
+00001b00: 6967 6874 203d 2073 656c 662e 636f 6d70  ight = self.comp
+00001b10: 7574 655f 7061 6464 696e 6728 696e 7075  ute_padding(inpu
+00001b20: 745f 6865 6967 6874 2c20 7365 6c66 2e6b  t_height, self.k
+00001b30: 6572 6e65 6c5f 7369 7a65 5b30 5d2c 2073  ernel_size[0], s
+00001b40: 656c 662e 7374 7269 6465 5b30 5d2c 2073  elf.stride[0], s
+00001b50: 656c 662e 6469 6c61 7469 6f6e 5b30 5d29  elf.dilation[0])
+00001b60: 0a20 2020 2020 2020 2070 6164 6469 6e67  .        padding
+00001b70: 5f77 6964 7468 203d 2073 656c 662e 636f  _width = self.co
+00001b80: 6d70 7574 655f 7061 6464 696e 6728 696e  mpute_padding(in
+00001b90: 7075 745f 7769 6474 682c 2073 656c 662e  put_width, self.
+00001ba0: 6b65 726e 656c 5f73 697a 655b 315d 2c20  kernel_size[1], 
+00001bb0: 7365 6c66 2e73 7472 6964 655b 315d 2c20  self.stride[1], 
+00001bc0: 7365 6c66 2e64 696c 6174 696f 6e5b 315d  self.dilation[1]
+00001bd0: 290a 0a20 2020 2020 2020 2023 2061 7070  )..        # app
+00001be0: 6c79 2070 6164 0a20 2020 2020 2020 2069  ly pad.        i
+00001bf0: 6620 7061 6464 696e 675f 6865 6967 6874  f padding_height
+00001c00: 203e 2030 206f 7220 7061 6464 696e 675f   > 0 or padding_
+00001c10: 7769 6474 6820 3e20 303a 0a20 2020 2020  width > 0:.     
+00001c20: 2020 2020 2020 2069 6e70 7574 203d 206f         input = o
+00001c30: 7073 2e70 6164 280a 2020 2020 2020 2020  ps.pad(.        
+00001c40: 2020 2020 2020 2020 696e 7075 742c 0a20          input,. 
+00001c50: 2020 2020 2020 2020 2020 2020 2020 205b                 [
+00001c60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00001c70: 2020 2020 2070 6164 6469 6e67 5f77 6964       padding_wid
+00001c80: 7468 202f 2f20 322c 0a20 2020 2020 2020  th // 2,.       
+00001c90: 2020 2020 2020 2020 2020 2020 2070 6164               pad
+00001ca0: 6469 6e67 5f77 6964 7468 202d 2070 6164  ding_width - pad
+00001cb0: 6469 6e67 5f77 6964 7468 202f 2f20 322c  ding_width // 2,
+00001cc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00001cd0: 2020 2020 2070 6164 6469 6e67 5f68 6569       padding_hei
+00001ce0: 6768 7420 2f2f 2032 2c0a 2020 2020 2020  ght // 2,.      
+00001cf0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+00001d00: 6464 696e 675f 6865 6967 6874 202d 2070  dding_height - p
+00001d10: 6164 6469 6e67 5f68 6569 6768 7420 2f2f  adding_height //
+00001d20: 2032 2c0a 2020 2020 2020 2020 2020 2020   2,.            
+00001d30: 2020 2020 5d2c 0a20 2020 2020 2020 2020      ],.         
+00001d40: 2020 2020 2020 2076 616c 7565 3d73 656c         value=sel
+00001d50: 662e 7661 6c75 652c 0a20 2020 2020 2020  f.value,.       
+00001d60: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
+00001d70: 6574 7572 6e20 696e 7075 740a 0a0a 636c  eturn input...cl
+00001d80: 6173 7320 4269 744d 6178 506f 6f6c 3264  ass BitMaxPool2d
+00001d90: 286e 6e2e 4365 6c6c 293a 0a20 2020 2022  (nn.Cell):.    "
+00001da0: 2222 5465 6e73 6f72 666c 6f77 206c 696b  ""Tensorflow lik
+00001db0: 6520 2753 414d 4527 2077 7261 7070 6572  e 'SAME' wrapper
+00001dc0: 2066 6f72 2032 4420 6d61 7820 706f 6f6c   for 2D max pool
+00001dd0: 696e 6722 2222 0a0a 2020 2020 6465 6620  ing"""..    def 
+00001de0: 5f5f 696e 6974 5f5f 280a 2020 2020 2020  __init__(.      
+00001df0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+00001e00: 6b65 726e 656c 5f73 697a 653a 2069 6e74  kernel_size: int
+00001e10: 2c0a 2020 2020 2020 2020 7374 7269 6465  ,.        stride
+00001e20: 3d4e 6f6e 652c 0a20 2020 2020 2020 2064  =None,.        d
+00001e30: 696c 6174 696f 6e3d 312c 0a20 2020 2020  ilation=1,.     
+00001e40: 2020 2063 6569 6c5f 6d6f 6465 3d46 616c     ceil_mode=Fal
+00001e50: 7365 2c0a 2020 2020 2020 2020 7061 6464  se,.        padd
+00001e60: 696e 673d 2830 2c20 3029 2c0a 2020 2020  ing=(0, 0),.    
+00001e70: 2020 2020 7061 6464 696e 675f 7661 6c75      padding_valu
+00001e80: 653d 302c 0a20 2020 2020 2020 2075 7365  e=0,.        use
+00001e90: 5f64 796e 616d 6963 5f70 6164 6469 6e67  _dynamic_padding
+00001ea0: 3d54 7275 652c 0a20 2020 2029 3a0a 2020  =True,.    ):.  
+00001eb0: 2020 2020 2020 7375 7065 7228 292e 5f5f        super().__
+00001ec0: 696e 6974 5f5f 2829 0a20 2020 2020 2020  init__().       
+00001ed0: 2073 656c 662e 7061 6464 696e 6720 3d20   self.padding = 
+00001ee0: 7061 6464 696e 670a 2020 2020 2020 2020  padding.        
+00001ef0: 7365 6c66 2e6b 6572 6e65 6c5f 7369 7a65  self.kernel_size
+00001f00: 203d 206b 6572 6e65 6c5f 7369 7a65 2069   = kernel_size i
+00001f10: 6620 6973 696e 7374 616e 6365 286b 6572  f isinstance(ker
+00001f20: 6e65 6c5f 7369 7a65 2c20 636f 6c6c 6563  nel_size, collec
+00001f30: 7469 6f6e 732e 6162 632e 4974 6572 6162  tions.abc.Iterab
+00001f40: 6c65 2920 656c 7365 2028 6b65 726e 656c  le) else (kernel
+00001f50: 5f73 697a 652c 206b 6572 6e65 6c5f 7369  _size, kernel_si
+00001f60: 7a65 290a 2020 2020 2020 2020 7365 6c66  ze).        self
+00001f70: 2e73 7472 6964 6520 3d20 7374 7269 6465  .stride = stride
+00001f80: 2069 6620 6973 696e 7374 616e 6365 2873   if isinstance(s
+00001f90: 7472 6964 652c 2063 6f6c 6c65 6374 696f  tride, collectio
+00001fa0: 6e73 2e61 6263 2e49 7465 7261 626c 6529  ns.abc.Iterable)
+00001fb0: 2065 6c73 6520 2873 7472 6964 652c 2073   else (stride, s
+00001fc0: 7472 6964 6529 0a20 2020 2020 2020 2073  tride).        s
+00001fd0: 656c 662e 6469 6c61 7469 6f6e 203d 2064  elf.dilation = d
+00001fe0: 696c 6174 696f 6e20 6966 2069 7369 6e73  ilation if isins
+00001ff0: 7461 6e63 6528 6469 6c61 7469 6f6e 2c20  tance(dilation, 
+00002000: 636f 6c6c 6563 7469 6f6e 732e 6162 632e  collections.abc.
+00002010: 4974 6572 6162 6c65 2920 656c 7365 2028  Iterable) else (
+00002020: 6469 6c61 7469 6f6e 2c20 6469 6c61 7469  dilation, dilati
+00002030: 6f6e 290a 2020 2020 2020 2020 7365 6c66  on).        self
+00002040: 2e64 696c 6174 696f 6e20 3d20 6469 6c61  .dilation = dila
+00002050: 7469 6f6e 0a20 2020 2020 2020 2073 656c  tion.        sel
+00002060: 662e 6365 696c 5f6d 6f64 6520 3d20 6365  f.ceil_mode = ce
+00002070: 696c 5f6d 6f64 650a 2020 2020 2020 2020  il_mode.        
+00002080: 7365 6c66 2e70 6164 5f6d 6f64 6520 3d20  self.pad_mode = 
+00002090: 2770 6164 2720 6966 2073 756d 2870 6164  'pad' if sum(pad
+000020a0: 6469 6e67 2920 3e20 3020 656c 7365 2027  ding) > 0 else '
+000020b0: 7661 6c69 6427 0a20 2020 2020 2020 2069  valid'.        i
+000020c0: 6620 7573 655f 6479 6e61 6d69 635f 7061  f use_dynamic_pa
+000020d0: 6464 696e 673a 0a20 2020 2020 2020 2020  dding:.         
+000020e0: 2020 2073 656c 662e 7061 6420 3d20 4479     self.pad = Dy
+000020f0: 6e61 6d69 6350 6164 3264 286b 6572 6e65  namicPad2d(kerne
+00002100: 6c5f 7369 7a65 2c20 7374 7269 6465 2c20  l_size, stride, 
+00002110: 6469 6c61 7469 6f6e 2c20 7061 6464 696e  dilation, paddin
+00002120: 675f 7661 6c75 6529 0a20 2020 2020 2020  g_value).       
+00002130: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00002140: 2020 2073 656c 662e 7061 6420 3d20 6e6e     self.pad = nn
+00002150: 2e49 6465 6e74 6974 7928 290a 0a20 2020  .Identity()..   
+00002160: 2064 6566 2063 6f6e 7374 7275 6374 2873   def construct(s
+00002170: 656c 662c 2068 6964 6465 6e5f 7374 6174  elf, hidden_stat
+00002180: 6573 293a 0a20 2020 2020 2020 2068 6964  es):.        hid
+00002190: 6465 6e5f 7374 6174 6573 203d 2073 656c  den_states = sel
+000021a0: 662e 7061 6428 6869 6464 656e 5f73 7461  f.pad(hidden_sta
+000021b0: 7465 7329 0a20 2020 2020 2020 2072 6574  tes).        ret
+000021c0: 7572 6e20 6f70 732e 6d61 785f 706f 6f6c  urn ops.max_pool
+000021d0: 3264 280a 2020 2020 2020 2020 2020 2020  2d(.            
+000021e0: 6869 6464 656e 5f73 7461 7465 732c 2073  hidden_states, s
+000021f0: 656c 662e 6b65 726e 656c 5f73 697a 652c  elf.kernel_size,
+00002200: 2073 656c 662e 7374 7269 6465 2c20 7365   self.stride, se
+00002210: 6c66 2e70 6164 6469 6e67 2c20 7365 6c66  lf.padding, self
+00002220: 2e64 696c 6174 696f 6e2c 2073 656c 662e  .dilation, self.
+00002230: 6365 696c 5f6d 6f64 650a 2020 2020 2020  ceil_mode.      
+00002240: 2020 290a 0a0a 636c 6173 7320 4269 7445    )...class BitE
+00002250: 6d62 6564 6469 6e67 7328 6e6e 2e43 656c  mbeddings(nn.Cel
+00002260: 6c29 3a0a 2020 2020 2222 220a 2020 2020  l):.    """.    
+00002270: 4269 5420 456d 6265 6464 696e 6773 2028  BiT Embeddings (
+00002280: 7374 656d 2920 636f 6d70 6f73 6564 206f  stem) composed o
+00002290: 6620 6120 7369 6e67 6c65 2061 6767 7265  f a single aggre
+000022a0: 7373 6976 6520 636f 6e76 6f6c 7574 696f  ssive convolutio
+000022b0: 6e2e 0a20 2020 2022 2222 0a0a 2020 2020  n..    """..    
+000022c0: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
+000022d0: 662c 2063 6f6e 6669 673a 2042 6974 436f  f, config: BitCo
+000022e0: 6e66 6967 293a 0a20 2020 2020 2020 2073  nfig):.        s
+000022f0: 7570 6572 2829 2e5f 5f69 6e69 745f 5f28  uper().__init__(
+00002300: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+00002310: 636f 6e76 6f6c 7574 696f 6e20 3d20 5765  convolution = We
+00002320: 6967 6874 5374 616e 6461 7264 697a 6564  ightStandardized
+00002330: 436f 6e76 3264 280a 2020 2020 2020 2020  Conv2d(.        
+00002340: 2020 2020 636f 6e66 6967 2e6e 756d 5f63      config.num_c
+00002350: 6861 6e6e 656c 732c 0a20 2020 2020 2020  hannels,.       
+00002360: 2020 2020 2063 6f6e 6669 672e 656d 6265       config.embe
+00002370: 6464 696e 675f 7369 7a65 2c0a 2020 2020  dding_size,.    
+00002380: 2020 2020 2020 2020 6b65 726e 656c 5f73          kernel_s
+00002390: 697a 653d 372c 0a20 2020 2020 2020 2020  ize=7,.         
+000023a0: 2020 2073 7472 6964 653d 322c 0a20 2020     stride=2,.   
+000023b0: 2020 2020 2020 2020 2065 7073 3d31 652d           eps=1e-
+000023c0: 382c 0a20 2020 2020 2020 2020 2020 2070  8,.            p
+000023d0: 6164 6469 6e67 3d63 6f6e 6669 672e 676c  adding=config.gl
+000023e0: 6f62 616c 5f70 6164 6469 6e67 2c0a 2020  obal_padding,.  
+000023f0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00002400: 2073 656c 662e 706f 6f6c 6572 203d 2042   self.pooler = B
+00002410: 6974 4d61 7850 6f6f 6c32 6428 6b65 726e  itMaxPool2d(kern
+00002420: 656c 5f73 697a 653d 332c 2073 7472 6964  el_size=3, strid
+00002430: 653d 322c 2075 7365 5f64 796e 616d 6963  e=2, use_dynamic
+00002440: 5f70 6164 6469 6e67 3d63 6f6e 6669 672e  _padding=config.
+00002450: 656d 6265 6464 696e 675f 6479 6e61 6d69  embedding_dynami
+00002460: 635f 7061 6464 696e 6729 0a0a 2020 2020  c_padding)..    
+00002470: 2020 2020 2320 5573 6520 7468 6520 7361      # Use the sa
+00002480: 6d65 2070 6164 6469 6e67 2073 7472 6174  me padding strat
+00002490: 6567 7920 6173 2063 6f6e 766f 6c75 7469  egy as convoluti
+000024a0: 6f6e 616c 206c 6179 6572 730a 2020 2020  onal layers.    
+000024b0: 2020 2020 6966 2063 6f6e 6669 672e 676c      if config.gl
+000024c0: 6f62 616c 5f70 6164 6469 6e67 2069 7320  obal_padding is 
+000024d0: 6e6f 7420 4e6f 6e65 2061 6e64 2063 6f6e  not None and con
+000024e0: 6669 672e 676c 6f62 616c 5f70 6164 6469  fig.global_paddi
+000024f0: 6e67 2e75 7070 6572 2829 203d 3d20 2253  ng.upper() == "S
+00002500: 414d 4522 3a0a 2020 2020 2020 2020 2020  AME":.          
+00002510: 2020 7365 6c66 2e70 6164 203d 206e 6e2e    self.pad = nn.
+00002520: 4964 656e 7469 7479 2829 0a20 2020 2020  Identity().     
+00002530: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00002540: 2020 2020 2073 656c 662e 7061 6420 3d20       self.pad = 
+00002550: 6e6e 2e43 6f6e 7374 616e 7450 6164 3264  nn.ConstantPad2d
+00002560: 2870 6164 6469 6e67 3d28 312c 2031 2c20  (padding=(1, 1, 
+00002570: 312c 2031 292c 2076 616c 7565 3d30 2e30  1, 1), value=0.0
+00002580: 290a 0a20 2020 2020 2020 2069 6620 6e6f  )..        if no
+00002590: 7420 636f 6e66 6967 2e6c 6179 6572 5f74  t config.layer_t
+000025a0: 7970 6520 3d3d 2022 7072 6561 6374 6976  ype == "preactiv
+000025b0: 6174 696f 6e22 3a0a 2020 2020 2020 2020  ation":.        
+000025c0: 2020 2020 7365 6c66 2e6e 6f72 6d20 3d20      self.norm = 
+000025d0: 4269 7447 726f 7570 4e6f 726d 4163 7469  BitGroupNormActi
+000025e0: 7661 7469 6f6e 2863 6f6e 6669 672c 206e  vation(config, n
+000025f0: 756d 5f63 6861 6e6e 656c 733d 636f 6e66  um_channels=conf
+00002600: 6967 2e65 6d62 6564 6469 6e67 5f73 697a  ig.embedding_siz
+00002610: 6529 0a20 2020 2020 2020 2065 6c73 653a  e).        else:
+00002620: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00002630: 662e 6e6f 726d 203d 206e 6e2e 4964 656e  f.norm = nn.Iden
+00002640: 7469 7479 2829 0a0a 2020 2020 2020 2020  tity()..        
+00002650: 7365 6c66 2e6e 756d 5f63 6861 6e6e 656c  self.num_channel
+00002660: 7320 3d20 636f 6e66 6967 2e6e 756d 5f63  s = config.num_c
+00002670: 6861 6e6e 656c 730a 0a20 2020 2064 6566  hannels..    def
+00002680: 2063 6f6e 7374 7275 6374 2873 656c 662c   construct(self,
+00002690: 2070 6978 656c 5f76 616c 7565 733a 206d   pixel_values: m
+000026a0: 696e 6473 706f 7265 2e54 656e 736f 7229  indspore.Tensor)
+000026b0: 202d 3e20 6d69 6e64 7370 6f72 652e 5465   -> mindspore.Te
+000026c0: 6e73 6f72 3a0a 2020 2020 2020 2020 6e75  nsor:.        nu
+000026d0: 6d5f 6368 616e 6e65 6c73 203d 2070 6978  m_channels = pix
+000026e0: 656c 5f76 616c 7565 732e 7368 6170 655b  el_values.shape[
+000026f0: 315d 0a20 2020 2020 2020 2069 6620 6e75  1].        if nu
+00002700: 6d5f 6368 616e 6e65 6c73 2021 3d20 7365  m_channels != se
+00002710: 6c66 2e6e 756d 5f63 6861 6e6e 656c 733a  lf.num_channels:
+00002720: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+00002730: 7365 2056 616c 7565 4572 726f 7228 0a20  se ValueError(. 
+00002740: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00002750: 4d61 6b65 2073 7572 6520 7468 6174 2074  Make sure that t
+00002760: 6865 2063 6861 6e6e 656c 2064 696d 656e  he channel dimen
+00002770: 7369 6f6e 206f 6620 7468 6520 7069 7865  sion of the pixe
+00002780: 6c20 7661 6c75 6573 206d 6174 6368 2077  l values match w
+00002790: 6974 6820 7468 6520 6f6e 6520 7365 7420  ith the one set 
+000027a0: 696e 2074 6865 2063 6f6e 6669 6775 7261  in the configura
+000027b0: 7469 6f6e 2e22 0a20 2020 2020 2020 2020  tion.".         
+000027c0: 2020 2029 0a0a 2020 2020 2020 2020 656d     )..        em
+000027d0: 6265 6464 696e 6720 3d20 7365 6c66 2e63  bedding = self.c
+000027e0: 6f6e 766f 6c75 7469 6f6e 2870 6978 656c  onvolution(pixel
+000027f0: 5f76 616c 7565 7329 0a0a 2020 2020 2020  _values)..      
+00002800: 2020 656d 6265 6464 696e 6720 3d20 7365    embedding = se
+00002810: 6c66 2e70 6164 2865 6d62 6564 6469 6e67  lf.pad(embedding
+00002820: 290a 0a20 2020 2020 2020 2065 6d62 6564  )..        embed
+00002830: 6469 6e67 203d 2073 656c 662e 6e6f 726d  ding = self.norm
+00002840: 2865 6d62 6564 6469 6e67 290a 0a20 2020  (embedding)..   
+00002850: 2020 2020 2065 6d62 6564 6469 6e67 203d       embedding =
+00002860: 2073 656c 662e 706f 6f6c 6572 2865 6d62   self.pooler(emb
+00002870: 6564 6469 6e67 290a 0a20 2020 2020 2020  edding)..       
+00002880: 2072 6574 7572 6e20 656d 6265 6464 696e   return embeddin
+00002890: 670a 0a0a 2320 436f 7069 6564 2066 726f  g...# Copied fro
+000028a0: 6d20 7472 616e 7366 6f72 6d65 7273 2e6d  m transformers.m
+000028b0: 6f64 656c 732e 636f 6e76 6e65 7874 2e6d  odels.convnext.m
+000028c0: 6f64 656c 696e 675f 636f 6e76 6e65 7874  odeling_convnext
+000028d0: 2e64 726f 705f 7061 7468 0a64 6566 2064  .drop_path.def d
+000028e0: 726f 705f 7061 7468 2869 6e70 7574 3a20  rop_path(input: 
+000028f0: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+00002900: 2c20 6472 6f70 5f70 726f 623a 2066 6c6f  , drop_prob: flo
+00002910: 6174 203d 2030 2e30 2c20 7472 6169 6e69  at = 0.0, traini
+00002920: 6e67 3a20 626f 6f6c 203d 2046 616c 7365  ng: bool = False
+00002930: 2920 2d3e 206d 696e 6473 706f 7265 2e54  ) -> mindspore.T
+00002940: 656e 736f 723a 0a20 2020 2022 2222 0a20  ensor:.    """. 
+00002950: 2020 2044 726f 7020 7061 7468 7320 2853     Drop paths (S
+00002960: 746f 6368 6173 7469 6320 4465 7074 6829  tochastic Depth)
+00002970: 2070 6572 2073 616d 706c 6520 2877 6865   per sample (whe
+00002980: 6e20 6170 706c 6965 6420 696e 206d 6169  n applied in mai
+00002990: 6e20 7061 7468 206f 6620 7265 7369 6475  n path of residu
+000029a0: 616c 2062 6c6f 636b 7329 2e0a 0a20 2020  al blocks)...   
+000029b0: 2043 6f6d 6d65 6e74 2062 7920 526f 7373   Comment by Ross
+000029c0: 2057 6967 6874 6d61 6e3a 2054 6869 7320   Wightman: This 
+000029d0: 6973 2074 6865 2073 616d 6520 6173 2074  is the same as t
+000029e0: 6865 2044 726f 7043 6f6e 6e65 6374 2069  he DropConnect i
+000029f0: 6d70 6c20 4920 6372 6561 7465 6420 666f  mpl I created fo
+00002a00: 7220 4566 6669 6369 656e 744e 6574 2c20  r EfficientNet, 
+00002a10: 6574 6320 6e65 7477 6f72 6b73 2c0a 2020  etc networks,.  
+00002a20: 2020 686f 7765 7665 722c 2074 6865 206f    however, the o
+00002a30: 7269 6769 6e61 6c20 6e61 6d65 2069 7320  riginal name is 
+00002a40: 6d69 736c 6561 6469 6e67 2061 7320 2744  misleading as 'D
+00002a50: 726f 7020 436f 6e6e 6563 7427 2069 7320  rop Connect' is 
+00002a60: 6120 6469 6666 6572 656e 7420 666f 726d  a different form
+00002a70: 206f 6620 6472 6f70 6f75 7420 696e 2061   of dropout in a
+00002a80: 2073 6570 6172 6174 6520 7061 7065 722e   separate paper.
+00002a90: 2e2e 0a20 2020 2053 6565 2064 6973 6375  ...    See discu
+00002aa0: 7373 696f 6e3a 2068 7474 7073 3a2f 2f67  ssion: https://g
+00002ab0: 6974 6875 622e 636f 6d2f 7465 6e73 6f72  ithub.com/tensor
+00002ac0: 666c 6f77 2f74 7075 2f69 7373 7565 732f  flow/tpu/issues/
+00002ad0: 3439 3423 6973 7375 6563 6f6d 6d65 6e74  494#issuecomment
+00002ae0: 2d35 3332 3936 3839 3536 202e 2e2e 2049  -532968956 ... I
+00002af0: 2776 6520 6f70 7465 6420 666f 7220 6368  've opted for ch
+00002b00: 616e 6769 6e67 2074 6865 0a20 2020 206c  anging the.    l
+00002b10: 6179 6572 2061 6e64 2061 7267 756d 656e  ayer and argumen
+00002b20: 7420 6e61 6d65 7320 746f 2027 6472 6f70  t names to 'drop
+00002b30: 2070 6174 6827 2072 6174 6865 7220 7468   path' rather th
+00002b40: 616e 206d 6978 2044 726f 7043 6f6e 6e65  an mix DropConne
+00002b50: 6374 2061 7320 6120 6c61 7965 7220 6e61  ct as a layer na
+00002b60: 6d65 2061 6e64 2075 7365 2027 7375 7276  me and use 'surv
+00002b70: 6976 616c 2072 6174 6527 2061 7320 7468  ival rate' as th
+00002b80: 650a 2020 2020 6172 6775 6d65 6e74 2e0a  e.    argument..
+00002b90: 2020 2020 2222 220a 2020 2020 6966 2064      """.    if d
+00002ba0: 726f 705f 7072 6f62 203d 3d20 302e 3020  rop_prob == 0.0 
+00002bb0: 6f72 206e 6f74 2074 7261 696e 696e 673a  or not training:
+00002bc0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00002bd0: 696e 7075 740a 2020 2020 6b65 6570 5f70  input.    keep_p
+00002be0: 726f 6220 3d20 3120 2d20 6472 6f70 5f70  rob = 1 - drop_p
+00002bf0: 726f 620a 2020 2020 7368 6170 6520 3d20  rob.    shape = 
+00002c00: 2869 6e70 7574 2e73 6861 7065 5b30 5d2c  (input.shape[0],
+00002c10: 2920 2b20 2831 2c29 202a 2028 696e 7075  ) + (1,) * (inpu
+00002c20: 742e 6e64 696d 202d 2031 2920 2023 2077  t.ndim - 1)  # w
+00002c30: 6f72 6b20 7769 7468 2064 6966 6620 6469  ork with diff di
+00002c40: 6d20 7465 6e73 6f72 732c 206e 6f74 206a  m tensors, not j
+00002c50: 7573 7420 3244 2043 6f6e 764e 6574 730a  ust 2D ConvNets.
+00002c60: 2020 2020 7261 6e64 6f6d 5f74 656e 736f      random_tenso
+00002c70: 7220 3d20 6b65 6570 5f70 726f 6220 2b20  r = keep_prob + 
+00002c80: 6f70 732e 7261 6e64 2873 6861 7065 2c20  ops.rand(shape, 
+00002c90: 6474 7970 653d 696e 7075 742e 6474 7970  dtype=input.dtyp
+00002ca0: 6529 0a20 2020 2072 616e 646f 6d5f 7465  e).    random_te
+00002cb0: 6e73 6f72 203d 2072 616e 646f 6d5f 7465  nsor = random_te
+00002cc0: 6e73 6f72 2e66 6c6f 6f72 2829 2020 2320  nsor.floor()  # 
+00002cd0: 6269 6e61 7269 7a65 0a20 2020 206f 7574  binarize.    out
+00002ce0: 7075 7420 3d20 696e 7075 742e 6469 7628  put = input.div(
+00002cf0: 6b65 6570 5f70 726f 6229 202a 2072 616e  keep_prob) * ran
+00002d00: 646f 6d5f 7465 6e73 6f72 0a20 2020 2072  dom_tensor.    r
+00002d10: 6574 7572 6e20 6f75 7470 7574 0a0a 0a23  eturn output...#
+00002d20: 2043 6f70 6965 6420 6672 6f6d 2074 7261   Copied from tra
+00002d30: 6e73 666f 726d 6572 732e 6d6f 6465 6c73  nsformers.models
+00002d40: 2e62 6569 742e 6d6f 6465 6c69 6e67 5f62  .beit.modeling_b
+00002d50: 6569 742e 4265 6974 4472 6f70 5061 7468  eit.BeitDropPath
+00002d60: 2077 6974 6820 4265 6974 2d3e 4269 740a   with Beit->Bit.
+00002d70: 636c 6173 7320 4269 7444 726f 7050 6174  class BitDropPat
+00002d80: 6828 6e6e 2e43 656c 6c29 3a0a 2020 2020  h(nn.Cell):.    
+00002d90: 2222 2244 726f 7020 7061 7468 7320 2853  """Drop paths (S
+00002da0: 746f 6368 6173 7469 6320 4465 7074 6829  tochastic Depth)
+00002db0: 2070 6572 2073 616d 706c 6520 2877 6865   per sample (whe
+00002dc0: 6e20 6170 706c 6965 6420 696e 206d 6169  n applied in mai
+00002dd0: 6e20 7061 7468 206f 6620 7265 7369 6475  n path of residu
+00002de0: 616c 2062 6c6f 636b 7329 2e22 2222 0a0a  al blocks)."""..
+00002df0: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
+00002e00: 2873 656c 662c 2064 726f 705f 7072 6f62  (self, drop_prob
+00002e10: 3a20 4f70 7469 6f6e 616c 5b66 6c6f 6174  : Optional[float
+00002e20: 5d20 3d20 4e6f 6e65 2920 2d3e 204e 6f6e  ] = None) -> Non
+00002e30: 653a 0a20 2020 2020 2020 2073 7570 6572  e:.        super
+00002e40: 2829 2e5f 5f69 6e69 745f 5f28 290a 2020  ().__init__().  
+00002e50: 2020 2020 2020 7365 6c66 2e64 726f 705f        self.drop_
+00002e60: 7072 6f62 203d 2064 726f 705f 7072 6f62  prob = drop_prob
+00002e70: 0a0a 2020 2020 6465 6620 636f 6e73 7472  ..    def constr
+00002e80: 7563 7428 7365 6c66 2c20 6869 6464 656e  uct(self, hidden
+00002e90: 5f73 7461 7465 733a 206d 696e 6473 706f  _states: mindspo
+00002ea0: 7265 2e54 656e 736f 7229 202d 3e20 6d69  re.Tensor) -> mi
+00002eb0: 6e64 7370 6f72 652e 5465 6e73 6f72 3a0a  ndspore.Tensor:.
+00002ec0: 2020 2020 2020 2020 7265 7475 726e 2064          return d
+00002ed0: 726f 705f 7061 7468 2868 6964 6465 6e5f  rop_path(hidden_
+00002ee0: 7374 6174 6573 2c20 7365 6c66 2e64 726f  states, self.dro
+00002ef0: 705f 7072 6f62 2c20 7365 6c66 2e74 7261  p_prob, self.tra
+00002f00: 696e 696e 6729 0a0a 2020 2020 6465 6620  ining)..    def 
+00002f10: 6578 7472 615f 7265 7072 2873 656c 6629  extra_repr(self)
+00002f20: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
+00002f30: 2072 6574 7572 6e20 2270 3d7b 7d22 2e66   return "p={}".f
+00002f40: 6f72 6d61 7428 7365 6c66 2e64 726f 705f  ormat(self.drop_
+00002f50: 7072 6f62 290a 0a0a 6465 6620 6d61 6b65  prob)...def make
+00002f60: 5f64 6976 2876 616c 7565 2c20 6469 7669  _div(value, divi
+00002f70: 736f 723d 3829 3a0a 2020 2020 6d69 6e5f  sor=8):.    min_
+00002f80: 7661 6c75 6520 3d20 6469 7669 736f 720a  value = divisor.
+00002f90: 2020 2020 6e65 775f 7661 6c75 6520 3d20      new_value = 
+00002fa0: 6d61 7828 6d69 6e5f 7661 6c75 652c 2069  max(min_value, i
+00002fb0: 6e74 2876 616c 7565 202b 2064 6976 6973  nt(value + divis
+00002fc0: 6f72 202f 2032 2920 2f2f 2064 6976 6973  or / 2) // divis
+00002fd0: 6f72 202a 2064 6976 6973 6f72 290a 2020  or * divisor).  
+00002fe0: 2020 6966 206e 6577 5f76 616c 7565 203c    if new_value <
+00002ff0: 2030 2e39 202a 2076 616c 7565 3a0a 2020   0.9 * value:.  
+00003000: 2020 2020 2020 6e65 775f 7661 6c75 6520        new_value 
+00003010: 2b3d 2064 6976 6973 6f72 0a20 2020 2072  += divisor.    r
+00003020: 6574 7572 6e20 6e65 775f 7661 6c75 650a  eturn new_value.
+00003030: 0a0a 636c 6173 7320 4269 7450 7265 4163  ..class BitPreAc
+00003040: 7469 7661 7469 6f6e 426f 7474 6c65 6e65  tivationBottlene
+00003050: 636b 4c61 7965 7228 6e6e 2e43 656c 6c29  ckLayer(nn.Cell)
+00003060: 3a0a 2020 2020 2222 2250 7265 2d61 6374  :.    """Pre-act
+00003070: 6976 6174 696f 6e20 2876 3229 2062 6f74  ivation (v2) bot
+00003080: 746c 656e 6563 6b20 626c 6f63 6b2e 0a20  tleneck block.. 
+00003090: 2020 2046 6f6c 6c6f 7773 2074 6865 2069     Follows the i
+000030a0: 6d70 6c65 6d65 6e74 6174 696f 6e20 6f66  mplementation of
+000030b0: 2022 4964 656e 7469 7479 204d 6170 7069   "Identity Mappi
+000030c0: 6e67 7320 696e 2044 6565 7020 5265 7369  ngs in Deep Resi
+000030d0: 6475 616c 204e 6574 776f 726b 7322 3a0a  dual Networks":.
+000030e0: 2020 2020 6874 7470 733a 2f2f 6769 7468      https://gith
+000030f0: 7562 2e63 6f6d 2f4b 6169 6d69 6e67 4865  ub.com/KaimingHe
+00003100: 2f72 6573 6e65 742d 316b 2d6c 6179 6572  /resnet-1k-layer
+00003110: 732f 626c 6f62 2f6d 6173 7465 722f 7265  s/blob/master/re
+00003120: 736e 6574 2d70 7265 2d61 6374 2e6c 7561  snet-pre-act.lua
+00003130: 0a0a 2020 2020 4578 6365 7074 2069 7420  ..    Except it 
+00003140: 7075 7473 2074 6865 2073 7472 6964 6520  puts the stride 
+00003150: 6f6e 2033 7833 2063 6f6e 7620 7768 656e  on 3x3 conv when
+00003160: 2061 7661 696c 6162 6c65 2e0a 2020 2020   available..    
+00003170: 2222 220a 0a20 2020 2064 6566 205f 5f69  """..    def __i
+00003180: 6e69 745f 5f28 0a20 2020 2020 2020 2073  nit__(.        s
+00003190: 656c 662c 0a20 2020 2020 2020 2063 6f6e  elf,.        con
+000031a0: 6669 672c 0a20 2020 2020 2020 2069 6e5f  fig,.        in_
+000031b0: 6368 616e 6e65 6c73 2c0a 2020 2020 2020  channels,.      
+000031c0: 2020 6f75 745f 6368 616e 6e65 6c73 3d4e    out_channels=N
+000031d0: 6f6e 652c 0a20 2020 2020 2020 2062 6f74  one,.        bot
+000031e0: 746c 655f 7261 7469 6f3d 302e 3235 2c0a  tle_ratio=0.25,.
+000031f0: 2020 2020 2020 2020 7374 7269 6465 3d31          stride=1
+00003200: 2c0a 2020 2020 2020 2020 6469 6c61 7469  ,.        dilati
+00003210: 6f6e 3d31 2c0a 2020 2020 2020 2020 6669  on=1,.        fi
+00003220: 7273 745f 6469 6c61 7469 6f6e 3d4e 6f6e  rst_dilation=Non
+00003230: 652c 0a20 2020 2020 2020 2067 726f 7570  e,.        group
+00003240: 733d 312c 0a20 2020 2020 2020 2064 726f  s=1,.        dro
+00003250: 705f 7061 7468 5f72 6174 653d 302e 302c  p_path_rate=0.0,
+00003260: 0a20 2020 2020 2020 2069 735f 6669 7273  .        is_firs
+00003270: 745f 6c61 7965 723d 4661 6c73 652c 0a20  t_layer=False,. 
+00003280: 2020 2029 3a0a 2020 2020 2020 2020 7375     ):.        su
+00003290: 7065 7228 292e 5f5f 696e 6974 5f5f 2829  per().__init__()
+000032a0: 0a0a 2020 2020 2020 2020 6669 7273 745f  ..        first_
+000032b0: 6469 6c61 7469 6f6e 203d 2066 6972 7374  dilation = first
+000032c0: 5f64 696c 6174 696f 6e20 6f72 2064 696c  _dilation or dil
+000032d0: 6174 696f 6e0a 0a20 2020 2020 2020 206f  ation..        o
+000032e0: 7574 5f63 6861 6e6e 656c 7320 3d20 6f75  ut_channels = ou
+000032f0: 745f 6368 616e 6e65 6c73 206f 7220 696e  t_channels or in
+00003300: 5f63 6861 6e6e 656c 730a 2020 2020 2020  _channels.      
+00003310: 2020 6d69 645f 6368 616e 6e65 6c73 203d    mid_channels =
+00003320: 206d 616b 655f 6469 7628 6f75 745f 6368   make_div(out_ch
+00003330: 616e 6e65 6c73 202a 2062 6f74 746c 655f  annels * bottle_
+00003340: 7261 7469 6f29 0a0a 2020 2020 2020 2020  ratio)..        
+00003350: 6966 2069 735f 6669 7273 745f 6c61 7965  if is_first_laye
+00003360: 723a 0a20 2020 2020 2020 2020 2020 2073  r:.            s
+00003370: 656c 662e 646f 776e 7361 6d70 6c65 203d  elf.downsample =
+00003380: 2042 6974 446f 776e 7361 6d70 6c65 436f   BitDownsampleCo
+00003390: 6e76 280a 2020 2020 2020 2020 2020 2020  nv(.            
+000033a0: 2020 2020 636f 6e66 6967 2c0a 2020 2020      config,.    
+000033b0: 2020 2020 2020 2020 2020 2020 696e 5f63              in_c
+000033c0: 6861 6e6e 656c 732c 0a20 2020 2020 2020  hannels,.       
+000033d0: 2020 2020 2020 2020 206f 7574 5f63 6861           out_cha
+000033e0: 6e6e 656c 732c 0a20 2020 2020 2020 2020  nnels,.         
+000033f0: 2020 2020 2020 2073 7472 6964 653d 7374         stride=st
+00003400: 7269 6465 2c0a 2020 2020 2020 2020 2020  ride,.          
+00003410: 2020 2020 2020 7072 6561 6374 3d54 7275        preact=Tru
+00003420: 652c 0a20 2020 2020 2020 2020 2020 2029  e,.            )
+00003430: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00003440: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00003450: 646f 776e 7361 6d70 6c65 203d 204e 6f6e  downsample = Non
+00003460: 650a 0a20 2020 2020 2020 2073 656c 662e  e..        self.
+00003470: 6e6f 726d 3120 3d20 4269 7447 726f 7570  norm1 = BitGroup
+00003480: 4e6f 726d 4163 7469 7661 7469 6f6e 2863  NormActivation(c
+00003490: 6f6e 6669 672c 2069 6e5f 6368 616e 6e65  onfig, in_channe
+000034a0: 6c73 290a 2020 2020 2020 2020 7365 6c66  ls).        self
+000034b0: 2e63 6f6e 7631 203d 2057 6569 6768 7453  .conv1 = WeightS
+000034c0: 7461 6e64 6172 6469 7a65 6443 6f6e 7632  tandardizedConv2
+000034d0: 6428 696e 5f63 6861 6e6e 656c 732c 206d  d(in_channels, m
+000034e0: 6964 5f63 6861 6e6e 656c 732c 2031 2c20  id_channels, 1, 
+000034f0: 6570 733d 3165 2d38 2c20 7061 6464 696e  eps=1e-8, paddin
+00003500: 673d 636f 6e66 6967 2e67 6c6f 6261 6c5f  g=config.global_
+00003510: 7061 6464 696e 6729 0a0a 2020 2020 2020  padding)..      
+00003520: 2020 7365 6c66 2e6e 6f72 6d32 203d 2042    self.norm2 = B
+00003530: 6974 4772 6f75 704e 6f72 6d41 6374 6976  itGroupNormActiv
+00003540: 6174 696f 6e28 636f 6e66 6967 2c20 6e75  ation(config, nu
+00003550: 6d5f 6368 616e 6e65 6c73 3d6d 6964 5f63  m_channels=mid_c
+00003560: 6861 6e6e 656c 7329 0a20 2020 2020 2020  hannels).       
+00003570: 2073 656c 662e 636f 6e76 3220 3d20 5765   self.conv2 = We
+00003580: 6967 6874 5374 616e 6461 7264 697a 6564  ightStandardized
+00003590: 436f 6e76 3264 280a 2020 2020 2020 2020  Conv2d(.        
+000035a0: 2020 2020 6d69 645f 6368 616e 6e65 6c73      mid_channels
+000035b0: 2c20 6d69 645f 6368 616e 6e65 6c73 2c20  , mid_channels, 
+000035c0: 332c 2073 7472 6964 653d 7374 7269 6465  3, stride=stride
+000035d0: 2c20 6772 6f75 7073 3d67 726f 7570 732c  , groups=groups,
+000035e0: 2065 7073 3d31 652d 382c 2070 6164 6469   eps=1e-8, paddi
+000035f0: 6e67 3d63 6f6e 6669 672e 676c 6f62 616c  ng=config.global
+00003600: 5f70 6164 6469 6e67 0a20 2020 2020 2020  _padding.       
+00003610: 2029 0a0a 2020 2020 2020 2020 7365 6c66   )..        self
+00003620: 2e6e 6f72 6d33 203d 2042 6974 4772 6f75  .norm3 = BitGrou
+00003630: 704e 6f72 6d41 6374 6976 6174 696f 6e28  pNormActivation(
+00003640: 636f 6e66 6967 2c20 6d69 645f 6368 616e  config, mid_chan
+00003650: 6e65 6c73 290a 2020 2020 2020 2020 7365  nels).        se
+00003660: 6c66 2e63 6f6e 7633 203d 2057 6569 6768  lf.conv3 = Weigh
+00003670: 7453 7461 6e64 6172 6469 7a65 6443 6f6e  tStandardizedCon
+00003680: 7632 6428 6d69 645f 6368 616e 6e65 6c73  v2d(mid_channels
+00003690: 2c20 6f75 745f 6368 616e 6e65 6c73 2c20  , out_channels, 
+000036a0: 312c 2065 7073 3d31 652d 382c 2070 6164  1, eps=1e-8, pad
+000036b0: 6469 6e67 3d63 6f6e 6669 672e 676c 6f62  ding=config.glob
+000036c0: 616c 5f70 6164 6469 6e67 290a 0a20 2020  al_padding)..   
+000036d0: 2020 2020 2073 656c 662e 6472 6f70 5f70       self.drop_p
+000036e0: 6174 6820 3d20 4269 7444 726f 7050 6174  ath = BitDropPat
+000036f0: 6828 6472 6f70 5f70 6174 685f 7261 7465  h(drop_path_rate
+00003700: 2920 6966 2064 726f 705f 7061 7468 5f72  ) if drop_path_r
+00003710: 6174 6520 3e20 3020 656c 7365 206e 6e2e  ate > 0 else nn.
+00003720: 4964 656e 7469 7479 2829 0a0a 2020 2020  Identity()..    
+00003730: 6465 6620 636f 6e73 7472 7563 7428 7365  def construct(se
+00003740: 6c66 2c20 6869 6464 656e 5f73 7461 7465  lf, hidden_state
+00003750: 7329 3a0a 2020 2020 2020 2020 6869 6464  s):.        hidd
+00003760: 656e 5f73 7461 7465 735f 7072 6561 6374  en_states_preact
+00003770: 203d 2073 656c 662e 6e6f 726d 3128 6869   = self.norm1(hi
+00003780: 6464 656e 5f73 7461 7465 7329 0a0a 2020  dden_states)..  
+00003790: 2020 2020 2020 2320 7368 6f72 7463 7574        # shortcut
+000037a0: 2062 7261 6e63 680a 2020 2020 2020 2020   branch.        
+000037b0: 7368 6f72 7463 7574 203d 2068 6964 6465  shortcut = hidde
+000037c0: 6e5f 7374 6174 6573 0a20 2020 2020 2020  n_states.       
+000037d0: 2069 6620 7365 6c66 2e64 6f77 6e73 616d   if self.downsam
+000037e0: 706c 6520 6973 206e 6f74 204e 6f6e 653a  ple is not None:
+000037f0: 0a20 2020 2020 2020 2020 2020 2073 686f  .            sho
+00003800: 7274 6375 7420 3d20 7365 6c66 2e64 6f77  rtcut = self.dow
+00003810: 6e73 616d 706c 6528 6869 6464 656e 5f73  nsample(hidden_s
+00003820: 7461 7465 735f 7072 6561 6374 290a 0a20  tates_preact).. 
+00003830: 2020 2020 2020 2023 2072 6573 6964 7561         # residua
+00003840: 6c20 6272 616e 6368 0a20 2020 2020 2020  l branch.       
+00003850: 2068 6964 6465 6e5f 7374 6174 6573 203d   hidden_states =
+00003860: 2073 656c 662e 636f 6e76 3128 6869 6464   self.conv1(hidd
+00003870: 656e 5f73 7461 7465 735f 7072 6561 6374  en_states_preact
+00003880: 290a 2020 2020 2020 2020 6869 6464 656e  ).        hidden
+00003890: 5f73 7461 7465 7320 3d20 7365 6c66 2e63  _states = self.c
+000038a0: 6f6e 7632 2873 656c 662e 6e6f 726d 3228  onv2(self.norm2(
+000038b0: 6869 6464 656e 5f73 7461 7465 7329 290a  hidden_states)).
+000038c0: 2020 2020 2020 2020 6869 6464 656e 5f73          hidden_s
+000038d0: 7461 7465 7320 3d20 7365 6c66 2e63 6f6e  tates = self.con
+000038e0: 7633 2873 656c 662e 6e6f 726d 3328 6869  v3(self.norm3(hi
+000038f0: 6464 656e 5f73 7461 7465 7329 290a 2020  dden_states)).  
+00003900: 2020 2020 2020 6869 6464 656e 5f73 7461        hidden_sta
+00003910: 7465 7320 3d20 7365 6c66 2e64 726f 705f  tes = self.drop_
+00003920: 7061 7468 2868 6964 6465 6e5f 7374 6174  path(hidden_stat
+00003930: 6573 290a 2020 2020 2020 2020 7265 7475  es).        retu
+00003940: 726e 2068 6964 6465 6e5f 7374 6174 6573  rn hidden_states
+00003950: 202b 2073 686f 7274 6375 740a 0a0a 636c   + shortcut...cl
+00003960: 6173 7320 4269 7442 6f74 746c 656e 6563  ass BitBottlenec
+00003970: 6b4c 6179 6572 286e 6e2e 4365 6c6c 293a  kLayer(nn.Cell):
+00003980: 0a20 2020 2022 2222 4e6f 6e20 5072 652d  .    """Non Pre-
+00003990: 6163 7469 7661 7469 6f6e 2062 6f74 746c  activation bottl
+000039a0: 656e 6563 6b20 626c 6f63 6b2c 2065 7175  eneck block, equ
+000039b0: 6976 616c 656e 7420 746f 2056 312e 352f  ivalent to V1.5/
+000039c0: 5631 6220 626f 7474 6c65 6e65 636b 2e20  V1b bottleneck. 
+000039d0: 5573 6564 2066 6f72 2056 6954 2048 7962  Used for ViT Hyb
+000039e0: 7269 642e 2222 220a 0a20 2020 2064 6566  rid."""..    def
+000039f0: 205f 5f69 6e69 745f 5f28 0a20 2020 2020   __init__(.     
+00003a00: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+00003a10: 2063 6f6e 6669 672c 0a20 2020 2020 2020   config,.       
+00003a20: 2069 6e5f 6368 616e 6e65 6c73 2c0a 2020   in_channels,.  
+00003a30: 2020 2020 2020 6f75 745f 6368 616e 6e65        out_channe
+00003a40: 6c73 3d4e 6f6e 652c 0a20 2020 2020 2020  ls=None,.       
+00003a50: 2062 6f74 746c 655f 7261 7469 6f3d 302e   bottle_ratio=0.
+00003a60: 3235 2c0a 2020 2020 2020 2020 7374 7269  25,.        stri
+00003a70: 6465 3d31 2c0a 2020 2020 2020 2020 6469  de=1,.        di
+00003a80: 6c61 7469 6f6e 3d31 2c0a 2020 2020 2020  lation=1,.      
+00003a90: 2020 6669 7273 745f 6469 6c61 7469 6f6e    first_dilation
+00003aa0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2067  =None,.        g
+00003ab0: 726f 7570 733d 312c 0a20 2020 2020 2020  roups=1,.       
+00003ac0: 2064 726f 705f 7061 7468 5f72 6174 653d   drop_path_rate=
+00003ad0: 302e 302c 0a20 2020 2020 2020 2069 735f  0.0,.        is_
+00003ae0: 6669 7273 745f 6c61 7965 723d 4661 6c73  first_layer=Fals
+00003af0: 652c 0a20 2020 2029 3a0a 2020 2020 2020  e,.    ):.      
+00003b00: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
+00003b10: 5f5f 2829 0a20 2020 2020 2020 2066 6972  __().        fir
+00003b20: 7374 5f64 696c 6174 696f 6e20 3d20 6669  st_dilation = fi
+00003b30: 7273 745f 6469 6c61 7469 6f6e 206f 7220  rst_dilation or 
+00003b40: 6469 6c61 7469 6f6e 0a0a 2020 2020 2020  dilation..      
+00003b50: 2020 6f75 745f 6368 616e 6e65 6c73 203d    out_channels =
+00003b60: 206f 7574 5f63 6861 6e6e 656c 7320 6f72   out_channels or
+00003b70: 2069 6e5f 6368 616e 6e65 6c73 0a20 2020   in_channels.   
+00003b80: 2020 2020 206d 6964 5f63 6873 203d 206d       mid_chs = m
+00003b90: 616b 655f 6469 7628 6f75 745f 6368 616e  ake_div(out_chan
+00003ba0: 6e65 6c73 202a 2062 6f74 746c 655f 7261  nels * bottle_ra
+00003bb0: 7469 6f29 0a0a 2020 2020 2020 2020 6966  tio)..        if
+00003bc0: 2069 735f 6669 7273 745f 6c61 7965 723a   is_first_layer:
+00003bd0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00003be0: 662e 646f 776e 7361 6d70 6c65 203d 2042  f.downsample = B
+00003bf0: 6974 446f 776e 7361 6d70 6c65 436f 6e76  itDownsampleConv
+00003c00: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00003c10: 2020 636f 6e66 6967 2c0a 2020 2020 2020    config,.      
+00003c20: 2020 2020 2020 2020 2020 696e 5f63 6861            in_cha
+00003c30: 6e6e 656c 732c 0a20 2020 2020 2020 2020  nnels,.         
+00003c40: 2020 2020 2020 206f 7574 5f63 6861 6e6e         out_chann
+00003c50: 656c 732c 0a20 2020 2020 2020 2020 2020  els,.           
+00003c60: 2020 2020 2073 7472 6964 653d 7374 7269       stride=stri
+00003c70: 6465 2c0a 2020 2020 2020 2020 2020 2020  de,.            
+00003c80: 2020 2020 7072 6561 6374 3d46 616c 7365      preact=False
+00003c90: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+00003ca0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00003cb0: 2020 2020 2020 2020 2020 7365 6c66 2e64            self.d
+00003cc0: 6f77 6e73 616d 706c 6520 3d20 4e6f 6e65  ownsample = None
+00003cd0: 0a0a 2020 2020 2020 2020 7365 6c66 2e63  ..        self.c
+00003ce0: 6f6e 7631 203d 2057 6569 6768 7453 7461  onv1 = WeightSta
+00003cf0: 6e64 6172 6469 7a65 6443 6f6e 7632 6428  ndardizedConv2d(
+00003d00: 696e 5f63 6861 6e6e 656c 732c 206d 6964  in_channels, mid
+00003d10: 5f63 6873 2c20 312c 2065 7073 3d31 652d  _chs, 1, eps=1e-
+00003d20: 382c 2070 6164 6469 6e67 3d63 6f6e 6669  8, padding=confi
+00003d30: 672e 676c 6f62 616c 5f70 6164 6469 6e67  g.global_padding
+00003d40: 290a 2020 2020 2020 2020 7365 6c66 2e6e  ).        self.n
+00003d50: 6f72 6d31 203d 2042 6974 4772 6f75 704e  orm1 = BitGroupN
+00003d60: 6f72 6d41 6374 6976 6174 696f 6e28 636f  ormActivation(co
+00003d70: 6e66 6967 2c20 6e75 6d5f 6368 616e 6e65  nfig, num_channe
+00003d80: 6c73 3d6d 6964 5f63 6873 290a 2020 2020  ls=mid_chs).    
+00003d90: 2020 2020 7365 6c66 2e63 6f6e 7632 203d      self.conv2 =
+00003da0: 2057 6569 6768 7453 7461 6e64 6172 6469   WeightStandardi
+00003db0: 7a65 6443 6f6e 7632 6428 0a20 2020 2020  zedConv2d(.     
+00003dc0: 2020 2020 2020 206d 6964 5f63 6873 2c0a         mid_chs,.
+00003dd0: 2020 2020 2020 2020 2020 2020 6d69 645f              mid_
+00003de0: 6368 732c 0a20 2020 2020 2020 2020 2020  chs,.           
+00003df0: 2033 2c0a 2020 2020 2020 2020 2020 2020   3,.            
+00003e00: 7374 7269 6465 3d73 7472 6964 652c 0a20  stride=stride,. 
+00003e10: 2020 2020 2020 2020 2020 2064 696c 6174             dilat
+00003e20: 696f 6e3d 6669 7273 745f 6469 6c61 7469  ion=first_dilati
+00003e30: 6f6e 2c0a 2020 2020 2020 2020 2020 2020  on,.            
+00003e40: 6772 6f75 7073 3d67 726f 7570 732c 0a20  groups=groups,. 
+00003e50: 2020 2020 2020 2020 2020 2065 7073 3d31             eps=1
+00003e60: 652d 382c 0a20 2020 2020 2020 2020 2020  e-8,.           
+00003e70: 2070 6164 6469 6e67 3d63 6f6e 6669 672e   padding=config.
+00003e80: 676c 6f62 616c 5f70 6164 6469 6e67 2c0a  global_padding,.
+00003e90: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00003ea0: 2020 7365 6c66 2e6e 6f72 6d32 203d 2042    self.norm2 = B
+00003eb0: 6974 4772 6f75 704e 6f72 6d41 6374 6976  itGroupNormActiv
+00003ec0: 6174 696f 6e28 636f 6e66 6967 2c20 6e75  ation(config, nu
+00003ed0: 6d5f 6368 616e 6e65 6c73 3d6d 6964 5f63  m_channels=mid_c
+00003ee0: 6873 290a 2020 2020 2020 2020 7365 6c66  hs).        self
+00003ef0: 2e63 6f6e 7633 203d 2057 6569 6768 7453  .conv3 = WeightS
+00003f00: 7461 6e64 6172 6469 7a65 6443 6f6e 7632  tandardizedConv2
+00003f10: 6428 6d69 645f 6368 732c 206f 7574 5f63  d(mid_chs, out_c
+00003f20: 6861 6e6e 656c 732c 2031 2c20 6570 733d  hannels, 1, eps=
+00003f30: 3165 2d38 2c20 7061 6464 696e 673d 636f  1e-8, padding=co
+00003f40: 6e66 6967 2e67 6c6f 6261 6c5f 7061 6464  nfig.global_padd
+00003f50: 696e 6729 0a20 2020 2020 2020 2073 656c  ing).        sel
+00003f60: 662e 6e6f 726d 3320 3d20 4269 7447 726f  f.norm3 = BitGro
+00003f70: 7570 4e6f 726d 4163 7469 7661 7469 6f6e  upNormActivation
+00003f80: 2863 6f6e 6669 672c 206e 756d 5f63 6861  (config, num_cha
+00003f90: 6e6e 656c 733d 6f75 745f 6368 616e 6e65  nnels=out_channe
+00003fa0: 6c73 2c20 6170 706c 795f 6163 7469 7661  ls, apply_activa
+00003fb0: 7469 6f6e 3d46 616c 7365 290a 2020 2020  tion=False).    
+00003fc0: 2020 2020 7365 6c66 2e64 726f 705f 7061      self.drop_pa
+00003fd0: 7468 203d 2042 6974 4472 6f70 5061 7468  th = BitDropPath
+00003fe0: 2864 726f 705f 7061 7468 5f72 6174 6529  (drop_path_rate)
+00003ff0: 2069 6620 6472 6f70 5f70 6174 685f 7261   if drop_path_ra
+00004000: 7465 203e 2030 2065 6c73 6520 6e6e 2e49  te > 0 else nn.I
+00004010: 6465 6e74 6974 7928 290a 0a20 2020 2020  dentity()..     
+00004020: 2020 2073 656c 662e 6163 7469 7661 7469     self.activati
+00004030: 6f6e 203d 2041 4354 3246 4e5b 636f 6e66  on = ACT2FN[conf
+00004040: 6967 2e68 6964 6465 6e5f 6163 745d 0a0a  ig.hidden_act]..
+00004050: 2020 2020 6465 6620 636f 6e73 7472 7563      def construc
+00004060: 7428 7365 6c66 2c20 6869 6464 656e 5f73  t(self, hidden_s
+00004070: 7461 7465 7329 3a0a 2020 2020 2020 2020  tates):.        
+00004080: 2320 7368 6f72 7463 7574 2062 7261 6e63  # shortcut branc
+00004090: 680a 2020 2020 2020 2020 7368 6f72 7463  h.        shortc
+000040a0: 7574 203d 2068 6964 6465 6e5f 7374 6174  ut = hidden_stat
+000040b0: 6573 0a20 2020 2020 2020 2069 6620 7365  es.        if se
+000040c0: 6c66 2e64 6f77 6e73 616d 706c 6520 6973  lf.downsample is
+000040d0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+000040e0: 2020 2020 2020 2073 686f 7274 6375 7420         shortcut 
+000040f0: 3d20 7365 6c66 2e64 6f77 6e73 616d 706c  = self.downsampl
+00004100: 6528 6869 6464 656e 5f73 7461 7465 7329  e(hidden_states)
+00004110: 0a0a 2020 2020 2020 2020 2320 7265 7369  ..        # resi
+00004120: 6475 616c 0a20 2020 2020 2020 2068 6964  dual.        hid
+00004130: 6465 6e5f 7374 6174 6573 203d 2073 656c  den_states = sel
+00004140: 662e 636f 6e76 3128 6869 6464 656e 5f73  f.conv1(hidden_s
+00004150: 7461 7465 7329 0a20 2020 2020 2020 2068  tates).        h
+00004160: 6964 6465 6e5f 7374 6174 6573 203d 2073  idden_states = s
+00004170: 656c 662e 6e6f 726d 3128 6869 6464 656e  elf.norm1(hidden
+00004180: 5f73 7461 7465 7329 0a0a 2020 2020 2020  _states)..      
+00004190: 2020 6869 6464 656e 5f73 7461 7465 7320    hidden_states 
+000041a0: 3d20 7365 6c66 2e63 6f6e 7632 2868 6964  = self.conv2(hid
+000041b0: 6465 6e5f 7374 6174 6573 290a 2020 2020  den_states).    
+000041c0: 2020 2020 6869 6464 656e 5f73 7461 7465      hidden_state
+000041d0: 7320 3d20 7365 6c66 2e6e 6f72 6d32 2868  s = self.norm2(h
+000041e0: 6964 6465 6e5f 7374 6174 6573 290a 0a20  idden_states).. 
+000041f0: 2020 2020 2020 2068 6964 6465 6e5f 7374         hidden_st
+00004200: 6174 6573 203d 2073 656c 662e 636f 6e76  ates = self.conv
+00004210: 3328 6869 6464 656e 5f73 7461 7465 7329  3(hidden_states)
+00004220: 0a20 2020 2020 2020 2068 6964 6465 6e5f  .        hidden_
+00004230: 7374 6174 6573 203d 2073 656c 662e 6e6f  states = self.no
+00004240: 726d 3328 6869 6464 656e 5f73 7461 7465  rm3(hidden_state
+00004250: 7329 0a0a 2020 2020 2020 2020 6869 6464  s)..        hidd
+00004260: 656e 5f73 7461 7465 7320 3d20 7365 6c66  en_states = self
+00004270: 2e64 726f 705f 7061 7468 2868 6964 6465  .drop_path(hidde
+00004280: 6e5f 7374 6174 6573 290a 2020 2020 2020  n_states).      
+00004290: 2020 6869 6464 656e 5f73 7461 7465 7320    hidden_states 
+000042a0: 3d20 7365 6c66 2e61 6374 6976 6174 696f  = self.activatio
+000042b0: 6e28 6869 6464 656e 5f73 7461 7465 7320  n(hidden_states 
+000042c0: 2b20 7368 6f72 7463 7574 290a 2020 2020  + shortcut).    
+000042d0: 2020 2020 7265 7475 726e 2068 6964 6465      return hidde
+000042e0: 6e5f 7374 6174 6573 0a0a 0a63 6c61 7373  n_states...class
+000042f0: 2042 6974 446f 776e 7361 6d70 6c65 436f   BitDownsampleCo
+00004300: 6e76 286e 6e2e 4365 6c6c 293a 0a20 2020  nv(nn.Cell):.   
+00004310: 2064 6566 205f 5f69 6e69 745f 5f28 0a20   def __init__(. 
+00004320: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+00004330: 2020 2020 2063 6f6e 6669 672c 0a20 2020       config,.   
+00004340: 2020 2020 2069 6e5f 6368 616e 6e65 6c73       in_channels
+00004350: 2c0a 2020 2020 2020 2020 6f75 745f 6368  ,.        out_ch
+00004360: 616e 6e65 6c73 2c0a 2020 2020 2020 2020  annels,.        
+00004370: 7374 7269 6465 3d31 2c0a 2020 2020 2020  stride=1,.      
+00004380: 2020 7072 6561 6374 3d54 7275 652c 0a20    preact=True,. 
+00004390: 2020 2029 3a0a 2020 2020 2020 2020 7375     ):.        su
+000043a0: 7065 7228 292e 5f5f 696e 6974 5f5f 2829  per().__init__()
+000043b0: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
+000043c0: 6e76 203d 2057 6569 6768 7453 7461 6e64  nv = WeightStand
+000043d0: 6172 6469 7a65 6443 6f6e 7632 6428 0a20  ardizedConv2d(. 
+000043e0: 2020 2020 2020 2020 2020 2069 6e5f 6368             in_ch
+000043f0: 616e 6e65 6c73 2c20 6f75 745f 6368 616e  annels, out_chan
+00004400: 6e65 6c73 2c20 312c 2073 7472 6964 653d  nels, 1, stride=
+00004410: 7374 7269 6465 2c20 6570 733d 3165 2d38  stride, eps=1e-8
+00004420: 2c20 7061 6464 696e 673d 636f 6e66 6967  , padding=config
+00004430: 2e67 6c6f 6261 6c5f 7061 6464 696e 670a  .global_padding.
+00004440: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00004450: 2020 7365 6c66 2e6e 6f72 6d20 3d20 280a    self.norm = (.
+00004460: 2020 2020 2020 2020 2020 2020 6e6e 2e49              nn.I
+00004470: 6465 6e74 6974 7928 290a 2020 2020 2020  dentity().      
+00004480: 2020 2020 2020 6966 2070 7265 6163 740a        if preact.
+00004490: 2020 2020 2020 2020 2020 2020 656c 7365              else
+000044a0: 2042 6974 4772 6f75 704e 6f72 6d41 6374   BitGroupNormAct
+000044b0: 6976 6174 696f 6e28 636f 6e66 6967 2c20  ivation(config, 
+000044c0: 6e75 6d5f 6368 616e 6e65 6c73 3d6f 7574  num_channels=out
+000044d0: 5f63 6861 6e6e 656c 732c 2061 7070 6c79  _channels, apply
+000044e0: 5f61 6374 6976 6174 696f 6e3d 4661 6c73  _activation=Fals
+000044f0: 6529 0a20 2020 2020 2020 2029 0a0a 2020  e).        )..  
+00004500: 2020 6465 6620 636f 6e73 7472 7563 7428    def construct(
+00004510: 7365 6c66 2c20 7829 3a0a 2020 2020 2020  self, x):.      
+00004520: 2020 7265 7475 726e 2073 656c 662e 6e6f    return self.no
+00004530: 726d 2873 656c 662e 636f 6e76 2878 2929  rm(self.conv(x))
+00004540: 0a0a 0a63 6c61 7373 2042 6974 5374 6167  ...class BitStag
+00004550: 6528 6e6e 2e43 656c 6c29 3a0a 2020 2020  e(nn.Cell):.    
+00004560: 2222 220a 2020 2020 4120 5265 734e 6574  """.    A ResNet
+00004570: 2076 3220 7374 6167 6520 636f 6d70 6f73   v2 stage compos
+00004580: 6564 2062 7920 7374 6163 6b65 6420 6c61  ed by stacked la
+00004590: 7965 7273 2e0a 2020 2020 2222 220a 0a20  yers..    """.. 
+000045a0: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
+000045b0: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+000045c0: 2020 2020 2020 2063 6f6e 6669 672c 0a20         config,. 
+000045d0: 2020 2020 2020 2069 6e5f 6368 616e 6e65         in_channe
+000045e0: 6c73 2c0a 2020 2020 2020 2020 6f75 745f  ls,.        out_
+000045f0: 6368 616e 6e65 6c73 2c0a 2020 2020 2020  channels,.      
+00004600: 2020 7374 7269 6465 2c0a 2020 2020 2020    stride,.      
+00004610: 2020 6469 6c61 7469 6f6e 2c0a 2020 2020    dilation,.    
+00004620: 2020 2020 6465 7074 682c 0a20 2020 2020      depth,.     
+00004630: 2020 2062 6f74 746c 655f 7261 7469 6f3d     bottle_ratio=
+00004640: 302e 3235 2c0a 2020 2020 2020 2020 6c61  0.25,.        la
+00004650: 7965 725f 6472 6f70 6f75 743d 4e6f 6e65  yer_dropout=None
+00004660: 2c0a 2020 2020 293a 0a20 2020 2020 2020  ,.    ):.       
+00004670: 2073 7570 6572 2829 2e5f 5f69 6e69 745f   super().__init_
+00004680: 5f28 290a 0a20 2020 2020 2020 2066 6972  _()..        fir
+00004690: 7374 5f64 696c 6174 696f 6e20 3d20 3120  st_dilation = 1 
+000046a0: 6966 2064 696c 6174 696f 6e20 696e 2028  if dilation in (
+000046b0: 312c 2032 2920 656c 7365 2032 0a0a 2020  1, 2) else 2..  
+000046c0: 2020 2020 2020 2320 4765 7420 7468 6520        # Get the 
+000046d0: 6c61 7965 7220 7479 7065 0a20 2020 2020  layer type.     
+000046e0: 2020 2069 6620 636f 6e66 6967 2e6c 6179     if config.lay
+000046f0: 6572 5f74 7970 6520 3d3d 2022 626f 7474  er_type == "bott
+00004700: 6c65 6e65 636b 223a 0a20 2020 2020 2020  leneck":.       
+00004710: 2020 2020 206c 6179 6572 5f63 6c73 203d       layer_cls =
+00004720: 2042 6974 426f 7474 6c65 6e65 636b 4c61   BitBottleneckLa
+00004730: 7965 720a 2020 2020 2020 2020 656c 7365  yer.        else
+00004740: 3a0a 2020 2020 2020 2020 2020 2020 6c61  :.            la
+00004750: 7965 725f 636c 7320 3d20 4269 7450 7265  yer_cls = BitPre
+00004760: 4163 7469 7661 7469 6f6e 426f 7474 6c65  ActivationBottle
+00004770: 6e65 636b 4c61 7965 720a 0a20 2020 2020  neckLayer..     
+00004780: 2020 2070 7265 765f 6368 7320 3d20 696e     prev_chs = in
+00004790: 5f63 6861 6e6e 656c 730a 2020 2020 2020  _channels.      
+000047a0: 2020 7365 6c66 2e6c 6179 6572 7320 3d20    self.layers = 
+000047b0: 6e6e 2e53 6571 7565 6e74 6961 6c43 656c  nn.SequentialCel
+000047c0: 6c28 290a 2020 2020 2020 2020 666f 7220  l().        for 
+000047d0: 6c61 7965 725f 6964 7820 696e 2072 616e  layer_idx in ran
+000047e0: 6765 2864 6570 7468 293a 0a20 2020 2020  ge(depth):.     
+000047f0: 2020 2020 2020 2023 2047 6574 2074 6865         # Get the
+00004800: 2063 7572 7265 6e74 2068 7970 6572 2d70   current hyper-p
+00004810: 6172 616d 6574 6572 730a 2020 2020 2020  arameters.      
+00004820: 2020 2020 2020 7374 7269 6465 2c20 6472        stride, dr
+00004830: 6f70 5f70 6174 685f 7261 7465 2c20 6973  op_path_rate, is
+00004840: 5f66 6972 7374 5f6c 6179 6572 203d 2073  _first_layer = s
+00004850: 656c 662e 5f67 6574 5f75 7064 6174 6564  elf._get_updated
+00004860: 5f68 7970 6572 7061 7261 6d65 7465 7273  _hyperparameters
+00004870: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00004880: 2020 6c61 7965 725f 6964 782c 2073 7472    layer_idx, str
+00004890: 6964 652c 206c 6179 6572 5f64 726f 706f  ide, layer_dropo
+000048a0: 7574 0a20 2020 2020 2020 2020 2020 2029  ut.            )
+000048b0: 0a0a 2020 2020 2020 2020 2020 2020 7365  ..            se
+000048c0: 6c66 2e6c 6179 6572 732e 6170 7065 6e64  lf.layers.append
+000048d0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000048e0: 2020 6c61 7965 725f 636c 7328 0a20 2020    layer_cls(.   
+000048f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004900: 2063 6f6e 6669 672c 0a20 2020 2020 2020   config,.       
+00004910: 2020 2020 2020 2020 2020 2020 2070 7265               pre
+00004920: 765f 6368 732c 0a20 2020 2020 2020 2020  v_chs,.         
+00004930: 2020 2020 2020 2020 2020 206f 7574 5f63             out_c
+00004940: 6861 6e6e 656c 732c 0a20 2020 2020 2020  hannels,.       
+00004950: 2020 2020 2020 2020 2020 2020 2073 7472               str
+00004960: 6964 653d 7374 7269 6465 2c0a 2020 2020  ide=stride,.    
+00004970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004980: 6469 6c61 7469 6f6e 3d64 696c 6174 696f  dilation=dilatio
+00004990: 6e2c 0a20 2020 2020 2020 2020 2020 2020  n,.             
+000049a0: 2020 2020 2020 2062 6f74 746c 655f 7261         bottle_ra
+000049b0: 7469 6f3d 626f 7474 6c65 5f72 6174 696f  tio=bottle_ratio
+000049c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000049d0: 2020 2020 2020 6669 7273 745f 6469 6c61        first_dila
+000049e0: 7469 6f6e 3d66 6972 7374 5f64 696c 6174  tion=first_dilat
+000049f0: 696f 6e2c 0a20 2020 2020 2020 2020 2020  ion,.           
+00004a00: 2020 2020 2020 2020 2064 726f 705f 7061           drop_pa
+00004a10: 7468 5f72 6174 653d 6472 6f70 5f70 6174  th_rate=drop_pat
+00004a20: 685f 7261 7465 2c0a 2020 2020 2020 2020  h_rate,.        
+00004a30: 2020 2020 2020 2020 2020 2020 6973 5f66              is_f
+00004a40: 6972 7374 5f6c 6179 6572 3d69 735f 6669  irst_layer=is_fi
+00004a50: 7273 745f 6c61 7965 722c 0a20 2020 2020  rst_layer,.     
+00004a60: 2020 2020 2020 2020 2020 2029 2c0a 2020             ),.  
+00004a70: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00004a80: 2020 2020 2020 2020 7072 6576 5f63 6873          prev_chs
+00004a90: 203d 206f 7574 5f63 6861 6e6e 656c 730a   = out_channels.
+00004aa0: 2020 2020 2020 2020 2020 2020 6669 7273              firs
+00004ab0: 745f 6469 6c61 7469 6f6e 203d 2064 696c  t_dilation = dil
+00004ac0: 6174 696f 6e0a 0a20 2020 2064 6566 205f  ation..    def _
+00004ad0: 6765 745f 7570 6461 7465 645f 6879 7065  get_updated_hype
+00004ae0: 7270 6172 616d 6574 6572 7328 7365 6c66  rparameters(self
+00004af0: 2c20 6c61 7965 725f 6964 782c 2073 7472  , layer_idx, str
+00004b00: 6964 652c 206c 6179 6572 5f64 726f 706f  ide, layer_dropo
+00004b10: 7574 293a 0a20 2020 2020 2020 2072 2222  ut):.        r""
+00004b20: 220a 2020 2020 2020 2020 4765 7420 7468  ".        Get th
+00004b30: 6520 6e65 7720 6879 7065 722d 7061 7261  e new hyper-para
+00004b40: 6d65 7465 7273 2077 6974 6820 7265 7370  meters with resp
+00004b50: 6563 7420 746f 2074 6865 2070 7265 7669  ect to the previ
+00004b60: 6f75 7320 6f6e 6573 2061 6e64 2074 6865  ous ones and the
+00004b70: 2069 6e64 6578 206f 6620 7468 6520 6375   index of the cu
+00004b80: 7272 656e 7420 6c61 7965 722e 0a20 2020  rrent layer..   
+00004b90: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00004ba0: 2069 6620 6c61 7965 725f 6472 6f70 6f75   if layer_dropou
+00004bb0: 743a 0a20 2020 2020 2020 2020 2020 2064  t:.            d
+00004bc0: 726f 705f 7061 7468 5f72 6174 6520 3d20  rop_path_rate = 
+00004bd0: 6c61 7965 725f 6472 6f70 6f75 745b 6c61  layer_dropout[la
+00004be0: 7965 725f 6964 785d 0a20 2020 2020 2020  yer_idx].       
+00004bf0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00004c00: 2020 2064 726f 705f 7061 7468 5f72 6174     drop_path_rat
+00004c10: 6520 3d20 302e 300a 0a20 2020 2020 2020  e = 0.0..       
+00004c20: 2069 6620 6c61 7965 725f 6964 7820 213d   if layer_idx !=
+00004c30: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+00004c40: 7374 7269 6465 203d 2031 0a0a 2020 2020  stride = 1..    
+00004c50: 2020 2020 6973 5f66 6972 7374 5f6c 6179      is_first_lay
+00004c60: 6572 203d 206c 6179 6572 5f69 6478 203d  er = layer_idx =
+00004c70: 3d20 300a 0a20 2020 2020 2020 2072 6574  = 0..        ret
+00004c80: 7572 6e20 7374 7269 6465 2c20 6472 6f70  urn stride, drop
+00004c90: 5f70 6174 685f 7261 7465 2c20 6973 5f66  _path_rate, is_f
+00004ca0: 6972 7374 5f6c 6179 6572 0a0a 2020 2020  irst_layer..    
+00004cb0: 6465 6620 636f 6e73 7472 7563 7428 7365  def construct(se
+00004cc0: 6c66 2c20 696e 7075 743a 206d 696e 6473  lf, input: minds
+00004cd0: 706f 7265 2e54 656e 736f 7229 202d 3e20  pore.Tensor) -> 
+00004ce0: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+00004cf0: 3a0a 2020 2020 2020 2020 6869 6464 656e  :.        hidden
+00004d00: 5f73 7461 7465 203d 2069 6e70 7574 0a20  _state = input. 
+00004d10: 2020 2020 2020 2066 6f72 205f 2c20 6c61         for _, la
+00004d20: 7965 7220 696e 2065 6e75 6d65 7261 7465  yer in enumerate
+00004d30: 2873 656c 662e 6c61 7965 7273 293a 0a20  (self.layers):. 
+00004d40: 2020 2020 2020 2020 2020 2068 6964 6465             hidde
+00004d50: 6e5f 7374 6174 6520 3d20 6c61 7965 7228  n_state = layer(
+00004d60: 6869 6464 656e 5f73 7461 7465 290a 2020  hidden_state).  
+00004d70: 2020 2020 2020 7265 7475 726e 2068 6964        return hid
+00004d80: 6465 6e5f 7374 6174 650a 0a0a 636c 6173  den_state...clas
+00004d90: 7320 4269 7445 6e63 6f64 6572 286e 6e2e  s BitEncoder(nn.
+00004da0: 4365 6c6c 293a 0a20 2020 2064 6566 205f  Cell):.    def _
+00004db0: 5f69 6e69 745f 5f28 7365 6c66 2c20 636f  _init__(self, co
+00004dc0: 6e66 6967 3a20 4269 7443 6f6e 6669 6729  nfig: BitConfig)
+00004dd0: 3a0a 2020 2020 2020 2020 7375 7065 7228  :.        super(
+00004de0: 292e 5f5f 696e 6974 5f5f 2829 0a20 2020  ).__init__().   
+00004df0: 2020 2020 2073 656c 662e 7374 6167 6573       self.stages
+00004e00: 203d 206e 6e2e 4365 6c6c 4c69 7374 285b   = nn.CellList([
+00004e10: 5d29 0a0a 2020 2020 2020 2020 7072 6576  ])..        prev
+00004e20: 5f63 6873 203d 2063 6f6e 6669 672e 656d  _chs = config.em
+00004e30: 6265 6464 696e 675f 7369 7a65 0a0a 2020  bedding_size..  
+00004e40: 2020 2020 2020 2320 5468 6573 6520 6e65        # These ne
+00004e50: 6564 7320 746f 2073 7461 7920 6861 7264  eds to stay hard
+00004e60: 636f 6465 640a 2020 2020 2020 2020 6375  coded.        cu
+00004e70: 7272 656e 745f 7374 7269 6465 203d 2034  rrent_stride = 4
+00004e80: 0a20 2020 2020 2020 2064 696c 6174 696f  .        dilatio
+00004e90: 6e20 3d20 310a 0a20 2020 2020 2020 206c  n = 1..        l
+00004ea0: 6179 6572 5f64 726f 706f 7574 7320 3d20  ayer_dropouts = 
+00004eb0: 5b0a 2020 2020 2020 2020 2020 2020 782e  [.            x.
+00004ec0: 746f 6c69 7374 2829 0a20 2020 2020 2020  tolist().       
+00004ed0: 2020 2020 2066 6f72 2078 2069 6e20 6d69       for x in mi
+00004ee0: 6e64 7370 6f72 652e 5465 6e73 6f72 286e  ndspore.Tensor(n
+00004ef0: 702e 6c69 6e73 7061 6365 2830 2c20 636f  p.linspace(0, co
+00004f00: 6e66 6967 2e64 726f 705f 7061 7468 5f72  nfig.drop_path_r
+00004f10: 6174 652c 2073 756d 2863 6f6e 6669 672e  ate, sum(config.
+00004f20: 6465 7074 6873 2929 292e 7370 6c69 7428  depths))).split(
+00004f30: 636f 6e66 6967 2e64 6570 7468 7329 0a20  config.depths). 
+00004f40: 2020 2020 2020 205d 0a0a 2020 2020 2020         ]..      
+00004f50: 2020 666f 7220 7374 6167 655f 6964 782c    for stage_idx,
+00004f60: 2028 6375 7272 656e 745f 6465 7074 682c   (current_depth,
+00004f70: 2063 7572 7265 6e74 5f68 6964 6465 6e5f   current_hidden_
+00004f80: 7369 7a65 2c20 6c61 7965 725f 6472 6f70  size, layer_drop
+00004f90: 6f75 7429 2069 6e20 656e 756d 6572 6174  out) in enumerat
+00004fa0: 6528 0a20 2020 2020 2020 2020 2020 207a  e(.            z
+00004fb0: 6970 2863 6f6e 6669 672e 6465 7074 6873  ip(config.depths
+00004fc0: 2c20 636f 6e66 6967 2e68 6964 6465 6e5f  , config.hidden_
+00004fd0: 7369 7a65 732c 206c 6179 6572 5f64 726f  sizes, layer_dro
+00004fe0: 706f 7574 7329 0a20 2020 2020 2020 2029  pouts).        )
+00004ff0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+00005000: 4765 7420 7468 6520 7570 6461 7465 6420  Get the updated 
+00005010: 6879 7065 7220 7061 7261 6d73 0a20 2020  hyper params.   
+00005020: 2020 2020 2020 2020 206f 7574 5f63 6861           out_cha
+00005030: 6e6e 656c 732c 2073 7472 6964 652c 2064  nnels, stride, d
+00005040: 696c 6174 696f 6e20 3d20 7365 6c66 2e5f  ilation = self._
+00005050: 6765 745f 7570 6461 7465 645f 6879 7065  get_updated_hype
+00005060: 7270 6172 616d 6574 6572 7328 0a20 2020  rparameters(.   
+00005070: 2020 2020 2020 2020 2020 2020 2073 7461               sta
+00005080: 6765 5f69 6478 2c20 6375 7272 656e 745f  ge_idx, current_
+00005090: 7374 7269 6465 2c20 6375 7272 656e 745f  stride, current_
+000050a0: 6869 6464 656e 5f73 697a 652c 2064 696c  hidden_size, dil
+000050b0: 6174 696f 6e2c 2063 6f6e 6669 670a 2020  ation, config.  
+000050c0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+000050d0: 2020 2020 2020 2020 2073 7461 6765 203d           stage =
+000050e0: 2042 6974 5374 6167 6528 0a20 2020 2020   BitStage(.     
+000050f0: 2020 2020 2020 2020 2020 2063 6f6e 6669             confi
+00005100: 672c 0a20 2020 2020 2020 2020 2020 2020  g,.             
+00005110: 2020 2070 7265 765f 6368 732c 0a20 2020     prev_chs,.   
+00005120: 2020 2020 2020 2020 2020 2020 206f 7574               out
+00005130: 5f63 6861 6e6e 656c 732c 0a20 2020 2020  _channels,.     
+00005140: 2020 2020 2020 2020 2020 2073 7472 6964             strid
+00005150: 653d 7374 7269 6465 2c0a 2020 2020 2020  e=stride,.      
+00005160: 2020 2020 2020 2020 2020 6469 6c61 7469            dilati
+00005170: 6f6e 3d64 696c 6174 696f 6e2c 0a20 2020  on=dilation,.   
+00005180: 2020 2020 2020 2020 2020 2020 2064 6570               dep
+00005190: 7468 3d63 7572 7265 6e74 5f64 6570 7468  th=current_depth
+000051a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000051b0: 2020 6c61 7965 725f 6472 6f70 6f75 743d    layer_dropout=
+000051c0: 6c61 7965 725f 6472 6f70 6f75 742c 0a20  layer_dropout,. 
+000051d0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+000051e0: 2020 2020 2020 2020 2020 7072 6576 5f63            prev_c
+000051f0: 6873 203d 206f 7574 5f63 6861 6e6e 656c  hs = out_channel
+00005200: 730a 2020 2020 2020 2020 2020 2020 6375  s.            cu
+00005210: 7272 656e 745f 7374 7269 6465 202a 3d20  rrent_stride *= 
+00005220: 7374 7269 6465 0a0a 2020 2020 2020 2020  stride..        
+00005230: 2020 2020 7365 7461 7474 7228 7365 6c66      setattr(self
+00005240: 2e73 7461 6765 732c 2073 7472 2873 7461  .stages, str(sta
+00005250: 6765 5f69 6478 292c 2073 7461 6765 290a  ge_idx), stage).
+00005260: 0a20 2020 2064 6566 205f 6765 745f 7570  .    def _get_up
+00005270: 6461 7465 645f 6879 7065 7270 6172 616d  dated_hyperparam
+00005280: 6574 6572 7328 7365 6c66 2c20 7374 6167  eters(self, stag
+00005290: 655f 6964 782c 2063 7572 7265 6e74 5f73  e_idx, current_s
+000052a0: 7472 6964 652c 2063 7572 7265 6e74 5f68  tride, current_h
+000052b0: 6964 6465 6e5f 7369 7a65 2c20 6469 6c61  idden_size, dila
+000052c0: 7469 6f6e 2c20 636f 6e66 6967 293a 0a20  tion, config):. 
+000052d0: 2020 2020 2020 206f 7574 5f63 6861 6e6e         out_chann
+000052e0: 656c 7320 3d20 6d61 6b65 5f64 6976 2863  els = make_div(c
+000052f0: 7572 7265 6e74 5f68 6964 6465 6e5f 7369  urrent_hidden_si
+00005300: 7a65 202a 2063 6f6e 6669 672e 7769 6474  ze * config.widt
+00005310: 685f 6661 6374 6f72 290a 2020 2020 2020  h_factor).      
+00005320: 2020 7374 7269 6465 203d 2031 2069 6620    stride = 1 if 
+00005330: 7374 6167 655f 6964 7820 3d3d 2030 2065  stage_idx == 0 e
+00005340: 6c73 6520 320a 2020 2020 2020 2020 6966  lse 2.        if
+00005350: 2063 7572 7265 6e74 5f73 7472 6964 6520   current_stride 
+00005360: 3e3d 2063 6f6e 6669 672e 6f75 7470 7574  >= config.output
+00005370: 5f73 7472 6964 653a 0a20 2020 2020 2020  _stride:.       
+00005380: 2020 2020 2064 696c 6174 696f 6e20 2a3d       dilation *=
+00005390: 2073 7472 6964 650a 2020 2020 2020 2020   stride.        
+000053a0: 2020 2020 7374 7269 6465 203d 2031 0a20      stride = 1. 
+000053b0: 2020 2020 2020 2072 6574 7572 6e20 6f75         return ou
+000053c0: 745f 6368 616e 6e65 6c73 2c20 7374 7269  t_channels, stri
+000053d0: 6465 2c20 6469 6c61 7469 6f6e 0a0a 2020  de, dilation..  
+000053e0: 2020 6465 6620 636f 6e73 7472 7563 7428    def construct(
+000053f0: 0a20 2020 2020 2020 2073 656c 662c 2068  .        self, h
+00005400: 6964 6465 6e5f 7374 6174 653a 206d 696e  idden_state: min
+00005410: 6473 706f 7265 2e54 656e 736f 722c 206f  dspore.Tensor, o
+00005420: 7574 7075 745f 6869 6464 656e 5f73 7461  utput_hidden_sta
+00005430: 7465 733a 2062 6f6f 6c20 3d20 4661 6c73  tes: bool = Fals
+00005440: 652c 2072 6574 7572 6e5f 6469 6374 3a20  e, return_dict: 
+00005450: 626f 6f6c 203d 2054 7275 650a 2020 2020  bool = True.    
+00005460: 2920 2d3e 2042 6173 654d 6f64 656c 4f75  ) -> BaseModelOu
+00005470: 7470 7574 5769 7468 4e6f 4174 7465 6e74  tputWithNoAttent
+00005480: 696f 6e3a 0a20 2020 2020 2020 2068 6964  ion:.        hid
+00005490: 6465 6e5f 7374 6174 6573 203d 2028 2920  den_states = () 
+000054a0: 6966 206f 7574 7075 745f 6869 6464 656e  if output_hidden
+000054b0: 5f73 7461 7465 7320 656c 7365 204e 6f6e  _states else Non
+000054c0: 650a 0a20 2020 2020 2020 2066 6f72 2073  e..        for s
+000054d0: 7461 6765 5f6d 6f64 756c 6520 696e 2073  tage_module in s
+000054e0: 656c 662e 7374 6167 6573 3a0a 2020 2020  elf.stages:.    
+000054f0: 2020 2020 2020 2020 6966 206f 7574 7075          if outpu
+00005500: 745f 6869 6464 656e 5f73 7461 7465 733a  t_hidden_states:
+00005510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005520: 2068 6964 6465 6e5f 7374 6174 6573 203d   hidden_states =
+00005530: 2068 6964 6465 6e5f 7374 6174 6573 202b   hidden_states +
+00005540: 2028 6869 6464 656e 5f73 7461 7465 2c29   (hidden_state,)
+00005550: 0a0a 2020 2020 2020 2020 2020 2020 6869  ..            hi
+00005560: 6464 656e 5f73 7461 7465 203d 2073 7461  dden_state = sta
+00005570: 6765 5f6d 6f64 756c 6528 6869 6464 656e  ge_module(hidden
+00005580: 5f73 7461 7465 290a 0a20 2020 2020 2020  _state)..       
+00005590: 2069 6620 6f75 7470 7574 5f68 6964 6465   if output_hidde
+000055a0: 6e5f 7374 6174 6573 3a0a 2020 2020 2020  n_states:.      
+000055b0: 2020 2020 2020 6869 6464 656e 5f73 7461        hidden_sta
+000055c0: 7465 7320 3d20 6869 6464 656e 5f73 7461  tes = hidden_sta
+000055d0: 7465 7320 2b20 2868 6964 6465 6e5f 7374  tes + (hidden_st
+000055e0: 6174 652c 290a 0a20 2020 2020 2020 2069  ate,)..        i
+000055f0: 6620 6e6f 7420 7265 7475 726e 5f64 6963  f not return_dic
+00005600: 743a 0a20 2020 2020 2020 2020 2020 2072  t:.            r
+00005610: 6574 7572 6e20 7475 706c 6528 7620 666f  eturn tuple(v fo
+00005620: 7220 7620 696e 205b 6869 6464 656e 5f73  r v in [hidden_s
+00005630: 7461 7465 2c20 6869 6464 656e 5f73 7461  tate, hidden_sta
+00005640: 7465 735d 2069 6620 7620 6973 206e 6f74  tes] if v is not
+00005650: 204e 6f6e 6529 0a0a 2020 2020 2020 2020   None)..        
+00005660: 7265 7475 726e 2042 6173 654d 6f64 656c  return BaseModel
+00005670: 4f75 7470 7574 5769 7468 4e6f 4174 7465  OutputWithNoAtte
+00005680: 6e74 696f 6e28 0a20 2020 2020 2020 2020  ntion(.         
+00005690: 2020 206c 6173 745f 6869 6464 656e 5f73     last_hidden_s
+000056a0: 7461 7465 3d68 6964 6465 6e5f 7374 6174  tate=hidden_stat
+000056b0: 652c 0a20 2020 2020 2020 2020 2020 2068  e,.            h
+000056c0: 6964 6465 6e5f 7374 6174 6573 3d68 6964  idden_states=hid
+000056d0: 6465 6e5f 7374 6174 6573 2c0a 2020 2020  den_states,.    
+000056e0: 2020 2020 290a 0a0a 636c 6173 7320 4269      )...class Bi
+000056f0: 7450 7265 5472 6169 6e65 644d 6f64 656c  tPreTrainedModel
+00005700: 2850 7265 5472 6169 6e65 644d 6f64 656c  (PreTrainedModel
+00005710: 293a 0a20 2020 2022 2222 0a20 2020 2041  ):.    """.    A
+00005720: 6e20 6162 7374 7261 6374 2063 6c61 7373  n abstract class
+00005730: 2074 6f20 6861 6e64 6c65 2077 6569 6768   to handle weigh
+00005740: 7473 2069 6e69 7469 616c 697a 6174 696f  ts initializatio
+00005750: 6e20 616e 6420 6120 7369 6d70 6c65 2069  n and a simple i
+00005760: 6e74 6572 6661 6365 2066 6f72 2064 6f77  nterface for dow
+00005770: 6e6c 6f61 6469 6e67 2061 6e64 206c 6f61  nloading and loa
+00005780: 6469 6e67 2070 7265 7472 6169 6e65 640a  ding pretrained.
+00005790: 2020 2020 6d6f 6465 6c73 2e0a 2020 2020      models..    
+000057a0: 2222 220a 0a20 2020 2063 6f6e 6669 675f  """..    config_
+000057b0: 636c 6173 7320 3d20 4269 7443 6f6e 6669  class = BitConfi
+000057c0: 670a 2020 2020 6261 7365 5f6d 6f64 656c  g.    base_model
+000057d0: 5f70 7265 6669 7820 3d20 2262 6974 220a  _prefix = "bit".
+000057e0: 2020 2020 6d61 696e 5f69 6e70 7574 5f6e      main_input_n
+000057f0: 616d 6520 3d20 2270 6978 656c 5f76 616c  ame = "pixel_val
+00005800: 7565 7322 0a0a 2020 2020 6465 6620 5f69  ues"..    def _i
+00005810: 6e69 745f 7765 6967 6874 7328 7365 6c66  nit_weights(self
+00005820: 2c20 6365 6c6c 293a 0a20 2020 2020 2020  , cell):.       
+00005830: 2069 6620 6973 696e 7374 616e 6365 2863   if isinstance(c
+00005840: 656c 6c2c 206e 6e2e 436f 6e76 3264 293a  ell, nn.Conv2d):
+00005850: 0a20 2020 2020 2020 2020 2020 2063 656c  .            cel
+00005860: 6c2e 7765 6967 6874 2e73 6574 5f64 6174  l.weight.set_dat
+00005870: 6128 696e 6974 6961 6c69 7a65 7228 4865  a(initializer(He
+00005880: 4e6f 726d 616c 2829 2c20 6365 6c6c 2e77  Normal(), cell.w
+00005890: 6569 6768 742e 7368 6170 652c 2063 656c  eight.shape, cel
+000058a0: 6c2e 7765 6967 6874 2e64 7479 7065 2929  l.weight.dtype))
+000058b0: 0a20 2020 2020 2020 2065 6c69 6620 6973  .        elif is
+000058c0: 696e 7374 616e 6365 2863 656c 6c2c 2028  instance(cell, (
+000058d0: 6e6e 2e42 6174 6368 4e6f 726d 3264 2c20  nn.BatchNorm2d, 
+000058e0: 6e6e 2e47 726f 7570 4e6f 726d 2929 3a0a  nn.GroupNorm)):.
+000058f0: 2020 2020 2020 2020 2020 2020 6365 6c6c              cell
+00005900: 2e77 6569 6768 742e 7365 745f 6461 7461  .weight.set_data
+00005910: 2869 6e69 7469 616c 697a 6572 2827 6f6e  (initializer('on
+00005920: 6573 272c 2063 656c 6c2e 7765 6967 6874  es', cell.weight
+00005930: 2e73 6861 7065 2c20 6365 6c6c 2e77 6569  .shape, cell.wei
+00005940: 6768 742e 6474 7970 6529 290a 2020 2020  ght.dtype)).    
+00005950: 2020 2020 2020 2020 6365 6c6c 2e62 6961          cell.bia
+00005960: 732e 7365 745f 6461 7461 2869 6e69 7469  s.set_data(initi
+00005970: 616c 697a 6572 2827 7a65 726f 7327 2c20  alizer('zeros', 
+00005980: 6365 6c6c 2e62 6961 732e 7368 6170 652c  cell.bias.shape,
+00005990: 2063 656c 6c2e 6269 6173 2e64 7479 7065   cell.bias.dtype
+000059a0: 2929 0a0a 0a0a 636c 6173 7320 4269 744d  ))....class BitM
+000059b0: 6f64 656c 2842 6974 5072 6554 7261 696e  odel(BitPreTrain
+000059c0: 6564 4d6f 6465 6c29 3a0a 2020 2020 6465  edModel):.    de
+000059d0: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
+000059e0: 2063 6f6e 6669 6729 3a0a 2020 2020 2020   config):.      
+000059f0: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
+00005a00: 5f5f 2863 6f6e 6669 6729 0a20 2020 2020  __(config).     
+00005a10: 2020 2073 656c 662e 636f 6e66 6967 203d     self.config =
+00005a20: 2063 6f6e 6669 670a 0a20 2020 2020 2020   config..       
+00005a30: 2073 656c 662e 656d 6265 6464 6572 203d   self.embedder =
+00005a40: 2042 6974 456d 6265 6464 696e 6773 2863   BitEmbeddings(c
+00005a50: 6f6e 6669 6729 0a0a 2020 2020 2020 2020  onfig)..        
+00005a60: 7365 6c66 2e65 6e63 6f64 6572 203d 2042  self.encoder = B
+00005a70: 6974 456e 636f 6465 7228 636f 6e66 6967  itEncoder(config
+00005a80: 290a 2020 2020 2020 2020 7365 6c66 2e6e  ).        self.n
+00005a90: 6f72 6d20 3d20 280a 2020 2020 2020 2020  orm = (.        
+00005aa0: 2020 2020 4269 7447 726f 7570 4e6f 726d      BitGroupNorm
+00005ab0: 4163 7469 7661 7469 6f6e 2863 6f6e 6669  Activation(confi
+00005ac0: 672c 206e 756d 5f63 6861 6e6e 656c 733d  g, num_channels=
+00005ad0: 636f 6e66 6967 2e68 6964 6465 6e5f 7369  config.hidden_si
+00005ae0: 7a65 735b 2d31 5d29 0a20 2020 2020 2020  zes[-1]).       
+00005af0: 2020 2020 2069 6620 636f 6e66 6967 2e6c       if config.l
+00005b00: 6179 6572 5f74 7970 6520 3d3d 2022 7072  ayer_type == "pr
+00005b10: 6561 6374 6976 6174 696f 6e22 0a20 2020  eactivation".   
+00005b20: 2020 2020 2020 2020 2065 6c73 6520 6e6e           else nn
+00005b30: 2e49 6465 6e74 6974 7928 290a 2020 2020  .Identity().    
+00005b40: 2020 2020 290a 0a20 2020 2020 2020 2073      )..        s
+00005b50: 656c 662e 706f 6f6c 6572 203d 206e 6e2e  elf.pooler = nn.
+00005b60: 4164 6170 7469 7665 4176 6750 6f6f 6c32  AdaptiveAvgPool2
+00005b70: 6428 2831 2c20 3129 290a 2020 2020 2020  d((1, 1)).      
+00005b80: 2020 2320 496e 6974 6961 6c69 7a65 2077    # Initialize w
+00005b90: 6569 6768 7473 2061 6e64 2061 7070 6c79  eights and apply
+00005ba0: 2066 696e 616c 2070 726f 6365 7373 696e   final processin
+00005bb0: 670a 2020 2020 2020 2020 7365 6c66 2e70  g.        self.p
+00005bc0: 6f73 745f 696e 6974 2829 0a0a 2020 2020  ost_init()..    
+00005bd0: 6465 6620 636f 6e73 7472 7563 7428 0a20  def construct(. 
+00005be0: 2020 2020 2020 2073 656c 662c 2070 6978         self, pix
+00005bf0: 656c 5f76 616c 7565 733a 206d 696e 6473  el_values: minds
+00005c00: 706f 7265 2e54 656e 736f 722c 206f 7574  pore.Tensor, out
+00005c10: 7075 745f 6869 6464 656e 5f73 7461 7465  put_hidden_state
+00005c20: 733a 204f 7074 696f 6e61 6c5b 626f 6f6c  s: Optional[bool
+00005c30: 5d20 3d20 4e6f 6e65 2c20 7265 7475 726e  ] = None, return
+00005c40: 5f64 6963 743a 204f 7074 696f 6e61 6c5b  _dict: Optional[
+00005c50: 626f 6f6c 5d20 3d20 4e6f 6e65 0a20 2020  bool] = None.   
+00005c60: 2029 202d 3e20 4261 7365 4d6f 6465 6c4f   ) -> BaseModelO
+00005c70: 7574 7075 7457 6974 6850 6f6f 6c69 6e67  utputWithPooling
+00005c80: 416e 644e 6f41 7474 656e 7469 6f6e 3a0a  AndNoAttention:.
+00005c90: 2020 2020 2020 2020 6f75 7470 7574 5f68          output_h
+00005ca0: 6964 6465 6e5f 7374 6174 6573 203d 2028  idden_states = (
+00005cb0: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
+00005cc0: 7075 745f 6869 6464 656e 5f73 7461 7465  put_hidden_state
+00005cd0: 7320 6966 206f 7574 7075 745f 6869 6464  s if output_hidd
+00005ce0: 656e 5f73 7461 7465 7320 6973 206e 6f74  en_states is not
+00005cf0: 204e 6f6e 6520 656c 7365 2073 656c 662e   None else self.
+00005d00: 636f 6e66 6967 2e6f 7574 7075 745f 6869  config.output_hi
+00005d10: 6464 656e 5f73 7461 7465 730a 2020 2020  dden_states.    
+00005d20: 2020 2020 290a 2020 2020 2020 2020 7265      ).        re
+00005d30: 7475 726e 5f64 6963 7420 3d20 7265 7475  turn_dict = retu
+00005d40: 726e 5f64 6963 7420 6966 2072 6574 7572  rn_dict if retur
+00005d50: 6e5f 6469 6374 2069 7320 6e6f 7420 4e6f  n_dict is not No
+00005d60: 6e65 2065 6c73 6520 7365 6c66 2e63 6f6e  ne else self.con
+00005d70: 6669 672e 7573 655f 7265 7475 726e 5f64  fig.use_return_d
+00005d80: 6963 740a 0a20 2020 2020 2020 2065 6d62  ict..        emb
+00005d90: 6564 6469 6e67 5f6f 7574 7075 7420 3d20  edding_output = 
+00005da0: 7365 6c66 2e65 6d62 6564 6465 7228 7069  self.embedder(pi
+00005db0: 7865 6c5f 7661 6c75 6573 290a 0a20 2020  xel_values)..   
+00005dc0: 2020 2020 2065 6e63 6f64 6572 5f6f 7574       encoder_out
+00005dd0: 7075 7473 203d 2073 656c 662e 656e 636f  puts = self.enco
+00005de0: 6465 7228 0a20 2020 2020 2020 2020 2020  der(.           
+00005df0: 2065 6d62 6564 6469 6e67 5f6f 7574 7075   embedding_outpu
+00005e00: 742c 206f 7574 7075 745f 6869 6464 656e  t, output_hidden
+00005e10: 5f73 7461 7465 733d 6f75 7470 7574 5f68  _states=output_h
+00005e20: 6964 6465 6e5f 7374 6174 6573 2c20 7265  idden_states, re
+00005e30: 7475 726e 5f64 6963 743d 7265 7475 726e  turn_dict=return
+00005e40: 5f64 6963 740a 2020 2020 2020 2020 290a  _dict.        ).
+00005e50: 0a20 2020 2020 2020 206c 6173 745f 6869  .        last_hi
+00005e60: 6464 656e 5f73 7461 7465 203d 2065 6e63  dden_state = enc
+00005e70: 6f64 6572 5f6f 7574 7075 7473 5b30 5d0a  oder_outputs[0].
+00005e80: 0a20 2020 2020 2020 206c 6173 745f 6869  .        last_hi
+00005e90: 6464 656e 5f73 7461 7465 203d 2073 656c  dden_state = sel
+00005ea0: 662e 6e6f 726d 286c 6173 745f 6869 6464  f.norm(last_hidd
+00005eb0: 656e 5f73 7461 7465 290a 0a20 2020 2020  en_state)..     
+00005ec0: 2020 2070 6f6f 6c65 645f 6f75 7470 7574     pooled_output
+00005ed0: 203d 2073 656c 662e 706f 6f6c 6572 286c   = self.pooler(l
+00005ee0: 6173 745f 6869 6464 656e 5f73 7461 7465  ast_hidden_state
+00005ef0: 290a 0a20 2020 2020 2020 2069 6620 6e6f  )..        if no
+00005f00: 7420 7265 7475 726e 5f64 6963 743a 0a20  t return_dict:. 
+00005f10: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00005f20: 6e20 286c 6173 745f 6869 6464 656e 5f73  n (last_hidden_s
+00005f30: 7461 7465 2c20 706f 6f6c 6564 5f6f 7574  tate, pooled_out
+00005f40: 7075 7429 202b 2065 6e63 6f64 6572 5f6f  put) + encoder_o
+00005f50: 7574 7075 7473 5b31 3a5d 0a0a 2020 2020  utputs[1:]..    
+00005f60: 2020 2020 7265 7475 726e 2042 6173 654d      return BaseM
+00005f70: 6f64 656c 4f75 7470 7574 5769 7468 506f  odelOutputWithPo
+00005f80: 6f6c 696e 6741 6e64 4e6f 4174 7465 6e74  olingAndNoAttent
+00005f90: 696f 6e28 0a20 2020 2020 2020 2020 2020  ion(.           
+00005fa0: 206c 6173 745f 6869 6464 656e 5f73 7461   last_hidden_sta
+00005fb0: 7465 3d6c 6173 745f 6869 6464 656e 5f73  te=last_hidden_s
+00005fc0: 7461 7465 2c0a 2020 2020 2020 2020 2020  tate,.          
+00005fd0: 2020 706f 6f6c 6572 5f6f 7574 7075 743d    pooler_output=
+00005fe0: 706f 6f6c 6564 5f6f 7574 7075 742c 0a20  pooled_output,. 
+00005ff0: 2020 2020 2020 2020 2020 2068 6964 6465             hidde
+00006000: 6e5f 7374 6174 6573 3d65 6e63 6f64 6572  n_states=encoder
+00006010: 5f6f 7574 7075 7473 2e68 6964 6465 6e5f  _outputs.hidden_
+00006020: 7374 6174 6573 2c0a 2020 2020 2020 2020  states,.        
+00006030: 290a 0a0a 636c 6173 7320 4269 7446 6f72  )...class BitFor
+00006040: 496d 6167 6543 6c61 7373 6966 6963 6174  ImageClassificat
+00006050: 696f 6e28 4269 7450 7265 5472 6169 6e65  ion(BitPreTraine
+00006060: 644d 6f64 656c 293a 0a20 2020 2064 6566  dModel):.    def
+00006070: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
+00006080: 636f 6e66 6967 293a 0a20 2020 2020 2020  config):.       
+00006090: 2073 7570 6572 2829 2e5f 5f69 6e69 745f   super().__init_
+000060a0: 5f28 636f 6e66 6967 290a 2020 2020 2020  _(config).      
+000060b0: 2020 7365 6c66 2e6e 756d 5f6c 6162 656c    self.num_label
+000060c0: 7320 3d20 636f 6e66 6967 2e6e 756d 5f6c  s = config.num_l
+000060d0: 6162 656c 730a 2020 2020 2020 2020 7365  abels.        se
+000060e0: 6c66 2e62 6974 203d 2042 6974 4d6f 6465  lf.bit = BitMode
+000060f0: 6c28 636f 6e66 6967 290a 2020 2020 2020  l(config).      
+00006100: 2020 2320 636c 6173 7369 6669 6361 7469    # classificati
+00006110: 6f6e 2068 6561 640a 2020 2020 2020 2020  on head.        
+00006120: 7365 6c66 2e63 6c61 7373 6966 6965 7220  self.classifier 
+00006130: 3d20 6e6e 2e53 6571 7565 6e74 6961 6c43  = nn.SequentialC
+00006140: 656c 6c28 0a20 2020 2020 2020 2020 2020  ell(.           
+00006150: 206e 6e2e 466c 6174 7465 6e28 292c 0a20   nn.Flatten(),. 
+00006160: 2020 2020 2020 2020 2020 206e 6e2e 4465             nn.De
+00006170: 6e73 6528 636f 6e66 6967 2e68 6964 6465  nse(config.hidde
+00006180: 6e5f 7369 7a65 735b 2d31 5d2c 2063 6f6e  n_sizes[-1], con
+00006190: 6669 672e 6e75 6d5f 6c61 6265 6c73 2920  fig.num_labels) 
+000061a0: 6966 2063 6f6e 6669 672e 6e75 6d5f 6c61  if config.num_la
+000061b0: 6265 6c73 203e 2030 2065 6c73 6520 6e6e  bels > 0 else nn
+000061c0: 2e49 6465 6e74 6974 7928 292c 0a20 2020  .Identity(),.   
+000061d0: 2020 2020 2029 0a20 2020 2020 2020 2023       ).        #
+000061e0: 2069 6e69 7469 616c 697a 6520 7765 6967   initialize weig
+000061f0: 6874 7320 616e 6420 6170 706c 7920 6669  hts and apply fi
+00006200: 6e61 6c20 7072 6f63 6573 7369 6e67 0a20  nal processing. 
+00006210: 2020 2020 2020 2073 656c 662e 706f 7374         self.post
+00006220: 5f69 6e69 7428 290a 0a20 2020 2064 6566  _init()..    def
+00006230: 2063 6f6e 7374 7275 6374 280a 2020 2020   construct(.    
+00006240: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+00006250: 2020 7069 7865 6c5f 7661 6c75 6573 3a20    pixel_values: 
+00006260: 4f70 7469 6f6e 616c 5b6d 696e 6473 706f  Optional[mindspo
+00006270: 7265 2e54 656e 736f 725d 203d 204e 6f6e  re.Tensor] = Non
+00006280: 652c 0a20 2020 2020 2020 206c 6162 656c  e,.        label
+00006290: 733a 204f 7074 696f 6e61 6c5b 6d69 6e64  s: Optional[mind
+000062a0: 7370 6f72 652e 5465 6e73 6f72 5d20 3d20  spore.Tensor] = 
+000062b0: 4e6f 6e65 2c0a 2020 2020 2020 2020 6f75  None,.        ou
+000062c0: 7470 7574 5f68 6964 6465 6e5f 7374 6174  tput_hidden_stat
+000062d0: 6573 3a20 4f70 7469 6f6e 616c 5b62 6f6f  es: Optional[boo
+000062e0: 6c5d 203d 204e 6f6e 652c 0a20 2020 2020  l] = None,.     
+000062f0: 2020 2072 6574 7572 6e5f 6469 6374 3a20     return_dict: 
+00006300: 4f70 7469 6f6e 616c 5b62 6f6f 6c5d 203d  Optional[bool] =
+00006310: 204e 6f6e 652c 0a20 2020 2029 202d 3e20   None,.    ) -> 
+00006320: 496d 6167 6543 6c61 7373 6966 6965 724f  ImageClassifierO
+00006330: 7574 7075 7457 6974 684e 6f41 7474 656e  utputWithNoAtten
+00006340: 7469 6f6e 3a0a 2020 2020 2020 2020 7222  tion:.        r"
+00006350: 2222 0a20 2020 2020 2020 206c 6162 656c  "".        label
+00006360: 7320 2860 6d69 6e64 7370 6f72 652e 5465  s (`mindspore.Te
+00006370: 6e73 6f72 6020 6f66 2073 6861 7065 2060  nsor` of shape `
+00006380: 2862 6174 6368 5f73 697a 652c 2960 2c20  (batch_size,)`, 
+00006390: 2a6f 7074 696f 6e61 6c2a 293a 0a20 2020  *optional*):.   
+000063a0: 2020 2020 2020 2020 204c 6162 656c 7320           Labels 
+000063b0: 666f 7220 636f 6d70 7574 696e 6720 7468  for computing th
+000063c0: 6520 696d 6167 6520 636c 6173 7369 6669  e image classifi
+000063d0: 6361 7469 6f6e 2f72 6567 7265 7373 696f  cation/regressio
+000063e0: 6e20 6c6f 7373 2e20 496e 6469 6365 7320  n loss. Indices 
+000063f0: 7368 6f75 6c64 2062 6520 696e 2060 5b30  should be in `[0
+00006400: 2c20 2e2e 2e2c 0a20 2020 2020 2020 2020  , ...,.         
+00006410: 2020 2063 6f6e 6669 672e 6e75 6d5f 6c61     config.num_la
+00006420: 6265 6c73 202d 2031 5d60 2e20 4966 2060  bels - 1]`. If `
+00006430: 636f 6e66 6967 2e6e 756d 5f6c 6162 656c  config.num_label
+00006440: 7320 3e20 3160 2061 2063 6c61 7373 6966  s > 1` a classif
+00006450: 6963 6174 696f 6e20 6c6f 7373 2069 7320  ication loss is 
+00006460: 636f 6d70 7574 6564 2028 4372 6f73 732d  computed (Cross-
+00006470: 456e 7472 6f70 7929 2e0a 2020 2020 2020  Entropy)..      
+00006480: 2020 2222 220a 2020 2020 2020 2020 7265    """.        re
+00006490: 7475 726e 5f64 6963 7420 3d20 7265 7475  turn_dict = retu
+000064a0: 726e 5f64 6963 7420 6966 2072 6574 7572  rn_dict if retur
+000064b0: 6e5f 6469 6374 2069 7320 6e6f 7420 4e6f  n_dict is not No
+000064c0: 6e65 2065 6c73 6520 7365 6c66 2e63 6f6e  ne else self.con
+000064d0: 6669 672e 7573 655f 7265 7475 726e 5f64  fig.use_return_d
+000064e0: 6963 740a 0a20 2020 2020 2020 206f 7574  ict..        out
+000064f0: 7075 7473 203d 2073 656c 662e 6269 7428  puts = self.bit(
+00006500: 7069 7865 6c5f 7661 6c75 6573 2c20 6f75  pixel_values, ou
+00006510: 7470 7574 5f68 6964 6465 6e5f 7374 6174  tput_hidden_stat
+00006520: 6573 3d6f 7574 7075 745f 6869 6464 656e  es=output_hidden
+00006530: 5f73 7461 7465 732c 2072 6574 7572 6e5f  _states, return_
+00006540: 6469 6374 3d72 6574 7572 6e5f 6469 6374  dict=return_dict
+00006550: 290a 0a20 2020 2020 2020 2070 6f6f 6c65  )..        poole
+00006560: 645f 6f75 7470 7574 203d 206f 7574 7075  d_output = outpu
+00006570: 7473 2e70 6f6f 6c65 725f 6f75 7470 7574  ts.pooler_output
+00006580: 2069 6620 7265 7475 726e 5f64 6963 7420   if return_dict 
+00006590: 656c 7365 206f 7574 7075 7473 5b31 5d0a  else outputs[1].
+000065a0: 0a20 2020 2020 2020 206c 6f67 6974 7320  .        logits 
+000065b0: 3d20 7365 6c66 2e63 6c61 7373 6966 6965  = self.classifie
+000065c0: 7228 706f 6f6c 6564 5f6f 7574 7075 7429  r(pooled_output)
+000065d0: 0a0a 2020 2020 2020 2020 6c6f 7373 203d  ..        loss =
+000065e0: 204e 6f6e 650a 0a20 2020 2020 2020 2069   None..        i
+000065f0: 6620 6c61 6265 6c73 2069 7320 6e6f 7420  f labels is not 
+00006600: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00006610: 2020 6966 2073 656c 662e 636f 6e66 6967    if self.config
+00006620: 2e70 726f 626c 656d 5f74 7970 6520 6973  .problem_type is
+00006630: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00006640: 2020 2020 2020 2069 6620 7365 6c66 2e6e         if self.n
+00006650: 756d 5f6c 6162 656c 7320 3d3d 2031 3a0a  um_labels == 1:.
+00006660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006670: 2020 2020 7365 6c66 2e63 6f6e 6669 672e      self.config.
+00006680: 7072 6f62 6c65 6d5f 7479 7065 203d 2022  problem_type = "
+00006690: 7265 6772 6573 7369 6f6e 220a 2020 2020  regression".    
+000066a0: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+000066b0: 2073 656c 662e 6e75 6d5f 6c61 6265 6c73   self.num_labels
+000066c0: 203e 2031 2061 6e64 206c 6162 656c 732e   > 1 and labels.
+000066d0: 6474 7970 6520 696e 2028 6d69 6e64 7370  dtype in (mindsp
+000066e0: 6f72 652e 696e 7436 342c 206d 696e 6473  ore.int64, minds
+000066f0: 706f 7265 2e69 6e74 3332 293a 0a20 2020  pore.int32):.   
+00006700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006710: 2073 656c 662e 636f 6e66 6967 2e70 726f   self.config.pro
+00006720: 626c 656d 5f74 7970 6520 3d20 2273 696e  blem_type = "sin
+00006730: 676c 655f 6c61 6265 6c5f 636c 6173 7369  gle_label_classi
+00006740: 6669 6361 7469 6f6e 220a 2020 2020 2020  fication".      
+00006750: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00006760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006770: 2020 2020 7365 6c66 2e63 6f6e 6669 672e      self.config.
+00006780: 7072 6f62 6c65 6d5f 7479 7065 203d 2022  problem_type = "
+00006790: 6d75 6c74 695f 6c61 6265 6c5f 636c 6173  multi_label_clas
+000067a0: 7369 6669 6361 7469 6f6e 220a 2020 2020  sification".    
+000067b0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+000067c0: 636f 6e66 6967 2e70 726f 626c 656d 5f74  config.problem_t
+000067d0: 7970 6520 3d3d 2022 7265 6772 6573 7369  ype == "regressi
+000067e0: 6f6e 223a 0a20 2020 2020 2020 2020 2020  on":.           
+000067f0: 2020 2020 2069 6620 7365 6c66 2e6e 756d       if self.num
+00006800: 5f6c 6162 656c 7320 3d3d 2031 3a0a 2020  _labels == 1:.  
+00006810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006820: 2020 6c6f 7373 203d 206f 7073 2e6d 7365    loss = ops.mse
+00006830: 5f6c 6f73 7328 6c6f 6769 7473 2e73 7175  _loss(logits.squ
+00006840: 6565 7a65 2829 2c20 6c61 6265 6c73 2e73  eeze(), labels.s
+00006850: 7175 6565 7a65 2829 290a 2020 2020 2020  queeze()).      
+00006860: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00006870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006880: 2020 2020 6c6f 7373 203d 206f 7073 2e6d      loss = ops.m
+00006890: 7365 5f6c 6f73 7328 6c6f 6769 7473 2c20  se_loss(logits, 
+000068a0: 6c61 6265 6c73 290a 2020 2020 2020 2020  labels).        
+000068b0: 2020 2020 656c 6966 2073 656c 662e 636f      elif self.co
+000068c0: 6e66 6967 2e70 726f 626c 656d 5f74 7970  nfig.problem_typ
+000068d0: 6520 3d3d 2022 7369 6e67 6c65 5f6c 6162  e == "single_lab
+000068e0: 656c 5f63 6c61 7373 6966 6963 6174 696f  el_classificatio
+000068f0: 6e22 3a0a 2020 2020 2020 2020 2020 2020  n":.            
+00006900: 2020 2020 6c6f 7373 203d 206f 7073 2e63      loss = ops.c
+00006910: 726f 7373 5f65 6e74 726f 7079 286c 6f67  ross_entropy(log
+00006920: 6974 732e 7669 6577 282d 312c 2073 656c  its.view(-1, sel
+00006930: 662e 6e75 6d5f 6c61 6265 6c73 292c 206c  f.num_labels), l
+00006940: 6162 656c 732e 7669 6577 282d 3129 290a  abels.view(-1)).
+00006950: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+00006960: 2073 656c 662e 636f 6e66 6967 2e70 726f   self.config.pro
+00006970: 626c 656d 5f74 7970 6520 3d3d 2022 6d75  blem_type == "mu
+00006980: 6c74 695f 6c61 6265 6c5f 636c 6173 7369  lti_label_classi
+00006990: 6669 6361 7469 6f6e 223a 0a20 2020 2020  fication":.     
+000069a0: 2020 2020 2020 2020 2020 206c 6f73 7320             loss 
+000069b0: 3d20 6f70 732e 6269 6e61 7279 5f63 726f  = ops.binary_cro
+000069c0: 7373 5f65 6e74 726f 7079 5f77 6974 685f  ss_entropy_with_
+000069d0: 6c6f 6769 7473 286c 6f67 6974 732c 206c  logits(logits, l
+000069e0: 6162 656c 7329 0a0a 2020 2020 2020 2020  abels)..        
+000069f0: 6966 206e 6f74 2072 6574 7572 6e5f 6469  if not return_di
+00006a00: 6374 3a0a 2020 2020 2020 2020 2020 2020  ct:.            
+00006a10: 6f75 7470 7574 203d 2028 6c6f 6769 7473  output = (logits
+00006a20: 2c29 202b 206f 7574 7075 7473 5b32 3a5d  ,) + outputs[2:]
+00006a30: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00006a40: 7572 6e20 286c 6f73 732c 2920 2b20 6f75  urn (loss,) + ou
+00006a50: 7470 7574 2069 6620 6c6f 7373 2069 7320  tput if loss is 
+00006a60: 6e6f 7420 4e6f 6e65 2065 6c73 6520 6f75  not None else ou
+00006a70: 7470 7574 0a0a 2020 2020 2020 2020 7265  tput..        re
+00006a80: 7475 726e 2049 6d61 6765 436c 6173 7369  turn ImageClassi
+00006a90: 6669 6572 4f75 7470 7574 5769 7468 4e6f  fierOutputWithNo
+00006aa0: 4174 7465 6e74 696f 6e28 6c6f 7373 3d6c  Attention(loss=l
+00006ab0: 6f73 732c 206c 6f67 6974 733d 6c6f 6769  oss, logits=logi
+00006ac0: 7473 2c20 6869 6464 656e 5f73 7461 7465  ts, hidden_state
+00006ad0: 733d 6f75 7470 7574 732e 6869 6464 656e  s=outputs.hidden
+00006ae0: 5f73 7461 7465 7329 0a0a 0a63 6c61 7373  _states)...class
+00006af0: 2042 6974 4261 636b 626f 6e65 2842 6974   BitBackbone(Bit
+00006b00: 5072 6554 7261 696e 6564 4d6f 6465 6c2c  PreTrainedModel,
+00006b10: 2042 6163 6b62 6f6e 654d 6978 696e 293a   BackboneMixin):
+00006b20: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+00006b30: 5f28 7365 6c66 2c20 636f 6e66 6967 293a  _(self, config):
+00006b40: 0a20 2020 2020 2020 2073 7570 6572 2829  .        super()
+00006b50: 2e5f 5f69 6e69 745f 5f28 636f 6e66 6967  .__init__(config
+00006b60: 290a 2020 2020 2020 2020 7375 7065 7228  ).        super(
+00006b70: 292e 5f69 6e69 745f 6261 636b 626f 6e65  )._init_backbone
+00006b80: 2863 6f6e 6669 6729 0a0a 2020 2020 2020  (config)..      
+00006b90: 2020 7365 6c66 2e62 6974 203d 2042 6974    self.bit = Bit
+00006ba0: 4d6f 6465 6c28 636f 6e66 6967 290a 2020  Model(config).  
+00006bb0: 2020 2020 2020 7365 6c66 2e6e 756d 5f66        self.num_f
+00006bc0: 6561 7475 7265 7320 3d20 5b63 6f6e 6669  eatures = [confi
+00006bd0: 672e 656d 6265 6464 696e 675f 7369 7a65  g.embedding_size
+00006be0: 5d20 2b20 636f 6e66 6967 2e68 6964 6465  ] + config.hidde
+00006bf0: 6e5f 7369 7a65 730a 0a20 2020 2020 2020  n_sizes..       
+00006c00: 2023 2069 6e69 7469 616c 697a 6520 7765   # initialize we
+00006c10: 6967 6874 7320 616e 6420 6170 706c 7920  ights and apply 
+00006c20: 6669 6e61 6c20 7072 6f63 6573 7369 6e67  final processing
+00006c30: 0a20 2020 2020 2020 2073 656c 662e 706f  .        self.po
+00006c40: 7374 5f69 6e69 7428 290a 0a20 2020 2064  st_init()..    d
+00006c50: 6566 2063 6f6e 7374 7275 6374 280a 2020  ef construct(.  
+00006c60: 2020 2020 2020 7365 6c66 2c20 7069 7865        self, pixe
+00006c70: 6c5f 7661 6c75 6573 3a20 6d69 6e64 7370  l_values: mindsp
+00006c80: 6f72 652e 5465 6e73 6f72 2c20 6f75 7470  ore.Tensor, outp
+00006c90: 7574 5f68 6964 6465 6e5f 7374 6174 6573  ut_hidden_states
+00006ca0: 3a20 4f70 7469 6f6e 616c 5b62 6f6f 6c5d  : Optional[bool]
+00006cb0: 203d 204e 6f6e 652c 2072 6574 7572 6e5f   = None, return_
+00006cc0: 6469 6374 3a20 4f70 7469 6f6e 616c 5b62  dict: Optional[b
+00006cd0: 6f6f 6c5d 203d 204e 6f6e 650a 2020 2020  ool] = None.    
+00006ce0: 2920 2d3e 2042 6163 6b62 6f6e 654f 7574  ) -> BackboneOut
+00006cf0: 7075 743a 0a20 2020 2020 2020 2022 2222  put:.        """
+00006d00: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
+00006d10: 3a0a 0a20 2020 2020 2020 2045 7861 6d70  :..        Examp
+00006d20: 6c65 733a 0a0a 2020 2020 2020 2020 6060  les:..        ``
+00006d30: 6070 7974 686f 6e0a 2020 2020 2020 2020  `python.        
+00006d40: 3e3e 3e20 6672 6f6d 2074 7261 6e73 666f  >>> from transfo
+00006d50: 726d 6572 7320 696d 706f 7274 2041 7574  rmers import Aut
+00006d60: 6f49 6d61 6765 5072 6f63 6573 736f 722c  oImageProcessor,
+00006d70: 2041 7574 6f42 6163 6b62 6f6e 650a 2020   AutoBackbone.  
+00006d80: 2020 2020 2020 3e3e 3e20 696d 706f 7274        >>> import
+00006d90: 2074 6f72 6368 0a20 2020 2020 2020 203e   torch.        >
+00006da0: 3e3e 2066 726f 6d20 5049 4c20 696d 706f  >> from PIL impo
+00006db0: 7274 2049 6d61 6765 0a20 2020 2020 2020  rt Image.       
+00006dc0: 203e 3e3e 2069 6d70 6f72 7420 7265 7175   >>> import requ
+00006dd0: 6573 7473 0a0a 2020 2020 2020 2020 3e3e  ests..        >>
+00006de0: 3e20 7572 6c20 3d20 2268 7474 703a 2f2f  > url = "http://
+00006df0: 696d 6167 6573 2e63 6f63 6f64 6174 6173  images.cocodatas
+00006e00: 6574 2e6f 7267 2f76 616c 3230 3137 2f30  et.org/val2017/0
+00006e10: 3030 3030 3030 3339 3736 392e 6a70 6722  00000039769.jpg"
+00006e20: 0a20 2020 2020 2020 203e 3e3e 2069 6d61  .        >>> ima
+00006e30: 6765 203d 2049 6d61 6765 2e6f 7065 6e28  ge = Image.open(
+00006e40: 7265 7175 6573 7473 2e67 6574 2875 726c  requests.get(url
+00006e50: 2c20 7374 7265 616d 3d54 7275 6529 2e72  , stream=True).r
+00006e60: 6177 290a 0a20 2020 2020 2020 203e 3e3e  aw)..        >>>
+00006e70: 2070 726f 6365 7373 6f72 203d 2041 7574   processor = Aut
+00006e80: 6f49 6d61 6765 5072 6f63 6573 736f 722e  oImageProcessor.
+00006e90: 6672 6f6d 5f70 7265 7472 6169 6e65 6428  from_pretrained(
+00006ea0: 2267 6f6f 676c 652f 7265 736e 6574 6e76  "google/resnetnv
+00006eb0: 322d 3530 2229 0a20 2020 2020 2020 203e  2-50").        >
+00006ec0: 3e3e 206d 6f64 656c 203d 2041 7574 6f42  >> model = AutoB
+00006ed0: 6163 6b62 6f6e 652e 6672 6f6d 5f70 7265  ackbone.from_pre
+00006ee0: 7472 6169 6e65 6428 2267 6f6f 676c 652f  trained("google/
+00006ef0: 7265 736e 6574 6e76 322d 3530 2229 0a0a  resnetnv2-50")..
+00006f00: 2020 2020 2020 2020 3e3e 3e20 696e 7075          >>> inpu
+00006f10: 7473 203d 2070 726f 6365 7373 6f72 2869  ts = processor(i
+00006f20: 6d61 6765 2c20 7265 7475 726e 5f74 656e  mage, return_ten
+00006f30: 736f 7273 3d22 7074 2229 0a20 2020 2020  sors="pt").     
+00006f40: 2020 203e 3e3e 206f 7574 7075 7473 203d     >>> outputs =
+00006f50: 206d 6f64 656c 282a 2a69 6e70 7574 7329   model(**inputs)
+00006f60: 0a20 2020 2020 2020 2060 6060 2222 220a  .        ```""".
+00006f70: 2020 2020 2020 2020 7265 7475 726e 5f64          return_d
+00006f80: 6963 7420 3d20 7265 7475 726e 5f64 6963  ict = return_dic
+00006f90: 7420 6966 2072 6574 7572 6e5f 6469 6374  t if return_dict
+00006fa0: 2069 7320 6e6f 7420 4e6f 6e65 2065 6c73   is not None els
+00006fb0: 6520 7365 6c66 2e63 6f6e 6669 672e 7573  e self.config.us
+00006fc0: 655f 7265 7475 726e 5f64 6963 740a 2020  e_return_dict.  
+00006fd0: 2020 2020 2020 6f75 7470 7574 5f68 6964        output_hid
+00006fe0: 6465 6e5f 7374 6174 6573 203d 2028 0a20  den_states = (. 
+00006ff0: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
+00007000: 745f 6869 6464 656e 5f73 7461 7465 7320  t_hidden_states 
+00007010: 6966 206f 7574 7075 745f 6869 6464 656e  if output_hidden
+00007020: 5f73 7461 7465 7320 6973 206e 6f74 204e  _states is not N
+00007030: 6f6e 6520 656c 7365 2073 656c 662e 636f  one else self.co
+00007040: 6e66 6967 2e6f 7574 7075 745f 6869 6464  nfig.output_hidd
+00007050: 656e 5f73 7461 7465 730a 2020 2020 2020  en_states.      
+00007060: 2020 290a 0a20 2020 2020 2020 206f 7574    )..        out
+00007070: 7075 7473 203d 2073 656c 662e 6269 7428  puts = self.bit(
+00007080: 7069 7865 6c5f 7661 6c75 6573 2c20 6f75  pixel_values, ou
+00007090: 7470 7574 5f68 6964 6465 6e5f 7374 6174  tput_hidden_stat
+000070a0: 6573 3d54 7275 652c 2072 6574 7572 6e5f  es=True, return_
+000070b0: 6469 6374 3d54 7275 6529 0a0a 2020 2020  dict=True)..    
+000070c0: 2020 2020 6869 6464 656e 5f73 7461 7465      hidden_state
+000070d0: 7320 3d20 6f75 7470 7574 732e 6869 6464  s = outputs.hidd
+000070e0: 656e 5f73 7461 7465 730a 0a20 2020 2020  en_states..     
+000070f0: 2020 2066 6561 7475 7265 5f6d 6170 7320     feature_maps 
+00007100: 3d20 2829 0a20 2020 2020 2020 2066 6f72  = ().        for
+00007110: 2069 6478 2c20 7374 6167 6520 696e 2065   idx, stage in e
+00007120: 6e75 6d65 7261 7465 2873 656c 662e 7374  numerate(self.st
+00007130: 6167 655f 6e61 6d65 7329 3a0a 2020 2020  age_names):.    
+00007140: 2020 2020 2020 2020 6966 2073 7461 6765          if stage
+00007150: 2069 6e20 7365 6c66 2e6f 7574 5f66 6561   in self.out_fea
+00007160: 7475 7265 733a 0a20 2020 2020 2020 2020  tures:.         
+00007170: 2020 2020 2020 2066 6561 7475 7265 5f6d         feature_m
+00007180: 6170 7320 2b3d 2028 6869 6464 656e 5f73  aps += (hidden_s
+00007190: 7461 7465 735b 6964 785d 2c29 0a0a 2020  tates[idx],)..  
+000071a0: 2020 2020 2020 6966 206e 6f74 2072 6574        if not ret
+000071b0: 7572 6e5f 6469 6374 3a0a 2020 2020 2020  urn_dict:.      
+000071c0: 2020 2020 2020 6f75 7470 7574 203d 2028        output = (
+000071d0: 6665 6174 7572 655f 6d61 7073 2c29 0a20  feature_maps,). 
+000071e0: 2020 2020 2020 2020 2020 2069 6620 6f75             if ou
+000071f0: 7470 7574 5f68 6964 6465 6e5f 7374 6174  tput_hidden_stat
+00007200: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+00007210: 2020 2020 6f75 7470 7574 202b 3d20 286f      output += (o
+00007220: 7574 7075 7473 2e68 6964 6465 6e5f 7374  utputs.hidden_st
+00007230: 6174 6573 2c29 0a20 2020 2020 2020 2020  ates,).         
+00007240: 2020 2072 6574 7572 6e20 6f75 7470 7574     return output
+00007250: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00007260: 2042 6163 6b62 6f6e 654f 7574 7075 7428   BackboneOutput(
+00007270: 0a20 2020 2020 2020 2020 2020 2066 6561  .            fea
+00007280: 7475 7265 5f6d 6170 733d 6665 6174 7572  ture_maps=featur
+00007290: 655f 6d61 7073 2c0a 2020 2020 2020 2020  e_maps,.        
+000072a0: 2020 2020 6869 6464 656e 5f73 7461 7465      hidden_state
+000072b0: 733d 6f75 7470 7574 732e 6869 6464 656e  s=outputs.hidden
+000072c0: 5f73 7461 7465 7320 6966 206f 7574 7075  _states if outpu
+000072d0: 745f 6869 6464 656e 5f73 7461 7465 7320  t_hidden_states 
+000072e0: 656c 7365 204e 6f6e 652c 0a20 2020 2020  else None,.     
+000072f0: 2020 2020 2020 2061 7474 656e 7469 6f6e         attention
+00007300: 733d 4e6f 6e65 2c0a 2020 2020 2020 2020  s=None,.        
+00007310: 290a 0a5f 5f61 6c6c 5f5f 203d 205b 0a20  )..__all__ = [. 
+00007320: 2020 2022 4269 7446 6f72 496d 6167 6543     "BitForImageC
+00007330: 6c61 7373 6966 6963 6174 696f 6e22 2c0a  lassification",.
+00007340: 2020 2020 2242 6974 4d6f 6465 6c22 2c0a      "BitModel",.
+00007350: 2020 2020 2242 6974 5072 6554 7261 696e      "BitPreTrain
+00007360: 6564 4d6f 6465 6c22 2c0a 2020 2020 2242  edModel",.    "B
+00007370: 6974 4261 636b 626f 6e65 222c 0a5d 0a    itBackbone",.].
```

## mindnlp/transformers/models/blenderbot/__init__.py

```diff
@@ -0,0 +1,74 @@
+00000000: 2320 436f 7079 7269 6768 7420 3230 3234  # Copyright 2024
+00000010: 2048 7561 7765 6920 5465 6368 6e6f 6c6f   Huawei Technolo
+00000020: 6769 6573 2043 6f2e 2c20 4c74 640a 230a  gies Co., Ltd.#.
+00000030: 2320 4c69 6365 6e73 6564 2075 6e64 6572  # Licensed under
+00000040: 2074 6865 2041 7061 6368 6520 4c69 6365   the Apache Lice
+00000050: 6e73 652c 2056 6572 7369 6f6e 2032 2e30  nse, Version 2.0
+00000060: 2028 7468 6520 224c 6963 656e 7365 2229   (the "License")
+00000070: 3b0a 2320 796f 7520 6d61 7920 6e6f 7420  ;.# you may not 
+00000080: 7573 6520 7468 6973 2066 696c 6520 6578  use this file ex
+00000090: 6365 7074 2069 6e20 636f 6d70 6c69 616e  cept in complian
+000000a0: 6365 2077 6974 6820 7468 6520 4c69 6365  ce with the Lice
+000000b0: 6e73 652e 0a23 2059 6f75 206d 6179 206f  nse..# You may o
+000000c0: 6274 6169 6e20 6120 636f 7079 206f 6620  btain a copy of 
+000000d0: 7468 6520 4c69 6365 6e73 6520 6174 0a23  the License at.#
+000000e0: 0a23 2068 7474 703a 2f2f 7777 772e 6170  .# http://www.ap
+000000f0: 6163 6865 2e6f 7267 2f6c 6963 656e 7365  ache.org/license
+00000100: 732f 4c49 4345 4e53 452d 322e 300a 230a  s/LICENSE-2.0.#.
+00000110: 2320 556e 6c65 7373 2072 6571 7569 7265  # Unless require
+00000120: 6420 6279 2061 7070 6c69 6361 626c 6520  d by applicable 
+00000130: 6c61 7720 6f72 2061 6772 6565 6420 746f  law or agreed to
+00000140: 2069 6e20 7772 6974 696e 672c 2073 6f66   in writing, sof
+00000150: 7477 6172 650a 2320 6469 7374 7269 6275  tware.# distribu
+00000160: 7465 6420 756e 6465 7220 7468 6520 4c69  ted under the Li
+00000170: 6365 6e73 6520 6973 2064 6973 7472 6962  cense is distrib
+00000180: 7574 6564 206f 6e20 616e 2022 4153 2049  uted on an "AS I
+00000190: 5322 2042 4153 4953 2c0a 2320 5749 5448  S" BASIS,.# WITH
+000001a0: 4f55 5420 5741 5252 414e 5449 4553 204f  OUT WARRANTIES O
+000001b0: 5220 434f 4e44 4954 494f 4e53 204f 4620  R CONDITIONS OF 
+000001c0: 414e 5920 4b49 4e44 2c20 6569 7468 6572  ANY KIND, either
+000001d0: 2065 7870 7265 7373 206f 7220 696d 706c   express or impl
+000001e0: 6965 642e 0a23 2053 6565 2074 6865 204c  ied..# See the L
+000001f0: 6963 656e 7365 2066 6f72 2074 6865 2073  icense for the s
+00000200: 7065 6369 6669 6320 6c61 6e67 7561 6765  pecific language
+00000210: 2067 6f76 6572 6e69 6e67 2070 6572 6d69   governing permi
+00000220: 7373 696f 6e73 2061 6e64 0a23 206c 696d  ssions and.# lim
+00000230: 6974 6174 696f 6e73 2075 6e64 6572 2074  itations under t
+00000240: 6865 204c 6963 656e 7365 2e0a 2320 3d3d  he License..# ==
+00000250: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00000260: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00000270: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00000280: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00000290: 3d3d 3d3d 3d3d 3d3d 3d3d 0a22 2222 0a42  ==========.""".B
+000002a0: 6c65 6e64 6572 626f 7420 4d6f 6465 6c2e  lenderbot Model.
+000002b0: 0a22 2222 0a66 726f 6d20 2e20 696d 706f  .""".from . impo
+000002c0: 7274 2063 6f6e 6669 6775 7261 7469 6f6e  rt configuration
+000002d0: 5f62 6c65 6e64 6572 626f 742c 206d 6f64  _blenderbot, mod
+000002e0: 656c 696e 675f 626c 656e 6465 7262 6f74  eling_blenderbot
+000002f0: 2c20 746f 6b65 6e69 7a61 7469 6f6e 5f62  , tokenization_b
+00000300: 6c65 6e64 6572 626f 742c 2074 6f6b 656e  lenderbot, token
+00000310: 697a 6174 696f 6e5f 626c 656e 6465 7262  ization_blenderb
+00000320: 6f74 5f66 6173 740a 6672 6f6d 202e 636f  ot_fast.from .co
+00000330: 6e66 6967 7572 6174 696f 6e5f 626c 656e  nfiguration_blen
+00000340: 6465 7262 6f74 2069 6d70 6f72 7420 2a0a  derbot import *.
+00000350: 6672 6f6d 202e 6d6f 6465 6c69 6e67 5f62  from .modeling_b
+00000360: 6c65 6e64 6572 626f 7420 696d 706f 7274  lenderbot import
+00000370: 202a 0a66 726f 6d20 2e74 6f6b 656e 697a   *.from .tokeniz
+00000380: 6174 696f 6e5f 626c 656e 6465 7262 6f74  ation_blenderbot
+00000390: 2069 6d70 6f72 7420 2a0a 6672 6f6d 202e   import *.from .
+000003a0: 746f 6b65 6e69 7a61 7469 6f6e 5f62 6c65  tokenization_ble
+000003b0: 6e64 6572 626f 745f 6661 7374 2069 6d70  nderbot_fast imp
+000003c0: 6f72 7420 2a0a 0a5f 5f61 6c6c 5f5f 203d  ort *..__all__ =
+000003d0: 205b 5d0a 5f5f 616c 6c5f 5f2e 6578 7465   [].__all__.exte
+000003e0: 6e64 2863 6f6e 6669 6775 7261 7469 6f6e  nd(configuration
+000003f0: 5f62 6c65 6e64 6572 626f 742e 5f5f 616c  _blenderbot.__al
+00000400: 6c5f 5f29 0a5f 5f61 6c6c 5f5f 2e65 7874  l__).__all__.ext
+00000410: 656e 6428 6d6f 6465 6c69 6e67 5f62 6c65  end(modeling_ble
+00000420: 6e64 6572 626f 742e 5f5f 616c 6c5f 5f29  nderbot.__all__)
+00000430: 0a5f 5f61 6c6c 5f5f 2e65 7874 656e 6428  .__all__.extend(
+00000440: 746f 6b65 6e69 7a61 7469 6f6e 5f62 6c65  tokenization_ble
+00000450: 6e64 6572 626f 742e 5f5f 616c 6c5f 5f29  nderbot.__all__)
+00000460: 0a5f 5f61 6c6c 5f5f 2e65 7874 656e 6428  .__all__.extend(
+00000470: 746f 6b65 6e69 7a61 7469 6f6e 5f62 6c65  tokenization_ble
+00000480: 6e64 6572 626f 745f 6661 7374 2e5f 5f61  nderbot_fast.__a
+00000490: 6c6c 5f5f 290a                           ll__).
```

## mindnlp/transformers/models/blenderbot/configuration_blenderbot.py

```diff
@@ -0,0 +1,473 @@
+00000000: 2320 636f 6469 6e67 3d75 7466 2d38 0a23  # coding=utf-8.#
+00000010: 2043 6f70 7972 6967 6874 2032 3032 3120   Copyright 2021 
+00000020: 5468 6520 4661 6365 626f 6f6b 2c20 496e  The Facebook, In
+00000030: 632e 2061 6e64 2054 6865 2048 7567 6769  c. and The Huggi
+00000040: 6e67 4661 6365 2049 6e63 2e20 7465 616d  ngFace Inc. team
+00000050: 2e20 416c 6c20 7269 6768 7473 2072 6573  . All rights res
+00000060: 6572 7665 642e 0a23 0a23 204c 6963 656e  erved..#.# Licen
+00000070: 7365 6420 756e 6465 7220 7468 6520 4170  sed under the Ap
+00000080: 6163 6865 204c 6963 656e 7365 2c20 5665  ache License, Ve
+00000090: 7273 696f 6e20 322e 3020 2874 6865 2022  rsion 2.0 (the "
+000000a0: 4c69 6365 6e73 6522 293b 0a23 2079 6f75  License");.# you
+000000b0: 206d 6179 206e 6f74 2075 7365 2074 6869   may not use thi
+000000c0: 7320 6669 6c65 2065 7863 6570 7420 696e  s file except in
+000000d0: 2063 6f6d 706c 6961 6e63 6520 7769 7468   compliance with
+000000e0: 2074 6865 204c 6963 656e 7365 2e0a 2320   the License..# 
+000000f0: 596f 7520 6d61 7920 6f62 7461 696e 2061  You may obtain a
+00000100: 2063 6f70 7920 6f66 2074 6865 204c 6963   copy of the Lic
+00000110: 656e 7365 2061 740a 230a 2320 2020 2020  ense at.#.#     
+00000120: 6874 7470 3a2f 2f77 7777 2e61 7061 6368  http://www.apach
+00000130: 652e 6f72 672f 6c69 6365 6e73 6573 2f4c  e.org/licenses/L
+00000140: 4943 454e 5345 2d32 2e30 0a23 0a23 2055  ICENSE-2.0.#.# U
+00000150: 6e6c 6573 7320 7265 7175 6972 6564 2062  nless required b
+00000160: 7920 6170 706c 6963 6162 6c65 206c 6177  y applicable law
+00000170: 206f 7220 6167 7265 6564 2074 6f20 696e   or agreed to in
+00000180: 2077 7269 7469 6e67 2c20 736f 6674 7761   writing, softwa
+00000190: 7265 0a23 2064 6973 7472 6962 7574 6564  re.# distributed
+000001a0: 2075 6e64 6572 2074 6865 204c 6963 656e   under the Licen
+000001b0: 7365 2069 7320 6469 7374 7269 6275 7465  se is distribute
+000001c0: 6420 6f6e 2061 6e20 2241 5320 4953 2220  d on an "AS IS" 
+000001d0: 4241 5349 532c 0a23 2057 4954 484f 5554  BASIS,.# WITHOUT
+000001e0: 2057 4152 5241 4e54 4945 5320 4f52 2043   WARRANTIES OR C
+000001f0: 4f4e 4449 5449 4f4e 5320 4f46 2041 4e59  ONDITIONS OF ANY
+00000200: 204b 494e 442c 2065 6974 6865 7220 6578   KIND, either ex
+00000210: 7072 6573 7320 6f72 2069 6d70 6c69 6564  press or implied
+00000220: 2e0a 2320 5365 6520 7468 6520 4c69 6365  ..# See the Lice
+00000230: 6e73 6520 666f 7220 7468 6520 7370 6563  nse for the spec
+00000240: 6966 6963 206c 616e 6775 6167 6520 676f  ific language go
+00000250: 7665 726e 696e 6720 7065 726d 6973 7369  verning permissi
+00000260: 6f6e 7320 616e 640a 2320 6c69 6d69 7461  ons and.# limita
+00000270: 7469 6f6e 7320 756e 6465 7220 7468 6520  tions under the 
+00000280: 4c69 6365 6e73 652e 0a22 2222 2042 6c65  License..""" Ble
+00000290: 6e64 6572 626f 7420 6d6f 6465 6c20 636f  nderbot model co
+000002a0: 6e66 6967 7572 6174 696f 6e22 2222 0a66  nfiguration""".f
+000002b0: 726f 6d20 2e2e 2e63 6f6e 6669 6775 7261  rom ...configura
+000002c0: 7469 6f6e 5f75 7469 6c73 2069 6d70 6f72  tion_utils impor
+000002d0: 7420 5072 6574 7261 696e 6564 436f 6e66  t PretrainedConf
+000002e0: 6967 0a66 726f 6d20 2e2e 2e2e 7574 696c  ig.from ....util
+000002f0: 7320 696d 706f 7274 206c 6f67 6769 6e67  s import logging
+00000300: 0a0a 0a6c 6f67 6765 7220 3d20 6c6f 6767  ...logger = logg
+00000310: 696e 672e 6765 745f 6c6f 6767 6572 285f  ing.get_logger(_
+00000320: 5f6e 616d 655f 5f29 0a0a 0a63 6c61 7373  _name__)...class
+00000330: 2042 6c65 6e64 6572 626f 7443 6f6e 6669   BlenderbotConfi
+00000340: 6728 5072 6574 7261 696e 6564 436f 6e66  g(PretrainedConf
+00000350: 6967 293a 0a20 2020 2072 2222 220a 2020  ig):.    r""".  
+00000360: 2020 5468 6973 2069 7320 7468 6520 636f    This is the co
+00000370: 6e66 6967 7572 6174 696f 6e20 636c 6173  nfiguration clas
+00000380: 7320 746f 2073 746f 7265 2074 6865 2063  s to store the c
+00000390: 6f6e 6669 6775 7261 7469 6f6e 206f 6620  onfiguration of 
+000003a0: 6120 5b60 426c 656e 6465 7262 6f74 4d6f  a [`BlenderbotMo
+000003b0: 6465 6c60 5d2e 2049 7420 6973 2075 7365  del`]. It is use
+000003c0: 6420 746f 2069 6e73 7461 6e74 6961 7465  d to instantiate
+000003d0: 2061 6e0a 2020 2020 426c 656e 6465 7262   an.    Blenderb
+000003e0: 6f74 206d 6f64 656c 2061 6363 6f72 6469  ot model accordi
+000003f0: 6e67 2074 6f20 7468 6520 7370 6563 6966  ng to the specif
+00000400: 6965 6420 6172 6775 6d65 6e74 732c 2064  ied arguments, d
+00000410: 6566 696e 696e 6720 7468 6520 6d6f 6465  efining the mode
+00000420: 6c20 6172 6368 6974 6563 7475 7265 2e20  l architecture. 
+00000430: 496e 7374 616e 7469 6174 696e 6720 610a  Instantiating a.
+00000440: 2020 2020 636f 6e66 6967 7572 6174 696f      configuratio
+00000450: 6e20 7769 7468 2074 6865 2064 6566 6175  n with the defau
+00000460: 6c74 7320 7769 6c6c 2079 6965 6c64 2061  lts will yield a
+00000470: 2073 696d 696c 6172 2063 6f6e 6669 6775   similar configu
+00000480: 7261 7469 6f6e 2074 6f20 7468 6174 206f  ration to that o
+00000490: 6620 7468 6520 426c 656e 6465 7262 6f74  f the Blenderbot
+000004a0: 0a20 2020 205b 6661 6365 626f 6f6b 2f62  .    [facebook/b
+000004b0: 6c65 6e64 6572 626f 742d 3342 5d28 6874  lenderbot-3B](ht
+000004c0: 7470 733a 2f2f 6875 6767 696e 6766 6163  tps://huggingfac
+000004d0: 652e 636f 2f66 6163 6562 6f6f 6b2f 626c  e.co/facebook/bl
+000004e0: 656e 6465 7262 6f74 2d33 4229 2061 7263  enderbot-3B) arc
+000004f0: 6869 7465 6374 7572 652e 0a0a 2020 2020  hitecture...    
+00000500: 436f 6e66 6967 7572 6174 696f 6e20 6f62  Configuration ob
+00000510: 6a65 6374 7320 696e 6865 7269 7420 6672  jects inherit fr
+00000520: 6f6d 205b 6050 7265 7472 6169 6e65 6443  om [`PretrainedC
+00000530: 6f6e 6669 6760 5d20 616e 6420 6361 6e20  onfig`] and can 
+00000540: 6265 2075 7365 6420 746f 2063 6f6e 7472  be used to contr
+00000550: 6f6c 2074 6865 206d 6f64 656c 206f 7574  ol the model out
+00000560: 7075 7473 2e20 5265 6164 2074 6865 0a20  puts. Read the. 
+00000570: 2020 2064 6f63 756d 656e 7461 7469 6f6e     documentation
+00000580: 2066 726f 6d20 5b60 5072 6574 7261 696e   from [`Pretrain
+00000590: 6564 436f 6e66 6967 605d 2066 6f72 206d  edConfig`] for m
+000005a0: 6f72 6520 696e 666f 726d 6174 696f 6e2e  ore information.
+000005b0: 0a0a 0a20 2020 2041 7267 733a 0a20 2020  ...    Args:.   
+000005c0: 2020 2020 2076 6f63 6162 5f73 697a 6520       vocab_size 
+000005d0: 2860 696e 7460 2c20 2a6f 7074 696f 6e61  (`int`, *optiona
+000005e0: 6c2a 2c20 6465 6661 756c 7473 2074 6f20  l*, defaults to 
+000005f0: 3530 3236 3529 3a0a 2020 2020 2020 2020  50265):.        
+00000600: 2020 2020 566f 6361 6275 6c61 7279 2073      Vocabulary s
+00000610: 697a 6520 6f66 2074 6865 2042 6c65 6e64  ize of the Blend
+00000620: 6572 626f 7420 6d6f 6465 6c2e 2044 6566  erbot model. Def
+00000630: 696e 6573 2074 6865 206e 756d 6265 7220  ines the number 
+00000640: 6f66 2064 6966 6665 7265 6e74 2074 6f6b  of different tok
+00000650: 656e 7320 7468 6174 2063 616e 2062 6520  ens that can be 
+00000660: 7265 7072 6573 656e 7465 6420 6279 0a20  represented by. 
+00000670: 2020 2020 2020 2020 2020 2074 6865 2060             the `
+00000680: 696e 7075 7473 5f69 6473 6020 7061 7373  inputs_ids` pass
+00000690: 6564 2077 6865 6e20 6361 6c6c 696e 6720  ed when calling 
+000006a0: 5b60 426c 656e 6465 7262 6f74 4d6f 6465  [`BlenderbotMode
+000006b0: 6c60 5d20 6f72 205b 6054 4642 6c65 6e64  l`] or [`TFBlend
+000006c0: 6572 626f 744d 6f64 656c 605d 2e0a 2020  erbotModel`]..  
+000006d0: 2020 2020 2020 645f 6d6f 6465 6c20 2860        d_model (`
+000006e0: 696e 7460 2c20 2a6f 7074 696f 6e61 6c2a  int`, *optional*
+000006f0: 2c20 6465 6661 756c 7473 2074 6f20 3130  , defaults to 10
+00000700: 3234 293a 0a20 2020 2020 2020 2020 2020  24):.           
+00000710: 2044 696d 656e 7369 6f6e 616c 6974 7920   Dimensionality 
+00000720: 6f66 2074 6865 206c 6179 6572 7320 616e  of the layers an
+00000730: 6420 7468 6520 706f 6f6c 6572 206c 6179  d the pooler lay
+00000740: 6572 2e0a 2020 2020 2020 2020 656e 636f  er..        enco
+00000750: 6465 725f 6c61 7965 7273 2028 6069 6e74  der_layers (`int
+00000760: 602c 202a 6f70 7469 6f6e 616c 2a2c 2064  `, *optional*, d
+00000770: 6566 6175 6c74 7320 746f 2031 3229 3a0a  efaults to 12):.
+00000780: 2020 2020 2020 2020 2020 2020 4e75 6d62              Numb
+00000790: 6572 206f 6620 656e 636f 6465 7220 6c61  er of encoder la
+000007a0: 7965 7273 2e0a 2020 2020 2020 2020 6465  yers..        de
+000007b0: 636f 6465 725f 6c61 7965 7273 2028 6069  coder_layers (`i
+000007c0: 6e74 602c 202a 6f70 7469 6f6e 616c 2a2c  nt`, *optional*,
+000007d0: 2064 6566 6175 6c74 7320 746f 2031 3229   defaults to 12)
+000007e0: 3a0a 2020 2020 2020 2020 2020 2020 4e75  :.            Nu
+000007f0: 6d62 6572 206f 6620 6465 636f 6465 7220  mber of decoder 
+00000800: 6c61 7965 7273 2e0a 2020 2020 2020 2020  layers..        
+00000810: 656e 636f 6465 725f 6174 7465 6e74 696f  encoder_attentio
+00000820: 6e5f 6865 6164 7320 2860 696e 7460 2c20  n_heads (`int`, 
+00000830: 2a6f 7074 696f 6e61 6c2a 2c20 6465 6661  *optional*, defa
+00000840: 756c 7473 2074 6f20 3136 293a 0a20 2020  ults to 16):.   
+00000850: 2020 2020 2020 2020 204e 756d 6265 7220           Number 
+00000860: 6f66 2061 7474 656e 7469 6f6e 2068 6561  of attention hea
+00000870: 6473 2066 6f72 2065 6163 6820 6174 7465  ds for each atte
+00000880: 6e74 696f 6e20 6c61 7965 7220 696e 2074  ntion layer in t
+00000890: 6865 2054 7261 6e73 666f 726d 6572 2065  he Transformer e
+000008a0: 6e63 6f64 6572 2e0a 2020 2020 2020 2020  ncoder..        
+000008b0: 6465 636f 6465 725f 6174 7465 6e74 696f  decoder_attentio
+000008c0: 6e5f 6865 6164 7320 2860 696e 7460 2c20  n_heads (`int`, 
+000008d0: 2a6f 7074 696f 6e61 6c2a 2c20 6465 6661  *optional*, defa
+000008e0: 756c 7473 2074 6f20 3136 293a 0a20 2020  ults to 16):.   
+000008f0: 2020 2020 2020 2020 204e 756d 6265 7220           Number 
+00000900: 6f66 2061 7474 656e 7469 6f6e 2068 6561  of attention hea
+00000910: 6473 2066 6f72 2065 6163 6820 6174 7465  ds for each atte
+00000920: 6e74 696f 6e20 6c61 7965 7220 696e 2074  ntion layer in t
+00000930: 6865 2054 7261 6e73 666f 726d 6572 2064  he Transformer d
+00000940: 6563 6f64 6572 2e0a 2020 2020 2020 2020  ecoder..        
+00000950: 6465 636f 6465 725f 6666 6e5f 6469 6d20  decoder_ffn_dim 
+00000960: 2860 696e 7460 2c20 2a6f 7074 696f 6e61  (`int`, *optiona
+00000970: 6c2a 2c20 6465 6661 756c 7473 2074 6f20  l*, defaults to 
+00000980: 3430 3936 293a 0a20 2020 2020 2020 2020  4096):.         
+00000990: 2020 2044 696d 656e 7369 6f6e 616c 6974     Dimensionalit
+000009a0: 7920 6f66 2074 6865 2022 696e 7465 726d  y of the "interm
+000009b0: 6564 6961 7465 2220 286f 6674 656e 206e  ediate" (often n
+000009c0: 616d 6564 2066 6565 642d 666f 7277 6172  amed feed-forwar
+000009d0: 6429 206c 6179 6572 2069 6e20 6465 636f  d) layer in deco
+000009e0: 6465 722e 0a20 2020 2020 2020 2065 6e63  der..        enc
+000009f0: 6f64 6572 5f66 666e 5f64 696d 2028 6069  oder_ffn_dim (`i
+00000a00: 6e74 602c 202a 6f70 7469 6f6e 616c 2a2c  nt`, *optional*,
+00000a10: 2064 6566 6175 6c74 7320 746f 2034 3039   defaults to 409
+00000a20: 3629 3a0a 2020 2020 2020 2020 2020 2020  6):.            
+00000a30: 4469 6d65 6e73 696f 6e61 6c69 7479 206f  Dimensionality o
+00000a40: 6620 7468 6520 2269 6e74 6572 6d65 6469  f the "intermedi
+00000a50: 6174 6522 2028 6f66 7465 6e20 6e61 6d65  ate" (often name
+00000a60: 6420 6665 6564 2d66 6f72 7761 7264 2920  d feed-forward) 
+00000a70: 6c61 7965 7220 696e 2064 6563 6f64 6572  layer in decoder
+00000a80: 2e0a 2020 2020 2020 2020 6163 7469 7661  ..        activa
+00000a90: 7469 6f6e 5f66 756e 6374 696f 6e20 2860  tion_function (`
+00000aa0: 7374 7260 206f 7220 6066 756e 6374 696f  str` or `functio
+00000ab0: 6e60 2c20 2a6f 7074 696f 6e61 6c2a 2c20  n`, *optional*, 
+00000ac0: 6465 6661 756c 7473 2074 6f20 6022 6765  defaults to `"ge
+00000ad0: 6c75 2260 293a 0a20 2020 2020 2020 2020  lu"`):.         
+00000ae0: 2020 2054 6865 206e 6f6e 2d6c 696e 6561     The non-linea
+00000af0: 7220 6163 7469 7661 7469 6f6e 2066 756e  r activation fun
+00000b00: 6374 696f 6e20 2866 756e 6374 696f 6e20  ction (function 
+00000b10: 6f72 2073 7472 696e 6729 2069 6e20 7468  or string) in th
+00000b20: 6520 656e 636f 6465 7220 616e 6420 706f  e encoder and po
+00000b30: 6f6c 6572 2e20 4966 2073 7472 696e 672c  oler. If string,
+00000b40: 2060 2267 656c 7522 602c 0a20 2020 2020   `"gelu"`,.     
+00000b50: 2020 2020 2020 2060 2272 656c 7522 602c         `"relu"`,
+00000b60: 2060 2273 696c 7522 6020 616e 6420 6022   `"silu"` and `"
+00000b70: 6765 6c75 5f6e 6577 2260 2061 7265 2073  gelu_new"` are s
+00000b80: 7570 706f 7274 6564 2e0a 2020 2020 2020  upported..      
+00000b90: 2020 6472 6f70 6f75 7420 2860 666c 6f61    dropout (`floa
+00000ba0: 7460 2c20 2a6f 7074 696f 6e61 6c2a 2c20  t`, *optional*, 
+00000bb0: 6465 6661 756c 7473 2074 6f20 302e 3129  defaults to 0.1)
+00000bc0: 3a0a 2020 2020 2020 2020 2020 2020 5468  :.            Th
+00000bd0: 6520 6472 6f70 6f75 7420 7072 6f62 6162  e dropout probab
+00000be0: 696c 6974 7920 666f 7220 616c 6c20 6675  ility for all fu
+00000bf0: 6c6c 7920 636f 6e6e 6563 7465 6420 6c61  lly connected la
+00000c00: 7965 7273 2069 6e20 7468 6520 656d 6265  yers in the embe
+00000c10: 6464 696e 6773 2c20 656e 636f 6465 722c  ddings, encoder,
+00000c20: 2061 6e64 2070 6f6f 6c65 722e 0a20 2020   and pooler..   
+00000c30: 2020 2020 2061 7474 656e 7469 6f6e 5f64       attention_d
+00000c40: 726f 706f 7574 2028 6066 6c6f 6174 602c  ropout (`float`,
+00000c50: 202a 6f70 7469 6f6e 616c 2a2c 2064 6566   *optional*, def
+00000c60: 6175 6c74 7320 746f 2030 2e30 293a 0a20  aults to 0.0):. 
+00000c70: 2020 2020 2020 2020 2020 2054 6865 2064             The d
+00000c80: 726f 706f 7574 2072 6174 696f 2066 6f72  ropout ratio for
+00000c90: 2074 6865 2061 7474 656e 7469 6f6e 2070   the attention p
+00000ca0: 726f 6261 6269 6c69 7469 6573 2e0a 2020  robabilities..  
+00000cb0: 2020 2020 2020 6163 7469 7661 7469 6f6e        activation
+00000cc0: 5f64 726f 706f 7574 2028 6066 6c6f 6174  _dropout (`float
+00000cd0: 602c 202a 6f70 7469 6f6e 616c 2a2c 2064  `, *optional*, d
+00000ce0: 6566 6175 6c74 7320 746f 2030 2e30 293a  efaults to 0.0):
+00000cf0: 0a20 2020 2020 2020 2020 2020 2054 6865  .            The
+00000d00: 2064 726f 706f 7574 2072 6174 696f 2066   dropout ratio f
+00000d10: 6f72 2061 6374 6976 6174 696f 6e73 2069  or activations i
+00000d20: 6e73 6964 6520 7468 6520 6675 6c6c 7920  nside the fully 
+00000d30: 636f 6e6e 6563 7465 6420 6c61 7965 722e  connected layer.
+00000d40: 0a20 2020 2020 2020 206d 6178 5f70 6f73  .        max_pos
+00000d50: 6974 696f 6e5f 656d 6265 6464 696e 6773  ition_embeddings
+00000d60: 2028 6069 6e74 602c 202a 6f70 7469 6f6e   (`int`, *option
+00000d70: 616c 2a2c 2064 6566 6175 6c74 7320 746f  al*, defaults to
+00000d80: 2031 3238 293a 0a20 2020 2020 2020 2020   128):.         
+00000d90: 2020 2054 6865 206d 6178 696d 756d 2073     The maximum s
+00000da0: 6571 7565 6e63 6520 6c65 6e67 7468 2074  equence length t
+00000db0: 6861 7420 7468 6973 206d 6f64 656c 206d  hat this model m
+00000dc0: 6967 6874 2065 7665 7220 6265 2075 7365  ight ever be use
+00000dd0: 6420 7769 7468 2e20 5479 7069 6361 6c6c  d with. Typicall
+00000de0: 7920 7365 7420 7468 6973 2074 6f20 736f  y set this to so
+00000df0: 6d65 7468 696e 6720 6c61 7267 650a 2020  mething large.  
+00000e00: 2020 2020 2020 2020 2020 6a75 7374 2069            just i
+00000e10: 6e20 6361 7365 2028 652e 672e 2c20 3531  n case (e.g., 51
+00000e20: 3220 6f72 2031 3032 3420 6f72 2032 3034  2 or 1024 or 204
+00000e30: 3829 2e0a 2020 2020 2020 2020 696e 6974  8)..        init
+00000e40: 5f73 7464 2028 6066 6c6f 6174 602c 202a  _std (`float`, *
+00000e50: 6f70 7469 6f6e 616c 2a2c 2064 6566 6175  optional*, defau
+00000e60: 6c74 7320 746f 2030 2e30 3229 3a0a 2020  lts to 0.02):.  
+00000e70: 2020 2020 2020 2020 2020 5468 6520 7374            The st
+00000e80: 616e 6461 7264 2064 6576 6961 7469 6f6e  andard deviation
+00000e90: 206f 6620 7468 6520 7472 756e 6361 7465   of the truncate
+00000ea0: 645f 6e6f 726d 616c 5f69 6e69 7469 616c  d_normal_initial
+00000eb0: 697a 6572 2066 6f72 2069 6e69 7469 616c  izer for initial
+00000ec0: 697a 696e 6720 616c 6c20 7765 6967 6874  izing all weight
+00000ed0: 206d 6174 7269 6365 732e 0a20 2020 2020   matrices..     
+00000ee0: 2020 2065 6e63 6f64 6572 5f6c 6179 6572     encoder_layer
+00000ef0: 6472 6f70 2028 6066 6c6f 6174 602c 202a  drop (`float`, *
+00000f00: 6f70 7469 6f6e 616c 2a2c 2064 6566 6175  optional*, defau
+00000f10: 6c74 7320 746f 2030 2e30 293a 0a20 2020  lts to 0.0):.   
+00000f20: 2020 2020 2020 2020 2054 6865 204c 6179           The Lay
+00000f30: 6572 4472 6f70 2070 726f 6261 6269 6c69  erDrop probabili
+00000f40: 7479 2066 6f72 2074 6865 2065 6e63 6f64  ty for the encod
+00000f50: 6572 2e20 5365 6520 7468 6520 5b4c 6179  er. See the [Lay
+00000f60: 6572 4472 6f70 2070 6170 6572 5d28 7365  erDrop paper](se
+00000f70: 6520 6874 7470 733a 2f2f 6172 7869 762e  e https://arxiv.
+00000f80: 6f72 672f 6162 732f 3139 3039 2e31 3135  org/abs/1909.115
+00000f90: 3536 290a 2020 2020 2020 2020 2020 2020  56).            
+00000fa0: 666f 7220 6d6f 7265 2064 6574 6169 6c73  for more details
+00000fb0: 2e0a 2020 2020 2020 2020 6465 636f 6465  ..        decode
+00000fc0: 725f 6c61 7965 7264 726f 7020 2860 666c  r_layerdrop (`fl
+00000fd0: 6f61 7460 2c20 2a6f 7074 696f 6e61 6c2a  oat`, *optional*
+00000fe0: 2c20 6465 6661 756c 7473 2074 6f20 302e  , defaults to 0.
+00000ff0: 3029 3a0a 2020 2020 2020 2020 2020 2020  0):.            
+00001000: 5468 6520 4c61 7965 7244 726f 7020 7072  The LayerDrop pr
+00001010: 6f62 6162 696c 6974 7920 666f 7220 7468  obability for th
+00001020: 6520 6465 636f 6465 722e 2053 6565 2074  e decoder. See t
+00001030: 6865 205b 4c61 7965 7244 726f 7020 7061  he [LayerDrop pa
+00001040: 7065 725d 2873 6565 2068 7474 7073 3a2f  per](see https:/
+00001050: 2f61 7278 6976 2e6f 7267 2f61 6273 2f31  /arxiv.org/abs/1
+00001060: 3930 392e 3131 3535 3629 0a20 2020 2020  909.11556).     
+00001070: 2020 2020 2020 2066 6f72 206d 6f72 6520         for more 
+00001080: 6465 7461 696c 732e 0a20 2020 2020 2020  details..       
+00001090: 2073 6361 6c65 5f65 6d62 6564 6469 6e67   scale_embedding
+000010a0: 2028 6062 6f6f 6c60 2c20 2a6f 7074 696f   (`bool`, *optio
+000010b0: 6e61 6c2a 2c20 6465 6661 756c 7473 2074  nal*, defaults t
+000010c0: 6f20 6046 616c 7365 6029 3a0a 2020 2020  o `False`):.    
+000010d0: 2020 2020 2020 2020 5363 616c 6520 656d          Scale em
+000010e0: 6265 6464 696e 6773 2062 7920 6469 7669  beddings by divi
+000010f0: 6e67 2062 7920 7371 7274 2864 5f6d 6f64  ng by sqrt(d_mod
+00001100: 656c 292e 0a20 2020 2020 2020 2075 7365  el)..        use
+00001110: 5f63 6163 6865 2028 6062 6f6f 6c60 2c20  _cache (`bool`, 
+00001120: 2a6f 7074 696f 6e61 6c2a 2c20 6465 6661  *optional*, defa
+00001130: 756c 7473 2074 6f20 6054 7275 6560 293a  ults to `True`):
+00001140: 0a20 2020 2020 2020 2020 2020 2057 6865  .            Whe
+00001150: 7468 6572 206f 7220 6e6f 7420 7468 6520  ther or not the 
+00001160: 6d6f 6465 6c20 7368 6f75 6c64 2072 6574  model should ret
+00001170: 7572 6e20 7468 6520 6c61 7374 206b 6579  urn the last key
+00001180: 2f76 616c 7565 7320 6174 7465 6e74 696f  /values attentio
+00001190: 6e73 2028 6e6f 7420 7573 6564 2062 7920  ns (not used by 
+000011a0: 616c 6c20 6d6f 6465 6c73 290a 2020 2020  all models).    
+000011b0: 2020 2020 666f 7263 6564 5f65 6f73 5f74      forced_eos_t
+000011c0: 6f6b 656e 5f69 6420 2860 696e 7460 2c20  oken_id (`int`, 
+000011d0: 2a6f 7074 696f 6e61 6c2a 2c20 6465 6661  *optional*, defa
+000011e0: 756c 7473 2074 6f20 3229 3a0a 2020 2020  ults to 2):.    
+000011f0: 2020 2020 2020 2020 5468 6520 6964 206f          The id o
+00001200: 6620 7468 6520 746f 6b65 6e20 746f 2066  f the token to f
+00001210: 6f72 6365 2061 7320 7468 6520 6c61 7374  orce as the last
+00001220: 2067 656e 6572 6174 6564 2074 6f6b 656e   generated token
+00001230: 2077 6865 6e20 606d 6178 5f6c 656e 6774   when `max_lengt
+00001240: 6860 2069 7320 7265 6163 6865 642e 2055  h` is reached. U
+00001250: 7375 616c 6c79 2073 6574 2074 6f0a 2020  sually set to.  
+00001260: 2020 2020 2020 2020 2020 6065 6f73 5f74            `eos_t
+00001270: 6f6b 656e 5f69 6460 2e0a 0a20 2020 2045  oken_id`...    E
+00001280: 7861 6d70 6c65 3a0a 0a20 2020 2060 6060  xample:..    ```
+00001290: 7079 7468 6f6e 0a20 2020 203e 3e3e 2066  python.    >>> f
+000012a0: 726f 6d20 7472 616e 7366 6f72 6d65 7273  rom transformers
+000012b0: 2069 6d70 6f72 7420 426c 656e 6465 7262   import Blenderb
+000012c0: 6f74 436f 6e66 6967 2c20 426c 656e 6465  otConfig, Blende
+000012d0: 7262 6f74 4d6f 6465 6c0a 0a20 2020 203e  rbotModel..    >
+000012e0: 3e3e 2023 2049 6e69 7469 616c 697a 696e  >> # Initializin
+000012f0: 6720 6120 426c 656e 6465 7262 6f74 2066  g a Blenderbot f
+00001300: 6163 6562 6f6f 6b2f 626c 656e 6465 7262  acebook/blenderb
+00001310: 6f74 2d33 4220 7374 796c 6520 636f 6e66  ot-3B style conf
+00001320: 6967 7572 6174 696f 6e0a 2020 2020 3e3e  iguration.    >>
+00001330: 3e20 636f 6e66 6967 7572 6174 696f 6e20  > configuration 
+00001340: 3d20 426c 656e 6465 7262 6f74 436f 6e66  = BlenderbotConf
+00001350: 6967 2829 0a0a 2020 2020 3e3e 3e20 2320  ig()..    >>> # 
+00001360: 496e 6974 6961 6c69 7a69 6e67 2061 206d  Initializing a m
+00001370: 6f64 656c 2028 7769 7468 2072 616e 646f  odel (with rando
+00001380: 6d20 7765 6967 6874 7329 2066 726f 6d20  m weights) from 
+00001390: 7468 6520 6661 6365 626f 6f6b 2f62 6c65  the facebook/ble
+000013a0: 6e64 6572 626f 742d 3342 2073 7479 6c65  nderbot-3B style
+000013b0: 2063 6f6e 6669 6775 7261 7469 6f6e 0a20   configuration. 
+000013c0: 2020 203e 3e3e 206d 6f64 656c 203d 2042     >>> model = B
+000013d0: 6c65 6e64 6572 626f 744d 6f64 656c 2863  lenderbotModel(c
+000013e0: 6f6e 6669 6775 7261 7469 6f6e 290a 0a20  onfiguration).. 
+000013f0: 2020 203e 3e3e 2023 2041 6363 6573 7369     >>> # Accessi
+00001400: 6e67 2074 6865 206d 6f64 656c 2063 6f6e  ng the model con
+00001410: 6669 6775 7261 7469 6f6e 0a20 2020 203e  figuration.    >
+00001420: 3e3e 2063 6f6e 6669 6775 7261 7469 6f6e  >> configuration
+00001430: 203d 206d 6f64 656c 2e63 6f6e 6669 670a   = model.config.
+00001440: 2020 2020 6060 6022 2222 0a0a 2020 2020      ```"""..    
+00001450: 6d6f 6465 6c5f 7479 7065 203d 2022 626c  model_type = "bl
+00001460: 656e 6465 7262 6f74 220a 2020 2020 6b65  enderbot".    ke
+00001470: 7973 5f74 6f5f 6967 6e6f 7265 5f61 745f  ys_to_ignore_at_
+00001480: 696e 6665 7265 6e63 6520 3d20 5b22 7061  inference = ["pa
+00001490: 7374 5f6b 6579 5f76 616c 7565 7322 5d0a  st_key_values"].
+000014a0: 2020 2020 6174 7472 6962 7574 655f 6d61      attribute_ma
+000014b0: 7020 3d20 7b22 6e75 6d5f 6174 7465 6e74  p = {"num_attent
+000014c0: 696f 6e5f 6865 6164 7322 3a20 2265 6e63  ion_heads": "enc
+000014d0: 6f64 6572 5f61 7474 656e 7469 6f6e 5f68  oder_attention_h
+000014e0: 6561 6473 222c 2022 6869 6464 656e 5f73  eads", "hidden_s
+000014f0: 697a 6522 3a20 2264 5f6d 6f64 656c 227d  ize": "d_model"}
+00001500: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
+00001510: 5f5f 280a 2020 2020 2020 2020 7365 6c66  __(.        self
+00001520: 2c0a 2020 2020 2020 2020 766f 6361 625f  ,.        vocab_
+00001530: 7369 7a65 3d38 3030 382c 0a20 2020 2020  size=8008,.     
+00001540: 2020 206d 6178 5f70 6f73 6974 696f 6e5f     max_position_
+00001550: 656d 6265 6464 696e 6773 3d31 3238 2c0a  embeddings=128,.
+00001560: 2020 2020 2020 2020 656e 636f 6465 725f          encoder_
+00001570: 6c61 7965 7273 3d32 2c0a 2020 2020 2020  layers=2,.      
+00001580: 2020 656e 636f 6465 725f 6666 6e5f 6469    encoder_ffn_di
+00001590: 6d3d 3130 3234 302c 0a20 2020 2020 2020  m=10240,.       
+000015a0: 2065 6e63 6f64 6572 5f61 7474 656e 7469   encoder_attenti
+000015b0: 6f6e 5f68 6561 6473 3d33 322c 0a20 2020  on_heads=32,.   
+000015c0: 2020 2020 2064 6563 6f64 6572 5f6c 6179       decoder_lay
+000015d0: 6572 733d 3234 2c0a 2020 2020 2020 2020  ers=24,.        
+000015e0: 6465 636f 6465 725f 6666 6e5f 6469 6d3d  decoder_ffn_dim=
+000015f0: 3130 3234 302c 0a20 2020 2020 2020 2064  10240,.        d
+00001600: 6563 6f64 6572 5f61 7474 656e 7469 6f6e  ecoder_attention
+00001610: 5f68 6561 6473 3d33 322c 0a20 2020 2020  _heads=32,.     
+00001620: 2020 2065 6e63 6f64 6572 5f6c 6179 6572     encoder_layer
+00001630: 6472 6f70 3d30 2e30 2c0a 2020 2020 2020  drop=0.0,.      
+00001640: 2020 6465 636f 6465 725f 6c61 7965 7264    decoder_layerd
+00001650: 726f 703d 302e 302c 0a20 2020 2020 2020  rop=0.0,.       
+00001660: 2075 7365 5f63 6163 6865 3d54 7275 652c   use_cache=True,
+00001670: 0a20 2020 2020 2020 2069 735f 656e 636f  .        is_enco
+00001680: 6465 725f 6465 636f 6465 723d 5472 7565  der_decoder=True
+00001690: 2c0a 2020 2020 2020 2020 6163 7469 7661  ,.        activa
+000016a0: 7469 6f6e 5f66 756e 6374 696f 6e3d 2267  tion_function="g
+000016b0: 656c 7522 2c0a 2020 2020 2020 2020 645f  elu",.        d_
+000016c0: 6d6f 6465 6c3d 3235 3630 2c0a 2020 2020  model=2560,.    
+000016d0: 2020 2020 6472 6f70 6f75 743d 302e 312c      dropout=0.1,
+000016e0: 0a20 2020 2020 2020 2061 7474 656e 7469  .        attenti
+000016f0: 6f6e 5f64 726f 706f 7574 3d30 2e30 2c0a  on_dropout=0.0,.
+00001700: 2020 2020 2020 2020 6163 7469 7661 7469          activati
+00001710: 6f6e 5f64 726f 706f 7574 3d30 2e30 2c0a  on_dropout=0.0,.
+00001720: 2020 2020 2020 2020 696e 6974 5f73 7464          init_std
+00001730: 3d30 2e30 322c 0a20 2020 2020 2020 2064  =0.02,.        d
+00001740: 6563 6f64 6572 5f73 7461 7274 5f74 6f6b  ecoder_start_tok
+00001750: 656e 5f69 643d 312c 0a20 2020 2020 2020  en_id=1,.       
+00001760: 2073 6361 6c65 5f65 6d62 6564 6469 6e67   scale_embedding
+00001770: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
+00001780: 7061 645f 746f 6b65 6e5f 6964 3d30 2c0a  pad_token_id=0,.
+00001790: 2020 2020 2020 2020 626f 735f 746f 6b65          bos_toke
+000017a0: 6e5f 6964 3d31 2c0a 2020 2020 2020 2020  n_id=1,.        
+000017b0: 656f 735f 746f 6b65 6e5f 6964 3d32 2c0a  eos_token_id=2,.
+000017c0: 2020 2020 2020 2020 656e 636f 6465 725f          encoder_
+000017d0: 6e6f 5f72 6570 6561 745f 6e67 7261 6d5f  no_repeat_ngram_
+000017e0: 7369 7a65 3d33 2c0a 2020 2020 2020 2020  size=3,.        
+000017f0: 666f 7263 6564 5f65 6f73 5f74 6f6b 656e  forced_eos_token
+00001800: 5f69 643d 322c 0a20 2020 2020 2020 202a  _id=2,.        *
+00001810: 2a6b 7761 7267 732c 0a20 2020 2029 3a0a  *kwargs,.    ):.
+00001820: 2020 2020 2020 2020 7365 6c66 2e76 6f63          self.voc
+00001830: 6162 5f73 697a 6520 3d20 766f 6361 625f  ab_size = vocab_
+00001840: 7369 7a65 0a20 2020 2020 2020 2073 656c  size.        sel
+00001850: 662e 6d61 785f 706f 7369 7469 6f6e 5f65  f.max_position_e
+00001860: 6d62 6564 6469 6e67 7320 3d20 6d61 785f  mbeddings = max_
+00001870: 706f 7369 7469 6f6e 5f65 6d62 6564 6469  position_embeddi
+00001880: 6e67 730a 2020 2020 2020 2020 7365 6c66  ngs.        self
+00001890: 2e64 5f6d 6f64 656c 203d 2064 5f6d 6f64  .d_model = d_mod
+000018a0: 656c 0a20 2020 2020 2020 2073 656c 662e  el.        self.
+000018b0: 656e 636f 6465 725f 6666 6e5f 6469 6d20  encoder_ffn_dim 
+000018c0: 3d20 656e 636f 6465 725f 6666 6e5f 6469  = encoder_ffn_di
+000018d0: 6d0a 2020 2020 2020 2020 7365 6c66 2e65  m.        self.e
+000018e0: 6e63 6f64 6572 5f6c 6179 6572 7320 3d20  ncoder_layers = 
+000018f0: 656e 636f 6465 725f 6c61 7965 7273 0a20  encoder_layers. 
+00001900: 2020 2020 2020 2073 656c 662e 656e 636f         self.enco
+00001910: 6465 725f 6174 7465 6e74 696f 6e5f 6865  der_attention_he
+00001920: 6164 7320 3d20 656e 636f 6465 725f 6174  ads = encoder_at
+00001930: 7465 6e74 696f 6e5f 6865 6164 730a 2020  tention_heads.  
+00001940: 2020 2020 2020 7365 6c66 2e64 6563 6f64        self.decod
+00001950: 6572 5f66 666e 5f64 696d 203d 2064 6563  er_ffn_dim = dec
+00001960: 6f64 6572 5f66 666e 5f64 696d 0a20 2020  oder_ffn_dim.   
+00001970: 2020 2020 2073 656c 662e 6465 636f 6465       self.decode
+00001980: 725f 6c61 7965 7273 203d 2064 6563 6f64  r_layers = decod
+00001990: 6572 5f6c 6179 6572 730a 2020 2020 2020  er_layers.      
+000019a0: 2020 7365 6c66 2e64 6563 6f64 6572 5f61    self.decoder_a
+000019b0: 7474 656e 7469 6f6e 5f68 6561 6473 203d  ttention_heads =
+000019c0: 2064 6563 6f64 6572 5f61 7474 656e 7469   decoder_attenti
+000019d0: 6f6e 5f68 6561 6473 0a20 2020 2020 2020  on_heads.       
+000019e0: 2073 656c 662e 6472 6f70 6f75 7420 3d20   self.dropout = 
+000019f0: 6472 6f70 6f75 740a 2020 2020 2020 2020  dropout.        
+00001a00: 7365 6c66 2e61 7474 656e 7469 6f6e 5f64  self.attention_d
+00001a10: 726f 706f 7574 203d 2061 7474 656e 7469  ropout = attenti
+00001a20: 6f6e 5f64 726f 706f 7574 0a20 2020 2020  on_dropout.     
+00001a30: 2020 2073 656c 662e 6163 7469 7661 7469     self.activati
+00001a40: 6f6e 5f64 726f 706f 7574 203d 2061 6374  on_dropout = act
+00001a50: 6976 6174 696f 6e5f 6472 6f70 6f75 740a  ivation_dropout.
+00001a60: 2020 2020 2020 2020 7365 6c66 2e61 6374          self.act
+00001a70: 6976 6174 696f 6e5f 6675 6e63 7469 6f6e  ivation_function
+00001a80: 203d 2061 6374 6976 6174 696f 6e5f 6675   = activation_fu
+00001a90: 6e63 7469 6f6e 0a20 2020 2020 2020 2073  nction.        s
+00001aa0: 656c 662e 696e 6974 5f73 7464 203d 2069  elf.init_std = i
+00001ab0: 6e69 745f 7374 640a 2020 2020 2020 2020  nit_std.        
+00001ac0: 7365 6c66 2e65 6e63 6f64 6572 5f6c 6179  self.encoder_lay
+00001ad0: 6572 6472 6f70 203d 2065 6e63 6f64 6572  erdrop = encoder
+00001ae0: 5f6c 6179 6572 6472 6f70 0a20 2020 2020  _layerdrop.     
+00001af0: 2020 2073 656c 662e 6465 636f 6465 725f     self.decoder_
+00001b00: 6c61 7965 7264 726f 7020 3d20 6465 636f  layerdrop = deco
+00001b10: 6465 725f 6c61 7965 7264 726f 700a 2020  der_layerdrop.  
+00001b20: 2020 2020 2020 7365 6c66 2e75 7365 5f63        self.use_c
+00001b30: 6163 6865 203d 2075 7365 5f63 6163 6865  ache = use_cache
+00001b40: 0a20 2020 2020 2020 2073 656c 662e 6e75  .        self.nu
+00001b50: 6d5f 6869 6464 656e 5f6c 6179 6572 7320  m_hidden_layers 
+00001b60: 3d20 656e 636f 6465 725f 6c61 7965 7273  = encoder_layers
+00001b70: 0a20 2020 2020 2020 2073 656c 662e 7363  .        self.sc
+00001b80: 616c 655f 656d 6265 6464 696e 6720 3d20  ale_embedding = 
+00001b90: 7363 616c 655f 656d 6265 6464 696e 6720  scale_embedding 
+00001ba0: 2023 2073 6361 6c65 2066 6163 746f 7220   # scale factor 
+00001bb0: 7769 6c6c 2062 6520 7371 7274 2864 5f6d  will be sqrt(d_m
+00001bc0: 6f64 656c 2920 6966 2054 7275 650a 0a20  odel) if True.. 
+00001bd0: 2020 2020 2020 2073 7570 6572 2829 2e5f         super()._
+00001be0: 5f69 6e69 745f 5f28 0a20 2020 2020 2020  _init__(.       
+00001bf0: 2020 2020 2070 6164 5f74 6f6b 656e 5f69       pad_token_i
+00001c00: 643d 7061 645f 746f 6b65 6e5f 6964 2c0a  d=pad_token_id,.
+00001c10: 2020 2020 2020 2020 2020 2020 626f 735f              bos_
+00001c20: 746f 6b65 6e5f 6964 3d62 6f73 5f74 6f6b  token_id=bos_tok
+00001c30: 656e 5f69 642c 0a20 2020 2020 2020 2020  en_id,.         
+00001c40: 2020 2065 6f73 5f74 6f6b 656e 5f69 643d     eos_token_id=
+00001c50: 656f 735f 746f 6b65 6e5f 6964 2c0a 2020  eos_token_id,.  
+00001c60: 2020 2020 2020 2020 2020 6973 5f65 6e63            is_enc
+00001c70: 6f64 6572 5f64 6563 6f64 6572 3d69 735f  oder_decoder=is_
+00001c80: 656e 636f 6465 725f 6465 636f 6465 722c  encoder_decoder,
+00001c90: 0a20 2020 2020 2020 2020 2020 2064 6563  .            dec
+00001ca0: 6f64 6572 5f73 7461 7274 5f74 6f6b 656e  oder_start_token
+00001cb0: 5f69 643d 6465 636f 6465 725f 7374 6172  _id=decoder_star
+00001cc0: 745f 746f 6b65 6e5f 6964 2c0a 2020 2020  t_token_id,.    
+00001cd0: 2020 2020 2020 2020 656e 636f 6465 725f          encoder_
+00001ce0: 6e6f 5f72 6570 6561 745f 6e67 7261 6d5f  no_repeat_ngram_
+00001cf0: 7369 7a65 3d65 6e63 6f64 6572 5f6e 6f5f  size=encoder_no_
+00001d00: 7265 7065 6174 5f6e 6772 616d 5f73 697a  repeat_ngram_siz
+00001d10: 652c 0a20 2020 2020 2020 2020 2020 2066  e,.            f
+00001d20: 6f72 6365 645f 656f 735f 746f 6b65 6e5f  orced_eos_token_
+00001d30: 6964 3d66 6f72 6365 645f 656f 735f 746f  id=forced_eos_to
+00001d40: 6b65 6e5f 6964 2c0a 2020 2020 2020 2020  ken_id,.        
+00001d50: 2020 2020 2a2a 6b77 6172 6773 2c0a 2020      **kwargs,.  
+00001d60: 2020 2020 2020 290a 0a5f 5f61 6c6c 5f5f        )..__all__
+00001d70: 203d 205b 2742 6c65 6e64 6572 626f 7443   = ['BlenderbotC
+00001d80: 6f6e 6669 6727 5d0a                      onfig'].
```

## mindnlp/transformers/models/blenderbot/modeling_blenderbot.py

```diff
@@ -0,0 +1,4042 @@
+00000000: 2320 636f 6469 6e67 3d75 7466 2d38 0a23  # coding=utf-8.#
+00000010: 2043 6f70 7972 6967 6874 2032 3032 3120   Copyright 2021 
+00000020: 5468 6520 4661 6365 626f 6f6b 2c20 496e  The Facebook, In
+00000030: 632e 2061 6e64 2054 6865 2048 7567 6769  c. and The Huggi
+00000040: 6e67 4661 6365 2049 6e63 2e20 7465 616d  ngFace Inc. team
+00000050: 2e20 416c 6c20 7269 6768 7473 2072 6573  . All rights res
+00000060: 6572 7665 642e 0a23 0a23 204c 6963 656e  erved..#.# Licen
+00000070: 7365 6420 756e 6465 7220 7468 6520 4170  sed under the Ap
+00000080: 6163 6865 204c 6963 656e 7365 2c20 5665  ache License, Ve
+00000090: 7273 696f 6e20 322e 3020 2874 6865 2022  rsion 2.0 (the "
+000000a0: 4c69 6365 6e73 6522 293b 0a23 2079 6f75  License");.# you
+000000b0: 206d 6179 206e 6f74 2075 7365 2074 6869   may not use thi
+000000c0: 7320 6669 6c65 2065 7863 6570 7420 696e  s file except in
+000000d0: 2063 6f6d 706c 6961 6e63 6520 7769 7468   compliance with
+000000e0: 2074 6865 204c 6963 656e 7365 2e0a 2320   the License..# 
+000000f0: 596f 7520 6d61 7920 6f62 7461 696e 2061  You may obtain a
+00000100: 2063 6f70 7920 6f66 2074 6865 204c 6963   copy of the Lic
+00000110: 656e 7365 2061 740a 230a 2320 2020 2020  ense at.#.#     
+00000120: 6874 7470 3a2f 2f77 7777 2e61 7061 6368  http://www.apach
+00000130: 652e 6f72 672f 6c69 6365 6e73 6573 2f4c  e.org/licenses/L
+00000140: 4943 454e 5345 2d32 2e30 0a23 0a23 2055  ICENSE-2.0.#.# U
+00000150: 6e6c 6573 7320 7265 7175 6972 6564 2062  nless required b
+00000160: 7920 6170 706c 6963 6162 6c65 206c 6177  y applicable law
+00000170: 206f 7220 6167 7265 6564 2074 6f20 696e   or agreed to in
+00000180: 2077 7269 7469 6e67 2c20 736f 6674 7761   writing, softwa
+00000190: 7265 0a23 2064 6973 7472 6962 7574 6564  re.# distributed
+000001a0: 2075 6e64 6572 2074 6865 204c 6963 656e   under the Licen
+000001b0: 7365 2069 7320 6469 7374 7269 6275 7465  se is distribute
+000001c0: 6420 6f6e 2061 6e20 2241 5320 4953 2220  d on an "AS IS" 
+000001d0: 4241 5349 532c 0a23 2057 4954 484f 5554  BASIS,.# WITHOUT
+000001e0: 2057 4152 5241 4e54 4945 5320 4f52 2043   WARRANTIES OR C
+000001f0: 4f4e 4449 5449 4f4e 5320 4f46 2041 4e59  ONDITIONS OF ANY
+00000200: 204b 494e 442c 2065 6974 6865 7220 6578   KIND, either ex
+00000210: 7072 6573 7320 6f72 2069 6d70 6c69 6564  press or implied
+00000220: 2e0a 2320 5365 6520 7468 6520 4c69 6365  ..# See the Lice
+00000230: 6e73 6520 666f 7220 7468 6520 7370 6563  nse for the spec
+00000240: 6966 6963 206c 616e 6775 6167 6520 676f  ific language go
+00000250: 7665 726e 696e 6720 7065 726d 6973 7369  verning permissi
+00000260: 6f6e 7320 616e 640a 2320 6c69 6d69 7461  ons and.# limita
+00000270: 7469 6f6e 7320 756e 6465 7220 7468 6520  tions under the 
+00000280: 4c69 6365 6e73 652e 0a22 2222 204d 696e  License..""" Min
+00000290: 6453 706f 7265 2042 6c65 6e64 6572 626f  dSpore Blenderbo
+000002a0: 7420 6d6f 6465 6c2e 2222 220a 696d 706f  t model.""".impo
+000002b0: 7274 2063 6f70 790a 696d 706f 7274 206d  rt copy.import m
+000002c0: 6174 680a 6672 6f6d 2074 7970 696e 6720  ath.from typing 
+000002d0: 696d 706f 7274 204c 6973 742c 204f 7074  import List, Opt
+000002e0: 696f 6e61 6c2c 2054 7570 6c65 2c20 556e  ional, Tuple, Un
+000002f0: 696f 6e0a 0a69 6d70 6f72 7420 6e75 6d70  ion..import nump
+00000300: 7920 6173 206e 700a 696d 706f 7274 206d  y as np.import m
+00000310: 696e 6473 706f 7265 0a66 726f 6d20 6d69  indspore.from mi
+00000320: 6e64 7370 6f72 6520 696d 706f 7274 206f  ndspore import o
+00000330: 7073 2c20 6e6e 2c20 5465 6e73 6f72 0a66  ps, nn, Tensor.f
+00000340: 726f 6d20 6d69 6e64 7370 6f72 652e 636f  rom mindspore.co
+00000350: 6d6d 6f6e 2e69 6e69 7469 616c 697a 6572  mmon.initializer
+00000360: 2069 6d70 6f72 7420 696e 6974 6961 6c69   import initiali
+00000370: 7a65 722c 204e 6f72 6d61 6c0a 0a66 726f  zer, Normal..fro
+00000380: 6d20 2e2e 2e2e 6d6f 6475 6c65 732e 6675  m ....modules.fu
+00000390: 6e63 7469 6f6e 616c 2069 6d70 6f72 7420  nctional import 
+000003a0: 6669 6e66 6f0a 6672 6f6d 202e 2e2e 6163  finfo.from ...ac
+000003b0: 7469 7661 7469 6f6e 7320 696d 706f 7274  tivations import
+000003c0: 2041 4354 3246 4e0a 6672 6f6d 202e 2e2e   ACT2FN.from ...
+000003d0: 6d6f 6465 6c69 6e67 5f61 7474 6e5f 6d61  modeling_attn_ma
+000003e0: 736b 5f75 7469 6c73 2069 6d70 6f72 7420  sk_utils import 
+000003f0: 5f70 7265 7061 7265 5f34 645f 6174 7465  _prepare_4d_atte
+00000400: 6e74 696f 6e5f 6d61 736b 2c20 5f70 7265  ntion_mask, _pre
+00000410: 7061 7265 5f34 645f 6361 7573 616c 5f61  pare_4d_causal_a
+00000420: 7474 656e 7469 6f6e 5f6d 6173 6b0a 6672  ttention_mask.fr
+00000430: 6f6d 202e 2e2e 6d6f 6465 6c69 6e67 5f6f  om ...modeling_o
+00000440: 7574 7075 7473 2069 6d70 6f72 7420 280a  utputs import (.
+00000450: 2020 2020 4261 7365 4d6f 6465 6c4f 7574      BaseModelOut
+00000460: 7075 742c 0a20 2020 2042 6173 654d 6f64  put,.    BaseMod
+00000470: 656c 4f75 7470 7574 5769 7468 5061 7374  elOutputWithPast
+00000480: 416e 6443 726f 7373 4174 7465 6e74 696f  AndCrossAttentio
+00000490: 6e73 2c0a 2020 2020 4361 7573 616c 4c4d  ns,.    CausalLM
+000004a0: 4f75 7470 7574 5769 7468 4372 6f73 7341  OutputWithCrossA
+000004b0: 7474 656e 7469 6f6e 732c 0a20 2020 2053  ttentions,.    S
+000004c0: 6571 3253 6571 4c4d 4f75 7470 7574 2c0a  eq2SeqLMOutput,.
+000004d0: 2020 2020 5365 7132 5365 714d 6f64 656c      Seq2SeqModel
+000004e0: 4f75 7470 7574 2c0a 290a 6672 6f6d 202e  Output,.).from .
+000004f0: 2e2e 2e75 7469 6c73 2069 6d70 6f72 7420  ...utils import 
+00000500: 6c6f 6767 696e 670a 6672 6f6d 202e 2e2e  logging.from ...
+00000510: 6d6f 6465 6c69 6e67 5f75 7469 6c73 2069  modeling_utils i
+00000520: 6d70 6f72 7420 5072 6554 7261 696e 6564  mport PreTrained
+00000530: 4d6f 6465 6c0a 6672 6f6d 202e 636f 6e66  Model.from .conf
+00000540: 6967 7572 6174 696f 6e5f 626c 656e 6465  iguration_blende
+00000550: 7262 6f74 2069 6d70 6f72 7420 426c 656e  rbot import Blen
+00000560: 6465 7262 6f74 436f 6e66 6967 0a0a 0a6c  derbotConfig...l
+00000570: 6f67 6765 7220 3d20 6c6f 6767 696e 672e  ogger = logging.
+00000580: 6765 745f 6c6f 6767 6572 285f 5f6e 616d  get_logger(__nam
+00000590: 655f 5f29 0a0a 5f43 4f4e 4649 475f 464f  e__).._CONFIG_FO
+000005a0: 525f 444f 4320 3d20 2242 6c65 6e64 6572  R_DOC = "Blender
+000005b0: 626f 7443 6f6e 6669 6722 0a5f 4348 4543  botConfig"._CHEC
+000005c0: 4b50 4f49 4e54 5f46 4f52 5f44 4f43 203d  KPOINT_FOR_DOC =
+000005d0: 2022 6661 6365 626f 6f6b 2f62 6c65 6e64   "facebook/blend
+000005e0: 6572 626f 742d 3430 304d 2d64 6973 7469  erbot-400M-disti
+000005f0: 6c6c 220a 0a0a 2320 436f 7069 6564 2066  ll"...# Copied f
+00000600: 726f 6d20 7472 616e 7366 6f72 6d65 7273  rom transformers
+00000610: 2e6d 6f64 656c 732e 6261 7274 2e6d 6f64  .models.bart.mod
+00000620: 656c 696e 675f 6261 7274 2e73 6869 6674  eling_bart.shift
+00000630: 5f74 6f6b 656e 735f 7269 6768 740a 6465  _tokens_right.de
+00000640: 6620 7368 6966 745f 746f 6b65 6e73 5f72  f shift_tokens_r
+00000650: 6967 6874 2869 6e70 7574 5f69 6473 3a20  ight(input_ids: 
+00000660: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+00000670: 2c20 7061 645f 746f 6b65 6e5f 6964 3a20  , pad_token_id: 
+00000680: 696e 742c 2064 6563 6f64 6572 5f73 7461  int, decoder_sta
+00000690: 7274 5f74 6f6b 656e 5f69 643a 2069 6e74  rt_token_id: int
+000006a0: 293a 0a20 2020 2022 2222 0a20 2020 2053  ):.    """.    S
+000006b0: 6869 6674 2069 6e70 7574 2069 6473 206f  hift input ids o
+000006c0: 6e65 2074 6f6b 656e 2074 6f20 7468 6520  ne token to the 
+000006d0: 7269 6768 742e 0a20 2020 2022 2222 0a20  right..    """. 
+000006e0: 2020 2073 6869 6674 6564 5f69 6e70 7574     shifted_input
+000006f0: 5f69 6473 203d 2069 6e70 7574 5f69 6473  _ids = input_ids
+00000700: 2e6e 6577 5f7a 6572 6f73 2869 6e70 7574  .new_zeros(input
+00000710: 5f69 6473 2e73 6861 7065 290a 2020 2020  _ids.shape).    
+00000720: 7368 6966 7465 645f 696e 7075 745f 6964  shifted_input_id
+00000730: 735b 3a2c 2031 3a5d 203d 2069 6e70 7574  s[:, 1:] = input
+00000740: 5f69 6473 5b3a 2c20 3a2d 315d 2e63 6f70  _ids[:, :-1].cop
+00000750: 7928 290a 2020 2020 7368 6966 7465 645f  y().    shifted_
+00000760: 696e 7075 745f 6964 735b 3a2c 2030 5d20  input_ids[:, 0] 
+00000770: 3d20 6465 636f 6465 725f 7374 6172 745f  = decoder_start_
+00000780: 746f 6b65 6e5f 6964 0a0a 2020 2020 6966  token_id..    if
+00000790: 2070 6164 5f74 6f6b 656e 5f69 6420 6973   pad_token_id is
+000007a0: 204e 6f6e 653a 0a20 2020 2020 2020 2072   None:.        r
+000007b0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+000007c0: 2273 656c 662e 6d6f 6465 6c2e 636f 6e66  "self.model.conf
+000007d0: 6967 2e70 6164 5f74 6f6b 656e 5f69 6420  ig.pad_token_id 
+000007e0: 6861 7320 746f 2062 6520 6465 6669 6e65  has to be define
+000007f0: 642e 2229 0a20 2020 2023 2072 6570 6c61  d.").    # repla
+00000800: 6365 2070 6f73 7369 626c 6520 2d31 3030  ce possible -100
+00000810: 2076 616c 7565 7320 696e 206c 6162 656c   values in label
+00000820: 7320 6279 2060 7061 645f 746f 6b65 6e5f  s by `pad_token_
+00000830: 6964 600a 2020 2020 7368 6966 7465 645f  id`.    shifted_
+00000840: 696e 7075 745f 6964 7320 3d20 7368 6966  input_ids = shif
+00000850: 7465 645f 696e 7075 745f 6964 732e 6d61  ted_input_ids.ma
+00000860: 736b 6564 5f66 696c 6c28 7368 6966 7465  sked_fill(shifte
+00000870: 645f 696e 7075 745f 6964 7320 3d3d 202d  d_input_ids == -
+00000880: 3130 302c 2070 6164 5f74 6f6b 656e 5f69  100, pad_token_i
+00000890: 6429 0a0a 2020 2020 7265 7475 726e 2073  d)..    return s
+000008a0: 6869 6674 6564 5f69 6e70 7574 5f69 6473  hifted_input_ids
+000008b0: 0a0a 0a63 6c61 7373 2042 6c65 6e64 6572  ...class Blender
+000008c0: 626f 744c 6561 726e 6564 506f 7369 7469  botLearnedPositi
+000008d0: 6f6e 616c 456d 6265 6464 696e 6728 6e6e  onalEmbedding(nn
+000008e0: 2e45 6d62 6564 6469 6e67 293a 0a20 2020  .Embedding):.   
+000008f0: 2022 2222 0a20 2020 2054 6869 7320 6d6f   """.    This mo
+00000900: 6475 6c65 206c 6561 726e 7320 706f 7369  dule learns posi
+00000910: 7469 6f6e 616c 2065 6d62 6564 6469 6e67  tional embedding
+00000920: 7320 7570 2074 6f20 6120 6669 7865 6420  s up to a fixed 
+00000930: 6d61 7869 6d75 6d20 7369 7a65 2e0a 2020  maximum size..  
+00000940: 2020 2222 220a 0a20 2020 2064 6566 2063    """..    def c
+00000950: 6f6e 7374 7275 6374 2873 656c 662c 2069  onstruct(self, i
+00000960: 6e70 7574 5f69 6473 5f73 6861 7065 2c20  nput_ids_shape, 
+00000970: 7061 7374 5f6b 6579 5f76 616c 7565 735f  past_key_values_
+00000980: 6c65 6e67 7468 3a20 696e 7420 3d20 3029  length: int = 0)
+00000990: 3a0a 2020 2020 2020 2020 2222 2260 696e  :.        """`in
+000009a0: 7075 745f 6964 735f 7368 6170 6560 2069  put_ids_shape` i
+000009b0: 7320 6578 7065 6374 6564 2074 6f20 6265  s expected to be
+000009c0: 205b 6273 7a20 7820 7365 716c 656e 5d2e   [bsz x seqlen].
+000009d0: 2222 220a 2020 2020 2020 2020 6273 7a2c  """.        bsz,
+000009e0: 2073 6571 5f6c 656e 203d 2069 6e70 7574   seq_len = input
+000009f0: 5f69 6473 5f73 6861 7065 5b3a 325d 0a20  _ids_shape[:2]. 
+00000a00: 2020 2020 2020 2070 6f73 6974 696f 6e73         positions
+00000a10: 203d 206f 7073 2e61 7261 6e67 6528 0a20   = ops.arange(. 
+00000a20: 2020 2020 2020 2020 2020 2070 6173 745f             past_
+00000a30: 6b65 795f 7661 6c75 6573 5f6c 656e 6774  key_values_lengt
+00000a40: 682c 2070 6173 745f 6b65 795f 7661 6c75  h, past_key_valu
+00000a50: 6573 5f6c 656e 6774 6820 2b20 7365 715f  es_length + seq_
+00000a60: 6c65 6e2c 2064 7479 7065 3d6d 696e 6473  len, dtype=minds
+00000a70: 706f 7265 2e69 6e74 3634 0a20 2020 2020  pore.int64.     
+00000a80: 2020 2029 0a20 2020 2020 2020 2072 6574     ).        ret
+00000a90: 7572 6e20 7375 7065 7228 292e 636f 6e73  urn super().cons
+00000aa0: 7472 7563 7428 706f 7369 7469 6f6e 7329  truct(positions)
+00000ab0: 0a0a 0a23 2043 6f70 6965 6420 6672 6f6d  ...# Copied from
+00000ac0: 2074 7261 6e73 666f 726d 6572 732e 6d6f   transformers.mo
+00000ad0: 6465 6c73 2e62 6172 742e 6d6f 6465 6c69  dels.bart.modeli
+00000ae0: 6e67 5f62 6172 742e 4261 7274 4174 7465  ng_bart.BartAtte
+00000af0: 6e74 696f 6e20 7769 7468 2042 6172 742d  ntion with Bart-
+00000b00: 3e42 6c65 6e64 6572 626f 740a 636c 6173  >Blenderbot.clas
+00000b10: 7320 426c 656e 6465 7262 6f74 4174 7465  s BlenderbotAtte
+00000b20: 6e74 696f 6e28 6e6e 2e43 656c 6c29 3a0a  ntion(nn.Cell):.
+00000b30: 2020 2020 2222 224d 756c 7469 2d68 6561      """Multi-hea
+00000b40: 6465 6420 6174 7465 6e74 696f 6e20 6672  ded attention fr
+00000b50: 6f6d 2027 4174 7465 6e74 696f 6e20 4973  om 'Attention Is
+00000b60: 2041 6c6c 2059 6f75 204e 6565 6427 2070   All You Need' p
+00000b70: 6170 6572 2222 220a 0a20 2020 2064 6566  aper"""..    def
+00000b80: 205f 5f69 6e69 745f 5f28 0a20 2020 2020   __init__(.     
+00000b90: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+00000ba0: 2065 6d62 6564 5f64 696d 3a20 696e 742c   embed_dim: int,
+00000bb0: 0a20 2020 2020 2020 206e 756d 5f68 6561  .        num_hea
+00000bc0: 6473 3a20 696e 742c 0a20 2020 2020 2020  ds: int,.       
+00000bd0: 2064 726f 706f 7574 3a20 666c 6f61 7420   dropout: float 
+00000be0: 3d20 302e 302c 0a20 2020 2020 2020 2069  = 0.0,.        i
+00000bf0: 735f 6465 636f 6465 723a 2062 6f6f 6c20  s_decoder: bool 
+00000c00: 3d20 4661 6c73 652c 0a20 2020 2020 2020  = False,.       
+00000c10: 2062 6961 733a 2062 6f6f 6c20 3d20 5472   bias: bool = Tr
+00000c20: 7565 2c0a 2020 2020 2020 2020 6973 5f63  ue,.        is_c
+00000c30: 6175 7361 6c3a 2062 6f6f 6c20 3d20 4661  ausal: bool = Fa
+00000c40: 6c73 652c 0a20 2020 2020 2020 2063 6f6e  lse,.        con
+00000c50: 6669 673a 204f 7074 696f 6e61 6c5b 426c  fig: Optional[Bl
+00000c60: 656e 6465 7262 6f74 436f 6e66 6967 5d20  enderbotConfig] 
+00000c70: 3d20 4e6f 6e65 2c0a 2020 2020 293a 0a20  = None,.    ):. 
+00000c80: 2020 2020 2020 2073 7570 6572 2829 2e5f         super()._
+00000c90: 5f69 6e69 745f 5f28 290a 2020 2020 2020  _init__().      
+00000ca0: 2020 7365 6c66 2e65 6d62 6564 5f64 696d    self.embed_dim
+00000cb0: 203d 2065 6d62 6564 5f64 696d 0a20 2020   = embed_dim.   
+00000cc0: 2020 2020 2073 656c 662e 6e75 6d5f 6865       self.num_he
+00000cd0: 6164 7320 3d20 6e75 6d5f 6865 6164 730a  ads = num_heads.
+00000ce0: 2020 2020 2020 2020 7365 6c66 2e64 726f          self.dro
+00000cf0: 706f 7574 203d 2064 726f 706f 7574 0a20  pout = dropout. 
+00000d00: 2020 2020 2020 2073 656c 662e 6865 6164         self.head
+00000d10: 5f64 696d 203d 2065 6d62 6564 5f64 696d  _dim = embed_dim
+00000d20: 202f 2f20 6e75 6d5f 6865 6164 730a 2020   // num_heads.  
+00000d30: 2020 2020 2020 7365 6c66 2e63 6f6e 6669        self.confi
+00000d40: 6720 3d20 636f 6e66 6967 0a0a 2020 2020  g = config..    
+00000d50: 2020 2020 6966 2028 7365 6c66 2e68 6561      if (self.hea
+00000d60: 645f 6469 6d20 2a20 6e75 6d5f 6865 6164  d_dim * num_head
+00000d70: 7329 2021 3d20 7365 6c66 2e65 6d62 6564  s) != self.embed
+00000d80: 5f64 696d 3a0a 2020 2020 2020 2020 2020  _dim:.          
+00000d90: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+00000da0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+00000db0: 2020 2020 6622 656d 6265 645f 6469 6d20      f"embed_dim 
+00000dc0: 6d75 7374 2062 6520 6469 7669 7369 626c  must be divisibl
+00000dd0: 6520 6279 206e 756d 5f68 6561 6473 2028  e by num_heads (
+00000de0: 676f 7420 6065 6d62 6564 5f64 696d 603a  got `embed_dim`:
+00000df0: 207b 7365 6c66 2e65 6d62 6564 5f64 696d   {self.embed_dim
+00000e00: 7d22 0a20 2020 2020 2020 2020 2020 2020  }".             
+00000e10: 2020 2066 2220 616e 6420 606e 756d 5f68     f" and `num_h
+00000e20: 6561 6473 603a 207b 6e75 6d5f 6865 6164  eads`: {num_head
+00000e30: 737d 292e 220a 2020 2020 2020 2020 2020  s}).".          
+00000e40: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
+00000e50: 2e73 6361 6c69 6e67 203d 2073 656c 662e  .scaling = self.
+00000e60: 6865 6164 5f64 696d 2a2a 2d30 2e35 0a20  head_dim**-0.5. 
+00000e70: 2020 2020 2020 2073 656c 662e 6973 5f64         self.is_d
+00000e80: 6563 6f64 6572 203d 2069 735f 6465 636f  ecoder = is_deco
+00000e90: 6465 720a 2020 2020 2020 2020 7365 6c66  der.        self
+00000ea0: 2e69 735f 6361 7573 616c 203d 2069 735f  .is_causal = is_
+00000eb0: 6361 7573 616c 0a0a 2020 2020 2020 2020  causal..        
+00000ec0: 7365 6c66 2e6b 5f70 726f 6a20 3d20 6e6e  self.k_proj = nn
+00000ed0: 2e44 656e 7365 2865 6d62 6564 5f64 696d  .Dense(embed_dim
+00000ee0: 2c20 656d 6265 645f 6469 6d2c 2068 6173  , embed_dim, has
+00000ef0: 5f62 6961 733d 6269 6173 290a 2020 2020  _bias=bias).    
+00000f00: 2020 2020 7365 6c66 2e76 5f70 726f 6a20      self.v_proj 
+00000f10: 3d20 6e6e 2e44 656e 7365 2865 6d62 6564  = nn.Dense(embed
+00000f20: 5f64 696d 2c20 656d 6265 645f 6469 6d2c  _dim, embed_dim,
+00000f30: 2068 6173 5f62 6961 733d 6269 6173 290a   has_bias=bias).
+00000f40: 2020 2020 2020 2020 7365 6c66 2e71 5f70          self.q_p
+00000f50: 726f 6a20 3d20 6e6e 2e44 656e 7365 2865  roj = nn.Dense(e
+00000f60: 6d62 6564 5f64 696d 2c20 656d 6265 645f  mbed_dim, embed_
+00000f70: 6469 6d2c 2068 6173 5f62 6961 733d 6269  dim, has_bias=bi
+00000f80: 6173 290a 2020 2020 2020 2020 7365 6c66  as).        self
+00000f90: 2e6f 7574 5f70 726f 6a20 3d20 6e6e 2e44  .out_proj = nn.D
+00000fa0: 656e 7365 2865 6d62 6564 5f64 696d 2c20  ense(embed_dim, 
+00000fb0: 656d 6265 645f 6469 6d2c 2068 6173 5f62  embed_dim, has_b
+00000fc0: 6961 733d 6269 6173 290a 0a20 2020 2064  ias=bias)..    d
+00000fd0: 6566 205f 7368 6170 6528 7365 6c66 2c20  ef _shape(self, 
+00000fe0: 7465 6e73 6f72 3a20 6d69 6e64 7370 6f72  tensor: mindspor
+00000ff0: 652e 5465 6e73 6f72 2c20 7365 715f 6c65  e.Tensor, seq_le
+00001000: 6e3a 2069 6e74 2c20 6273 7a3a 2069 6e74  n: int, bsz: int
+00001010: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+00001020: 6e20 7465 6e73 6f72 2e76 6965 7728 6273  n tensor.view(bs
+00001030: 7a2c 2073 6571 5f6c 656e 2c20 7365 6c66  z, seq_len, self
+00001040: 2e6e 756d 5f68 6561 6473 2c20 7365 6c66  .num_heads, self
+00001050: 2e68 6561 645f 6469 6d29 2e73 7761 7061  .head_dim).swapa
+00001060: 7865 7328 312c 2032 290a 0a20 2020 2064  xes(1, 2)..    d
+00001070: 6566 2063 6f6e 7374 7275 6374 280a 2020  ef construct(.  
+00001080: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+00001090: 2020 2020 6869 6464 656e 5f73 7461 7465      hidden_state
+000010a0: 733a 206d 696e 6473 706f 7265 2e54 656e  s: mindspore.Ten
+000010b0: 736f 722c 0a20 2020 2020 2020 206b 6579  sor,.        key
+000010c0: 5f76 616c 7565 5f73 7461 7465 733a 204f  _value_states: O
+000010d0: 7074 696f 6e61 6c5b 6d69 6e64 7370 6f72  ptional[mindspor
+000010e0: 652e 5465 6e73 6f72 5d20 3d20 4e6f 6e65  e.Tensor] = None
+000010f0: 2c0a 2020 2020 2020 2020 7061 7374 5f6b  ,.        past_k
+00001100: 6579 5f76 616c 7565 3a20 4f70 7469 6f6e  ey_value: Option
+00001110: 616c 5b54 7570 6c65 5b6d 696e 6473 706f  al[Tuple[mindspo
+00001120: 7265 2e54 656e 736f 725d 5d20 3d20 4e6f  re.Tensor]] = No
+00001130: 6e65 2c0a 2020 2020 2020 2020 6174 7465  ne,.        atte
+00001140: 6e74 696f 6e5f 6d61 736b 3a20 4f70 7469  ntion_mask: Opti
+00001150: 6f6e 616c 5b6d 696e 6473 706f 7265 2e54  onal[mindspore.T
+00001160: 656e 736f 725d 203d 204e 6f6e 652c 0a20  ensor] = None,. 
+00001170: 2020 2020 2020 206c 6179 6572 5f68 6561         layer_hea
+00001180: 645f 6d61 736b 3a20 4f70 7469 6f6e 616c  d_mask: Optional
+00001190: 5b6d 696e 6473 706f 7265 2e54 656e 736f  [mindspore.Tenso
+000011a0: 725d 203d 204e 6f6e 652c 0a20 2020 2020  r] = None,.     
+000011b0: 2020 206f 7574 7075 745f 6174 7465 6e74     output_attent
+000011c0: 696f 6e73 3a20 626f 6f6c 203d 2046 616c  ions: bool = Fal
+000011d0: 7365 2c0a 2020 2020 2920 2d3e 2054 7570  se,.    ) -> Tup
+000011e0: 6c65 5b6d 696e 6473 706f 7265 2e54 656e  le[mindspore.Ten
+000011f0: 736f 722c 204f 7074 696f 6e61 6c5b 6d69  sor, Optional[mi
+00001200: 6e64 7370 6f72 652e 5465 6e73 6f72 5d2c  ndspore.Tensor],
+00001210: 204f 7074 696f 6e61 6c5b 5475 706c 655b   Optional[Tuple[
+00001220: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+00001230: 5d5d 5d3a 0a20 2020 2020 2020 2022 2222  ]]]:.        """
+00001240: 496e 7075 7420 7368 6170 653a 2042 6174  Input shape: Bat
+00001250: 6368 2078 2054 696d 6520 7820 4368 616e  ch x Time x Chan
+00001260: 6e65 6c22 2222 0a0a 2020 2020 2020 2020  nel"""..        
+00001270: 2320 6966 206b 6579 5f76 616c 7565 5f73  # if key_value_s
+00001280: 7461 7465 7320 6172 6520 7072 6f76 6964  tates are provid
+00001290: 6564 2074 6869 7320 6c61 7965 7220 6973  ed this layer is
+000012a0: 2075 7365 6420 6173 2061 2063 726f 7373   used as a cross
+000012b0: 2d61 7474 656e 7469 6f6e 206c 6179 6572  -attention layer
+000012c0: 0a20 2020 2020 2020 2023 2066 6f72 2074  .        # for t
+000012d0: 6865 2064 6563 6f64 6572 0a20 2020 2020  he decoder.     
+000012e0: 2020 2069 735f 6372 6f73 735f 6174 7465     is_cross_atte
+000012f0: 6e74 696f 6e20 3d20 6b65 795f 7661 6c75  ntion = key_valu
+00001300: 655f 7374 6174 6573 2069 7320 6e6f 7420  e_states is not 
+00001310: 4e6f 6e65 0a0a 2020 2020 2020 2020 6273  None..        bs
+00001320: 7a2c 2074 6774 5f6c 656e 2c20 5f20 3d20  z, tgt_len, _ = 
+00001330: 6869 6464 656e 5f73 7461 7465 732e 7368  hidden_states.sh
+00001340: 6170 650a 0a20 2020 2020 2020 2023 2067  ape..        # g
+00001350: 6574 2071 7565 7279 2070 726f 6a0a 2020  et query proj.  
+00001360: 2020 2020 2020 7175 6572 795f 7374 6174        query_stat
+00001370: 6573 203d 2073 656c 662e 715f 7072 6f6a  es = self.q_proj
+00001380: 2868 6964 6465 6e5f 7374 6174 6573 2920  (hidden_states) 
+00001390: 2a20 7365 6c66 2e73 6361 6c69 6e67 0a20  * self.scaling. 
+000013a0: 2020 2020 2020 2023 2067 6574 206b 6579         # get key
+000013b0: 2c20 7661 6c75 6520 7072 6f6a 0a20 2020  , value proj.   
+000013c0: 2020 2020 2023 2060 7061 7374 5f6b 6579       # `past_key
+000013d0: 5f76 616c 7565 5b30 5d2e 7368 6170 655b  _value[0].shape[
+000013e0: 325d 203d 3d20 6b65 795f 7661 6c75 655f  2] == key_value_
+000013f0: 7374 6174 6573 2e73 6861 7065 5b31 5d60  states.shape[1]`
+00001400: 0a20 2020 2020 2020 2023 2069 7320 6368  .        # is ch
+00001410: 6563 6b69 6e67 2074 6861 7420 7468 6520  ecking that the 
+00001420: 6073 6571 7565 6e63 655f 6c65 6e67 7468  `sequence_length
+00001430: 6020 6f66 2074 6865 2060 7061 7374 5f6b  ` of the `past_k
+00001440: 6579 5f76 616c 7565 6020 6973 2074 6865  ey_value` is the
+00001450: 2073 616d 6520 6173 0a20 2020 2020 2020   same as.       
+00001460: 2023 2074 6865 2070 726f 7669 6465 6420   # the provided 
+00001470: 606b 6579 5f76 616c 7565 5f73 7461 7465  `key_value_state
+00001480: 7360 2074 6f20 7375 7070 6f72 7420 7072  s` to support pr
+00001490: 6566 6978 2074 756e 696e 670a 2020 2020  efix tuning.    
+000014a0: 2020 2020 6966 2028 0a20 2020 2020 2020      if (.       
+000014b0: 2020 2020 2069 735f 6372 6f73 735f 6174       is_cross_at
+000014c0: 7465 6e74 696f 6e0a 2020 2020 2020 2020  tention.        
+000014d0: 2020 2020 616e 6420 7061 7374 5f6b 6579      and past_key
+000014e0: 5f76 616c 7565 2069 7320 6e6f 7420 4e6f  _value is not No
+000014f0: 6e65 0a20 2020 2020 2020 2020 2020 2061  ne.            a
+00001500: 6e64 2070 6173 745f 6b65 795f 7661 6c75  nd past_key_valu
+00001510: 655b 305d 2e73 6861 7065 5b32 5d20 3d3d  e[0].shape[2] ==
+00001520: 206b 6579 5f76 616c 7565 5f73 7461 7465   key_value_state
+00001530: 732e 7368 6170 655b 315d 0a20 2020 2020  s.shape[1].     
+00001540: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
+00001550: 2020 2320 7265 7573 6520 6b2c 762c 2063    # reuse k,v, c
+00001560: 726f 7373 5f61 7474 656e 7469 6f6e 730a  ross_attentions.
+00001570: 2020 2020 2020 2020 2020 2020 6b65 795f              key_
+00001580: 7374 6174 6573 203d 2070 6173 745f 6b65  states = past_ke
+00001590: 795f 7661 6c75 655b 305d 0a20 2020 2020  y_value[0].     
+000015a0: 2020 2020 2020 2076 616c 7565 5f73 7461         value_sta
+000015b0: 7465 7320 3d20 7061 7374 5f6b 6579 5f76  tes = past_key_v
+000015c0: 616c 7565 5b31 5d0a 2020 2020 2020 2020  alue[1].        
+000015d0: 656c 6966 2069 735f 6372 6f73 735f 6174  elif is_cross_at
+000015e0: 7465 6e74 696f 6e3a 0a20 2020 2020 2020  tention:.       
+000015f0: 2020 2020 2023 2063 726f 7373 5f61 7474       # cross_att
+00001600: 656e 7469 6f6e 730a 2020 2020 2020 2020  entions.        
+00001610: 2020 2020 6b65 795f 7374 6174 6573 203d      key_states =
+00001620: 2073 656c 662e 5f73 6861 7065 2873 656c   self._shape(sel
+00001630: 662e 6b5f 7072 6f6a 286b 6579 5f76 616c  f.k_proj(key_val
+00001640: 7565 5f73 7461 7465 7329 2c20 2d31 2c20  ue_states), -1, 
+00001650: 6273 7a29 0a20 2020 2020 2020 2020 2020  bsz).           
+00001660: 2076 616c 7565 5f73 7461 7465 7320 3d20   value_states = 
+00001670: 7365 6c66 2e5f 7368 6170 6528 7365 6c66  self._shape(self
+00001680: 2e76 5f70 726f 6a28 6b65 795f 7661 6c75  .v_proj(key_valu
+00001690: 655f 7374 6174 6573 292c 202d 312c 2062  e_states), -1, b
+000016a0: 737a 290a 2020 2020 2020 2020 656c 6966  sz).        elif
+000016b0: 2070 6173 745f 6b65 795f 7661 6c75 6520   past_key_value 
+000016c0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+000016d0: 2020 2020 2020 2020 2023 2072 6575 7365           # reuse
+000016e0: 206b 2c20 762c 2073 656c 665f 6174 7465   k, v, self_atte
+000016f0: 6e74 696f 6e0a 2020 2020 2020 2020 2020  ntion.          
+00001700: 2020 6b65 795f 7374 6174 6573 203d 2073    key_states = s
+00001710: 656c 662e 5f73 6861 7065 2873 656c 662e  elf._shape(self.
+00001720: 6b5f 7072 6f6a 2868 6964 6465 6e5f 7374  k_proj(hidden_st
+00001730: 6174 6573 292c 202d 312c 2062 737a 290a  ates), -1, bsz).
+00001740: 2020 2020 2020 2020 2020 2020 7661 6c75              valu
+00001750: 655f 7374 6174 6573 203d 2073 656c 662e  e_states = self.
+00001760: 5f73 6861 7065 2873 656c 662e 765f 7072  _shape(self.v_pr
+00001770: 6f6a 2868 6964 6465 6e5f 7374 6174 6573  oj(hidden_states
+00001780: 292c 202d 312c 2062 737a 290a 2020 2020  ), -1, bsz).    
+00001790: 2020 2020 2020 2020 6b65 795f 7374 6174          key_stat
+000017a0: 6573 203d 206f 7073 2e63 6174 285b 7061  es = ops.cat([pa
+000017b0: 7374 5f6b 6579 5f76 616c 7565 5b30 5d2c  st_key_value[0],
+000017c0: 206b 6579 5f73 7461 7465 735d 2c20 6178   key_states], ax
+000017d0: 6973 3d32 290a 2020 2020 2020 2020 2020  is=2).          
+000017e0: 2020 7661 6c75 655f 7374 6174 6573 203d    value_states =
+000017f0: 206f 7073 2e63 6174 285b 7061 7374 5f6b   ops.cat([past_k
+00001800: 6579 5f76 616c 7565 5b31 5d2c 2076 616c  ey_value[1], val
+00001810: 7565 5f73 7461 7465 735d 2c20 6178 6973  ue_states], axis
+00001820: 3d32 290a 2020 2020 2020 2020 656c 7365  =2).        else
+00001830: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+00001840: 7365 6c66 5f61 7474 656e 7469 6f6e 0a20  self_attention. 
+00001850: 2020 2020 2020 2020 2020 206b 6579 5f73             key_s
+00001860: 7461 7465 7320 3d20 7365 6c66 2e5f 7368  tates = self._sh
+00001870: 6170 6528 7365 6c66 2e6b 5f70 726f 6a28  ape(self.k_proj(
+00001880: 6869 6464 656e 5f73 7461 7465 7329 2c20  hidden_states), 
+00001890: 2d31 2c20 6273 7a29 0a20 2020 2020 2020  -1, bsz).       
+000018a0: 2020 2020 2076 616c 7565 5f73 7461 7465       value_state
+000018b0: 7320 3d20 7365 6c66 2e5f 7368 6170 6528  s = self._shape(
+000018c0: 7365 6c66 2e76 5f70 726f 6a28 6869 6464  self.v_proj(hidd
+000018d0: 656e 5f73 7461 7465 7329 2c20 2d31 2c20  en_states), -1, 
+000018e0: 6273 7a29 0a0a 2020 2020 2020 2020 6966  bsz)..        if
+000018f0: 2073 656c 662e 6973 5f64 6563 6f64 6572   self.is_decoder
+00001900: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+00001910: 6966 2063 726f 7373 5f61 7474 656e 7469  if cross_attenti
+00001920: 6f6e 2073 6176 6520 5475 706c 6528 6d69  on save Tuple(mi
+00001930: 6e64 7370 6f72 652e 5465 6e73 6f72 2c20  ndspore.Tensor, 
+00001940: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+00001950: 2920 6f66 2061 6c6c 2063 726f 7373 2061  ) of all cross a
+00001960: 7474 656e 7469 6f6e 206b 6579 2f76 616c  ttention key/val
+00001970: 7565 5f73 7461 7465 732e 0a20 2020 2020  ue_states..     
+00001980: 2020 2020 2020 2023 2046 7572 7468 6572         # Further
+00001990: 2063 616c 6c73 2074 6f20 6372 6f73 735f   calls to cross_
+000019a0: 6174 7465 6e74 696f 6e20 6c61 7965 7220  attention layer 
+000019b0: 6361 6e20 7468 656e 2072 6575 7365 2061  can then reuse a
+000019c0: 6c6c 2063 726f 7373 2d61 7474 656e 7469  ll cross-attenti
+000019d0: 6f6e 0a20 2020 2020 2020 2020 2020 2023  on.            #
+000019e0: 206b 6579 2f76 616c 7565 5f73 7461 7465   key/value_state
+000019f0: 7320 2866 6972 7374 2022 6966 2220 6361  s (first "if" ca
+00001a00: 7365 290a 2020 2020 2020 2020 2020 2020  se).            
+00001a10: 2320 6966 2075 6e69 2d64 6972 6563 7469  # if uni-directi
+00001a20: 6f6e 616c 2073 656c 662d 6174 7465 6e74  onal self-attent
+00001a30: 696f 6e20 2864 6563 6f64 6572 2920 7361  ion (decoder) sa
+00001a40: 7665 2054 7570 6c65 286d 696e 6473 706f  ve Tuple(mindspo
+00001a50: 7265 2e54 656e 736f 722c 206d 696e 6473  re.Tensor, minds
+00001a60: 706f 7265 2e54 656e 736f 7229 206f 660a  pore.Tensor) of.
+00001a70: 2020 2020 2020 2020 2020 2020 2320 616c              # al
+00001a80: 6c20 7072 6576 696f 7573 2064 6563 6f64  l previous decod
+00001a90: 6572 206b 6579 2f76 616c 7565 5f73 7461  er key/value_sta
+00001aa0: 7465 732e 2046 7572 7468 6572 2063 616c  tes. Further cal
+00001ab0: 6c73 2074 6f20 756e 692d 6469 7265 6374  ls to uni-direct
+00001ac0: 696f 6e61 6c20 7365 6c66 2d61 7474 656e  ional self-atten
+00001ad0: 7469 6f6e 0a20 2020 2020 2020 2020 2020  tion.           
+00001ae0: 2023 2063 616e 2063 6f6e 6361 7420 7072   # can concat pr
+00001af0: 6576 696f 7573 2064 6563 6f64 6572 206b  evious decoder k
+00001b00: 6579 2f76 616c 7565 5f73 7461 7465 7320  ey/value_states 
+00001b10: 746f 2063 7572 7265 6e74 2070 726f 6a65  to current proje
+00001b20: 6374 6564 206b 6579 2f76 616c 7565 5f73  cted key/value_s
+00001b30: 7461 7465 7320 2874 6869 7264 2022 656c  tates (third "el
+00001b40: 6966 2220 6361 7365 290a 2020 2020 2020  if" case).      
+00001b50: 2020 2020 2020 2320 6966 2065 6e63 6f64        # if encod
+00001b60: 6572 2062 692d 6469 7265 6374 696f 6e61  er bi-directiona
+00001b70: 6c20 7365 6c66 2d61 7474 656e 7469 6f6e  l self-attention
+00001b80: 2060 7061 7374 5f6b 6579 5f76 616c 7565   `past_key_value
+00001b90: 6020 6973 2061 6c77 6179 7320 604e 6f6e  ` is always `Non
+00001ba0: 6560 0a20 2020 2020 2020 2020 2020 2070  e`.            p
+00001bb0: 6173 745f 6b65 795f 7661 6c75 6520 3d20  ast_key_value = 
+00001bc0: 286b 6579 5f73 7461 7465 732c 2076 616c  (key_states, val
+00001bd0: 7565 5f73 7461 7465 7329 0a0a 2020 2020  ue_states)..    
+00001be0: 2020 2020 7072 6f6a 5f73 6861 7065 203d      proj_shape =
+00001bf0: 2028 6273 7a20 2a20 7365 6c66 2e6e 756d   (bsz * self.num
+00001c00: 5f68 6561 6473 2c20 2d31 2c20 7365 6c66  _heads, -1, self
+00001c10: 2e68 6561 645f 6469 6d29 0a20 2020 2020  .head_dim).     
+00001c20: 2020 2071 7565 7279 5f73 7461 7465 7320     query_states 
+00001c30: 3d20 7365 6c66 2e5f 7368 6170 6528 7175  = self._shape(qu
+00001c40: 6572 795f 7374 6174 6573 2c20 7467 745f  ery_states, tgt_
+00001c50: 6c65 6e2c 2062 737a 292e 7669 6577 282a  len, bsz).view(*
+00001c60: 7072 6f6a 5f73 6861 7065 290a 2020 2020  proj_shape).    
+00001c70: 2020 2020 6b65 795f 7374 6174 6573 203d      key_states =
+00001c80: 206b 6579 5f73 7461 7465 732e 7265 7368   key_states.resh
+00001c90: 6170 6528 2a70 726f 6a5f 7368 6170 6529  ape(*proj_shape)
+00001ca0: 0a20 2020 2020 2020 2076 616c 7565 5f73  .        value_s
+00001cb0: 7461 7465 7320 3d20 7661 6c75 655f 7374  tates = value_st
+00001cc0: 6174 6573 2e72 6573 6861 7065 282a 7072  ates.reshape(*pr
+00001cd0: 6f6a 5f73 6861 7065 290a 0a20 2020 2020  oj_shape)..     
+00001ce0: 2020 2073 7263 5f6c 656e 203d 206b 6579     src_len = key
+00001cf0: 5f73 7461 7465 732e 7368 6170 655b 315d  _states.shape[1]
+00001d00: 0a20 2020 2020 2020 2061 7474 6e5f 7765  .        attn_we
+00001d10: 6967 6874 7320 3d20 6f70 732e 626d 6d28  ights = ops.bmm(
+00001d20: 7175 6572 795f 7374 6174 6573 2c20 6b65  query_states, ke
+00001d30: 795f 7374 6174 6573 2e73 7761 7061 7865  y_states.swapaxe
+00001d40: 7328 312c 2032 2929 0a0a 2020 2020 2020  s(1, 2))..      
+00001d50: 2020 6966 2061 7474 6e5f 7765 6967 6874    if attn_weight
+00001d60: 732e 7368 6170 6520 213d 2028 6273 7a20  s.shape != (bsz 
+00001d70: 2a20 7365 6c66 2e6e 756d 5f68 6561 6473  * self.num_heads
+00001d80: 2c20 7467 745f 6c65 6e2c 2073 7263 5f6c  , tgt_len, src_l
+00001d90: 656e 293a 0a20 2020 2020 2020 2020 2020  en):.           
+00001da0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+00001db0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+00001dc0: 2020 2066 2241 7474 656e 7469 6f6e 2077     f"Attention w
+00001dd0: 6569 6768 7473 2073 686f 756c 6420 6265  eights should be
+00001de0: 206f 6620 7369 7a65 207b 2862 737a 202a   of size {(bsz *
+00001df0: 2073 656c 662e 6e75 6d5f 6865 6164 732c   self.num_heads,
+00001e00: 2074 6774 5f6c 656e 2c20 7372 635f 6c65   tgt_len, src_le
+00001e10: 6e29 7d2c 2062 7574 2069 7322 0a20 2020  n)}, but is".   
+00001e20: 2020 2020 2020 2020 2020 2020 2066 2220               f" 
+00001e30: 7b61 7474 6e5f 7765 6967 6874 732e 7368  {attn_weights.sh
+00001e40: 6170 657d 220a 2020 2020 2020 2020 2020  ape}".          
+00001e50: 2020 290a 0a20 2020 2020 2020 2069 6620    )..        if 
+00001e60: 6174 7465 6e74 696f 6e5f 6d61 736b 2069  attention_mask i
+00001e70: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00001e80: 2020 2020 2020 2020 6966 2061 7474 656e          if atten
+00001e90: 7469 6f6e 5f6d 6173 6b2e 7368 6170 6520  tion_mask.shape 
+00001ea0: 213d 2028 6273 7a2c 2031 2c20 7467 745f  != (bsz, 1, tgt_
+00001eb0: 6c65 6e2c 2073 7263 5f6c 656e 293a 0a20  len, src_len):. 
+00001ec0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00001ed0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+00001ee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00001ef0: 2020 2020 2066 2241 7474 656e 7469 6f6e       f"Attention
+00001f00: 206d 6173 6b20 7368 6f75 6c64 2062 6520   mask should be 
+00001f10: 6f66 2073 697a 6520 7b28 6273 7a2c 2031  of size {(bsz, 1
+00001f20: 2c20 7467 745f 6c65 6e2c 2073 7263 5f6c  , tgt_len, src_l
+00001f30: 656e 297d 2c20 6275 7420 6973 207b 6174  en)}, but is {at
+00001f40: 7465 6e74 696f 6e5f 6d61 736b 2e73 6861  tention_mask.sha
+00001f50: 7065 7d22 0a20 2020 2020 2020 2020 2020  pe}".           
+00001f60: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00001f70: 2020 2061 7474 6e5f 7765 6967 6874 7320     attn_weights 
+00001f80: 3d20 6174 746e 5f77 6569 6768 7473 2e76  = attn_weights.v
+00001f90: 6965 7728 6273 7a2c 2073 656c 662e 6e75  iew(bsz, self.nu
+00001fa0: 6d5f 6865 6164 732c 2074 6774 5f6c 656e  m_heads, tgt_len
+00001fb0: 2c20 7372 635f 6c65 6e29 202b 2061 7474  , src_len) + att
+00001fc0: 656e 7469 6f6e 5f6d 6173 6b0a 2020 2020  ention_mask.    
+00001fd0: 2020 2020 2020 2020 6174 746e 5f77 6569          attn_wei
+00001fe0: 6768 7473 203d 2061 7474 6e5f 7765 6967  ghts = attn_weig
+00001ff0: 6874 732e 7669 6577 2862 737a 202a 2073  hts.view(bsz * s
+00002000: 656c 662e 6e75 6d5f 6865 6164 732c 2074  elf.num_heads, t
+00002010: 6774 5f6c 656e 2c20 7372 635f 6c65 6e29  gt_len, src_len)
+00002020: 0a0a 2020 2020 2020 2020 6174 746e 5f77  ..        attn_w
+00002030: 6569 6768 7473 203d 206f 7073 2e73 6f66  eights = ops.sof
+00002040: 746d 6178 2861 7474 6e5f 7765 6967 6874  tmax(attn_weight
+00002050: 732c 2061 7869 733d 2d31 290a 0a20 2020  s, axis=-1)..   
+00002060: 2020 2020 2069 6620 6c61 7965 725f 6865       if layer_he
+00002070: 6164 5f6d 6173 6b20 6973 206e 6f74 204e  ad_mask is not N
+00002080: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00002090: 2069 6620 6c61 7965 725f 6865 6164 5f6d   if layer_head_m
+000020a0: 6173 6b2e 7368 6170 6520 213d 2028 7365  ask.shape != (se
+000020b0: 6c66 2e6e 756d 5f68 6561 6473 2c29 3a0a  lf.num_heads,):.
+000020c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000020d0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+000020e0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000020f0: 2020 2020 2020 6622 4865 6164 206d 6173        f"Head mas
+00002100: 6b20 666f 7220 6120 7369 6e67 6c65 206c  k for a single l
+00002110: 6179 6572 2073 686f 756c 6420 6265 206f  ayer should be o
+00002120: 6620 7369 7a65 207b 2873 656c 662e 6e75  f size {(self.nu
+00002130: 6d5f 6865 6164 732c 297d 2c20 6275 7420  m_heads,)}, but 
+00002140: 6973 220a 2020 2020 2020 2020 2020 2020  is".            
+00002150: 2020 2020 2020 2020 6622 207b 6c61 7965          f" {laye
+00002160: 725f 6865 6164 5f6d 6173 6b2e 7368 6170  r_head_mask.shap
+00002170: 657d 220a 2020 2020 2020 2020 2020 2020  e}".            
+00002180: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00002190: 2020 6174 746e 5f77 6569 6768 7473 203d    attn_weights =
+000021a0: 206c 6179 6572 5f68 6561 645f 6d61 736b   layer_head_mask
+000021b0: 2e76 6965 7728 312c 202d 312c 2031 2c20  .view(1, -1, 1, 
+000021c0: 3129 202a 2061 7474 6e5f 7765 6967 6874  1) * attn_weight
+000021d0: 732e 7669 6577 2862 737a 2c20 7365 6c66  s.view(bsz, self
+000021e0: 2e6e 756d 5f68 6561 6473 2c20 7467 745f  .num_heads, tgt_
+000021f0: 6c65 6e2c 2073 7263 5f6c 656e 290a 2020  len, src_len).  
+00002200: 2020 2020 2020 2020 2020 6174 746e 5f77            attn_w
+00002210: 6569 6768 7473 203d 2061 7474 6e5f 7765  eights = attn_we
+00002220: 6967 6874 732e 7669 6577 2862 737a 202a  ights.view(bsz *
+00002230: 2073 656c 662e 6e75 6d5f 6865 6164 732c   self.num_heads,
+00002240: 2074 6774 5f6c 656e 2c20 7372 635f 6c65   tgt_len, src_le
+00002250: 6e29 0a0a 2020 2020 2020 2020 6966 206f  n)..        if o
+00002260: 7574 7075 745f 6174 7465 6e74 696f 6e73  utput_attentions
+00002270: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+00002280: 7468 6973 206f 7065 7261 7469 6f6e 2069  this operation i
+00002290: 7320 6120 6269 7420 6177 6b77 6172 642c  s a bit awkward,
+000022a0: 2062 7574 2069 7427 7320 7265 7175 6972   but it's requir
+000022b0: 6564 2074 6f0a 2020 2020 2020 2020 2020  ed to.          
+000022c0: 2020 2320 6d61 6b65 2073 7572 6520 7468    # make sure th
+000022d0: 6174 2061 7474 6e5f 7765 6967 6874 7320  at attn_weights 
+000022e0: 6b65 6570 7320 6974 7320 6772 6164 6965  keeps its gradie
+000022f0: 6e74 2e0a 2020 2020 2020 2020 2020 2020  nt..            
+00002300: 2320 496e 206f 7264 6572 2074 6f20 646f  # In order to do
+00002310: 2073 6f2c 2061 7474 6e5f 7765 6967 6874   so, attn_weight
+00002320: 7320 6861 7665 2074 6f20 6265 2072 6573  s have to be res
+00002330: 6861 7065 640a 2020 2020 2020 2020 2020  haped.          
+00002340: 2020 2320 7477 6963 6520 616e 6420 6861    # twice and ha
+00002350: 7665 2074 6f20 6265 2072 6575 7365 6420  ve to be reused 
+00002360: 696e 2074 6865 2066 6f6c 6c6f 7769 6e67  in the following
+00002370: 0a20 2020 2020 2020 2020 2020 2061 7474  .            att
+00002380: 6e5f 7765 6967 6874 735f 7265 7368 6170  n_weights_reshap
+00002390: 6564 203d 2061 7474 6e5f 7765 6967 6874  ed = attn_weight
+000023a0: 732e 7669 6577 2862 737a 2c20 7365 6c66  s.view(bsz, self
+000023b0: 2e6e 756d 5f68 6561 6473 2c20 7467 745f  .num_heads, tgt_
+000023c0: 6c65 6e2c 2073 7263 5f6c 656e 290a 2020  len, src_len).  
+000023d0: 2020 2020 2020 2020 2020 6174 746e 5f77            attn_w
+000023e0: 6569 6768 7473 203d 2061 7474 6e5f 7765  eights = attn_we
+000023f0: 6967 6874 735f 7265 7368 6170 6564 2e76  ights_reshaped.v
+00002400: 6965 7728 6273 7a20 2a20 7365 6c66 2e6e  iew(bsz * self.n
+00002410: 756d 5f68 6561 6473 2c20 7467 745f 6c65  um_heads, tgt_le
+00002420: 6e2c 2073 7263 5f6c 656e 290a 2020 2020  n, src_len).    
+00002430: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00002440: 2020 2020 2020 6174 746e 5f77 6569 6768        attn_weigh
+00002450: 7473 5f72 6573 6861 7065 6420 3d20 4e6f  ts_reshaped = No
+00002460: 6e65 0a0a 2020 2020 2020 2020 6174 746e  ne..        attn
+00002470: 5f70 726f 6273 203d 206f 7073 2e64 726f  _probs = ops.dro
+00002480: 706f 7574 2861 7474 6e5f 7765 6967 6874  pout(attn_weight
+00002490: 732c 2070 3d73 656c 662e 6472 6f70 6f75  s, p=self.dropou
+000024a0: 742c 2074 7261 696e 696e 673d 7365 6c66  t, training=self
+000024b0: 2e74 7261 696e 696e 6729 0a0a 2020 2020  .training)..    
+000024c0: 2020 2020 6174 746e 5f6f 7574 7075 7420      attn_output 
+000024d0: 3d20 6f70 732e 626d 6d28 6174 746e 5f70  = ops.bmm(attn_p
+000024e0: 726f 6273 2c20 7661 6c75 655f 7374 6174  robs, value_stat
+000024f0: 6573 290a 0a20 2020 2020 2020 2069 6620  es)..        if 
+00002500: 6174 746e 5f6f 7574 7075 742e 7368 6170  attn_output.shap
+00002510: 6520 213d 2028 6273 7a20 2a20 7365 6c66  e != (bsz * self
+00002520: 2e6e 756d 5f68 6561 6473 2c20 7467 745f  .num_heads, tgt_
+00002530: 6c65 6e2c 2073 656c 662e 6865 6164 5f64  len, self.head_d
+00002540: 696d 293a 0a20 2020 2020 2020 2020 2020  im):.           
+00002550: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+00002560: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+00002570: 2020 2066 2260 6174 746e 5f6f 7574 7075     f"`attn_outpu
+00002580: 7460 2073 686f 756c 6420 6265 206f 6620  t` should be of 
+00002590: 7369 7a65 207b 2862 737a 202a 2073 656c  size {(bsz * sel
+000025a0: 662e 6e75 6d5f 6865 6164 732c 2074 6774  f.num_heads, tgt
+000025b0: 5f6c 656e 2c20 7365 6c66 2e68 6561 645f  _len, self.head_
+000025c0: 6469 6d29 7d2c 2062 7574 2069 7322 0a20  dim)}, but is". 
+000025d0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+000025e0: 2220 7b61 7474 6e5f 6f75 7470 7574 2e73  " {attn_output.s
+000025f0: 6861 7065 7d22 0a20 2020 2020 2020 2020  hape}".         
+00002600: 2020 2029 0a0a 2020 2020 2020 2020 6174     )..        at
+00002610: 746e 5f6f 7574 7075 7420 3d20 6174 746e  tn_output = attn
+00002620: 5f6f 7574 7075 742e 7669 6577 2862 737a  _output.view(bsz
+00002630: 2c20 7365 6c66 2e6e 756d 5f68 6561 6473  , self.num_heads
+00002640: 2c20 7467 745f 6c65 6e2c 2073 656c 662e  , tgt_len, self.
+00002650: 6865 6164 5f64 696d 290a 2020 2020 2020  head_dim).      
+00002660: 2020 6174 746e 5f6f 7574 7075 7420 3d20    attn_output = 
+00002670: 6174 746e 5f6f 7574 7075 742e 7377 6170  attn_output.swap
+00002680: 6178 6573 2831 2c20 3229 0a0a 2020 2020  axes(1, 2)..    
+00002690: 2020 2020 2320 5573 6520 7468 6520 6065      # Use the `e
+000026a0: 6d62 6564 5f64 696d 6020 6672 6f6d 2074  mbed_dim` from t
+000026b0: 6865 2063 6f6e 6669 6720 2873 746f 7265  he config (store
+000026c0: 6420 696e 2074 6865 2063 6c61 7373 2920  d in the class) 
+000026d0: 7261 7468 6572 2074 6861 6e20 6068 6964  rather than `hid
+000026e0: 6465 6e5f 7374 6174 6560 2062 6563 6175  den_state` becau
+000026f0: 7365 2060 6174 746e 5f6f 7574 7075 7460  se `attn_output`
+00002700: 2063 616e 2062 650a 2020 2020 2020 2020   can be.        
+00002710: 2320 7061 7274 6974 696f 6e65 6420 6163  # partitioned ac
+00002720: 726f 7373 2047 5055 7320 7768 656e 2075  ross GPUs when u
+00002730: 7369 6e67 2074 656e 736f 722d 7061 7261  sing tensor-para
+00002740: 6c6c 656c 6973 6d2e 0a20 2020 2020 2020  llelism..       
+00002750: 2061 7474 6e5f 6f75 7470 7574 203d 2061   attn_output = a
+00002760: 7474 6e5f 6f75 7470 7574 2e72 6573 6861  ttn_output.resha
+00002770: 7065 2862 737a 2c20 7467 745f 6c65 6e2c  pe(bsz, tgt_len,
+00002780: 2073 656c 662e 656d 6265 645f 6469 6d29   self.embed_dim)
+00002790: 0a0a 2020 2020 2020 2020 6174 746e 5f6f  ..        attn_o
+000027a0: 7574 7075 7420 3d20 7365 6c66 2e6f 7574  utput = self.out
+000027b0: 5f70 726f 6a28 6174 746e 5f6f 7574 7075  _proj(attn_outpu
+000027c0: 7429 0a0a 2020 2020 2020 2020 7265 7475  t)..        retu
+000027d0: 726e 2061 7474 6e5f 6f75 7470 7574 2c20  rn attn_output, 
+000027e0: 6174 746e 5f77 6569 6768 7473 5f72 6573  attn_weights_res
+000027f0: 6861 7065 642c 2070 6173 745f 6b65 795f  haped, past_key_
+00002800: 7661 6c75 650a 0a0a 424c 454e 4445 5242  value...BLENDERB
+00002810: 4f54 5f41 5454 454e 5449 4f4e 5f43 4c41  OT_ATTENTION_CLA
+00002820: 5353 4553 203d 207b 2265 6167 6572 223a  SSES = {"eager":
+00002830: 2042 6c65 6e64 6572 626f 7441 7474 656e   BlenderbotAtten
+00002840: 7469 6f6e 7d0a 0a0a 2320 436f 7069 6564  tion}...# Copied
+00002850: 2066 726f 6d20 7472 616e 7366 6f72 6d65   from transforme
+00002860: 7273 2e6d 6f64 656c 732e 6d62 6172 742e  rs.models.mbart.
+00002870: 6d6f 6465 6c69 6e67 5f6d 6261 7274 2e4d  modeling_mbart.M
+00002880: 4261 7274 456e 636f 6465 724c 6179 6572  BartEncoderLayer
+00002890: 2077 6974 6820 4d42 6172 742d 3e42 6c65   with MBart->Ble
+000028a0: 6e64 6572 626f 742c 204d 4241 5254 2d3e  nderbot, MBART->
+000028b0: 424c 454e 4445 5242 4f54 0a63 6c61 7373  BLENDERBOT.class
+000028c0: 2042 6c65 6e64 6572 626f 7445 6e63 6f64   BlenderbotEncod
+000028d0: 6572 4c61 7965 7228 6e6e 2e43 656c 6c29  erLayer(nn.Cell)
+000028e0: 3a0a 2020 2020 6465 6620 5f5f 696e 6974  :.    def __init
+000028f0: 5f5f 2873 656c 662c 2063 6f6e 6669 673a  __(self, config:
+00002900: 2042 6c65 6e64 6572 626f 7443 6f6e 6669   BlenderbotConfi
+00002910: 6729 3a0a 2020 2020 2020 2020 7375 7065  g):.        supe
+00002920: 7228 292e 5f5f 696e 6974 5f5f 2829 0a20  r().__init__(). 
+00002930: 2020 2020 2020 2073 656c 662e 656d 6265         self.embe
+00002940: 645f 6469 6d20 3d20 636f 6e66 6967 2e64  d_dim = config.d
+00002950: 5f6d 6f64 656c 0a0a 2020 2020 2020 2020  _model..        
+00002960: 7365 6c66 2e73 656c 665f 6174 746e 203d  self.self_attn =
+00002970: 2042 4c45 4e44 4552 424f 545f 4154 5445   BLENDERBOT_ATTE
+00002980: 4e54 494f 4e5f 434c 4153 5345 535b 2265  NTION_CLASSES["e
+00002990: 6167 6572 225d 280a 2020 2020 2020 2020  ager"](.        
+000029a0: 2020 2020 656d 6265 645f 6469 6d3d 7365      embed_dim=se
+000029b0: 6c66 2e65 6d62 6564 5f64 696d 2c0a 2020  lf.embed_dim,.  
+000029c0: 2020 2020 2020 2020 2020 6e75 6d5f 6865            num_he
+000029d0: 6164 733d 636f 6e66 6967 2e65 6e63 6f64  ads=config.encod
+000029e0: 6572 5f61 7474 656e 7469 6f6e 5f68 6561  er_attention_hea
+000029f0: 6473 2c0a 2020 2020 2020 2020 2020 2020  ds,.            
+00002a00: 6472 6f70 6f75 743d 636f 6e66 6967 2e61  dropout=config.a
+00002a10: 7474 656e 7469 6f6e 5f64 726f 706f 7574  ttention_dropout
+00002a20: 2c0a 2020 2020 2020 2020 2020 2020 636f  ,.            co
+00002a30: 6e66 6967 3d63 6f6e 6669 672c 0a20 2020  nfig=config,.   
+00002a40: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
+00002a50: 656c 662e 7365 6c66 5f61 7474 6e5f 6c61  elf.self_attn_la
+00002a60: 7965 725f 6e6f 726d 203d 206e 6e2e 4c61  yer_norm = nn.La
+00002a70: 7965 724e 6f72 6d28 7365 6c66 2e65 6d62  yerNorm(self.emb
+00002a80: 6564 5f64 696d 290a 2020 2020 2020 2020  ed_dim).        
+00002a90: 7365 6c66 2e64 726f 706f 7574 203d 2063  self.dropout = c
+00002aa0: 6f6e 6669 672e 6472 6f70 6f75 740a 2020  onfig.dropout.  
+00002ab0: 2020 2020 2020 7365 6c66 2e61 6374 6976        self.activ
+00002ac0: 6174 696f 6e5f 666e 203d 2041 4354 3246  ation_fn = ACT2F
+00002ad0: 4e5b 636f 6e66 6967 2e61 6374 6976 6174  N[config.activat
+00002ae0: 696f 6e5f 6675 6e63 7469 6f6e 5d0a 2020  ion_function].  
+00002af0: 2020 2020 2020 7365 6c66 2e61 6374 6976        self.activ
+00002b00: 6174 696f 6e5f 6472 6f70 6f75 7420 3d20  ation_dropout = 
+00002b10: 636f 6e66 6967 2e61 6374 6976 6174 696f  config.activatio
+00002b20: 6e5f 6472 6f70 6f75 740a 2020 2020 2020  n_dropout.      
+00002b30: 2020 7365 6c66 2e66 6331 203d 206e 6e2e    self.fc1 = nn.
+00002b40: 4465 6e73 6528 7365 6c66 2e65 6d62 6564  Dense(self.embed
+00002b50: 5f64 696d 2c20 636f 6e66 6967 2e65 6e63  _dim, config.enc
+00002b60: 6f64 6572 5f66 666e 5f64 696d 290a 2020  oder_ffn_dim).  
+00002b70: 2020 2020 2020 7365 6c66 2e66 6332 203d        self.fc2 =
+00002b80: 206e 6e2e 4465 6e73 6528 636f 6e66 6967   nn.Dense(config
+00002b90: 2e65 6e63 6f64 6572 5f66 666e 5f64 696d  .encoder_ffn_dim
+00002ba0: 2c20 7365 6c66 2e65 6d62 6564 5f64 696d  , self.embed_dim
+00002bb0: 290a 2020 2020 2020 2020 7365 6c66 2e66  ).        self.f
+00002bc0: 696e 616c 5f6c 6179 6572 5f6e 6f72 6d20  inal_layer_norm 
+00002bd0: 3d20 6e6e 2e4c 6179 6572 4e6f 726d 2873  = nn.LayerNorm(s
+00002be0: 656c 662e 656d 6265 645f 6469 6d29 0a0a  elf.embed_dim)..
+00002bf0: 2020 2020 6465 6620 636f 6e73 7472 7563      def construc
+00002c00: 7428 0a20 2020 2020 2020 2073 656c 662c  t(.        self,
+00002c10: 0a20 2020 2020 2020 2068 6964 6465 6e5f  .        hidden_
+00002c20: 7374 6174 6573 3a20 6d69 6e64 7370 6f72  states: mindspor
+00002c30: 652e 5465 6e73 6f72 2c0a 2020 2020 2020  e.Tensor,.      
+00002c40: 2020 6174 7465 6e74 696f 6e5f 6d61 736b    attention_mask
+00002c50: 3a20 6d69 6e64 7370 6f72 652e 5465 6e73  : mindspore.Tens
+00002c60: 6f72 2c0a 2020 2020 2020 2020 6c61 7965  or,.        laye
+00002c70: 725f 6865 6164 5f6d 6173 6b3a 206d 696e  r_head_mask: min
+00002c80: 6473 706f 7265 2e54 656e 736f 722c 0a20  dspore.Tensor,. 
+00002c90: 2020 2020 2020 206f 7574 7075 745f 6174         output_at
+00002ca0: 7465 6e74 696f 6e73 3a20 626f 6f6c 203d  tentions: bool =
+00002cb0: 2046 616c 7365 2c0a 2020 2020 2920 2d3e   False,.    ) ->
+00002cc0: 206d 696e 6473 706f 7265 2e54 656e 736f   mindspore.Tenso
+00002cd0: 723a 0a20 2020 2020 2020 2022 2222 0a20  r:.        """. 
+00002ce0: 2020 2020 2020 2041 7267 733a 0a20 2020         Args:.   
+00002cf0: 2020 2020 2020 2020 2068 6964 6465 6e5f           hidden_
+00002d00: 7374 6174 6573 2028 606d 696e 6473 706f  states (`mindspo
+00002d10: 7265 2e54 656e 736f 7260 293a 2069 6e70  re.Tensor`): inp
+00002d20: 7574 2074 6f20 7468 6520 6c61 7965 7220  ut to the layer 
+00002d30: 6f66 2073 6861 7065 2060 2862 6174 6368  of shape `(batch
+00002d40: 2c20 7365 715f 6c65 6e2c 2065 6d62 6564  , seq_len, embed
+00002d50: 5f64 696d 2960 0a20 2020 2020 2020 2020  _dim)`.         
+00002d60: 2020 2061 7474 656e 7469 6f6e 5f6d 6173     attention_mas
+00002d70: 6b20 2860 6d69 6e64 7370 6f72 652e 5465  k (`mindspore.Te
+00002d80: 6e73 6f72 6029 3a20 6174 7465 6e74 696f  nsor`): attentio
+00002d90: 6e20 6d61 736b 206f 6620 7369 7a65 0a20  n mask of size. 
+00002da0: 2020 2020 2020 2020 2020 2020 2020 2060                 `
+00002db0: 2862 6174 6368 2c20 312c 2074 6774 5f6c  (batch, 1, tgt_l
+00002dc0: 656e 2c20 7372 635f 6c65 6e29 6020 7768  en, src_len)` wh
+00002dd0: 6572 6520 7061 6464 696e 6720 656c 656d  ere padding elem
+00002de0: 656e 7473 2061 7265 2069 6e64 6963 6174  ents are indicat
+00002df0: 6564 2062 7920 7665 7279 206c 6172 6765  ed by very large
+00002e00: 206e 6567 6174 6976 6520 7661 6c75 6573   negative values
+00002e10: 2e0a 2020 2020 2020 2020 2020 2020 6c61  ..            la
+00002e20: 7965 725f 6865 6164 5f6d 6173 6b20 2860  yer_head_mask (`
+00002e30: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+00002e40: 6029 3a20 6d61 736b 2066 6f72 2061 7474  `): mask for att
+00002e50: 656e 7469 6f6e 2068 6561 6473 2069 6e20  ention heads in 
+00002e60: 6120 6769 7665 6e20 6c61 7965 7220 6f66  a given layer of
+00002e70: 2073 697a 650a 2020 2020 2020 2020 2020   size.          
+00002e80: 2020 2020 2020 6028 656e 636f 6465 725f        `(encoder_
+00002e90: 6174 7465 6e74 696f 6e5f 6865 6164 732c  attention_heads,
+00002ea0: 2960 2e0a 2020 2020 2020 2020 2020 2020  )`..            
+00002eb0: 6f75 7470 7574 5f61 7474 656e 7469 6f6e  output_attention
+00002ec0: 7320 2860 626f 6f6c 602c 202a 6f70 7469  s (`bool`, *opti
+00002ed0: 6f6e 616c 2a29 3a0a 2020 2020 2020 2020  onal*):.        
+00002ee0: 2020 2020 2020 2020 5768 6574 6865 7220          Whether 
+00002ef0: 6f72 206e 6f74 2074 6f20 7265 7475 726e  or not to return
+00002f00: 2074 6865 2061 7474 656e 7469 6f6e 7320   the attentions 
+00002f10: 7465 6e73 6f72 7320 6f66 2061 6c6c 2061  tensors of all a
+00002f20: 7474 656e 7469 6f6e 206c 6179 6572 732e  ttention layers.
+00002f30: 2053 6565 2060 6174 7465 6e74 696f 6e73   See `attentions
+00002f40: 6020 756e 6465 720a 2020 2020 2020 2020  ` under.        
+00002f50: 2020 2020 2020 2020 7265 7475 726e 6564          returned
+00002f60: 2074 656e 736f 7273 2066 6f72 206d 6f72   tensors for mor
+00002f70: 6520 6465 7461 696c 2e0a 2020 2020 2020  e detail..      
+00002f80: 2020 2222 220a 2020 2020 2020 2020 7265    """.        re
+00002f90: 7369 6475 616c 203d 2068 6964 6465 6e5f  sidual = hidden_
+00002fa0: 7374 6174 6573 0a20 2020 2020 2020 2068  states.        h
+00002fb0: 6964 6465 6e5f 7374 6174 6573 203d 2073  idden_states = s
+00002fc0: 656c 662e 7365 6c66 5f61 7474 6e5f 6c61  elf.self_attn_la
+00002fd0: 7965 725f 6e6f 726d 2868 6964 6465 6e5f  yer_norm(hidden_
+00002fe0: 7374 6174 6573 290a 2020 2020 2020 2020  states).        
+00002ff0: 6869 6464 656e 5f73 7461 7465 732c 2061  hidden_states, a
+00003000: 7474 6e5f 7765 6967 6874 732c 205f 203d  ttn_weights, _ =
+00003010: 2073 656c 662e 7365 6c66 5f61 7474 6e28   self.self_attn(
+00003020: 0a20 2020 2020 2020 2020 2020 2068 6964  .            hid
+00003030: 6465 6e5f 7374 6174 6573 3d68 6964 6465  den_states=hidde
+00003040: 6e5f 7374 6174 6573 2c0a 2020 2020 2020  n_states,.      
+00003050: 2020 2020 2020 6174 7465 6e74 696f 6e5f        attention_
+00003060: 6d61 736b 3d61 7474 656e 7469 6f6e 5f6d  mask=attention_m
+00003070: 6173 6b2c 0a20 2020 2020 2020 2020 2020  ask,.           
+00003080: 206c 6179 6572 5f68 6561 645f 6d61 736b   layer_head_mask
+00003090: 3d6c 6179 6572 5f68 6561 645f 6d61 736b  =layer_head_mask
+000030a0: 2c0a 2020 2020 2020 2020 2020 2020 6f75  ,.            ou
+000030b0: 7470 7574 5f61 7474 656e 7469 6f6e 733d  tput_attentions=
+000030c0: 6f75 7470 7574 5f61 7474 656e 7469 6f6e  output_attention
+000030d0: 732c 0a20 2020 2020 2020 2029 0a20 2020  s,.        ).   
+000030e0: 2020 2020 2068 6964 6465 6e5f 7374 6174       hidden_stat
+000030f0: 6573 203d 206f 7073 2e64 726f 706f 7574  es = ops.dropout
+00003100: 2868 6964 6465 6e5f 7374 6174 6573 2c20  (hidden_states, 
+00003110: 703d 7365 6c66 2e64 726f 706f 7574 2c20  p=self.dropout, 
+00003120: 7472 6169 6e69 6e67 3d73 656c 662e 7472  training=self.tr
+00003130: 6169 6e69 6e67 290a 2020 2020 2020 2020  aining).        
+00003140: 6869 6464 656e 5f73 7461 7465 7320 3d20  hidden_states = 
+00003150: 7265 7369 6475 616c 202b 2068 6964 6465  residual + hidde
+00003160: 6e5f 7374 6174 6573 0a0a 2020 2020 2020  n_states..      
+00003170: 2020 7265 7369 6475 616c 203d 2068 6964    residual = hid
+00003180: 6465 6e5f 7374 6174 6573 0a20 2020 2020  den_states.     
+00003190: 2020 2068 6964 6465 6e5f 7374 6174 6573     hidden_states
+000031a0: 203d 2073 656c 662e 6669 6e61 6c5f 6c61   = self.final_la
+000031b0: 7965 725f 6e6f 726d 2868 6964 6465 6e5f  yer_norm(hidden_
+000031c0: 7374 6174 6573 290a 2020 2020 2020 2020  states).        
+000031d0: 6869 6464 656e 5f73 7461 7465 7320 3d20  hidden_states = 
+000031e0: 7365 6c66 2e61 6374 6976 6174 696f 6e5f  self.activation_
+000031f0: 666e 2873 656c 662e 6663 3128 6869 6464  fn(self.fc1(hidd
+00003200: 656e 5f73 7461 7465 7329 290a 2020 2020  en_states)).    
+00003210: 2020 2020 6869 6464 656e 5f73 7461 7465      hidden_state
+00003220: 7320 3d20 6f70 732e 6472 6f70 6f75 7428  s = ops.dropout(
+00003230: 6869 6464 656e 5f73 7461 7465 732c 2070  hidden_states, p
+00003240: 3d73 656c 662e 6163 7469 7661 7469 6f6e  =self.activation
+00003250: 5f64 726f 706f 7574 2c20 7472 6169 6e69  _dropout, traini
+00003260: 6e67 3d73 656c 662e 7472 6169 6e69 6e67  ng=self.training
+00003270: 290a 2020 2020 2020 2020 6869 6464 656e  ).        hidden
+00003280: 5f73 7461 7465 7320 3d20 7365 6c66 2e66  _states = self.f
+00003290: 6332 2868 6964 6465 6e5f 7374 6174 6573  c2(hidden_states
+000032a0: 290a 2020 2020 2020 2020 6869 6464 656e  ).        hidden
+000032b0: 5f73 7461 7465 7320 3d20 6f70 732e 6472  _states = ops.dr
+000032c0: 6f70 6f75 7428 6869 6464 656e 5f73 7461  opout(hidden_sta
+000032d0: 7465 732c 2070 3d73 656c 662e 6472 6f70  tes, p=self.drop
+000032e0: 6f75 742c 2074 7261 696e 696e 673d 7365  out, training=se
+000032f0: 6c66 2e74 7261 696e 696e 6729 0a20 2020  lf.training).   
+00003300: 2020 2020 2068 6964 6465 6e5f 7374 6174       hidden_stat
+00003310: 6573 203d 2072 6573 6964 7561 6c20 2b20  es = residual + 
+00003320: 6869 6464 656e 5f73 7461 7465 730a 0a20  hidden_states.. 
+00003330: 2020 2020 2020 2069 6620 6869 6464 656e         if hidden
+00003340: 5f73 7461 7465 732e 6474 7970 6520 3d3d  _states.dtype ==
+00003350: 206d 696e 6473 706f 7265 2e66 6c6f 6174   mindspore.float
+00003360: 3136 2061 6e64 2028 0a20 2020 2020 2020  16 and (.       
+00003370: 2020 2020 206f 7073 2e69 7369 6e66 2868       ops.isinf(h
+00003380: 6964 6465 6e5f 7374 6174 6573 292e 616e  idden_states).an
+00003390: 7928 2920 6f72 206f 7073 2e69 736e 616e  y() or ops.isnan
+000033a0: 2868 6964 6465 6e5f 7374 6174 6573 292e  (hidden_states).
+000033b0: 616e 7928 290a 2020 2020 2020 2020 293a  any().        ):
+000033c0: 0a20 2020 2020 2020 2020 2020 2063 6c61  .            cla
+000033d0: 6d70 5f76 616c 7565 203d 2066 696e 666f  mp_value = finfo
+000033e0: 2868 6964 6465 6e5f 7374 6174 6573 2e64  (hidden_states.d
+000033f0: 7479 7065 2c20 276d 6178 2729 202d 2031  type, 'max') - 1
+00003400: 3030 300a 2020 2020 2020 2020 2020 2020  000.            
+00003410: 6869 6464 656e 5f73 7461 7465 7320 3d20  hidden_states = 
+00003420: 6f70 732e 636c 616d 7028 6869 6464 656e  ops.clamp(hidden
+00003430: 5f73 7461 7465 732c 206d 696e 3d2d 636c  _states, min=-cl
+00003440: 616d 705f 7661 6c75 652c 206d 6178 3d63  amp_value, max=c
+00003450: 6c61 6d70 5f76 616c 7565 290a 0a20 2020  lamp_value)..   
+00003460: 2020 2020 206f 7574 7075 7473 203d 2028       outputs = (
+00003470: 6869 6464 656e 5f73 7461 7465 732c 290a  hidden_states,).
+00003480: 0a20 2020 2020 2020 2069 6620 6f75 7470  .        if outp
+00003490: 7574 5f61 7474 656e 7469 6f6e 733a 0a20  ut_attentions:. 
+000034a0: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
+000034b0: 7473 202b 3d20 2861 7474 6e5f 7765 6967  ts += (attn_weig
+000034c0: 6874 732c 290a 0a20 2020 2020 2020 2072  hts,)..        r
+000034d0: 6574 7572 6e20 6f75 7470 7574 730a 0a0a  eturn outputs...
+000034e0: 2320 436f 7069 6564 2066 726f 6d20 7472  # Copied from tr
+000034f0: 616e 7366 6f72 6d65 7273 2e6d 6f64 656c  ansformers.model
+00003500: 732e 6d62 6172 742e 6d6f 6465 6c69 6e67  s.mbart.modeling
+00003510: 5f6d 6261 7274 2e4d 4261 7274 4465 636f  _mbart.MBartDeco
+00003520: 6465 724c 6179 6572 2077 6974 6820 4d42  derLayer with MB
+00003530: 6172 742d 3e42 6c65 6e64 6572 626f 742c  art->Blenderbot,
+00003540: 204d 4241 5254 2d3e 424c 454e 4445 5242   MBART->BLENDERB
+00003550: 4f54 0a63 6c61 7373 2042 6c65 6e64 6572  OT.class Blender
+00003560: 626f 7444 6563 6f64 6572 4c61 7965 7228  botDecoderLayer(
+00003570: 6e6e 2e43 656c 6c29 3a0a 2020 2020 6465  nn.Cell):.    de
+00003580: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
+00003590: 2063 6f6e 6669 673a 2042 6c65 6e64 6572   config: Blender
+000035a0: 626f 7443 6f6e 6669 6729 3a0a 2020 2020  botConfig):.    
+000035b0: 2020 2020 7375 7065 7228 292e 5f5f 696e      super().__in
+000035c0: 6974 5f5f 2829 0a20 2020 2020 2020 2073  it__().        s
+000035d0: 656c 662e 656d 6265 645f 6469 6d20 3d20  elf.embed_dim = 
+000035e0: 636f 6e66 6967 2e64 5f6d 6f64 656c 0a0a  config.d_model..
+000035f0: 2020 2020 2020 2020 7365 6c66 2e73 656c          self.sel
+00003600: 665f 6174 746e 203d 2042 4c45 4e44 4552  f_attn = BLENDER
+00003610: 424f 545f 4154 5445 4e54 494f 4e5f 434c  BOT_ATTENTION_CL
+00003620: 4153 5345 535b 2265 6167 6572 225d 280a  ASSES["eager"](.
+00003630: 2020 2020 2020 2020 2020 2020 656d 6265              embe
+00003640: 645f 6469 6d3d 7365 6c66 2e65 6d62 6564  d_dim=self.embed
+00003650: 5f64 696d 2c0a 2020 2020 2020 2020 2020  _dim,.          
+00003660: 2020 6e75 6d5f 6865 6164 733d 636f 6e66    num_heads=conf
+00003670: 6967 2e64 6563 6f64 6572 5f61 7474 656e  ig.decoder_atten
+00003680: 7469 6f6e 5f68 6561 6473 2c0a 2020 2020  tion_heads,.    
+00003690: 2020 2020 2020 2020 6472 6f70 6f75 743d          dropout=
+000036a0: 636f 6e66 6967 2e61 7474 656e 7469 6f6e  config.attention
+000036b0: 5f64 726f 706f 7574 2c0a 2020 2020 2020  _dropout,.      
+000036c0: 2020 2020 2020 6973 5f64 6563 6f64 6572        is_decoder
+000036d0: 3d54 7275 652c 0a20 2020 2020 2020 2020  =True,.         
+000036e0: 2020 2069 735f 6361 7573 616c 3d54 7275     is_causal=Tru
+000036f0: 652c 0a20 2020 2020 2020 2020 2020 2063  e,.            c
+00003700: 6f6e 6669 673d 636f 6e66 6967 2c0a 2020  onfig=config,.  
+00003710: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00003720: 7365 6c66 2e64 726f 706f 7574 203d 2063  self.dropout = c
+00003730: 6f6e 6669 672e 6472 6f70 6f75 740a 2020  onfig.dropout.  
+00003740: 2020 2020 2020 7365 6c66 2e61 6374 6976        self.activ
+00003750: 6174 696f 6e5f 666e 203d 2041 4354 3246  ation_fn = ACT2F
+00003760: 4e5b 636f 6e66 6967 2e61 6374 6976 6174  N[config.activat
+00003770: 696f 6e5f 6675 6e63 7469 6f6e 5d0a 2020  ion_function].  
+00003780: 2020 2020 2020 7365 6c66 2e61 6374 6976        self.activ
+00003790: 6174 696f 6e5f 6472 6f70 6f75 7420 3d20  ation_dropout = 
+000037a0: 636f 6e66 6967 2e61 6374 6976 6174 696f  config.activatio
+000037b0: 6e5f 6472 6f70 6f75 740a 0a20 2020 2020  n_dropout..     
+000037c0: 2020 2073 656c 662e 7365 6c66 5f61 7474     self.self_att
+000037d0: 6e5f 6c61 7965 725f 6e6f 726d 203d 206e  n_layer_norm = n
+000037e0: 6e2e 4c61 7965 724e 6f72 6d28 7365 6c66  n.LayerNorm(self
+000037f0: 2e65 6d62 6564 5f64 696d 290a 2020 2020  .embed_dim).    
+00003800: 2020 2020 7365 6c66 2e65 6e63 6f64 6572      self.encoder
+00003810: 5f61 7474 6e20 3d20 424c 454e 4445 5242  _attn = BLENDERB
+00003820: 4f54 5f41 5454 454e 5449 4f4e 5f43 4c41  OT_ATTENTION_CLA
+00003830: 5353 4553 5b22 6561 6765 7222 5d28 0a20  SSES["eager"](. 
+00003840: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00003850: 656d 6265 645f 6469 6d2c 0a20 2020 2020  embed_dim,.     
+00003860: 2020 2020 2020 2063 6f6e 6669 672e 6465         config.de
+00003870: 636f 6465 725f 6174 7465 6e74 696f 6e5f  coder_attention_
+00003880: 6865 6164 732c 0a20 2020 2020 2020 2020  heads,.         
+00003890: 2020 2064 726f 706f 7574 3d63 6f6e 6669     dropout=confi
+000038a0: 672e 6174 7465 6e74 696f 6e5f 6472 6f70  g.attention_drop
+000038b0: 6f75 742c 0a20 2020 2020 2020 2020 2020  out,.           
+000038c0: 2069 735f 6465 636f 6465 723d 5472 7565   is_decoder=True
+000038d0: 2c0a 2020 2020 2020 2020 2020 2020 636f  ,.            co
+000038e0: 6e66 6967 3d63 6f6e 6669 672c 0a20 2020  nfig=config,.   
+000038f0: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
+00003900: 656c 662e 656e 636f 6465 725f 6174 746e  elf.encoder_attn
+00003910: 5f6c 6179 6572 5f6e 6f72 6d20 3d20 6e6e  _layer_norm = nn
+00003920: 2e4c 6179 6572 4e6f 726d 2873 656c 662e  .LayerNorm(self.
+00003930: 656d 6265 645f 6469 6d29 0a20 2020 2020  embed_dim).     
+00003940: 2020 2073 656c 662e 6663 3120 3d20 6e6e     self.fc1 = nn
+00003950: 2e44 656e 7365 2873 656c 662e 656d 6265  .Dense(self.embe
+00003960: 645f 6469 6d2c 2063 6f6e 6669 672e 6465  d_dim, config.de
+00003970: 636f 6465 725f 6666 6e5f 6469 6d29 0a20  coder_ffn_dim). 
+00003980: 2020 2020 2020 2073 656c 662e 6663 3220         self.fc2 
+00003990: 3d20 6e6e 2e44 656e 7365 2863 6f6e 6669  = nn.Dense(confi
+000039a0: 672e 6465 636f 6465 725f 6666 6e5f 6469  g.decoder_ffn_di
+000039b0: 6d2c 2073 656c 662e 656d 6265 645f 6469  m, self.embed_di
+000039c0: 6d29 0a20 2020 2020 2020 2073 656c 662e  m).        self.
+000039d0: 6669 6e61 6c5f 6c61 7965 725f 6e6f 726d  final_layer_norm
+000039e0: 203d 206e 6e2e 4c61 7965 724e 6f72 6d28   = nn.LayerNorm(
+000039f0: 7365 6c66 2e65 6d62 6564 5f64 696d 290a  self.embed_dim).
+00003a00: 0a20 2020 2064 6566 2063 6f6e 7374 7275  .    def constru
+00003a10: 6374 280a 2020 2020 2020 2020 7365 6c66  ct(.        self
+00003a20: 2c0a 2020 2020 2020 2020 6869 6464 656e  ,.        hidden
+00003a30: 5f73 7461 7465 733a 206d 696e 6473 706f  _states: mindspo
+00003a40: 7265 2e54 656e 736f 722c 0a20 2020 2020  re.Tensor,.     
+00003a50: 2020 2061 7474 656e 7469 6f6e 5f6d 6173     attention_mas
+00003a60: 6b3a 204f 7074 696f 6e61 6c5b 6d69 6e64  k: Optional[mind
+00003a70: 7370 6f72 652e 5465 6e73 6f72 5d20 3d20  spore.Tensor] = 
+00003a80: 4e6f 6e65 2c0a 2020 2020 2020 2020 656e  None,.        en
+00003a90: 636f 6465 725f 6869 6464 656e 5f73 7461  coder_hidden_sta
+00003aa0: 7465 733a 204f 7074 696f 6e61 6c5b 6d69  tes: Optional[mi
+00003ab0: 6e64 7370 6f72 652e 5465 6e73 6f72 5d20  ndspore.Tensor] 
+00003ac0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00003ad0: 656e 636f 6465 725f 6174 7465 6e74 696f  encoder_attentio
+00003ae0: 6e5f 6d61 736b 3a20 4f70 7469 6f6e 616c  n_mask: Optional
+00003af0: 5b6d 696e 6473 706f 7265 2e54 656e 736f  [mindspore.Tenso
+00003b00: 725d 203d 204e 6f6e 652c 0a20 2020 2020  r] = None,.     
+00003b10: 2020 206c 6179 6572 5f68 6561 645f 6d61     layer_head_ma
+00003b20: 736b 3a20 4f70 7469 6f6e 616c 5b6d 696e  sk: Optional[min
+00003b30: 6473 706f 7265 2e54 656e 736f 725d 203d  dspore.Tensor] =
+00003b40: 204e 6f6e 652c 0a20 2020 2020 2020 2063   None,.        c
+00003b50: 726f 7373 5f61 7474 6e5f 6c61 7965 725f  ross_attn_layer_
+00003b60: 6865 6164 5f6d 6173 6b3a 204f 7074 696f  head_mask: Optio
+00003b70: 6e61 6c5b 6d69 6e64 7370 6f72 652e 5465  nal[mindspore.Te
+00003b80: 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a 2020  nsor] = None,.  
+00003b90: 2020 2020 2020 7061 7374 5f6b 6579 5f76        past_key_v
+00003ba0: 616c 7565 3a20 4f70 7469 6f6e 616c 5b54  alue: Optional[T
+00003bb0: 7570 6c65 5b6d 696e 6473 706f 7265 2e54  uple[mindspore.T
+00003bc0: 656e 736f 725d 5d20 3d20 4e6f 6e65 2c0a  ensor]] = None,.
+00003bd0: 2020 2020 2020 2020 6f75 7470 7574 5f61          output_a
+00003be0: 7474 656e 7469 6f6e 733a 204f 7074 696f  ttentions: Optio
+00003bf0: 6e61 6c5b 626f 6f6c 5d20 3d20 4661 6c73  nal[bool] = Fals
+00003c00: 652c 0a20 2020 2020 2020 2075 7365 5f63  e,.        use_c
+00003c10: 6163 6865 3a20 4f70 7469 6f6e 616c 5b62  ache: Optional[b
+00003c20: 6f6f 6c5d 203d 2054 7275 652c 0a20 2020  ool] = True,.   
+00003c30: 2029 202d 3e20 6d69 6e64 7370 6f72 652e   ) -> mindspore.
+00003c40: 5465 6e73 6f72 3a0a 2020 2020 2020 2020  Tensor:.        
+00003c50: 2222 220a 2020 2020 2020 2020 4172 6773  """.        Args
+00003c60: 3a0a 2020 2020 2020 2020 2020 2020 6869  :.            hi
+00003c70: 6464 656e 5f73 7461 7465 7320 2860 6d69  dden_states (`mi
+00003c80: 6e64 7370 6f72 652e 5465 6e73 6f72 6029  ndspore.Tensor`)
+00003c90: 3a20 696e 7075 7420 746f 2074 6865 206c  : input to the l
+00003ca0: 6179 6572 206f 6620 7368 6170 6520 6028  ayer of shape `(
+00003cb0: 6261 7463 682c 2073 6571 5f6c 656e 2c20  batch, seq_len, 
+00003cc0: 656d 6265 645f 6469 6d29 600a 2020 2020  embed_dim)`.    
+00003cd0: 2020 2020 2020 2020 6174 7465 6e74 696f          attentio
+00003ce0: 6e5f 6d61 736b 2028 606d 696e 6473 706f  n_mask (`mindspo
+00003cf0: 7265 2e54 656e 736f 7260 293a 2061 7474  re.Tensor`): att
+00003d00: 656e 7469 6f6e 206d 6173 6b20 6f66 2073  ention mask of s
+00003d10: 697a 650a 2020 2020 2020 2020 2020 2020  ize.            
+00003d20: 2020 2020 6028 6261 7463 682c 2031 2c20      `(batch, 1, 
+00003d30: 7467 745f 6c65 6e2c 2073 7263 5f6c 656e  tgt_len, src_len
+00003d40: 2960 2077 6865 7265 2070 6164 6469 6e67  )` where padding
+00003d50: 2065 6c65 6d65 6e74 7320 6172 6520 696e   elements are in
+00003d60: 6469 6361 7465 6420 6279 2076 6572 7920  dicated by very 
+00003d70: 6c61 7267 6520 6e65 6761 7469 7665 2076  large negative v
+00003d80: 616c 7565 732e 0a20 2020 2020 2020 2020  alues..         
+00003d90: 2020 2065 6e63 6f64 6572 5f68 6964 6465     encoder_hidde
+00003da0: 6e5f 7374 6174 6573 2028 606d 696e 6473  n_states (`minds
+00003db0: 706f 7265 2e54 656e 736f 7260 293a 0a20  pore.Tensor`):. 
+00003dc0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00003dd0: 726f 7373 2061 7474 656e 7469 6f6e 2069  ross attention i
+00003de0: 6e70 7574 2074 6f20 7468 6520 6c61 7965  nput to the laye
+00003df0: 7220 6f66 2073 6861 7065 2060 2862 6174  r of shape `(bat
+00003e00: 6368 2c20 7365 715f 6c65 6e2c 2065 6d62  ch, seq_len, emb
+00003e10: 6564 5f64 696d 2960 0a20 2020 2020 2020  ed_dim)`.       
+00003e20: 2020 2020 2065 6e63 6f64 6572 5f61 7474       encoder_att
+00003e30: 656e 7469 6f6e 5f6d 6173 6b20 2860 6d69  ention_mask (`mi
+00003e40: 6e64 7370 6f72 652e 5465 6e73 6f72 6029  ndspore.Tensor`)
+00003e50: 3a20 656e 636f 6465 7220 6174 7465 6e74  : encoder attent
+00003e60: 696f 6e20 6d61 736b 206f 6620 7369 7a65  ion mask of size
+00003e70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003e80: 2060 2862 6174 6368 2c20 312c 2074 6774   `(batch, 1, tgt
+00003e90: 5f6c 656e 2c20 7372 635f 6c65 6e29 6020  _len, src_len)` 
+00003ea0: 7768 6572 6520 7061 6464 696e 6720 656c  where padding el
+00003eb0: 656d 656e 7473 2061 7265 2069 6e64 6963  ements are indic
+00003ec0: 6174 6564 2062 7920 7665 7279 206c 6172  ated by very lar
+00003ed0: 6765 206e 6567 6174 6976 6520 7661 6c75  ge negative valu
+00003ee0: 6573 2e0a 2020 2020 2020 2020 2020 2020  es..            
+00003ef0: 6c61 7965 725f 6865 6164 5f6d 6173 6b20  layer_head_mask 
+00003f00: 2860 6d69 6e64 7370 6f72 652e 5465 6e73  (`mindspore.Tens
+00003f10: 6f72 6029 3a20 6d61 736b 2066 6f72 2061  or`): mask for a
+00003f20: 7474 656e 7469 6f6e 2068 6561 6473 2069  ttention heads i
+00003f30: 6e20 6120 6769 7665 6e20 6c61 7965 7220  n a given layer 
+00003f40: 6f66 2073 697a 650a 2020 2020 2020 2020  of size.        
+00003f50: 2020 2020 2020 2020 6028 656e 636f 6465          `(encode
+00003f60: 725f 6174 7465 6e74 696f 6e5f 6865 6164  r_attention_head
+00003f70: 732c 2960 2e0a 2020 2020 2020 2020 2020  s,)`..          
+00003f80: 2020 6372 6f73 735f 6174 746e 5f6c 6179    cross_attn_lay
+00003f90: 6572 5f68 6561 645f 6d61 736b 2028 606d  er_head_mask (`m
+00003fa0: 696e 6473 706f 7265 2e54 656e 736f 7260  indspore.Tensor`
+00003fb0: 293a 206d 6173 6b20 666f 7220 6372 6f73  ): mask for cros
+00003fc0: 732d 6174 7465 6e74 696f 6e20 6865 6164  s-attention head
+00003fd0: 7320 696e 2061 2067 6976 656e 206c 6179  s in a given lay
+00003fe0: 6572 206f 660a 2020 2020 2020 2020 2020  er of.          
+00003ff0: 2020 2020 2020 7369 7a65 2060 2864 6563        size `(dec
+00004000: 6f64 6572 5f61 7474 656e 7469 6f6e 5f68  oder_attention_h
+00004010: 6561 6473 2c29 602e 0a20 2020 2020 2020  eads,)`..       
+00004020: 2020 2020 2070 6173 745f 6b65 795f 7661       past_key_va
+00004030: 6c75 6520 2860 5475 706c 6528 6d69 6e64  lue (`Tuple(mind
+00004040: 7370 6f72 652e 5465 6e73 6f72 2960 293a  spore.Tensor)`):
+00004050: 2063 6163 6865 6420 7061 7374 206b 6579   cached past key
+00004060: 2061 6e64 2076 616c 7565 2070 726f 6a65   and value proje
+00004070: 6374 696f 6e20 7374 6174 6573 0a20 2020  ction states.   
+00004080: 2020 2020 2020 2020 206f 7574 7075 745f           output_
+00004090: 6174 7465 6e74 696f 6e73 2028 6062 6f6f  attentions (`boo
+000040a0: 6c60 2c20 2a6f 7074 696f 6e61 6c2a 293a  l`, *optional*):
+000040b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000040c0: 2057 6865 7468 6572 206f 7220 6e6f 7420   Whether or not 
+000040d0: 746f 2072 6574 7572 6e20 7468 6520 6174  to return the at
+000040e0: 7465 6e74 696f 6e73 2074 656e 736f 7273  tentions tensors
+000040f0: 206f 6620 616c 6c20 6174 7465 6e74 696f   of all attentio
+00004100: 6e20 6c61 7965 7273 2e20 5365 6520 6061  n layers. See `a
+00004110: 7474 656e 7469 6f6e 7360 2075 6e64 6572  ttentions` under
+00004120: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00004130: 2072 6574 7572 6e65 6420 7465 6e73 6f72   returned tensor
+00004140: 7320 666f 7220 6d6f 7265 2064 6574 6169  s for more detai
+00004150: 6c2e 0a20 2020 2020 2020 2022 2222 0a20  l..        """. 
+00004160: 2020 2020 2020 2072 6573 6964 7561 6c20         residual 
+00004170: 3d20 6869 6464 656e 5f73 7461 7465 730a  = hidden_states.
+00004180: 2020 2020 2020 2020 6869 6464 656e 5f73          hidden_s
+00004190: 7461 7465 7320 3d20 7365 6c66 2e73 656c  tates = self.sel
+000041a0: 665f 6174 746e 5f6c 6179 6572 5f6e 6f72  f_attn_layer_nor
+000041b0: 6d28 6869 6464 656e 5f73 7461 7465 7329  m(hidden_states)
+000041c0: 0a0a 2020 2020 2020 2020 2320 5365 6c66  ..        # Self
+000041d0: 2041 7474 656e 7469 6f6e 0a20 2020 2020   Attention.     
+000041e0: 2020 2023 2064 6563 6f64 6572 2075 6e69     # decoder uni
+000041f0: 2d64 6972 6563 7469 6f6e 616c 2073 656c  -directional sel
+00004200: 662d 6174 7465 6e74 696f 6e20 6361 6368  f-attention cach
+00004210: 6564 206b 6579 2f76 616c 7565 7320 7475  ed key/values tu
+00004220: 706c 6520 6973 2061 7420 706f 7369 7469  ple is at positi
+00004230: 6f6e 7320 312c 320a 2020 2020 2020 2020  ons 1,2.        
+00004240: 7365 6c66 5f61 7474 6e5f 7061 7374 5f6b  self_attn_past_k
+00004250: 6579 5f76 616c 7565 203d 2070 6173 745f  ey_value = past_
+00004260: 6b65 795f 7661 6c75 655b 3a32 5d20 6966  key_value[:2] if
+00004270: 2070 6173 745f 6b65 795f 7661 6c75 6520   past_key_value 
+00004280: 6973 206e 6f74 204e 6f6e 6520 656c 7365  is not None else
+00004290: 204e 6f6e 650a 2020 2020 2020 2020 2320   None.        # 
+000042a0: 6164 6420 7072 6573 656e 7420 7365 6c66  add present self
+000042b0: 2d61 7474 6e20 6361 6368 6520 746f 2070  -attn cache to p
+000042c0: 6f73 6974 696f 6e73 2031 2c32 206f 6620  ositions 1,2 of 
+000042d0: 7072 6573 656e 745f 6b65 795f 7661 6c75  present_key_valu
+000042e0: 6520 7475 706c 650a 2020 2020 2020 2020  e tuple.        
+000042f0: 6869 6464 656e 5f73 7461 7465 732c 2073  hidden_states, s
+00004300: 656c 665f 6174 746e 5f77 6569 6768 7473  elf_attn_weights
+00004310: 2c20 7072 6573 656e 745f 6b65 795f 7661  , present_key_va
+00004320: 6c75 6520 3d20 7365 6c66 2e73 656c 665f  lue = self.self_
+00004330: 6174 746e 280a 2020 2020 2020 2020 2020  attn(.          
+00004340: 2020 6869 6464 656e 5f73 7461 7465 733d    hidden_states=
+00004350: 6869 6464 656e 5f73 7461 7465 732c 0a20  hidden_states,. 
+00004360: 2020 2020 2020 2020 2020 2070 6173 745f             past_
+00004370: 6b65 795f 7661 6c75 653d 7365 6c66 5f61  key_value=self_a
+00004380: 7474 6e5f 7061 7374 5f6b 6579 5f76 616c  ttn_past_key_val
+00004390: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
+000043a0: 6174 7465 6e74 696f 6e5f 6d61 736b 3d61  attention_mask=a
+000043b0: 7474 656e 7469 6f6e 5f6d 6173 6b2c 0a20  ttention_mask,. 
+000043c0: 2020 2020 2020 2020 2020 206c 6179 6572             layer
+000043d0: 5f68 6561 645f 6d61 736b 3d6c 6179 6572  _head_mask=layer
+000043e0: 5f68 6561 645f 6d61 736b 2c0a 2020 2020  _head_mask,.    
+000043f0: 2020 2020 2020 2020 6f75 7470 7574 5f61          output_a
+00004400: 7474 656e 7469 6f6e 733d 6f75 7470 7574  ttentions=output
+00004410: 5f61 7474 656e 7469 6f6e 732c 0a20 2020  _attentions,.   
+00004420: 2020 2020 2029 0a20 2020 2020 2020 2068       ).        h
+00004430: 6964 6465 6e5f 7374 6174 6573 203d 206f  idden_states = o
+00004440: 7073 2e64 726f 706f 7574 2868 6964 6465  ps.dropout(hidde
+00004450: 6e5f 7374 6174 6573 2c20 703d 7365 6c66  n_states, p=self
+00004460: 2e64 726f 706f 7574 2c20 7472 6169 6e69  .dropout, traini
+00004470: 6e67 3d73 656c 662e 7472 6169 6e69 6e67  ng=self.training
+00004480: 290a 2020 2020 2020 2020 6869 6464 656e  ).        hidden
+00004490: 5f73 7461 7465 7320 3d20 7265 7369 6475  _states = residu
+000044a0: 616c 202b 2068 6964 6465 6e5f 7374 6174  al + hidden_stat
+000044b0: 6573 0a0a 2020 2020 2020 2020 2320 4372  es..        # Cr
+000044c0: 6f73 732d 4174 7465 6e74 696f 6e20 426c  oss-Attention Bl
+000044d0: 6f63 6b0a 2020 2020 2020 2020 6372 6f73  ock.        cros
+000044e0: 735f 6174 746e 5f70 7265 7365 6e74 5f6b  s_attn_present_k
+000044f0: 6579 5f76 616c 7565 203d 204e 6f6e 650a  ey_value = None.
+00004500: 2020 2020 2020 2020 6372 6f73 735f 6174          cross_at
+00004510: 746e 5f77 6569 6768 7473 203d 204e 6f6e  tn_weights = Non
+00004520: 650a 2020 2020 2020 2020 6966 2065 6e63  e.        if enc
+00004530: 6f64 6572 5f68 6964 6465 6e5f 7374 6174  oder_hidden_stat
+00004540: 6573 2069 7320 6e6f 7420 4e6f 6e65 3a0a  es is not None:.
+00004550: 2020 2020 2020 2020 2020 2020 7265 7369              resi
+00004560: 6475 616c 203d 2068 6964 6465 6e5f 7374  dual = hidden_st
+00004570: 6174 6573 0a20 2020 2020 2020 2020 2020  ates.           
+00004580: 2068 6964 6465 6e5f 7374 6174 6573 203d   hidden_states =
+00004590: 2073 656c 662e 656e 636f 6465 725f 6174   self.encoder_at
+000045a0: 746e 5f6c 6179 6572 5f6e 6f72 6d28 6869  tn_layer_norm(hi
+000045b0: 6464 656e 5f73 7461 7465 7329 0a0a 2020  dden_states)..  
+000045c0: 2020 2020 2020 2020 2020 2320 6372 6f73            # cros
+000045d0: 735f 6174 746e 2063 6163 6865 6420 6b65  s_attn cached ke
+000045e0: 792f 7661 6c75 6573 2074 7570 6c65 2069  y/values tuple i
+000045f0: 7320 6174 2070 6f73 6974 696f 6e73 2033  s at positions 3
+00004600: 2c34 206f 6620 7072 6573 656e 745f 6b65  ,4 of present_ke
+00004610: 795f 7661 6c75 6520 7475 706c 650a 2020  y_value tuple.  
+00004620: 2020 2020 2020 2020 2020 6372 6f73 735f            cross_
+00004630: 6174 746e 5f70 6173 745f 6b65 795f 7661  attn_past_key_va
+00004640: 6c75 6520 3d20 7061 7374 5f6b 6579 5f76  lue = past_key_v
+00004650: 616c 7565 5b2d 323a 5d20 6966 2070 6173  alue[-2:] if pas
+00004660: 745f 6b65 795f 7661 6c75 6520 6973 206e  t_key_value is n
+00004670: 6f74 204e 6f6e 6520 656c 7365 204e 6f6e  ot None else Non
+00004680: 650a 2020 2020 2020 2020 2020 2020 6869  e.            hi
+00004690: 6464 656e 5f73 7461 7465 732c 2063 726f  dden_states, cro
+000046a0: 7373 5f61 7474 6e5f 7765 6967 6874 732c  ss_attn_weights,
+000046b0: 2063 726f 7373 5f61 7474 6e5f 7072 6573   cross_attn_pres
+000046c0: 656e 745f 6b65 795f 7661 6c75 6520 3d20  ent_key_value = 
+000046d0: 7365 6c66 2e65 6e63 6f64 6572 5f61 7474  self.encoder_att
+000046e0: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
+000046f0: 2020 2068 6964 6465 6e5f 7374 6174 6573     hidden_states
+00004700: 3d68 6964 6465 6e5f 7374 6174 6573 2c0a  =hidden_states,.
+00004710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004720: 6b65 795f 7661 6c75 655f 7374 6174 6573  key_value_states
+00004730: 3d65 6e63 6f64 6572 5f68 6964 6465 6e5f  =encoder_hidden_
+00004740: 7374 6174 6573 2c0a 2020 2020 2020 2020  states,.        
+00004750: 2020 2020 2020 2020 6174 7465 6e74 696f          attentio
+00004760: 6e5f 6d61 736b 3d65 6e63 6f64 6572 5f61  n_mask=encoder_a
+00004770: 7474 656e 7469 6f6e 5f6d 6173 6b2c 0a20  ttention_mask,. 
+00004780: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00004790: 6179 6572 5f68 6561 645f 6d61 736b 3d63  ayer_head_mask=c
+000047a0: 726f 7373 5f61 7474 6e5f 6c61 7965 725f  ross_attn_layer_
+000047b0: 6865 6164 5f6d 6173 6b2c 0a20 2020 2020  head_mask,.     
+000047c0: 2020 2020 2020 2020 2020 2070 6173 745f             past_
+000047d0: 6b65 795f 7661 6c75 653d 6372 6f73 735f  key_value=cross_
+000047e0: 6174 746e 5f70 6173 745f 6b65 795f 7661  attn_past_key_va
+000047f0: 6c75 652c 0a20 2020 2020 2020 2020 2020  lue,.           
+00004800: 2020 2020 206f 7574 7075 745f 6174 7465       output_atte
+00004810: 6e74 696f 6e73 3d6f 7574 7075 745f 6174  ntions=output_at
+00004820: 7465 6e74 696f 6e73 2c0a 2020 2020 2020  tentions,.      
+00004830: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00004840: 2020 2020 6869 6464 656e 5f73 7461 7465      hidden_state
+00004850: 7320 3d20 6f70 732e 6472 6f70 6f75 7428  s = ops.dropout(
+00004860: 6869 6464 656e 5f73 7461 7465 732c 2070  hidden_states, p
+00004870: 3d73 656c 662e 6472 6f70 6f75 742c 2074  =self.dropout, t
+00004880: 7261 696e 696e 673d 7365 6c66 2e74 7261  raining=self.tra
+00004890: 696e 696e 6729 0a20 2020 2020 2020 2020  ining).         
+000048a0: 2020 2068 6964 6465 6e5f 7374 6174 6573     hidden_states
+000048b0: 203d 2072 6573 6964 7561 6c20 2b20 6869   = residual + hi
+000048c0: 6464 656e 5f73 7461 7465 730a 0a20 2020  dden_states..   
+000048d0: 2020 2020 2020 2020 2023 2061 6464 2063           # add c
+000048e0: 726f 7373 2d61 7474 6e20 746f 2070 6f73  ross-attn to pos
+000048f0: 6974 696f 6e73 2033 2c34 206f 6620 7072  itions 3,4 of pr
+00004900: 6573 656e 745f 6b65 795f 7661 6c75 6520  esent_key_value 
+00004910: 7475 706c 650a 2020 2020 2020 2020 2020  tuple.          
+00004920: 2020 7072 6573 656e 745f 6b65 795f 7661    present_key_va
+00004930: 6c75 6520 3d20 7072 6573 656e 745f 6b65  lue = present_ke
+00004940: 795f 7661 6c75 6520 2b20 6372 6f73 735f  y_value + cross_
+00004950: 6174 746e 5f70 7265 7365 6e74 5f6b 6579  attn_present_key
+00004960: 5f76 616c 7565 0a0a 2020 2020 2020 2020  _value..        
+00004970: 2320 4675 6c6c 7920 436f 6e6e 6563 7465  # Fully Connecte
+00004980: 640a 2020 2020 2020 2020 7265 7369 6475  d.        residu
+00004990: 616c 203d 2068 6964 6465 6e5f 7374 6174  al = hidden_stat
+000049a0: 6573 0a20 2020 2020 2020 2068 6964 6465  es.        hidde
+000049b0: 6e5f 7374 6174 6573 203d 2073 656c 662e  n_states = self.
+000049c0: 6669 6e61 6c5f 6c61 7965 725f 6e6f 726d  final_layer_norm
+000049d0: 2868 6964 6465 6e5f 7374 6174 6573 290a  (hidden_states).
+000049e0: 2020 2020 2020 2020 6869 6464 656e 5f73          hidden_s
+000049f0: 7461 7465 7320 3d20 7365 6c66 2e61 6374  tates = self.act
+00004a00: 6976 6174 696f 6e5f 666e 2873 656c 662e  ivation_fn(self.
+00004a10: 6663 3128 6869 6464 656e 5f73 7461 7465  fc1(hidden_state
+00004a20: 7329 290a 2020 2020 2020 2020 6869 6464  s)).        hidd
+00004a30: 656e 5f73 7461 7465 7320 3d20 6f70 732e  en_states = ops.
+00004a40: 6472 6f70 6f75 7428 6869 6464 656e 5f73  dropout(hidden_s
+00004a50: 7461 7465 732c 2070 3d73 656c 662e 6163  tates, p=self.ac
+00004a60: 7469 7661 7469 6f6e 5f64 726f 706f 7574  tivation_dropout
+00004a70: 2c20 7472 6169 6e69 6e67 3d73 656c 662e  , training=self.
+00004a80: 7472 6169 6e69 6e67 290a 2020 2020 2020  training).      
+00004a90: 2020 6869 6464 656e 5f73 7461 7465 7320    hidden_states 
+00004aa0: 3d20 7365 6c66 2e66 6332 2868 6964 6465  = self.fc2(hidde
+00004ab0: 6e5f 7374 6174 6573 290a 2020 2020 2020  n_states).      
+00004ac0: 2020 6869 6464 656e 5f73 7461 7465 7320    hidden_states 
+00004ad0: 3d20 6f70 732e 6472 6f70 6f75 7428 6869  = ops.dropout(hi
+00004ae0: 6464 656e 5f73 7461 7465 732c 2070 3d73  dden_states, p=s
+00004af0: 656c 662e 6472 6f70 6f75 742c 2074 7261  elf.dropout, tra
+00004b00: 696e 696e 673d 7365 6c66 2e74 7261 696e  ining=self.train
+00004b10: 696e 6729 0a20 2020 2020 2020 2068 6964  ing).        hid
+00004b20: 6465 6e5f 7374 6174 6573 203d 2072 6573  den_states = res
+00004b30: 6964 7561 6c20 2b20 6869 6464 656e 5f73  idual + hidden_s
+00004b40: 7461 7465 730a 0a20 2020 2020 2020 206f  tates..        o
+00004b50: 7574 7075 7473 203d 2028 6869 6464 656e  utputs = (hidden
+00004b60: 5f73 7461 7465 732c 290a 0a20 2020 2020  _states,)..     
+00004b70: 2020 2069 6620 6f75 7470 7574 5f61 7474     if output_att
+00004b80: 656e 7469 6f6e 733a 0a20 2020 2020 2020  entions:.       
+00004b90: 2020 2020 206f 7574 7075 7473 202b 3d20       outputs += 
+00004ba0: 2873 656c 665f 6174 746e 5f77 6569 6768  (self_attn_weigh
+00004bb0: 7473 2c20 6372 6f73 735f 6174 746e 5f77  ts, cross_attn_w
+00004bc0: 6569 6768 7473 290a 0a20 2020 2020 2020  eights)..       
+00004bd0: 2069 6620 7573 655f 6361 6368 653a 0a20   if use_cache:. 
+00004be0: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
+00004bf0: 7473 202b 3d20 2870 7265 7365 6e74 5f6b  ts += (present_k
+00004c00: 6579 5f76 616c 7565 2c29 0a0a 2020 2020  ey_value,)..    
+00004c10: 2020 2020 7265 7475 726e 206f 7574 7075      return outpu
+00004c20: 7473 0a0a 0a63 6c61 7373 2042 6c65 6e64  ts...class Blend
+00004c30: 6572 626f 7450 7265 5472 6169 6e65 644d  erbotPreTrainedM
+00004c40: 6f64 656c 2850 7265 5472 6169 6e65 644d  odel(PreTrainedM
+00004c50: 6f64 656c 293a 0a20 2020 2063 6f6e 6669  odel):.    confi
+00004c60: 675f 636c 6173 7320 3d20 426c 656e 6465  g_class = Blende
+00004c70: 7262 6f74 436f 6e66 6967 0a20 2020 2062  rbotConfig.    b
+00004c80: 6173 655f 6d6f 6465 6c5f 7072 6566 6978  ase_model_prefix
+00004c90: 203d 2022 6d6f 6465 6c22 0a20 2020 2073   = "model".    s
+00004ca0: 7570 706f 7274 735f 6772 6164 6965 6e74  upports_gradient
+00004cb0: 5f63 6865 636b 706f 696e 7469 6e67 203d  _checkpointing =
+00004cc0: 2054 7275 650a 0a20 2020 2064 6566 205f   True..    def _
+00004cd0: 696e 6974 5f77 6569 6768 7473 2873 656c  init_weights(sel
+00004ce0: 662c 2063 656c 6c29 3a0a 2020 2020 2020  f, cell):.      
+00004cf0: 2020 2222 2249 6e69 7469 616c 697a 6520    """Initialize 
+00004d00: 7468 6520 7765 6967 6874 7322 2222 0a20  the weights""". 
+00004d10: 2020 2020 2020 2073 7464 203d 2073 656c         std = sel
+00004d20: 662e 636f 6e66 6967 2e69 6e69 745f 7374  f.config.init_st
+00004d30: 640a 2020 2020 2020 2020 6966 2069 7369  d.        if isi
+00004d40: 6e73 7461 6e63 6528 6365 6c6c 2c20 6e6e  nstance(cell, nn
+00004d50: 2e44 656e 7365 293a 0a20 2020 2020 2020  .Dense):.       
+00004d60: 2020 2020 2023 2053 6c69 6768 746c 7920       # Slightly 
+00004d70: 6469 6666 6572 656e 7420 6672 6f6d 2074  different from t
+00004d80: 6865 2054 4620 7665 7273 696f 6e20 7768  he TF version wh
+00004d90: 6963 6820 7573 6573 2074 7275 6e63 6174  ich uses truncat
+00004da0: 6564 5f6e 6f72 6d61 6c20 666f 7220 696e  ed_normal for in
+00004db0: 6974 6961 6c69 7a61 7469 6f6e 0a20 2020  itialization.   
+00004dc0: 2020 2020 2020 2020 2023 2063 6620 6874           # cf ht
+00004dd0: 7470 733a 2f2f 6769 7468 7562 2e63 6f6d  tps://github.com
+00004de0: 2f70 7974 6f72 6368 2f70 7974 6f72 6368  /pytorch/pytorch
+00004df0: 2f70 756c 6c2f 3536 3137 0a20 2020 2020  /pull/5617.     
+00004e00: 2020 2020 2020 2063 656c 6c2e 7765 6967         cell.weig
+00004e10: 6874 2e73 6574 5f64 6174 6128 696e 6974  ht.set_data(init
+00004e20: 6961 6c69 7a65 7228 4e6f 726d 616c 2873  ializer(Normal(s
+00004e30: 7464 292c 0a20 2020 2020 2020 2020 2020  td),.           
+00004e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004e60: 2020 2020 2020 2020 2063 656c 6c2e 7765           cell.we
+00004e70: 6967 6874 2e73 6861 7065 2c20 6365 6c6c  ight.shape, cell
+00004e80: 2e77 6569 6768 742e 6474 7970 6529 290a  .weight.dtype)).
+00004e90: 2020 2020 2020 2020 2020 2020 6966 2063              if c
+00004ea0: 656c 6c2e 6861 735f 6269 6173 3a0a 2020  ell.has_bias:.  
+00004eb0: 2020 2020 2020 2020 2020 2020 2020 6365                ce
+00004ec0: 6c6c 2e62 6961 732e 7365 745f 6461 7461  ll.bias.set_data
+00004ed0: 2869 6e69 7469 616c 697a 6572 2827 7a65  (initializer('ze
+00004ee0: 726f 7327 2c20 6365 6c6c 2e62 6961 732e  ros', cell.bias.
+00004ef0: 7368 6170 652c 2063 656c 6c2e 6269 6173  shape, cell.bias
+00004f00: 2e64 7479 7065 2929 0a20 2020 2020 2020  .dtype)).       
+00004f10: 2065 6c69 6620 6973 696e 7374 616e 6365   elif isinstance
+00004f20: 2863 656c 6c2c 206e 6e2e 456d 6265 6464  (cell, nn.Embedd
+00004f30: 696e 6729 3a0a 2020 2020 2020 2020 2020  ing):.          
+00004f40: 2020 7765 6967 6874 203d 206e 702e 7261    weight = np.ra
+00004f50: 6e64 6f6d 2e6e 6f72 6d61 6c28 302e 302c  ndom.normal(0.0,
+00004f60: 2073 7464 2c20 6365 6c6c 2e77 6569 6768   std, cell.weigh
+00004f70: 742e 7368 6170 6529 0a20 2020 2020 2020  t.shape).       
+00004f80: 2020 2020 2069 6620 6365 6c6c 2e70 6164       if cell.pad
+00004f90: 6469 6e67 5f69 6478 3a0a 2020 2020 2020  ding_idx:.      
+00004fa0: 2020 2020 2020 2020 2020 7765 6967 6874            weight
+00004fb0: 5b63 656c 6c2e 7061 6464 696e 675f 6964  [cell.padding_id
+00004fc0: 785d 203d 2030 0a0a 2020 2020 2020 2020  x] = 0..        
+00004fd0: 2020 2020 6365 6c6c 2e77 6569 6768 742e      cell.weight.
+00004fe0: 7365 745f 6461 7461 2854 656e 736f 7228  set_data(Tensor(
+00004ff0: 7765 6967 6874 2c20 6365 6c6c 2e77 6569  weight, cell.wei
+00005000: 6768 742e 6474 7970 6529 290a 0a20 2020  ght.dtype))..   
+00005010: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
+00005020: 6566 2064 756d 6d79 5f69 6e70 7574 7328  ef dummy_inputs(
+00005030: 7365 6c66 293a 0a20 2020 2020 2020 2070  self):.        p
+00005040: 6164 5f74 6f6b 656e 203d 2073 656c 662e  ad_token = self.
+00005050: 636f 6e66 6967 2e70 6164 5f74 6f6b 656e  config.pad_token
+00005060: 5f69 640a 2020 2020 2020 2020 696e 7075  _id.        inpu
+00005070: 745f 6964 7320 3d20 6d69 6e64 7370 6f72  t_ids = mindspor
+00005080: 652e 7465 6e73 6f72 285b 5b30 2c20 362c  e.tensor([[0, 6,
+00005090: 2031 302c 2034 2c20 325d 2c20 5b30 2c20   10, 4, 2], [0, 
+000050a0: 382c 2031 322c 2032 2c20 7061 645f 746f  8, 12, 2, pad_to
+000050b0: 6b65 6e5d 5d29 0a20 2020 2020 2020 2064  ken]]).        d
+000050c0: 756d 6d79 5f69 6e70 7574 7320 3d20 7b0a  ummy_inputs = {.
+000050d0: 2020 2020 2020 2020 2020 2020 2261 7474              "att
+000050e0: 656e 7469 6f6e 5f6d 6173 6b22 3a20 696e  ention_mask": in
+000050f0: 7075 745f 6964 732e 6e65 2870 6164 5f74  put_ids.ne(pad_t
+00005100: 6f6b 656e 292c 0a20 2020 2020 2020 2020  oken),.         
+00005110: 2020 2022 696e 7075 745f 6964 7322 3a20     "input_ids": 
+00005120: 696e 7075 745f 6964 732c 0a20 2020 2020  input_ids,.     
+00005130: 2020 2020 2020 2022 6465 636f 6465 725f         "decoder_
+00005140: 696e 7075 745f 6964 7322 3a20 696e 7075  input_ids": inpu
+00005150: 745f 6964 732c 0a20 2020 2020 2020 207d  t_ids,.        }
+00005160: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00005170: 6475 6d6d 795f 696e 7075 7473 0a0a 0a63  dummy_inputs...c
+00005180: 6c61 7373 2042 6c65 6e64 6572 626f 7445  lass BlenderbotE
+00005190: 6e63 6f64 6572 2842 6c65 6e64 6572 626f  ncoder(Blenderbo
+000051a0: 7450 7265 5472 6169 6e65 644d 6f64 656c  tPreTrainedModel
+000051b0: 293a 0a20 2020 2022 2222 0a20 2020 2054  ):.    """.    T
+000051c0: 7261 6e73 666f 726d 6572 2065 6e63 6f64  ransformer encod
+000051d0: 6572 2063 6f6e 7369 7374 696e 6720 6f66  er consisting of
+000051e0: 202a 636f 6e66 6967 2e65 6e63 6f64 6572   *config.encoder
+000051f0: 5f6c 6179 6572 732a 2073 656c 6620 6174  _layers* self at
+00005200: 7465 6e74 696f 6e20 6c61 7965 7273 2e20  tention layers. 
+00005210: 4561 6368 206c 6179 6572 2069 7320 610a  Each layer is a.
+00005220: 2020 2020 5b60 426c 656e 6465 7262 6f74      [`Blenderbot
+00005230: 456e 636f 6465 724c 6179 6572 605d 2e0a  EncoderLayer`]..
+00005240: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
+00005250: 2020 2063 6f6e 6669 673a 2042 6c65 6e64     config: Blend
+00005260: 6572 626f 7443 6f6e 6669 670a 2020 2020  erbotConfig.    
+00005270: 2020 2020 656d 6265 645f 746f 6b65 6e73      embed_tokens
+00005280: 2028 6e6e 2e45 6d62 6564 6469 6e67 293a   (nn.Embedding):
+00005290: 206f 7574 7075 7420 656d 6265 6464 696e   output embeddin
+000052a0: 670a 2020 2020 2222 220a 0a20 2020 2064  g.    """..    d
+000052b0: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
+000052c0: 2c20 636f 6e66 6967 3a20 426c 656e 6465  , config: Blende
+000052d0: 7262 6f74 436f 6e66 6967 2c20 656d 6265  rbotConfig, embe
+000052e0: 645f 746f 6b65 6e73 3a20 4f70 7469 6f6e  d_tokens: Option
+000052f0: 616c 5b6e 6e2e 456d 6265 6464 696e 675d  al[nn.Embedding]
+00005300: 203d 204e 6f6e 6529 3a0a 2020 2020 2020   = None):.      
+00005310: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
+00005320: 5f5f 2863 6f6e 6669 6729 0a0a 2020 2020  __(config)..    
+00005330: 2020 2020 7365 6c66 2e64 726f 706f 7574      self.dropout
+00005340: 203d 2063 6f6e 6669 672e 6472 6f70 6f75   = config.dropou
+00005350: 740a 2020 2020 2020 2020 7365 6c66 2e6c  t.        self.l
+00005360: 6179 6572 6472 6f70 203d 2063 6f6e 6669  ayerdrop = confi
+00005370: 672e 656e 636f 6465 725f 6c61 7965 7264  g.encoder_layerd
+00005380: 726f 700a 0a20 2020 2020 2020 2065 6d62  rop..        emb
+00005390: 6564 5f64 696d 203d 2063 6f6e 6669 672e  ed_dim = config.
+000053a0: 645f 6d6f 6465 6c0a 2020 2020 2020 2020  d_model.        
+000053b0: 7365 6c66 2e70 6164 6469 6e67 5f69 6478  self.padding_idx
+000053c0: 203d 2063 6f6e 6669 672e 7061 645f 746f   = config.pad_to
+000053d0: 6b65 6e5f 6964 0a20 2020 2020 2020 2073  ken_id.        s
+000053e0: 656c 662e 6d61 785f 736f 7572 6365 5f70  elf.max_source_p
+000053f0: 6f73 6974 696f 6e73 203d 2063 6f6e 6669  ositions = confi
+00005400: 672e 6d61 785f 706f 7369 7469 6f6e 5f65  g.max_position_e
+00005410: 6d62 6564 6469 6e67 730a 2020 2020 2020  mbeddings.      
+00005420: 2020 7365 6c66 2e65 6d62 6564 5f73 6361    self.embed_sca
+00005430: 6c65 203d 206d 6174 682e 7371 7274 2865  le = math.sqrt(e
+00005440: 6d62 6564 5f64 696d 2920 6966 2063 6f6e  mbed_dim) if con
+00005450: 6669 672e 7363 616c 655f 656d 6265 6464  fig.scale_embedd
+00005460: 696e 6720 656c 7365 2031 2e30 0a0a 2020  ing else 1.0..  
+00005470: 2020 2020 2020 6966 2065 6d62 6564 5f74        if embed_t
+00005480: 6f6b 656e 7320 6973 206e 6f74 204e 6f6e  okens is not Non
+00005490: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
+000054a0: 656c 662e 656d 6265 645f 746f 6b65 6e73  elf.embed_tokens
+000054b0: 203d 2065 6d62 6564 5f74 6f6b 656e 730a   = embed_tokens.
+000054c0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+000054d0: 2020 2020 2020 2020 2020 7365 6c66 2e65            self.e
+000054e0: 6d62 6564 5f74 6f6b 656e 7320 3d20 6e6e  mbed_tokens = nn
+000054f0: 2e45 6d62 6564 6469 6e67 2863 6f6e 6669  .Embedding(confi
+00005500: 672e 766f 6361 625f 7369 7a65 2c20 656d  g.vocab_size, em
+00005510: 6265 645f 6469 6d2c 2073 656c 662e 7061  bed_dim, self.pa
+00005520: 6464 696e 675f 6964 7829 0a0a 2020 2020  dding_idx)..    
+00005530: 2020 2020 7365 6c66 2e65 6d62 6564 5f70      self.embed_p
+00005540: 6f73 6974 696f 6e73 203d 2042 6c65 6e64  ositions = Blend
+00005550: 6572 626f 744c 6561 726e 6564 506f 7369  erbotLearnedPosi
+00005560: 7469 6f6e 616c 456d 6265 6464 696e 6728  tionalEmbedding(
+00005570: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+00005580: 6669 672e 6d61 785f 706f 7369 7469 6f6e  fig.max_position
+00005590: 5f65 6d62 6564 6469 6e67 732c 0a20 2020  _embeddings,.   
+000055a0: 2020 2020 2020 2020 2065 6d62 6564 5f64           embed_d
+000055b0: 696d 2c0a 2020 2020 2020 2020 290a 2020  im,.        ).  
+000055c0: 2020 2020 2020 7365 6c66 2e6c 6179 6572        self.layer
+000055d0: 7320 3d20 6e6e 2e43 656c 6c4c 6973 7428  s = nn.CellList(
+000055e0: 5b42 6c65 6e64 6572 626f 7445 6e63 6f64  [BlenderbotEncod
+000055f0: 6572 4c61 7965 7228 636f 6e66 6967 2920  erLayer(config) 
+00005600: 666f 7220 5f20 696e 2072 616e 6765 2863  for _ in range(c
+00005610: 6f6e 6669 672e 656e 636f 6465 725f 6c61  onfig.encoder_la
+00005620: 7965 7273 295d 290a 2020 2020 2020 2020  yers)]).        
+00005630: 7365 6c66 2e6c 6179 6572 5f6e 6f72 6d20  self.layer_norm 
+00005640: 3d20 6e6e 2e4c 6179 6572 4e6f 726d 2863  = nn.LayerNorm(c
+00005650: 6f6e 6669 672e 645f 6d6f 6465 6c29 0a0a  onfig.d_model)..
+00005660: 2020 2020 2020 2020 7365 6c66 2e67 7261          self.gra
+00005670: 6469 656e 745f 6368 6563 6b70 6f69 6e74  dient_checkpoint
+00005680: 696e 6720 3d20 4661 6c73 650a 2020 2020  ing = False.    
+00005690: 2020 2020 2320 496e 6974 6961 6c69 7a65      # Initialize
+000056a0: 2077 6569 6768 7473 2061 6e64 2061 7070   weights and app
+000056b0: 6c79 2066 696e 616c 2070 726f 6365 7373  ly final process
+000056c0: 696e 670a 2020 2020 2020 2020 7365 6c66  ing.        self
+000056d0: 2e70 6f73 745f 696e 6974 2829 0a0a 2020  .post_init()..  
+000056e0: 2020 6465 6620 636f 6e73 7472 7563 7428    def construct(
+000056f0: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+00005700: 2020 2020 2020 2069 6e70 7574 5f69 6473         input_ids
+00005710: 3d4e 6f6e 652c 0a20 2020 2020 2020 2061  =None,.        a
+00005720: 7474 656e 7469 6f6e 5f6d 6173 6b3d 4e6f  ttention_mask=No
+00005730: 6e65 2c0a 2020 2020 2020 2020 6865 6164  ne,.        head
+00005740: 5f6d 6173 6b3d 4e6f 6e65 2c0a 2020 2020  _mask=None,.    
+00005750: 2020 2020 696e 7075 7473 5f65 6d62 6564      inputs_embed
+00005760: 733d 4e6f 6e65 2c0a 2020 2020 2020 2020  s=None,.        
+00005770: 6f75 7470 7574 5f61 7474 656e 7469 6f6e  output_attention
+00005780: 733d 4e6f 6e65 2c0a 2020 2020 2020 2020  s=None,.        
+00005790: 6f75 7470 7574 5f68 6964 6465 6e5f 7374  output_hidden_st
+000057a0: 6174 6573 3d4e 6f6e 652c 0a20 2020 2020  ates=None,.     
+000057b0: 2020 2072 6574 7572 6e5f 6469 6374 3d4e     return_dict=N
+000057c0: 6f6e 652c 0a20 2020 2029 3a0a 2020 2020  one,.    ):.    
+000057d0: 2020 2020 7222 2222 0a20 2020 2020 2020      r""".       
+000057e0: 2041 7267 733a 0a20 2020 2020 2020 2020   Args:.         
+000057f0: 2020 2069 6e70 7574 5f69 6473 2028 606d     input_ids (`m
+00005800: 696e 6473 706f 7265 2e54 656e 736f 7260  indspore.Tensor`
+00005810: 206f 6620 7368 6170 6520 6028 6261 7463   of shape `(batc
+00005820: 685f 7369 7a65 2c20 7365 7175 656e 6365  h_size, sequence
+00005830: 5f6c 656e 6774 6829 6029 3a0a 2020 2020  _length)`):.    
+00005840: 2020 2020 2020 2020 2020 2020 496e 6469              Indi
+00005850: 6365 7320 6f66 2069 6e70 7574 2073 6571  ces of input seq
+00005860: 7565 6e63 6520 746f 6b65 6e73 2069 6e20  uence tokens in 
+00005870: 7468 6520 766f 6361 6275 6c61 7279 2e20  the vocabulary. 
+00005880: 5061 6464 696e 6720 7769 6c6c 2062 6520  Padding will be 
+00005890: 6967 6e6f 7265 6420 6279 2064 6566 6175  ignored by defau
+000058a0: 6c74 2073 686f 756c 6420 796f 750a 2020  lt should you.  
+000058b0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+000058c0: 6f76 6964 6520 6974 2e0a 0a20 2020 2020  ovide it...     
+000058d0: 2020 2020 2020 2020 2020 2049 6e64 6963             Indic
+000058e0: 6573 2063 616e 2062 6520 6f62 7461 696e  es can be obtain
+000058f0: 6564 2075 7369 6e67 205b 6041 7574 6f54  ed using [`AutoT
+00005900: 6f6b 656e 697a 6572 605d 2e20 5365 6520  okenizer`]. See 
+00005910: 5b60 5072 6554 7261 696e 6564 546f 6b65  [`PreTrainedToke
+00005920: 6e69 7a65 722e 656e 636f 6465 605d 2061  nizer.encode`] a
+00005930: 6e64 0a20 2020 2020 2020 2020 2020 2020  nd.             
+00005940: 2020 205b 6050 7265 5472 6169 6e65 6454     [`PreTrainedT
+00005950: 6f6b 656e 697a 6572 2e5f 5f63 616c 6c5f  okenizer.__call_
+00005960: 5f60 5d20 666f 7220 6465 7461 696c 732e  _`] for details.
+00005970: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00005980: 2020 5b57 6861 7420 6172 6520 696e 7075    [What are inpu
+00005990: 7420 4944 733f 5d28 2e2e 2f67 6c6f 7373  t IDs?](../gloss
+000059a0: 6172 7923 696e 7075 742d 6964 7329 0a20  ary#input-ids). 
+000059b0: 2020 2020 2020 2020 2020 2061 7474 656e             atten
+000059c0: 7469 6f6e 5f6d 6173 6b20 2860 6d69 6e64  tion_mask (`mind
+000059d0: 7370 6f72 652e 5465 6e73 6f72 6020 6f66  spore.Tensor` of
+000059e0: 2073 6861 7065 2060 2862 6174 6368 5f73   shape `(batch_s
+000059f0: 697a 652c 2073 6571 7565 6e63 655f 6c65  ize, sequence_le
+00005a00: 6e67 7468 2960 2c20 2a6f 7074 696f 6e61  ngth)`, *optiona
+00005a10: 6c2a 293a 0a20 2020 2020 2020 2020 2020  l*):.           
+00005a20: 2020 2020 204d 6173 6b20 746f 2061 766f       Mask to avo
+00005a30: 6964 2070 6572 666f 726d 696e 6720 6174  id performing at
+00005a40: 7465 6e74 696f 6e20 6f6e 2070 6164 6469  tention on paddi
+00005a50: 6e67 2074 6f6b 656e 2069 6e64 6963 6573  ng token indices
+00005a60: 2e20 4d61 736b 2076 616c 7565 7320 7365  . Mask values se
+00005a70: 6c65 6374 6564 2069 6e20 605b 302c 2031  lected in `[0, 1
+00005a80: 5d60 3a0a 0a20 2020 2020 2020 2020 2020  ]`:..           
+00005a90: 2020 2020 202d 2031 2066 6f72 2074 6f6b       - 1 for tok
+00005aa0: 656e 7320 7468 6174 2061 7265 202a 2a6e  ens that are **n
+00005ab0: 6f74 206d 6173 6b65 642a 2a2c 0a20 2020  ot masked**,.   
+00005ac0: 2020 2020 2020 2020 2020 2020 202d 2030               - 0
+00005ad0: 2066 6f72 2074 6f6b 656e 7320 7468 6174   for tokens that
+00005ae0: 2061 7265 202a 2a6d 6173 6b65 642a 2a2e   are **masked**.
+00005af0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00005b00: 2020 5b57 6861 7420 6172 6520 6174 7465    [What are atte
+00005b10: 6e74 696f 6e20 6d61 736b 733f 5d28 2e2e  ntion masks?](..
+00005b20: 2f67 6c6f 7373 6172 7923 6174 7465 6e74  /glossary#attent
+00005b30: 696f 6e2d 6d61 736b 290a 2020 2020 2020  ion-mask).      
+00005b40: 2020 2020 2020 6865 6164 5f6d 6173 6b20        head_mask 
+00005b50: 2860 6d69 6e64 7370 6f72 652e 5465 6e73  (`mindspore.Tens
+00005b60: 6f72 6020 6f66 2073 6861 7065 2060 2865  or` of shape `(e
+00005b70: 6e63 6f64 6572 5f6c 6179 6572 732c 2065  ncoder_layers, e
+00005b80: 6e63 6f64 6572 5f61 7474 656e 7469 6f6e  ncoder_attention
+00005b90: 5f68 6561 6473 2960 2c20 2a6f 7074 696f  _heads)`, *optio
+00005ba0: 6e61 6c2a 293a 0a20 2020 2020 2020 2020  nal*):.         
+00005bb0: 2020 2020 2020 204d 6173 6b20 746f 206e         Mask to n
+00005bc0: 756c 6c69 6679 2073 656c 6563 7465 6420  ullify selected 
+00005bd0: 6865 6164 7320 6f66 2074 6865 2061 7474  heads of the att
+00005be0: 656e 7469 6f6e 206d 6f64 756c 6573 2e20  ention modules. 
+00005bf0: 4d61 736b 2076 616c 7565 7320 7365 6c65  Mask values sele
+00005c00: 6374 6564 2069 6e20 605b 302c 2031 5d60  cted in `[0, 1]`
+00005c10: 3a0a 0a20 2020 2020 2020 2020 2020 2020  :..             
+00005c20: 2020 202d 2031 2069 6e64 6963 6174 6573     - 1 indicates
+00005c30: 2074 6865 2068 6561 6420 6973 202a 2a6e   the head is **n
+00005c40: 6f74 206d 6173 6b65 642a 2a2c 0a20 2020  ot masked**,.   
+00005c50: 2020 2020 2020 2020 2020 2020 202d 2030               - 0
+00005c60: 2069 6e64 6963 6174 6573 2074 6865 2068   indicates the h
+00005c70: 6561 6420 6973 202a 2a6d 6173 6b65 642a  ead is **masked*
+00005c80: 2a2e 0a0a 2020 2020 2020 2020 2020 2020  *...            
+00005c90: 696e 7075 7473 5f65 6d62 6564 7320 2860  inputs_embeds (`
+00005ca0: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+00005cb0: 6020 6f66 2073 6861 7065 2060 2862 6174  ` of shape `(bat
+00005cc0: 6368 5f73 697a 652c 2073 6571 7565 6e63  ch_size, sequenc
+00005cd0: 655f 6c65 6e67 7468 2c20 6869 6464 656e  e_length, hidden
+00005ce0: 5f73 697a 6529 602c 202a 6f70 7469 6f6e  _size)`, *option
+00005cf0: 616c 2a29 3a0a 2020 2020 2020 2020 2020  al*):.          
+00005d00: 2020 2020 2020 4f70 7469 6f6e 616c 6c79        Optionally
+00005d10: 2c20 696e 7374 6561 6420 6f66 2070 6173  , instead of pas
+00005d20: 7369 6e67 2060 696e 7075 745f 6964 7360  sing `input_ids`
+00005d30: 2079 6f75 2063 616e 2063 686f 6f73 6520   you can choose 
+00005d40: 746f 2064 6972 6563 746c 7920 7061 7373  to directly pass
+00005d50: 2061 6e20 656d 6265 6464 6564 2072 6570   an embedded rep
+00005d60: 7265 7365 6e74 6174 696f 6e2e 0a20 2020  resentation..   
+00005d70: 2020 2020 2020 2020 2020 2020 2054 6869               Thi
+00005d80: 7320 6973 2075 7365 6675 6c20 6966 2079  s is useful if y
+00005d90: 6f75 2077 616e 7420 6d6f 7265 2063 6f6e  ou want more con
+00005da0: 7472 6f6c 206f 7665 7220 686f 7720 746f  trol over how to
+00005db0: 2063 6f6e 7665 7274 2060 696e 7075 745f   convert `input_
+00005dc0: 6964 7360 2069 6e64 6963 6573 2069 6e74  ids` indices int
+00005dd0: 6f20 6173 736f 6369 6174 6564 2076 6563  o associated vec
+00005de0: 746f 7273 0a20 2020 2020 2020 2020 2020  tors.           
+00005df0: 2020 2020 2074 6861 6e20 7468 6520 6d6f       than the mo
+00005e00: 6465 6c27 7320 696e 7465 726e 616c 2065  del's internal e
+00005e10: 6d62 6564 6469 6e67 206c 6f6f 6b75 7020  mbedding lookup 
+00005e20: 6d61 7472 6978 2e0a 2020 2020 2020 2020  matrix..        
+00005e30: 2020 2020 6f75 7470 7574 5f61 7474 656e      output_atten
+00005e40: 7469 6f6e 7320 2860 626f 6f6c 602c 202a  tions (`bool`, *
+00005e50: 6f70 7469 6f6e 616c 2a29 3a0a 2020 2020  optional*):.    
+00005e60: 2020 2020 2020 2020 2020 2020 5768 6574              Whet
+00005e70: 6865 7220 6f72 206e 6f74 2074 6f20 7265  her or not to re
+00005e80: 7475 726e 2074 6865 2061 7474 656e 7469  turn the attenti
+00005e90: 6f6e 7320 7465 6e73 6f72 7320 6f66 2061  ons tensors of a
+00005ea0: 6c6c 2061 7474 656e 7469 6f6e 206c 6179  ll attention lay
+00005eb0: 6572 732e 2053 6565 2060 6174 7465 6e74  ers. See `attent
+00005ec0: 696f 6e73 6020 756e 6465 720a 2020 2020  ions` under.    
+00005ed0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00005ee0: 726e 6564 2074 656e 736f 7273 2066 6f72  rned tensors for
+00005ef0: 206d 6f72 6520 6465 7461 696c 2e0a 2020   more detail..  
+00005f00: 2020 2020 2020 2020 2020 6f75 7470 7574            output
+00005f10: 5f68 6964 6465 6e5f 7374 6174 6573 2028  _hidden_states (
+00005f20: 6062 6f6f 6c60 2c20 2a6f 7074 696f 6e61  `bool`, *optiona
+00005f30: 6c2a 293a 0a20 2020 2020 2020 2020 2020  l*):.           
+00005f40: 2020 2020 2057 6865 7468 6572 206f 7220       Whether or 
+00005f50: 6e6f 7420 746f 2072 6574 7572 6e20 7468  not to return th
+00005f60: 6520 6869 6464 656e 2073 7461 7465 7320  e hidden states 
+00005f70: 6f66 2061 6c6c 206c 6179 6572 732e 2053  of all layers. S
+00005f80: 6565 2060 6869 6464 656e 5f73 7461 7465  ee `hidden_state
+00005f90: 7360 2075 6e64 6572 2072 6574 7572 6e65  s` under returne
+00005fa0: 6420 7465 6e73 6f72 730a 2020 2020 2020  d tensors.      
+00005fb0: 2020 2020 2020 2020 2020 666f 7220 6d6f            for mo
+00005fc0: 7265 2064 6574 6169 6c2e 0a20 2020 2020  re detail..     
+00005fd0: 2020 2020 2020 2072 6574 7572 6e5f 6469         return_di
+00005fe0: 6374 2028 6062 6f6f 6c60 2c20 2a6f 7074  ct (`bool`, *opt
+00005ff0: 696f 6e61 6c2a 293a 0a20 2020 2020 2020  ional*):.       
+00006000: 2020 2020 2020 2020 2057 6865 7468 6572           Whether
+00006010: 206f 7220 6e6f 7420 746f 2072 6574 7572   or not to retur
+00006020: 6e20 6120 5b60 7e75 7469 6c73 2e4d 6f64  n a [`~utils.Mod
+00006030: 656c 4f75 7470 7574 605d 2069 6e73 7465  elOutput`] inste
+00006040: 6164 206f 6620 6120 706c 6169 6e20 7475  ad of a plain tu
+00006050: 706c 652e 0a20 2020 2020 2020 2022 2222  ple..        """
+00006060: 0a20 2020 2020 2020 206f 7574 7075 745f  .        output_
+00006070: 6174 7465 6e74 696f 6e73 203d 206f 7574  attentions = out
+00006080: 7075 745f 6174 7465 6e74 696f 6e73 2069  put_attentions i
+00006090: 6620 6f75 7470 7574 5f61 7474 656e 7469  f output_attenti
+000060a0: 6f6e 7320 6973 206e 6f74 204e 6f6e 6520  ons is not None 
+000060b0: 656c 7365 2073 656c 662e 636f 6e66 6967  else self.config
+000060c0: 2e6f 7574 7075 745f 6174 7465 6e74 696f  .output_attentio
+000060d0: 6e73 0a20 2020 2020 2020 206f 7574 7075  ns.        outpu
+000060e0: 745f 6869 6464 656e 5f73 7461 7465 7320  t_hidden_states 
+000060f0: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+00006100: 6f75 7470 7574 5f68 6964 6465 6e5f 7374  output_hidden_st
+00006110: 6174 6573 2069 6620 6f75 7470 7574 5f68  ates if output_h
+00006120: 6964 6465 6e5f 7374 6174 6573 2069 7320  idden_states is 
+00006130: 6e6f 7420 4e6f 6e65 2065 6c73 6520 7365  not None else se
+00006140: 6c66 2e63 6f6e 6669 672e 6f75 7470 7574  lf.config.output
+00006150: 5f68 6964 6465 6e5f 7374 6174 6573 0a20  _hidden_states. 
+00006160: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00006170: 2072 6574 7572 6e5f 6469 6374 203d 2072   return_dict = r
+00006180: 6574 7572 6e5f 6469 6374 2069 6620 7265  eturn_dict if re
+00006190: 7475 726e 5f64 6963 7420 6973 206e 6f74  turn_dict is not
+000061a0: 204e 6f6e 6520 656c 7365 2073 656c 662e   None else self.
+000061b0: 636f 6e66 6967 2e75 7365 5f72 6574 7572  config.use_retur
+000061c0: 6e5f 6469 6374 0a0a 2020 2020 2020 2020  n_dict..        
+000061d0: 2320 7265 7472 6965 7665 2069 6e70 7574  # retrieve input
+000061e0: 5f69 6473 2061 6e64 2069 6e70 7574 735f  _ids and inputs_
+000061f0: 656d 6265 6473 0a20 2020 2020 2020 2069  embeds.        i
+00006200: 6620 696e 7075 745f 6964 7320 6973 206e  f input_ids is n
+00006210: 6f74 204e 6f6e 6520 616e 6420 696e 7075  ot None and inpu
+00006220: 7473 5f65 6d62 6564 7320 6973 206e 6f74  ts_embeds is not
+00006230: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00006240: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+00006250: 726f 7228 2259 6f75 2063 616e 6e6f 7420  ror("You cannot 
+00006260: 7370 6563 6966 7920 626f 7468 2069 6e70  specify both inp
+00006270: 7574 5f69 6473 2061 6e64 2069 6e70 7574  ut_ids and input
+00006280: 735f 656d 6265 6473 2061 7420 7468 6520  s_embeds at the 
+00006290: 7361 6d65 2074 696d 6522 290a 2020 2020  same time").    
+000062a0: 2020 2020 656c 6966 2069 6e70 7574 5f69      elif input_i
+000062b0: 6473 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ds is not None:.
+000062c0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000062d0: 2e77 6172 6e5f 6966 5f70 6164 6469 6e67  .warn_if_padding
+000062e0: 5f61 6e64 5f6e 6f5f 6174 7465 6e74 696f  _and_no_attentio
+000062f0: 6e5f 6d61 736b 2869 6e70 7574 5f69 6473  n_mask(input_ids
+00006300: 2c20 6174 7465 6e74 696f 6e5f 6d61 736b  , attention_mask
+00006310: 290a 2020 2020 2020 2020 2020 2020 696e  ).            in
+00006320: 7075 745f 7368 6170 6520 3d20 696e 7075  put_shape = inpu
+00006330: 745f 6964 732e 7368 6170 650a 2020 2020  t_ids.shape.    
+00006340: 2020 2020 2020 2020 696e 7075 745f 6964          input_id
+00006350: 7320 3d20 696e 7075 745f 6964 732e 7669  s = input_ids.vi
+00006360: 6577 282d 312c 2069 6e70 7574 5f73 6861  ew(-1, input_sha
+00006370: 7065 5b2d 315d 290a 2020 2020 2020 2020  pe[-1]).        
+00006380: 656c 6966 2069 6e70 7574 735f 656d 6265  elif inputs_embe
+00006390: 6473 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ds is not None:.
+000063a0: 2020 2020 2020 2020 2020 2020 696e 7075              inpu
+000063b0: 745f 7368 6170 6520 3d20 696e 7075 7473  t_shape = inputs
+000063c0: 5f65 6d62 6564 732e 7368 6170 655b 3a2d  _embeds.shape[:-
+000063d0: 315d 0a20 2020 2020 2020 2065 6c73 653a  1].        else:
+000063e0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+000063f0: 7365 2056 616c 7565 4572 726f 7228 2259  se ValueError("Y
+00006400: 6f75 2068 6176 6520 746f 2073 7065 6369  ou have to speci
+00006410: 6679 2065 6974 6865 7220 696e 7075 745f  fy either input_
+00006420: 6964 7320 6f72 2069 6e70 7574 735f 656d  ids or inputs_em
+00006430: 6265 6473 2229 0a0a 2020 2020 2020 2020  beds")..        
+00006440: 6966 2069 6e70 7574 735f 656d 6265 6473  if inputs_embeds
+00006450: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00006460: 2020 2020 2020 696e 7075 7473 5f65 6d62        inputs_emb
+00006470: 6564 7320 3d20 7365 6c66 2e65 6d62 6564  eds = self.embed
+00006480: 5f74 6f6b 656e 7328 696e 7075 745f 6964  _tokens(input_id
+00006490: 7329 202a 2073 656c 662e 656d 6265 645f  s) * self.embed_
+000064a0: 7363 616c 650a 0a20 2020 2020 2020 2065  scale..        e
+000064b0: 6d62 6564 5f70 6f73 203d 2073 656c 662e  mbed_pos = self.
+000064c0: 656d 6265 645f 706f 7369 7469 6f6e 7328  embed_positions(
+000064d0: 696e 7075 745f 7368 6170 6529 0a0a 2020  input_shape)..  
+000064e0: 2020 2020 2020 6869 6464 656e 5f73 7461        hidden_sta
+000064f0: 7465 7320 3d20 696e 7075 7473 5f65 6d62  tes = inputs_emb
+00006500: 6564 7320 2b20 656d 6265 645f 706f 730a  eds + embed_pos.
+00006510: 2020 2020 2020 2020 6869 6464 656e 5f73          hidden_s
+00006520: 7461 7465 7320 3d20 6f70 732e 6472 6f70  tates = ops.drop
+00006530: 6f75 7428 6869 6464 656e 5f73 7461 7465  out(hidden_state
+00006540: 732c 2070 3d73 656c 662e 6472 6f70 6f75  s, p=self.dropou
+00006550: 742c 2074 7261 696e 696e 673d 7365 6c66  t, training=self
+00006560: 2e74 7261 696e 696e 6729 0a0a 2020 2020  .training)..    
+00006570: 2020 2020 2320 6578 7061 6e64 2061 7474      # expand att
+00006580: 656e 7469 6f6e 5f6d 6173 6b0a 2020 2020  ention_mask.    
+00006590: 2020 2020 6966 2061 7474 656e 7469 6f6e      if attention
+000065a0: 5f6d 6173 6b20 6973 206e 6f74 204e 6f6e  _mask is not Non
+000065b0: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
+000065c0: 205b 6273 7a2c 2073 6571 5f6c 656e 5d20   [bsz, seq_len] 
+000065d0: 2d3e 205b 6273 7a2c 2031 2c20 7467 745f  -> [bsz, 1, tgt_
+000065e0: 7365 715f 6c65 6e2c 2073 7263 5f73 6571  seq_len, src_seq
+000065f0: 5f6c 656e 5d0a 2020 2020 2020 2020 2020  _len].          
+00006600: 2020 6174 7465 6e74 696f 6e5f 6d61 736b    attention_mask
+00006610: 203d 205f 7072 6570 6172 655f 3464 5f61   = _prepare_4d_a
+00006620: 7474 656e 7469 6f6e 5f6d 6173 6b28 6174  ttention_mask(at
+00006630: 7465 6e74 696f 6e5f 6d61 736b 2c20 696e  tention_mask, in
+00006640: 7075 7473 5f65 6d62 6564 732e 6474 7970  puts_embeds.dtyp
+00006650: 6529 0a0a 2020 2020 2020 2020 656e 636f  e)..        enco
+00006660: 6465 725f 7374 6174 6573 203d 2028 2920  der_states = () 
+00006670: 6966 206f 7574 7075 745f 6869 6464 656e  if output_hidden
+00006680: 5f73 7461 7465 7320 656c 7365 204e 6f6e  _states else Non
+00006690: 650a 2020 2020 2020 2020 616c 6c5f 6174  e.        all_at
+000066a0: 7465 6e74 696f 6e73 203d 2028 2920 6966  tentions = () if
+000066b0: 206f 7574 7075 745f 6174 7465 6e74 696f   output_attentio
+000066c0: 6e73 2065 6c73 6520 4e6f 6e65 0a0a 2020  ns else None..  
+000066d0: 2020 2020 2020 2320 6368 6563 6b20 6966        # check if
+000066e0: 2068 6561 645f 6d61 736b 2068 6173 2061   head_mask has a
+000066f0: 2063 6f72 7265 6374 206e 756d 6265 7220   correct number 
+00006700: 6f66 206c 6179 6572 7320 7370 6563 6966  of layers specif
+00006710: 6965 6420 6966 2064 6573 6972 6564 0a20  ied if desired. 
+00006720: 2020 2020 2020 2069 6620 6865 6164 5f6d         if head_m
+00006730: 6173 6b20 6973 206e 6f74 204e 6f6e 653a  ask is not None:
+00006740: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00006750: 6865 6164 5f6d 6173 6b2e 7368 6170 655b  head_mask.shape[
+00006760: 305d 2021 3d20 6c65 6e28 7365 6c66 2e6c  0] != len(self.l
+00006770: 6179 6572 7329 3a0a 2020 2020 2020 2020  ayers):.        
+00006780: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+00006790: 6c75 6545 7272 6f72 280a 2020 2020 2020  lueError(.      
+000067a0: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+000067b0: 5468 6520 6865 6164 5f6d 6173 6b20 7368  The head_mask sh
+000067c0: 6f75 6c64 2062 6520 7370 6563 6966 6965  ould be specifie
+000067d0: 6420 666f 7220 7b6c 656e 2873 656c 662e  d for {len(self.
+000067e0: 6c61 7965 7273 297d 206c 6179 6572 732c  layers)} layers,
+000067f0: 2062 7574 2069 7420 6973 2066 6f72 220a   but it is for".
+00006800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006810: 2020 2020 6622 207b 6865 6164 5f6d 6173      f" {head_mas
+00006820: 6b2e 7368 6170 655b 305d 7d2e 220a 2020  k.shape[0]}.".  
+00006830: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00006840: 2020 2020 2020 2020 666f 7220 6964 782c          for idx,
+00006850: 2065 6e63 6f64 6572 5f6c 6179 6572 2069   encoder_layer i
+00006860: 6e20 656e 756d 6572 6174 6528 7365 6c66  n enumerate(self
+00006870: 2e6c 6179 6572 7329 3a0a 2020 2020 2020  .layers):.      
+00006880: 2020 2020 2020 6966 206f 7574 7075 745f        if output_
+00006890: 6869 6464 656e 5f73 7461 7465 733a 0a20  hidden_states:. 
+000068a0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+000068b0: 6e63 6f64 6572 5f73 7461 7465 7320 3d20  ncoder_states = 
+000068c0: 656e 636f 6465 725f 7374 6174 6573 202b  encoder_states +
+000068d0: 2028 6869 6464 656e 5f73 7461 7465 732c   (hidden_states,
+000068e0: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
+000068f0: 6164 6420 4c61 7965 7244 726f 7020 2873  add LayerDrop (s
+00006900: 6565 2068 7474 7073 3a2f 2f61 7278 6976  ee https://arxiv
+00006910: 2e6f 7267 2f61 6273 2f31 3930 392e 3131  .org/abs/1909.11
+00006920: 3535 3620 666f 7220 6465 7363 7269 7074  556 for descript
+00006930: 696f 6e29 0a20 2020 2020 2020 2020 2020  ion).           
+00006940: 2074 6f5f 6472 6f70 203d 2046 616c 7365   to_drop = False
+00006950: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00006960: 7365 6c66 2e74 7261 696e 696e 673a 0a20  self.training:. 
+00006970: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00006980: 726f 706f 7574 5f70 726f 6261 6269 6c69  ropout_probabili
+00006990: 7479 203d 206f 7073 2e72 616e 6428 5b5d  ty = ops.rand([]
+000069a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000069b0: 2020 6966 2064 726f 706f 7574 5f70 726f    if dropout_pro
+000069c0: 6261 6269 6c69 7479 203c 2073 656c 662e  bability < self.
+000069d0: 6c61 7965 7264 726f 703a 2020 2320 736b  layerdrop:  # sk
+000069e0: 6970 2074 6865 206c 6179 6572 0a20 2020  ip the layer.   
+000069f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006a00: 2074 6f5f 6472 6f70 203d 2054 7275 650a   to_drop = True.
+00006a10: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00006a20: 746f 5f64 726f 703a 0a20 2020 2020 2020  to_drop:.       
+00006a30: 2020 2020 2020 2020 206c 6179 6572 5f6f           layer_o
+00006a40: 7574 7075 7473 203d 2028 4e6f 6e65 2c20  utputs = (None, 
+00006a50: 4e6f 6e65 290a 2020 2020 2020 2020 2020  None).          
+00006a60: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00006a70: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00006a80: 6772 6164 6965 6e74 5f63 6865 636b 706f  gradient_checkpo
+00006a90: 696e 7469 6e67 2061 6e64 2073 656c 662e  inting and self.
+00006aa0: 7472 6169 6e69 6e67 3a0a 2020 2020 2020  training:.      
+00006ab0: 2020 2020 2020 2020 2020 2020 2020 6c61                la
+00006ac0: 7965 725f 6f75 7470 7574 7320 3d20 7365  yer_outputs = se
+00006ad0: 6c66 2e5f 6772 6164 6965 6e74 5f63 6865  lf._gradient_che
+00006ae0: 636b 706f 696e 7469 6e67 5f66 756e 6328  ckpointing_func(
+00006af0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006b00: 2020 2020 2020 2020 2065 6e63 6f64 6572           encoder
+00006b10: 5f6c 6179 6572 2e5f 5f63 616c 6c5f 5f2c  _layer.__call__,
+00006b20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006b30: 2020 2020 2020 2020 2068 6964 6465 6e5f           hidden_
+00006b40: 7374 6174 6573 2c0a 2020 2020 2020 2020  states,.        
+00006b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006b60: 6174 7465 6e74 696f 6e5f 6d61 736b 2c0a  attention_mask,.
+00006b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006b80: 2020 2020 2020 2020 2868 6561 645f 6d61          (head_ma
+00006b90: 736b 5b69 6478 5d20 6966 2068 6561 645f  sk[idx] if head_
+00006ba0: 6d61 736b 2069 7320 6e6f 7420 4e6f 6e65  mask is not None
+00006bb0: 2065 6c73 6520 4e6f 6e65 292c 0a20 2020   else None),.   
+00006bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006bd0: 2020 2020 206f 7574 7075 745f 6174 7465       output_atte
+00006be0: 6e74 696f 6e73 2c0a 2020 2020 2020 2020  ntions,.        
+00006bf0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00006c00: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00006c10: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00006c20: 2020 2020 2020 2020 6c61 7965 725f 6f75          layer_ou
+00006c30: 7470 7574 7320 3d20 656e 636f 6465 725f  tputs = encoder_
+00006c40: 6c61 7965 7228 0a20 2020 2020 2020 2020  layer(.         
+00006c50: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+00006c60: 6964 6465 6e5f 7374 6174 6573 2c0a 2020  idden_states,.  
+00006c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006c80: 2020 2020 2020 6174 7465 6e74 696f 6e5f        attention_
+00006c90: 6d61 736b 2c0a 2020 2020 2020 2020 2020  mask,.          
+00006ca0: 2020 2020 2020 2020 2020 2020 2020 6c61                la
+00006cb0: 7965 725f 6865 6164 5f6d 6173 6b3d 2868  yer_head_mask=(h
+00006cc0: 6561 645f 6d61 736b 5b69 6478 5d20 6966  ead_mask[idx] if
+00006cd0: 2068 6561 645f 6d61 736b 2069 7320 6e6f   head_mask is no
+00006ce0: 7420 4e6f 6e65 2065 6c73 6520 4e6f 6e65  t None else None
+00006cf0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00006d00: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
+00006d10: 745f 6174 7465 6e74 696f 6e73 3d6f 7574  t_attentions=out
+00006d20: 7075 745f 6174 7465 6e74 696f 6e73 2c0a  put_attentions,.
+00006d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006d40: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+00006d50: 2020 2020 2020 2068 6964 6465 6e5f 7374         hidden_st
+00006d60: 6174 6573 203d 206c 6179 6572 5f6f 7574  ates = layer_out
+00006d70: 7075 7473 5b30 5d0a 0a20 2020 2020 2020  puts[0]..       
+00006d80: 2020 2020 2069 6620 6f75 7470 7574 5f61       if output_a
+00006d90: 7474 656e 7469 6f6e 733a 0a20 2020 2020  ttentions:.     
+00006da0: 2020 2020 2020 2020 2020 2061 6c6c 5f61             all_a
+00006db0: 7474 656e 7469 6f6e 7320 3d20 616c 6c5f  ttentions = all_
+00006dc0: 6174 7465 6e74 696f 6e73 202b 2028 6c61  attentions + (la
+00006dd0: 7965 725f 6f75 7470 7574 735b 315d 2c29  yer_outputs[1],)
+00006de0: 0a0a 2020 2020 2020 2020 2320 6164 6420  ..        # add 
+00006df0: 6669 6e61 6c20 6c61 7965 7220 6e6f 726d  final layer norm
+00006e00: 0a20 2020 2020 2020 2068 6964 6465 6e5f  .        hidden_
+00006e10: 7374 6174 6573 203d 2073 656c 662e 6c61  states = self.la
+00006e20: 7965 725f 6e6f 726d 2868 6964 6465 6e5f  yer_norm(hidden_
+00006e30: 7374 6174 6573 290a 0a20 2020 2020 2020  states)..       
+00006e40: 2069 6620 6f75 7470 7574 5f68 6964 6465   if output_hidde
+00006e50: 6e5f 7374 6174 6573 3a0a 2020 2020 2020  n_states:.      
+00006e60: 2020 2020 2020 656e 636f 6465 725f 7374        encoder_st
+00006e70: 6174 6573 203d 2065 6e63 6f64 6572 5f73  ates = encoder_s
+00006e80: 7461 7465 7320 2b20 2868 6964 6465 6e5f  tates + (hidden_
+00006e90: 7374 6174 6573 2c29 0a0a 2020 2020 2020  states,)..      
+00006ea0: 2020 6966 206e 6f74 2072 6574 7572 6e5f    if not return_
+00006eb0: 6469 6374 3a0a 2020 2020 2020 2020 2020  dict:.          
+00006ec0: 2020 7265 7475 726e 2074 7570 6c65 2876    return tuple(v
+00006ed0: 2066 6f72 2076 2069 6e20 5b68 6964 6465   for v in [hidde
+00006ee0: 6e5f 7374 6174 6573 2c20 656e 636f 6465  n_states, encode
+00006ef0: 725f 7374 6174 6573 2c20 616c 6c5f 6174  r_states, all_at
+00006f00: 7465 6e74 696f 6e73 5d20 6966 2076 2069  tentions] if v i
+00006f10: 7320 6e6f 7420 4e6f 6e65 290a 2020 2020  s not None).    
+00006f20: 2020 2020 7265 7475 726e 2042 6173 654d      return BaseM
+00006f30: 6f64 656c 4f75 7470 7574 280a 2020 2020  odelOutput(.    
+00006f40: 2020 2020 2020 2020 6c61 7374 5f68 6964          last_hid
+00006f50: 6465 6e5f 7374 6174 653d 6869 6464 656e  den_state=hidden
+00006f60: 5f73 7461 7465 732c 2068 6964 6465 6e5f  _states, hidden_
+00006f70: 7374 6174 6573 3d65 6e63 6f64 6572 5f73  states=encoder_s
+00006f80: 7461 7465 732c 2061 7474 656e 7469 6f6e  tates, attention
+00006f90: 733d 616c 6c5f 6174 7465 6e74 696f 6e73  s=all_attentions
+00006fa0: 0a20 2020 2020 2020 2029 0a0a 0a63 6c61  .        )...cla
+00006fb0: 7373 2042 6c65 6e64 6572 626f 7444 6563  ss BlenderbotDec
+00006fc0: 6f64 6572 2842 6c65 6e64 6572 626f 7450  oder(BlenderbotP
+00006fd0: 7265 5472 6169 6e65 644d 6f64 656c 293a  reTrainedModel):
+00006fe0: 0a20 2020 2022 2222 0a20 2020 2054 7261  .    """.    Tra
+00006ff0: 6e73 666f 726d 6572 2064 6563 6f64 6572  nsformer decoder
+00007000: 2063 6f6e 7369 7374 696e 6720 6f66 202a   consisting of *
+00007010: 636f 6e66 6967 2e64 6563 6f64 6572 5f6c  config.decoder_l
+00007020: 6179 6572 732a 206c 6179 6572 732e 2045  ayers* layers. E
+00007030: 6163 6820 6c61 7965 7220 6973 2061 205b  ach layer is a [
+00007040: 6042 6c65 6e64 6572 626f 7444 6563 6f64  `BlenderbotDecod
+00007050: 6572 4c61 7965 7260 5d0a 0a20 2020 2041  erLayer`]..    A
+00007060: 7267 733a 0a20 2020 2020 2020 2063 6f6e  rgs:.        con
+00007070: 6669 673a 2042 6c65 6e64 6572 626f 7443  fig: BlenderbotC
+00007080: 6f6e 6669 670a 2020 2020 2020 2020 656d  onfig.        em
+00007090: 6265 645f 746f 6b65 6e73 2028 6e6e 2e45  bed_tokens (nn.E
+000070a0: 6d62 6564 6469 6e67 293a 206f 7574 7075  mbedding): outpu
+000070b0: 7420 656d 6265 6464 696e 670a 2020 2020  t embedding.    
+000070c0: 2222 220a 0a20 2020 2064 6566 205f 5f69  """..    def __i
+000070d0: 6e69 745f 5f28 7365 6c66 2c20 636f 6e66  nit__(self, conf
+000070e0: 6967 3a20 426c 656e 6465 7262 6f74 436f  ig: BlenderbotCo
+000070f0: 6e66 6967 2c20 656d 6265 645f 746f 6b65  nfig, embed_toke
+00007100: 6e73 3a20 4f70 7469 6f6e 616c 5b6e 6e2e  ns: Optional[nn.
+00007110: 456d 6265 6464 696e 675d 203d 204e 6f6e  Embedding] = Non
+00007120: 6529 3a0a 2020 2020 2020 2020 7375 7065  e):.        supe
+00007130: 7228 292e 5f5f 696e 6974 5f5f 2863 6f6e  r().__init__(con
+00007140: 6669 6729 0a20 2020 2020 2020 2073 656c  fig).        sel
+00007150: 662e 6472 6f70 6f75 7420 3d20 636f 6e66  f.dropout = conf
+00007160: 6967 2e64 726f 706f 7574 0a20 2020 2020  ig.dropout.     
+00007170: 2020 2073 656c 662e 6c61 7965 7264 726f     self.layerdro
+00007180: 7020 3d20 636f 6e66 6967 2e64 6563 6f64  p = config.decod
+00007190: 6572 5f6c 6179 6572 6472 6f70 0a20 2020  er_layerdrop.   
+000071a0: 2020 2020 2073 656c 662e 7061 6464 696e       self.paddin
+000071b0: 675f 6964 7820 3d20 636f 6e66 6967 2e70  g_idx = config.p
+000071c0: 6164 5f74 6f6b 656e 5f69 640a 2020 2020  ad_token_id.    
+000071d0: 2020 2020 7365 6c66 2e6d 6178 5f74 6172      self.max_tar
+000071e0: 6765 745f 706f 7369 7469 6f6e 7320 3d20  get_positions = 
+000071f0: 636f 6e66 6967 2e6d 6178 5f70 6f73 6974  config.max_posit
+00007200: 696f 6e5f 656d 6265 6464 696e 6773 0a20  ion_embeddings. 
+00007210: 2020 2020 2020 2073 656c 662e 656d 6265         self.embe
+00007220: 645f 7363 616c 6520 3d20 6d61 7468 2e73  d_scale = math.s
+00007230: 7172 7428 636f 6e66 6967 2e64 5f6d 6f64  qrt(config.d_mod
+00007240: 656c 2920 6966 2063 6f6e 6669 672e 7363  el) if config.sc
+00007250: 616c 655f 656d 6265 6464 696e 6720 656c  ale_embedding el
+00007260: 7365 2031 2e30 0a0a 2020 2020 2020 2020  se 1.0..        
+00007270: 6966 2065 6d62 6564 5f74 6f6b 656e 7320  if embed_tokens 
+00007280: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00007290: 2020 2020 2020 2020 2073 656c 662e 656d           self.em
+000072a0: 6265 645f 746f 6b65 6e73 203d 2065 6d62  bed_tokens = emb
+000072b0: 6564 5f74 6f6b 656e 730a 2020 2020 2020  ed_tokens.      
+000072c0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000072d0: 2020 2020 7365 6c66 2e65 6d62 6564 5f74      self.embed_t
+000072e0: 6f6b 656e 7320 3d20 6e6e 2e45 6d62 6564  okens = nn.Embed
+000072f0: 6469 6e67 2863 6f6e 6669 672e 766f 6361  ding(config.voca
+00007300: 625f 7369 7a65 2c20 636f 6e66 6967 2e64  b_size, config.d
+00007310: 5f6d 6f64 656c 2c20 7365 6c66 2e70 6164  _model, self.pad
+00007320: 6469 6e67 5f69 6478 290a 0a20 2020 2020  ding_idx)..     
+00007330: 2020 2073 656c 662e 656d 6265 645f 706f     self.embed_po
+00007340: 7369 7469 6f6e 7320 3d20 426c 656e 6465  sitions = Blende
+00007350: 7262 6f74 4c65 6172 6e65 6450 6f73 6974  rbotLearnedPosit
+00007360: 696f 6e61 6c45 6d62 6564 6469 6e67 280a  ionalEmbedding(.
+00007370: 2020 2020 2020 2020 2020 2020 636f 6e66              conf
+00007380: 6967 2e6d 6178 5f70 6f73 6974 696f 6e5f  ig.max_position_
+00007390: 656d 6265 6464 696e 6773 2c0a 2020 2020  embeddings,.    
+000073a0: 2020 2020 2020 2020 636f 6e66 6967 2e64          config.d
+000073b0: 5f6d 6f64 656c 2c0a 2020 2020 2020 2020  _model,.        
+000073c0: 290a 2020 2020 2020 2020 7365 6c66 2e6c  ).        self.l
+000073d0: 6179 6572 7320 3d20 6e6e 2e43 656c 6c4c  ayers = nn.CellL
+000073e0: 6973 7428 5b42 6c65 6e64 6572 626f 7444  ist([BlenderbotD
+000073f0: 6563 6f64 6572 4c61 7965 7228 636f 6e66  ecoderLayer(conf
+00007400: 6967 2920 666f 7220 5f20 696e 2072 616e  ig) for _ in ran
+00007410: 6765 2863 6f6e 6669 672e 6465 636f 6465  ge(config.decode
+00007420: 725f 6c61 7965 7273 295d 290a 2020 2020  r_layers)]).    
+00007430: 2020 2020 7365 6c66 2e6c 6179 6572 5f6e      self.layer_n
+00007440: 6f72 6d20 3d20 6e6e 2e4c 6179 6572 4e6f  orm = nn.LayerNo
+00007450: 726d 2863 6f6e 6669 672e 645f 6d6f 6465  rm(config.d_mode
+00007460: 6c29 0a0a 2020 2020 2020 2020 7365 6c66  l)..        self
+00007470: 2e67 7261 6469 656e 745f 6368 6563 6b70  .gradient_checkp
+00007480: 6f69 6e74 696e 6720 3d20 4661 6c73 650a  ointing = False.
+00007490: 2020 2020 2020 2020 2320 496e 6974 6961          # Initia
+000074a0: 6c69 7a65 2077 6569 6768 7473 2061 6e64  lize weights and
+000074b0: 2061 7070 6c79 2066 696e 616c 2070 726f   apply final pro
+000074c0: 6365 7373 696e 670a 2020 2020 2020 2020  cessing.        
+000074d0: 7365 6c66 2e70 6f73 745f 696e 6974 2829  self.post_init()
+000074e0: 0a0a 2020 2020 6465 6620 6765 745f 696e  ..    def get_in
+000074f0: 7075 745f 656d 6265 6464 696e 6773 2873  put_embeddings(s
+00007500: 656c 6629 3a0a 2020 2020 2020 2020 7265  elf):.        re
+00007510: 7475 726e 2073 656c 662e 656d 6265 645f  turn self.embed_
+00007520: 746f 6b65 6e73 0a0a 2020 2020 6465 6620  tokens..    def 
+00007530: 7365 745f 696e 7075 745f 656d 6265 6464  set_input_embedd
+00007540: 696e 6773 2873 656c 662c 2076 616c 7565  ings(self, value
+00007550: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+00007560: 656d 6265 645f 746f 6b65 6e73 203d 2076  embed_tokens = v
+00007570: 616c 7565 0a0a 2020 2020 6465 6620 636f  alue..    def co
+00007580: 6e73 7472 7563 7428 0a20 2020 2020 2020  nstruct(.       
+00007590: 2073 656c 662c 0a20 2020 2020 2020 2069   self,.        i
+000075a0: 6e70 7574 5f69 6473 3d4e 6f6e 652c 0a20  nput_ids=None,. 
+000075b0: 2020 2020 2020 2061 7474 656e 7469 6f6e         attention
+000075c0: 5f6d 6173 6b3d 4e6f 6e65 2c0a 2020 2020  _mask=None,.    
+000075d0: 2020 2020 656e 636f 6465 725f 6869 6464      encoder_hidd
+000075e0: 656e 5f73 7461 7465 733d 4e6f 6e65 2c0a  en_states=None,.
+000075f0: 2020 2020 2020 2020 656e 636f 6465 725f          encoder_
+00007600: 6174 7465 6e74 696f 6e5f 6d61 736b 3d4e  attention_mask=N
+00007610: 6f6e 652c 0a20 2020 2020 2020 2068 6561  one,.        hea
+00007620: 645f 6d61 736b 3d4e 6f6e 652c 0a20 2020  d_mask=None,.   
+00007630: 2020 2020 2063 726f 7373 5f61 7474 6e5f       cross_attn_
+00007640: 6865 6164 5f6d 6173 6b3d 4e6f 6e65 2c0a  head_mask=None,.
+00007650: 2020 2020 2020 2020 7061 7374 5f6b 6579          past_key
+00007660: 5f76 616c 7565 733d 4e6f 6e65 2c0a 2020  _values=None,.  
+00007670: 2020 2020 2020 696e 7075 7473 5f65 6d62        inputs_emb
+00007680: 6564 733d 4e6f 6e65 2c0a 2020 2020 2020  eds=None,.      
+00007690: 2020 7573 655f 6361 6368 653d 4e6f 6e65    use_cache=None
+000076a0: 2c0a 2020 2020 2020 2020 6f75 7470 7574  ,.        output
+000076b0: 5f61 7474 656e 7469 6f6e 733d 4e6f 6e65  _attentions=None
+000076c0: 2c0a 2020 2020 2020 2020 6f75 7470 7574  ,.        output
+000076d0: 5f68 6964 6465 6e5f 7374 6174 6573 3d4e  _hidden_states=N
+000076e0: 6f6e 652c 0a20 2020 2020 2020 2072 6574  one,.        ret
+000076f0: 7572 6e5f 6469 6374 3d4e 6f6e 652c 0a20  urn_dict=None,. 
+00007700: 2020 2029 3a0a 2020 2020 2020 2020 7222     ):.        r"
+00007710: 2222 0a20 2020 2020 2020 2041 7267 733a  "".        Args:
+00007720: 0a20 2020 2020 2020 2020 2020 2069 6e70  .            inp
+00007730: 7574 5f69 6473 2028 606d 696e 6473 706f  ut_ids (`mindspo
+00007740: 7265 2e54 656e 736f 7260 206f 6620 7368  re.Tensor` of sh
+00007750: 6170 6520 6028 6261 7463 685f 7369 7a65  ape `(batch_size
+00007760: 2c20 7365 7175 656e 6365 5f6c 656e 6774  , sequence_lengt
+00007770: 6829 6029 3a0a 2020 2020 2020 2020 2020  h)`):.          
+00007780: 2020 2020 2020 496e 6469 6365 7320 6f66        Indices of
+00007790: 2069 6e70 7574 2073 6571 7565 6e63 6520   input sequence 
+000077a0: 746f 6b65 6e73 2069 6e20 7468 6520 766f  tokens in the vo
+000077b0: 6361 6275 6c61 7279 2e20 5061 6464 696e  cabulary. Paddin
+000077c0: 6720 7769 6c6c 2062 6520 6967 6e6f 7265  g will be ignore
+000077d0: 6420 6279 2064 6566 6175 6c74 2073 686f  d by default sho
+000077e0: 756c 6420 796f 750a 2020 2020 2020 2020  uld you.        
+000077f0: 2020 2020 2020 2020 7072 6f76 6964 6520          provide 
+00007800: 6974 2e0a 0a20 2020 2020 2020 2020 2020  it...           
+00007810: 2020 2020 2049 6e64 6963 6573 2063 616e       Indices can
+00007820: 2062 6520 6f62 7461 696e 6564 2075 7369   be obtained usi
+00007830: 6e67 205b 6041 7574 6f54 6f6b 656e 697a  ng [`AutoTokeniz
+00007840: 6572 605d 2e20 5365 6520 5b60 5072 6554  er`]. See [`PreT
+00007850: 7261 696e 6564 546f 6b65 6e69 7a65 722e  rainedTokenizer.
+00007860: 656e 636f 6465 605d 2061 6e64 0a20 2020  encode`] and.   
+00007870: 2020 2020 2020 2020 2020 2020 205b 6050               [`P
+00007880: 7265 5472 6169 6e65 6454 6f6b 656e 697a  reTrainedTokeniz
+00007890: 6572 2e5f 5f63 616c 6c5f 5f60 5d20 666f  er.__call__`] fo
+000078a0: 7220 6465 7461 696c 732e 0a0a 2020 2020  r details...    
+000078b0: 2020 2020 2020 2020 2020 2020 5b57 6861              [Wha
+000078c0: 7420 6172 6520 696e 7075 7420 4944 733f  t are input IDs?
+000078d0: 5d28 2e2e 2f67 6c6f 7373 6172 7923 696e  ](../glossary#in
+000078e0: 7075 742d 6964 7329 0a20 2020 2020 2020  put-ids).       
+000078f0: 2020 2020 2061 7474 656e 7469 6f6e 5f6d       attention_m
+00007900: 6173 6b20 2860 6d69 6e64 7370 6f72 652e  ask (`mindspore.
+00007910: 5465 6e73 6f72 6020 6f66 2073 6861 7065  Tensor` of shape
+00007920: 2060 2862 6174 6368 5f73 697a 652c 2073   `(batch_size, s
+00007930: 6571 7565 6e63 655f 6c65 6e67 7468 2960  equence_length)`
+00007940: 2c20 2a6f 7074 696f 6e61 6c2a 293a 0a20  , *optional*):. 
+00007950: 2020 2020 2020 2020 2020 2020 2020 204d                 M
+00007960: 6173 6b20 746f 2061 766f 6964 2070 6572  ask to avoid per
+00007970: 666f 726d 696e 6720 6174 7465 6e74 696f  forming attentio
+00007980: 6e20 6f6e 2070 6164 6469 6e67 2074 6f6b  n on padding tok
+00007990: 656e 2069 6e64 6963 6573 2e20 4d61 736b  en indices. Mask
+000079a0: 2076 616c 7565 7320 7365 6c65 6374 6564   values selected
+000079b0: 2069 6e20 605b 302c 2031 5d60 3a0a 0a20   in `[0, 1]`:.. 
+000079c0: 2020 2020 2020 2020 2020 2020 2020 202d                 -
+000079d0: 2031 2066 6f72 2074 6f6b 656e 7320 7468   1 for tokens th
+000079e0: 6174 2061 7265 202a 2a6e 6f74 206d 6173  at are **not mas
+000079f0: 6b65 642a 2a2c 0a20 2020 2020 2020 2020  ked**,.         
+00007a00: 2020 2020 2020 202d 2030 2066 6f72 2074         - 0 for t
+00007a10: 6f6b 656e 7320 7468 6174 2061 7265 202a  okens that are *
+00007a20: 2a6d 6173 6b65 642a 2a2e 0a0a 2020 2020  *masked**...    
+00007a30: 2020 2020 2020 2020 2020 2020 5b57 6861              [Wha
+00007a40: 7420 6172 6520 6174 7465 6e74 696f 6e20  t are attention 
+00007a50: 6d61 736b 733f 5d28 2e2e 2f67 6c6f 7373  masks?](../gloss
+00007a60: 6172 7923 6174 7465 6e74 696f 6e2d 6d61  ary#attention-ma
+00007a70: 736b 290a 2020 2020 2020 2020 2020 2020  sk).            
+00007a80: 656e 636f 6465 725f 6869 6464 656e 5f73  encoder_hidden_s
+00007a90: 7461 7465 7320 2860 6d69 6e64 7370 6f72  tates (`mindspor
+00007aa0: 652e 5465 6e73 6f72 6020 6f66 2073 6861  e.Tensor` of sha
+00007ab0: 7065 2060 2862 6174 6368 5f73 697a 652c  pe `(batch_size,
+00007ac0: 2065 6e63 6f64 6572 5f73 6571 7565 6e63   encoder_sequenc
+00007ad0: 655f 6c65 6e67 7468 2c20 6869 6464 656e  e_length, hidden
+00007ae0: 5f73 697a 6529 602c 202a 6f70 7469 6f6e  _size)`, *option
+00007af0: 616c 2a29 3a0a 2020 2020 2020 2020 2020  al*):.          
+00007b00: 2020 2020 2020 5365 7175 656e 6365 206f        Sequence o
+00007b10: 6620 6869 6464 656e 2d73 7461 7465 7320  f hidden-states 
+00007b20: 6174 2074 6865 206f 7574 7075 7420 6f66  at the output of
+00007b30: 2074 6865 206c 6173 7420 6c61 7965 7220   the last layer 
+00007b40: 6f66 2074 6865 2065 6e63 6f64 6572 2e20  of the encoder. 
+00007b50: 5573 6564 2069 6e20 7468 6520 6372 6f73  Used in the cros
+00007b60: 732d 6174 7465 6e74 696f 6e0a 2020 2020  s-attention.    
+00007b70: 2020 2020 2020 2020 2020 2020 6f66 2074              of t
+00007b80: 6865 2064 6563 6f64 6572 2e0a 2020 2020  he decoder..    
+00007b90: 2020 2020 2020 2020 656e 636f 6465 725f          encoder_
+00007ba0: 6174 7465 6e74 696f 6e5f 6d61 736b 2028  attention_mask (
+00007bb0: 606d 696e 6473 706f 7265 2e54 656e 736f  `mindspore.Tenso
+00007bc0: 7260 206f 6620 7368 6170 6520 6028 6261  r` of shape `(ba
+00007bd0: 7463 685f 7369 7a65 2c20 656e 636f 6465  tch_size, encode
+00007be0: 725f 7365 7175 656e 6365 5f6c 656e 6774  r_sequence_lengt
+00007bf0: 6829 602c 202a 6f70 7469 6f6e 616c 2a29  h)`, *optional*)
+00007c00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00007c10: 2020 4d61 736b 2074 6f20 6176 6f69 6420    Mask to avoid 
+00007c20: 7065 7266 6f72 6d69 6e67 2063 726f 7373  performing cross
+00007c30: 2d61 7474 656e 7469 6f6e 206f 6e20 7061  -attention on pa
+00007c40: 6464 696e 6720 746f 6b65 6e73 2069 6e64  dding tokens ind
+00007c50: 6963 6573 206f 6620 656e 636f 6465 7220  ices of encoder 
+00007c60: 696e 7075 745f 6964 732e 204d 6173 6b20  input_ids. Mask 
+00007c70: 7661 6c75 6573 0a20 2020 2020 2020 2020  values.         
+00007c80: 2020 2020 2020 2073 656c 6563 7465 6420         selected 
+00007c90: 696e 2060 5b30 2c20 315d 603a 0a0a 2020  in `[0, 1]`:..  
+00007ca0: 2020 2020 2020 2020 2020 2020 2020 2d20                - 
+00007cb0: 3120 666f 7220 746f 6b65 6e73 2074 6861  1 for tokens tha
+00007cc0: 7420 6172 6520 2a2a 6e6f 7420 6d61 736b  t are **not mask
+00007cd0: 6564 2a2a 2c0a 2020 2020 2020 2020 2020  ed**,.          
+00007ce0: 2020 2020 2020 2d20 3020 666f 7220 746f        - 0 for to
+00007cf0: 6b65 6e73 2074 6861 7420 6172 6520 2a2a  kens that are **
+00007d00: 6d61 736b 6564 2a2a 2e0a 0a20 2020 2020  masked**...     
+00007d10: 2020 2020 2020 2020 2020 205b 5768 6174             [What
+00007d20: 2061 7265 2061 7474 656e 7469 6f6e 206d   are attention m
+00007d30: 6173 6b73 3f5d 282e 2e2f 676c 6f73 7361  asks?](../glossa
+00007d40: 7279 2361 7474 656e 7469 6f6e 2d6d 6173  ry#attention-mas
+00007d50: 6b29 0a20 2020 2020 2020 2020 2020 2068  k).            h
+00007d60: 6561 645f 6d61 736b 2028 606d 696e 6473  ead_mask (`minds
+00007d70: 706f 7265 2e54 656e 736f 7260 206f 6620  pore.Tensor` of 
+00007d80: 7368 6170 6520 6028 656e 636f 6465 725f  shape `(encoder_
+00007d90: 6c61 7965 7273 2c20 656e 636f 6465 725f  layers, encoder_
+00007da0: 6174 7465 6e74 696f 6e5f 6865 6164 7329  attention_heads)
+00007db0: 602c 202a 6f70 7469 6f6e 616c 2a29 3a0a  `, *optional*):.
+00007dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007dd0: 4d61 736b 2074 6f20 6e75 6c6c 6966 7920  Mask to nullify 
+00007de0: 7365 6c65 6374 6564 2068 6561 6473 206f  selected heads o
+00007df0: 6620 7468 6520 6174 7465 6e74 696f 6e20  f the attention 
+00007e00: 6d6f 6475 6c65 7320 696e 2074 6865 2065  modules in the e
+00007e10: 6e63 6f64 6572 2e20 4d61 736b 2076 616c  ncoder. Mask val
+00007e20: 7565 7320 7365 6c65 6374 6564 2069 6e20  ues selected in 
+00007e30: 605b 302c 0a20 2020 2020 2020 2020 2020  `[0,.           
+00007e40: 2020 2020 2031 5d60 3a0a 0a20 2020 2020       1]`:..     
+00007e50: 2020 2020 2020 2020 2020 202d 2031 2069             - 1 i
+00007e60: 6e64 6963 6174 6573 2074 6865 2068 6561  ndicates the hea
+00007e70: 6420 6973 202a 2a6e 6f74 206d 6173 6b65  d is **not maske
+00007e80: 642a 2a2c 0a20 2020 2020 2020 2020 2020  d**,.           
+00007e90: 2020 2020 202d 2030 2069 6e64 6963 6174       - 0 indicat
+00007ea0: 6573 2074 6865 2068 6561 6420 6973 202a  es the head is *
+00007eb0: 2a6d 6173 6b65 642a 2a2e 0a0a 2020 2020  *masked**...    
+00007ec0: 2020 2020 2020 2020 6372 6f73 735f 6174          cross_at
+00007ed0: 746e 5f68 6561 645f 6d61 736b 2028 606d  tn_head_mask (`m
+00007ee0: 696e 6473 706f 7265 2e54 656e 736f 7260  indspore.Tensor`
+00007ef0: 206f 6620 7368 6170 6520 6028 6465 636f   of shape `(deco
+00007f00: 6465 725f 6c61 7965 7273 2c20 6465 636f  der_layers, deco
+00007f10: 6465 725f 6174 7465 6e74 696f 6e5f 6865  der_attention_he
+00007f20: 6164 7329 602c 202a 6f70 7469 6f6e 616c  ads)`, *optional
+00007f30: 2a29 3a0a 2020 2020 2020 2020 2020 2020  *):.            
+00007f40: 2020 2020 4d61 736b 2074 6f20 6e75 6c6c      Mask to null
+00007f50: 6966 7920 7365 6c65 6374 6564 2068 6561  ify selected hea
+00007f60: 6473 206f 6620 7468 6520 6372 6f73 732d  ds of the cross-
+00007f70: 6174 7465 6e74 696f 6e20 6d6f 6475 6c65  attention module
+00007f80: 7320 696e 2074 6865 2064 6563 6f64 6572  s in the decoder
+00007f90: 2074 6f20 6176 6f69 6420 7065 7266 6f72   to avoid perfor
+00007fa0: 6d69 6e67 0a20 2020 2020 2020 2020 2020  ming.           
+00007fb0: 2020 2020 2063 726f 7373 2d61 7474 656e       cross-atten
+00007fc0: 7469 6f6e 206f 6e20 6869 6464 656e 2068  tion on hidden h
+00007fd0: 6561 6473 2e20 4d61 736b 2076 616c 7565  eads. Mask value
+00007fe0: 7320 7365 6c65 6374 6564 2069 6e20 605b  s selected in `[
+00007ff0: 302c 2031 5d60 3a0a 0a20 2020 2020 2020  0, 1]`:..       
+00008000: 2020 2020 2020 2020 202d 2031 2069 6e64           - 1 ind
+00008010: 6963 6174 6573 2074 6865 2068 6561 6420  icates the head 
+00008020: 6973 202a 2a6e 6f74 206d 6173 6b65 642a  is **not masked*
+00008030: 2a2c 0a20 2020 2020 2020 2020 2020 2020  *,.             
+00008040: 2020 202d 2030 2069 6e64 6963 6174 6573     - 0 indicates
+00008050: 2074 6865 2068 6561 6420 6973 202a 2a6d   the head is **m
+00008060: 6173 6b65 642a 2a2e 0a0a 2020 2020 2020  asked**...      
+00008070: 2020 2020 2020 7061 7374 5f6b 6579 5f76        past_key_v
+00008080: 616c 7565 7320 2860 7475 706c 6528 7475  alues (`tuple(tu
+00008090: 706c 6528 6d69 6e64 7370 6f72 652e 5465  ple(mindspore.Te
+000080a0: 6e73 6f72 2929 602c 202a 6f70 7469 6f6e  nsor))`, *option
+000080b0: 616c 2a2c 2072 6574 7572 6e65 6420 7768  al*, returned wh
+000080c0: 656e 2060 7573 655f 6361 6368 653d 5472  en `use_cache=Tr
+000080d0: 7565 6020 6973 2070 6173 7365 6420 6f72  ue` is passed or
+000080e0: 2077 6865 6e20 6063 6f6e 6669 672e 7573   when `config.us
+000080f0: 655f 6361 6368 653d 5472 7565 6029 3a0a  e_cache=True`):.
+00008100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008110: 5475 706c 6520 6f66 2060 7475 706c 6528  Tuple of `tuple(
+00008120: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+00008130: 2960 206f 6620 6c65 6e67 7468 2060 636f  )` of length `co
+00008140: 6e66 6967 2e6e 5f6c 6179 6572 7360 2c20  nfig.n_layers`, 
+00008150: 7769 7468 2065 6163 6820 7475 706c 6520  with each tuple 
+00008160: 6861 7669 6e67 2032 2074 656e 736f 7273  having 2 tensors
+00008170: 206f 660a 2020 2020 2020 2020 2020 2020   of.            
+00008180: 2020 2020 7368 6170 6520 6028 6261 7463      shape `(batc
+00008190: 685f 7369 7a65 2c20 6e75 6d5f 6865 6164  h_size, num_head
+000081a0: 732c 2073 6571 7565 6e63 655f 6c65 6e67  s, sequence_leng
+000081b0: 7468 2c20 656d 6265 645f 7369 7a65 5f70  th, embed_size_p
+000081c0: 6572 5f68 6561 6429 6029 2061 6e64 2032  er_head)`) and 2
+000081d0: 2061 6464 6974 696f 6e61 6c20 7465 6e73   additional tens
+000081e0: 6f72 7320 6f66 0a20 2020 2020 2020 2020  ors of.         
+000081f0: 2020 2020 2020 2073 6861 7065 2060 2862         shape `(b
+00008200: 6174 6368 5f73 697a 652c 206e 756d 5f68  atch_size, num_h
+00008210: 6561 6473 2c20 656e 636f 6465 725f 7365  eads, encoder_se
+00008220: 7175 656e 6365 5f6c 656e 6774 682c 2065  quence_length, e
+00008230: 6d62 6564 5f73 697a 655f 7065 725f 6865  mbed_size_per_he
+00008240: 6164 2960 2e0a 0a20 2020 2020 2020 2020  ad)`...         
+00008250: 2020 2020 2020 2043 6f6e 7461 696e 7320         Contains 
+00008260: 7072 652d 636f 6d70 7574 6564 2068 6964  pre-computed hid
+00008270: 6465 6e2d 7374 6174 6573 2028 6b65 7920  den-states (key 
+00008280: 616e 6420 7661 6c75 6573 2069 6e20 7468  and values in th
+00008290: 6520 7365 6c66 2d61 7474 656e 7469 6f6e  e self-attention
+000082a0: 2062 6c6f 636b 7320 616e 6420 696e 2074   blocks and in t
+000082b0: 6865 0a20 2020 2020 2020 2020 2020 2020  he.             
+000082c0: 2020 2063 726f 7373 2d61 7474 656e 7469     cross-attenti
+000082d0: 6f6e 2062 6c6f 636b 7329 2074 6861 7420  on blocks) that 
+000082e0: 6361 6e20 6265 2075 7365 6420 2873 6565  can be used (see
+000082f0: 2060 7061 7374 5f6b 6579 5f76 616c 7565   `past_key_value
+00008300: 7360 2069 6e70 7574 2920 746f 2073 7065  s` input) to spe
+00008310: 6564 2075 7020 7365 7175 656e 7469 616c  ed up sequential
+00008320: 2064 6563 6f64 696e 672e 0a0a 2020 2020   decoding...    
+00008330: 2020 2020 2020 2020 2020 2020 4966 2060              If `
+00008340: 7061 7374 5f6b 6579 5f76 616c 7565 7360  past_key_values`
+00008350: 2061 7265 2075 7365 642c 2074 6865 2075   are used, the u
+00008360: 7365 7220 6361 6e20 6f70 7469 6f6e 616c  ser can optional
+00008370: 6c79 2069 6e70 7574 206f 6e6c 7920 7468  ly input only th
+00008380: 6520 6c61 7374 2060 6465 636f 6465 725f  e last `decoder_
+00008390: 696e 7075 745f 6964 7360 2028 7468 6f73  input_ids` (thos
+000083a0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+000083b0: 2020 7468 6174 2064 6f6e 2774 2068 6176    that don't hav
+000083c0: 6520 7468 6569 7220 7061 7374 206b 6579  e their past key
+000083d0: 2076 616c 7565 2073 7461 7465 7320 6769   value states gi
+000083e0: 7665 6e20 746f 2074 6869 7320 6d6f 6465  ven to this mode
+000083f0: 6c29 206f 6620 7368 6170 6520 6028 6261  l) of shape `(ba
+00008400: 7463 685f 7369 7a65 2c20 3129 6020 696e  tch_size, 1)` in
+00008410: 7374 6561 6420 6f66 0a20 2020 2020 2020  stead of.       
+00008420: 2020 2020 2020 2020 2061 6c6c 2060 6465           all `de
+00008430: 636f 6465 725f 696e 7075 745f 6964 7360  coder_input_ids`
+00008440: 206f 6620 7368 6170 6520 6028 6261 7463   of shape `(batc
+00008450: 685f 7369 7a65 2c20 7365 7175 656e 6365  h_size, sequence
+00008460: 5f6c 656e 6774 6829 602e 0a20 2020 2020  _length)`..     
+00008470: 2020 2020 2020 2069 6e70 7574 735f 656d         inputs_em
+00008480: 6265 6473 2028 606d 696e 6473 706f 7265  beds (`mindspore
+00008490: 2e54 656e 736f 7260 206f 6620 7368 6170  .Tensor` of shap
+000084a0: 6520 6028 6261 7463 685f 7369 7a65 2c20  e `(batch_size, 
+000084b0: 7365 7175 656e 6365 5f6c 656e 6774 682c  sequence_length,
+000084c0: 2068 6964 6465 6e5f 7369 7a65 2960 2c20   hidden_size)`, 
+000084d0: 2a6f 7074 696f 6e61 6c2a 293a 0a20 2020  *optional*):.   
+000084e0: 2020 2020 2020 2020 2020 2020 204f 7074               Opt
+000084f0: 696f 6e61 6c6c 792c 2069 6e73 7465 6164  ionally, instead
+00008500: 206f 6620 7061 7373 696e 6720 6069 6e70   of passing `inp
+00008510: 7574 5f69 6473 6020 796f 7520 6361 6e20  ut_ids` you can 
+00008520: 6368 6f6f 7365 2074 6f20 6469 7265 6374  choose to direct
+00008530: 6c79 2070 6173 7320 616e 2065 6d62 6564  ly pass an embed
+00008540: 6465 6420 7265 7072 6573 656e 7461 7469  ded representati
+00008550: 6f6e 2e0a 2020 2020 2020 2020 2020 2020  on..            
+00008560: 2020 2020 5468 6973 2069 7320 7573 6566      This is usef
+00008570: 756c 2069 6620 796f 7520 7761 6e74 206d  ul if you want m
+00008580: 6f72 6520 636f 6e74 726f 6c20 6f76 6572  ore control over
+00008590: 2068 6f77 2074 6f20 636f 6e76 6572 7420   how to convert 
+000085a0: 6069 6e70 7574 5f69 6473 6020 696e 6469  `input_ids` indi
+000085b0: 6365 7320 696e 746f 2061 7373 6f63 6961  ces into associa
+000085c0: 7465 6420 7665 6374 6f72 730a 2020 2020  ted vectors.    
+000085d0: 2020 2020 2020 2020 2020 2020 7468 616e              than
+000085e0: 2074 6865 206d 6f64 656c 2773 2069 6e74   the model's int
+000085f0: 6572 6e61 6c20 656d 6265 6464 696e 6720  ernal embedding 
+00008600: 6c6f 6f6b 7570 206d 6174 7269 782e 0a20  lookup matrix.. 
+00008610: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
+00008620: 745f 6174 7465 6e74 696f 6e73 2028 6062  t_attentions (`b
+00008630: 6f6f 6c60 2c20 2a6f 7074 696f 6e61 6c2a  ool`, *optional*
+00008640: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00008650: 2020 2057 6865 7468 6572 206f 7220 6e6f     Whether or no
+00008660: 7420 746f 2072 6574 7572 6e20 7468 6520  t to return the 
+00008670: 6174 7465 6e74 696f 6e73 2074 656e 736f  attentions tenso
+00008680: 7273 206f 6620 616c 6c20 6174 7465 6e74  rs of all attent
+00008690: 696f 6e20 6c61 7965 7273 2e20 5365 6520  ion layers. See 
+000086a0: 6061 7474 656e 7469 6f6e 7360 2075 6e64  `attentions` und
+000086b0: 6572 0a20 2020 2020 2020 2020 2020 2020  er.             
+000086c0: 2020 2072 6574 7572 6e65 6420 7465 6e73     returned tens
+000086d0: 6f72 7320 666f 7220 6d6f 7265 2064 6574  ors for more det
+000086e0: 6169 6c2e 0a20 2020 2020 2020 2020 2020  ail..           
+000086f0: 206f 7574 7075 745f 6869 6464 656e 5f73   output_hidden_s
+00008700: 7461 7465 7320 2860 626f 6f6c 602c 202a  tates (`bool`, *
+00008710: 6f70 7469 6f6e 616c 2a29 3a0a 2020 2020  optional*):.    
+00008720: 2020 2020 2020 2020 2020 2020 5768 6574              Whet
+00008730: 6865 7220 6f72 206e 6f74 2074 6f20 7265  her or not to re
+00008740: 7475 726e 2074 6865 2068 6964 6465 6e20  turn the hidden 
+00008750: 7374 6174 6573 206f 6620 616c 6c20 6c61  states of all la
+00008760: 7965 7273 2e20 5365 6520 6068 6964 6465  yers. See `hidde
+00008770: 6e5f 7374 6174 6573 6020 756e 6465 7220  n_states` under 
+00008780: 7265 7475 726e 6564 2074 656e 736f 7273  returned tensors
+00008790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000087a0: 2066 6f72 206d 6f72 6520 6465 7461 696c   for more detail
+000087b0: 2e0a 2020 2020 2020 2020 2020 2020 7265  ..            re
+000087c0: 7475 726e 5f64 6963 7420 2860 626f 6f6c  turn_dict (`bool
+000087d0: 602c 202a 6f70 7469 6f6e 616c 2a29 3a0a  `, *optional*):.
+000087e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000087f0: 5768 6574 6865 7220 6f72 206e 6f74 2074  Whether or not t
+00008800: 6f20 7265 7475 726e 2061 205b 607e 7574  o return a [`~ut
+00008810: 696c 732e 4d6f 6465 6c4f 7574 7075 7460  ils.ModelOutput`
+00008820: 5d20 696e 7374 6561 6420 6f66 2061 2070  ] instead of a p
+00008830: 6c61 696e 2074 7570 6c65 2e0a 2020 2020  lain tuple..    
+00008840: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00008850: 6f75 7470 7574 5f61 7474 656e 7469 6f6e  output_attention
+00008860: 7320 3d20 6f75 7470 7574 5f61 7474 656e  s = output_atten
+00008870: 7469 6f6e 7320 6966 206f 7574 7075 745f  tions if output_
+00008880: 6174 7465 6e74 696f 6e73 2069 7320 6e6f  attentions is no
+00008890: 7420 4e6f 6e65 2065 6c73 6520 7365 6c66  t None else self
+000088a0: 2e63 6f6e 6669 672e 6f75 7470 7574 5f61  .config.output_a
+000088b0: 7474 656e 7469 6f6e 730a 2020 2020 2020  ttentions.      
+000088c0: 2020 6f75 7470 7574 5f68 6964 6465 6e5f    output_hidden_
+000088d0: 7374 6174 6573 203d 2028 0a20 2020 2020  states = (.     
+000088e0: 2020 2020 2020 206f 7574 7075 745f 6869         output_hi
+000088f0: 6464 656e 5f73 7461 7465 7320 6966 206f  dden_states if o
+00008900: 7574 7075 745f 6869 6464 656e 5f73 7461  utput_hidden_sta
+00008910: 7465 7320 6973 206e 6f74 204e 6f6e 6520  tes is not None 
+00008920: 656c 7365 2073 656c 662e 636f 6e66 6967  else self.config
+00008930: 2e6f 7574 7075 745f 6869 6464 656e 5f73  .output_hidden_s
+00008940: 7461 7465 730a 2020 2020 2020 2020 290a  tates.        ).
+00008950: 2020 2020 2020 2020 7573 655f 6361 6368          use_cach
+00008960: 6520 3d20 7573 655f 6361 6368 6520 6966  e = use_cache if
+00008970: 2075 7365 5f63 6163 6865 2069 7320 6e6f   use_cache is no
+00008980: 7420 4e6f 6e65 2065 6c73 6520 7365 6c66  t None else self
+00008990: 2e63 6f6e 6669 672e 7573 655f 6361 6368  .config.use_cach
+000089a0: 650a 2020 2020 2020 2020 7265 7475 726e  e.        return
+000089b0: 5f64 6963 7420 3d20 7265 7475 726e 5f64  _dict = return_d
+000089c0: 6963 7420 6966 2072 6574 7572 6e5f 6469  ict if return_di
+000089d0: 6374 2069 7320 6e6f 7420 4e6f 6e65 2065  ct is not None e
+000089e0: 6c73 6520 7365 6c66 2e63 6f6e 6669 672e  lse self.config.
+000089f0: 7573 655f 7265 7475 726e 5f64 6963 740a  use_return_dict.
+00008a00: 0a20 2020 2020 2020 2023 2072 6574 7269  .        # retri
+00008a10: 6576 6520 696e 7075 745f 6964 7320 616e  eve input_ids an
+00008a20: 6420 696e 7075 7473 5f65 6d62 6564 730a  d inputs_embeds.
+00008a30: 2020 2020 2020 2020 6966 2069 6e70 7574          if input
+00008a40: 5f69 6473 2069 7320 6e6f 7420 4e6f 6e65  _ids is not None
+00008a50: 2061 6e64 2069 6e70 7574 735f 656d 6265   and inputs_embe
+00008a60: 6473 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ds is not None:.
+00008a70: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00008a80: 6520 5661 6c75 6545 7272 6f72 2822 596f  e ValueError("Yo
+00008a90: 7520 6361 6e6e 6f74 2073 7065 6369 6679  u cannot specify
+00008aa0: 2062 6f74 6820 6465 636f 6465 725f 696e   both decoder_in
+00008ab0: 7075 745f 6964 7320 616e 6420 6465 636f  put_ids and deco
+00008ac0: 6465 725f 696e 7075 7473 5f65 6d62 6564  der_inputs_embed
+00008ad0: 7320 6174 2074 6865 2073 616d 6520 7469  s at the same ti
+00008ae0: 6d65 2229 0a20 2020 2020 2020 2065 6c69  me").        eli
+00008af0: 6620 696e 7075 745f 6964 7320 6973 206e  f input_ids is n
+00008b00: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00008b10: 2020 2020 2069 6e70 7574 5f73 6861 7065       input_shape
+00008b20: 203d 2069 6e70 7574 5f69 6473 2e73 6861   = input_ids.sha
+00008b30: 7065 0a20 2020 2020 2020 2020 2020 2069  pe.            i
+00008b40: 6e70 7574 5f69 6473 203d 2069 6e70 7574  nput_ids = input
+00008b50: 5f69 6473 2e76 6965 7728 2d31 2c20 696e  _ids.view(-1, in
+00008b60: 7075 745f 7368 6170 655b 2d31 5d29 0a20  put_shape[-1]). 
+00008b70: 2020 2020 2020 2065 6c69 6620 696e 7075         elif inpu
+00008b80: 7473 5f65 6d62 6564 7320 6973 206e 6f74  ts_embeds is not
+00008b90: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00008ba0: 2020 2069 6e70 7574 5f73 6861 7065 203d     input_shape =
+00008bb0: 2069 6e70 7574 735f 656d 6265 6473 2e73   inputs_embeds.s
+00008bc0: 6861 7065 5b3a 2d31 5d0a 2020 2020 2020  hape[:-1].      
+00008bd0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00008be0: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+00008bf0: 7272 6f72 2822 596f 7520 6861 7665 2074  rror("You have t
+00008c00: 6f20 7370 6563 6966 7920 6569 7468 6572  o specify either
+00008c10: 2064 6563 6f64 6572 5f69 6e70 7574 5f69   decoder_input_i
+00008c20: 6473 206f 7220 6465 636f 6465 725f 696e  ds or decoder_in
+00008c30: 7075 7473 5f65 6d62 6564 7322 290a 0a20  puts_embeds").. 
+00008c40: 2020 2020 2020 2023 2070 6173 745f 6b65         # past_ke
+00008c50: 795f 7661 6c75 6573 5f6c 656e 6774 680a  y_values_length.
+00008c60: 2020 2020 2020 2020 7061 7374 5f6b 6579          past_key
+00008c70: 5f76 616c 7565 735f 6c65 6e67 7468 203d  _values_length =
+00008c80: 2070 6173 745f 6b65 795f 7661 6c75 6573   past_key_values
+00008c90: 5b30 5d5b 305d 2e73 6861 7065 5b32 5d20  [0][0].shape[2] 
+00008ca0: 6966 2070 6173 745f 6b65 795f 7661 6c75  if past_key_valu
+00008cb0: 6573 2069 7320 6e6f 7420 4e6f 6e65 2065  es is not None e
+00008cc0: 6c73 6520 300a 0a20 2020 2020 2020 2069  lse 0..        i
+00008cd0: 6620 696e 7075 7473 5f65 6d62 6564 7320  f inputs_embeds 
+00008ce0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00008cf0: 2020 2020 2069 6e70 7574 735f 656d 6265       inputs_embe
+00008d00: 6473 203d 2073 656c 662e 656d 6265 645f  ds = self.embed_
+00008d10: 746f 6b65 6e73 2869 6e70 7574 5f69 6473  tokens(input_ids
+00008d20: 2920 2a20 7365 6c66 2e65 6d62 6564 5f73  ) * self.embed_s
+00008d30: 6361 6c65 0a0a 2020 2020 2020 2020 6174  cale..        at
+00008d40: 7465 6e74 696f 6e5f 6d61 736b 203d 205f  tention_mask = _
+00008d50: 7072 6570 6172 655f 3464 5f63 6175 7361  prepare_4d_causa
+00008d60: 6c5f 6174 7465 6e74 696f 6e5f 6d61 736b  l_attention_mask
+00008d70: 280a 2020 2020 2020 2020 2020 2020 6174  (.            at
+00008d80: 7465 6e74 696f 6e5f 6d61 736b 2c20 696e  tention_mask, in
+00008d90: 7075 745f 7368 6170 652c 2069 6e70 7574  put_shape, input
+00008da0: 735f 656d 6265 6473 2c20 7061 7374 5f6b  s_embeds, past_k
+00008db0: 6579 5f76 616c 7565 735f 6c65 6e67 7468  ey_values_length
+00008dc0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00008dd0: 2020 2020 2320 6578 7061 6e64 2065 6e63      # expand enc
+00008de0: 6f64 6572 2061 7474 656e 7469 6f6e 206d  oder attention m
+00008df0: 6173 6b0a 2020 2020 2020 2020 6966 2065  ask.        if e
+00008e00: 6e63 6f64 6572 5f68 6964 6465 6e5f 7374  ncoder_hidden_st
+00008e10: 6174 6573 2069 7320 6e6f 7420 4e6f 6e65  ates is not None
+00008e20: 2061 6e64 2065 6e63 6f64 6572 5f61 7474   and encoder_att
+00008e30: 656e 7469 6f6e 5f6d 6173 6b20 6973 206e  ention_mask is n
+00008e40: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00008e50: 2020 2020 2023 205b 6273 7a2c 2073 6571       # [bsz, seq
+00008e60: 5f6c 656e 5d20 2d3e 205b 6273 7a2c 2031  _len] -> [bsz, 1
+00008e70: 2c20 7467 745f 7365 715f 6c65 6e2c 2073  , tgt_seq_len, s
+00008e80: 7263 5f73 6571 5f6c 656e 5d0a 2020 2020  rc_seq_len].    
+00008e90: 2020 2020 2020 2020 656e 636f 6465 725f          encoder_
+00008ea0: 6174 7465 6e74 696f 6e5f 6d61 736b 203d  attention_mask =
+00008eb0: 205f 7072 6570 6172 655f 3464 5f61 7474   _prepare_4d_att
+00008ec0: 656e 7469 6f6e 5f6d 6173 6b28 0a20 2020  ention_mask(.   
+00008ed0: 2020 2020 2020 2020 2020 2020 2065 6e63               enc
+00008ee0: 6f64 6572 5f61 7474 656e 7469 6f6e 5f6d  oder_attention_m
+00008ef0: 6173 6b2c 2069 6e70 7574 735f 656d 6265  ask, inputs_embe
+00008f00: 6473 2e64 7479 7065 2c20 7467 745f 6c65  ds.dtype, tgt_le
+00008f10: 6e3d 696e 7075 745f 7368 6170 655b 2d31  n=input_shape[-1
+00008f20: 5d0a 2020 2020 2020 2020 2020 2020 290a  ].            ).
+00008f30: 0a20 2020 2020 2020 2023 2065 6d62 6564  .        # embed
+00008f40: 2070 6f73 6974 696f 6e73 0a20 2020 2020   positions.     
+00008f50: 2020 2070 6f73 6974 696f 6e73 203d 2073     positions = s
+00008f60: 656c 662e 656d 6265 645f 706f 7369 7469  elf.embed_positi
+00008f70: 6f6e 7328 696e 7075 745f 7368 6170 652c  ons(input_shape,
+00008f80: 2070 6173 745f 6b65 795f 7661 6c75 6573   past_key_values
+00008f90: 5f6c 656e 6774 6829 0a0a 2020 2020 2020  _length)..      
+00008fa0: 2020 6869 6464 656e 5f73 7461 7465 7320    hidden_states 
+00008fb0: 3d20 696e 7075 7473 5f65 6d62 6564 7320  = inputs_embeds 
+00008fc0: 2b20 706f 7369 7469 6f6e 730a 0a20 2020  + positions..   
+00008fd0: 2020 2020 2068 6964 6465 6e5f 7374 6174       hidden_stat
+00008fe0: 6573 203d 206f 7073 2e64 726f 706f 7574  es = ops.dropout
+00008ff0: 2868 6964 6465 6e5f 7374 6174 6573 2c20  (hidden_states, 
+00009000: 703d 7365 6c66 2e64 726f 706f 7574 2c20  p=self.dropout, 
+00009010: 7472 6169 6e69 6e67 3d73 656c 662e 7472  training=self.tr
+00009020: 6169 6e69 6e67 290a 0a20 2020 2020 2020  aining)..       
+00009030: 2069 6620 7365 6c66 2e67 7261 6469 656e   if self.gradien
+00009040: 745f 6368 6563 6b70 6f69 6e74 696e 6720  t_checkpointing 
+00009050: 616e 6420 7365 6c66 2e74 7261 696e 696e  and self.trainin
+00009060: 673a 0a20 2020 2020 2020 2020 2020 2069  g:.            i
+00009070: 6620 7573 655f 6361 6368 653a 0a20 2020  f use_cache:.   
+00009080: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+00009090: 6765 722e 7761 726e 696e 6728 0a20 2020  ger.warning(.   
+000090a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000090b0: 2022 6075 7365 5f63 6163 6865 3d54 7275   "`use_cache=Tru
+000090c0: 6560 2069 7320 696e 636f 6d70 6174 6962  e` is incompatib
+000090d0: 6c65 2077 6974 6820 6772 6164 6965 6e74  le with gradient
+000090e0: 2063 6865 636b 706f 696e 7469 6e67 2e20   checkpointing. 
+000090f0: 5365 7474 696e 6720 6075 7365 5f63 6163  Setting `use_cac
+00009100: 6865 3d46 616c 7365 602e 2e2e 220a 2020  he=False`...".  
+00009110: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00009120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009130: 7573 655f 6361 6368 6520 3d20 4661 6c73  use_cache = Fals
+00009140: 650a 2020 2020 2020 2020 2320 6465 636f  e.        # deco
+00009150: 6465 7220 6c61 7965 7273 0a20 2020 2020  der layers.     
+00009160: 2020 2061 6c6c 5f68 6964 6465 6e5f 7374     all_hidden_st
+00009170: 6174 6573 203d 2028 2920 6966 206f 7574  ates = () if out
+00009180: 7075 745f 6869 6464 656e 5f73 7461 7465  put_hidden_state
+00009190: 7320 656c 7365 204e 6f6e 650a 2020 2020  s else None.    
+000091a0: 2020 2020 616c 6c5f 7365 6c66 5f61 7474      all_self_att
+000091b0: 6e73 203d 2028 2920 6966 206f 7574 7075  ns = () if outpu
+000091c0: 745f 6174 7465 6e74 696f 6e73 2065 6c73  t_attentions els
+000091d0: 6520 4e6f 6e65 0a20 2020 2020 2020 2061  e None.        a
+000091e0: 6c6c 5f63 726f 7373 5f61 7474 656e 7469  ll_cross_attenti
+000091f0: 6f6e 7320 3d20 2829 2069 6620 286f 7574  ons = () if (out
+00009200: 7075 745f 6174 7465 6e74 696f 6e73 2061  put_attentions a
+00009210: 6e64 2065 6e63 6f64 6572 5f68 6964 6465  nd encoder_hidde
+00009220: 6e5f 7374 6174 6573 2069 7320 6e6f 7420  n_states is not 
+00009230: 4e6f 6e65 2920 656c 7365 204e 6f6e 650a  None) else None.
+00009240: 2020 2020 2020 2020 6e65 7874 5f64 6563          next_dec
+00009250: 6f64 6572 5f63 6163 6865 203d 2028 2920  oder_cache = () 
+00009260: 6966 2075 7365 5f63 6163 6865 2065 6c73  if use_cache els
+00009270: 6520 4e6f 6e65 0a0a 2020 2020 2020 2020  e None..        
+00009280: 2320 6368 6563 6b20 6966 2068 6561 645f  # check if head_
+00009290: 6d61 736b 2f63 726f 7373 5f61 7474 6e5f  mask/cross_attn_
+000092a0: 6865 6164 5f6d 6173 6b20 6861 7320 6120  head_mask has a 
+000092b0: 636f 7272 6563 7420 6e75 6d62 6572 206f  correct number o
+000092c0: 6620 6c61 7965 7273 2073 7065 6369 6669  f layers specifi
+000092d0: 6564 2069 6620 6465 7369 7265 640a 2020  ed if desired.  
+000092e0: 2020 2020 2020 666f 7220 6174 746e 5f6d        for attn_m
+000092f0: 6173 6b2c 206d 6173 6b5f 6e61 6d65 2069  ask, mask_name i
+00009300: 6e20 7a69 7028 5b68 6561 645f 6d61 736b  n zip([head_mask
+00009310: 2c20 6372 6f73 735f 6174 746e 5f68 6561  , cross_attn_hea
+00009320: 645f 6d61 736b 5d2c 205b 2268 6561 645f  d_mask], ["head_
+00009330: 6d61 736b 222c 2022 6372 6f73 735f 6174  mask", "cross_at
+00009340: 746e 5f68 6561 645f 6d61 736b 225d 293a  tn_head_mask"]):
+00009350: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00009360: 6174 746e 5f6d 6173 6b20 6973 206e 6f74  attn_mask is not
+00009370: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00009380: 2020 2020 2020 2069 6620 6174 746e 5f6d         if attn_m
+00009390: 6173 6b2e 7368 6170 655b 305d 2021 3d20  ask.shape[0] != 
+000093a0: 6c65 6e28 7365 6c66 2e6c 6179 6572 7329  len(self.layers)
+000093b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000093c0: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
+000093d0: 6545 7272 6f72 280a 2020 2020 2020 2020  eError(.        
+000093e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000093f0: 6622 5468 6520 607b 6d61 736b 5f6e 616d  f"The `{mask_nam
+00009400: 657d 6020 7368 6f75 6c64 2062 6520 7370  e}` should be sp
+00009410: 6563 6966 6965 6420 666f 7220 7b6c 656e  ecified for {len
+00009420: 2873 656c 662e 6c61 7965 7273 297d 206c  (self.layers)} l
+00009430: 6179 6572 732c 2062 7574 2069 7420 6973  ayers, but it is
+00009440: 2066 6f72 220a 2020 2020 2020 2020 2020   for".          
+00009450: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+00009460: 207b 6865 6164 5f6d 6173 6b2e 7368 6170   {head_mask.shap
+00009470: 655b 305d 7d2e 220a 2020 2020 2020 2020  e[0]}.".        
+00009480: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00009490: 2020 2020 2020 666f 7220 6964 782c 2064        for idx, d
+000094a0: 6563 6f64 6572 5f6c 6179 6572 2069 6e20  ecoder_layer in 
+000094b0: 656e 756d 6572 6174 6528 7365 6c66 2e6c  enumerate(self.l
+000094c0: 6179 6572 7329 3a0a 2020 2020 2020 2020  ayers):.        
+000094d0: 2020 2020 2320 6164 6420 4c61 7965 7244      # add LayerD
+000094e0: 726f 7020 2873 6565 2068 7474 7073 3a2f  rop (see https:/
+000094f0: 2f61 7278 6976 2e6f 7267 2f61 6273 2f31  /arxiv.org/abs/1
+00009500: 3930 392e 3131 3535 3620 666f 7220 6465  909.11556 for de
+00009510: 7363 7269 7074 696f 6e29 0a20 2020 2020  scription).     
+00009520: 2020 2020 2020 2069 6620 6f75 7470 7574         if output
+00009530: 5f68 6964 6465 6e5f 7374 6174 6573 3a0a  _hidden_states:.
+00009540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009550: 616c 6c5f 6869 6464 656e 5f73 7461 7465  all_hidden_state
+00009560: 7320 2b3d 2028 6869 6464 656e 5f73 7461  s += (hidden_sta
+00009570: 7465 732c 290a 2020 2020 2020 2020 2020  tes,).          
+00009580: 2020 6966 2073 656c 662e 7472 6169 6e69    if self.traini
+00009590: 6e67 3a0a 2020 2020 2020 2020 2020 2020  ng:.            
+000095a0: 2020 2020 6472 6f70 6f75 745f 7072 6f62      dropout_prob
+000095b0: 6162 696c 6974 7920 3d20 6f70 732e 7261  ability = ops.ra
+000095c0: 6e64 285b 5d29 0a20 2020 2020 2020 2020  nd([]).         
+000095d0: 2020 2020 2020 2069 6620 6472 6f70 6f75         if dropou
+000095e0: 745f 7072 6f62 6162 696c 6974 7920 3c20  t_probability < 
+000095f0: 7365 6c66 2e6c 6179 6572 6472 6f70 3a0a  self.layerdrop:.
+00009600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009610: 2020 2020 636f 6e74 696e 7565 0a0a 2020      continue..  
+00009620: 2020 2020 2020 2020 2020 7061 7374 5f6b            past_k
+00009630: 6579 5f76 616c 7565 203d 2070 6173 745f  ey_value = past_
+00009640: 6b65 795f 7661 6c75 6573 5b69 6478 5d20  key_values[idx] 
+00009650: 6966 2070 6173 745f 6b65 795f 7661 6c75  if past_key_valu
+00009660: 6573 2069 7320 6e6f 7420 4e6f 6e65 2065  es is not None e
+00009670: 6c73 6520 4e6f 6e65 0a0a 2020 2020 2020  lse None..      
+00009680: 2020 2020 2020 6966 2073 656c 662e 6772        if self.gr
+00009690: 6164 6965 6e74 5f63 6865 636b 706f 696e  adient_checkpoin
+000096a0: 7469 6e67 2061 6e64 2073 656c 662e 7472  ting and self.tr
+000096b0: 6169 6e69 6e67 3a0a 2020 2020 2020 2020  aining:.        
+000096c0: 2020 2020 2020 2020 6c61 7965 725f 6f75          layer_ou
+000096d0: 7470 7574 7320 3d20 7365 6c66 2e5f 6772  tputs = self._gr
+000096e0: 6164 6965 6e74 5f63 6865 636b 706f 696e  adient_checkpoin
+000096f0: 7469 6e67 5f66 756e 6328 0a20 2020 2020  ting_func(.     
+00009700: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00009710: 6563 6f64 6572 5f6c 6179 6572 2e5f 5f63  ecoder_layer.__c
+00009720: 616c 6c5f 5f2c 0a20 2020 2020 2020 2020  all__,.         
+00009730: 2020 2020 2020 2020 2020 2068 6964 6465             hidde
+00009740: 6e5f 7374 6174 6573 2c0a 2020 2020 2020  n_states,.      
+00009750: 2020 2020 2020 2020 2020 2020 2020 6174                at
+00009760: 7465 6e74 696f 6e5f 6d61 736b 2c0a 2020  tention_mask,.  
+00009770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009780: 2020 656e 636f 6465 725f 6869 6464 656e    encoder_hidden
+00009790: 5f73 7461 7465 732c 0a20 2020 2020 2020  _states,.       
+000097a0: 2020 2020 2020 2020 2020 2020 2065 6e63               enc
+000097b0: 6f64 6572 5f61 7474 656e 7469 6f6e 5f6d  oder_attention_m
+000097c0: 6173 6b2c 0a20 2020 2020 2020 2020 2020  ask,.           
+000097d0: 2020 2020 2020 2020 2068 6561 645f 6d61           head_ma
+000097e0: 736b 5b69 6478 5d20 6966 2068 6561 645f  sk[idx] if head_
+000097f0: 6d61 736b 2069 7320 6e6f 7420 4e6f 6e65  mask is not None
+00009800: 2065 6c73 6520 4e6f 6e65 2c0a 2020 2020   else None,.    
+00009810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009820: 6372 6f73 735f 6174 746e 5f68 6561 645f  cross_attn_head_
+00009830: 6d61 736b 5b69 6478 5d20 6966 2063 726f  mask[idx] if cro
+00009840: 7373 5f61 7474 6e5f 6865 6164 5f6d 6173  ss_attn_head_mas
+00009850: 6b20 6973 206e 6f74 204e 6f6e 6520 656c  k is not None el
+00009860: 7365 204e 6f6e 652c 0a20 2020 2020 2020  se None,.       
+00009870: 2020 2020 2020 2020 2020 2020 204e 6f6e               Non
+00009880: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00009890: 2020 2020 2020 206f 7574 7075 745f 6174         output_at
+000098a0: 7465 6e74 696f 6e73 2c0a 2020 2020 2020  tentions,.      
+000098b0: 2020 2020 2020 2020 2020 2020 2020 7573                us
+000098c0: 655f 6361 6368 652c 0a20 2020 2020 2020  e_cache,.       
+000098d0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+000098e0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000098f0: 2020 2020 2020 2020 2020 2020 206c 6179               lay
+00009900: 6572 5f6f 7574 7075 7473 203d 2064 6563  er_outputs = dec
+00009910: 6f64 6572 5f6c 6179 6572 280a 2020 2020  oder_layer(.    
+00009920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009930: 6869 6464 656e 5f73 7461 7465 732c 0a20  hidden_states,. 
+00009940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009950: 2020 2061 7474 656e 7469 6f6e 5f6d 6173     attention_mas
+00009960: 6b3d 6174 7465 6e74 696f 6e5f 6d61 736b  k=attention_mask
+00009970: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00009980: 2020 2020 2020 656e 636f 6465 725f 6869        encoder_hi
+00009990: 6464 656e 5f73 7461 7465 733d 656e 636f  dden_states=enco
+000099a0: 6465 725f 6869 6464 656e 5f73 7461 7465  der_hidden_state
+000099b0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+000099c0: 2020 2020 2020 2065 6e63 6f64 6572 5f61         encoder_a
+000099d0: 7474 656e 7469 6f6e 5f6d 6173 6b3d 656e  ttention_mask=en
+000099e0: 636f 6465 725f 6174 7465 6e74 696f 6e5f  coder_attention_
+000099f0: 6d61 736b 2c0a 2020 2020 2020 2020 2020  mask,.          
+00009a00: 2020 2020 2020 2020 2020 6c61 7965 725f            layer_
+00009a10: 6865 6164 5f6d 6173 6b3d 2868 6561 645f  head_mask=(head_
+00009a20: 6d61 736b 5b69 6478 5d20 6966 2068 6561  mask[idx] if hea
+00009a30: 645f 6d61 736b 2069 7320 6e6f 7420 4e6f  d_mask is not No
+00009a40: 6e65 2065 6c73 6520 4e6f 6e65 292c 0a20  ne else None),. 
+00009a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009a60: 2020 2063 726f 7373 5f61 7474 6e5f 6c61     cross_attn_la
+00009a70: 7965 725f 6865 6164 5f6d 6173 6b3d 280a  yer_head_mask=(.
+00009a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009a90: 2020 2020 2020 2020 6372 6f73 735f 6174          cross_at
+00009aa0: 746e 5f68 6561 645f 6d61 736b 5b69 6478  tn_head_mask[idx
+00009ab0: 5d20 6966 2063 726f 7373 5f61 7474 6e5f  ] if cross_attn_
+00009ac0: 6865 6164 5f6d 6173 6b20 6973 206e 6f74  head_mask is not
+00009ad0: 204e 6f6e 6520 656c 7365 204e 6f6e 650a   None else None.
+00009ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009af0: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
+00009b00: 2020 2020 2020 2020 2020 2070 6173 745f             past_
+00009b10: 6b65 795f 7661 6c75 653d 7061 7374 5f6b  key_value=past_k
+00009b20: 6579 5f76 616c 7565 2c0a 2020 2020 2020  ey_value,.      
+00009b30: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
+00009b40: 7470 7574 5f61 7474 656e 7469 6f6e 733d  tput_attentions=
+00009b50: 6f75 7470 7574 5f61 7474 656e 7469 6f6e  output_attention
+00009b60: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+00009b70: 2020 2020 2020 2075 7365 5f63 6163 6865         use_cache
+00009b80: 3d75 7365 5f63 6163 6865 2c0a 2020 2020  =use_cache,.    
+00009b90: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00009ba0: 2020 2020 2020 2020 2020 6869 6464 656e            hidden
+00009bb0: 5f73 7461 7465 7320 3d20 6c61 7965 725f  _states = layer_
+00009bc0: 6f75 7470 7574 735b 305d 0a0a 2020 2020  outputs[0]..    
+00009bd0: 2020 2020 2020 2020 6966 2075 7365 5f63          if use_c
+00009be0: 6163 6865 3a0a 2020 2020 2020 2020 2020  ache:.          
+00009bf0: 2020 2020 2020 6e65 7874 5f64 6563 6f64        next_decod
+00009c00: 6572 5f63 6163 6865 202b 3d20 286c 6179  er_cache += (lay
+00009c10: 6572 5f6f 7574 7075 7473 5b33 2069 6620  er_outputs[3 if 
+00009c20: 6f75 7470 7574 5f61 7474 656e 7469 6f6e  output_attention
+00009c30: 7320 656c 7365 2031 5d2c 290a 0a20 2020  s else 1],)..   
+00009c40: 2020 2020 2020 2020 2069 6620 6f75 7470           if outp
+00009c50: 7574 5f61 7474 656e 7469 6f6e 733a 0a20  ut_attentions:. 
+00009c60: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00009c70: 6c6c 5f73 656c 665f 6174 746e 7320 2b3d  ll_self_attns +=
+00009c80: 2028 6c61 7965 725f 6f75 7470 7574 735b   (layer_outputs[
+00009c90: 315d 2c29 0a0a 2020 2020 2020 2020 2020  1],)..          
+00009ca0: 2020 2020 2020 6966 2065 6e63 6f64 6572        if encoder
+00009cb0: 5f68 6964 6465 6e5f 7374 6174 6573 2069  _hidden_states i
+00009cc0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00009cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009ce0: 616c 6c5f 6372 6f73 735f 6174 7465 6e74  all_cross_attent
+00009cf0: 696f 6e73 202b 3d20 286c 6179 6572 5f6f  ions += (layer_o
+00009d00: 7574 7075 7473 5b32 5d2c 290a 0a20 2020  utputs[2],)..   
+00009d10: 2020 2020 2023 2061 6464 2066 696e 616c       # add final
+00009d20: 206c 6179 6572 206e 6f72 6d0a 2020 2020   layer norm.    
+00009d30: 2020 2020 6869 6464 656e 5f73 7461 7465      hidden_state
+00009d40: 7320 3d20 7365 6c66 2e6c 6179 6572 5f6e  s = self.layer_n
+00009d50: 6f72 6d28 6869 6464 656e 5f73 7461 7465  orm(hidden_state
+00009d60: 7329 0a0a 2020 2020 2020 2020 2320 6164  s)..        # ad
+00009d70: 6420 6869 6464 656e 2073 7461 7465 7320  d hidden states 
+00009d80: 6672 6f6d 2074 6865 206c 6173 7420 6465  from the last de
+00009d90: 636f 6465 7220 6c61 7965 720a 2020 2020  coder layer.    
+00009da0: 2020 2020 6966 206f 7574 7075 745f 6869      if output_hi
+00009db0: 6464 656e 5f73 7461 7465 733a 0a20 2020  dden_states:.   
+00009dc0: 2020 2020 2020 2020 2061 6c6c 5f68 6964           all_hid
+00009dd0: 6465 6e5f 7374 6174 6573 202b 3d20 2868  den_states += (h
+00009de0: 6964 6465 6e5f 7374 6174 6573 2c29 0a0a  idden_states,)..
+00009df0: 2020 2020 2020 2020 6e65 7874 5f63 6163          next_cac
+00009e00: 6865 203d 206e 6578 745f 6465 636f 6465  he = next_decode
+00009e10: 725f 6361 6368 6520 6966 2075 7365 5f63  r_cache if use_c
+00009e20: 6163 6865 2065 6c73 6520 4e6f 6e65 0a20  ache else None. 
+00009e30: 2020 2020 2020 2069 6620 6e6f 7420 7265         if not re
+00009e40: 7475 726e 5f64 6963 743a 0a20 2020 2020  turn_dict:.     
+00009e50: 2020 2020 2020 2072 6574 7572 6e20 7475         return tu
+00009e60: 706c 6528 0a20 2020 2020 2020 2020 2020  ple(.           
+00009e70: 2020 2020 2076 0a20 2020 2020 2020 2020       v.         
+00009e80: 2020 2020 2020 2066 6f72 2076 2069 6e20         for v in 
+00009e90: 5b68 6964 6465 6e5f 7374 6174 6573 2c20  [hidden_states, 
+00009ea0: 6e65 7874 5f63 6163 6865 2c20 616c 6c5f  next_cache, all_
+00009eb0: 6869 6464 656e 5f73 7461 7465 732c 2061  hidden_states, a
+00009ec0: 6c6c 5f73 656c 665f 6174 746e 732c 2061  ll_self_attns, a
+00009ed0: 6c6c 5f63 726f 7373 5f61 7474 656e 7469  ll_cross_attenti
+00009ee0: 6f6e 735d 0a20 2020 2020 2020 2020 2020  ons].           
+00009ef0: 2020 2020 2069 6620 7620 6973 206e 6f74       if v is not
+00009f00: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
+00009f10: 2020 290a 2020 2020 2020 2020 7265 7475    ).        retu
+00009f20: 726e 2042 6173 654d 6f64 656c 4f75 7470  rn BaseModelOutp
+00009f30: 7574 5769 7468 5061 7374 416e 6443 726f  utWithPastAndCro
+00009f40: 7373 4174 7465 6e74 696f 6e73 280a 2020  ssAttentions(.  
+00009f50: 2020 2020 2020 2020 2020 6c61 7374 5f68            last_h
+00009f60: 6964 6465 6e5f 7374 6174 653d 6869 6464  idden_state=hidd
+00009f70: 656e 5f73 7461 7465 732c 0a20 2020 2020  en_states,.     
+00009f80: 2020 2020 2020 2070 6173 745f 6b65 795f         past_key_
+00009f90: 7661 6c75 6573 3d6e 6578 745f 6361 6368  values=next_cach
+00009fa0: 652c 0a20 2020 2020 2020 2020 2020 2068  e,.            h
+00009fb0: 6964 6465 6e5f 7374 6174 6573 3d61 6c6c  idden_states=all
+00009fc0: 5f68 6964 6465 6e5f 7374 6174 6573 2c0a  _hidden_states,.
+00009fd0: 2020 2020 2020 2020 2020 2020 6174 7465              atte
+00009fe0: 6e74 696f 6e73 3d61 6c6c 5f73 656c 665f  ntions=all_self_
+00009ff0: 6174 746e 732c 0a20 2020 2020 2020 2020  attns,.         
+0000a000: 2020 2063 726f 7373 5f61 7474 656e 7469     cross_attenti
+0000a010: 6f6e 733d 616c 6c5f 6372 6f73 735f 6174  ons=all_cross_at
+0000a020: 7465 6e74 696f 6e73 2c0a 2020 2020 2020  tentions,.      
+0000a030: 2020 290a 0a0a 636c 6173 7320 426c 656e    )...class Blen
+0000a040: 6465 7262 6f74 4d6f 6465 6c28 426c 656e  derbotModel(Blen
+0000a050: 6465 7262 6f74 5072 6554 7261 696e 6564  derbotPreTrained
+0000a060: 4d6f 6465 6c29 3a0a 2020 2020 5f74 6965  Model):.    _tie
+0000a070: 645f 7765 6967 6874 735f 6b65 7973 203d  d_weights_keys =
+0000a080: 205b 2264 6563 6f64 6572 2e65 6d62 6564   ["decoder.embed
+0000a090: 5f74 6f6b 656e 732e 7765 6967 6874 222c  _tokens.weight",
+0000a0a0: 2022 656e 636f 6465 722e 656d 6265 645f   "encoder.embed_
+0000a0b0: 746f 6b65 6e73 2e77 6569 6768 7422 5d0a  tokens.weight"].
+0000a0c0: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+0000a0d0: 5f28 7365 6c66 2c20 636f 6e66 6967 3a20  _(self, config: 
+0000a0e0: 426c 656e 6465 7262 6f74 436f 6e66 6967  BlenderbotConfig
+0000a0f0: 293a 0a20 2020 2020 2020 2073 7570 6572  ):.        super
+0000a100: 2829 2e5f 5f69 6e69 745f 5f28 636f 6e66  ().__init__(conf
+0000a110: 6967 290a 0a20 2020 2020 2020 2070 6164  ig)..        pad
+0000a120: 6469 6e67 5f69 6478 2c20 766f 6361 625f  ding_idx, vocab_
+0000a130: 7369 7a65 203d 2063 6f6e 6669 672e 7061  size = config.pa
+0000a140: 645f 746f 6b65 6e5f 6964 2c20 636f 6e66  d_token_id, conf
+0000a150: 6967 2e76 6f63 6162 5f73 697a 650a 2020  ig.vocab_size.  
+0000a160: 2020 2020 2020 7365 6c66 2e73 6861 7265        self.share
+0000a170: 6420 3d20 6e6e 2e45 6d62 6564 6469 6e67  d = nn.Embedding
+0000a180: 2876 6f63 6162 5f73 697a 652c 2063 6f6e  (vocab_size, con
+0000a190: 6669 672e 645f 6d6f 6465 6c2c 2070 6164  fig.d_model, pad
+0000a1a0: 6469 6e67 5f69 6478 290a 0a20 2020 2020  ding_idx)..     
+0000a1b0: 2020 2073 656c 662e 656e 636f 6465 7220     self.encoder 
+0000a1c0: 3d20 426c 656e 6465 7262 6f74 456e 636f  = BlenderbotEnco
+0000a1d0: 6465 7228 636f 6e66 6967 2c20 7365 6c66  der(config, self
+0000a1e0: 2e73 6861 7265 6429 0a20 2020 2020 2020  .shared).       
+0000a1f0: 2073 656c 662e 6465 636f 6465 7220 3d20   self.decoder = 
+0000a200: 426c 656e 6465 7262 6f74 4465 636f 6465  BlenderbotDecode
+0000a210: 7228 636f 6e66 6967 2c20 7365 6c66 2e73  r(config, self.s
+0000a220: 6861 7265 6429 0a0a 2020 2020 2020 2020  hared)..        
+0000a230: 2320 496e 6974 6961 6c69 7a65 2077 6569  # Initialize wei
+0000a240: 6768 7473 2061 6e64 2061 7070 6c79 2066  ghts and apply f
+0000a250: 696e 616c 2070 726f 6365 7373 696e 670a  inal processing.
+0000a260: 2020 2020 2020 2020 7365 6c66 2e70 6f73          self.pos
+0000a270: 745f 696e 6974 2829 0a0a 2020 2020 6465  t_init()..    de
+0000a280: 6620 6765 745f 696e 7075 745f 656d 6265  f get_input_embe
+0000a290: 6464 696e 6773 2873 656c 6629 3a0a 2020  ddings(self):.  
+0000a2a0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+0000a2b0: 662e 7368 6172 6564 0a0a 2020 2020 6465  f.shared..    de
+0000a2c0: 6620 7365 745f 696e 7075 745f 656d 6265  f set_input_embe
+0000a2d0: 6464 696e 6773 2873 656c 662c 2076 616c  ddings(self, val
+0000a2e0: 7565 293a 0a20 2020 2020 2020 2073 656c  ue):.        sel
+0000a2f0: 662e 7368 6172 6564 203d 2076 616c 7565  f.shared = value
+0000a300: 0a20 2020 2020 2020 2073 656c 662e 656e  .        self.en
+0000a310: 636f 6465 722e 656d 6265 645f 746f 6b65  coder.embed_toke
+0000a320: 6e73 203d 2073 656c 662e 7368 6172 6564  ns = self.shared
+0000a330: 0a20 2020 2020 2020 2073 656c 662e 6465  .        self.de
+0000a340: 636f 6465 722e 656d 6265 645f 746f 6b65  coder.embed_toke
+0000a350: 6e73 203d 2073 656c 662e 7368 6172 6564  ns = self.shared
+0000a360: 0a0a 2020 2020 6465 6620 6765 745f 656e  ..    def get_en
+0000a370: 636f 6465 7228 7365 6c66 293a 0a20 2020  coder(self):.   
+0000a380: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+0000a390: 2e65 6e63 6f64 6572 0a0a 2020 2020 6465  .encoder..    de
+0000a3a0: 6620 6765 745f 6465 636f 6465 7228 7365  f get_decoder(se
+0000a3b0: 6c66 293a 0a20 2020 2020 2020 2072 6574  lf):.        ret
+0000a3c0: 7572 6e20 7365 6c66 2e64 6563 6f64 6572  urn self.decoder
+0000a3d0: 0a0a 2020 2020 6465 6620 636f 6e73 7472  ..    def constr
+0000a3e0: 7563 7428 0a20 2020 2020 2020 2073 656c  uct(.        sel
+0000a3f0: 662c 0a20 2020 2020 2020 2069 6e70 7574  f,.        input
+0000a400: 5f69 6473 3a20 4f70 7469 6f6e 616c 5b6d  _ids: Optional[m
+0000a410: 696e 6473 706f 7265 2e54 656e 736f 725d  indspore.Tensor]
+0000a420: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+0000a430: 2061 7474 656e 7469 6f6e 5f6d 6173 6b3a   attention_mask:
+0000a440: 204f 7074 696f 6e61 6c5b 6d69 6e64 7370   Optional[mindsp
+0000a450: 6f72 652e 5465 6e73 6f72 5d20 3d20 4e6f  ore.Tensor] = No
+0000a460: 6e65 2c0a 2020 2020 2020 2020 6465 636f  ne,.        deco
+0000a470: 6465 725f 696e 7075 745f 6964 733a 204f  der_input_ids: O
+0000a480: 7074 696f 6e61 6c5b 6d69 6e64 7370 6f72  ptional[mindspor
+0000a490: 652e 5465 6e73 6f72 5d20 3d20 4e6f 6e65  e.Tensor] = None
+0000a4a0: 2c0a 2020 2020 2020 2020 6465 636f 6465  ,.        decode
+0000a4b0: 725f 6174 7465 6e74 696f 6e5f 6d61 736b  r_attention_mask
+0000a4c0: 3a20 4f70 7469 6f6e 616c 5b6d 696e 6473  : Optional[minds
+0000a4d0: 706f 7265 2e54 656e 736f 725d 203d 204e  pore.Tensor] = N
+0000a4e0: 6f6e 652c 0a20 2020 2020 2020 2068 6561  one,.        hea
+0000a4f0: 645f 6d61 736b 3a20 4f70 7469 6f6e 616c  d_mask: Optional
+0000a500: 5b6d 696e 6473 706f 7265 2e54 656e 736f  [mindspore.Tenso
+0000a510: 725d 203d 204e 6f6e 652c 0a20 2020 2020  r] = None,.     
+0000a520: 2020 2064 6563 6f64 6572 5f68 6561 645f     decoder_head_
+0000a530: 6d61 736b 3a20 4f70 7469 6f6e 616c 5b6d  mask: Optional[m
+0000a540: 696e 6473 706f 7265 2e54 656e 736f 725d  indspore.Tensor]
+0000a550: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+0000a560: 2063 726f 7373 5f61 7474 6e5f 6865 6164   cross_attn_head
+0000a570: 5f6d 6173 6b3a 204f 7074 696f 6e61 6c5b  _mask: Optional[
+0000a580: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+0000a590: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+0000a5a0: 2020 656e 636f 6465 725f 6f75 7470 7574    encoder_output
+0000a5b0: 733a 204f 7074 696f 6e61 6c5b 556e 696f  s: Optional[Unio
+0000a5c0: 6e5b 5475 706c 652c 2042 6173 654d 6f64  n[Tuple, BaseMod
+0000a5d0: 656c 4f75 7470 7574 5d5d 203d 204e 6f6e  elOutput]] = Non
+0000a5e0: 652c 0a20 2020 2020 2020 2070 6173 745f  e,.        past_
+0000a5f0: 6b65 795f 7661 6c75 6573 3a20 4f70 7469  key_values: Opti
+0000a600: 6f6e 616c 5b4c 6973 745b 6d69 6e64 7370  onal[List[mindsp
+0000a610: 6f72 652e 5465 6e73 6f72 5d5d 203d 204e  ore.Tensor]] = N
+0000a620: 6f6e 652c 0a20 2020 2020 2020 2069 6e70  one,.        inp
+0000a630: 7574 735f 656d 6265 6473 3a20 4f70 7469  uts_embeds: Opti
+0000a640: 6f6e 616c 5b6d 696e 6473 706f 7265 2e54  onal[mindspore.T
+0000a650: 656e 736f 725d 203d 204e 6f6e 652c 0a20  ensor] = None,. 
+0000a660: 2020 2020 2020 2064 6563 6f64 6572 5f69         decoder_i
+0000a670: 6e70 7574 735f 656d 6265 6473 3a20 4f70  nputs_embeds: Op
+0000a680: 7469 6f6e 616c 5b6d 696e 6473 706f 7265  tional[mindspore
+0000a690: 2e54 656e 736f 725d 203d 204e 6f6e 652c  .Tensor] = None,
+0000a6a0: 0a20 2020 2020 2020 2075 7365 5f63 6163  .        use_cac
+0000a6b0: 6865 3a20 4f70 7469 6f6e 616c 5b62 6f6f  he: Optional[boo
+0000a6c0: 6c5d 203d 204e 6f6e 652c 0a20 2020 2020  l] = None,.     
+0000a6d0: 2020 206f 7574 7075 745f 6174 7465 6e74     output_attent
+0000a6e0: 696f 6e73 3a20 4f70 7469 6f6e 616c 5b62  ions: Optional[b
+0000a6f0: 6f6f 6c5d 203d 204e 6f6e 652c 0a20 2020  ool] = None,.   
+0000a700: 2020 2020 206f 7574 7075 745f 6869 6464       output_hidd
+0000a710: 656e 5f73 7461 7465 733a 204f 7074 696f  en_states: Optio
+0000a720: 6e61 6c5b 626f 6f6c 5d20 3d20 4e6f 6e65  nal[bool] = None
+0000a730: 2c0a 2020 2020 2020 2020 7265 7475 726e  ,.        return
+0000a740: 5f64 6963 743a 204f 7074 696f 6e61 6c5b  _dict: Optional[
+0000a750: 626f 6f6c 5d20 3d20 4e6f 6e65 2c0a 2020  bool] = None,.  
+0000a760: 2020 2920 2d3e 2055 6e69 6f6e 5b54 7570    ) -> Union[Tup
+0000a770: 6c65 5b6d 696e 6473 706f 7265 2e54 656e  le[mindspore.Ten
+0000a780: 736f 725d 2c20 5365 7132 5365 714d 6f64  sor], Seq2SeqMod
+0000a790: 656c 4f75 7470 7574 5d3a 0a20 2020 2020  elOutput]:.     
+0000a7a0: 2020 2072 2222 220a 2020 2020 2020 2020     r""".        
+0000a7b0: 5265 7475 726e 733a 0a0a 2020 2020 2020  Returns:..      
+0000a7c0: 2020 4578 616d 706c 653a 0a0a 2020 2020    Example:..    
+0000a7d0: 2020 2020 6060 6070 7974 686f 6e0a 2020      ```python.  
+0000a7e0: 2020 2020 2020 3e3e 3e20 6672 6f6d 2074        >>> from t
+0000a7f0: 7261 6e73 666f 726d 6572 7320 696d 706f  ransformers impo
+0000a800: 7274 2041 7574 6f54 6f6b 656e 697a 6572  rt AutoTokenizer
+0000a810: 2c20 426c 656e 6465 7262 6f74 4d6f 6465  , BlenderbotMode
+0000a820: 6c0a 0a20 2020 2020 2020 203e 3e3e 206d  l..        >>> m
+0000a830: 6f64 656c 203d 2042 6c65 6e64 6572 626f  odel = Blenderbo
+0000a840: 744d 6f64 656c 2e66 726f 6d5f 7072 6574  tModel.from_pret
+0000a850: 7261 696e 6564 2822 6661 6365 626f 6f6b  rained("facebook
+0000a860: 2f62 6c65 6e64 6572 626f 742d 3430 304d  /blenderbot-400M
+0000a870: 2d64 6973 7469 6c6c 2229 0a20 2020 2020  -distill").     
+0000a880: 2020 203e 3e3e 2074 6f6b 656e 697a 6572     >>> tokenizer
+0000a890: 203d 2041 7574 6f54 6f6b 656e 697a 6572   = AutoTokenizer
+0000a8a0: 2e66 726f 6d5f 7072 6574 7261 696e 6564  .from_pretrained
+0000a8b0: 2822 6661 6365 626f 6f6b 2f62 6c65 6e64  ("facebook/blend
+0000a8c0: 6572 626f 742d 3430 304d 2d64 6973 7469  erbot-400M-disti
+0000a8d0: 6c6c 2229 0a0a 2020 2020 2020 2020 3e3e  ll")..        >>
+0000a8e0: 3e20 696e 7075 7473 203d 2074 6f6b 656e  > inputs = token
+0000a8f0: 697a 6572 2822 5374 7564 6965 7320 6861  izer("Studies ha
+0000a900: 7665 2062 6565 6e20 7368 6f77 6e20 7468  ve been shown th
+0000a910: 6174 206f 776e 696e 6720 6120 646f 6720  at owning a dog 
+0000a920: 6973 2067 6f6f 6420 666f 7220 796f 7522  is good for you"
+0000a930: 2c20 7265 7475 726e 5f74 656e 736f 7273  , return_tensors
+0000a940: 3d22 7074 2229 0a20 2020 2020 2020 203e  ="pt").        >
+0000a950: 3e3e 2064 6563 6f64 6572 5f69 6e70 7574  >> decoder_input
+0000a960: 5f69 6473 203d 2074 6f6b 656e 697a 6572  _ids = tokenizer
+0000a970: 2822 5374 7564 6965 7320 7368 6f77 2074  ("Studies show t
+0000a980: 6861 7422 2c20 7265 7475 726e 5f74 656e  hat", return_ten
+0000a990: 736f 7273 3d22 7074 2229 2e69 6e70 7574  sors="pt").input
+0000a9a0: 5f69 6473 2020 2320 4261 7463 6820 7369  _ids  # Batch si
+0000a9b0: 7a65 2031 0a20 2020 2020 2020 203e 3e3e  ze 1.        >>>
+0000a9c0: 206f 7574 7075 7473 203d 206d 6f64 656c   outputs = model
+0000a9d0: 2869 6e70 7574 5f69 6473 3d69 6e70 7574  (input_ids=input
+0000a9e0: 732e 696e 7075 745f 6964 732c 2064 6563  s.input_ids, dec
+0000a9f0: 6f64 6572 5f69 6e70 7574 5f69 6473 3d64  oder_input_ids=d
+0000aa00: 6563 6f64 6572 5f69 6e70 7574 5f69 6473  ecoder_input_ids
+0000aa10: 290a 0a20 2020 2020 2020 203e 3e3e 206c  )..        >>> l
+0000aa20: 6173 745f 6869 6464 656e 5f73 7461 7465  ast_hidden_state
+0000aa30: 7320 3d20 6f75 7470 7574 732e 6c61 7374  s = outputs.last
+0000aa40: 5f68 6964 6465 6e5f 7374 6174 650a 2020  _hidden_state.  
+0000aa50: 2020 2020 2020 3e3e 3e20 6c69 7374 286c        >>> list(l
+0000aa60: 6173 745f 6869 6464 656e 5f73 7461 7465  ast_hidden_state
+0000aa70: 732e 7368 6170 6529 0a20 2020 2020 2020  s.shape).       
+0000aa80: 205b 312c 2036 2c20 3132 3830 5d0a 2020   [1, 6, 1280].  
+0000aa90: 2020 2020 2020 6060 6022 2222 0a20 2020        ```""".   
+0000aaa0: 2020 2020 206f 7574 7075 745f 6174 7465       output_atte
+0000aab0: 6e74 696f 6e73 203d 206f 7574 7075 745f  ntions = output_
+0000aac0: 6174 7465 6e74 696f 6e73 2069 6620 6f75  attentions if ou
+0000aad0: 7470 7574 5f61 7474 656e 7469 6f6e 7320  tput_attentions 
+0000aae0: 6973 206e 6f74 204e 6f6e 6520 656c 7365  is not None else
+0000aaf0: 2073 656c 662e 636f 6e66 6967 2e6f 7574   self.config.out
+0000ab00: 7075 745f 6174 7465 6e74 696f 6e73 0a20  put_attentions. 
+0000ab10: 2020 2020 2020 206f 7574 7075 745f 6869         output_hi
+0000ab20: 6464 656e 5f73 7461 7465 7320 3d20 280a  dden_states = (.
+0000ab30: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
+0000ab40: 7574 5f68 6964 6465 6e5f 7374 6174 6573  ut_hidden_states
+0000ab50: 2069 6620 6f75 7470 7574 5f68 6964 6465   if output_hidde
+0000ab60: 6e5f 7374 6174 6573 2069 7320 6e6f 7420  n_states is not 
+0000ab70: 4e6f 6e65 2065 6c73 6520 7365 6c66 2e63  None else self.c
+0000ab80: 6f6e 6669 672e 6f75 7470 7574 5f68 6964  onfig.output_hid
+0000ab90: 6465 6e5f 7374 6174 6573 0a20 2020 2020  den_states.     
+0000aba0: 2020 2029 0a20 2020 2020 2020 2075 7365     ).        use
+0000abb0: 5f63 6163 6865 203d 2075 7365 5f63 6163  _cache = use_cac
+0000abc0: 6865 2069 6620 7573 655f 6361 6368 6520  he if use_cache 
+0000abd0: 6973 206e 6f74 204e 6f6e 6520 656c 7365  is not None else
+0000abe0: 2073 656c 662e 636f 6e66 6967 2e75 7365   self.config.use
+0000abf0: 5f63 6163 6865 0a20 2020 2020 2020 2072  _cache.        r
+0000ac00: 6574 7572 6e5f 6469 6374 203d 2072 6574  eturn_dict = ret
+0000ac10: 7572 6e5f 6469 6374 2069 6620 7265 7475  urn_dict if retu
+0000ac20: 726e 5f64 6963 7420 6973 206e 6f74 204e  rn_dict is not N
+0000ac30: 6f6e 6520 656c 7365 2073 656c 662e 636f  one else self.co
+0000ac40: 6e66 6967 2e75 7365 5f72 6574 7572 6e5f  nfig.use_return_
+0000ac50: 6469 6374 0a0a 2020 2020 2020 2020 6966  dict..        if
+0000ac60: 2065 6e63 6f64 6572 5f6f 7574 7075 7473   encoder_outputs
+0000ac70: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0000ac80: 2020 2020 2020 656e 636f 6465 725f 6f75        encoder_ou
+0000ac90: 7470 7574 7320 3d20 7365 6c66 2e65 6e63  tputs = self.enc
+0000aca0: 6f64 6572 280a 2020 2020 2020 2020 2020  oder(.          
+0000acb0: 2020 2020 2020 696e 7075 745f 6964 733d        input_ids=
+0000acc0: 696e 7075 745f 6964 732c 0a20 2020 2020  input_ids,.     
+0000acd0: 2020 2020 2020 2020 2020 2061 7474 656e             atten
+0000ace0: 7469 6f6e 5f6d 6173 6b3d 6174 7465 6e74  tion_mask=attent
+0000acf0: 696f 6e5f 6d61 736b 2c0a 2020 2020 2020  ion_mask,.      
+0000ad00: 2020 2020 2020 2020 2020 6865 6164 5f6d            head_m
+0000ad10: 6173 6b3d 6865 6164 5f6d 6173 6b2c 0a20  ask=head_mask,. 
+0000ad20: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000ad30: 6e70 7574 735f 656d 6265 6473 3d69 6e70  nputs_embeds=inp
+0000ad40: 7574 735f 656d 6265 6473 2c0a 2020 2020  uts_embeds,.    
+0000ad50: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
+0000ad60: 7574 5f61 7474 656e 7469 6f6e 733d 6f75  ut_attentions=ou
+0000ad70: 7470 7574 5f61 7474 656e 7469 6f6e 732c  tput_attentions,
+0000ad80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ad90: 206f 7574 7075 745f 6869 6464 656e 5f73   output_hidden_s
+0000ada0: 7461 7465 733d 6f75 7470 7574 5f68 6964  tates=output_hid
+0000adb0: 6465 6e5f 7374 6174 6573 2c0a 2020 2020  den_states,.    
+0000adc0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000add0: 726e 5f64 6963 743d 7265 7475 726e 5f64  rn_dict=return_d
+0000ade0: 6963 742c 0a20 2020 2020 2020 2020 2020  ict,.           
+0000adf0: 2029 0a20 2020 2020 2020 2023 2049 6620   ).        # If 
+0000ae00: 7468 6520 7573 6572 2070 6173 7365 6420  the user passed 
+0000ae10: 6120 7475 706c 6520 666f 7220 656e 636f  a tuple for enco
+0000ae20: 6465 725f 6f75 7470 7574 732c 2077 6520  der_outputs, we 
+0000ae30: 7772 6170 2069 7420 696e 2061 2042 6173  wrap it in a Bas
+0000ae40: 654d 6f64 656c 4f75 7470 7574 2077 6865  eModelOutput whe
+0000ae50: 6e20 7265 7475 726e 5f64 6963 743d 5472  n return_dict=Tr
+0000ae60: 7565 0a20 2020 2020 2020 2065 6c69 6620  ue.        elif 
+0000ae70: 7265 7475 726e 5f64 6963 7420 616e 6420  return_dict and 
+0000ae80: 6e6f 7420 6973 696e 7374 616e 6365 2865  not isinstance(e
+0000ae90: 6e63 6f64 6572 5f6f 7574 7075 7473 2c20  ncoder_outputs, 
+0000aea0: 4261 7365 4d6f 6465 6c4f 7574 7075 7429  BaseModelOutput)
+0000aeb0: 3a0a 2020 2020 2020 2020 2020 2020 656e  :.            en
+0000aec0: 636f 6465 725f 6f75 7470 7574 7320 3d20  coder_outputs = 
+0000aed0: 4261 7365 4d6f 6465 6c4f 7574 7075 7428  BaseModelOutput(
+0000aee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000aef0: 206c 6173 745f 6869 6464 656e 5f73 7461   last_hidden_sta
+0000af00: 7465 3d65 6e63 6f64 6572 5f6f 7574 7075  te=encoder_outpu
+0000af10: 7473 5b30 5d2c 0a20 2020 2020 2020 2020  ts[0],.         
+0000af20: 2020 2020 2020 2068 6964 6465 6e5f 7374         hidden_st
+0000af30: 6174 6573 3d65 6e63 6f64 6572 5f6f 7574  ates=encoder_out
+0000af40: 7075 7473 5b31 5d20 6966 206c 656e 2865  puts[1] if len(e
+0000af50: 6e63 6f64 6572 5f6f 7574 7075 7473 2920  ncoder_outputs) 
+0000af60: 3e20 3120 656c 7365 204e 6f6e 652c 0a20  > 1 else None,. 
+0000af70: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0000af80: 7474 656e 7469 6f6e 733d 656e 636f 6465  ttentions=encode
+0000af90: 725f 6f75 7470 7574 735b 325d 2069 6620  r_outputs[2] if 
+0000afa0: 6c65 6e28 656e 636f 6465 725f 6f75 7470  len(encoder_outp
+0000afb0: 7574 7329 203e 2032 2065 6c73 6520 4e6f  uts) > 2 else No
+0000afc0: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+0000afd0: 290a 0a20 2020 2020 2020 2023 2064 6563  )..        # dec
+0000afe0: 6f64 6572 206f 7574 7075 7473 2063 6f6e  oder outputs con
+0000aff0: 7369 7374 7320 6f66 2028 6465 635f 6665  sists of (dec_fe
+0000b000: 6174 7572 6573 2c20 7061 7374 5f6b 6579  atures, past_key
+0000b010: 5f76 616c 7565 2c20 6465 635f 6869 6464  _value, dec_hidd
+0000b020: 656e 2c20 6465 635f 6174 746e 290a 2020  en, dec_attn).  
+0000b030: 2020 2020 2020 6465 636f 6465 725f 6f75        decoder_ou
+0000b040: 7470 7574 7320 3d20 7365 6c66 2e64 6563  tputs = self.dec
+0000b050: 6f64 6572 280a 2020 2020 2020 2020 2020  oder(.          
+0000b060: 2020 696e 7075 745f 6964 733d 6465 636f    input_ids=deco
+0000b070: 6465 725f 696e 7075 745f 6964 732c 0a20  der_input_ids,. 
+0000b080: 2020 2020 2020 2020 2020 2061 7474 656e             atten
+0000b090: 7469 6f6e 5f6d 6173 6b3d 6465 636f 6465  tion_mask=decode
+0000b0a0: 725f 6174 7465 6e74 696f 6e5f 6d61 736b  r_attention_mask
+0000b0b0: 2c0a 2020 2020 2020 2020 2020 2020 656e  ,.            en
+0000b0c0: 636f 6465 725f 6869 6464 656e 5f73 7461  coder_hidden_sta
+0000b0d0: 7465 733d 656e 636f 6465 725f 6f75 7470  tes=encoder_outp
+0000b0e0: 7574 735b 305d 2c0a 2020 2020 2020 2020  uts[0],.        
+0000b0f0: 2020 2020 656e 636f 6465 725f 6174 7465      encoder_atte
+0000b100: 6e74 696f 6e5f 6d61 736b 3d61 7474 656e  ntion_mask=atten
+0000b110: 7469 6f6e 5f6d 6173 6b2c 0a20 2020 2020  tion_mask,.     
+0000b120: 2020 2020 2020 2068 6561 645f 6d61 736b         head_mask
+0000b130: 3d64 6563 6f64 6572 5f68 6561 645f 6d61  =decoder_head_ma
+0000b140: 736b 2c0a 2020 2020 2020 2020 2020 2020  sk,.            
+0000b150: 6372 6f73 735f 6174 746e 5f68 6561 645f  cross_attn_head_
+0000b160: 6d61 736b 3d63 726f 7373 5f61 7474 6e5f  mask=cross_attn_
+0000b170: 6865 6164 5f6d 6173 6b2c 0a20 2020 2020  head_mask,.     
+0000b180: 2020 2020 2020 2070 6173 745f 6b65 795f         past_key_
+0000b190: 7661 6c75 6573 3d70 6173 745f 6b65 795f  values=past_key_
+0000b1a0: 7661 6c75 6573 2c0a 2020 2020 2020 2020  values,.        
+0000b1b0: 2020 2020 696e 7075 7473 5f65 6d62 6564      inputs_embed
+0000b1c0: 733d 6465 636f 6465 725f 696e 7075 7473  s=decoder_inputs
+0000b1d0: 5f65 6d62 6564 732c 0a20 2020 2020 2020  _embeds,.       
+0000b1e0: 2020 2020 2075 7365 5f63 6163 6865 3d75       use_cache=u
+0000b1f0: 7365 5f63 6163 6865 2c0a 2020 2020 2020  se_cache,.      
+0000b200: 2020 2020 2020 6f75 7470 7574 5f61 7474        output_att
+0000b210: 656e 7469 6f6e 733d 6f75 7470 7574 5f61  entions=output_a
+0000b220: 7474 656e 7469 6f6e 732c 0a20 2020 2020  ttentions,.     
+0000b230: 2020 2020 2020 206f 7574 7075 745f 6869         output_hi
+0000b240: 6464 656e 5f73 7461 7465 733d 6f75 7470  dden_states=outp
+0000b250: 7574 5f68 6964 6465 6e5f 7374 6174 6573  ut_hidden_states
+0000b260: 2c0a 2020 2020 2020 2020 2020 2020 7265  ,.            re
+0000b270: 7475 726e 5f64 6963 743d 7265 7475 726e  turn_dict=return
+0000b280: 5f64 6963 742c 0a20 2020 2020 2020 2029  _dict,.        )
+0000b290: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
+0000b2a0: 2072 6574 7572 6e5f 6469 6374 3a0a 2020   return_dict:.  
+0000b2b0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000b2c0: 2064 6563 6f64 6572 5f6f 7574 7075 7473   decoder_outputs
+0000b2d0: 202b 2065 6e63 6f64 6572 5f6f 7574 7075   + encoder_outpu
+0000b2e0: 7473 0a0a 2020 2020 2020 2020 7265 7475  ts..        retu
+0000b2f0: 726e 2053 6571 3253 6571 4d6f 6465 6c4f  rn Seq2SeqModelO
+0000b300: 7574 7075 7428 0a20 2020 2020 2020 2020  utput(.         
+0000b310: 2020 206c 6173 745f 6869 6464 656e 5f73     last_hidden_s
+0000b320: 7461 7465 3d64 6563 6f64 6572 5f6f 7574  tate=decoder_out
+0000b330: 7075 7473 2e6c 6173 745f 6869 6464 656e  puts.last_hidden
+0000b340: 5f73 7461 7465 2c0a 2020 2020 2020 2020  _state,.        
+0000b350: 2020 2020 7061 7374 5f6b 6579 5f76 616c      past_key_val
+0000b360: 7565 733d 6465 636f 6465 725f 6f75 7470  ues=decoder_outp
+0000b370: 7574 732e 7061 7374 5f6b 6579 5f76 616c  uts.past_key_val
+0000b380: 7565 732c 0a20 2020 2020 2020 2020 2020  ues,.           
+0000b390: 2064 6563 6f64 6572 5f68 6964 6465 6e5f   decoder_hidden_
+0000b3a0: 7374 6174 6573 3d64 6563 6f64 6572 5f6f  states=decoder_o
+0000b3b0: 7574 7075 7473 2e68 6964 6465 6e5f 7374  utputs.hidden_st
+0000b3c0: 6174 6573 2c0a 2020 2020 2020 2020 2020  ates,.          
+0000b3d0: 2020 6465 636f 6465 725f 6174 7465 6e74    decoder_attent
+0000b3e0: 696f 6e73 3d64 6563 6f64 6572 5f6f 7574  ions=decoder_out
+0000b3f0: 7075 7473 2e61 7474 656e 7469 6f6e 732c  puts.attentions,
+0000b400: 0a20 2020 2020 2020 2020 2020 2063 726f  .            cro
+0000b410: 7373 5f61 7474 656e 7469 6f6e 733d 6465  ss_attentions=de
+0000b420: 636f 6465 725f 6f75 7470 7574 732e 6372  coder_outputs.cr
+0000b430: 6f73 735f 6174 7465 6e74 696f 6e73 2c0a  oss_attentions,.
+0000b440: 2020 2020 2020 2020 2020 2020 656e 636f              enco
+0000b450: 6465 725f 6c61 7374 5f68 6964 6465 6e5f  der_last_hidden_
+0000b460: 7374 6174 653d 656e 636f 6465 725f 6f75  state=encoder_ou
+0000b470: 7470 7574 732e 6c61 7374 5f68 6964 6465  tputs.last_hidde
+0000b480: 6e5f 7374 6174 652c 0a20 2020 2020 2020  n_state,.       
+0000b490: 2020 2020 2065 6e63 6f64 6572 5f68 6964       encoder_hid
+0000b4a0: 6465 6e5f 7374 6174 6573 3d65 6e63 6f64  den_states=encod
+0000b4b0: 6572 5f6f 7574 7075 7473 2e68 6964 6465  er_outputs.hidde
+0000b4c0: 6e5f 7374 6174 6573 2c0a 2020 2020 2020  n_states,.      
+0000b4d0: 2020 2020 2020 656e 636f 6465 725f 6174        encoder_at
+0000b4e0: 7465 6e74 696f 6e73 3d65 6e63 6f64 6572  tentions=encoder
+0000b4f0: 5f6f 7574 7075 7473 2e61 7474 656e 7469  _outputs.attenti
+0000b500: 6f6e 732c 0a20 2020 2020 2020 2029 0a0a  ons,.        )..
+0000b510: 0a63 6c61 7373 2042 6c65 6e64 6572 626f  .class Blenderbo
+0000b520: 7446 6f72 436f 6e64 6974 696f 6e61 6c47  tForConditionalG
+0000b530: 656e 6572 6174 696f 6e28 426c 656e 6465  eneration(Blende
+0000b540: 7262 6f74 5072 6554 7261 696e 6564 4d6f  rbotPreTrainedMo
+0000b550: 6465 6c29 3a0a 2020 2020 6261 7365 5f6d  del):.    base_m
+0000b560: 6f64 656c 5f70 7265 6669 7820 3d20 226d  odel_prefix = "m
+0000b570: 6f64 656c 220a 2020 2020 5f74 6965 645f  odel".    _tied_
+0000b580: 7765 6967 6874 735f 6b65 7973 203d 205b  weights_keys = [
+0000b590: 2264 6563 6f64 6572 2e65 6d62 6564 5f74  "decoder.embed_t
+0000b5a0: 6f6b 656e 732e 7765 6967 6874 222c 2022  okens.weight", "
+0000b5b0: 656e 636f 6465 722e 656d 6265 645f 746f  encoder.embed_to
+0000b5c0: 6b65 6e73 2e77 6569 6768 7422 2c20 226c  kens.weight", "l
+0000b5d0: 6d5f 6865 6164 2e77 6569 6768 7422 5d0a  m_head.weight"].
+0000b5e0: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+0000b5f0: 5f28 7365 6c66 2c20 636f 6e66 6967 3a20  _(self, config: 
+0000b600: 426c 656e 6465 7262 6f74 436f 6e66 6967  BlenderbotConfig
+0000b610: 293a 0a20 2020 2020 2020 2073 7570 6572  ):.        super
+0000b620: 2829 2e5f 5f69 6e69 745f 5f28 636f 6e66  ().__init__(conf
+0000b630: 6967 290a 2020 2020 2020 2020 7365 6c66  ig).        self
+0000b640: 2e6d 6f64 656c 203d 2042 6c65 6e64 6572  .model = Blender
+0000b650: 626f 744d 6f64 656c 2863 6f6e 6669 6729  botModel(config)
+0000b660: 0a20 2020 2020 2020 2073 656c 662e 6669  .        self.fi
+0000b670: 6e61 6c5f 6c6f 6769 7473 5f62 6961 7320  nal_logits_bias 
+0000b680: 3d20 6f70 732e 7a65 726f 7328 2831 2c20  = ops.zeros((1, 
+0000b690: 7365 6c66 2e6d 6f64 656c 2e73 6861 7265  self.model.share
+0000b6a0: 642e 766f 6361 625f 7369 7a65 2929 0a20  d.vocab_size)). 
+0000b6b0: 2020 2020 2020 2073 656c 662e 6c6d 5f68         self.lm_h
+0000b6c0: 6561 6420 3d20 6e6e 2e44 656e 7365 2863  ead = nn.Dense(c
+0000b6d0: 6f6e 6669 672e 645f 6d6f 6465 6c2c 2073  onfig.d_model, s
+0000b6e0: 656c 662e 6d6f 6465 6c2e 7368 6172 6564  elf.model.shared
+0000b6f0: 2e76 6f63 6162 5f73 697a 652c 2068 6173  .vocab_size, has
+0000b700: 5f62 6961 733d 4661 6c73 6529 0a0a 2020  _bias=False)..  
+0000b710: 2020 2020 2020 2320 496e 6974 6961 6c69        # Initiali
+0000b720: 7a65 2077 6569 6768 7473 2061 6e64 2061  ze weights and a
+0000b730: 7070 6c79 2066 696e 616c 2070 726f 6365  pply final proce
+0000b740: 7373 696e 670a 2020 2020 2020 2020 7365  ssing.        se
+0000b750: 6c66 2e70 6f73 745f 696e 6974 2829 0a0a  lf.post_init()..
+0000b760: 2020 2020 6465 6620 6765 745f 656e 636f      def get_enco
+0000b770: 6465 7228 7365 6c66 293a 0a20 2020 2020  der(self):.     
+0000b780: 2020 2072 6574 7572 6e20 7365 6c66 2e6d     return self.m
+0000b790: 6f64 656c 2e67 6574 5f65 6e63 6f64 6572  odel.get_encoder
+0000b7a0: 2829 0a0a 2020 2020 6465 6620 6765 745f  ()..    def get_
+0000b7b0: 6465 636f 6465 7228 7365 6c66 293a 0a20  decoder(self):. 
+0000b7c0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+0000b7d0: 6c66 2e6d 6f64 656c 2e67 6574 5f64 6563  lf.model.get_dec
+0000b7e0: 6f64 6572 2829 0a0a 2020 2020 6465 6620  oder()..    def 
+0000b7f0: 7265 7369 7a65 5f74 6f6b 656e 5f65 6d62  resize_token_emb
+0000b800: 6564 6469 6e67 7328 7365 6c66 2c20 6e65  eddings(self, ne
+0000b810: 775f 6e75 6d5f 746f 6b65 6e73 3a20 696e  w_num_tokens: in
+0000b820: 742c 2070 6164 5f74 6f5f 6d75 6c74 6970  t, pad_to_multip
+0000b830: 6c65 5f6f 663a 204f 7074 696f 6e61 6c5b  le_of: Optional[
+0000b840: 696e 745d 203d 204e 6f6e 6529 202d 3e20  int] = None) -> 
+0000b850: 6e6e 2e45 6d62 6564 6469 6e67 3a0a 2020  nn.Embedding:.  
+0000b860: 2020 2020 2020 6e65 775f 656d 6265 6464        new_embedd
+0000b870: 696e 6773 203d 2073 7570 6572 2829 2e72  ings = super().r
+0000b880: 6573 697a 655f 746f 6b65 6e5f 656d 6265  esize_token_embe
+0000b890: 6464 696e 6773 286e 6577 5f6e 756d 5f74  ddings(new_num_t
+0000b8a0: 6f6b 656e 732c 2070 6164 5f74 6f5f 6d75  okens, pad_to_mu
+0000b8b0: 6c74 6970 6c65 5f6f 6629 0a20 2020 2020  ltiple_of).     
+0000b8c0: 2020 2073 656c 662e 5f72 6573 697a 655f     self._resize_
+0000b8d0: 6669 6e61 6c5f 6c6f 6769 7473 5f62 6961  final_logits_bia
+0000b8e0: 7328 6e65 775f 656d 6265 6464 696e 6773  s(new_embeddings
+0000b8f0: 2e77 6569 6768 742e 7368 6170 655b 305d  .weight.shape[0]
+0000b900: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+0000b910: 206e 6577 5f65 6d62 6564 6469 6e67 730a   new_embeddings.
+0000b920: 0a20 2020 2064 6566 205f 7265 7369 7a65  .    def _resize
+0000b930: 5f66 696e 616c 5f6c 6f67 6974 735f 6269  _final_logits_bi
+0000b940: 6173 2873 656c 662c 206e 6577 5f6e 756d  as(self, new_num
+0000b950: 5f74 6f6b 656e 733a 2069 6e74 2920 2d3e  _tokens: int) ->
+0000b960: 204e 6f6e 653a 0a20 2020 2020 2020 206f   None:.        o
+0000b970: 6c64 5f6e 756d 5f74 6f6b 656e 7320 3d20  ld_num_tokens = 
+0000b980: 7365 6c66 2e66 696e 616c 5f6c 6f67 6974  self.final_logit
+0000b990: 735f 6269 6173 2e73 6861 7065 5b2d 315d  s_bias.shape[-1]
+0000b9a0: 0a20 2020 2020 2020 2069 6620 6e65 775f  .        if new_
+0000b9b0: 6e75 6d5f 746f 6b65 6e73 203c 3d20 6f6c  num_tokens <= ol
+0000b9c0: 645f 6e75 6d5f 746f 6b65 6e73 3a0a 2020  d_num_tokens:.  
+0000b9d0: 2020 2020 2020 2020 2020 6e65 775f 6269            new_bi
+0000b9e0: 6173 203d 2073 656c 662e 6669 6e61 6c5f  as = self.final_
+0000b9f0: 6c6f 6769 7473 5f62 6961 735b 3a2c 203a  logits_bias[:, :
+0000ba00: 6e65 775f 6e75 6d5f 746f 6b65 6e73 5d0a  new_num_tokens].
+0000ba10: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0000ba20: 2020 2020 2020 2020 2020 6578 7472 615f            extra_
+0000ba30: 6269 6173 203d 206f 7073 2e7a 6572 6f73  bias = ops.zeros
+0000ba40: 2828 312c 206e 6577 5f6e 756d 5f74 6f6b  ((1, new_num_tok
+0000ba50: 656e 7320 2d20 6f6c 645f 6e75 6d5f 746f  ens - old_num_to
+0000ba60: 6b65 6e73 2929 0a20 2020 2020 2020 2020  kens)).         
+0000ba70: 2020 206e 6577 5f62 6961 7320 3d20 6f70     new_bias = op
+0000ba80: 732e 6361 7428 5b73 656c 662e 6669 6e61  s.cat([self.fina
+0000ba90: 6c5f 6c6f 6769 7473 5f62 6961 732c 2065  l_logits_bias, e
+0000baa0: 7874 7261 5f62 6961 735d 2c20 6178 6973  xtra_bias], axis
+0000bab0: 3d31 290a 2020 2020 2020 2020 7365 6c66  =1).        self
+0000bac0: 2e66 696e 616c 5f6c 6f67 6974 735f 6269  .final_logits_bi
+0000bad0: 6173 203d 206e 6577 5f62 6961 730a 0a20  as = new_bias.. 
+0000bae0: 2020 2064 6566 2067 6574 5f6f 7574 7075     def get_outpu
+0000baf0: 745f 656d 6265 6464 696e 6773 2873 656c  t_embeddings(sel
+0000bb00: 6629 3a0a 2020 2020 2020 2020 7265 7475  f):.        retu
+0000bb10: 726e 2073 656c 662e 6c6d 5f68 6561 640a  rn self.lm_head.
+0000bb20: 0a20 2020 2064 6566 2073 6574 5f6f 7574  .    def set_out
+0000bb30: 7075 745f 656d 6265 6464 696e 6773 2873  put_embeddings(s
+0000bb40: 656c 662c 206e 6577 5f65 6d62 6564 6469  elf, new_embeddi
+0000bb50: 6e67 7329 3a0a 2020 2020 2020 2020 7365  ngs):.        se
+0000bb60: 6c66 2e6c 6d5f 6865 6164 203d 206e 6577  lf.lm_head = new
+0000bb70: 5f65 6d62 6564 6469 6e67 730a 0a20 2020  _embeddings..   
+0000bb80: 2064 6566 2063 6f6e 7374 7275 6374 280a   def construct(.
+0000bb90: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+0000bba0: 2020 2020 2020 696e 7075 745f 6964 733a        input_ids:
+0000bbb0: 204f 7074 696f 6e61 6c5b 6d69 6e64 7370   Optional[mindsp
+0000bbc0: 6f72 652e 5465 6e73 6f72 5d20 3d20 4e6f  ore.Tensor] = No
+0000bbd0: 6e65 2c0a 2020 2020 2020 2020 6174 7465  ne,.        atte
+0000bbe0: 6e74 696f 6e5f 6d61 736b 3a20 4f70 7469  ntion_mask: Opti
+0000bbf0: 6f6e 616c 5b6d 696e 6473 706f 7265 2e54  onal[mindspore.T
+0000bc00: 656e 736f 725d 203d 204e 6f6e 652c 0a20  ensor] = None,. 
+0000bc10: 2020 2020 2020 2064 6563 6f64 6572 5f69         decoder_i
+0000bc20: 6e70 7574 5f69 6473 3a20 4f70 7469 6f6e  nput_ids: Option
+0000bc30: 616c 5b6d 696e 6473 706f 7265 2e54 656e  al[mindspore.Ten
+0000bc40: 736f 725d 203d 204e 6f6e 652c 0a20 2020  sor] = None,.   
+0000bc50: 2020 2020 2064 6563 6f64 6572 5f61 7474       decoder_att
+0000bc60: 656e 7469 6f6e 5f6d 6173 6b3a 204f 7074  ention_mask: Opt
+0000bc70: 696f 6e61 6c5b 6d69 6e64 7370 6f72 652e  ional[mindspore.
+0000bc80: 5465 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a  Tensor] = None,.
+0000bc90: 2020 2020 2020 2020 6865 6164 5f6d 6173          head_mas
+0000bca0: 6b3a 204f 7074 696f 6e61 6c5b 6d69 6e64  k: Optional[mind
+0000bcb0: 7370 6f72 652e 5465 6e73 6f72 5d20 3d20  spore.Tensor] = 
+0000bcc0: 4e6f 6e65 2c0a 2020 2020 2020 2020 6465  None,.        de
+0000bcd0: 636f 6465 725f 6865 6164 5f6d 6173 6b3a  coder_head_mask:
+0000bce0: 204f 7074 696f 6e61 6c5b 6d69 6e64 7370   Optional[mindsp
+0000bcf0: 6f72 652e 5465 6e73 6f72 5d20 3d20 4e6f  ore.Tensor] = No
+0000bd00: 6e65 2c0a 2020 2020 2020 2020 6372 6f73  ne,.        cros
+0000bd10: 735f 6174 746e 5f68 6561 645f 6d61 736b  s_attn_head_mask
+0000bd20: 3a20 4f70 7469 6f6e 616c 5b6d 696e 6473  : Optional[minds
+0000bd30: 706f 7265 2e54 656e 736f 725d 203d 204e  pore.Tensor] = N
+0000bd40: 6f6e 652c 0a20 2020 2020 2020 2065 6e63  one,.        enc
+0000bd50: 6f64 6572 5f6f 7574 7075 7473 3a20 4f70  oder_outputs: Op
+0000bd60: 7469 6f6e 616c 5b55 6e69 6f6e 5b54 7570  tional[Union[Tup
+0000bd70: 6c65 2c20 4261 7365 4d6f 6465 6c4f 7574  le, BaseModelOut
+0000bd80: 7075 745d 5d20 3d20 4e6f 6e65 2c0a 2020  put]] = None,.  
+0000bd90: 2020 2020 2020 7061 7374 5f6b 6579 5f76        past_key_v
+0000bda0: 616c 7565 733a 204f 7074 696f 6e61 6c5b  alues: Optional[
+0000bdb0: 4c69 7374 5b6d 696e 6473 706f 7265 2e54  List[mindspore.T
+0000bdc0: 656e 736f 725d 5d20 3d20 4e6f 6e65 2c0a  ensor]] = None,.
+0000bdd0: 2020 2020 2020 2020 696e 7075 7473 5f65          inputs_e
+0000bde0: 6d62 6564 733a 204f 7074 696f 6e61 6c5b  mbeds: Optional[
+0000bdf0: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+0000be00: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+0000be10: 2020 6465 636f 6465 725f 696e 7075 7473    decoder_inputs
+0000be20: 5f65 6d62 6564 733a 204f 7074 696f 6e61  _embeds: Optiona
+0000be30: 6c5b 6d69 6e64 7370 6f72 652e 5465 6e73  l[mindspore.Tens
+0000be40: 6f72 5d20 3d20 4e6f 6e65 2c0a 2020 2020  or] = None,.    
+0000be50: 2020 2020 6c61 6265 6c73 3a20 4f70 7469      labels: Opti
+0000be60: 6f6e 616c 5b6d 696e 6473 706f 7265 2e54  onal[mindspore.T
+0000be70: 656e 736f 725d 203d 204e 6f6e 652c 0a20  ensor] = None,. 
+0000be80: 2020 2020 2020 2075 7365 5f63 6163 6865         use_cache
+0000be90: 3a20 4f70 7469 6f6e 616c 5b62 6f6f 6c5d  : Optional[bool]
+0000bea0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+0000beb0: 206f 7574 7075 745f 6174 7465 6e74 696f   output_attentio
+0000bec0: 6e73 3a20 4f70 7469 6f6e 616c 5b62 6f6f  ns: Optional[boo
+0000bed0: 6c5d 203d 204e 6f6e 652c 0a20 2020 2020  l] = None,.     
+0000bee0: 2020 206f 7574 7075 745f 6869 6464 656e     output_hidden
+0000bef0: 5f73 7461 7465 733a 204f 7074 696f 6e61  _states: Optiona
+0000bf00: 6c5b 626f 6f6c 5d20 3d20 4e6f 6e65 2c0a  l[bool] = None,.
+0000bf10: 2020 2020 2020 2020 7265 7475 726e 5f64          return_d
+0000bf20: 6963 743a 204f 7074 696f 6e61 6c5b 626f  ict: Optional[bo
+0000bf30: 6f6c 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ol] = None,.    
+0000bf40: 2920 2d3e 2055 6e69 6f6e 5b54 7570 6c65  ) -> Union[Tuple
+0000bf50: 5b6d 696e 6473 706f 7265 2e54 656e 736f  [mindspore.Tenso
+0000bf60: 725d 2c20 5365 7132 5365 714c 4d4f 7574  r], Seq2SeqLMOut
+0000bf70: 7075 745d 3a0a 2020 2020 2020 2020 7222  put]:.        r"
+0000bf80: 2222 0a20 2020 2020 2020 206c 6162 656c  "".        label
+0000bf90: 7320 2860 6d69 6e64 7370 6f72 652e 5465  s (`mindspore.Te
+0000bfa0: 6e73 6f72 6020 6f66 2073 6861 7065 2060  nsor` of shape `
+0000bfb0: 2862 6174 6368 5f73 697a 652c 2073 6571  (batch_size, seq
+0000bfc0: 7565 6e63 655f 6c65 6e67 7468 2960 2c20  uence_length)`, 
+0000bfd0: 2a6f 7074 696f 6e61 6c2a 293a 0a20 2020  *optional*):.   
+0000bfe0: 2020 2020 2020 2020 204c 6162 656c 7320           Labels 
+0000bff0: 666f 7220 636f 6d70 7574 696e 6720 7468  for computing th
+0000c000: 6520 6d61 736b 6564 206c 616e 6775 6167  e masked languag
+0000c010: 6520 6d6f 6465 6c69 6e67 206c 6f73 732e  e modeling loss.
+0000c020: 2049 6e64 6963 6573 2073 686f 756c 6420   Indices should 
+0000c030: 6569 7468 6572 2062 6520 696e 2060 5b30  either be in `[0
+0000c040: 2c20 2e2e 2e2c 0a20 2020 2020 2020 2020  , ...,.         
+0000c050: 2020 2063 6f6e 6669 672e 766f 6361 625f     config.vocab_
+0000c060: 7369 7a65 5d60 206f 7220 2d31 3030 2028  size]` or -100 (
+0000c070: 7365 6520 6069 6e70 7574 5f69 6473 6020  see `input_ids` 
+0000c080: 646f 6373 7472 696e 6729 2e20 546f 6b65  docstring). Toke
+0000c090: 6e73 2077 6974 6820 696e 6469 6365 7320  ns with indices 
+0000c0a0: 7365 7420 746f 2060 2d31 3030 6020 6172  set to `-100` ar
+0000c0b0: 6520 6967 6e6f 7265 640a 2020 2020 2020  e ignored.      
+0000c0c0: 2020 2020 2020 286d 6173 6b65 6429 2c20        (masked), 
+0000c0d0: 7468 6520 6c6f 7373 2069 7320 6f6e 6c79  the loss is only
+0000c0e0: 2063 6f6d 7075 7465 6420 666f 7220 7468   computed for th
+0000c0f0: 6520 746f 6b65 6e73 2077 6974 6820 6c61  e tokens with la
+0000c100: 6265 6c73 2069 6e20 605b 302c 202e 2e2e  bels in `[0, ...
+0000c110: 2c20 636f 6e66 6967 2e76 6f63 6162 5f73  , config.vocab_s
+0000c120: 697a 655d 602e 0a0a 2020 2020 2020 2020  ize]`...        
+0000c130: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
+0000c140: 2022 2222 0a20 2020 2020 2020 2072 6574   """.        ret
+0000c150: 7572 6e5f 6469 6374 203d 2072 6574 7572  urn_dict = retur
+0000c160: 6e5f 6469 6374 2069 6620 7265 7475 726e  n_dict if return
+0000c170: 5f64 6963 7420 6973 206e 6f74 204e 6f6e  _dict is not Non
+0000c180: 6520 656c 7365 2073 656c 662e 636f 6e66  e else self.conf
+0000c190: 6967 2e75 7365 5f72 6574 7572 6e5f 6469  ig.use_return_di
+0000c1a0: 6374 0a0a 2020 2020 2020 2020 6966 206c  ct..        if l
+0000c1b0: 6162 656c 7320 6973 206e 6f74 204e 6f6e  abels is not Non
+0000c1c0: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
+0000c1d0: 6620 7573 655f 6361 6368 653a 0a20 2020  f use_cache:.   
+0000c1e0: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+0000c1f0: 6765 722e 7761 726e 696e 6728 2254 6865  ger.warning("The
+0000c200: 2060 7573 655f 6361 6368 6560 2061 7267   `use_cache` arg
+0000c210: 756d 656e 7420 6973 2063 6861 6e67 6564  ument is changed
+0000c220: 2074 6f20 6046 616c 7365 6020 7369 6e63   to `False` sinc
+0000c230: 6520 606c 6162 656c 7360 2069 7320 7072  e `labels` is pr
+0000c240: 6f76 6964 6564 2e22 290a 2020 2020 2020  ovided.").      
+0000c250: 2020 2020 2020 7573 655f 6361 6368 6520        use_cache 
+0000c260: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
+0000c270: 2020 2020 6966 2064 6563 6f64 6572 5f69      if decoder_i
+0000c280: 6e70 7574 5f69 6473 2069 7320 4e6f 6e65  nput_ids is None
+0000c290: 2061 6e64 2064 6563 6f64 6572 5f69 6e70   and decoder_inp
+0000c2a0: 7574 735f 656d 6265 6473 2069 7320 4e6f  uts_embeds is No
+0000c2b0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0000c2c0: 2020 2020 6465 636f 6465 725f 696e 7075      decoder_inpu
+0000c2d0: 745f 6964 7320 3d20 7368 6966 745f 746f  t_ids = shift_to
+0000c2e0: 6b65 6e73 5f72 6967 6874 280a 2020 2020  kens_right(.    
+0000c2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c300: 6c61 6265 6c73 2c20 7365 6c66 2e63 6f6e  labels, self.con
+0000c310: 6669 672e 7061 645f 746f 6b65 6e5f 6964  fig.pad_token_id
+0000c320: 2c20 7365 6c66 2e63 6f6e 6669 672e 6465  , self.config.de
+0000c330: 636f 6465 725f 7374 6172 745f 746f 6b65  coder_start_toke
+0000c340: 6e5f 6964 0a20 2020 2020 2020 2020 2020  n_id.           
+0000c350: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+0000c360: 6f75 7470 7574 7320 3d20 7365 6c66 2e6d  outputs = self.m
+0000c370: 6f64 656c 280a 2020 2020 2020 2020 2020  odel(.          
+0000c380: 2020 696e 7075 745f 6964 732c 0a20 2020    input_ids,.   
+0000c390: 2020 2020 2020 2020 2061 7474 656e 7469           attenti
+0000c3a0: 6f6e 5f6d 6173 6b3d 6174 7465 6e74 696f  on_mask=attentio
+0000c3b0: 6e5f 6d61 736b 2c0a 2020 2020 2020 2020  n_mask,.        
+0000c3c0: 2020 2020 6465 636f 6465 725f 696e 7075      decoder_inpu
+0000c3d0: 745f 6964 733d 6465 636f 6465 725f 696e  t_ids=decoder_in
+0000c3e0: 7075 745f 6964 732c 0a20 2020 2020 2020  put_ids,.       
+0000c3f0: 2020 2020 2065 6e63 6f64 6572 5f6f 7574       encoder_out
+0000c400: 7075 7473 3d65 6e63 6f64 6572 5f6f 7574  puts=encoder_out
+0000c410: 7075 7473 2c0a 2020 2020 2020 2020 2020  puts,.          
+0000c420: 2020 6465 636f 6465 725f 6174 7465 6e74    decoder_attent
+0000c430: 696f 6e5f 6d61 736b 3d64 6563 6f64 6572  ion_mask=decoder
+0000c440: 5f61 7474 656e 7469 6f6e 5f6d 6173 6b2c  _attention_mask,
+0000c450: 0a20 2020 2020 2020 2020 2020 2068 6561  .            hea
+0000c460: 645f 6d61 736b 3d68 6561 645f 6d61 736b  d_mask=head_mask
+0000c470: 2c0a 2020 2020 2020 2020 2020 2020 6465  ,.            de
+0000c480: 636f 6465 725f 6865 6164 5f6d 6173 6b3d  coder_head_mask=
+0000c490: 6465 636f 6465 725f 6865 6164 5f6d 6173  decoder_head_mas
+0000c4a0: 6b2c 0a20 2020 2020 2020 2020 2020 2063  k,.            c
+0000c4b0: 726f 7373 5f61 7474 6e5f 6865 6164 5f6d  ross_attn_head_m
+0000c4c0: 6173 6b3d 6372 6f73 735f 6174 746e 5f68  ask=cross_attn_h
+0000c4d0: 6561 645f 6d61 736b 2c0a 2020 2020 2020  ead_mask,.      
+0000c4e0: 2020 2020 2020 7061 7374 5f6b 6579 5f76        past_key_v
+0000c4f0: 616c 7565 733d 7061 7374 5f6b 6579 5f76  alues=past_key_v
+0000c500: 616c 7565 732c 0a20 2020 2020 2020 2020  alues,.         
+0000c510: 2020 2069 6e70 7574 735f 656d 6265 6473     inputs_embeds
+0000c520: 3d69 6e70 7574 735f 656d 6265 6473 2c0a  =inputs_embeds,.
+0000c530: 2020 2020 2020 2020 2020 2020 6465 636f              deco
+0000c540: 6465 725f 696e 7075 7473 5f65 6d62 6564  der_inputs_embed
+0000c550: 733d 6465 636f 6465 725f 696e 7075 7473  s=decoder_inputs
+0000c560: 5f65 6d62 6564 732c 0a20 2020 2020 2020  _embeds,.       
+0000c570: 2020 2020 2075 7365 5f63 6163 6865 3d75       use_cache=u
+0000c580: 7365 5f63 6163 6865 2c0a 2020 2020 2020  se_cache,.      
+0000c590: 2020 2020 2020 6f75 7470 7574 5f61 7474        output_att
+0000c5a0: 656e 7469 6f6e 733d 6f75 7470 7574 5f61  entions=output_a
+0000c5b0: 7474 656e 7469 6f6e 732c 0a20 2020 2020  ttentions,.     
+0000c5c0: 2020 2020 2020 206f 7574 7075 745f 6869         output_hi
+0000c5d0: 6464 656e 5f73 7461 7465 733d 6f75 7470  dden_states=outp
+0000c5e0: 7574 5f68 6964 6465 6e5f 7374 6174 6573  ut_hidden_states
+0000c5f0: 2c0a 2020 2020 2020 2020 2020 2020 7265  ,.            re
+0000c600: 7475 726e 5f64 6963 743d 7265 7475 726e  turn_dict=return
+0000c610: 5f64 6963 742c 0a20 2020 2020 2020 2029  _dict,.        )
+0000c620: 0a20 2020 2020 2020 206c 6d5f 6c6f 6769  .        lm_logi
+0000c630: 7473 203d 2073 656c 662e 6c6d 5f68 6561  ts = self.lm_hea
+0000c640: 6428 6f75 7470 7574 735b 305d 2920 2b20  d(outputs[0]) + 
+0000c650: 7365 6c66 2e66 696e 616c 5f6c 6f67 6974  self.final_logit
+0000c660: 735f 6269 6173 0a0a 2020 2020 2020 2020  s_bias..        
+0000c670: 6d61 736b 6564 5f6c 6d5f 6c6f 7373 203d  masked_lm_loss =
+0000c680: 204e 6f6e 650a 2020 2020 2020 2020 6966   None.        if
+0000c690: 206c 6162 656c 7320 6973 206e 6f74 204e   labels is not N
+0000c6a0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0000c6b0: 206d 6173 6b65 645f 6c6d 5f6c 6f73 7320   masked_lm_loss 
+0000c6c0: 3d20 6f70 732e 6372 6f73 735f 656e 7472  = ops.cross_entr
+0000c6d0: 6f70 7928 6c6d 5f6c 6f67 6974 732e 7669  opy(lm_logits.vi
+0000c6e0: 6577 282d 312c 2073 656c 662e 636f 6e66  ew(-1, self.conf
+0000c6f0: 6967 2e76 6f63 6162 5f73 697a 6529 2c20  ig.vocab_size), 
+0000c700: 6c61 6265 6c73 2e76 6965 7728 2d31 2929  labels.view(-1))
+0000c710: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
+0000c720: 2072 6574 7572 6e5f 6469 6374 3a0a 2020   return_dict:.  
+0000c730: 2020 2020 2020 2020 2020 6f75 7470 7574            output
+0000c740: 203d 2028 6c6d 5f6c 6f67 6974 732c 2920   = (lm_logits,) 
+0000c750: 2b20 6f75 7470 7574 735b 313a 5d0a 2020  + outputs[1:].  
+0000c760: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000c770: 2028 286d 6173 6b65 645f 6c6d 5f6c 6f73   ((masked_lm_los
+0000c780: 732c 2920 2b20 6f75 7470 7574 2920 6966  s,) + output) if
+0000c790: 206d 6173 6b65 645f 6c6d 5f6c 6f73 7320   masked_lm_loss 
+0000c7a0: 6973 206e 6f74 204e 6f6e 6520 656c 7365  is not None else
+0000c7b0: 206f 7574 7075 740a 0a20 2020 2020 2020   output..       
+0000c7c0: 2072 6574 7572 6e20 5365 7132 5365 714c   return Seq2SeqL
+0000c7d0: 4d4f 7574 7075 7428 0a20 2020 2020 2020  MOutput(.       
+0000c7e0: 2020 2020 206c 6f73 733d 6d61 736b 6564       loss=masked
+0000c7f0: 5f6c 6d5f 6c6f 7373 2c0a 2020 2020 2020  _lm_loss,.      
+0000c800: 2020 2020 2020 6c6f 6769 7473 3d6c 6d5f        logits=lm_
+0000c810: 6c6f 6769 7473 2c0a 2020 2020 2020 2020  logits,.        
+0000c820: 2020 2020 7061 7374 5f6b 6579 5f76 616c      past_key_val
+0000c830: 7565 733d 6f75 7470 7574 732e 7061 7374  ues=outputs.past
+0000c840: 5f6b 6579 5f76 616c 7565 732c 0a20 2020  _key_values,.   
+0000c850: 2020 2020 2020 2020 2064 6563 6f64 6572           decoder
+0000c860: 5f68 6964 6465 6e5f 7374 6174 6573 3d6f  _hidden_states=o
+0000c870: 7574 7075 7473 2e64 6563 6f64 6572 5f68  utputs.decoder_h
+0000c880: 6964 6465 6e5f 7374 6174 6573 2c0a 2020  idden_states,.  
+0000c890: 2020 2020 2020 2020 2020 6465 636f 6465            decode
+0000c8a0: 725f 6174 7465 6e74 696f 6e73 3d6f 7574  r_attentions=out
+0000c8b0: 7075 7473 2e64 6563 6f64 6572 5f61 7474  puts.decoder_att
+0000c8c0: 656e 7469 6f6e 732c 0a20 2020 2020 2020  entions,.       
+0000c8d0: 2020 2020 2063 726f 7373 5f61 7474 656e       cross_atten
+0000c8e0: 7469 6f6e 733d 6f75 7470 7574 732e 6372  tions=outputs.cr
+0000c8f0: 6f73 735f 6174 7465 6e74 696f 6e73 2c0a  oss_attentions,.
+0000c900: 2020 2020 2020 2020 2020 2020 656e 636f              enco
+0000c910: 6465 725f 6c61 7374 5f68 6964 6465 6e5f  der_last_hidden_
+0000c920: 7374 6174 653d 6f75 7470 7574 732e 656e  state=outputs.en
+0000c930: 636f 6465 725f 6c61 7374 5f68 6964 6465  coder_last_hidde
+0000c940: 6e5f 7374 6174 652c 0a20 2020 2020 2020  n_state,.       
+0000c950: 2020 2020 2065 6e63 6f64 6572 5f68 6964       encoder_hid
+0000c960: 6465 6e5f 7374 6174 6573 3d6f 7574 7075  den_states=outpu
+0000c970: 7473 2e65 6e63 6f64 6572 5f68 6964 6465  ts.encoder_hidde
+0000c980: 6e5f 7374 6174 6573 2c0a 2020 2020 2020  n_states,.      
+0000c990: 2020 2020 2020 656e 636f 6465 725f 6174        encoder_at
+0000c9a0: 7465 6e74 696f 6e73 3d6f 7574 7075 7473  tentions=outputs
+0000c9b0: 2e65 6e63 6f64 6572 5f61 7474 656e 7469  .encoder_attenti
+0000c9c0: 6f6e 732c 0a20 2020 2020 2020 2029 0a0a  ons,.        )..
+0000c9d0: 2020 2020 6465 6620 7072 6570 6172 655f      def prepare_
+0000c9e0: 696e 7075 7473 5f66 6f72 5f67 656e 6572  inputs_for_gener
+0000c9f0: 6174 696f 6e28 0a20 2020 2020 2020 2073  ation(.        s
+0000ca00: 656c 662c 0a20 2020 2020 2020 2064 6563  elf,.        dec
+0000ca10: 6f64 6572 5f69 6e70 7574 5f69 6473 2c0a  oder_input_ids,.
+0000ca20: 2020 2020 2020 2020 7061 7374 5f6b 6579          past_key
+0000ca30: 5f76 616c 7565 733d 4e6f 6e65 2c0a 2020  _values=None,.  
+0000ca40: 2020 2020 2020 6174 7465 6e74 696f 6e5f        attention_
+0000ca50: 6d61 736b 3d4e 6f6e 652c 0a20 2020 2020  mask=None,.     
+0000ca60: 2020 2068 6561 645f 6d61 736b 3d4e 6f6e     head_mask=Non
+0000ca70: 652c 0a20 2020 2020 2020 2064 6563 6f64  e,.        decod
+0000ca80: 6572 5f68 6561 645f 6d61 736b 3d4e 6f6e  er_head_mask=Non
+0000ca90: 652c 0a20 2020 2020 2020 2063 726f 7373  e,.        cross
+0000caa0: 5f61 7474 6e5f 6865 6164 5f6d 6173 6b3d  _attn_head_mask=
+0000cab0: 4e6f 6e65 2c0a 2020 2020 2020 2020 7573  None,.        us
+0000cac0: 655f 6361 6368 653d 4e6f 6e65 2c0a 2020  e_cache=None,.  
+0000cad0: 2020 2020 2020 656e 636f 6465 725f 6f75        encoder_ou
+0000cae0: 7470 7574 733d 4e6f 6e65 2c0a 2020 2020  tputs=None,.    
+0000caf0: 2020 2020 2a2a 6b77 6172 6773 2c0a 2020      **kwargs,.  
+0000cb00: 2020 293a 0a20 2020 2020 2020 2023 2063    ):.        # c
+0000cb10: 7574 2064 6563 6f64 6572 5f69 6e70 7574  ut decoder_input
+0000cb20: 5f69 6473 2069 6620 7061 7374 2069 7320  _ids if past is 
+0000cb30: 7573 6564 0a20 2020 2020 2020 2069 6620  used.        if 
+0000cb40: 7061 7374 5f6b 6579 5f76 616c 7565 7320  past_key_values 
+0000cb50: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+0000cb60: 2020 2020 2020 2020 2070 6173 745f 6c65           past_le
+0000cb70: 6e67 7468 203d 2070 6173 745f 6b65 795f  ngth = past_key_
+0000cb80: 7661 6c75 6573 5b30 5d5b 305d 2e73 6861  values[0][0].sha
+0000cb90: 7065 5b32 5d0a 0a20 2020 2020 2020 2020  pe[2]..         
+0000cba0: 2020 2023 2053 6f6d 6520 6765 6e65 7261     # Some genera
+0000cbb0: 7469 6f6e 206d 6574 686f 6473 2061 6c72  tion methods alr
+0000cbc0: 6561 6479 2070 6173 7320 6f6e 6c79 2074  eady pass only t
+0000cbd0: 6865 206c 6173 7420 696e 7075 7420 4944  he last input ID
+0000cbe0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0000cbf0: 6465 636f 6465 725f 696e 7075 745f 6964  decoder_input_id
+0000cc00: 732e 7368 6170 655b 315d 203e 2070 6173  s.shape[1] > pas
+0000cc10: 745f 6c65 6e67 7468 3a0a 2020 2020 2020  t_length:.      
+0000cc20: 2020 2020 2020 2020 2020 7265 6d6f 7665            remove
+0000cc30: 5f70 7265 6669 785f 6c65 6e67 7468 203d  _prefix_length =
+0000cc40: 2070 6173 745f 6c65 6e67 7468 0a20 2020   past_length.   
+0000cc50: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0000cc60: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0000cc70: 2044 6566 6175 6c74 2074 6f20 6f6c 6420   Default to old 
+0000cc80: 6265 6861 7669 6f72 3a20 6b65 6570 206f  behavior: keep o
+0000cc90: 6e6c 7920 6669 6e61 6c20 4944 0a20 2020  nly final ID.   
+0000cca0: 2020 2020 2020 2020 2020 2020 2072 656d               rem
+0000ccb0: 6f76 655f 7072 6566 6978 5f6c 656e 6774  ove_prefix_lengt
+0000ccc0: 6820 3d20 6465 636f 6465 725f 696e 7075  h = decoder_inpu
+0000ccd0: 745f 6964 732e 7368 6170 655b 315d 202d  t_ids.shape[1] -
+0000cce0: 2031 0a0a 2020 2020 2020 2020 2020 2020   1..            
+0000ccf0: 6465 636f 6465 725f 696e 7075 745f 6964  decoder_input_id
+0000cd00: 7320 3d20 6465 636f 6465 725f 696e 7075  s = decoder_inpu
+0000cd10: 745f 6964 735b 3a2c 2072 656d 6f76 655f  t_ids[:, remove_
+0000cd20: 7072 6566 6978 5f6c 656e 6774 683a 5d0a  prefix_length:].
+0000cd30: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000cd40: 7b0a 2020 2020 2020 2020 2020 2020 2269  {.            "i
+0000cd50: 6e70 7574 5f69 6473 223a 204e 6f6e 652c  nput_ids": None,
+0000cd60: 2020 2320 656e 636f 6465 725f 6f75 7470    # encoder_outp
+0000cd70: 7574 7320 6973 2064 6566 696e 6564 2e20  uts is defined. 
+0000cd80: 696e 7075 745f 6964 7320 6e6f 7420 6e65  input_ids not ne
+0000cd90: 6564 6564 0a20 2020 2020 2020 2020 2020  eded.           
+0000cda0: 2022 656e 636f 6465 725f 6f75 7470 7574   "encoder_output
+0000cdb0: 7322 3a20 656e 636f 6465 725f 6f75 7470  s": encoder_outp
+0000cdc0: 7574 732c 0a20 2020 2020 2020 2020 2020  uts,.           
+0000cdd0: 2022 7061 7374 5f6b 6579 5f76 616c 7565   "past_key_value
+0000cde0: 7322 3a20 7061 7374 5f6b 6579 5f76 616c  s": past_key_val
+0000cdf0: 7565 732c 0a20 2020 2020 2020 2020 2020  ues,.           
+0000ce00: 2022 6465 636f 6465 725f 696e 7075 745f   "decoder_input_
+0000ce10: 6964 7322 3a20 6465 636f 6465 725f 696e  ids": decoder_in
+0000ce20: 7075 745f 6964 732c 0a20 2020 2020 2020  put_ids,.       
+0000ce30: 2020 2020 2022 6174 7465 6e74 696f 6e5f       "attention_
+0000ce40: 6d61 736b 223a 2061 7474 656e 7469 6f6e  mask": attention
+0000ce50: 5f6d 6173 6b2c 0a20 2020 2020 2020 2020  _mask,.         
+0000ce60: 2020 2022 6865 6164 5f6d 6173 6b22 3a20     "head_mask": 
+0000ce70: 6865 6164 5f6d 6173 6b2c 0a20 2020 2020  head_mask,.     
+0000ce80: 2020 2020 2020 2022 6465 636f 6465 725f         "decoder_
+0000ce90: 6865 6164 5f6d 6173 6b22 3a20 6465 636f  head_mask": deco
+0000cea0: 6465 725f 6865 6164 5f6d 6173 6b2c 0a20  der_head_mask,. 
+0000ceb0: 2020 2020 2020 2020 2020 2022 6372 6f73             "cros
+0000cec0: 735f 6174 746e 5f68 6561 645f 6d61 736b  s_attn_head_mask
+0000ced0: 223a 2063 726f 7373 5f61 7474 6e5f 6865  ": cross_attn_he
+0000cee0: 6164 5f6d 6173 6b2c 0a20 2020 2020 2020  ad_mask,.       
+0000cef0: 2020 2020 2022 7573 655f 6361 6368 6522       "use_cache"
+0000cf00: 3a20 7573 655f 6361 6368 652c 2020 2320  : use_cache,  # 
+0000cf10: 6368 616e 6765 2074 6869 7320 746f 2061  change this to a
+0000cf20: 766f 6964 2063 6163 6869 6e67 2028 7072  void caching (pr
+0000cf30: 6573 756d 6162 6c79 2066 6f72 2064 6562  esumably for deb
+0000cf40: 7567 6769 6e67 290a 2020 2020 2020 2020  ugging).        
+0000cf50: 7d0a 0a20 2020 2040 7374 6174 6963 6d65  }..    @staticme
+0000cf60: 7468 6f64 0a20 2020 2064 6566 205f 7265  thod.    def _re
+0000cf70: 6f72 6465 725f 6361 6368 6528 7061 7374  order_cache(past
+0000cf80: 5f6b 6579 5f76 616c 7565 732c 2062 6561  _key_values, bea
+0000cf90: 6d5f 6964 7829 3a0a 2020 2020 2020 2020  m_idx):.        
+0000cfa0: 7265 6f72 6465 7265 645f 7061 7374 203d  reordered_past =
+0000cfb0: 2028 290a 2020 2020 2020 2020 666f 7220   ().        for 
+0000cfc0: 6c61 7965 725f 7061 7374 2069 6e20 7061  layer_past in pa
+0000cfd0: 7374 5f6b 6579 5f76 616c 7565 733a 0a20  st_key_values:. 
+0000cfe0: 2020 2020 2020 2020 2020 2023 2063 6163             # cac
+0000cff0: 6865 6420 6372 6f73 735f 6174 7465 6e74  hed cross_attent
+0000d000: 696f 6e20 7374 6174 6573 2064 6f6e 2774  ion states don't
+0000d010: 2068 6176 6520 746f 2062 6520 7265 6f72   have to be reor
+0000d020: 6465 7265 6420 2d3e 2074 6865 7920 6172  dered -> they ar
+0000d030: 6520 616c 7761 7973 2074 6865 2073 616d  e always the sam
+0000d040: 650a 2020 2020 2020 2020 2020 2020 7265  e.            re
+0000d050: 6f72 6465 7265 645f 7061 7374 202b 3d20  ordered_past += 
+0000d060: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000d070: 2020 7475 706c 6528 7061 7374 5f73 7461    tuple(past_sta
+0000d080: 7465 2e69 6e64 6578 5f73 656c 6563 7428  te.index_select(
+0000d090: 302c 2062 6561 6d5f 6964 7829 2066 6f72  0, beam_idx) for
+0000d0a0: 2070 6173 745f 7374 6174 6520 696e 206c   past_state in l
+0000d0b0: 6179 6572 5f70 6173 745b 3a32 5d29 0a20  ayer_past[:2]). 
+0000d0c0: 2020 2020 2020 2020 2020 2020 2020 202b                 +
+0000d0d0: 206c 6179 6572 5f70 6173 745b 323a 5d2c   layer_past[2:],
+0000d0e0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0000d0f0: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+0000d100: 6f72 6465 7265 645f 7061 7374 0a0a 0a23  ordered_past...#
+0000d110: 2043 6f70 6965 6420 6672 6f6d 2074 7261   Copied from tra
+0000d120: 6e73 666f 726d 6572 732e 6d6f 6465 6c73  nsformers.models
+0000d130: 2e62 6172 742e 6d6f 6465 6c69 6e67 5f62  .bart.modeling_b
+0000d140: 6172 742e 4261 7274 4465 636f 6465 7257  art.BartDecoderW
+0000d150: 7261 7070 6572 2077 6974 6820 4261 7274  rapper with Bart
+0000d160: 2d3e 426c 656e 6465 7262 6f74 0a63 6c61  ->Blenderbot.cla
+0000d170: 7373 2042 6c65 6e64 6572 626f 7444 6563  ss BlenderbotDec
+0000d180: 6f64 6572 5772 6170 7065 7228 426c 656e  oderWrapper(Blen
+0000d190: 6465 7262 6f74 5072 6554 7261 696e 6564  derbotPreTrained
+0000d1a0: 4d6f 6465 6c29 3a0a 2020 2020 2222 220a  Model):.    """.
+0000d1b0: 2020 2020 5468 6973 2077 7261 7070 6572      This wrapper
+0000d1c0: 2063 6c61 7373 2069 7320 6120 6865 6c70   class is a help
+0000d1d0: 6572 2063 6c61 7373 2074 6f20 636f 7272  er class to corr
+0000d1e0: 6563 746c 7920 6c6f 6164 2070 7265 7472  ectly load pretr
+0000d1f0: 6169 6e65 6420 6368 6563 6b70 6f69 6e74  ained checkpoint
+0000d200: 7320 7768 656e 2074 6865 2063 6175 7361  s when the causa
+0000d210: 6c20 6c61 6e67 7561 6765 206d 6f64 656c  l language model
+0000d220: 2069 730a 2020 2020 7573 6564 2069 6e20   is.    used in 
+0000d230: 636f 6d62 696e 6174 696f 6e20 7769 7468  combination with
+0000d240: 2074 6865 205b 6045 6e63 6f64 6572 4465   the [`EncoderDe
+0000d250: 636f 6465 724d 6f64 656c 605d 2066 7261  coderModel`] fra
+0000d260: 6d65 776f 726b 2e0a 2020 2020 2222 220a  mework..    """.
+0000d270: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+0000d280: 5f28 7365 6c66 2c20 636f 6e66 6967 293a  _(self, config):
+0000d290: 0a20 2020 2020 2020 2073 7570 6572 2829  .        super()
+0000d2a0: 2e5f 5f69 6e69 745f 5f28 636f 6e66 6967  .__init__(config
+0000d2b0: 290a 2020 2020 2020 2020 7365 6c66 2e64  ).        self.d
+0000d2c0: 6563 6f64 6572 203d 2042 6c65 6e64 6572  ecoder = Blender
+0000d2d0: 626f 7444 6563 6f64 6572 2863 6f6e 6669  botDecoder(confi
+0000d2e0: 6729 0a0a 2020 2020 6465 6620 636f 6e73  g)..    def cons
+0000d2f0: 7472 7563 7428 7365 6c66 2c20 2a61 7267  truct(self, *arg
+0000d300: 732c 202a 2a6b 7761 7267 7329 3a0a 2020  s, **kwargs):.  
+0000d310: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+0000d320: 662e 6465 636f 6465 7228 2a61 7267 732c  f.decoder(*args,
+0000d330: 202a 2a6b 7761 7267 7329 0a0a 0a23 2043   **kwargs)...# C
+0000d340: 6f70 6965 6420 6672 6f6d 2074 7261 6e73  opied from trans
+0000d350: 666f 726d 6572 732e 6d6f 6465 6c73 2e62  formers.models.b
+0000d360: 6172 742e 6d6f 6465 6c69 6e67 5f62 6172  art.modeling_bar
+0000d370: 742e 4261 7274 466f 7243 6175 7361 6c4c  t.BartForCausalL
+0000d380: 4d20 7769 7468 2042 6172 742d 3e42 6c65  M with Bart->Ble
+0000d390: 6e64 6572 626f 742c 2066 6163 6562 6f6f  nderbot, faceboo
+0000d3a0: 6b2f 6261 7274 2d62 6173 652d 3e66 6163  k/bart-base->fac
+0000d3b0: 6562 6f6f 6b2f 626c 656e 6465 7262 6f74  ebook/blenderbot
+0000d3c0: 2d34 3030 4d2d 6469 7374 696c 6c0a 636c  -400M-distill.cl
+0000d3d0: 6173 7320 426c 656e 6465 7262 6f74 466f  ass BlenderbotFo
+0000d3e0: 7243 6175 7361 6c4c 4d28 426c 656e 6465  rCausalLM(Blende
+0000d3f0: 7262 6f74 5072 6554 7261 696e 6564 4d6f  rbotPreTrainedMo
+0000d400: 6465 6c29 3a0a 2020 2020 5f74 6965 645f  del):.    _tied_
+0000d410: 7765 6967 6874 735f 6b65 7973 203d 205b  weights_keys = [
+0000d420: 226c 6d5f 6865 6164 2e77 6569 6768 7422  "lm_head.weight"
+0000d430: 5d0a 0a20 2020 2064 6566 205f 5f69 6e69  ]..    def __ini
+0000d440: 745f 5f28 7365 6c66 2c20 636f 6e66 6967  t__(self, config
+0000d450: 293a 0a20 2020 2020 2020 2063 6f6e 6669  ):.        confi
+0000d460: 6720 3d20 636f 7079 2e64 6565 7063 6f70  g = copy.deepcop
+0000d470: 7928 636f 6e66 6967 290a 2020 2020 2020  y(config).      
+0000d480: 2020 636f 6e66 6967 2e69 735f 6465 636f    config.is_deco
+0000d490: 6465 7220 3d20 5472 7565 0a20 2020 2020  der = True.     
+0000d4a0: 2020 2063 6f6e 6669 672e 6973 5f65 6e63     config.is_enc
+0000d4b0: 6f64 6572 5f64 6563 6f64 6572 203d 2046  oder_decoder = F
+0000d4c0: 616c 7365 0a20 2020 2020 2020 2073 7570  alse.        sup
+0000d4d0: 6572 2829 2e5f 5f69 6e69 745f 5f28 636f  er().__init__(co
+0000d4e0: 6e66 6967 290a 2020 2020 2020 2020 7365  nfig).        se
+0000d4f0: 6c66 2e6d 6f64 656c 203d 2042 6c65 6e64  lf.model = Blend
+0000d500: 6572 626f 7444 6563 6f64 6572 5772 6170  erbotDecoderWrap
+0000d510: 7065 7228 636f 6e66 6967 290a 0a20 2020  per(config)..   
+0000d520: 2020 2020 2073 656c 662e 6c6d 5f68 6561       self.lm_hea
+0000d530: 6420 3d20 6e6e 2e44 656e 7365 2863 6f6e  d = nn.Dense(con
+0000d540: 6669 672e 6869 6464 656e 5f73 697a 652c  fig.hidden_size,
+0000d550: 2063 6f6e 6669 672e 766f 6361 625f 7369   config.vocab_si
+0000d560: 7a65 2c20 6861 735f 6269 6173 3d46 616c  ze, has_bias=Fal
+0000d570: 7365 290a 0a20 2020 2020 2020 2023 2049  se)..        # I
+0000d580: 6e69 7469 616c 697a 6520 7765 6967 6874  nitialize weight
+0000d590: 7320 616e 6420 6170 706c 7920 6669 6e61  s and apply fina
+0000d5a0: 6c20 7072 6f63 6573 7369 6e67 0a20 2020  l processing.   
+0000d5b0: 2020 2020 2073 656c 662e 706f 7374 5f69       self.post_i
+0000d5c0: 6e69 7428 290a 0a20 2020 2064 6566 2067  nit()..    def g
+0000d5d0: 6574 5f69 6e70 7574 5f65 6d62 6564 6469  et_input_embeddi
+0000d5e0: 6e67 7328 7365 6c66 293a 0a20 2020 2020  ngs(self):.     
+0000d5f0: 2020 2072 6574 7572 6e20 7365 6c66 2e6d     return self.m
+0000d600: 6f64 656c 2e64 6563 6f64 6572 2e65 6d62  odel.decoder.emb
+0000d610: 6564 5f74 6f6b 656e 730a 0a20 2020 2064  ed_tokens..    d
+0000d620: 6566 2073 6574 5f69 6e70 7574 5f65 6d62  ef set_input_emb
+0000d630: 6564 6469 6e67 7328 7365 6c66 2c20 7661  eddings(self, va
+0000d640: 6c75 6529 3a0a 2020 2020 2020 2020 7365  lue):.        se
+0000d650: 6c66 2e6d 6f64 656c 2e64 6563 6f64 6572  lf.model.decoder
+0000d660: 2e65 6d62 6564 5f74 6f6b 656e 7320 3d20  .embed_tokens = 
+0000d670: 7661 6c75 650a 0a20 2020 2064 6566 2067  value..    def g
+0000d680: 6574 5f6f 7574 7075 745f 656d 6265 6464  et_output_embedd
+0000d690: 696e 6773 2873 656c 6629 3a0a 2020 2020  ings(self):.    
+0000d6a0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+0000d6b0: 6c6d 5f68 6561 640a 0a20 2020 2064 6566  lm_head..    def
+0000d6c0: 2073 6574 5f6f 7574 7075 745f 656d 6265   set_output_embe
+0000d6d0: 6464 696e 6773 2873 656c 662c 206e 6577  ddings(self, new
+0000d6e0: 5f65 6d62 6564 6469 6e67 7329 3a0a 2020  _embeddings):.  
+0000d6f0: 2020 2020 2020 7365 6c66 2e6c 6d5f 6865        self.lm_he
+0000d700: 6164 203d 206e 6577 5f65 6d62 6564 6469  ad = new_embeddi
+0000d710: 6e67 730a 0a20 2020 2064 6566 2073 6574  ngs..    def set
+0000d720: 5f64 6563 6f64 6572 2873 656c 662c 2064  _decoder(self, d
+0000d730: 6563 6f64 6572 293a 0a20 2020 2020 2020  ecoder):.       
+0000d740: 2073 656c 662e 6d6f 6465 6c2e 6465 636f   self.model.deco
+0000d750: 6465 7220 3d20 6465 636f 6465 720a 0a20  der = decoder.. 
+0000d760: 2020 2064 6566 2067 6574 5f64 6563 6f64     def get_decod
+0000d770: 6572 2873 656c 6629 3a0a 2020 2020 2020  er(self):.      
+0000d780: 2020 7265 7475 726e 2073 656c 662e 6d6f    return self.mo
+0000d790: 6465 6c2e 6465 636f 6465 720a 0a20 2020  del.decoder..   
+0000d7a0: 2064 6566 2063 6f6e 7374 7275 6374 280a   def construct(.
+0000d7b0: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+0000d7c0: 2020 2020 2020 696e 7075 745f 6964 733a        input_ids:
+0000d7d0: 206d 696e 6473 706f 7265 2e54 656e 736f   mindspore.Tenso
+0000d7e0: 7220 3d20 4e6f 6e65 2c0a 2020 2020 2020  r = None,.      
+0000d7f0: 2020 6174 7465 6e74 696f 6e5f 6d61 736b    attention_mask
+0000d800: 3a20 4f70 7469 6f6e 616c 5b6d 696e 6473  : Optional[minds
+0000d810: 706f 7265 2e54 656e 736f 725d 203d 204e  pore.Tensor] = N
+0000d820: 6f6e 652c 0a20 2020 2020 2020 2065 6e63  one,.        enc
+0000d830: 6f64 6572 5f68 6964 6465 6e5f 7374 6174  oder_hidden_stat
+0000d840: 6573 3a20 4f70 7469 6f6e 616c 5b6d 696e  es: Optional[min
+0000d850: 6473 706f 7265 2e54 656e 736f 725d 203d  dspore.Tensor] =
+0000d860: 204e 6f6e 652c 0a20 2020 2020 2020 2065   None,.        e
+0000d870: 6e63 6f64 6572 5f61 7474 656e 7469 6f6e  ncoder_attention
+0000d880: 5f6d 6173 6b3a 204f 7074 696f 6e61 6c5b  _mask: Optional[
+0000d890: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+0000d8a0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+0000d8b0: 2020 6865 6164 5f6d 6173 6b3a 204f 7074    head_mask: Opt
+0000d8c0: 696f 6e61 6c5b 6d69 6e64 7370 6f72 652e  ional[mindspore.
+0000d8d0: 5465 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a  Tensor] = None,.
+0000d8e0: 2020 2020 2020 2020 6372 6f73 735f 6174          cross_at
+0000d8f0: 746e 5f68 6561 645f 6d61 736b 3a20 4f70  tn_head_mask: Op
+0000d900: 7469 6f6e 616c 5b6d 696e 6473 706f 7265  tional[mindspore
+0000d910: 2e54 656e 736f 725d 203d 204e 6f6e 652c  .Tensor] = None,
+0000d920: 0a20 2020 2020 2020 2070 6173 745f 6b65  .        past_ke
+0000d930: 795f 7661 6c75 6573 3a20 4f70 7469 6f6e  y_values: Option
+0000d940: 616c 5b4c 6973 745b 6d69 6e64 7370 6f72  al[List[mindspor
+0000d950: 652e 5465 6e73 6f72 5d5d 203d 204e 6f6e  e.Tensor]] = Non
+0000d960: 652c 0a20 2020 2020 2020 2069 6e70 7574  e,.        input
+0000d970: 735f 656d 6265 6473 3a20 4f70 7469 6f6e  s_embeds: Option
+0000d980: 616c 5b6d 696e 6473 706f 7265 2e54 656e  al[mindspore.Ten
+0000d990: 736f 725d 203d 204e 6f6e 652c 0a20 2020  sor] = None,.   
+0000d9a0: 2020 2020 206c 6162 656c 733a 204f 7074       labels: Opt
+0000d9b0: 696f 6e61 6c5b 6d69 6e64 7370 6f72 652e  ional[mindspore.
+0000d9c0: 5465 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a  Tensor] = None,.
+0000d9d0: 2020 2020 2020 2020 7573 655f 6361 6368          use_cach
+0000d9e0: 653a 204f 7074 696f 6e61 6c5b 626f 6f6c  e: Optional[bool
+0000d9f0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+0000da00: 2020 6f75 7470 7574 5f61 7474 656e 7469    output_attenti
+0000da10: 6f6e 733a 204f 7074 696f 6e61 6c5b 626f  ons: Optional[bo
+0000da20: 6f6c 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ol] = None,.    
+0000da30: 2020 2020 6f75 7470 7574 5f68 6964 6465      output_hidde
+0000da40: 6e5f 7374 6174 6573 3a20 4f70 7469 6f6e  n_states: Option
+0000da50: 616c 5b62 6f6f 6c5d 203d 204e 6f6e 652c  al[bool] = None,
+0000da60: 0a20 2020 2020 2020 2072 6574 7572 6e5f  .        return_
+0000da70: 6469 6374 3a20 4f70 7469 6f6e 616c 5b62  dict: Optional[b
+0000da80: 6f6f 6c5d 203d 204e 6f6e 652c 0a20 2020  ool] = None,.   
+0000da90: 2029 202d 3e20 556e 696f 6e5b 5475 706c   ) -> Union[Tupl
+0000daa0: 652c 2043 6175 7361 6c4c 4d4f 7574 7075  e, CausalLMOutpu
+0000dab0: 7457 6974 6843 726f 7373 4174 7465 6e74  tWithCrossAttent
+0000dac0: 696f 6e73 5d3a 0a20 2020 2020 2020 2072  ions]:.        r
+0000dad0: 2222 220a 2020 2020 2020 2020 4172 6773  """.        Args
+0000dae0: 3a0a 2020 2020 2020 2020 2020 2020 696e  :.            in
+0000daf0: 7075 745f 6964 7320 2860 6d69 6e64 7370  put_ids (`mindsp
+0000db00: 6f72 652e 5465 6e73 6f72 6020 6f66 2073  ore.Tensor` of s
+0000db10: 6861 7065 2060 2862 6174 6368 5f73 697a  hape `(batch_siz
+0000db20: 652c 2073 6571 7565 6e63 655f 6c65 6e67  e, sequence_leng
+0000db30: 7468 2960 293a 0a20 2020 2020 2020 2020  th)`):.         
+0000db40: 2020 2020 2020 2049 6e64 6963 6573 206f         Indices o
+0000db50: 6620 696e 7075 7420 7365 7175 656e 6365  f input sequence
+0000db60: 2074 6f6b 656e 7320 696e 2074 6865 2076   tokens in the v
+0000db70: 6f63 6162 756c 6172 792e 2050 6164 6469  ocabulary. Paddi
+0000db80: 6e67 2077 696c 6c20 6265 2069 676e 6f72  ng will be ignor
+0000db90: 6564 2062 7920 6465 6661 756c 7420 7368  ed by default sh
+0000dba0: 6f75 6c64 2079 6f75 0a20 2020 2020 2020  ould you.       
+0000dbb0: 2020 2020 2020 2020 2070 726f 7669 6465           provide
+0000dbc0: 2069 742e 0a0a 2020 2020 2020 2020 2020   it...          
+0000dbd0: 2020 2020 2020 496e 6469 6365 7320 6361        Indices ca
+0000dbe0: 6e20 6265 206f 6274 6169 6e65 6420 7573  n be obtained us
+0000dbf0: 696e 6720 5b60 4175 746f 546f 6b65 6e69  ing [`AutoTokeni
+0000dc00: 7a65 7260 5d2e 2053 6565 205b 6050 7265  zer`]. See [`Pre
+0000dc10: 5472 6169 6e65 6454 6f6b 656e 697a 6572  TrainedTokenizer
+0000dc20: 2e65 6e63 6f64 6560 5d20 616e 640a 2020  .encode`] and.  
+0000dc30: 2020 2020 2020 2020 2020 2020 2020 5b60                [`
+0000dc40: 5072 6554 7261 696e 6564 546f 6b65 6e69  PreTrainedTokeni
+0000dc50: 7a65 722e 5f5f 6361 6c6c 5f5f 605d 2066  zer.__call__`] f
+0000dc60: 6f72 2064 6574 6169 6c73 2e0a 0a20 2020  or details...   
+0000dc70: 2020 2020 2020 2020 2020 2020 205b 5768               [Wh
+0000dc80: 6174 2061 7265 2069 6e70 7574 2049 4473  at are input IDs
+0000dc90: 3f5d 282e 2e2f 676c 6f73 7361 7279 2369  ?](../glossary#i
+0000dca0: 6e70 7574 2d69 6473 290a 2020 2020 2020  nput-ids).      
+0000dcb0: 2020 2020 2020 6174 7465 6e74 696f 6e5f        attention_
+0000dcc0: 6d61 736b 2028 606d 696e 6473 706f 7265  mask (`mindspore
+0000dcd0: 2e54 656e 736f 7260 206f 6620 7368 6170  .Tensor` of shap
+0000dce0: 6520 6028 6261 7463 685f 7369 7a65 2c20  e `(batch_size, 
+0000dcf0: 7365 7175 656e 6365 5f6c 656e 6774 6829  sequence_length)
+0000dd00: 602c 202a 6f70 7469 6f6e 616c 2a29 3a0a  `, *optional*):.
+0000dd10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dd20: 4d61 736b 2074 6f20 6176 6f69 6420 7065  Mask to avoid pe
+0000dd30: 7266 6f72 6d69 6e67 2061 7474 656e 7469  rforming attenti
+0000dd40: 6f6e 206f 6e20 7061 6464 696e 6720 746f  on on padding to
+0000dd50: 6b65 6e20 696e 6469 6365 732e 204d 6173  ken indices. Mas
+0000dd60: 6b20 7661 6c75 6573 2073 656c 6563 7465  k values selecte
+0000dd70: 6420 696e 2060 5b30 2c20 315d 603a 0a0a  d in `[0, 1]`:..
+0000dd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dd90: 2d20 3120 666f 7220 746f 6b65 6e73 2074  - 1 for tokens t
+0000dda0: 6861 7420 6172 6520 2a2a 6e6f 7420 6d61  hat are **not ma
+0000ddb0: 736b 6564 2a2a 2c0a 2020 2020 2020 2020  sked**,.        
+0000ddc0: 2020 2020 2020 2020 2d20 3020 666f 7220          - 0 for 
+0000ddd0: 746f 6b65 6e73 2074 6861 7420 6172 6520  tokens that are 
+0000dde0: 2a2a 6d61 736b 6564 2a2a 2e0a 0a20 2020  **masked**...   
+0000ddf0: 2020 2020 2020 2020 2020 2020 205b 5768               [Wh
+0000de00: 6174 2061 7265 2061 7474 656e 7469 6f6e  at are attention
+0000de10: 206d 6173 6b73 3f5d 282e 2e2f 676c 6f73   masks?](../glos
+0000de20: 7361 7279 2361 7474 656e 7469 6f6e 2d6d  sary#attention-m
+0000de30: 6173 6b29 0a20 2020 2020 2020 2020 2020  ask).           
+0000de40: 2065 6e63 6f64 6572 5f68 6964 6465 6e5f   encoder_hidden_
+0000de50: 7374 6174 6573 2020 2860 6d69 6e64 7370  states  (`mindsp
+0000de60: 6f72 652e 5465 6e73 6f72 6020 6f66 2073  ore.Tensor` of s
+0000de70: 6861 7065 2060 2862 6174 6368 5f73 697a  hape `(batch_siz
+0000de80: 652c 2073 6571 7565 6e63 655f 6c65 6e67  e, sequence_leng
+0000de90: 7468 2c20 6869 6464 656e 5f73 697a 6529  th, hidden_size)
+0000dea0: 602c 202a 6f70 7469 6f6e 616c 2a29 3a0a  `, *optional*):.
+0000deb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000dec0: 5365 7175 656e 6365 206f 6620 6869 6464  Sequence of hidd
+0000ded0: 656e 2d73 7461 7465 7320 6174 2074 6865  en-states at the
+0000dee0: 206f 7574 7075 7420 6f66 2074 6865 206c   output of the l
+0000def0: 6173 7420 6c61 7965 7220 6f66 2074 6865  ast layer of the
+0000df00: 2065 6e63 6f64 6572 2e20 5573 6564 2069   encoder. Used i
+0000df10: 6e20 7468 6520 6372 6f73 732d 6174 7465  n the cross-atte
+0000df20: 6e74 696f 6e0a 2020 2020 2020 2020 2020  ntion.          
+0000df30: 2020 2020 2020 6966 2074 6865 206d 6f64        if the mod
+0000df40: 656c 2069 7320 636f 6e66 6967 7572 6564  el is configured
+0000df50: 2061 7320 6120 6465 636f 6465 722e 0a20   as a decoder.. 
+0000df60: 2020 2020 2020 2020 2020 2065 6e63 6f64             encod
+0000df70: 6572 5f61 7474 656e 7469 6f6e 5f6d 6173  er_attention_mas
+0000df80: 6b20 2860 6d69 6e64 7370 6f72 652e 5465  k (`mindspore.Te
+0000df90: 6e73 6f72 6020 6f66 2073 6861 7065 2060  nsor` of shape `
+0000dfa0: 2862 6174 6368 5f73 697a 652c 2073 6571  (batch_size, seq
+0000dfb0: 7565 6e63 655f 6c65 6e67 7468 2960 2c20  uence_length)`, 
+0000dfc0: 2a6f 7074 696f 6e61 6c2a 293a 0a20 2020  *optional*):.   
+0000dfd0: 2020 2020 2020 2020 2020 2020 204d 6173               Mas
+0000dfe0: 6b20 746f 2061 766f 6964 2070 6572 666f  k to avoid perfo
+0000dff0: 726d 696e 6720 6174 7465 6e74 696f 6e20  rming attention 
+0000e000: 6f6e 2074 6865 2070 6164 6469 6e67 2074  on the padding t
+0000e010: 6f6b 656e 2069 6e64 6963 6573 206f 6620  oken indices of 
+0000e020: 7468 6520 656e 636f 6465 7220 696e 7075  the encoder inpu
+0000e030: 742e 2054 6869 7320 6d61 736b 2069 7320  t. This mask is 
+0000e040: 7573 6564 0a20 2020 2020 2020 2020 2020  used.           
+0000e050: 2020 2020 2069 6e20 7468 6520 6372 6f73       in the cros
+0000e060: 732d 6174 7465 6e74 696f 6e20 6966 2074  s-attention if t
+0000e070: 6865 206d 6f64 656c 2069 7320 636f 6e66  he model is conf
+0000e080: 6967 7572 6564 2061 7320 6120 6465 636f  igured as a deco
+0000e090: 6465 722e 204d 6173 6b20 7661 6c75 6573  der. Mask values
+0000e0a0: 2073 656c 6563 7465 6420 696e 2060 5b30   selected in `[0
+0000e0b0: 2c20 315d 603a 0a20 2020 2020 2020 2020  , 1]`:.         
+0000e0c0: 2020 2068 6561 645f 6d61 736b 2028 606d     head_mask (`m
+0000e0d0: 696e 6473 706f 7265 2e54 656e 736f 7260  indspore.Tensor`
+0000e0e0: 206f 6620 7368 6170 6520 6028 6465 636f   of shape `(deco
+0000e0f0: 6465 725f 6c61 7965 7273 2c20 6465 636f  der_layers, deco
+0000e100: 6465 725f 6174 7465 6e74 696f 6e5f 6865  der_attention_he
+0000e110: 6164 7329 602c 202a 6f70 7469 6f6e 616c  ads)`, *optional
+0000e120: 2a29 3a0a 2020 2020 2020 2020 2020 2020  *):.            
+0000e130: 2020 2020 4d61 736b 2074 6f20 6e75 6c6c      Mask to null
+0000e140: 6966 7920 7365 6c65 6374 6564 2068 6561  ify selected hea
+0000e150: 6473 206f 6620 7468 6520 6174 7465 6e74  ds of the attent
+0000e160: 696f 6e20 6d6f 6475 6c65 732e 204d 6173  ion modules. Mas
+0000e170: 6b20 7661 6c75 6573 2073 656c 6563 7465  k values selecte
+0000e180: 6420 696e 2060 5b30 2c20 315d 603a 0a0a  d in `[0, 1]`:..
+0000e190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e1a0: 2d20 3120 696e 6469 6361 7465 7320 7468  - 1 indicates th
+0000e1b0: 6520 6865 6164 2069 7320 2a2a 6e6f 7420  e head is **not 
+0000e1c0: 6d61 736b 6564 2a2a 2c0a 2020 2020 2020  masked**,.      
+0000e1d0: 2020 2020 2020 2020 2020 2d20 3020 696e            - 0 in
+0000e1e0: 6469 6361 7465 7320 7468 6520 6865 6164  dicates the head
+0000e1f0: 2069 7320 2a2a 6d61 736b 6564 2a2a 2e0a   is **masked**..
+0000e200: 0a20 2020 2020 2020 2020 2020 2063 726f  .            cro
+0000e210: 7373 5f61 7474 6e5f 6865 6164 5f6d 6173  ss_attn_head_mas
+0000e220: 6b20 2860 6d69 6e64 7370 6f72 652e 5465  k (`mindspore.Te
+0000e230: 6e73 6f72 6020 6f66 2073 6861 7065 2060  nsor` of shape `
+0000e240: 2864 6563 6f64 6572 5f6c 6179 6572 732c  (decoder_layers,
+0000e250: 2064 6563 6f64 6572 5f61 7474 656e 7469   decoder_attenti
+0000e260: 6f6e 5f68 6561 6473 2960 2c20 2a6f 7074  on_heads)`, *opt
+0000e270: 696f 6e61 6c2a 293a 0a20 2020 2020 2020  ional*):.       
+0000e280: 2020 2020 2020 2020 204d 6173 6b20 746f           Mask to
+0000e290: 206e 756c 6c69 6679 2073 656c 6563 7465   nullify selecte
+0000e2a0: 6420 6865 6164 7320 6f66 2074 6865 2063  d heads of the c
+0000e2b0: 726f 7373 2d61 7474 656e 7469 6f6e 206d  ross-attention m
+0000e2c0: 6f64 756c 6573 2e20 4d61 736b 2076 616c  odules. Mask val
+0000e2d0: 7565 7320 7365 6c65 6374 6564 2069 6e20  ues selected in 
+0000e2e0: 605b 302c 2031 5d60 3a0a 0a20 2020 2020  `[0, 1]`:..     
+0000e2f0: 2020 2020 2020 2020 2020 202d 2031 2069             - 1 i
+0000e300: 6e64 6963 6174 6573 2074 6865 2068 6561  ndicates the hea
+0000e310: 6420 6973 202a 2a6e 6f74 206d 6173 6b65  d is **not maske
+0000e320: 642a 2a2c 0a20 2020 2020 2020 2020 2020  d**,.           
+0000e330: 2020 2020 202d 2030 2069 6e64 6963 6174       - 0 indicat
+0000e340: 6573 2074 6865 2068 6561 6420 6973 202a  es the head is *
+0000e350: 2a6d 6173 6b65 642a 2a2e 0a0a 2020 2020  *masked**...    
+0000e360: 2020 2020 2020 2020 7061 7374 5f6b 6579          past_key
+0000e370: 5f76 616c 7565 7320 2860 7475 706c 6528  _values (`tuple(
+0000e380: 7475 706c 6528 6d69 6e64 7370 6f72 652e  tuple(mindspore.
+0000e390: 5465 6e73 6f72 2929 602c 202a 6f70 7469  Tensor))`, *opti
+0000e3a0: 6f6e 616c 2a2c 2072 6574 7572 6e65 6420  onal*, returned 
+0000e3b0: 7768 656e 2060 7573 655f 6361 6368 653d  when `use_cache=
+0000e3c0: 5472 7565 6020 6973 2070 6173 7365 6420  True` is passed 
+0000e3d0: 6f72 2077 6865 6e20 6063 6f6e 6669 672e  or when `config.
+0000e3e0: 7573 655f 6361 6368 653d 5472 7565 6029  use_cache=True`)
+0000e3f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000e400: 2020 5475 706c 6520 6f66 2060 7475 706c    Tuple of `tupl
+0000e410: 6528 6d69 6e64 7370 6f72 652e 5465 6e73  e(mindspore.Tens
+0000e420: 6f72 2960 206f 6620 6c65 6e67 7468 2060  or)` of length `
+0000e430: 636f 6e66 6967 2e6e 5f6c 6179 6572 7360  config.n_layers`
+0000e440: 2c20 7769 7468 2065 6163 6820 7475 706c  , with each tupl
+0000e450: 6520 6861 7669 6e67 2032 2074 656e 736f  e having 2 tenso
+0000e460: 7273 206f 660a 2020 2020 2020 2020 2020  rs of.          
+0000e470: 2020 2020 2020 7368 6170 6520 6028 6261        shape `(ba
+0000e480: 7463 685f 7369 7a65 2c20 6e75 6d5f 6865  tch_size, num_he
+0000e490: 6164 732c 2073 6571 7565 6e63 655f 6c65  ads, sequence_le
+0000e4a0: 6e67 7468 2c20 656d 6265 645f 7369 7a65  ngth, embed_size
+0000e4b0: 5f70 6572 5f68 6561 6429 6029 2061 6e64  _per_head)`) and
+0000e4c0: 2032 2061 6464 6974 696f 6e61 6c20 7465   2 additional te
+0000e4d0: 6e73 6f72 7320 6f66 0a20 2020 2020 2020  nsors of.       
+0000e4e0: 2020 2020 2020 2020 2073 6861 7065 2060           shape `
+0000e4f0: 2862 6174 6368 5f73 697a 652c 206e 756d  (batch_size, num
+0000e500: 5f68 6561 6473 2c20 656e 636f 6465 725f  _heads, encoder_
+0000e510: 7365 7175 656e 6365 5f6c 656e 6774 682c  sequence_length,
+0000e520: 2065 6d62 6564 5f73 697a 655f 7065 725f   embed_size_per_
+0000e530: 6865 6164 2960 2e20 5468 6520 7477 6f20  head)`. The two 
+0000e540: 6164 6469 7469 6f6e 616c 0a20 2020 2020  additional.     
+0000e550: 2020 2020 2020 2020 2020 2074 656e 736f             tenso
+0000e560: 7273 2061 7265 206f 6e6c 7920 7265 7175  rs are only requ
+0000e570: 6972 6564 2077 6865 6e20 7468 6520 6d6f  ired when the mo
+0000e580: 6465 6c20 6973 2075 7365 6420 6173 2061  del is used as a
+0000e590: 2064 6563 6f64 6572 2069 6e20 6120 5365   decoder in a Se
+0000e5a0: 7175 656e 6365 2074 6f20 5365 7175 656e  quence to Sequen
+0000e5b0: 6365 206d 6f64 656c 2e0a 0a20 2020 2020  ce model...     
+0000e5c0: 2020 2020 2020 2020 2020 2043 6f6e 7461             Conta
+0000e5d0: 696e 7320 7072 652d 636f 6d70 7574 6564  ins pre-computed
+0000e5e0: 2068 6964 6465 6e2d 7374 6174 6573 2028   hidden-states (
+0000e5f0: 6b65 7920 616e 6420 7661 6c75 6573 2069  key and values i
+0000e600: 6e20 7468 6520 7365 6c66 2d61 7474 656e  n the self-atten
+0000e610: 7469 6f6e 2062 6c6f 636b 7320 616e 6420  tion blocks and 
+0000e620: 696e 2074 6865 0a20 2020 2020 2020 2020  in the.         
+0000e630: 2020 2020 2020 2063 726f 7373 2d61 7474         cross-att
+0000e640: 656e 7469 6f6e 2062 6c6f 636b 7329 2074  ention blocks) t
+0000e650: 6861 7420 6361 6e20 6265 2075 7365 6420  hat can be used 
+0000e660: 2873 6565 2060 7061 7374 5f6b 6579 5f76  (see `past_key_v
+0000e670: 616c 7565 7360 2069 6e70 7574 2920 746f  alues` input) to
+0000e680: 2073 7065 6564 2075 7020 7365 7175 656e   speed up sequen
+0000e690: 7469 616c 2064 6563 6f64 696e 672e 0a0a  tial decoding...
+0000e6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e6b0: 4966 2060 7061 7374 5f6b 6579 5f76 616c  If `past_key_val
+0000e6c0: 7565 7360 2061 7265 2075 7365 642c 2074  ues` are used, t
+0000e6d0: 6865 2075 7365 7220 6361 6e20 6f70 7469  he user can opti
+0000e6e0: 6f6e 616c 6c79 2069 6e70 7574 206f 6e6c  onally input onl
+0000e6f0: 7920 7468 6520 6c61 7374 2060 6465 636f  y the last `deco
+0000e700: 6465 725f 696e 7075 745f 6964 7360 2028  der_input_ids` (
+0000e710: 7468 6f73 650a 2020 2020 2020 2020 2020  those.          
+0000e720: 2020 2020 2020 7468 6174 2064 6f6e 2774        that don't
+0000e730: 2068 6176 6520 7468 6569 7220 7061 7374   have their past
+0000e740: 206b 6579 2076 616c 7565 2073 7461 7465   key value state
+0000e750: 7320 6769 7665 6e20 746f 2074 6869 7320  s given to this 
+0000e760: 6d6f 6465 6c29 206f 6620 7368 6170 6520  model) of shape 
+0000e770: 6028 6261 7463 685f 7369 7a65 2c20 3129  `(batch_size, 1)
+0000e780: 6020 696e 7374 6561 6420 6f66 0a20 2020  ` instead of.   
+0000e790: 2020 2020 2020 2020 2020 2020 2061 6c6c               all
+0000e7a0: 2060 6465 636f 6465 725f 696e 7075 745f   `decoder_input_
+0000e7b0: 6964 7360 206f 6620 7368 6170 6520 6028  ids` of shape `(
+0000e7c0: 6261 7463 685f 7369 7a65 2c20 7365 7175  batch_size, sequ
+0000e7d0: 656e 6365 5f6c 656e 6774 6829 602e 0a20  ence_length)`.. 
+0000e7e0: 2020 2020 2020 2020 2020 206c 6162 656c             label
+0000e7f0: 7320 2860 6d69 6e64 7370 6f72 652e 5465  s (`mindspore.Te
+0000e800: 6e73 6f72 6020 6f66 2073 6861 7065 2060  nsor` of shape `
+0000e810: 2862 6174 6368 5f73 697a 652c 2073 6571  (batch_size, seq
+0000e820: 7565 6e63 655f 6c65 6e67 7468 2960 2c20  uence_length)`, 
+0000e830: 2a6f 7074 696f 6e61 6c2a 293a 0a20 2020  *optional*):.   
+0000e840: 2020 2020 2020 2020 2020 2020 204c 6162               Lab
+0000e850: 656c 7320 666f 7220 636f 6d70 7574 696e  els for computin
+0000e860: 6720 7468 6520 6d61 736b 6564 206c 616e  g the masked lan
+0000e870: 6775 6167 6520 6d6f 6465 6c69 6e67 206c  guage modeling l
+0000e880: 6f73 732e 2049 6e64 6963 6573 2073 686f  oss. Indices sho
+0000e890: 756c 6420 6569 7468 6572 2062 6520 696e  uld either be in
+0000e8a0: 2060 5b30 2c20 2e2e 2e2c 0a20 2020 2020   `[0, ...,.     
+0000e8b0: 2020 2020 2020 2020 2020 2063 6f6e 6669             confi
+0000e8c0: 672e 766f 6361 625f 7369 7a65 5d60 206f  g.vocab_size]` o
+0000e8d0: 7220 2d31 3030 2028 7365 6520 6069 6e70  r -100 (see `inp
+0000e8e0: 7574 5f69 6473 6020 646f 6373 7472 696e  ut_ids` docstrin
+0000e8f0: 6729 2e20 546f 6b65 6e73 2077 6974 6820  g). Tokens with 
+0000e900: 696e 6469 6365 7320 7365 7420 746f 2060  indices set to `
+0000e910: 2d31 3030 6020 6172 6520 6967 6e6f 7265  -100` are ignore
+0000e920: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+0000e930: 2020 286d 6173 6b65 6429 2c20 7468 6520    (masked), the 
+0000e940: 6c6f 7373 2069 7320 6f6e 6c79 2063 6f6d  loss is only com
+0000e950: 7075 7465 6420 666f 7220 7468 6520 746f  puted for the to
+0000e960: 6b65 6e73 2077 6974 6820 6c61 6265 6c73  kens with labels
+0000e970: 2069 6e20 605b 302c 202e 2e2e 2c20 636f   in `[0, ..., co
+0000e980: 6e66 6967 2e76 6f63 6162 5f73 697a 655d  nfig.vocab_size]
+0000e990: 602e 0a20 2020 2020 2020 2020 2020 2075  `..            u
+0000e9a0: 7365 5f63 6163 6865 2028 6062 6f6f 6c60  se_cache (`bool`
+0000e9b0: 2c20 2a6f 7074 696f 6e61 6c2a 293a 0a20  , *optional*):. 
+0000e9c0: 2020 2020 2020 2020 2020 2020 2020 2049                 I
+0000e9d0: 6620 7365 7420 746f 2060 5472 7565 602c  f set to `True`,
+0000e9e0: 2060 7061 7374 5f6b 6579 5f76 616c 7565   `past_key_value
+0000e9f0: 7360 206b 6579 2076 616c 7565 2073 7461  s` key value sta
+0000ea00: 7465 7320 6172 6520 7265 7475 726e 6564  tes are returned
+0000ea10: 2061 6e64 2063 616e 2062 6520 7573 6564   and can be used
+0000ea20: 2074 6f20 7370 6565 6420 7570 2064 6563   to speed up dec
+0000ea30: 6f64 696e 670a 2020 2020 2020 2020 2020  oding.          
+0000ea40: 2020 2020 2020 2873 6565 2060 7061 7374        (see `past
+0000ea50: 5f6b 6579 5f76 616c 7565 7360 292e 0a0a  _key_values`)...
+0000ea60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ea70: 2d20 3120 666f 7220 746f 6b65 6e73 2074  - 1 for tokens t
+0000ea80: 6861 7420 6172 6520 2a2a 6e6f 7420 6d61  hat are **not ma
+0000ea90: 736b 6564 2a2a 2c0a 2020 2020 2020 2020  sked**,.        
+0000eaa0: 2020 2020 2020 2020 2d20 3020 666f 7220          - 0 for 
+0000eab0: 746f 6b65 6e73 2074 6861 7420 6172 6520  tokens that are 
+0000eac0: 2a2a 6d61 736b 6564 2a2a 2e0a 2020 2020  **masked**..    
+0000ead0: 2020 2020 2020 2020 6f75 7470 7574 5f61          output_a
+0000eae0: 7474 656e 7469 6f6e 7320 2860 626f 6f6c  ttentions (`bool
+0000eaf0: 602c 202a 6f70 7469 6f6e 616c 2a29 3a0a  `, *optional*):.
+0000eb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eb10: 5768 6574 6865 7220 6f72 206e 6f74 2074  Whether or not t
+0000eb20: 6f20 7265 7475 726e 2074 6865 2061 7474  o return the att
+0000eb30: 656e 7469 6f6e 7320 7465 6e73 6f72 7320  entions tensors 
+0000eb40: 6f66 2061 6c6c 2061 7474 656e 7469 6f6e  of all attention
+0000eb50: 206c 6179 6572 732e 2053 6565 2060 6174   layers. See `at
+0000eb60: 7465 6e74 696f 6e73 6020 756e 6465 720a  tentions` under.
+0000eb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000eb80: 7265 7475 726e 6564 2074 656e 736f 7273  returned tensors
+0000eb90: 2066 6f72 206d 6f72 6520 6465 7461 696c   for more detail
+0000eba0: 2e0a 2020 2020 2020 2020 2020 2020 6f75  ..            ou
+0000ebb0: 7470 7574 5f68 6964 6465 6e5f 7374 6174  tput_hidden_stat
+0000ebc0: 6573 2028 6062 6f6f 6c60 2c20 2a6f 7074  es (`bool`, *opt
+0000ebd0: 696f 6e61 6c2a 293a 0a20 2020 2020 2020  ional*):.       
+0000ebe0: 2020 2020 2020 2020 2057 6865 7468 6572           Whether
+0000ebf0: 206f 7220 6e6f 7420 746f 2072 6574 7572   or not to retur
+0000ec00: 6e20 7468 6520 6869 6464 656e 2073 7461  n the hidden sta
+0000ec10: 7465 7320 6f66 2061 6c6c 206c 6179 6572  tes of all layer
+0000ec20: 732e 2053 6565 2060 6869 6464 656e 5f73  s. See `hidden_s
+0000ec30: 7461 7465 7360 2075 6e64 6572 2072 6574  tates` under ret
+0000ec40: 7572 6e65 6420 7465 6e73 6f72 730a 2020  urned tensors.  
+0000ec50: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+0000ec60: 7220 6d6f 7265 2064 6574 6169 6c2e 0a20  r more detail.. 
+0000ec70: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000ec80: 6e5f 6469 6374 2028 6062 6f6f 6c60 2c20  n_dict (`bool`, 
+0000ec90: 2a6f 7074 696f 6e61 6c2a 293a 0a20 2020  *optional*):.   
+0000eca0: 2020 2020 2020 2020 2020 2020 2057 6865               Whe
+0000ecb0: 7468 6572 206f 7220 6e6f 7420 746f 2072  ther or not to r
+0000ecc0: 6574 7572 6e20 6120 5b60 7e75 7469 6c73  eturn a [`~utils
+0000ecd0: 2e4d 6f64 656c 4f75 7470 7574 605d 2069  .ModelOutput`] i
+0000ece0: 6e73 7465 6164 206f 6620 6120 706c 6169  nstead of a plai
+0000ecf0: 6e20 7475 706c 652e 0a0a 2020 2020 2020  n tuple...      
+0000ed00: 2020 5265 7475 726e 733a 0a0a 2020 2020    Returns:..    
+0000ed10: 2020 2020 4578 616d 706c 653a 0a0a 2020      Example:..  
+0000ed20: 2020 2020 2020 6060 6070 7974 686f 6e0a        ```python.
+0000ed30: 2020 2020 2020 2020 3e3e 3e20 6672 6f6d          >>> from
+0000ed40: 2074 7261 6e73 666f 726d 6572 7320 696d   transformers im
+0000ed50: 706f 7274 2041 7574 6f54 6f6b 656e 697a  port AutoTokeniz
+0000ed60: 6572 2c20 426c 656e 6465 7262 6f74 466f  er, BlenderbotFo
+0000ed70: 7243 6175 7361 6c4c 4d0a 0a20 2020 2020  rCausalLM..     
+0000ed80: 2020 203e 3e3e 2074 6f6b 656e 697a 6572     >>> tokenizer
+0000ed90: 203d 2041 7574 6f54 6f6b 656e 697a 6572   = AutoTokenizer
+0000eda0: 2e66 726f 6d5f 7072 6574 7261 696e 6564  .from_pretrained
+0000edb0: 2822 6661 6365 626f 6f6b 2f62 6c65 6e64  ("facebook/blend
+0000edc0: 6572 626f 742d 3430 304d 2d64 6973 7469  erbot-400M-disti
+0000edd0: 6c6c 2229 0a20 2020 2020 2020 203e 3e3e  ll").        >>>
+0000ede0: 206d 6f64 656c 203d 2042 6c65 6e64 6572   model = Blender
+0000edf0: 626f 7446 6f72 4361 7573 616c 4c4d 2e66  botForCausalLM.f
+0000ee00: 726f 6d5f 7072 6574 7261 696e 6564 2822  rom_pretrained("
+0000ee10: 6661 6365 626f 6f6b 2f62 6c65 6e64 6572  facebook/blender
+0000ee20: 626f 742d 3430 304d 2d64 6973 7469 6c6c  bot-400M-distill
+0000ee30: 222c 2061 6464 5f63 726f 7373 5f61 7474  ", add_cross_att
+0000ee40: 656e 7469 6f6e 3d46 616c 7365 290a 2020  ention=False).  
+0000ee50: 2020 2020 2020 3e3e 3e20 6173 7365 7274        >>> assert
+0000ee60: 206d 6f64 656c 2e63 6f6e 6669 672e 6973   model.config.is
+0000ee70: 5f64 6563 6f64 6572 2c20 6622 7b6d 6f64  _decoder, f"{mod
+0000ee80: 656c 2e5f 5f63 6c61 7373 5f5f 7d20 6861  el.__class__} ha
+0000ee90: 7320 746f 2062 6520 636f 6e66 6967 7572  s to be configur
+0000eea0: 6564 2061 7320 6120 6465 636f 6465 722e  ed as a decoder.
+0000eeb0: 220a 2020 2020 2020 2020 3e3e 3e20 696e  ".        >>> in
+0000eec0: 7075 7473 203d 2074 6f6b 656e 697a 6572  puts = tokenizer
+0000eed0: 2822 4865 6c6c 6f2c 206d 7920 646f 6720  ("Hello, my dog 
+0000eee0: 6973 2063 7574 6522 2c20 7265 7475 726e  is cute", return
+0000eef0: 5f74 656e 736f 7273 3d22 7074 2229 0a20  _tensors="pt"). 
+0000ef00: 2020 2020 2020 203e 3e3e 206f 7574 7075         >>> outpu
+0000ef10: 7473 203d 206d 6f64 656c 282a 2a69 6e70  ts = model(**inp
+0000ef20: 7574 7329 0a0a 2020 2020 2020 2020 3e3e  uts)..        >>
+0000ef30: 3e20 6c6f 6769 7473 203d 206f 7574 7075  > logits = outpu
+0000ef40: 7473 2e6c 6f67 6974 730a 2020 2020 2020  ts.logits.      
+0000ef50: 2020 3e3e 3e20 6578 7065 6374 6564 5f73    >>> expected_s
+0000ef60: 6861 7065 203d 205b 312c 2069 6e70 7574  hape = [1, input
+0000ef70: 732e 696e 7075 745f 6964 732e 7368 6170  s.input_ids.shap
+0000ef80: 655b 2d31 5d2c 206d 6f64 656c 2e63 6f6e  e[-1], model.con
+0000ef90: 6669 672e 766f 6361 625f 7369 7a65 5d0a  fig.vocab_size].
+0000efa0: 2020 2020 2020 2020 3e3e 3e20 6c69 7374          >>> list
+0000efb0: 286c 6f67 6974 732e 7368 6170 6529 203d  (logits.shape) =
+0000efc0: 3d20 6578 7065 6374 6564 5f73 6861 7065  = expected_shape
+0000efd0: 0a20 2020 2020 2020 2054 7275 650a 2020  .        True.  
+0000efe0: 2020 2020 2020 6060 6022 2222 0a0a 2020        ```"""..  
+0000eff0: 2020 2020 2020 6f75 7470 7574 5f61 7474        output_att
+0000f000: 656e 7469 6f6e 7320 3d20 6f75 7470 7574  entions = output
+0000f010: 5f61 7474 656e 7469 6f6e 7320 6966 206f  _attentions if o
+0000f020: 7574 7075 745f 6174 7465 6e74 696f 6e73  utput_attentions
+0000f030: 2069 7320 6e6f 7420 4e6f 6e65 2065 6c73   is not None els
+0000f040: 6520 7365 6c66 2e63 6f6e 6669 672e 6f75  e self.config.ou
+0000f050: 7470 7574 5f61 7474 656e 7469 6f6e 730a  tput_attentions.
+0000f060: 2020 2020 2020 2020 6f75 7470 7574 5f68          output_h
+0000f070: 6964 6465 6e5f 7374 6174 6573 203d 2028  idden_states = (
+0000f080: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
+0000f090: 7075 745f 6869 6464 656e 5f73 7461 7465  put_hidden_state
+0000f0a0: 7320 6966 206f 7574 7075 745f 6869 6464  s if output_hidd
+0000f0b0: 656e 5f73 7461 7465 7320 6973 206e 6f74  en_states is not
+0000f0c0: 204e 6f6e 6520 656c 7365 2073 656c 662e   None else self.
+0000f0d0: 636f 6e66 6967 2e6f 7574 7075 745f 6869  config.output_hi
+0000f0e0: 6464 656e 5f73 7461 7465 730a 2020 2020  dden_states.    
+0000f0f0: 2020 2020 290a 2020 2020 2020 2020 7265      ).        re
+0000f100: 7475 726e 5f64 6963 7420 3d20 7265 7475  turn_dict = retu
+0000f110: 726e 5f64 6963 7420 6966 2072 6574 7572  rn_dict if retur
+0000f120: 6e5f 6469 6374 2069 7320 6e6f 7420 4e6f  n_dict is not No
+0000f130: 6e65 2065 6c73 6520 7365 6c66 2e63 6f6e  ne else self.con
+0000f140: 6669 672e 7573 655f 7265 7475 726e 5f64  fig.use_return_d
+0000f150: 6963 740a 0a20 2020 2020 2020 2023 2064  ict..        # d
+0000f160: 6563 6f64 6572 206f 7574 7075 7473 2063  ecoder outputs c
+0000f170: 6f6e 7369 7374 7320 6f66 2028 6465 635f  onsists of (dec_
+0000f180: 6665 6174 7572 6573 2c20 6c61 7965 725f  features, layer_
+0000f190: 7374 6174 652c 2064 6563 5f68 6964 6465  state, dec_hidde
+0000f1a0: 6e2c 2064 6563 5f61 7474 6e29 0a20 2020  n, dec_attn).   
+0000f1b0: 2020 2020 206f 7574 7075 7473 203d 2073       outputs = s
+0000f1c0: 656c 662e 6d6f 6465 6c2e 6465 636f 6465  elf.model.decode
+0000f1d0: 7228 0a20 2020 2020 2020 2020 2020 2069  r(.            i
+0000f1e0: 6e70 7574 5f69 6473 3d69 6e70 7574 5f69  nput_ids=input_i
+0000f1f0: 6473 2c0a 2020 2020 2020 2020 2020 2020  ds,.            
+0000f200: 6174 7465 6e74 696f 6e5f 6d61 736b 3d61  attention_mask=a
+0000f210: 7474 656e 7469 6f6e 5f6d 6173 6b2c 0a20  ttention_mask,. 
+0000f220: 2020 2020 2020 2020 2020 2065 6e63 6f64             encod
+0000f230: 6572 5f68 6964 6465 6e5f 7374 6174 6573  er_hidden_states
+0000f240: 3d65 6e63 6f64 6572 5f68 6964 6465 6e5f  =encoder_hidden_
+0000f250: 7374 6174 6573 2c0a 2020 2020 2020 2020  states,.        
+0000f260: 2020 2020 656e 636f 6465 725f 6174 7465      encoder_atte
+0000f270: 6e74 696f 6e5f 6d61 736b 3d65 6e63 6f64  ntion_mask=encod
+0000f280: 6572 5f61 7474 656e 7469 6f6e 5f6d 6173  er_attention_mas
+0000f290: 6b2c 0a20 2020 2020 2020 2020 2020 2068  k,.            h
+0000f2a0: 6561 645f 6d61 736b 3d68 6561 645f 6d61  ead_mask=head_ma
+0000f2b0: 736b 2c0a 2020 2020 2020 2020 2020 2020  sk,.            
+0000f2c0: 6372 6f73 735f 6174 746e 5f68 6561 645f  cross_attn_head_
+0000f2d0: 6d61 736b 3d63 726f 7373 5f61 7474 6e5f  mask=cross_attn_
+0000f2e0: 6865 6164 5f6d 6173 6b2c 0a20 2020 2020  head_mask,.     
+0000f2f0: 2020 2020 2020 2070 6173 745f 6b65 795f         past_key_
+0000f300: 7661 6c75 6573 3d70 6173 745f 6b65 795f  values=past_key_
+0000f310: 7661 6c75 6573 2c0a 2020 2020 2020 2020  values,.        
+0000f320: 2020 2020 696e 7075 7473 5f65 6d62 6564      inputs_embed
+0000f330: 733d 696e 7075 7473 5f65 6d62 6564 732c  s=inputs_embeds,
+0000f340: 0a20 2020 2020 2020 2020 2020 2075 7365  .            use
+0000f350: 5f63 6163 6865 3d75 7365 5f63 6163 6865  _cache=use_cache
+0000f360: 2c0a 2020 2020 2020 2020 2020 2020 6f75  ,.            ou
+0000f370: 7470 7574 5f61 7474 656e 7469 6f6e 733d  tput_attentions=
+0000f380: 6f75 7470 7574 5f61 7474 656e 7469 6f6e  output_attention
+0000f390: 732c 0a20 2020 2020 2020 2020 2020 206f  s,.            o
+0000f3a0: 7574 7075 745f 6869 6464 656e 5f73 7461  utput_hidden_sta
+0000f3b0: 7465 733d 6f75 7470 7574 5f68 6964 6465  tes=output_hidde
+0000f3c0: 6e5f 7374 6174 6573 2c0a 2020 2020 2020  n_states,.      
+0000f3d0: 2020 2020 2020 7265 7475 726e 5f64 6963        return_dic
+0000f3e0: 743d 7265 7475 726e 5f64 6963 742c 0a20  t=return_dict,. 
+0000f3f0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+0000f400: 2020 6c6f 6769 7473 203d 2073 656c 662e    logits = self.
+0000f410: 6c6d 5f68 6561 6428 6f75 7470 7574 735b  lm_head(outputs[
+0000f420: 305d 290a 0a20 2020 2020 2020 206c 6f73  0])..        los
+0000f430: 7320 3d20 4e6f 6e65 0a20 2020 2020 2020  s = None.       
+0000f440: 2069 6620 6c61 6265 6c73 2069 7320 6e6f   if labels is no
+0000f450: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+0000f460: 2020 2020 6c6f 7373 203d 206f 7073 2e63      loss = ops.c
+0000f470: 726f 7373 5f65 6e74 726f 7079 286c 6f67  ross_entropy(log
+0000f480: 6974 732e 7669 6577 282d 312c 2073 656c  its.view(-1, sel
+0000f490: 662e 636f 6e66 6967 2e76 6f63 6162 5f73  f.config.vocab_s
+0000f4a0: 697a 6529 2c20 6c61 6265 6c73 2e76 6965  ize), labels.vie
+0000f4b0: 7728 2d31 2929 0a0a 2020 2020 2020 2020  w(-1))..        
+0000f4c0: 6966 206e 6f74 2072 6574 7572 6e5f 6469  if not return_di
+0000f4d0: 6374 3a0a 2020 2020 2020 2020 2020 2020  ct:.            
+0000f4e0: 6f75 7470 7574 203d 2028 6c6f 6769 7473  output = (logits
+0000f4f0: 2c29 202b 206f 7574 7075 7473 5b31 3a5d  ,) + outputs[1:]
+0000f500: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0000f510: 7572 6e20 286c 6f73 732c 2920 2b20 6f75  urn (loss,) + ou
+0000f520: 7470 7574 2069 6620 6c6f 7373 2069 7320  tput if loss is 
+0000f530: 6e6f 7420 4e6f 6e65 2065 6c73 6520 6f75  not None else ou
+0000f540: 7470 7574 0a0a 2020 2020 2020 2020 7265  tput..        re
+0000f550: 7475 726e 2043 6175 7361 6c4c 4d4f 7574  turn CausalLMOut
+0000f560: 7075 7457 6974 6843 726f 7373 4174 7465  putWithCrossAtte
+0000f570: 6e74 696f 6e73 280a 2020 2020 2020 2020  ntions(.        
+0000f580: 2020 2020 6c6f 7373 3d6c 6f73 732c 0a20      loss=loss,. 
+0000f590: 2020 2020 2020 2020 2020 206c 6f67 6974             logit
+0000f5a0: 733d 6c6f 6769 7473 2c0a 2020 2020 2020  s=logits,.      
+0000f5b0: 2020 2020 2020 7061 7374 5f6b 6579 5f76        past_key_v
+0000f5c0: 616c 7565 733d 6f75 7470 7574 732e 7061  alues=outputs.pa
+0000f5d0: 7374 5f6b 6579 5f76 616c 7565 732c 0a20  st_key_values,. 
+0000f5e0: 2020 2020 2020 2020 2020 2068 6964 6465             hidde
+0000f5f0: 6e5f 7374 6174 6573 3d6f 7574 7075 7473  n_states=outputs
+0000f600: 2e68 6964 6465 6e5f 7374 6174 6573 2c0a  .hidden_states,.
+0000f610: 2020 2020 2020 2020 2020 2020 6174 7465              atte
+0000f620: 6e74 696f 6e73 3d6f 7574 7075 7473 2e61  ntions=outputs.a
+0000f630: 7474 656e 7469 6f6e 732c 0a20 2020 2020  ttentions,.     
+0000f640: 2020 2020 2020 2063 726f 7373 5f61 7474         cross_att
+0000f650: 656e 7469 6f6e 733d 6f75 7470 7574 732e  entions=outputs.
+0000f660: 6372 6f73 735f 6174 7465 6e74 696f 6e73  cross_attentions
+0000f670: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
+0000f680: 2064 6566 2070 7265 7061 7265 5f69 6e70   def prepare_inp
+0000f690: 7574 735f 666f 725f 6765 6e65 7261 7469  uts_for_generati
+0000f6a0: 6f6e 280a 2020 2020 2020 2020 7365 6c66  on(.        self
+0000f6b0: 2c20 696e 7075 745f 6964 732c 2070 6173  , input_ids, pas
+0000f6c0: 745f 6b65 795f 7661 6c75 6573 3d4e 6f6e  t_key_values=Non
+0000f6d0: 652c 2061 7474 656e 7469 6f6e 5f6d 6173  e, attention_mas
+0000f6e0: 6b3d 4e6f 6e65 2c20 7573 655f 6361 6368  k=None, use_cach
+0000f6f0: 653d 4e6f 6e65 2c20 2a2a 6b77 6172 6773  e=None, **kwargs
+0000f700: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
+0000f710: 2320 6966 206d 6f64 656c 2069 7320 7573  # if model is us
+0000f720: 6564 2061 7320 6120 6465 636f 6465 7220  ed as a decoder 
+0000f730: 696e 2065 6e63 6f64 6572 2d64 6563 6f64  in encoder-decod
+0000f740: 6572 206d 6f64 656c 2c20 7468 6520 6465  er model, the de
+0000f750: 636f 6465 7220 6174 7465 6e74 696f 6e20  coder attention 
+0000f760: 6d61 736b 2069 7320 6372 6561 7465 6420  mask is created 
+0000f770: 6f6e 2074 6865 2066 6c79 0a20 2020 2020  on the fly.     
+0000f780: 2020 2069 6620 6174 7465 6e74 696f 6e5f     if attention_
+0000f790: 6d61 736b 2069 7320 4e6f 6e65 3a0a 2020  mask is None:.  
+0000f7a0: 2020 2020 2020 2020 2020 6174 7465 6e74            attent
+0000f7b0: 696f 6e5f 6d61 736b 203d 2069 6e70 7574  ion_mask = input
+0000f7c0: 5f69 6473 2e6e 6577 5f6f 6e65 7328 696e  _ids.new_ones(in
+0000f7d0: 7075 745f 6964 732e 7368 6170 6529 0a0a  put_ids.shape)..
+0000f7e0: 2020 2020 2020 2020 6966 2070 6173 745f          if past_
+0000f7f0: 6b65 795f 7661 6c75 6573 3a0a 2020 2020  key_values:.    
+0000f800: 2020 2020 2020 2020 7061 7374 5f6c 656e          past_len
+0000f810: 6774 6820 3d20 7061 7374 5f6b 6579 5f76  gth = past_key_v
+0000f820: 616c 7565 735b 305d 5b30 5d2e 7368 6170  alues[0][0].shap
+0000f830: 655b 325d 0a0a 2020 2020 2020 2020 2020  e[2]..          
+0000f840: 2020 2320 536f 6d65 2067 656e 6572 6174    # Some generat
+0000f850: 696f 6e20 6d65 7468 6f64 7320 616c 7265  ion methods alre
+0000f860: 6164 7920 7061 7373 206f 6e6c 7920 7468  ady pass only th
+0000f870: 6520 6c61 7374 2069 6e70 7574 2049 440a  e last input ID.
+0000f880: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+0000f890: 6e70 7574 5f69 6473 2e73 6861 7065 5b31  nput_ids.shape[1
+0000f8a0: 5d20 3e20 7061 7374 5f6c 656e 6774 683a  ] > past_length:
+0000f8b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f8c0: 2072 656d 6f76 655f 7072 6566 6978 5f6c   remove_prefix_l
+0000f8d0: 656e 6774 6820 3d20 7061 7374 5f6c 656e  ength = past_len
+0000f8e0: 6774 680a 2020 2020 2020 2020 2020 2020  gth.            
+0000f8f0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0000f900: 2020 2020 2020 2320 4465 6661 756c 7420        # Default 
+0000f910: 746f 206f 6c64 2062 6568 6176 696f 723a  to old behavior:
+0000f920: 206b 6565 7020 6f6e 6c79 2066 696e 616c   keep only final
+0000f930: 2049 440a 2020 2020 2020 2020 2020 2020   ID.            
+0000f940: 2020 2020 7265 6d6f 7665 5f70 7265 6669      remove_prefi
+0000f950: 785f 6c65 6e67 7468 203d 2069 6e70 7574  x_length = input
+0000f960: 5f69 6473 2e73 6861 7065 5b31 5d20 2d20  _ids.shape[1] - 
+0000f970: 310a 0a20 2020 2020 2020 2020 2020 2069  1..            i
+0000f980: 6e70 7574 5f69 6473 203d 2069 6e70 7574  nput_ids = input
+0000f990: 5f69 6473 5b3a 2c20 7265 6d6f 7665 5f70  _ids[:, remove_p
+0000f9a0: 7265 6669 785f 6c65 6e67 7468 3a5d 0a20  refix_length:]. 
+0000f9b0: 2020 2020 2020 2023 2066 6972 7374 2073         # first s
+0000f9c0: 7465 702c 2064 6563 6f64 6572 5f63 6163  tep, decoder_cac
+0000f9d0: 6865 645f 7374 6174 6573 2061 7265 2065  hed_states are e
+0000f9e0: 6d70 7479 0a20 2020 2020 2020 2072 6574  mpty.        ret
+0000f9f0: 7572 6e20 7b0a 2020 2020 2020 2020 2020  urn {.          
+0000fa00: 2020 2269 6e70 7574 5f69 6473 223a 2069    "input_ids": i
+0000fa10: 6e70 7574 5f69 6473 2c20 2023 2065 6e63  nput_ids,  # enc
+0000fa20: 6f64 6572 5f6f 7574 7075 7473 2069 7320  oder_outputs is 
+0000fa30: 6465 6669 6e65 642e 2069 6e70 7574 5f69  defined. input_i
+0000fa40: 6473 206e 6f74 206e 6565 6465 640a 2020  ds not needed.  
+0000fa50: 2020 2020 2020 2020 2020 2261 7474 656e            "atten
+0000fa60: 7469 6f6e 5f6d 6173 6b22 3a20 6174 7465  tion_mask": atte
+0000fa70: 6e74 696f 6e5f 6d61 736b 2c0a 2020 2020  ntion_mask,.    
+0000fa80: 2020 2020 2020 2020 2270 6173 745f 6b65          "past_ke
+0000fa90: 795f 7661 6c75 6573 223a 2070 6173 745f  y_values": past_
+0000faa0: 6b65 795f 7661 6c75 6573 2c0a 2020 2020  key_values,.    
+0000fab0: 2020 2020 2020 2020 2275 7365 5f63 6163          "use_cac
+0000fac0: 6865 223a 2075 7365 5f63 6163 6865 2c0a  he": use_cache,.
+0000fad0: 2020 2020 2020 2020 7d0a 0a20 2020 2040          }..    @
+0000fae0: 7374 6174 6963 6d65 7468 6f64 0a20 2020  staticmethod.   
+0000faf0: 2064 6566 205f 7265 6f72 6465 725f 6361   def _reorder_ca
+0000fb00: 6368 6528 7061 7374 5f6b 6579 5f76 616c  che(past_key_val
+0000fb10: 7565 732c 2062 6561 6d5f 6964 7829 3a0a  ues, beam_idx):.
+0000fb20: 2020 2020 2020 2020 7265 6f72 6465 7265          reordere
+0000fb30: 645f 7061 7374 203d 2028 290a 2020 2020  d_past = ().    
+0000fb40: 2020 2020 666f 7220 6c61 7965 725f 7061      for layer_pa
+0000fb50: 7374 2069 6e20 7061 7374 5f6b 6579 5f76  st in past_key_v
+0000fb60: 616c 7565 733a 0a20 2020 2020 2020 2020  alues:.         
+0000fb70: 2020 2072 656f 7264 6572 6564 5f70 6173     reordered_pas
+0000fb80: 7420 2b3d 2028 0a20 2020 2020 2020 2020  t += (.         
+0000fb90: 2020 2020 2020 2074 7570 6c65 2870 6173         tuple(pas
+0000fba0: 745f 7374 6174 652e 696e 6465 785f 7365  t_state.index_se
+0000fbb0: 6c65 6374 2830 2c20 6265 616d 5f69 6478  lect(0, beam_idx
+0000fbc0: 2920 666f 7220 7061 7374 5f73 7461 7465  ) for past_state
+0000fbd0: 2069 6e20 6c61 7965 725f 7061 7374 292c   in layer_past),
+0000fbe0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0000fbf0: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+0000fc00: 6f72 6465 7265 645f 7061 7374 0a0a 5f5f  ordered_past..__
+0000fc10: 616c 6c5f 5f20 3d20 5b0a 2020 2020 2242  all__ = [.    "B
+0000fc20: 6c65 6e64 6572 626f 7446 6f72 4361 7573  lenderbotForCaus
+0000fc30: 616c 4c4d 222c 0a20 2020 2022 426c 656e  alLM",.    "Blen
+0000fc40: 6465 7262 6f74 466f 7243 6f6e 6469 7469  derbotForConditi
+0000fc50: 6f6e 616c 4765 6e65 7261 7469 6f6e 222c  onalGeneration",
+0000fc60: 0a20 2020 2022 426c 656e 6465 7262 6f74  .    "Blenderbot
+0000fc70: 4d6f 6465 6c22 2c0a 2020 2020 2242 6c65  Model",.    "Ble
+0000fc80: 6e64 6572 626f 7450 7265 5472 6169 6e65  nderbotPreTraine
+0000fc90: 644d 6f64 656c 222c 0a5d 0a              dModel",.].
```

## mindnlp/transformers/models/blenderbot/tokenization_blenderbot.py

```diff
@@ -0,0 +1,1195 @@
+00000000: 2320 636f 6469 6e67 3d75 7466 2d38 0a23  # coding=utf-8.#
+00000010: 2043 6f70 7972 6967 6874 2032 3032 3120   Copyright 2021 
+00000020: 5468 6520 4661 6365 626f 6f6b 2049 6e63  The Facebook Inc
+00000030: 2e20 616e 6420 5468 6520 4875 6767 696e  . and The Huggin
+00000040: 6746 6163 6520 496e 632e 2074 6561 6d2e  gFace Inc. team.
+00000050: 2041 6c6c 2072 6967 6874 7320 7265 7365   All rights rese
+00000060: 7276 6564 2e0a 230a 2320 4c69 6365 6e73  rved..#.# Licens
+00000070: 6564 2075 6e64 6572 2074 6865 2041 7061  ed under the Apa
+00000080: 6368 6520 4c69 6365 6e73 652c 2056 6572  che License, Ver
+00000090: 7369 6f6e 2032 2e30 2028 7468 6520 224c  sion 2.0 (the "L
+000000a0: 6963 656e 7365 2229 3b0a 2320 796f 7520  icense");.# you 
+000000b0: 6d61 7920 6e6f 7420 7573 6520 7468 6973  may not use this
+000000c0: 2066 696c 6520 6578 6365 7074 2069 6e20   file except in 
+000000d0: 636f 6d70 6c69 616e 6365 2077 6974 6820  compliance with 
+000000e0: 7468 6520 4c69 6365 6e73 652e 0a23 2059  the License..# Y
+000000f0: 6f75 206d 6179 206f 6274 6169 6e20 6120  ou may obtain a 
+00000100: 636f 7079 206f 6620 7468 6520 4c69 6365  copy of the Lice
+00000110: 6e73 6520 6174 0a23 0a23 2020 2020 2068  nse at.#.#     h
+00000120: 7474 703a 2f2f 7777 772e 6170 6163 6865  ttp://www.apache
+00000130: 2e6f 7267 2f6c 6963 656e 7365 732f 4c49  .org/licenses/LI
+00000140: 4345 4e53 452d 322e 300a 230a 2320 556e  CENSE-2.0.#.# Un
+00000150: 6c65 7373 2072 6571 7569 7265 6420 6279  less required by
+00000160: 2061 7070 6c69 6361 626c 6520 6c61 7720   applicable law 
+00000170: 6f72 2061 6772 6565 6420 746f 2069 6e20  or agreed to in 
+00000180: 7772 6974 696e 672c 2073 6f66 7477 6172  writing, softwar
+00000190: 650a 2320 6469 7374 7269 6275 7465 6420  e.# distributed 
+000001a0: 756e 6465 7220 7468 6520 4c69 6365 6e73  under the Licens
+000001b0: 6520 6973 2064 6973 7472 6962 7574 6564  e is distributed
+000001c0: 206f 6e20 616e 2022 4153 2049 5322 2042   on an "AS IS" B
+000001d0: 4153 4953 2c0a 2320 5749 5448 4f55 5420  ASIS,.# WITHOUT 
+000001e0: 5741 5252 414e 5449 4553 204f 5220 434f  WARRANTIES OR CO
+000001f0: 4e44 4954 494f 4e53 204f 4620 414e 5920  NDITIONS OF ANY 
+00000200: 4b49 4e44 2c20 6569 7468 6572 2065 7870  KIND, either exp
+00000210: 7265 7373 206f 7220 696d 706c 6965 642e  ress or implied.
+00000220: 0a23 2053 6565 2074 6865 204c 6963 656e  .# See the Licen
+00000230: 7365 2066 6f72 2074 6865 2073 7065 6369  se for the speci
+00000240: 6669 6320 6c61 6e67 7561 6765 2067 6f76  fic language gov
+00000250: 6572 6e69 6e67 2070 6572 6d69 7373 696f  erning permissio
+00000260: 6e73 2061 6e64 0a23 206c 696d 6974 6174  ns and.# limitat
+00000270: 696f 6e73 2075 6e64 6572 2074 6865 204c  ions under the L
+00000280: 6963 656e 7365 2e0a 2222 2254 6f6b 656e  icense.."""Token
+00000290: 697a 6174 696f 6e20 636c 6173 7320 666f  ization class fo
+000002a0: 7220 426c 656e 6465 7262 6f74 2e22 2222  r Blenderbot."""
+000002b0: 0a0a 696d 706f 7274 206a 736f 6e0a 696d  ..import json.im
+000002c0: 706f 7274 206f 730a 6672 6f6d 2066 756e  port os.from fun
+000002d0: 6374 6f6f 6c73 2069 6d70 6f72 7420 6c72  ctools import lr
+000002e0: 755f 6361 6368 650a 6672 6f6d 2074 7970  u_cache.from typ
+000002f0: 696e 6720 696d 706f 7274 204c 6973 742c  ing import List,
+00000300: 204f 7074 696f 6e61 6c2c 2054 7570 6c65   Optional, Tuple
+00000310: 0a0a 696d 706f 7274 2072 6567 6578 2061  ..import regex a
+00000320: 7320 7265 0a0a 6672 6f6d 202e 2e2e 746f  s re..from ...to
+00000330: 6b65 6e69 7a61 7469 6f6e 5f75 7469 6c73  kenization_utils
+00000340: 2069 6d70 6f72 7420 4164 6465 6454 6f6b   import AddedTok
+00000350: 656e 2c20 5072 6554 7261 696e 6564 546f  en, PreTrainedTo
+00000360: 6b65 6e69 7a65 720a 6672 6f6d 202e 2e2e  kenizer.from ...
+00000370: 2e75 7469 6c73 2069 6d70 6f72 7420 6c6f  .utils import lo
+00000380: 6767 696e 670a 0a0a 6c6f 6767 6572 203d  gging...logger =
+00000390: 206c 6f67 6769 6e67 2e67 6574 5f6c 6f67   logging.get_log
+000003a0: 6765 7228 5f5f 6e61 6d65 5f5f 290a 0a0a  ger(__name__)...
+000003b0: 564f 4341 425f 4649 4c45 535f 4e41 4d45  VOCAB_FILES_NAME
+000003c0: 5320 3d20 7b0a 2020 2020 2276 6f63 6162  S = {.    "vocab
+000003d0: 5f66 696c 6522 3a20 2276 6f63 6162 2e6a  _file": "vocab.j
+000003e0: 736f 6e22 2c0a 2020 2020 226d 6572 6765  son",.    "merge
+000003f0: 735f 6669 6c65 223a 2022 6d65 7267 6573  s_file": "merges
+00000400: 2e74 7874 222c 0a20 2020 2022 746f 6b65  .txt",.    "toke
+00000410: 6e69 7a65 725f 636f 6e66 6967 5f66 696c  nizer_config_fil
+00000420: 6522 3a20 2274 6f6b 656e 697a 6572 5f63  e": "tokenizer_c
+00000430: 6f6e 6669 672e 6a73 6f6e 222c 0a7d 0a0a  onfig.json",.}..
+00000440: 0a40 6c72 755f 6361 6368 6528 290a 2320  .@lru_cache().# 
+00000450: 436f 7069 6564 2066 726f 6d20 7472 616e  Copied from tran
+00000460: 7366 6f72 6d65 7273 2e6d 6f64 656c 732e  sformers.models.
+00000470: 726f 6265 7274 612e 746f 6b65 6e69 7a61  roberta.tokeniza
+00000480: 7469 6f6e 5f72 6f62 6572 7461 2e62 7974  tion_roberta.byt
+00000490: 6573 5f74 6f5f 756e 6963 6f64 650a 6465  es_to_unicode.de
+000004a0: 6620 6279 7465 735f 746f 5f75 6e69 636f  f bytes_to_unico
+000004b0: 6465 2829 3a0a 2020 2020 2222 220a 2020  de():.    """.  
+000004c0: 2020 5265 7475 726e 7320 6c69 7374 206f    Returns list o
+000004d0: 6620 7574 662d 3820 6279 7465 2061 6e64  f utf-8 byte and
+000004e0: 2061 206d 6170 7069 6e67 2074 6f20 756e   a mapping to un
+000004f0: 6963 6f64 6520 7374 7269 6e67 732e 2057  icode strings. W
+00000500: 6520 7370 6563 6966 6963 616c 6c79 2061  e specifically a
+00000510: 766f 6964 7320 6d61 7070 696e 6720 746f  voids mapping to
+00000520: 2077 6869 7465 7370 6163 652f 636f 6e74   whitespace/cont
+00000530: 726f 6c0a 2020 2020 6368 6172 6163 7465  rol.    characte
+00000540: 7273 2074 6865 2062 7065 2063 6f64 6520  rs the bpe code 
+00000550: 6261 7266 7320 6f6e 2e0a 0a20 2020 2054  barfs on...    T
+00000560: 6865 2072 6576 6572 7369 626c 6520 6270  he reversible bp
+00000570: 6520 636f 6465 7320 776f 726b 206f 6e20  e codes work on 
+00000580: 756e 6963 6f64 6520 7374 7269 6e67 732e  unicode strings.
+00000590: 2054 6869 7320 6d65 616e 7320 796f 7520   This means you 
+000005a0: 6e65 6564 2061 206c 6172 6765 2023 206f  need a large # o
+000005b0: 6620 756e 6963 6f64 6520 6368 6172 6163  f unicode charac
+000005c0: 7465 7273 2069 6e20 796f 7572 2076 6f63  ters in your voc
+000005d0: 6162 0a20 2020 2069 6620 796f 7520 7761  ab.    if you wa
+000005e0: 6e74 2074 6f20 6176 6f69 6420 554e 4b73  nt to avoid UNKs
+000005f0: 2e20 5768 656e 2079 6f75 2772 6520 6174  . When you're at
+00000600: 2073 6f6d 6574 6869 6e67 206c 696b 6520   something like 
+00000610: 6120 3130 4220 746f 6b65 6e20 6461 7461  a 10B token data
+00000620: 7365 7420 796f 7520 656e 6420 7570 206e  set you end up n
+00000630: 6565 6469 6e67 2061 726f 756e 6420 354b  eeding around 5K
+00000640: 2066 6f72 0a20 2020 2064 6563 656e 7420   for.    decent 
+00000650: 636f 7665 7261 6765 2e20 5468 6973 2069  coverage. This i
+00000660: 7320 6120 7369 676e 6966 6963 616e 7420  s a significant 
+00000670: 7065 7263 656e 7461 6765 206f 6620 796f  percentage of yo
+00000680: 7572 206e 6f72 6d61 6c2c 2073 6179 2c20  ur normal, say, 
+00000690: 3332 4b20 6270 6520 766f 6361 622e 2054  32K bpe vocab. T
+000006a0: 6f20 6176 6f69 6420 7468 6174 2c20 7765  o avoid that, we
+000006b0: 2077 616e 7420 6c6f 6f6b 7570 0a20 2020   want lookup.   
+000006c0: 2074 6162 6c65 7320 6265 7477 6565 6e20   tables between 
+000006d0: 7574 662d 3820 6279 7465 7320 616e 6420  utf-8 bytes and 
+000006e0: 756e 6963 6f64 6520 7374 7269 6e67 732e  unicode strings.
+000006f0: 0a20 2020 2022 2222 0a20 2020 2062 7320  .    """.    bs 
+00000700: 3d20 280a 2020 2020 2020 2020 6c69 7374  = (.        list
+00000710: 2872 616e 6765 286f 7264 2822 2122 292c  (range(ord("!"),
+00000720: 206f 7264 2822 7e22 2920 2b20 3129 2920   ord("~") + 1)) 
+00000730: 2b20 6c69 7374 2872 616e 6765 286f 7264  + list(range(ord
+00000740: 2822 c2a1 2229 2c20 6f72 6428 22c2 ac22  (".."), ord(".."
+00000750: 2920 2b20 3129 2920 2b20 6c69 7374 2872  ) + 1)) + list(r
+00000760: 616e 6765 286f 7264 2822 c2ae 2229 2c20  ange(ord(".."), 
+00000770: 6f72 6428 22c3 bf22 2920 2b20 3129 290a  ord("..") + 1)).
+00000780: 2020 2020 290a 2020 2020 6373 203d 2062      ).    cs = b
+00000790: 735b 3a5d 0a20 2020 206e 203d 2030 0a20  s[:].    n = 0. 
+000007a0: 2020 2066 6f72 2062 2069 6e20 7261 6e67     for b in rang
+000007b0: 6528 322a 2a38 293a 0a20 2020 2020 2020  e(2**8):.       
+000007c0: 2069 6620 6220 6e6f 7420 696e 2062 733a   if b not in bs:
+000007d0: 0a20 2020 2020 2020 2020 2020 2062 732e  .            bs.
+000007e0: 6170 7065 6e64 2862 290a 2020 2020 2020  append(b).      
+000007f0: 2020 2020 2020 6373 2e61 7070 656e 6428        cs.append(
+00000800: 322a 2a38 202b 206e 290a 2020 2020 2020  2**8 + n).      
+00000810: 2020 2020 2020 6e20 2b3d 2031 0a20 2020        n += 1.   
+00000820: 2063 7320 3d20 5b63 6872 286e 2920 666f   cs = [chr(n) fo
+00000830: 7220 6e20 696e 2063 735d 0a20 2020 2072  r n in cs].    r
+00000840: 6574 7572 6e20 6469 6374 287a 6970 2862  eturn dict(zip(b
+00000850: 732c 2063 7329 290a 0a0a 2320 436f 7069  s, cs))...# Copi
+00000860: 6564 2066 726f 6d20 7472 616e 7366 6f72  ed from transfor
+00000870: 6d65 7273 2e6d 6f64 656c 732e 726f 6265  mers.models.robe
+00000880: 7274 612e 746f 6b65 6e69 7a61 7469 6f6e  rta.tokenization
+00000890: 5f72 6f62 6572 7461 2e67 6574 5f70 6169  _roberta.get_pai
+000008a0: 7273 0a64 6566 2067 6574 5f70 6169 7273  rs.def get_pairs
+000008b0: 2877 6f72 6429 3a0a 2020 2020 2222 220a  (word):.    """.
+000008c0: 2020 2020 5265 7475 726e 2073 6574 206f      Return set o
+000008d0: 6620 7379 6d62 6f6c 2070 6169 7273 2069  f symbol pairs i
+000008e0: 6e20 6120 776f 7264 2e0a 0a20 2020 2057  n a word...    W
+000008f0: 6f72 6420 6973 2072 6570 7265 7365 6e74  ord is represent
+00000900: 6564 2061 7320 7475 706c 6520 6f66 2073  ed as tuple of s
+00000910: 796d 626f 6c73 2028 7379 6d62 6f6c 7320  ymbols (symbols 
+00000920: 6265 696e 6720 7661 7269 6162 6c65 2d6c  being variable-l
+00000930: 656e 6774 6820 7374 7269 6e67 7329 2e0a  ength strings)..
+00000940: 2020 2020 2222 220a 2020 2020 7061 6972      """.    pair
+00000950: 7320 3d20 7365 7428 290a 2020 2020 7072  s = set().    pr
+00000960: 6576 5f63 6861 7220 3d20 776f 7264 5b30  ev_char = word[0
+00000970: 5d0a 2020 2020 666f 7220 6368 6172 2069  ].    for char i
+00000980: 6e20 776f 7264 5b31 3a5d 3a0a 2020 2020  n word[1:]:.    
+00000990: 2020 2020 7061 6972 732e 6164 6428 2870      pairs.add((p
+000009a0: 7265 765f 6368 6172 2c20 6368 6172 2929  rev_char, char))
+000009b0: 0a20 2020 2020 2020 2070 7265 765f 6368  .        prev_ch
+000009c0: 6172 203d 2063 6861 720a 2020 2020 7265  ar = char.    re
+000009d0: 7475 726e 2070 6169 7273 0a0a 0a63 6c61  turn pairs...cla
+000009e0: 7373 2042 6c65 6e64 6572 626f 7454 6f6b  ss BlenderbotTok
+000009f0: 656e 697a 6572 2850 7265 5472 6169 6e65  enizer(PreTraine
+00000a00: 6454 6f6b 656e 697a 6572 293a 0a20 2020  dTokenizer):.   
+00000a10: 2022 2222 0a20 2020 2043 6f6e 7374 7275   """.    Constru
+00000a20: 6374 7320 6120 426c 656e 6465 7262 6f74  cts a Blenderbot
+00000a30: 2074 6f6b 656e 697a 6572 2c20 6465 7269   tokenizer, deri
+00000a40: 7665 6420 6672 6f6d 2074 6865 2047 5054  ved from the GPT
+00000a50: 2d32 2074 6f6b 656e 697a 6572 2c20 7573  -2 tokenizer, us
+00000a60: 696e 6720 6279 7465 2d6c 6576 656c 2042  ing byte-level B
+00000a70: 7974 652d 5061 6972 2d45 6e63 6f64 696e  yte-Pair-Encodin
+00000a80: 672e 0a0a 2020 2020 5468 6973 2074 6f6b  g...    This tok
+00000a90: 656e 697a 6572 2068 6173 2062 6565 6e20  enizer has been 
+00000aa0: 7472 6169 6e65 6420 746f 2074 7265 6174  trained to treat
+00000ab0: 2073 7061 6365 7320 6c69 6b65 2070 6172   spaces like par
+00000ac0: 7473 206f 6620 7468 6520 746f 6b65 6e73  ts of the tokens
+00000ad0: 2028 6120 6269 7420 6c69 6b65 2073 656e   (a bit like sen
+00000ae0: 7465 6e63 6570 6965 6365 2920 736f 2061  tencepiece) so a
+00000af0: 2077 6f72 6420 7769 6c6c 0a20 2020 2062   word will.    b
+00000b00: 6520 656e 636f 6465 6420 6469 6666 6572  e encoded differ
+00000b10: 656e 746c 7920 7768 6574 6865 7220 6974  ently whether it
+00000b20: 2069 7320 6174 2074 6865 2062 6567 696e   is at the begin
+00000b30: 6e69 6e67 206f 6620 7468 6520 7365 6e74  ning of the sent
+00000b40: 656e 6365 2028 7769 7468 6f75 7420 7370  ence (without sp
+00000b50: 6163 6529 206f 7220 6e6f 743a 0a0a 2020  ace) or not:..  
+00000b60: 2020 6060 6070 7974 686f 6e0a 2020 2020    ```python.    
+00000b70: 3e3e 3e20 6672 6f6d 2074 7261 6e73 666f  >>> from transfo
+00000b80: 726d 6572 7320 696d 706f 7274 2042 6c65  rmers import Ble
+00000b90: 6e64 6572 626f 7454 6f6b 656e 697a 6572  nderbotTokenizer
+00000ba0: 0a0a 2020 2020 3e3e 3e20 746f 6b65 6e69  ..    >>> tokeni
+00000bb0: 7a65 7220 3d20 426c 656e 6465 7262 6f74  zer = Blenderbot
+00000bc0: 546f 6b65 6e69 7a65 722e 6672 6f6d 5f70  Tokenizer.from_p
+00000bd0: 7265 7472 6169 6e65 6428 2266 6163 6562  retrained("faceb
+00000be0: 6f6f 6b2f 626c 656e 6465 7262 6f74 2d33  ook/blenderbot-3
+00000bf0: 4222 290a 2020 2020 3e3e 3e20 746f 6b65  B").    >>> toke
+00000c00: 6e69 7a65 722e 6164 645f 7072 6566 6978  nizer.add_prefix
+00000c10: 5f73 7061 6365 203d 2046 616c 7365 0a20  _space = False. 
+00000c20: 2020 203e 3e3e 2074 6f6b 656e 697a 6572     >>> tokenizer
+00000c30: 2822 4865 6c6c 6f20 776f 726c 6422 295b  ("Hello world")[
+00000c40: 2269 6e70 7574 5f69 6473 225d 0a20 2020  "input_ids"].   
+00000c50: 205b 3437 2c20 3932 312c 2038 362c 2031   [47, 921, 86, 1
+00000c60: 3038 352c 2032 5d0a 0a20 2020 203e 3e3e  085, 2]..    >>>
+00000c70: 2074 6f6b 656e 697a 6572 2822 2048 656c   tokenizer(" Hel
+00000c80: 6c6f 2077 6f72 6c64 2229 5b22 696e 7075  lo world")["inpu
+00000c90: 745f 6964 7322 5d0a 2020 2020 5b36 3935  t_ids"].    [695
+00000ca0: 302c 2031 3038 352c 2032 5d0a 2020 2020  0, 1085, 2].    
+00000cb0: 6060 600a 0a20 2020 2059 6f75 2063 616e  ```..    You can
+00000cc0: 2067 6574 2061 726f 756e 6420 7468 6174   get around that
+00000cd0: 2062 6568 6176 696f 7220 6279 2070 6173   behavior by pas
+00000ce0: 7369 6e67 2060 6164 645f 7072 6566 6978  sing `add_prefix
+00000cf0: 5f73 7061 6365 3d54 7275 6560 2077 6865  _space=True` whe
+00000d00: 6e20 696e 7374 616e 7469 6174 696e 6720  n instantiating 
+00000d10: 7468 6973 2074 6f6b 656e 697a 6572 206f  this tokenizer o
+00000d20: 7220 7768 656e 2079 6f75 0a20 2020 2063  r when you.    c
+00000d30: 616c 6c20 6974 206f 6e20 736f 6d65 2074  all it on some t
+00000d40: 6578 742c 2062 7574 2073 696e 6365 2074  ext, but since t
+00000d50: 6865 206d 6f64 656c 2077 6173 206e 6f74  he model was not
+00000d60: 2070 7265 7472 6169 6e65 6420 7468 6973   pretrained this
+00000d70: 2077 6179 2c20 6974 206d 6967 6874 2079   way, it might y
+00000d80: 6965 6c64 2061 2064 6563 7265 6173 6520  ield a decrease 
+00000d90: 696e 2070 6572 666f 726d 616e 6365 2e0a  in performance..
+00000da0: 0a20 2020 203c 5469 703e 0a0a 2020 2020  .    <Tip>..    
+00000db0: 5768 656e 2075 7365 6420 7769 7468 2060  When used with `
+00000dc0: 6973 5f73 706c 6974 5f69 6e74 6f5f 776f  is_split_into_wo
+00000dd0: 7264 733d 5472 7565 602c 2074 6869 7320  rds=True`, this 
+00000de0: 746f 6b65 6e69 7a65 7220 7769 6c6c 2061  tokenizer will a
+00000df0: 6464 2061 2073 7061 6365 2062 6566 6f72  dd a space befor
+00000e00: 6520 6561 6368 2077 6f72 6420 2865 7665  e each word (eve
+00000e10: 6e20 7468 6520 6669 7273 7420 6f6e 6529  n the first one)
+00000e20: 2e0a 0a20 2020 203c 2f54 6970 3e0a 0a20  ...    </Tip>.. 
+00000e30: 2020 2054 6869 7320 746f 6b65 6e69 7a65     This tokenize
+00000e40: 7220 696e 6865 7269 7473 2066 726f 6d20  r inherits from 
+00000e50: 5b60 5072 6554 7261 696e 6564 546f 6b65  [`PreTrainedToke
+00000e60: 6e69 7a65 7260 5d20 7768 6963 6820 636f  nizer`] which co
+00000e70: 6e74 6169 6e73 206d 6f73 7420 6f66 2074  ntains most of t
+00000e80: 6865 206d 6169 6e20 6d65 7468 6f64 732e  he main methods.
+00000e90: 2055 7365 7273 2073 686f 756c 6420 7265   Users should re
+00000ea0: 6665 7220 746f 0a20 2020 2074 6869 7320  fer to.    this 
+00000eb0: 7375 7065 7263 6c61 7373 2066 6f72 206d  superclass for m
+00000ec0: 6f72 6520 696e 666f 726d 6174 696f 6e20  ore information 
+00000ed0: 7265 6761 7264 696e 6720 7468 6f73 6520  regarding those 
+00000ee0: 6d65 7468 6f64 732e 0a0a 2020 2020 4172  methods...    Ar
+00000ef0: 6773 3a0a 2020 2020 2020 2020 766f 6361  gs:.        voca
+00000f00: 625f 6669 6c65 2028 6073 7472 6029 3a0a  b_file (`str`):.
+00000f10: 2020 2020 2020 2020 2020 2020 5061 7468              Path
+00000f20: 2074 6f20 7468 6520 766f 6361 6275 6c61   to the vocabula
+00000f30: 7279 2066 696c 652e 0a20 2020 2020 2020  ry file..       
+00000f40: 206d 6572 6765 735f 6669 6c65 2028 6073   merges_file (`s
+00000f50: 7472 6029 3a0a 2020 2020 2020 2020 2020  tr`):.          
+00000f60: 2020 5061 7468 2074 6f20 7468 6520 6d65    Path to the me
+00000f70: 7267 6573 2066 696c 652e 0a20 2020 2020  rges file..     
+00000f80: 2020 2065 7272 6f72 7320 2860 7374 7260     errors (`str`
+00000f90: 2c20 2a6f 7074 696f 6e61 6c2a 2c20 6465  , *optional*, de
+00000fa0: 6661 756c 7473 2074 6f20 6022 7265 706c  faults to `"repl
+00000fb0: 6163 6522 6029 3a0a 2020 2020 2020 2020  ace"`):.        
+00000fc0: 2020 2020 5061 7261 6469 676d 2074 6f20      Paradigm to 
+00000fd0: 666f 6c6c 6f77 2077 6865 6e20 6465 636f  follow when deco
+00000fe0: 6469 6e67 2062 7974 6573 2074 6f20 5554  ding bytes to UT
+00000ff0: 462d 382e 2053 6565 0a20 2020 2020 2020  F-8. See.       
+00001000: 2020 2020 205b 6279 7465 732e 6465 636f       [bytes.deco
+00001010: 6465 5d28 6874 7470 733a 2f2f 646f 6373  de](https://docs
+00001020: 2e70 7974 686f 6e2e 6f72 672f 332f 6c69  .python.org/3/li
+00001030: 6272 6172 792f 7374 6474 7970 6573 2e68  brary/stdtypes.h
+00001040: 746d 6c23 6279 7465 732e 6465 636f 6465  tml#bytes.decode
+00001050: 2920 666f 7220 6d6f 7265 2069 6e66 6f72  ) for more infor
+00001060: 6d61 7469 6f6e 2e0a 2020 2020 2020 2020  mation..        
+00001070: 626f 735f 746f 6b65 6e20 2860 7374 7260  bos_token (`str`
+00001080: 2c20 2a6f 7074 696f 6e61 6c2a 2c20 6465  , *optional*, de
+00001090: 6661 756c 7473 2074 6f20 6022 3c73 3e22  faults to `"<s>"
+000010a0: 6029 3a0a 2020 2020 2020 2020 2020 2020  `):.            
+000010b0: 5468 6520 6265 6769 6e6e 696e 6720 6f66  The beginning of
+000010c0: 2073 6571 7565 6e63 6520 746f 6b65 6e20   sequence token 
+000010d0: 7468 6174 2077 6173 2075 7365 6420 6475  that was used du
+000010e0: 7269 6e67 2070 7265 7472 6169 6e69 6e67  ring pretraining
+000010f0: 2e20 4361 6e20 6265 2075 7365 6420 6120  . Can be used a 
+00001100: 7365 7175 656e 6365 2063 6c61 7373 6966  sequence classif
+00001110: 6965 7220 746f 6b65 6e2e 0a0a 2020 2020  ier token...    
+00001120: 2020 2020 2020 2020 3c54 6970 3e0a 0a20          <Tip>.. 
+00001130: 2020 2020 2020 2020 2020 2057 6865 6e20             When 
+00001140: 6275 696c 6469 6e67 2061 2073 6571 7565  building a seque
+00001150: 6e63 6520 7573 696e 6720 7370 6563 6961  nce using specia
+00001160: 6c20 746f 6b65 6e73 2c20 7468 6973 2069  l tokens, this i
+00001170: 7320 6e6f 7420 7468 6520 746f 6b65 6e20  s not the token 
+00001180: 7468 6174 2069 7320 7573 6564 2066 6f72  that is used for
+00001190: 2074 6865 2062 6567 696e 6e69 6e67 206f   the beginning o
+000011a0: 660a 2020 2020 2020 2020 2020 2020 7365  f.            se
+000011b0: 7175 656e 6365 2e20 5468 6520 746f 6b65  quence. The toke
+000011c0: 6e20 7573 6564 2069 7320 7468 6520 6063  n used is the `c
+000011d0: 6c73 5f74 6f6b 656e 602e 0a0a 2020 2020  ls_token`...    
+000011e0: 2020 2020 2020 2020 3c2f 5469 703e 0a0a          </Tip>..
+000011f0: 2020 2020 2020 2020 656f 735f 746f 6b65          eos_toke
+00001200: 6e20 2860 7374 7260 2c20 2a6f 7074 696f  n (`str`, *optio
+00001210: 6e61 6c2a 2c20 6465 6661 756c 7473 2074  nal*, defaults t
+00001220: 6f20 6022 3c2f 733e 2260 293a 0a20 2020  o `"</s>"`):.   
+00001230: 2020 2020 2020 2020 2054 6865 2065 6e64           The end
+00001240: 206f 6620 7365 7175 656e 6365 2074 6f6b   of sequence tok
+00001250: 656e 2e0a 0a20 2020 2020 2020 2020 2020  en...           
+00001260: 203c 5469 703e 0a0a 2020 2020 2020 2020   <Tip>..        
+00001270: 2020 2020 5768 656e 2062 7569 6c64 696e      When buildin
+00001280: 6720 6120 7365 7175 656e 6365 2075 7369  g a sequence usi
+00001290: 6e67 2073 7065 6369 616c 2074 6f6b 656e  ng special token
+000012a0: 732c 2074 6869 7320 6973 206e 6f74 2074  s, this is not t
+000012b0: 6865 2074 6f6b 656e 2074 6861 7420 6973  he token that is
+000012c0: 2075 7365 6420 666f 7220 7468 6520 656e   used for the en
+000012d0: 6420 6f66 2073 6571 7565 6e63 652e 0a20  d of sequence.. 
+000012e0: 2020 2020 2020 2020 2020 2054 6865 2074             The t
+000012f0: 6f6b 656e 2075 7365 6420 6973 2074 6865  oken used is the
+00001300: 2060 7365 705f 746f 6b65 6e60 2e0a 0a20   `sep_token`... 
+00001310: 2020 2020 2020 2020 2020 203c 2f54 6970             </Tip
+00001320: 3e0a 0a20 2020 2020 2020 2073 6570 5f74  >..        sep_t
+00001330: 6f6b 656e 2028 6073 7472 602c 202a 6f70  oken (`str`, *op
+00001340: 7469 6f6e 616c 2a2c 2064 6566 6175 6c74  tional*, default
+00001350: 7320 746f 2060 223c 2f73 3e22 6029 3a0a  s to `"</s>"`):.
+00001360: 2020 2020 2020 2020 2020 2020 5468 6520              The 
+00001370: 7365 7061 7261 746f 7220 746f 6b65 6e2c  separator token,
+00001380: 2077 6869 6368 2069 7320 7573 6564 2077   which is used w
+00001390: 6865 6e20 6275 696c 6469 6e67 2061 2073  hen building a s
+000013a0: 6571 7565 6e63 6520 6672 6f6d 206d 756c  equence from mul
+000013b0: 7469 706c 6520 7365 7175 656e 6365 732c  tiple sequences,
+000013c0: 2065 2e67 2e20 7477 6f20 7365 7175 656e   e.g. two sequen
+000013d0: 6365 7320 666f 720a 2020 2020 2020 2020  ces for.        
+000013e0: 2020 2020 7365 7175 656e 6365 2063 6c61      sequence cla
+000013f0: 7373 6966 6963 6174 696f 6e20 6f72 2066  ssification or f
+00001400: 6f72 2061 2074 6578 7420 616e 6420 6120  or a text and a 
+00001410: 7175 6573 7469 6f6e 2066 6f72 2071 7565  question for que
+00001420: 7374 696f 6e20 616e 7377 6572 696e 672e  stion answering.
+00001430: 2049 7420 6973 2061 6c73 6f20 7573 6564   It is also used
+00001440: 2061 7320 7468 6520 6c61 7374 0a20 2020   as the last.   
+00001450: 2020 2020 2020 2020 2074 6f6b 656e 206f           token o
+00001460: 6620 6120 7365 7175 656e 6365 2062 7569  f a sequence bui
+00001470: 6c74 2077 6974 6820 7370 6563 6961 6c20  lt with special 
+00001480: 746f 6b65 6e73 2e0a 2020 2020 2020 2020  tokens..        
+00001490: 636c 735f 746f 6b65 6e20 2860 7374 7260  cls_token (`str`
+000014a0: 2c20 2a6f 7074 696f 6e61 6c2a 2c20 6465  , *optional*, de
+000014b0: 6661 756c 7473 2074 6f20 6022 3c73 3e22  faults to `"<s>"
+000014c0: 6029 3a0a 2020 2020 2020 2020 2020 2020  `):.            
+000014d0: 5468 6520 636c 6173 7369 6669 6572 2074  The classifier t
+000014e0: 6f6b 656e 2077 6869 6368 2069 7320 7573  oken which is us
+000014f0: 6564 2077 6865 6e20 646f 696e 6720 7365  ed when doing se
+00001500: 7175 656e 6365 2063 6c61 7373 6966 6963  quence classific
+00001510: 6174 696f 6e20 2863 6c61 7373 6966 6963  ation (classific
+00001520: 6174 696f 6e20 6f66 2074 6865 2077 686f  ation of the who
+00001530: 6c65 2073 6571 7565 6e63 650a 2020 2020  le sequence.    
+00001540: 2020 2020 2020 2020 696e 7374 6561 6420          instead 
+00001550: 6f66 2070 6572 2d74 6f6b 656e 2063 6c61  of per-token cla
+00001560: 7373 6966 6963 6174 696f 6e29 2e20 4974  ssification). It
+00001570: 2069 7320 7468 6520 6669 7273 7420 746f   is the first to
+00001580: 6b65 6e20 6f66 2074 6865 2073 6571 7565  ken of the seque
+00001590: 6e63 6520 7768 656e 2062 7569 6c74 2077  nce when built w
+000015a0: 6974 6820 7370 6563 6961 6c20 746f 6b65  ith special toke
+000015b0: 6e73 2e0a 2020 2020 2020 2020 756e 6b5f  ns..        unk_
+000015c0: 746f 6b65 6e20 2860 7374 7260 2c20 2a6f  token (`str`, *o
+000015d0: 7074 696f 6e61 6c2a 2c20 6465 6661 756c  ptional*, defaul
+000015e0: 7473 2074 6f20 6022 3c75 6e6b 3e22 6029  ts to `"<unk>"`)
+000015f0: 3a0a 2020 2020 2020 2020 2020 2020 5468  :.            Th
+00001600: 6520 756e 6b6e 6f77 6e20 746f 6b65 6e2e  e unknown token.
+00001610: 2041 2074 6f6b 656e 2074 6861 7420 6973   A token that is
+00001620: 206e 6f74 2069 6e20 7468 6520 766f 6361   not in the voca
+00001630: 6275 6c61 7279 2063 616e 6e6f 7420 6265  bulary cannot be
+00001640: 2063 6f6e 7665 7274 6564 2074 6f20 616e   converted to an
+00001650: 2049 4420 616e 6420 6973 2073 6574 2074   ID and is set t
+00001660: 6f20 6265 2074 6869 730a 2020 2020 2020  o be this.      
+00001670: 2020 2020 2020 746f 6b65 6e20 696e 7374        token inst
+00001680: 6561 642e 0a20 2020 2020 2020 2070 6164  ead..        pad
+00001690: 5f74 6f6b 656e 2028 6073 7472 602c 202a  _token (`str`, *
+000016a0: 6f70 7469 6f6e 616c 2a2c 2064 6566 6175  optional*, defau
+000016b0: 6c74 7320 746f 2060 223c 7061 643e 2260  lts to `"<pad>"`
+000016c0: 293a 0a20 2020 2020 2020 2020 2020 2054  ):.            T
+000016d0: 6865 2074 6f6b 656e 2075 7365 6420 666f  he token used fo
+000016e0: 7220 7061 6464 696e 672c 2066 6f72 2065  r padding, for e
+000016f0: 7861 6d70 6c65 2077 6865 6e20 6261 7463  xample when batc
+00001700: 6869 6e67 2073 6571 7565 6e63 6573 206f  hing sequences o
+00001710: 6620 6469 6666 6572 656e 7420 6c65 6e67  f different leng
+00001720: 7468 732e 0a20 2020 2020 2020 206d 6173  ths..        mas
+00001730: 6b5f 746f 6b65 6e20 2860 7374 7260 2c20  k_token (`str`, 
+00001740: 2a6f 7074 696f 6e61 6c2a 2c20 6465 6661  *optional*, defa
+00001750: 756c 7473 2074 6f20 6022 3c6d 6173 6b3e  ults to `"<mask>
+00001760: 2260 293a 0a20 2020 2020 2020 2020 2020  "`):.           
+00001770: 2054 6865 2074 6f6b 656e 2075 7365 6420   The token used 
+00001780: 666f 7220 6d61 736b 696e 6720 7661 6c75  for masking valu
+00001790: 6573 2e20 5468 6973 2069 7320 7468 6520  es. This is the 
+000017a0: 746f 6b65 6e20 7573 6564 2077 6865 6e20  token used when 
+000017b0: 7472 6169 6e69 6e67 2074 6869 7320 6d6f  training this mo
+000017c0: 6465 6c20 7769 7468 206d 6173 6b65 6420  del with masked 
+000017d0: 6c61 6e67 7561 6765 0a20 2020 2020 2020  language.       
+000017e0: 2020 2020 206d 6f64 656c 696e 672e 2054       modeling. T
+000017f0: 6869 7320 6973 2074 6865 2074 6f6b 656e  his is the token
+00001800: 2077 6869 6368 2074 6865 206d 6f64 656c   which the model
+00001810: 2077 696c 6c20 7472 7920 746f 2070 7265   will try to pre
+00001820: 6469 6374 2e0a 2020 2020 2020 2020 6164  dict..        ad
+00001830: 645f 7072 6566 6978 5f73 7061 6365 2028  d_prefix_space (
+00001840: 6062 6f6f 6c60 2c20 2a6f 7074 696f 6e61  `bool`, *optiona
+00001850: 6c2a 2c20 6465 6661 756c 7473 2074 6f20  l*, defaults to 
+00001860: 6046 616c 7365 6029 3a0a 2020 2020 2020  `False`):.      
+00001870: 2020 2020 2020 5768 6574 6865 7220 6f72        Whether or
+00001880: 206e 6f74 2074 6f20 6164 6420 616e 2069   not to add an i
+00001890: 6e69 7469 616c 2073 7061 6365 2074 6f20  nitial space to 
+000018a0: 7468 6520 696e 7075 742e 2054 6869 7320  the input. This 
+000018b0: 616c 6c6f 7773 2074 6f20 7472 6561 7420  allows to treat 
+000018c0: 7468 6520 6c65 6164 696e 6720 776f 7264  the leading word
+000018d0: 206a 7573 7420 6173 2061 6e79 0a20 2020   just as any.   
+000018e0: 2020 2020 2020 2020 206f 7468 6572 2077           other w
+000018f0: 6f72 642e 2028 426c 656e 6465 7262 6f74  ord. (Blenderbot
+00001900: 2074 6f6b 656e 697a 6572 2064 6574 6563   tokenizer detec
+00001910: 7420 6265 6769 6e6e 696e 6720 6f66 2077  t beginning of w
+00001920: 6f72 6473 2062 7920 7468 6520 7072 6563  ords by the prec
+00001930: 6564 696e 6720 7370 6163 6529 2e0a 2020  eding space)..  
+00001940: 2020 2222 220a 0a20 2020 2076 6f63 6162    """..    vocab
+00001950: 5f66 696c 6573 5f6e 616d 6573 203d 2056  _files_names = V
+00001960: 4f43 4142 5f46 494c 4553 5f4e 414d 4553  OCAB_FILES_NAMES
+00001970: 0a20 2020 206d 6f64 656c 5f69 6e70 7574  .    model_input
+00001980: 5f6e 616d 6573 203d 205b 2269 6e70 7574  _names = ["input
+00001990: 5f69 6473 222c 2022 6174 7465 6e74 696f  _ids", "attentio
+000019a0: 6e5f 6d61 736b 225d 0a0a 2020 2020 2320  n_mask"]..    # 
+000019b0: 436f 7069 6564 2066 726f 6d20 7472 616e  Copied from tran
+000019c0: 7366 6f72 6d65 7273 2e6d 6f64 656c 732e  sformers.models.
+000019d0: 726f 6265 7274 612e 746f 6b65 6e69 7a61  roberta.tokeniza
+000019e0: 7469 6f6e 5f72 6f62 6572 7461 2e52 6f62  tion_roberta.Rob
+000019f0: 6572 7461 546f 6b65 6e69 7a65 722e 5f5f  ertaTokenizer.__
+00001a00: 696e 6974 5f5f 2077 6974 6820 526f 6265  init__ with Robe
+00001a10: 7274 612d 3e42 6c65 6e64 6572 626f 742c  rta->Blenderbot,
+00001a20: 2052 6f42 4552 5461 2d3e 426c 656e 6465   RoBERTa->Blende
+00001a30: 7262 6f74 0a20 2020 2064 6566 205f 5f69  rbot.    def __i
+00001a40: 6e69 745f 5f28 0a20 2020 2020 2020 2073  nit__(.        s
+00001a50: 656c 662c 0a20 2020 2020 2020 2076 6f63  elf,.        voc
+00001a60: 6162 5f66 696c 652c 0a20 2020 2020 2020  ab_file,.       
+00001a70: 206d 6572 6765 735f 6669 6c65 2c0a 2020   merges_file,.  
+00001a80: 2020 2020 2020 6572 726f 7273 3d22 7265        errors="re
+00001a90: 706c 6163 6522 2c0a 2020 2020 2020 2020  place",.        
+00001aa0: 626f 735f 746f 6b65 6e3d 223c 733e 222c  bos_token="<s>",
+00001ab0: 0a20 2020 2020 2020 2065 6f73 5f74 6f6b  .        eos_tok
+00001ac0: 656e 3d22 3c2f 733e 222c 0a20 2020 2020  en="</s>",.     
+00001ad0: 2020 2073 6570 5f74 6f6b 656e 3d22 3c2f     sep_token="</
+00001ae0: 733e 222c 0a20 2020 2020 2020 2063 6c73  s>",.        cls
+00001af0: 5f74 6f6b 656e 3d22 3c73 3e22 2c0a 2020  _token="<s>",.  
+00001b00: 2020 2020 2020 756e 6b5f 746f 6b65 6e3d        unk_token=
+00001b10: 223c 756e 6b3e 222c 0a20 2020 2020 2020  "<unk>",.       
+00001b20: 2070 6164 5f74 6f6b 656e 3d22 3c70 6164   pad_token="<pad
+00001b30: 3e22 2c0a 2020 2020 2020 2020 6d61 736b  >",.        mask
+00001b40: 5f74 6f6b 656e 3d22 3c6d 6173 6b3e 222c  _token="<mask>",
+00001b50: 0a20 2020 2020 2020 2061 6464 5f70 7265  .        add_pre
+00001b60: 6669 785f 7370 6163 653d 4661 6c73 652c  fix_space=False,
+00001b70: 0a20 2020 2020 2020 202a 2a6b 7761 7267  .        **kwarg
+00001b80: 732c 0a20 2020 2029 3a0a 2020 2020 2020  s,.    ):.      
+00001b90: 2020 626f 735f 746f 6b65 6e20 3d20 4164    bos_token = Ad
+00001ba0: 6465 6454 6f6b 656e 2862 6f73 5f74 6f6b  dedToken(bos_tok
+00001bb0: 656e 2c20 6c73 7472 6970 3d46 616c 7365  en, lstrip=False
+00001bc0: 2c20 7273 7472 6970 3d46 616c 7365 2920  , rstrip=False) 
+00001bd0: 6966 2069 7369 6e73 7461 6e63 6528 626f  if isinstance(bo
+00001be0: 735f 746f 6b65 6e2c 2073 7472 2920 656c  s_token, str) el
+00001bf0: 7365 2062 6f73 5f74 6f6b 656e 0a20 2020  se bos_token.   
+00001c00: 2020 2020 2070 6164 5f74 6f6b 656e 203d       pad_token =
+00001c10: 2041 6464 6564 546f 6b65 6e28 7061 645f   AddedToken(pad_
+00001c20: 746f 6b65 6e2c 206c 7374 7269 703d 4661  token, lstrip=Fa
+00001c30: 6c73 652c 2072 7374 7269 703d 4661 6c73  lse, rstrip=Fals
+00001c40: 6529 2069 6620 6973 696e 7374 616e 6365  e) if isinstance
+00001c50: 2870 6164 5f74 6f6b 656e 2c20 7374 7229  (pad_token, str)
+00001c60: 2065 6c73 6520 7061 645f 746f 6b65 6e0a   else pad_token.
+00001c70: 2020 2020 2020 2020 656f 735f 746f 6b65          eos_toke
+00001c80: 6e20 3d20 4164 6465 6454 6f6b 656e 2865  n = AddedToken(e
+00001c90: 6f73 5f74 6f6b 656e 2c20 6c73 7472 6970  os_token, lstrip
+00001ca0: 3d46 616c 7365 2c20 7273 7472 6970 3d46  =False, rstrip=F
+00001cb0: 616c 7365 2920 6966 2069 7369 6e73 7461  alse) if isinsta
+00001cc0: 6e63 6528 656f 735f 746f 6b65 6e2c 2073  nce(eos_token, s
+00001cd0: 7472 2920 656c 7365 2065 6f73 5f74 6f6b  tr) else eos_tok
+00001ce0: 656e 0a20 2020 2020 2020 2075 6e6b 5f74  en.        unk_t
+00001cf0: 6f6b 656e 203d 2041 6464 6564 546f 6b65  oken = AddedToke
+00001d00: 6e28 756e 6b5f 746f 6b65 6e2c 206c 7374  n(unk_token, lst
+00001d10: 7269 703d 4661 6c73 652c 2072 7374 7269  rip=False, rstri
+00001d20: 703d 4661 6c73 6529 2069 6620 6973 696e  p=False) if isin
+00001d30: 7374 616e 6365 2875 6e6b 5f74 6f6b 656e  stance(unk_token
+00001d40: 2c20 7374 7229 2065 6c73 6520 756e 6b5f  , str) else unk_
+00001d50: 746f 6b65 6e0a 2020 2020 2020 2020 7365  token.        se
+00001d60: 705f 746f 6b65 6e20 3d20 4164 6465 6454  p_token = AddedT
+00001d70: 6f6b 656e 2873 6570 5f74 6f6b 656e 2c20  oken(sep_token, 
+00001d80: 6c73 7472 6970 3d46 616c 7365 2c20 7273  lstrip=False, rs
+00001d90: 7472 6970 3d46 616c 7365 2920 6966 2069  trip=False) if i
+00001da0: 7369 6e73 7461 6e63 6528 7365 705f 746f  sinstance(sep_to
+00001db0: 6b65 6e2c 2073 7472 2920 656c 7365 2073  ken, str) else s
+00001dc0: 6570 5f74 6f6b 656e 0a20 2020 2020 2020  ep_token.       
+00001dd0: 2063 6c73 5f74 6f6b 656e 203d 2041 6464   cls_token = Add
+00001de0: 6564 546f 6b65 6e28 636c 735f 746f 6b65  edToken(cls_toke
+00001df0: 6e2c 206c 7374 7269 703d 4661 6c73 652c  n, lstrip=False,
+00001e00: 2072 7374 7269 703d 4661 6c73 6529 2069   rstrip=False) i
+00001e10: 6620 6973 696e 7374 616e 6365 2863 6c73  f isinstance(cls
+00001e20: 5f74 6f6b 656e 2c20 7374 7229 2065 6c73  _token, str) els
+00001e30: 6520 636c 735f 746f 6b65 6e0a 0a20 2020  e cls_token..   
+00001e40: 2020 2020 2023 204d 6173 6b20 746f 6b65       # Mask toke
+00001e50: 6e20 6265 6861 7665 206c 696b 6520 6120  n behave like a 
+00001e60: 6e6f 726d 616c 2077 6f72 642c 2069 2e65  normal word, i.e
+00001e70: 2e20 696e 636c 7564 6520 7468 6520 7370  . include the sp
+00001e80: 6163 6520 6265 666f 7265 2069 740a 2020  ace before it.  
+00001e90: 2020 2020 2020 6d61 736b 5f74 6f6b 656e        mask_token
+00001ea0: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+00001eb0: 2041 6464 6564 546f 6b65 6e28 6d61 736b   AddedToken(mask
+00001ec0: 5f74 6f6b 656e 2c20 6c73 7472 6970 3d54  _token, lstrip=T
+00001ed0: 7275 652c 2072 7374 7269 703d 4661 6c73  rue, rstrip=Fals
+00001ee0: 652c 206e 6f72 6d61 6c69 7a65 643d 4661  e, normalized=Fa
+00001ef0: 6c73 6529 0a20 2020 2020 2020 2020 2020  lse).           
+00001f00: 2069 6620 6973 696e 7374 616e 6365 286d   if isinstance(m
+00001f10: 6173 6b5f 746f 6b65 6e2c 2073 7472 290a  ask_token, str).
+00001f20: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00001f30: 206d 6173 6b5f 746f 6b65 6e0a 2020 2020   mask_token.    
+00001f40: 2020 2020 290a 0a20 2020 2020 2020 2023      )..        #
+00001f50: 2074 6865 7365 2073 7065 6369 616c 2074   these special t
+00001f60: 6f6b 656e 7320 6172 6520 6e6f 7420 7061  okens are not pa
+00001f70: 7274 206f 6620 7468 6520 766f 6361 622e  rt of the vocab.
+00001f80: 6a73 6f6e 2c20 6c65 7427 7320 6164 6420  json, let's add 
+00001f90: 7468 656d 2069 6e20 7468 6520 636f 7272  them in the corr
+00001fa0: 6563 7420 6f72 6465 720a 0a20 2020 2020  ect order..     
+00001fb0: 2020 2077 6974 6820 6f70 656e 2876 6f63     with open(voc
+00001fc0: 6162 5f66 696c 652c 2065 6e63 6f64 696e  ab_file, encodin
+00001fd0: 673d 2275 7466 2d38 2229 2061 7320 766f  g="utf-8") as vo
+00001fe0: 6361 625f 6861 6e64 6c65 3a0a 2020 2020  cab_handle:.    
+00001ff0: 2020 2020 2020 2020 7365 6c66 2e65 6e63          self.enc
+00002000: 6f64 6572 203d 206a 736f 6e2e 6c6f 6164  oder = json.load
+00002010: 2876 6f63 6162 5f68 616e 646c 6529 0a20  (vocab_handle). 
+00002020: 2020 2020 2020 2073 656c 662e 6465 636f         self.deco
+00002030: 6465 7220 3d20 7b76 3a20 6b20 666f 7220  der = {v: k for 
+00002040: 6b2c 2076 2069 6e20 7365 6c66 2e65 6e63  k, v in self.enc
+00002050: 6f64 6572 2e69 7465 6d73 2829 7d0a 2020  oder.items()}.  
+00002060: 2020 2020 2020 7365 6c66 2e65 7272 6f72        self.error
+00002070: 7320 3d20 6572 726f 7273 2020 2320 686f  s = errors  # ho
+00002080: 7720 746f 2068 616e 646c 6520 6572 726f  w to handle erro
+00002090: 7273 2069 6e20 6465 636f 6469 6e67 0a20  rs in decoding. 
+000020a0: 2020 2020 2020 2073 656c 662e 6279 7465         self.byte
+000020b0: 5f65 6e63 6f64 6572 203d 2062 7974 6573  _encoder = bytes
+000020c0: 5f74 6f5f 756e 6963 6f64 6528 290a 2020  _to_unicode().  
+000020d0: 2020 2020 2020 7365 6c66 2e62 7974 655f        self.byte_
+000020e0: 6465 636f 6465 7220 3d20 7b76 3a20 6b20  decoder = {v: k 
+000020f0: 666f 7220 6b2c 2076 2069 6e20 7365 6c66  for k, v in self
+00002100: 2e62 7974 655f 656e 636f 6465 722e 6974  .byte_encoder.it
+00002110: 656d 7328 297d 0a20 2020 2020 2020 2077  ems()}.        w
+00002120: 6974 6820 6f70 656e 286d 6572 6765 735f  ith open(merges_
+00002130: 6669 6c65 2c20 656e 636f 6469 6e67 3d22  file, encoding="
+00002140: 7574 662d 3822 2920 6173 206d 6572 6765  utf-8") as merge
+00002150: 735f 6861 6e64 6c65 3a0a 2020 2020 2020  s_handle:.      
+00002160: 2020 2020 2020 6270 655f 6d65 7267 6573        bpe_merges
+00002170: 203d 206d 6572 6765 735f 6861 6e64 6c65   = merges_handle
+00002180: 2e72 6561 6428 292e 7370 6c69 7428 225c  .read().split("\
+00002190: 6e22 295b 313a 2d31 5d0a 2020 2020 2020  n")[1:-1].      
+000021a0: 2020 6270 655f 6d65 7267 6573 203d 205b    bpe_merges = [
+000021b0: 7475 706c 6528 6d65 7267 652e 7370 6c69  tuple(merge.spli
+000021c0: 7428 2929 2066 6f72 206d 6572 6765 2069  t()) for merge i
+000021d0: 6e20 6270 655f 6d65 7267 6573 5d0a 2020  n bpe_merges].  
+000021e0: 2020 2020 2020 7365 6c66 2e62 7065 5f72        self.bpe_r
+000021f0: 616e 6b73 203d 2064 6963 7428 7a69 7028  anks = dict(zip(
+00002200: 6270 655f 6d65 7267 6573 2c20 7261 6e67  bpe_merges, rang
+00002210: 6528 6c65 6e28 6270 655f 6d65 7267 6573  e(len(bpe_merges
+00002220: 2929 2929 0a20 2020 2020 2020 2073 656c  )))).        sel
+00002230: 662e 6361 6368 6520 3d20 7b7d 0a20 2020  f.cache = {}.   
+00002240: 2020 2020 2073 656c 662e 6164 645f 7072       self.add_pr
+00002250: 6566 6978 5f73 7061 6365 203d 2061 6464  efix_space = add
+00002260: 5f70 7265 6669 785f 7370 6163 650a 0a20  _prefix_space.. 
+00002270: 2020 2020 2020 2023 2053 686f 756c 6420         # Should 
+00002280: 6861 7665 2061 6464 6564 2072 652e 4947  have added re.IG
+00002290: 4e4f 5245 4341 5345 2073 6f20 4250 4520  NORECASE so BPE 
+000022a0: 6d65 7267 6573 2063 616e 2068 6170 7065  merges can happe
+000022b0: 6e20 666f 7220 6361 7069 7461 6c69 7a65  n for capitalize
+000022c0: 6420 7665 7273 696f 6e73 206f 6620 636f  d versions of co
+000022d0: 6e74 7261 6374 696f 6e73 0a20 2020 2020  ntractions.     
+000022e0: 2020 2073 656c 662e 7061 7420 3d20 7265     self.pat = re
+000022f0: 2e63 6f6d 7069 6c65 2872 2222 2227 737c  .compile(r"""'s|
+00002300: 2774 7c27 7265 7c27 7665 7c27 6d7c 276c  't|'re|'ve|'m|'l
+00002310: 6c7c 2764 7c20 3f5c 707b 4c7d 2b7c 203f  l|'d| ?\p{L}+| ?
+00002320: 5c70 7b4e 7d2b 7c20 3f5b 5e5c 735c 707b  \p{N}+| ?[^\s\p{
+00002330: 4c7d 5c70 7b4e 7d5d 2b7c 5c73 2b28 3f21  L}\p{N}]+|\s+(?!
+00002340: 5c53 297c 5c73 2b22 2222 290a 0a20 2020  \S)|\s+""")..   
+00002350: 2020 2020 2073 7570 6572 2829 2e5f 5f69       super().__i
+00002360: 6e69 745f 5f28 0a20 2020 2020 2020 2020  nit__(.         
+00002370: 2020 2065 7272 6f72 733d 6572 726f 7273     errors=errors
+00002380: 2c0a 2020 2020 2020 2020 2020 2020 626f  ,.            bo
+00002390: 735f 746f 6b65 6e3d 626f 735f 746f 6b65  s_token=bos_toke
+000023a0: 6e2c 0a20 2020 2020 2020 2020 2020 2065  n,.            e
+000023b0: 6f73 5f74 6f6b 656e 3d65 6f73 5f74 6f6b  os_token=eos_tok
+000023c0: 656e 2c0a 2020 2020 2020 2020 2020 2020  en,.            
+000023d0: 756e 6b5f 746f 6b65 6e3d 756e 6b5f 746f  unk_token=unk_to
+000023e0: 6b65 6e2c 0a20 2020 2020 2020 2020 2020  ken,.           
+000023f0: 2073 6570 5f74 6f6b 656e 3d73 6570 5f74   sep_token=sep_t
+00002400: 6f6b 656e 2c0a 2020 2020 2020 2020 2020  oken,.          
+00002410: 2020 636c 735f 746f 6b65 6e3d 636c 735f    cls_token=cls_
+00002420: 746f 6b65 6e2c 0a20 2020 2020 2020 2020  token,.         
+00002430: 2020 2070 6164 5f74 6f6b 656e 3d70 6164     pad_token=pad
+00002440: 5f74 6f6b 656e 2c0a 2020 2020 2020 2020  _token,.        
+00002450: 2020 2020 6d61 736b 5f74 6f6b 656e 3d6d      mask_token=m
+00002460: 6173 6b5f 746f 6b65 6e2c 0a20 2020 2020  ask_token,.     
+00002470: 2020 2020 2020 2061 6464 5f70 7265 6669         add_prefi
+00002480: 785f 7370 6163 653d 6164 645f 7072 6566  x_space=add_pref
+00002490: 6978 5f73 7061 6365 2c0a 2020 2020 2020  ix_space,.      
+000024a0: 2020 2020 2020 2a2a 6b77 6172 6773 2c0a        **kwargs,.
+000024b0: 2020 2020 2020 2020 290a 0a20 2020 2040          )..    @
+000024c0: 7072 6f70 6572 7479 0a20 2020 2023 2043  property.    # C
+000024d0: 6f70 6965 6420 6672 6f6d 2074 7261 6e73  opied from trans
+000024e0: 666f 726d 6572 732e 6d6f 6465 6c73 2e72  formers.models.r
+000024f0: 6f62 6572 7461 2e74 6f6b 656e 697a 6174  oberta.tokenizat
+00002500: 696f 6e5f 726f 6265 7274 612e 526f 6265  ion_roberta.Robe
+00002510: 7274 6154 6f6b 656e 697a 6572 2e76 6f63  rtaTokenizer.voc
+00002520: 6162 5f73 697a 6520 7769 7468 2052 6f62  ab_size with Rob
+00002530: 6572 7461 2d3e 426c 656e 6465 7262 6f74  erta->Blenderbot
+00002540: 2c20 526f 4245 5254 612d 3e42 6c65 6e64  , RoBERTa->Blend
+00002550: 6572 626f 740a 2020 2020 6465 6620 766f  erbot.    def vo
+00002560: 6361 625f 7369 7a65 2873 656c 6629 3a0a  cab_size(self):.
+00002570: 2020 2020 2020 2020 7265 7475 726e 206c          return l
+00002580: 656e 2873 656c 662e 656e 636f 6465 7229  en(self.encoder)
+00002590: 0a0a 2020 2020 2320 436f 7069 6564 2066  ..    # Copied f
+000025a0: 726f 6d20 7472 616e 7366 6f72 6d65 7273  rom transformers
+000025b0: 2e6d 6f64 656c 732e 726f 6265 7274 612e  .models.roberta.
+000025c0: 746f 6b65 6e69 7a61 7469 6f6e 5f72 6f62  tokenization_rob
+000025d0: 6572 7461 2e52 6f62 6572 7461 546f 6b65  erta.RobertaToke
+000025e0: 6e69 7a65 722e 6765 745f 766f 6361 6220  nizer.get_vocab 
+000025f0: 7769 7468 2052 6f62 6572 7461 2d3e 426c  with Roberta->Bl
+00002600: 656e 6465 7262 6f74 2c20 526f 4245 5254  enderbot, RoBERT
+00002610: 612d 3e42 6c65 6e64 6572 626f 740a 2020  a->Blenderbot.  
+00002620: 2020 6465 6620 6765 745f 766f 6361 6228    def get_vocab(
+00002630: 7365 6c66 293a 0a20 2020 2020 2020 2076  self):.        v
+00002640: 6f63 6162 203d 2064 6963 7428 7365 6c66  ocab = dict(self
+00002650: 2e65 6e63 6f64 6572 292e 636f 7079 2829  .encoder).copy()
+00002660: 0a20 2020 2020 2020 2076 6f63 6162 2e75  .        vocab.u
+00002670: 7064 6174 6528 7365 6c66 2e61 6464 6564  pdate(self.added
+00002680: 5f74 6f6b 656e 735f 656e 636f 6465 7229  _tokens_encoder)
+00002690: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000026a0: 766f 6361 620a 0a20 2020 2023 2043 6f70  vocab..    # Cop
+000026b0: 6965 6420 6672 6f6d 2074 7261 6e73 666f  ied from transfo
+000026c0: 726d 6572 732e 6d6f 6465 6c73 2e72 6f62  rmers.models.rob
+000026d0: 6572 7461 2e74 6f6b 656e 697a 6174 696f  erta.tokenizatio
+000026e0: 6e5f 726f 6265 7274 612e 526f 6265 7274  n_roberta.Robert
+000026f0: 6154 6f6b 656e 697a 6572 2e62 7065 2077  aTokenizer.bpe w
+00002700: 6974 6820 526f 6265 7274 612d 3e42 6c65  ith Roberta->Ble
+00002710: 6e64 6572 626f 742c 2052 6f42 4552 5461  nderbot, RoBERTa
+00002720: 2d3e 426c 656e 6465 7262 6f74 0a20 2020  ->Blenderbot.   
+00002730: 2064 6566 2062 7065 2873 656c 662c 2074   def bpe(self, t
+00002740: 6f6b 656e 293a 0a20 2020 2020 2020 2069  oken):.        i
+00002750: 6620 746f 6b65 6e20 696e 2073 656c 662e  f token in self.
+00002760: 6361 6368 653a 0a20 2020 2020 2020 2020  cache:.         
+00002770: 2020 2072 6574 7572 6e20 7365 6c66 2e63     return self.c
+00002780: 6163 6865 5b74 6f6b 656e 5d0a 2020 2020  ache[token].    
+00002790: 2020 2020 776f 7264 203d 2074 7570 6c65      word = tuple
+000027a0: 2874 6f6b 656e 290a 2020 2020 2020 2020  (token).        
+000027b0: 7061 6972 7320 3d20 6765 745f 7061 6972  pairs = get_pair
+000027c0: 7328 776f 7264 290a 0a20 2020 2020 2020  s(word)..       
+000027d0: 2069 6620 6e6f 7420 7061 6972 733a 0a20   if not pairs:. 
+000027e0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+000027f0: 6e20 746f 6b65 6e0a 0a20 2020 2020 2020  n token..       
+00002800: 2077 6869 6c65 2054 7275 653a 0a20 2020   while True:.   
+00002810: 2020 2020 2020 2020 2062 6967 7261 6d20           bigram 
+00002820: 3d20 6d69 6e28 7061 6972 732c 206b 6579  = min(pairs, key
+00002830: 3d6c 616d 6264 6120 7061 6972 3a20 7365  =lambda pair: se
+00002840: 6c66 2e62 7065 5f72 616e 6b73 2e67 6574  lf.bpe_ranks.get
+00002850: 2870 6169 722c 2066 6c6f 6174 2822 696e  (pair, float("in
+00002860: 6622 2929 290a 2020 2020 2020 2020 2020  f"))).          
+00002870: 2020 6966 2062 6967 7261 6d20 6e6f 7420    if bigram not 
+00002880: 696e 2073 656c 662e 6270 655f 7261 6e6b  in self.bpe_rank
+00002890: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+000028a0: 2020 2062 7265 616b 0a20 2020 2020 2020     break.       
+000028b0: 2020 2020 2066 6972 7374 2c20 7365 636f       first, seco
+000028c0: 6e64 203d 2062 6967 7261 6d0a 2020 2020  nd = bigram.    
+000028d0: 2020 2020 2020 2020 6e65 775f 776f 7264          new_word
+000028e0: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
+000028f0: 2020 6920 3d20 300a 2020 2020 2020 2020    i = 0.        
+00002900: 2020 2020 7768 696c 6520 6920 3c20 6c65      while i < le
+00002910: 6e28 776f 7264 293a 0a20 2020 2020 2020  n(word):.       
+00002920: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+00002930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002940: 2020 6a20 3d20 776f 7264 2e69 6e64 6578    j = word.index
+00002950: 2866 6972 7374 2c20 6929 0a20 2020 2020  (first, i).     
+00002960: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+00002970: 7420 5661 6c75 6545 7272 6f72 3a0a 2020  t ValueError:.  
+00002980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002990: 2020 6e65 775f 776f 7264 2e65 7874 656e    new_word.exten
+000029a0: 6428 776f 7264 5b69 3a5d 290a 2020 2020  d(word[i:]).    
+000029b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000029c0: 6272 6561 6b0a 2020 2020 2020 2020 2020  break.          
+000029d0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000029e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000029f0: 6e65 775f 776f 7264 2e65 7874 656e 6428  new_word.extend(
+00002a00: 776f 7264 5b69 3a6a 5d29 0a20 2020 2020  word[i:j]).     
+00002a10: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00002a20: 203d 206a 0a0a 2020 2020 2020 2020 2020   = j..          
+00002a30: 2020 2020 2020 6966 2077 6f72 645b 695d        if word[i]
+00002a40: 203d 3d20 6669 7273 7420 616e 6420 6920   == first and i 
+00002a50: 3c20 6c65 6e28 776f 7264 2920 2d20 3120  < len(word) - 1 
+00002a60: 616e 6420 776f 7264 5b69 202b 2031 5d20  and word[i + 1] 
+00002a70: 3d3d 2073 6563 6f6e 643a 0a20 2020 2020  == second:.     
+00002a80: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00002a90: 6577 5f77 6f72 642e 6170 7065 6e64 2866  ew_word.append(f
+00002aa0: 6972 7374 202b 2073 6563 6f6e 6429 0a20  irst + second). 
+00002ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002ac0: 2020 2069 202b 3d20 320a 2020 2020 2020     i += 2.      
+00002ad0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00002ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002af0: 2020 2020 6e65 775f 776f 7264 2e61 7070      new_word.app
+00002b00: 656e 6428 776f 7264 5b69 5d29 0a20 2020  end(word[i]).   
+00002b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002b20: 2069 202b 3d20 310a 2020 2020 2020 2020   i += 1.        
+00002b30: 2020 2020 6e65 775f 776f 7264 203d 2074      new_word = t
+00002b40: 7570 6c65 286e 6577 5f77 6f72 6429 0a20  uple(new_word). 
+00002b50: 2020 2020 2020 2020 2020 2077 6f72 6420             word 
+00002b60: 3d20 6e65 775f 776f 7264 0a20 2020 2020  = new_word.     
+00002b70: 2020 2020 2020 2069 6620 6c65 6e28 776f         if len(wo
+00002b80: 7264 2920 3d3d 2031 3a0a 2020 2020 2020  rd) == 1:.      
+00002b90: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
+00002ba0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00002bb0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00002bc0: 2020 7061 6972 7320 3d20 6765 745f 7061    pairs = get_pa
+00002bd0: 6972 7328 776f 7264 290a 2020 2020 2020  irs(word).      
+00002be0: 2020 776f 7264 203d 2022 2022 2e6a 6f69    word = " ".joi
+00002bf0: 6e28 776f 7264 290a 2020 2020 2020 2020  n(word).        
+00002c00: 7365 6c66 2e63 6163 6865 5b74 6f6b 656e  self.cache[token
+00002c10: 5d20 3d20 776f 7264 0a20 2020 2020 2020  ] = word.       
+00002c20: 2072 6574 7572 6e20 776f 7264 0a0a 2020   return word..  
+00002c30: 2020 2320 436f 7069 6564 2066 726f 6d20    # Copied from 
+00002c40: 7472 616e 7366 6f72 6d65 7273 2e6d 6f64  transformers.mod
+00002c50: 656c 732e 726f 6265 7274 612e 746f 6b65  els.roberta.toke
+00002c60: 6e69 7a61 7469 6f6e 5f72 6f62 6572 7461  nization_roberta
+00002c70: 2e52 6f62 6572 7461 546f 6b65 6e69 7a65  .RobertaTokenize
+00002c80: 722e 5f74 6f6b 656e 697a 6520 7769 7468  r._tokenize with
+00002c90: 2052 6f62 6572 7461 2d3e 426c 656e 6465   Roberta->Blende
+00002ca0: 7262 6f74 2c20 526f 4245 5254 612d 3e42  rbot, RoBERTa->B
+00002cb0: 6c65 6e64 6572 626f 740a 2020 2020 6465  lenderbot.    de
+00002cc0: 6620 5f74 6f6b 656e 697a 6528 7365 6c66  f _tokenize(self
+00002cd0: 2c20 7465 7874 293a 0a20 2020 2020 2020  , text):.       
+00002ce0: 2022 2222 546f 6b65 6e69 7a65 2061 2073   """Tokenize a s
+00002cf0: 7472 696e 672e 2222 220a 2020 2020 2020  tring.""".      
+00002d00: 2020 6270 655f 746f 6b65 6e73 203d 205b    bpe_tokens = [
+00002d10: 5d0a 2020 2020 2020 2020 666f 7220 746f  ].        for to
+00002d20: 6b65 6e20 696e 2072 652e 6669 6e64 616c  ken in re.findal
+00002d30: 6c28 7365 6c66 2e70 6174 2c20 7465 7874  l(self.pat, text
+00002d40: 293a 0a20 2020 2020 2020 2020 2020 2074  ):.            t
+00002d50: 6f6b 656e 203d 2022 222e 6a6f 696e 280a  oken = "".join(.
+00002d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002d70: 7365 6c66 2e62 7974 655f 656e 636f 6465  self.byte_encode
+00002d80: 725b 625d 2066 6f72 2062 2069 6e20 746f  r[b] for b in to
+00002d90: 6b65 6e2e 656e 636f 6465 2822 7574 662d  ken.encode("utf-
+00002da0: 3822 290a 2020 2020 2020 2020 2020 2020  8").            
+00002db0: 2920 2023 204d 6170 7320 616c 6c20 6f75  )  # Maps all ou
+00002dc0: 7220 6279 7465 7320 746f 2075 6e69 636f  r bytes to unico
+00002dd0: 6465 2073 7472 696e 6773 2c20 6176 6f69  de strings, avoi
+00002de0: 6469 6e67 2063 6f6e 7472 6f6c 2074 6f6b  ding control tok
+00002df0: 656e 7320 6f66 2074 6865 2042 5045 2028  ens of the BPE (
+00002e00: 7370 6163 6573 2069 6e20 6f75 7220 6361  spaces in our ca
+00002e10: 7365 290a 2020 2020 2020 2020 2020 2020  se).            
+00002e20: 6270 655f 746f 6b65 6e73 2e65 7874 656e  bpe_tokens.exten
+00002e30: 6428 6270 655f 746f 6b65 6e20 666f 7220  d(bpe_token for 
+00002e40: 6270 655f 746f 6b65 6e20 696e 2073 656c  bpe_token in sel
+00002e50: 662e 6270 6528 746f 6b65 6e29 2e73 706c  f.bpe(token).spl
+00002e60: 6974 2822 2022 2929 0a20 2020 2020 2020  it(" ")).       
+00002e70: 2072 6574 7572 6e20 6270 655f 746f 6b65   return bpe_toke
+00002e80: 6e73 0a0a 2020 2020 2320 436f 7069 6564  ns..    # Copied
+00002e90: 2066 726f 6d20 7472 616e 7366 6f72 6d65   from transforme
+00002ea0: 7273 2e6d 6f64 656c 732e 726f 6265 7274  rs.models.robert
+00002eb0: 612e 746f 6b65 6e69 7a61 7469 6f6e 5f72  a.tokenization_r
+00002ec0: 6f62 6572 7461 2e52 6f62 6572 7461 546f  oberta.RobertaTo
+00002ed0: 6b65 6e69 7a65 722e 5f63 6f6e 7665 7274  kenizer._convert
+00002ee0: 5f74 6f6b 656e 5f74 6f5f 6964 2077 6974  _token_to_id wit
+00002ef0: 6820 526f 6265 7274 612d 3e42 6c65 6e64  h Roberta->Blend
+00002f00: 6572 626f 742c 2052 6f42 4552 5461 2d3e  erbot, RoBERTa->
+00002f10: 426c 656e 6465 7262 6f74 0a20 2020 2064  Blenderbot.    d
+00002f20: 6566 205f 636f 6e76 6572 745f 746f 6b65  ef _convert_toke
+00002f30: 6e5f 746f 5f69 6428 7365 6c66 2c20 746f  n_to_id(self, to
+00002f40: 6b65 6e29 3a0a 2020 2020 2020 2020 2222  ken):.        ""
+00002f50: 2243 6f6e 7665 7274 7320 6120 746f 6b65  "Converts a toke
+00002f60: 6e20 2873 7472 2920 696e 2061 6e20 6964  n (str) in an id
+00002f70: 2075 7369 6e67 2074 6865 2076 6f63 6162   using the vocab
+00002f80: 2e22 2222 0a20 2020 2020 2020 2072 6574  .""".        ret
+00002f90: 7572 6e20 7365 6c66 2e65 6e63 6f64 6572  urn self.encoder
+00002fa0: 2e67 6574 2874 6f6b 656e 2c20 7365 6c66  .get(token, self
+00002fb0: 2e65 6e63 6f64 6572 2e67 6574 2873 656c  .encoder.get(sel
+00002fc0: 662e 756e 6b5f 746f 6b65 6e29 290a 0a20  f.unk_token)).. 
+00002fd0: 2020 2023 2043 6f70 6965 6420 6672 6f6d     # Copied from
+00002fe0: 2074 7261 6e73 666f 726d 6572 732e 6d6f   transformers.mo
+00002ff0: 6465 6c73 2e72 6f62 6572 7461 2e74 6f6b  dels.roberta.tok
+00003000: 656e 697a 6174 696f 6e5f 726f 6265 7274  enization_robert
+00003010: 612e 526f 6265 7274 6154 6f6b 656e 697a  a.RobertaTokeniz
+00003020: 6572 2e5f 636f 6e76 6572 745f 6964 5f74  er._convert_id_t
+00003030: 6f5f 746f 6b65 6e20 7769 7468 2052 6f62  o_token with Rob
+00003040: 6572 7461 2d3e 426c 656e 6465 7262 6f74  erta->Blenderbot
+00003050: 2c20 526f 4245 5254 612d 3e42 6c65 6e64  , RoBERTa->Blend
+00003060: 6572 626f 740a 2020 2020 6465 6620 5f63  erbot.    def _c
+00003070: 6f6e 7665 7274 5f69 645f 746f 5f74 6f6b  onvert_id_to_tok
+00003080: 656e 2873 656c 662c 2069 6e64 6578 293a  en(self, index):
+00003090: 0a20 2020 2020 2020 2022 2222 436f 6e76  .        """Conv
+000030a0: 6572 7473 2061 6e20 696e 6465 7820 2869  erts an index (i
+000030b0: 6e74 6567 6572 2920 696e 2061 2074 6f6b  nteger) in a tok
+000030c0: 656e 2028 7374 7229 2075 7369 6e67 2074  en (str) using t
+000030d0: 6865 2076 6f63 6162 2e22 2222 0a20 2020  he vocab.""".   
+000030e0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+000030f0: 2e64 6563 6f64 6572 2e67 6574 2869 6e64  .decoder.get(ind
+00003100: 6578 290a 0a20 2020 2023 2043 6f70 6965  ex)..    # Copie
+00003110: 6420 6672 6f6d 2074 7261 6e73 666f 726d  d from transform
+00003120: 6572 732e 6d6f 6465 6c73 2e72 6f62 6572  ers.models.rober
+00003130: 7461 2e74 6f6b 656e 697a 6174 696f 6e5f  ta.tokenization_
+00003140: 726f 6265 7274 612e 526f 6265 7274 6154  roberta.RobertaT
+00003150: 6f6b 656e 697a 6572 2e63 6f6e 7665 7274  okenizer.convert
+00003160: 5f74 6f6b 656e 735f 746f 5f73 7472 696e  _tokens_to_strin
+00003170: 6720 7769 7468 2052 6f62 6572 7461 2d3e  g with Roberta->
+00003180: 426c 656e 6465 7262 6f74 2c20 526f 4245  Blenderbot, RoBE
+00003190: 5254 612d 3e42 6c65 6e64 6572 626f 740a  RTa->Blenderbot.
+000031a0: 2020 2020 6465 6620 636f 6e76 6572 745f      def convert_
+000031b0: 746f 6b65 6e73 5f74 6f5f 7374 7269 6e67  tokens_to_string
+000031c0: 2873 656c 662c 2074 6f6b 656e 7329 3a0a  (self, tokens):.
+000031d0: 2020 2020 2020 2020 2222 2243 6f6e 7665          """Conve
+000031e0: 7274 7320 6120 7365 7175 656e 6365 206f  rts a sequence o
+000031f0: 6620 746f 6b65 6e73 2028 7374 7269 6e67  f tokens (string
+00003200: 2920 696e 2061 2073 696e 676c 6520 7374  ) in a single st
+00003210: 7269 6e67 2e22 2222 0a20 2020 2020 2020  ring.""".       
+00003220: 2074 6578 7420 3d20 2222 2e6a 6f69 6e28   text = "".join(
+00003230: 746f 6b65 6e73 290a 2020 2020 2020 2020  tokens).        
+00003240: 7465 7874 203d 2062 7974 6561 7272 6179  text = bytearray
+00003250: 285b 7365 6c66 2e62 7974 655f 6465 636f  ([self.byte_deco
+00003260: 6465 725b 635d 2066 6f72 2063 2069 6e20  der[c] for c in 
+00003270: 7465 7874 5d29 2e64 6563 6f64 6528 2275  text]).decode("u
+00003280: 7466 2d38 222c 2065 7272 6f72 733d 7365  tf-8", errors=se
+00003290: 6c66 2e65 7272 6f72 7329 0a20 2020 2020  lf.errors).     
+000032a0: 2020 2072 6574 7572 6e20 7465 7874 0a0a     return text..
+000032b0: 2020 2020 2320 436f 7069 6564 2066 726f      # Copied fro
+000032c0: 6d20 7472 616e 7366 6f72 6d65 7273 2e6d  m transformers.m
+000032d0: 6f64 656c 732e 726f 6265 7274 612e 746f  odels.roberta.to
+000032e0: 6b65 6e69 7a61 7469 6f6e 5f72 6f62 6572  kenization_rober
+000032f0: 7461 2e52 6f62 6572 7461 546f 6b65 6e69  ta.RobertaTokeni
+00003300: 7a65 722e 7361 7665 5f76 6f63 6162 756c  zer.save_vocabul
+00003310: 6172 7920 7769 7468 2052 6f62 6572 7461  ary with Roberta
+00003320: 2d3e 426c 656e 6465 7262 6f74 2c20 526f  ->Blenderbot, Ro
+00003330: 4245 5254 612d 3e42 6c65 6e64 6572 626f  BERTa->Blenderbo
+00003340: 740a 2020 2020 6465 6620 7361 7665 5f76  t.    def save_v
+00003350: 6f63 6162 756c 6172 7928 7365 6c66 2c20  ocabulary(self, 
+00003360: 7361 7665 5f64 6972 6563 746f 7279 3a20  save_directory: 
+00003370: 7374 722c 2066 696c 656e 616d 655f 7072  str, filename_pr
+00003380: 6566 6978 3a20 4f70 7469 6f6e 616c 5b73  efix: Optional[s
+00003390: 7472 5d20 3d20 4e6f 6e65 2920 2d3e 2054  tr] = None) -> T
+000033a0: 7570 6c65 5b73 7472 5d3a 0a20 2020 2020  uple[str]:.     
+000033b0: 2020 2069 6620 6e6f 7420 6f73 2e70 6174     if not os.pat
+000033c0: 682e 6973 6469 7228 7361 7665 5f64 6972  h.isdir(save_dir
+000033d0: 6563 746f 7279 293a 0a20 2020 2020 2020  ectory):.       
+000033e0: 2020 2020 206c 6f67 6765 722e 6572 726f       logger.erro
+000033f0: 7228 6622 566f 6361 6275 6c61 7279 2070  r(f"Vocabulary p
+00003400: 6174 6820 287b 7361 7665 5f64 6972 6563  ath ({save_direc
+00003410: 746f 7279 7d29 2073 686f 756c 6420 6265  tory}) should be
+00003420: 2061 2064 6972 6563 746f 7279 2229 0a20   a directory"). 
+00003430: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00003440: 6e0a 2020 2020 2020 2020 766f 6361 625f  n.        vocab_
+00003450: 6669 6c65 203d 206f 732e 7061 7468 2e6a  file = os.path.j
+00003460: 6f69 6e28 0a20 2020 2020 2020 2020 2020  oin(.           
+00003470: 2073 6176 655f 6469 7265 6374 6f72 792c   save_directory,
+00003480: 2028 6669 6c65 6e61 6d65 5f70 7265 6669   (filename_prefi
+00003490: 7820 2b20 222d 2220 6966 2066 696c 656e  x + "-" if filen
+000034a0: 616d 655f 7072 6566 6978 2065 6c73 6520  ame_prefix else 
+000034b0: 2222 2920 2b20 564f 4341 425f 4649 4c45  "") + VOCAB_FILE
+000034c0: 535f 4e41 4d45 535b 2276 6f63 6162 5f66  S_NAMES["vocab_f
+000034d0: 696c 6522 5d0a 2020 2020 2020 2020 290a  ile"].        ).
+000034e0: 2020 2020 2020 2020 6d65 7267 655f 6669          merge_fi
+000034f0: 6c65 203d 206f 732e 7061 7468 2e6a 6f69  le = os.path.joi
+00003500: 6e28 0a20 2020 2020 2020 2020 2020 2073  n(.            s
+00003510: 6176 655f 6469 7265 6374 6f72 792c 2028  ave_directory, (
+00003520: 6669 6c65 6e61 6d65 5f70 7265 6669 7820  filename_prefix 
+00003530: 2b20 222d 2220 6966 2066 696c 656e 616d  + "-" if filenam
+00003540: 655f 7072 6566 6978 2065 6c73 6520 2222  e_prefix else ""
+00003550: 2920 2b20 564f 4341 425f 4649 4c45 535f  ) + VOCAB_FILES_
+00003560: 4e41 4d45 535b 226d 6572 6765 735f 6669  NAMES["merges_fi
+00003570: 6c65 225d 0a20 2020 2020 2020 2029 0a0a  le"].        )..
+00003580: 2020 2020 2020 2020 7769 7468 206f 7065          with ope
+00003590: 6e28 766f 6361 625f 6669 6c65 2c20 2277  n(vocab_file, "w
+000035a0: 222c 2065 6e63 6f64 696e 673d 2275 7466  ", encoding="utf
+000035b0: 2d38 2229 2061 7320 663a 0a20 2020 2020  -8") as f:.     
+000035c0: 2020 2020 2020 2066 2e77 7269 7465 286a         f.write(j
+000035d0: 736f 6e2e 6475 6d70 7328 7365 6c66 2e65  son.dumps(self.e
+000035e0: 6e63 6f64 6572 2c20 696e 6465 6e74 3d32  ncoder, indent=2
+000035f0: 2c20 736f 7274 5f6b 6579 733d 5472 7565  , sort_keys=True
+00003600: 2c20 656e 7375 7265 5f61 7363 6969 3d46  , ensure_ascii=F
+00003610: 616c 7365 2920 2b20 225c 6e22 290a 0a20  alse) + "\n").. 
+00003620: 2020 2020 2020 2069 6e64 6578 203d 2030         index = 0
+00003630: 0a20 2020 2020 2020 2077 6974 6820 6f70  .        with op
+00003640: 656e 286d 6572 6765 5f66 696c 652c 2022  en(merge_file, "
+00003650: 7722 2c20 656e 636f 6469 6e67 3d22 7574  w", encoding="ut
+00003660: 662d 3822 2920 6173 2077 7269 7465 723a  f-8") as writer:
+00003670: 0a20 2020 2020 2020 2020 2020 2077 7269  .            wri
+00003680: 7465 722e 7772 6974 6528 2223 7665 7273  ter.write("#vers
+00003690: 696f 6e3a 2030 2e32 5c6e 2229 0a20 2020  ion: 0.2\n").   
+000036a0: 2020 2020 2020 2020 2066 6f72 2062 7065           for bpe
+000036b0: 5f74 6f6b 656e 732c 2074 6f6b 656e 5f69  _tokens, token_i
+000036c0: 6e64 6578 2069 6e20 736f 7274 6564 2873  ndex in sorted(s
+000036d0: 656c 662e 6270 655f 7261 6e6b 732e 6974  elf.bpe_ranks.it
+000036e0: 656d 7328 292c 206b 6579 3d6c 616d 6264  ems(), key=lambd
+000036f0: 6120 6b76 3a20 6b76 5b31 5d29 3a0a 2020  a kv: kv[1]):.  
+00003700: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00003710: 2069 6e64 6578 2021 3d20 746f 6b65 6e5f   index != token_
+00003720: 696e 6465 783a 0a20 2020 2020 2020 2020  index:.         
+00003730: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+00003740: 722e 7761 726e 696e 6728 0a20 2020 2020  r.warning(.     
+00003750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003760: 2020 2066 2253 6176 696e 6720 766f 6361     f"Saving voca
+00003770: 6275 6c61 7279 2074 6f20 7b6d 6572 6765  bulary to {merge
+00003780: 5f66 696c 657d 3a20 4250 4520 6d65 7267  _file}: BPE merg
+00003790: 6520 696e 6469 6365 7320 6172 6520 6e6f  e indices are no
+000037a0: 7420 636f 6e73 6563 7574 6976 652e 220a  t consecutive.".
+000037b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000037c0: 2020 2020 2020 2020 2220 506c 6561 7365          " Please
+000037d0: 2063 6865 636b 2074 6861 7420 7468 6520   check that the 
+000037e0: 746f 6b65 6e69 7a65 7220 6973 206e 6f74  tokenizer is not
+000037f0: 2063 6f72 7275 7074 6564 2122 0a20 2020   corrupted!".   
+00003800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003810: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00003820: 2020 2020 2020 2069 6e64 6578 203d 2074         index = t
+00003830: 6f6b 656e 5f69 6e64 6578 0a20 2020 2020  oken_index.     
+00003840: 2020 2020 2020 2020 2020 2077 7269 7465             write
+00003850: 722e 7772 6974 6528 2220 222e 6a6f 696e  r.write(" ".join
+00003860: 2862 7065 5f74 6f6b 656e 7329 202b 2022  (bpe_tokens) + "
+00003870: 5c6e 2229 0a20 2020 2020 2020 2020 2020  \n").           
+00003880: 2020 2020 2069 6e64 6578 202b 3d20 310a       index += 1.
+00003890: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000038a0: 766f 6361 625f 6669 6c65 2c20 6d65 7267  vocab_file, merg
+000038b0: 655f 6669 6c65 0a0a 2020 2020 2320 436f  e_file..    # Co
+000038c0: 7069 6564 2066 726f 6d20 7472 616e 7366  pied from transf
+000038d0: 6f72 6d65 7273 2e6d 6f64 656c 732e 726f  ormers.models.ro
+000038e0: 6265 7274 612e 746f 6b65 6e69 7a61 7469  berta.tokenizati
+000038f0: 6f6e 5f72 6f62 6572 7461 2e52 6f62 6572  on_roberta.Rober
+00003900: 7461 546f 6b65 6e69 7a65 722e 6765 745f  taTokenizer.get_
+00003910: 7370 6563 6961 6c5f 746f 6b65 6e73 5f6d  special_tokens_m
+00003920: 6173 6b20 7769 7468 2052 6f62 6572 7461  ask with Roberta
+00003930: 2d3e 426c 656e 6465 7262 6f74 2c20 526f  ->Blenderbot, Ro
+00003940: 4245 5254 612d 3e42 6c65 6e64 6572 626f  BERTa->Blenderbo
+00003950: 740a 2020 2020 6465 6620 6765 745f 7370  t.    def get_sp
+00003960: 6563 6961 6c5f 746f 6b65 6e73 5f6d 6173  ecial_tokens_mas
+00003970: 6b28 0a20 2020 2020 2020 2073 656c 662c  k(.        self,
+00003980: 2074 6f6b 656e 5f69 6473 5f30 3a20 4c69   token_ids_0: Li
+00003990: 7374 5b69 6e74 5d2c 2074 6f6b 656e 5f69  st[int], token_i
+000039a0: 6473 5f31 3a20 4f70 7469 6f6e 616c 5b4c  ds_1: Optional[L
+000039b0: 6973 745b 696e 745d 5d20 3d20 4e6f 6e65  ist[int]] = None
+000039c0: 2c20 616c 7265 6164 795f 6861 735f 7370  , already_has_sp
+000039d0: 6563 6961 6c5f 746f 6b65 6e73 3a20 626f  ecial_tokens: bo
+000039e0: 6f6c 203d 2046 616c 7365 0a20 2020 2029  ol = False.    )
+000039f0: 202d 3e20 4c69 7374 5b69 6e74 5d3a 0a20   -> List[int]:. 
+00003a00: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00003a10: 2020 2052 6574 7269 6576 6520 7365 7175     Retrieve sequ
+00003a20: 656e 6365 2069 6473 2066 726f 6d20 6120  ence ids from a 
+00003a30: 746f 6b65 6e20 6c69 7374 2074 6861 7420  token list that 
+00003a40: 6861 7320 6e6f 2073 7065 6369 616c 2074  has no special t
+00003a50: 6f6b 656e 7320 6164 6465 642e 2054 6869  okens added. Thi
+00003a60: 7320 6d65 7468 6f64 2069 7320 6361 6c6c  s method is call
+00003a70: 6564 2077 6865 6e20 6164 6469 6e67 0a20  ed when adding. 
+00003a80: 2020 2020 2020 2073 7065 6369 616c 2074         special t
+00003a90: 6f6b 656e 7320 7573 696e 6720 7468 6520  okens using the 
+00003aa0: 746f 6b65 6e69 7a65 7220 6070 7265 7061  tokenizer `prepa
+00003ab0: 7265 5f66 6f72 5f6d 6f64 656c 6020 6d65  re_for_model` me
+00003ac0: 7468 6f64 2e0a 0a20 2020 2020 2020 2041  thod...        A
+00003ad0: 7267 733a 0a20 2020 2020 2020 2020 2020  rgs:.           
+00003ae0: 2074 6f6b 656e 5f69 6473 5f30 2028 604c   token_ids_0 (`L
+00003af0: 6973 745b 696e 745d 6029 3a0a 2020 2020  ist[int]`):.    
+00003b00: 2020 2020 2020 2020 2020 2020 4c69 7374              List
+00003b10: 206f 6620 4944 732e 0a20 2020 2020 2020   of IDs..       
+00003b20: 2020 2020 2074 6f6b 656e 5f69 6473 5f31       token_ids_1
+00003b30: 2028 604c 6973 745b 696e 745d 602c 202a   (`List[int]`, *
+00003b40: 6f70 7469 6f6e 616c 2a29 3a0a 2020 2020  optional*):.    
+00003b50: 2020 2020 2020 2020 2020 2020 4f70 7469              Opti
+00003b60: 6f6e 616c 2073 6563 6f6e 6420 6c69 7374  onal second list
+00003b70: 206f 6620 4944 7320 666f 7220 7365 7175   of IDs for sequ
+00003b80: 656e 6365 2070 6169 7273 2e0a 2020 2020  ence pairs..    
+00003b90: 2020 2020 2020 2020 616c 7265 6164 795f          already_
+00003ba0: 6861 735f 7370 6563 6961 6c5f 746f 6b65  has_special_toke
+00003bb0: 6e73 2028 6062 6f6f 6c60 2c20 2a6f 7074  ns (`bool`, *opt
+00003bc0: 696f 6e61 6c2a 2c20 6465 6661 756c 7473  ional*, defaults
+00003bd0: 2074 6f20 6046 616c 7365 6029 3a0a 2020   to `False`):.  
+00003be0: 2020 2020 2020 2020 2020 2020 2020 5768                Wh
+00003bf0: 6574 6865 7220 6f72 206e 6f74 2074 6865  ether or not the
+00003c00: 2074 6f6b 656e 206c 6973 7420 6973 2061   token list is a
+00003c10: 6c72 6561 6479 2066 6f72 6d61 7474 6564  lready formatted
+00003c20: 2077 6974 6820 7370 6563 6961 6c20 746f   with special to
+00003c30: 6b65 6e73 2066 6f72 2074 6865 206d 6f64  kens for the mod
+00003c40: 656c 2e0a 0a20 2020 2020 2020 2052 6574  el...        Ret
+00003c50: 7572 6e73 3a0a 2020 2020 2020 2020 2020  urns:.          
+00003c60: 2020 604c 6973 745b 696e 745d 603a 2041    `List[int]`: A
+00003c70: 206c 6973 7420 6f66 2069 6e74 6567 6572   list of integer
+00003c80: 7320 696e 2074 6865 2072 616e 6765 205b  s in the range [
+00003c90: 302c 2031 5d3a 2031 2066 6f72 2061 2073  0, 1]: 1 for a s
+00003ca0: 7065 6369 616c 2074 6f6b 656e 2c20 3020  pecial token, 0 
+00003cb0: 666f 7220 6120 7365 7175 656e 6365 2074  for a sequence t
+00003cc0: 6f6b 656e 2e0a 2020 2020 2020 2020 2222  oken..        ""
+00003cd0: 220a 2020 2020 2020 2020 6966 2061 6c72  ".        if alr
+00003ce0: 6561 6479 5f68 6173 5f73 7065 6369 616c  eady_has_special
+00003cf0: 5f74 6f6b 656e 733a 0a20 2020 2020 2020  _tokens:.       
+00003d00: 2020 2020 2072 6574 7572 6e20 7375 7065       return supe
+00003d10: 7228 292e 6765 745f 7370 6563 6961 6c5f  r().get_special_
+00003d20: 746f 6b65 6e73 5f6d 6173 6b28 0a20 2020  tokens_mask(.   
+00003d30: 2020 2020 2020 2020 2020 2020 2074 6f6b               tok
+00003d40: 656e 5f69 6473 5f30 3d74 6f6b 656e 5f69  en_ids_0=token_i
+00003d50: 6473 5f30 2c20 746f 6b65 6e5f 6964 735f  ds_0, token_ids_
+00003d60: 313d 746f 6b65 6e5f 6964 735f 312c 2061  1=token_ids_1, a
+00003d70: 6c72 6561 6479 5f68 6173 5f73 7065 6369  lready_has_speci
+00003d80: 616c 5f74 6f6b 656e 733d 5472 7565 0a20  al_tokens=True. 
+00003d90: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00003da0: 2020 2020 2020 6966 2074 6f6b 656e 5f69        if token_i
+00003db0: 6473 5f31 2069 7320 4e6f 6e65 3a0a 2020  ds_1 is None:.  
+00003dc0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00003dd0: 205b 315d 202b 2028 5b30 5d20 2a20 6c65   [1] + ([0] * le
+00003de0: 6e28 746f 6b65 6e5f 6964 735f 3029 2920  n(token_ids_0)) 
+00003df0: 2b20 5b31 5d0a 2020 2020 2020 2020 7265  + [1].        re
+00003e00: 7475 726e 205b 315d 202b 2028 5b30 5d20  turn [1] + ([0] 
+00003e10: 2a20 6c65 6e28 746f 6b65 6e5f 6964 735f  * len(token_ids_
+00003e20: 3029 2920 2b20 5b31 2c20 315d 202b 2028  0)) + [1, 1] + (
+00003e30: 5b30 5d20 2a20 6c65 6e28 746f 6b65 6e5f  [0] * len(token_
+00003e40: 6964 735f 3129 2920 2b20 5b31 5d0a 0a20  ids_1)) + [1].. 
+00003e50: 2020 2023 2043 6f70 6965 6420 6672 6f6d     # Copied from
+00003e60: 2074 7261 6e73 666f 726d 6572 732e 6d6f   transformers.mo
+00003e70: 6465 6c73 2e72 6f62 6572 7461 2e74 6f6b  dels.roberta.tok
+00003e80: 656e 697a 6174 696f 6e5f 726f 6265 7274  enization_robert
+00003e90: 612e 526f 6265 7274 6154 6f6b 656e 697a  a.RobertaTokeniz
+00003ea0: 6572 2e63 7265 6174 655f 746f 6b65 6e5f  er.create_token_
+00003eb0: 7479 7065 5f69 6473 5f66 726f 6d5f 7365  type_ids_from_se
+00003ec0: 7175 656e 6365 7320 7769 7468 2052 6f62  quences with Rob
+00003ed0: 6572 7461 2d3e 426c 656e 6465 7262 6f74  erta->Blenderbot
+00003ee0: 2c20 526f 4245 5254 612d 3e42 6c65 6e64  , RoBERTa->Blend
+00003ef0: 6572 626f 740a 2020 2020 6465 6620 6372  erbot.    def cr
+00003f00: 6561 7465 5f74 6f6b 656e 5f74 7970 655f  eate_token_type_
+00003f10: 6964 735f 6672 6f6d 5f73 6571 7565 6e63  ids_from_sequenc
+00003f20: 6573 280a 2020 2020 2020 2020 7365 6c66  es(.        self
+00003f30: 2c20 746f 6b65 6e5f 6964 735f 303a 204c  , token_ids_0: L
+00003f40: 6973 745b 696e 745d 2c20 746f 6b65 6e5f  ist[int], token_
+00003f50: 6964 735f 313a 204f 7074 696f 6e61 6c5b  ids_1: Optional[
+00003f60: 4c69 7374 5b69 6e74 5d5d 203d 204e 6f6e  List[int]] = Non
+00003f70: 650a 2020 2020 2920 2d3e 204c 6973 745b  e.    ) -> List[
+00003f80: 696e 745d 3a0a 2020 2020 2020 2020 2222  int]:.        ""
+00003f90: 220a 2020 2020 2020 2020 4372 6561 7465  ".        Create
+00003fa0: 2061 206d 6173 6b20 6672 6f6d 2074 6865   a mask from the
+00003fb0: 2074 776f 2073 6571 7565 6e63 6573 2070   two sequences p
+00003fc0: 6173 7365 6420 746f 2062 6520 7573 6564  assed to be used
+00003fd0: 2069 6e20 6120 7365 7175 656e 6365 2d70   in a sequence-p
+00003fe0: 6169 7220 636c 6173 7369 6669 6361 7469  air classificati
+00003ff0: 6f6e 2074 6173 6b2e 2042 6c65 6e64 6572  on task. Blender
+00004000: 626f 7420 646f 6573 206e 6f74 0a20 2020  bot does not.   
+00004010: 2020 2020 206d 616b 6520 7573 6520 6f66       make use of
+00004020: 2074 6f6b 656e 2074 7970 6520 6964 732c   token type ids,
+00004030: 2074 6865 7265 666f 7265 2061 206c 6973   therefore a lis
+00004040: 7420 6f66 207a 6572 6f73 2069 7320 7265  t of zeros is re
+00004050: 7475 726e 6564 2e0a 0a20 2020 2020 2020  turned...       
+00004060: 2041 7267 733a 0a20 2020 2020 2020 2020   Args:.         
+00004070: 2020 2074 6f6b 656e 5f69 6473 5f30 2028     token_ids_0 (
+00004080: 604c 6973 745b 696e 745d 6029 3a0a 2020  `List[int]`):.  
+00004090: 2020 2020 2020 2020 2020 2020 2020 4c69                Li
+000040a0: 7374 206f 6620 4944 732e 0a20 2020 2020  st of IDs..     
+000040b0: 2020 2020 2020 2074 6f6b 656e 5f69 6473         token_ids
+000040c0: 5f31 2028 604c 6973 745b 696e 745d 602c  _1 (`List[int]`,
+000040d0: 202a 6f70 7469 6f6e 616c 2a29 3a0a 2020   *optional*):.  
+000040e0: 2020 2020 2020 2020 2020 2020 2020 4f70                Op
+000040f0: 7469 6f6e 616c 2073 6563 6f6e 6420 6c69  tional second li
+00004100: 7374 206f 6620 4944 7320 666f 7220 7365  st of IDs for se
+00004110: 7175 656e 6365 2070 6169 7273 2e0a 0a20  quence pairs... 
+00004120: 2020 2020 2020 2052 6574 7572 6e73 3a0a         Returns:.
+00004130: 2020 2020 2020 2020 2020 2020 604c 6973              `Lis
+00004140: 745b 696e 745d 603a 204c 6973 7420 6f66  t[int]`: List of
+00004150: 207a 6572 6f73 2e0a 2020 2020 2020 2020   zeros..        
+00004160: 2222 220a 2020 2020 2020 2020 7365 7020  """.        sep 
+00004170: 3d20 5b73 656c 662e 7365 705f 746f 6b65  = [self.sep_toke
+00004180: 6e5f 6964 5d0a 2020 2020 2020 2020 636c  n_id].        cl
+00004190: 7320 3d20 5b73 656c 662e 636c 735f 746f  s = [self.cls_to
+000041a0: 6b65 6e5f 6964 5d0a 0a20 2020 2020 2020  ken_id]..       
+000041b0: 2069 6620 746f 6b65 6e5f 6964 735f 3120   if token_ids_1 
+000041c0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+000041d0: 2020 2020 2072 6574 7572 6e20 6c65 6e28       return len(
+000041e0: 636c 7320 2b20 746f 6b65 6e5f 6964 735f  cls + token_ids_
+000041f0: 3020 2b20 7365 7029 202a 205b 305d 0a20  0 + sep) * [0]. 
+00004200: 2020 2020 2020 2072 6574 7572 6e20 6c65         return le
+00004210: 6e28 636c 7320 2b20 746f 6b65 6e5f 6964  n(cls + token_id
+00004220: 735f 3020 2b20 7365 7020 2b20 7365 7020  s_0 + sep + sep 
+00004230: 2b20 746f 6b65 6e5f 6964 735f 3120 2b20  + token_ids_1 + 
+00004240: 7365 7029 202a 205b 305d 0a0a 2020 2020  sep) * [0]..    
+00004250: 2320 436f 7069 6564 2066 726f 6d20 7472  # Copied from tr
+00004260: 616e 7366 6f72 6d65 7273 2e6d 6f64 656c  ansformers.model
+00004270: 732e 726f 6265 7274 612e 746f 6b65 6e69  s.roberta.tokeni
+00004280: 7a61 7469 6f6e 5f72 6f62 6572 7461 2e52  zation_roberta.R
+00004290: 6f62 6572 7461 546f 6b65 6e69 7a65 722e  obertaTokenizer.
+000042a0: 7072 6570 6172 655f 666f 725f 746f 6b65  prepare_for_toke
+000042b0: 6e69 7a61 7469 6f6e 2077 6974 6820 526f  nization with Ro
+000042c0: 6265 7274 612d 3e42 6c65 6e64 6572 626f  berta->Blenderbo
+000042d0: 742c 2052 6f42 4552 5461 2d3e 426c 656e  t, RoBERTa->Blen
+000042e0: 6465 7262 6f74 0a20 2020 2064 6566 2070  derbot.    def p
+000042f0: 7265 7061 7265 5f66 6f72 5f74 6f6b 656e  repare_for_token
+00004300: 697a 6174 696f 6e28 7365 6c66 2c20 7465  ization(self, te
+00004310: 7874 2c20 6973 5f73 706c 6974 5f69 6e74  xt, is_split_int
+00004320: 6f5f 776f 7264 733d 4661 6c73 652c 202a  o_words=False, *
+00004330: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
+00004340: 2020 6164 645f 7072 6566 6978 5f73 7061    add_prefix_spa
+00004350: 6365 203d 206b 7761 7267 732e 706f 7028  ce = kwargs.pop(
+00004360: 2261 6464 5f70 7265 6669 785f 7370 6163  "add_prefix_spac
+00004370: 6522 2c20 7365 6c66 2e61 6464 5f70 7265  e", self.add_pre
+00004380: 6669 785f 7370 6163 6529 0a20 2020 2020  fix_space).     
+00004390: 2020 2069 6620 2869 735f 7370 6c69 745f     if (is_split_
+000043a0: 696e 746f 5f77 6f72 6473 206f 7220 6164  into_words or ad
+000043b0: 645f 7072 6566 6978 5f73 7061 6365 2920  d_prefix_space) 
+000043c0: 616e 6420 286c 656e 2874 6578 7429 203e  and (len(text) >
+000043d0: 2030 2061 6e64 206e 6f74 2074 6578 745b   0 and not text[
+000043e0: 305d 2e69 7373 7061 6365 2829 293a 0a20  0].isspace()):. 
+000043f0: 2020 2020 2020 2020 2020 2074 6578 7420             text 
+00004400: 3d20 2220 2220 2b20 7465 7874 0a20 2020  = " " + text.   
+00004410: 2020 2020 2072 6574 7572 6e20 2874 6578       return (tex
+00004420: 742c 206b 7761 7267 7329 0a0a 2020 2020  t, kwargs)..    
+00004430: 6465 6620 6275 696c 645f 696e 7075 7473  def build_inputs
+00004440: 5f77 6974 685f 7370 6563 6961 6c5f 746f  _with_special_to
+00004450: 6b65 6e73 2873 656c 662c 2074 6f6b 656e  kens(self, token
+00004460: 5f69 6473 5f30 3a20 4c69 7374 5b69 6e74  _ids_0: List[int
+00004470: 5d2c 2074 6f6b 656e 5f69 6473 5f31 3a20  ], token_ids_1: 
+00004480: 4f70 7469 6f6e 616c 5b4c 6973 745b 696e  Optional[List[in
+00004490: 745d 5d20 3d20 4e6f 6e65 293a 0a20 2020  t]] = None):.   
+000044a0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+000044b0: 2042 7569 6c64 206d 6f64 656c 2069 6e70   Build model inp
+000044c0: 7574 7320 6672 6f6d 2061 2073 6571 7565  uts from a seque
+000044d0: 6e63 6520 6f72 2061 2070 6169 7220 6f66  nce or a pair of
+000044e0: 2073 6571 7565 6e63 6520 666f 7220 7365   sequence for se
+000044f0: 7175 656e 6365 2063 6c61 7373 6966 6963  quence classific
+00004500: 6174 696f 6e20 7461 736b 7320 6279 2063  ation tasks by c
+00004510: 6f6e 6361 7465 6e61 7469 6e67 2061 6e64  oncatenating and
+00004520: 0a20 2020 2020 2020 2061 6464 696e 6720  .        adding 
+00004530: 7370 6563 6961 6c20 746f 6b65 6e73 2e20  special tokens. 
+00004540: 4120 426c 656e 6465 7262 6f74 2073 6571  A Blenderbot seq
+00004550: 7565 6e63 6520 6861 7320 7468 6520 666f  uence has the fo
+00004560: 6c6c 6f77 696e 6720 666f 726d 6174 3a0a  llowing format:.
+00004570: 2020 2020 2020 2020 2d20 7369 6e67 6c65          - single
+00004580: 2073 6571 7565 6e63 653a 2060 2058 203c   sequence: ` X <
+00004590: 2f73 3e60 0a0a 2020 2020 2020 2020 4172  /s>`..        Ar
+000045a0: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
+000045b0: 746f 6b65 6e5f 6964 735f 3020 2860 4c69  token_ids_0 (`Li
+000045c0: 7374 5b69 6e74 5d60 293a 0a20 2020 2020  st[int]`):.     
+000045d0: 2020 2020 2020 2020 2020 204c 6973 7420             List 
+000045e0: 6f66 2049 4473 2074 6f20 7768 6963 6820  of IDs to which 
+000045f0: 7468 6520 7370 6563 6961 6c20 746f 6b65  the special toke
+00004600: 6e73 2077 696c 6c20 6265 2061 6464 6564  ns will be added
+00004610: 0a20 2020 2020 2020 2020 2020 2074 6f6b  .            tok
+00004620: 656e 5f69 6473 5f31 2028 604c 6973 745b  en_ids_1 (`List[
+00004630: 696e 745d 602c 202a 6f70 7469 6f6e 616c  int]`, *optional
+00004640: 2a29 3a0a 2020 2020 2020 2020 2020 2020  *):.            
+00004650: 2020 2020 5769 6c6c 2062 6520 6967 6e6f      Will be igno
+00004660: 7265 640a 2020 2020 2020 2020 5265 7475  red.        Retu
+00004670: 726e 733a 0a20 2020 2020 2020 2020 2020  rns:.           
+00004680: 2060 4c69 7374 5b69 6e74 5d60 3a20 6c69   `List[int]`: li
+00004690: 7374 206f 6620 5b69 6e70 7574 2049 4473  st of [input IDs
+000046a0: 5d28 2e2e 2f67 6c6f 7373 6172 7923 696e  ](../glossary#in
+000046b0: 7075 742d 6964 7329 2077 6974 6820 7468  put-ids) with th
+000046c0: 6520 6170 7072 6f70 7269 6174 6520 7370  e appropriate sp
+000046d0: 6563 6961 6c20 746f 6b65 6e73 2e0a 2020  ecial tokens..  
+000046e0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+000046f0: 2020 7265 7475 726e 2074 6f6b 656e 5f69    return token_i
+00004700: 6473 5f30 202b 205b 7365 6c66 2e65 6f73  ds_0 + [self.eos
+00004710: 5f74 6f6b 656e 5f69 645d 0a0a 2020 2020  _token_id]..    
+00004720: 4070 726f 7065 7274 790a 2020 2020 6465  @property.    de
+00004730: 6620 6465 6661 756c 745f 6368 6174 5f74  f default_chat_t
+00004740: 656d 706c 6174 6528 7365 6c66 293a 0a20  emplate(self):. 
+00004750: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00004760: 2020 2041 2076 6572 7920 7369 6d70 6c65     A very simple
+00004770: 2063 6861 7420 7465 6d70 6c61 7465 2074   chat template t
+00004780: 6861 7420 6a75 7374 2061 6464 7320 7768  hat just adds wh
+00004790: 6974 6573 7061 6365 2062 6574 7765 656e  itespace between
+000047a0: 206d 6573 7361 6765 732e 0a20 2020 2020   messages..     
+000047b0: 2020 2022 2222 0a20 2020 2020 2020 206c     """.        l
+000047c0: 6f67 6765 722e 7761 726e 696e 675f 6f6e  ogger.warning_on
+000047d0: 6365 280a 2020 2020 2020 2020 2020 2020  ce(.            
+000047e0: 225c 6e4e 6f20 6368 6174 2074 656d 706c  "\nNo chat templ
+000047f0: 6174 6520 6973 2064 6566 696e 6564 2066  ate is defined f
+00004800: 6f72 2074 6869 7320 746f 6b65 6e69 7a65  or this tokenize
+00004810: 7220 2d20 7573 696e 6720 7468 6520 6465  r - using the de
+00004820: 6661 756c 7420 7465 6d70 6c61 7465 2022  fault template "
+00004830: 0a20 2020 2020 2020 2020 2020 2066 2266  .            f"f
+00004840: 6f72 2074 6865 207b 7365 6c66 2e5f 5f63  or the {self.__c
+00004850: 6c61 7373 5f5f 2e5f 5f6e 616d 655f 5f7d  lass__.__name__}
+00004860: 2063 6c61 7373 2e20 4966 2074 6865 2064   class. If the d
+00004870: 6566 6175 6c74 2069 7320 6e6f 7420 6170  efault is not ap
+00004880: 7072 6f70 7269 6174 6520 666f 7220 220a  propriate for ".
+00004890: 2020 2020 2020 2020 2020 2020 2279 6f75              "you
+000048a0: 7220 6d6f 6465 6c2c 2070 6c65 6173 6520  r model, please 
+000048b0: 7365 7420 6074 6f6b 656e 697a 6572 2e63  set `tokenizer.c
+000048c0: 6861 745f 7465 6d70 6c61 7465 6020 746f  hat_template` to
+000048d0: 2061 6e20 6170 7072 6f70 7269 6174 6520   an appropriate 
+000048e0: 7465 6d70 6c61 7465 2e20 220a 2020 2020  template. ".    
+000048f0: 2020 2020 2020 2020 2253 6565 2068 7474          "See htt
+00004900: 7073 3a2f 2f68 7567 6769 6e67 6661 6365  ps://huggingface
+00004910: 2e63 6f2f 646f 6373 2f74 7261 6e73 666f  .co/docs/transfo
+00004920: 726d 6572 732f 6d61 696e 2f63 6861 745f  rmers/main/chat_
+00004930: 7465 6d70 6c61 7469 6e67 2066 6f72 206d  templating for m
+00004940: 6f72 6520 696e 666f 726d 6174 696f 6e2e  ore information.
+00004950: 5c6e 220a 2020 2020 2020 2020 290a 2020  \n".        ).  
+00004960: 2020 2020 2020 7265 7475 726e 2028 0a20        return (. 
+00004970: 2020 2020 2020 2020 2020 2022 7b25 2066             "{% f
+00004980: 6f72 206d 6573 7361 6765 2069 6e20 6d65  or message in me
+00004990: 7373 6167 6573 2025 7d22 0a20 2020 2020  ssages %}".     
+000049a0: 2020 2020 2020 2022 7b25 2069 6620 6d65         "{% if me
+000049b0: 7373 6167 655b 2772 6f6c 6527 5d20 3d3d  ssage['role'] ==
+000049c0: 2027 7573 6572 2720 257d 7b7b 2027 2027   'user' %}{{ ' '
+000049d0: 207d 7d7b 2520 656e 6469 6620 257d 220a   }}{% endif %}".
+000049e0: 2020 2020 2020 2020 2020 2020 227b 7b20              "{{ 
+000049f0: 6d65 7373 6167 655b 2763 6f6e 7465 6e74  message['content
+00004a00: 275d 207d 7d22 0a20 2020 2020 2020 2020  '] }}".         
+00004a10: 2020 2022 7b25 2069 6620 6e6f 7420 6c6f     "{% if not lo
+00004a20: 6f70 2e6c 6173 7420 257d 7b7b 2027 2020  op.last %}{{ '  
+00004a30: 2720 7d7d 7b25 2065 6e64 6966 2025 7d22  ' }}{% endif %}"
+00004a40: 0a20 2020 2020 2020 2020 2020 2022 7b25  .            "{%
+00004a50: 2065 6e64 666f 7220 257d 220a 2020 2020   endfor %}".    
+00004a60: 2020 2020 2020 2020 227b 7b20 656f 735f          "{{ eos_
+00004a70: 746f 6b65 6e20 7d7d 220a 2020 2020 2020  token }}".      
+00004a80: 2020 290a 0a5f 5f61 6c6c 5f5f 203d 205b    )..__all__ = [
+00004a90: 2742 6c65 6e64 6572 626f 7454 6f6b 656e  'BlenderbotToken
+00004aa0: 697a 6572 275d 0a                        izer'].
```

## mindnlp/transformers/models/blenderbot/tokenization_blenderbot_fast.py

```diff
@@ -0,0 +1,1195 @@
+00000000: 2320 636f 6469 6e67 3d75 7466 2d38 0a23  # coding=utf-8.#
+00000010: 2043 6f70 7972 6967 6874 2032 3032 3120   Copyright 2021 
+00000020: 5468 6520 4661 6365 626f 6f6b 2049 6e63  The Facebook Inc
+00000030: 2e20 616e 6420 5468 6520 4875 6767 696e  . and The Huggin
+00000040: 6746 6163 6520 496e 632e 2074 6561 6d2e  gFace Inc. team.
+00000050: 2041 6c6c 2072 6967 6874 7320 7265 7365   All rights rese
+00000060: 7276 6564 2e0a 230a 2320 4c69 6365 6e73  rved..#.# Licens
+00000070: 6564 2075 6e64 6572 2074 6865 2041 7061  ed under the Apa
+00000080: 6368 6520 4c69 6365 6e73 652c 2056 6572  che License, Ver
+00000090: 7369 6f6e 2032 2e30 2028 7468 6520 224c  sion 2.0 (the "L
+000000a0: 6963 656e 7365 2229 3b0a 2320 796f 7520  icense");.# you 
+000000b0: 6d61 7920 6e6f 7420 7573 6520 7468 6973  may not use this
+000000c0: 2066 696c 6520 6578 6365 7074 2069 6e20   file except in 
+000000d0: 636f 6d70 6c69 616e 6365 2077 6974 6820  compliance with 
+000000e0: 7468 6520 4c69 6365 6e73 652e 0a23 2059  the License..# Y
+000000f0: 6f75 206d 6179 206f 6274 6169 6e20 6120  ou may obtain a 
+00000100: 636f 7079 206f 6620 7468 6520 4c69 6365  copy of the Lice
+00000110: 6e73 6520 6174 0a23 0a23 2020 2020 2068  nse at.#.#     h
+00000120: 7474 703a 2f2f 7777 772e 6170 6163 6865  ttp://www.apache
+00000130: 2e6f 7267 2f6c 6963 656e 7365 732f 4c49  .org/licenses/LI
+00000140: 4345 4e53 452d 322e 300a 230a 2320 556e  CENSE-2.0.#.# Un
+00000150: 6c65 7373 2072 6571 7569 7265 6420 6279  less required by
+00000160: 2061 7070 6c69 6361 626c 6520 6c61 7720   applicable law 
+00000170: 6f72 2061 6772 6565 6420 746f 2069 6e20  or agreed to in 
+00000180: 7772 6974 696e 672c 2073 6f66 7477 6172  writing, softwar
+00000190: 650a 2320 6469 7374 7269 6275 7465 6420  e.# distributed 
+000001a0: 756e 6465 7220 7468 6520 4c69 6365 6e73  under the Licens
+000001b0: 6520 6973 2064 6973 7472 6962 7574 6564  e is distributed
+000001c0: 206f 6e20 616e 2022 4153 2049 5322 2042   on an "AS IS" B
+000001d0: 4153 4953 2c0a 2320 5749 5448 4f55 5420  ASIS,.# WITHOUT 
+000001e0: 5741 5252 414e 5449 4553 204f 5220 434f  WARRANTIES OR CO
+000001f0: 4e44 4954 494f 4e53 204f 4620 414e 5920  NDITIONS OF ANY 
+00000200: 4b49 4e44 2c20 6569 7468 6572 2065 7870  KIND, either exp
+00000210: 7265 7373 206f 7220 696d 706c 6965 642e  ress or implied.
+00000220: 0a23 2053 6565 2074 6865 204c 6963 656e  .# See the Licen
+00000230: 7365 2066 6f72 2074 6865 2073 7065 6369  se for the speci
+00000240: 6669 6320 6c61 6e67 7561 6765 2067 6f76  fic language gov
+00000250: 6572 6e69 6e67 2070 6572 6d69 7373 696f  erning permissio
+00000260: 6e73 2061 6e64 0a23 206c 696d 6974 6174  ns and.# limitat
+00000270: 696f 6e73 2075 6e64 6572 2074 6865 204c  ions under the L
+00000280: 6963 656e 7365 2e0a 2222 2254 6f6b 656e  icense.."""Token
+00000290: 697a 6174 696f 6e20 636c 6173 7320 666f  ization class fo
+000002a0: 7220 426c 656e 6465 7262 6f74 2e22 2222  r Blenderbot."""
+000002b0: 0a0a 696d 706f 7274 206a 736f 6e0a 696d  ..import json.im
+000002c0: 706f 7274 206f 730a 6672 6f6d 2066 756e  port os.from fun
+000002d0: 6374 6f6f 6c73 2069 6d70 6f72 7420 6c72  ctools import lr
+000002e0: 755f 6361 6368 650a 6672 6f6d 2074 7970  u_cache.from typ
+000002f0: 696e 6720 696d 706f 7274 204c 6973 742c  ing import List,
+00000300: 204f 7074 696f 6e61 6c2c 2054 7570 6c65   Optional, Tuple
+00000310: 0a0a 696d 706f 7274 2072 6567 6578 2061  ..import regex a
+00000320: 7320 7265 0a0a 6672 6f6d 202e 2e2e 746f  s re..from ...to
+00000330: 6b65 6e69 7a61 7469 6f6e 5f75 7469 6c73  kenization_utils
+00000340: 2069 6d70 6f72 7420 4164 6465 6454 6f6b   import AddedTok
+00000350: 656e 2c20 5072 6554 7261 696e 6564 546f  en, PreTrainedTo
+00000360: 6b65 6e69 7a65 720a 6672 6f6d 202e 2e2e  kenizer.from ...
+00000370: 2e75 7469 6c73 2069 6d70 6f72 7420 6c6f  .utils import lo
+00000380: 6767 696e 670a 0a0a 6c6f 6767 6572 203d  gging...logger =
+00000390: 206c 6f67 6769 6e67 2e67 6574 5f6c 6f67   logging.get_log
+000003a0: 6765 7228 5f5f 6e61 6d65 5f5f 290a 0a0a  ger(__name__)...
+000003b0: 564f 4341 425f 4649 4c45 535f 4e41 4d45  VOCAB_FILES_NAME
+000003c0: 5320 3d20 7b0a 2020 2020 2276 6f63 6162  S = {.    "vocab
+000003d0: 5f66 696c 6522 3a20 2276 6f63 6162 2e6a  _file": "vocab.j
+000003e0: 736f 6e22 2c0a 2020 2020 226d 6572 6765  son",.    "merge
+000003f0: 735f 6669 6c65 223a 2022 6d65 7267 6573  s_file": "merges
+00000400: 2e74 7874 222c 0a20 2020 2022 746f 6b65  .txt",.    "toke
+00000410: 6e69 7a65 725f 636f 6e66 6967 5f66 696c  nizer_config_fil
+00000420: 6522 3a20 2274 6f6b 656e 697a 6572 5f63  e": "tokenizer_c
+00000430: 6f6e 6669 672e 6a73 6f6e 222c 0a7d 0a0a  onfig.json",.}..
+00000440: 0a40 6c72 755f 6361 6368 6528 290a 2320  .@lru_cache().# 
+00000450: 436f 7069 6564 2066 726f 6d20 7472 616e  Copied from tran
+00000460: 7366 6f72 6d65 7273 2e6d 6f64 656c 732e  sformers.models.
+00000470: 726f 6265 7274 612e 746f 6b65 6e69 7a61  roberta.tokeniza
+00000480: 7469 6f6e 5f72 6f62 6572 7461 2e62 7974  tion_roberta.byt
+00000490: 6573 5f74 6f5f 756e 6963 6f64 650a 6465  es_to_unicode.de
+000004a0: 6620 6279 7465 735f 746f 5f75 6e69 636f  f bytes_to_unico
+000004b0: 6465 2829 3a0a 2020 2020 2222 220a 2020  de():.    """.  
+000004c0: 2020 5265 7475 726e 7320 6c69 7374 206f    Returns list o
+000004d0: 6620 7574 662d 3820 6279 7465 2061 6e64  f utf-8 byte and
+000004e0: 2061 206d 6170 7069 6e67 2074 6f20 756e   a mapping to un
+000004f0: 6963 6f64 6520 7374 7269 6e67 732e 2057  icode strings. W
+00000500: 6520 7370 6563 6966 6963 616c 6c79 2061  e specifically a
+00000510: 766f 6964 7320 6d61 7070 696e 6720 746f  voids mapping to
+00000520: 2077 6869 7465 7370 6163 652f 636f 6e74   whitespace/cont
+00000530: 726f 6c0a 2020 2020 6368 6172 6163 7465  rol.    characte
+00000540: 7273 2074 6865 2062 7065 2063 6f64 6520  rs the bpe code 
+00000550: 6261 7266 7320 6f6e 2e0a 0a20 2020 2054  barfs on...    T
+00000560: 6865 2072 6576 6572 7369 626c 6520 6270  he reversible bp
+00000570: 6520 636f 6465 7320 776f 726b 206f 6e20  e codes work on 
+00000580: 756e 6963 6f64 6520 7374 7269 6e67 732e  unicode strings.
+00000590: 2054 6869 7320 6d65 616e 7320 796f 7520   This means you 
+000005a0: 6e65 6564 2061 206c 6172 6765 2023 206f  need a large # o
+000005b0: 6620 756e 6963 6f64 6520 6368 6172 6163  f unicode charac
+000005c0: 7465 7273 2069 6e20 796f 7572 2076 6f63  ters in your voc
+000005d0: 6162 0a20 2020 2069 6620 796f 7520 7761  ab.    if you wa
+000005e0: 6e74 2074 6f20 6176 6f69 6420 554e 4b73  nt to avoid UNKs
+000005f0: 2e20 5768 656e 2079 6f75 2772 6520 6174  . When you're at
+00000600: 2073 6f6d 6574 6869 6e67 206c 696b 6520   something like 
+00000610: 6120 3130 4220 746f 6b65 6e20 6461 7461  a 10B token data
+00000620: 7365 7420 796f 7520 656e 6420 7570 206e  set you end up n
+00000630: 6565 6469 6e67 2061 726f 756e 6420 354b  eeding around 5K
+00000640: 2066 6f72 0a20 2020 2064 6563 656e 7420   for.    decent 
+00000650: 636f 7665 7261 6765 2e20 5468 6973 2069  coverage. This i
+00000660: 7320 6120 7369 676e 6966 6963 616e 7420  s a significant 
+00000670: 7065 7263 656e 7461 6765 206f 6620 796f  percentage of yo
+00000680: 7572 206e 6f72 6d61 6c2c 2073 6179 2c20  ur normal, say, 
+00000690: 3332 4b20 6270 6520 766f 6361 622e 2054  32K bpe vocab. T
+000006a0: 6f20 6176 6f69 6420 7468 6174 2c20 7765  o avoid that, we
+000006b0: 2077 616e 7420 6c6f 6f6b 7570 0a20 2020   want lookup.   
+000006c0: 2074 6162 6c65 7320 6265 7477 6565 6e20   tables between 
+000006d0: 7574 662d 3820 6279 7465 7320 616e 6420  utf-8 bytes and 
+000006e0: 756e 6963 6f64 6520 7374 7269 6e67 732e  unicode strings.
+000006f0: 0a20 2020 2022 2222 0a20 2020 2062 7320  .    """.    bs 
+00000700: 3d20 280a 2020 2020 2020 2020 6c69 7374  = (.        list
+00000710: 2872 616e 6765 286f 7264 2822 2122 292c  (range(ord("!"),
+00000720: 206f 7264 2822 7e22 2920 2b20 3129 2920   ord("~") + 1)) 
+00000730: 2b20 6c69 7374 2872 616e 6765 286f 7264  + list(range(ord
+00000740: 2822 c2a1 2229 2c20 6f72 6428 22c2 ac22  (".."), ord(".."
+00000750: 2920 2b20 3129 2920 2b20 6c69 7374 2872  ) + 1)) + list(r
+00000760: 616e 6765 286f 7264 2822 c2ae 2229 2c20  ange(ord(".."), 
+00000770: 6f72 6428 22c3 bf22 2920 2b20 3129 290a  ord("..") + 1)).
+00000780: 2020 2020 290a 2020 2020 6373 203d 2062      ).    cs = b
+00000790: 735b 3a5d 0a20 2020 206e 203d 2030 0a20  s[:].    n = 0. 
+000007a0: 2020 2066 6f72 2062 2069 6e20 7261 6e67     for b in rang
+000007b0: 6528 322a 2a38 293a 0a20 2020 2020 2020  e(2**8):.       
+000007c0: 2069 6620 6220 6e6f 7420 696e 2062 733a   if b not in bs:
+000007d0: 0a20 2020 2020 2020 2020 2020 2062 732e  .            bs.
+000007e0: 6170 7065 6e64 2862 290a 2020 2020 2020  append(b).      
+000007f0: 2020 2020 2020 6373 2e61 7070 656e 6428        cs.append(
+00000800: 322a 2a38 202b 206e 290a 2020 2020 2020  2**8 + n).      
+00000810: 2020 2020 2020 6e20 2b3d 2031 0a20 2020        n += 1.   
+00000820: 2063 7320 3d20 5b63 6872 286e 2920 666f   cs = [chr(n) fo
+00000830: 7220 6e20 696e 2063 735d 0a20 2020 2072  r n in cs].    r
+00000840: 6574 7572 6e20 6469 6374 287a 6970 2862  eturn dict(zip(b
+00000850: 732c 2063 7329 290a 0a0a 2320 436f 7069  s, cs))...# Copi
+00000860: 6564 2066 726f 6d20 7472 616e 7366 6f72  ed from transfor
+00000870: 6d65 7273 2e6d 6f64 656c 732e 726f 6265  mers.models.robe
+00000880: 7274 612e 746f 6b65 6e69 7a61 7469 6f6e  rta.tokenization
+00000890: 5f72 6f62 6572 7461 2e67 6574 5f70 6169  _roberta.get_pai
+000008a0: 7273 0a64 6566 2067 6574 5f70 6169 7273  rs.def get_pairs
+000008b0: 2877 6f72 6429 3a0a 2020 2020 2222 220a  (word):.    """.
+000008c0: 2020 2020 5265 7475 726e 2073 6574 206f      Return set o
+000008d0: 6620 7379 6d62 6f6c 2070 6169 7273 2069  f symbol pairs i
+000008e0: 6e20 6120 776f 7264 2e0a 0a20 2020 2057  n a word...    W
+000008f0: 6f72 6420 6973 2072 6570 7265 7365 6e74  ord is represent
+00000900: 6564 2061 7320 7475 706c 6520 6f66 2073  ed as tuple of s
+00000910: 796d 626f 6c73 2028 7379 6d62 6f6c 7320  ymbols (symbols 
+00000920: 6265 696e 6720 7661 7269 6162 6c65 2d6c  being variable-l
+00000930: 656e 6774 6820 7374 7269 6e67 7329 2e0a  ength strings)..
+00000940: 2020 2020 2222 220a 2020 2020 7061 6972      """.    pair
+00000950: 7320 3d20 7365 7428 290a 2020 2020 7072  s = set().    pr
+00000960: 6576 5f63 6861 7220 3d20 776f 7264 5b30  ev_char = word[0
+00000970: 5d0a 2020 2020 666f 7220 6368 6172 2069  ].    for char i
+00000980: 6e20 776f 7264 5b31 3a5d 3a0a 2020 2020  n word[1:]:.    
+00000990: 2020 2020 7061 6972 732e 6164 6428 2870      pairs.add((p
+000009a0: 7265 765f 6368 6172 2c20 6368 6172 2929  rev_char, char))
+000009b0: 0a20 2020 2020 2020 2070 7265 765f 6368  .        prev_ch
+000009c0: 6172 203d 2063 6861 720a 2020 2020 7265  ar = char.    re
+000009d0: 7475 726e 2070 6169 7273 0a0a 0a63 6c61  turn pairs...cla
+000009e0: 7373 2042 6c65 6e64 6572 626f 7454 6f6b  ss BlenderbotTok
+000009f0: 656e 697a 6572 2850 7265 5472 6169 6e65  enizer(PreTraine
+00000a00: 6454 6f6b 656e 697a 6572 293a 0a20 2020  dTokenizer):.   
+00000a10: 2022 2222 0a20 2020 2043 6f6e 7374 7275   """.    Constru
+00000a20: 6374 7320 6120 426c 656e 6465 7262 6f74  cts a Blenderbot
+00000a30: 2074 6f6b 656e 697a 6572 2c20 6465 7269   tokenizer, deri
+00000a40: 7665 6420 6672 6f6d 2074 6865 2047 5054  ved from the GPT
+00000a50: 2d32 2074 6f6b 656e 697a 6572 2c20 7573  -2 tokenizer, us
+00000a60: 696e 6720 6279 7465 2d6c 6576 656c 2042  ing byte-level B
+00000a70: 7974 652d 5061 6972 2d45 6e63 6f64 696e  yte-Pair-Encodin
+00000a80: 672e 0a0a 2020 2020 5468 6973 2074 6f6b  g...    This tok
+00000a90: 656e 697a 6572 2068 6173 2062 6565 6e20  enizer has been 
+00000aa0: 7472 6169 6e65 6420 746f 2074 7265 6174  trained to treat
+00000ab0: 2073 7061 6365 7320 6c69 6b65 2070 6172   spaces like par
+00000ac0: 7473 206f 6620 7468 6520 746f 6b65 6e73  ts of the tokens
+00000ad0: 2028 6120 6269 7420 6c69 6b65 2073 656e   (a bit like sen
+00000ae0: 7465 6e63 6570 6965 6365 2920 736f 2061  tencepiece) so a
+00000af0: 2077 6f72 6420 7769 6c6c 0a20 2020 2062   word will.    b
+00000b00: 6520 656e 636f 6465 6420 6469 6666 6572  e encoded differ
+00000b10: 656e 746c 7920 7768 6574 6865 7220 6974  ently whether it
+00000b20: 2069 7320 6174 2074 6865 2062 6567 696e   is at the begin
+00000b30: 6e69 6e67 206f 6620 7468 6520 7365 6e74  ning of the sent
+00000b40: 656e 6365 2028 7769 7468 6f75 7420 7370  ence (without sp
+00000b50: 6163 6529 206f 7220 6e6f 743a 0a0a 2020  ace) or not:..  
+00000b60: 2020 6060 6070 7974 686f 6e0a 2020 2020    ```python.    
+00000b70: 3e3e 3e20 6672 6f6d 2074 7261 6e73 666f  >>> from transfo
+00000b80: 726d 6572 7320 696d 706f 7274 2042 6c65  rmers import Ble
+00000b90: 6e64 6572 626f 7454 6f6b 656e 697a 6572  nderbotTokenizer
+00000ba0: 0a0a 2020 2020 3e3e 3e20 746f 6b65 6e69  ..    >>> tokeni
+00000bb0: 7a65 7220 3d20 426c 656e 6465 7262 6f74  zer = Blenderbot
+00000bc0: 546f 6b65 6e69 7a65 722e 6672 6f6d 5f70  Tokenizer.from_p
+00000bd0: 7265 7472 6169 6e65 6428 2266 6163 6562  retrained("faceb
+00000be0: 6f6f 6b2f 626c 656e 6465 7262 6f74 2d33  ook/blenderbot-3
+00000bf0: 4222 290a 2020 2020 3e3e 3e20 746f 6b65  B").    >>> toke
+00000c00: 6e69 7a65 722e 6164 645f 7072 6566 6978  nizer.add_prefix
+00000c10: 5f73 7061 6365 203d 2046 616c 7365 0a20  _space = False. 
+00000c20: 2020 203e 3e3e 2074 6f6b 656e 697a 6572     >>> tokenizer
+00000c30: 2822 4865 6c6c 6f20 776f 726c 6422 295b  ("Hello world")[
+00000c40: 2269 6e70 7574 5f69 6473 225d 0a20 2020  "input_ids"].   
+00000c50: 205b 3437 2c20 3932 312c 2038 362c 2031   [47, 921, 86, 1
+00000c60: 3038 352c 2032 5d0a 0a20 2020 203e 3e3e  085, 2]..    >>>
+00000c70: 2074 6f6b 656e 697a 6572 2822 2048 656c   tokenizer(" Hel
+00000c80: 6c6f 2077 6f72 6c64 2229 5b22 696e 7075  lo world")["inpu
+00000c90: 745f 6964 7322 5d0a 2020 2020 5b36 3935  t_ids"].    [695
+00000ca0: 302c 2031 3038 352c 2032 5d0a 2020 2020  0, 1085, 2].    
+00000cb0: 6060 600a 0a20 2020 2059 6f75 2063 616e  ```..    You can
+00000cc0: 2067 6574 2061 726f 756e 6420 7468 6174   get around that
+00000cd0: 2062 6568 6176 696f 7220 6279 2070 6173   behavior by pas
+00000ce0: 7369 6e67 2060 6164 645f 7072 6566 6978  sing `add_prefix
+00000cf0: 5f73 7061 6365 3d54 7275 6560 2077 6865  _space=True` whe
+00000d00: 6e20 696e 7374 616e 7469 6174 696e 6720  n instantiating 
+00000d10: 7468 6973 2074 6f6b 656e 697a 6572 206f  this tokenizer o
+00000d20: 7220 7768 656e 2079 6f75 0a20 2020 2063  r when you.    c
+00000d30: 616c 6c20 6974 206f 6e20 736f 6d65 2074  all it on some t
+00000d40: 6578 742c 2062 7574 2073 696e 6365 2074  ext, but since t
+00000d50: 6865 206d 6f64 656c 2077 6173 206e 6f74  he model was not
+00000d60: 2070 7265 7472 6169 6e65 6420 7468 6973   pretrained this
+00000d70: 2077 6179 2c20 6974 206d 6967 6874 2079   way, it might y
+00000d80: 6965 6c64 2061 2064 6563 7265 6173 6520  ield a decrease 
+00000d90: 696e 2070 6572 666f 726d 616e 6365 2e0a  in performance..
+00000da0: 0a20 2020 203c 5469 703e 0a0a 2020 2020  .    <Tip>..    
+00000db0: 5768 656e 2075 7365 6420 7769 7468 2060  When used with `
+00000dc0: 6973 5f73 706c 6974 5f69 6e74 6f5f 776f  is_split_into_wo
+00000dd0: 7264 733d 5472 7565 602c 2074 6869 7320  rds=True`, this 
+00000de0: 746f 6b65 6e69 7a65 7220 7769 6c6c 2061  tokenizer will a
+00000df0: 6464 2061 2073 7061 6365 2062 6566 6f72  dd a space befor
+00000e00: 6520 6561 6368 2077 6f72 6420 2865 7665  e each word (eve
+00000e10: 6e20 7468 6520 6669 7273 7420 6f6e 6529  n the first one)
+00000e20: 2e0a 0a20 2020 203c 2f54 6970 3e0a 0a20  ...    </Tip>.. 
+00000e30: 2020 2054 6869 7320 746f 6b65 6e69 7a65     This tokenize
+00000e40: 7220 696e 6865 7269 7473 2066 726f 6d20  r inherits from 
+00000e50: 5b60 5072 6554 7261 696e 6564 546f 6b65  [`PreTrainedToke
+00000e60: 6e69 7a65 7260 5d20 7768 6963 6820 636f  nizer`] which co
+00000e70: 6e74 6169 6e73 206d 6f73 7420 6f66 2074  ntains most of t
+00000e80: 6865 206d 6169 6e20 6d65 7468 6f64 732e  he main methods.
+00000e90: 2055 7365 7273 2073 686f 756c 6420 7265   Users should re
+00000ea0: 6665 7220 746f 0a20 2020 2074 6869 7320  fer to.    this 
+00000eb0: 7375 7065 7263 6c61 7373 2066 6f72 206d  superclass for m
+00000ec0: 6f72 6520 696e 666f 726d 6174 696f 6e20  ore information 
+00000ed0: 7265 6761 7264 696e 6720 7468 6f73 6520  regarding those 
+00000ee0: 6d65 7468 6f64 732e 0a0a 2020 2020 4172  methods...    Ar
+00000ef0: 6773 3a0a 2020 2020 2020 2020 766f 6361  gs:.        voca
+00000f00: 625f 6669 6c65 2028 6073 7472 6029 3a0a  b_file (`str`):.
+00000f10: 2020 2020 2020 2020 2020 2020 5061 7468              Path
+00000f20: 2074 6f20 7468 6520 766f 6361 6275 6c61   to the vocabula
+00000f30: 7279 2066 696c 652e 0a20 2020 2020 2020  ry file..       
+00000f40: 206d 6572 6765 735f 6669 6c65 2028 6073   merges_file (`s
+00000f50: 7472 6029 3a0a 2020 2020 2020 2020 2020  tr`):.          
+00000f60: 2020 5061 7468 2074 6f20 7468 6520 6d65    Path to the me
+00000f70: 7267 6573 2066 696c 652e 0a20 2020 2020  rges file..     
+00000f80: 2020 2065 7272 6f72 7320 2860 7374 7260     errors (`str`
+00000f90: 2c20 2a6f 7074 696f 6e61 6c2a 2c20 6465  , *optional*, de
+00000fa0: 6661 756c 7473 2074 6f20 6022 7265 706c  faults to `"repl
+00000fb0: 6163 6522 6029 3a0a 2020 2020 2020 2020  ace"`):.        
+00000fc0: 2020 2020 5061 7261 6469 676d 2074 6f20      Paradigm to 
+00000fd0: 666f 6c6c 6f77 2077 6865 6e20 6465 636f  follow when deco
+00000fe0: 6469 6e67 2062 7974 6573 2074 6f20 5554  ding bytes to UT
+00000ff0: 462d 382e 2053 6565 0a20 2020 2020 2020  F-8. See.       
+00001000: 2020 2020 205b 6279 7465 732e 6465 636f       [bytes.deco
+00001010: 6465 5d28 6874 7470 733a 2f2f 646f 6373  de](https://docs
+00001020: 2e70 7974 686f 6e2e 6f72 672f 332f 6c69  .python.org/3/li
+00001030: 6272 6172 792f 7374 6474 7970 6573 2e68  brary/stdtypes.h
+00001040: 746d 6c23 6279 7465 732e 6465 636f 6465  tml#bytes.decode
+00001050: 2920 666f 7220 6d6f 7265 2069 6e66 6f72  ) for more infor
+00001060: 6d61 7469 6f6e 2e0a 2020 2020 2020 2020  mation..        
+00001070: 626f 735f 746f 6b65 6e20 2860 7374 7260  bos_token (`str`
+00001080: 2c20 2a6f 7074 696f 6e61 6c2a 2c20 6465  , *optional*, de
+00001090: 6661 756c 7473 2074 6f20 6022 3c73 3e22  faults to `"<s>"
+000010a0: 6029 3a0a 2020 2020 2020 2020 2020 2020  `):.            
+000010b0: 5468 6520 6265 6769 6e6e 696e 6720 6f66  The beginning of
+000010c0: 2073 6571 7565 6e63 6520 746f 6b65 6e20   sequence token 
+000010d0: 7468 6174 2077 6173 2075 7365 6420 6475  that was used du
+000010e0: 7269 6e67 2070 7265 7472 6169 6e69 6e67  ring pretraining
+000010f0: 2e20 4361 6e20 6265 2075 7365 6420 6120  . Can be used a 
+00001100: 7365 7175 656e 6365 2063 6c61 7373 6966  sequence classif
+00001110: 6965 7220 746f 6b65 6e2e 0a0a 2020 2020  ier token...    
+00001120: 2020 2020 2020 2020 3c54 6970 3e0a 0a20          <Tip>.. 
+00001130: 2020 2020 2020 2020 2020 2057 6865 6e20             When 
+00001140: 6275 696c 6469 6e67 2061 2073 6571 7565  building a seque
+00001150: 6e63 6520 7573 696e 6720 7370 6563 6961  nce using specia
+00001160: 6c20 746f 6b65 6e73 2c20 7468 6973 2069  l tokens, this i
+00001170: 7320 6e6f 7420 7468 6520 746f 6b65 6e20  s not the token 
+00001180: 7468 6174 2069 7320 7573 6564 2066 6f72  that is used for
+00001190: 2074 6865 2062 6567 696e 6e69 6e67 206f   the beginning o
+000011a0: 660a 2020 2020 2020 2020 2020 2020 7365  f.            se
+000011b0: 7175 656e 6365 2e20 5468 6520 746f 6b65  quence. The toke
+000011c0: 6e20 7573 6564 2069 7320 7468 6520 6063  n used is the `c
+000011d0: 6c73 5f74 6f6b 656e 602e 0a0a 2020 2020  ls_token`...    
+000011e0: 2020 2020 2020 2020 3c2f 5469 703e 0a0a          </Tip>..
+000011f0: 2020 2020 2020 2020 656f 735f 746f 6b65          eos_toke
+00001200: 6e20 2860 7374 7260 2c20 2a6f 7074 696f  n (`str`, *optio
+00001210: 6e61 6c2a 2c20 6465 6661 756c 7473 2074  nal*, defaults t
+00001220: 6f20 6022 3c2f 733e 2260 293a 0a20 2020  o `"</s>"`):.   
+00001230: 2020 2020 2020 2020 2054 6865 2065 6e64           The end
+00001240: 206f 6620 7365 7175 656e 6365 2074 6f6b   of sequence tok
+00001250: 656e 2e0a 0a20 2020 2020 2020 2020 2020  en...           
+00001260: 203c 5469 703e 0a0a 2020 2020 2020 2020   <Tip>..        
+00001270: 2020 2020 5768 656e 2062 7569 6c64 696e      When buildin
+00001280: 6720 6120 7365 7175 656e 6365 2075 7369  g a sequence usi
+00001290: 6e67 2073 7065 6369 616c 2074 6f6b 656e  ng special token
+000012a0: 732c 2074 6869 7320 6973 206e 6f74 2074  s, this is not t
+000012b0: 6865 2074 6f6b 656e 2074 6861 7420 6973  he token that is
+000012c0: 2075 7365 6420 666f 7220 7468 6520 656e   used for the en
+000012d0: 6420 6f66 2073 6571 7565 6e63 652e 0a20  d of sequence.. 
+000012e0: 2020 2020 2020 2020 2020 2054 6865 2074             The t
+000012f0: 6f6b 656e 2075 7365 6420 6973 2074 6865  oken used is the
+00001300: 2060 7365 705f 746f 6b65 6e60 2e0a 0a20   `sep_token`... 
+00001310: 2020 2020 2020 2020 2020 203c 2f54 6970             </Tip
+00001320: 3e0a 0a20 2020 2020 2020 2073 6570 5f74  >..        sep_t
+00001330: 6f6b 656e 2028 6073 7472 602c 202a 6f70  oken (`str`, *op
+00001340: 7469 6f6e 616c 2a2c 2064 6566 6175 6c74  tional*, default
+00001350: 7320 746f 2060 223c 2f73 3e22 6029 3a0a  s to `"</s>"`):.
+00001360: 2020 2020 2020 2020 2020 2020 5468 6520              The 
+00001370: 7365 7061 7261 746f 7220 746f 6b65 6e2c  separator token,
+00001380: 2077 6869 6368 2069 7320 7573 6564 2077   which is used w
+00001390: 6865 6e20 6275 696c 6469 6e67 2061 2073  hen building a s
+000013a0: 6571 7565 6e63 6520 6672 6f6d 206d 756c  equence from mul
+000013b0: 7469 706c 6520 7365 7175 656e 6365 732c  tiple sequences,
+000013c0: 2065 2e67 2e20 7477 6f20 7365 7175 656e   e.g. two sequen
+000013d0: 6365 7320 666f 720a 2020 2020 2020 2020  ces for.        
+000013e0: 2020 2020 7365 7175 656e 6365 2063 6c61      sequence cla
+000013f0: 7373 6966 6963 6174 696f 6e20 6f72 2066  ssification or f
+00001400: 6f72 2061 2074 6578 7420 616e 6420 6120  or a text and a 
+00001410: 7175 6573 7469 6f6e 2066 6f72 2071 7565  question for que
+00001420: 7374 696f 6e20 616e 7377 6572 696e 672e  stion answering.
+00001430: 2049 7420 6973 2061 6c73 6f20 7573 6564   It is also used
+00001440: 2061 7320 7468 6520 6c61 7374 0a20 2020   as the last.   
+00001450: 2020 2020 2020 2020 2074 6f6b 656e 206f           token o
+00001460: 6620 6120 7365 7175 656e 6365 2062 7569  f a sequence bui
+00001470: 6c74 2077 6974 6820 7370 6563 6961 6c20  lt with special 
+00001480: 746f 6b65 6e73 2e0a 2020 2020 2020 2020  tokens..        
+00001490: 636c 735f 746f 6b65 6e20 2860 7374 7260  cls_token (`str`
+000014a0: 2c20 2a6f 7074 696f 6e61 6c2a 2c20 6465  , *optional*, de
+000014b0: 6661 756c 7473 2074 6f20 6022 3c73 3e22  faults to `"<s>"
+000014c0: 6029 3a0a 2020 2020 2020 2020 2020 2020  `):.            
+000014d0: 5468 6520 636c 6173 7369 6669 6572 2074  The classifier t
+000014e0: 6f6b 656e 2077 6869 6368 2069 7320 7573  oken which is us
+000014f0: 6564 2077 6865 6e20 646f 696e 6720 7365  ed when doing se
+00001500: 7175 656e 6365 2063 6c61 7373 6966 6963  quence classific
+00001510: 6174 696f 6e20 2863 6c61 7373 6966 6963  ation (classific
+00001520: 6174 696f 6e20 6f66 2074 6865 2077 686f  ation of the who
+00001530: 6c65 2073 6571 7565 6e63 650a 2020 2020  le sequence.    
+00001540: 2020 2020 2020 2020 696e 7374 6561 6420          instead 
+00001550: 6f66 2070 6572 2d74 6f6b 656e 2063 6c61  of per-token cla
+00001560: 7373 6966 6963 6174 696f 6e29 2e20 4974  ssification). It
+00001570: 2069 7320 7468 6520 6669 7273 7420 746f   is the first to
+00001580: 6b65 6e20 6f66 2074 6865 2073 6571 7565  ken of the seque
+00001590: 6e63 6520 7768 656e 2062 7569 6c74 2077  nce when built w
+000015a0: 6974 6820 7370 6563 6961 6c20 746f 6b65  ith special toke
+000015b0: 6e73 2e0a 2020 2020 2020 2020 756e 6b5f  ns..        unk_
+000015c0: 746f 6b65 6e20 2860 7374 7260 2c20 2a6f  token (`str`, *o
+000015d0: 7074 696f 6e61 6c2a 2c20 6465 6661 756c  ptional*, defaul
+000015e0: 7473 2074 6f20 6022 3c75 6e6b 3e22 6029  ts to `"<unk>"`)
+000015f0: 3a0a 2020 2020 2020 2020 2020 2020 5468  :.            Th
+00001600: 6520 756e 6b6e 6f77 6e20 746f 6b65 6e2e  e unknown token.
+00001610: 2041 2074 6f6b 656e 2074 6861 7420 6973   A token that is
+00001620: 206e 6f74 2069 6e20 7468 6520 766f 6361   not in the voca
+00001630: 6275 6c61 7279 2063 616e 6e6f 7420 6265  bulary cannot be
+00001640: 2063 6f6e 7665 7274 6564 2074 6f20 616e   converted to an
+00001650: 2049 4420 616e 6420 6973 2073 6574 2074   ID and is set t
+00001660: 6f20 6265 2074 6869 730a 2020 2020 2020  o be this.      
+00001670: 2020 2020 2020 746f 6b65 6e20 696e 7374        token inst
+00001680: 6561 642e 0a20 2020 2020 2020 2070 6164  ead..        pad
+00001690: 5f74 6f6b 656e 2028 6073 7472 602c 202a  _token (`str`, *
+000016a0: 6f70 7469 6f6e 616c 2a2c 2064 6566 6175  optional*, defau
+000016b0: 6c74 7320 746f 2060 223c 7061 643e 2260  lts to `"<pad>"`
+000016c0: 293a 0a20 2020 2020 2020 2020 2020 2054  ):.            T
+000016d0: 6865 2074 6f6b 656e 2075 7365 6420 666f  he token used fo
+000016e0: 7220 7061 6464 696e 672c 2066 6f72 2065  r padding, for e
+000016f0: 7861 6d70 6c65 2077 6865 6e20 6261 7463  xample when batc
+00001700: 6869 6e67 2073 6571 7565 6e63 6573 206f  hing sequences o
+00001710: 6620 6469 6666 6572 656e 7420 6c65 6e67  f different leng
+00001720: 7468 732e 0a20 2020 2020 2020 206d 6173  ths..        mas
+00001730: 6b5f 746f 6b65 6e20 2860 7374 7260 2c20  k_token (`str`, 
+00001740: 2a6f 7074 696f 6e61 6c2a 2c20 6465 6661  *optional*, defa
+00001750: 756c 7473 2074 6f20 6022 3c6d 6173 6b3e  ults to `"<mask>
+00001760: 2260 293a 0a20 2020 2020 2020 2020 2020  "`):.           
+00001770: 2054 6865 2074 6f6b 656e 2075 7365 6420   The token used 
+00001780: 666f 7220 6d61 736b 696e 6720 7661 6c75  for masking valu
+00001790: 6573 2e20 5468 6973 2069 7320 7468 6520  es. This is the 
+000017a0: 746f 6b65 6e20 7573 6564 2077 6865 6e20  token used when 
+000017b0: 7472 6169 6e69 6e67 2074 6869 7320 6d6f  training this mo
+000017c0: 6465 6c20 7769 7468 206d 6173 6b65 6420  del with masked 
+000017d0: 6c61 6e67 7561 6765 0a20 2020 2020 2020  language.       
+000017e0: 2020 2020 206d 6f64 656c 696e 672e 2054       modeling. T
+000017f0: 6869 7320 6973 2074 6865 2074 6f6b 656e  his is the token
+00001800: 2077 6869 6368 2074 6865 206d 6f64 656c   which the model
+00001810: 2077 696c 6c20 7472 7920 746f 2070 7265   will try to pre
+00001820: 6469 6374 2e0a 2020 2020 2020 2020 6164  dict..        ad
+00001830: 645f 7072 6566 6978 5f73 7061 6365 2028  d_prefix_space (
+00001840: 6062 6f6f 6c60 2c20 2a6f 7074 696f 6e61  `bool`, *optiona
+00001850: 6c2a 2c20 6465 6661 756c 7473 2074 6f20  l*, defaults to 
+00001860: 6046 616c 7365 6029 3a0a 2020 2020 2020  `False`):.      
+00001870: 2020 2020 2020 5768 6574 6865 7220 6f72        Whether or
+00001880: 206e 6f74 2074 6f20 6164 6420 616e 2069   not to add an i
+00001890: 6e69 7469 616c 2073 7061 6365 2074 6f20  nitial space to 
+000018a0: 7468 6520 696e 7075 742e 2054 6869 7320  the input. This 
+000018b0: 616c 6c6f 7773 2074 6f20 7472 6561 7420  allows to treat 
+000018c0: 7468 6520 6c65 6164 696e 6720 776f 7264  the leading word
+000018d0: 206a 7573 7420 6173 2061 6e79 0a20 2020   just as any.   
+000018e0: 2020 2020 2020 2020 206f 7468 6572 2077           other w
+000018f0: 6f72 642e 2028 426c 656e 6465 7262 6f74  ord. (Blenderbot
+00001900: 2074 6f6b 656e 697a 6572 2064 6574 6563   tokenizer detec
+00001910: 7420 6265 6769 6e6e 696e 6720 6f66 2077  t beginning of w
+00001920: 6f72 6473 2062 7920 7468 6520 7072 6563  ords by the prec
+00001930: 6564 696e 6720 7370 6163 6529 2e0a 2020  eding space)..  
+00001940: 2020 2222 220a 0a20 2020 2076 6f63 6162    """..    vocab
+00001950: 5f66 696c 6573 5f6e 616d 6573 203d 2056  _files_names = V
+00001960: 4f43 4142 5f46 494c 4553 5f4e 414d 4553  OCAB_FILES_NAMES
+00001970: 0a20 2020 206d 6f64 656c 5f69 6e70 7574  .    model_input
+00001980: 5f6e 616d 6573 203d 205b 2269 6e70 7574  _names = ["input
+00001990: 5f69 6473 222c 2022 6174 7465 6e74 696f  _ids", "attentio
+000019a0: 6e5f 6d61 736b 225d 0a0a 2020 2020 2320  n_mask"]..    # 
+000019b0: 436f 7069 6564 2066 726f 6d20 7472 616e  Copied from tran
+000019c0: 7366 6f72 6d65 7273 2e6d 6f64 656c 732e  sformers.models.
+000019d0: 726f 6265 7274 612e 746f 6b65 6e69 7a61  roberta.tokeniza
+000019e0: 7469 6f6e 5f72 6f62 6572 7461 2e52 6f62  tion_roberta.Rob
+000019f0: 6572 7461 546f 6b65 6e69 7a65 722e 5f5f  ertaTokenizer.__
+00001a00: 696e 6974 5f5f 2077 6974 6820 526f 6265  init__ with Robe
+00001a10: 7274 612d 3e42 6c65 6e64 6572 626f 742c  rta->Blenderbot,
+00001a20: 2052 6f42 4552 5461 2d3e 426c 656e 6465   RoBERTa->Blende
+00001a30: 7262 6f74 0a20 2020 2064 6566 205f 5f69  rbot.    def __i
+00001a40: 6e69 745f 5f28 0a20 2020 2020 2020 2073  nit__(.        s
+00001a50: 656c 662c 0a20 2020 2020 2020 2076 6f63  elf,.        voc
+00001a60: 6162 5f66 696c 652c 0a20 2020 2020 2020  ab_file,.       
+00001a70: 206d 6572 6765 735f 6669 6c65 2c0a 2020   merges_file,.  
+00001a80: 2020 2020 2020 6572 726f 7273 3d22 7265        errors="re
+00001a90: 706c 6163 6522 2c0a 2020 2020 2020 2020  place",.        
+00001aa0: 626f 735f 746f 6b65 6e3d 223c 733e 222c  bos_token="<s>",
+00001ab0: 0a20 2020 2020 2020 2065 6f73 5f74 6f6b  .        eos_tok
+00001ac0: 656e 3d22 3c2f 733e 222c 0a20 2020 2020  en="</s>",.     
+00001ad0: 2020 2073 6570 5f74 6f6b 656e 3d22 3c2f     sep_token="</
+00001ae0: 733e 222c 0a20 2020 2020 2020 2063 6c73  s>",.        cls
+00001af0: 5f74 6f6b 656e 3d22 3c73 3e22 2c0a 2020  _token="<s>",.  
+00001b00: 2020 2020 2020 756e 6b5f 746f 6b65 6e3d        unk_token=
+00001b10: 223c 756e 6b3e 222c 0a20 2020 2020 2020  "<unk>",.       
+00001b20: 2070 6164 5f74 6f6b 656e 3d22 3c70 6164   pad_token="<pad
+00001b30: 3e22 2c0a 2020 2020 2020 2020 6d61 736b  >",.        mask
+00001b40: 5f74 6f6b 656e 3d22 3c6d 6173 6b3e 222c  _token="<mask>",
+00001b50: 0a20 2020 2020 2020 2061 6464 5f70 7265  .        add_pre
+00001b60: 6669 785f 7370 6163 653d 4661 6c73 652c  fix_space=False,
+00001b70: 0a20 2020 2020 2020 202a 2a6b 7761 7267  .        **kwarg
+00001b80: 732c 0a20 2020 2029 3a0a 2020 2020 2020  s,.    ):.      
+00001b90: 2020 626f 735f 746f 6b65 6e20 3d20 4164    bos_token = Ad
+00001ba0: 6465 6454 6f6b 656e 2862 6f73 5f74 6f6b  dedToken(bos_tok
+00001bb0: 656e 2c20 6c73 7472 6970 3d46 616c 7365  en, lstrip=False
+00001bc0: 2c20 7273 7472 6970 3d46 616c 7365 2920  , rstrip=False) 
+00001bd0: 6966 2069 7369 6e73 7461 6e63 6528 626f  if isinstance(bo
+00001be0: 735f 746f 6b65 6e2c 2073 7472 2920 656c  s_token, str) el
+00001bf0: 7365 2062 6f73 5f74 6f6b 656e 0a20 2020  se bos_token.   
+00001c00: 2020 2020 2070 6164 5f74 6f6b 656e 203d       pad_token =
+00001c10: 2041 6464 6564 546f 6b65 6e28 7061 645f   AddedToken(pad_
+00001c20: 746f 6b65 6e2c 206c 7374 7269 703d 4661  token, lstrip=Fa
+00001c30: 6c73 652c 2072 7374 7269 703d 4661 6c73  lse, rstrip=Fals
+00001c40: 6529 2069 6620 6973 696e 7374 616e 6365  e) if isinstance
+00001c50: 2870 6164 5f74 6f6b 656e 2c20 7374 7229  (pad_token, str)
+00001c60: 2065 6c73 6520 7061 645f 746f 6b65 6e0a   else pad_token.
+00001c70: 2020 2020 2020 2020 656f 735f 746f 6b65          eos_toke
+00001c80: 6e20 3d20 4164 6465 6454 6f6b 656e 2865  n = AddedToken(e
+00001c90: 6f73 5f74 6f6b 656e 2c20 6c73 7472 6970  os_token, lstrip
+00001ca0: 3d46 616c 7365 2c20 7273 7472 6970 3d46  =False, rstrip=F
+00001cb0: 616c 7365 2920 6966 2069 7369 6e73 7461  alse) if isinsta
+00001cc0: 6e63 6528 656f 735f 746f 6b65 6e2c 2073  nce(eos_token, s
+00001cd0: 7472 2920 656c 7365 2065 6f73 5f74 6f6b  tr) else eos_tok
+00001ce0: 656e 0a20 2020 2020 2020 2075 6e6b 5f74  en.        unk_t
+00001cf0: 6f6b 656e 203d 2041 6464 6564 546f 6b65  oken = AddedToke
+00001d00: 6e28 756e 6b5f 746f 6b65 6e2c 206c 7374  n(unk_token, lst
+00001d10: 7269 703d 4661 6c73 652c 2072 7374 7269  rip=False, rstri
+00001d20: 703d 4661 6c73 6529 2069 6620 6973 696e  p=False) if isin
+00001d30: 7374 616e 6365 2875 6e6b 5f74 6f6b 656e  stance(unk_token
+00001d40: 2c20 7374 7229 2065 6c73 6520 756e 6b5f  , str) else unk_
+00001d50: 746f 6b65 6e0a 2020 2020 2020 2020 7365  token.        se
+00001d60: 705f 746f 6b65 6e20 3d20 4164 6465 6454  p_token = AddedT
+00001d70: 6f6b 656e 2873 6570 5f74 6f6b 656e 2c20  oken(sep_token, 
+00001d80: 6c73 7472 6970 3d46 616c 7365 2c20 7273  lstrip=False, rs
+00001d90: 7472 6970 3d46 616c 7365 2920 6966 2069  trip=False) if i
+00001da0: 7369 6e73 7461 6e63 6528 7365 705f 746f  sinstance(sep_to
+00001db0: 6b65 6e2c 2073 7472 2920 656c 7365 2073  ken, str) else s
+00001dc0: 6570 5f74 6f6b 656e 0a20 2020 2020 2020  ep_token.       
+00001dd0: 2063 6c73 5f74 6f6b 656e 203d 2041 6464   cls_token = Add
+00001de0: 6564 546f 6b65 6e28 636c 735f 746f 6b65  edToken(cls_toke
+00001df0: 6e2c 206c 7374 7269 703d 4661 6c73 652c  n, lstrip=False,
+00001e00: 2072 7374 7269 703d 4661 6c73 6529 2069   rstrip=False) i
+00001e10: 6620 6973 696e 7374 616e 6365 2863 6c73  f isinstance(cls
+00001e20: 5f74 6f6b 656e 2c20 7374 7229 2065 6c73  _token, str) els
+00001e30: 6520 636c 735f 746f 6b65 6e0a 0a20 2020  e cls_token..   
+00001e40: 2020 2020 2023 204d 6173 6b20 746f 6b65       # Mask toke
+00001e50: 6e20 6265 6861 7665 206c 696b 6520 6120  n behave like a 
+00001e60: 6e6f 726d 616c 2077 6f72 642c 2069 2e65  normal word, i.e
+00001e70: 2e20 696e 636c 7564 6520 7468 6520 7370  . include the sp
+00001e80: 6163 6520 6265 666f 7265 2069 740a 2020  ace before it.  
+00001e90: 2020 2020 2020 6d61 736b 5f74 6f6b 656e        mask_token
+00001ea0: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+00001eb0: 2041 6464 6564 546f 6b65 6e28 6d61 736b   AddedToken(mask
+00001ec0: 5f74 6f6b 656e 2c20 6c73 7472 6970 3d54  _token, lstrip=T
+00001ed0: 7275 652c 2072 7374 7269 703d 4661 6c73  rue, rstrip=Fals
+00001ee0: 652c 206e 6f72 6d61 6c69 7a65 643d 4661  e, normalized=Fa
+00001ef0: 6c73 6529 0a20 2020 2020 2020 2020 2020  lse).           
+00001f00: 2069 6620 6973 696e 7374 616e 6365 286d   if isinstance(m
+00001f10: 6173 6b5f 746f 6b65 6e2c 2073 7472 290a  ask_token, str).
+00001f20: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00001f30: 206d 6173 6b5f 746f 6b65 6e0a 2020 2020   mask_token.    
+00001f40: 2020 2020 290a 0a20 2020 2020 2020 2023      )..        #
+00001f50: 2074 6865 7365 2073 7065 6369 616c 2074   these special t
+00001f60: 6f6b 656e 7320 6172 6520 6e6f 7420 7061  okens are not pa
+00001f70: 7274 206f 6620 7468 6520 766f 6361 622e  rt of the vocab.
+00001f80: 6a73 6f6e 2c20 6c65 7427 7320 6164 6420  json, let's add 
+00001f90: 7468 656d 2069 6e20 7468 6520 636f 7272  them in the corr
+00001fa0: 6563 7420 6f72 6465 720a 0a20 2020 2020  ect order..     
+00001fb0: 2020 2077 6974 6820 6f70 656e 2876 6f63     with open(voc
+00001fc0: 6162 5f66 696c 652c 2065 6e63 6f64 696e  ab_file, encodin
+00001fd0: 673d 2275 7466 2d38 2229 2061 7320 766f  g="utf-8") as vo
+00001fe0: 6361 625f 6861 6e64 6c65 3a0a 2020 2020  cab_handle:.    
+00001ff0: 2020 2020 2020 2020 7365 6c66 2e65 6e63          self.enc
+00002000: 6f64 6572 203d 206a 736f 6e2e 6c6f 6164  oder = json.load
+00002010: 2876 6f63 6162 5f68 616e 646c 6529 0a20  (vocab_handle). 
+00002020: 2020 2020 2020 2073 656c 662e 6465 636f         self.deco
+00002030: 6465 7220 3d20 7b76 3a20 6b20 666f 7220  der = {v: k for 
+00002040: 6b2c 2076 2069 6e20 7365 6c66 2e65 6e63  k, v in self.enc
+00002050: 6f64 6572 2e69 7465 6d73 2829 7d0a 2020  oder.items()}.  
+00002060: 2020 2020 2020 7365 6c66 2e65 7272 6f72        self.error
+00002070: 7320 3d20 6572 726f 7273 2020 2320 686f  s = errors  # ho
+00002080: 7720 746f 2068 616e 646c 6520 6572 726f  w to handle erro
+00002090: 7273 2069 6e20 6465 636f 6469 6e67 0a20  rs in decoding. 
+000020a0: 2020 2020 2020 2073 656c 662e 6279 7465         self.byte
+000020b0: 5f65 6e63 6f64 6572 203d 2062 7974 6573  _encoder = bytes
+000020c0: 5f74 6f5f 756e 6963 6f64 6528 290a 2020  _to_unicode().  
+000020d0: 2020 2020 2020 7365 6c66 2e62 7974 655f        self.byte_
+000020e0: 6465 636f 6465 7220 3d20 7b76 3a20 6b20  decoder = {v: k 
+000020f0: 666f 7220 6b2c 2076 2069 6e20 7365 6c66  for k, v in self
+00002100: 2e62 7974 655f 656e 636f 6465 722e 6974  .byte_encoder.it
+00002110: 656d 7328 297d 0a20 2020 2020 2020 2077  ems()}.        w
+00002120: 6974 6820 6f70 656e 286d 6572 6765 735f  ith open(merges_
+00002130: 6669 6c65 2c20 656e 636f 6469 6e67 3d22  file, encoding="
+00002140: 7574 662d 3822 2920 6173 206d 6572 6765  utf-8") as merge
+00002150: 735f 6861 6e64 6c65 3a0a 2020 2020 2020  s_handle:.      
+00002160: 2020 2020 2020 6270 655f 6d65 7267 6573        bpe_merges
+00002170: 203d 206d 6572 6765 735f 6861 6e64 6c65   = merges_handle
+00002180: 2e72 6561 6428 292e 7370 6c69 7428 225c  .read().split("\
+00002190: 6e22 295b 313a 2d31 5d0a 2020 2020 2020  n")[1:-1].      
+000021a0: 2020 6270 655f 6d65 7267 6573 203d 205b    bpe_merges = [
+000021b0: 7475 706c 6528 6d65 7267 652e 7370 6c69  tuple(merge.spli
+000021c0: 7428 2929 2066 6f72 206d 6572 6765 2069  t()) for merge i
+000021d0: 6e20 6270 655f 6d65 7267 6573 5d0a 2020  n bpe_merges].  
+000021e0: 2020 2020 2020 7365 6c66 2e62 7065 5f72        self.bpe_r
+000021f0: 616e 6b73 203d 2064 6963 7428 7a69 7028  anks = dict(zip(
+00002200: 6270 655f 6d65 7267 6573 2c20 7261 6e67  bpe_merges, rang
+00002210: 6528 6c65 6e28 6270 655f 6d65 7267 6573  e(len(bpe_merges
+00002220: 2929 2929 0a20 2020 2020 2020 2073 656c  )))).        sel
+00002230: 662e 6361 6368 6520 3d20 7b7d 0a20 2020  f.cache = {}.   
+00002240: 2020 2020 2073 656c 662e 6164 645f 7072       self.add_pr
+00002250: 6566 6978 5f73 7061 6365 203d 2061 6464  efix_space = add
+00002260: 5f70 7265 6669 785f 7370 6163 650a 0a20  _prefix_space.. 
+00002270: 2020 2020 2020 2023 2053 686f 756c 6420         # Should 
+00002280: 6861 7665 2061 6464 6564 2072 652e 4947  have added re.IG
+00002290: 4e4f 5245 4341 5345 2073 6f20 4250 4520  NORECASE so BPE 
+000022a0: 6d65 7267 6573 2063 616e 2068 6170 7065  merges can happe
+000022b0: 6e20 666f 7220 6361 7069 7461 6c69 7a65  n for capitalize
+000022c0: 6420 7665 7273 696f 6e73 206f 6620 636f  d versions of co
+000022d0: 6e74 7261 6374 696f 6e73 0a20 2020 2020  ntractions.     
+000022e0: 2020 2073 656c 662e 7061 7420 3d20 7265     self.pat = re
+000022f0: 2e63 6f6d 7069 6c65 2872 2222 2227 737c  .compile(r"""'s|
+00002300: 2774 7c27 7265 7c27 7665 7c27 6d7c 276c  't|'re|'ve|'m|'l
+00002310: 6c7c 2764 7c20 3f5c 707b 4c7d 2b7c 203f  l|'d| ?\p{L}+| ?
+00002320: 5c70 7b4e 7d2b 7c20 3f5b 5e5c 735c 707b  \p{N}+| ?[^\s\p{
+00002330: 4c7d 5c70 7b4e 7d5d 2b7c 5c73 2b28 3f21  L}\p{N}]+|\s+(?!
+00002340: 5c53 297c 5c73 2b22 2222 290a 0a20 2020  \S)|\s+""")..   
+00002350: 2020 2020 2073 7570 6572 2829 2e5f 5f69       super().__i
+00002360: 6e69 745f 5f28 0a20 2020 2020 2020 2020  nit__(.         
+00002370: 2020 2065 7272 6f72 733d 6572 726f 7273     errors=errors
+00002380: 2c0a 2020 2020 2020 2020 2020 2020 626f  ,.            bo
+00002390: 735f 746f 6b65 6e3d 626f 735f 746f 6b65  s_token=bos_toke
+000023a0: 6e2c 0a20 2020 2020 2020 2020 2020 2065  n,.            e
+000023b0: 6f73 5f74 6f6b 656e 3d65 6f73 5f74 6f6b  os_token=eos_tok
+000023c0: 656e 2c0a 2020 2020 2020 2020 2020 2020  en,.            
+000023d0: 756e 6b5f 746f 6b65 6e3d 756e 6b5f 746f  unk_token=unk_to
+000023e0: 6b65 6e2c 0a20 2020 2020 2020 2020 2020  ken,.           
+000023f0: 2073 6570 5f74 6f6b 656e 3d73 6570 5f74   sep_token=sep_t
+00002400: 6f6b 656e 2c0a 2020 2020 2020 2020 2020  oken,.          
+00002410: 2020 636c 735f 746f 6b65 6e3d 636c 735f    cls_token=cls_
+00002420: 746f 6b65 6e2c 0a20 2020 2020 2020 2020  token,.         
+00002430: 2020 2070 6164 5f74 6f6b 656e 3d70 6164     pad_token=pad
+00002440: 5f74 6f6b 656e 2c0a 2020 2020 2020 2020  _token,.        
+00002450: 2020 2020 6d61 736b 5f74 6f6b 656e 3d6d      mask_token=m
+00002460: 6173 6b5f 746f 6b65 6e2c 0a20 2020 2020  ask_token,.     
+00002470: 2020 2020 2020 2061 6464 5f70 7265 6669         add_prefi
+00002480: 785f 7370 6163 653d 6164 645f 7072 6566  x_space=add_pref
+00002490: 6978 5f73 7061 6365 2c0a 2020 2020 2020  ix_space,.      
+000024a0: 2020 2020 2020 2a2a 6b77 6172 6773 2c0a        **kwargs,.
+000024b0: 2020 2020 2020 2020 290a 0a20 2020 2040          )..    @
+000024c0: 7072 6f70 6572 7479 0a20 2020 2023 2043  property.    # C
+000024d0: 6f70 6965 6420 6672 6f6d 2074 7261 6e73  opied from trans
+000024e0: 666f 726d 6572 732e 6d6f 6465 6c73 2e72  formers.models.r
+000024f0: 6f62 6572 7461 2e74 6f6b 656e 697a 6174  oberta.tokenizat
+00002500: 696f 6e5f 726f 6265 7274 612e 526f 6265  ion_roberta.Robe
+00002510: 7274 6154 6f6b 656e 697a 6572 2e76 6f63  rtaTokenizer.voc
+00002520: 6162 5f73 697a 6520 7769 7468 2052 6f62  ab_size with Rob
+00002530: 6572 7461 2d3e 426c 656e 6465 7262 6f74  erta->Blenderbot
+00002540: 2c20 526f 4245 5254 612d 3e42 6c65 6e64  , RoBERTa->Blend
+00002550: 6572 626f 740a 2020 2020 6465 6620 766f  erbot.    def vo
+00002560: 6361 625f 7369 7a65 2873 656c 6629 3a0a  cab_size(self):.
+00002570: 2020 2020 2020 2020 7265 7475 726e 206c          return l
+00002580: 656e 2873 656c 662e 656e 636f 6465 7229  en(self.encoder)
+00002590: 0a0a 2020 2020 2320 436f 7069 6564 2066  ..    # Copied f
+000025a0: 726f 6d20 7472 616e 7366 6f72 6d65 7273  rom transformers
+000025b0: 2e6d 6f64 656c 732e 726f 6265 7274 612e  .models.roberta.
+000025c0: 746f 6b65 6e69 7a61 7469 6f6e 5f72 6f62  tokenization_rob
+000025d0: 6572 7461 2e52 6f62 6572 7461 546f 6b65  erta.RobertaToke
+000025e0: 6e69 7a65 722e 6765 745f 766f 6361 6220  nizer.get_vocab 
+000025f0: 7769 7468 2052 6f62 6572 7461 2d3e 426c  with Roberta->Bl
+00002600: 656e 6465 7262 6f74 2c20 526f 4245 5254  enderbot, RoBERT
+00002610: 612d 3e42 6c65 6e64 6572 626f 740a 2020  a->Blenderbot.  
+00002620: 2020 6465 6620 6765 745f 766f 6361 6228    def get_vocab(
+00002630: 7365 6c66 293a 0a20 2020 2020 2020 2076  self):.        v
+00002640: 6f63 6162 203d 2064 6963 7428 7365 6c66  ocab = dict(self
+00002650: 2e65 6e63 6f64 6572 292e 636f 7079 2829  .encoder).copy()
+00002660: 0a20 2020 2020 2020 2076 6f63 6162 2e75  .        vocab.u
+00002670: 7064 6174 6528 7365 6c66 2e61 6464 6564  pdate(self.added
+00002680: 5f74 6f6b 656e 735f 656e 636f 6465 7229  _tokens_encoder)
+00002690: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000026a0: 766f 6361 620a 0a20 2020 2023 2043 6f70  vocab..    # Cop
+000026b0: 6965 6420 6672 6f6d 2074 7261 6e73 666f  ied from transfo
+000026c0: 726d 6572 732e 6d6f 6465 6c73 2e72 6f62  rmers.models.rob
+000026d0: 6572 7461 2e74 6f6b 656e 697a 6174 696f  erta.tokenizatio
+000026e0: 6e5f 726f 6265 7274 612e 526f 6265 7274  n_roberta.Robert
+000026f0: 6154 6f6b 656e 697a 6572 2e62 7065 2077  aTokenizer.bpe w
+00002700: 6974 6820 526f 6265 7274 612d 3e42 6c65  ith Roberta->Ble
+00002710: 6e64 6572 626f 742c 2052 6f42 4552 5461  nderbot, RoBERTa
+00002720: 2d3e 426c 656e 6465 7262 6f74 0a20 2020  ->Blenderbot.   
+00002730: 2064 6566 2062 7065 2873 656c 662c 2074   def bpe(self, t
+00002740: 6f6b 656e 293a 0a20 2020 2020 2020 2069  oken):.        i
+00002750: 6620 746f 6b65 6e20 696e 2073 656c 662e  f token in self.
+00002760: 6361 6368 653a 0a20 2020 2020 2020 2020  cache:.         
+00002770: 2020 2072 6574 7572 6e20 7365 6c66 2e63     return self.c
+00002780: 6163 6865 5b74 6f6b 656e 5d0a 2020 2020  ache[token].    
+00002790: 2020 2020 776f 7264 203d 2074 7570 6c65      word = tuple
+000027a0: 2874 6f6b 656e 290a 2020 2020 2020 2020  (token).        
+000027b0: 7061 6972 7320 3d20 6765 745f 7061 6972  pairs = get_pair
+000027c0: 7328 776f 7264 290a 0a20 2020 2020 2020  s(word)..       
+000027d0: 2069 6620 6e6f 7420 7061 6972 733a 0a20   if not pairs:. 
+000027e0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+000027f0: 6e20 746f 6b65 6e0a 0a20 2020 2020 2020  n token..       
+00002800: 2077 6869 6c65 2054 7275 653a 0a20 2020   while True:.   
+00002810: 2020 2020 2020 2020 2062 6967 7261 6d20           bigram 
+00002820: 3d20 6d69 6e28 7061 6972 732c 206b 6579  = min(pairs, key
+00002830: 3d6c 616d 6264 6120 7061 6972 3a20 7365  =lambda pair: se
+00002840: 6c66 2e62 7065 5f72 616e 6b73 2e67 6574  lf.bpe_ranks.get
+00002850: 2870 6169 722c 2066 6c6f 6174 2822 696e  (pair, float("in
+00002860: 6622 2929 290a 2020 2020 2020 2020 2020  f"))).          
+00002870: 2020 6966 2062 6967 7261 6d20 6e6f 7420    if bigram not 
+00002880: 696e 2073 656c 662e 6270 655f 7261 6e6b  in self.bpe_rank
+00002890: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+000028a0: 2020 2062 7265 616b 0a20 2020 2020 2020     break.       
+000028b0: 2020 2020 2066 6972 7374 2c20 7365 636f       first, seco
+000028c0: 6e64 203d 2062 6967 7261 6d0a 2020 2020  nd = bigram.    
+000028d0: 2020 2020 2020 2020 6e65 775f 776f 7264          new_word
+000028e0: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
+000028f0: 2020 6920 3d20 300a 2020 2020 2020 2020    i = 0.        
+00002900: 2020 2020 7768 696c 6520 6920 3c20 6c65      while i < le
+00002910: 6e28 776f 7264 293a 0a20 2020 2020 2020  n(word):.       
+00002920: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+00002930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002940: 2020 6a20 3d20 776f 7264 2e69 6e64 6578    j = word.index
+00002950: 2866 6972 7374 2c20 6929 0a20 2020 2020  (first, i).     
+00002960: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+00002970: 7420 5661 6c75 6545 7272 6f72 3a0a 2020  t ValueError:.  
+00002980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002990: 2020 6e65 775f 776f 7264 2e65 7874 656e    new_word.exten
+000029a0: 6428 776f 7264 5b69 3a5d 290a 2020 2020  d(word[i:]).    
+000029b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000029c0: 6272 6561 6b0a 2020 2020 2020 2020 2020  break.          
+000029d0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000029e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000029f0: 6e65 775f 776f 7264 2e65 7874 656e 6428  new_word.extend(
+00002a00: 776f 7264 5b69 3a6a 5d29 0a20 2020 2020  word[i:j]).     
+00002a10: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00002a20: 203d 206a 0a0a 2020 2020 2020 2020 2020   = j..          
+00002a30: 2020 2020 2020 6966 2077 6f72 645b 695d        if word[i]
+00002a40: 203d 3d20 6669 7273 7420 616e 6420 6920   == first and i 
+00002a50: 3c20 6c65 6e28 776f 7264 2920 2d20 3120  < len(word) - 1 
+00002a60: 616e 6420 776f 7264 5b69 202b 2031 5d20  and word[i + 1] 
+00002a70: 3d3d 2073 6563 6f6e 643a 0a20 2020 2020  == second:.     
+00002a80: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00002a90: 6577 5f77 6f72 642e 6170 7065 6e64 2866  ew_word.append(f
+00002aa0: 6972 7374 202b 2073 6563 6f6e 6429 0a20  irst + second). 
+00002ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002ac0: 2020 2069 202b 3d20 320a 2020 2020 2020     i += 2.      
+00002ad0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00002ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002af0: 2020 2020 6e65 775f 776f 7264 2e61 7070      new_word.app
+00002b00: 656e 6428 776f 7264 5b69 5d29 0a20 2020  end(word[i]).   
+00002b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002b20: 2069 202b 3d20 310a 2020 2020 2020 2020   i += 1.        
+00002b30: 2020 2020 6e65 775f 776f 7264 203d 2074      new_word = t
+00002b40: 7570 6c65 286e 6577 5f77 6f72 6429 0a20  uple(new_word). 
+00002b50: 2020 2020 2020 2020 2020 2077 6f72 6420             word 
+00002b60: 3d20 6e65 775f 776f 7264 0a20 2020 2020  = new_word.     
+00002b70: 2020 2020 2020 2069 6620 6c65 6e28 776f         if len(wo
+00002b80: 7264 2920 3d3d 2031 3a0a 2020 2020 2020  rd) == 1:.      
+00002b90: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
+00002ba0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00002bb0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00002bc0: 2020 7061 6972 7320 3d20 6765 745f 7061    pairs = get_pa
+00002bd0: 6972 7328 776f 7264 290a 2020 2020 2020  irs(word).      
+00002be0: 2020 776f 7264 203d 2022 2022 2e6a 6f69    word = " ".joi
+00002bf0: 6e28 776f 7264 290a 2020 2020 2020 2020  n(word).        
+00002c00: 7365 6c66 2e63 6163 6865 5b74 6f6b 656e  self.cache[token
+00002c10: 5d20 3d20 776f 7264 0a20 2020 2020 2020  ] = word.       
+00002c20: 2072 6574 7572 6e20 776f 7264 0a0a 2020   return word..  
+00002c30: 2020 2320 436f 7069 6564 2066 726f 6d20    # Copied from 
+00002c40: 7472 616e 7366 6f72 6d65 7273 2e6d 6f64  transformers.mod
+00002c50: 656c 732e 726f 6265 7274 612e 746f 6b65  els.roberta.toke
+00002c60: 6e69 7a61 7469 6f6e 5f72 6f62 6572 7461  nization_roberta
+00002c70: 2e52 6f62 6572 7461 546f 6b65 6e69 7a65  .RobertaTokenize
+00002c80: 722e 5f74 6f6b 656e 697a 6520 7769 7468  r._tokenize with
+00002c90: 2052 6f62 6572 7461 2d3e 426c 656e 6465   Roberta->Blende
+00002ca0: 7262 6f74 2c20 526f 4245 5254 612d 3e42  rbot, RoBERTa->B
+00002cb0: 6c65 6e64 6572 626f 740a 2020 2020 6465  lenderbot.    de
+00002cc0: 6620 5f74 6f6b 656e 697a 6528 7365 6c66  f _tokenize(self
+00002cd0: 2c20 7465 7874 293a 0a20 2020 2020 2020  , text):.       
+00002ce0: 2022 2222 546f 6b65 6e69 7a65 2061 2073   """Tokenize a s
+00002cf0: 7472 696e 672e 2222 220a 2020 2020 2020  tring.""".      
+00002d00: 2020 6270 655f 746f 6b65 6e73 203d 205b    bpe_tokens = [
+00002d10: 5d0a 2020 2020 2020 2020 666f 7220 746f  ].        for to
+00002d20: 6b65 6e20 696e 2072 652e 6669 6e64 616c  ken in re.findal
+00002d30: 6c28 7365 6c66 2e70 6174 2c20 7465 7874  l(self.pat, text
+00002d40: 293a 0a20 2020 2020 2020 2020 2020 2074  ):.            t
+00002d50: 6f6b 656e 203d 2022 222e 6a6f 696e 280a  oken = "".join(.
+00002d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002d70: 7365 6c66 2e62 7974 655f 656e 636f 6465  self.byte_encode
+00002d80: 725b 625d 2066 6f72 2062 2069 6e20 746f  r[b] for b in to
+00002d90: 6b65 6e2e 656e 636f 6465 2822 7574 662d  ken.encode("utf-
+00002da0: 3822 290a 2020 2020 2020 2020 2020 2020  8").            
+00002db0: 2920 2023 204d 6170 7320 616c 6c20 6f75  )  # Maps all ou
+00002dc0: 7220 6279 7465 7320 746f 2075 6e69 636f  r bytes to unico
+00002dd0: 6465 2073 7472 696e 6773 2c20 6176 6f69  de strings, avoi
+00002de0: 6469 6e67 2063 6f6e 7472 6f6c 2074 6f6b  ding control tok
+00002df0: 656e 7320 6f66 2074 6865 2042 5045 2028  ens of the BPE (
+00002e00: 7370 6163 6573 2069 6e20 6f75 7220 6361  spaces in our ca
+00002e10: 7365 290a 2020 2020 2020 2020 2020 2020  se).            
+00002e20: 6270 655f 746f 6b65 6e73 2e65 7874 656e  bpe_tokens.exten
+00002e30: 6428 6270 655f 746f 6b65 6e20 666f 7220  d(bpe_token for 
+00002e40: 6270 655f 746f 6b65 6e20 696e 2073 656c  bpe_token in sel
+00002e50: 662e 6270 6528 746f 6b65 6e29 2e73 706c  f.bpe(token).spl
+00002e60: 6974 2822 2022 2929 0a20 2020 2020 2020  it(" ")).       
+00002e70: 2072 6574 7572 6e20 6270 655f 746f 6b65   return bpe_toke
+00002e80: 6e73 0a0a 2020 2020 2320 436f 7069 6564  ns..    # Copied
+00002e90: 2066 726f 6d20 7472 616e 7366 6f72 6d65   from transforme
+00002ea0: 7273 2e6d 6f64 656c 732e 726f 6265 7274  rs.models.robert
+00002eb0: 612e 746f 6b65 6e69 7a61 7469 6f6e 5f72  a.tokenization_r
+00002ec0: 6f62 6572 7461 2e52 6f62 6572 7461 546f  oberta.RobertaTo
+00002ed0: 6b65 6e69 7a65 722e 5f63 6f6e 7665 7274  kenizer._convert
+00002ee0: 5f74 6f6b 656e 5f74 6f5f 6964 2077 6974  _token_to_id wit
+00002ef0: 6820 526f 6265 7274 612d 3e42 6c65 6e64  h Roberta->Blend
+00002f00: 6572 626f 742c 2052 6f42 4552 5461 2d3e  erbot, RoBERTa->
+00002f10: 426c 656e 6465 7262 6f74 0a20 2020 2064  Blenderbot.    d
+00002f20: 6566 205f 636f 6e76 6572 745f 746f 6b65  ef _convert_toke
+00002f30: 6e5f 746f 5f69 6428 7365 6c66 2c20 746f  n_to_id(self, to
+00002f40: 6b65 6e29 3a0a 2020 2020 2020 2020 2222  ken):.        ""
+00002f50: 2243 6f6e 7665 7274 7320 6120 746f 6b65  "Converts a toke
+00002f60: 6e20 2873 7472 2920 696e 2061 6e20 6964  n (str) in an id
+00002f70: 2075 7369 6e67 2074 6865 2076 6f63 6162   using the vocab
+00002f80: 2e22 2222 0a20 2020 2020 2020 2072 6574  .""".        ret
+00002f90: 7572 6e20 7365 6c66 2e65 6e63 6f64 6572  urn self.encoder
+00002fa0: 2e67 6574 2874 6f6b 656e 2c20 7365 6c66  .get(token, self
+00002fb0: 2e65 6e63 6f64 6572 2e67 6574 2873 656c  .encoder.get(sel
+00002fc0: 662e 756e 6b5f 746f 6b65 6e29 290a 0a20  f.unk_token)).. 
+00002fd0: 2020 2023 2043 6f70 6965 6420 6672 6f6d     # Copied from
+00002fe0: 2074 7261 6e73 666f 726d 6572 732e 6d6f   transformers.mo
+00002ff0: 6465 6c73 2e72 6f62 6572 7461 2e74 6f6b  dels.roberta.tok
+00003000: 656e 697a 6174 696f 6e5f 726f 6265 7274  enization_robert
+00003010: 612e 526f 6265 7274 6154 6f6b 656e 697a  a.RobertaTokeniz
+00003020: 6572 2e5f 636f 6e76 6572 745f 6964 5f74  er._convert_id_t
+00003030: 6f5f 746f 6b65 6e20 7769 7468 2052 6f62  o_token with Rob
+00003040: 6572 7461 2d3e 426c 656e 6465 7262 6f74  erta->Blenderbot
+00003050: 2c20 526f 4245 5254 612d 3e42 6c65 6e64  , RoBERTa->Blend
+00003060: 6572 626f 740a 2020 2020 6465 6620 5f63  erbot.    def _c
+00003070: 6f6e 7665 7274 5f69 645f 746f 5f74 6f6b  onvert_id_to_tok
+00003080: 656e 2873 656c 662c 2069 6e64 6578 293a  en(self, index):
+00003090: 0a20 2020 2020 2020 2022 2222 436f 6e76  .        """Conv
+000030a0: 6572 7473 2061 6e20 696e 6465 7820 2869  erts an index (i
+000030b0: 6e74 6567 6572 2920 696e 2061 2074 6f6b  nteger) in a tok
+000030c0: 656e 2028 7374 7229 2075 7369 6e67 2074  en (str) using t
+000030d0: 6865 2076 6f63 6162 2e22 2222 0a20 2020  he vocab.""".   
+000030e0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+000030f0: 2e64 6563 6f64 6572 2e67 6574 2869 6e64  .decoder.get(ind
+00003100: 6578 290a 0a20 2020 2023 2043 6f70 6965  ex)..    # Copie
+00003110: 6420 6672 6f6d 2074 7261 6e73 666f 726d  d from transform
+00003120: 6572 732e 6d6f 6465 6c73 2e72 6f62 6572  ers.models.rober
+00003130: 7461 2e74 6f6b 656e 697a 6174 696f 6e5f  ta.tokenization_
+00003140: 726f 6265 7274 612e 526f 6265 7274 6154  roberta.RobertaT
+00003150: 6f6b 656e 697a 6572 2e63 6f6e 7665 7274  okenizer.convert
+00003160: 5f74 6f6b 656e 735f 746f 5f73 7472 696e  _tokens_to_strin
+00003170: 6720 7769 7468 2052 6f62 6572 7461 2d3e  g with Roberta->
+00003180: 426c 656e 6465 7262 6f74 2c20 526f 4245  Blenderbot, RoBE
+00003190: 5254 612d 3e42 6c65 6e64 6572 626f 740a  RTa->Blenderbot.
+000031a0: 2020 2020 6465 6620 636f 6e76 6572 745f      def convert_
+000031b0: 746f 6b65 6e73 5f74 6f5f 7374 7269 6e67  tokens_to_string
+000031c0: 2873 656c 662c 2074 6f6b 656e 7329 3a0a  (self, tokens):.
+000031d0: 2020 2020 2020 2020 2222 2243 6f6e 7665          """Conve
+000031e0: 7274 7320 6120 7365 7175 656e 6365 206f  rts a sequence o
+000031f0: 6620 746f 6b65 6e73 2028 7374 7269 6e67  f tokens (string
+00003200: 2920 696e 2061 2073 696e 676c 6520 7374  ) in a single st
+00003210: 7269 6e67 2e22 2222 0a20 2020 2020 2020  ring.""".       
+00003220: 2074 6578 7420 3d20 2222 2e6a 6f69 6e28   text = "".join(
+00003230: 746f 6b65 6e73 290a 2020 2020 2020 2020  tokens).        
+00003240: 7465 7874 203d 2062 7974 6561 7272 6179  text = bytearray
+00003250: 285b 7365 6c66 2e62 7974 655f 6465 636f  ([self.byte_deco
+00003260: 6465 725b 635d 2066 6f72 2063 2069 6e20  der[c] for c in 
+00003270: 7465 7874 5d29 2e64 6563 6f64 6528 2275  text]).decode("u
+00003280: 7466 2d38 222c 2065 7272 6f72 733d 7365  tf-8", errors=se
+00003290: 6c66 2e65 7272 6f72 7329 0a20 2020 2020  lf.errors).     
+000032a0: 2020 2072 6574 7572 6e20 7465 7874 0a0a     return text..
+000032b0: 2020 2020 2320 436f 7069 6564 2066 726f      # Copied fro
+000032c0: 6d20 7472 616e 7366 6f72 6d65 7273 2e6d  m transformers.m
+000032d0: 6f64 656c 732e 726f 6265 7274 612e 746f  odels.roberta.to
+000032e0: 6b65 6e69 7a61 7469 6f6e 5f72 6f62 6572  kenization_rober
+000032f0: 7461 2e52 6f62 6572 7461 546f 6b65 6e69  ta.RobertaTokeni
+00003300: 7a65 722e 7361 7665 5f76 6f63 6162 756c  zer.save_vocabul
+00003310: 6172 7920 7769 7468 2052 6f62 6572 7461  ary with Roberta
+00003320: 2d3e 426c 656e 6465 7262 6f74 2c20 526f  ->Blenderbot, Ro
+00003330: 4245 5254 612d 3e42 6c65 6e64 6572 626f  BERTa->Blenderbo
+00003340: 740a 2020 2020 6465 6620 7361 7665 5f76  t.    def save_v
+00003350: 6f63 6162 756c 6172 7928 7365 6c66 2c20  ocabulary(self, 
+00003360: 7361 7665 5f64 6972 6563 746f 7279 3a20  save_directory: 
+00003370: 7374 722c 2066 696c 656e 616d 655f 7072  str, filename_pr
+00003380: 6566 6978 3a20 4f70 7469 6f6e 616c 5b73  efix: Optional[s
+00003390: 7472 5d20 3d20 4e6f 6e65 2920 2d3e 2054  tr] = None) -> T
+000033a0: 7570 6c65 5b73 7472 5d3a 0a20 2020 2020  uple[str]:.     
+000033b0: 2020 2069 6620 6e6f 7420 6f73 2e70 6174     if not os.pat
+000033c0: 682e 6973 6469 7228 7361 7665 5f64 6972  h.isdir(save_dir
+000033d0: 6563 746f 7279 293a 0a20 2020 2020 2020  ectory):.       
+000033e0: 2020 2020 206c 6f67 6765 722e 6572 726f       logger.erro
+000033f0: 7228 6622 566f 6361 6275 6c61 7279 2070  r(f"Vocabulary p
+00003400: 6174 6820 287b 7361 7665 5f64 6972 6563  ath ({save_direc
+00003410: 746f 7279 7d29 2073 686f 756c 6420 6265  tory}) should be
+00003420: 2061 2064 6972 6563 746f 7279 2229 0a20   a directory"). 
+00003430: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00003440: 6e0a 2020 2020 2020 2020 766f 6361 625f  n.        vocab_
+00003450: 6669 6c65 203d 206f 732e 7061 7468 2e6a  file = os.path.j
+00003460: 6f69 6e28 0a20 2020 2020 2020 2020 2020  oin(.           
+00003470: 2073 6176 655f 6469 7265 6374 6f72 792c   save_directory,
+00003480: 2028 6669 6c65 6e61 6d65 5f70 7265 6669   (filename_prefi
+00003490: 7820 2b20 222d 2220 6966 2066 696c 656e  x + "-" if filen
+000034a0: 616d 655f 7072 6566 6978 2065 6c73 6520  ame_prefix else 
+000034b0: 2222 2920 2b20 564f 4341 425f 4649 4c45  "") + VOCAB_FILE
+000034c0: 535f 4e41 4d45 535b 2276 6f63 6162 5f66  S_NAMES["vocab_f
+000034d0: 696c 6522 5d0a 2020 2020 2020 2020 290a  ile"].        ).
+000034e0: 2020 2020 2020 2020 6d65 7267 655f 6669          merge_fi
+000034f0: 6c65 203d 206f 732e 7061 7468 2e6a 6f69  le = os.path.joi
+00003500: 6e28 0a20 2020 2020 2020 2020 2020 2073  n(.            s
+00003510: 6176 655f 6469 7265 6374 6f72 792c 2028  ave_directory, (
+00003520: 6669 6c65 6e61 6d65 5f70 7265 6669 7820  filename_prefix 
+00003530: 2b20 222d 2220 6966 2066 696c 656e 616d  + "-" if filenam
+00003540: 655f 7072 6566 6978 2065 6c73 6520 2222  e_prefix else ""
+00003550: 2920 2b20 564f 4341 425f 4649 4c45 535f  ) + VOCAB_FILES_
+00003560: 4e41 4d45 535b 226d 6572 6765 735f 6669  NAMES["merges_fi
+00003570: 6c65 225d 0a20 2020 2020 2020 2029 0a0a  le"].        )..
+00003580: 2020 2020 2020 2020 7769 7468 206f 7065          with ope
+00003590: 6e28 766f 6361 625f 6669 6c65 2c20 2277  n(vocab_file, "w
+000035a0: 222c 2065 6e63 6f64 696e 673d 2275 7466  ", encoding="utf
+000035b0: 2d38 2229 2061 7320 663a 0a20 2020 2020  -8") as f:.     
+000035c0: 2020 2020 2020 2066 2e77 7269 7465 286a         f.write(j
+000035d0: 736f 6e2e 6475 6d70 7328 7365 6c66 2e65  son.dumps(self.e
+000035e0: 6e63 6f64 6572 2c20 696e 6465 6e74 3d32  ncoder, indent=2
+000035f0: 2c20 736f 7274 5f6b 6579 733d 5472 7565  , sort_keys=True
+00003600: 2c20 656e 7375 7265 5f61 7363 6969 3d46  , ensure_ascii=F
+00003610: 616c 7365 2920 2b20 225c 6e22 290a 0a20  alse) + "\n").. 
+00003620: 2020 2020 2020 2069 6e64 6578 203d 2030         index = 0
+00003630: 0a20 2020 2020 2020 2077 6974 6820 6f70  .        with op
+00003640: 656e 286d 6572 6765 5f66 696c 652c 2022  en(merge_file, "
+00003650: 7722 2c20 656e 636f 6469 6e67 3d22 7574  w", encoding="ut
+00003660: 662d 3822 2920 6173 2077 7269 7465 723a  f-8") as writer:
+00003670: 0a20 2020 2020 2020 2020 2020 2077 7269  .            wri
+00003680: 7465 722e 7772 6974 6528 2223 7665 7273  ter.write("#vers
+00003690: 696f 6e3a 2030 2e32 5c6e 2229 0a20 2020  ion: 0.2\n").   
+000036a0: 2020 2020 2020 2020 2066 6f72 2062 7065           for bpe
+000036b0: 5f74 6f6b 656e 732c 2074 6f6b 656e 5f69  _tokens, token_i
+000036c0: 6e64 6578 2069 6e20 736f 7274 6564 2873  ndex in sorted(s
+000036d0: 656c 662e 6270 655f 7261 6e6b 732e 6974  elf.bpe_ranks.it
+000036e0: 656d 7328 292c 206b 6579 3d6c 616d 6264  ems(), key=lambd
+000036f0: 6120 6b76 3a20 6b76 5b31 5d29 3a0a 2020  a kv: kv[1]):.  
+00003700: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00003710: 2069 6e64 6578 2021 3d20 746f 6b65 6e5f   index != token_
+00003720: 696e 6465 783a 0a20 2020 2020 2020 2020  index:.         
+00003730: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+00003740: 722e 7761 726e 696e 6728 0a20 2020 2020  r.warning(.     
+00003750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003760: 2020 2066 2253 6176 696e 6720 766f 6361     f"Saving voca
+00003770: 6275 6c61 7279 2074 6f20 7b6d 6572 6765  bulary to {merge
+00003780: 5f66 696c 657d 3a20 4250 4520 6d65 7267  _file}: BPE merg
+00003790: 6520 696e 6469 6365 7320 6172 6520 6e6f  e indices are no
+000037a0: 7420 636f 6e73 6563 7574 6976 652e 220a  t consecutive.".
+000037b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000037c0: 2020 2020 2020 2020 2220 506c 6561 7365          " Please
+000037d0: 2063 6865 636b 2074 6861 7420 7468 6520   check that the 
+000037e0: 746f 6b65 6e69 7a65 7220 6973 206e 6f74  tokenizer is not
+000037f0: 2063 6f72 7275 7074 6564 2122 0a20 2020   corrupted!".   
+00003800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003810: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00003820: 2020 2020 2020 2069 6e64 6578 203d 2074         index = t
+00003830: 6f6b 656e 5f69 6e64 6578 0a20 2020 2020  oken_index.     
+00003840: 2020 2020 2020 2020 2020 2077 7269 7465             write
+00003850: 722e 7772 6974 6528 2220 222e 6a6f 696e  r.write(" ".join
+00003860: 2862 7065 5f74 6f6b 656e 7329 202b 2022  (bpe_tokens) + "
+00003870: 5c6e 2229 0a20 2020 2020 2020 2020 2020  \n").           
+00003880: 2020 2020 2069 6e64 6578 202b 3d20 310a       index += 1.
+00003890: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000038a0: 766f 6361 625f 6669 6c65 2c20 6d65 7267  vocab_file, merg
+000038b0: 655f 6669 6c65 0a0a 2020 2020 2320 436f  e_file..    # Co
+000038c0: 7069 6564 2066 726f 6d20 7472 616e 7366  pied from transf
+000038d0: 6f72 6d65 7273 2e6d 6f64 656c 732e 726f  ormers.models.ro
+000038e0: 6265 7274 612e 746f 6b65 6e69 7a61 7469  berta.tokenizati
+000038f0: 6f6e 5f72 6f62 6572 7461 2e52 6f62 6572  on_roberta.Rober
+00003900: 7461 546f 6b65 6e69 7a65 722e 6765 745f  taTokenizer.get_
+00003910: 7370 6563 6961 6c5f 746f 6b65 6e73 5f6d  special_tokens_m
+00003920: 6173 6b20 7769 7468 2052 6f62 6572 7461  ask with Roberta
+00003930: 2d3e 426c 656e 6465 7262 6f74 2c20 526f  ->Blenderbot, Ro
+00003940: 4245 5254 612d 3e42 6c65 6e64 6572 626f  BERTa->Blenderbo
+00003950: 740a 2020 2020 6465 6620 6765 745f 7370  t.    def get_sp
+00003960: 6563 6961 6c5f 746f 6b65 6e73 5f6d 6173  ecial_tokens_mas
+00003970: 6b28 0a20 2020 2020 2020 2073 656c 662c  k(.        self,
+00003980: 2074 6f6b 656e 5f69 6473 5f30 3a20 4c69   token_ids_0: Li
+00003990: 7374 5b69 6e74 5d2c 2074 6f6b 656e 5f69  st[int], token_i
+000039a0: 6473 5f31 3a20 4f70 7469 6f6e 616c 5b4c  ds_1: Optional[L
+000039b0: 6973 745b 696e 745d 5d20 3d20 4e6f 6e65  ist[int]] = None
+000039c0: 2c20 616c 7265 6164 795f 6861 735f 7370  , already_has_sp
+000039d0: 6563 6961 6c5f 746f 6b65 6e73 3a20 626f  ecial_tokens: bo
+000039e0: 6f6c 203d 2046 616c 7365 0a20 2020 2029  ol = False.    )
+000039f0: 202d 3e20 4c69 7374 5b69 6e74 5d3a 0a20   -> List[int]:. 
+00003a00: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00003a10: 2020 2052 6574 7269 6576 6520 7365 7175     Retrieve sequ
+00003a20: 656e 6365 2069 6473 2066 726f 6d20 6120  ence ids from a 
+00003a30: 746f 6b65 6e20 6c69 7374 2074 6861 7420  token list that 
+00003a40: 6861 7320 6e6f 2073 7065 6369 616c 2074  has no special t
+00003a50: 6f6b 656e 7320 6164 6465 642e 2054 6869  okens added. Thi
+00003a60: 7320 6d65 7468 6f64 2069 7320 6361 6c6c  s method is call
+00003a70: 6564 2077 6865 6e20 6164 6469 6e67 0a20  ed when adding. 
+00003a80: 2020 2020 2020 2073 7065 6369 616c 2074         special t
+00003a90: 6f6b 656e 7320 7573 696e 6720 7468 6520  okens using the 
+00003aa0: 746f 6b65 6e69 7a65 7220 6070 7265 7061  tokenizer `prepa
+00003ab0: 7265 5f66 6f72 5f6d 6f64 656c 6020 6d65  re_for_model` me
+00003ac0: 7468 6f64 2e0a 0a20 2020 2020 2020 2041  thod...        A
+00003ad0: 7267 733a 0a20 2020 2020 2020 2020 2020  rgs:.           
+00003ae0: 2074 6f6b 656e 5f69 6473 5f30 2028 604c   token_ids_0 (`L
+00003af0: 6973 745b 696e 745d 6029 3a0a 2020 2020  ist[int]`):.    
+00003b00: 2020 2020 2020 2020 2020 2020 4c69 7374              List
+00003b10: 206f 6620 4944 732e 0a20 2020 2020 2020   of IDs..       
+00003b20: 2020 2020 2074 6f6b 656e 5f69 6473 5f31       token_ids_1
+00003b30: 2028 604c 6973 745b 696e 745d 602c 202a   (`List[int]`, *
+00003b40: 6f70 7469 6f6e 616c 2a29 3a0a 2020 2020  optional*):.    
+00003b50: 2020 2020 2020 2020 2020 2020 4f70 7469              Opti
+00003b60: 6f6e 616c 2073 6563 6f6e 6420 6c69 7374  onal second list
+00003b70: 206f 6620 4944 7320 666f 7220 7365 7175   of IDs for sequ
+00003b80: 656e 6365 2070 6169 7273 2e0a 2020 2020  ence pairs..    
+00003b90: 2020 2020 2020 2020 616c 7265 6164 795f          already_
+00003ba0: 6861 735f 7370 6563 6961 6c5f 746f 6b65  has_special_toke
+00003bb0: 6e73 2028 6062 6f6f 6c60 2c20 2a6f 7074  ns (`bool`, *opt
+00003bc0: 696f 6e61 6c2a 2c20 6465 6661 756c 7473  ional*, defaults
+00003bd0: 2074 6f20 6046 616c 7365 6029 3a0a 2020   to `False`):.  
+00003be0: 2020 2020 2020 2020 2020 2020 2020 5768                Wh
+00003bf0: 6574 6865 7220 6f72 206e 6f74 2074 6865  ether or not the
+00003c00: 2074 6f6b 656e 206c 6973 7420 6973 2061   token list is a
+00003c10: 6c72 6561 6479 2066 6f72 6d61 7474 6564  lready formatted
+00003c20: 2077 6974 6820 7370 6563 6961 6c20 746f   with special to
+00003c30: 6b65 6e73 2066 6f72 2074 6865 206d 6f64  kens for the mod
+00003c40: 656c 2e0a 0a20 2020 2020 2020 2052 6574  el...        Ret
+00003c50: 7572 6e73 3a0a 2020 2020 2020 2020 2020  urns:.          
+00003c60: 2020 604c 6973 745b 696e 745d 603a 2041    `List[int]`: A
+00003c70: 206c 6973 7420 6f66 2069 6e74 6567 6572   list of integer
+00003c80: 7320 696e 2074 6865 2072 616e 6765 205b  s in the range [
+00003c90: 302c 2031 5d3a 2031 2066 6f72 2061 2073  0, 1]: 1 for a s
+00003ca0: 7065 6369 616c 2074 6f6b 656e 2c20 3020  pecial token, 0 
+00003cb0: 666f 7220 6120 7365 7175 656e 6365 2074  for a sequence t
+00003cc0: 6f6b 656e 2e0a 2020 2020 2020 2020 2222  oken..        ""
+00003cd0: 220a 2020 2020 2020 2020 6966 2061 6c72  ".        if alr
+00003ce0: 6561 6479 5f68 6173 5f73 7065 6369 616c  eady_has_special
+00003cf0: 5f74 6f6b 656e 733a 0a20 2020 2020 2020  _tokens:.       
+00003d00: 2020 2020 2072 6574 7572 6e20 7375 7065       return supe
+00003d10: 7228 292e 6765 745f 7370 6563 6961 6c5f  r().get_special_
+00003d20: 746f 6b65 6e73 5f6d 6173 6b28 0a20 2020  tokens_mask(.   
+00003d30: 2020 2020 2020 2020 2020 2020 2074 6f6b               tok
+00003d40: 656e 5f69 6473 5f30 3d74 6f6b 656e 5f69  en_ids_0=token_i
+00003d50: 6473 5f30 2c20 746f 6b65 6e5f 6964 735f  ds_0, token_ids_
+00003d60: 313d 746f 6b65 6e5f 6964 735f 312c 2061  1=token_ids_1, a
+00003d70: 6c72 6561 6479 5f68 6173 5f73 7065 6369  lready_has_speci
+00003d80: 616c 5f74 6f6b 656e 733d 5472 7565 0a20  al_tokens=True. 
+00003d90: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00003da0: 2020 2020 2020 6966 2074 6f6b 656e 5f69        if token_i
+00003db0: 6473 5f31 2069 7320 4e6f 6e65 3a0a 2020  ds_1 is None:.  
+00003dc0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00003dd0: 205b 315d 202b 2028 5b30 5d20 2a20 6c65   [1] + ([0] * le
+00003de0: 6e28 746f 6b65 6e5f 6964 735f 3029 2920  n(token_ids_0)) 
+00003df0: 2b20 5b31 5d0a 2020 2020 2020 2020 7265  + [1].        re
+00003e00: 7475 726e 205b 315d 202b 2028 5b30 5d20  turn [1] + ([0] 
+00003e10: 2a20 6c65 6e28 746f 6b65 6e5f 6964 735f  * len(token_ids_
+00003e20: 3029 2920 2b20 5b31 2c20 315d 202b 2028  0)) + [1, 1] + (
+00003e30: 5b30 5d20 2a20 6c65 6e28 746f 6b65 6e5f  [0] * len(token_
+00003e40: 6964 735f 3129 2920 2b20 5b31 5d0a 0a20  ids_1)) + [1].. 
+00003e50: 2020 2023 2043 6f70 6965 6420 6672 6f6d     # Copied from
+00003e60: 2074 7261 6e73 666f 726d 6572 732e 6d6f   transformers.mo
+00003e70: 6465 6c73 2e72 6f62 6572 7461 2e74 6f6b  dels.roberta.tok
+00003e80: 656e 697a 6174 696f 6e5f 726f 6265 7274  enization_robert
+00003e90: 612e 526f 6265 7274 6154 6f6b 656e 697a  a.RobertaTokeniz
+00003ea0: 6572 2e63 7265 6174 655f 746f 6b65 6e5f  er.create_token_
+00003eb0: 7479 7065 5f69 6473 5f66 726f 6d5f 7365  type_ids_from_se
+00003ec0: 7175 656e 6365 7320 7769 7468 2052 6f62  quences with Rob
+00003ed0: 6572 7461 2d3e 426c 656e 6465 7262 6f74  erta->Blenderbot
+00003ee0: 2c20 526f 4245 5254 612d 3e42 6c65 6e64  , RoBERTa->Blend
+00003ef0: 6572 626f 740a 2020 2020 6465 6620 6372  erbot.    def cr
+00003f00: 6561 7465 5f74 6f6b 656e 5f74 7970 655f  eate_token_type_
+00003f10: 6964 735f 6672 6f6d 5f73 6571 7565 6e63  ids_from_sequenc
+00003f20: 6573 280a 2020 2020 2020 2020 7365 6c66  es(.        self
+00003f30: 2c20 746f 6b65 6e5f 6964 735f 303a 204c  , token_ids_0: L
+00003f40: 6973 745b 696e 745d 2c20 746f 6b65 6e5f  ist[int], token_
+00003f50: 6964 735f 313a 204f 7074 696f 6e61 6c5b  ids_1: Optional[
+00003f60: 4c69 7374 5b69 6e74 5d5d 203d 204e 6f6e  List[int]] = Non
+00003f70: 650a 2020 2020 2920 2d3e 204c 6973 745b  e.    ) -> List[
+00003f80: 696e 745d 3a0a 2020 2020 2020 2020 2222  int]:.        ""
+00003f90: 220a 2020 2020 2020 2020 4372 6561 7465  ".        Create
+00003fa0: 2061 206d 6173 6b20 6672 6f6d 2074 6865   a mask from the
+00003fb0: 2074 776f 2073 6571 7565 6e63 6573 2070   two sequences p
+00003fc0: 6173 7365 6420 746f 2062 6520 7573 6564  assed to be used
+00003fd0: 2069 6e20 6120 7365 7175 656e 6365 2d70   in a sequence-p
+00003fe0: 6169 7220 636c 6173 7369 6669 6361 7469  air classificati
+00003ff0: 6f6e 2074 6173 6b2e 2042 6c65 6e64 6572  on task. Blender
+00004000: 626f 7420 646f 6573 206e 6f74 0a20 2020  bot does not.   
+00004010: 2020 2020 206d 616b 6520 7573 6520 6f66       make use of
+00004020: 2074 6f6b 656e 2074 7970 6520 6964 732c   token type ids,
+00004030: 2074 6865 7265 666f 7265 2061 206c 6973   therefore a lis
+00004040: 7420 6f66 207a 6572 6f73 2069 7320 7265  t of zeros is re
+00004050: 7475 726e 6564 2e0a 0a20 2020 2020 2020  turned...       
+00004060: 2041 7267 733a 0a20 2020 2020 2020 2020   Args:.         
+00004070: 2020 2074 6f6b 656e 5f69 6473 5f30 2028     token_ids_0 (
+00004080: 604c 6973 745b 696e 745d 6029 3a0a 2020  `List[int]`):.  
+00004090: 2020 2020 2020 2020 2020 2020 2020 4c69                Li
+000040a0: 7374 206f 6620 4944 732e 0a20 2020 2020  st of IDs..     
+000040b0: 2020 2020 2020 2074 6f6b 656e 5f69 6473         token_ids
+000040c0: 5f31 2028 604c 6973 745b 696e 745d 602c  _1 (`List[int]`,
+000040d0: 202a 6f70 7469 6f6e 616c 2a29 3a0a 2020   *optional*):.  
+000040e0: 2020 2020 2020 2020 2020 2020 2020 4f70                Op
+000040f0: 7469 6f6e 616c 2073 6563 6f6e 6420 6c69  tional second li
+00004100: 7374 206f 6620 4944 7320 666f 7220 7365  st of IDs for se
+00004110: 7175 656e 6365 2070 6169 7273 2e0a 0a20  quence pairs... 
+00004120: 2020 2020 2020 2052 6574 7572 6e73 3a0a         Returns:.
+00004130: 2020 2020 2020 2020 2020 2020 604c 6973              `Lis
+00004140: 745b 696e 745d 603a 204c 6973 7420 6f66  t[int]`: List of
+00004150: 207a 6572 6f73 2e0a 2020 2020 2020 2020   zeros..        
+00004160: 2222 220a 2020 2020 2020 2020 7365 7020  """.        sep 
+00004170: 3d20 5b73 656c 662e 7365 705f 746f 6b65  = [self.sep_toke
+00004180: 6e5f 6964 5d0a 2020 2020 2020 2020 636c  n_id].        cl
+00004190: 7320 3d20 5b73 656c 662e 636c 735f 746f  s = [self.cls_to
+000041a0: 6b65 6e5f 6964 5d0a 0a20 2020 2020 2020  ken_id]..       
+000041b0: 2069 6620 746f 6b65 6e5f 6964 735f 3120   if token_ids_1 
+000041c0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+000041d0: 2020 2020 2072 6574 7572 6e20 6c65 6e28       return len(
+000041e0: 636c 7320 2b20 746f 6b65 6e5f 6964 735f  cls + token_ids_
+000041f0: 3020 2b20 7365 7029 202a 205b 305d 0a20  0 + sep) * [0]. 
+00004200: 2020 2020 2020 2072 6574 7572 6e20 6c65         return le
+00004210: 6e28 636c 7320 2b20 746f 6b65 6e5f 6964  n(cls + token_id
+00004220: 735f 3020 2b20 7365 7020 2b20 7365 7020  s_0 + sep + sep 
+00004230: 2b20 746f 6b65 6e5f 6964 735f 3120 2b20  + token_ids_1 + 
+00004240: 7365 7029 202a 205b 305d 0a0a 2020 2020  sep) * [0]..    
+00004250: 2320 436f 7069 6564 2066 726f 6d20 7472  # Copied from tr
+00004260: 616e 7366 6f72 6d65 7273 2e6d 6f64 656c  ansformers.model
+00004270: 732e 726f 6265 7274 612e 746f 6b65 6e69  s.roberta.tokeni
+00004280: 7a61 7469 6f6e 5f72 6f62 6572 7461 2e52  zation_roberta.R
+00004290: 6f62 6572 7461 546f 6b65 6e69 7a65 722e  obertaTokenizer.
+000042a0: 7072 6570 6172 655f 666f 725f 746f 6b65  prepare_for_toke
+000042b0: 6e69 7a61 7469 6f6e 2077 6974 6820 526f  nization with Ro
+000042c0: 6265 7274 612d 3e42 6c65 6e64 6572 626f  berta->Blenderbo
+000042d0: 742c 2052 6f42 4552 5461 2d3e 426c 656e  t, RoBERTa->Blen
+000042e0: 6465 7262 6f74 0a20 2020 2064 6566 2070  derbot.    def p
+000042f0: 7265 7061 7265 5f66 6f72 5f74 6f6b 656e  repare_for_token
+00004300: 697a 6174 696f 6e28 7365 6c66 2c20 7465  ization(self, te
+00004310: 7874 2c20 6973 5f73 706c 6974 5f69 6e74  xt, is_split_int
+00004320: 6f5f 776f 7264 733d 4661 6c73 652c 202a  o_words=False, *
+00004330: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
+00004340: 2020 6164 645f 7072 6566 6978 5f73 7061    add_prefix_spa
+00004350: 6365 203d 206b 7761 7267 732e 706f 7028  ce = kwargs.pop(
+00004360: 2261 6464 5f70 7265 6669 785f 7370 6163  "add_prefix_spac
+00004370: 6522 2c20 7365 6c66 2e61 6464 5f70 7265  e", self.add_pre
+00004380: 6669 785f 7370 6163 6529 0a20 2020 2020  fix_space).     
+00004390: 2020 2069 6620 2869 735f 7370 6c69 745f     if (is_split_
+000043a0: 696e 746f 5f77 6f72 6473 206f 7220 6164  into_words or ad
+000043b0: 645f 7072 6566 6978 5f73 7061 6365 2920  d_prefix_space) 
+000043c0: 616e 6420 286c 656e 2874 6578 7429 203e  and (len(text) >
+000043d0: 2030 2061 6e64 206e 6f74 2074 6578 745b   0 and not text[
+000043e0: 305d 2e69 7373 7061 6365 2829 293a 0a20  0].isspace()):. 
+000043f0: 2020 2020 2020 2020 2020 2074 6578 7420             text 
+00004400: 3d20 2220 2220 2b20 7465 7874 0a20 2020  = " " + text.   
+00004410: 2020 2020 2072 6574 7572 6e20 2874 6578       return (tex
+00004420: 742c 206b 7761 7267 7329 0a0a 2020 2020  t, kwargs)..    
+00004430: 6465 6620 6275 696c 645f 696e 7075 7473  def build_inputs
+00004440: 5f77 6974 685f 7370 6563 6961 6c5f 746f  _with_special_to
+00004450: 6b65 6e73 2873 656c 662c 2074 6f6b 656e  kens(self, token
+00004460: 5f69 6473 5f30 3a20 4c69 7374 5b69 6e74  _ids_0: List[int
+00004470: 5d2c 2074 6f6b 656e 5f69 6473 5f31 3a20  ], token_ids_1: 
+00004480: 4f70 7469 6f6e 616c 5b4c 6973 745b 696e  Optional[List[in
+00004490: 745d 5d20 3d20 4e6f 6e65 293a 0a20 2020  t]] = None):.   
+000044a0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+000044b0: 2042 7569 6c64 206d 6f64 656c 2069 6e70   Build model inp
+000044c0: 7574 7320 6672 6f6d 2061 2073 6571 7565  uts from a seque
+000044d0: 6e63 6520 6f72 2061 2070 6169 7220 6f66  nce or a pair of
+000044e0: 2073 6571 7565 6e63 6520 666f 7220 7365   sequence for se
+000044f0: 7175 656e 6365 2063 6c61 7373 6966 6963  quence classific
+00004500: 6174 696f 6e20 7461 736b 7320 6279 2063  ation tasks by c
+00004510: 6f6e 6361 7465 6e61 7469 6e67 2061 6e64  oncatenating and
+00004520: 0a20 2020 2020 2020 2061 6464 696e 6720  .        adding 
+00004530: 7370 6563 6961 6c20 746f 6b65 6e73 2e20  special tokens. 
+00004540: 4120 426c 656e 6465 7262 6f74 2073 6571  A Blenderbot seq
+00004550: 7565 6e63 6520 6861 7320 7468 6520 666f  uence has the fo
+00004560: 6c6c 6f77 696e 6720 666f 726d 6174 3a0a  llowing format:.
+00004570: 2020 2020 2020 2020 2d20 7369 6e67 6c65          - single
+00004580: 2073 6571 7565 6e63 653a 2060 2058 203c   sequence: ` X <
+00004590: 2f73 3e60 0a0a 2020 2020 2020 2020 4172  /s>`..        Ar
+000045a0: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
+000045b0: 746f 6b65 6e5f 6964 735f 3020 2860 4c69  token_ids_0 (`Li
+000045c0: 7374 5b69 6e74 5d60 293a 0a20 2020 2020  st[int]`):.     
+000045d0: 2020 2020 2020 2020 2020 204c 6973 7420             List 
+000045e0: 6f66 2049 4473 2074 6f20 7768 6963 6820  of IDs to which 
+000045f0: 7468 6520 7370 6563 6961 6c20 746f 6b65  the special toke
+00004600: 6e73 2077 696c 6c20 6265 2061 6464 6564  ns will be added
+00004610: 0a20 2020 2020 2020 2020 2020 2074 6f6b  .            tok
+00004620: 656e 5f69 6473 5f31 2028 604c 6973 745b  en_ids_1 (`List[
+00004630: 696e 745d 602c 202a 6f70 7469 6f6e 616c  int]`, *optional
+00004640: 2a29 3a0a 2020 2020 2020 2020 2020 2020  *):.            
+00004650: 2020 2020 5769 6c6c 2062 6520 6967 6e6f      Will be igno
+00004660: 7265 640a 2020 2020 2020 2020 5265 7475  red.        Retu
+00004670: 726e 733a 0a20 2020 2020 2020 2020 2020  rns:.           
+00004680: 2060 4c69 7374 5b69 6e74 5d60 3a20 6c69   `List[int]`: li
+00004690: 7374 206f 6620 5b69 6e70 7574 2049 4473  st of [input IDs
+000046a0: 5d28 2e2e 2f67 6c6f 7373 6172 7923 696e  ](../glossary#in
+000046b0: 7075 742d 6964 7329 2077 6974 6820 7468  put-ids) with th
+000046c0: 6520 6170 7072 6f70 7269 6174 6520 7370  e appropriate sp
+000046d0: 6563 6961 6c20 746f 6b65 6e73 2e0a 2020  ecial tokens..  
+000046e0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+000046f0: 2020 7265 7475 726e 2074 6f6b 656e 5f69    return token_i
+00004700: 6473 5f30 202b 205b 7365 6c66 2e65 6f73  ds_0 + [self.eos
+00004710: 5f74 6f6b 656e 5f69 645d 0a0a 2020 2020  _token_id]..    
+00004720: 4070 726f 7065 7274 790a 2020 2020 6465  @property.    de
+00004730: 6620 6465 6661 756c 745f 6368 6174 5f74  f default_chat_t
+00004740: 656d 706c 6174 6528 7365 6c66 293a 0a20  emplate(self):. 
+00004750: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00004760: 2020 2041 2076 6572 7920 7369 6d70 6c65     A very simple
+00004770: 2063 6861 7420 7465 6d70 6c61 7465 2074   chat template t
+00004780: 6861 7420 6a75 7374 2061 6464 7320 7768  hat just adds wh
+00004790: 6974 6573 7061 6365 2062 6574 7765 656e  itespace between
+000047a0: 206d 6573 7361 6765 732e 0a20 2020 2020   messages..     
+000047b0: 2020 2022 2222 0a20 2020 2020 2020 206c     """.        l
+000047c0: 6f67 6765 722e 7761 726e 696e 675f 6f6e  ogger.warning_on
+000047d0: 6365 280a 2020 2020 2020 2020 2020 2020  ce(.            
+000047e0: 225c 6e4e 6f20 6368 6174 2074 656d 706c  "\nNo chat templ
+000047f0: 6174 6520 6973 2064 6566 696e 6564 2066  ate is defined f
+00004800: 6f72 2074 6869 7320 746f 6b65 6e69 7a65  or this tokenize
+00004810: 7220 2d20 7573 696e 6720 7468 6520 6465  r - using the de
+00004820: 6661 756c 7420 7465 6d70 6c61 7465 2022  fault template "
+00004830: 0a20 2020 2020 2020 2020 2020 2066 2266  .            f"f
+00004840: 6f72 2074 6865 207b 7365 6c66 2e5f 5f63  or the {self.__c
+00004850: 6c61 7373 5f5f 2e5f 5f6e 616d 655f 5f7d  lass__.__name__}
+00004860: 2063 6c61 7373 2e20 4966 2074 6865 2064   class. If the d
+00004870: 6566 6175 6c74 2069 7320 6e6f 7420 6170  efault is not ap
+00004880: 7072 6f70 7269 6174 6520 666f 7220 220a  propriate for ".
+00004890: 2020 2020 2020 2020 2020 2020 2279 6f75              "you
+000048a0: 7220 6d6f 6465 6c2c 2070 6c65 6173 6520  r model, please 
+000048b0: 7365 7420 6074 6f6b 656e 697a 6572 2e63  set `tokenizer.c
+000048c0: 6861 745f 7465 6d70 6c61 7465 6020 746f  hat_template` to
+000048d0: 2061 6e20 6170 7072 6f70 7269 6174 6520   an appropriate 
+000048e0: 7465 6d70 6c61 7465 2e20 220a 2020 2020  template. ".    
+000048f0: 2020 2020 2020 2020 2253 6565 2068 7474          "See htt
+00004900: 7073 3a2f 2f68 7567 6769 6e67 6661 6365  ps://huggingface
+00004910: 2e63 6f2f 646f 6373 2f74 7261 6e73 666f  .co/docs/transfo
+00004920: 726d 6572 732f 6d61 696e 2f63 6861 745f  rmers/main/chat_
+00004930: 7465 6d70 6c61 7469 6e67 2066 6f72 206d  templating for m
+00004940: 6f72 6520 696e 666f 726d 6174 696f 6e2e  ore information.
+00004950: 5c6e 220a 2020 2020 2020 2020 290a 2020  \n".        ).  
+00004960: 2020 2020 2020 7265 7475 726e 2028 0a20        return (. 
+00004970: 2020 2020 2020 2020 2020 2022 7b25 2066             "{% f
+00004980: 6f72 206d 6573 7361 6765 2069 6e20 6d65  or message in me
+00004990: 7373 6167 6573 2025 7d22 0a20 2020 2020  ssages %}".     
+000049a0: 2020 2020 2020 2022 7b25 2069 6620 6d65         "{% if me
+000049b0: 7373 6167 655b 2772 6f6c 6527 5d20 3d3d  ssage['role'] ==
+000049c0: 2027 7573 6572 2720 257d 7b7b 2027 2027   'user' %}{{ ' '
+000049d0: 207d 7d7b 2520 656e 6469 6620 257d 220a   }}{% endif %}".
+000049e0: 2020 2020 2020 2020 2020 2020 227b 7b20              "{{ 
+000049f0: 6d65 7373 6167 655b 2763 6f6e 7465 6e74  message['content
+00004a00: 275d 207d 7d22 0a20 2020 2020 2020 2020  '] }}".         
+00004a10: 2020 2022 7b25 2069 6620 6e6f 7420 6c6f     "{% if not lo
+00004a20: 6f70 2e6c 6173 7420 257d 7b7b 2027 2020  op.last %}{{ '  
+00004a30: 2720 7d7d 7b25 2065 6e64 6966 2025 7d22  ' }}{% endif %}"
+00004a40: 0a20 2020 2020 2020 2020 2020 2022 7b25  .            "{%
+00004a50: 2065 6e64 666f 7220 257d 220a 2020 2020   endfor %}".    
+00004a60: 2020 2020 2020 2020 227b 7b20 656f 735f          "{{ eos_
+00004a70: 746f 6b65 6e20 7d7d 220a 2020 2020 2020  token }}".      
+00004a80: 2020 290a 0a5f 5f61 6c6c 5f5f 203d 205b    )..__all__ = [
+00004a90: 2742 6c65 6e64 6572 626f 7454 6f6b 656e  'BlenderbotToken
+00004aa0: 697a 6572 275d 0a                        izer'].
```

## mindnlp/transformers/models/blenderbot_small/__init__.py

```diff
@@ -0,0 +1,79 @@
+00000000: 2320 436f 7079 7269 6768 7420 3230 3234  # Copyright 2024
+00000010: 2048 7561 7765 6920 5465 6368 6e6f 6c6f   Huawei Technolo
+00000020: 6769 6573 2043 6f2e 2c20 4c74 640a 230a  gies Co., Ltd.#.
+00000030: 2320 4c69 6365 6e73 6564 2075 6e64 6572  # Licensed under
+00000040: 2074 6865 2041 7061 6368 6520 4c69 6365   the Apache Lice
+00000050: 6e73 652c 2056 6572 7369 6f6e 2032 2e30  nse, Version 2.0
+00000060: 2028 7468 6520 224c 6963 656e 7365 2229   (the "License")
+00000070: 3b0a 2320 796f 7520 6d61 7920 6e6f 7420  ;.# you may not 
+00000080: 7573 6520 7468 6973 2066 696c 6520 6578  use this file ex
+00000090: 6365 7074 2069 6e20 636f 6d70 6c69 616e  cept in complian
+000000a0: 6365 2077 6974 6820 7468 6520 4c69 6365  ce with the Lice
+000000b0: 6e73 652e 0a23 2059 6f75 206d 6179 206f  nse..# You may o
+000000c0: 6274 6169 6e20 6120 636f 7079 206f 6620  btain a copy of 
+000000d0: 7468 6520 4c69 6365 6e73 6520 6174 0a23  the License at.#
+000000e0: 0a23 2068 7474 703a 2f2f 7777 772e 6170  .# http://www.ap
+000000f0: 6163 6865 2e6f 7267 2f6c 6963 656e 7365  ache.org/license
+00000100: 732f 4c49 4345 4e53 452d 322e 300a 230a  s/LICENSE-2.0.#.
+00000110: 2320 556e 6c65 7373 2072 6571 7569 7265  # Unless require
+00000120: 6420 6279 2061 7070 6c69 6361 626c 6520  d by applicable 
+00000130: 6c61 7720 6f72 2061 6772 6565 6420 746f  law or agreed to
+00000140: 2069 6e20 7772 6974 696e 672c 2073 6f66   in writing, sof
+00000150: 7477 6172 650a 2320 6469 7374 7269 6275  tware.# distribu
+00000160: 7465 6420 756e 6465 7220 7468 6520 4c69  ted under the Li
+00000170: 6365 6e73 6520 6973 2064 6973 7472 6962  cense is distrib
+00000180: 7574 6564 206f 6e20 616e 2022 4153 2049  uted on an "AS I
+00000190: 5322 2042 4153 4953 2c0a 2320 5749 5448  S" BASIS,.# WITH
+000001a0: 4f55 5420 5741 5252 414e 5449 4553 204f  OUT WARRANTIES O
+000001b0: 5220 434f 4e44 4954 494f 4e53 204f 4620  R CONDITIONS OF 
+000001c0: 414e 5920 4b49 4e44 2c20 6569 7468 6572  ANY KIND, either
+000001d0: 2065 7870 7265 7373 206f 7220 696d 706c   express or impl
+000001e0: 6965 642e 0a23 2053 6565 2074 6865 204c  ied..# See the L
+000001f0: 6963 656e 7365 2066 6f72 2074 6865 2073  icense for the s
+00000200: 7065 6369 6669 6320 6c61 6e67 7561 6765  pecific language
+00000210: 2067 6f76 6572 6e69 6e67 2070 6572 6d69   governing permi
+00000220: 7373 696f 6e73 2061 6e64 0a23 206c 696d  ssions and.# lim
+00000230: 6974 6174 696f 6e73 2075 6e64 6572 2074  itations under t
+00000240: 6865 204c 6963 656e 7365 2e0a 2320 3d3d  he License..# ==
+00000250: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00000260: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00000270: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00000280: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00000290: 3d3d 3d3d 3d3d 3d3d 3d3d 0a22 2222 0a42  ==========.""".B
+000002a0: 6c65 6e64 6572 626f 7420 536d 616c 6c20  lenderbot Small 
+000002b0: 4d6f 6465 6c2e 0a22 2222 0a66 726f 6d20  Model..""".from 
+000002c0: 2e20 696d 706f 7274 2063 6f6e 6669 6775  . import configu
+000002d0: 7261 7469 6f6e 5f62 6c65 6e64 6572 626f  ration_blenderbo
+000002e0: 745f 736d 616c 6c2c 206d 6f64 656c 696e  t_small, modelin
+000002f0: 675f 626c 656e 6465 7262 6f74 5f73 6d61  g_blenderbot_sma
+00000300: 6c6c 2c20 746f 6b65 6e69 7a61 7469 6f6e  ll, tokenization
+00000310: 5f62 6c65 6e64 6572 626f 745f 736d 616c  _blenderbot_smal
+00000320: 6c2c 2074 6f6b 656e 697a 6174 696f 6e5f  l, tokenization_
+00000330: 626c 656e 6465 7262 6f74 5f73 6d61 6c6c  blenderbot_small
+00000340: 5f66 6173 740a 6672 6f6d 202e 636f 6e66  _fast.from .conf
+00000350: 6967 7572 6174 696f 6e5f 626c 656e 6465  iguration_blende
+00000360: 7262 6f74 5f73 6d61 6c6c 2069 6d70 6f72  rbot_small impor
+00000370: 7420 2a0a 6672 6f6d 202e 6d6f 6465 6c69  t *.from .modeli
+00000380: 6e67 5f62 6c65 6e64 6572 626f 745f 736d  ng_blenderbot_sm
+00000390: 616c 6c20 696d 706f 7274 202a 0a66 726f  all import *.fro
+000003a0: 6d20 2e74 6f6b 656e 697a 6174 696f 6e5f  m .tokenization_
+000003b0: 626c 656e 6465 7262 6f74 5f73 6d61 6c6c  blenderbot_small
+000003c0: 2069 6d70 6f72 7420 2a0a 6672 6f6d 202e   import *.from .
+000003d0: 746f 6b65 6e69 7a61 7469 6f6e 5f62 6c65  tokenization_ble
+000003e0: 6e64 6572 626f 745f 736d 616c 6c5f 6661  nderbot_small_fa
+000003f0: 7374 2069 6d70 6f72 7420 2a0a 0a5f 5f61  st import *..__a
+00000400: 6c6c 5f5f 203d 205b 5d0a 5f5f 616c 6c5f  ll__ = [].__all_
+00000410: 5f2e 6578 7465 6e64 2863 6f6e 6669 6775  _.extend(configu
+00000420: 7261 7469 6f6e 5f62 6c65 6e64 6572 626f  ration_blenderbo
+00000430: 745f 736d 616c 6c2e 5f5f 616c 6c5f 5f29  t_small.__all__)
+00000440: 0a5f 5f61 6c6c 5f5f 2e65 7874 656e 6428  .__all__.extend(
+00000450: 6d6f 6465 6c69 6e67 5f62 6c65 6e64 6572  modeling_blender
+00000460: 626f 745f 736d 616c 6c2e 5f5f 616c 6c5f  bot_small.__all_
+00000470: 5f29 0a5f 5f61 6c6c 5f5f 2e65 7874 656e  _).__all__.exten
+00000480: 6428 746f 6b65 6e69 7a61 7469 6f6e 5f62  d(tokenization_b
+00000490: 6c65 6e64 6572 626f 745f 736d 616c 6c2e  lenderbot_small.
+000004a0: 5f5f 616c 6c5f 5f29 0a5f 5f61 6c6c 5f5f  __all__).__all__
+000004b0: 2e65 7874 656e 6428 746f 6b65 6e69 7a61  .extend(tokeniza
+000004c0: 7469 6f6e 5f62 6c65 6e64 6572 626f 745f  tion_blenderbot_
+000004d0: 736d 616c 6c5f 6661 7374 2e5f 5f61 6c6c  small_fast.__all
+000004e0: 5f5f 290a                                __).
```

## mindnlp/transformers/models/blenderbot_small/configuration_blenderbot_small.py

```diff
@@ -0,0 +1,472 @@
+00000000: 2320 636f 6469 6e67 3d75 7466 2d38 0a23  # coding=utf-8.#
+00000010: 2043 6f70 7972 6967 6874 2032 3032 3120   Copyright 2021 
+00000020: 5468 6520 4661 6365 626f 6f6b 2c20 496e  The Facebook, In
+00000030: 632e 2061 6e64 2054 6865 2048 7567 6769  c. and The Huggi
+00000040: 6e67 4661 6365 2049 6e63 2e20 7465 616d  ngFace Inc. team
+00000050: 2e20 416c 6c20 7269 6768 7473 2072 6573  . All rights res
+00000060: 6572 7665 642e 0a23 0a23 204c 6963 656e  erved..#.# Licen
+00000070: 7365 6420 756e 6465 7220 7468 6520 4170  sed under the Ap
+00000080: 6163 6865 204c 6963 656e 7365 2c20 5665  ache License, Ve
+00000090: 7273 696f 6e20 322e 3020 2874 6865 2022  rsion 2.0 (the "
+000000a0: 4c69 6365 6e73 6522 293b 0a23 2079 6f75  License");.# you
+000000b0: 206d 6179 206e 6f74 2075 7365 2074 6869   may not use thi
+000000c0: 7320 6669 6c65 2065 7863 6570 7420 696e  s file except in
+000000d0: 2063 6f6d 706c 6961 6e63 6520 7769 7468   compliance with
+000000e0: 2074 6865 204c 6963 656e 7365 2e0a 2320   the License..# 
+000000f0: 596f 7520 6d61 7920 6f62 7461 696e 2061  You may obtain a
+00000100: 2063 6f70 7920 6f66 2074 6865 204c 6963   copy of the Lic
+00000110: 656e 7365 2061 740a 230a 2320 2020 2020  ense at.#.#     
+00000120: 6874 7470 3a2f 2f77 7777 2e61 7061 6368  http://www.apach
+00000130: 652e 6f72 672f 6c69 6365 6e73 6573 2f4c  e.org/licenses/L
+00000140: 4943 454e 5345 2d32 2e30 0a23 0a23 2055  ICENSE-2.0.#.# U
+00000150: 6e6c 6573 7320 7265 7175 6972 6564 2062  nless required b
+00000160: 7920 6170 706c 6963 6162 6c65 206c 6177  y applicable law
+00000170: 206f 7220 6167 7265 6564 2074 6f20 696e   or agreed to in
+00000180: 2077 7269 7469 6e67 2c20 736f 6674 7761   writing, softwa
+00000190: 7265 0a23 2064 6973 7472 6962 7574 6564  re.# distributed
+000001a0: 2075 6e64 6572 2074 6865 204c 6963 656e   under the Licen
+000001b0: 7365 2069 7320 6469 7374 7269 6275 7465  se is distribute
+000001c0: 6420 6f6e 2061 6e20 2241 5320 4953 2220  d on an "AS IS" 
+000001d0: 4241 5349 532c 0a23 2057 4954 484f 5554  BASIS,.# WITHOUT
+000001e0: 2057 4152 5241 4e54 4945 5320 4f52 2043   WARRANTIES OR C
+000001f0: 4f4e 4449 5449 4f4e 5320 4f46 2041 4e59  ONDITIONS OF ANY
+00000200: 204b 494e 442c 2065 6974 6865 7220 6578   KIND, either ex
+00000210: 7072 6573 7320 6f72 2069 6d70 6c69 6564  press or implied
+00000220: 2e0a 2320 5365 6520 7468 6520 4c69 6365  ..# See the Lice
+00000230: 6e73 6520 666f 7220 7468 6520 7370 6563  nse for the spec
+00000240: 6966 6963 206c 616e 6775 6167 6520 676f  ific language go
+00000250: 7665 726e 696e 6720 7065 726d 6973 7369  verning permissi
+00000260: 6f6e 7320 616e 640a 2320 6c69 6d69 7461  ons and.# limita
+00000270: 7469 6f6e 7320 756e 6465 7220 7468 6520  tions under the 
+00000280: 4c69 6365 6e73 652e 0a22 2222 2042 6c65  License..""" Ble
+00000290: 6e64 6572 626f 7453 6d61 6c6c 206d 6f64  nderbotSmall mod
+000002a0: 656c 2063 6f6e 6669 6775 7261 7469 6f6e  el configuration
+000002b0: 2222 220a 6672 6f6d 202e 2e2e 636f 6e66  """.from ...conf
+000002c0: 6967 7572 6174 696f 6e5f 7574 696c 7320  iguration_utils 
+000002d0: 696d 706f 7274 2050 7265 7472 6169 6e65  import Pretraine
+000002e0: 6443 6f6e 6669 670a 6672 6f6d 202e 2e2e  dConfig.from ...
+000002f0: 2e75 7469 6c73 2069 6d70 6f72 7420 6c6f  .utils import lo
+00000300: 6767 696e 670a 0a0a 6c6f 6767 6572 203d  gging...logger =
+00000310: 206c 6f67 6769 6e67 2e67 6574 5f6c 6f67   logging.get_log
+00000320: 6765 7228 5f5f 6e61 6d65 5f5f 290a 0a0a  ger(__name__)...
+00000330: 636c 6173 7320 426c 656e 6465 7262 6f74  class Blenderbot
+00000340: 536d 616c 6c43 6f6e 6669 6728 5072 6574  SmallConfig(Pret
+00000350: 7261 696e 6564 436f 6e66 6967 293a 0a20  rainedConfig):. 
+00000360: 2020 2072 2222 220a 2020 2020 5468 6973     r""".    This
+00000370: 2069 7320 7468 6520 636f 6e66 6967 7572   is the configur
+00000380: 6174 696f 6e20 636c 6173 7320 746f 2073  ation class to s
+00000390: 746f 7265 2074 6865 2063 6f6e 6669 6775  tore the configu
+000003a0: 7261 7469 6f6e 206f 6620 6120 5b60 426c  ration of a [`Bl
+000003b0: 656e 6465 7262 6f74 536d 616c 6c4d 6f64  enderbotSmallMod
+000003c0: 656c 605d 2e20 4974 2069 7320 7573 6564  el`]. It is used
+000003d0: 2074 6f20 696e 7374 616e 7469 6174 650a   to instantiate.
+000003e0: 2020 2020 616e 2042 6c65 6e64 6572 626f      an Blenderbo
+000003f0: 7453 6d61 6c6c 206d 6f64 656c 2061 6363  tSmall model acc
+00000400: 6f72 6469 6e67 2074 6f20 7468 6520 7370  ording to the sp
+00000410: 6563 6966 6965 6420 6172 6775 6d65 6e74  ecified argument
+00000420: 732c 2064 6566 696e 696e 6720 7468 6520  s, defining the 
+00000430: 6d6f 6465 6c20 6172 6368 6974 6563 7475  model architectu
+00000440: 7265 2e20 496e 7374 616e 7469 6174 696e  re. Instantiatin
+00000450: 6720 610a 2020 2020 636f 6e66 6967 7572  g a.    configur
+00000460: 6174 696f 6e20 7769 7468 2074 6865 2064  ation with the d
+00000470: 6566 6175 6c74 7320 7769 6c6c 2079 6965  efaults will yie
+00000480: 6c64 2061 2073 696d 696c 6172 2063 6f6e  ld a similar con
+00000490: 6669 6775 7261 7469 6f6e 2074 6f20 7468  figuration to th
+000004a0: 6174 206f 6620 7468 6520 426c 656e 6465  at of the Blende
+000004b0: 7262 6f74 536d 616c 6c0a 2020 2020 5b66  rbotSmall.    [f
+000004c0: 6163 6562 6f6f 6b2f 626c 656e 6465 7262  acebook/blenderb
+000004d0: 6f74 5f73 6d61 6c6c 2d39 304d 5d28 6874  ot_small-90M](ht
+000004e0: 7470 733a 2f2f 6875 6767 696e 6766 6163  tps://huggingfac
+000004f0: 652e 636f 2f66 6163 6562 6f6f 6b2f 626c  e.co/facebook/bl
+00000500: 656e 6465 7262 6f74 5f73 6d61 6c6c 2d39  enderbot_small-9
+00000510: 304d 2920 6172 6368 6974 6563 7475 7265  0M) architecture
+00000520: 2e0a 0a20 2020 2043 6f6e 6669 6775 7261  ...    Configura
+00000530: 7469 6f6e 206f 626a 6563 7473 2069 6e68  tion objects inh
+00000540: 6572 6974 2066 726f 6d20 5b60 5072 6574  erit from [`Pret
+00000550: 7261 696e 6564 436f 6e66 6967 605d 2061  rainedConfig`] a
+00000560: 6e64 2063 616e 2062 6520 7573 6564 2074  nd can be used t
+00000570: 6f20 636f 6e74 726f 6c20 7468 6520 6d6f  o control the mo
+00000580: 6465 6c20 6f75 7470 7574 732e 2052 6561  del outputs. Rea
+00000590: 6420 7468 650a 2020 2020 646f 6375 6d65  d the.    docume
+000005a0: 6e74 6174 696f 6e20 6672 6f6d 205b 6050  ntation from [`P
+000005b0: 7265 7472 6169 6e65 6443 6f6e 6669 6760  retrainedConfig`
+000005c0: 5d20 666f 7220 6d6f 7265 2069 6e66 6f72  ] for more infor
+000005d0: 6d61 7469 6f6e 2e0a 0a0a 2020 2020 4172  mation....    Ar
+000005e0: 6773 3a0a 2020 2020 2020 2020 766f 6361  gs:.        voca
+000005f0: 625f 7369 7a65 2028 6069 6e74 602c 202a  b_size (`int`, *
+00000600: 6f70 7469 6f6e 616c 2a2c 2064 6566 6175  optional*, defau
+00000610: 6c74 7320 746f 2035 3032 3635 293a 0a20  lts to 50265):. 
+00000620: 2020 2020 2020 2020 2020 2056 6f63 6162             Vocab
+00000630: 756c 6172 7920 7369 7a65 206f 6620 7468  ulary size of th
+00000640: 6520 426c 656e 6465 7262 6f74 536d 616c  e BlenderbotSmal
+00000650: 6c20 6d6f 6465 6c2e 2044 6566 696e 6573  l model. Defines
+00000660: 2074 6865 206e 756d 6265 7220 6f66 2064   the number of d
+00000670: 6966 6665 7265 6e74 2074 6f6b 656e 7320  ifferent tokens 
+00000680: 7468 6174 2063 616e 2062 650a 2020 2020  that can be.    
+00000690: 2020 2020 2020 2020 7265 7072 6573 656e          represen
+000006a0: 7465 6420 6279 2074 6865 2060 696e 7075  ted by the `inpu
+000006b0: 7473 5f69 6473 6020 7061 7373 6564 2077  ts_ids` passed w
+000006c0: 6865 6e20 6361 6c6c 696e 6720 5b60 426c  hen calling [`Bl
+000006d0: 656e 6465 7262 6f74 536d 616c 6c4d 6f64  enderbotSmallMod
+000006e0: 656c 605d 206f 7220 5b60 5446 426c 656e  el`] or [`TFBlen
+000006f0: 6465 7262 6f74 536d 616c 6c4d 6f64 656c  derbotSmallModel
+00000700: 605d 2e0a 2020 2020 2020 2020 645f 6d6f  `]..        d_mo
+00000710: 6465 6c20 2860 696e 7460 2c20 2a6f 7074  del (`int`, *opt
+00000720: 696f 6e61 6c2a 2c20 6465 6661 756c 7473  ional*, defaults
+00000730: 2074 6f20 3531 3229 3a0a 2020 2020 2020   to 512):.      
+00000740: 2020 2020 2020 4469 6d65 6e73 696f 6e61        Dimensiona
+00000750: 6c69 7479 206f 6620 7468 6520 6c61 7965  lity of the laye
+00000760: 7273 2061 6e64 2074 6865 2070 6f6f 6c65  rs and the poole
+00000770: 7220 6c61 7965 722e 0a20 2020 2020 2020  r layer..       
+00000780: 2065 6e63 6f64 6572 5f6c 6179 6572 7320   encoder_layers 
+00000790: 2860 696e 7460 2c20 2a6f 7074 696f 6e61  (`int`, *optiona
+000007a0: 6c2a 2c20 6465 6661 756c 7473 2074 6f20  l*, defaults to 
+000007b0: 3829 3a0a 2020 2020 2020 2020 2020 2020  8):.            
+000007c0: 4e75 6d62 6572 206f 6620 656e 636f 6465  Number of encode
+000007d0: 7220 6c61 7965 7273 2e0a 2020 2020 2020  r layers..      
+000007e0: 2020 6465 636f 6465 725f 6c61 7965 7273    decoder_layers
+000007f0: 2028 6069 6e74 602c 202a 6f70 7469 6f6e   (`int`, *option
+00000800: 616c 2a2c 2064 6566 6175 6c74 7320 746f  al*, defaults to
+00000810: 2038 293a 0a20 2020 2020 2020 2020 2020   8):.           
+00000820: 204e 756d 6265 7220 6f66 2064 6563 6f64   Number of decod
+00000830: 6572 206c 6179 6572 732e 0a20 2020 2020  er layers..     
+00000840: 2020 2065 6e63 6f64 6572 5f61 7474 656e     encoder_atten
+00000850: 7469 6f6e 5f68 6561 6473 2028 6069 6e74  tion_heads (`int
+00000860: 602c 202a 6f70 7469 6f6e 616c 2a2c 2064  `, *optional*, d
+00000870: 6566 6175 6c74 7320 746f 2031 3629 3a0a  efaults to 16):.
+00000880: 2020 2020 2020 2020 2020 2020 4e75 6d62              Numb
+00000890: 6572 206f 6620 6174 7465 6e74 696f 6e20  er of attention 
+000008a0: 6865 6164 7320 666f 7220 6561 6368 2061  heads for each a
+000008b0: 7474 656e 7469 6f6e 206c 6179 6572 2069  ttention layer i
+000008c0: 6e20 7468 6520 5472 616e 7366 6f72 6d65  n the Transforme
+000008d0: 7220 656e 636f 6465 722e 0a20 2020 2020  r encoder..     
+000008e0: 2020 2064 6563 6f64 6572 5f61 7474 656e     decoder_atten
+000008f0: 7469 6f6e 5f68 6561 6473 2028 6069 6e74  tion_heads (`int
+00000900: 602c 202a 6f70 7469 6f6e 616c 2a2c 2064  `, *optional*, d
+00000910: 6566 6175 6c74 7320 746f 2031 3629 3a0a  efaults to 16):.
+00000920: 2020 2020 2020 2020 2020 2020 4e75 6d62              Numb
+00000930: 6572 206f 6620 6174 7465 6e74 696f 6e20  er of attention 
+00000940: 6865 6164 7320 666f 7220 6561 6368 2061  heads for each a
+00000950: 7474 656e 7469 6f6e 206c 6179 6572 2069  ttention layer i
+00000960: 6e20 7468 6520 5472 616e 7366 6f72 6d65  n the Transforme
+00000970: 7220 6465 636f 6465 722e 0a20 2020 2020  r decoder..     
+00000980: 2020 2064 6563 6f64 6572 5f66 666e 5f64     decoder_ffn_d
+00000990: 696d 2028 6069 6e74 602c 202a 6f70 7469  im (`int`, *opti
+000009a0: 6f6e 616c 2a2c 2064 6566 6175 6c74 7320  onal*, defaults 
+000009b0: 746f 2032 3034 3829 3a0a 2020 2020 2020  to 2048):.      
+000009c0: 2020 2020 2020 4469 6d65 6e73 696f 6e61        Dimensiona
+000009d0: 6c69 7479 206f 6620 7468 6520 2269 6e74  lity of the "int
+000009e0: 6572 6d65 6469 6174 6522 2028 6f66 7465  ermediate" (ofte
+000009f0: 6e20 6e61 6d65 6420 6665 6564 2d66 6f72  n named feed-for
+00000a00: 7761 7264 2920 6c61 7965 7220 696e 2064  ward) layer in d
+00000a10: 6563 6f64 6572 2e0a 2020 2020 2020 2020  ecoder..        
+00000a20: 656e 636f 6465 725f 6666 6e5f 6469 6d20  encoder_ffn_dim 
+00000a30: 2860 696e 7460 2c20 2a6f 7074 696f 6e61  (`int`, *optiona
+00000a40: 6c2a 2c20 6465 6661 756c 7473 2074 6f20  l*, defaults to 
+00000a50: 3230 3438 293a 0a20 2020 2020 2020 2020  2048):.         
+00000a60: 2020 2044 696d 656e 7369 6f6e 616c 6974     Dimensionalit
+00000a70: 7920 6f66 2074 6865 2022 696e 7465 726d  y of the "interm
+00000a80: 6564 6961 7465 2220 286f 6674 656e 206e  ediate" (often n
+00000a90: 616d 6564 2066 6565 642d 666f 7277 6172  amed feed-forwar
+00000aa0: 6429 206c 6179 6572 2069 6e20 6465 636f  d) layer in deco
+00000ab0: 6465 722e 0a20 2020 2020 2020 2061 6374  der..        act
+00000ac0: 6976 6174 696f 6e5f 6675 6e63 7469 6f6e  ivation_function
+00000ad0: 2028 6073 7472 6020 6f72 2060 6675 6e63   (`str` or `func
+00000ae0: 7469 6f6e 602c 202a 6f70 7469 6f6e 616c  tion`, *optional
+00000af0: 2a2c 2064 6566 6175 6c74 7320 746f 2060  *, defaults to `
+00000b00: 2267 656c 7522 6029 3a0a 2020 2020 2020  "gelu"`):.      
+00000b10: 2020 2020 2020 5468 6520 6e6f 6e2d 6c69        The non-li
+00000b20: 6e65 6172 2061 6374 6976 6174 696f 6e20  near activation 
+00000b30: 6675 6e63 7469 6f6e 2028 6675 6e63 7469  function (functi
+00000b40: 6f6e 206f 7220 7374 7269 6e67 2920 696e  on or string) in
+00000b50: 2074 6865 2065 6e63 6f64 6572 2061 6e64   the encoder and
+00000b60: 2070 6f6f 6c65 722e 2049 6620 7374 7269   pooler. If stri
+00000b70: 6e67 2c20 6022 6765 6c75 2260 2c0a 2020  ng, `"gelu"`,.  
+00000b80: 2020 2020 2020 2020 2020 6022 7265 6c75            `"relu
+00000b90: 2260 2c20 6022 7369 6c75 2260 2061 6e64  "`, `"silu"` and
+00000ba0: 2060 2267 656c 755f 6e65 7722 6020 6172   `"gelu_new"` ar
+00000bb0: 6520 7375 7070 6f72 7465 642e 0a20 2020  e supported..   
+00000bc0: 2020 2020 2064 726f 706f 7574 2028 6066       dropout (`f
+00000bd0: 6c6f 6174 602c 202a 6f70 7469 6f6e 616c  loat`, *optional
+00000be0: 2a2c 2064 6566 6175 6c74 7320 746f 2030  *, defaults to 0
+00000bf0: 2e31 293a 0a20 2020 2020 2020 2020 2020  .1):.           
+00000c00: 2054 6865 2064 726f 706f 7574 2070 726f   The dropout pro
+00000c10: 6261 6269 6c69 7479 2066 6f72 2061 6c6c  bability for all
+00000c20: 2066 756c 6c79 2063 6f6e 6e65 6374 6564   fully connected
+00000c30: 206c 6179 6572 7320 696e 2074 6865 2065   layers in the e
+00000c40: 6d62 6564 6469 6e67 732c 2065 6e63 6f64  mbeddings, encod
+00000c50: 6572 2c20 616e 6420 706f 6f6c 6572 2e0a  er, and pooler..
+00000c60: 2020 2020 2020 2020 6174 7465 6e74 696f          attentio
+00000c70: 6e5f 6472 6f70 6f75 7420 2860 666c 6f61  n_dropout (`floa
+00000c80: 7460 2c20 2a6f 7074 696f 6e61 6c2a 2c20  t`, *optional*, 
+00000c90: 6465 6661 756c 7473 2074 6f20 302e 3029  defaults to 0.0)
+00000ca0: 3a0a 2020 2020 2020 2020 2020 2020 5468  :.            Th
+00000cb0: 6520 6472 6f70 6f75 7420 7261 7469 6f20  e dropout ratio 
+00000cc0: 666f 7220 7468 6520 6174 7465 6e74 696f  for the attentio
+00000cd0: 6e20 7072 6f62 6162 696c 6974 6965 732e  n probabilities.
+00000ce0: 0a20 2020 2020 2020 2061 6374 6976 6174  .        activat
+00000cf0: 696f 6e5f 6472 6f70 6f75 7420 2860 666c  ion_dropout (`fl
+00000d00: 6f61 7460 2c20 2a6f 7074 696f 6e61 6c2a  oat`, *optional*
+00000d10: 2c20 6465 6661 756c 7473 2074 6f20 302e  , defaults to 0.
+00000d20: 3029 3a0a 2020 2020 2020 2020 2020 2020  0):.            
+00000d30: 5468 6520 6472 6f70 6f75 7420 7261 7469  The dropout rati
+00000d40: 6f20 666f 7220 6163 7469 7661 7469 6f6e  o for activation
+00000d50: 7320 696e 7369 6465 2074 6865 2066 756c  s inside the ful
+00000d60: 6c79 2063 6f6e 6e65 6374 6564 206c 6179  ly connected lay
+00000d70: 6572 2e0a 2020 2020 2020 2020 6d61 785f  er..        max_
+00000d80: 706f 7369 7469 6f6e 5f65 6d62 6564 6469  position_embeddi
+00000d90: 6e67 7320 2860 696e 7460 2c20 2a6f 7074  ngs (`int`, *opt
+00000da0: 696f 6e61 6c2a 2c20 6465 6661 756c 7473  ional*, defaults
+00000db0: 2074 6f20 3531 3229 3a0a 2020 2020 2020   to 512):.      
+00000dc0: 2020 2020 2020 5468 6520 6d61 7869 6d75        The maximu
+00000dd0: 6d20 7365 7175 656e 6365 206c 656e 6774  m sequence lengt
+00000de0: 6820 7468 6174 2074 6869 7320 6d6f 6465  h that this mode
+00000df0: 6c20 6d69 6768 7420 6576 6572 2062 6520  l might ever be 
+00000e00: 7573 6564 2077 6974 682e 2054 7970 6963  used with. Typic
+00000e10: 616c 6c79 2073 6574 2074 6869 7320 746f  ally set this to
+00000e20: 2073 6f6d 6574 6869 6e67 206c 6172 6765   something large
+00000e30: 0a20 2020 2020 2020 2020 2020 206a 7573  .            jus
+00000e40: 7420 696e 2063 6173 6520 2865 2e67 2e2c  t in case (e.g.,
+00000e50: 2035 3132 206f 7220 3130 3234 206f 7220   512 or 1024 or 
+00000e60: 3230 3438 292e 0a20 2020 2020 2020 2069  2048)..        i
+00000e70: 6e69 745f 7374 6420 2860 666c 6f61 7460  nit_std (`float`
+00000e80: 2c20 2a6f 7074 696f 6e61 6c2a 2c20 6465  , *optional*, de
+00000e90: 6661 756c 7473 2074 6f20 302e 3032 293a  faults to 0.02):
+00000ea0: 0a20 2020 2020 2020 2020 2020 2054 6865  .            The
+00000eb0: 2073 7461 6e64 6172 6420 6465 7669 6174   standard deviat
+00000ec0: 696f 6e20 6f66 2074 6865 2074 7275 6e63  ion of the trunc
+00000ed0: 6174 6564 5f6e 6f72 6d61 6c5f 696e 6974  ated_normal_init
+00000ee0: 6961 6c69 7a65 7220 666f 7220 696e 6974  ializer for init
+00000ef0: 6961 6c69 7a69 6e67 2061 6c6c 2077 6569  ializing all wei
+00000f00: 6768 7420 6d61 7472 6963 6573 2e0a 2020  ght matrices..  
+00000f10: 2020 2020 2020 656e 636f 6465 725f 6c61        encoder_la
+00000f20: 7965 7264 726f 7020 2860 666c 6f61 7460  yerdrop (`float`
+00000f30: 2c20 2a6f 7074 696f 6e61 6c2a 2c20 6465  , *optional*, de
+00000f40: 6661 756c 7473 2074 6f20 302e 3029 3a0a  faults to 0.0):.
+00000f50: 2020 2020 2020 2020 2020 2020 5468 6520              The 
+00000f60: 4c61 7965 7244 726f 7020 7072 6f62 6162  LayerDrop probab
+00000f70: 696c 6974 7920 666f 7220 7468 6520 656e  ility for the en
+00000f80: 636f 6465 722e 2053 6565 2074 6865 205b  coder. See the [
+00000f90: 4c61 7965 7244 726f 7020 7061 7065 725d  LayerDrop paper]
+00000fa0: 2873 6565 2068 7474 7073 3a2f 2f61 7278  (see https://arx
+00000fb0: 6976 2e6f 7267 2f61 6273 2f31 3930 392e  iv.org/abs/1909.
+00000fc0: 3131 3535 3629 0a20 2020 2020 2020 2020  11556).         
+00000fd0: 2020 2066 6f72 206d 6f72 6520 6465 7461     for more deta
+00000fe0: 696c 732e 0a20 2020 2020 2020 2064 6563  ils..        dec
+00000ff0: 6f64 6572 5f6c 6179 6572 6472 6f70 2028  oder_layerdrop (
+00001000: 6066 6c6f 6174 602c 202a 6f70 7469 6f6e  `float`, *option
+00001010: 616c 2a2c 2064 6566 6175 6c74 7320 746f  al*, defaults to
+00001020: 2030 2e30 293a 0a20 2020 2020 2020 2020   0.0):.         
+00001030: 2020 2054 6865 204c 6179 6572 4472 6f70     The LayerDrop
+00001040: 2070 726f 6261 6269 6c69 7479 2066 6f72   probability for
+00001050: 2074 6865 2064 6563 6f64 6572 2e20 5365   the decoder. Se
+00001060: 6520 7468 6520 5b4c 6179 6572 4472 6f70  e the [LayerDrop
+00001070: 2070 6170 6572 5d28 7365 6520 6874 7470   paper](see http
+00001080: 733a 2f2f 6172 7869 762e 6f72 672f 6162  s://arxiv.org/ab
+00001090: 732f 3139 3039 2e31 3135 3536 290a 2020  s/1909.11556).  
+000010a0: 2020 2020 2020 2020 2020 666f 7220 6d6f            for mo
+000010b0: 7265 2064 6574 6169 6c73 2e0a 2020 2020  re details..    
+000010c0: 2020 2020 7363 616c 655f 656d 6265 6464      scale_embedd
+000010d0: 696e 6720 2860 626f 6f6c 602c 202a 6f70  ing (`bool`, *op
+000010e0: 7469 6f6e 616c 2a2c 2064 6566 6175 6c74  tional*, default
+000010f0: 7320 746f 2060 4661 6c73 6560 293a 0a20  s to `False`):. 
+00001100: 2020 2020 2020 2020 2020 2053 6361 6c65             Scale
+00001110: 2065 6d62 6564 6469 6e67 7320 6279 2064   embeddings by d
+00001120: 6976 696e 6720 6279 2073 7172 7428 645f  iving by sqrt(d_
+00001130: 6d6f 6465 6c29 2e0a 2020 2020 2020 2020  model)..        
+00001140: 7573 655f 6361 6368 6520 2860 626f 6f6c  use_cache (`bool
+00001150: 602c 202a 6f70 7469 6f6e 616c 2a2c 2064  `, *optional*, d
+00001160: 6566 6175 6c74 7320 746f 2060 5472 7565  efaults to `True
+00001170: 6029 3a0a 2020 2020 2020 2020 2020 2020  `):.            
+00001180: 5768 6574 6865 7220 6f72 206e 6f74 2074  Whether or not t
+00001190: 6865 206d 6f64 656c 2073 686f 756c 6420  he model should 
+000011a0: 7265 7475 726e 2074 6865 206c 6173 7420  return the last 
+000011b0: 6b65 792f 7661 6c75 6573 2061 7474 656e  key/values atten
+000011c0: 7469 6f6e 7320 286e 6f74 2075 7365 6420  tions (not used 
+000011d0: 6279 2061 6c6c 206d 6f64 656c 7329 0a20  by all models). 
+000011e0: 2020 2020 2020 2066 6f72 6365 645f 656f         forced_eo
+000011f0: 735f 746f 6b65 6e5f 6964 2028 6069 6e74  s_token_id (`int
+00001200: 602c 202a 6f70 7469 6f6e 616c 2a2c 2064  `, *optional*, d
+00001210: 6566 6175 6c74 7320 746f 2032 293a 0a20  efaults to 2):. 
+00001220: 2020 2020 2020 2020 2020 2054 6865 2069             The i
+00001230: 6420 6f66 2074 6865 2074 6f6b 656e 2074  d of the token t
+00001240: 6f20 666f 7263 6520 6173 2074 6865 206c  o force as the l
+00001250: 6173 7420 6765 6e65 7261 7465 6420 746f  ast generated to
+00001260: 6b65 6e20 7768 656e 2060 6d61 785f 6c65  ken when `max_le
+00001270: 6e67 7468 6020 6973 2072 6561 6368 6564  ngth` is reached
+00001280: 2e20 5573 7561 6c6c 7920 7365 7420 746f  . Usually set to
+00001290: 0a20 2020 2020 2020 2020 2020 2060 656f  .            `eo
+000012a0: 735f 746f 6b65 6e5f 6964 602e 0a0a 2020  s_token_id`...  
+000012b0: 2020 4578 616d 706c 653a 0a0a 2020 2020    Example:..    
+000012c0: 6060 6070 7974 686f 6e0a 2020 2020 3e3e  ```python.    >>
+000012d0: 3e20 6672 6f6d 2074 7261 6e73 666f 726d  > from transform
+000012e0: 6572 7320 696d 706f 7274 2042 6c65 6e64  ers import Blend
+000012f0: 6572 626f 7453 6d61 6c6c 436f 6e66 6967  erbotSmallConfig
+00001300: 2c20 426c 656e 6465 7262 6f74 536d 616c  , BlenderbotSmal
+00001310: 6c4d 6f64 656c 0a0a 2020 2020 3e3e 3e20  lModel..    >>> 
+00001320: 2320 496e 6974 6961 6c69 7a69 6e67 2061  # Initializing a
+00001330: 2042 6c65 6e64 6572 626f 7453 6d61 6c6c   BlenderbotSmall
+00001340: 2066 6163 6562 6f6f 6b2f 626c 656e 6465   facebook/blende
+00001350: 7262 6f74 5f73 6d61 6c6c 2d39 304d 2073  rbot_small-90M s
+00001360: 7479 6c65 2063 6f6e 6669 6775 7261 7469  tyle configurati
+00001370: 6f6e 0a20 2020 203e 3e3e 2063 6f6e 6669  on.    >>> confi
+00001380: 6775 7261 7469 6f6e 203d 2042 6c65 6e64  guration = Blend
+00001390: 6572 626f 7453 6d61 6c6c 436f 6e66 6967  erbotSmallConfig
+000013a0: 2829 0a0a 2020 2020 3e3e 3e20 2320 496e  ()..    >>> # In
+000013b0: 6974 6961 6c69 7a69 6e67 2061 206d 6f64  itializing a mod
+000013c0: 656c 2028 7769 7468 2072 616e 646f 6d20  el (with random 
+000013d0: 7765 6967 6874 7329 2066 726f 6d20 7468  weights) from th
+000013e0: 6520 6661 6365 626f 6f6b 2f62 6c65 6e64  e facebook/blend
+000013f0: 6572 626f 745f 736d 616c 6c2d 3930 4d20  erbot_small-90M 
+00001400: 7374 796c 6520 636f 6e66 6967 7572 6174  style configurat
+00001410: 696f 6e0a 2020 2020 3e3e 3e20 6d6f 6465  ion.    >>> mode
+00001420: 6c20 3d20 426c 656e 6465 7262 6f74 536d  l = BlenderbotSm
+00001430: 616c 6c4d 6f64 656c 2863 6f6e 6669 6775  allModel(configu
+00001440: 7261 7469 6f6e 290a 0a20 2020 203e 3e3e  ration)..    >>>
+00001450: 2023 2041 6363 6573 7369 6e67 2074 6865   # Accessing the
+00001460: 206d 6f64 656c 2063 6f6e 6669 6775 7261   model configura
+00001470: 7469 6f6e 0a20 2020 203e 3e3e 2063 6f6e  tion.    >>> con
+00001480: 6669 6775 7261 7469 6f6e 203d 206d 6f64  figuration = mod
+00001490: 656c 2e63 6f6e 6669 670a 2020 2020 6060  el.config.    ``
+000014a0: 6022 2222 0a0a 2020 2020 6d6f 6465 6c5f  `"""..    model_
+000014b0: 7479 7065 203d 2022 626c 656e 6465 7262  type = "blenderb
+000014c0: 6f74 2d73 6d61 6c6c 220a 2020 2020 6b65  ot-small".    ke
+000014d0: 7973 5f74 6f5f 6967 6e6f 7265 5f61 745f  ys_to_ignore_at_
+000014e0: 696e 6665 7265 6e63 6520 3d20 5b22 7061  inference = ["pa
+000014f0: 7374 5f6b 6579 5f76 616c 7565 7322 5d0a  st_key_values"].
+00001500: 2020 2020 6174 7472 6962 7574 655f 6d61      attribute_ma
+00001510: 7020 3d20 7b22 6e75 6d5f 6174 7465 6e74  p = {"num_attent
+00001520: 696f 6e5f 6865 6164 7322 3a20 2265 6e63  ion_heads": "enc
+00001530: 6f64 6572 5f61 7474 656e 7469 6f6e 5f68  oder_attention_h
+00001540: 6561 6473 222c 2022 6869 6464 656e 5f73  eads", "hidden_s
+00001550: 697a 6522 3a20 2264 5f6d 6f64 656c 227d  ize": "d_model"}
+00001560: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
+00001570: 5f5f 280a 2020 2020 2020 2020 7365 6c66  __(.        self
+00001580: 2c0a 2020 2020 2020 2020 766f 6361 625f  ,.        vocab_
+00001590: 7369 7a65 3d35 3032 3635 2c0a 2020 2020  size=50265,.    
+000015a0: 2020 2020 6d61 785f 706f 7369 7469 6f6e      max_position
+000015b0: 5f65 6d62 6564 6469 6e67 733d 3531 322c  _embeddings=512,
+000015c0: 0a20 2020 2020 2020 2065 6e63 6f64 6572  .        encoder
+000015d0: 5f6c 6179 6572 733d 382c 0a20 2020 2020  _layers=8,.     
+000015e0: 2020 2065 6e63 6f64 6572 5f66 666e 5f64     encoder_ffn_d
+000015f0: 696d 3d32 3034 382c 0a20 2020 2020 2020  im=2048,.       
+00001600: 2065 6e63 6f64 6572 5f61 7474 656e 7469   encoder_attenti
+00001610: 6f6e 5f68 6561 6473 3d31 362c 0a20 2020  on_heads=16,.   
+00001620: 2020 2020 2064 6563 6f64 6572 5f6c 6179       decoder_lay
+00001630: 6572 733d 382c 0a20 2020 2020 2020 2064  ers=8,.        d
+00001640: 6563 6f64 6572 5f66 666e 5f64 696d 3d32  ecoder_ffn_dim=2
+00001650: 3034 382c 0a20 2020 2020 2020 2064 6563  048,.        dec
+00001660: 6f64 6572 5f61 7474 656e 7469 6f6e 5f68  oder_attention_h
+00001670: 6561 6473 3d31 362c 0a20 2020 2020 2020  eads=16,.       
+00001680: 2065 6e63 6f64 6572 5f6c 6179 6572 6472   encoder_layerdr
+00001690: 6f70 3d30 2e30 2c0a 2020 2020 2020 2020  op=0.0,.        
+000016a0: 6465 636f 6465 725f 6c61 7965 7264 726f  decoder_layerdro
+000016b0: 703d 302e 302c 0a20 2020 2020 2020 2075  p=0.0,.        u
+000016c0: 7365 5f63 6163 6865 3d54 7275 652c 0a20  se_cache=True,. 
+000016d0: 2020 2020 2020 2069 735f 656e 636f 6465         is_encode
+000016e0: 725f 6465 636f 6465 723d 5472 7565 2c0a  r_decoder=True,.
+000016f0: 2020 2020 2020 2020 6163 7469 7661 7469          activati
+00001700: 6f6e 5f66 756e 6374 696f 6e3d 2267 656c  on_function="gel
+00001710: 7522 2c0a 2020 2020 2020 2020 645f 6d6f  u",.        d_mo
+00001720: 6465 6c3d 3531 322c 0a20 2020 2020 2020  del=512,.       
+00001730: 2064 726f 706f 7574 3d30 2e31 2c0a 2020   dropout=0.1,.  
+00001740: 2020 2020 2020 6174 7465 6e74 696f 6e5f        attention_
+00001750: 6472 6f70 6f75 743d 302e 302c 0a20 2020  dropout=0.0,.   
+00001760: 2020 2020 2061 6374 6976 6174 696f 6e5f       activation_
+00001770: 6472 6f70 6f75 743d 302e 302c 0a20 2020  dropout=0.0,.   
+00001780: 2020 2020 2069 6e69 745f 7374 643d 302e       init_std=0.
+00001790: 3032 2c0a 2020 2020 2020 2020 6465 636f  02,.        deco
+000017a0: 6465 725f 7374 6172 745f 746f 6b65 6e5f  der_start_token_
+000017b0: 6964 3d31 2c0a 2020 2020 2020 2020 7363  id=1,.        sc
+000017c0: 616c 655f 656d 6265 6464 696e 673d 4661  ale_embedding=Fa
+000017d0: 6c73 652c 0a20 2020 2020 2020 2070 6164  lse,.        pad
+000017e0: 5f74 6f6b 656e 5f69 643d 302c 0a20 2020  _token_id=0,.   
+000017f0: 2020 2020 2062 6f73 5f74 6f6b 656e 5f69       bos_token_i
+00001800: 643d 312c 0a20 2020 2020 2020 2065 6f73  d=1,.        eos
+00001810: 5f74 6f6b 656e 5f69 643d 322c 0a20 2020  _token_id=2,.   
+00001820: 2020 2020 2066 6f72 6365 645f 656f 735f       forced_eos_
+00001830: 746f 6b65 6e5f 6964 3d32 2c0a 2020 2020  token_id=2,.    
+00001840: 2020 2020 2a2a 6b77 6172 6773 2c0a 2020      **kwargs,.  
+00001850: 2020 293a 0a20 2020 2020 2020 2073 656c    ):.        sel
+00001860: 662e 766f 6361 625f 7369 7a65 203d 2076  f.vocab_size = v
+00001870: 6f63 6162 5f73 697a 650a 2020 2020 2020  ocab_size.      
+00001880: 2020 7365 6c66 2e6d 6178 5f70 6f73 6974    self.max_posit
+00001890: 696f 6e5f 656d 6265 6464 696e 6773 203d  ion_embeddings =
+000018a0: 206d 6178 5f70 6f73 6974 696f 6e5f 656d   max_position_em
+000018b0: 6265 6464 696e 6773 0a20 2020 2020 2020  beddings.       
+000018c0: 2073 656c 662e 645f 6d6f 6465 6c20 3d20   self.d_model = 
+000018d0: 645f 6d6f 6465 6c0a 2020 2020 2020 2020  d_model.        
+000018e0: 7365 6c66 2e65 6e63 6f64 6572 5f66 666e  self.encoder_ffn
+000018f0: 5f64 696d 203d 2065 6e63 6f64 6572 5f66  _dim = encoder_f
+00001900: 666e 5f64 696d 0a20 2020 2020 2020 2073  fn_dim.        s
+00001910: 656c 662e 656e 636f 6465 725f 6c61 7965  elf.encoder_laye
+00001920: 7273 203d 2065 6e63 6f64 6572 5f6c 6179  rs = encoder_lay
+00001930: 6572 730a 2020 2020 2020 2020 7365 6c66  ers.        self
+00001940: 2e65 6e63 6f64 6572 5f61 7474 656e 7469  .encoder_attenti
+00001950: 6f6e 5f68 6561 6473 203d 2065 6e63 6f64  on_heads = encod
+00001960: 6572 5f61 7474 656e 7469 6f6e 5f68 6561  er_attention_hea
+00001970: 6473 0a20 2020 2020 2020 2073 656c 662e  ds.        self.
+00001980: 6465 636f 6465 725f 6666 6e5f 6469 6d20  decoder_ffn_dim 
+00001990: 3d20 6465 636f 6465 725f 6666 6e5f 6469  = decoder_ffn_di
+000019a0: 6d0a 2020 2020 2020 2020 7365 6c66 2e64  m.        self.d
+000019b0: 6563 6f64 6572 5f6c 6179 6572 7320 3d20  ecoder_layers = 
+000019c0: 6465 636f 6465 725f 6c61 7965 7273 0a20  decoder_layers. 
+000019d0: 2020 2020 2020 2073 656c 662e 6465 636f         self.deco
+000019e0: 6465 725f 6174 7465 6e74 696f 6e5f 6865  der_attention_he
+000019f0: 6164 7320 3d20 6465 636f 6465 725f 6174  ads = decoder_at
+00001a00: 7465 6e74 696f 6e5f 6865 6164 730a 2020  tention_heads.  
+00001a10: 2020 2020 2020 7365 6c66 2e64 726f 706f        self.dropo
+00001a20: 7574 203d 2064 726f 706f 7574 0a20 2020  ut = dropout.   
+00001a30: 2020 2020 2073 656c 662e 6174 7465 6e74       self.attent
+00001a40: 696f 6e5f 6472 6f70 6f75 7420 3d20 6174  ion_dropout = at
+00001a50: 7465 6e74 696f 6e5f 6472 6f70 6f75 740a  tention_dropout.
+00001a60: 2020 2020 2020 2020 7365 6c66 2e61 6374          self.act
+00001a70: 6976 6174 696f 6e5f 6472 6f70 6f75 7420  ivation_dropout 
+00001a80: 3d20 6163 7469 7661 7469 6f6e 5f64 726f  = activation_dro
+00001a90: 706f 7574 0a20 2020 2020 2020 2073 656c  pout.        sel
+00001aa0: 662e 6163 7469 7661 7469 6f6e 5f66 756e  f.activation_fun
+00001ab0: 6374 696f 6e20 3d20 6163 7469 7661 7469  ction = activati
+00001ac0: 6f6e 5f66 756e 6374 696f 6e0a 2020 2020  on_function.    
+00001ad0: 2020 2020 7365 6c66 2e69 6e69 745f 7374      self.init_st
+00001ae0: 6420 3d20 696e 6974 5f73 7464 0a20 2020  d = init_std.   
+00001af0: 2020 2020 2073 656c 662e 656e 636f 6465       self.encode
+00001b00: 725f 6c61 7965 7264 726f 7020 3d20 656e  r_layerdrop = en
+00001b10: 636f 6465 725f 6c61 7965 7264 726f 700a  coder_layerdrop.
+00001b20: 2020 2020 2020 2020 7365 6c66 2e64 6563          self.dec
+00001b30: 6f64 6572 5f6c 6179 6572 6472 6f70 203d  oder_layerdrop =
+00001b40: 2064 6563 6f64 6572 5f6c 6179 6572 6472   decoder_layerdr
+00001b50: 6f70 0a20 2020 2020 2020 2073 656c 662e  op.        self.
+00001b60: 7573 655f 6361 6368 6520 3d20 7573 655f  use_cache = use_
+00001b70: 6361 6368 650a 2020 2020 2020 2020 7365  cache.        se
+00001b80: 6c66 2e6e 756d 5f68 6964 6465 6e5f 6c61  lf.num_hidden_la
+00001b90: 7965 7273 203d 2065 6e63 6f64 6572 5f6c  yers = encoder_l
+00001ba0: 6179 6572 730a 2020 2020 2020 2020 7365  ayers.        se
+00001bb0: 6c66 2e73 6361 6c65 5f65 6d62 6564 6469  lf.scale_embeddi
+00001bc0: 6e67 203d 2073 6361 6c65 5f65 6d62 6564  ng = scale_embed
+00001bd0: 6469 6e67 2020 2320 7363 616c 6520 6661  ding  # scale fa
+00001be0: 6374 6f72 2077 696c 6c20 6265 2073 7172  ctor will be sqr
+00001bf0: 7428 645f 6d6f 6465 6c29 2069 6620 5472  t(d_model) if Tr
+00001c00: 7565 0a0a 2020 2020 2020 2020 7375 7065  ue..        supe
+00001c10: 7228 292e 5f5f 696e 6974 5f5f 280a 2020  r().__init__(.  
+00001c20: 2020 2020 2020 2020 2020 7061 645f 746f            pad_to
+00001c30: 6b65 6e5f 6964 3d70 6164 5f74 6f6b 656e  ken_id=pad_token
+00001c40: 5f69 642c 0a20 2020 2020 2020 2020 2020  _id,.           
+00001c50: 2062 6f73 5f74 6f6b 656e 5f69 643d 626f   bos_token_id=bo
+00001c60: 735f 746f 6b65 6e5f 6964 2c0a 2020 2020  s_token_id,.    
+00001c70: 2020 2020 2020 2020 656f 735f 746f 6b65          eos_toke
+00001c80: 6e5f 6964 3d65 6f73 5f74 6f6b 656e 5f69  n_id=eos_token_i
+00001c90: 642c 0a20 2020 2020 2020 2020 2020 2069  d,.            i
+00001ca0: 735f 656e 636f 6465 725f 6465 636f 6465  s_encoder_decode
+00001cb0: 723d 6973 5f65 6e63 6f64 6572 5f64 6563  r=is_encoder_dec
+00001cc0: 6f64 6572 2c0a 2020 2020 2020 2020 2020  oder,.          
+00001cd0: 2020 6465 636f 6465 725f 7374 6172 745f    decoder_start_
+00001ce0: 746f 6b65 6e5f 6964 3d64 6563 6f64 6572  token_id=decoder
+00001cf0: 5f73 7461 7274 5f74 6f6b 656e 5f69 642c  _start_token_id,
+00001d00: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00001d10: 6365 645f 656f 735f 746f 6b65 6e5f 6964  ced_eos_token_id
+00001d20: 3d66 6f72 6365 645f 656f 735f 746f 6b65  =forced_eos_toke
+00001d30: 6e5f 6964 2c0a 2020 2020 2020 2020 2020  n_id,.          
+00001d40: 2020 2a2a 6b77 6172 6773 2c0a 2020 2020    **kwargs,.    
+00001d50: 2020 2020 290a 0a5f 5f61 6c6c 5f5f 203d      )..__all__ =
+00001d60: 205b 2742 6c65 6e64 6572 626f 7453 6d61   ['BlenderbotSma
+00001d70: 6c6c 436f 6e66 6967 275d 0a              llConfig'].
```

## mindnlp/transformers/models/blenderbot_small/modeling_blenderbot_small.py

```diff
@@ -0,0 +1,4092 @@
+00000000: 2320 636f 6469 6e67 3d75 7466 2d38 0a23  # coding=utf-8.#
+00000010: 2043 6f70 7972 6967 6874 2032 3032 3120   Copyright 2021 
+00000020: 5468 6520 4661 6365 626f 6f6b 2c20 496e  The Facebook, In
+00000030: 632e 2061 6e64 2054 6865 2048 7567 6769  c. and The Huggi
+00000040: 6e67 4661 6365 2049 6e63 2e20 7465 616d  ngFace Inc. team
+00000050: 2e20 416c 6c20 7269 6768 7473 2072 6573  . All rights res
+00000060: 6572 7665 642e 0a23 0a23 204c 6963 656e  erved..#.# Licen
+00000070: 7365 6420 756e 6465 7220 7468 6520 4170  sed under the Ap
+00000080: 6163 6865 204c 6963 656e 7365 2c20 5665  ache License, Ve
+00000090: 7273 696f 6e20 322e 3020 2874 6865 2022  rsion 2.0 (the "
+000000a0: 4c69 6365 6e73 6522 293b 0a23 2079 6f75  License");.# you
+000000b0: 206d 6179 206e 6f74 2075 7365 2074 6869   may not use thi
+000000c0: 7320 6669 6c65 2065 7863 6570 7420 696e  s file except in
+000000d0: 2063 6f6d 706c 6961 6e63 6520 7769 7468   compliance with
+000000e0: 2074 6865 204c 6963 656e 7365 2e0a 2320   the License..# 
+000000f0: 596f 7520 6d61 7920 6f62 7461 696e 2061  You may obtain a
+00000100: 2063 6f70 7920 6f66 2074 6865 204c 6963   copy of the Lic
+00000110: 656e 7365 2061 740a 230a 2320 2020 2020  ense at.#.#     
+00000120: 6874 7470 3a2f 2f77 7777 2e61 7061 6368  http://www.apach
+00000130: 652e 6f72 672f 6c69 6365 6e73 6573 2f4c  e.org/licenses/L
+00000140: 4943 454e 5345 2d32 2e30 0a23 0a23 2055  ICENSE-2.0.#.# U
+00000150: 6e6c 6573 7320 7265 7175 6972 6564 2062  nless required b
+00000160: 7920 6170 706c 6963 6162 6c65 206c 6177  y applicable law
+00000170: 206f 7220 6167 7265 6564 2074 6f20 696e   or agreed to in
+00000180: 2077 7269 7469 6e67 2c20 736f 6674 7761   writing, softwa
+00000190: 7265 0a23 2064 6973 7472 6962 7574 6564  re.# distributed
+000001a0: 2075 6e64 6572 2074 6865 204c 6963 656e   under the Licen
+000001b0: 7365 2069 7320 6469 7374 7269 6275 7465  se is distribute
+000001c0: 6420 6f6e 2061 6e20 2241 5320 4953 2220  d on an "AS IS" 
+000001d0: 4241 5349 532c 0a23 2057 4954 484f 5554  BASIS,.# WITHOUT
+000001e0: 2057 4152 5241 4e54 4945 5320 4f52 2043   WARRANTIES OR C
+000001f0: 4f4e 4449 5449 4f4e 5320 4f46 2041 4e59  ONDITIONS OF ANY
+00000200: 204b 494e 442c 2065 6974 6865 7220 6578   KIND, either ex
+00000210: 7072 6573 7320 6f72 2069 6d70 6c69 6564  press or implied
+00000220: 2e0a 2320 5365 6520 7468 6520 4c69 6365  ..# See the Lice
+00000230: 6e73 6520 666f 7220 7468 6520 7370 6563  nse for the spec
+00000240: 6966 6963 206c 616e 6775 6167 6520 676f  ific language go
+00000250: 7665 726e 696e 6720 7065 726d 6973 7369  verning permissi
+00000260: 6f6e 7320 616e 640a 2320 6c69 6d69 7461  ons and.# limita
+00000270: 7469 6f6e 7320 756e 6465 7220 7468 6520  tions under the 
+00000280: 4c69 6365 6e73 652e 0a22 2222 204d 696e  License..""" Min
+00000290: 6453 706f 7265 2042 6c65 6e64 6572 626f  dSpore Blenderbo
+000002a0: 7453 6d61 6c6c 206d 6f64 656c 2e22 2222  tSmall model."""
+000002b0: 0a69 6d70 6f72 7420 636f 7079 0a69 6d70  .import copy.imp
+000002c0: 6f72 7420 6d61 7468 0a66 726f 6d20 7479  ort math.from ty
+000002d0: 7069 6e67 2069 6d70 6f72 7420 4c69 7374  ping import List
+000002e0: 2c20 4f70 7469 6f6e 616c 2c20 5475 706c  , Optional, Tupl
+000002f0: 652c 2055 6e69 6f6e 0a0a 696d 706f 7274  e, Union..import
+00000300: 206e 756d 7079 2061 7320 6e70 0a69 6d70   numpy as np.imp
+00000310: 6f72 7420 6d69 6e64 7370 6f72 650a 6672  ort mindspore.fr
+00000320: 6f6d 206d 696e 6473 706f 7265 2069 6d70  om mindspore imp
+00000330: 6f72 7420 6e6e 2c20 6f70 732c 2054 656e  ort nn, ops, Ten
+00000340: 736f 720a 6672 6f6d 206d 696e 6473 706f  sor.from mindspo
+00000350: 7265 2e63 6f6d 6d6f 6e2e 696e 6974 6961  re.common.initia
+00000360: 6c69 7a65 7220 696d 706f 7274 2069 6e69  lizer import ini
+00000370: 7469 616c 697a 6572 2c20 4e6f 726d 616c  tializer, Normal
+00000380: 0a0a 6672 6f6d 206d 696e 646e 6c70 2e6d  ..from mindnlp.m
+00000390: 6f64 756c 6573 2e66 756e 6374 696f 6e61  odules.functiona
+000003a0: 6c20 696d 706f 7274 2066 696e 666f 0a66  l import finfo.f
+000003b0: 726f 6d20 2e2e 2e61 6374 6976 6174 696f  rom ...activatio
+000003c0: 6e73 2069 6d70 6f72 7420 4143 5432 464e  ns import ACT2FN
+000003d0: 0a66 726f 6d20 2e2e 2e6d 6f64 656c 696e  .from ...modelin
+000003e0: 675f 6174 746e 5f6d 6173 6b5f 7574 696c  g_attn_mask_util
+000003f0: 7320 696d 706f 7274 205f 7072 6570 6172  s import _prepar
+00000400: 655f 3464 5f61 7474 656e 7469 6f6e 5f6d  e_4d_attention_m
+00000410: 6173 6b2c 205f 7072 6570 6172 655f 3464  ask, _prepare_4d
+00000420: 5f63 6175 7361 6c5f 6174 7465 6e74 696f  _causal_attentio
+00000430: 6e5f 6d61 736b 0a66 726f 6d20 2e2e 2e6d  n_mask.from ...m
+00000440: 6f64 656c 696e 675f 6f75 7470 7574 7320  odeling_outputs 
+00000450: 696d 706f 7274 2028 0a20 2020 2042 6173  import (.    Bas
+00000460: 654d 6f64 656c 4f75 7470 7574 2c0a 2020  eModelOutput,.  
+00000470: 2020 4261 7365 4d6f 6465 6c4f 7574 7075    BaseModelOutpu
+00000480: 7457 6974 6850 6173 7441 6e64 4372 6f73  tWithPastAndCros
+00000490: 7341 7474 656e 7469 6f6e 732c 0a20 2020  sAttentions,.   
+000004a0: 2043 6175 7361 6c4c 4d4f 7574 7075 7457   CausalLMOutputW
+000004b0: 6974 6843 726f 7373 4174 7465 6e74 696f  ithCrossAttentio
+000004c0: 6e73 2c0a 2020 2020 5365 7132 5365 714c  ns,.    Seq2SeqL
+000004d0: 4d4f 7574 7075 742c 0a20 2020 2053 6571  MOutput,.    Seq
+000004e0: 3253 6571 4d6f 6465 6c4f 7574 7075 742c  2SeqModelOutput,
+000004f0: 0a29 0a66 726f 6d20 2e2e 2e6d 6f64 656c  .).from ...model
+00000500: 696e 675f 7574 696c 7320 696d 706f 7274  ing_utils import
+00000510: 2050 7265 5472 6169 6e65 644d 6f64 656c   PreTrainedModel
+00000520: 0a66 726f 6d20 2e2e 2e2e 7574 696c 7320  .from ....utils 
+00000530: 696d 706f 7274 206c 6f67 6769 6e67 0a66  import logging.f
+00000540: 726f 6d20 2e63 6f6e 6669 6775 7261 7469  rom .configurati
+00000550: 6f6e 5f62 6c65 6e64 6572 626f 745f 736d  on_blenderbot_sm
+00000560: 616c 6c20 696d 706f 7274 2042 6c65 6e64  all import Blend
+00000570: 6572 626f 7453 6d61 6c6c 436f 6e66 6967  erbotSmallConfig
+00000580: 0a0a 0a6c 6f67 6765 7220 3d20 6c6f 6767  ...logger = logg
+00000590: 696e 672e 6765 745f 6c6f 6767 6572 285f  ing.get_logger(_
+000005a0: 5f6e 616d 655f 5f29 0a0a 5f43 4f4e 4649  _name__).._CONFI
+000005b0: 475f 464f 525f 444f 4320 3d20 2242 6c65  G_FOR_DOC = "Ble
+000005c0: 6e64 6572 626f 7453 6d61 6c6c 436f 6e66  nderbotSmallConf
+000005d0: 6967 220a 0a0a 2320 436f 7069 6564 2066  ig"...# Copied f
+000005e0: 726f 6d20 7472 616e 7366 6f72 6d65 7273  rom transformers
+000005f0: 2e6d 6f64 656c 732e 6261 7274 2e6d 6f64  .models.bart.mod
+00000600: 656c 696e 675f 6261 7274 2e73 6869 6674  eling_bart.shift
+00000610: 5f74 6f6b 656e 735f 7269 6768 740a 6465  _tokens_right.de
+00000620: 6620 7368 6966 745f 746f 6b65 6e73 5f72  f shift_tokens_r
+00000630: 6967 6874 2869 6e70 7574 5f69 6473 3a20  ight(input_ids: 
+00000640: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+00000650: 2c20 7061 645f 746f 6b65 6e5f 6964 3a20  , pad_token_id: 
+00000660: 696e 742c 2064 6563 6f64 6572 5f73 7461  int, decoder_sta
+00000670: 7274 5f74 6f6b 656e 5f69 643a 2069 6e74  rt_token_id: int
+00000680: 293a 0a20 2020 2022 2222 0a20 2020 2053  ):.    """.    S
+00000690: 6869 6674 2069 6e70 7574 2069 6473 206f  hift input ids o
+000006a0: 6e65 2074 6f6b 656e 2074 6f20 7468 6520  ne token to the 
+000006b0: 7269 6768 742e 0a20 2020 2022 2222 0a20  right..    """. 
+000006c0: 2020 2073 6869 6674 6564 5f69 6e70 7574     shifted_input
+000006d0: 5f69 6473 203d 2069 6e70 7574 5f69 6473  _ids = input_ids
+000006e0: 2e6e 6577 5f7a 6572 6f73 2869 6e70 7574  .new_zeros(input
+000006f0: 5f69 6473 2e73 6861 7065 290a 2020 2020  _ids.shape).    
+00000700: 7368 6966 7465 645f 696e 7075 745f 6964  shifted_input_id
+00000710: 735b 3a2c 2031 3a5d 203d 2069 6e70 7574  s[:, 1:] = input
+00000720: 5f69 6473 5b3a 2c20 3a2d 315d 2e63 6f70  _ids[:, :-1].cop
+00000730: 7928 290a 2020 2020 7368 6966 7465 645f  y().    shifted_
+00000740: 696e 7075 745f 6964 735b 3a2c 2030 5d20  input_ids[:, 0] 
+00000750: 3d20 6465 636f 6465 725f 7374 6172 745f  = decoder_start_
+00000760: 746f 6b65 6e5f 6964 0a0a 2020 2020 6966  token_id..    if
+00000770: 2070 6164 5f74 6f6b 656e 5f69 6420 6973   pad_token_id is
+00000780: 204e 6f6e 653a 0a20 2020 2020 2020 2072   None:.        r
+00000790: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+000007a0: 2273 656c 662e 6d6f 6465 6c2e 636f 6e66  "self.model.conf
+000007b0: 6967 2e70 6164 5f74 6f6b 656e 5f69 6420  ig.pad_token_id 
+000007c0: 6861 7320 746f 2062 6520 6465 6669 6e65  has to be define
+000007d0: 642e 2229 0a20 2020 2023 2072 6570 6c61  d.").    # repla
+000007e0: 6365 2070 6f73 7369 626c 6520 2d31 3030  ce possible -100
+000007f0: 2076 616c 7565 7320 696e 206c 6162 656c   values in label
+00000800: 7320 6279 2060 7061 645f 746f 6b65 6e5f  s by `pad_token_
+00000810: 6964 600a 2020 2020 7368 6966 7465 645f  id`.    shifted_
+00000820: 696e 7075 745f 6964 7320 3d20 7368 6966  input_ids = shif
+00000830: 7465 645f 696e 7075 745f 6964 732e 6d61  ted_input_ids.ma
+00000840: 736b 6564 5f66 696c 6c28 7368 6966 7465  sked_fill(shifte
+00000850: 645f 696e 7075 745f 6964 7320 3d3d 202d  d_input_ids == -
+00000860: 3130 302c 2070 6164 5f74 6f6b 656e 5f69  100, pad_token_i
+00000870: 6429 0a0a 2020 2020 7265 7475 726e 2073  d)..    return s
+00000880: 6869 6674 6564 5f69 6e70 7574 5f69 6473  hifted_input_ids
+00000890: 0a0a 0a23 2043 6f70 6965 6420 6672 6f6d  ...# Copied from
+000008a0: 2074 7261 6e73 666f 726d 6572 732e 6d6f   transformers.mo
+000008b0: 6465 6c73 2e62 6c65 6e64 6572 626f 742e  dels.blenderbot.
+000008c0: 6d6f 6465 6c69 6e67 5f62 6c65 6e64 6572  modeling_blender
+000008d0: 626f 742e 426c 656e 6465 7262 6f74 4c65  bot.BlenderbotLe
+000008e0: 6172 6e65 6450 6f73 6974 696f 6e61 6c45  arnedPositionalE
+000008f0: 6d62 6564 6469 6e67 2077 6974 6820 426c  mbedding with Bl
+00000900: 656e 6465 7262 6f74 2d3e 426c 656e 6465  enderbot->Blende
+00000910: 7262 6f74 536d 616c 6c0a 636c 6173 7320  rbotSmall.class 
+00000920: 426c 656e 6465 7262 6f74 536d 616c 6c4c  BlenderbotSmallL
+00000930: 6561 726e 6564 506f 7369 7469 6f6e 616c  earnedPositional
+00000940: 456d 6265 6464 696e 6728 6e6e 2e45 6d62  Embedding(nn.Emb
+00000950: 6564 6469 6e67 293a 0a20 2020 2022 2222  edding):.    """
+00000960: 0a20 2020 2054 6869 7320 6d6f 6475 6c65  .    This module
+00000970: 206c 6561 726e 7320 706f 7369 7469 6f6e   learns position
+00000980: 616c 2065 6d62 6564 6469 6e67 7320 7570  al embeddings up
+00000990: 2074 6f20 6120 6669 7865 6420 6d61 7869   to a fixed maxi
+000009a0: 6d75 6d20 7369 7a65 2e0a 2020 2020 2222  mum size..    ""
+000009b0: 220a 0a20 2020 2064 6566 205f 5f69 6e69  "..    def __ini
+000009c0: 745f 5f28 7365 6c66 2c20 6e75 6d5f 656d  t__(self, num_em
+000009d0: 6265 6464 696e 6773 3a20 696e 742c 2065  beddings: int, e
+000009e0: 6d62 6564 6469 6e67 5f64 696d 3a20 696e  mbedding_dim: in
+000009f0: 7429 3a0a 2020 2020 2020 2020 7375 7065  t):.        supe
+00000a00: 7228 292e 5f5f 696e 6974 5f5f 286e 756d  r().__init__(num
+00000a10: 5f65 6d62 6564 6469 6e67 732c 2065 6d62  _embeddings, emb
+00000a20: 6564 6469 6e67 5f64 696d 290a 0a20 2020  edding_dim)..   
+00000a30: 2064 6566 2063 6f6e 7374 7275 6374 2873   def construct(s
+00000a40: 656c 662c 2069 6e70 7574 5f69 6473 5f73  elf, input_ids_s
+00000a50: 6861 7065 2c20 7061 7374 5f6b 6579 5f76  hape, past_key_v
+00000a60: 616c 7565 735f 6c65 6e67 7468 3a20 696e  alues_length: in
+00000a70: 7420 3d20 3029 3a0a 2020 2020 2020 2020  t = 0):.        
+00000a80: 2222 2260 696e 7075 745f 6964 735f 7368  """`input_ids_sh
+00000a90: 6170 6560 2069 7320 6578 7065 6374 6564  ape` is expected
+00000aa0: 2074 6f20 6265 205b 6273 7a20 7820 7365   to be [bsz x se
+00000ab0: 716c 656e 5d2e 2222 220a 2020 2020 2020  qlen].""".      
+00000ac0: 2020 6273 7a2c 2073 6571 5f6c 656e 203d    bsz, seq_len =
+00000ad0: 2069 6e70 7574 5f69 6473 5f73 6861 7065   input_ids_shape
+00000ae0: 5b3a 325d 0a20 2020 2020 2020 2070 6f73  [:2].        pos
+00000af0: 6974 696f 6e73 203d 206f 7073 2e61 7261  itions = ops.ara
+00000b00: 6e67 6528 0a20 2020 2020 2020 2020 2020  nge(.           
+00000b10: 2070 6173 745f 6b65 795f 7661 6c75 6573   past_key_values
+00000b20: 5f6c 656e 6774 682c 2070 6173 745f 6b65  _length, past_ke
+00000b30: 795f 7661 6c75 6573 5f6c 656e 6774 6820  y_values_length 
+00000b40: 2b20 7365 715f 6c65 6e2c 2064 7479 7065  + seq_len, dtype
+00000b50: 3d6d 696e 6473 706f 7265 2e69 6e74 3634  =mindspore.int64
+00000b60: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00000b70: 2020 2072 6574 7572 6e20 7375 7065 7228     return super(
+00000b80: 292e 636f 6e73 7472 7563 7428 706f 7369  ).construct(posi
+00000b90: 7469 6f6e 7329 0a0a 0a23 2043 6f70 6965  tions)...# Copie
+00000ba0: 6420 6672 6f6d 2074 7261 6e73 666f 726d  d from transform
+00000bb0: 6572 732e 6d6f 6465 6c73 2e62 6172 742e  ers.models.bart.
+00000bc0: 6d6f 6465 6c69 6e67 5f62 6172 742e 4261  modeling_bart.Ba
+00000bd0: 7274 4174 7465 6e74 696f 6e20 7769 7468  rtAttention with
+00000be0: 2042 6172 742d 3e42 6c65 6e64 6572 626f   Bart->Blenderbo
+00000bf0: 7453 6d61 6c6c 0a63 6c61 7373 2042 6c65  tSmall.class Ble
+00000c00: 6e64 6572 626f 7453 6d61 6c6c 4174 7465  nderbotSmallAtte
+00000c10: 6e74 696f 6e28 6e6e 2e43 656c 6c29 3a0a  ntion(nn.Cell):.
+00000c20: 2020 2020 2222 224d 756c 7469 2d68 6561      """Multi-hea
+00000c30: 6465 6420 6174 7465 6e74 696f 6e20 6672  ded attention fr
+00000c40: 6f6d 2027 4174 7465 6e74 696f 6e20 4973  om 'Attention Is
+00000c50: 2041 6c6c 2059 6f75 204e 6565 6427 2070   All You Need' p
+00000c60: 6170 6572 2222 220a 0a20 2020 2064 6566  aper"""..    def
+00000c70: 205f 5f69 6e69 745f 5f28 0a20 2020 2020   __init__(.     
+00000c80: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+00000c90: 2065 6d62 6564 5f64 696d 3a20 696e 742c   embed_dim: int,
+00000ca0: 0a20 2020 2020 2020 206e 756d 5f68 6561  .        num_hea
+00000cb0: 6473 3a20 696e 742c 0a20 2020 2020 2020  ds: int,.       
+00000cc0: 2064 726f 706f 7574 3a20 666c 6f61 7420   dropout: float 
+00000cd0: 3d20 302e 302c 0a20 2020 2020 2020 2069  = 0.0,.        i
+00000ce0: 735f 6465 636f 6465 723a 2062 6f6f 6c20  s_decoder: bool 
+00000cf0: 3d20 4661 6c73 652c 0a20 2020 2020 2020  = False,.       
+00000d00: 2062 6961 733a 2062 6f6f 6c20 3d20 5472   bias: bool = Tr
+00000d10: 7565 2c0a 2020 2020 2020 2020 6973 5f63  ue,.        is_c
+00000d20: 6175 7361 6c3a 2062 6f6f 6c20 3d20 4661  ausal: bool = Fa
+00000d30: 6c73 652c 0a20 2020 2020 2020 2063 6f6e  lse,.        con
+00000d40: 6669 673a 204f 7074 696f 6e61 6c5b 426c  fig: Optional[Bl
+00000d50: 656e 6465 7262 6f74 536d 616c 6c43 6f6e  enderbotSmallCon
+00000d60: 6669 675d 203d 204e 6f6e 652c 0a20 2020  fig] = None,.   
+00000d70: 2029 3a0a 2020 2020 2020 2020 7375 7065   ):.        supe
+00000d80: 7228 292e 5f5f 696e 6974 5f5f 2829 0a20  r().__init__(). 
+00000d90: 2020 2020 2020 2073 656c 662e 656d 6265         self.embe
+00000da0: 645f 6469 6d20 3d20 656d 6265 645f 6469  d_dim = embed_di
+00000db0: 6d0a 2020 2020 2020 2020 7365 6c66 2e6e  m.        self.n
+00000dc0: 756d 5f68 6561 6473 203d 206e 756d 5f68  um_heads = num_h
+00000dd0: 6561 6473 0a20 2020 2020 2020 2073 656c  eads.        sel
+00000de0: 662e 6472 6f70 6f75 7420 3d20 6472 6f70  f.dropout = drop
+00000df0: 6f75 740a 2020 2020 2020 2020 7365 6c66  out.        self
+00000e00: 2e68 6561 645f 6469 6d20 3d20 656d 6265  .head_dim = embe
+00000e10: 645f 6469 6d20 2f2f 206e 756d 5f68 6561  d_dim // num_hea
+00000e20: 6473 0a20 2020 2020 2020 2073 656c 662e  ds.        self.
+00000e30: 636f 6e66 6967 203d 2063 6f6e 6669 670a  config = config.
+00000e40: 0a20 2020 2020 2020 2069 6620 2873 656c  .        if (sel
+00000e50: 662e 6865 6164 5f64 696d 202a 206e 756d  f.head_dim * num
+00000e60: 5f68 6561 6473 2920 213d 2073 656c 662e  _heads) != self.
+00000e70: 656d 6265 645f 6469 6d3a 0a20 2020 2020  embed_dim:.     
+00000e80: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+00000e90: 7565 4572 726f 7228 0a20 2020 2020 2020  ueError(.       
+00000ea0: 2020 2020 2020 2020 2066 2265 6d62 6564           f"embed
+00000eb0: 5f64 696d 206d 7573 7420 6265 2064 6976  _dim must be div
+00000ec0: 6973 6962 6c65 2062 7920 6e75 6d5f 6865  isible by num_he
+00000ed0: 6164 7320 2867 6f74 2060 656d 6265 645f  ads (got `embed_
+00000ee0: 6469 6d60 3a20 7b73 656c 662e 656d 6265  dim`: {self.embe
+00000ef0: 645f 6469 6d7d 220a 2020 2020 2020 2020  d_dim}".        
+00000f00: 2020 2020 2020 2020 6622 2061 6e64 2060          f" and `
+00000f10: 6e75 6d5f 6865 6164 7360 3a20 7b6e 756d  num_heads`: {num
+00000f20: 5f68 6561 6473 7d29 2e22 0a20 2020 2020  _heads}).".     
+00000f30: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00000f40: 2073 656c 662e 7363 616c 696e 6720 3d20   self.scaling = 
+00000f50: 7365 6c66 2e68 6561 645f 6469 6d2a 2a2d  self.head_dim**-
+00000f60: 302e 350a 2020 2020 2020 2020 7365 6c66  0.5.        self
+00000f70: 2e69 735f 6465 636f 6465 7220 3d20 6973  .is_decoder = is
+00000f80: 5f64 6563 6f64 6572 0a20 2020 2020 2020  _decoder.       
+00000f90: 2073 656c 662e 6973 5f63 6175 7361 6c20   self.is_causal 
+00000fa0: 3d20 6973 5f63 6175 7361 6c0a 0a20 2020  = is_causal..   
+00000fb0: 2020 2020 2073 656c 662e 6b5f 7072 6f6a       self.k_proj
+00000fc0: 203d 206e 6e2e 4465 6e73 6528 656d 6265   = nn.Dense(embe
+00000fd0: 645f 6469 6d2c 2065 6d62 6564 5f64 696d  d_dim, embed_dim
+00000fe0: 2c20 6861 735f 6269 6173 3d62 6961 7329  , has_bias=bias)
+00000ff0: 0a20 2020 2020 2020 2073 656c 662e 765f  .        self.v_
+00001000: 7072 6f6a 203d 206e 6e2e 4465 6e73 6528  proj = nn.Dense(
+00001010: 656d 6265 645f 6469 6d2c 2065 6d62 6564  embed_dim, embed
+00001020: 5f64 696d 2c20 6861 735f 6269 6173 3d62  _dim, has_bias=b
+00001030: 6961 7329 0a20 2020 2020 2020 2073 656c  ias).        sel
+00001040: 662e 715f 7072 6f6a 203d 206e 6e2e 4465  f.q_proj = nn.De
+00001050: 6e73 6528 656d 6265 645f 6469 6d2c 2065  nse(embed_dim, e
+00001060: 6d62 6564 5f64 696d 2c20 6861 735f 6269  mbed_dim, has_bi
+00001070: 6173 3d62 6961 7329 0a20 2020 2020 2020  as=bias).       
+00001080: 2073 656c 662e 6f75 745f 7072 6f6a 203d   self.out_proj =
+00001090: 206e 6e2e 4465 6e73 6528 656d 6265 645f   nn.Dense(embed_
+000010a0: 6469 6d2c 2065 6d62 6564 5f64 696d 2c20  dim, embed_dim, 
+000010b0: 6861 735f 6269 6173 3d62 6961 7329 0a0a  has_bias=bias)..
+000010c0: 2020 2020 6465 6620 5f73 6861 7065 2873      def _shape(s
+000010d0: 656c 662c 2074 656e 736f 723a 206d 696e  elf, tensor: min
+000010e0: 6473 706f 7265 2e54 656e 736f 722c 2073  dspore.Tensor, s
+000010f0: 6571 5f6c 656e 3a20 696e 742c 2062 737a  eq_len: int, bsz
+00001100: 3a20 696e 7429 3a0a 2020 2020 2020 2020  : int):.        
+00001110: 7265 7475 726e 2074 656e 736f 722e 7669  return tensor.vi
+00001120: 6577 2862 737a 2c20 7365 715f 6c65 6e2c  ew(bsz, seq_len,
+00001130: 2073 656c 662e 6e75 6d5f 6865 6164 732c   self.num_heads,
+00001140: 2073 656c 662e 6865 6164 5f64 696d 292e   self.head_dim).
+00001150: 7377 6170 6178 6573 2831 2c20 3229 0a0a  swapaxes(1, 2)..
+00001160: 2020 2020 6465 6620 636f 6e73 7472 7563      def construc
+00001170: 7428 0a20 2020 2020 2020 2073 656c 662c  t(.        self,
+00001180: 0a20 2020 2020 2020 2068 6964 6465 6e5f  .        hidden_
+00001190: 7374 6174 6573 3a20 6d69 6e64 7370 6f72  states: mindspor
+000011a0: 652e 5465 6e73 6f72 2c0a 2020 2020 2020  e.Tensor,.      
+000011b0: 2020 6b65 795f 7661 6c75 655f 7374 6174    key_value_stat
+000011c0: 6573 3a20 4f70 7469 6f6e 616c 5b6d 696e  es: Optional[min
+000011d0: 6473 706f 7265 2e54 656e 736f 725d 203d  dspore.Tensor] =
+000011e0: 204e 6f6e 652c 0a20 2020 2020 2020 2070   None,.        p
+000011f0: 6173 745f 6b65 795f 7661 6c75 653a 204f  ast_key_value: O
+00001200: 7074 696f 6e61 6c5b 5475 706c 655b 6d69  ptional[Tuple[mi
+00001210: 6e64 7370 6f72 652e 5465 6e73 6f72 5d5d  ndspore.Tensor]]
+00001220: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00001230: 2061 7474 656e 7469 6f6e 5f6d 6173 6b3a   attention_mask:
+00001240: 204f 7074 696f 6e61 6c5b 6d69 6e64 7370   Optional[mindsp
+00001250: 6f72 652e 5465 6e73 6f72 5d20 3d20 4e6f  ore.Tensor] = No
+00001260: 6e65 2c0a 2020 2020 2020 2020 6c61 7965  ne,.        laye
+00001270: 725f 6865 6164 5f6d 6173 6b3a 204f 7074  r_head_mask: Opt
+00001280: 696f 6e61 6c5b 6d69 6e64 7370 6f72 652e  ional[mindspore.
+00001290: 5465 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a  Tensor] = None,.
+000012a0: 2020 2020 2020 2020 6f75 7470 7574 5f61          output_a
+000012b0: 7474 656e 7469 6f6e 733a 2062 6f6f 6c20  ttentions: bool 
+000012c0: 3d20 4661 6c73 652c 0a20 2020 2029 202d  = False,.    ) -
+000012d0: 3e20 5475 706c 655b 6d69 6e64 7370 6f72  > Tuple[mindspor
+000012e0: 652e 5465 6e73 6f72 2c20 4f70 7469 6f6e  e.Tensor, Option
+000012f0: 616c 5b6d 696e 6473 706f 7265 2e54 656e  al[mindspore.Ten
+00001300: 736f 725d 2c20 4f70 7469 6f6e 616c 5b54  sor], Optional[T
+00001310: 7570 6c65 5b6d 696e 6473 706f 7265 2e54  uple[mindspore.T
+00001320: 656e 736f 725d 5d5d 3a0a 2020 2020 2020  ensor]]]:.      
+00001330: 2020 2222 2249 6e70 7574 2073 6861 7065    """Input shape
+00001340: 3a20 4261 7463 6820 7820 5469 6d65 2078  : Batch x Time x
+00001350: 2043 6861 6e6e 656c 2222 220a 0a20 2020   Channel"""..   
+00001360: 2020 2020 2023 2069 6620 6b65 795f 7661       # if key_va
+00001370: 6c75 655f 7374 6174 6573 2061 7265 2070  lue_states are p
+00001380: 726f 7669 6465 6420 7468 6973 206c 6179  rovided this lay
+00001390: 6572 2069 7320 7573 6564 2061 7320 6120  er is used as a 
+000013a0: 6372 6f73 732d 6174 7465 6e74 696f 6e20  cross-attention 
+000013b0: 6c61 7965 720a 2020 2020 2020 2020 2320  layer.        # 
+000013c0: 666f 7220 7468 6520 6465 636f 6465 720a  for the decoder.
+000013d0: 2020 2020 2020 2020 6973 5f63 726f 7373          is_cross
+000013e0: 5f61 7474 656e 7469 6f6e 203d 206b 6579  _attention = key
+000013f0: 5f76 616c 7565 5f73 7461 7465 7320 6973  _value_states is
+00001400: 206e 6f74 204e 6f6e 650a 0a20 2020 2020   not None..     
+00001410: 2020 2062 737a 2c20 7467 745f 6c65 6e2c     bsz, tgt_len,
+00001420: 205f 203d 2068 6964 6465 6e5f 7374 6174   _ = hidden_stat
+00001430: 6573 2e73 6861 7065 0a0a 2020 2020 2020  es.shape..      
+00001440: 2020 2320 6765 7420 7175 6572 7920 7072    # get query pr
+00001450: 6f6a 0a20 2020 2020 2020 2071 7565 7279  oj.        query
+00001460: 5f73 7461 7465 7320 3d20 7365 6c66 2e71  _states = self.q
+00001470: 5f70 726f 6a28 6869 6464 656e 5f73 7461  _proj(hidden_sta
+00001480: 7465 7329 202a 2073 656c 662e 7363 616c  tes) * self.scal
+00001490: 696e 670a 2020 2020 2020 2020 2320 6765  ing.        # ge
+000014a0: 7420 6b65 792c 2076 616c 7565 2070 726f  t key, value pro
+000014b0: 6a0a 2020 2020 2020 2020 2320 6070 6173  j.        # `pas
+000014c0: 745f 6b65 795f 7661 6c75 655b 305d 2e73  t_key_value[0].s
+000014d0: 6861 7065 5b32 5d20 3d3d 206b 6579 5f76  hape[2] == key_v
+000014e0: 616c 7565 5f73 7461 7465 732e 7368 6170  alue_states.shap
+000014f0: 655b 315d 600a 2020 2020 2020 2020 2320  e[1]`.        # 
+00001500: 6973 2063 6865 636b 696e 6720 7468 6174  is checking that
+00001510: 2074 6865 2060 7365 7175 656e 6365 5f6c   the `sequence_l
+00001520: 656e 6774 6860 206f 6620 7468 6520 6070  ength` of the `p
+00001530: 6173 745f 6b65 795f 7661 6c75 6560 2069  ast_key_value` i
+00001540: 7320 7468 6520 7361 6d65 2061 730a 2020  s the same as.  
+00001550: 2020 2020 2020 2320 7468 6520 7072 6f76        # the prov
+00001560: 6964 6564 2060 6b65 795f 7661 6c75 655f  ided `key_value_
+00001570: 7374 6174 6573 6020 746f 2073 7570 706f  states` to suppo
+00001580: 7274 2070 7265 6669 7820 7475 6e69 6e67  rt prefix tuning
+00001590: 0a20 2020 2020 2020 2069 6620 280a 2020  .        if (.  
+000015a0: 2020 2020 2020 2020 2020 6973 5f63 726f            is_cro
+000015b0: 7373 5f61 7474 656e 7469 6f6e 0a20 2020  ss_attention.   
+000015c0: 2020 2020 2020 2020 2061 6e64 2070 6173           and pas
+000015d0: 745f 6b65 795f 7661 6c75 6520 6973 206e  t_key_value is n
+000015e0: 6f74 204e 6f6e 650a 2020 2020 2020 2020  ot None.        
+000015f0: 2020 2020 616e 6420 7061 7374 5f6b 6579      and past_key
+00001600: 5f76 616c 7565 5b30 5d2e 7368 6170 655b  _value[0].shape[
+00001610: 325d 203d 3d20 6b65 795f 7661 6c75 655f  2] == key_value_
+00001620: 7374 6174 6573 2e73 6861 7065 5b31 5d0a  states.shape[1].
+00001630: 2020 2020 2020 2020 293a 0a20 2020 2020          ):.     
+00001640: 2020 2020 2020 2023 2072 6575 7365 206b         # reuse k
+00001650: 2c76 2c20 6372 6f73 735f 6174 7465 6e74  ,v, cross_attent
+00001660: 696f 6e73 0a20 2020 2020 2020 2020 2020  ions.           
+00001670: 206b 6579 5f73 7461 7465 7320 3d20 7061   key_states = pa
+00001680: 7374 5f6b 6579 5f76 616c 7565 5b30 5d0a  st_key_value[0].
+00001690: 2020 2020 2020 2020 2020 2020 7661 6c75              valu
+000016a0: 655f 7374 6174 6573 203d 2070 6173 745f  e_states = past_
+000016b0: 6b65 795f 7661 6c75 655b 315d 0a20 2020  key_value[1].   
+000016c0: 2020 2020 2065 6c69 6620 6973 5f63 726f       elif is_cro
+000016d0: 7373 5f61 7474 656e 7469 6f6e 3a0a 2020  ss_attention:.  
+000016e0: 2020 2020 2020 2020 2020 2320 6372 6f73            # cros
+000016f0: 735f 6174 7465 6e74 696f 6e73 0a20 2020  s_attentions.   
+00001700: 2020 2020 2020 2020 206b 6579 5f73 7461           key_sta
+00001710: 7465 7320 3d20 7365 6c66 2e5f 7368 6170  tes = self._shap
+00001720: 6528 7365 6c66 2e6b 5f70 726f 6a28 6b65  e(self.k_proj(ke
+00001730: 795f 7661 6c75 655f 7374 6174 6573 292c  y_value_states),
+00001740: 202d 312c 2062 737a 290a 2020 2020 2020   -1, bsz).      
+00001750: 2020 2020 2020 7661 6c75 655f 7374 6174        value_stat
+00001760: 6573 203d 2073 656c 662e 5f73 6861 7065  es = self._shape
+00001770: 2873 656c 662e 765f 7072 6f6a 286b 6579  (self.v_proj(key
+00001780: 5f76 616c 7565 5f73 7461 7465 7329 2c20  _value_states), 
+00001790: 2d31 2c20 6273 7a29 0a20 2020 2020 2020  -1, bsz).       
+000017a0: 2065 6c69 6620 7061 7374 5f6b 6579 5f76   elif past_key_v
+000017b0: 616c 7565 2069 7320 6e6f 7420 4e6f 6e65  alue is not None
+000017c0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+000017d0: 7265 7573 6520 6b2c 2076 2c20 7365 6c66  reuse k, v, self
+000017e0: 5f61 7474 656e 7469 6f6e 0a20 2020 2020  _attention.     
+000017f0: 2020 2020 2020 206b 6579 5f73 7461 7465         key_state
+00001800: 7320 3d20 7365 6c66 2e5f 7368 6170 6528  s = self._shape(
+00001810: 7365 6c66 2e6b 5f70 726f 6a28 6869 6464  self.k_proj(hidd
+00001820: 656e 5f73 7461 7465 7329 2c20 2d31 2c20  en_states), -1, 
+00001830: 6273 7a29 0a20 2020 2020 2020 2020 2020  bsz).           
+00001840: 2076 616c 7565 5f73 7461 7465 7320 3d20   value_states = 
+00001850: 7365 6c66 2e5f 7368 6170 6528 7365 6c66  self._shape(self
+00001860: 2e76 5f70 726f 6a28 6869 6464 656e 5f73  .v_proj(hidden_s
+00001870: 7461 7465 7329 2c20 2d31 2c20 6273 7a29  tates), -1, bsz)
+00001880: 0a20 2020 2020 2020 2020 2020 206b 6579  .            key
+00001890: 5f73 7461 7465 7320 3d20 6f70 732e 6361  _states = ops.ca
+000018a0: 7428 5b70 6173 745f 6b65 795f 7661 6c75  t([past_key_valu
+000018b0: 655b 305d 2c20 6b65 795f 7374 6174 6573  e[0], key_states
+000018c0: 5d2c 2061 7869 733d 3229 0a20 2020 2020  ], axis=2).     
+000018d0: 2020 2020 2020 2076 616c 7565 5f73 7461         value_sta
+000018e0: 7465 7320 3d20 6f70 732e 6361 7428 5b70  tes = ops.cat([p
+000018f0: 6173 745f 6b65 795f 7661 6c75 655b 315d  ast_key_value[1]
+00001900: 2c20 7661 6c75 655f 7374 6174 6573 5d2c  , value_states],
+00001910: 2061 7869 733d 3229 0a20 2020 2020 2020   axis=2).       
+00001920: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00001930: 2020 2023 2073 656c 665f 6174 7465 6e74     # self_attent
+00001940: 696f 6e0a 2020 2020 2020 2020 2020 2020  ion.            
+00001950: 6b65 795f 7374 6174 6573 203d 2073 656c  key_states = sel
+00001960: 662e 5f73 6861 7065 2873 656c 662e 6b5f  f._shape(self.k_
+00001970: 7072 6f6a 2868 6964 6465 6e5f 7374 6174  proj(hidden_stat
+00001980: 6573 292c 202d 312c 2062 737a 290a 2020  es), -1, bsz).  
+00001990: 2020 2020 2020 2020 2020 7661 6c75 655f            value_
+000019a0: 7374 6174 6573 203d 2073 656c 662e 5f73  states = self._s
+000019b0: 6861 7065 2873 656c 662e 765f 7072 6f6a  hape(self.v_proj
+000019c0: 2868 6964 6465 6e5f 7374 6174 6573 292c  (hidden_states),
+000019d0: 202d 312c 2062 737a 290a 0a20 2020 2020   -1, bsz)..     
+000019e0: 2020 2069 6620 7365 6c66 2e69 735f 6465     if self.is_de
+000019f0: 636f 6465 723a 0a20 2020 2020 2020 2020  coder:.         
+00001a00: 2020 2023 2069 6620 6372 6f73 735f 6174     # if cross_at
+00001a10: 7465 6e74 696f 6e20 7361 7665 2054 7570  tention save Tup
+00001a20: 6c65 286d 696e 6473 706f 7265 2e54 656e  le(mindspore.Ten
+00001a30: 736f 722c 206d 696e 6473 706f 7265 2e54  sor, mindspore.T
+00001a40: 656e 736f 7229 206f 6620 616c 6c20 6372  ensor) of all cr
+00001a50: 6f73 7320 6174 7465 6e74 696f 6e20 6b65  oss attention ke
+00001a60: 792f 7661 6c75 655f 7374 6174 6573 2e0a  y/value_states..
+00001a70: 2020 2020 2020 2020 2020 2020 2320 4675              # Fu
+00001a80: 7274 6865 7220 6361 6c6c 7320 746f 2063  rther calls to c
+00001a90: 726f 7373 5f61 7474 656e 7469 6f6e 206c  ross_attention l
+00001aa0: 6179 6572 2063 616e 2074 6865 6e20 7265  ayer can then re
+00001ab0: 7573 6520 616c 6c20 6372 6f73 732d 6174  use all cross-at
+00001ac0: 7465 6e74 696f 6e0a 2020 2020 2020 2020  tention.        
+00001ad0: 2020 2020 2320 6b65 792f 7661 6c75 655f      # key/value_
+00001ae0: 7374 6174 6573 2028 6669 7273 7420 2269  states (first "i
+00001af0: 6622 2063 6173 6529 0a20 2020 2020 2020  f" case).       
+00001b00: 2020 2020 2023 2069 6620 756e 692d 6469       # if uni-di
+00001b10: 7265 6374 696f 6e61 6c20 7365 6c66 2d61  rectional self-a
+00001b20: 7474 656e 7469 6f6e 2028 6465 636f 6465  ttention (decode
+00001b30: 7229 2073 6176 6520 5475 706c 6528 6d69  r) save Tuple(mi
+00001b40: 6e64 7370 6f72 652e 5465 6e73 6f72 2c20  ndspore.Tensor, 
+00001b50: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+00001b60: 2920 6f66 0a20 2020 2020 2020 2020 2020  ) of.           
+00001b70: 2023 2061 6c6c 2070 7265 7669 6f75 7320   # all previous 
+00001b80: 6465 636f 6465 7220 6b65 792f 7661 6c75  decoder key/valu
+00001b90: 655f 7374 6174 6573 2e20 4675 7274 6865  e_states. Furthe
+00001ba0: 7220 6361 6c6c 7320 746f 2075 6e69 2d64  r calls to uni-d
+00001bb0: 6972 6563 7469 6f6e 616c 2073 656c 662d  irectional self-
+00001bc0: 6174 7465 6e74 696f 6e0a 2020 2020 2020  attention.      
+00001bd0: 2020 2020 2020 2320 6361 6e20 636f 6e63        # can conc
+00001be0: 6174 2070 7265 7669 6f75 7320 6465 636f  at previous deco
+00001bf0: 6465 7220 6b65 792f 7661 6c75 655f 7374  der key/value_st
+00001c00: 6174 6573 2074 6f20 6375 7272 656e 7420  ates to current 
+00001c10: 7072 6f6a 6563 7465 6420 6b65 792f 7661  projected key/va
+00001c20: 6c75 655f 7374 6174 6573 2028 7468 6972  lue_states (thir
+00001c30: 6420 2265 6c69 6622 2063 6173 6529 0a20  d "elif" case). 
+00001c40: 2020 2020 2020 2020 2020 2023 2069 6620             # if 
+00001c50: 656e 636f 6465 7220 6269 2d64 6972 6563  encoder bi-direc
+00001c60: 7469 6f6e 616c 2073 656c 662d 6174 7465  tional self-atte
+00001c70: 6e74 696f 6e20 6070 6173 745f 6b65 795f  ntion `past_key_
+00001c80: 7661 6c75 6560 2069 7320 616c 7761 7973  value` is always
+00001c90: 2060 4e6f 6e65 600a 2020 2020 2020 2020   `None`.        
+00001ca0: 2020 2020 7061 7374 5f6b 6579 5f76 616c      past_key_val
+00001cb0: 7565 203d 2028 6b65 795f 7374 6174 6573  ue = (key_states
+00001cc0: 2c20 7661 6c75 655f 7374 6174 6573 290a  , value_states).
+00001cd0: 0a20 2020 2020 2020 2070 726f 6a5f 7368  .        proj_sh
+00001ce0: 6170 6520 3d20 2862 737a 202a 2073 656c  ape = (bsz * sel
+00001cf0: 662e 6e75 6d5f 6865 6164 732c 202d 312c  f.num_heads, -1,
+00001d00: 2073 656c 662e 6865 6164 5f64 696d 290a   self.head_dim).
+00001d10: 2020 2020 2020 2020 7175 6572 795f 7374          query_st
+00001d20: 6174 6573 203d 2073 656c 662e 5f73 6861  ates = self._sha
+00001d30: 7065 2871 7565 7279 5f73 7461 7465 732c  pe(query_states,
+00001d40: 2074 6774 5f6c 656e 2c20 6273 7a29 2e76   tgt_len, bsz).v
+00001d50: 6965 7728 2a70 726f 6a5f 7368 6170 6529  iew(*proj_shape)
+00001d60: 0a20 2020 2020 2020 206b 6579 5f73 7461  .        key_sta
+00001d70: 7465 7320 3d20 6b65 795f 7374 6174 6573  tes = key_states
+00001d80: 2e72 6573 6861 7065 282a 7072 6f6a 5f73  .reshape(*proj_s
+00001d90: 6861 7065 290a 2020 2020 2020 2020 7661  hape).        va
+00001da0: 6c75 655f 7374 6174 6573 203d 2076 616c  lue_states = val
+00001db0: 7565 5f73 7461 7465 732e 7265 7368 6170  ue_states.reshap
+00001dc0: 6528 2a70 726f 6a5f 7368 6170 6529 0a0a  e(*proj_shape)..
+00001dd0: 2020 2020 2020 2020 7372 635f 6c65 6e20          src_len 
+00001de0: 3d20 6b65 795f 7374 6174 6573 2e73 6861  = key_states.sha
+00001df0: 7065 5b31 5d0a 2020 2020 2020 2020 6174  pe[1].        at
+00001e00: 746e 5f77 6569 6768 7473 203d 206f 7073  tn_weights = ops
+00001e10: 2e62 6d6d 2871 7565 7279 5f73 7461 7465  .bmm(query_state
+00001e20: 732c 206b 6579 5f73 7461 7465 732e 7377  s, key_states.sw
+00001e30: 6170 6178 6573 2831 2c20 3229 290a 0a20  apaxes(1, 2)).. 
+00001e40: 2020 2020 2020 2069 6620 6174 746e 5f77         if attn_w
+00001e50: 6569 6768 7473 2e73 6861 7065 2021 3d20  eights.shape != 
+00001e60: 2862 737a 202a 2073 656c 662e 6e75 6d5f  (bsz * self.num_
+00001e70: 6865 6164 732c 2074 6774 5f6c 656e 2c20  heads, tgt_len, 
+00001e80: 7372 635f 6c65 6e29 3a0a 2020 2020 2020  src_len):.      
+00001e90: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
+00001ea0: 6545 7272 6f72 280a 2020 2020 2020 2020  eError(.        
+00001eb0: 2020 2020 2020 2020 6622 4174 7465 6e74          f"Attent
+00001ec0: 696f 6e20 7765 6967 6874 7320 7368 6f75  ion weights shou
+00001ed0: 6c64 2062 6520 6f66 2073 697a 6520 7b28  ld be of size {(
+00001ee0: 6273 7a20 2a20 7365 6c66 2e6e 756d 5f68  bsz * self.num_h
+00001ef0: 6561 6473 2c20 7467 745f 6c65 6e2c 2073  eads, tgt_len, s
+00001f00: 7263 5f6c 656e 297d 2c20 6275 7420 6973  rc_len)}, but is
+00001f10: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00001f20: 2020 6622 207b 6174 746e 5f77 6569 6768    f" {attn_weigh
+00001f30: 7473 2e73 6861 7065 7d22 0a20 2020 2020  ts.shape}".     
+00001f40: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00001f50: 2020 6966 2061 7474 656e 7469 6f6e 5f6d    if attention_m
+00001f60: 6173 6b20 6973 206e 6f74 204e 6f6e 653a  ask is not None:
+00001f70: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00001f80: 6174 7465 6e74 696f 6e5f 6d61 736b 2e73  attention_mask.s
+00001f90: 6861 7065 2021 3d20 2862 737a 2c20 312c  hape != (bsz, 1,
+00001fa0: 2074 6774 5f6c 656e 2c20 7372 635f 6c65   tgt_len, src_le
+00001fb0: 6e29 3a0a 2020 2020 2020 2020 2020 2020  n):.            
+00001fc0: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+00001fd0: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+00001fe0: 2020 2020 2020 2020 2020 6622 4174 7465            f"Atte
+00001ff0: 6e74 696f 6e20 6d61 736b 2073 686f 756c  ntion mask shoul
+00002000: 6420 6265 206f 6620 7369 7a65 207b 2862  d be of size {(b
+00002010: 737a 2c20 312c 2074 6774 5f6c 656e 2c20  sz, 1, tgt_len, 
+00002020: 7372 635f 6c65 6e29 7d2c 2062 7574 2069  src_len)}, but i
+00002030: 7320 7b61 7474 656e 7469 6f6e 5f6d 6173  s {attention_mas
+00002040: 6b2e 7368 6170 657d 220a 2020 2020 2020  k.shape}".      
+00002050: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00002060: 2020 2020 2020 2020 6174 746e 5f77 6569          attn_wei
+00002070: 6768 7473 203d 2061 7474 6e5f 7765 6967  ghts = attn_weig
+00002080: 6874 732e 7669 6577 2862 737a 2c20 7365  hts.view(bsz, se
+00002090: 6c66 2e6e 756d 5f68 6561 6473 2c20 7467  lf.num_heads, tg
+000020a0: 745f 6c65 6e2c 2073 7263 5f6c 656e 2920  t_len, src_len) 
+000020b0: 2b20 6174 7465 6e74 696f 6e5f 6d61 736b  + attention_mask
+000020c0: 0a20 2020 2020 2020 2020 2020 2061 7474  .            att
+000020d0: 6e5f 7765 6967 6874 7320 3d20 6174 746e  n_weights = attn
+000020e0: 5f77 6569 6768 7473 2e76 6965 7728 6273  _weights.view(bs
+000020f0: 7a20 2a20 7365 6c66 2e6e 756d 5f68 6561  z * self.num_hea
+00002100: 6473 2c20 7467 745f 6c65 6e2c 2073 7263  ds, tgt_len, src
+00002110: 5f6c 656e 290a 0a20 2020 2020 2020 2061  _len)..        a
+00002120: 7474 6e5f 7765 6967 6874 7320 3d20 6f70  ttn_weights = op
+00002130: 732e 736f 6674 6d61 7828 6174 746e 5f77  s.softmax(attn_w
+00002140: 6569 6768 7473 2c20 6178 6973 3d2d 3129  eights, axis=-1)
+00002150: 0a0a 2020 2020 2020 2020 6966 206c 6179  ..        if lay
+00002160: 6572 5f68 6561 645f 6d61 736b 2069 7320  er_head_mask is 
+00002170: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+00002180: 2020 2020 2020 6966 206c 6179 6572 5f68        if layer_h
+00002190: 6561 645f 6d61 736b 2e73 6861 7065 2021  ead_mask.shape !
+000021a0: 3d20 2873 656c 662e 6e75 6d5f 6865 6164  = (self.num_head
+000021b0: 732c 293a 0a20 2020 2020 2020 2020 2020  s,):.           
+000021c0: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+000021d0: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+000021e0: 2020 2020 2020 2020 2020 2066 2248 6561             f"Hea
+000021f0: 6420 6d61 736b 2066 6f72 2061 2073 696e  d mask for a sin
+00002200: 676c 6520 6c61 7965 7220 7368 6f75 6c64  gle layer should
+00002210: 2062 6520 6f66 2073 697a 6520 7b28 7365   be of size {(se
+00002220: 6c66 2e6e 756d 5f68 6561 6473 2c29 7d2c  lf.num_heads,)},
+00002230: 2062 7574 2069 7322 0a20 2020 2020 2020   but is".       
+00002240: 2020 2020 2020 2020 2020 2020 2066 2220               f" 
+00002250: 7b6c 6179 6572 5f68 6561 645f 6d61 736b  {layer_head_mask
+00002260: 2e73 6861 7065 7d22 0a20 2020 2020 2020  .shape}".       
+00002270: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00002280: 2020 2020 2020 2061 7474 6e5f 7765 6967         attn_weig
+00002290: 6874 7320 3d20 6c61 7965 725f 6865 6164  hts = layer_head
+000022a0: 5f6d 6173 6b2e 7669 6577 2831 2c20 2d31  _mask.view(1, -1
+000022b0: 2c20 312c 2031 2920 2a20 6174 746e 5f77  , 1, 1) * attn_w
+000022c0: 6569 6768 7473 2e76 6965 7728 6273 7a2c  eights.view(bsz,
+000022d0: 2073 656c 662e 6e75 6d5f 6865 6164 732c   self.num_heads,
+000022e0: 2074 6774 5f6c 656e 2c20 7372 635f 6c65   tgt_len, src_le
+000022f0: 6e29 0a20 2020 2020 2020 2020 2020 2061  n).            a
+00002300: 7474 6e5f 7765 6967 6874 7320 3d20 6174  ttn_weights = at
+00002310: 746e 5f77 6569 6768 7473 2e76 6965 7728  tn_weights.view(
+00002320: 6273 7a20 2a20 7365 6c66 2e6e 756d 5f68  bsz * self.num_h
+00002330: 6561 6473 2c20 7467 745f 6c65 6e2c 2073  eads, tgt_len, s
+00002340: 7263 5f6c 656e 290a 0a20 2020 2020 2020  rc_len)..       
+00002350: 2069 6620 6f75 7470 7574 5f61 7474 656e   if output_atten
+00002360: 7469 6f6e 733a 0a20 2020 2020 2020 2020  tions:.         
+00002370: 2020 2023 2074 6869 7320 6f70 6572 6174     # this operat
+00002380: 696f 6e20 6973 2061 2062 6974 2061 776b  ion is a bit awk
+00002390: 7761 7264 2c20 6275 7420 6974 2773 2072  ward, but it's r
+000023a0: 6571 7569 7265 6420 746f 0a20 2020 2020  equired to.     
+000023b0: 2020 2020 2020 2023 206d 616b 6520 7375         # make su
+000023c0: 7265 2074 6861 7420 6174 746e 5f77 6569  re that attn_wei
+000023d0: 6768 7473 206b 6565 7073 2069 7473 2067  ghts keeps its g
+000023e0: 7261 6469 656e 742e 0a20 2020 2020 2020  radient..       
+000023f0: 2020 2020 2023 2049 6e20 6f72 6465 7220       # In order 
+00002400: 746f 2064 6f20 736f 2c20 6174 746e 5f77  to do so, attn_w
+00002410: 6569 6768 7473 2068 6176 6520 746f 2062  eights have to b
+00002420: 6520 7265 7368 6170 6564 0a20 2020 2020  e reshaped.     
+00002430: 2020 2020 2020 2023 2074 7769 6365 2061         # twice a
+00002440: 6e64 2068 6176 6520 746f 2062 6520 7265  nd have to be re
+00002450: 7573 6564 2069 6e20 7468 6520 666f 6c6c  used in the foll
+00002460: 6f77 696e 670a 2020 2020 2020 2020 2020  owing.          
+00002470: 2020 6174 746e 5f77 6569 6768 7473 5f72    attn_weights_r
+00002480: 6573 6861 7065 6420 3d20 6174 746e 5f77  eshaped = attn_w
+00002490: 6569 6768 7473 2e76 6965 7728 6273 7a2c  eights.view(bsz,
+000024a0: 2073 656c 662e 6e75 6d5f 6865 6164 732c   self.num_heads,
+000024b0: 2074 6774 5f6c 656e 2c20 7372 635f 6c65   tgt_len, src_le
+000024c0: 6e29 0a20 2020 2020 2020 2020 2020 2061  n).            a
+000024d0: 7474 6e5f 7765 6967 6874 7320 3d20 6174  ttn_weights = at
+000024e0: 746e 5f77 6569 6768 7473 5f72 6573 6861  tn_weights_resha
+000024f0: 7065 642e 7669 6577 2862 737a 202a 2073  ped.view(bsz * s
+00002500: 656c 662e 6e75 6d5f 6865 6164 732c 2074  elf.num_heads, t
+00002510: 6774 5f6c 656e 2c20 7372 635f 6c65 6e29  gt_len, src_len)
+00002520: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00002530: 2020 2020 2020 2020 2020 2061 7474 6e5f             attn_
+00002540: 7765 6967 6874 735f 7265 7368 6170 6564  weights_reshaped
+00002550: 203d 204e 6f6e 650a 0a20 2020 2020 2020   = None..       
+00002560: 2061 7474 6e5f 7072 6f62 7320 3d20 6f70   attn_probs = op
+00002570: 732e 6472 6f70 6f75 7428 6174 746e 5f77  s.dropout(attn_w
+00002580: 6569 6768 7473 2c20 703d 7365 6c66 2e64  eights, p=self.d
+00002590: 726f 706f 7574 2c20 7472 6169 6e69 6e67  ropout, training
+000025a0: 3d73 656c 662e 7472 6169 6e69 6e67 290a  =self.training).
+000025b0: 0a20 2020 2020 2020 2061 7474 6e5f 6f75  .        attn_ou
+000025c0: 7470 7574 203d 206f 7073 2e62 6d6d 2861  tput = ops.bmm(a
+000025d0: 7474 6e5f 7072 6f62 732c 2076 616c 7565  ttn_probs, value
+000025e0: 5f73 7461 7465 7329 0a0a 2020 2020 2020  _states)..      
+000025f0: 2020 6966 2061 7474 6e5f 6f75 7470 7574    if attn_output
+00002600: 2e73 6861 7065 2021 3d20 2862 737a 202a  .shape != (bsz *
+00002610: 2073 656c 662e 6e75 6d5f 6865 6164 732c   self.num_heads,
+00002620: 2074 6774 5f6c 656e 2c20 7365 6c66 2e68   tgt_len, self.h
+00002630: 6561 645f 6469 6d29 3a0a 2020 2020 2020  ead_dim):.      
+00002640: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
+00002650: 6545 7272 6f72 280a 2020 2020 2020 2020  eError(.        
+00002660: 2020 2020 2020 2020 6622 6061 7474 6e5f          f"`attn_
+00002670: 6f75 7470 7574 6020 7368 6f75 6c64 2062  output` should b
+00002680: 6520 6f66 2073 697a 6520 7b28 6273 7a20  e of size {(bsz 
+00002690: 2a20 7365 6c66 2e6e 756d 5f68 6561 6473  * self.num_heads
+000026a0: 2c20 7467 745f 6c65 6e2c 2073 656c 662e  , tgt_len, self.
+000026b0: 6865 6164 5f64 696d 297d 2c20 6275 7420  head_dim)}, but 
+000026c0: 6973 220a 2020 2020 2020 2020 2020 2020  is".            
+000026d0: 2020 2020 6622 207b 6174 746e 5f6f 7574      f" {attn_out
+000026e0: 7075 742e 7368 6170 657d 220a 2020 2020  put.shape}".    
+000026f0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00002700: 2020 2061 7474 6e5f 6f75 7470 7574 203d     attn_output =
+00002710: 2061 7474 6e5f 6f75 7470 7574 2e76 6965   attn_output.vie
+00002720: 7728 6273 7a2c 2073 656c 662e 6e75 6d5f  w(bsz, self.num_
+00002730: 6865 6164 732c 2074 6774 5f6c 656e 2c20  heads, tgt_len, 
+00002740: 7365 6c66 2e68 6561 645f 6469 6d29 0a20  self.head_dim). 
+00002750: 2020 2020 2020 2061 7474 6e5f 6f75 7470         attn_outp
+00002760: 7574 203d 2061 7474 6e5f 6f75 7470 7574  ut = attn_output
+00002770: 2e73 7761 7061 7865 7328 312c 2032 290a  .swapaxes(1, 2).
+00002780: 0a20 2020 2020 2020 2023 2055 7365 2074  .        # Use t
+00002790: 6865 2060 656d 6265 645f 6469 6d60 2066  he `embed_dim` f
+000027a0: 726f 6d20 7468 6520 636f 6e66 6967 2028  rom the config (
+000027b0: 7374 6f72 6564 2069 6e20 7468 6520 636c  stored in the cl
+000027c0: 6173 7329 2072 6174 6865 7220 7468 616e  ass) rather than
+000027d0: 2060 6869 6464 656e 5f73 7461 7465 6020   `hidden_state` 
+000027e0: 6265 6361 7573 6520 6061 7474 6e5f 6f75  because `attn_ou
+000027f0: 7470 7574 6020 6361 6e20 6265 0a20 2020  tput` can be.   
+00002800: 2020 2020 2023 2070 6172 7469 7469 6f6e       # partition
+00002810: 6564 2061 6372 6f73 7320 4750 5573 2077  ed across GPUs w
+00002820: 6865 6e20 7573 696e 6720 7465 6e73 6f72  hen using tensor
+00002830: 2d70 6172 616c 6c65 6c69 736d 2e0a 2020  -parallelism..  
+00002840: 2020 2020 2020 6174 746e 5f6f 7574 7075        attn_outpu
+00002850: 7420 3d20 6174 746e 5f6f 7574 7075 742e  t = attn_output.
+00002860: 7265 7368 6170 6528 6273 7a2c 2074 6774  reshape(bsz, tgt
+00002870: 5f6c 656e 2c20 7365 6c66 2e65 6d62 6564  _len, self.embed
+00002880: 5f64 696d 290a 0a20 2020 2020 2020 2061  _dim)..        a
+00002890: 7474 6e5f 6f75 7470 7574 203d 2073 656c  ttn_output = sel
+000028a0: 662e 6f75 745f 7072 6f6a 2861 7474 6e5f  f.out_proj(attn_
+000028b0: 6f75 7470 7574 290a 0a20 2020 2020 2020  output)..       
+000028c0: 2072 6574 7572 6e20 6174 746e 5f6f 7574   return attn_out
+000028d0: 7075 742c 2061 7474 6e5f 7765 6967 6874  put, attn_weight
+000028e0: 735f 7265 7368 6170 6564 2c20 7061 7374  s_reshaped, past
+000028f0: 5f6b 6579 5f76 616c 7565 0a0a 0a23 2043  _key_value...# C
+00002900: 6f70 6965 6420 6672 6f6d 2074 7261 6e73  opied from trans
+00002910: 666f 726d 6572 732e 6d6f 6465 6c73 2e62  formers.models.b
+00002920: 6172 742e 6d6f 6465 6c69 6e67 5f62 6172  art.modeling_bar
+00002930: 742e 4261 7274 456e 636f 6465 724c 6179  t.BartEncoderLay
+00002940: 6572 2077 6974 6820 4261 7274 2d3e 426c  er with Bart->Bl
+00002950: 656e 6465 7262 6f74 536d 616c 6c2c 2042  enderbotSmall, B
+00002960: 4152 542d 3e42 4c45 4e44 4552 424f 545f  ART->BLENDERBOT_
+00002970: 534d 414c 4c0a 636c 6173 7320 426c 656e  SMALL.class Blen
+00002980: 6465 7262 6f74 536d 616c 6c45 6e63 6f64  derbotSmallEncod
+00002990: 6572 4c61 7965 7228 6e6e 2e43 656c 6c29  erLayer(nn.Cell)
+000029a0: 3a0a 2020 2020 6465 6620 5f5f 696e 6974  :.    def __init
+000029b0: 5f5f 2873 656c 662c 2063 6f6e 6669 673a  __(self, config:
+000029c0: 2042 6c65 6e64 6572 626f 7453 6d61 6c6c   BlenderbotSmall
+000029d0: 436f 6e66 6967 293a 0a20 2020 2020 2020  Config):.       
+000029e0: 2073 7570 6572 2829 2e5f 5f69 6e69 745f   super().__init_
+000029f0: 5f28 290a 2020 2020 2020 2020 7365 6c66  _().        self
+00002a00: 2e65 6d62 6564 5f64 696d 203d 2063 6f6e  .embed_dim = con
+00002a10: 6669 672e 645f 6d6f 6465 6c0a 0a20 2020  fig.d_model..   
+00002a20: 2020 2020 2073 656c 662e 7365 6c66 5f61       self.self_a
+00002a30: 7474 6e20 3d20 424c 454e 4445 5242 4f54  ttn = BLENDERBOT
+00002a40: 5f53 4d41 4c4c 5f41 5454 454e 5449 4f4e  _SMALL_ATTENTION
+00002a50: 5f43 4c41 5353 4553 5b63 6f6e 6669 672e  _CLASSES[config.
+00002a60: 5f61 7474 6e5f 696d 706c 656d 656e 7461  _attn_implementa
+00002a70: 7469 6f6e 5d28 0a20 2020 2020 2020 2020  tion](.         
+00002a80: 2020 2065 6d62 6564 5f64 696d 3d73 656c     embed_dim=sel
+00002a90: 662e 656d 6265 645f 6469 6d2c 0a20 2020  f.embed_dim,.   
+00002aa0: 2020 2020 2020 2020 206e 756d 5f68 6561           num_hea
+00002ab0: 6473 3d63 6f6e 6669 672e 656e 636f 6465  ds=config.encode
+00002ac0: 725f 6174 7465 6e74 696f 6e5f 6865 6164  r_attention_head
+00002ad0: 732c 0a20 2020 2020 2020 2020 2020 2064  s,.            d
+00002ae0: 726f 706f 7574 3d63 6f6e 6669 672e 6174  ropout=config.at
+00002af0: 7465 6e74 696f 6e5f 6472 6f70 6f75 742c  tention_dropout,
+00002b00: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+00002b10: 6669 673d 636f 6e66 6967 2c0a 2020 2020  fig=config,.    
+00002b20: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
+00002b30: 6c66 2e73 656c 665f 6174 746e 5f6c 6179  lf.self_attn_lay
+00002b40: 6572 5f6e 6f72 6d20 3d20 6e6e 2e4c 6179  er_norm = nn.Lay
+00002b50: 6572 4e6f 726d 2873 656c 662e 656d 6265  erNorm(self.embe
+00002b60: 645f 6469 6d29 0a20 2020 2020 2020 2073  d_dim).        s
+00002b70: 656c 662e 6472 6f70 6f75 7420 3d20 636f  elf.dropout = co
+00002b80: 6e66 6967 2e64 726f 706f 7574 0a20 2020  nfig.dropout.   
+00002b90: 2020 2020 2073 656c 662e 6163 7469 7661       self.activa
+00002ba0: 7469 6f6e 5f66 6e20 3d20 4143 5432 464e  tion_fn = ACT2FN
+00002bb0: 5b63 6f6e 6669 672e 6163 7469 7661 7469  [config.activati
+00002bc0: 6f6e 5f66 756e 6374 696f 6e5d 0a20 2020  on_function].   
+00002bd0: 2020 2020 2073 656c 662e 6163 7469 7661       self.activa
+00002be0: 7469 6f6e 5f64 726f 706f 7574 203d 2063  tion_dropout = c
+00002bf0: 6f6e 6669 672e 6163 7469 7661 7469 6f6e  onfig.activation
+00002c00: 5f64 726f 706f 7574 0a20 2020 2020 2020  _dropout.       
+00002c10: 2073 656c 662e 6663 3120 3d20 6e6e 2e44   self.fc1 = nn.D
+00002c20: 656e 7365 2873 656c 662e 656d 6265 645f  ense(self.embed_
+00002c30: 6469 6d2c 2063 6f6e 6669 672e 656e 636f  dim, config.enco
+00002c40: 6465 725f 6666 6e5f 6469 6d29 0a20 2020  der_ffn_dim).   
+00002c50: 2020 2020 2073 656c 662e 6663 3220 3d20       self.fc2 = 
+00002c60: 6e6e 2e44 656e 7365 2863 6f6e 6669 672e  nn.Dense(config.
+00002c70: 656e 636f 6465 725f 6666 6e5f 6469 6d2c  encoder_ffn_dim,
+00002c80: 2073 656c 662e 656d 6265 645f 6469 6d29   self.embed_dim)
+00002c90: 0a20 2020 2020 2020 2073 656c 662e 6669  .        self.fi
+00002ca0: 6e61 6c5f 6c61 7965 725f 6e6f 726d 203d  nal_layer_norm =
+00002cb0: 206e 6e2e 4c61 7965 724e 6f72 6d28 7365   nn.LayerNorm(se
+00002cc0: 6c66 2e65 6d62 6564 5f64 696d 290a 0a20  lf.embed_dim).. 
+00002cd0: 2020 2064 6566 2063 6f6e 7374 7275 6374     def construct
+00002ce0: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+00002cf0: 2020 2020 2020 2020 6869 6464 656e 5f73          hidden_s
+00002d00: 7461 7465 733a 206d 696e 6473 706f 7265  tates: mindspore
+00002d10: 2e54 656e 736f 722c 0a20 2020 2020 2020  .Tensor,.       
+00002d20: 2061 7474 656e 7469 6f6e 5f6d 6173 6b3a   attention_mask:
+00002d30: 206d 696e 6473 706f 7265 2e54 656e 736f   mindspore.Tenso
+00002d40: 722c 0a20 2020 2020 2020 206c 6179 6572  r,.        layer
+00002d50: 5f68 6561 645f 6d61 736b 3a20 6d69 6e64  _head_mask: mind
+00002d60: 7370 6f72 652e 5465 6e73 6f72 2c0a 2020  spore.Tensor,.  
+00002d70: 2020 2020 2020 6f75 7470 7574 5f61 7474        output_att
+00002d80: 656e 7469 6f6e 733a 204f 7074 696f 6e61  entions: Optiona
+00002d90: 6c5b 626f 6f6c 5d20 3d20 4661 6c73 652c  l[bool] = False,
+00002da0: 0a20 2020 2029 202d 3e20 5475 706c 655b  .    ) -> Tuple[
+00002db0: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+00002dc0: 2c20 4f70 7469 6f6e 616c 5b6d 696e 6473  , Optional[minds
+00002dd0: 706f 7265 2e54 656e 736f 725d 5d3a 0a20  pore.Tensor]]:. 
+00002de0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00002df0: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+00002e00: 2020 2020 2068 6964 6465 6e5f 7374 6174       hidden_stat
+00002e10: 6573 2028 606d 696e 6473 706f 7265 2e54  es (`mindspore.T
+00002e20: 656e 736f 7260 293a 2069 6e70 7574 2074  ensor`): input t
+00002e30: 6f20 7468 6520 6c61 7965 7220 6f66 2073  o the layer of s
+00002e40: 6861 7065 2060 2862 6174 6368 2c20 7365  hape `(batch, se
+00002e50: 715f 6c65 6e2c 2065 6d62 6564 5f64 696d  q_len, embed_dim
+00002e60: 2960 0a20 2020 2020 2020 2020 2020 2061  )`.            a
+00002e70: 7474 656e 7469 6f6e 5f6d 6173 6b20 2860  ttention_mask (`
+00002e80: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+00002e90: 6029 3a20 6174 7465 6e74 696f 6e20 6d61  `): attention ma
+00002ea0: 736b 206f 6620 7369 7a65 0a20 2020 2020  sk of size.     
+00002eb0: 2020 2020 2020 2020 2020 2060 2862 6174             `(bat
+00002ec0: 6368 2c20 312c 2074 6774 5f6c 656e 2c20  ch, 1, tgt_len, 
+00002ed0: 7372 635f 6c65 6e29 6020 7768 6572 6520  src_len)` where 
+00002ee0: 7061 6464 696e 6720 656c 656d 656e 7473  padding elements
+00002ef0: 2061 7265 2069 6e64 6963 6174 6564 2062   are indicated b
+00002f00: 7920 7665 7279 206c 6172 6765 206e 6567  y very large neg
+00002f10: 6174 6976 6520 7661 6c75 6573 2e0a 2020  ative values..  
+00002f20: 2020 2020 2020 2020 2020 6c61 7965 725f            layer_
+00002f30: 6865 6164 5f6d 6173 6b20 2860 6d69 6e64  head_mask (`mind
+00002f40: 7370 6f72 652e 5465 6e73 6f72 6029 3a20  spore.Tensor`): 
+00002f50: 6d61 736b 2066 6f72 2061 7474 656e 7469  mask for attenti
+00002f60: 6f6e 2068 6561 6473 2069 6e20 6120 6769  on heads in a gi
+00002f70: 7665 6e20 6c61 7965 7220 6f66 2073 697a  ven layer of siz
+00002f80: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00002f90: 2020 6028 656e 636f 6465 725f 6174 7465    `(encoder_atte
+00002fa0: 6e74 696f 6e5f 6865 6164 732c 2960 2e0a  ntion_heads,)`..
+00002fb0: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
+00002fc0: 7574 5f61 7474 656e 7469 6f6e 7320 2860  ut_attentions (`
+00002fd0: 626f 6f6c 602c 202a 6f70 7469 6f6e 616c  bool`, *optional
+00002fe0: 2a29 3a0a 2020 2020 2020 2020 2020 2020  *):.            
+00002ff0: 2020 2020 5768 6574 6865 7220 6f72 206e      Whether or n
+00003000: 6f74 2074 6f20 7265 7475 726e 2074 6865  ot to return the
+00003010: 2061 7474 656e 7469 6f6e 7320 7465 6e73   attentions tens
+00003020: 6f72 7320 6f66 2061 6c6c 2061 7474 656e  ors of all atten
+00003030: 7469 6f6e 206c 6179 6572 732e 2053 6565  tion layers. See
+00003040: 2060 6174 7465 6e74 696f 6e73 6020 756e   `attentions` un
+00003050: 6465 720a 2020 2020 2020 2020 2020 2020  der.            
+00003060: 2020 2020 7265 7475 726e 6564 2074 656e      returned ten
+00003070: 736f 7273 2066 6f72 206d 6f72 6520 6465  sors for more de
+00003080: 7461 696c 2e0a 2020 2020 2020 2020 2222  tail..        ""
+00003090: 220a 2020 2020 2020 2020 7265 7369 6475  ".        residu
+000030a0: 616c 203d 2068 6964 6465 6e5f 7374 6174  al = hidden_stat
+000030b0: 6573 0a20 2020 2020 2020 2068 6964 6465  es.        hidde
+000030c0: 6e5f 7374 6174 6573 2c20 6174 746e 5f77  n_states, attn_w
+000030d0: 6569 6768 7473 2c20 5f20 3d20 7365 6c66  eights, _ = self
+000030e0: 2e73 656c 665f 6174 746e 280a 2020 2020  .self_attn(.    
+000030f0: 2020 2020 2020 2020 6869 6464 656e 5f73          hidden_s
+00003100: 7461 7465 733d 6869 6464 656e 5f73 7461  tates=hidden_sta
+00003110: 7465 732c 0a20 2020 2020 2020 2020 2020  tes,.           
+00003120: 2061 7474 656e 7469 6f6e 5f6d 6173 6b3d   attention_mask=
+00003130: 6174 7465 6e74 696f 6e5f 6d61 736b 2c0a  attention_mask,.
+00003140: 2020 2020 2020 2020 2020 2020 6c61 7965              laye
+00003150: 725f 6865 6164 5f6d 6173 6b3d 6c61 7965  r_head_mask=laye
+00003160: 725f 6865 6164 5f6d 6173 6b2c 0a20 2020  r_head_mask,.   
+00003170: 2020 2020 2020 2020 206f 7574 7075 745f           output_
+00003180: 6174 7465 6e74 696f 6e73 3d6f 7574 7075  attentions=outpu
+00003190: 745f 6174 7465 6e74 696f 6e73 2c0a 2020  t_attentions,.  
+000031a0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000031b0: 6869 6464 656e 5f73 7461 7465 7320 3d20  hidden_states = 
+000031c0: 6f70 732e 6472 6f70 6f75 7428 6869 6464  ops.dropout(hidd
+000031d0: 656e 5f73 7461 7465 732c 2070 3d73 656c  en_states, p=sel
+000031e0: 662e 6472 6f70 6f75 742c 2074 7261 696e  f.dropout, train
+000031f0: 696e 673d 7365 6c66 2e74 7261 696e 696e  ing=self.trainin
+00003200: 6729 0a20 2020 2020 2020 2068 6964 6465  g).        hidde
+00003210: 6e5f 7374 6174 6573 203d 2072 6573 6964  n_states = resid
+00003220: 7561 6c20 2b20 6869 6464 656e 5f73 7461  ual + hidden_sta
+00003230: 7465 730a 2020 2020 2020 2020 6869 6464  tes.        hidd
+00003240: 656e 5f73 7461 7465 7320 3d20 7365 6c66  en_states = self
+00003250: 2e73 656c 665f 6174 746e 5f6c 6179 6572  .self_attn_layer
+00003260: 5f6e 6f72 6d28 6869 6464 656e 5f73 7461  _norm(hidden_sta
+00003270: 7465 7329 0a0a 2020 2020 2020 2020 7265  tes)..        re
+00003280: 7369 6475 616c 203d 2068 6964 6465 6e5f  sidual = hidden_
+00003290: 7374 6174 6573 0a20 2020 2020 2020 2068  states.        h
+000032a0: 6964 6465 6e5f 7374 6174 6573 203d 2073  idden_states = s
+000032b0: 656c 662e 6163 7469 7661 7469 6f6e 5f66  elf.activation_f
+000032c0: 6e28 7365 6c66 2e66 6331 2868 6964 6465  n(self.fc1(hidde
+000032d0: 6e5f 7374 6174 6573 2929 0a20 2020 2020  n_states)).     
+000032e0: 2020 2068 6964 6465 6e5f 7374 6174 6573     hidden_states
+000032f0: 203d 206f 7073 2e64 726f 706f 7574 2868   = ops.dropout(h
+00003300: 6964 6465 6e5f 7374 6174 6573 2c20 703d  idden_states, p=
+00003310: 7365 6c66 2e61 6374 6976 6174 696f 6e5f  self.activation_
+00003320: 6472 6f70 6f75 742c 2074 7261 696e 696e  dropout, trainin
+00003330: 673d 7365 6c66 2e74 7261 696e 696e 6729  g=self.training)
+00003340: 0a20 2020 2020 2020 2068 6964 6465 6e5f  .        hidden_
+00003350: 7374 6174 6573 203d 2073 656c 662e 6663  states = self.fc
+00003360: 3228 6869 6464 656e 5f73 7461 7465 7329  2(hidden_states)
+00003370: 0a20 2020 2020 2020 2068 6964 6465 6e5f  .        hidden_
+00003380: 7374 6174 6573 203d 206f 7073 2e64 726f  states = ops.dro
+00003390: 706f 7574 2868 6964 6465 6e5f 7374 6174  pout(hidden_stat
+000033a0: 6573 2c20 703d 7365 6c66 2e64 726f 706f  es, p=self.dropo
+000033b0: 7574 2c20 7472 6169 6e69 6e67 3d73 656c  ut, training=sel
+000033c0: 662e 7472 6169 6e69 6e67 290a 2020 2020  f.training).    
+000033d0: 2020 2020 6869 6464 656e 5f73 7461 7465      hidden_state
+000033e0: 7320 3d20 7265 7369 6475 616c 202b 2068  s = residual + h
+000033f0: 6964 6465 6e5f 7374 6174 6573 0a20 2020  idden_states.   
+00003400: 2020 2020 2068 6964 6465 6e5f 7374 6174       hidden_stat
+00003410: 6573 203d 2073 656c 662e 6669 6e61 6c5f  es = self.final_
+00003420: 6c61 7965 725f 6e6f 726d 2868 6964 6465  layer_norm(hidde
+00003430: 6e5f 7374 6174 6573 290a 0a20 2020 2020  n_states)..     
+00003440: 2020 2069 6620 6869 6464 656e 5f73 7461     if hidden_sta
+00003450: 7465 732e 6474 7970 6520 3d3d 206d 696e  tes.dtype == min
+00003460: 6473 706f 7265 2e66 6c6f 6174 3136 2061  dspore.float16 a
+00003470: 6e64 2028 0a20 2020 2020 2020 2020 2020  nd (.           
+00003480: 206f 7073 2e69 7369 6e66 2868 6964 6465   ops.isinf(hidde
+00003490: 6e5f 7374 6174 6573 292e 616e 7928 2920  n_states).any() 
+000034a0: 6f72 206f 7073 2e69 736e 616e 2868 6964  or ops.isnan(hid
+000034b0: 6465 6e5f 7374 6174 6573 292e 616e 7928  den_states).any(
+000034c0: 290a 2020 2020 2020 2020 293a 0a20 2020  ).        ):.   
+000034d0: 2020 2020 2020 2020 2063 6c61 6d70 5f76           clamp_v
+000034e0: 616c 7565 203d 2066 696e 666f 2868 6964  alue = finfo(hid
+000034f0: 6465 6e5f 7374 6174 6573 2e64 7479 7065  den_states.dtype
+00003500: 2c20 276d 6178 2729 202d 2031 3030 300a  , 'max') - 1000.
+00003510: 2020 2020 2020 2020 2020 2020 6869 6464              hidd
+00003520: 656e 5f73 7461 7465 7320 3d20 6f70 732e  en_states = ops.
+00003530: 636c 616d 7028 6869 6464 656e 5f73 7461  clamp(hidden_sta
+00003540: 7465 732c 206d 696e 3d2d 636c 616d 705f  tes, min=-clamp_
+00003550: 7661 6c75 652c 206d 6178 3d63 6c61 6d70  value, max=clamp
+00003560: 5f76 616c 7565 290a 0a20 2020 2020 2020  _value)..       
+00003570: 206f 7574 7075 7473 203d 2028 6869 6464   outputs = (hidd
+00003580: 656e 5f73 7461 7465 732c 290a 0a20 2020  en_states,)..   
+00003590: 2020 2020 2069 6620 6f75 7470 7574 5f61       if output_a
+000035a0: 7474 656e 7469 6f6e 733a 0a20 2020 2020  ttentions:.     
+000035b0: 2020 2020 2020 206f 7574 7075 7473 202b         outputs +
+000035c0: 3d20 2861 7474 6e5f 7765 6967 6874 732c  = (attn_weights,
+000035d0: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+000035e0: 6e20 6f75 7470 7574 730a 0a0a 2320 544f  n outputs...# TO
+000035f0: 444f 3a20 496d 706c 656d 656e 7420 6174  DO: Implement at
+00003600: 7465 6e74 696f 6e20 7769 7468 2053 4450  tention with SDP
+00003610: 4120 666f 7220 5469 6d65 5365 7269 6573  A for TimeSeries
+00003620: 5472 616e 7366 6f72 6d65 722e 0a42 4c45  Transformer..BLE
+00003630: 4e44 4552 424f 545f 534d 414c 4c5f 4154  NDERBOT_SMALL_AT
+00003640: 5445 4e54 494f 4e5f 434c 4153 5345 5320  TENTION_CLASSES 
+00003650: 3d20 7b0a 2020 2020 2265 6167 6572 223a  = {.    "eager":
+00003660: 2042 6c65 6e64 6572 626f 7453 6d61 6c6c   BlenderbotSmall
+00003670: 4174 7465 6e74 696f 6e2c 0a7d 0a0a 0a23  Attention,.}...#
+00003680: 2043 6f70 6965 6420 6672 6f6d 2074 7261   Copied from tra
+00003690: 6e73 666f 726d 6572 732e 6d6f 6465 6c73  nsformers.models
+000036a0: 2e62 6172 742e 6d6f 6465 6c69 6e67 5f62  .bart.modeling_b
+000036b0: 6172 742e 4261 7274 4465 636f 6465 724c  art.BartDecoderL
+000036c0: 6179 6572 2077 6974 6820 4261 7274 2d3e  ayer with Bart->
+000036d0: 426c 656e 6465 7262 6f74 536d 616c 6c2c  BlenderbotSmall,
+000036e0: 2042 4152 542d 3e42 4c45 4e44 4552 424f   BART->BLENDERBO
+000036f0: 545f 534d 414c 4c0a 636c 6173 7320 426c  T_SMALL.class Bl
+00003700: 656e 6465 7262 6f74 536d 616c 6c44 6563  enderbotSmallDec
+00003710: 6f64 6572 4c61 7965 7228 6e6e 2e43 656c  oderLayer(nn.Cel
+00003720: 6c29 3a0a 2020 2020 6465 6620 5f5f 696e  l):.    def __in
+00003730: 6974 5f5f 2873 656c 662c 2063 6f6e 6669  it__(self, confi
+00003740: 673a 2042 6c65 6e64 6572 626f 7453 6d61  g: BlenderbotSma
+00003750: 6c6c 436f 6e66 6967 293a 0a20 2020 2020  llConfig):.     
+00003760: 2020 2073 7570 6572 2829 2e5f 5f69 6e69     super().__ini
+00003770: 745f 5f28 290a 2020 2020 2020 2020 7365  t__().        se
+00003780: 6c66 2e65 6d62 6564 5f64 696d 203d 2063  lf.embed_dim = c
+00003790: 6f6e 6669 672e 645f 6d6f 6465 6c0a 0a20  onfig.d_model.. 
+000037a0: 2020 2020 2020 2073 656c 662e 7365 6c66         self.self
+000037b0: 5f61 7474 6e20 3d20 424c 454e 4445 5242  _attn = BLENDERB
+000037c0: 4f54 5f53 4d41 4c4c 5f41 5454 454e 5449  OT_SMALL_ATTENTI
+000037d0: 4f4e 5f43 4c41 5353 4553 5b63 6f6e 6669  ON_CLASSES[confi
+000037e0: 672e 5f61 7474 6e5f 696d 706c 656d 656e  g._attn_implemen
+000037f0: 7461 7469 6f6e 5d28 0a20 2020 2020 2020  tation](.       
+00003800: 2020 2020 2065 6d62 6564 5f64 696d 3d73       embed_dim=s
+00003810: 656c 662e 656d 6265 645f 6469 6d2c 0a20  elf.embed_dim,. 
+00003820: 2020 2020 2020 2020 2020 206e 756d 5f68             num_h
+00003830: 6561 6473 3d63 6f6e 6669 672e 6465 636f  eads=config.deco
+00003840: 6465 725f 6174 7465 6e74 696f 6e5f 6865  der_attention_he
+00003850: 6164 732c 0a20 2020 2020 2020 2020 2020  ads,.           
+00003860: 2064 726f 706f 7574 3d63 6f6e 6669 672e   dropout=config.
+00003870: 6174 7465 6e74 696f 6e5f 6472 6f70 6f75  attention_dropou
+00003880: 742c 0a20 2020 2020 2020 2020 2020 2069  t,.            i
+00003890: 735f 6465 636f 6465 723d 5472 7565 2c0a  s_decoder=True,.
+000038a0: 2020 2020 2020 2020 2020 2020 6973 5f63              is_c
+000038b0: 6175 7361 6c3d 5472 7565 2c0a 2020 2020  ausal=True,.    
+000038c0: 2020 2020 2020 2020 636f 6e66 6967 3d63          config=c
+000038d0: 6f6e 6669 672c 0a20 2020 2020 2020 2029  onfig,.        )
+000038e0: 0a20 2020 2020 2020 2073 656c 662e 6472  .        self.dr
+000038f0: 6f70 6f75 7420 3d20 636f 6e66 6967 2e64  opout = config.d
+00003900: 726f 706f 7574 0a20 2020 2020 2020 2073  ropout.        s
+00003910: 656c 662e 6163 7469 7661 7469 6f6e 5f66  elf.activation_f
+00003920: 6e20 3d20 4143 5432 464e 5b63 6f6e 6669  n = ACT2FN[confi
+00003930: 672e 6163 7469 7661 7469 6f6e 5f66 756e  g.activation_fun
+00003940: 6374 696f 6e5d 0a20 2020 2020 2020 2073  ction].        s
+00003950: 656c 662e 6163 7469 7661 7469 6f6e 5f64  elf.activation_d
+00003960: 726f 706f 7574 203d 2063 6f6e 6669 672e  ropout = config.
+00003970: 6163 7469 7661 7469 6f6e 5f64 726f 706f  activation_dropo
+00003980: 7574 0a0a 2020 2020 2020 2020 7365 6c66  ut..        self
+00003990: 2e73 656c 665f 6174 746e 5f6c 6179 6572  .self_attn_layer
+000039a0: 5f6e 6f72 6d20 3d20 6e6e 2e4c 6179 6572  _norm = nn.Layer
+000039b0: 4e6f 726d 2873 656c 662e 656d 6265 645f  Norm(self.embed_
+000039c0: 6469 6d29 0a20 2020 2020 2020 2073 656c  dim).        sel
+000039d0: 662e 656e 636f 6465 725f 6174 746e 203d  f.encoder_attn =
+000039e0: 2042 4c45 4e44 4552 424f 545f 534d 414c   BLENDERBOT_SMAL
+000039f0: 4c5f 4154 5445 4e54 494f 4e5f 434c 4153  L_ATTENTION_CLAS
+00003a00: 5345 535b 636f 6e66 6967 2e5f 6174 746e  SES[config._attn
+00003a10: 5f69 6d70 6c65 6d65 6e74 6174 696f 6e5d  _implementation]
+00003a20: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
+00003a30: 6c66 2e65 6d62 6564 5f64 696d 2c0a 2020  lf.embed_dim,.  
+00003a40: 2020 2020 2020 2020 2020 636f 6e66 6967            config
+00003a50: 2e64 6563 6f64 6572 5f61 7474 656e 7469  .decoder_attenti
+00003a60: 6f6e 5f68 6561 6473 2c0a 2020 2020 2020  on_heads,.      
+00003a70: 2020 2020 2020 6472 6f70 6f75 743d 636f        dropout=co
+00003a80: 6e66 6967 2e61 7474 656e 7469 6f6e 5f64  nfig.attention_d
+00003a90: 726f 706f 7574 2c0a 2020 2020 2020 2020  ropout,.        
+00003aa0: 2020 2020 6973 5f64 6563 6f64 6572 3d54      is_decoder=T
+00003ab0: 7275 652c 0a20 2020 2020 2020 2020 2020  rue,.           
+00003ac0: 2063 6f6e 6669 673d 636f 6e66 6967 2c0a   config=config,.
+00003ad0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00003ae0: 2020 7365 6c66 2e65 6e63 6f64 6572 5f61    self.encoder_a
+00003af0: 7474 6e5f 6c61 7965 725f 6e6f 726d 203d  ttn_layer_norm =
+00003b00: 206e 6e2e 4c61 7965 724e 6f72 6d28 7365   nn.LayerNorm(se
+00003b10: 6c66 2e65 6d62 6564 5f64 696d 290a 2020  lf.embed_dim).  
+00003b20: 2020 2020 2020 7365 6c66 2e66 6331 203d        self.fc1 =
+00003b30: 206e 6e2e 4465 6e73 6528 7365 6c66 2e65   nn.Dense(self.e
+00003b40: 6d62 6564 5f64 696d 2c20 636f 6e66 6967  mbed_dim, config
+00003b50: 2e64 6563 6f64 6572 5f66 666e 5f64 696d  .decoder_ffn_dim
+00003b60: 290a 2020 2020 2020 2020 7365 6c66 2e66  ).        self.f
+00003b70: 6332 203d 206e 6e2e 4465 6e73 6528 636f  c2 = nn.Dense(co
+00003b80: 6e66 6967 2e64 6563 6f64 6572 5f66 666e  nfig.decoder_ffn
+00003b90: 5f64 696d 2c20 7365 6c66 2e65 6d62 6564  _dim, self.embed
+00003ba0: 5f64 696d 290a 2020 2020 2020 2020 7365  _dim).        se
+00003bb0: 6c66 2e66 696e 616c 5f6c 6179 6572 5f6e  lf.final_layer_n
+00003bc0: 6f72 6d20 3d20 6e6e 2e4c 6179 6572 4e6f  orm = nn.LayerNo
+00003bd0: 726d 2873 656c 662e 656d 6265 645f 6469  rm(self.embed_di
+00003be0: 6d29 0a0a 2020 2020 6465 6620 636f 6e73  m)..    def cons
+00003bf0: 7472 7563 7428 0a20 2020 2020 2020 2073  truct(.        s
+00003c00: 656c 662c 0a20 2020 2020 2020 2068 6964  elf,.        hid
+00003c10: 6465 6e5f 7374 6174 6573 3a20 6d69 6e64  den_states: mind
+00003c20: 7370 6f72 652e 5465 6e73 6f72 2c0a 2020  spore.Tensor,.  
+00003c30: 2020 2020 2020 6174 7465 6e74 696f 6e5f        attention_
+00003c40: 6d61 736b 3a20 4f70 7469 6f6e 616c 5b6d  mask: Optional[m
+00003c50: 696e 6473 706f 7265 2e54 656e 736f 725d  indspore.Tensor]
+00003c60: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00003c70: 2065 6e63 6f64 6572 5f68 6964 6465 6e5f   encoder_hidden_
+00003c80: 7374 6174 6573 3a20 4f70 7469 6f6e 616c  states: Optional
+00003c90: 5b6d 696e 6473 706f 7265 2e54 656e 736f  [mindspore.Tenso
+00003ca0: 725d 203d 204e 6f6e 652c 0a20 2020 2020  r] = None,.     
+00003cb0: 2020 2065 6e63 6f64 6572 5f61 7474 656e     encoder_atten
+00003cc0: 7469 6f6e 5f6d 6173 6b3a 204f 7074 696f  tion_mask: Optio
+00003cd0: 6e61 6c5b 6d69 6e64 7370 6f72 652e 5465  nal[mindspore.Te
+00003ce0: 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a 2020  nsor] = None,.  
+00003cf0: 2020 2020 2020 6c61 7965 725f 6865 6164        layer_head
+00003d00: 5f6d 6173 6b3a 204f 7074 696f 6e61 6c5b  _mask: Optional[
+00003d10: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+00003d20: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+00003d30: 2020 6372 6f73 735f 6174 746e 5f6c 6179    cross_attn_lay
+00003d40: 6572 5f68 6561 645f 6d61 736b 3a20 4f70  er_head_mask: Op
+00003d50: 7469 6f6e 616c 5b6d 696e 6473 706f 7265  tional[mindspore
+00003d60: 2e54 656e 736f 725d 203d 204e 6f6e 652c  .Tensor] = None,
+00003d70: 0a20 2020 2020 2020 2070 6173 745f 6b65  .        past_ke
+00003d80: 795f 7661 6c75 653a 204f 7074 696f 6e61  y_value: Optiona
+00003d90: 6c5b 5475 706c 655b 6d69 6e64 7370 6f72  l[Tuple[mindspor
+00003da0: 652e 5465 6e73 6f72 5d5d 203d 204e 6f6e  e.Tensor]] = Non
+00003db0: 652c 0a20 2020 2020 2020 206f 7574 7075  e,.        outpu
+00003dc0: 745f 6174 7465 6e74 696f 6e73 3a20 4f70  t_attentions: Op
+00003dd0: 7469 6f6e 616c 5b62 6f6f 6c5d 203d 2046  tional[bool] = F
+00003de0: 616c 7365 2c0a 2020 2020 2020 2020 7573  alse,.        us
+00003df0: 655f 6361 6368 653a 204f 7074 696f 6e61  e_cache: Optiona
+00003e00: 6c5b 626f 6f6c 5d20 3d20 5472 7565 2c0a  l[bool] = True,.
+00003e10: 2020 2020 2920 2d3e 2054 7570 6c65 5b6d      ) -> Tuple[m
+00003e20: 696e 6473 706f 7265 2e54 656e 736f 722c  indspore.Tensor,
+00003e30: 204f 7074 696f 6e61 6c5b 5475 706c 655b   Optional[Tuple[
+00003e40: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+00003e50: 2c20 6d69 6e64 7370 6f72 652e 5465 6e73  , mindspore.Tens
+00003e60: 6f72 5d5d 5d3a 0a20 2020 2020 2020 2022  or]]]:.        "
+00003e70: 2222 0a20 2020 2020 2020 2041 7267 733a  "".        Args:
+00003e80: 0a20 2020 2020 2020 2020 2020 2068 6964  .            hid
+00003e90: 6465 6e5f 7374 6174 6573 2028 606d 696e  den_states (`min
+00003ea0: 6473 706f 7265 2e54 656e 736f 7260 293a  dspore.Tensor`):
+00003eb0: 2069 6e70 7574 2074 6f20 7468 6520 6c61   input to the la
+00003ec0: 7965 7220 6f66 2073 6861 7065 2060 2862  yer of shape `(b
+00003ed0: 6174 6368 2c20 7365 715f 6c65 6e2c 2065  atch, seq_len, e
+00003ee0: 6d62 6564 5f64 696d 2960 0a20 2020 2020  mbed_dim)`.     
+00003ef0: 2020 2020 2020 2061 7474 656e 7469 6f6e         attention
+00003f00: 5f6d 6173 6b20 2860 6d69 6e64 7370 6f72  _mask (`mindspor
+00003f10: 652e 5465 6e73 6f72 6029 3a20 6174 7465  e.Tensor`): atte
+00003f20: 6e74 696f 6e20 6d61 736b 206f 6620 7369  ntion mask of si
+00003f30: 7a65 0a20 2020 2020 2020 2020 2020 2020  ze.             
+00003f40: 2020 2060 2862 6174 6368 2c20 312c 2074     `(batch, 1, t
+00003f50: 6774 5f6c 656e 2c20 7372 635f 6c65 6e29  gt_len, src_len)
+00003f60: 6020 7768 6572 6520 7061 6464 696e 6720  ` where padding 
+00003f70: 656c 656d 656e 7473 2061 7265 2069 6e64  elements are ind
+00003f80: 6963 6174 6564 2062 7920 7665 7279 206c  icated by very l
+00003f90: 6172 6765 206e 6567 6174 6976 6520 7661  arge negative va
+00003fa0: 6c75 6573 2e0a 2020 2020 2020 2020 2020  lues..          
+00003fb0: 2020 656e 636f 6465 725f 6869 6464 656e    encoder_hidden
+00003fc0: 5f73 7461 7465 7320 2860 6d69 6e64 7370  _states (`mindsp
+00003fd0: 6f72 652e 5465 6e73 6f72 6029 3a0a 2020  ore.Tensor`):.  
+00003fe0: 2020 2020 2020 2020 2020 2020 2020 6372                cr
+00003ff0: 6f73 7320 6174 7465 6e74 696f 6e20 696e  oss attention in
+00004000: 7075 7420 746f 2074 6865 206c 6179 6572  put to the layer
+00004010: 206f 6620 7368 6170 6520 6028 6261 7463   of shape `(batc
+00004020: 682c 2073 6571 5f6c 656e 2c20 656d 6265  h, seq_len, embe
+00004030: 645f 6469 6d29 600a 2020 2020 2020 2020  d_dim)`.        
+00004040: 2020 2020 656e 636f 6465 725f 6174 7465      encoder_atte
+00004050: 6e74 696f 6e5f 6d61 736b 2028 606d 696e  ntion_mask (`min
+00004060: 6473 706f 7265 2e54 656e 736f 7260 293a  dspore.Tensor`):
+00004070: 2065 6e63 6f64 6572 2061 7474 656e 7469   encoder attenti
+00004080: 6f6e 206d 6173 6b20 6f66 2073 697a 650a  on mask of size.
+00004090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000040a0: 6028 6261 7463 682c 2031 2c20 7467 745f  `(batch, 1, tgt_
+000040b0: 6c65 6e2c 2073 7263 5f6c 656e 2960 2077  len, src_len)` w
+000040c0: 6865 7265 2070 6164 6469 6e67 2065 6c65  here padding ele
+000040d0: 6d65 6e74 7320 6172 6520 696e 6469 6361  ments are indica
+000040e0: 7465 6420 6279 2076 6572 7920 6c61 7267  ted by very larg
+000040f0: 6520 6e65 6761 7469 7665 2076 616c 7565  e negative value
+00004100: 732e 0a20 2020 2020 2020 2020 2020 206c  s..            l
+00004110: 6179 6572 5f68 6561 645f 6d61 736b 2028  ayer_head_mask (
+00004120: 606d 696e 6473 706f 7265 2e54 656e 736f  `mindspore.Tenso
+00004130: 7260 293a 206d 6173 6b20 666f 7220 6174  r`): mask for at
+00004140: 7465 6e74 696f 6e20 6865 6164 7320 696e  tention heads in
+00004150: 2061 2067 6976 656e 206c 6179 6572 206f   a given layer o
+00004160: 6620 7369 7a65 0a20 2020 2020 2020 2020  f size.         
+00004170: 2020 2020 2020 2060 2865 6e63 6f64 6572         `(encoder
+00004180: 5f61 7474 656e 7469 6f6e 5f68 6561 6473  _attention_heads
+00004190: 2c29 602e 0a20 2020 2020 2020 2020 2020  ,)`..           
+000041a0: 2063 726f 7373 5f61 7474 6e5f 6c61 7965   cross_attn_laye
+000041b0: 725f 6865 6164 5f6d 6173 6b20 2860 6d69  r_head_mask (`mi
+000041c0: 6e64 7370 6f72 652e 5465 6e73 6f72 6029  ndspore.Tensor`)
+000041d0: 3a20 6d61 736b 2066 6f72 2063 726f 7373  : mask for cross
+000041e0: 2d61 7474 656e 7469 6f6e 2068 6561 6473  -attention heads
+000041f0: 2069 6e20 6120 6769 7665 6e20 6c61 7965   in a given laye
+00004200: 7220 6f66 0a20 2020 2020 2020 2020 2020  r of.           
+00004210: 2020 2020 2073 697a 6520 6028 6465 636f       size `(deco
+00004220: 6465 725f 6174 7465 6e74 696f 6e5f 6865  der_attention_he
+00004230: 6164 732c 2960 2e0a 2020 2020 2020 2020  ads,)`..        
+00004240: 2020 2020 7061 7374 5f6b 6579 5f76 616c      past_key_val
+00004250: 7565 2028 6054 7570 6c65 286d 696e 6473  ue (`Tuple(minds
+00004260: 706f 7265 2e54 656e 736f 7229 6029 3a20  pore.Tensor)`): 
+00004270: 6361 6368 6564 2070 6173 7420 6b65 7920  cached past key 
+00004280: 616e 6420 7661 6c75 6520 7072 6f6a 6563  and value projec
+00004290: 7469 6f6e 2073 7461 7465 730a 2020 2020  tion states.    
+000042a0: 2020 2020 2020 2020 6f75 7470 7574 5f61          output_a
+000042b0: 7474 656e 7469 6f6e 7320 2860 626f 6f6c  ttentions (`bool
+000042c0: 602c 202a 6f70 7469 6f6e 616c 2a29 3a0a  `, *optional*):.
+000042d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000042e0: 5768 6574 6865 7220 6f72 206e 6f74 2074  Whether or not t
+000042f0: 6f20 7265 7475 726e 2074 6865 2061 7474  o return the att
+00004300: 656e 7469 6f6e 7320 7465 6e73 6f72 7320  entions tensors 
+00004310: 6f66 2061 6c6c 2061 7474 656e 7469 6f6e  of all attention
+00004320: 206c 6179 6572 732e 2053 6565 2060 6174   layers. See `at
+00004330: 7465 6e74 696f 6e73 6020 756e 6465 720a  tentions` under.
+00004340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004350: 7265 7475 726e 6564 2074 656e 736f 7273  returned tensors
+00004360: 2066 6f72 206d 6f72 6520 6465 7461 696c   for more detail
+00004370: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+00004380: 2020 2020 2020 7265 7369 6475 616c 203d        residual =
+00004390: 2068 6964 6465 6e5f 7374 6174 6573 0a0a   hidden_states..
+000043a0: 2020 2020 2020 2020 2320 5365 6c66 2041          # Self A
+000043b0: 7474 656e 7469 6f6e 0a20 2020 2020 2020  ttention.       
+000043c0: 2023 2064 6563 6f64 6572 2075 6e69 2d64   # decoder uni-d
+000043d0: 6972 6563 7469 6f6e 616c 2073 656c 662d  irectional self-
+000043e0: 6174 7465 6e74 696f 6e20 6361 6368 6564  attention cached
+000043f0: 206b 6579 2f76 616c 7565 7320 7475 706c   key/values tupl
+00004400: 6520 6973 2061 7420 706f 7369 7469 6f6e  e is at position
+00004410: 7320 312c 320a 2020 2020 2020 2020 7365  s 1,2.        se
+00004420: 6c66 5f61 7474 6e5f 7061 7374 5f6b 6579  lf_attn_past_key
+00004430: 5f76 616c 7565 203d 2070 6173 745f 6b65  _value = past_ke
+00004440: 795f 7661 6c75 655b 3a32 5d20 6966 2070  y_value[:2] if p
+00004450: 6173 745f 6b65 795f 7661 6c75 6520 6973  ast_key_value is
+00004460: 206e 6f74 204e 6f6e 6520 656c 7365 204e   not None else N
+00004470: 6f6e 650a 2020 2020 2020 2020 2320 6164  one.        # ad
+00004480: 6420 7072 6573 656e 7420 7365 6c66 2d61  d present self-a
+00004490: 7474 6e20 6361 6368 6520 746f 2070 6f73  ttn cache to pos
+000044a0: 6974 696f 6e73 2031 2c32 206f 6620 7072  itions 1,2 of pr
+000044b0: 6573 656e 745f 6b65 795f 7661 6c75 6520  esent_key_value 
+000044c0: 7475 706c 650a 2020 2020 2020 2020 6869  tuple.        hi
+000044d0: 6464 656e 5f73 7461 7465 732c 2073 656c  dden_states, sel
+000044e0: 665f 6174 746e 5f77 6569 6768 7473 2c20  f_attn_weights, 
+000044f0: 7072 6573 656e 745f 6b65 795f 7661 6c75  present_key_valu
+00004500: 6520 3d20 7365 6c66 2e73 656c 665f 6174  e = self.self_at
+00004510: 746e 280a 2020 2020 2020 2020 2020 2020  tn(.            
+00004520: 6869 6464 656e 5f73 7461 7465 733d 6869  hidden_states=hi
+00004530: 6464 656e 5f73 7461 7465 732c 0a20 2020  dden_states,.   
+00004540: 2020 2020 2020 2020 2070 6173 745f 6b65           past_ke
+00004550: 795f 7661 6c75 653d 7365 6c66 5f61 7474  y_value=self_att
+00004560: 6e5f 7061 7374 5f6b 6579 5f76 616c 7565  n_past_key_value
+00004570: 2c0a 2020 2020 2020 2020 2020 2020 6174  ,.            at
+00004580: 7465 6e74 696f 6e5f 6d61 736b 3d61 7474  tention_mask=att
+00004590: 656e 7469 6f6e 5f6d 6173 6b2c 0a20 2020  ention_mask,.   
+000045a0: 2020 2020 2020 2020 206c 6179 6572 5f68           layer_h
+000045b0: 6561 645f 6d61 736b 3d6c 6179 6572 5f68  ead_mask=layer_h
+000045c0: 6561 645f 6d61 736b 2c0a 2020 2020 2020  ead_mask,.      
+000045d0: 2020 2020 2020 6f75 7470 7574 5f61 7474        output_att
+000045e0: 656e 7469 6f6e 733d 6f75 7470 7574 5f61  entions=output_a
+000045f0: 7474 656e 7469 6f6e 732c 0a20 2020 2020  ttentions,.     
+00004600: 2020 2029 0a20 2020 2020 2020 2068 6964     ).        hid
+00004610: 6465 6e5f 7374 6174 6573 203d 206f 7073  den_states = ops
+00004620: 2e64 726f 706f 7574 2868 6964 6465 6e5f  .dropout(hidden_
+00004630: 7374 6174 6573 2c20 703d 7365 6c66 2e64  states, p=self.d
+00004640: 726f 706f 7574 2c20 7472 6169 6e69 6e67  ropout, training
+00004650: 3d73 656c 662e 7472 6169 6e69 6e67 290a  =self.training).
+00004660: 2020 2020 2020 2020 6869 6464 656e 5f73          hidden_s
+00004670: 7461 7465 7320 3d20 7265 7369 6475 616c  tates = residual
+00004680: 202b 2068 6964 6465 6e5f 7374 6174 6573   + hidden_states
+00004690: 0a20 2020 2020 2020 2068 6964 6465 6e5f  .        hidden_
+000046a0: 7374 6174 6573 203d 2073 656c 662e 7365  states = self.se
+000046b0: 6c66 5f61 7474 6e5f 6c61 7965 725f 6e6f  lf_attn_layer_no
+000046c0: 726d 2868 6964 6465 6e5f 7374 6174 6573  rm(hidden_states
+000046d0: 290a 0a20 2020 2020 2020 2023 2043 726f  )..        # Cro
+000046e0: 7373 2d41 7474 656e 7469 6f6e 2042 6c6f  ss-Attention Blo
+000046f0: 636b 0a20 2020 2020 2020 2063 726f 7373  ck.        cross
+00004700: 5f61 7474 6e5f 7072 6573 656e 745f 6b65  _attn_present_ke
+00004710: 795f 7661 6c75 6520 3d20 4e6f 6e65 0a20  y_value = None. 
+00004720: 2020 2020 2020 2063 726f 7373 5f61 7474         cross_att
+00004730: 6e5f 7765 6967 6874 7320 3d20 4e6f 6e65  n_weights = None
+00004740: 0a20 2020 2020 2020 2069 6620 656e 636f  .        if enco
+00004750: 6465 725f 6869 6464 656e 5f73 7461 7465  der_hidden_state
+00004760: 7320 6973 206e 6f74 204e 6f6e 653a 0a20  s is not None:. 
+00004770: 2020 2020 2020 2020 2020 2072 6573 6964             resid
+00004780: 7561 6c20 3d20 6869 6464 656e 5f73 7461  ual = hidden_sta
+00004790: 7465 730a 0a20 2020 2020 2020 2020 2020  tes..           
+000047a0: 2023 2063 726f 7373 5f61 7474 6e20 6361   # cross_attn ca
+000047b0: 6368 6564 206b 6579 2f76 616c 7565 7320  ched key/values 
+000047c0: 7475 706c 6520 6973 2061 7420 706f 7369  tuple is at posi
+000047d0: 7469 6f6e 7320 332c 3420 6f66 2070 7265  tions 3,4 of pre
+000047e0: 7365 6e74 5f6b 6579 5f76 616c 7565 2074  sent_key_value t
+000047f0: 7570 6c65 0a20 2020 2020 2020 2020 2020  uple.           
+00004800: 2063 726f 7373 5f61 7474 6e5f 7061 7374   cross_attn_past
+00004810: 5f6b 6579 5f76 616c 7565 203d 2070 6173  _key_value = pas
+00004820: 745f 6b65 795f 7661 6c75 655b 2d32 3a5d  t_key_value[-2:]
+00004830: 2069 6620 7061 7374 5f6b 6579 5f76 616c   if past_key_val
+00004840: 7565 2069 7320 6e6f 7420 4e6f 6e65 2065  ue is not None e
+00004850: 6c73 6520 4e6f 6e65 0a20 2020 2020 2020  lse None.       
+00004860: 2020 2020 2068 6964 6465 6e5f 7374 6174       hidden_stat
+00004870: 6573 2c20 6372 6f73 735f 6174 746e 5f77  es, cross_attn_w
+00004880: 6569 6768 7473 2c20 6372 6f73 735f 6174  eights, cross_at
+00004890: 746e 5f70 7265 7365 6e74 5f6b 6579 5f76  tn_present_key_v
+000048a0: 616c 7565 203d 2073 656c 662e 656e 636f  alue = self.enco
+000048b0: 6465 725f 6174 746e 280a 2020 2020 2020  der_attn(.      
+000048c0: 2020 2020 2020 2020 2020 6869 6464 656e            hidden
+000048d0: 5f73 7461 7465 733d 6869 6464 656e 5f73  _states=hidden_s
+000048e0: 7461 7465 732c 0a20 2020 2020 2020 2020  tates,.         
+000048f0: 2020 2020 2020 206b 6579 5f76 616c 7565         key_value
+00004900: 5f73 7461 7465 733d 656e 636f 6465 725f  _states=encoder_
+00004910: 6869 6464 656e 5f73 7461 7465 732c 0a20  hidden_states,. 
+00004920: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00004930: 7474 656e 7469 6f6e 5f6d 6173 6b3d 656e  ttention_mask=en
+00004940: 636f 6465 725f 6174 7465 6e74 696f 6e5f  coder_attention_
+00004950: 6d61 736b 2c0a 2020 2020 2020 2020 2020  mask,.          
+00004960: 2020 2020 2020 6c61 7965 725f 6865 6164        layer_head
+00004970: 5f6d 6173 6b3d 6372 6f73 735f 6174 746e  _mask=cross_attn
+00004980: 5f6c 6179 6572 5f68 6561 645f 6d61 736b  _layer_head_mask
+00004990: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000049a0: 2020 7061 7374 5f6b 6579 5f76 616c 7565    past_key_value
+000049b0: 3d63 726f 7373 5f61 7474 6e5f 7061 7374  =cross_attn_past
+000049c0: 5f6b 6579 5f76 616c 7565 2c0a 2020 2020  _key_value,.    
+000049d0: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
+000049e0: 7574 5f61 7474 656e 7469 6f6e 733d 6f75  ut_attentions=ou
+000049f0: 7470 7574 5f61 7474 656e 7469 6f6e 732c  tput_attentions,
+00004a00: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00004a10: 2020 2020 2020 2020 2020 2068 6964 6465             hidde
+00004a20: 6e5f 7374 6174 6573 203d 206f 7073 2e64  n_states = ops.d
+00004a30: 726f 706f 7574 2868 6964 6465 6e5f 7374  ropout(hidden_st
+00004a40: 6174 6573 2c20 703d 7365 6c66 2e64 726f  ates, p=self.dro
+00004a50: 706f 7574 2c20 7472 6169 6e69 6e67 3d73  pout, training=s
+00004a60: 656c 662e 7472 6169 6e69 6e67 290a 2020  elf.training).  
+00004a70: 2020 2020 2020 2020 2020 6869 6464 656e            hidden
+00004a80: 5f73 7461 7465 7320 3d20 7265 7369 6475  _states = residu
+00004a90: 616c 202b 2068 6964 6465 6e5f 7374 6174  al + hidden_stat
+00004aa0: 6573 0a20 2020 2020 2020 2020 2020 2068  es.            h
+00004ab0: 6964 6465 6e5f 7374 6174 6573 203d 2073  idden_states = s
+00004ac0: 656c 662e 656e 636f 6465 725f 6174 746e  elf.encoder_attn
+00004ad0: 5f6c 6179 6572 5f6e 6f72 6d28 6869 6464  _layer_norm(hidd
+00004ae0: 656e 5f73 7461 7465 7329 0a0a 2020 2020  en_states)..    
+00004af0: 2020 2020 2020 2020 2320 6164 6420 6372          # add cr
+00004b00: 6f73 732d 6174 746e 2074 6f20 706f 7369  oss-attn to posi
+00004b10: 7469 6f6e 7320 332c 3420 6f66 2070 7265  tions 3,4 of pre
+00004b20: 7365 6e74 5f6b 6579 5f76 616c 7565 2074  sent_key_value t
+00004b30: 7570 6c65 0a20 2020 2020 2020 2020 2020  uple.           
+00004b40: 2070 7265 7365 6e74 5f6b 6579 5f76 616c   present_key_val
+00004b50: 7565 203d 2070 7265 7365 6e74 5f6b 6579  ue = present_key
+00004b60: 5f76 616c 7565 202b 2063 726f 7373 5f61  _value + cross_a
+00004b70: 7474 6e5f 7072 6573 656e 745f 6b65 795f  ttn_present_key_
+00004b80: 7661 6c75 650a 0a20 2020 2020 2020 2023  value..        #
+00004b90: 2046 756c 6c79 2043 6f6e 6e65 6374 6564   Fully Connected
+00004ba0: 0a20 2020 2020 2020 2072 6573 6964 7561  .        residua
+00004bb0: 6c20 3d20 6869 6464 656e 5f73 7461 7465  l = hidden_state
+00004bc0: 730a 2020 2020 2020 2020 6869 6464 656e  s.        hidden
+00004bd0: 5f73 7461 7465 7320 3d20 7365 6c66 2e61  _states = self.a
+00004be0: 6374 6976 6174 696f 6e5f 666e 2873 656c  ctivation_fn(sel
+00004bf0: 662e 6663 3128 6869 6464 656e 5f73 7461  f.fc1(hidden_sta
+00004c00: 7465 7329 290a 2020 2020 2020 2020 6869  tes)).        hi
+00004c10: 6464 656e 5f73 7461 7465 7320 3d20 6f70  dden_states = op
+00004c20: 732e 6472 6f70 6f75 7428 6869 6464 656e  s.dropout(hidden
+00004c30: 5f73 7461 7465 732c 2070 3d73 656c 662e  _states, p=self.
+00004c40: 6163 7469 7661 7469 6f6e 5f64 726f 706f  activation_dropo
+00004c50: 7574 2c20 7472 6169 6e69 6e67 3d73 656c  ut, training=sel
+00004c60: 662e 7472 6169 6e69 6e67 290a 2020 2020  f.training).    
+00004c70: 2020 2020 6869 6464 656e 5f73 7461 7465      hidden_state
+00004c80: 7320 3d20 7365 6c66 2e66 6332 2868 6964  s = self.fc2(hid
+00004c90: 6465 6e5f 7374 6174 6573 290a 2020 2020  den_states).    
+00004ca0: 2020 2020 6869 6464 656e 5f73 7461 7465      hidden_state
+00004cb0: 7320 3d20 6f70 732e 6472 6f70 6f75 7428  s = ops.dropout(
+00004cc0: 6869 6464 656e 5f73 7461 7465 732c 2070  hidden_states, p
+00004cd0: 3d73 656c 662e 6472 6f70 6f75 742c 2074  =self.dropout, t
+00004ce0: 7261 696e 696e 673d 7365 6c66 2e74 7261  raining=self.tra
+00004cf0: 696e 696e 6729 0a20 2020 2020 2020 2068  ining).        h
+00004d00: 6964 6465 6e5f 7374 6174 6573 203d 2072  idden_states = r
+00004d10: 6573 6964 7561 6c20 2b20 6869 6464 656e  esidual + hidden
+00004d20: 5f73 7461 7465 730a 2020 2020 2020 2020  _states.        
+00004d30: 6869 6464 656e 5f73 7461 7465 7320 3d20  hidden_states = 
+00004d40: 7365 6c66 2e66 696e 616c 5f6c 6179 6572  self.final_layer
+00004d50: 5f6e 6f72 6d28 6869 6464 656e 5f73 7461  _norm(hidden_sta
+00004d60: 7465 7329 0a0a 2020 2020 2020 2020 6f75  tes)..        ou
+00004d70: 7470 7574 7320 3d20 2868 6964 6465 6e5f  tputs = (hidden_
+00004d80: 7374 6174 6573 2c29 0a0a 2020 2020 2020  states,)..      
+00004d90: 2020 6966 206f 7574 7075 745f 6174 7465    if output_atte
+00004da0: 6e74 696f 6e73 3a0a 2020 2020 2020 2020  ntions:.        
+00004db0: 2020 2020 6f75 7470 7574 7320 2b3d 2028      outputs += (
+00004dc0: 7365 6c66 5f61 7474 6e5f 7765 6967 6874  self_attn_weight
+00004dd0: 732c 2063 726f 7373 5f61 7474 6e5f 7765  s, cross_attn_we
+00004de0: 6967 6874 7329 0a0a 2020 2020 2020 2020  ights)..        
+00004df0: 6966 2075 7365 5f63 6163 6865 3a0a 2020  if use_cache:.  
+00004e00: 2020 2020 2020 2020 2020 6f75 7470 7574            output
+00004e10: 7320 2b3d 2028 7072 6573 656e 745f 6b65  s += (present_ke
+00004e20: 795f 7661 6c75 652c 290a 0a20 2020 2020  y_value,)..     
+00004e30: 2020 2072 6574 7572 6e20 6f75 7470 7574     return output
+00004e40: 730a 0a0a 636c 6173 7320 426c 656e 6465  s...class Blende
+00004e50: 7262 6f74 536d 616c 6c50 7265 5472 6169  rbotSmallPreTrai
+00004e60: 6e65 644d 6f64 656c 2850 7265 5472 6169  nedModel(PreTrai
+00004e70: 6e65 644d 6f64 656c 293a 0a20 2020 2063  nedModel):.    c
+00004e80: 6f6e 6669 675f 636c 6173 7320 3d20 426c  onfig_class = Bl
+00004e90: 656e 6465 7262 6f74 536d 616c 6c43 6f6e  enderbotSmallCon
+00004ea0: 6669 670a 2020 2020 6261 7365 5f6d 6f64  fig.    base_mod
+00004eb0: 656c 5f70 7265 6669 7820 3d20 226d 6f64  el_prefix = "mod
+00004ec0: 656c 220a 2020 2020 7375 7070 6f72 7473  el".    supports
+00004ed0: 5f67 7261 6469 656e 745f 6368 6563 6b70  _gradient_checkp
+00004ee0: 6f69 6e74 696e 6720 3d20 5472 7565 0a0a  ointing = True..
+00004ef0: 2020 2020 6465 6620 5f69 6e69 745f 7765      def _init_we
+00004f00: 6967 6874 7328 7365 6c66 2c20 6365 6c6c  ights(self, cell
+00004f10: 293a 0a20 2020 2020 2020 2022 2222 496e  ):.        """In
+00004f20: 6974 6961 6c69 7a65 2074 6865 2077 6569  itialize the wei
+00004f30: 6768 7473 2222 220a 2020 2020 2020 2020  ghts""".        
+00004f40: 7374 6420 3d20 7365 6c66 2e63 6f6e 6669  std = self.confi
+00004f50: 672e 696e 6974 5f73 7464 0a20 2020 2020  g.init_std.     
+00004f60: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+00004f70: 2863 656c 6c2c 206e 6e2e 4465 6e73 6529  (cell, nn.Dense)
+00004f80: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+00004f90: 536c 6967 6874 6c79 2064 6966 6665 7265  Slightly differe
+00004fa0: 6e74 2066 726f 6d20 7468 6520 5446 2076  nt from the TF v
+00004fb0: 6572 7369 6f6e 2077 6869 6368 2075 7365  ersion which use
+00004fc0: 7320 7472 756e 6361 7465 645f 6e6f 726d  s truncated_norm
+00004fd0: 616c 2066 6f72 2069 6e69 7469 616c 697a  al for initializ
+00004fe0: 6174 696f 6e0a 2020 2020 2020 2020 2020  ation.          
+00004ff0: 2020 2320 6366 2068 7474 7073 3a2f 2f67    # cf https://g
+00005000: 6974 6875 622e 636f 6d2f 7079 746f 7263  ithub.com/pytorc
+00005010: 682f 7079 746f 7263 682f 7075 6c6c 2f35  h/pytorch/pull/5
+00005020: 3631 370a 2020 2020 2020 2020 2020 2020  617.            
+00005030: 6365 6c6c 2e77 6569 6768 742e 7365 745f  cell.weight.set_
+00005040: 6461 7461 2869 6e69 7469 616c 697a 6572  data(initializer
+00005050: 284e 6f72 6d61 6c28 7374 6429 2c0a 2020  (Normal(std),.  
+00005060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005090: 2020 6365 6c6c 2e77 6569 6768 742e 7368    cell.weight.sh
+000050a0: 6170 652c 2063 656c 6c2e 7765 6967 6874  ape, cell.weight
+000050b0: 2e64 7479 7065 2929 0a20 2020 2020 2020  .dtype)).       
+000050c0: 2020 2020 2069 6620 6365 6c6c 2e68 6173       if cell.has
+000050d0: 5f62 6961 733a 0a20 2020 2020 2020 2020  _bias:.         
+000050e0: 2020 2020 2020 2063 656c 6c2e 6269 6173         cell.bias
+000050f0: 2e73 6574 5f64 6174 6128 696e 6974 6961  .set_data(initia
+00005100: 6c69 7a65 7228 277a 6572 6f73 272c 2063  lizer('zeros', c
+00005110: 656c 6c2e 6269 6173 2e73 6861 7065 2c20  ell.bias.shape, 
+00005120: 6365 6c6c 2e62 6961 732e 6474 7970 6529  cell.bias.dtype)
+00005130: 290a 2020 2020 2020 2020 656c 6966 2069  ).        elif i
+00005140: 7369 6e73 7461 6e63 6528 6365 6c6c 2c20  sinstance(cell, 
+00005150: 6e6e 2e45 6d62 6564 6469 6e67 293a 0a20  nn.Embedding):. 
+00005160: 2020 2020 2020 2020 2020 2077 6569 6768             weigh
+00005170: 7420 3d20 6e70 2e72 616e 646f 6d2e 6e6f  t = np.random.no
+00005180: 726d 616c 2830 2e30 2c20 7374 642c 2063  rmal(0.0, std, c
+00005190: 656c 6c2e 7765 6967 6874 2e73 6861 7065  ell.weight.shape
+000051a0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+000051b0: 2063 656c 6c2e 7061 6464 696e 675f 6964   cell.padding_id
+000051c0: 783a 0a20 2020 2020 2020 2020 2020 2020  x:.             
+000051d0: 2020 2077 6569 6768 745b 6365 6c6c 2e70     weight[cell.p
+000051e0: 6164 6469 6e67 5f69 6478 5d20 3d20 300a  adding_idx] = 0.
+000051f0: 0a20 2020 2020 2020 2020 2020 2063 656c  .            cel
+00005200: 6c2e 7765 6967 6874 2e73 6574 5f64 6174  l.weight.set_dat
+00005210: 6128 5465 6e73 6f72 2877 6569 6768 742c  a(Tensor(weight,
+00005220: 2063 656c 6c2e 7765 6967 6874 2e64 7479   cell.weight.dty
+00005230: 7065 2929 0a0a 0a20 2020 2040 7072 6f70  pe))...    @prop
+00005240: 6572 7479 0a20 2020 2064 6566 2064 756d  erty.    def dum
+00005250: 6d79 5f69 6e70 7574 7328 7365 6c66 293a  my_inputs(self):
+00005260: 0a20 2020 2020 2020 2070 6164 5f74 6f6b  .        pad_tok
+00005270: 656e 203d 2073 656c 662e 636f 6e66 6967  en = self.config
+00005280: 2e70 6164 5f74 6f6b 656e 5f69 640a 2020  .pad_token_id.  
+00005290: 2020 2020 2020 696e 7075 745f 6964 7320        input_ids 
+000052a0: 3d20 6d69 6e64 7370 6f72 652e 7465 6e73  = mindspore.tens
+000052b0: 6f72 285b 5b30 2c20 362c 2031 302c 2034  or([[0, 6, 10, 4
+000052c0: 2c20 325d 2c20 5b30 2c20 382c 2031 322c  , 2], [0, 8, 12,
+000052d0: 2032 2c20 7061 645f 746f 6b65 6e5d 5d29   2, pad_token]])
+000052e0: 0a20 2020 2020 2020 2064 756d 6d79 5f69  .        dummy_i
+000052f0: 6e70 7574 7320 3d20 7b0a 2020 2020 2020  nputs = {.      
+00005300: 2020 2020 2020 2261 7474 656e 7469 6f6e        "attention
+00005310: 5f6d 6173 6b22 3a20 696e 7075 745f 6964  _mask": input_id
+00005320: 732e 6e65 2870 6164 5f74 6f6b 656e 292c  s.ne(pad_token),
+00005330: 0a20 2020 2020 2020 2020 2020 2022 696e  .            "in
+00005340: 7075 745f 6964 7322 3a20 696e 7075 745f  put_ids": input_
+00005350: 6964 732c 0a20 2020 2020 2020 2020 2020  ids,.           
+00005360: 2022 6465 636f 6465 725f 696e 7075 745f   "decoder_input_
+00005370: 6964 7322 3a20 696e 7075 745f 6964 732c  ids": input_ids,
+00005380: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
+00005390: 2020 2072 6574 7572 6e20 6475 6d6d 795f     return dummy_
+000053a0: 696e 7075 7473 0a0a 0a63 6c61 7373 2042  inputs...class B
+000053b0: 6c65 6e64 6572 626f 7453 6d61 6c6c 456e  lenderbotSmallEn
+000053c0: 636f 6465 7228 426c 656e 6465 7262 6f74  coder(Blenderbot
+000053d0: 536d 616c 6c50 7265 5472 6169 6e65 644d  SmallPreTrainedM
+000053e0: 6f64 656c 293a 0a20 2020 2022 2222 0a20  odel):.    """. 
+000053f0: 2020 2054 7261 6e73 666f 726d 6572 2065     Transformer e
+00005400: 6e63 6f64 6572 2063 6f6e 7369 7374 696e  ncoder consistin
+00005410: 6720 6f66 202a 636f 6e66 6967 2e65 6e63  g of *config.enc
+00005420: 6f64 6572 5f6c 6179 6572 732a 2073 656c  oder_layers* sel
+00005430: 6620 6174 7465 6e74 696f 6e20 6c61 7965  f attention laye
+00005440: 7273 2e20 4561 6368 206c 6179 6572 2069  rs. Each layer i
+00005450: 7320 610a 2020 2020 5b60 426c 656e 6465  s a.    [`Blende
+00005460: 7262 6f74 536d 616c 6c45 6e63 6f64 6572  rbotSmallEncoder
+00005470: 4c61 7965 7260 5d2e 0a0a 2020 2020 4172  Layer`]...    Ar
+00005480: 6773 3a0a 2020 2020 2020 2020 636f 6e66  gs:.        conf
+00005490: 6967 3a20 426c 656e 6465 7262 6f74 536d  ig: BlenderbotSm
+000054a0: 616c 6c43 6f6e 6669 670a 2020 2020 2020  allConfig.      
+000054b0: 2020 656d 6265 645f 746f 6b65 6e73 2028    embed_tokens (
+000054c0: 6e6e 2e45 6d62 6564 6469 6e67 293a 206f  nn.Embedding): o
+000054d0: 7574 7075 7420 656d 6265 6464 696e 670a  utput embedding.
+000054e0: 2020 2020 2222 220a 0a20 2020 2064 6566      """..    def
+000054f0: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
+00005500: 636f 6e66 6967 3a20 426c 656e 6465 7262  config: Blenderb
+00005510: 6f74 536d 616c 6c43 6f6e 6669 672c 2065  otSmallConfig, e
+00005520: 6d62 6564 5f74 6f6b 656e 733a 204f 7074  mbed_tokens: Opt
+00005530: 696f 6e61 6c5b 6e6e 2e45 6d62 6564 6469  ional[nn.Embeddi
+00005540: 6e67 5d20 3d20 4e6f 6e65 293a 0a20 2020  ng] = None):.   
+00005550: 2020 2020 2073 7570 6572 2829 2e5f 5f69       super().__i
+00005560: 6e69 745f 5f28 636f 6e66 6967 290a 0a20  nit__(config).. 
+00005570: 2020 2020 2020 2073 656c 662e 6472 6f70         self.drop
+00005580: 6f75 7420 3d20 636f 6e66 6967 2e64 726f  out = config.dro
+00005590: 706f 7574 0a20 2020 2020 2020 2073 656c  pout.        sel
+000055a0: 662e 6c61 7965 7264 726f 7020 3d20 636f  f.layerdrop = co
+000055b0: 6e66 6967 2e65 6e63 6f64 6572 5f6c 6179  nfig.encoder_lay
+000055c0: 6572 6472 6f70 0a0a 2020 2020 2020 2020  erdrop..        
+000055d0: 656d 6265 645f 6469 6d20 3d20 636f 6e66  embed_dim = conf
+000055e0: 6967 2e64 5f6d 6f64 656c 0a20 2020 2020  ig.d_model.     
+000055f0: 2020 2073 656c 662e 7061 6464 696e 675f     self.padding_
+00005600: 6964 7820 3d20 636f 6e66 6967 2e70 6164  idx = config.pad
+00005610: 5f74 6f6b 656e 5f69 640a 2020 2020 2020  _token_id.      
+00005620: 2020 7365 6c66 2e6d 6178 5f73 6f75 7263    self.max_sourc
+00005630: 655f 706f 7369 7469 6f6e 7320 3d20 636f  e_positions = co
+00005640: 6e66 6967 2e6d 6178 5f70 6f73 6974 696f  nfig.max_positio
+00005650: 6e5f 656d 6265 6464 696e 6773 0a20 2020  n_embeddings.   
+00005660: 2020 2020 2073 656c 662e 656d 6265 645f       self.embed_
+00005670: 7363 616c 6520 3d20 6d61 7468 2e73 7172  scale = math.sqr
+00005680: 7428 656d 6265 645f 6469 6d29 2069 6620  t(embed_dim) if 
+00005690: 636f 6e66 6967 2e73 6361 6c65 5f65 6d62  config.scale_emb
+000056a0: 6564 6469 6e67 2065 6c73 6520 312e 300a  edding else 1.0.
+000056b0: 0a20 2020 2020 2020 2069 6620 656d 6265  .        if embe
+000056c0: 645f 746f 6b65 6e73 2069 7320 6e6f 7420  d_tokens is not 
+000056d0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+000056e0: 2020 7365 6c66 2e65 6d62 6564 5f74 6f6b    self.embed_tok
+000056f0: 656e 7320 3d20 656d 6265 645f 746f 6b65  ens = embed_toke
+00005700: 6e73 0a20 2020 2020 2020 2065 6c73 653a  ns.        else:
+00005710: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00005720: 662e 656d 6265 645f 746f 6b65 6e73 203d  f.embed_tokens =
+00005730: 206e 6e2e 456d 6265 6464 696e 6728 636f   nn.Embedding(co
+00005740: 6e66 6967 2e76 6f63 6162 5f73 697a 652c  nfig.vocab_size,
+00005750: 2065 6d62 6564 5f64 696d 2c20 7365 6c66   embed_dim, self
+00005760: 2e70 6164 6469 6e67 5f69 6478 290a 0a20  .padding_idx).. 
+00005770: 2020 2020 2020 2073 656c 662e 656d 6265         self.embe
+00005780: 645f 706f 7369 7469 6f6e 7320 3d20 426c  d_positions = Bl
+00005790: 656e 6465 7262 6f74 536d 616c 6c4c 6561  enderbotSmallLea
+000057a0: 726e 6564 506f 7369 7469 6f6e 616c 456d  rnedPositionalEm
+000057b0: 6265 6464 696e 6728 0a20 2020 2020 2020  bedding(.       
+000057c0: 2020 2020 2063 6f6e 6669 672e 6d61 785f       config.max_
+000057d0: 706f 7369 7469 6f6e 5f65 6d62 6564 6469  position_embeddi
+000057e0: 6e67 732c 0a20 2020 2020 2020 2020 2020  ngs,.           
+000057f0: 2065 6d62 6564 5f64 696d 2c0a 2020 2020   embed_dim,.    
+00005800: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
+00005810: 6c66 2e6c 6179 6572 7320 3d20 6e6e 2e43  lf.layers = nn.C
+00005820: 656c 6c4c 6973 7428 5b42 6c65 6e64 6572  ellList([Blender
+00005830: 626f 7453 6d61 6c6c 456e 636f 6465 724c  botSmallEncoderL
+00005840: 6179 6572 2863 6f6e 6669 6729 2066 6f72  ayer(config) for
+00005850: 205f 2069 6e20 7261 6e67 6528 636f 6e66   _ in range(conf
+00005860: 6967 2e65 6e63 6f64 6572 5f6c 6179 6572  ig.encoder_layer
+00005870: 7329 5d29 0a20 2020 2020 2020 2073 656c  s)]).        sel
+00005880: 662e 6c61 7965 726e 6f72 6d5f 656d 6265  f.layernorm_embe
+00005890: 6464 696e 6720 3d20 6e6e 2e4c 6179 6572  dding = nn.Layer
+000058a0: 4e6f 726d 2865 6d62 6564 5f64 696d 290a  Norm(embed_dim).
+000058b0: 0a20 2020 2020 2020 2073 656c 662e 6772  .        self.gr
+000058c0: 6164 6965 6e74 5f63 6865 636b 706f 696e  adient_checkpoin
+000058d0: 7469 6e67 203d 2046 616c 7365 0a20 2020  ting = False.   
+000058e0: 2020 2020 2023 2049 6e69 7469 616c 697a       # Initializ
+000058f0: 6520 7765 6967 6874 7320 616e 6420 6170  e weights and ap
+00005900: 706c 7920 6669 6e61 6c20 7072 6f63 6573  ply final proces
+00005910: 7369 6e67 0a20 2020 2020 2020 2073 656c  sing.        sel
+00005920: 662e 706f 7374 5f69 6e69 7428 290a 0a20  f.post_init().. 
+00005930: 2020 2064 6566 2063 6f6e 7374 7275 6374     def construct
+00005940: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+00005950: 2020 2020 2020 2020 696e 7075 745f 6964          input_id
+00005960: 733d 4e6f 6e65 2c0a 2020 2020 2020 2020  s=None,.        
+00005970: 6174 7465 6e74 696f 6e5f 6d61 736b 3d4e  attention_mask=N
+00005980: 6f6e 652c 0a20 2020 2020 2020 2068 6561  one,.        hea
+00005990: 645f 6d61 736b 3d4e 6f6e 652c 0a20 2020  d_mask=None,.   
+000059a0: 2020 2020 2069 6e70 7574 735f 656d 6265       inputs_embe
+000059b0: 6473 3d4e 6f6e 652c 0a20 2020 2020 2020  ds=None,.       
+000059c0: 206f 7574 7075 745f 6174 7465 6e74 696f   output_attentio
+000059d0: 6e73 3d4e 6f6e 652c 0a20 2020 2020 2020  ns=None,.       
+000059e0: 206f 7574 7075 745f 6869 6464 656e 5f73   output_hidden_s
+000059f0: 7461 7465 733d 4e6f 6e65 2c0a 2020 2020  tates=None,.    
+00005a00: 2020 2020 7265 7475 726e 5f64 6963 743d      return_dict=
+00005a10: 4e6f 6e65 2c0a 2020 2020 293a 0a20 2020  None,.    ):.   
+00005a20: 2020 2020 2072 2222 220a 2020 2020 2020       r""".      
+00005a30: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+00005a40: 2020 2020 696e 7075 745f 6964 7320 2860      input_ids (`
+00005a50: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+00005a60: 6020 6f66 2073 6861 7065 2060 2862 6174  ` of shape `(bat
+00005a70: 6368 5f73 697a 652c 2073 6571 7565 6e63  ch_size, sequenc
+00005a80: 655f 6c65 6e67 7468 2960 293a 0a20 2020  e_length)`):.   
+00005a90: 2020 2020 2020 2020 2020 2020 2049 6e64               Ind
+00005aa0: 6963 6573 206f 6620 696e 7075 7420 7365  ices of input se
+00005ab0: 7175 656e 6365 2074 6f6b 656e 7320 696e  quence tokens in
+00005ac0: 2074 6865 2076 6f63 6162 756c 6172 792e   the vocabulary.
+00005ad0: 2050 6164 6469 6e67 2077 696c 6c20 6265   Padding will be
+00005ae0: 2069 676e 6f72 6564 2062 7920 6465 6661   ignored by defa
+00005af0: 756c 7420 7368 6f75 6c64 2079 6f75 0a20  ult should you. 
+00005b00: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00005b10: 726f 7669 6465 2069 742e 0a0a 2020 2020  rovide it...    
+00005b20: 2020 2020 2020 2020 2020 2020 496e 6469              Indi
+00005b30: 6365 7320 6361 6e20 6265 206f 6274 6169  ces can be obtai
+00005b40: 6e65 6420 7573 696e 6720 5b60 4175 746f  ned using [`Auto
+00005b50: 546f 6b65 6e69 7a65 7260 5d2e 2053 6565  Tokenizer`]. See
+00005b60: 205b 6050 7265 5472 6169 6e65 6454 6f6b   [`PreTrainedTok
+00005b70: 656e 697a 6572 2e65 6e63 6f64 6560 5d20  enizer.encode`] 
+00005b80: 616e 640a 2020 2020 2020 2020 2020 2020  and.            
+00005b90: 2020 2020 5b60 5072 6554 7261 696e 6564      [`PreTrained
+00005ba0: 546f 6b65 6e69 7a65 722e 5f5f 6361 6c6c  Tokenizer.__call
+00005bb0: 5f5f 605d 2066 6f72 2064 6574 6169 6c73  __`] for details
+00005bc0: 2e0a 0a20 2020 2020 2020 2020 2020 2020  ...             
+00005bd0: 2020 205b 5768 6174 2061 7265 2069 6e70     [What are inp
+00005be0: 7574 2049 4473 3f5d 282e 2e2f 676c 6f73  ut IDs?](../glos
+00005bf0: 7361 7279 2369 6e70 7574 2d69 6473 290a  sary#input-ids).
+00005c00: 2020 2020 2020 2020 2020 2020 6174 7465              atte
+00005c10: 6e74 696f 6e5f 6d61 736b 2028 606d 696e  ntion_mask (`min
+00005c20: 6473 706f 7265 2e54 656e 736f 7260 206f  dspore.Tensor` o
+00005c30: 6620 7368 6170 6520 6028 6261 7463 685f  f shape `(batch_
+00005c40: 7369 7a65 2c20 7365 7175 656e 6365 5f6c  size, sequence_l
+00005c50: 656e 6774 6829 602c 202a 6f70 7469 6f6e  ength)`, *option
+00005c60: 616c 2a29 3a0a 2020 2020 2020 2020 2020  al*):.          
+00005c70: 2020 2020 2020 4d61 736b 2074 6f20 6176        Mask to av
+00005c80: 6f69 6420 7065 7266 6f72 6d69 6e67 2061  oid performing a
+00005c90: 7474 656e 7469 6f6e 206f 6e20 7061 6464  ttention on padd
+00005ca0: 696e 6720 746f 6b65 6e20 696e 6469 6365  ing token indice
+00005cb0: 732e 204d 6173 6b20 7661 6c75 6573 2073  s. Mask values s
+00005cc0: 656c 6563 7465 6420 696e 2060 5b30 2c20  elected in `[0, 
+00005cd0: 315d 603a 0a0a 2020 2020 2020 2020 2020  1]`:..          
+00005ce0: 2020 2020 2020 2d20 3120 666f 7220 746f        - 1 for to
+00005cf0: 6b65 6e73 2074 6861 7420 6172 6520 2a2a  kens that are **
+00005d00: 6e6f 7420 6d61 736b 6564 2a2a 2c0a 2020  not masked**,.  
+00005d10: 2020 2020 2020 2020 2020 2020 2020 2d20                - 
+00005d20: 3020 666f 7220 746f 6b65 6e73 2074 6861  0 for tokens tha
+00005d30: 7420 6172 6520 2a2a 6d61 736b 6564 2a2a  t are **masked**
+00005d40: 2e0a 0a20 2020 2020 2020 2020 2020 2020  ...             
+00005d50: 2020 205b 5768 6174 2061 7265 2061 7474     [What are att
+00005d60: 656e 7469 6f6e 206d 6173 6b73 3f5d 282e  ention masks?](.
+00005d70: 2e2f 676c 6f73 7361 7279 2361 7474 656e  ./glossary#atten
+00005d80: 7469 6f6e 2d6d 6173 6b29 0a20 2020 2020  tion-mask).     
+00005d90: 2020 2020 2020 2068 6561 645f 6d61 736b         head_mask
+00005da0: 2028 606d 696e 6473 706f 7265 2e54 656e   (`mindspore.Ten
+00005db0: 736f 7260 206f 6620 7368 6170 6520 6028  sor` of shape `(
+00005dc0: 656e 636f 6465 725f 6c61 7965 7273 2c20  encoder_layers, 
+00005dd0: 656e 636f 6465 725f 6174 7465 6e74 696f  encoder_attentio
+00005de0: 6e5f 6865 6164 7329 602c 202a 6f70 7469  n_heads)`, *opti
+00005df0: 6f6e 616c 2a29 3a0a 2020 2020 2020 2020  onal*):.        
+00005e00: 2020 2020 2020 2020 4d61 736b 2074 6f20          Mask to 
+00005e10: 6e75 6c6c 6966 7920 7365 6c65 6374 6564  nullify selected
+00005e20: 2068 6561 6473 206f 6620 7468 6520 6174   heads of the at
+00005e30: 7465 6e74 696f 6e20 6d6f 6475 6c65 732e  tention modules.
+00005e40: 204d 6173 6b20 7661 6c75 6573 2073 656c   Mask values sel
+00005e50: 6563 7465 6420 696e 2060 5b30 2c20 315d  ected in `[0, 1]
+00005e60: 603a 0a0a 2020 2020 2020 2020 2020 2020  `:..            
+00005e70: 2020 2020 2d20 3120 696e 6469 6361 7465      - 1 indicate
+00005e80: 7320 7468 6520 6865 6164 2069 7320 2a2a  s the head is **
+00005e90: 6e6f 7420 6d61 736b 6564 2a2a 2c0a 2020  not masked**,.  
+00005ea0: 2020 2020 2020 2020 2020 2020 2020 2d20                - 
+00005eb0: 3020 696e 6469 6361 7465 7320 7468 6520  0 indicates the 
+00005ec0: 6865 6164 2069 7320 2a2a 6d61 736b 6564  head is **masked
+00005ed0: 2a2a 2e0a 0a20 2020 2020 2020 2020 2020  **...           
+00005ee0: 2069 6e70 7574 735f 656d 6265 6473 2028   inputs_embeds (
+00005ef0: 606d 696e 6473 706f 7265 2e54 656e 736f  `mindspore.Tenso
+00005f00: 7260 206f 6620 7368 6170 6520 6028 6261  r` of shape `(ba
+00005f10: 7463 685f 7369 7a65 2c20 7365 7175 656e  tch_size, sequen
+00005f20: 6365 5f6c 656e 6774 682c 2068 6964 6465  ce_length, hidde
+00005f30: 6e5f 7369 7a65 2960 2c20 2a6f 7074 696f  n_size)`, *optio
+00005f40: 6e61 6c2a 293a 0a20 2020 2020 2020 2020  nal*):.         
+00005f50: 2020 2020 2020 204f 7074 696f 6e61 6c6c         Optionall
+00005f60: 792c 2069 6e73 7465 6164 206f 6620 7061  y, instead of pa
+00005f70: 7373 696e 6720 6069 6e70 7574 5f69 6473  ssing `input_ids
+00005f80: 6020 796f 7520 6361 6e20 6368 6f6f 7365  ` you can choose
+00005f90: 2074 6f20 6469 7265 6374 6c79 2070 6173   to directly pas
+00005fa0: 7320 616e 2065 6d62 6564 6465 6420 7265  s an embedded re
+00005fb0: 7072 6573 656e 7461 7469 6f6e 2e0a 2020  presentation..  
+00005fc0: 2020 2020 2020 2020 2020 2020 2020 5468                Th
+00005fd0: 6973 2069 7320 7573 6566 756c 2069 6620  is is useful if 
+00005fe0: 796f 7520 7761 6e74 206d 6f72 6520 636f  you want more co
+00005ff0: 6e74 726f 6c20 6f76 6572 2068 6f77 2074  ntrol over how t
+00006000: 6f20 636f 6e76 6572 7420 6069 6e70 7574  o convert `input
+00006010: 5f69 6473 6020 696e 6469 6365 7320 696e  _ids` indices in
+00006020: 746f 2061 7373 6f63 6961 7465 6420 7665  to associated ve
+00006030: 6374 6f72 730a 2020 2020 2020 2020 2020  ctors.          
+00006040: 2020 2020 2020 7468 616e 2074 6865 206d        than the m
+00006050: 6f64 656c 2773 2069 6e74 6572 6e61 6c20  odel's internal 
+00006060: 656d 6265 6464 696e 6720 6c6f 6f6b 7570  embedding lookup
+00006070: 206d 6174 7269 782e 0a20 2020 2020 2020   matrix..       
+00006080: 2020 2020 206f 7574 7075 745f 6174 7465       output_atte
+00006090: 6e74 696f 6e73 2028 6062 6f6f 6c60 2c20  ntions (`bool`, 
+000060a0: 2a6f 7074 696f 6e61 6c2a 293a 0a20 2020  *optional*):.   
+000060b0: 2020 2020 2020 2020 2020 2020 2057 6865               Whe
+000060c0: 7468 6572 206f 7220 6e6f 7420 746f 2072  ther or not to r
+000060d0: 6574 7572 6e20 7468 6520 6174 7465 6e74  eturn the attent
+000060e0: 696f 6e73 2074 656e 736f 7273 206f 6620  ions tensors of 
+000060f0: 616c 6c20 6174 7465 6e74 696f 6e20 6c61  all attention la
+00006100: 7965 7273 2e20 5365 6520 6061 7474 656e  yers. See `atten
+00006110: 7469 6f6e 7360 2075 6e64 6572 0a20 2020  tions` under.   
+00006120: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00006130: 7572 6e65 6420 7465 6e73 6f72 7320 666f  urned tensors fo
+00006140: 7220 6d6f 7265 2064 6574 6169 6c2e 0a20  r more detail.. 
+00006150: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
+00006160: 745f 6869 6464 656e 5f73 7461 7465 7320  t_hidden_states 
+00006170: 2860 626f 6f6c 602c 202a 6f70 7469 6f6e  (`bool`, *option
+00006180: 616c 2a29 3a0a 2020 2020 2020 2020 2020  al*):.          
+00006190: 2020 2020 2020 5768 6574 6865 7220 6f72        Whether or
+000061a0: 206e 6f74 2074 6f20 7265 7475 726e 2074   not to return t
+000061b0: 6865 2068 6964 6465 6e20 7374 6174 6573  he hidden states
+000061c0: 206f 6620 616c 6c20 6c61 7965 7273 2e20   of all layers. 
+000061d0: 5365 6520 6068 6964 6465 6e5f 7374 6174  See `hidden_stat
+000061e0: 6573 6020 756e 6465 7220 7265 7475 726e  es` under return
+000061f0: 6564 2074 656e 736f 7273 0a20 2020 2020  ed tensors.     
+00006200: 2020 2020 2020 2020 2020 2066 6f72 206d             for m
+00006210: 6f72 6520 6465 7461 696c 2e0a 2020 2020  ore detail..    
+00006220: 2020 2020 2020 2020 7265 7475 726e 5f64          return_d
+00006230: 6963 7420 2860 626f 6f6c 602c 202a 6f70  ict (`bool`, *op
+00006240: 7469 6f6e 616c 2a29 3a0a 2020 2020 2020  tional*):.      
+00006250: 2020 2020 2020 2020 2020 5768 6574 6865            Whethe
+00006260: 7220 6f72 206e 6f74 2074 6f20 7265 7475  r or not to retu
+00006270: 726e 2061 205b 607e 7574 696c 732e 4d6f  rn a [`~utils.Mo
+00006280: 6465 6c4f 7574 7075 7460 5d20 696e 7374  delOutput`] inst
+00006290: 6561 6420 6f66 2061 2070 6c61 696e 2074  ead of a plain t
+000062a0: 7570 6c65 2e0a 2020 2020 2020 2020 2222  uple..        ""
+000062b0: 220a 2020 2020 2020 2020 6f75 7470 7574  ".        output
+000062c0: 5f61 7474 656e 7469 6f6e 7320 3d20 6f75  _attentions = ou
+000062d0: 7470 7574 5f61 7474 656e 7469 6f6e 7320  tput_attentions 
+000062e0: 6966 206f 7574 7075 745f 6174 7465 6e74  if output_attent
+000062f0: 696f 6e73 2069 7320 6e6f 7420 4e6f 6e65  ions is not None
+00006300: 2065 6c73 6520 7365 6c66 2e63 6f6e 6669   else self.confi
+00006310: 672e 6f75 7470 7574 5f61 7474 656e 7469  g.output_attenti
+00006320: 6f6e 730a 2020 2020 2020 2020 6f75 7470  ons.        outp
+00006330: 7574 5f68 6964 6465 6e5f 7374 6174 6573  ut_hidden_states
+00006340: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+00006350: 206f 7574 7075 745f 6869 6464 656e 5f73   output_hidden_s
+00006360: 7461 7465 7320 6966 206f 7574 7075 745f  tates if output_
+00006370: 6869 6464 656e 5f73 7461 7465 7320 6973  hidden_states is
+00006380: 206e 6f74 204e 6f6e 6520 656c 7365 2073   not None else s
+00006390: 656c 662e 636f 6e66 6967 2e6f 7574 7075  elf.config.outpu
+000063a0: 745f 6869 6464 656e 5f73 7461 7465 730a  t_hidden_states.
+000063b0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000063c0: 2020 7265 7475 726e 5f64 6963 7420 3d20    return_dict = 
+000063d0: 7265 7475 726e 5f64 6963 7420 6966 2072  return_dict if r
+000063e0: 6574 7572 6e5f 6469 6374 2069 7320 6e6f  eturn_dict is no
+000063f0: 7420 4e6f 6e65 2065 6c73 6520 7365 6c66  t None else self
+00006400: 2e63 6f6e 6669 672e 7573 655f 7265 7475  .config.use_retu
+00006410: 726e 5f64 6963 740a 0a20 2020 2020 2020  rn_dict..       
+00006420: 2023 2072 6574 7269 6576 6520 696e 7075   # retrieve inpu
+00006430: 745f 6964 7320 616e 6420 696e 7075 7473  t_ids and inputs
+00006440: 5f65 6d62 6564 730a 2020 2020 2020 2020  _embeds.        
+00006450: 6966 2069 6e70 7574 5f69 6473 2069 7320  if input_ids is 
+00006460: 6e6f 7420 4e6f 6e65 2061 6e64 2069 6e70  not None and inp
+00006470: 7574 735f 656d 6265 6473 2069 7320 6e6f  uts_embeds is no
+00006480: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00006490: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+000064a0: 7272 6f72 2822 596f 7520 6361 6e6e 6f74  rror("You cannot
+000064b0: 2073 7065 6369 6679 2062 6f74 6820 696e   specify both in
+000064c0: 7075 745f 6964 7320 616e 6420 696e 7075  put_ids and inpu
+000064d0: 7473 5f65 6d62 6564 7320 6174 2074 6865  ts_embeds at the
+000064e0: 2073 616d 6520 7469 6d65 2229 0a20 2020   same time").   
+000064f0: 2020 2020 2065 6c69 6620 696e 7075 745f       elif input_
+00006500: 6964 7320 6973 206e 6f74 204e 6f6e 653a  ids is not None:
+00006510: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00006520: 662e 7761 726e 5f69 665f 7061 6464 696e  f.warn_if_paddin
+00006530: 675f 616e 645f 6e6f 5f61 7474 656e 7469  g_and_no_attenti
+00006540: 6f6e 5f6d 6173 6b28 696e 7075 745f 6964  on_mask(input_id
+00006550: 732c 2061 7474 656e 7469 6f6e 5f6d 6173  s, attention_mas
+00006560: 6b29 0a20 2020 2020 2020 2020 2020 2069  k).            i
+00006570: 6e70 7574 5f73 6861 7065 203d 2069 6e70  nput_shape = inp
+00006580: 7574 5f69 6473 2e73 6861 7065 0a20 2020  ut_ids.shape.   
+00006590: 2020 2020 2020 2020 2069 6e70 7574 5f69           input_i
+000065a0: 6473 203d 2069 6e70 7574 5f69 6473 2e76  ds = input_ids.v
+000065b0: 6965 7728 2d31 2c20 696e 7075 745f 7368  iew(-1, input_sh
+000065c0: 6170 655b 2d31 5d29 0a20 2020 2020 2020  ape[-1]).       
+000065d0: 2065 6c69 6620 696e 7075 7473 5f65 6d62   elif inputs_emb
+000065e0: 6564 7320 6973 206e 6f74 204e 6f6e 653a  eds is not None:
+000065f0: 0a20 2020 2020 2020 2020 2020 2069 6e70  .            inp
+00006600: 7574 5f73 6861 7065 203d 2069 6e70 7574  ut_shape = input
+00006610: 735f 656d 6265 6473 2e73 6861 7065 5b3a  s_embeds.shape[:
+00006620: 2d31 5d0a 2020 2020 2020 2020 656c 7365  -1].        else
+00006630: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+00006640: 6973 6520 5661 6c75 6545 7272 6f72 2822  ise ValueError("
+00006650: 596f 7520 6861 7665 2074 6f20 7370 6563  You have to spec
+00006660: 6966 7920 6569 7468 6572 2069 6e70 7574  ify either input
+00006670: 5f69 6473 206f 7220 696e 7075 7473 5f65  _ids or inputs_e
+00006680: 6d62 6564 7322 290a 0a20 2020 2020 2020  mbeds")..       
+00006690: 2069 6620 696e 7075 7473 5f65 6d62 6564   if inputs_embed
+000066a0: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
+000066b0: 2020 2020 2020 2069 6e70 7574 735f 656d         inputs_em
+000066c0: 6265 6473 203d 2073 656c 662e 656d 6265  beds = self.embe
+000066d0: 645f 746f 6b65 6e73 2869 6e70 7574 5f69  d_tokens(input_i
+000066e0: 6473 2920 2a20 7365 6c66 2e65 6d62 6564  ds) * self.embed
+000066f0: 5f73 6361 6c65 0a0a 2020 2020 2020 2020  _scale..        
+00006700: 656d 6265 645f 706f 7320 3d20 7365 6c66  embed_pos = self
+00006710: 2e65 6d62 6564 5f70 6f73 6974 696f 6e73  .embed_positions
+00006720: 2869 6e70 7574 5f73 6861 7065 290a 0a20  (input_shape).. 
+00006730: 2020 2020 2020 2068 6964 6465 6e5f 7374         hidden_st
+00006740: 6174 6573 203d 2069 6e70 7574 735f 656d  ates = inputs_em
+00006750: 6265 6473 202b 2065 6d62 6564 5f70 6f73  beds + embed_pos
+00006760: 0a20 2020 2020 2020 2068 6964 6465 6e5f  .        hidden_
+00006770: 7374 6174 6573 203d 2073 656c 662e 6c61  states = self.la
+00006780: 7965 726e 6f72 6d5f 656d 6265 6464 696e  yernorm_embeddin
+00006790: 6728 6869 6464 656e 5f73 7461 7465 7329  g(hidden_states)
+000067a0: 0a20 2020 2020 2020 2068 6964 6465 6e5f  .        hidden_
+000067b0: 7374 6174 6573 203d 206f 7073 2e64 726f  states = ops.dro
+000067c0: 706f 7574 2868 6964 6465 6e5f 7374 6174  pout(hidden_stat
+000067d0: 6573 2c20 703d 7365 6c66 2e64 726f 706f  es, p=self.dropo
+000067e0: 7574 2c20 7472 6169 6e69 6e67 3d73 656c  ut, training=sel
+000067f0: 662e 7472 6169 6e69 6e67 290a 0a20 2020  f.training)..   
+00006800: 2020 2020 2023 2065 7870 616e 6420 6174       # expand at
+00006810: 7465 6e74 696f 6e5f 6d61 736b 0a20 2020  tention_mask.   
+00006820: 2020 2020 2069 6620 6174 7465 6e74 696f       if attentio
+00006830: 6e5f 6d61 736b 2069 7320 6e6f 7420 4e6f  n_mask is not No
+00006840: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00006850: 2320 5b62 737a 2c20 7365 715f 6c65 6e5d  # [bsz, seq_len]
+00006860: 202d 3e20 5b62 737a 2c20 312c 2074 6774   -> [bsz, 1, tgt
+00006870: 5f73 6571 5f6c 656e 2c20 7372 635f 7365  _seq_len, src_se
+00006880: 715f 6c65 6e5d 0a20 2020 2020 2020 2020  q_len].         
+00006890: 2020 2061 7474 656e 7469 6f6e 5f6d 6173     attention_mas
+000068a0: 6b20 3d20 5f70 7265 7061 7265 5f34 645f  k = _prepare_4d_
+000068b0: 6174 7465 6e74 696f 6e5f 6d61 736b 2861  attention_mask(a
+000068c0: 7474 656e 7469 6f6e 5f6d 6173 6b2c 2069  ttention_mask, i
+000068d0: 6e70 7574 735f 656d 6265 6473 2e64 7479  nputs_embeds.dty
+000068e0: 7065 290a 0a20 2020 2020 2020 2065 6e63  pe)..        enc
+000068f0: 6f64 6572 5f73 7461 7465 7320 3d20 2829  oder_states = ()
+00006900: 2069 6620 6f75 7470 7574 5f68 6964 6465   if output_hidde
+00006910: 6e5f 7374 6174 6573 2065 6c73 6520 4e6f  n_states else No
+00006920: 6e65 0a20 2020 2020 2020 2061 6c6c 5f61  ne.        all_a
+00006930: 7474 656e 7469 6f6e 7320 3d20 2829 2069  ttentions = () i
+00006940: 6620 6f75 7470 7574 5f61 7474 656e 7469  f output_attenti
+00006950: 6f6e 7320 656c 7365 204e 6f6e 650a 0a20  ons else None.. 
+00006960: 2020 2020 2020 2023 2063 6865 636b 2069         # check i
+00006970: 6620 6865 6164 5f6d 6173 6b20 6861 7320  f head_mask has 
+00006980: 6120 636f 7272 6563 7420 6e75 6d62 6572  a correct number
+00006990: 206f 6620 6c61 7965 7273 2073 7065 6369   of layers speci
+000069a0: 6669 6564 2069 6620 6465 7369 7265 640a  fied if desired.
+000069b0: 2020 2020 2020 2020 6966 2068 6561 645f          if head_
+000069c0: 6d61 736b 2069 7320 6e6f 7420 4e6f 6e65  mask is not None
+000069d0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+000069e0: 2068 6561 645f 6d61 736b 2e73 6861 7065   head_mask.shape
+000069f0: 5b30 5d20 213d 206c 656e 2873 656c 662e  [0] != len(self.
+00006a00: 6c61 7965 7273 293a 0a20 2020 2020 2020  layers):.       
+00006a10: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+00006a20: 616c 7565 4572 726f 7228 0a20 2020 2020  alueError(.     
+00006a30: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00006a40: 2254 6865 2068 6561 645f 6d61 736b 2073  "The head_mask s
+00006a50: 686f 756c 6420 6265 2073 7065 6369 6669  hould be specifi
+00006a60: 6564 2066 6f72 207b 6c65 6e28 7365 6c66  ed for {len(self
+00006a70: 2e6c 6179 6572 7329 7d20 6c61 7965 7273  .layers)} layers
+00006a80: 2c20 6275 7420 6974 2069 7320 666f 7222  , but it is for"
+00006a90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006aa0: 2020 2020 2066 2220 7b68 6561 645f 6d61       f" {head_ma
+00006ab0: 736b 2e73 6861 7065 5b30 5d7d 2e22 0a20  sk.shape[0]}.". 
+00006ac0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00006ad0: 0a20 2020 2020 2020 2066 6f72 2069 6478  .        for idx
+00006ae0: 2c20 656e 636f 6465 725f 6c61 7965 7220  , encoder_layer 
+00006af0: 696e 2065 6e75 6d65 7261 7465 2873 656c  in enumerate(sel
+00006b00: 662e 6c61 7965 7273 293a 0a20 2020 2020  f.layers):.     
+00006b10: 2020 2020 2020 2069 6620 6f75 7470 7574         if output
+00006b20: 5f68 6964 6465 6e5f 7374 6174 6573 3a0a  _hidden_states:.
+00006b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006b40: 656e 636f 6465 725f 7374 6174 6573 203d  encoder_states =
+00006b50: 2065 6e63 6f64 6572 5f73 7461 7465 7320   encoder_states 
+00006b60: 2b20 2868 6964 6465 6e5f 7374 6174 6573  + (hidden_states
+00006b70: 2c29 0a20 2020 2020 2020 2020 2020 2023  ,).            #
+00006b80: 2061 6464 204c 6179 6572 4472 6f70 2028   add LayerDrop (
+00006b90: 7365 6520 6874 7470 733a 2f2f 6172 7869  see https://arxi
+00006ba0: 762e 6f72 672f 6162 732f 3139 3039 2e31  v.org/abs/1909.1
+00006bb0: 3135 3536 2066 6f72 2064 6573 6372 6970  1556 for descrip
+00006bc0: 7469 6f6e 290a 2020 2020 2020 2020 2020  tion).          
+00006bd0: 2020 746f 5f64 726f 7020 3d20 4661 6c73    to_drop = Fals
+00006be0: 650a 2020 2020 2020 2020 2020 2020 6966  e.            if
+00006bf0: 2073 656c 662e 7472 6169 6e69 6e67 3a0a   self.training:.
+00006c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006c10: 6472 6f70 6f75 745f 7072 6f62 6162 696c  dropout_probabil
+00006c20: 6974 7920 3d20 6f70 732e 7261 6e64 285b  ity = ops.rand([
+00006c30: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
+00006c40: 2020 2069 6620 6472 6f70 6f75 745f 7072     if dropout_pr
+00006c50: 6f62 6162 696c 6974 7920 3c20 7365 6c66  obability < self
+00006c60: 2e6c 6179 6572 6472 6f70 3a20 2023 2073  .layerdrop:  # s
+00006c70: 6b69 7020 7468 6520 6c61 7965 720a 2020  kip the layer.  
+00006c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006c90: 2020 746f 5f64 726f 7020 3d20 5472 7565    to_drop = True
+00006ca0: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+00006cb0: 2074 6f5f 6472 6f70 3a0a 2020 2020 2020   to_drop:.      
+00006cc0: 2020 2020 2020 2020 2020 6c61 7965 725f            layer_
+00006cd0: 6f75 7470 7574 7320 3d20 284e 6f6e 652c  outputs = (None,
+00006ce0: 204e 6f6e 6529 0a20 2020 2020 2020 2020   None).         
+00006cf0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00006d00: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+00006d10: 2e67 7261 6469 656e 745f 6368 6563 6b70  .gradient_checkp
+00006d20: 6f69 6e74 696e 6720 616e 6420 7365 6c66  ointing and self
+00006d30: 2e74 7261 696e 696e 673a 0a20 2020 2020  .training:.     
+00006d40: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00006d50: 6179 6572 5f6f 7574 7075 7473 203d 2073  ayer_outputs = s
+00006d60: 656c 662e 5f67 7261 6469 656e 745f 6368  elf._gradient_ch
+00006d70: 6563 6b70 6f69 6e74 696e 675f 6675 6e63  eckpointing_func
+00006d80: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00006d90: 2020 2020 2020 2020 2020 656e 636f 6465            encode
+00006da0: 725f 6c61 7965 722e 5f5f 6361 6c6c 5f5f  r_layer.__call__
+00006db0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00006dc0: 2020 2020 2020 2020 2020 6869 6464 656e            hidden
+00006dd0: 5f73 7461 7465 732c 0a20 2020 2020 2020  _states,.       
+00006de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006df0: 2061 7474 656e 7469 6f6e 5f6d 6173 6b2c   attention_mask,
+00006e00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006e10: 2020 2020 2020 2020 2028 6865 6164 5f6d           (head_m
+00006e20: 6173 6b5b 6964 785d 2069 6620 6865 6164  ask[idx] if head
+00006e30: 5f6d 6173 6b20 6973 206e 6f74 204e 6f6e  _mask is not Non
+00006e40: 6520 656c 7365 204e 6f6e 6529 2c0a 2020  e else None),.  
+00006e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006e60: 2020 2020 2020 6f75 7470 7574 5f61 7474        output_att
+00006e70: 656e 7469 6f6e 732c 0a20 2020 2020 2020  entions,.       
+00006e80: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+00006e90: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00006ea0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00006eb0: 2020 2020 2020 2020 206c 6179 6572 5f6f           layer_o
+00006ec0: 7574 7075 7473 203d 2065 6e63 6f64 6572  utputs = encoder
+00006ed0: 5f6c 6179 6572 280a 2020 2020 2020 2020  _layer(.        
+00006ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006ef0: 6869 6464 656e 5f73 7461 7465 732c 0a20  hidden_states,. 
+00006f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006f10: 2020 2020 2020 2061 7474 656e 7469 6f6e         attention
+00006f20: 5f6d 6173 6b2c 0a20 2020 2020 2020 2020  _mask,.         
+00006f30: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00006f40: 6179 6572 5f68 6561 645f 6d61 736b 3d28  ayer_head_mask=(
+00006f50: 6865 6164 5f6d 6173 6b5b 6964 785d 2069  head_mask[idx] i
+00006f60: 6620 6865 6164 5f6d 6173 6b20 6973 206e  f head_mask is n
+00006f70: 6f74 204e 6f6e 6520 656c 7365 204e 6f6e  ot None else Non
+00006f80: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+00006f90: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
+00006fa0: 7574 5f61 7474 656e 7469 6f6e 733d 6f75  ut_attentions=ou
+00006fb0: 7470 7574 5f61 7474 656e 7469 6f6e 732c  tput_attentions,
+00006fc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006fd0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00006fe0: 2020 2020 2020 2020 6869 6464 656e 5f73          hidden_s
+00006ff0: 7461 7465 7320 3d20 6c61 7965 725f 6f75  tates = layer_ou
+00007000: 7470 7574 735b 305d 0a0a 2020 2020 2020  tputs[0]..      
+00007010: 2020 2020 2020 6966 206f 7574 7075 745f        if output_
+00007020: 6174 7465 6e74 696f 6e73 3a0a 2020 2020  attentions:.    
+00007030: 2020 2020 2020 2020 2020 2020 616c 6c5f              all_
+00007040: 6174 7465 6e74 696f 6e73 203d 2061 6c6c  attentions = all
+00007050: 5f61 7474 656e 7469 6f6e 7320 2b20 286c  _attentions + (l
+00007060: 6179 6572 5f6f 7574 7075 7473 5b31 5d2c  ayer_outputs[1],
+00007070: 290a 0a20 2020 2020 2020 2069 6620 6f75  )..        if ou
+00007080: 7470 7574 5f68 6964 6465 6e5f 7374 6174  tput_hidden_stat
+00007090: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+000070a0: 656e 636f 6465 725f 7374 6174 6573 203d  encoder_states =
+000070b0: 2065 6e63 6f64 6572 5f73 7461 7465 7320   encoder_states 
+000070c0: 2b20 2868 6964 6465 6e5f 7374 6174 6573  + (hidden_states
+000070d0: 2c29 0a0a 2020 2020 2020 2020 6966 206e  ,)..        if n
+000070e0: 6f74 2072 6574 7572 6e5f 6469 6374 3a0a  ot return_dict:.
+000070f0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00007100: 726e 2074 7570 6c65 2876 2066 6f72 2076  rn tuple(v for v
+00007110: 2069 6e20 5b68 6964 6465 6e5f 7374 6174   in [hidden_stat
+00007120: 6573 2c20 656e 636f 6465 725f 7374 6174  es, encoder_stat
+00007130: 6573 2c20 616c 6c5f 6174 7465 6e74 696f  es, all_attentio
+00007140: 6e73 5d20 6966 2076 2069 7320 6e6f 7420  ns] if v is not 
+00007150: 4e6f 6e65 290a 2020 2020 2020 2020 7265  None).        re
+00007160: 7475 726e 2042 6173 654d 6f64 656c 4f75  turn BaseModelOu
+00007170: 7470 7574 280a 2020 2020 2020 2020 2020  tput(.          
+00007180: 2020 6c61 7374 5f68 6964 6465 6e5f 7374    last_hidden_st
+00007190: 6174 653d 6869 6464 656e 5f73 7461 7465  ate=hidden_state
+000071a0: 732c 2068 6964 6465 6e5f 7374 6174 6573  s, hidden_states
+000071b0: 3d65 6e63 6f64 6572 5f73 7461 7465 732c  =encoder_states,
+000071c0: 2061 7474 656e 7469 6f6e 733d 616c 6c5f   attentions=all_
+000071d0: 6174 7465 6e74 696f 6e73 0a20 2020 2020  attentions.     
+000071e0: 2020 2029 0a0a 0a63 6c61 7373 2042 6c65     )...class Ble
+000071f0: 6e64 6572 626f 7453 6d61 6c6c 4465 636f  nderbotSmallDeco
+00007200: 6465 7228 426c 656e 6465 7262 6f74 536d  der(BlenderbotSm
+00007210: 616c 6c50 7265 5472 6169 6e65 644d 6f64  allPreTrainedMod
+00007220: 656c 293a 0a20 2020 2022 2222 0a20 2020  el):.    """.   
+00007230: 2054 7261 6e73 666f 726d 6572 2064 6563   Transformer dec
+00007240: 6f64 6572 2063 6f6e 7369 7374 696e 6720  oder consisting 
+00007250: 6f66 202a 636f 6e66 6967 2e64 6563 6f64  of *config.decod
+00007260: 6572 5f6c 6179 6572 732a 206c 6179 6572  er_layers* layer
+00007270: 732e 2045 6163 6820 6c61 7965 7220 6973  s. Each layer is
+00007280: 2061 205b 6042 6c65 6e64 6572 626f 7453   a [`BlenderbotS
+00007290: 6d61 6c6c 4465 636f 6465 724c 6179 6572  mallDecoderLayer
+000072a0: 605d 0a0a 2020 2020 4172 6773 3a0a 2020  `]..    Args:.  
+000072b0: 2020 2020 2020 636f 6e66 6967 3a20 426c        config: Bl
+000072c0: 656e 6465 7262 6f74 536d 616c 6c43 6f6e  enderbotSmallCon
+000072d0: 6669 670a 2020 2020 2020 2020 656d 6265  fig.        embe
+000072e0: 645f 746f 6b65 6e73 2028 6e6e 2e45 6d62  d_tokens (nn.Emb
+000072f0: 6564 6469 6e67 293a 206f 7574 7075 7420  edding): output 
+00007300: 656d 6265 6464 696e 670a 2020 2020 2222  embedding.    ""
+00007310: 220a 0a20 2020 2064 6566 205f 5f69 6e69  "..    def __ini
+00007320: 745f 5f28 7365 6c66 2c20 636f 6e66 6967  t__(self, config
+00007330: 3a20 426c 656e 6465 7262 6f74 536d 616c  : BlenderbotSmal
+00007340: 6c43 6f6e 6669 672c 2065 6d62 6564 5f74  lConfig, embed_t
+00007350: 6f6b 656e 733a 204f 7074 696f 6e61 6c5b  okens: Optional[
+00007360: 6e6e 2e45 6d62 6564 6469 6e67 5d20 3d20  nn.Embedding] = 
+00007370: 4e6f 6e65 293a 0a20 2020 2020 2020 2073  None):.        s
+00007380: 7570 6572 2829 2e5f 5f69 6e69 745f 5f28  uper().__init__(
+00007390: 636f 6e66 6967 290a 2020 2020 2020 2020  config).        
+000073a0: 7365 6c66 2e64 726f 706f 7574 203d 2063  self.dropout = c
+000073b0: 6f6e 6669 672e 6472 6f70 6f75 740a 2020  onfig.dropout.  
+000073c0: 2020 2020 2020 7365 6c66 2e6c 6179 6572        self.layer
+000073d0: 6472 6f70 203d 2063 6f6e 6669 672e 6465  drop = config.de
+000073e0: 636f 6465 725f 6c61 7965 7264 726f 700a  coder_layerdrop.
+000073f0: 2020 2020 2020 2020 7365 6c66 2e70 6164          self.pad
+00007400: 6469 6e67 5f69 6478 203d 2063 6f6e 6669  ding_idx = confi
+00007410: 672e 7061 645f 746f 6b65 6e5f 6964 0a20  g.pad_token_id. 
+00007420: 2020 2020 2020 2073 656c 662e 6d61 785f         self.max_
+00007430: 7461 7267 6574 5f70 6f73 6974 696f 6e73  target_positions
+00007440: 203d 2063 6f6e 6669 672e 6d61 785f 706f   = config.max_po
+00007450: 7369 7469 6f6e 5f65 6d62 6564 6469 6e67  sition_embedding
+00007460: 730a 2020 2020 2020 2020 7365 6c66 2e65  s.        self.e
+00007470: 6d62 6564 5f73 6361 6c65 203d 206d 6174  mbed_scale = mat
+00007480: 682e 7371 7274 2863 6f6e 6669 672e 645f  h.sqrt(config.d_
+00007490: 6d6f 6465 6c29 2069 6620 636f 6e66 6967  model) if config
+000074a0: 2e73 6361 6c65 5f65 6d62 6564 6469 6e67  .scale_embedding
+000074b0: 2065 6c73 6520 312e 300a 0a20 2020 2020   else 1.0..     
+000074c0: 2020 2069 6620 656d 6265 645f 746f 6b65     if embed_toke
+000074d0: 6e73 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ns is not None:.
+000074e0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000074f0: 2e65 6d62 6564 5f74 6f6b 656e 7320 3d20  .embed_tokens = 
+00007500: 656d 6265 645f 746f 6b65 6e73 0a20 2020  embed_tokens.   
+00007510: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00007520: 2020 2020 2020 2073 656c 662e 656d 6265         self.embe
+00007530: 645f 746f 6b65 6e73 203d 206e 6e2e 456d  d_tokens = nn.Em
+00007540: 6265 6464 696e 6728 636f 6e66 6967 2e76  bedding(config.v
+00007550: 6f63 6162 5f73 697a 652c 2063 6f6e 6669  ocab_size, confi
+00007560: 672e 645f 6d6f 6465 6c2c 2073 656c 662e  g.d_model, self.
+00007570: 7061 6464 696e 675f 6964 7829 0a0a 2020  padding_idx)..  
+00007580: 2020 2020 2020 7365 6c66 2e65 6d62 6564        self.embed
+00007590: 5f70 6f73 6974 696f 6e73 203d 2042 6c65  _positions = Ble
+000075a0: 6e64 6572 626f 7453 6d61 6c6c 4c65 6172  nderbotSmallLear
+000075b0: 6e65 6450 6f73 6974 696f 6e61 6c45 6d62  nedPositionalEmb
+000075c0: 6564 6469 6e67 280a 2020 2020 2020 2020  edding(.        
+000075d0: 2020 2020 636f 6e66 6967 2e6d 6178 5f70      config.max_p
+000075e0: 6f73 6974 696f 6e5f 656d 6265 6464 696e  osition_embeddin
+000075f0: 6773 2c0a 2020 2020 2020 2020 2020 2020  gs,.            
+00007600: 636f 6e66 6967 2e64 5f6d 6f64 656c 2c0a  config.d_model,.
+00007610: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00007620: 2020 7365 6c66 2e6c 6179 6572 7320 3d20    self.layers = 
+00007630: 6e6e 2e43 656c 6c4c 6973 7428 5b42 6c65  nn.CellList([Ble
+00007640: 6e64 6572 626f 7453 6d61 6c6c 4465 636f  nderbotSmallDeco
+00007650: 6465 724c 6179 6572 2863 6f6e 6669 6729  derLayer(config)
+00007660: 2066 6f72 205f 2069 6e20 7261 6e67 6528   for _ in range(
+00007670: 636f 6e66 6967 2e64 6563 6f64 6572 5f6c  config.decoder_l
+00007680: 6179 6572 7329 5d29 0a20 2020 2020 2020  ayers)]).       
+00007690: 2073 656c 662e 6c61 7965 726e 6f72 6d5f   self.layernorm_
+000076a0: 656d 6265 6464 696e 6720 3d20 6e6e 2e4c  embedding = nn.L
+000076b0: 6179 6572 4e6f 726d 2863 6f6e 6669 672e  ayerNorm(config.
+000076c0: 645f 6d6f 6465 6c29 0a0a 2020 2020 2020  d_model)..      
+000076d0: 2020 7365 6c66 2e67 7261 6469 656e 745f    self.gradient_
+000076e0: 6368 6563 6b70 6f69 6e74 696e 6720 3d20  checkpointing = 
+000076f0: 4661 6c73 650a 2020 2020 2020 2020 2320  False.        # 
+00007700: 496e 6974 6961 6c69 7a65 2077 6569 6768  Initialize weigh
+00007710: 7473 2061 6e64 2061 7070 6c79 2066 696e  ts and apply fin
+00007720: 616c 2070 726f 6365 7373 696e 670a 2020  al processing.  
+00007730: 2020 2020 2020 7365 6c66 2e70 6f73 745f        self.post_
+00007740: 696e 6974 2829 0a0a 2020 2020 6465 6620  init()..    def 
+00007750: 6765 745f 696e 7075 745f 656d 6265 6464  get_input_embedd
+00007760: 696e 6773 2873 656c 6629 3a0a 2020 2020  ings(self):.    
+00007770: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+00007780: 656d 6265 645f 746f 6b65 6e73 0a0a 2020  embed_tokens..  
+00007790: 2020 6465 6620 7365 745f 696e 7075 745f    def set_input_
+000077a0: 656d 6265 6464 696e 6773 2873 656c 662c  embeddings(self,
+000077b0: 2076 616c 7565 293a 0a20 2020 2020 2020   value):.       
+000077c0: 2073 656c 662e 656d 6265 645f 746f 6b65   self.embed_toke
+000077d0: 6e73 203d 2076 616c 7565 0a0a 2020 2020  ns = value..    
+000077e0: 6465 6620 636f 6e73 7472 7563 7428 0a20  def construct(. 
+000077f0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+00007800: 2020 2020 2069 6e70 7574 5f69 6473 3d4e       input_ids=N
+00007810: 6f6e 652c 0a20 2020 2020 2020 2061 7474  one,.        att
+00007820: 656e 7469 6f6e 5f6d 6173 6b3d 4e6f 6e65  ention_mask=None
+00007830: 2c0a 2020 2020 2020 2020 656e 636f 6465  ,.        encode
+00007840: 725f 6869 6464 656e 5f73 7461 7465 733d  r_hidden_states=
+00007850: 4e6f 6e65 2c0a 2020 2020 2020 2020 656e  None,.        en
+00007860: 636f 6465 725f 6174 7465 6e74 696f 6e5f  coder_attention_
+00007870: 6d61 736b 3d4e 6f6e 652c 0a20 2020 2020  mask=None,.     
+00007880: 2020 2068 6561 645f 6d61 736b 3d4e 6f6e     head_mask=Non
+00007890: 652c 0a20 2020 2020 2020 2063 726f 7373  e,.        cross
+000078a0: 5f61 7474 6e5f 6865 6164 5f6d 6173 6b3d  _attn_head_mask=
+000078b0: 4e6f 6e65 2c0a 2020 2020 2020 2020 7061  None,.        pa
+000078c0: 7374 5f6b 6579 5f76 616c 7565 733d 4e6f  st_key_values=No
+000078d0: 6e65 2c0a 2020 2020 2020 2020 696e 7075  ne,.        inpu
+000078e0: 7473 5f65 6d62 6564 733d 4e6f 6e65 2c0a  ts_embeds=None,.
+000078f0: 2020 2020 2020 2020 7573 655f 6361 6368          use_cach
+00007900: 653d 4e6f 6e65 2c0a 2020 2020 2020 2020  e=None,.        
+00007910: 6f75 7470 7574 5f61 7474 656e 7469 6f6e  output_attention
+00007920: 733d 4e6f 6e65 2c0a 2020 2020 2020 2020  s=None,.        
+00007930: 6f75 7470 7574 5f68 6964 6465 6e5f 7374  output_hidden_st
+00007940: 6174 6573 3d4e 6f6e 652c 0a20 2020 2020  ates=None,.     
+00007950: 2020 2072 6574 7572 6e5f 6469 6374 3d4e     return_dict=N
+00007960: 6f6e 652c 0a20 2020 2029 3a0a 2020 2020  one,.    ):.    
+00007970: 2020 2020 7222 2222 0a20 2020 2020 2020      r""".       
+00007980: 2041 7267 733a 0a20 2020 2020 2020 2020   Args:.         
+00007990: 2020 2069 6e70 7574 5f69 6473 2028 606d     input_ids (`m
+000079a0: 696e 6473 706f 7265 2e54 656e 736f 7260  indspore.Tensor`
+000079b0: 206f 6620 7368 6170 6520 6028 6261 7463   of shape `(batc
+000079c0: 685f 7369 7a65 2c20 7365 7175 656e 6365  h_size, sequence
+000079d0: 5f6c 656e 6774 6829 6029 3a0a 2020 2020  _length)`):.    
+000079e0: 2020 2020 2020 2020 2020 2020 496e 6469              Indi
+000079f0: 6365 7320 6f66 2069 6e70 7574 2073 6571  ces of input seq
+00007a00: 7565 6e63 6520 746f 6b65 6e73 2069 6e20  uence tokens in 
+00007a10: 7468 6520 766f 6361 6275 6c61 7279 2e20  the vocabulary. 
+00007a20: 5061 6464 696e 6720 7769 6c6c 2062 6520  Padding will be 
+00007a30: 6967 6e6f 7265 6420 6279 2064 6566 6175  ignored by defau
+00007a40: 6c74 2073 686f 756c 6420 796f 750a 2020  lt should you.  
+00007a50: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+00007a60: 6f76 6964 6520 6974 2e0a 0a20 2020 2020  ovide it...     
+00007a70: 2020 2020 2020 2020 2020 2049 6e64 6963             Indic
+00007a80: 6573 2063 616e 2062 6520 6f62 7461 696e  es can be obtain
+00007a90: 6564 2075 7369 6e67 205b 6041 7574 6f54  ed using [`AutoT
+00007aa0: 6f6b 656e 697a 6572 605d 2e20 5365 6520  okenizer`]. See 
+00007ab0: 5b60 5072 6554 7261 696e 6564 546f 6b65  [`PreTrainedToke
+00007ac0: 6e69 7a65 722e 656e 636f 6465 605d 2061  nizer.encode`] a
+00007ad0: 6e64 0a20 2020 2020 2020 2020 2020 2020  nd.             
+00007ae0: 2020 205b 6050 7265 5472 6169 6e65 6454     [`PreTrainedT
+00007af0: 6f6b 656e 697a 6572 2e5f 5f63 616c 6c5f  okenizer.__call_
+00007b00: 5f60 5d20 666f 7220 6465 7461 696c 732e  _`] for details.
+00007b10: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00007b20: 2020 5b57 6861 7420 6172 6520 696e 7075    [What are inpu
+00007b30: 7420 4944 733f 5d28 2e2e 2f67 6c6f 7373  t IDs?](../gloss
+00007b40: 6172 7923 696e 7075 742d 6964 7329 0a20  ary#input-ids). 
+00007b50: 2020 2020 2020 2020 2020 2061 7474 656e             atten
+00007b60: 7469 6f6e 5f6d 6173 6b20 2860 6d69 6e64  tion_mask (`mind
+00007b70: 7370 6f72 652e 5465 6e73 6f72 6020 6f66  spore.Tensor` of
+00007b80: 2073 6861 7065 2060 2862 6174 6368 5f73   shape `(batch_s
+00007b90: 697a 652c 2073 6571 7565 6e63 655f 6c65  ize, sequence_le
+00007ba0: 6e67 7468 2960 2c20 2a6f 7074 696f 6e61  ngth)`, *optiona
+00007bb0: 6c2a 293a 0a20 2020 2020 2020 2020 2020  l*):.           
+00007bc0: 2020 2020 204d 6173 6b20 746f 2061 766f       Mask to avo
+00007bd0: 6964 2070 6572 666f 726d 696e 6720 6174  id performing at
+00007be0: 7465 6e74 696f 6e20 6f6e 2070 6164 6469  tention on paddi
+00007bf0: 6e67 2074 6f6b 656e 2069 6e64 6963 6573  ng token indices
+00007c00: 2e20 4d61 736b 2076 616c 7565 7320 7365  . Mask values se
+00007c10: 6c65 6374 6564 2069 6e20 605b 302c 2031  lected in `[0, 1
+00007c20: 5d60 3a0a 0a20 2020 2020 2020 2020 2020  ]`:..           
+00007c30: 2020 2020 202d 2031 2066 6f72 2074 6f6b       - 1 for tok
+00007c40: 656e 7320 7468 6174 2061 7265 202a 2a6e  ens that are **n
+00007c50: 6f74 206d 6173 6b65 642a 2a2c 0a20 2020  ot masked**,.   
+00007c60: 2020 2020 2020 2020 2020 2020 202d 2030               - 0
+00007c70: 2066 6f72 2074 6f6b 656e 7320 7468 6174   for tokens that
+00007c80: 2061 7265 202a 2a6d 6173 6b65 642a 2a2e   are **masked**.
+00007c90: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00007ca0: 2020 5b57 6861 7420 6172 6520 6174 7465    [What are atte
+00007cb0: 6e74 696f 6e20 6d61 736b 733f 5d28 2e2e  ntion masks?](..
+00007cc0: 2f67 6c6f 7373 6172 7923 6174 7465 6e74  /glossary#attent
+00007cd0: 696f 6e2d 6d61 736b 290a 2020 2020 2020  ion-mask).      
+00007ce0: 2020 2020 2020 656e 636f 6465 725f 6869        encoder_hi
+00007cf0: 6464 656e 5f73 7461 7465 7320 2860 6d69  dden_states (`mi
+00007d00: 6e64 7370 6f72 652e 5465 6e73 6f72 6020  ndspore.Tensor` 
+00007d10: 6f66 2073 6861 7065 2060 2862 6174 6368  of shape `(batch
+00007d20: 5f73 697a 652c 2065 6e63 6f64 6572 5f73  _size, encoder_s
+00007d30: 6571 7565 6e63 655f 6c65 6e67 7468 2c20  equence_length, 
+00007d40: 6869 6464 656e 5f73 697a 6529 602c 202a  hidden_size)`, *
+00007d50: 6f70 7469 6f6e 616c 2a29 3a0a 2020 2020  optional*):.    
+00007d60: 2020 2020 2020 2020 2020 2020 5365 7175              Sequ
+00007d70: 656e 6365 206f 6620 6869 6464 656e 2d73  ence of hidden-s
+00007d80: 7461 7465 7320 6174 2074 6865 206f 7574  tates at the out
+00007d90: 7075 7420 6f66 2074 6865 206c 6173 7420  put of the last 
+00007da0: 6c61 7965 7220 6f66 2074 6865 2065 6e63  layer of the enc
+00007db0: 6f64 6572 2e20 5573 6564 2069 6e20 7468  oder. Used in th
+00007dc0: 6520 6372 6f73 732d 6174 7465 6e74 696f  e cross-attentio
+00007dd0: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
+00007de0: 2020 6f66 2074 6865 2064 6563 6f64 6572    of the decoder
+00007df0: 2e0a 2020 2020 2020 2020 2020 2020 656e  ..            en
+00007e00: 636f 6465 725f 6174 7465 6e74 696f 6e5f  coder_attention_
+00007e10: 6d61 736b 2028 606d 696e 6473 706f 7265  mask (`mindspore
+00007e20: 2e54 656e 736f 7260 206f 6620 7368 6170  .Tensor` of shap
+00007e30: 6520 6028 6261 7463 685f 7369 7a65 2c20  e `(batch_size, 
+00007e40: 656e 636f 6465 725f 7365 7175 656e 6365  encoder_sequence
+00007e50: 5f6c 656e 6774 6829 602c 202a 6f70 7469  _length)`, *opti
+00007e60: 6f6e 616c 2a29 3a0a 2020 2020 2020 2020  onal*):.        
+00007e70: 2020 2020 2020 2020 4d61 736b 2074 6f20          Mask to 
+00007e80: 6176 6f69 6420 7065 7266 6f72 6d69 6e67  avoid performing
+00007e90: 2063 726f 7373 2d61 7474 656e 7469 6f6e   cross-attention
+00007ea0: 206f 6e20 7061 6464 696e 6720 746f 6b65   on padding toke
+00007eb0: 6e73 2069 6e64 6963 6573 206f 6620 656e  ns indices of en
+00007ec0: 636f 6465 7220 696e 7075 745f 6964 732e  coder input_ids.
+00007ed0: 204d 6173 6b20 7661 6c75 6573 0a20 2020   Mask values.   
+00007ee0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00007ef0: 6563 7465 6420 696e 2060 5b30 2c20 315d  ected in `[0, 1]
+00007f00: 603a 0a0a 2020 2020 2020 2020 2020 2020  `:..            
+00007f10: 2020 2020 2d20 3120 666f 7220 746f 6b65      - 1 for toke
+00007f20: 6e73 2074 6861 7420 6172 6520 2a2a 6e6f  ns that are **no
+00007f30: 7420 6d61 736b 6564 2a2a 2c0a 2020 2020  t masked**,.    
+00007f40: 2020 2020 2020 2020 2020 2020 2d20 3020              - 0 
+00007f50: 666f 7220 746f 6b65 6e73 2074 6861 7420  for tokens that 
+00007f60: 6172 6520 2a2a 6d61 736b 6564 2a2a 2e0a  are **masked**..
+00007f70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007f80: 205b 5768 6174 2061 7265 2061 7474 656e   [What are atten
+00007f90: 7469 6f6e 206d 6173 6b73 3f5d 282e 2e2f  tion masks?](../
+00007fa0: 676c 6f73 7361 7279 2361 7474 656e 7469  glossary#attenti
+00007fb0: 6f6e 2d6d 6173 6b29 0a20 2020 2020 2020  on-mask).       
+00007fc0: 2020 2020 2068 6561 645f 6d61 736b 2028       head_mask (
+00007fd0: 606d 696e 6473 706f 7265 2e54 656e 736f  `mindspore.Tenso
+00007fe0: 7260 206f 6620 7368 6170 6520 6028 6465  r` of shape `(de
+00007ff0: 636f 6465 725f 6c61 7965 7273 2c20 6465  coder_layers, de
+00008000: 636f 6465 725f 6174 7465 6e74 696f 6e5f  coder_attention_
+00008010: 6865 6164 7329 602c 202a 6f70 7469 6f6e  heads)`, *option
+00008020: 616c 2a29 3a0a 2020 2020 2020 2020 2020  al*):.          
+00008030: 2020 2020 2020 4d61 736b 2074 6f20 6e75        Mask to nu
+00008040: 6c6c 6966 7920 7365 6c65 6374 6564 2068  llify selected h
+00008050: 6561 6473 206f 6620 7468 6520 6174 7465  eads of the atte
+00008060: 6e74 696f 6e20 6d6f 6475 6c65 732e 204d  ntion modules. M
+00008070: 6173 6b20 7661 6c75 6573 2073 656c 6563  ask values selec
+00008080: 7465 6420 696e 2060 5b30 2c20 315d 603a  ted in `[0, 1]`:
+00008090: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+000080a0: 2020 2d20 3120 696e 6469 6361 7465 7320    - 1 indicates 
+000080b0: 7468 6520 6865 6164 2069 7320 2a2a 6e6f  the head is **no
+000080c0: 7420 6d61 736b 6564 2a2a 2c0a 2020 2020  t masked**,.    
+000080d0: 2020 2020 2020 2020 2020 2020 2d20 3020              - 0 
+000080e0: 696e 6469 6361 7465 7320 7468 6520 6865  indicates the he
+000080f0: 6164 2069 7320 2a2a 6d61 736b 6564 2a2a  ad is **masked**
+00008100: 2e0a 0a20 2020 2020 2020 2020 2020 2063  ...            c
+00008110: 726f 7373 5f61 7474 6e5f 6865 6164 5f6d  ross_attn_head_m
+00008120: 6173 6b20 2860 6d69 6e64 7370 6f72 652e  ask (`mindspore.
+00008130: 5465 6e73 6f72 6020 6f66 2073 6861 7065  Tensor` of shape
+00008140: 2060 2864 6563 6f64 6572 5f6c 6179 6572   `(decoder_layer
+00008150: 732c 2064 6563 6f64 6572 5f61 7474 656e  s, decoder_atten
+00008160: 7469 6f6e 5f68 6561 6473 2960 2c20 2a6f  tion_heads)`, *o
+00008170: 7074 696f 6e61 6c2a 293a 0a20 2020 2020  ptional*):.     
+00008180: 2020 2020 2020 2020 2020 204d 6173 6b20             Mask 
+00008190: 746f 206e 756c 6c69 6679 2073 656c 6563  to nullify selec
+000081a0: 7465 6420 6865 6164 7320 6f66 2074 6865  ted heads of the
+000081b0: 2063 726f 7373 2d61 7474 656e 7469 6f6e   cross-attention
+000081c0: 206d 6f64 756c 6573 2069 6e20 7468 6520   modules in the 
+000081d0: 6465 636f 6465 7220 746f 2061 766f 6964  decoder to avoid
+000081e0: 2070 6572 666f 726d 696e 670a 2020 2020   performing.    
+000081f0: 2020 2020 2020 2020 2020 2020 6372 6f73              cros
+00008200: 732d 6174 7465 6e74 696f 6e20 6f6e 2068  s-attention on h
+00008210: 6964 6465 6e20 6865 6164 732e 204d 6173  idden heads. Mas
+00008220: 6b20 7661 6c75 6573 2073 656c 6563 7465  k values selecte
+00008230: 6420 696e 2060 5b30 2c20 315d 603a 0a0a  d in `[0, 1]`:..
+00008240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008250: 2d20 3120 696e 6469 6361 7465 7320 7468  - 1 indicates th
+00008260: 6520 6865 6164 2069 7320 2a2a 6e6f 7420  e head is **not 
+00008270: 6d61 736b 6564 2a2a 2c0a 2020 2020 2020  masked**,.      
+00008280: 2020 2020 2020 2020 2020 2d20 3020 696e            - 0 in
+00008290: 6469 6361 7465 7320 7468 6520 6865 6164  dicates the head
+000082a0: 2069 7320 2a2a 6d61 736b 6564 2a2a 2e0a   is **masked**..
+000082b0: 0a20 2020 2020 2020 2020 2020 2070 6173  .            pas
+000082c0: 745f 6b65 795f 7661 6c75 6573 2028 6074  t_key_values (`t
+000082d0: 7570 6c65 2874 7570 6c65 286d 696e 6473  uple(tuple(minds
+000082e0: 706f 7265 2e54 656e 736f 7229 2960 2c20  pore.Tensor))`, 
+000082f0: 2a6f 7074 696f 6e61 6c2a 2c20 7265 7475  *optional*, retu
+00008300: 726e 6564 2077 6865 6e20 6075 7365 5f63  rned when `use_c
+00008310: 6163 6865 3d54 7275 6560 2069 7320 7061  ache=True` is pa
+00008320: 7373 6564 206f 7220 7768 656e 2060 636f  ssed or when `co
+00008330: 6e66 6967 2e75 7365 5f63 6163 6865 3d54  nfig.use_cache=T
+00008340: 7275 6560 293a 0a20 2020 2020 2020 2020  rue`):.         
+00008350: 2020 2020 2020 2054 7570 6c65 206f 6620         Tuple of 
+00008360: 6074 7570 6c65 286d 696e 6473 706f 7265  `tuple(mindspore
+00008370: 2e54 656e 736f 7229 6020 6f66 206c 656e  .Tensor)` of len
+00008380: 6774 6820 6063 6f6e 6669 672e 6e5f 6c61  gth `config.n_la
+00008390: 7965 7273 602c 2077 6974 6820 6561 6368  yers`, with each
+000083a0: 2074 7570 6c65 2068 6176 696e 6720 3220   tuple having 2 
+000083b0: 7465 6e73 6f72 7320 6f66 0a20 2020 2020  tensors of.     
+000083c0: 2020 2020 2020 2020 2020 2073 6861 7065             shape
+000083d0: 2060 2862 6174 6368 5f73 697a 652c 206e   `(batch_size, n
+000083e0: 756d 5f68 6561 6473 2c20 7365 7175 656e  um_heads, sequen
+000083f0: 6365 5f6c 656e 6774 682c 2065 6d62 6564  ce_length, embed
+00008400: 5f73 697a 655f 7065 725f 6865 6164 2960  _size_per_head)`
+00008410: 2920 616e 6420 3220 6164 6469 7469 6f6e  ) and 2 addition
+00008420: 616c 2074 656e 736f 7273 206f 660a 2020  al tensors of.  
+00008430: 2020 2020 2020 2020 2020 2020 2020 7368                sh
+00008440: 6170 6520 6028 6261 7463 685f 7369 7a65  ape `(batch_size
+00008450: 2c20 6e75 6d5f 6865 6164 732c 2065 6e63  , num_heads, enc
+00008460: 6f64 6572 5f73 6571 7565 6e63 655f 6c65  oder_sequence_le
+00008470: 6e67 7468 2c20 656d 6265 645f 7369 7a65  ngth, embed_size
+00008480: 5f70 6572 5f68 6561 6429 602e 0a0a 2020  _per_head)`...  
+00008490: 2020 2020 2020 2020 2020 2020 2020 436f                Co
+000084a0: 6e74 6169 6e73 2070 7265 2d63 6f6d 7075  ntains pre-compu
+000084b0: 7465 6420 6869 6464 656e 2d73 7461 7465  ted hidden-state
+000084c0: 7320 286b 6579 2061 6e64 2076 616c 7565  s (key and value
+000084d0: 7320 696e 2074 6865 2073 656c 662d 6174  s in the self-at
+000084e0: 7465 6e74 696f 6e20 626c 6f63 6b73 2061  tention blocks a
+000084f0: 6e64 2069 6e20 7468 650a 2020 2020 2020  nd in the.      
+00008500: 2020 2020 2020 2020 2020 6372 6f73 732d            cross-
+00008510: 6174 7465 6e74 696f 6e20 626c 6f63 6b73  attention blocks
+00008520: 2920 7468 6174 2063 616e 2062 6520 7573  ) that can be us
+00008530: 6564 2028 7365 6520 6070 6173 745f 6b65  ed (see `past_ke
+00008540: 795f 7661 6c75 6573 6020 696e 7075 7429  y_values` input)
+00008550: 2074 6f20 7370 6565 6420 7570 2073 6571   to speed up seq
+00008560: 7565 6e74 6961 6c20 6465 636f 6469 6e67  uential decoding
+00008570: 2e0a 0a20 2020 2020 2020 2020 2020 2020  ...             
+00008580: 2020 2049 6620 6070 6173 745f 6b65 795f     If `past_key_
+00008590: 7661 6c75 6573 6020 6172 6520 7573 6564  values` are used
+000085a0: 2c20 7468 6520 7573 6572 2063 616e 206f  , the user can o
+000085b0: 7074 696f 6e61 6c6c 7920 696e 7075 7420  ptionally input 
+000085c0: 6f6e 6c79 2074 6865 206c 6173 7420 6064  only the last `d
+000085d0: 6563 6f64 6572 5f69 6e70 7574 5f69 6473  ecoder_input_ids
+000085e0: 6020 2874 686f 7365 0a20 2020 2020 2020  ` (those.       
+000085f0: 2020 2020 2020 2020 2074 6861 7420 646f           that do
+00008600: 6e27 7420 6861 7665 2074 6865 6972 2070  n't have their p
+00008610: 6173 7420 6b65 7920 7661 6c75 6520 7374  ast key value st
+00008620: 6174 6573 2067 6976 656e 2074 6f20 7468  ates given to th
+00008630: 6973 206d 6f64 656c 2920 6f66 2073 6861  is model) of sha
+00008640: 7065 2060 2862 6174 6368 5f73 697a 652c  pe `(batch_size,
+00008650: 2031 2960 2069 6e73 7465 6164 206f 660a   1)` instead of.
+00008660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008670: 616c 6c20 6064 6563 6f64 6572 5f69 6e70  all `decoder_inp
+00008680: 7574 5f69 6473 6020 6f66 2073 6861 7065  ut_ids` of shape
+00008690: 2060 2862 6174 6368 5f73 697a 652c 2073   `(batch_size, s
+000086a0: 6571 7565 6e63 655f 6c65 6e67 7468 2960  equence_length)`
+000086b0: 2e0a 2020 2020 2020 2020 2020 2020 696e  ..            in
+000086c0: 7075 7473 5f65 6d62 6564 7320 2860 6d69  puts_embeds (`mi
+000086d0: 6e64 7370 6f72 652e 5465 6e73 6f72 6020  ndspore.Tensor` 
+000086e0: 6f66 2073 6861 7065 2060 2862 6174 6368  of shape `(batch
+000086f0: 5f73 697a 652c 2073 6571 7565 6e63 655f  _size, sequence_
+00008700: 6c65 6e67 7468 2c20 6869 6464 656e 5f73  length, hidden_s
+00008710: 697a 6529 602c 202a 6f70 7469 6f6e 616c  ize)`, *optional
+00008720: 2a29 3a0a 2020 2020 2020 2020 2020 2020  *):.            
+00008730: 2020 2020 4f70 7469 6f6e 616c 6c79 2c20      Optionally, 
+00008740: 696e 7374 6561 6420 6f66 2070 6173 7369  instead of passi
+00008750: 6e67 2060 696e 7075 745f 6964 7360 2079  ng `input_ids` y
+00008760: 6f75 2063 616e 2063 686f 6f73 6520 746f  ou can choose to
+00008770: 2064 6972 6563 746c 7920 7061 7373 2061   directly pass a
+00008780: 6e20 656d 6265 6464 6564 2072 6570 7265  n embedded repre
+00008790: 7365 6e74 6174 696f 6e2e 0a20 2020 2020  sentation..     
+000087a0: 2020 2020 2020 2020 2020 2054 6869 7320             This 
+000087b0: 6973 2075 7365 6675 6c20 6966 2079 6f75  is useful if you
+000087c0: 2077 616e 7420 6d6f 7265 2063 6f6e 7472   want more contr
+000087d0: 6f6c 206f 7665 7220 686f 7720 746f 2063  ol over how to c
+000087e0: 6f6e 7665 7274 2060 696e 7075 745f 6964  onvert `input_id
+000087f0: 7360 2069 6e64 6963 6573 2069 6e74 6f20  s` indices into 
+00008800: 6173 736f 6369 6174 6564 2076 6563 746f  associated vecto
+00008810: 7273 0a20 2020 2020 2020 2020 2020 2020  rs.             
+00008820: 2020 2074 6861 6e20 7468 6520 6d6f 6465     than the mode
+00008830: 6c27 7320 696e 7465 726e 616c 2065 6d62  l's internal emb
+00008840: 6564 6469 6e67 206c 6f6f 6b75 7020 6d61  edding lookup ma
+00008850: 7472 6978 2e0a 2020 2020 2020 2020 2020  trix..          
+00008860: 2020 6f75 7470 7574 5f61 7474 656e 7469    output_attenti
+00008870: 6f6e 7320 2860 626f 6f6c 602c 202a 6f70  ons (`bool`, *op
+00008880: 7469 6f6e 616c 2a29 3a0a 2020 2020 2020  tional*):.      
+00008890: 2020 2020 2020 2020 2020 5768 6574 6865            Whethe
+000088a0: 7220 6f72 206e 6f74 2074 6f20 7265 7475  r or not to retu
+000088b0: 726e 2074 6865 2061 7474 656e 7469 6f6e  rn the attention
+000088c0: 7320 7465 6e73 6f72 7320 6f66 2061 6c6c  s tensors of all
+000088d0: 2061 7474 656e 7469 6f6e 206c 6179 6572   attention layer
+000088e0: 732e 2053 6565 2060 6174 7465 6e74 696f  s. See `attentio
+000088f0: 6e73 6020 756e 6465 720a 2020 2020 2020  ns` under.      
+00008900: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00008910: 6564 2074 656e 736f 7273 2066 6f72 206d  ed tensors for m
+00008920: 6f72 6520 6465 7461 696c 2e0a 2020 2020  ore detail..    
+00008930: 2020 2020 2020 2020 6f75 7470 7574 5f68          output_h
+00008940: 6964 6465 6e5f 7374 6174 6573 2028 6062  idden_states (`b
+00008950: 6f6f 6c60 2c20 2a6f 7074 696f 6e61 6c2a  ool`, *optional*
+00008960: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00008970: 2020 2057 6865 7468 6572 206f 7220 6e6f     Whether or no
+00008980: 7420 746f 2072 6574 7572 6e20 7468 6520  t to return the 
+00008990: 6869 6464 656e 2073 7461 7465 7320 6f66  hidden states of
+000089a0: 2061 6c6c 206c 6179 6572 732e 2053 6565   all layers. See
+000089b0: 2060 6869 6464 656e 5f73 7461 7465 7360   `hidden_states`
+000089c0: 2075 6e64 6572 2072 6574 7572 6e65 6420   under returned 
+000089d0: 7465 6e73 6f72 730a 2020 2020 2020 2020  tensors.        
+000089e0: 2020 2020 2020 2020 666f 7220 6d6f 7265          for more
+000089f0: 2064 6574 6169 6c2e 0a20 2020 2020 2020   detail..       
+00008a00: 2020 2020 2072 6574 7572 6e5f 6469 6374       return_dict
+00008a10: 2028 6062 6f6f 6c60 2c20 2a6f 7074 696f   (`bool`, *optio
+00008a20: 6e61 6c2a 293a 0a20 2020 2020 2020 2020  nal*):.         
+00008a30: 2020 2020 2020 2057 6865 7468 6572 206f         Whether o
+00008a40: 7220 6e6f 7420 746f 2072 6574 7572 6e20  r not to return 
+00008a50: 6120 5b60 7e75 7469 6c73 2e4d 6f64 656c  a [`~utils.Model
+00008a60: 4f75 7470 7574 605d 2069 6e73 7465 6164  Output`] instead
+00008a70: 206f 6620 6120 706c 6169 6e20 7475 706c   of a plain tupl
+00008a80: 652e 0a20 2020 2020 2020 2022 2222 0a20  e..        """. 
+00008a90: 2020 2020 2020 206f 7574 7075 745f 6174         output_at
+00008aa0: 7465 6e74 696f 6e73 203d 206f 7574 7075  tentions = outpu
+00008ab0: 745f 6174 7465 6e74 696f 6e73 2069 6620  t_attentions if 
+00008ac0: 6f75 7470 7574 5f61 7474 656e 7469 6f6e  output_attention
+00008ad0: 7320 6973 206e 6f74 204e 6f6e 6520 656c  s is not None el
+00008ae0: 7365 2073 656c 662e 636f 6e66 6967 2e6f  se self.config.o
+00008af0: 7574 7075 745f 6174 7465 6e74 696f 6e73  utput_attentions
+00008b00: 0a20 2020 2020 2020 206f 7574 7075 745f  .        output_
+00008b10: 6869 6464 656e 5f73 7461 7465 7320 3d20  hidden_states = 
+00008b20: 280a 2020 2020 2020 2020 2020 2020 6f75  (.            ou
+00008b30: 7470 7574 5f68 6964 6465 6e5f 7374 6174  tput_hidden_stat
+00008b40: 6573 2069 6620 6f75 7470 7574 5f68 6964  es if output_hid
+00008b50: 6465 6e5f 7374 6174 6573 2069 7320 6e6f  den_states is no
+00008b60: 7420 4e6f 6e65 2065 6c73 6520 7365 6c66  t None else self
+00008b70: 2e63 6f6e 6669 672e 6f75 7470 7574 5f68  .config.output_h
+00008b80: 6964 6465 6e5f 7374 6174 6573 0a20 2020  idden_states.   
+00008b90: 2020 2020 2029 0a20 2020 2020 2020 2075       ).        u
+00008ba0: 7365 5f63 6163 6865 203d 2075 7365 5f63  se_cache = use_c
+00008bb0: 6163 6865 2069 6620 7573 655f 6361 6368  ache if use_cach
+00008bc0: 6520 6973 206e 6f74 204e 6f6e 6520 656c  e is not None el
+00008bd0: 7365 2073 656c 662e 636f 6e66 6967 2e75  se self.config.u
+00008be0: 7365 5f63 6163 6865 0a20 2020 2020 2020  se_cache.       
+00008bf0: 2072 6574 7572 6e5f 6469 6374 203d 2072   return_dict = r
+00008c00: 6574 7572 6e5f 6469 6374 2069 6620 7265  eturn_dict if re
+00008c10: 7475 726e 5f64 6963 7420 6973 206e 6f74  turn_dict is not
+00008c20: 204e 6f6e 6520 656c 7365 2073 656c 662e   None else self.
+00008c30: 636f 6e66 6967 2e75 7365 5f72 6574 7572  config.use_retur
+00008c40: 6e5f 6469 6374 0a0a 2020 2020 2020 2020  n_dict..        
+00008c50: 2320 7265 7472 6965 7665 2069 6e70 7574  # retrieve input
+00008c60: 5f69 6473 2061 6e64 2069 6e70 7574 735f  _ids and inputs_
+00008c70: 656d 6265 6473 0a20 2020 2020 2020 2069  embeds.        i
+00008c80: 6620 696e 7075 745f 6964 7320 6973 206e  f input_ids is n
+00008c90: 6f74 204e 6f6e 6520 616e 6420 696e 7075  ot None and inpu
+00008ca0: 7473 5f65 6d62 6564 7320 6973 206e 6f74  ts_embeds is not
+00008cb0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00008cc0: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+00008cd0: 726f 7228 2259 6f75 2063 616e 6e6f 7420  ror("You cannot 
+00008ce0: 7370 6563 6966 7920 626f 7468 2064 6563  specify both dec
+00008cf0: 6f64 6572 5f69 6e70 7574 5f69 6473 2061  oder_input_ids a
+00008d00: 6e64 2064 6563 6f64 6572 5f69 6e70 7574  nd decoder_input
+00008d10: 735f 656d 6265 6473 2061 7420 7468 6520  s_embeds at the 
+00008d20: 7361 6d65 2074 696d 6522 290a 2020 2020  same time").    
+00008d30: 2020 2020 656c 6966 2069 6e70 7574 5f69      elif input_i
+00008d40: 6473 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ds is not None:.
+00008d50: 2020 2020 2020 2020 2020 2020 696e 7075              inpu
+00008d60: 745f 7368 6170 6520 3d20 696e 7075 745f  t_shape = input_
+00008d70: 6964 732e 7368 6170 650a 2020 2020 2020  ids.shape.      
+00008d80: 2020 2020 2020 696e 7075 745f 6964 7320        input_ids 
+00008d90: 3d20 696e 7075 745f 6964 732e 7669 6577  = input_ids.view
+00008da0: 282d 312c 2069 6e70 7574 5f73 6861 7065  (-1, input_shape
+00008db0: 5b2d 315d 290a 2020 2020 2020 2020 656c  [-1]).        el
+00008dc0: 6966 2069 6e70 7574 735f 656d 6265 6473  if inputs_embeds
+00008dd0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00008de0: 2020 2020 2020 2020 2020 696e 7075 745f            input_
+00008df0: 7368 6170 6520 3d20 696e 7075 7473 5f65  shape = inputs_e
+00008e00: 6d62 6564 732e 7368 6170 655b 3a2d 315d  mbeds.shape[:-1]
+00008e10: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00008e20: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00008e30: 2056 616c 7565 4572 726f 7228 2259 6f75   ValueError("You
+00008e40: 2068 6176 6520 746f 2073 7065 6369 6679   have to specify
+00008e50: 2065 6974 6865 7220 6465 636f 6465 725f   either decoder_
+00008e60: 696e 7075 745f 6964 7320 6f72 2064 6563  input_ids or dec
+00008e70: 6f64 6572 5f69 6e70 7574 735f 656d 6265  oder_inputs_embe
+00008e80: 6473 2229 0a0a 2020 2020 2020 2020 2320  ds")..        # 
+00008e90: 7061 7374 5f6b 6579 5f76 616c 7565 735f  past_key_values_
+00008ea0: 6c65 6e67 7468 0a20 2020 2020 2020 2070  length.        p
+00008eb0: 6173 745f 6b65 795f 7661 6c75 6573 5f6c  ast_key_values_l
+00008ec0: 656e 6774 6820 3d20 7061 7374 5f6b 6579  ength = past_key
+00008ed0: 5f76 616c 7565 735b 305d 5b30 5d2e 7368  _values[0][0].sh
+00008ee0: 6170 655b 325d 2069 6620 7061 7374 5f6b  ape[2] if past_k
+00008ef0: 6579 5f76 616c 7565 7320 6973 206e 6f74  ey_values is not
+00008f00: 204e 6f6e 6520 656c 7365 2030 0a0a 2020   None else 0..  
+00008f10: 2020 2020 2020 6966 2069 6e70 7574 735f        if inputs_
+00008f20: 656d 6265 6473 2069 7320 4e6f 6e65 3a0a  embeds is None:.
+00008f30: 2020 2020 2020 2020 2020 2020 696e 7075              inpu
+00008f40: 7473 5f65 6d62 6564 7320 3d20 7365 6c66  ts_embeds = self
+00008f50: 2e65 6d62 6564 5f74 6f6b 656e 7328 696e  .embed_tokens(in
+00008f60: 7075 745f 6964 7329 202a 2073 656c 662e  put_ids) * self.
+00008f70: 656d 6265 645f 7363 616c 650a 0a20 2020  embed_scale..   
+00008f80: 2020 2020 2061 7474 656e 7469 6f6e 5f6d       attention_m
+00008f90: 6173 6b20 3d20 5f70 7265 7061 7265 5f34  ask = _prepare_4
+00008fa0: 645f 6361 7573 616c 5f61 7474 656e 7469  d_causal_attenti
+00008fb0: 6f6e 5f6d 6173 6b28 0a20 2020 2020 2020  on_mask(.       
+00008fc0: 2020 2020 2061 7474 656e 7469 6f6e 5f6d       attention_m
+00008fd0: 6173 6b2c 2069 6e70 7574 5f73 6861 7065  ask, input_shape
+00008fe0: 2c20 696e 7075 7473 5f65 6d62 6564 732c  , inputs_embeds,
+00008ff0: 2070 6173 745f 6b65 795f 7661 6c75 6573   past_key_values
+00009000: 5f6c 656e 6774 680a 2020 2020 2020 2020  _length.        
+00009010: 290a 0a20 2020 2020 2020 2023 2065 7870  )..        # exp
+00009020: 616e 6420 656e 636f 6465 7220 6174 7465  and encoder atte
+00009030: 6e74 696f 6e20 6d61 736b 0a20 2020 2020  ntion mask.     
+00009040: 2020 2069 6620 656e 636f 6465 725f 6869     if encoder_hi
+00009050: 6464 656e 5f73 7461 7465 7320 6973 206e  dden_states is n
+00009060: 6f74 204e 6f6e 6520 616e 6420 656e 636f  ot None and enco
+00009070: 6465 725f 6174 7465 6e74 696f 6e5f 6d61  der_attention_ma
+00009080: 736b 2069 7320 6e6f 7420 4e6f 6e65 3a0a  sk is not None:.
+00009090: 2020 2020 2020 2020 2020 2020 2320 5b62              # [b
+000090a0: 737a 2c20 7365 715f 6c65 6e5d 202d 3e20  sz, seq_len] -> 
+000090b0: 5b62 737a 2c20 312c 2074 6774 5f73 6571  [bsz, 1, tgt_seq
+000090c0: 5f6c 656e 2c20 7372 635f 7365 715f 6c65  _len, src_seq_le
+000090d0: 6e5d 0a20 2020 2020 2020 2020 2020 2065  n].            e
+000090e0: 6e63 6f64 6572 5f61 7474 656e 7469 6f6e  ncoder_attention
+000090f0: 5f6d 6173 6b20 3d20 5f70 7265 7061 7265  _mask = _prepare
+00009100: 5f34 645f 6174 7465 6e74 696f 6e5f 6d61  _4d_attention_ma
+00009110: 736b 280a 2020 2020 2020 2020 2020 2020  sk(.            
+00009120: 2020 2020 656e 636f 6465 725f 6174 7465      encoder_atte
+00009130: 6e74 696f 6e5f 6d61 736b 2c20 696e 7075  ntion_mask, inpu
+00009140: 7473 5f65 6d62 6564 732e 6474 7970 652c  ts_embeds.dtype,
+00009150: 2074 6774 5f6c 656e 3d69 6e70 7574 5f73   tgt_len=input_s
+00009160: 6861 7065 5b2d 315d 0a20 2020 2020 2020  hape[-1].       
+00009170: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00009180: 2320 656d 6265 6420 706f 7369 7469 6f6e  # embed position
+00009190: 730a 2020 2020 2020 2020 706f 7369 7469  s.        positi
+000091a0: 6f6e 7320 3d20 7365 6c66 2e65 6d62 6564  ons = self.embed
+000091b0: 5f70 6f73 6974 696f 6e73 2869 6e70 7574  _positions(input
+000091c0: 5f73 6861 7065 2c20 7061 7374 5f6b 6579  _shape, past_key
+000091d0: 5f76 616c 7565 735f 6c65 6e67 7468 290a  _values_length).
+000091e0: 0a20 2020 2020 2020 2023 2042 6c65 6e64  .        # Blend
+000091f0: 6572 626f 7453 6d61 6c6c 2061 7070 6c69  erbotSmall appli
+00009200: 6573 206c 6179 6572 206e 6f72 6d20 6f6e  es layer norm on
+00009210: 2068 6964 6465 6e5f 7374 6174 6573 0a20   hidden_states. 
+00009220: 2020 2020 2020 2069 6e70 7574 735f 656d         inputs_em
+00009230: 6265 6473 203d 2073 656c 662e 6c61 7965  beds = self.laye
+00009240: 726e 6f72 6d5f 656d 6265 6464 696e 6728  rnorm_embedding(
+00009250: 696e 7075 7473 5f65 6d62 6564 7329 0a20  inputs_embeds). 
+00009260: 2020 2020 2020 2068 6964 6465 6e5f 7374         hidden_st
+00009270: 6174 6573 203d 2069 6e70 7574 735f 656d  ates = inputs_em
+00009280: 6265 6473 202b 2070 6f73 6974 696f 6e73  beds + positions
+00009290: 0a0a 2020 2020 2020 2020 6869 6464 656e  ..        hidden
+000092a0: 5f73 7461 7465 7320 3d20 6f70 732e 6472  _states = ops.dr
+000092b0: 6f70 6f75 7428 6869 6464 656e 5f73 7461  opout(hidden_sta
+000092c0: 7465 732c 2070 3d73 656c 662e 6472 6f70  tes, p=self.drop
+000092d0: 6f75 742c 2074 7261 696e 696e 673d 7365  out, training=se
+000092e0: 6c66 2e74 7261 696e 696e 6729 0a0a 2020  lf.training)..  
+000092f0: 2020 2020 2020 6966 2073 656c 662e 6772        if self.gr
+00009300: 6164 6965 6e74 5f63 6865 636b 706f 696e  adient_checkpoin
+00009310: 7469 6e67 2061 6e64 2073 656c 662e 7472  ting and self.tr
+00009320: 6169 6e69 6e67 3a0a 2020 2020 2020 2020  aining:.        
+00009330: 2020 2020 6966 2075 7365 5f63 6163 6865      if use_cache
+00009340: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00009350: 2020 6c6f 6767 6572 2e77 6172 6e69 6e67    logger.warning
+00009360: 5f6f 6e63 6528 0a20 2020 2020 2020 2020  _once(.         
+00009370: 2020 2020 2020 2020 2020 2022 6075 7365             "`use
+00009380: 5f63 6163 6865 3d54 7275 6560 2069 7320  _cache=True` is 
+00009390: 696e 636f 6d70 6174 6962 6c65 2077 6974  incompatible wit
+000093a0: 6820 6772 6164 6965 6e74 2063 6865 636b  h gradient check
+000093b0: 706f 696e 7469 6e67 2e20 5365 7474 696e  pointing. Settin
+000093c0: 6720 6075 7365 5f63 6163 6865 3d46 616c  g `use_cache=Fal
+000093d0: 7365 602e 2e2e 220a 2020 2020 2020 2020  se`...".        
+000093e0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000093f0: 2020 2020 2020 2020 2020 7573 655f 6361            use_ca
+00009400: 6368 6520 3d20 4661 6c73 650a 0a20 2020  che = False..   
+00009410: 2020 2020 2023 2064 6563 6f64 6572 206c       # decoder l
+00009420: 6179 6572 730a 2020 2020 2020 2020 616c  ayers.        al
+00009430: 6c5f 6869 6464 656e 5f73 7461 7465 7320  l_hidden_states 
+00009440: 3d20 2829 2069 6620 6f75 7470 7574 5f68  = () if output_h
+00009450: 6964 6465 6e5f 7374 6174 6573 2065 6c73  idden_states els
+00009460: 6520 4e6f 6e65 0a20 2020 2020 2020 2061  e None.        a
+00009470: 6c6c 5f73 656c 665f 6174 746e 7320 3d20  ll_self_attns = 
+00009480: 2829 2069 6620 6f75 7470 7574 5f61 7474  () if output_att
+00009490: 656e 7469 6f6e 7320 656c 7365 204e 6f6e  entions else Non
+000094a0: 650a 2020 2020 2020 2020 616c 6c5f 6372  e.        all_cr
+000094b0: 6f73 735f 6174 7465 6e74 696f 6e73 203d  oss_attentions =
+000094c0: 2028 2920 6966 2028 6f75 7470 7574 5f61   () if (output_a
+000094d0: 7474 656e 7469 6f6e 7320 616e 6420 656e  ttentions and en
+000094e0: 636f 6465 725f 6869 6464 656e 5f73 7461  coder_hidden_sta
+000094f0: 7465 7320 6973 206e 6f74 204e 6f6e 6529  tes is not None)
+00009500: 2065 6c73 6520 4e6f 6e65 0a20 2020 2020   else None.     
+00009510: 2020 206e 6578 745f 6465 636f 6465 725f     next_decoder_
+00009520: 6361 6368 6520 3d20 2829 2069 6620 7573  cache = () if us
+00009530: 655f 6361 6368 6520 656c 7365 204e 6f6e  e_cache else Non
+00009540: 650a 0a20 2020 2020 2020 2023 2063 6865  e..        # che
+00009550: 636b 2069 6620 6865 6164 5f6d 6173 6b2f  ck if head_mask/
+00009560: 6372 6f73 735f 6174 746e 5f68 6561 645f  cross_attn_head_
+00009570: 6d61 736b 2068 6173 2061 2063 6f72 7265  mask has a corre
+00009580: 6374 206e 756d 6265 7220 6f66 206c 6179  ct number of lay
+00009590: 6572 7320 7370 6563 6966 6965 6420 6966  ers specified if
+000095a0: 2064 6573 6972 6564 0a20 2020 2020 2020   desired.       
+000095b0: 2066 6f72 2061 7474 6e5f 6d61 736b 2c20   for attn_mask, 
+000095c0: 6d61 736b 5f6e 616d 6520 696e 207a 6970  mask_name in zip
+000095d0: 285b 6865 6164 5f6d 6173 6b2c 2063 726f  ([head_mask, cro
+000095e0: 7373 5f61 7474 6e5f 6865 6164 5f6d 6173  ss_attn_head_mas
+000095f0: 6b5d 2c20 5b22 6865 6164 5f6d 6173 6b22  k], ["head_mask"
+00009600: 2c20 2263 726f 7373 5f61 7474 6e5f 6865  , "cross_attn_he
+00009610: 6164 5f6d 6173 6b22 5d29 3a0a 2020 2020  ad_mask"]):.    
+00009620: 2020 2020 2020 2020 6966 2061 7474 6e5f          if attn_
+00009630: 6d61 736b 2069 7320 6e6f 7420 4e6f 6e65  mask is not None
+00009640: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00009650: 2020 6966 2061 7474 6e5f 6d61 736b 2e73    if attn_mask.s
+00009660: 6861 7065 5b30 5d20 213d 206c 656e 2873  hape[0] != len(s
+00009670: 656c 662e 6c61 7965 7273 293a 0a20 2020  elf.layers):.   
+00009680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009690: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+000096a0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+000096b0: 2020 2020 2020 2020 2020 2066 2254 6865             f"The
+000096c0: 2060 7b6d 6173 6b5f 6e61 6d65 7d60 2073   `{mask_name}` s
+000096d0: 686f 756c 6420 6265 2073 7065 6369 6669  hould be specifi
+000096e0: 6564 2066 6f72 207b 6c65 6e28 7365 6c66  ed for {len(self
+000096f0: 2e6c 6179 6572 7329 7d20 6c61 7965 7273  .layers)} layers
+00009700: 2c20 6275 7420 6974 2069 7320 666f 7222  , but it is for"
+00009710: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009720: 2020 2020 2020 2020 2066 2220 7b68 6561           f" {hea
+00009730: 645f 6d61 736b 2e73 6861 7065 5b30 5d7d  d_mask.shape[0]}
+00009740: 2e22 0a20 2020 2020 2020 2020 2020 2020  .".             
+00009750: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00009760: 2066 6f72 2069 6478 2c20 6465 636f 6465   for idx, decode
+00009770: 725f 6c61 7965 7220 696e 2065 6e75 6d65  r_layer in enume
+00009780: 7261 7465 2873 656c 662e 6c61 7965 7273  rate(self.layers
+00009790: 293a 0a20 2020 2020 2020 2020 2020 2023  ):.            #
+000097a0: 2061 6464 204c 6179 6572 4472 6f70 2028   add LayerDrop (
+000097b0: 7365 6520 6874 7470 733a 2f2f 6172 7869  see https://arxi
+000097c0: 762e 6f72 672f 6162 732f 3139 3039 2e31  v.org/abs/1909.1
+000097d0: 3135 3536 2066 6f72 2064 6573 6372 6970  1556 for descrip
+000097e0: 7469 6f6e 290a 2020 2020 2020 2020 2020  tion).          
+000097f0: 2020 6966 206f 7574 7075 745f 6869 6464    if output_hidd
+00009800: 656e 5f73 7461 7465 733a 0a20 2020 2020  en_states:.     
+00009810: 2020 2020 2020 2020 2020 2061 6c6c 5f68             all_h
+00009820: 6964 6465 6e5f 7374 6174 6573 202b 3d20  idden_states += 
+00009830: 2868 6964 6465 6e5f 7374 6174 6573 2c29  (hidden_states,)
+00009840: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00009850: 7365 6c66 2e74 7261 696e 696e 673a 0a20  self.training:. 
+00009860: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00009870: 726f 706f 7574 5f70 726f 6261 6269 6c69  ropout_probabili
+00009880: 7479 203d 206f 7073 2e72 616e 6428 5b5d  ty = ops.rand([]
+00009890: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000098a0: 2020 6966 2064 726f 706f 7574 5f70 726f    if dropout_pro
+000098b0: 6261 6269 6c69 7479 203c 2073 656c 662e  bability < self.
+000098c0: 6c61 7965 7264 726f 703a 0a20 2020 2020  layerdrop:.     
+000098d0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000098e0: 6f6e 7469 6e75 650a 0a20 2020 2020 2020  ontinue..       
+000098f0: 2020 2020 2070 6173 745f 6b65 795f 7661       past_key_va
+00009900: 6c75 6520 3d20 7061 7374 5f6b 6579 5f76  lue = past_key_v
+00009910: 616c 7565 735b 6964 785d 2069 6620 7061  alues[idx] if pa
+00009920: 7374 5f6b 6579 5f76 616c 7565 7320 6973  st_key_values is
+00009930: 206e 6f74 204e 6f6e 6520 656c 7365 204e   not None else N
+00009940: 6f6e 650a 0a20 2020 2020 2020 2020 2020  one..           
+00009950: 2069 6620 7365 6c66 2e67 7261 6469 656e   if self.gradien
+00009960: 745f 6368 6563 6b70 6f69 6e74 696e 6720  t_checkpointing 
+00009970: 616e 6420 7365 6c66 2e74 7261 696e 696e  and self.trainin
+00009980: 673a 0a20 2020 2020 2020 2020 2020 2020  g:.             
+00009990: 2020 206c 6179 6572 5f6f 7574 7075 7473     layer_outputs
+000099a0: 203d 2073 656c 662e 5f67 7261 6469 656e   = self._gradien
+000099b0: 745f 6368 6563 6b70 6f69 6e74 696e 675f  t_checkpointing_
+000099c0: 6675 6e63 280a 2020 2020 2020 2020 2020  func(.          
+000099d0: 2020 2020 2020 2020 2020 6465 636f 6465            decode
+000099e0: 725f 6c61 7965 722e 5f5f 6361 6c6c 5f5f  r_layer.__call__
+000099f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00009a00: 2020 2020 2020 6869 6464 656e 5f73 7461        hidden_sta
+00009a10: 7465 732c 0a20 2020 2020 2020 2020 2020  tes,.           
+00009a20: 2020 2020 2020 2020 2061 7474 656e 7469           attenti
+00009a30: 6f6e 5f6d 6173 6b2c 0a20 2020 2020 2020  on_mask,.       
+00009a40: 2020 2020 2020 2020 2020 2020 2065 6e63               enc
+00009a50: 6f64 6572 5f68 6964 6465 6e5f 7374 6174  oder_hidden_stat
+00009a60: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+00009a70: 2020 2020 2020 2020 656e 636f 6465 725f          encoder_
+00009a80: 6174 7465 6e74 696f 6e5f 6d61 736b 2c0a  attention_mask,.
+00009a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009aa0: 2020 2020 6865 6164 5f6d 6173 6b5b 6964      head_mask[id
+00009ab0: 785d 2069 6620 6865 6164 5f6d 6173 6b20  x] if head_mask 
+00009ac0: 6973 206e 6f74 204e 6f6e 6520 656c 7365  is not None else
+00009ad0: 204e 6f6e 652c 0a20 2020 2020 2020 2020   None,.         
+00009ae0: 2020 2020 2020 2020 2020 2063 726f 7373             cross
+00009af0: 5f61 7474 6e5f 6865 6164 5f6d 6173 6b5b  _attn_head_mask[
+00009b00: 6964 785d 2069 6620 6372 6f73 735f 6174  idx] if cross_at
+00009b10: 746e 5f68 6561 645f 6d61 736b 2069 7320  tn_head_mask is 
+00009b20: 6e6f 7420 4e6f 6e65 2065 6c73 6520 4e6f  not None else No
+00009b30: 6e65 2c0a 2020 2020 2020 2020 2020 2020  ne,.            
+00009b40: 2020 2020 2020 2020 4e6f 6e65 2c0a 2020          None,.  
+00009b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009b60: 2020 6f75 7470 7574 5f61 7474 656e 7469    output_attenti
+00009b70: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
+00009b80: 2020 2020 2020 2020 2075 7365 5f63 6163           use_cac
+00009b90: 6865 2c0a 2020 2020 2020 2020 2020 2020  he,.            
+00009ba0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00009bb0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00009bc0: 2020 2020 2020 2020 6c61 7965 725f 6f75          layer_ou
+00009bd0: 7470 7574 7320 3d20 6465 636f 6465 725f  tputs = decoder_
+00009be0: 6c61 7965 7228 0a20 2020 2020 2020 2020  layer(.         
+00009bf0: 2020 2020 2020 2020 2020 2068 6964 6465             hidde
+00009c00: 6e5f 7374 6174 6573 2c0a 2020 2020 2020  n_states,.      
+00009c10: 2020 2020 2020 2020 2020 2020 2020 6174                at
+00009c20: 7465 6e74 696f 6e5f 6d61 736b 3d61 7474  tention_mask=att
+00009c30: 656e 7469 6f6e 5f6d 6173 6b2c 0a20 2020  ention_mask,.   
+00009c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009c50: 2065 6e63 6f64 6572 5f68 6964 6465 6e5f   encoder_hidden_
+00009c60: 7374 6174 6573 3d65 6e63 6f64 6572 5f68  states=encoder_h
+00009c70: 6964 6465 6e5f 7374 6174 6573 2c0a 2020  idden_states,.  
+00009c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009c90: 2020 656e 636f 6465 725f 6174 7465 6e74    encoder_attent
+00009ca0: 696f 6e5f 6d61 736b 3d65 6e63 6f64 6572  ion_mask=encoder
+00009cb0: 5f61 7474 656e 7469 6f6e 5f6d 6173 6b2c  _attention_mask,
+00009cc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009cd0: 2020 2020 206c 6179 6572 5f68 6561 645f       layer_head_
+00009ce0: 6d61 736b 3d28 6865 6164 5f6d 6173 6b5b  mask=(head_mask[
+00009cf0: 6964 785d 2069 6620 6865 6164 5f6d 6173  idx] if head_mas
+00009d00: 6b20 6973 206e 6f74 204e 6f6e 6520 656c  k is not None el
+00009d10: 7365 204e 6f6e 6529 2c0a 2020 2020 2020  se None),.      
+00009d20: 2020 2020 2020 2020 2020 2020 2020 6372                cr
+00009d30: 6f73 735f 6174 746e 5f6c 6179 6572 5f68  oss_attn_layer_h
+00009d40: 6561 645f 6d61 736b 3d28 0a20 2020 2020  ead_mask=(.     
+00009d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009d60: 2020 2063 726f 7373 5f61 7474 6e5f 6865     cross_attn_he
+00009d70: 6164 5f6d 6173 6b5b 6964 785d 2069 6620  ad_mask[idx] if 
+00009d80: 6372 6f73 735f 6174 746e 5f68 6561 645f  cross_attn_head_
+00009d90: 6d61 736b 2069 7320 6e6f 7420 4e6f 6e65  mask is not None
+00009da0: 2065 6c73 6520 4e6f 6e65 0a20 2020 2020   else None.     
+00009db0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00009dc0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00009dd0: 2020 2020 2020 7061 7374 5f6b 6579 5f76        past_key_v
+00009de0: 616c 7565 3d70 6173 745f 6b65 795f 7661  alue=past_key_va
+00009df0: 6c75 652c 0a20 2020 2020 2020 2020 2020  lue,.           
+00009e00: 2020 2020 2020 2020 206f 7574 7075 745f           output_
+00009e10: 6174 7465 6e74 696f 6e73 3d6f 7574 7075  attentions=outpu
+00009e20: 745f 6174 7465 6e74 696f 6e73 2c0a 2020  t_attentions,.  
+00009e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009e40: 2020 7573 655f 6361 6368 653d 7573 655f    use_cache=use_
+00009e50: 6361 6368 652c 0a20 2020 2020 2020 2020  cache,.         
+00009e60: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00009e70: 2020 2020 2068 6964 6465 6e5f 7374 6174       hidden_stat
+00009e80: 6573 203d 206c 6179 6572 5f6f 7574 7075  es = layer_outpu
+00009e90: 7473 5b30 5d0a 0a20 2020 2020 2020 2020  ts[0]..         
+00009ea0: 2020 2069 6620 7573 655f 6361 6368 653a     if use_cache:
+00009eb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009ec0: 206e 6578 745f 6465 636f 6465 725f 6361   next_decoder_ca
+00009ed0: 6368 6520 2b3d 2028 6c61 7965 725f 6f75  che += (layer_ou
+00009ee0: 7470 7574 735b 3320 6966 206f 7574 7075  tputs[3 if outpu
+00009ef0: 745f 6174 7465 6e74 696f 6e73 2065 6c73  t_attentions els
+00009f00: 6520 315d 2c29 0a0a 2020 2020 2020 2020  e 1],)..        
+00009f10: 2020 2020 6966 206f 7574 7075 745f 6174      if output_at
+00009f20: 7465 6e74 696f 6e73 3a0a 2020 2020 2020  tentions:.      
+00009f30: 2020 2020 2020 2020 2020 616c 6c5f 7365            all_se
+00009f40: 6c66 5f61 7474 6e73 202b 3d20 286c 6179  lf_attns += (lay
+00009f50: 6572 5f6f 7574 7075 7473 5b31 5d2c 290a  er_outputs[1],).
+00009f60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009f70: 2069 6620 656e 636f 6465 725f 6869 6464   if encoder_hidd
+00009f80: 656e 5f73 7461 7465 7320 6973 206e 6f74  en_states is not
+00009f90: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00009fa0: 2020 2020 2020 2020 2020 2061 6c6c 5f63             all_c
+00009fb0: 726f 7373 5f61 7474 656e 7469 6f6e 7320  ross_attentions 
+00009fc0: 2b3d 2028 6c61 7965 725f 6f75 7470 7574  += (layer_output
+00009fd0: 735b 325d 2c29 0a0a 2020 2020 2020 2020  s[2],)..        
+00009fe0: 2320 6164 6420 6869 6464 656e 2073 7461  # add hidden sta
+00009ff0: 7465 7320 6672 6f6d 2074 6865 206c 6173  tes from the las
+0000a000: 7420 6465 636f 6465 7220 6c61 7965 720a  t decoder layer.
+0000a010: 2020 2020 2020 2020 6966 206f 7574 7075          if outpu
+0000a020: 745f 6869 6464 656e 5f73 7461 7465 733a  t_hidden_states:
+0000a030: 0a20 2020 2020 2020 2020 2020 2061 6c6c  .            all
+0000a040: 5f68 6964 6465 6e5f 7374 6174 6573 202b  _hidden_states +
+0000a050: 3d20 2868 6964 6465 6e5f 7374 6174 6573  = (hidden_states
+0000a060: 2c29 0a0a 2020 2020 2020 2020 6e65 7874  ,)..        next
+0000a070: 5f63 6163 6865 203d 206e 6578 745f 6465  _cache = next_de
+0000a080: 636f 6465 725f 6361 6368 6520 6966 2075  coder_cache if u
+0000a090: 7365 5f63 6163 6865 2065 6c73 6520 4e6f  se_cache else No
+0000a0a0: 6e65 0a20 2020 2020 2020 2069 6620 6e6f  ne.        if no
+0000a0b0: 7420 7265 7475 726e 5f64 6963 743a 0a20  t return_dict:. 
+0000a0c0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000a0d0: 6e20 7475 706c 6528 0a20 2020 2020 2020  n tuple(.       
+0000a0e0: 2020 2020 2020 2020 2076 0a20 2020 2020           v.     
+0000a0f0: 2020 2020 2020 2020 2020 2066 6f72 2076             for v
+0000a100: 2069 6e20 5b68 6964 6465 6e5f 7374 6174   in [hidden_stat
+0000a110: 6573 2c20 6e65 7874 5f63 6163 6865 2c20  es, next_cache, 
+0000a120: 616c 6c5f 6869 6464 656e 5f73 7461 7465  all_hidden_state
+0000a130: 732c 2061 6c6c 5f73 656c 665f 6174 746e  s, all_self_attn
+0000a140: 732c 2061 6c6c 5f63 726f 7373 5f61 7474  s, all_cross_att
+0000a150: 656e 7469 6f6e 735d 0a20 2020 2020 2020  entions].       
+0000a160: 2020 2020 2020 2020 2069 6620 7620 6973           if v is
+0000a170: 206e 6f74 204e 6f6e 650a 2020 2020 2020   not None.      
+0000a180: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0000a190: 7265 7475 726e 2042 6173 654d 6f64 656c  return BaseModel
+0000a1a0: 4f75 7470 7574 5769 7468 5061 7374 416e  OutputWithPastAn
+0000a1b0: 6443 726f 7373 4174 7465 6e74 696f 6e73  dCrossAttentions
+0000a1c0: 280a 2020 2020 2020 2020 2020 2020 6c61  (.            la
+0000a1d0: 7374 5f68 6964 6465 6e5f 7374 6174 653d  st_hidden_state=
+0000a1e0: 6869 6464 656e 5f73 7461 7465 732c 0a20  hidden_states,. 
+0000a1f0: 2020 2020 2020 2020 2020 2070 6173 745f             past_
+0000a200: 6b65 795f 7661 6c75 6573 3d6e 6578 745f  key_values=next_
+0000a210: 6361 6368 652c 0a20 2020 2020 2020 2020  cache,.         
+0000a220: 2020 2068 6964 6465 6e5f 7374 6174 6573     hidden_states
+0000a230: 3d61 6c6c 5f68 6964 6465 6e5f 7374 6174  =all_hidden_stat
+0000a240: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+0000a250: 6174 7465 6e74 696f 6e73 3d61 6c6c 5f73  attentions=all_s
+0000a260: 656c 665f 6174 746e 732c 0a20 2020 2020  elf_attns,.     
+0000a270: 2020 2020 2020 2063 726f 7373 5f61 7474         cross_att
+0000a280: 656e 7469 6f6e 733d 616c 6c5f 6372 6f73  entions=all_cros
+0000a290: 735f 6174 7465 6e74 696f 6e73 2c0a 2020  s_attentions,.  
+0000a2a0: 2020 2020 2020 290a 0a0a 636c 6173 7320        )...class 
+0000a2b0: 426c 656e 6465 7262 6f74 536d 616c 6c4d  BlenderbotSmallM
+0000a2c0: 6f64 656c 2842 6c65 6e64 6572 626f 7453  odel(BlenderbotS
+0000a2d0: 6d61 6c6c 5072 6554 7261 696e 6564 4d6f  mallPreTrainedMo
+0000a2e0: 6465 6c29 3a0a 2020 2020 5f74 6965 645f  del):.    _tied_
+0000a2f0: 7765 6967 6874 735f 6b65 7973 203d 205b  weights_keys = [
+0000a300: 2264 6563 6f64 6572 2e65 6d62 6564 5f74  "decoder.embed_t
+0000a310: 6f6b 656e 732e 7765 6967 6874 222c 2022  okens.weight", "
+0000a320: 656e 636f 6465 722e 656d 6265 645f 746f  encoder.embed_to
+0000a330: 6b65 6e73 2e77 6569 6768 7422 5d0a 0a20  kens.weight"].. 
+0000a340: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
+0000a350: 7365 6c66 2c20 636f 6e66 6967 3a20 426c  self, config: Bl
+0000a360: 656e 6465 7262 6f74 536d 616c 6c43 6f6e  enderbotSmallCon
+0000a370: 6669 6729 3a0a 2020 2020 2020 2020 7375  fig):.        su
+0000a380: 7065 7228 292e 5f5f 696e 6974 5f5f 2863  per().__init__(c
+0000a390: 6f6e 6669 6729 0a0a 2020 2020 2020 2020  onfig)..        
+0000a3a0: 7061 6464 696e 675f 6964 782c 2076 6f63  padding_idx, voc
+0000a3b0: 6162 5f73 697a 6520 3d20 636f 6e66 6967  ab_size = config
+0000a3c0: 2e70 6164 5f74 6f6b 656e 5f69 642c 2063  .pad_token_id, c
+0000a3d0: 6f6e 6669 672e 766f 6361 625f 7369 7a65  onfig.vocab_size
+0000a3e0: 0a20 2020 2020 2020 2073 656c 662e 7368  .        self.sh
+0000a3f0: 6172 6564 203d 206e 6e2e 456d 6265 6464  ared = nn.Embedd
+0000a400: 696e 6728 766f 6361 625f 7369 7a65 2c20  ing(vocab_size, 
+0000a410: 636f 6e66 6967 2e64 5f6d 6f64 656c 2c20  config.d_model, 
+0000a420: 7061 6464 696e 675f 6964 7829 0a0a 2020  padding_idx)..  
+0000a430: 2020 2020 2020 7365 6c66 2e65 6e63 6f64        self.encod
+0000a440: 6572 203d 2042 6c65 6e64 6572 626f 7453  er = BlenderbotS
+0000a450: 6d61 6c6c 456e 636f 6465 7228 636f 6e66  mallEncoder(conf
+0000a460: 6967 2c20 7365 6c66 2e73 6861 7265 6429  ig, self.shared)
+0000a470: 0a20 2020 2020 2020 2073 656c 662e 6465  .        self.de
+0000a480: 636f 6465 7220 3d20 426c 656e 6465 7262  coder = Blenderb
+0000a490: 6f74 536d 616c 6c44 6563 6f64 6572 2863  otSmallDecoder(c
+0000a4a0: 6f6e 6669 672c 2073 656c 662e 7368 6172  onfig, self.shar
+0000a4b0: 6564 290a 0a20 2020 2020 2020 2023 2049  ed)..        # I
+0000a4c0: 6e69 7469 616c 697a 6520 7765 6967 6874  nitialize weight
+0000a4d0: 7320 616e 6420 6170 706c 7920 6669 6e61  s and apply fina
+0000a4e0: 6c20 7072 6f63 6573 7369 6e67 0a20 2020  l processing.   
+0000a4f0: 2020 2020 2073 656c 662e 706f 7374 5f69       self.post_i
+0000a500: 6e69 7428 290a 0a20 2020 2064 6566 2067  nit()..    def g
+0000a510: 6574 5f69 6e70 7574 5f65 6d62 6564 6469  et_input_embeddi
+0000a520: 6e67 7328 7365 6c66 293a 0a20 2020 2020  ngs(self):.     
+0000a530: 2020 2072 6574 7572 6e20 7365 6c66 2e73     return self.s
+0000a540: 6861 7265 640a 0a20 2020 2064 6566 2073  hared..    def s
+0000a550: 6574 5f69 6e70 7574 5f65 6d62 6564 6469  et_input_embeddi
+0000a560: 6e67 7328 7365 6c66 2c20 7661 6c75 6529  ngs(self, value)
+0000a570: 3a0a 2020 2020 2020 2020 7365 6c66 2e73  :.        self.s
+0000a580: 6861 7265 6420 3d20 7661 6c75 650a 2020  hared = value.  
+0000a590: 2020 2020 2020 7365 6c66 2e65 6e63 6f64        self.encod
+0000a5a0: 6572 2e65 6d62 6564 5f74 6f6b 656e 7320  er.embed_tokens 
+0000a5b0: 3d20 7365 6c66 2e73 6861 7265 640a 2020  = self.shared.  
+0000a5c0: 2020 2020 2020 7365 6c66 2e64 6563 6f64        self.decod
+0000a5d0: 6572 2e65 6d62 6564 5f74 6f6b 656e 7320  er.embed_tokens 
+0000a5e0: 3d20 7365 6c66 2e73 6861 7265 640a 0a20  = self.shared.. 
+0000a5f0: 2020 2064 6566 2067 6574 5f65 6e63 6f64     def get_encod
+0000a600: 6572 2873 656c 6629 3a0a 2020 2020 2020  er(self):.      
+0000a610: 2020 7265 7475 726e 2073 656c 662e 656e    return self.en
+0000a620: 636f 6465 720a 0a20 2020 2064 6566 2067  coder..    def g
+0000a630: 6574 5f64 6563 6f64 6572 2873 656c 6629  et_decoder(self)
+0000a640: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0000a650: 2073 656c 662e 6465 636f 6465 720a 0a20   self.decoder.. 
+0000a660: 2020 2064 6566 2063 6f6e 7374 7275 6374     def construct
+0000a670: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+0000a680: 2020 2020 2020 2020 696e 7075 745f 6964          input_id
+0000a690: 733a 204f 7074 696f 6e61 6c5b 6d69 6e64  s: Optional[mind
+0000a6a0: 7370 6f72 652e 5465 6e73 6f72 5d20 3d20  spore.Tensor] = 
+0000a6b0: 4e6f 6e65 2c0a 2020 2020 2020 2020 6174  None,.        at
+0000a6c0: 7465 6e74 696f 6e5f 6d61 736b 3a20 4f70  tention_mask: Op
+0000a6d0: 7469 6f6e 616c 5b6d 696e 6473 706f 7265  tional[mindspore
+0000a6e0: 2e54 656e 736f 725d 203d 204e 6f6e 652c  .Tensor] = None,
+0000a6f0: 0a20 2020 2020 2020 2064 6563 6f64 6572  .        decoder
+0000a700: 5f69 6e70 7574 5f69 6473 3a20 4f70 7469  _input_ids: Opti
+0000a710: 6f6e 616c 5b6d 696e 6473 706f 7265 2e54  onal[mindspore.T
+0000a720: 656e 736f 725d 203d 204e 6f6e 652c 0a20  ensor] = None,. 
+0000a730: 2020 2020 2020 2064 6563 6f64 6572 5f61         decoder_a
+0000a740: 7474 656e 7469 6f6e 5f6d 6173 6b3a 204f  ttention_mask: O
+0000a750: 7074 696f 6e61 6c5b 6d69 6e64 7370 6f72  ptional[mindspor
+0000a760: 652e 5465 6e73 6f72 5d20 3d20 4e6f 6e65  e.Tensor] = None
+0000a770: 2c0a 2020 2020 2020 2020 6865 6164 5f6d  ,.        head_m
+0000a780: 6173 6b3a 204f 7074 696f 6e61 6c5b 6d69  ask: Optional[mi
+0000a790: 6e64 7370 6f72 652e 5465 6e73 6f72 5d20  ndspore.Tensor] 
+0000a7a0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+0000a7b0: 6465 636f 6465 725f 6865 6164 5f6d 6173  decoder_head_mas
+0000a7c0: 6b3a 204f 7074 696f 6e61 6c5b 6d69 6e64  k: Optional[mind
+0000a7d0: 7370 6f72 652e 5465 6e73 6f72 5d20 3d20  spore.Tensor] = 
+0000a7e0: 4e6f 6e65 2c0a 2020 2020 2020 2020 6372  None,.        cr
+0000a7f0: 6f73 735f 6174 746e 5f68 6561 645f 6d61  oss_attn_head_ma
+0000a800: 736b 3a20 4f70 7469 6f6e 616c 5b6d 696e  sk: Optional[min
+0000a810: 6473 706f 7265 2e54 656e 736f 725d 203d  dspore.Tensor] =
+0000a820: 204e 6f6e 652c 0a20 2020 2020 2020 2065   None,.        e
+0000a830: 6e63 6f64 6572 5f6f 7574 7075 7473 3a20  ncoder_outputs: 
+0000a840: 4f70 7469 6f6e 616c 5b55 6e69 6f6e 5b54  Optional[Union[T
+0000a850: 7570 6c65 2c20 4261 7365 4d6f 6465 6c4f  uple, BaseModelO
+0000a860: 7574 7075 745d 5d20 3d20 4e6f 6e65 2c0a  utput]] = None,.
+0000a870: 2020 2020 2020 2020 7061 7374 5f6b 6579          past_key
+0000a880: 5f76 616c 7565 733a 204f 7074 696f 6e61  _values: Optiona
+0000a890: 6c5b 4c69 7374 5b6d 696e 6473 706f 7265  l[List[mindspore
+0000a8a0: 2e54 656e 736f 725d 5d20 3d20 4e6f 6e65  .Tensor]] = None
+0000a8b0: 2c0a 2020 2020 2020 2020 696e 7075 7473  ,.        inputs
+0000a8c0: 5f65 6d62 6564 733a 204f 7074 696f 6e61  _embeds: Optiona
+0000a8d0: 6c5b 6d69 6e64 7370 6f72 652e 5465 6e73  l[mindspore.Tens
+0000a8e0: 6f72 5d20 3d20 4e6f 6e65 2c0a 2020 2020  or] = None,.    
+0000a8f0: 2020 2020 6465 636f 6465 725f 696e 7075      decoder_inpu
+0000a900: 7473 5f65 6d62 6564 733a 204f 7074 696f  ts_embeds: Optio
+0000a910: 6e61 6c5b 6d69 6e64 7370 6f72 652e 5465  nal[mindspore.Te
+0000a920: 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a 2020  nsor] = None,.  
+0000a930: 2020 2020 2020 7573 655f 6361 6368 653a        use_cache:
+0000a940: 204f 7074 696f 6e61 6c5b 626f 6f6c 5d20   Optional[bool] 
+0000a950: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+0000a960: 6f75 7470 7574 5f61 7474 656e 7469 6f6e  output_attention
+0000a970: 733a 204f 7074 696f 6e61 6c5b 626f 6f6c  s: Optional[bool
+0000a980: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+0000a990: 2020 6f75 7470 7574 5f68 6964 6465 6e5f    output_hidden_
+0000a9a0: 7374 6174 6573 3a20 4f70 7469 6f6e 616c  states: Optional
+0000a9b0: 5b62 6f6f 6c5d 203d 204e 6f6e 652c 0a20  [bool] = None,. 
+0000a9c0: 2020 2020 2020 2072 6574 7572 6e5f 6469         return_di
+0000a9d0: 6374 3a20 4f70 7469 6f6e 616c 5b62 6f6f  ct: Optional[boo
+0000a9e0: 6c5d 203d 204e 6f6e 652c 0a20 2020 2029  l] = None,.    )
+0000a9f0: 202d 3e20 556e 696f 6e5b 5475 706c 655b   -> Union[Tuple[
+0000aa00: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+0000aa10: 5d2c 2053 6571 3253 6571 4d6f 6465 6c4f  ], Seq2SeqModelO
+0000aa20: 7574 7075 745d 3a0a 2020 2020 2020 2020  utput]:.        
+0000aa30: 7222 2222 0a20 2020 2020 2020 2052 6574  r""".        Ret
+0000aa40: 7572 6e73 3a0a 0a20 2020 2020 2020 2045  urns:..        E
+0000aa50: 7861 6d70 6c65 3a0a 0a20 2020 2020 2020  xample:..       
+0000aa60: 2060 6060 7079 7468 6f6e 0a20 2020 2020   ```python.     
+0000aa70: 2020 203e 3e3e 2066 726f 6d20 7472 616e     >>> from tran
+0000aa80: 7366 6f72 6d65 7273 2069 6d70 6f72 7420  sformers import 
+0000aa90: 4175 746f 546f 6b65 6e69 7a65 722c 2042  AutoTokenizer, B
+0000aaa0: 6c65 6e64 6572 626f 7453 6d61 6c6c 4d6f  lenderbotSmallMo
+0000aab0: 6465 6c0a 0a20 2020 2020 2020 203e 3e3e  del..        >>>
+0000aac0: 206d 6f64 656c 203d 2042 6c65 6e64 6572   model = Blender
+0000aad0: 626f 7453 6d61 6c6c 4d6f 6465 6c2e 6672  botSmallModel.fr
+0000aae0: 6f6d 5f70 7265 7472 6169 6e65 6428 2266  om_pretrained("f
+0000aaf0: 6163 6562 6f6f 6b2f 626c 656e 6465 7262  acebook/blenderb
+0000ab00: 6f74 5f73 6d61 6c6c 2d39 304d 2229 0a20  ot_small-90M"). 
+0000ab10: 2020 2020 2020 203e 3e3e 2074 6f6b 656e         >>> token
+0000ab20: 697a 6572 203d 2041 7574 6f54 6f6b 656e  izer = AutoToken
+0000ab30: 697a 6572 2e66 726f 6d5f 7072 6574 7261  izer.from_pretra
+0000ab40: 696e 6564 2822 6661 6365 626f 6f6b 2f62  ined("facebook/b
+0000ab50: 6c65 6e64 6572 626f 745f 736d 616c 6c2d  lenderbot_small-
+0000ab60: 3930 4d22 290a 0a20 2020 2020 2020 203e  90M")..        >
+0000ab70: 3e3e 2069 6e70 7574 7320 3d20 746f 6b65  >> inputs = toke
+0000ab80: 6e69 7a65 7228 2253 7475 6469 6573 2068  nizer("Studies h
+0000ab90: 6176 6520 6265 656e 2073 686f 776e 2074  ave been shown t
+0000aba0: 6861 7420 6f77 6e69 6e67 2061 2064 6f67  hat owning a dog
+0000abb0: 2069 7320 676f 6f64 2066 6f72 2079 6f75   is good for you
+0000abc0: 222c 2072 6574 7572 6e5f 7465 6e73 6f72  ", return_tensor
+0000abd0: 733d 2270 7422 290a 2020 2020 2020 2020  s="pt").        
+0000abe0: 3e3e 3e20 6465 636f 6465 725f 696e 7075  >>> decoder_inpu
+0000abf0: 7473 203d 2074 6f6b 656e 697a 6572 2822  ts = tokenizer("
+0000ac00: 5374 7564 6965 7320 7368 6f77 2074 6861  Studies show tha
+0000ac10: 7422 2c20 7265 7475 726e 5f74 656e 736f  t", return_tenso
+0000ac20: 7273 3d22 7074 2229 2020 2320 4261 7463  rs="pt")  # Batc
+0000ac30: 6820 7369 7a65 2031 0a20 2020 2020 2020  h size 1.       
+0000ac40: 203e 3e3e 206f 7574 7075 7473 203d 206d   >>> outputs = m
+0000ac50: 6f64 656c 2869 6e70 7574 5f69 6473 3d69  odel(input_ids=i
+0000ac60: 6e70 7574 732e 696e 7075 745f 6964 732c  nputs.input_ids,
+0000ac70: 2064 6563 6f64 6572 5f69 6e70 7574 5f69   decoder_input_i
+0000ac80: 6473 3d64 6563 6f64 6572 5f69 6e70 7574  ds=decoder_input
+0000ac90: 732e 696e 7075 745f 6964 7329 0a0a 2020  s.input_ids)..  
+0000aca0: 2020 2020 2020 3e3e 3e20 6c61 7374 5f68        >>> last_h
+0000acb0: 6964 6465 6e5f 7374 6174 6573 203d 206f  idden_states = o
+0000acc0: 7574 7075 7473 2e6c 6173 745f 6869 6464  utputs.last_hidd
+0000acd0: 656e 5f73 7461 7465 0a20 2020 2020 2020  en_state.       
+0000ace0: 203e 3e3e 206c 6973 7428 6c61 7374 5f68   >>> list(last_h
+0000acf0: 6964 6465 6e5f 7374 6174 6573 2e73 6861  idden_states.sha
+0000ad00: 7065 290a 2020 2020 2020 2020 5b31 2c20  pe).        [1, 
+0000ad10: 332c 2035 3132 5d0a 2020 2020 2020 2020  3, 512].        
+0000ad20: 6060 6022 2222 0a20 2020 2020 2020 206f  ```""".        o
+0000ad30: 7574 7075 745f 6174 7465 6e74 696f 6e73  utput_attentions
+0000ad40: 203d 206f 7574 7075 745f 6174 7465 6e74   = output_attent
+0000ad50: 696f 6e73 2069 6620 6f75 7470 7574 5f61  ions if output_a
+0000ad60: 7474 656e 7469 6f6e 7320 6973 206e 6f74  ttentions is not
+0000ad70: 204e 6f6e 6520 656c 7365 2073 656c 662e   None else self.
+0000ad80: 636f 6e66 6967 2e6f 7574 7075 745f 6174  config.output_at
+0000ad90: 7465 6e74 696f 6e73 0a20 2020 2020 2020  tentions.       
+0000ada0: 206f 7574 7075 745f 6869 6464 656e 5f73   output_hidden_s
+0000adb0: 7461 7465 7320 3d20 280a 2020 2020 2020  tates = (.      
+0000adc0: 2020 2020 2020 6f75 7470 7574 5f68 6964        output_hid
+0000add0: 6465 6e5f 7374 6174 6573 2069 6620 6f75  den_states if ou
+0000ade0: 7470 7574 5f68 6964 6465 6e5f 7374 6174  tput_hidden_stat
+0000adf0: 6573 2069 7320 6e6f 7420 4e6f 6e65 2065  es is not None e
+0000ae00: 6c73 6520 7365 6c66 2e63 6f6e 6669 672e  lse self.config.
+0000ae10: 6f75 7470 7574 5f68 6964 6465 6e5f 7374  output_hidden_st
+0000ae20: 6174 6573 0a20 2020 2020 2020 2029 0a20  ates.        ). 
+0000ae30: 2020 2020 2020 2075 7365 5f63 6163 6865         use_cache
+0000ae40: 203d 2075 7365 5f63 6163 6865 2069 6620   = use_cache if 
+0000ae50: 7573 655f 6361 6368 6520 6973 206e 6f74  use_cache is not
+0000ae60: 204e 6f6e 6520 656c 7365 2073 656c 662e   None else self.
+0000ae70: 636f 6e66 6967 2e75 7365 5f63 6163 6865  config.use_cache
+0000ae80: 0a20 2020 2020 2020 2072 6574 7572 6e5f  .        return_
+0000ae90: 6469 6374 203d 2072 6574 7572 6e5f 6469  dict = return_di
+0000aea0: 6374 2069 6620 7265 7475 726e 5f64 6963  ct if return_dic
+0000aeb0: 7420 6973 206e 6f74 204e 6f6e 6520 656c  t is not None el
+0000aec0: 7365 2073 656c 662e 636f 6e66 6967 2e75  se self.config.u
+0000aed0: 7365 5f72 6574 7572 6e5f 6469 6374 0a0a  se_return_dict..
+0000aee0: 2020 2020 2020 2020 6966 2065 6e63 6f64          if encod
+0000aef0: 6572 5f6f 7574 7075 7473 2069 7320 4e6f  er_outputs is No
+0000af00: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0000af10: 656e 636f 6465 725f 6f75 7470 7574 7320  encoder_outputs 
+0000af20: 3d20 7365 6c66 2e65 6e63 6f64 6572 280a  = self.encoder(.
+0000af30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000af40: 696e 7075 745f 6964 733d 696e 7075 745f  input_ids=input_
+0000af50: 6964 732c 0a20 2020 2020 2020 2020 2020  ids,.           
+0000af60: 2020 2020 2061 7474 656e 7469 6f6e 5f6d       attention_m
+0000af70: 6173 6b3d 6174 7465 6e74 696f 6e5f 6d61  ask=attention_ma
+0000af80: 736b 2c0a 2020 2020 2020 2020 2020 2020  sk,.            
+0000af90: 2020 2020 6865 6164 5f6d 6173 6b3d 6865      head_mask=he
+0000afa0: 6164 5f6d 6173 6b2c 0a20 2020 2020 2020  ad_mask,.       
+0000afb0: 2020 2020 2020 2020 2069 6e70 7574 735f           inputs_
+0000afc0: 656d 6265 6473 3d69 6e70 7574 735f 656d  embeds=inputs_em
+0000afd0: 6265 6473 2c0a 2020 2020 2020 2020 2020  beds,.          
+0000afe0: 2020 2020 2020 6f75 7470 7574 5f61 7474        output_att
+0000aff0: 656e 7469 6f6e 733d 6f75 7470 7574 5f61  entions=output_a
+0000b000: 7474 656e 7469 6f6e 732c 0a20 2020 2020  ttentions,.     
+0000b010: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
+0000b020: 745f 6869 6464 656e 5f73 7461 7465 733d  t_hidden_states=
+0000b030: 6f75 7470 7574 5f68 6964 6465 6e5f 7374  output_hidden_st
+0000b040: 6174 6573 2c0a 2020 2020 2020 2020 2020  ates,.          
+0000b050: 2020 2020 2020 7265 7475 726e 5f64 6963        return_dic
+0000b060: 743d 7265 7475 726e 5f64 6963 742c 0a20  t=return_dict,. 
+0000b070: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0000b080: 2020 2020 2023 2049 6620 7468 6520 7573       # If the us
+0000b090: 6572 2070 6173 7365 6420 6120 7475 706c  er passed a tupl
+0000b0a0: 6520 666f 7220 656e 636f 6465 725f 6f75  e for encoder_ou
+0000b0b0: 7470 7574 732c 2077 6520 7772 6170 2069  tputs, we wrap i
+0000b0c0: 7420 696e 2061 2042 6173 654d 6f64 656c  t in a BaseModel
+0000b0d0: 4f75 7470 7574 2077 6865 6e20 7265 7475  Output when retu
+0000b0e0: 726e 5f64 6963 743d 5472 7565 0a20 2020  rn_dict=True.   
+0000b0f0: 2020 2020 2065 6c69 6620 7265 7475 726e       elif return
+0000b100: 5f64 6963 7420 616e 6420 6e6f 7420 6973  _dict and not is
+0000b110: 696e 7374 616e 6365 2865 6e63 6f64 6572  instance(encoder
+0000b120: 5f6f 7574 7075 7473 2c20 4261 7365 4d6f  _outputs, BaseMo
+0000b130: 6465 6c4f 7574 7075 7429 3a0a 2020 2020  delOutput):.    
+0000b140: 2020 2020 2020 2020 656e 636f 6465 725f          encoder_
+0000b150: 6f75 7470 7574 7320 3d20 4261 7365 4d6f  outputs = BaseMo
+0000b160: 6465 6c4f 7574 7075 7428 0a20 2020 2020  delOutput(.     
+0000b170: 2020 2020 2020 2020 2020 206c 6173 745f             last_
+0000b180: 6869 6464 656e 5f73 7461 7465 3d65 6e63  hidden_state=enc
+0000b190: 6f64 6572 5f6f 7574 7075 7473 5b30 5d2c  oder_outputs[0],
+0000b1a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b1b0: 2068 6964 6465 6e5f 7374 6174 6573 3d65   hidden_states=e
+0000b1c0: 6e63 6f64 6572 5f6f 7574 7075 7473 5b31  ncoder_outputs[1
+0000b1d0: 5d20 6966 206c 656e 2865 6e63 6f64 6572  ] if len(encoder
+0000b1e0: 5f6f 7574 7075 7473 2920 3e20 3120 656c  _outputs) > 1 el
+0000b1f0: 7365 204e 6f6e 652c 0a20 2020 2020 2020  se None,.       
+0000b200: 2020 2020 2020 2020 2061 7474 656e 7469           attenti
+0000b210: 6f6e 733d 656e 636f 6465 725f 6f75 7470  ons=encoder_outp
+0000b220: 7574 735b 325d 2069 6620 6c65 6e28 656e  uts[2] if len(en
+0000b230: 636f 6465 725f 6f75 7470 7574 7329 203e  coder_outputs) >
+0000b240: 2032 2065 6c73 6520 4e6f 6e65 2c0a 2020   2 else None,.  
+0000b250: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+0000b260: 2020 2020 2023 2064 6563 6f64 6572 206f       # decoder o
+0000b270: 7574 7075 7473 2063 6f6e 7369 7374 7320  utputs consists 
+0000b280: 6f66 2028 6465 635f 6665 6174 7572 6573  of (dec_features
+0000b290: 2c20 7061 7374 5f6b 6579 5f76 616c 7565  , past_key_value
+0000b2a0: 2c20 6465 635f 6869 6464 656e 2c20 6465  , dec_hidden, de
+0000b2b0: 635f 6174 746e 290a 2020 2020 2020 2020  c_attn).        
+0000b2c0: 6465 636f 6465 725f 6f75 7470 7574 7320  decoder_outputs 
+0000b2d0: 3d20 7365 6c66 2e64 6563 6f64 6572 280a  = self.decoder(.
+0000b2e0: 2020 2020 2020 2020 2020 2020 696e 7075              inpu
+0000b2f0: 745f 6964 733d 6465 636f 6465 725f 696e  t_ids=decoder_in
+0000b300: 7075 745f 6964 732c 0a20 2020 2020 2020  put_ids,.       
+0000b310: 2020 2020 2061 7474 656e 7469 6f6e 5f6d       attention_m
+0000b320: 6173 6b3d 6465 636f 6465 725f 6174 7465  ask=decoder_atte
+0000b330: 6e74 696f 6e5f 6d61 736b 2c0a 2020 2020  ntion_mask,.    
+0000b340: 2020 2020 2020 2020 656e 636f 6465 725f          encoder_
+0000b350: 6869 6464 656e 5f73 7461 7465 733d 656e  hidden_states=en
+0000b360: 636f 6465 725f 6f75 7470 7574 735b 305d  coder_outputs[0]
+0000b370: 2c0a 2020 2020 2020 2020 2020 2020 656e  ,.            en
+0000b380: 636f 6465 725f 6174 7465 6e74 696f 6e5f  coder_attention_
+0000b390: 6d61 736b 3d61 7474 656e 7469 6f6e 5f6d  mask=attention_m
+0000b3a0: 6173 6b2c 0a20 2020 2020 2020 2020 2020  ask,.           
+0000b3b0: 2068 6561 645f 6d61 736b 3d64 6563 6f64   head_mask=decod
+0000b3c0: 6572 5f68 6561 645f 6d61 736b 2c0a 2020  er_head_mask,.  
+0000b3d0: 2020 2020 2020 2020 2020 6372 6f73 735f            cross_
+0000b3e0: 6174 746e 5f68 6561 645f 6d61 736b 3d63  attn_head_mask=c
+0000b3f0: 726f 7373 5f61 7474 6e5f 6865 6164 5f6d  ross_attn_head_m
+0000b400: 6173 6b2c 0a20 2020 2020 2020 2020 2020  ask,.           
+0000b410: 2070 6173 745f 6b65 795f 7661 6c75 6573   past_key_values
+0000b420: 3d70 6173 745f 6b65 795f 7661 6c75 6573  =past_key_values
+0000b430: 2c0a 2020 2020 2020 2020 2020 2020 696e  ,.            in
+0000b440: 7075 7473 5f65 6d62 6564 733d 6465 636f  puts_embeds=deco
+0000b450: 6465 725f 696e 7075 7473 5f65 6d62 6564  der_inputs_embed
+0000b460: 732c 0a20 2020 2020 2020 2020 2020 2075  s,.            u
+0000b470: 7365 5f63 6163 6865 3d75 7365 5f63 6163  se_cache=use_cac
+0000b480: 6865 2c0a 2020 2020 2020 2020 2020 2020  he,.            
+0000b490: 6f75 7470 7574 5f61 7474 656e 7469 6f6e  output_attention
+0000b4a0: 733d 6f75 7470 7574 5f61 7474 656e 7469  s=output_attenti
+0000b4b0: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
+0000b4c0: 206f 7574 7075 745f 6869 6464 656e 5f73   output_hidden_s
+0000b4d0: 7461 7465 733d 6f75 7470 7574 5f68 6964  tates=output_hid
+0000b4e0: 6465 6e5f 7374 6174 6573 2c0a 2020 2020  den_states,.    
+0000b4f0: 2020 2020 2020 2020 7265 7475 726e 5f64          return_d
+0000b500: 6963 743d 7265 7475 726e 5f64 6963 742c  ict=return_dict,
+0000b510: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+0000b520: 2020 2020 6966 206e 6f74 2072 6574 7572      if not retur
+0000b530: 6e5f 6469 6374 3a0a 2020 2020 2020 2020  n_dict:.        
+0000b540: 2020 2020 7265 7475 726e 2064 6563 6f64      return decod
+0000b550: 6572 5f6f 7574 7075 7473 202b 2065 6e63  er_outputs + enc
+0000b560: 6f64 6572 5f6f 7574 7075 7473 0a0a 2020  oder_outputs..  
+0000b570: 2020 2020 2020 7265 7475 726e 2053 6571        return Seq
+0000b580: 3253 6571 4d6f 6465 6c4f 7574 7075 7428  2SeqModelOutput(
+0000b590: 0a20 2020 2020 2020 2020 2020 206c 6173  .            las
+0000b5a0: 745f 6869 6464 656e 5f73 7461 7465 3d64  t_hidden_state=d
+0000b5b0: 6563 6f64 6572 5f6f 7574 7075 7473 2e6c  ecoder_outputs.l
+0000b5c0: 6173 745f 6869 6464 656e 5f73 7461 7465  ast_hidden_state
+0000b5d0: 2c0a 2020 2020 2020 2020 2020 2020 7061  ,.            pa
+0000b5e0: 7374 5f6b 6579 5f76 616c 7565 733d 6465  st_key_values=de
+0000b5f0: 636f 6465 725f 6f75 7470 7574 732e 7061  coder_outputs.pa
+0000b600: 7374 5f6b 6579 5f76 616c 7565 732c 0a20  st_key_values,. 
+0000b610: 2020 2020 2020 2020 2020 2064 6563 6f64             decod
+0000b620: 6572 5f68 6964 6465 6e5f 7374 6174 6573  er_hidden_states
+0000b630: 3d64 6563 6f64 6572 5f6f 7574 7075 7473  =decoder_outputs
+0000b640: 2e68 6964 6465 6e5f 7374 6174 6573 2c0a  .hidden_states,.
+0000b650: 2020 2020 2020 2020 2020 2020 6465 636f              deco
+0000b660: 6465 725f 6174 7465 6e74 696f 6e73 3d64  der_attentions=d
+0000b670: 6563 6f64 6572 5f6f 7574 7075 7473 2e61  ecoder_outputs.a
+0000b680: 7474 656e 7469 6f6e 732c 0a20 2020 2020  ttentions,.     
+0000b690: 2020 2020 2020 2063 726f 7373 5f61 7474         cross_att
+0000b6a0: 656e 7469 6f6e 733d 6465 636f 6465 725f  entions=decoder_
+0000b6b0: 6f75 7470 7574 732e 6372 6f73 735f 6174  outputs.cross_at
+0000b6c0: 7465 6e74 696f 6e73 2c0a 2020 2020 2020  tentions,.      
+0000b6d0: 2020 2020 2020 656e 636f 6465 725f 6c61        encoder_la
+0000b6e0: 7374 5f68 6964 6465 6e5f 7374 6174 653d  st_hidden_state=
+0000b6f0: 656e 636f 6465 725f 6f75 7470 7574 732e  encoder_outputs.
+0000b700: 6c61 7374 5f68 6964 6465 6e5f 7374 6174  last_hidden_stat
+0000b710: 652c 0a20 2020 2020 2020 2020 2020 2065  e,.            e
+0000b720: 6e63 6f64 6572 5f68 6964 6465 6e5f 7374  ncoder_hidden_st
+0000b730: 6174 6573 3d65 6e63 6f64 6572 5f6f 7574  ates=encoder_out
+0000b740: 7075 7473 2e68 6964 6465 6e5f 7374 6174  puts.hidden_stat
+0000b750: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+0000b760: 656e 636f 6465 725f 6174 7465 6e74 696f  encoder_attentio
+0000b770: 6e73 3d65 6e63 6f64 6572 5f6f 7574 7075  ns=encoder_outpu
+0000b780: 7473 2e61 7474 656e 7469 6f6e 732c 0a20  ts.attentions,. 
+0000b790: 2020 2020 2020 2029 0a0a 0a63 6c61 7373         )...class
+0000b7a0: 2042 6c65 6e64 6572 626f 7453 6d61 6c6c   BlenderbotSmall
+0000b7b0: 466f 7243 6f6e 6469 7469 6f6e 616c 4765  ForConditionalGe
+0000b7c0: 6e65 7261 7469 6f6e 2842 6c65 6e64 6572  neration(Blender
+0000b7d0: 626f 7453 6d61 6c6c 5072 6554 7261 696e  botSmallPreTrain
+0000b7e0: 6564 4d6f 6465 6c29 3a0a 2020 2020 6261  edModel):.    ba
+0000b7f0: 7365 5f6d 6f64 656c 5f70 7265 6669 7820  se_model_prefix 
+0000b800: 3d20 226d 6f64 656c 220a 2020 2020 5f6b  = "model".    _k
+0000b810: 6579 735f 746f 5f69 676e 6f72 655f 6f6e  eys_to_ignore_on
+0000b820: 5f6c 6f61 645f 756e 6578 7065 6374 6564  _load_unexpected
+0000b830: 203d 205b 2266 696e 616c 5f6c 6f67 6974   = ["final_logit
+0000b840: 735f 6269 6173 225d 0a20 2020 205f 7469  s_bias"].    _ti
+0000b850: 6564 5f77 6569 6768 7473 5f6b 6579 7320  ed_weights_keys 
+0000b860: 3d20 5b22 6465 636f 6465 722e 656d 6265  = ["decoder.embe
+0000b870: 645f 746f 6b65 6e73 2e77 6569 6768 7422  d_tokens.weight"
+0000b880: 2c20 2265 6e63 6f64 6572 2e65 6d62 6564  , "encoder.embed
+0000b890: 5f74 6f6b 656e 732e 7765 6967 6874 222c  _tokens.weight",
+0000b8a0: 2022 6c6d 5f68 6561 642e 7765 6967 6874   "lm_head.weight
+0000b8b0: 225d 0a0a 2020 2020 6465 6620 5f5f 696e  "]..    def __in
+0000b8c0: 6974 5f5f 2873 656c 662c 2063 6f6e 6669  it__(self, confi
+0000b8d0: 673a 2042 6c65 6e64 6572 626f 7453 6d61  g: BlenderbotSma
+0000b8e0: 6c6c 436f 6e66 6967 293a 0a20 2020 2020  llConfig):.     
+0000b8f0: 2020 2073 7570 6572 2829 2e5f 5f69 6e69     super().__ini
+0000b900: 745f 5f28 636f 6e66 6967 290a 2020 2020  t__(config).    
+0000b910: 2020 2020 7365 6c66 2e6d 6f64 656c 203d      self.model =
+0000b920: 2042 6c65 6e64 6572 626f 7453 6d61 6c6c   BlenderbotSmall
+0000b930: 4d6f 6465 6c28 636f 6e66 6967 290a 2020  Model(config).  
+0000b940: 2020 2020 2020 7365 6c66 2e66 696e 616c        self.final
+0000b950: 5f6c 6f67 6974 735f 6269 6173 203d 206f  _logits_bias = o
+0000b960: 7073 2e7a 6572 6f73 2828 312c 2073 656c  ps.zeros((1, sel
+0000b970: 662e 6d6f 6465 6c2e 7368 6172 6564 2e76  f.model.shared.v
+0000b980: 6f63 6162 5f73 697a 6529 290a 2020 2020  ocab_size)).    
+0000b990: 2020 2020 7365 6c66 2e6c 6d5f 6865 6164      self.lm_head
+0000b9a0: 203d 206e 6e2e 4465 6e73 6528 636f 6e66   = nn.Dense(conf
+0000b9b0: 6967 2e64 5f6d 6f64 656c 2c20 7365 6c66  ig.d_model, self
+0000b9c0: 2e6d 6f64 656c 2e73 6861 7265 642e 766f  .model.shared.vo
+0000b9d0: 6361 625f 7369 7a65 2c20 6861 735f 6269  cab_size, has_bi
+0000b9e0: 6173 3d46 616c 7365 290a 0a20 2020 2020  as=False)..     
+0000b9f0: 2020 2023 2049 6e69 7469 616c 697a 6520     # Initialize 
+0000ba00: 7765 6967 6874 7320 616e 6420 6170 706c  weights and appl
+0000ba10: 7920 6669 6e61 6c20 7072 6f63 6573 7369  y final processi
+0000ba20: 6e67 0a20 2020 2020 2020 2073 656c 662e  ng.        self.
+0000ba30: 706f 7374 5f69 6e69 7428 290a 0a20 2020  post_init()..   
+0000ba40: 2064 6566 2067 6574 5f65 6e63 6f64 6572   def get_encoder
+0000ba50: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0000ba60: 7265 7475 726e 2073 656c 662e 6d6f 6465  return self.mode
+0000ba70: 6c2e 6765 745f 656e 636f 6465 7228 290a  l.get_encoder().
+0000ba80: 0a20 2020 2064 6566 2067 6574 5f64 6563  .    def get_dec
+0000ba90: 6f64 6572 2873 656c 6629 3a0a 2020 2020  oder(self):.    
+0000baa0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+0000bab0: 6d6f 6465 6c2e 6765 745f 6465 636f 6465  model.get_decode
+0000bac0: 7228 290a 0a20 2020 2064 6566 2072 6573  r()..    def res
+0000bad0: 697a 655f 746f 6b65 6e5f 656d 6265 6464  ize_token_embedd
+0000bae0: 696e 6773 2873 656c 662c 206e 6577 5f6e  ings(self, new_n
+0000baf0: 756d 5f74 6f6b 656e 733a 2069 6e74 2c20  um_tokens: int, 
+0000bb00: 7061 645f 746f 5f6d 756c 7469 706c 655f  pad_to_multiple_
+0000bb10: 6f66 3a20 4f70 7469 6f6e 616c 5b69 6e74  of: Optional[int
+0000bb20: 5d20 3d20 4e6f 6e65 2920 2d3e 206e 6e2e  ] = None) -> nn.
+0000bb30: 456d 6265 6464 696e 673a 0a20 2020 2020  Embedding:.     
+0000bb40: 2020 206e 6577 5f65 6d62 6564 6469 6e67     new_embedding
+0000bb50: 7320 3d20 7375 7065 7228 292e 7265 7369  s = super().resi
+0000bb60: 7a65 5f74 6f6b 656e 5f65 6d62 6564 6469  ze_token_embeddi
+0000bb70: 6e67 7328 6e65 775f 6e75 6d5f 746f 6b65  ngs(new_num_toke
+0000bb80: 6e73 2c20 7061 645f 746f 5f6d 756c 7469  ns, pad_to_multi
+0000bb90: 706c 655f 6f66 290a 2020 2020 2020 2020  ple_of).        
+0000bba0: 7365 6c66 2e5f 7265 7369 7a65 5f66 696e  self._resize_fin
+0000bbb0: 616c 5f6c 6f67 6974 735f 6269 6173 286e  al_logits_bias(n
+0000bbc0: 6577 5f65 6d62 6564 6469 6e67 732e 7765  ew_embeddings.we
+0000bbd0: 6967 6874 2e73 6861 7065 5b30 5d29 0a20  ight.shape[0]). 
+0000bbe0: 2020 2020 2020 2072 6574 7572 6e20 6e65         return ne
+0000bbf0: 775f 656d 6265 6464 696e 6773 0a0a 2020  w_embeddings..  
+0000bc00: 2020 6465 6620 5f72 6573 697a 655f 6669    def _resize_fi
+0000bc10: 6e61 6c5f 6c6f 6769 7473 5f62 6961 7328  nal_logits_bias(
+0000bc20: 7365 6c66 2c20 6e65 775f 6e75 6d5f 746f  self, new_num_to
+0000bc30: 6b65 6e73 3a20 696e 7429 202d 3e20 4e6f  kens: int) -> No
+0000bc40: 6e65 3a0a 2020 2020 2020 2020 6f6c 645f  ne:.        old_
+0000bc50: 6e75 6d5f 746f 6b65 6e73 203d 2073 656c  num_tokens = sel
+0000bc60: 662e 6669 6e61 6c5f 6c6f 6769 7473 5f62  f.final_logits_b
+0000bc70: 6961 732e 7368 6170 655b 2d31 5d0a 2020  ias.shape[-1].  
+0000bc80: 2020 2020 2020 6966 206e 6577 5f6e 756d        if new_num
+0000bc90: 5f74 6f6b 656e 7320 3c3d 206f 6c64 5f6e  _tokens <= old_n
+0000bca0: 756d 5f74 6f6b 656e 733a 0a20 2020 2020  um_tokens:.     
+0000bcb0: 2020 2020 2020 206e 6577 5f62 6961 7320         new_bias 
+0000bcc0: 3d20 7365 6c66 2e66 696e 616c 5f6c 6f67  = self.final_log
+0000bcd0: 6974 735f 6269 6173 5b3a 2c20 3a6e 6577  its_bias[:, :new
+0000bce0: 5f6e 756d 5f74 6f6b 656e 735d 0a20 2020  _num_tokens].   
+0000bcf0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0000bd00: 2020 2020 2020 2065 7874 7261 5f62 6961         extra_bia
+0000bd10: 7320 3d20 6f70 732e 7a65 726f 7328 2831  s = ops.zeros((1
+0000bd20: 2c20 6e65 775f 6e75 6d5f 746f 6b65 6e73  , new_num_tokens
+0000bd30: 202d 206f 6c64 5f6e 756d 5f74 6f6b 656e   - old_num_token
+0000bd40: 7329 290a 2020 2020 2020 2020 2020 2020  s)).            
+0000bd50: 6e65 775f 6269 6173 203d 206f 7073 2e63  new_bias = ops.c
+0000bd60: 6174 285b 7365 6c66 2e66 696e 616c 5f6c  at([self.final_l
+0000bd70: 6f67 6974 735f 6269 6173 2c20 6578 7472  ogits_bias, extr
+0000bd80: 615f 6269 6173 5d2c 2061 7869 733d 3129  a_bias], axis=1)
+0000bd90: 0a20 2020 2020 2020 2073 656c 662e 6669  .        self.fi
+0000bda0: 6e61 6c5f 6c6f 6769 7473 5f62 6961 7320  nal_logits_bias 
+0000bdb0: 3d20 6e65 775f 6269 6173 0a0a 2020 2020  = new_bias..    
+0000bdc0: 6465 6620 6765 745f 6f75 7470 7574 5f65  def get_output_e
+0000bdd0: 6d62 6564 6469 6e67 7328 7365 6c66 293a  mbeddings(self):
+0000bde0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000bdf0: 7365 6c66 2e6c 6d5f 6865 6164 0a0a 2020  self.lm_head..  
+0000be00: 2020 6465 6620 7365 745f 6f75 7470 7574    def set_output
+0000be10: 5f65 6d62 6564 6469 6e67 7328 7365 6c66  _embeddings(self
+0000be20: 2c20 6e65 775f 656d 6265 6464 696e 6773  , new_embeddings
+0000be30: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+0000be40: 6c6d 5f68 6561 6420 3d20 6e65 775f 656d  lm_head = new_em
+0000be50: 6265 6464 696e 6773 0a0a 2020 2020 6465  beddings..    de
+0000be60: 6620 636f 6e73 7472 7563 7428 0a20 2020  f construct(.   
+0000be70: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+0000be80: 2020 2069 6e70 7574 5f69 6473 3a20 4f70     input_ids: Op
+0000be90: 7469 6f6e 616c 5b6d 696e 6473 706f 7265  tional[mindspore
+0000bea0: 2e54 656e 736f 725d 203d 204e 6f6e 652c  .Tensor] = None,
+0000beb0: 0a20 2020 2020 2020 2061 7474 656e 7469  .        attenti
+0000bec0: 6f6e 5f6d 6173 6b3a 204f 7074 696f 6e61  on_mask: Optiona
+0000bed0: 6c5b 6d69 6e64 7370 6f72 652e 5465 6e73  l[mindspore.Tens
+0000bee0: 6f72 5d20 3d20 4e6f 6e65 2c0a 2020 2020  or] = None,.    
+0000bef0: 2020 2020 6465 636f 6465 725f 696e 7075      decoder_inpu
+0000bf00: 745f 6964 733a 204f 7074 696f 6e61 6c5b  t_ids: Optional[
+0000bf10: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+0000bf20: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+0000bf30: 2020 6465 636f 6465 725f 6174 7465 6e74    decoder_attent
+0000bf40: 696f 6e5f 6d61 736b 3a20 4f70 7469 6f6e  ion_mask: Option
+0000bf50: 616c 5b6d 696e 6473 706f 7265 2e54 656e  al[mindspore.Ten
+0000bf60: 736f 725d 203d 204e 6f6e 652c 0a20 2020  sor] = None,.   
+0000bf70: 2020 2020 2068 6561 645f 6d61 736b 3a20       head_mask: 
+0000bf80: 4f70 7469 6f6e 616c 5b6d 696e 6473 706f  Optional[mindspo
+0000bf90: 7265 2e54 656e 736f 725d 203d 204e 6f6e  re.Tensor] = Non
+0000bfa0: 652c 0a20 2020 2020 2020 2064 6563 6f64  e,.        decod
+0000bfb0: 6572 5f68 6561 645f 6d61 736b 3a20 4f70  er_head_mask: Op
+0000bfc0: 7469 6f6e 616c 5b6d 696e 6473 706f 7265  tional[mindspore
+0000bfd0: 2e54 656e 736f 725d 203d 204e 6f6e 652c  .Tensor] = None,
+0000bfe0: 0a20 2020 2020 2020 2063 726f 7373 5f61  .        cross_a
+0000bff0: 7474 6e5f 6865 6164 5f6d 6173 6b3a 204f  ttn_head_mask: O
+0000c000: 7074 696f 6e61 6c5b 6d69 6e64 7370 6f72  ptional[mindspor
+0000c010: 652e 5465 6e73 6f72 5d20 3d20 4e6f 6e65  e.Tensor] = None
+0000c020: 2c0a 2020 2020 2020 2020 656e 636f 6465  ,.        encode
+0000c030: 725f 6f75 7470 7574 733a 204f 7074 696f  r_outputs: Optio
+0000c040: 6e61 6c5b 556e 696f 6e5b 5475 706c 652c  nal[Union[Tuple,
+0000c050: 2042 6173 654d 6f64 656c 4f75 7470 7574   BaseModelOutput
+0000c060: 5d5d 203d 204e 6f6e 652c 0a20 2020 2020  ]] = None,.     
+0000c070: 2020 2070 6173 745f 6b65 795f 7661 6c75     past_key_valu
+0000c080: 6573 3a20 4f70 7469 6f6e 616c 5b4c 6973  es: Optional[Lis
+0000c090: 745b 6d69 6e64 7370 6f72 652e 5465 6e73  t[mindspore.Tens
+0000c0a0: 6f72 5d5d 203d 204e 6f6e 652c 0a20 2020  or]] = None,.   
+0000c0b0: 2020 2020 2069 6e70 7574 735f 656d 6265       inputs_embe
+0000c0c0: 6473 3a20 4f70 7469 6f6e 616c 5b6d 696e  ds: Optional[min
+0000c0d0: 6473 706f 7265 2e54 656e 736f 725d 203d  dspore.Tensor] =
+0000c0e0: 204e 6f6e 652c 0a20 2020 2020 2020 2064   None,.        d
+0000c0f0: 6563 6f64 6572 5f69 6e70 7574 735f 656d  ecoder_inputs_em
+0000c100: 6265 6473 3a20 4f70 7469 6f6e 616c 5b6d  beds: Optional[m
+0000c110: 696e 6473 706f 7265 2e54 656e 736f 725d  indspore.Tensor]
+0000c120: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+0000c130: 206c 6162 656c 733a 204f 7074 696f 6e61   labels: Optiona
+0000c140: 6c5b 6d69 6e64 7370 6f72 652e 5465 6e73  l[mindspore.Tens
+0000c150: 6f72 5d20 3d20 4e6f 6e65 2c0a 2020 2020  or] = None,.    
+0000c160: 2020 2020 7573 655f 6361 6368 653a 204f      use_cache: O
+0000c170: 7074 696f 6e61 6c5b 626f 6f6c 5d20 3d20  ptional[bool] = 
+0000c180: 4e6f 6e65 2c0a 2020 2020 2020 2020 6f75  None,.        ou
+0000c190: 7470 7574 5f61 7474 656e 7469 6f6e 733a  tput_attentions:
+0000c1a0: 204f 7074 696f 6e61 6c5b 626f 6f6c 5d20   Optional[bool] 
+0000c1b0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+0000c1c0: 6f75 7470 7574 5f68 6964 6465 6e5f 7374  output_hidden_st
+0000c1d0: 6174 6573 3a20 4f70 7469 6f6e 616c 5b62  ates: Optional[b
+0000c1e0: 6f6f 6c5d 203d 204e 6f6e 652c 0a20 2020  ool] = None,.   
+0000c1f0: 2020 2020 2072 6574 7572 6e5f 6469 6374       return_dict
+0000c200: 3a20 4f70 7469 6f6e 616c 5b62 6f6f 6c5d  : Optional[bool]
+0000c210: 203d 204e 6f6e 652c 0a20 2020 2029 202d   = None,.    ) -
+0000c220: 3e20 556e 696f 6e5b 5475 706c 655b 6d69  > Union[Tuple[mi
+0000c230: 6e64 7370 6f72 652e 5465 6e73 6f72 5d2c  ndspore.Tensor],
+0000c240: 2053 6571 3253 6571 4c4d 4f75 7470 7574   Seq2SeqLMOutput
+0000c250: 5d3a 0a20 2020 2020 2020 2072 2222 220a  ]:.        r""".
+0000c260: 2020 2020 2020 2020 6c61 6265 6c73 2028          labels (
+0000c270: 606d 696e 6473 706f 7265 2e54 656e 736f  `mindspore.Tenso
+0000c280: 7260 206f 6620 7368 6170 6520 6028 6261  r` of shape `(ba
+0000c290: 7463 685f 7369 7a65 2c20 7365 7175 656e  tch_size, sequen
+0000c2a0: 6365 5f6c 656e 6774 6829 602c 202a 6f70  ce_length)`, *op
+0000c2b0: 7469 6f6e 616c 2a29 3a0a 2020 2020 2020  tional*):.      
+0000c2c0: 2020 2020 2020 4c61 6265 6c73 2066 6f72        Labels for
+0000c2d0: 2063 6f6d 7075 7469 6e67 2074 6865 206d   computing the m
+0000c2e0: 6173 6b65 6420 6c61 6e67 7561 6765 206d  asked language m
+0000c2f0: 6f64 656c 696e 6720 6c6f 7373 2e20 496e  odeling loss. In
+0000c300: 6469 6365 7320 7368 6f75 6c64 2065 6974  dices should eit
+0000c310: 6865 7220 6265 2069 6e20 605b 302c 202e  her be in `[0, .
+0000c320: 2e2e 2c0a 2020 2020 2020 2020 2020 2020  ..,.            
+0000c330: 636f 6e66 6967 2e76 6f63 6162 5f73 697a  config.vocab_siz
+0000c340: 655d 6020 6f72 202d 3130 3020 2873 6565  e]` or -100 (see
+0000c350: 2060 696e 7075 745f 6964 7360 2064 6f63   `input_ids` doc
+0000c360: 7374 7269 6e67 292e 2054 6f6b 656e 7320  string). Tokens 
+0000c370: 7769 7468 2069 6e64 6963 6573 2073 6574  with indices set
+0000c380: 2074 6f20 602d 3130 3060 2061 7265 2069   to `-100` are i
+0000c390: 676e 6f72 6564 0a20 2020 2020 2020 2020  gnored.         
+0000c3a0: 2020 2028 6d61 736b 6564 292c 2074 6865     (masked), the
+0000c3b0: 206c 6f73 7320 6973 206f 6e6c 7920 636f   loss is only co
+0000c3c0: 6d70 7574 6564 2066 6f72 2074 6865 2074  mputed for the t
+0000c3d0: 6f6b 656e 7320 7769 7468 206c 6162 656c  okens with label
+0000c3e0: 7320 696e 2060 5b30 2c20 2e2e 2e2c 2063  s in `[0, ..., c
+0000c3f0: 6f6e 6669 672e 766f 6361 625f 7369 7a65  onfig.vocab_size
+0000c400: 5d60 2e0a 0a20 2020 2020 2020 2052 6574  ]`...        Ret
+0000c410: 7572 6e73 3a0a 2020 2020 2020 2020 2222  urns:.        ""
+0000c420: 220a 2020 2020 2020 2020 7265 7475 726e  ".        return
+0000c430: 5f64 6963 7420 3d20 7265 7475 726e 5f64  _dict = return_d
+0000c440: 6963 7420 6966 2072 6574 7572 6e5f 6469  ict if return_di
+0000c450: 6374 2069 7320 6e6f 7420 4e6f 6e65 2065  ct is not None e
+0000c460: 6c73 6520 7365 6c66 2e63 6f6e 6669 672e  lse self.config.
+0000c470: 7573 655f 7265 7475 726e 5f64 6963 740a  use_return_dict.
+0000c480: 0a20 2020 2020 2020 2069 6620 6c61 6265  .        if labe
+0000c490: 6c73 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ls is not None:.
+0000c4a0: 2020 2020 2020 2020 2020 2020 6966 2075              if u
+0000c4b0: 7365 5f63 6163 6865 3a0a 2020 2020 2020  se_cache:.      
+0000c4c0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+0000c4d0: 2e77 6172 6e69 6e67 2822 5468 6520 6075  .warning("The `u
+0000c4e0: 7365 5f63 6163 6865 6020 6172 6775 6d65  se_cache` argume
+0000c4f0: 6e74 2069 7320 6368 616e 6765 6420 746f  nt is changed to
+0000c500: 2060 4661 6c73 6560 2073 696e 6365 2060   `False` since `
+0000c510: 6c61 6265 6c73 6020 6973 2070 726f 7669  labels` is provi
+0000c520: 6465 642e 2229 0a20 2020 2020 2020 2020  ded.").         
+0000c530: 2020 2075 7365 5f63 6163 6865 203d 2046     use_cache = F
+0000c540: 616c 7365 0a20 2020 2020 2020 2020 2020  alse.           
+0000c550: 2069 6620 6465 636f 6465 725f 696e 7075   if decoder_inpu
+0000c560: 745f 6964 7320 6973 204e 6f6e 6520 616e  t_ids is None an
+0000c570: 6420 6465 636f 6465 725f 696e 7075 7473  d decoder_inputs
+0000c580: 5f65 6d62 6564 7320 6973 204e 6f6e 653a  _embeds is None:
+0000c590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c5a0: 2064 6563 6f64 6572 5f69 6e70 7574 5f69   decoder_input_i
+0000c5b0: 6473 203d 2073 6869 6674 5f74 6f6b 656e  ds = shift_token
+0000c5c0: 735f 7269 6768 7428 0a20 2020 2020 2020  s_right(.       
+0000c5d0: 2020 2020 2020 2020 2020 2020 206c 6162               lab
+0000c5e0: 656c 732c 2073 656c 662e 636f 6e66 6967  els, self.config
+0000c5f0: 2e70 6164 5f74 6f6b 656e 5f69 642c 2073  .pad_token_id, s
+0000c600: 656c 662e 636f 6e66 6967 2e64 6563 6f64  elf.config.decod
+0000c610: 6572 5f73 7461 7274 5f74 6f6b 656e 5f69  er_start_token_i
+0000c620: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+0000c630: 2020 290a 0a20 2020 2020 2020 206f 7574    )..        out
+0000c640: 7075 7473 203d 2073 656c 662e 6d6f 6465  puts = self.mode
+0000c650: 6c28 0a20 2020 2020 2020 2020 2020 2069  l(.            i
+0000c660: 6e70 7574 5f69 6473 2c0a 2020 2020 2020  nput_ids,.      
+0000c670: 2020 2020 2020 6174 7465 6e74 696f 6e5f        attention_
+0000c680: 6d61 736b 3d61 7474 656e 7469 6f6e 5f6d  mask=attention_m
+0000c690: 6173 6b2c 0a20 2020 2020 2020 2020 2020  ask,.           
+0000c6a0: 2064 6563 6f64 6572 5f69 6e70 7574 5f69   decoder_input_i
+0000c6b0: 6473 3d64 6563 6f64 6572 5f69 6e70 7574  ds=decoder_input
+0000c6c0: 5f69 6473 2c0a 2020 2020 2020 2020 2020  _ids,.          
+0000c6d0: 2020 656e 636f 6465 725f 6f75 7470 7574    encoder_output
+0000c6e0: 733d 656e 636f 6465 725f 6f75 7470 7574  s=encoder_output
+0000c6f0: 732c 0a20 2020 2020 2020 2020 2020 2064  s,.            d
+0000c700: 6563 6f64 6572 5f61 7474 656e 7469 6f6e  ecoder_attention
+0000c710: 5f6d 6173 6b3d 6465 636f 6465 725f 6174  _mask=decoder_at
+0000c720: 7465 6e74 696f 6e5f 6d61 736b 2c0a 2020  tention_mask,.  
+0000c730: 2020 2020 2020 2020 2020 6865 6164 5f6d            head_m
+0000c740: 6173 6b3d 6865 6164 5f6d 6173 6b2c 0a20  ask=head_mask,. 
+0000c750: 2020 2020 2020 2020 2020 2064 6563 6f64             decod
+0000c760: 6572 5f68 6561 645f 6d61 736b 3d64 6563  er_head_mask=dec
+0000c770: 6f64 6572 5f68 6561 645f 6d61 736b 2c0a  oder_head_mask,.
+0000c780: 2020 2020 2020 2020 2020 2020 6372 6f73              cros
+0000c790: 735f 6174 746e 5f68 6561 645f 6d61 736b  s_attn_head_mask
+0000c7a0: 3d63 726f 7373 5f61 7474 6e5f 6865 6164  =cross_attn_head
+0000c7b0: 5f6d 6173 6b2c 0a20 2020 2020 2020 2020  _mask,.         
+0000c7c0: 2020 2070 6173 745f 6b65 795f 7661 6c75     past_key_valu
+0000c7d0: 6573 3d70 6173 745f 6b65 795f 7661 6c75  es=past_key_valu
+0000c7e0: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+0000c7f0: 696e 7075 7473 5f65 6d62 6564 733d 696e  inputs_embeds=in
+0000c800: 7075 7473 5f65 6d62 6564 732c 0a20 2020  puts_embeds,.   
+0000c810: 2020 2020 2020 2020 2064 6563 6f64 6572           decoder
+0000c820: 5f69 6e70 7574 735f 656d 6265 6473 3d64  _inputs_embeds=d
+0000c830: 6563 6f64 6572 5f69 6e70 7574 735f 656d  ecoder_inputs_em
+0000c840: 6265 6473 2c0a 2020 2020 2020 2020 2020  beds,.          
+0000c850: 2020 7573 655f 6361 6368 653d 7573 655f    use_cache=use_
+0000c860: 6361 6368 652c 0a20 2020 2020 2020 2020  cache,.         
+0000c870: 2020 206f 7574 7075 745f 6174 7465 6e74     output_attent
+0000c880: 696f 6e73 3d6f 7574 7075 745f 6174 7465  ions=output_atte
+0000c890: 6e74 696f 6e73 2c0a 2020 2020 2020 2020  ntions,.        
+0000c8a0: 2020 2020 6f75 7470 7574 5f68 6964 6465      output_hidde
+0000c8b0: 6e5f 7374 6174 6573 3d6f 7574 7075 745f  n_states=output_
+0000c8c0: 6869 6464 656e 5f73 7461 7465 732c 0a20  hidden_states,. 
+0000c8d0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000c8e0: 6e5f 6469 6374 3d72 6574 7572 6e5f 6469  n_dict=return_di
+0000c8f0: 6374 2c0a 2020 2020 2020 2020 290a 2020  ct,.        ).  
+0000c900: 2020 2020 2020 6c6d 5f6c 6f67 6974 7320        lm_logits 
+0000c910: 3d20 7365 6c66 2e6c 6d5f 6865 6164 286f  = self.lm_head(o
+0000c920: 7574 7075 7473 5b30 5d29 202b 2073 656c  utputs[0]) + sel
+0000c930: 662e 6669 6e61 6c5f 6c6f 6769 7473 5f62  f.final_logits_b
+0000c940: 6961 730a 0a20 2020 2020 2020 206d 6173  ias..        mas
+0000c950: 6b65 645f 6c6d 5f6c 6f73 7320 3d20 4e6f  ked_lm_loss = No
+0000c960: 6e65 0a20 2020 2020 2020 2069 6620 6c61  ne.        if la
+0000c970: 6265 6c73 2069 7320 6e6f 7420 4e6f 6e65  bels is not None
+0000c980: 3a0a 2020 2020 2020 2020 2020 2020 6d61  :.            ma
+0000c990: 736b 6564 5f6c 6d5f 6c6f 7373 203d 206f  sked_lm_loss = o
+0000c9a0: 7073 2e63 726f 7373 5f65 6e74 726f 7079  ps.cross_entropy
+0000c9b0: 286c 6d5f 6c6f 6769 7473 2e76 6965 7728  (lm_logits.view(
+0000c9c0: 2d31 2c20 7365 6c66 2e63 6f6e 6669 672e  -1, self.config.
+0000c9d0: 766f 6361 625f 7369 7a65 292c 206c 6162  vocab_size), lab
+0000c9e0: 656c 732e 7669 6577 282d 3129 290a 0a20  els.view(-1)).. 
+0000c9f0: 2020 2020 2020 2069 6620 6e6f 7420 7265         if not re
+0000ca00: 7475 726e 5f64 6963 743a 0a20 2020 2020  turn_dict:.     
+0000ca10: 2020 2020 2020 206f 7574 7075 7420 3d20         output = 
+0000ca20: 286c 6d5f 6c6f 6769 7473 2c29 202b 206f  (lm_logits,) + o
+0000ca30: 7574 7075 7473 5b31 3a5d 0a20 2020 2020  utputs[1:].     
+0000ca40: 2020 2020 2020 2072 6574 7572 6e20 2828         return ((
+0000ca50: 6d61 736b 6564 5f6c 6d5f 6c6f 7373 2c29  masked_lm_loss,)
+0000ca60: 202b 206f 7574 7075 7429 2069 6620 6d61   + output) if ma
+0000ca70: 736b 6564 5f6c 6d5f 6c6f 7373 2069 7320  sked_lm_loss is 
+0000ca80: 6e6f 7420 4e6f 6e65 2065 6c73 6520 6f75  not None else ou
+0000ca90: 7470 7574 0a0a 2020 2020 2020 2020 7265  tput..        re
+0000caa0: 7475 726e 2053 6571 3253 6571 4c4d 4f75  turn Seq2SeqLMOu
+0000cab0: 7470 7574 280a 2020 2020 2020 2020 2020  tput(.          
+0000cac0: 2020 6c6f 7373 3d6d 6173 6b65 645f 6c6d    loss=masked_lm
+0000cad0: 5f6c 6f73 732c 0a20 2020 2020 2020 2020  _loss,.         
+0000cae0: 2020 206c 6f67 6974 733d 6c6d 5f6c 6f67     logits=lm_log
+0000caf0: 6974 732c 0a20 2020 2020 2020 2020 2020  its,.           
+0000cb00: 2070 6173 745f 6b65 795f 7661 6c75 6573   past_key_values
+0000cb10: 3d6f 7574 7075 7473 2e70 6173 745f 6b65  =outputs.past_ke
+0000cb20: 795f 7661 6c75 6573 2c0a 2020 2020 2020  y_values,.      
+0000cb30: 2020 2020 2020 6465 636f 6465 725f 6869        decoder_hi
+0000cb40: 6464 656e 5f73 7461 7465 733d 6f75 7470  dden_states=outp
+0000cb50: 7574 732e 6465 636f 6465 725f 6869 6464  uts.decoder_hidd
+0000cb60: 656e 5f73 7461 7465 732c 0a20 2020 2020  en_states,.     
+0000cb70: 2020 2020 2020 2064 6563 6f64 6572 5f61         decoder_a
+0000cb80: 7474 656e 7469 6f6e 733d 6f75 7470 7574  ttentions=output
+0000cb90: 732e 6465 636f 6465 725f 6174 7465 6e74  s.decoder_attent
+0000cba0: 696f 6e73 2c0a 2020 2020 2020 2020 2020  ions,.          
+0000cbb0: 2020 6372 6f73 735f 6174 7465 6e74 696f    cross_attentio
+0000cbc0: 6e73 3d6f 7574 7075 7473 2e63 726f 7373  ns=outputs.cross
+0000cbd0: 5f61 7474 656e 7469 6f6e 732c 0a20 2020  _attentions,.   
+0000cbe0: 2020 2020 2020 2020 2065 6e63 6f64 6572           encoder
+0000cbf0: 5f6c 6173 745f 6869 6464 656e 5f73 7461  _last_hidden_sta
+0000cc00: 7465 3d6f 7574 7075 7473 2e65 6e63 6f64  te=outputs.encod
+0000cc10: 6572 5f6c 6173 745f 6869 6464 656e 5f73  er_last_hidden_s
+0000cc20: 7461 7465 2c0a 2020 2020 2020 2020 2020  tate,.          
+0000cc30: 2020 656e 636f 6465 725f 6869 6464 656e    encoder_hidden
+0000cc40: 5f73 7461 7465 733d 6f75 7470 7574 732e  _states=outputs.
+0000cc50: 656e 636f 6465 725f 6869 6464 656e 5f73  encoder_hidden_s
+0000cc60: 7461 7465 732c 0a20 2020 2020 2020 2020  tates,.         
+0000cc70: 2020 2065 6e63 6f64 6572 5f61 7474 656e     encoder_atten
+0000cc80: 7469 6f6e 733d 6f75 7470 7574 732e 656e  tions=outputs.en
+0000cc90: 636f 6465 725f 6174 7465 6e74 696f 6e73  coder_attentions
+0000cca0: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
+0000ccb0: 2064 6566 2070 7265 7061 7265 5f69 6e70   def prepare_inp
+0000ccc0: 7574 735f 666f 725f 6765 6e65 7261 7469  uts_for_generati
+0000ccd0: 6f6e 280a 2020 2020 2020 2020 7365 6c66  on(.        self
+0000cce0: 2c0a 2020 2020 2020 2020 6465 636f 6465  ,.        decode
+0000ccf0: 725f 696e 7075 745f 6964 732c 0a20 2020  r_input_ids,.   
+0000cd00: 2020 2020 2070 6173 745f 6b65 795f 7661       past_key_va
+0000cd10: 6c75 6573 3d4e 6f6e 652c 0a20 2020 2020  lues=None,.     
+0000cd20: 2020 2061 7474 656e 7469 6f6e 5f6d 6173     attention_mas
+0000cd30: 6b3d 4e6f 6e65 2c0a 2020 2020 2020 2020  k=None,.        
+0000cd40: 6865 6164 5f6d 6173 6b3d 4e6f 6e65 2c0a  head_mask=None,.
+0000cd50: 2020 2020 2020 2020 6465 636f 6465 725f          decoder_
+0000cd60: 6865 6164 5f6d 6173 6b3d 4e6f 6e65 2c0a  head_mask=None,.
+0000cd70: 2020 2020 2020 2020 6372 6f73 735f 6174          cross_at
+0000cd80: 746e 5f68 6561 645f 6d61 736b 3d4e 6f6e  tn_head_mask=Non
+0000cd90: 652c 0a20 2020 2020 2020 2075 7365 5f63  e,.        use_c
+0000cda0: 6163 6865 3d4e 6f6e 652c 0a20 2020 2020  ache=None,.     
+0000cdb0: 2020 2065 6e63 6f64 6572 5f6f 7574 7075     encoder_outpu
+0000cdc0: 7473 3d4e 6f6e 652c 0a20 2020 2020 2020  ts=None,.       
+0000cdd0: 202a 2a6b 7761 7267 732c 0a20 2020 2029   **kwargs,.    )
+0000cde0: 3a0a 2020 2020 2020 2020 2320 6375 7420  :.        # cut 
+0000cdf0: 6465 636f 6465 725f 696e 7075 745f 6964  decoder_input_id
+0000ce00: 7320 6966 2070 6173 7420 6973 2075 7365  s if past is use
+0000ce10: 640a 2020 2020 2020 2020 6966 2070 6173  d.        if pas
+0000ce20: 745f 6b65 795f 7661 6c75 6573 2069 7320  t_key_values is 
+0000ce30: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+0000ce40: 2020 2020 2020 7061 7374 5f6c 656e 6774        past_lengt
+0000ce50: 6820 3d20 7061 7374 5f6b 6579 5f76 616c  h = past_key_val
+0000ce60: 7565 735b 305d 5b30 5d2e 7368 6170 655b  ues[0][0].shape[
+0000ce70: 325d 0a0a 2020 2020 2020 2020 2020 2020  2]..            
+0000ce80: 2320 536f 6d65 2067 656e 6572 6174 696f  # Some generatio
+0000ce90: 6e20 6d65 7468 6f64 7320 616c 7265 6164  n methods alread
+0000cea0: 7920 7061 7373 206f 6e6c 7920 7468 6520  y pass only the 
+0000ceb0: 6c61 7374 2069 6e70 7574 2049 440a 2020  last input ID.  
+0000cec0: 2020 2020 2020 2020 2020 6966 2064 6563            if dec
+0000ced0: 6f64 6572 5f69 6e70 7574 5f69 6473 2e73  oder_input_ids.s
+0000cee0: 6861 7065 5b31 5d20 3e20 7061 7374 5f6c  hape[1] > past_l
+0000cef0: 656e 6774 683a 0a20 2020 2020 2020 2020  ength:.         
+0000cf00: 2020 2020 2020 2072 656d 6f76 655f 7072         remove_pr
+0000cf10: 6566 6978 5f6c 656e 6774 6820 3d20 7061  efix_length = pa
+0000cf20: 7374 5f6c 656e 6774 680a 2020 2020 2020  st_length.      
+0000cf30: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0000cf40: 2020 2020 2020 2020 2020 2020 2320 4465              # De
+0000cf50: 6661 756c 7420 746f 206f 6c64 2062 6568  fault to old beh
+0000cf60: 6176 696f 723a 206b 6565 7020 6f6e 6c79  avior: keep only
+0000cf70: 2066 696e 616c 2049 440a 2020 2020 2020   final ID.      
+0000cf80: 2020 2020 2020 2020 2020 7265 6d6f 7665            remove
+0000cf90: 5f70 7265 6669 785f 6c65 6e67 7468 203d  _prefix_length =
+0000cfa0: 2064 6563 6f64 6572 5f69 6e70 7574 5f69   decoder_input_i
+0000cfb0: 6473 2e73 6861 7065 5b31 5d20 2d20 310a  ds.shape[1] - 1.
+0000cfc0: 0a20 2020 2020 2020 2020 2020 2064 6563  .            dec
+0000cfd0: 6f64 6572 5f69 6e70 7574 5f69 6473 203d  oder_input_ids =
+0000cfe0: 2064 6563 6f64 6572 5f69 6e70 7574 5f69   decoder_input_i
+0000cff0: 6473 5b3a 2c20 7265 6d6f 7665 5f70 7265  ds[:, remove_pre
+0000d000: 6669 785f 6c65 6e67 7468 3a5d 0a0a 2020  fix_length:]..  
+0000d010: 2020 2020 2020 7265 7475 726e 207b 0a20        return {. 
+0000d020: 2020 2020 2020 2020 2020 2022 696e 7075             "inpu
+0000d030: 745f 6964 7322 3a20 4e6f 6e65 2c20 2023  t_ids": None,  #
+0000d040: 2065 6e63 6f64 6572 5f6f 7574 7075 7473   encoder_outputs
+0000d050: 2069 7320 6465 6669 6e65 642e 2069 6e70   is defined. inp
+0000d060: 7574 5f69 6473 206e 6f74 206e 6565 6465  ut_ids not neede
+0000d070: 640a 2020 2020 2020 2020 2020 2020 2265  d.            "e
+0000d080: 6e63 6f64 6572 5f6f 7574 7075 7473 223a  ncoder_outputs":
+0000d090: 2065 6e63 6f64 6572 5f6f 7574 7075 7473   encoder_outputs
+0000d0a0: 2c0a 2020 2020 2020 2020 2020 2020 2270  ,.            "p
+0000d0b0: 6173 745f 6b65 795f 7661 6c75 6573 223a  ast_key_values":
+0000d0c0: 2070 6173 745f 6b65 795f 7661 6c75 6573   past_key_values
+0000d0d0: 2c0a 2020 2020 2020 2020 2020 2020 2264  ,.            "d
+0000d0e0: 6563 6f64 6572 5f69 6e70 7574 5f69 6473  ecoder_input_ids
+0000d0f0: 223a 2064 6563 6f64 6572 5f69 6e70 7574  ": decoder_input
+0000d100: 5f69 6473 2c0a 2020 2020 2020 2020 2020  _ids,.          
+0000d110: 2020 2261 7474 656e 7469 6f6e 5f6d 6173    "attention_mas
+0000d120: 6b22 3a20 6174 7465 6e74 696f 6e5f 6d61  k": attention_ma
+0000d130: 736b 2c0a 2020 2020 2020 2020 2020 2020  sk,.            
+0000d140: 2268 6561 645f 6d61 736b 223a 2068 6561  "head_mask": hea
+0000d150: 645f 6d61 736b 2c0a 2020 2020 2020 2020  d_mask,.        
+0000d160: 2020 2020 2264 6563 6f64 6572 5f68 6561      "decoder_hea
+0000d170: 645f 6d61 736b 223a 2064 6563 6f64 6572  d_mask": decoder
+0000d180: 5f68 6561 645f 6d61 736b 2c0a 2020 2020  _head_mask,.    
+0000d190: 2020 2020 2020 2020 2263 726f 7373 5f61          "cross_a
+0000d1a0: 7474 6e5f 6865 6164 5f6d 6173 6b22 3a20  ttn_head_mask": 
+0000d1b0: 6372 6f73 735f 6174 746e 5f68 6561 645f  cross_attn_head_
+0000d1c0: 6d61 736b 2c0a 2020 2020 2020 2020 2020  mask,.          
+0000d1d0: 2020 2275 7365 5f63 6163 6865 223a 2075    "use_cache": u
+0000d1e0: 7365 5f63 6163 6865 2c20 2023 2063 6861  se_cache,  # cha
+0000d1f0: 6e67 6520 7468 6973 2074 6f20 6176 6f69  nge this to avoi
+0000d200: 6420 6361 6368 696e 6720 2870 7265 7375  d caching (presu
+0000d210: 6d61 626c 7920 666f 7220 6465 6275 6767  mably for debugg
+0000d220: 696e 6729 0a20 2020 2020 2020 207d 0a0a  ing).        }..
+0000d230: 2020 2020 4073 7461 7469 636d 6574 686f      @staticmetho
+0000d240: 640a 2020 2020 6465 6620 5f72 656f 7264  d.    def _reord
+0000d250: 6572 5f63 6163 6865 2870 6173 745f 6b65  er_cache(past_ke
+0000d260: 795f 7661 6c75 6573 2c20 6265 616d 5f69  y_values, beam_i
+0000d270: 6478 293a 0a20 2020 2020 2020 2072 656f  dx):.        reo
+0000d280: 7264 6572 6564 5f70 6173 7420 3d20 2829  rdered_past = ()
+0000d290: 0a20 2020 2020 2020 2066 6f72 206c 6179  .        for lay
+0000d2a0: 6572 5f70 6173 7420 696e 2070 6173 745f  er_past in past_
+0000d2b0: 6b65 795f 7661 6c75 6573 3a0a 2020 2020  key_values:.    
+0000d2c0: 2020 2020 2020 2020 2320 6361 6368 6564          # cached
+0000d2d0: 2063 726f 7373 5f61 7474 656e 7469 6f6e   cross_attention
+0000d2e0: 2073 7461 7465 7320 646f 6e27 7420 6861   states don't ha
+0000d2f0: 7665 2074 6f20 6265 2072 656f 7264 6572  ve to be reorder
+0000d300: 6564 202d 3e20 7468 6579 2061 7265 2061  ed -> they are a
+0000d310: 6c77 6179 7320 7468 6520 7361 6d65 0a20  lways the same. 
+0000d320: 2020 2020 2020 2020 2020 2072 656f 7264             reord
+0000d330: 6572 6564 5f70 6173 7420 2b3d 2028 0a20  ered_past += (. 
+0000d340: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0000d350: 7570 6c65 2870 6173 745f 7374 6174 652e  uple(past_state.
+0000d360: 696e 6465 785f 7365 6c65 6374 2830 2c20  index_select(0, 
+0000d370: 6265 616d 5f69 6478 2920 666f 7220 7061  beam_idx) for pa
+0000d380: 7374 5f73 7461 7465 2069 6e20 6c61 7965  st_state in laye
+0000d390: 725f 7061 7374 5b3a 325d 290a 2020 2020  r_past[:2]).    
+0000d3a0: 2020 2020 2020 2020 2020 2020 2b20 6c61              + la
+0000d3b0: 7965 725f 7061 7374 5b32 3a5d 2c0a 2020  yer_past[2:],.  
+0000d3c0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0000d3d0: 2020 2020 7265 7475 726e 2072 656f 7264      return reord
+0000d3e0: 6572 6564 5f70 6173 740a 0a0a 2320 436f  ered_past...# Co
+0000d3f0: 7069 6564 2066 726f 6d20 7472 616e 7366  pied from transf
+0000d400: 6f72 6d65 7273 2e6d 6f64 656c 732e 6261  ormers.models.ba
+0000d410: 7274 2e6d 6f64 656c 696e 675f 6261 7274  rt.modeling_bart
+0000d420: 2e42 6172 7444 6563 6f64 6572 5772 6170  .BartDecoderWrap
+0000d430: 7065 7220 7769 7468 2042 6172 742d 3e42  per with Bart->B
+0000d440: 6c65 6e64 6572 626f 7453 6d61 6c6c 0a63  lenderbotSmall.c
+0000d450: 6c61 7373 2042 6c65 6e64 6572 626f 7453  lass BlenderbotS
+0000d460: 6d61 6c6c 4465 636f 6465 7257 7261 7070  mallDecoderWrapp
+0000d470: 6572 2842 6c65 6e64 6572 626f 7453 6d61  er(BlenderbotSma
+0000d480: 6c6c 5072 6554 7261 696e 6564 4d6f 6465  llPreTrainedMode
+0000d490: 6c29 3a0a 2020 2020 2222 220a 2020 2020  l):.    """.    
+0000d4a0: 5468 6973 2077 7261 7070 6572 2063 6c61  This wrapper cla
+0000d4b0: 7373 2069 7320 6120 6865 6c70 6572 2063  ss is a helper c
+0000d4c0: 6c61 7373 2074 6f20 636f 7272 6563 746c  lass to correctl
+0000d4d0: 7920 6c6f 6164 2070 7265 7472 6169 6e65  y load pretraine
+0000d4e0: 6420 6368 6563 6b70 6f69 6e74 7320 7768  d checkpoints wh
+0000d4f0: 656e 2074 6865 2063 6175 7361 6c20 6c61  en the causal la
+0000d500: 6e67 7561 6765 206d 6f64 656c 2069 730a  nguage model is.
+0000d510: 2020 2020 7573 6564 2069 6e20 636f 6d62      used in comb
+0000d520: 696e 6174 696f 6e20 7769 7468 2074 6865  ination with the
+0000d530: 205b 6045 6e63 6f64 6572 4465 636f 6465   [`EncoderDecode
+0000d540: 724d 6f64 656c 605d 2066 7261 6d65 776f  rModel`] framewo
+0000d550: 726b 2e0a 2020 2020 2222 220a 0a20 2020  rk..    """..   
+0000d560: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
+0000d570: 6c66 2c20 636f 6e66 6967 293a 0a20 2020  lf, config):.   
+0000d580: 2020 2020 2073 7570 6572 2829 2e5f 5f69       super().__i
+0000d590: 6e69 745f 5f28 636f 6e66 6967 290a 2020  nit__(config).  
+0000d5a0: 2020 2020 2020 7365 6c66 2e64 6563 6f64        self.decod
+0000d5b0: 6572 203d 2042 6c65 6e64 6572 626f 7453  er = BlenderbotS
+0000d5c0: 6d61 6c6c 4465 636f 6465 7228 636f 6e66  mallDecoder(conf
+0000d5d0: 6967 290a 0a20 2020 2064 6566 2063 6f6e  ig)..    def con
+0000d5e0: 7374 7275 6374 2873 656c 662c 202a 6172  struct(self, *ar
+0000d5f0: 6773 2c20 2a2a 6b77 6172 6773 293a 0a20  gs, **kwargs):. 
+0000d600: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+0000d610: 6c66 2e64 6563 6f64 6572 282a 6172 6773  lf.decoder(*args
+0000d620: 2c20 2a2a 6b77 6172 6773 290a 0a0a 2320  , **kwargs)...# 
+0000d630: 436f 7069 6564 2066 726f 6d20 7472 616e  Copied from tran
+0000d640: 7366 6f72 6d65 7273 2e6d 6f64 656c 732e  sformers.models.
+0000d650: 6261 7274 2e6d 6f64 656c 696e 675f 6261  bart.modeling_ba
+0000d660: 7274 2e42 6172 7446 6f72 4361 7573 616c  rt.BartForCausal
+0000d670: 4c4d 2077 6974 6820 4261 7274 2d3e 426c  LM with Bart->Bl
+0000d680: 656e 6465 7262 6f74 536d 616c 6c2c 2066  enderbotSmall, f
+0000d690: 6163 6562 6f6f 6b2f 6261 7274 2d62 6173  acebook/bart-bas
+0000d6a0: 652d 3e66 6163 6562 6f6f 6b2f 626c 656e  e->facebook/blen
+0000d6b0: 6465 7262 6f74 5f73 6d61 6c6c 2d39 304d  derbot_small-90M
+0000d6c0: 0a63 6c61 7373 2042 6c65 6e64 6572 626f  .class Blenderbo
+0000d6d0: 7453 6d61 6c6c 466f 7243 6175 7361 6c4c  tSmallForCausalL
+0000d6e0: 4d28 426c 656e 6465 7262 6f74 536d 616c  M(BlenderbotSmal
+0000d6f0: 6c50 7265 5472 6169 6e65 644d 6f64 656c  lPreTrainedModel
+0000d700: 293a 0a20 2020 205f 7469 6564 5f77 6569  ):.    _tied_wei
+0000d710: 6768 7473 5f6b 6579 7320 3d20 5b22 6c6d  ghts_keys = ["lm
+0000d720: 5f68 6561 642e 7765 6967 6874 225d 0a0a  _head.weight"]..
+0000d730: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
+0000d740: 2873 656c 662c 2063 6f6e 6669 6729 3a0a  (self, config):.
+0000d750: 2020 2020 2020 2020 636f 6e66 6967 203d          config =
+0000d760: 2063 6f70 792e 6465 6570 636f 7079 2863   copy.deepcopy(c
+0000d770: 6f6e 6669 6729 0a20 2020 2020 2020 2063  onfig).        c
+0000d780: 6f6e 6669 672e 6973 5f64 6563 6f64 6572  onfig.is_decoder
+0000d790: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
+0000d7a0: 636f 6e66 6967 2e69 735f 656e 636f 6465  config.is_encode
+0000d7b0: 725f 6465 636f 6465 7220 3d20 4661 6c73  r_decoder = Fals
+0000d7c0: 650a 2020 2020 2020 2020 7375 7065 7228  e.        super(
+0000d7d0: 292e 5f5f 696e 6974 5f5f 2863 6f6e 6669  ).__init__(confi
+0000d7e0: 6729 0a20 2020 2020 2020 2073 656c 662e  g).        self.
+0000d7f0: 6d6f 6465 6c20 3d20 426c 656e 6465 7262  model = Blenderb
+0000d800: 6f74 536d 616c 6c44 6563 6f64 6572 5772  otSmallDecoderWr
+0000d810: 6170 7065 7228 636f 6e66 6967 290a 0a20  apper(config).. 
+0000d820: 2020 2020 2020 2073 656c 662e 6c6d 5f68         self.lm_h
+0000d830: 6561 6420 3d20 6e6e 2e44 656e 7365 2863  ead = nn.Dense(c
+0000d840: 6f6e 6669 672e 6869 6464 656e 5f73 697a  onfig.hidden_siz
+0000d850: 652c 2063 6f6e 6669 672e 766f 6361 625f  e, config.vocab_
+0000d860: 7369 7a65 2c20 6861 735f 6269 6173 3d46  size, has_bias=F
+0000d870: 616c 7365 290a 0a20 2020 2020 2020 2023  alse)..        #
+0000d880: 2049 6e69 7469 616c 697a 6520 7765 6967   Initialize weig
+0000d890: 6874 7320 616e 6420 6170 706c 7920 6669  hts and apply fi
+0000d8a0: 6e61 6c20 7072 6f63 6573 7369 6e67 0a20  nal processing. 
+0000d8b0: 2020 2020 2020 2073 656c 662e 706f 7374         self.post
+0000d8c0: 5f69 6e69 7428 290a 0a20 2020 2064 6566  _init()..    def
+0000d8d0: 2067 6574 5f69 6e70 7574 5f65 6d62 6564   get_input_embed
+0000d8e0: 6469 6e67 7328 7365 6c66 293a 0a20 2020  dings(self):.   
+0000d8f0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+0000d900: 2e6d 6f64 656c 2e64 6563 6f64 6572 2e65  .model.decoder.e
+0000d910: 6d62 6564 5f74 6f6b 656e 730a 0a20 2020  mbed_tokens..   
+0000d920: 2064 6566 2073 6574 5f69 6e70 7574 5f65   def set_input_e
+0000d930: 6d62 6564 6469 6e67 7328 7365 6c66 2c20  mbeddings(self, 
+0000d940: 7661 6c75 6529 3a0a 2020 2020 2020 2020  value):.        
+0000d950: 7365 6c66 2e6d 6f64 656c 2e64 6563 6f64  self.model.decod
+0000d960: 6572 2e65 6d62 6564 5f74 6f6b 656e 7320  er.embed_tokens 
+0000d970: 3d20 7661 6c75 650a 0a20 2020 2064 6566  = value..    def
+0000d980: 2067 6574 5f6f 7574 7075 745f 656d 6265   get_output_embe
+0000d990: 6464 696e 6773 2873 656c 6629 3a0a 2020  ddings(self):.  
+0000d9a0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+0000d9b0: 662e 6c6d 5f68 6561 640a 0a20 2020 2064  f.lm_head..    d
+0000d9c0: 6566 2073 6574 5f6f 7574 7075 745f 656d  ef set_output_em
+0000d9d0: 6265 6464 696e 6773 2873 656c 662c 206e  beddings(self, n
+0000d9e0: 6577 5f65 6d62 6564 6469 6e67 7329 3a0a  ew_embeddings):.
+0000d9f0: 2020 2020 2020 2020 7365 6c66 2e6c 6d5f          self.lm_
+0000da00: 6865 6164 203d 206e 6577 5f65 6d62 6564  head = new_embed
+0000da10: 6469 6e67 730a 0a20 2020 2064 6566 2073  dings..    def s
+0000da20: 6574 5f64 6563 6f64 6572 2873 656c 662c  et_decoder(self,
+0000da30: 2064 6563 6f64 6572 293a 0a20 2020 2020   decoder):.     
+0000da40: 2020 2073 656c 662e 6d6f 6465 6c2e 6465     self.model.de
+0000da50: 636f 6465 7220 3d20 6465 636f 6465 720a  coder = decoder.
+0000da60: 0a20 2020 2064 6566 2067 6574 5f64 6563  .    def get_dec
+0000da70: 6f64 6572 2873 656c 6629 3a0a 2020 2020  oder(self):.    
+0000da80: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+0000da90: 6d6f 6465 6c2e 6465 636f 6465 720a 0a20  model.decoder.. 
+0000daa0: 2020 2064 6566 2063 6f6e 7374 7275 6374     def construct
+0000dab0: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+0000dac0: 2020 2020 2020 2020 696e 7075 745f 6964          input_id
+0000dad0: 733a 206d 696e 6473 706f 7265 2e54 656e  s: mindspore.Ten
+0000dae0: 736f 7220 3d20 4e6f 6e65 2c0a 2020 2020  sor = None,.    
+0000daf0: 2020 2020 6174 7465 6e74 696f 6e5f 6d61      attention_ma
+0000db00: 736b 3a20 4f70 7469 6f6e 616c 5b6d 696e  sk: Optional[min
+0000db10: 6473 706f 7265 2e54 656e 736f 725d 203d  dspore.Tensor] =
+0000db20: 204e 6f6e 652c 0a20 2020 2020 2020 2065   None,.        e
+0000db30: 6e63 6f64 6572 5f68 6964 6465 6e5f 7374  ncoder_hidden_st
+0000db40: 6174 6573 3a20 4f70 7469 6f6e 616c 5b6d  ates: Optional[m
+0000db50: 696e 6473 706f 7265 2e54 656e 736f 725d  indspore.Tensor]
+0000db60: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+0000db70: 2065 6e63 6f64 6572 5f61 7474 656e 7469   encoder_attenti
+0000db80: 6f6e 5f6d 6173 6b3a 204f 7074 696f 6e61  on_mask: Optiona
+0000db90: 6c5b 6d69 6e64 7370 6f72 652e 5465 6e73  l[mindspore.Tens
+0000dba0: 6f72 5d20 3d20 4e6f 6e65 2c0a 2020 2020  or] = None,.    
+0000dbb0: 2020 2020 6865 6164 5f6d 6173 6b3a 204f      head_mask: O
+0000dbc0: 7074 696f 6e61 6c5b 6d69 6e64 7370 6f72  ptional[mindspor
+0000dbd0: 652e 5465 6e73 6f72 5d20 3d20 4e6f 6e65  e.Tensor] = None
+0000dbe0: 2c0a 2020 2020 2020 2020 6372 6f73 735f  ,.        cross_
+0000dbf0: 6174 746e 5f68 6561 645f 6d61 736b 3a20  attn_head_mask: 
+0000dc00: 4f70 7469 6f6e 616c 5b6d 696e 6473 706f  Optional[mindspo
+0000dc10: 7265 2e54 656e 736f 725d 203d 204e 6f6e  re.Tensor] = Non
+0000dc20: 652c 0a20 2020 2020 2020 2070 6173 745f  e,.        past_
+0000dc30: 6b65 795f 7661 6c75 6573 3a20 4f70 7469  key_values: Opti
+0000dc40: 6f6e 616c 5b4c 6973 745b 6d69 6e64 7370  onal[List[mindsp
+0000dc50: 6f72 652e 5465 6e73 6f72 5d5d 203d 204e  ore.Tensor]] = N
+0000dc60: 6f6e 652c 0a20 2020 2020 2020 2069 6e70  one,.        inp
+0000dc70: 7574 735f 656d 6265 6473 3a20 4f70 7469  uts_embeds: Opti
+0000dc80: 6f6e 616c 5b6d 696e 6473 706f 7265 2e54  onal[mindspore.T
+0000dc90: 656e 736f 725d 203d 204e 6f6e 652c 0a20  ensor] = None,. 
+0000dca0: 2020 2020 2020 206c 6162 656c 733a 204f         labels: O
+0000dcb0: 7074 696f 6e61 6c5b 6d69 6e64 7370 6f72  ptional[mindspor
+0000dcc0: 652e 5465 6e73 6f72 5d20 3d20 4e6f 6e65  e.Tensor] = None
+0000dcd0: 2c0a 2020 2020 2020 2020 7573 655f 6361  ,.        use_ca
+0000dce0: 6368 653a 204f 7074 696f 6e61 6c5b 626f  che: Optional[bo
+0000dcf0: 6f6c 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ol] = None,.    
+0000dd00: 2020 2020 6f75 7470 7574 5f61 7474 656e      output_atten
+0000dd10: 7469 6f6e 733a 204f 7074 696f 6e61 6c5b  tions: Optional[
+0000dd20: 626f 6f6c 5d20 3d20 4e6f 6e65 2c0a 2020  bool] = None,.  
+0000dd30: 2020 2020 2020 6f75 7470 7574 5f68 6964        output_hid
+0000dd40: 6465 6e5f 7374 6174 6573 3a20 4f70 7469  den_states: Opti
+0000dd50: 6f6e 616c 5b62 6f6f 6c5d 203d 204e 6f6e  onal[bool] = Non
+0000dd60: 652c 0a20 2020 2020 2020 2072 6574 7572  e,.        retur
+0000dd70: 6e5f 6469 6374 3a20 4f70 7469 6f6e 616c  n_dict: Optional
+0000dd80: 5b62 6f6f 6c5d 203d 204e 6f6e 652c 0a20  [bool] = None,. 
+0000dd90: 2020 2029 202d 3e20 556e 696f 6e5b 5475     ) -> Union[Tu
+0000dda0: 706c 652c 2043 6175 7361 6c4c 4d4f 7574  ple, CausalLMOut
+0000ddb0: 7075 7457 6974 6843 726f 7373 4174 7465  putWithCrossAtte
+0000ddc0: 6e74 696f 6e73 5d3a 0a20 2020 2020 2020  ntions]:.       
+0000ddd0: 2072 2222 220a 2020 2020 2020 2020 4172   r""".        Ar
+0000dde0: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
+0000ddf0: 696e 7075 745f 6964 7320 2860 6d69 6e64  input_ids (`mind
+0000de00: 7370 6f72 652e 5465 6e73 6f72 6020 6f66  spore.Tensor` of
+0000de10: 2073 6861 7065 2060 2862 6174 6368 5f73   shape `(batch_s
+0000de20: 697a 652c 2073 6571 7565 6e63 655f 6c65  ize, sequence_le
+0000de30: 6e67 7468 2960 293a 0a20 2020 2020 2020  ngth)`):.       
+0000de40: 2020 2020 2020 2020 2049 6e64 6963 6573           Indices
+0000de50: 206f 6620 696e 7075 7420 7365 7175 656e   of input sequen
+0000de60: 6365 2074 6f6b 656e 7320 696e 2074 6865  ce tokens in the
+0000de70: 2076 6f63 6162 756c 6172 792e 2050 6164   vocabulary. Pad
+0000de80: 6469 6e67 2077 696c 6c20 6265 2069 676e  ding will be ign
+0000de90: 6f72 6564 2062 7920 6465 6661 756c 7420  ored by default 
+0000dea0: 7368 6f75 6c64 2079 6f75 0a20 2020 2020  should you.     
+0000deb0: 2020 2020 2020 2020 2020 2070 726f 7669             provi
+0000dec0: 6465 2069 742e 0a0a 2020 2020 2020 2020  de it...        
+0000ded0: 2020 2020 2020 2020 496e 6469 6365 7320          Indices 
+0000dee0: 6361 6e20 6265 206f 6274 6169 6e65 6420  can be obtained 
+0000def0: 7573 696e 6720 5b60 4175 746f 546f 6b65  using [`AutoToke
+0000df00: 6e69 7a65 7260 5d2e 2053 6565 205b 6050  nizer`]. See [`P
+0000df10: 7265 5472 6169 6e65 6454 6f6b 656e 697a  reTrainedTokeniz
+0000df20: 6572 2e65 6e63 6f64 6560 5d20 616e 640a  er.encode`] and.
+0000df30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000df40: 5b60 5072 6554 7261 696e 6564 546f 6b65  [`PreTrainedToke
+0000df50: 6e69 7a65 722e 5f5f 6361 6c6c 5f5f 605d  nizer.__call__`]
+0000df60: 2066 6f72 2064 6574 6169 6c73 2e0a 0a20   for details... 
+0000df70: 2020 2020 2020 2020 2020 2020 2020 205b                 [
+0000df80: 5768 6174 2061 7265 2069 6e70 7574 2049  What are input I
+0000df90: 4473 3f5d 282e 2e2f 676c 6f73 7361 7279  Ds?](../glossary
+0000dfa0: 2369 6e70 7574 2d69 6473 290a 2020 2020  #input-ids).    
+0000dfb0: 2020 2020 2020 2020 6174 7465 6e74 696f          attentio
+0000dfc0: 6e5f 6d61 736b 2028 606d 696e 6473 706f  n_mask (`mindspo
+0000dfd0: 7265 2e54 656e 736f 7260 206f 6620 7368  re.Tensor` of sh
+0000dfe0: 6170 6520 6028 6261 7463 685f 7369 7a65  ape `(batch_size
+0000dff0: 2c20 7365 7175 656e 6365 5f6c 656e 6774  , sequence_lengt
+0000e000: 6829 602c 202a 6f70 7469 6f6e 616c 2a29  h)`, *optional*)
+0000e010: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000e020: 2020 4d61 736b 2074 6f20 6176 6f69 6420    Mask to avoid 
+0000e030: 7065 7266 6f72 6d69 6e67 2061 7474 656e  performing atten
+0000e040: 7469 6f6e 206f 6e20 7061 6464 696e 6720  tion on padding 
+0000e050: 746f 6b65 6e20 696e 6469 6365 732e 204d  token indices. M
+0000e060: 6173 6b20 7661 6c75 6573 2073 656c 6563  ask values selec
+0000e070: 7465 6420 696e 2060 5b30 2c20 315d 603a  ted in `[0, 1]`:
+0000e080: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000e090: 2020 2d20 3120 666f 7220 746f 6b65 6e73    - 1 for tokens
+0000e0a0: 2074 6861 7420 6172 6520 2a2a 6e6f 7420   that are **not 
+0000e0b0: 6d61 736b 6564 2a2a 2c0a 2020 2020 2020  masked**,.      
+0000e0c0: 2020 2020 2020 2020 2020 2d20 3020 666f            - 0 fo
+0000e0d0: 7220 746f 6b65 6e73 2074 6861 7420 6172  r tokens that ar
+0000e0e0: 6520 2a2a 6d61 736b 6564 2a2a 2e0a 0a20  e **masked**... 
+0000e0f0: 2020 2020 2020 2020 2020 2020 2020 205b                 [
+0000e100: 5768 6174 2061 7265 2061 7474 656e 7469  What are attenti
+0000e110: 6f6e 206d 6173 6b73 3f5d 282e 2e2f 676c  on masks?](../gl
+0000e120: 6f73 7361 7279 2361 7474 656e 7469 6f6e  ossary#attention
+0000e130: 2d6d 6173 6b29 0a20 2020 2020 2020 2020  -mask).         
+0000e140: 2020 2065 6e63 6f64 6572 5f68 6964 6465     encoder_hidde
+0000e150: 6e5f 7374 6174 6573 2020 2860 6d69 6e64  n_states  (`mind
+0000e160: 7370 6f72 652e 5465 6e73 6f72 6020 6f66  spore.Tensor` of
+0000e170: 2073 6861 7065 2060 2862 6174 6368 5f73   shape `(batch_s
+0000e180: 697a 652c 2073 6571 7565 6e63 655f 6c65  ize, sequence_le
+0000e190: 6e67 7468 2c20 6869 6464 656e 5f73 697a  ngth, hidden_siz
+0000e1a0: 6529 602c 202a 6f70 7469 6f6e 616c 2a29  e)`, *optional*)
+0000e1b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000e1c0: 2020 5365 7175 656e 6365 206f 6620 6869    Sequence of hi
+0000e1d0: 6464 656e 2d73 7461 7465 7320 6174 2074  dden-states at t
+0000e1e0: 6865 206f 7574 7075 7420 6f66 2074 6865  he output of the
+0000e1f0: 206c 6173 7420 6c61 7965 7220 6f66 2074   last layer of t
+0000e200: 6865 2065 6e63 6f64 6572 2e20 5573 6564  he encoder. Used
+0000e210: 2069 6e20 7468 6520 6372 6f73 732d 6174   in the cross-at
+0000e220: 7465 6e74 696f 6e0a 2020 2020 2020 2020  tention.        
+0000e230: 2020 2020 2020 2020 6966 2074 6865 206d          if the m
+0000e240: 6f64 656c 2069 7320 636f 6e66 6967 7572  odel is configur
+0000e250: 6564 2061 7320 6120 6465 636f 6465 722e  ed as a decoder.
+0000e260: 0a20 2020 2020 2020 2020 2020 2065 6e63  .            enc
+0000e270: 6f64 6572 5f61 7474 656e 7469 6f6e 5f6d  oder_attention_m
+0000e280: 6173 6b20 2860 6d69 6e64 7370 6f72 652e  ask (`mindspore.
+0000e290: 5465 6e73 6f72 6020 6f66 2073 6861 7065  Tensor` of shape
+0000e2a0: 2060 2862 6174 6368 5f73 697a 652c 2073   `(batch_size, s
+0000e2b0: 6571 7565 6e63 655f 6c65 6e67 7468 2960  equence_length)`
+0000e2c0: 2c20 2a6f 7074 696f 6e61 6c2a 293a 0a20  , *optional*):. 
+0000e2d0: 2020 2020 2020 2020 2020 2020 2020 204d                 M
+0000e2e0: 6173 6b20 746f 2061 766f 6964 2070 6572  ask to avoid per
+0000e2f0: 666f 726d 696e 6720 6174 7465 6e74 696f  forming attentio
+0000e300: 6e20 6f6e 2074 6865 2070 6164 6469 6e67  n on the padding
+0000e310: 2074 6f6b 656e 2069 6e64 6963 6573 206f   token indices o
+0000e320: 6620 7468 6520 656e 636f 6465 7220 696e  f the encoder in
+0000e330: 7075 742e 2054 6869 7320 6d61 736b 2069  put. This mask i
+0000e340: 7320 7573 6564 0a20 2020 2020 2020 2020  s used.         
+0000e350: 2020 2020 2020 2069 6e20 7468 6520 6372         in the cr
+0000e360: 6f73 732d 6174 7465 6e74 696f 6e20 6966  oss-attention if
+0000e370: 2074 6865 206d 6f64 656c 2069 7320 636f   the model is co
+0000e380: 6e66 6967 7572 6564 2061 7320 6120 6465  nfigured as a de
+0000e390: 636f 6465 722e 204d 6173 6b20 7661 6c75  coder. Mask valu
+0000e3a0: 6573 2073 656c 6563 7465 6420 696e 2060  es selected in `
+0000e3b0: 5b30 2c20 315d 603a 0a20 2020 2020 2020  [0, 1]`:.       
+0000e3c0: 2020 2020 2068 6561 645f 6d61 736b 2028       head_mask (
+0000e3d0: 606d 696e 6473 706f 7265 2e54 656e 736f  `mindspore.Tenso
+0000e3e0: 7260 206f 6620 7368 6170 6520 6028 6465  r` of shape `(de
+0000e3f0: 636f 6465 725f 6c61 7965 7273 2c20 6465  coder_layers, de
+0000e400: 636f 6465 725f 6174 7465 6e74 696f 6e5f  coder_attention_
+0000e410: 6865 6164 7329 602c 202a 6f70 7469 6f6e  heads)`, *option
+0000e420: 616c 2a29 3a0a 2020 2020 2020 2020 2020  al*):.          
+0000e430: 2020 2020 2020 4d61 736b 2074 6f20 6e75        Mask to nu
+0000e440: 6c6c 6966 7920 7365 6c65 6374 6564 2068  llify selected h
+0000e450: 6561 6473 206f 6620 7468 6520 6174 7465  eads of the atte
+0000e460: 6e74 696f 6e20 6d6f 6475 6c65 732e 204d  ntion modules. M
+0000e470: 6173 6b20 7661 6c75 6573 2073 656c 6563  ask values selec
+0000e480: 7465 6420 696e 2060 5b30 2c20 315d 603a  ted in `[0, 1]`:
+0000e490: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000e4a0: 2020 2d20 3120 696e 6469 6361 7465 7320    - 1 indicates 
+0000e4b0: 7468 6520 6865 6164 2069 7320 2a2a 6e6f  the head is **no
+0000e4c0: 7420 6d61 736b 6564 2a2a 2c0a 2020 2020  t masked**,.    
+0000e4d0: 2020 2020 2020 2020 2020 2020 2d20 3020              - 0 
+0000e4e0: 696e 6469 6361 7465 7320 7468 6520 6865  indicates the he
+0000e4f0: 6164 2069 7320 2a2a 6d61 736b 6564 2a2a  ad is **masked**
+0000e500: 2e0a 0a20 2020 2020 2020 2020 2020 2063  ...            c
+0000e510: 726f 7373 5f61 7474 6e5f 6865 6164 5f6d  ross_attn_head_m
+0000e520: 6173 6b20 2860 6d69 6e64 7370 6f72 652e  ask (`mindspore.
+0000e530: 5465 6e73 6f72 6020 6f66 2073 6861 7065  Tensor` of shape
+0000e540: 2060 2864 6563 6f64 6572 5f6c 6179 6572   `(decoder_layer
+0000e550: 732c 2064 6563 6f64 6572 5f61 7474 656e  s, decoder_atten
+0000e560: 7469 6f6e 5f68 6561 6473 2960 2c20 2a6f  tion_heads)`, *o
+0000e570: 7074 696f 6e61 6c2a 293a 0a20 2020 2020  ptional*):.     
+0000e580: 2020 2020 2020 2020 2020 204d 6173 6b20             Mask 
+0000e590: 746f 206e 756c 6c69 6679 2073 656c 6563  to nullify selec
+0000e5a0: 7465 6420 6865 6164 7320 6f66 2074 6865  ted heads of the
+0000e5b0: 2063 726f 7373 2d61 7474 656e 7469 6f6e   cross-attention
+0000e5c0: 206d 6f64 756c 6573 2e20 4d61 736b 2076   modules. Mask v
+0000e5d0: 616c 7565 7320 7365 6c65 6374 6564 2069  alues selected i
+0000e5e0: 6e20 605b 302c 2031 5d60 3a0a 0a20 2020  n `[0, 1]`:..   
+0000e5f0: 2020 2020 2020 2020 2020 2020 202d 2031               - 1
+0000e600: 2069 6e64 6963 6174 6573 2074 6865 2068   indicates the h
+0000e610: 6561 6420 6973 202a 2a6e 6f74 206d 6173  ead is **not mas
+0000e620: 6b65 642a 2a2c 0a20 2020 2020 2020 2020  ked**,.         
+0000e630: 2020 2020 2020 202d 2030 2069 6e64 6963         - 0 indic
+0000e640: 6174 6573 2074 6865 2068 6561 6420 6973  ates the head is
+0000e650: 202a 2a6d 6173 6b65 642a 2a2e 0a0a 2020   **masked**...  
+0000e660: 2020 2020 2020 2020 2020 7061 7374 5f6b            past_k
+0000e670: 6579 5f76 616c 7565 7320 2860 7475 706c  ey_values (`tupl
+0000e680: 6528 7475 706c 6528 6d69 6e64 7370 6f72  e(tuple(mindspor
+0000e690: 652e 5465 6e73 6f72 2929 602c 202a 6f70  e.Tensor))`, *op
+0000e6a0: 7469 6f6e 616c 2a2c 2072 6574 7572 6e65  tional*, returne
+0000e6b0: 6420 7768 656e 2060 7573 655f 6361 6368  d when `use_cach
+0000e6c0: 653d 5472 7565 6020 6973 2070 6173 7365  e=True` is passe
+0000e6d0: 6420 6f72 2077 6865 6e20 6063 6f6e 6669  d or when `confi
+0000e6e0: 672e 7573 655f 6361 6368 653d 5472 7565  g.use_cache=True
+0000e6f0: 6029 3a0a 2020 2020 2020 2020 2020 2020  `):.            
+0000e700: 2020 2020 5475 706c 6520 6f66 2060 7475      Tuple of `tu
+0000e710: 706c 6528 6d69 6e64 7370 6f72 652e 5465  ple(mindspore.Te
+0000e720: 6e73 6f72 2960 206f 6620 6c65 6e67 7468  nsor)` of length
+0000e730: 2060 636f 6e66 6967 2e6e 5f6c 6179 6572   `config.n_layer
+0000e740: 7360 2c20 7769 7468 2065 6163 6820 7475  s`, with each tu
+0000e750: 706c 6520 6861 7669 6e67 2032 2074 656e  ple having 2 ten
+0000e760: 736f 7273 206f 660a 2020 2020 2020 2020  sors of.        
+0000e770: 2020 2020 2020 2020 7368 6170 6520 6028          shape `(
+0000e780: 6261 7463 685f 7369 7a65 2c20 6e75 6d5f  batch_size, num_
+0000e790: 6865 6164 732c 2073 6571 7565 6e63 655f  heads, sequence_
+0000e7a0: 6c65 6e67 7468 2c20 656d 6265 645f 7369  length, embed_si
+0000e7b0: 7a65 5f70 6572 5f68 6561 6429 6029 2061  ze_per_head)`) a
+0000e7c0: 6e64 2032 2061 6464 6974 696f 6e61 6c20  nd 2 additional 
+0000e7d0: 7465 6e73 6f72 7320 6f66 0a20 2020 2020  tensors of.     
+0000e7e0: 2020 2020 2020 2020 2020 2073 6861 7065             shape
+0000e7f0: 2060 2862 6174 6368 5f73 697a 652c 206e   `(batch_size, n
+0000e800: 756d 5f68 6561 6473 2c20 656e 636f 6465  um_heads, encode
+0000e810: 725f 7365 7175 656e 6365 5f6c 656e 6774  r_sequence_lengt
+0000e820: 682c 2065 6d62 6564 5f73 697a 655f 7065  h, embed_size_pe
+0000e830: 725f 6865 6164 2960 2e20 5468 6520 7477  r_head)`. The tw
+0000e840: 6f20 6164 6469 7469 6f6e 616c 0a20 2020  o additional.   
+0000e850: 2020 2020 2020 2020 2020 2020 2074 656e               ten
+0000e860: 736f 7273 2061 7265 206f 6e6c 7920 7265  sors are only re
+0000e870: 7175 6972 6564 2077 6865 6e20 7468 6520  quired when the 
+0000e880: 6d6f 6465 6c20 6973 2075 7365 6420 6173  model is used as
+0000e890: 2061 2064 6563 6f64 6572 2069 6e20 6120   a decoder in a 
+0000e8a0: 5365 7175 656e 6365 2074 6f20 5365 7175  Sequence to Sequ
+0000e8b0: 656e 6365 206d 6f64 656c 2e0a 0a20 2020  ence model...   
+0000e8c0: 2020 2020 2020 2020 2020 2020 2043 6f6e               Con
+0000e8d0: 7461 696e 7320 7072 652d 636f 6d70 7574  tains pre-comput
+0000e8e0: 6564 2068 6964 6465 6e2d 7374 6174 6573  ed hidden-states
+0000e8f0: 2028 6b65 7920 616e 6420 7661 6c75 6573   (key and values
+0000e900: 2069 6e20 7468 6520 7365 6c66 2d61 7474   in the self-att
+0000e910: 656e 7469 6f6e 2062 6c6f 636b 7320 616e  ention blocks an
+0000e920: 6420 696e 2074 6865 0a20 2020 2020 2020  d in the.       
+0000e930: 2020 2020 2020 2020 2063 726f 7373 2d61           cross-a
+0000e940: 7474 656e 7469 6f6e 2062 6c6f 636b 7329  ttention blocks)
+0000e950: 2074 6861 7420 6361 6e20 6265 2075 7365   that can be use
+0000e960: 6420 2873 6565 2060 7061 7374 5f6b 6579  d (see `past_key
+0000e970: 5f76 616c 7565 7360 2069 6e70 7574 2920  _values` input) 
+0000e980: 746f 2073 7065 6564 2075 7020 7365 7175  to speed up sequ
+0000e990: 656e 7469 616c 2064 6563 6f64 696e 672e  ential decoding.
+0000e9a0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000e9b0: 2020 4966 2060 7061 7374 5f6b 6579 5f76    If `past_key_v
+0000e9c0: 616c 7565 7360 2061 7265 2075 7365 642c  alues` are used,
+0000e9d0: 2074 6865 2075 7365 7220 6361 6e20 6f70   the user can op
+0000e9e0: 7469 6f6e 616c 6c79 2069 6e70 7574 206f  tionally input o
+0000e9f0: 6e6c 7920 7468 6520 6c61 7374 2060 6465  nly the last `de
+0000ea00: 636f 6465 725f 696e 7075 745f 6964 7360  coder_input_ids`
+0000ea10: 2028 7468 6f73 650a 2020 2020 2020 2020   (those.        
+0000ea20: 2020 2020 2020 2020 7468 6174 2064 6f6e          that don
+0000ea30: 2774 2068 6176 6520 7468 6569 7220 7061  't have their pa
+0000ea40: 7374 206b 6579 2076 616c 7565 2073 7461  st key value sta
+0000ea50: 7465 7320 6769 7665 6e20 746f 2074 6869  tes given to thi
+0000ea60: 7320 6d6f 6465 6c29 206f 6620 7368 6170  s model) of shap
+0000ea70: 6520 6028 6261 7463 685f 7369 7a65 2c20  e `(batch_size, 
+0000ea80: 3129 6020 696e 7374 6561 6420 6f66 0a20  1)` instead of. 
+0000ea90: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0000eaa0: 6c6c 2060 6465 636f 6465 725f 696e 7075  ll `decoder_inpu
+0000eab0: 745f 6964 7360 206f 6620 7368 6170 6520  t_ids` of shape 
+0000eac0: 6028 6261 7463 685f 7369 7a65 2c20 7365  `(batch_size, se
+0000ead0: 7175 656e 6365 5f6c 656e 6774 6829 602e  quence_length)`.
+0000eae0: 0a20 2020 2020 2020 2020 2020 206c 6162  .            lab
+0000eaf0: 656c 7320 2860 6d69 6e64 7370 6f72 652e  els (`mindspore.
+0000eb00: 5465 6e73 6f72 6020 6f66 2073 6861 7065  Tensor` of shape
+0000eb10: 2060 2862 6174 6368 5f73 697a 652c 2073   `(batch_size, s
+0000eb20: 6571 7565 6e63 655f 6c65 6e67 7468 2960  equence_length)`
+0000eb30: 2c20 2a6f 7074 696f 6e61 6c2a 293a 0a20  , *optional*):. 
+0000eb40: 2020 2020 2020 2020 2020 2020 2020 204c                 L
+0000eb50: 6162 656c 7320 666f 7220 636f 6d70 7574  abels for comput
+0000eb60: 696e 6720 7468 6520 6d61 736b 6564 206c  ing the masked l
+0000eb70: 616e 6775 6167 6520 6d6f 6465 6c69 6e67  anguage modeling
+0000eb80: 206c 6f73 732e 2049 6e64 6963 6573 2073   loss. Indices s
+0000eb90: 686f 756c 6420 6569 7468 6572 2062 6520  hould either be 
+0000eba0: 696e 2060 5b30 2c20 2e2e 2e2c 0a20 2020  in `[0, ...,.   
+0000ebb0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0000ebc0: 6669 672e 766f 6361 625f 7369 7a65 5d60  fig.vocab_size]`
+0000ebd0: 206f 7220 2d31 3030 2028 7365 6520 6069   or -100 (see `i
+0000ebe0: 6e70 7574 5f69 6473 6020 646f 6373 7472  nput_ids` docstr
+0000ebf0: 696e 6729 2e20 546f 6b65 6e73 2077 6974  ing). Tokens wit
+0000ec00: 6820 696e 6469 6365 7320 7365 7420 746f  h indices set to
+0000ec10: 2060 2d31 3030 6020 6172 6520 6967 6e6f   `-100` are igno
+0000ec20: 7265 640a 2020 2020 2020 2020 2020 2020  red.            
+0000ec30: 2020 2020 286d 6173 6b65 6429 2c20 7468      (masked), th
+0000ec40: 6520 6c6f 7373 2069 7320 6f6e 6c79 2063  e loss is only c
+0000ec50: 6f6d 7075 7465 6420 666f 7220 7468 6520  omputed for the 
+0000ec60: 746f 6b65 6e73 2077 6974 6820 6c61 6265  tokens with labe
+0000ec70: 6c73 2069 6e20 605b 302c 202e 2e2e 2c20  ls in `[0, ..., 
+0000ec80: 636f 6e66 6967 2e76 6f63 6162 5f73 697a  config.vocab_siz
+0000ec90: 655d 602e 0a20 2020 2020 2020 2020 2020  e]`..           
+0000eca0: 2075 7365 5f63 6163 6865 2028 6062 6f6f   use_cache (`boo
+0000ecb0: 6c60 2c20 2a6f 7074 696f 6e61 6c2a 293a  l`, *optional*):
+0000ecc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ecd0: 2049 6620 7365 7420 746f 2060 5472 7565   If set to `True
+0000ece0: 602c 2060 7061 7374 5f6b 6579 5f76 616c  `, `past_key_val
+0000ecf0: 7565 7360 206b 6579 2076 616c 7565 2073  ues` key value s
+0000ed00: 7461 7465 7320 6172 6520 7265 7475 726e  tates are return
+0000ed10: 6564 2061 6e64 2063 616e 2062 6520 7573  ed and can be us
+0000ed20: 6564 2074 6f20 7370 6565 6420 7570 2064  ed to speed up d
+0000ed30: 6563 6f64 696e 670a 2020 2020 2020 2020  ecoding.        
+0000ed40: 2020 2020 2020 2020 2873 6565 2060 7061          (see `pa
+0000ed50: 7374 5f6b 6579 5f76 616c 7565 7360 292e  st_key_values`).
+0000ed60: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0000ed70: 2020 2d20 3120 666f 7220 746f 6b65 6e73    - 1 for tokens
+0000ed80: 2074 6861 7420 6172 6520 2a2a 6e6f 7420   that are **not 
+0000ed90: 6d61 736b 6564 2a2a 2c0a 2020 2020 2020  masked**,.      
+0000eda0: 2020 2020 2020 2020 2020 2d20 3020 666f            - 0 fo
+0000edb0: 7220 746f 6b65 6e73 2074 6861 7420 6172  r tokens that ar
+0000edc0: 6520 2a2a 6d61 736b 6564 2a2a 2e0a 2020  e **masked**..  
+0000edd0: 2020 2020 2020 2020 2020 6f75 7470 7574            output
+0000ede0: 5f61 7474 656e 7469 6f6e 7320 2860 626f  _attentions (`bo
+0000edf0: 6f6c 602c 202a 6f70 7469 6f6e 616c 2a29  ol`, *optional*)
+0000ee00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000ee10: 2020 5768 6574 6865 7220 6f72 206e 6f74    Whether or not
+0000ee20: 2074 6f20 7265 7475 726e 2074 6865 2061   to return the a
+0000ee30: 7474 656e 7469 6f6e 7320 7465 6e73 6f72  ttentions tensor
+0000ee40: 7320 6f66 2061 6c6c 2061 7474 656e 7469  s of all attenti
+0000ee50: 6f6e 206c 6179 6572 732e 2053 6565 2060  on layers. See `
+0000ee60: 6174 7465 6e74 696f 6e73 6020 756e 6465  attentions` unde
+0000ee70: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
+0000ee80: 2020 7265 7475 726e 6564 2074 656e 736f    returned tenso
+0000ee90: 7273 2066 6f72 206d 6f72 6520 6465 7461  rs for more deta
+0000eea0: 696c 2e0a 2020 2020 2020 2020 2020 2020  il..            
+0000eeb0: 6f75 7470 7574 5f68 6964 6465 6e5f 7374  output_hidden_st
+0000eec0: 6174 6573 2028 6062 6f6f 6c60 2c20 2a6f  ates (`bool`, *o
+0000eed0: 7074 696f 6e61 6c2a 293a 0a20 2020 2020  ptional*):.     
+0000eee0: 2020 2020 2020 2020 2020 2057 6865 7468             Wheth
+0000eef0: 6572 206f 7220 6e6f 7420 746f 2072 6574  er or not to ret
+0000ef00: 7572 6e20 7468 6520 6869 6464 656e 2073  urn the hidden s
+0000ef10: 7461 7465 7320 6f66 2061 6c6c 206c 6179  tates of all lay
+0000ef20: 6572 732e 2053 6565 2060 6869 6464 656e  ers. See `hidden
+0000ef30: 5f73 7461 7465 7360 2075 6e64 6572 2072  _states` under r
+0000ef40: 6574 7572 6e65 6420 7465 6e73 6f72 730a  eturned tensors.
+0000ef50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ef60: 666f 7220 6d6f 7265 2064 6574 6169 6c2e  for more detail.
+0000ef70: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0000ef80: 7572 6e5f 6469 6374 2028 6062 6f6f 6c60  urn_dict (`bool`
+0000ef90: 2c20 2a6f 7074 696f 6e61 6c2a 293a 0a20  , *optional*):. 
+0000efa0: 2020 2020 2020 2020 2020 2020 2020 2057                 W
+0000efb0: 6865 7468 6572 206f 7220 6e6f 7420 746f  hether or not to
+0000efc0: 2072 6574 7572 6e20 6120 5b60 7e75 7469   return a [`~uti
+0000efd0: 6c73 2e4d 6f64 656c 4f75 7470 7574 605d  ls.ModelOutput`]
+0000efe0: 2069 6e73 7465 6164 206f 6620 6120 706c   instead of a pl
+0000eff0: 6169 6e20 7475 706c 652e 0a0a 2020 2020  ain tuple...    
+0000f000: 2020 2020 5265 7475 726e 733a 0a0a 2020      Returns:..  
+0000f010: 2020 2020 2020 4578 616d 706c 653a 0a0a        Example:..
+0000f020: 2020 2020 2020 2020 6060 6070 7974 686f          ```pytho
+0000f030: 6e0a 2020 2020 2020 2020 3e3e 3e20 6672  n.        >>> fr
+0000f040: 6f6d 2074 7261 6e73 666f 726d 6572 7320  om transformers 
+0000f050: 696d 706f 7274 2041 7574 6f54 6f6b 656e  import AutoToken
+0000f060: 697a 6572 2c20 426c 656e 6465 7262 6f74  izer, Blenderbot
+0000f070: 536d 616c 6c46 6f72 4361 7573 616c 4c4d  SmallForCausalLM
+0000f080: 0a0a 2020 2020 2020 2020 3e3e 3e20 746f  ..        >>> to
+0000f090: 6b65 6e69 7a65 7220 3d20 4175 746f 546f  kenizer = AutoTo
+0000f0a0: 6b65 6e69 7a65 722e 6672 6f6d 5f70 7265  kenizer.from_pre
+0000f0b0: 7472 6169 6e65 6428 2266 6163 6562 6f6f  trained("faceboo
+0000f0c0: 6b2f 626c 656e 6465 7262 6f74 5f73 6d61  k/blenderbot_sma
+0000f0d0: 6c6c 2d39 304d 2229 0a20 2020 2020 2020  ll-90M").       
+0000f0e0: 203e 3e3e 206d 6f64 656c 203d 2042 6c65   >>> model = Ble
+0000f0f0: 6e64 6572 626f 7453 6d61 6c6c 466f 7243  nderbotSmallForC
+0000f100: 6175 7361 6c4c 4d2e 6672 6f6d 5f70 7265  ausalLM.from_pre
+0000f110: 7472 6169 6e65 6428 2266 6163 6562 6f6f  trained("faceboo
+0000f120: 6b2f 626c 656e 6465 7262 6f74 5f73 6d61  k/blenderbot_sma
+0000f130: 6c6c 2d39 304d 222c 2061 6464 5f63 726f  ll-90M", add_cro
+0000f140: 7373 5f61 7474 656e 7469 6f6e 3d46 616c  ss_attention=Fal
+0000f150: 7365 290a 2020 2020 2020 2020 3e3e 3e20  se).        >>> 
+0000f160: 6173 7365 7274 206d 6f64 656c 2e63 6f6e  assert model.con
+0000f170: 6669 672e 6973 5f64 6563 6f64 6572 2c20  fig.is_decoder, 
+0000f180: 6622 7b6d 6f64 656c 2e5f 5f63 6c61 7373  f"{model.__class
+0000f190: 5f5f 7d20 6861 7320 746f 2062 6520 636f  __} has to be co
+0000f1a0: 6e66 6967 7572 6564 2061 7320 6120 6465  nfigured as a de
+0000f1b0: 636f 6465 722e 220a 2020 2020 2020 2020  coder.".        
+0000f1c0: 3e3e 3e20 696e 7075 7473 203d 2074 6f6b  >>> inputs = tok
+0000f1d0: 656e 697a 6572 2822 4865 6c6c 6f2c 206d  enizer("Hello, m
+0000f1e0: 7920 646f 6720 6973 2063 7574 6522 2c20  y dog is cute", 
+0000f1f0: 7265 7475 726e 5f74 656e 736f 7273 3d22  return_tensors="
+0000f200: 7074 2229 0a20 2020 2020 2020 203e 3e3e  pt").        >>>
+0000f210: 206f 7574 7075 7473 203d 206d 6f64 656c   outputs = model
+0000f220: 282a 2a69 6e70 7574 7329 0a0a 2020 2020  (**inputs)..    
+0000f230: 2020 2020 3e3e 3e20 6c6f 6769 7473 203d      >>> logits =
+0000f240: 206f 7574 7075 7473 2e6c 6f67 6974 730a   outputs.logits.
+0000f250: 2020 2020 2020 2020 3e3e 3e20 6578 7065          >>> expe
+0000f260: 6374 6564 5f73 6861 7065 203d 205b 312c  cted_shape = [1,
+0000f270: 2069 6e70 7574 732e 696e 7075 745f 6964   inputs.input_id
+0000f280: 732e 7368 6170 655b 2d31 5d2c 206d 6f64  s.shape[-1], mod
+0000f290: 656c 2e63 6f6e 6669 672e 766f 6361 625f  el.config.vocab_
+0000f2a0: 7369 7a65 5d0a 2020 2020 2020 2020 3e3e  size].        >>
+0000f2b0: 3e20 6c69 7374 286c 6f67 6974 732e 7368  > list(logits.sh
+0000f2c0: 6170 6529 203d 3d20 6578 7065 6374 6564  ape) == expected
+0000f2d0: 5f73 6861 7065 0a20 2020 2020 2020 2054  _shape.        T
+0000f2e0: 7275 650a 2020 2020 2020 2020 6060 6022  rue.        ```"
+0000f2f0: 2222 0a0a 2020 2020 2020 2020 6f75 7470  ""..        outp
+0000f300: 7574 5f61 7474 656e 7469 6f6e 7320 3d20  ut_attentions = 
+0000f310: 6f75 7470 7574 5f61 7474 656e 7469 6f6e  output_attention
+0000f320: 7320 6966 206f 7574 7075 745f 6174 7465  s if output_atte
+0000f330: 6e74 696f 6e73 2069 7320 6e6f 7420 4e6f  ntions is not No
+0000f340: 6e65 2065 6c73 6520 7365 6c66 2e63 6f6e  ne else self.con
+0000f350: 6669 672e 6f75 7470 7574 5f61 7474 656e  fig.output_atten
+0000f360: 7469 6f6e 730a 2020 2020 2020 2020 6f75  tions.        ou
+0000f370: 7470 7574 5f68 6964 6465 6e5f 7374 6174  tput_hidden_stat
+0000f380: 6573 203d 2028 0a20 2020 2020 2020 2020  es = (.         
+0000f390: 2020 206f 7574 7075 745f 6869 6464 656e     output_hidden
+0000f3a0: 5f73 7461 7465 7320 6966 206f 7574 7075  _states if outpu
+0000f3b0: 745f 6869 6464 656e 5f73 7461 7465 7320  t_hidden_states 
+0000f3c0: 6973 206e 6f74 204e 6f6e 6520 656c 7365  is not None else
+0000f3d0: 2073 656c 662e 636f 6e66 6967 2e6f 7574   self.config.out
+0000f3e0: 7075 745f 6869 6464 656e 5f73 7461 7465  put_hidden_state
+0000f3f0: 730a 2020 2020 2020 2020 290a 2020 2020  s.        ).    
+0000f400: 2020 2020 7265 7475 726e 5f64 6963 7420      return_dict 
+0000f410: 3d20 7265 7475 726e 5f64 6963 7420 6966  = return_dict if
+0000f420: 2072 6574 7572 6e5f 6469 6374 2069 7320   return_dict is 
+0000f430: 6e6f 7420 4e6f 6e65 2065 6c73 6520 7365  not None else se
+0000f440: 6c66 2e63 6f6e 6669 672e 7573 655f 7265  lf.config.use_re
+0000f450: 7475 726e 5f64 6963 740a 0a20 2020 2020  turn_dict..     
+0000f460: 2020 2023 2064 6563 6f64 6572 206f 7574     # decoder out
+0000f470: 7075 7473 2063 6f6e 7369 7374 7320 6f66  puts consists of
+0000f480: 2028 6465 635f 6665 6174 7572 6573 2c20   (dec_features, 
+0000f490: 6c61 7965 725f 7374 6174 652c 2064 6563  layer_state, dec
+0000f4a0: 5f68 6964 6465 6e2c 2064 6563 5f61 7474  _hidden, dec_att
+0000f4b0: 6e29 0a20 2020 2020 2020 206f 7574 7075  n).        outpu
+0000f4c0: 7473 203d 2073 656c 662e 6d6f 6465 6c2e  ts = self.model.
+0000f4d0: 6465 636f 6465 7228 0a20 2020 2020 2020  decoder(.       
+0000f4e0: 2020 2020 2069 6e70 7574 5f69 6473 3d69       input_ids=i
+0000f4f0: 6e70 7574 5f69 6473 2c0a 2020 2020 2020  nput_ids,.      
+0000f500: 2020 2020 2020 6174 7465 6e74 696f 6e5f        attention_
+0000f510: 6d61 736b 3d61 7474 656e 7469 6f6e 5f6d  mask=attention_m
+0000f520: 6173 6b2c 0a20 2020 2020 2020 2020 2020  ask,.           
+0000f530: 2065 6e63 6f64 6572 5f68 6964 6465 6e5f   encoder_hidden_
+0000f540: 7374 6174 6573 3d65 6e63 6f64 6572 5f68  states=encoder_h
+0000f550: 6964 6465 6e5f 7374 6174 6573 2c0a 2020  idden_states,.  
+0000f560: 2020 2020 2020 2020 2020 656e 636f 6465            encode
+0000f570: 725f 6174 7465 6e74 696f 6e5f 6d61 736b  r_attention_mask
+0000f580: 3d65 6e63 6f64 6572 5f61 7474 656e 7469  =encoder_attenti
+0000f590: 6f6e 5f6d 6173 6b2c 0a20 2020 2020 2020  on_mask,.       
+0000f5a0: 2020 2020 2068 6561 645f 6d61 736b 3d68       head_mask=h
+0000f5b0: 6561 645f 6d61 736b 2c0a 2020 2020 2020  ead_mask,.      
+0000f5c0: 2020 2020 2020 6372 6f73 735f 6174 746e        cross_attn
+0000f5d0: 5f68 6561 645f 6d61 736b 3d63 726f 7373  _head_mask=cross
+0000f5e0: 5f61 7474 6e5f 6865 6164 5f6d 6173 6b2c  _attn_head_mask,
+0000f5f0: 0a20 2020 2020 2020 2020 2020 2070 6173  .            pas
+0000f600: 745f 6b65 795f 7661 6c75 6573 3d70 6173  t_key_values=pas
+0000f610: 745f 6b65 795f 7661 6c75 6573 2c0a 2020  t_key_values,.  
+0000f620: 2020 2020 2020 2020 2020 696e 7075 7473            inputs
+0000f630: 5f65 6d62 6564 733d 696e 7075 7473 5f65  _embeds=inputs_e
+0000f640: 6d62 6564 732c 0a20 2020 2020 2020 2020  mbeds,.         
+0000f650: 2020 2075 7365 5f63 6163 6865 3d75 7365     use_cache=use
+0000f660: 5f63 6163 6865 2c0a 2020 2020 2020 2020  _cache,.        
+0000f670: 2020 2020 6f75 7470 7574 5f61 7474 656e      output_atten
+0000f680: 7469 6f6e 733d 6f75 7470 7574 5f61 7474  tions=output_att
+0000f690: 656e 7469 6f6e 732c 0a20 2020 2020 2020  entions,.       
+0000f6a0: 2020 2020 206f 7574 7075 745f 6869 6464       output_hidd
+0000f6b0: 656e 5f73 7461 7465 733d 6f75 7470 7574  en_states=output
+0000f6c0: 5f68 6964 6465 6e5f 7374 6174 6573 2c0a  _hidden_states,.
+0000f6d0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000f6e0: 726e 5f64 6963 743d 7265 7475 726e 5f64  rn_dict=return_d
+0000f6f0: 6963 742c 0a20 2020 2020 2020 2029 0a0a  ict,.        )..
+0000f700: 2020 2020 2020 2020 6c6f 6769 7473 203d          logits =
+0000f710: 2073 656c 662e 6c6d 5f68 6561 6428 6f75   self.lm_head(ou
+0000f720: 7470 7574 735b 305d 290a 0a20 2020 2020  tputs[0])..     
+0000f730: 2020 206c 6f73 7320 3d20 4e6f 6e65 0a20     loss = None. 
+0000f740: 2020 2020 2020 2069 6620 6c61 6265 6c73         if labels
+0000f750: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+0000f760: 2020 2020 2020 2020 2020 6c6f 7373 203d            loss =
+0000f770: 206f 7073 2e63 726f 7373 5f65 6e74 726f   ops.cross_entro
+0000f780: 7079 286c 6f67 6974 732e 7669 6577 282d  py(logits.view(-
+0000f790: 312c 2073 656c 662e 636f 6e66 6967 2e76  1, self.config.v
+0000f7a0: 6f63 6162 5f73 697a 6529 2c20 6c61 6265  ocab_size), labe
+0000f7b0: 6c73 2e76 6965 7728 2d31 2929 0a0a 2020  ls.view(-1))..  
+0000f7c0: 2020 2020 2020 6966 206e 6f74 2072 6574        if not ret
+0000f7d0: 7572 6e5f 6469 6374 3a0a 2020 2020 2020  urn_dict:.      
+0000f7e0: 2020 2020 2020 6f75 7470 7574 203d 2028        output = (
+0000f7f0: 6c6f 6769 7473 2c29 202b 206f 7574 7075  logits,) + outpu
+0000f800: 7473 5b31 3a5d 0a20 2020 2020 2020 2020  ts[1:].         
+0000f810: 2020 2072 6574 7572 6e20 286c 6f73 732c     return (loss,
+0000f820: 2920 2b20 6f75 7470 7574 2069 6620 6c6f  ) + output if lo
+0000f830: 7373 2069 7320 6e6f 7420 4e6f 6e65 2065  ss is not None e
+0000f840: 6c73 6520 6f75 7470 7574 0a0a 2020 2020  lse output..    
+0000f850: 2020 2020 7265 7475 726e 2043 6175 7361      return Causa
+0000f860: 6c4c 4d4f 7574 7075 7457 6974 6843 726f  lLMOutputWithCro
+0000f870: 7373 4174 7465 6e74 696f 6e73 280a 2020  ssAttentions(.  
+0000f880: 2020 2020 2020 2020 2020 6c6f 7373 3d6c            loss=l
+0000f890: 6f73 732c 0a20 2020 2020 2020 2020 2020  oss,.           
+0000f8a0: 206c 6f67 6974 733d 6c6f 6769 7473 2c0a   logits=logits,.
+0000f8b0: 2020 2020 2020 2020 2020 2020 7061 7374              past
+0000f8c0: 5f6b 6579 5f76 616c 7565 733d 6f75 7470  _key_values=outp
+0000f8d0: 7574 732e 7061 7374 5f6b 6579 5f76 616c  uts.past_key_val
+0000f8e0: 7565 732c 0a20 2020 2020 2020 2020 2020  ues,.           
+0000f8f0: 2068 6964 6465 6e5f 7374 6174 6573 3d6f   hidden_states=o
+0000f900: 7574 7075 7473 2e68 6964 6465 6e5f 7374  utputs.hidden_st
+0000f910: 6174 6573 2c0a 2020 2020 2020 2020 2020  ates,.          
+0000f920: 2020 6174 7465 6e74 696f 6e73 3d6f 7574    attentions=out
+0000f930: 7075 7473 2e61 7474 656e 7469 6f6e 732c  puts.attentions,
+0000f940: 0a20 2020 2020 2020 2020 2020 2063 726f  .            cro
+0000f950: 7373 5f61 7474 656e 7469 6f6e 733d 6f75  ss_attentions=ou
+0000f960: 7470 7574 732e 6372 6f73 735f 6174 7465  tputs.cross_atte
+0000f970: 6e74 696f 6e73 2c0a 2020 2020 2020 2020  ntions,.        
+0000f980: 290a 0a20 2020 2064 6566 2070 7265 7061  )..    def prepa
+0000f990: 7265 5f69 6e70 7574 735f 666f 725f 6765  re_inputs_for_ge
+0000f9a0: 6e65 7261 7469 6f6e 280a 2020 2020 2020  neration(.      
+0000f9b0: 2020 7365 6c66 2c20 696e 7075 745f 6964    self, input_id
+0000f9c0: 732c 2070 6173 745f 6b65 795f 7661 6c75  s, past_key_valu
+0000f9d0: 6573 3d4e 6f6e 652c 2061 7474 656e 7469  es=None, attenti
+0000f9e0: 6f6e 5f6d 6173 6b3d 4e6f 6e65 2c20 7573  on_mask=None, us
+0000f9f0: 655f 6361 6368 653d 4e6f 6e65 2c20 2a2a  e_cache=None, **
+0000fa00: 6b77 6172 6773 0a20 2020 2029 3a0a 2020  kwargs.    ):.  
+0000fa10: 2020 2020 2020 2320 6966 206d 6f64 656c        # if model
+0000fa20: 2069 7320 7573 6564 2061 7320 6120 6465   is used as a de
+0000fa30: 636f 6465 7220 696e 2065 6e63 6f64 6572  coder in encoder
+0000fa40: 2d64 6563 6f64 6572 206d 6f64 656c 2c20  -decoder model, 
+0000fa50: 7468 6520 6465 636f 6465 7220 6174 7465  the decoder atte
+0000fa60: 6e74 696f 6e20 6d61 736b 2069 7320 6372  ntion mask is cr
+0000fa70: 6561 7465 6420 6f6e 2074 6865 2066 6c79  eated on the fly
+0000fa80: 0a20 2020 2020 2020 2069 6620 6174 7465  .        if atte
+0000fa90: 6e74 696f 6e5f 6d61 736b 2069 7320 4e6f  ntion_mask is No
+0000faa0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0000fab0: 6174 7465 6e74 696f 6e5f 6d61 736b 203d  attention_mask =
+0000fac0: 2069 6e70 7574 5f69 6473 2e6e 6577 5f6f   input_ids.new_o
+0000fad0: 6e65 7328 696e 7075 745f 6964 732e 7368  nes(input_ids.sh
+0000fae0: 6170 6529 0a0a 2020 2020 2020 2020 6966  ape)..        if
+0000faf0: 2070 6173 745f 6b65 795f 7661 6c75 6573   past_key_values
+0000fb00: 3a0a 2020 2020 2020 2020 2020 2020 7061  :.            pa
+0000fb10: 7374 5f6c 656e 6774 6820 3d20 7061 7374  st_length = past
+0000fb20: 5f6b 6579 5f76 616c 7565 735b 305d 5b30  _key_values[0][0
+0000fb30: 5d2e 7368 6170 655b 325d 0a0a 2020 2020  ].shape[2]..    
+0000fb40: 2020 2020 2020 2020 2320 536f 6d65 2067          # Some g
+0000fb50: 656e 6572 6174 696f 6e20 6d65 7468 6f64  eneration method
+0000fb60: 7320 616c 7265 6164 7920 7061 7373 206f  s already pass o
+0000fb70: 6e6c 7920 7468 6520 6c61 7374 2069 6e70  nly the last inp
+0000fb80: 7574 2049 440a 2020 2020 2020 2020 2020  ut ID.          
+0000fb90: 2020 6966 2069 6e70 7574 5f69 6473 2e73    if input_ids.s
+0000fba0: 6861 7065 5b31 5d20 3e20 7061 7374 5f6c  hape[1] > past_l
+0000fbb0: 656e 6774 683a 0a20 2020 2020 2020 2020  ength:.         
+0000fbc0: 2020 2020 2020 2072 656d 6f76 655f 7072         remove_pr
+0000fbd0: 6566 6978 5f6c 656e 6774 6820 3d20 7061  efix_length = pa
+0000fbe0: 7374 5f6c 656e 6774 680a 2020 2020 2020  st_length.      
+0000fbf0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0000fc00: 2020 2020 2020 2020 2020 2020 2320 4465              # De
+0000fc10: 6661 756c 7420 746f 206f 6c64 2062 6568  fault to old beh
+0000fc20: 6176 696f 723a 206b 6565 7020 6f6e 6c79  avior: keep only
+0000fc30: 2066 696e 616c 2049 440a 2020 2020 2020   final ID.      
+0000fc40: 2020 2020 2020 2020 2020 7265 6d6f 7665            remove
+0000fc50: 5f70 7265 6669 785f 6c65 6e67 7468 203d  _prefix_length =
+0000fc60: 2069 6e70 7574 5f69 6473 2e73 6861 7065   input_ids.shape
+0000fc70: 5b31 5d20 2d20 310a 0a20 2020 2020 2020  [1] - 1..       
+0000fc80: 2020 2020 2069 6e70 7574 5f69 6473 203d       input_ids =
+0000fc90: 2069 6e70 7574 5f69 6473 5b3a 2c20 7265   input_ids[:, re
+0000fca0: 6d6f 7665 5f70 7265 6669 785f 6c65 6e67  move_prefix_leng
+0000fcb0: 7468 3a5d 0a20 2020 2020 2020 2023 2066  th:].        # f
+0000fcc0: 6972 7374 2073 7465 702c 2064 6563 6f64  irst step, decod
+0000fcd0: 6572 5f63 6163 6865 645f 7374 6174 6573  er_cached_states
+0000fce0: 2061 7265 2065 6d70 7479 0a20 2020 2020   are empty.     
+0000fcf0: 2020 2072 6574 7572 6e20 7b0a 2020 2020     return {.    
+0000fd00: 2020 2020 2020 2020 2269 6e70 7574 5f69          "input_i
+0000fd10: 6473 223a 2069 6e70 7574 5f69 6473 2c20  ds": input_ids, 
+0000fd20: 2023 2065 6e63 6f64 6572 5f6f 7574 7075   # encoder_outpu
+0000fd30: 7473 2069 7320 6465 6669 6e65 642e 2069  ts is defined. i
+0000fd40: 6e70 7574 5f69 6473 206e 6f74 206e 6565  nput_ids not nee
+0000fd50: 6465 640a 2020 2020 2020 2020 2020 2020  ded.            
+0000fd60: 2261 7474 656e 7469 6f6e 5f6d 6173 6b22  "attention_mask"
+0000fd70: 3a20 6174 7465 6e74 696f 6e5f 6d61 736b  : attention_mask
+0000fd80: 2c0a 2020 2020 2020 2020 2020 2020 2270  ,.            "p
+0000fd90: 6173 745f 6b65 795f 7661 6c75 6573 223a  ast_key_values":
+0000fda0: 2070 6173 745f 6b65 795f 7661 6c75 6573   past_key_values
+0000fdb0: 2c0a 2020 2020 2020 2020 2020 2020 2275  ,.            "u
+0000fdc0: 7365 5f63 6163 6865 223a 2075 7365 5f63  se_cache": use_c
+0000fdd0: 6163 6865 2c0a 2020 2020 2020 2020 7d0a  ache,.        }.
+0000fde0: 0a20 2020 2040 7374 6174 6963 6d65 7468  .    @staticmeth
+0000fdf0: 6f64 0a20 2020 2064 6566 205f 7265 6f72  od.    def _reor
+0000fe00: 6465 725f 6361 6368 6528 7061 7374 5f6b  der_cache(past_k
+0000fe10: 6579 5f76 616c 7565 732c 2062 6561 6d5f  ey_values, beam_
+0000fe20: 6964 7829 3a0a 2020 2020 2020 2020 7265  idx):.        re
+0000fe30: 6f72 6465 7265 645f 7061 7374 203d 2028  ordered_past = (
+0000fe40: 290a 2020 2020 2020 2020 666f 7220 6c61  ).        for la
+0000fe50: 7965 725f 7061 7374 2069 6e20 7061 7374  yer_past in past
+0000fe60: 5f6b 6579 5f76 616c 7565 733a 0a20 2020  _key_values:.   
+0000fe70: 2020 2020 2020 2020 2072 656f 7264 6572           reorder
+0000fe80: 6564 5f70 6173 7420 2b3d 2028 0a20 2020  ed_past += (.   
+0000fe90: 2020 2020 2020 2020 2020 2020 2074 7570               tup
+0000fea0: 6c65 2870 6173 745f 7374 6174 652e 696e  le(past_state.in
+0000feb0: 6465 785f 7365 6c65 6374 2830 2c20 6265  dex_select(0, be
+0000fec0: 616d 5f69 6478 2920 666f 7220 7061 7374  am_idx) for past
+0000fed0: 5f73 7461 7465 2069 6e20 6c61 7965 725f  _state in layer_
+0000fee0: 7061 7374 292c 0a20 2020 2020 2020 2020  past),.         
+0000fef0: 2020 2029 0a20 2020 2020 2020 2072 6574     ).        ret
+0000ff00: 7572 6e20 7265 6f72 6465 7265 645f 7061  urn reordered_pa
+0000ff10: 7374 0a0a 5f5f 616c 6c5f 5f20 3d20 5b0a  st..__all__ = [.
+0000ff20: 2020 2020 2242 6c65 6e64 6572 626f 7453      "BlenderbotS
+0000ff30: 6d61 6c6c 466f 7243 6175 7361 6c4c 4d22  mallForCausalLM"
+0000ff40: 2c0a 2020 2020 2242 6c65 6e64 6572 626f  ,.    "Blenderbo
+0000ff50: 7453 6d61 6c6c 466f 7243 6f6e 6469 7469  tSmallForConditi
+0000ff60: 6f6e 616c 4765 6e65 7261 7469 6f6e 222c  onalGeneration",
+0000ff70: 0a20 2020 2022 426c 656e 6465 7262 6f74  .    "Blenderbot
+0000ff80: 536d 616c 6c4d 6f64 656c 222c 0a20 2020  SmallModel",.   
+0000ff90: 2022 426c 656e 6465 7262 6f74 536d 616c   "BlenderbotSmal
+0000ffa0: 6c50 7265 5472 6169 6e65 644d 6f64 656c  lPreTrainedModel
+0000ffb0: 222c 0a5d 0a                             ",.].
```

## mindnlp/transformers/models/blenderbot_small/tokenization_blenderbot_small.py

```diff
@@ -0,0 +1,563 @@
+00000000: 2320 636f 6469 6e67 3d75 7466 2d38 0a23  # coding=utf-8.#
+00000010: 2043 6f70 7972 6967 6874 2032 3032 3120   Copyright 2021 
+00000020: 5468 6520 4661 6365 626f 6f6b 2049 6e63  The Facebook Inc
+00000030: 2e20 616e 6420 5468 6520 4875 6767 696e  . and The Huggin
+00000040: 6746 6163 6520 496e 632e 2074 6561 6d2e  gFace Inc. team.
+00000050: 2041 6c6c 2072 6967 6874 7320 7265 7365   All rights rese
+00000060: 7276 6564 2e0a 230a 2320 4c69 6365 6e73  rved..#.# Licens
+00000070: 6564 2075 6e64 6572 2074 6865 2041 7061  ed under the Apa
+00000080: 6368 6520 4c69 6365 6e73 652c 2056 6572  che License, Ver
+00000090: 7369 6f6e 2032 2e30 2028 7468 6520 224c  sion 2.0 (the "L
+000000a0: 6963 656e 7365 2229 3b0a 2320 796f 7520  icense");.# you 
+000000b0: 6d61 7920 6e6f 7420 7573 6520 7468 6973  may not use this
+000000c0: 2066 696c 6520 6578 6365 7074 2069 6e20   file except in 
+000000d0: 636f 6d70 6c69 616e 6365 2077 6974 6820  compliance with 
+000000e0: 7468 6520 4c69 6365 6e73 652e 0a23 2059  the License..# Y
+000000f0: 6f75 206d 6179 206f 6274 6169 6e20 6120  ou may obtain a 
+00000100: 636f 7079 206f 6620 7468 6520 4c69 6365  copy of the Lice
+00000110: 6e73 6520 6174 0a23 0a23 2020 2020 2068  nse at.#.#     h
+00000120: 7474 703a 2f2f 7777 772e 6170 6163 6865  ttp://www.apache
+00000130: 2e6f 7267 2f6c 6963 656e 7365 732f 4c49  .org/licenses/LI
+00000140: 4345 4e53 452d 322e 300a 230a 2320 556e  CENSE-2.0.#.# Un
+00000150: 6c65 7373 2072 6571 7569 7265 6420 6279  less required by
+00000160: 2061 7070 6c69 6361 626c 6520 6c61 7720   applicable law 
+00000170: 6f72 2061 6772 6565 6420 746f 2069 6e20  or agreed to in 
+00000180: 7772 6974 696e 672c 2073 6f66 7477 6172  writing, softwar
+00000190: 650a 2320 6469 7374 7269 6275 7465 6420  e.# distributed 
+000001a0: 756e 6465 7220 7468 6520 4c69 6365 6e73  under the Licens
+000001b0: 6520 6973 2064 6973 7472 6962 7574 6564  e is distributed
+000001c0: 206f 6e20 616e 2022 4153 2049 5322 2042   on an "AS IS" B
+000001d0: 4153 4953 2c0a 2320 5749 5448 4f55 5420  ASIS,.# WITHOUT 
+000001e0: 5741 5252 414e 5449 4553 204f 5220 434f  WARRANTIES OR CO
+000001f0: 4e44 4954 494f 4e53 204f 4620 414e 5920  NDITIONS OF ANY 
+00000200: 4b49 4e44 2c20 6569 7468 6572 2065 7870  KIND, either exp
+00000210: 7265 7373 206f 7220 696d 706c 6965 642e  ress or implied.
+00000220: 0a23 2053 6565 2074 6865 204c 6963 656e  .# See the Licen
+00000230: 7365 2066 6f72 2074 6865 2073 7065 6369  se for the speci
+00000240: 6669 6320 6c61 6e67 7561 6765 2067 6f76  fic language gov
+00000250: 6572 6e69 6e67 2070 6572 6d69 7373 696f  erning permissio
+00000260: 6e73 2061 6e64 0a23 206c 696d 6974 6174  ns and.# limitat
+00000270: 696f 6e73 2075 6e64 6572 2074 6865 204c  ions under the L
+00000280: 6963 656e 7365 2e0a 2222 2254 6f6b 656e  icense.."""Token
+00000290: 697a 6174 696f 6e20 636c 6173 7320 666f  ization class fo
+000002a0: 7220 426c 656e 6465 7262 6f74 536d 616c  r BlenderbotSmal
+000002b0: 6c2e 2222 220a 0a69 6d70 6f72 7420 6a73  l."""..import js
+000002c0: 6f6e 0a69 6d70 6f72 7420 6f73 0a66 726f  on.import os.fro
+000002d0: 6d20 7479 7069 6e67 2069 6d70 6f72 7420  m typing import 
+000002e0: 4469 6374 2c20 4c69 7374 2c20 4f70 7469  Dict, List, Opti
+000002f0: 6f6e 616c 2c20 5475 706c 650a 0a69 6d70  onal, Tuple..imp
+00000300: 6f72 7420 7265 6765 7820 6173 2072 650a  ort regex as re.
+00000310: 0a66 726f 6d20 2e2e 2e74 6f6b 656e 697a  .from ...tokeniz
+00000320: 6174 696f 6e5f 7574 696c 7320 696d 706f  ation_utils impo
+00000330: 7274 2050 7265 5472 6169 6e65 6454 6f6b  rt PreTrainedTok
+00000340: 656e 697a 6572 0a66 726f 6d20 2e2e 2e2e  enizer.from ....
+00000350: 7574 696c 7320 696d 706f 7274 206c 6f67  utils import log
+00000360: 6769 6e67 0a0a 0a6c 6f67 6765 7220 3d20  ging...logger = 
+00000370: 6c6f 6767 696e 672e 6765 745f 6c6f 6767  logging.get_logg
+00000380: 6572 285f 5f6e 616d 655f 5f29 0a0a 0a56  er(__name__)...V
+00000390: 4f43 4142 5f46 494c 4553 5f4e 414d 4553  OCAB_FILES_NAMES
+000003a0: 203d 207b 0a20 2020 2022 766f 6361 625f   = {.    "vocab_
+000003b0: 6669 6c65 223a 2022 766f 6361 622e 6a73  file": "vocab.js
+000003c0: 6f6e 222c 0a20 2020 2022 6d65 7267 6573  on",.    "merges
+000003d0: 5f66 696c 6522 3a20 226d 6572 6765 732e  _file": "merges.
+000003e0: 7478 7422 2c0a 2020 2020 2274 6f6b 656e  txt",.    "token
+000003f0: 697a 6572 5f63 6f6e 6669 675f 6669 6c65  izer_config_file
+00000400: 223a 2022 746f 6b65 6e69 7a65 725f 636f  ": "tokenizer_co
+00000410: 6e66 6967 2e6a 736f 6e22 2c0a 7d0a 0a0a  nfig.json",.}...
+00000420: 6465 6620 6765 745f 7061 6972 7328 776f  def get_pairs(wo
+00000430: 7264 293a 0a20 2020 2022 2222 0a20 2020  rd):.    """.   
+00000440: 2052 6574 7572 6e20 7365 7420 6f66 2073   Return set of s
+00000450: 796d 626f 6c20 7061 6972 7320 696e 2061  ymbol pairs in a
+00000460: 2077 6f72 642e 0a0a 2020 2020 576f 7264   word...    Word
+00000470: 2069 7320 7265 7072 6573 656e 7465 6420   is represented 
+00000480: 6173 2074 7570 6c65 206f 6620 7379 6d62  as tuple of symb
+00000490: 6f6c 7320 2873 796d 626f 6c73 2062 6569  ols (symbols bei
+000004a0: 6e67 2076 6172 6961 626c 652d 6c65 6e67  ng variable-leng
+000004b0: 7468 2073 7472 696e 6773 292e 0a20 2020  th strings)..   
+000004c0: 2022 2222 0a20 2020 2070 6169 7273 203d   """.    pairs =
+000004d0: 2073 6574 2829 0a20 2020 2070 7265 765f   set().    prev_
+000004e0: 6368 6172 203d 2077 6f72 645b 305d 0a20  char = word[0]. 
+000004f0: 2020 2066 6f72 2063 6861 7220 696e 2077     for char in w
+00000500: 6f72 645b 313a 5d3a 0a20 2020 2020 2020  ord[1:]:.       
+00000510: 2070 6169 7273 2e61 6464 2828 7072 6576   pairs.add((prev
+00000520: 5f63 6861 722c 2063 6861 7229 290a 2020  _char, char)).  
+00000530: 2020 2020 2020 7072 6576 5f63 6861 7220        prev_char 
+00000540: 3d20 6368 6172 0a0a 2020 2020 7061 6972  = char..    pair
+00000550: 7320 3d20 7365 7428 7061 6972 7329 0a20  s = set(pairs). 
+00000560: 2020 2072 6574 7572 6e20 7061 6972 730a     return pairs.
+00000570: 0a0a 636c 6173 7320 426c 656e 6465 7262  ..class Blenderb
+00000580: 6f74 536d 616c 6c54 6f6b 656e 697a 6572  otSmallTokenizer
+00000590: 2850 7265 5472 6169 6e65 6454 6f6b 656e  (PreTrainedToken
+000005a0: 697a 6572 293a 0a20 2020 2022 2222 0a20  izer):.    """. 
+000005b0: 2020 2043 6f6e 7374 7275 6374 7320 6120     Constructs a 
+000005c0: 426c 656e 6465 7262 6f74 2d39 304d 2074  Blenderbot-90M t
+000005d0: 6f6b 656e 697a 6572 2062 6173 6564 206f  okenizer based o
+000005e0: 6e20 4250 4520 2842 7974 652d 5061 6972  n BPE (Byte-Pair
+000005f0: 2d45 6e63 6f64 696e 6729 0a0a 2020 2020  -Encoding)..    
+00000600: 5468 6973 2074 6f6b 656e 697a 6572 2069  This tokenizer i
+00000610: 6e68 6572 6974 7320 6672 6f6d 205b 6050  nherits from [`P
+00000620: 7265 5472 6169 6e65 6454 6f6b 656e 697a  reTrainedTokeniz
+00000630: 6572 605d 2077 6869 6368 2063 6f6e 7461  er`] which conta
+00000640: 696e 7320 6d6f 7374 206f 6620 7468 6520  ins most of the 
+00000650: 6d61 696e 206d 6574 686f 6473 2e20 5573  main methods. Us
+00000660: 6572 7320 7368 6f75 6c64 2072 6566 6572  ers should refer
+00000670: 2074 6f0a 2020 2020 7468 6520 7375 7065   to.    the supe
+00000680: 7263 6c61 7373 2066 6f72 206d 6f72 6520  rclass for more 
+00000690: 696e 666f 726d 6174 696f 6e20 7265 6761  information rega
+000006a0: 7264 696e 6720 6d65 7468 6f64 732e 0a0a  rding methods...
+000006b0: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+000006c0: 2020 766f 6361 625f 6669 6c65 2028 6073    vocab_file (`s
+000006d0: 7472 6029 3a0a 2020 2020 2020 2020 2020  tr`):.          
+000006e0: 2020 4669 6c65 2063 6f6e 7461 696e 696e    File containin
+000006f0: 6720 7468 6520 766f 6361 6275 6c61 7279  g the vocabulary
+00000700: 2e0a 2020 2020 2020 2020 6d65 7267 6573  ..        merges
+00000710: 5f66 696c 6520 2860 7374 7260 293a 0a20  _file (`str`):. 
+00000720: 2020 2020 2020 2020 2020 2050 6174 6820             Path 
+00000730: 746f 2074 6865 206d 6572 6765 7320 6669  to the merges fi
+00000740: 6c65 2e0a 2020 2020 2020 2020 626f 735f  le..        bos_
+00000750: 746f 6b65 6e20 2860 7374 7260 2c20 2a6f  token (`str`, *o
+00000760: 7074 696f 6e61 6c2a 2c20 6465 6661 756c  ptional*, defaul
+00000770: 7473 2074 6f20 6022 5f5f 7374 6172 745f  ts to `"__start_
+00000780: 5f22 6029 3a0a 2020 2020 2020 2020 2020  _"`):.          
+00000790: 2020 5468 6520 6265 6769 6e6e 696e 6720    The beginning 
+000007a0: 6f66 2073 656e 7465 6e63 6520 746f 6b65  of sentence toke
+000007b0: 6e2e 0a20 2020 2020 2020 2065 6f73 5f74  n..        eos_t
+000007c0: 6f6b 656e 2028 6073 7472 602c 202a 6f70  oken (`str`, *op
+000007d0: 7469 6f6e 616c 2a2c 2064 6566 6175 6c74  tional*, default
+000007e0: 7320 746f 2060 225f 5f65 6e64 5f5f 2260  s to `"__end__"`
+000007f0: 293a 0a20 2020 2020 2020 2020 2020 2054  ):.            T
+00000800: 6865 2065 6e64 206f 6620 7365 6e74 656e  he end of senten
+00000810: 6365 2074 6f6b 656e 2e0a 2020 2020 2020  ce token..      
+00000820: 2020 756e 6b5f 746f 6b65 6e20 2860 7374    unk_token (`st
+00000830: 7260 2c20 2a6f 7074 696f 6e61 6c2a 2c20  r`, *optional*, 
+00000840: 6465 6661 756c 7473 2074 6f20 6022 5f5f  defaults to `"__
+00000850: 756e 6b5f 5f22 6029 3a0a 2020 2020 2020  unk__"`):.      
+00000860: 2020 2020 2020 5468 6520 756e 6b6e 6f77        The unknow
+00000870: 6e20 746f 6b65 6e2e 2041 2074 6f6b 656e  n token. A token
+00000880: 2074 6861 7420 6973 206e 6f74 2069 6e20   that is not in 
+00000890: 7468 6520 766f 6361 6275 6c61 7279 2063  the vocabulary c
+000008a0: 616e 6e6f 7420 6265 2063 6f6e 7665 7274  annot be convert
+000008b0: 6564 2074 6f20 616e 2049 4420 616e 6420  ed to an ID and 
+000008c0: 6973 2073 6574 2074 6f20 6265 2074 6869  is set to be thi
+000008d0: 730a 2020 2020 2020 2020 2020 2020 746f  s.            to
+000008e0: 6b65 6e20 696e 7374 6561 642e 0a20 2020  ken instead..   
+000008f0: 2020 2020 2070 6164 5f74 6f6b 656e 2028       pad_token (
+00000900: 6073 7472 602c 202a 6f70 7469 6f6e 616c  `str`, *optional
+00000910: 2a2c 2064 6566 6175 6c74 7320 746f 2060  *, defaults to `
+00000920: 225f 5f6e 756c 6c5f 5f22 6029 3a0a 2020  "__null__"`):.  
+00000930: 2020 2020 2020 2020 2020 5468 6520 746f            The to
+00000940: 6b65 6e20 7573 6564 2066 6f72 2070 6164  ken used for pad
+00000950: 6469 6e67 2c20 666f 7220 6578 616d 706c  ding, for exampl
+00000960: 6520 7768 656e 2062 6174 6368 696e 6720  e when batching 
+00000970: 7365 7175 656e 6365 7320 6f66 2064 6966  sequences of dif
+00000980: 6665 7265 6e74 206c 656e 6774 6873 2e0a  ferent lengths..
+00000990: 2020 2020 2020 2020 6b77 6172 6773 2028          kwargs (
+000009a0: 2a6f 7074 696f 6e61 6c2a 293a 0a20 2020  *optional*):.   
+000009b0: 2020 2020 2020 2020 2041 6464 6974 696f           Additio
+000009c0: 6e61 6c20 6b65 7977 6f72 6420 6172 6775  nal keyword argu
+000009d0: 6d65 6e74 7320 7061 7373 6564 2061 6c6f  ments passed alo
+000009e0: 6e67 2074 6f20 5b60 5072 6554 7261 696e  ng to [`PreTrain
+000009f0: 6564 546f 6b65 6e69 7a65 7260 5d0a 2020  edTokenizer`].  
+00000a00: 2020 2222 220a 0a20 2020 2076 6f63 6162    """..    vocab
+00000a10: 5f66 696c 6573 5f6e 616d 6573 203d 2056  _files_names = V
+00000a20: 4f43 4142 5f46 494c 4553 5f4e 414d 4553  OCAB_FILES_NAMES
+00000a30: 0a20 2020 206d 6f64 656c 5f69 6e70 7574  .    model_input
+00000a40: 5f6e 616d 6573 203d 205b 2269 6e70 7574  _names = ["input
+00000a50: 5f69 6473 222c 2022 6174 7465 6e74 696f  _ids", "attentio
+00000a60: 6e5f 6d61 736b 225d 0a0a 2020 2020 6465  n_mask"]..    de
+00000a70: 6620 5f5f 696e 6974 5f5f 280a 2020 2020  f __init__(.    
+00000a80: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+00000a90: 2020 766f 6361 625f 6669 6c65 2c0a 2020    vocab_file,.  
+00000aa0: 2020 2020 2020 6d65 7267 6573 5f66 696c        merges_fil
+00000ab0: 652c 0a20 2020 2020 2020 2062 6f73 5f74  e,.        bos_t
+00000ac0: 6f6b 656e 3d22 5f5f 7374 6172 745f 5f22  oken="__start__"
+00000ad0: 2c0a 2020 2020 2020 2020 656f 735f 746f  ,.        eos_to
+00000ae0: 6b65 6e3d 225f 5f65 6e64 5f5f 222c 0a20  ken="__end__",. 
+00000af0: 2020 2020 2020 2075 6e6b 5f74 6f6b 656e         unk_token
+00000b00: 3d22 5f5f 756e 6b5f 5f22 2c0a 2020 2020  ="__unk__",.    
+00000b10: 2020 2020 7061 645f 746f 6b65 6e3d 225f      pad_token="_
+00000b20: 5f6e 756c 6c5f 5f22 2c0a 2020 2020 2020  _null__",.      
+00000b30: 2020 2a2a 6b77 6172 6773 2c0a 2020 2020    **kwargs,.    
+00000b40: 293a 0a20 2020 2020 2020 2077 6974 6820  ):.        with 
+00000b50: 6f70 656e 2876 6f63 6162 5f66 696c 652c  open(vocab_file,
+00000b60: 2065 6e63 6f64 696e 673d 2275 7466 2d38   encoding="utf-8
+00000b70: 2229 2061 7320 766f 6361 625f 6861 6e64  ") as vocab_hand
+00000b80: 6c65 3a0a 2020 2020 2020 2020 2020 2020  le:.            
+00000b90: 7365 6c66 2e65 6e63 6f64 6572 203d 206a  self.encoder = j
+00000ba0: 736f 6e2e 6c6f 6164 2876 6f63 6162 5f68  son.load(vocab_h
+00000bb0: 616e 646c 6529 0a20 2020 2020 2020 2073  andle).        s
+00000bc0: 656c 662e 6465 636f 6465 7220 3d20 7b76  elf.decoder = {v
+00000bd0: 3a20 6b20 666f 7220 6b2c 2076 2069 6e20  : k for k, v in 
+00000be0: 7365 6c66 2e65 6e63 6f64 6572 2e69 7465  self.encoder.ite
+00000bf0: 6d73 2829 7d0a 2020 2020 2020 2020 7769  ms()}.        wi
+00000c00: 7468 206f 7065 6e28 6d65 7267 6573 5f66  th open(merges_f
+00000c10: 696c 652c 2065 6e63 6f64 696e 673d 2275  ile, encoding="u
+00000c20: 7466 2d38 2229 2061 7320 6d65 7267 6573  tf-8") as merges
+00000c30: 5f68 616e 646c 653a 0a20 2020 2020 2020  _handle:.       
+00000c40: 2020 2020 206d 6572 6765 7320 3d20 6d65       merges = me
+00000c50: 7267 6573 5f68 616e 646c 652e 7265 6164  rges_handle.read
+00000c60: 2829 2e73 706c 6974 2822 5c6e 2229 5b31  ().split("\n")[1
+00000c70: 3a2d 315d 0a20 2020 2020 2020 206d 6572  :-1].        mer
+00000c80: 6765 7320 3d20 5b74 7570 6c65 286d 6572  ges = [tuple(mer
+00000c90: 6765 2e73 706c 6974 2829 2920 666f 7220  ge.split()) for 
+00000ca0: 6d65 7267 6520 696e 206d 6572 6765 735d  merge in merges]
+00000cb0: 0a20 2020 2020 2020 2073 656c 662e 6270  .        self.bp
+00000cc0: 655f 7261 6e6b 7320 3d20 6469 6374 287a  e_ranks = dict(z
+00000cd0: 6970 286d 6572 6765 732c 2072 616e 6765  ip(merges, range
+00000ce0: 286c 656e 286d 6572 6765 7329 2929 290a  (len(merges)))).
+00000cf0: 2020 2020 2020 2020 7365 6c66 2e63 6163          self.cac
+00000d00: 6865 203d 207b 7d0a 2020 2020 2020 2020  he = {}.        
+00000d10: 7375 7065 7228 292e 5f5f 696e 6974 5f5f  super().__init__
+00000d20: 2875 6e6b 5f74 6f6b 656e 3d75 6e6b 5f74  (unk_token=unk_t
+00000d30: 6f6b 656e 2c20 626f 735f 746f 6b65 6e3d  oken, bos_token=
+00000d40: 626f 735f 746f 6b65 6e2c 2065 6f73 5f74  bos_token, eos_t
+00000d50: 6f6b 656e 3d65 6f73 5f74 6f6b 656e 2c20  oken=eos_token, 
+00000d60: 7061 645f 746f 6b65 6e3d 7061 645f 746f  pad_token=pad_to
+00000d70: 6b65 6e2c 202a 2a6b 7761 7267 7329 0a0a  ken, **kwargs)..
+00000d80: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
+00000d90: 2020 6465 6620 766f 6361 625f 7369 7a65    def vocab_size
+00000da0: 2873 656c 6629 202d 3e20 696e 743a 0a20  (self) -> int:. 
+00000db0: 2020 2020 2020 2072 6574 7572 6e20 6c65         return le
+00000dc0: 6e28 7365 6c66 2e65 6e63 6f64 6572 290a  n(self.encoder).
+00000dd0: 0a20 2020 2064 6566 2067 6574 5f76 6f63  .    def get_voc
+00000de0: 6162 2873 656c 6629 202d 3e20 4469 6374  ab(self) -> Dict
+00000df0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+00000e00: 2064 6963 7428 7365 6c66 2e65 6e63 6f64   dict(self.encod
+00000e10: 6572 2c20 2a2a 7365 6c66 2e61 6464 6564  er, **self.added
+00000e20: 5f74 6f6b 656e 735f 656e 636f 6465 7229  _tokens_encoder)
+00000e30: 0a0a 2020 2020 6465 6620 6270 6528 7365  ..    def bpe(se
+00000e40: 6c66 2c20 746f 6b65 6e3a 2073 7472 2920  lf, token: str) 
+00000e50: 2d3e 2073 7472 3a0a 2020 2020 2020 2020  -> str:.        
+00000e60: 6966 2074 6f6b 656e 2069 6e20 7365 6c66  if token in self
+00000e70: 2e63 6163 6865 3a0a 2020 2020 2020 2020  .cache:.        
+00000e80: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+00000e90: 6361 6368 655b 746f 6b65 6e5d 0a20 2020  cache[token].   
+00000ea0: 2020 2020 2074 6f6b 656e 203d 2072 652e       token = re.
+00000eb0: 7375 6228 2228 5b2e 2c21 3f28 295d 2922  sub("([.,!?()])"
+00000ec0: 2c20 7222 205c 3122 2c20 746f 6b65 6e29  , r" \1", token)
+00000ed0: 0a20 2020 2020 2020 2074 6f6b 656e 203d  .        token =
+00000ee0: 2072 652e 7375 6228 2228 2729 222c 2072   re.sub("(')", r
+00000ef0: 2220 5c31 2022 2c20 746f 6b65 6e29 0a20  " \1 ", token). 
+00000f00: 2020 2020 2020 2074 6f6b 656e 203d 2072         token = r
+00000f10: 652e 7375 6228 7222 5c73 7b32 2c7d 222c  e.sub(r"\s{2,}",
+00000f20: 2022 2022 2c20 746f 6b65 6e29 0a20 2020   " ", token).   
+00000f30: 2020 2020 2069 6620 225c 6e22 2069 6e20       if "\n" in 
+00000f40: 746f 6b65 6e3a 0a20 2020 2020 2020 2020  token:.         
+00000f50: 2020 2074 6f6b 656e 203d 2074 6f6b 656e     token = token
+00000f60: 2e72 6570 6c61 6365 2822 5c6e 222c 2022  .replace("\n", "
+00000f70: 205f 5f6e 6577 6c6e 5f5f 2229 0a0a 2020   __newln__")..  
+00000f80: 2020 2020 2020 746f 6b65 6e73 203d 2074        tokens = t
+00000f90: 6f6b 656e 2e73 706c 6974 2822 2022 290a  oken.split(" ").
+00000fa0: 2020 2020 2020 2020 776f 7264 7320 3d20          words = 
+00000fb0: 5b5d 0a20 2020 2020 2020 2066 6f72 2074  [].        for t
+00000fc0: 6f6b 656e 2069 6e20 746f 6b65 6e73 3a0a  oken in tokens:.
+00000fd0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00000fe0: 6f74 206c 656e 2874 6f6b 656e 293a 2023  ot len(token): #
+00000ff0: 2070 796c 696e 743a 2064 6973 6162 6c65   pylint: disable
+00001000: 3d75 7365 2d69 6d70 6c69 6369 742d 626f  =use-implicit-bo
+00001010: 6f6c 6561 6e65 7373 2d6e 6f74 2d6c 656e  oleaness-not-len
+00001020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00001030: 2063 6f6e 7469 6e75 650a 0a20 2020 2020   continue..     
+00001040: 2020 2020 2020 2074 6f6b 656e 203d 2074         token = t
+00001050: 6f6b 656e 2e6c 6f77 6572 2829 0a20 2020  oken.lower().   
+00001060: 2020 2020 2020 2020 2077 6f72 6420 3d20           word = 
+00001070: 7475 706c 6528 746f 6b65 6e29 0a20 2020  tuple(token).   
+00001080: 2020 2020 2020 2020 2077 6f72 6420 3d20           word = 
+00001090: 7475 706c 6528 6c69 7374 2877 6f72 645b  tuple(list(word[
+000010a0: 3a2d 315d 2920 2b20 5b77 6f72 645b 2d31  :-1]) + [word[-1
+000010b0: 5d20 2b20 223c 2f77 3e22 5d29 0a20 2020  ] + "</w>"]).   
+000010c0: 2020 2020 2020 2020 2070 6169 7273 203d           pairs =
+000010d0: 2067 6574 5f70 6169 7273 2877 6f72 6429   get_pairs(word)
+000010e0: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+000010f0: 206e 6f74 2070 6169 7273 3a0a 2020 2020   not pairs:.    
+00001100: 2020 2020 2020 2020 2020 2020 776f 7264              word
+00001110: 732e 6170 7065 6e64 2874 6f6b 656e 290a  s.append(token).
+00001120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001130: 636f 6e74 696e 7565 0a0a 2020 2020 2020  continue..      
+00001140: 2020 2020 2020 7768 696c 6520 5472 7565        while True
+00001150: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00001160: 2020 6269 6772 616d 203d 206d 696e 2870    bigram = min(p
+00001170: 6169 7273 2c20 6b65 793d 6c61 6d62 6461  airs, key=lambda
+00001180: 2070 6169 723a 2073 656c 662e 6270 655f   pair: self.bpe_
+00001190: 7261 6e6b 732e 6765 7428 7061 6972 2c20  ranks.get(pair, 
+000011a0: 666c 6f61 7428 2269 6e66 2229 2929 0a20  float("inf"))). 
+000011b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000011c0: 6620 6269 6772 616d 206e 6f74 2069 6e20  f bigram not in 
+000011d0: 7365 6c66 2e62 7065 5f72 616e 6b73 3a0a  self.bpe_ranks:.
+000011e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000011f0: 2020 2020 6272 6561 6b0a 2020 2020 2020      break.      
+00001200: 2020 2020 2020 2020 2020 6669 7273 742c            first,
+00001210: 2073 6563 6f6e 6420 3d20 6269 6772 616d   second = bigram
+00001220: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00001230: 206e 6577 5f77 6f72 6420 3d20 5b5d 0a20   new_word = []. 
+00001240: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00001250: 203d 2030 0a0a 2020 2020 2020 2020 2020   = 0..          
+00001260: 2020 2020 2020 7768 696c 6520 6920 3c20        while i < 
+00001270: 6c65 6e28 776f 7264 293a 0a20 2020 2020  len(word):.     
+00001280: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00001290: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+000012a0: 2020 2020 2020 2020 2020 2020 6a20 3d20              j = 
+000012b0: 776f 7264 2e69 6e64 6578 2866 6972 7374  word.index(first
+000012c0: 2c20 6929 0a20 2020 2020 2020 2020 2020  , i).           
+000012d0: 2020 2020 2020 2020 2020 2020 206e 6577               new
+000012e0: 5f77 6f72 642e 6578 7465 6e64 2877 6f72  _word.extend(wor
+000012f0: 645b 693a 6a5d 290a 2020 2020 2020 2020  d[i:j]).        
+00001300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001310: 6920 3d20 6a0a 2020 2020 2020 2020 2020  i = j.          
+00001320: 2020 2020 2020 2020 2020 6578 6365 7074            except
+00001330: 2056 616c 7565 4572 726f 723a 0a20 2020   ValueError:.   
+00001340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001350: 2020 2020 206e 6577 5f77 6f72 642e 6578       new_word.ex
+00001360: 7465 6e64 2877 6f72 645b 693a 5d29 0a20  tend(word[i:]). 
+00001370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001380: 2020 2020 2020 2062 7265 616b 0a0a 2020         break..  
+00001390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000013a0: 2020 6966 2077 6f72 645b 695d 203d 3d20    if word[i] == 
+000013b0: 6669 7273 7420 616e 6420 6920 3c20 6c65  first and i < le
+000013c0: 6e28 776f 7264 2920 2d20 3120 616e 6420  n(word) - 1 and 
+000013d0: 776f 7264 5b69 202b 2031 5d20 3d3d 2073  word[i + 1] == s
+000013e0: 6563 6f6e 643a 0a20 2020 2020 2020 2020  econd:.         
+000013f0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00001400: 6577 5f77 6f72 642e 6170 7065 6e64 2866  ew_word.append(f
+00001410: 6972 7374 202b 2073 6563 6f6e 6429 0a20  irst + second). 
+00001420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001430: 2020 2020 2020 2069 202b 3d20 320a 2020         i += 2.  
+00001440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001450: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00001460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001470: 6e65 775f 776f 7264 2e61 7070 656e 6428  new_word.append(
+00001480: 776f 7264 5b69 5d29 0a20 2020 2020 2020  word[i]).       
+00001490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000014a0: 2069 202b 3d20 310a 2020 2020 2020 2020   i += 1.        
+000014b0: 2020 2020 2020 2020 6e65 775f 776f 7264          new_word
+000014c0: 203d 2074 7570 6c65 286e 6577 5f77 6f72   = tuple(new_wor
+000014d0: 6429 0a20 2020 2020 2020 2020 2020 2020  d).             
+000014e0: 2020 2077 6f72 6420 3d20 6e65 775f 776f     word = new_wo
+000014f0: 7264 0a20 2020 2020 2020 2020 2020 2020  rd.             
+00001500: 2020 2069 6620 6c65 6e28 776f 7264 2920     if len(word) 
+00001510: 3d3d 2031 3a0a 2020 2020 2020 2020 2020  == 1:.          
+00001520: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
+00001530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001540: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00001550: 2020 2020 2020 2020 2020 7061 6972 7320            pairs 
+00001560: 3d20 6765 745f 7061 6972 7328 776f 7264  = get_pairs(word
+00001570: 290a 2020 2020 2020 2020 2020 2020 776f  ).            wo
+00001580: 7264 203d 2022 4040 2022 2e6a 6f69 6e28  rd = "@@ ".join(
+00001590: 776f 7264 290a 2020 2020 2020 2020 2020  word).          
+000015a0: 2020 776f 7264 203d 2077 6f72 645b 3a2d    word = word[:-
+000015b0: 345d 0a0a 2020 2020 2020 2020 2020 2020  4]..            
+000015c0: 7365 6c66 2e63 6163 6865 5b74 6f6b 656e  self.cache[token
+000015d0: 5d20 3d20 776f 7264 0a20 2020 2020 2020  ] = word.       
+000015e0: 2020 2020 2077 6f72 6473 2e61 7070 656e       words.appen
+000015f0: 6428 776f 7264 290a 2020 2020 2020 2020  d(word).        
+00001600: 7265 7475 726e 2022 2022 2e6a 6f69 6e28  return " ".join(
+00001610: 776f 7264 7329 0a0a 2020 2020 6465 6620  words)..    def 
+00001620: 5f74 6f6b 656e 697a 6528 7365 6c66 2c20  _tokenize(self, 
+00001630: 7465 7874 3a20 7374 7229 202d 3e20 4c69  text: str) -> Li
+00001640: 7374 5b73 7472 5d3a 0a20 2020 2020 2020  st[str]:.       
+00001650: 2022 2222 5370 6c69 7420 6120 7374 7269   """Split a stri
+00001660: 6e67 2069 6e74 6f20 746f 6b65 6e73 2075  ng into tokens u
+00001670: 7369 6e67 2042 5045 2e22 2222 0a20 2020  sing BPE.""".   
+00001680: 2020 2020 2073 706c 6974 5f74 6f6b 656e       split_token
+00001690: 7320 3d20 5b5d 0a0a 2020 2020 2020 2020  s = []..        
+000016a0: 776f 7264 7320 3d20 7265 2e66 696e 6461  words = re.finda
+000016b0: 6c6c 2872 225c 532b 5c6e 3f22 2c20 7465  ll(r"\S+\n?", te
+000016c0: 7874 290a 0a20 2020 2020 2020 2066 6f72  xt)..        for
+000016d0: 2074 6f6b 656e 2069 6e20 776f 7264 733a   token in words:
+000016e0: 0a20 2020 2020 2020 2020 2020 2073 706c  .            spl
+000016f0: 6974 5f74 6f6b 656e 732e 6578 7465 6e64  it_tokens.extend
+00001700: 286c 6973 7428 7365 6c66 2e62 7065 2874  (list(self.bpe(t
+00001710: 6f6b 656e 292e 7370 6c69 7428 2220 2229  oken).split(" ")
+00001720: 2929 0a20 2020 2020 2020 2072 6574 7572  )).        retur
+00001730: 6e20 7370 6c69 745f 746f 6b65 6e73 0a0a  n split_tokens..
+00001740: 2020 2020 6465 6620 5f63 6f6e 7665 7274      def _convert
+00001750: 5f74 6f6b 656e 5f74 6f5f 6964 2873 656c  _token_to_id(sel
+00001760: 662c 2074 6f6b 656e 3a20 7374 7229 202d  f, token: str) -
+00001770: 3e20 696e 743a 0a20 2020 2020 2020 2022  > int:.        "
+00001780: 2222 436f 6e76 6572 7473 2061 2074 6f6b  ""Converts a tok
+00001790: 656e 2074 6f20 616e 2069 6420 7573 696e  en to an id usin
+000017a0: 6720 7468 6520 766f 6361 622e 2222 220a  g the vocab.""".
+000017b0: 2020 2020 2020 2020 746f 6b65 6e20 3d20          token = 
+000017c0: 746f 6b65 6e2e 6c6f 7765 7228 290a 2020  token.lower().  
+000017d0: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+000017e0: 662e 656e 636f 6465 722e 6765 7428 746f  f.encoder.get(to
+000017f0: 6b65 6e2c 2073 656c 662e 656e 636f 6465  ken, self.encode
+00001800: 722e 6765 7428 7365 6c66 2e75 6e6b 5f74  r.get(self.unk_t
+00001810: 6f6b 656e 2929 0a0a 2020 2020 6465 6620  oken))..    def 
+00001820: 5f63 6f6e 7665 7274 5f69 645f 746f 5f74  _convert_id_to_t
+00001830: 6f6b 656e 2873 656c 662c 2069 6e64 6578  oken(self, index
+00001840: 3a20 696e 7429 202d 3e20 7374 723a 0a20  : int) -> str:. 
+00001850: 2020 2020 2020 2022 2222 436f 6e76 6572         """Conver
+00001860: 7473 2061 6e20 696e 6465 7820 2869 6e74  ts an index (int
+00001870: 6567 6572 2920 696e 2061 2074 6f6b 656e  eger) in a token
+00001880: 2028 7374 7229 2075 7369 6e67 2074 6865   (str) using the
+00001890: 2076 6f63 6162 2e22 2222 0a20 2020 2020   vocab.""".     
+000018a0: 2020 2072 6574 7572 6e20 7365 6c66 2e64     return self.d
+000018b0: 6563 6f64 6572 2e67 6574 2869 6e64 6578  ecoder.get(index
+000018c0: 2c20 7365 6c66 2e75 6e6b 5f74 6f6b 656e  , self.unk_token
+000018d0: 290a 0a20 2020 2064 6566 2063 6f6e 7665  )..    def conve
+000018e0: 7274 5f74 6f6b 656e 735f 746f 5f73 7472  rt_tokens_to_str
+000018f0: 696e 6728 7365 6c66 2c20 746f 6b65 6e73  ing(self, tokens
+00001900: 3a20 4c69 7374 5b73 7472 5d29 202d 3e20  : List[str]) -> 
+00001910: 7374 723a 0a20 2020 2020 2020 2022 2222  str:.        """
+00001920: 436f 6e76 6572 7473 2061 2073 6571 7565  Converts a seque
+00001930: 6e63 6520 6f66 2074 6f6b 656e 7320 696e  nce of tokens in
+00001940: 2061 2073 696e 676c 6520 7374 7269 6e67   a single string
+00001950: 2e22 2222 0a20 2020 2020 2020 206f 7574  .""".        out
+00001960: 5f73 7472 696e 6720 3d20 2220 222e 6a6f  _string = " ".jo
+00001970: 696e 2874 6f6b 656e 7329 2e72 6570 6c61  in(tokens).repla
+00001980: 6365 2822 4040 2022 2c20 2222 292e 7374  ce("@@ ", "").st
+00001990: 7269 7028 290a 2020 2020 2020 2020 7265  rip().        re
+000019a0: 7475 726e 206f 7574 5f73 7472 696e 670a  turn out_string.
+000019b0: 0a20 2020 2064 6566 2073 6176 655f 766f  .    def save_vo
+000019c0: 6361 6275 6c61 7279 2873 656c 662c 2073  cabulary(self, s
+000019d0: 6176 655f 6469 7265 6374 6f72 793a 2073  ave_directory: s
+000019e0: 7472 2c20 6669 6c65 6e61 6d65 5f70 7265  tr, filename_pre
+000019f0: 6669 783a 204f 7074 696f 6e61 6c5b 7374  fix: Optional[st
+00001a00: 725d 203d 204e 6f6e 6529 202d 3e20 5475  r] = None) -> Tu
+00001a10: 706c 655b 7374 725d 3a0a 2020 2020 2020  ple[str]:.      
+00001a20: 2020 6966 206e 6f74 206f 732e 7061 7468    if not os.path
+00001a30: 2e69 7364 6972 2873 6176 655f 6469 7265  .isdir(save_dire
+00001a40: 6374 6f72 7929 3a0a 2020 2020 2020 2020  ctory):.        
+00001a50: 2020 2020 6c6f 6767 6572 2e65 7272 6f72      logger.error
+00001a60: 2866 2256 6f63 6162 756c 6172 7920 7061  (f"Vocabulary pa
+00001a70: 7468 2028 7b73 6176 655f 6469 7265 6374  th ({save_direct
+00001a80: 6f72 797d 2920 7368 6f75 6c64 2062 6520  ory}) should be 
+00001a90: 6120 6469 7265 6374 6f72 7922 290a 2020  a directory").  
+00001aa0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00001ab0: 0a20 2020 2020 2020 2076 6f63 6162 5f66  .        vocab_f
+00001ac0: 696c 6520 3d20 6f73 2e70 6174 682e 6a6f  ile = os.path.jo
+00001ad0: 696e 280a 2020 2020 2020 2020 2020 2020  in(.            
+00001ae0: 7361 7665 5f64 6972 6563 746f 7279 2c20  save_directory, 
+00001af0: 2866 696c 656e 616d 655f 7072 6566 6978  (filename_prefix
+00001b00: 202b 2022 2d22 2069 6620 6669 6c65 6e61   + "-" if filena
+00001b10: 6d65 5f70 7265 6669 7820 656c 7365 2022  me_prefix else "
+00001b20: 2229 202b 2056 4f43 4142 5f46 494c 4553  ") + VOCAB_FILES
+00001b30: 5f4e 414d 4553 5b22 766f 6361 625f 6669  _NAMES["vocab_fi
+00001b40: 6c65 225d 0a20 2020 2020 2020 2029 0a20  le"].        ). 
+00001b50: 2020 2020 2020 206d 6572 6765 5f66 696c         merge_fil
+00001b60: 6520 3d20 6f73 2e70 6174 682e 6a6f 696e  e = os.path.join
+00001b70: 280a 2020 2020 2020 2020 2020 2020 7361  (.            sa
+00001b80: 7665 5f64 6972 6563 746f 7279 2c20 2866  ve_directory, (f
+00001b90: 696c 656e 616d 655f 7072 6566 6978 202b  ilename_prefix +
+00001ba0: 2022 2d22 2069 6620 6669 6c65 6e61 6d65   "-" if filename
+00001bb0: 5f70 7265 6669 7820 656c 7365 2022 2229  _prefix else "")
+00001bc0: 202b 2056 4f43 4142 5f46 494c 4553 5f4e   + VOCAB_FILES_N
+00001bd0: 414d 4553 5b22 6d65 7267 6573 5f66 696c  AMES["merges_fil
+00001be0: 6522 5d0a 2020 2020 2020 2020 290a 0a20  e"].        ).. 
+00001bf0: 2020 2020 2020 2077 6974 6820 6f70 656e         with open
+00001c00: 2876 6f63 6162 5f66 696c 652c 2022 7722  (vocab_file, "w"
+00001c10: 2c20 656e 636f 6469 6e67 3d22 7574 662d  , encoding="utf-
+00001c20: 3822 2920 6173 2066 3a0a 2020 2020 2020  8") as f:.      
+00001c30: 2020 2020 2020 662e 7772 6974 6528 6a73        f.write(js
+00001c40: 6f6e 2e64 756d 7073 2873 656c 662e 656e  on.dumps(self.en
+00001c50: 636f 6465 722c 2069 6e64 656e 743d 322c  coder, indent=2,
+00001c60: 2073 6f72 745f 6b65 7973 3d54 7275 652c   sort_keys=True,
+00001c70: 2065 6e73 7572 655f 6173 6369 693d 4661   ensure_ascii=Fa
+00001c80: 6c73 6529 202b 2022 5c6e 2229 0a0a 2020  lse) + "\n")..  
+00001c90: 2020 2020 2020 696e 6465 7820 3d20 300a        index = 0.
+00001ca0: 2020 2020 2020 2020 7769 7468 206f 7065          with ope
+00001cb0: 6e28 6d65 7267 655f 6669 6c65 2c20 2277  n(merge_file, "w
+00001cc0: 222c 2065 6e63 6f64 696e 673d 2275 7466  ", encoding="utf
+00001cd0: 2d38 2229 2061 7320 7772 6974 6572 3a0a  -8") as writer:.
+00001ce0: 2020 2020 2020 2020 2020 2020 7772 6974              writ
+00001cf0: 6572 2e77 7269 7465 2822 2376 6572 7369  er.write("#versi
+00001d00: 6f6e 3a20 302e 325c 6e22 290a 2020 2020  on: 0.2\n").    
+00001d10: 2020 2020 2020 2020 666f 7220 6270 655f          for bpe_
+00001d20: 746f 6b65 6e73 2c20 746f 6b65 6e5f 696e  tokens, token_in
+00001d30: 6465 7820 696e 2073 6f72 7465 6428 7365  dex in sorted(se
+00001d40: 6c66 2e62 7065 5f72 616e 6b73 2e69 7465  lf.bpe_ranks.ite
+00001d50: 6d73 2829 2c20 6b65 793d 6c61 6d62 6461  ms(), key=lambda
+00001d60: 206b 763a 206b 765b 315d 293a 0a20 2020   kv: kv[1]):.   
+00001d70: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00001d80: 696e 6465 7820 213d 2074 6f6b 656e 5f69  index != token_i
+00001d90: 6e64 6578 3a0a 2020 2020 2020 2020 2020  ndex:.          
+00001da0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+00001db0: 2e77 6172 6e69 6e67 280a 2020 2020 2020  .warning(.      
+00001dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001dd0: 2020 6622 5361 7669 6e67 2076 6f63 6162    f"Saving vocab
+00001de0: 756c 6172 7920 746f 207b 6d65 7267 655f  ulary to {merge_
+00001df0: 6669 6c65 7d3a 2042 5045 206d 6572 6765  file}: BPE merge
+00001e00: 2069 6e64 6963 6573 2061 7265 206e 6f74   indices are not
+00001e10: 2063 6f6e 7365 6375 7469 7665 2e22 0a20   consecutive.". 
+00001e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001e30: 2020 2020 2020 2022 2050 6c65 6173 6520         " Please 
+00001e40: 6368 6563 6b20 7468 6174 2074 6865 2074  check that the t
+00001e50: 6f6b 656e 697a 6572 2069 7320 6e6f 7420  okenizer is not 
+00001e60: 636f 7272 7570 7465 6421 220a 2020 2020  corrupted!".    
+00001e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001e80: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00001e90: 2020 2020 2020 696e 6465 7820 3d20 746f        index = to
+00001ea0: 6b65 6e5f 696e 6465 780a 2020 2020 2020  ken_index.      
+00001eb0: 2020 2020 2020 2020 2020 7772 6974 6572            writer
+00001ec0: 2e77 7269 7465 2822 2022 2e6a 6f69 6e28  .write(" ".join(
+00001ed0: 6270 655f 746f 6b65 6e73 2920 2b20 225c  bpe_tokens) + "\
+00001ee0: 6e22 290a 2020 2020 2020 2020 2020 2020  n").            
+00001ef0: 2020 2020 696e 6465 7820 2b3d 2031 0a0a      index += 1..
+00001f00: 2020 2020 2020 2020 7265 7475 726e 2076          return v
+00001f10: 6f63 6162 5f66 696c 652c 206d 6572 6765  ocab_file, merge
+00001f20: 5f66 696c 650a 0a20 2020 2040 7072 6f70  _file..    @prop
+00001f30: 6572 7479 0a20 2020 2023 2043 6f70 6965  erty.    # Copie
+00001f40: 6420 6672 6f6d 2074 7261 6e73 666f 726d  d from transform
+00001f50: 6572 732e 6d6f 6465 6c73 2e62 6c65 6e64  ers.models.blend
+00001f60: 6572 626f 742e 746f 6b65 6e69 7a61 7469  erbot.tokenizati
+00001f70: 6f6e 5f62 6c65 6e64 6572 626f 742e 426c  on_blenderbot.Bl
+00001f80: 656e 6465 7262 6f74 546f 6b65 6e69 7a65  enderbotTokenize
+00001f90: 722e 6465 6661 756c 745f 6368 6174 5f74  r.default_chat_t
+00001fa0: 656d 706c 6174 650a 2020 2020 6465 6620  emplate.    def 
+00001fb0: 6465 6661 756c 745f 6368 6174 5f74 656d  default_chat_tem
+00001fc0: 706c 6174 6528 7365 6c66 293a 0a20 2020  plate(self):.   
+00001fd0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00001fe0: 2041 2076 6572 7920 7369 6d70 6c65 2063   A very simple c
+00001ff0: 6861 7420 7465 6d70 6c61 7465 2074 6861  hat template tha
+00002000: 7420 6a75 7374 2061 6464 7320 7768 6974  t just adds whit
+00002010: 6573 7061 6365 2062 6574 7765 656e 206d  espace between m
+00002020: 6573 7361 6765 732e 0a20 2020 2020 2020  essages..       
+00002030: 2022 2222 0a20 2020 2020 2020 206c 6f67   """.        log
+00002040: 6765 722e 7761 726e 696e 675f 6f6e 6365  ger.warning_once
+00002050: 280a 2020 2020 2020 2020 2020 2020 225c  (.            "\
+00002060: 6e4e 6f20 6368 6174 2074 656d 706c 6174  nNo chat templat
+00002070: 6520 6973 2064 6566 696e 6564 2066 6f72  e is defined for
+00002080: 2074 6869 7320 746f 6b65 6e69 7a65 7220   this tokenizer 
+00002090: 2d20 7573 696e 6720 7468 6520 6465 6661  - using the defa
+000020a0: 756c 7420 7465 6d70 6c61 7465 2022 0a20  ult template ". 
+000020b0: 2020 2020 2020 2020 2020 2066 2266 6f72             f"for
+000020c0: 2074 6865 207b 7365 6c66 2e5f 5f63 6c61   the {self.__cla
+000020d0: 7373 5f5f 2e5f 5f6e 616d 655f 5f7d 2063  ss__.__name__} c
+000020e0: 6c61 7373 2e20 4966 2074 6865 2064 6566  lass. If the def
+000020f0: 6175 6c74 2069 7320 6e6f 7420 6170 7072  ault is not appr
+00002100: 6f70 7269 6174 6520 666f 7220 220a 2020  opriate for ".  
+00002110: 2020 2020 2020 2020 2020 2279 6f75 7220            "your 
+00002120: 6d6f 6465 6c2c 2070 6c65 6173 6520 7365  model, please se
+00002130: 7420 6074 6f6b 656e 697a 6572 2e63 6861  t `tokenizer.cha
+00002140: 745f 7465 6d70 6c61 7465 6020 746f 2061  t_template` to a
+00002150: 6e20 6170 7072 6f70 7269 6174 6520 7465  n appropriate te
+00002160: 6d70 6c61 7465 2e20 220a 2020 2020 2020  mplate. ".      
+00002170: 2020 2020 2020 2253 6565 2068 7474 7073        "See https
+00002180: 3a2f 2f68 7567 6769 6e67 6661 6365 2e63  ://huggingface.c
+00002190: 6f2f 646f 6373 2f74 7261 6e73 666f 726d  o/docs/transform
+000021a0: 6572 732f 6d61 696e 2f63 6861 745f 7465  ers/main/chat_te
+000021b0: 6d70 6c61 7469 6e67 2066 6f72 206d 6f72  mplating for mor
+000021c0: 6520 696e 666f 726d 6174 696f 6e2e 5c6e  e information.\n
+000021d0: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
+000021e0: 2020 2020 7265 7475 726e 2028 0a20 2020      return (.   
+000021f0: 2020 2020 2020 2020 2022 7b25 2066 6f72           "{% for
+00002200: 206d 6573 7361 6765 2069 6e20 6d65 7373   message in mess
+00002210: 6167 6573 2025 7d22 0a20 2020 2020 2020  ages %}".       
+00002220: 2020 2020 2022 7b25 2069 6620 6d65 7373       "{% if mess
+00002230: 6167 655b 2772 6f6c 6527 5d20 3d3d 2027  age['role'] == '
+00002240: 7573 6572 2720 257d 7b7b 2027 2027 207d  user' %}{{ ' ' }
+00002250: 7d7b 2520 656e 6469 6620 257d 220a 2020  }{% endif %}".  
+00002260: 2020 2020 2020 2020 2020 227b 7b20 6d65            "{{ me
+00002270: 7373 6167 655b 2763 6f6e 7465 6e74 275d  ssage['content']
+00002280: 207d 7d22 0a20 2020 2020 2020 2020 2020   }}".           
+00002290: 2022 7b25 2069 6620 6e6f 7420 6c6f 6f70   "{% if not loop
+000022a0: 2e6c 6173 7420 257d 7b7b 2027 2020 2720  .last %}{{ '  ' 
+000022b0: 7d7d 7b25 2065 6e64 6966 2025 7d22 0a20  }}{% endif %}". 
+000022c0: 2020 2020 2020 2020 2020 2022 7b25 2065             "{% e
+000022d0: 6e64 666f 7220 257d 220a 2020 2020 2020  ndfor %}".      
+000022e0: 2020 2020 2020 227b 7b20 656f 735f 746f        "{{ eos_to
+000022f0: 6b65 6e20 7d7d 220a 2020 2020 2020 2020  ken }}".        
+00002300: 290a 0a5f 5f61 6c6c 5f5f 203d 205b 2742  )..__all__ = ['B
+00002310: 6c65 6e64 6572 626f 7453 6d61 6c6c 546f  lenderbotSmallTo
+00002320: 6b65 6e69 7a65 7227 5d0a                 kenizer'].
```

## mindnlp/transformers/models/blenderbot_small/tokenization_blenderbot_small_fast.py

```diff
@@ -0,0 +1,273 @@
+00000000: 2320 636f 6469 6e67 3d75 7466 2d38 0a23  # coding=utf-8.#
+00000010: 2043 6f70 7972 6967 6874 2032 3032 312c   Copyright 2021,
+00000020: 2054 6865 2046 6163 6562 6f6f 6b2c 2049   The Facebook, I
+00000030: 6e63 2e20 616e 6420 5468 6520 4875 6767  nc. and The Hugg
+00000040: 696e 6746 6163 6520 496e 632e 2074 6561  ingFace Inc. tea
+00000050: 6d2e 2041 6c6c 2072 6967 6874 7320 7265  m. All rights re
+00000060: 7365 7276 6564 2e0a 230a 2320 4c69 6365  served..#.# Lice
+00000070: 6e73 6564 2075 6e64 6572 2074 6865 2041  nsed under the A
+00000080: 7061 6368 6520 4c69 6365 6e73 652c 2056  pache License, V
+00000090: 6572 7369 6f6e 2032 2e30 2028 7468 6520  ersion 2.0 (the 
+000000a0: 224c 6963 656e 7365 2229 3b0a 2320 796f  "License");.# yo
+000000b0: 7520 6d61 7920 6e6f 7420 7573 6520 7468  u may not use th
+000000c0: 6973 2066 696c 6520 6578 6365 7074 2069  is file except i
+000000d0: 6e20 636f 6d70 6c69 616e 6365 2077 6974  n compliance wit
+000000e0: 6820 7468 6520 4c69 6365 6e73 652e 0a23  h the License..#
+000000f0: 2059 6f75 206d 6179 206f 6274 6169 6e20   You may obtain 
+00000100: 6120 636f 7079 206f 6620 7468 6520 4c69  a copy of the Li
+00000110: 6365 6e73 6520 6174 0a23 0a23 2020 2020  cense at.#.#    
+00000120: 2068 7474 703a 2f2f 7777 772e 6170 6163   http://www.apac
+00000130: 6865 2e6f 7267 2f6c 6963 656e 7365 732f  he.org/licenses/
+00000140: 4c49 4345 4e53 452d 322e 300a 230a 2320  LICENSE-2.0.#.# 
+00000150: 556e 6c65 7373 2072 6571 7569 7265 6420  Unless required 
+00000160: 6279 2061 7070 6c69 6361 626c 6520 6c61  by applicable la
+00000170: 7720 6f72 2061 6772 6565 6420 746f 2069  w or agreed to i
+00000180: 6e20 7772 6974 696e 672c 2073 6f66 7477  n writing, softw
+00000190: 6172 650a 2320 6469 7374 7269 6275 7465  are.# distribute
+000001a0: 6420 756e 6465 7220 7468 6520 4c69 6365  d under the Lice
+000001b0: 6e73 6520 6973 2064 6973 7472 6962 7574  nse is distribut
+000001c0: 6564 206f 6e20 616e 2022 4153 2049 5322  ed on an "AS IS"
+000001d0: 2042 4153 4953 2c0a 2320 5749 5448 4f55   BASIS,.# WITHOU
+000001e0: 5420 5741 5252 414e 5449 4553 204f 5220  T WARRANTIES OR 
+000001f0: 434f 4e44 4954 494f 4e53 204f 4620 414e  CONDITIONS OF AN
+00000200: 5920 4b49 4e44 2c20 6569 7468 6572 2065  Y KIND, either e
+00000210: 7870 7265 7373 206f 7220 696d 706c 6965  xpress or implie
+00000220: 642e 0a23 2053 6565 2074 6865 204c 6963  d..# See the Lic
+00000230: 656e 7365 2066 6f72 2074 6865 2073 7065  ense for the spe
+00000240: 6369 6669 6320 6c61 6e67 7561 6765 2067  cific language g
+00000250: 6f76 6572 6e69 6e67 2070 6572 6d69 7373  overning permiss
+00000260: 696f 6e73 2061 6e64 0a23 206c 696d 6974  ions and.# limit
+00000270: 6174 696f 6e73 2075 6e64 6572 2074 6865  ations under the
+00000280: 204c 6963 656e 7365 2e0a 2222 2246 6173   License.."""Fas
+00000290: 7420 746f 6b65 6e69 7a61 7469 6f6e 2063  t tokenization c
+000002a0: 6c61 7373 2066 6f72 2042 6c65 6e64 6572  lass for Blender
+000002b0: 626f 7453 6d61 6c6c 2e22 2222 0a66 726f  botSmall.""".fro
+000002c0: 6d20 7479 7069 6e67 2069 6d70 6f72 7420  m typing import 
+000002d0: 4c69 7374 2c20 4f70 7469 6f6e 616c 0a0a  List, Optional..
+000002e0: 6672 6f6d 2074 6f6b 656e 697a 6572 7320  from tokenizers 
+000002f0: 696d 706f 7274 2042 7974 654c 6576 656c  import ByteLevel
+00000300: 4250 4554 6f6b 656e 697a 6572 0a0a 6672  BPETokenizer..fr
+00000310: 6f6d 202e 2e2e 746f 6b65 6e69 7a61 7469  om ...tokenizati
+00000320: 6f6e 5f75 7469 6c73 5f66 6173 7420 696d  on_utils_fast im
+00000330: 706f 7274 2050 7265 5472 6169 6e65 6454  port PreTrainedT
+00000340: 6f6b 656e 697a 6572 4661 7374 0a66 726f  okenizerFast.fro
+00000350: 6d20 2e2e 2e2e 7574 696c 7320 696d 706f  m ....utils impo
+00000360: 7274 206c 6f67 6769 6e67 0a66 726f 6d20  rt logging.from 
+00000370: 2e74 6f6b 656e 697a 6174 696f 6e5f 626c  .tokenization_bl
+00000380: 656e 6465 7262 6f74 5f73 6d61 6c6c 2069  enderbot_small i
+00000390: 6d70 6f72 7420 426c 656e 6465 7262 6f74  mport Blenderbot
+000003a0: 536d 616c 6c54 6f6b 656e 697a 6572 0a0a  SmallTokenizer..
+000003b0: 0a6c 6f67 6765 7220 3d20 6c6f 6767 696e  .logger = loggin
+000003c0: 672e 6765 745f 6c6f 6767 6572 285f 5f6e  g.get_logger(__n
+000003d0: 616d 655f 5f29 0a0a 564f 4341 425f 4649  ame__)..VOCAB_FI
+000003e0: 4c45 535f 4e41 4d45 5320 3d20 7b0a 2020  LES_NAMES = {.  
+000003f0: 2020 2276 6f63 6162 5f66 696c 6522 3a20    "vocab_file": 
+00000400: 2276 6f63 6162 2e6a 736f 6e22 2c0a 2020  "vocab.json",.  
+00000410: 2020 226d 6572 6765 735f 6669 6c65 223a    "merges_file":
+00000420: 2022 6d65 7267 6573 2e74 7874 222c 0a20   "merges.txt",. 
+00000430: 2020 2022 746f 6b65 6e69 7a65 725f 636f     "tokenizer_co
+00000440: 6e66 6967 5f66 696c 6522 3a20 2274 6f6b  nfig_file": "tok
+00000450: 656e 697a 6572 5f63 6f6e 6669 672e 6a73  enizer_config.js
+00000460: 6f6e 222c 0a7d 0a0a 0a63 6c61 7373 2042  on",.}...class B
+00000470: 6c65 6e64 6572 626f 7453 6d61 6c6c 546f  lenderbotSmallTo
+00000480: 6b65 6e69 7a65 7246 6173 7428 5072 6554  kenizerFast(PreT
+00000490: 7261 696e 6564 546f 6b65 6e69 7a65 7246  rainedTokenizerF
+000004a0: 6173 7429 3a0a 2020 2020 2222 220a 2020  ast):.    """.  
+000004b0: 2020 436f 6e73 7472 7563 7420 6120 2266    Construct a "f
+000004c0: 6173 7422 2042 6c65 6e64 6572 626f 7453  ast" BlenderbotS
+000004d0: 6d61 6c6c 2074 6f6b 656e 697a 6572 2028  mall tokenizer (
+000004e0: 6261 636b 6564 2062 7920 4875 6767 696e  backed by Huggin
+000004f0: 6746 6163 6527 7320 2a74 6f6b 656e 697a  gFace's *tokeniz
+00000500: 6572 732a 206c 6962 7261 7279 292e 0a0a  ers* library)...
+00000510: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+00000520: 2020 766f 6361 625f 6669 6c65 2028 6073    vocab_file (`s
+00000530: 7472 6029 3a0a 2020 2020 2020 2020 2020  tr`):.          
+00000540: 2020 5061 7468 2074 6f20 7468 6520 766f    Path to the vo
+00000550: 6361 6275 6c61 7279 2066 696c 652e 0a20  cabulary file.. 
+00000560: 2020 2022 2222 0a0a 2020 2020 766f 6361     """..    voca
+00000570: 625f 6669 6c65 735f 6e61 6d65 7320 3d20  b_files_names = 
+00000580: 564f 4341 425f 4649 4c45 535f 4e41 4d45  VOCAB_FILES_NAME
+00000590: 530a 2020 2020 736c 6f77 5f74 6f6b 656e  S.    slow_token
+000005a0: 697a 6572 5f63 6c61 7373 203d 2042 6c65  izer_class = Ble
+000005b0: 6e64 6572 626f 7453 6d61 6c6c 546f 6b65  nderbotSmallToke
+000005c0: 6e69 7a65 720a 0a20 2020 2064 6566 205f  nizer..    def _
+000005d0: 5f69 6e69 745f 5f28 0a20 2020 2020 2020  _init__(.       
+000005e0: 2073 656c 662c 0a20 2020 2020 2020 2076   self,.        v
+000005f0: 6f63 6162 5f66 696c 653d 4e6f 6e65 2c0a  ocab_file=None,.
+00000600: 2020 2020 2020 2020 6d65 7267 6573 5f66          merges_f
+00000610: 696c 653d 4e6f 6e65 2c0a 2020 2020 2020  ile=None,.      
+00000620: 2020 756e 6b5f 746f 6b65 6e3d 223c 7c65    unk_token="<|e
+00000630: 6e64 6f66 7465 7874 7c3e 222c 0a20 2020  ndoftext|>",.   
+00000640: 2020 2020 2062 6f73 5f74 6f6b 656e 3d22       bos_token="
+00000650: 3c7c 656e 646f 6674 6578 747c 3e22 2c0a  <|endoftext|>",.
+00000660: 2020 2020 2020 2020 656f 735f 746f 6b65          eos_toke
+00000670: 6e3d 223c 7c65 6e64 6f66 7465 7874 7c3e  n="<|endoftext|>
+00000680: 222c 0a20 2020 2020 2020 2061 6464 5f70  ",.        add_p
+00000690: 7265 6669 785f 7370 6163 653d 4661 6c73  refix_space=Fals
+000006a0: 652c 0a20 2020 2020 2020 2074 7269 6d5f  e,.        trim_
+000006b0: 6f66 6673 6574 733d 5472 7565 2c0a 2020  offsets=True,.  
+000006c0: 2020 2020 2020 2a2a 6b77 6172 6773 2c0a        **kwargs,.
+000006d0: 2020 2020 293a 0a20 2020 2020 2020 2073      ):.        s
+000006e0: 7570 6572 2829 2e5f 5f69 6e69 745f 5f28  uper().__init__(
+000006f0: 0a20 2020 2020 2020 2020 2020 2042 7974  .            Byt
+00000700: 654c 6576 656c 4250 4554 6f6b 656e 697a  eLevelBPETokeniz
+00000710: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
+00000720: 2020 2020 766f 6361 623d 766f 6361 625f      vocab=vocab_
+00000730: 6669 6c65 2c0a 2020 2020 2020 2020 2020  file,.          
+00000740: 2020 2020 2020 6d65 7267 6573 3d6d 6572        merges=mer
+00000750: 6765 735f 6669 6c65 2c0a 2020 2020 2020  ges_file,.      
+00000760: 2020 2020 2020 2020 2020 6164 645f 7072            add_pr
+00000770: 6566 6978 5f73 7061 6365 3d61 6464 5f70  efix_space=add_p
+00000780: 7265 6669 785f 7370 6163 652c 0a20 2020  refix_space,.   
+00000790: 2020 2020 2020 2020 2020 2020 2074 7269               tri
+000007a0: 6d5f 6f66 6673 6574 733d 7472 696d 5f6f  m_offsets=trim_o
+000007b0: 6666 7365 7473 2c0a 2020 2020 2020 2020  ffsets,.        
+000007c0: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
+000007d0: 2020 2062 6f73 5f74 6f6b 656e 3d62 6f73     bos_token=bos
+000007e0: 5f74 6f6b 656e 2c0a 2020 2020 2020 2020  _token,.        
+000007f0: 2020 2020 656f 735f 746f 6b65 6e3d 656f      eos_token=eo
+00000800: 735f 746f 6b65 6e2c 0a20 2020 2020 2020  s_token,.       
+00000810: 2020 2020 2075 6e6b 5f74 6f6b 656e 3d75       unk_token=u
+00000820: 6e6b 5f74 6f6b 656e 2c0a 2020 2020 2020  nk_token,.      
+00000830: 2020 2020 2020 2a2a 6b77 6172 6773 2c0a        **kwargs,.
+00000840: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00000850: 2020 7365 6c66 2e61 6464 5f70 7265 6669    self.add_prefi
+00000860: 785f 7370 6163 6520 3d20 6164 645f 7072  x_space = add_pr
+00000870: 6566 6978 5f73 7061 6365 0a0a 2020 2020  efix_space..    
+00000880: 6465 6620 6275 696c 645f 696e 7075 7473  def build_inputs
+00000890: 5f77 6974 685f 7370 6563 6961 6c5f 746f  _with_special_to
+000008a0: 6b65 6e73 2873 656c 662c 2074 6f6b 656e  kens(self, token
+000008b0: 5f69 6473 5f30 2c20 746f 6b65 6e5f 6964  _ids_0, token_id
+000008c0: 735f 313d 4e6f 6e65 293a 0a20 2020 2020  s_1=None):.     
+000008d0: 2020 206f 7574 7075 7420 3d20 5b73 656c     output = [sel
+000008e0: 662e 626f 735f 746f 6b65 6e5f 6964 5d20  f.bos_token_id] 
+000008f0: 2b20 746f 6b65 6e5f 6964 735f 3020 2b20  + token_ids_0 + 
+00000900: 5b73 656c 662e 656f 735f 746f 6b65 6e5f  [self.eos_token_
+00000910: 6964 5d0a 2020 2020 2020 2020 6966 2074  id].        if t
+00000920: 6f6b 656e 5f69 6473 5f31 2069 7320 4e6f  oken_ids_1 is No
+00000930: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00000940: 7265 7475 726e 206f 7574 7075 740a 0a20  return output.. 
+00000950: 2020 2020 2020 2072 6574 7572 6e20 6f75         return ou
+00000960: 7470 7574 202b 205b 7365 6c66 2e65 6f73  tput + [self.eos
+00000970: 5f74 6f6b 656e 5f69 645d 202b 2074 6f6b  _token_id] + tok
+00000980: 656e 5f69 6473 5f31 202b 205b 7365 6c66  en_ids_1 + [self
+00000990: 2e65 6f73 5f74 6f6b 656e 5f69 645d 0a0a  .eos_token_id]..
+000009a0: 2020 2020 6465 6620 6372 6561 7465 5f74      def create_t
+000009b0: 6f6b 656e 5f74 7970 655f 6964 735f 6672  oken_type_ids_fr
+000009c0: 6f6d 5f73 6571 7565 6e63 6573 280a 2020  om_sequences(.  
+000009d0: 2020 2020 2020 7365 6c66 2c20 746f 6b65        self, toke
+000009e0: 6e5f 6964 735f 303a 204c 6973 745b 696e  n_ids_0: List[in
+000009f0: 745d 2c20 746f 6b65 6e5f 6964 735f 313a  t], token_ids_1:
+00000a00: 204f 7074 696f 6e61 6c5b 4c69 7374 5b69   Optional[List[i
+00000a10: 6e74 5d5d 203d 204e 6f6e 650a 2020 2020  nt]] = None.    
+00000a20: 2920 2d3e 204c 6973 745b 696e 745d 3a0a  ) -> List[int]:.
+00000a30: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00000a40: 2020 2020 4372 6561 7465 2061 206d 6173      Create a mas
+00000a50: 6b20 6672 6f6d 2074 6865 2074 776f 2073  k from the two s
+00000a60: 6571 7565 6e63 6573 2070 6173 7365 6420  equences passed 
+00000a70: 746f 2062 6520 7573 6564 2069 6e20 6120  to be used in a 
+00000a80: 7365 7175 656e 6365 2d70 6169 7220 636c  sequence-pair cl
+00000a90: 6173 7369 6669 6361 7469 6f6e 2074 6173  assification tas
+00000aa0: 6b2e 2042 6c65 6e64 6572 626f 7453 6d61  k. BlenderbotSma
+00000ab0: 6c6c 0a20 2020 2020 2020 2064 6f65 7320  ll.        does 
+00000ac0: 6e6f 7420 6d61 6b65 2075 7365 206f 6620  not make use of 
+00000ad0: 746f 6b65 6e20 7479 7065 2069 6473 2c20  token type ids, 
+00000ae0: 7468 6572 6566 6f72 6520 6120 6c69 7374  therefore a list
+00000af0: 206f 6620 7a65 726f 7320 6973 2072 6574   of zeros is ret
+00000b00: 7572 6e65 642e 0a0a 2020 2020 2020 2020  urned...        
+00000b10: 4172 6773 3a0a 2020 2020 2020 2020 2020  Args:.          
+00000b20: 2020 746f 6b65 6e5f 6964 735f 3020 2860    token_ids_0 (`
+00000b30: 4c69 7374 5b69 6e74 5d60 293a 0a20 2020  List[int]`):.   
+00000b40: 2020 2020 2020 2020 2020 2020 204c 6973               Lis
+00000b50: 7420 6f66 2049 4473 2e0a 2020 2020 2020  t of IDs..      
+00000b60: 2020 2020 2020 746f 6b65 6e5f 6964 735f        token_ids_
+00000b70: 3120 2860 4c69 7374 5b69 6e74 5d60 2c20  1 (`List[int]`, 
+00000b80: 2a6f 7074 696f 6e61 6c2a 293a 0a20 2020  *optional*):.   
+00000b90: 2020 2020 2020 2020 2020 2020 204f 7074               Opt
+00000ba0: 696f 6e61 6c20 7365 636f 6e64 206c 6973  ional second lis
+00000bb0: 7420 6f66 2049 4473 2066 6f72 2073 6571  t of IDs for seq
+00000bc0: 7565 6e63 6520 7061 6972 732e 0a0a 2020  uence pairs...  
+00000bd0: 2020 2020 2020 5265 7475 726e 733a 0a20        Returns:. 
+00000be0: 2020 2020 2020 2020 2020 2060 4c69 7374             `List
+00000bf0: 5b69 6e74 5d60 3a20 4c69 7374 206f 6620  [int]`: List of 
+00000c00: 7a65 726f 732e 0a20 2020 2020 2020 2022  zeros..        "
+00000c10: 2222 0a20 2020 2020 2020 2073 6570 203d  "".        sep =
+00000c20: 205b 7365 6c66 2e73 6570 5f74 6f6b 656e   [self.sep_token
+00000c30: 5f69 645d 0a20 2020 2020 2020 2063 6c73  _id].        cls
+00000c40: 203d 205b 7365 6c66 2e63 6c73 5f74 6f6b   = [self.cls_tok
+00000c50: 656e 5f69 645d 0a0a 2020 2020 2020 2020  en_id]..        
+00000c60: 6966 2074 6f6b 656e 5f69 6473 5f31 2069  if token_ids_1 i
+00000c70: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+00000c80: 2020 2020 7265 7475 726e 206c 656e 2863      return len(c
+00000c90: 6c73 202b 2074 6f6b 656e 5f69 6473 5f30  ls + token_ids_0
+00000ca0: 202b 2073 6570 2920 2a20 5b30 5d0a 2020   + sep) * [0].  
+00000cb0: 2020 2020 2020 7265 7475 726e 206c 656e        return len
+00000cc0: 2863 6c73 202b 2074 6f6b 656e 5f69 6473  (cls + token_ids
+00000cd0: 5f30 202b 2073 6570 202b 2073 6570 202b  _0 + sep + sep +
+00000ce0: 2074 6f6b 656e 5f69 6473 5f31 202b 2073   token_ids_1 + s
+00000cf0: 6570 2920 2a20 5b30 5d0a 0a20 2020 2040  ep) * [0]..    @
+00000d00: 7072 6f70 6572 7479 0a20 2020 2023 2043  property.    # C
+00000d10: 6f70 6965 6420 6672 6f6d 2074 7261 6e73  opied from trans
+00000d20: 666f 726d 6572 732e 6d6f 6465 6c73 2e62  formers.models.b
+00000d30: 6c65 6e64 6572 626f 742e 746f 6b65 6e69  lenderbot.tokeni
+00000d40: 7a61 7469 6f6e 5f62 6c65 6e64 6572 626f  zation_blenderbo
+00000d50: 742e 426c 656e 6465 7262 6f74 546f 6b65  t.BlenderbotToke
+00000d60: 6e69 7a65 722e 6465 6661 756c 745f 6368  nizer.default_ch
+00000d70: 6174 5f74 656d 706c 6174 650a 2020 2020  at_template.    
+00000d80: 6465 6620 6465 6661 756c 745f 6368 6174  def default_chat
+00000d90: 5f74 656d 706c 6174 6528 7365 6c66 293a  _template(self):
+00000da0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00000db0: 2020 2020 2041 2076 6572 7920 7369 6d70       A very simp
+00000dc0: 6c65 2063 6861 7420 7465 6d70 6c61 7465  le chat template
+00000dd0: 2074 6861 7420 6a75 7374 2061 6464 7320   that just adds 
+00000de0: 7768 6974 6573 7061 6365 2062 6574 7765  whitespace betwe
+00000df0: 656e 206d 6573 7361 6765 732e 0a20 2020  en messages..   
+00000e00: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00000e10: 206c 6f67 6765 722e 7761 726e 696e 675f   logger.warning_
+00000e20: 6f6e 6365 280a 2020 2020 2020 2020 2020  once(.          
+00000e30: 2020 225c 6e4e 6f20 6368 6174 2074 656d    "\nNo chat tem
+00000e40: 706c 6174 6520 6973 2064 6566 696e 6564  plate is defined
+00000e50: 2066 6f72 2074 6869 7320 746f 6b65 6e69   for this tokeni
+00000e60: 7a65 7220 2d20 7573 696e 6720 7468 6520  zer - using the 
+00000e70: 6465 6661 756c 7420 7465 6d70 6c61 7465  default template
+00000e80: 2022 0a20 2020 2020 2020 2020 2020 2066   ".            f
+00000e90: 2266 6f72 2074 6865 207b 7365 6c66 2e5f  "for the {self._
+00000ea0: 5f63 6c61 7373 5f5f 2e5f 5f6e 616d 655f  _class__.__name_
+00000eb0: 5f7d 2063 6c61 7373 2e20 4966 2074 6865  _} class. If the
+00000ec0: 2064 6566 6175 6c74 2069 7320 6e6f 7420   default is not 
+00000ed0: 6170 7072 6f70 7269 6174 6520 666f 7220  appropriate for 
+00000ee0: 220a 2020 2020 2020 2020 2020 2020 2279  ".            "y
+00000ef0: 6f75 7220 6d6f 6465 6c2c 2070 6c65 6173  our model, pleas
+00000f00: 6520 7365 7420 6074 6f6b 656e 697a 6572  e set `tokenizer
+00000f10: 2e63 6861 745f 7465 6d70 6c61 7465 6020  .chat_template` 
+00000f20: 746f 2061 6e20 6170 7072 6f70 7269 6174  to an appropriat
+00000f30: 6520 7465 6d70 6c61 7465 2e20 220a 2020  e template. ".  
+00000f40: 2020 2020 2020 2020 2020 2253 6565 2068            "See h
+00000f50: 7474 7073 3a2f 2f68 7567 6769 6e67 6661  ttps://huggingfa
+00000f60: 6365 2e63 6f2f 646f 6373 2f74 7261 6e73  ce.co/docs/trans
+00000f70: 666f 726d 6572 732f 6d61 696e 2f63 6861  formers/main/cha
+00000f80: 745f 7465 6d70 6c61 7469 6e67 2066 6f72  t_templating for
+00000f90: 206d 6f72 6520 696e 666f 726d 6174 696f   more informatio
+00000fa0: 6e2e 5c6e 220a 2020 2020 2020 2020 290a  n.\n".        ).
+00000fb0: 2020 2020 2020 2020 7265 7475 726e 2028          return (
+00000fc0: 0a20 2020 2020 2020 2020 2020 2022 7b25  .            "{%
+00000fd0: 2066 6f72 206d 6573 7361 6765 2069 6e20   for message in 
+00000fe0: 6d65 7373 6167 6573 2025 7d22 0a20 2020  messages %}".   
+00000ff0: 2020 2020 2020 2020 2022 7b25 2069 6620           "{% if 
+00001000: 6d65 7373 6167 655b 2772 6f6c 6527 5d20  message['role'] 
+00001010: 3d3d 2027 7573 6572 2720 257d 7b7b 2027  == 'user' %}{{ '
+00001020: 2027 207d 7d7b 2520 656e 6469 6620 257d   ' }}{% endif %}
+00001030: 220a 2020 2020 2020 2020 2020 2020 227b  ".            "{
+00001040: 7b20 6d65 7373 6167 655b 2763 6f6e 7465  { message['conte
+00001050: 6e74 275d 207d 7d22 0a20 2020 2020 2020  nt'] }}".       
+00001060: 2020 2020 2022 7b25 2069 6620 6e6f 7420       "{% if not 
+00001070: 6c6f 6f70 2e6c 6173 7420 257d 7b7b 2027  loop.last %}{{ '
+00001080: 2020 2720 7d7d 7b25 2065 6e64 6966 2025    ' }}{% endif %
+00001090: 7d22 0a20 2020 2020 2020 2020 2020 2022  }".            "
+000010a0: 7b25 2065 6e64 666f 7220 257d 220a 2020  {% endfor %}".  
+000010b0: 2020 2020 2020 2020 2020 227b 7b20 656f            "{{ eo
+000010c0: 735f 746f 6b65 6e20 7d7d 220a 2020 2020  s_token }}".    
+000010d0: 2020 2020 290a 0a5f 5f61 6c6c 5f5f 203d      )..__all__ =
+000010e0: 205b 2742 6c65 6e64 6572 626f 7453 6d61   ['BlenderbotSma
+000010f0: 6c6c 546f 6b65 6e69 7a65 7246 6173 7427  llTokenizerFast'
+00001100: 5d0a                                     ].
```

## mindnlp/transformers/models/blip/__init__.py

```diff
@@ -0,0 +1,68 @@
+00000000: 2320 436f 7079 7269 6768 7420 3230 3234  # Copyright 2024
+00000010: 2048 7561 7765 6920 5465 6368 6e6f 6c6f   Huawei Technolo
+00000020: 6769 6573 2043 6f2e 2c20 4c74 640a 230a  gies Co., Ltd.#.
+00000030: 2320 4c69 6365 6e73 6564 2075 6e64 6572  # Licensed under
+00000040: 2074 6865 2041 7061 6368 6520 4c69 6365   the Apache Lice
+00000050: 6e73 652c 2056 6572 7369 6f6e 2032 2e30  nse, Version 2.0
+00000060: 2028 7468 6520 224c 6963 656e 7365 2229   (the "License")
+00000070: 3b0a 2320 796f 7520 6d61 7920 6e6f 7420  ;.# you may not 
+00000080: 7573 6520 7468 6973 2066 696c 6520 6578  use this file ex
+00000090: 6365 7074 2069 6e20 636f 6d70 6c69 616e  cept in complian
+000000a0: 6365 2077 6974 6820 7468 6520 4c69 6365  ce with the Lice
+000000b0: 6e73 652e 0a23 2059 6f75 206d 6179 206f  nse..# You may o
+000000c0: 6274 6169 6e20 6120 636f 7079 206f 6620  btain a copy of 
+000000d0: 7468 6520 4c69 6365 6e73 6520 6174 0a23  the License at.#
+000000e0: 0a23 2068 7474 703a 2f2f 7777 772e 6170  .# http://www.ap
+000000f0: 6163 6865 2e6f 7267 2f6c 6963 656e 7365  ache.org/license
+00000100: 732f 4c49 4345 4e53 452d 322e 300a 230a  s/LICENSE-2.0.#.
+00000110: 2320 556e 6c65 7373 2072 6571 7569 7265  # Unless require
+00000120: 6420 6279 2061 7070 6c69 6361 626c 6520  d by applicable 
+00000130: 6c61 7720 6f72 2061 6772 6565 6420 746f  law or agreed to
+00000140: 2069 6e20 7772 6974 696e 672c 2073 6f66   in writing, sof
+00000150: 7477 6172 650a 2320 6469 7374 7269 6275  tware.# distribu
+00000160: 7465 6420 756e 6465 7220 7468 6520 4c69  ted under the Li
+00000170: 6365 6e73 6520 6973 2064 6973 7472 6962  cense is distrib
+00000180: 7574 6564 206f 6e20 616e 2022 4153 2049  uted on an "AS I
+00000190: 5322 2042 4153 4953 2c0a 2320 5749 5448  S" BASIS,.# WITH
+000001a0: 4f55 5420 5741 5252 414e 5449 4553 204f  OUT WARRANTIES O
+000001b0: 5220 434f 4e44 4954 494f 4e53 204f 4620  R CONDITIONS OF 
+000001c0: 414e 5920 4b49 4e44 2c20 6569 7468 6572  ANY KIND, either
+000001d0: 2065 7870 7265 7373 206f 7220 696d 706c   express or impl
+000001e0: 6965 642e 0a23 2053 6565 2074 6865 204c  ied..# See the L
+000001f0: 6963 656e 7365 2066 6f72 2074 6865 2073  icense for the s
+00000200: 7065 6369 6669 6320 6c61 6e67 7561 6765  pecific language
+00000210: 2067 6f76 6572 6e69 6e67 2070 6572 6d69   governing permi
+00000220: 7373 696f 6e73 2061 6e64 0a23 206c 696d  ssions and.# lim
+00000230: 6974 6174 696f 6e73 2075 6e64 6572 2074  itations under t
+00000240: 6865 204c 6963 656e 7365 2e0a 2320 3d3d  he License..# ==
+00000250: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00000260: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00000270: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00000280: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00000290: 3d3d 3d3d 3d3d 3d3d 3d3d 0a22 2222 0a42  ==========.""".B
+000002a0: 6c69 7020 4d6f 6465 6c2e 0a22 2222 0a66  lip Model..""".f
+000002b0: 726f 6d20 2e20 696d 706f 7274 2063 6f6e  rom . import con
+000002c0: 6669 6775 7261 7469 6f6e 5f62 6c69 702c  figuration_blip,
+000002d0: 206d 6f64 656c 696e 675f 626c 6970 2c20   modeling_blip, 
+000002e0: 696d 6167 655f 7072 6f63 6573 7369 6e67  image_processing
+000002f0: 5f62 6c69 702c 2070 726f 6365 7373 696e  _blip, processin
+00000300: 675f 626c 6970 0a66 726f 6d20 2e63 6f6e  g_blip.from .con
+00000310: 6669 6775 7261 7469 6f6e 5f62 6c69 7020  figuration_blip 
+00000320: 696d 706f 7274 202a 0a66 726f 6d20 2e6d  import *.from .m
+00000330: 6f64 656c 696e 675f 626c 6970 2069 6d70  odeling_blip imp
+00000340: 6f72 7420 2a0a 6672 6f6d 202e 696d 6167  ort *.from .imag
+00000350: 655f 7072 6f63 6573 7369 6e67 5f62 6c69  e_processing_bli
+00000360: 7020 696d 706f 7274 202a 0a66 726f 6d20  p import *.from 
+00000370: 2e70 726f 6365 7373 696e 675f 626c 6970  .processing_blip
+00000380: 2069 6d70 6f72 7420 2a0a 0a5f 5f61 6c6c   import *..__all
+00000390: 5f5f 203d 205b 5d0a 5f5f 616c 6c5f 5f2e  __ = [].__all__.
+000003a0: 6578 7465 6e64 2863 6f6e 6669 6775 7261  extend(configura
+000003b0: 7469 6f6e 5f62 6c69 702e 5f5f 616c 6c5f  tion_blip.__all_
+000003c0: 5f29 0a5f 5f61 6c6c 5f5f 2e65 7874 656e  _).__all__.exten
+000003d0: 6428 6d6f 6465 6c69 6e67 5f62 6c69 702e  d(modeling_blip.
+000003e0: 5f5f 616c 6c5f 5f29 0a5f 5f61 6c6c 5f5f  __all__).__all__
+000003f0: 2e65 7874 656e 6428 696d 6167 655f 7072  .extend(image_pr
+00000400: 6f63 6573 7369 6e67 5f62 6c69 702e 5f5f  ocessing_blip.__
+00000410: 616c 6c5f 5f29 0a5f 5f61 6c6c 5f5f 2e65  all__).__all__.e
+00000420: 7874 656e 6428 7072 6f63 6573 7369 6e67  xtend(processing
+00000430: 5f62 6c69 702e 5f5f 616c 6c5f 5f29 0a    _blip.__all__).
```

## mindnlp/transformers/models/blip/configuration_blip.py

```diff
@@ -0,0 +1,1029 @@
+00000000: 2320 636f 6469 6e67 3d75 7466 2d38 0a23  # coding=utf-8.#
+00000010: 2043 6f70 7972 6967 6874 2032 3032 3220   Copyright 2022 
+00000020: 5468 6520 4875 6767 696e 6746 6163 6520  The HuggingFace 
+00000030: 496e 632e 2074 6561 6d2e 2041 6c6c 2072  Inc. team. All r
+00000040: 6967 6874 7320 7265 7365 7276 6564 2e0a  ights reserved..
+00000050: 230a 2320 4c69 6365 6e73 6564 2075 6e64  #.# Licensed und
+00000060: 6572 2074 6865 2041 7061 6368 6520 4c69  er the Apache Li
+00000070: 6365 6e73 652c 2056 6572 7369 6f6e 2032  cense, Version 2
+00000080: 2e30 2028 7468 6520 224c 6963 656e 7365  .0 (the "License
+00000090: 2229 3b0a 2320 796f 7520 6d61 7920 6e6f  ");.# you may no
+000000a0: 7420 7573 6520 7468 6973 2066 696c 6520  t use this file 
+000000b0: 6578 6365 7074 2069 6e20 636f 6d70 6c69  except in compli
+000000c0: 616e 6365 2077 6974 6820 7468 6520 4c69  ance with the Li
+000000d0: 6365 6e73 652e 0a23 2059 6f75 206d 6179  cense..# You may
+000000e0: 206f 6274 6169 6e20 6120 636f 7079 206f   obtain a copy o
+000000f0: 6620 7468 6520 4c69 6365 6e73 6520 6174  f the License at
+00000100: 0a23 0a23 2020 2020 2068 7474 703a 2f2f  .#.#     http://
+00000110: 7777 772e 6170 6163 6865 2e6f 7267 2f6c  www.apache.org/l
+00000120: 6963 656e 7365 732f 4c49 4345 4e53 452d  icenses/LICENSE-
+00000130: 322e 300a 230a 2320 556e 6c65 7373 2072  2.0.#.# Unless r
+00000140: 6571 7569 7265 6420 6279 2061 7070 6c69  equired by appli
+00000150: 6361 626c 6520 6c61 7720 6f72 2061 6772  cable law or agr
+00000160: 6565 6420 746f 2069 6e20 7772 6974 696e  eed to in writin
+00000170: 672c 2073 6f66 7477 6172 650a 2320 6469  g, software.# di
+00000180: 7374 7269 6275 7465 6420 756e 6465 7220  stributed under 
+00000190: 7468 6520 4c69 6365 6e73 6520 6973 2064  the License is d
+000001a0: 6973 7472 6962 7574 6564 206f 6e20 616e  istributed on an
+000001b0: 2022 4153 2049 5322 2042 4153 4953 2c0a   "AS IS" BASIS,.
+000001c0: 2320 5749 5448 4f55 5420 5741 5252 414e  # WITHOUT WARRAN
+000001d0: 5449 4553 204f 5220 434f 4e44 4954 494f  TIES OR CONDITIO
+000001e0: 4e53 204f 4620 414e 5920 4b49 4e44 2c20  NS OF ANY KIND, 
+000001f0: 6569 7468 6572 2065 7870 7265 7373 206f  either express o
+00000200: 7220 696d 706c 6965 642e 0a23 2053 6565  r implied..# See
+00000210: 2074 6865 204c 6963 656e 7365 2066 6f72   the License for
+00000220: 2074 6865 2073 7065 6369 6669 6320 6c61   the specific la
+00000230: 6e67 7561 6765 2067 6f76 6572 6e69 6e67  nguage governing
+00000240: 2070 6572 6d69 7373 696f 6e73 2061 6e64   permissions and
+00000250: 0a23 206c 696d 6974 6174 696f 6e73 2075  .# limitations u
+00000260: 6e64 6572 2074 6865 204c 6963 656e 7365  nder the License
+00000270: 2e0a 2222 2220 426c 6970 206d 6f64 656c  ..""" Blip model
+00000280: 2063 6f6e 6669 6775 7261 7469 6f6e 2222   configuration""
+00000290: 220a 0a69 6d70 6f72 7420 6f73 0a66 726f  "..import os.fro
+000002a0: 6d20 7479 7069 6e67 2069 6d70 6f72 7420  m typing import 
+000002b0: 556e 696f 6e0a 0a66 726f 6d20 2e2e 2e63  Union..from ...c
+000002c0: 6f6e 6669 6775 7261 7469 6f6e 5f75 7469  onfiguration_uti
+000002d0: 6c73 2069 6d70 6f72 7420 5072 6574 7261  ls import Pretra
+000002e0: 696e 6564 436f 6e66 6967 0a66 726f 6d20  inedConfig.from 
+000002f0: 2e2e 2e2e 7574 696c 7320 696d 706f 7274  ....utils import
+00000300: 206c 6f67 6769 6e67 0a0a 0a6c 6f67 6765   logging...logge
+00000310: 7220 3d20 6c6f 6767 696e 672e 6765 745f  r = logging.get_
+00000320: 6c6f 6767 6572 285f 5f6e 616d 655f 5f29  logger(__name__)
+00000330: 0a0a 0a63 6c61 7373 2042 6c69 7054 6578  ...class BlipTex
+00000340: 7443 6f6e 6669 6728 5072 6574 7261 696e  tConfig(Pretrain
+00000350: 6564 436f 6e66 6967 293a 0a20 2020 2072  edConfig):.    r
+00000360: 2222 220a 2020 2020 5468 6973 2069 7320  """.    This is 
+00000370: 7468 6520 636f 6e66 6967 7572 6174 696f  the configuratio
+00000380: 6e20 636c 6173 7320 746f 2073 746f 7265  n class to store
+00000390: 2074 6865 2063 6f6e 6669 6775 7261 7469   the configurati
+000003a0: 6f6e 206f 6620 6120 5b60 426c 6970 5465  on of a [`BlipTe
+000003b0: 7874 4d6f 6465 6c60 5d2e 2049 7420 6973  xtModel`]. It is
+000003c0: 2075 7365 6420 746f 2069 6e73 7461 6e74   used to instant
+000003d0: 6961 7465 2061 2042 4c49 500a 2020 2020  iate a BLIP.    
+000003e0: 7465 7874 206d 6f64 656c 2061 6363 6f72  text model accor
+000003f0: 6469 6e67 2074 6f20 7468 6520 7370 6563  ding to the spec
+00000400: 6966 6965 6420 6172 6775 6d65 6e74 732c  ified arguments,
+00000410: 2064 6566 696e 696e 6720 7468 6520 6d6f   defining the mo
+00000420: 6465 6c20 6172 6368 6974 6563 7475 7265  del architecture
+00000430: 2e20 496e 7374 616e 7469 6174 696e 6720  . Instantiating 
+00000440: 6120 636f 6e66 6967 7572 6174 696f 6e0a  a configuration.
+00000450: 2020 2020 7769 7468 2074 6865 2064 6566      with the def
+00000460: 6175 6c74 7320 7769 6c6c 2079 6965 6c64  aults will yield
+00000470: 2061 2073 696d 696c 6172 2063 6f6e 6669   a similar confi
+00000480: 6775 7261 7469 6f6e 2074 6f20 7468 6174  guration to that
+00000490: 206f 6620 7468 6520 6042 6c69 7054 6578   of the `BlipTex
+000004a0: 7460 2075 7365 6420 6279 2074 6865 205b  t` used by the [
+000004b0: 6261 7365 0a20 2020 2061 7263 6869 7465  base.    archite
+000004c0: 6374 7572 6573 5d28 6874 7470 733a 2f2f  ctures](https://
+000004d0: 6875 6767 696e 6766 6163 652e 636f 2f53  huggingface.co/S
+000004e0: 616c 6573 666f 7263 652f 626c 6970 2d76  alesforce/blip-v
+000004f0: 7161 2d62 6173 6529 2e0a 0a20 2020 2043  qa-base)...    C
+00000500: 6f6e 6669 6775 7261 7469 6f6e 206f 626a  onfiguration obj
+00000510: 6563 7473 2069 6e68 6572 6974 2066 726f  ects inherit fro
+00000520: 6d20 5b60 5072 6574 7261 696e 6564 436f  m [`PretrainedCo
+00000530: 6e66 6967 605d 2061 6e64 2063 616e 2062  nfig`] and can b
+00000540: 6520 7573 6564 2074 6f20 636f 6e74 726f  e used to contro
+00000550: 6c20 7468 6520 6d6f 6465 6c20 6f75 7470  l the model outp
+00000560: 7574 732e 2052 6561 6420 7468 650a 2020  uts. Read the.  
+00000570: 2020 646f 6375 6d65 6e74 6174 696f 6e20    documentation 
+00000580: 6672 6f6d 205b 6050 7265 7472 6169 6e65  from [`Pretraine
+00000590: 6443 6f6e 6669 6760 5d20 666f 7220 6d6f  dConfig`] for mo
+000005a0: 7265 2069 6e66 6f72 6d61 7469 6f6e 2e0a  re information..
+000005b0: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
+000005c0: 2020 2020 766f 6361 625f 7369 7a65 2028      vocab_size (
+000005d0: 6069 6e74 602c 202a 6f70 7469 6f6e 616c  `int`, *optional
+000005e0: 2a2c 2064 6566 6175 6c74 7320 746f 2033  *, defaults to 3
+000005f0: 3035 3234 293a 0a20 2020 2020 2020 2020  0524):.         
+00000600: 2020 2056 6f63 6162 756c 6172 7920 7369     Vocabulary si
+00000610: 7a65 206f 6620 7468 6520 6042 6c69 7060  ze of the `Blip`
+00000620: 2074 6578 7420 6d6f 6465 6c2e 2044 6566   text model. Def
+00000630: 696e 6573 2074 6865 206e 756d 6265 7220  ines the number 
+00000640: 6f66 2064 6966 6665 7265 6e74 2074 6f6b  of different tok
+00000650: 656e 7320 7468 6174 2063 616e 2062 6520  ens that can be 
+00000660: 7265 7072 6573 656e 7465 6420 6279 0a20  represented by. 
+00000670: 2020 2020 2020 2020 2020 2074 6865 2060             the `
+00000680: 696e 7075 7473 5f69 6473 6020 7061 7373  inputs_ids` pass
+00000690: 6564 2077 6865 6e20 6361 6c6c 696e 6720  ed when calling 
+000006a0: 5b60 426c 6970 4d6f 6465 6c60 5d2e 0a20  [`BlipModel`].. 
+000006b0: 2020 2020 2020 2068 6964 6465 6e5f 7369         hidden_si
+000006c0: 7a65 2028 6069 6e74 602c 202a 6f70 7469  ze (`int`, *opti
+000006d0: 6f6e 616c 2a2c 2064 6566 6175 6c74 7320  onal*, defaults 
+000006e0: 746f 2037 3638 293a 0a20 2020 2020 2020  to 768):.       
+000006f0: 2020 2020 2044 696d 656e 7369 6f6e 616c       Dimensional
+00000700: 6974 7920 6f66 2074 6865 2065 6e63 6f64  ity of the encod
+00000710: 6572 206c 6179 6572 7320 616e 6420 7468  er layers and th
+00000720: 6520 706f 6f6c 6572 206c 6179 6572 2e0a  e pooler layer..
+00000730: 2020 2020 2020 2020 656e 636f 6465 725f          encoder_
+00000740: 6869 6464 656e 5f73 697a 6520 2860 696e  hidden_size (`in
+00000750: 7460 2c20 2a6f 7074 696f 6e61 6c2a 2c20  t`, *optional*, 
+00000760: 6465 6661 756c 7473 2074 6f20 3736 3829  defaults to 768)
+00000770: 3a0a 2020 2020 2020 2020 2020 2020 4469  :.            Di
+00000780: 6d65 6e73 696f 6e61 6c69 7479 206f 6620  mensionality of 
+00000790: 7468 6520 656e 636f 6465 7220 6c61 7965  the encoder laye
+000007a0: 7273 2066 726f 6d20 7468 6520 7669 7369  rs from the visi
+000007b0: 6f6e 206d 6f64 656c 2e0a 2020 2020 2020  on model..      
+000007c0: 2020 696e 7465 726d 6564 6961 7465 5f73    intermediate_s
+000007d0: 697a 6520 2860 696e 7460 2c20 2a6f 7074  ize (`int`, *opt
+000007e0: 696f 6e61 6c2a 2c20 6465 6661 756c 7473  ional*, defaults
+000007f0: 2074 6f20 3330 3732 293a 0a20 2020 2020   to 3072):.     
+00000800: 2020 2020 2020 2044 696d 656e 7369 6f6e         Dimension
+00000810: 616c 6974 7920 6f66 2074 6865 2022 696e  ality of the "in
+00000820: 7465 726d 6564 6961 7465 2220 2869 2e65  termediate" (i.e
+00000830: 2e2c 2066 6565 642d 666f 7277 6172 6429  ., feed-forward)
+00000840: 206c 6179 6572 2069 6e20 7468 6520 5472   layer in the Tr
+00000850: 616e 7366 6f72 6d65 7220 656e 636f 6465  ansformer encode
+00000860: 722e 0a20 2020 2020 2020 206e 756d 5f68  r..        num_h
+00000870: 6964 6465 6e5f 6c61 7965 7273 2028 6069  idden_layers (`i
+00000880: 6e74 602c 202a 6f70 7469 6f6e 616c 2a2c  nt`, *optional*,
+00000890: 2064 6566 6175 6c74 7320 746f 2031 3229   defaults to 12)
+000008a0: 3a0a 2020 2020 2020 2020 2020 2020 4e75  :.            Nu
+000008b0: 6d62 6572 206f 6620 6869 6464 656e 206c  mber of hidden l
+000008c0: 6179 6572 7320 696e 2074 6865 2054 7261  ayers in the Tra
+000008d0: 6e73 666f 726d 6572 2065 6e63 6f64 6572  nsformer encoder
+000008e0: 2e0a 2020 2020 2020 2020 6e75 6d5f 6174  ..        num_at
+000008f0: 7465 6e74 696f 6e5f 6865 6164 7320 2860  tention_heads (`
+00000900: 696e 7460 2c20 2a6f 7074 696f 6e61 6c2a  int`, *optional*
+00000910: 2c20 6465 6661 756c 7473 2074 6f20 3829  , defaults to 8)
+00000920: 3a0a 2020 2020 2020 2020 2020 2020 4e75  :.            Nu
+00000930: 6d62 6572 206f 6620 6174 7465 6e74 696f  mber of attentio
+00000940: 6e20 6865 6164 7320 666f 7220 6561 6368  n heads for each
+00000950: 2061 7474 656e 7469 6f6e 206c 6179 6572   attention layer
+00000960: 2069 6e20 7468 6520 5472 616e 7366 6f72   in the Transfor
+00000970: 6d65 7220 656e 636f 6465 722e 0a20 2020  mer encoder..   
+00000980: 2020 2020 206d 6178 5f70 6f73 6974 696f       max_positio
+00000990: 6e5f 656d 6265 6464 696e 6773 2028 6069  n_embeddings (`i
+000009a0: 6e74 602c 202a 6f70 7469 6f6e 616c 2a2c  nt`, *optional*,
+000009b0: 2064 6566 6175 6c74 7320 746f 2035 3132   defaults to 512
+000009c0: 293a 0a20 2020 2020 2020 2020 2020 2054  ):.            T
+000009d0: 6865 206d 6178 696d 756d 2073 6571 7565  he maximum seque
+000009e0: 6e63 6520 6c65 6e67 7468 2074 6861 7420  nce length that 
+000009f0: 7468 6973 206d 6f64 656c 206d 6967 6874  this model might
+00000a00: 2065 7665 7220 6265 2075 7365 6420 7769   ever be used wi
+00000a10: 7468 2e20 5479 7069 6361 6c6c 7920 7365  th. Typically se
+00000a20: 7420 7468 6973 2074 6f20 736f 6d65 7468  t this to someth
+00000a30: 696e 6720 6c61 7267 650a 2020 2020 2020  ing large.      
+00000a40: 2020 2020 2020 6a75 7374 2069 6e20 6361        just in ca
+00000a50: 7365 2028 652e 672e 2c20 3531 3220 6f72  se (e.g., 512 or
+00000a60: 2031 3032 3420 6f72 2032 3034 3829 2e0a   1024 or 2048)..
+00000a70: 2020 2020 2020 2020 6869 6464 656e 5f61          hidden_a
+00000a80: 6374 2028 6073 7472 6020 6f72 2060 6675  ct (`str` or `fu
+00000a90: 6e63 7469 6f6e 602c 202a 6f70 7469 6f6e  nction`, *option
+00000aa0: 616c 2a2c 2064 6566 6175 6c74 7320 746f  al*, defaults to
+00000ab0: 2060 2267 656c 7522 6029 3a0a 2020 2020   `"gelu"`):.    
+00000ac0: 2020 2020 2020 2020 5468 6520 6e6f 6e2d          The non-
+00000ad0: 6c69 6e65 6172 2061 6374 6976 6174 696f  linear activatio
+00000ae0: 6e20 6675 6e63 7469 6f6e 2028 6675 6e63  n function (func
+00000af0: 7469 6f6e 206f 7220 7374 7269 6e67 2920  tion or string) 
+00000b00: 696e 2074 6865 2065 6e63 6f64 6572 2061  in the encoder a
+00000b10: 6e64 2070 6f6f 6c65 722e 2049 6620 7374  nd pooler. If st
+00000b20: 7269 6e67 2c20 6022 6765 6c75 2260 2c0a  ring, `"gelu"`,.
+00000b30: 2020 2020 2020 2020 2020 2020 6022 7265              `"re
+00000b40: 6c75 2260 2c20 6022 7365 6c75 2260 2061  lu"`, `"selu"` a
+00000b50: 6e64 2060 2267 656c 755f 6e65 7722 6020  nd `"gelu_new"` 
+00000b60: 6060 2267 656c 7522 6020 6172 6520 7375  ``"gelu"` are su
+00000b70: 7070 6f72 7465 642e 0a20 2020 2020 2020  pported..       
+00000b80: 206c 6179 6572 5f6e 6f72 6d5f 6570 7320   layer_norm_eps 
+00000b90: 2860 666c 6f61 7460 2c20 2a6f 7074 696f  (`float`, *optio
+00000ba0: 6e61 6c2a 2c20 6465 6661 756c 7473 2074  nal*, defaults t
+00000bb0: 6f20 3165 2d31 3229 3a0a 2020 2020 2020  o 1e-12):.      
+00000bc0: 2020 2020 2020 5468 6520 6570 7369 6c6f        The epsilo
+00000bd0: 6e20 7573 6564 2062 7920 7468 6520 6c61  n used by the la
+00000be0: 7965 7220 6e6f 726d 616c 697a 6174 696f  yer normalizatio
+00000bf0: 6e20 6c61 7965 7273 2e0a 2020 2020 2020  n layers..      
+00000c00: 2020 6869 6464 656e 5f64 726f 706f 7574    hidden_dropout
+00000c10: 5f70 726f 6220 2860 666c 6f61 7460 2c20  _prob (`float`, 
+00000c20: 2a6f 7074 696f 6e61 6c2a 2c20 6465 6661  *optional*, defa
+00000c30: 756c 7473 2074 6f20 302e 3029 3a0a 2020  ults to 0.0):.  
+00000c40: 2020 2020 2020 2020 2020 5468 6520 6472            The dr
+00000c50: 6f70 6f75 7420 7072 6f62 6162 696c 6974  opout probabilit
+00000c60: 7920 666f 7220 616c 6c20 6675 6c6c 7920  y for all fully 
+00000c70: 636f 6e6e 6563 7465 6420 6c61 7965 7273  connected layers
+00000c80: 2069 6e20 7468 6520 656d 6265 6464 696e   in the embeddin
+00000c90: 6773 2c20 656e 636f 6465 722c 2061 6e64  gs, encoder, and
+00000ca0: 2070 6f6f 6c65 722e 0a20 2020 2020 2020   pooler..       
+00000cb0: 2061 7474 656e 7469 6f6e 5f64 726f 706f   attention_dropo
+00000cc0: 7574 2028 6066 6c6f 6174 602c 202a 6f70  ut (`float`, *op
+00000cd0: 7469 6f6e 616c 2a2c 2064 6566 6175 6c74  tional*, default
+00000ce0: 7320 746f 2030 2e30 293a 0a20 2020 2020  s to 0.0):.     
+00000cf0: 2020 2020 2020 2054 6865 2064 726f 706f         The dropo
+00000d00: 7574 2072 6174 696f 2066 6f72 2074 6865  ut ratio for the
+00000d10: 2061 7474 656e 7469 6f6e 2070 726f 6261   attention proba
+00000d20: 6269 6c69 7469 6573 2e0a 2020 2020 2020  bilities..      
+00000d30: 2020 696e 6974 6961 6c69 7a65 725f 7261    initializer_ra
+00000d40: 6e67 6520 2860 666c 6f61 7460 2c20 2a6f  nge (`float`, *o
+00000d50: 7074 696f 6e61 6c2a 2c20 6465 6661 756c  ptional*, defaul
+00000d60: 7473 2074 6f20 302e 3032 293a 0a20 2020  ts to 0.02):.   
+00000d70: 2020 2020 2020 2020 2054 6865 2073 7461           The sta
+00000d80: 6e64 6172 6420 6465 7669 6174 696f 6e20  ndard deviation 
+00000d90: 6f66 2074 6865 2074 7275 6e63 6174 6564  of the truncated
+00000da0: 5f6e 6f72 6d61 6c5f 696e 6974 6961 6c69  _normal_initiali
+00000db0: 7a65 7220 666f 7220 696e 6974 6961 6c69  zer for initiali
+00000dc0: 7a69 6e67 2061 6c6c 2077 6569 6768 7420  zing all weight 
+00000dd0: 6d61 7472 6963 6573 2e0a 2020 2020 2020  matrices..      
+00000de0: 2020 626f 735f 746f 6b65 6e5f 6964 2028    bos_token_id (
+00000df0: 6069 6e74 602c 202a 6f70 7469 6f6e 616c  `int`, *optional
+00000e00: 2a2c 2064 6566 6175 6c74 7320 746f 2033  *, defaults to 3
+00000e10: 3035 3232 293a 0a20 2020 2020 2020 2020  0522):.         
+00000e20: 2020 2054 6865 2069 6420 6f66 2074 6865     The id of the
+00000e30: 2060 6265 6769 6e6e 696e 672d 6f66 2d73   `beginning-of-s
+00000e40: 6571 7565 6e63 6560 2074 6f6b 656e 2e0a  equence` token..
+00000e50: 2020 2020 2020 2020 656f 735f 746f 6b65          eos_toke
+00000e60: 6e5f 6964 2028 6069 6e74 602c 202a 6f70  n_id (`int`, *op
+00000e70: 7469 6f6e 616c 2a2c 2064 6566 6175 6c74  tional*, default
+00000e80: 7320 746f 2032 293a 0a20 2020 2020 2020  s to 2):.       
+00000e90: 2020 2020 2054 6865 2069 6420 6f66 2074       The id of t
+00000ea0: 6865 2060 656e 642d 6f66 2d73 6571 7565  he `end-of-seque
+00000eb0: 6e63 6560 2074 6f6b 656e 2e0a 2020 2020  nce` token..    
+00000ec0: 2020 2020 7061 645f 746f 6b65 6e5f 6964      pad_token_id
+00000ed0: 2028 6069 6e74 602c 202a 6f70 7469 6f6e   (`int`, *option
+00000ee0: 616c 2a2c 2064 6566 6175 6c74 7320 746f  al*, defaults to
+00000ef0: 2030 293a 0a20 2020 2020 2020 2020 2020   0):.           
+00000f00: 2054 6865 2069 6420 6f66 2074 6865 2060   The id of the `
+00000f10: 7061 6464 696e 6760 2074 6f6b 656e 2e0a  padding` token..
+00000f20: 2020 2020 2020 2020 7365 705f 746f 6b65          sep_toke
+00000f30: 6e5f 6964 2028 6069 6e74 602c 202a 6f70  n_id (`int`, *op
+00000f40: 7469 6f6e 616c 2a2c 2064 6566 6175 6c74  tional*, default
+00000f50: 7320 746f 2031 3032 293a 0a20 2020 2020  s to 102):.     
+00000f60: 2020 2020 2020 2054 6865 2069 6420 6f66         The id of
+00000f70: 2074 6865 2060 7365 7061 7261 746f 7260   the `separator`
+00000f80: 2074 6f6b 656e 2e0a 2020 2020 2020 2020   token..        
+00000f90: 6973 5f64 6563 6f64 6572 2028 6062 6f6f  is_decoder (`boo
+00000fa0: 6c60 2c20 2a6f 7074 696f 6e61 6c2a 2c20  l`, *optional*, 
+00000fb0: 6465 6661 756c 7473 2074 6f20 6054 7275  defaults to `Tru
+00000fc0: 6560 293a 0a20 2020 2020 2020 2020 2020  e`):.           
+00000fd0: 2057 6865 7468 6572 2074 6865 206d 6f64   Whether the mod
+00000fe0: 656c 2069 7320 7573 6564 2061 7320 6120  el is used as a 
+00000ff0: 6465 636f 6465 722e 0a20 2020 2020 2020  decoder..       
+00001000: 2075 7365 5f63 6163 6865 2028 6062 6f6f   use_cache (`boo
+00001010: 6c60 2c20 2a6f 7074 696f 6e61 6c2a 2c20  l`, *optional*, 
+00001020: 6465 6661 756c 7473 2074 6f20 6054 7275  defaults to `Tru
+00001030: 6560 293a 0a20 2020 2020 2020 2020 2020  e`):.           
+00001040: 2057 6865 7468 6572 206f 7220 6e6f 7420   Whether or not 
+00001050: 7468 6520 6d6f 6465 6c20 7368 6f75 6c64  the model should
+00001060: 2072 6574 7572 6e20 7468 6520 6c61 7374   return the last
+00001070: 206b 6579 2f76 616c 7565 7320 6174 7465   key/values atte
+00001080: 6e74 696f 6e73 2028 6e6f 7420 7573 6564  ntions (not used
+00001090: 2062 7920 616c 6c20 6d6f 6465 6c73 292e   by all models).
+000010a0: 0a20 2020 2020 2020 206c 6162 656c 5f73  .        label_s
+000010b0: 6d6f 6f74 6869 6e67 2028 666c 6f61 742c  moothing (float,
+000010c0: 202a 6f70 7469 6f6e 616c 2a29 3a0a 2020   *optional*):.  
+000010d0: 2020 2020 2020 2020 2020 4120 666c 6f61            A floa
+000010e0: 7420 696e 205b 302e 302c 2031 2e30 5d2e  t in [0.0, 1.0].
+000010f0: 2053 7065 6369 6669 6573 2074 6865 2061   Specifies the a
+00001100: 6d6f 756e 7420 6f66 2073 6d6f 6f74 6869  mount of smoothi
+00001110: 6e67 2077 6865 6e20 636f 6d70 7574 696e  ng when computin
+00001120: 6720 7468 6520 6c6f 7373 2c20 7768 6572  g the loss, wher
+00001130: 6520 302e 3020 6d65 616e 7320 6e6f 2073  e 0.0 means no s
+00001140: 6d6f 6f74 6869 6e67 2e20 5468 6520 7461  moothing. The ta
+00001150: 7267 6574 730a 2020 2020 2020 2020 2020  rgets.          
+00001160: 2020 6265 636f 6d65 2061 206d 6978 7475    become a mixtu
+00001170: 7265 206f 6620 7468 6520 6f72 6967 696e  re of the origin
+00001180: 616c 2067 726f 756e 6420 7472 7574 6820  al ground truth 
+00001190: 616e 6420 6120 756e 6966 6f72 6d20 6469  and a uniform di
+000011a0: 7374 7269 6275 7469 6f6e 2061 7320 6465  stribution as de
+000011b0: 7363 7269 6265 6420 696e 0a20 2020 2020  scribed in.     
+000011c0: 2020 2020 2020 2060 5265 7468 696e 6b69         `Rethinki
+000011d0: 6e67 2074 6865 2049 6e63 6570 7469 6f6e  ng the Inception
+000011e0: 2041 7263 6869 7465 6374 7572 6520 666f   Architecture fo
+000011f0: 7220 436f 6d70 7574 6572 2056 6973 696f  r Computer Visio
+00001200: 6e20 3c68 7474 7073 3a2f 2f61 7278 6976  n <https://arxiv
+00001210: 2e6f 7267 2f61 6273 2f31 3531 322e 3030  .org/abs/1512.00
+00001220: 3536 373e 605f 5f2e 2044 6566 6175 6c74  567>`__. Default
+00001230: 3a20 3a6d 6174 683a 6030 2e30 602e 0a0a  : :math:`0.0`...
+00001240: 2020 2020 4578 616d 706c 653a 0a0a 2020      Example:..  
+00001250: 2020 6060 6070 7974 686f 6e0a 2020 2020    ```python.    
+00001260: 3e3e 3e20 6672 6f6d 2074 7261 6e73 666f  >>> from transfo
+00001270: 726d 6572 7320 696d 706f 7274 2042 6c69  rmers import Bli
+00001280: 7054 6578 7443 6f6e 6669 672c 2042 6c69  pTextConfig, Bli
+00001290: 7054 6578 744d 6f64 656c 0a0a 2020 2020  pTextModel..    
+000012a0: 3e3e 3e20 2320 496e 6974 6961 6c69 7a69  >>> # Initializi
+000012b0: 6e67 2061 2042 6c69 7054 6578 7443 6f6e  ng a BlipTextCon
+000012c0: 6669 6720 7769 7468 2053 616c 6573 666f  fig with Salesfo
+000012d0: 7263 652f 626c 6970 2d76 7161 2d62 6173  rce/blip-vqa-bas
+000012e0: 6520 7374 796c 6520 636f 6e66 6967 7572  e style configur
+000012f0: 6174 696f 6e0a 2020 2020 3e3e 3e20 636f  ation.    >>> co
+00001300: 6e66 6967 7572 6174 696f 6e20 3d20 426c  nfiguration = Bl
+00001310: 6970 5465 7874 436f 6e66 6967 2829 0a0a  ipTextConfig()..
+00001320: 2020 2020 3e3e 3e20 2320 496e 6974 6961      >>> # Initia
+00001330: 6c69 7a69 6e67 2061 2042 6c69 7054 6578  lizing a BlipTex
+00001340: 744d 6f64 656c 2028 7769 7468 2072 616e  tModel (with ran
+00001350: 646f 6d20 7765 6967 6874 7329 2066 726f  dom weights) fro
+00001360: 6d20 7468 6520 5361 6c65 7366 6f72 6365  m the Salesforce
+00001370: 2f62 6c69 702d 7671 612d 6261 7365 2073  /blip-vqa-base s
+00001380: 7479 6c65 2063 6f6e 6669 6775 7261 7469  tyle configurati
+00001390: 6f6e 0a20 2020 203e 3e3e 206d 6f64 656c  on.    >>> model
+000013a0: 203d 2042 6c69 7054 6578 744d 6f64 656c   = BlipTextModel
+000013b0: 2863 6f6e 6669 6775 7261 7469 6f6e 290a  (configuration).
+000013c0: 0a20 2020 203e 3e3e 2023 2041 6363 6573  .    >>> # Acces
+000013d0: 7369 6e67 2074 6865 206d 6f64 656c 2063  sing the model c
+000013e0: 6f6e 6669 6775 7261 7469 6f6e 0a20 2020  onfiguration.   
+000013f0: 203e 3e3e 2063 6f6e 6669 6775 7261 7469   >>> configurati
+00001400: 6f6e 203d 206d 6f64 656c 2e63 6f6e 6669  on = model.confi
+00001410: 670a 2020 2020 6060 6022 2222 0a0a 2020  g.    ```"""..  
+00001420: 2020 6d6f 6465 6c5f 7479 7065 203d 2022    model_type = "
+00001430: 626c 6970 5f74 6578 745f 6d6f 6465 6c22  blip_text_model"
+00001440: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
+00001450: 5f5f 280a 2020 2020 2020 2020 7365 6c66  __(.        self
+00001460: 2c0a 2020 2020 2020 2020 766f 6361 625f  ,.        vocab_
+00001470: 7369 7a65 3d33 3035 3234 2c0a 2020 2020  size=30524,.    
+00001480: 2020 2020 6869 6464 656e 5f73 697a 653d      hidden_size=
+00001490: 3736 382c 0a20 2020 2020 2020 2065 6e63  768,.        enc
+000014a0: 6f64 6572 5f68 6964 6465 6e5f 7369 7a65  oder_hidden_size
+000014b0: 3d37 3638 2c0a 2020 2020 2020 2020 696e  =768,.        in
+000014c0: 7465 726d 6564 6961 7465 5f73 697a 653d  termediate_size=
+000014d0: 3330 3732 2c0a 2020 2020 2020 2020 7072  3072,.        pr
+000014e0: 6f6a 6563 7469 6f6e 5f64 696d 3d37 3638  ojection_dim=768
+000014f0: 2c0a 2020 2020 2020 2020 6e75 6d5f 6869  ,.        num_hi
+00001500: 6464 656e 5f6c 6179 6572 733d 3132 2c0a  dden_layers=12,.
+00001510: 2020 2020 2020 2020 6e75 6d5f 6174 7465          num_atte
+00001520: 6e74 696f 6e5f 6865 6164 733d 382c 0a20  ntion_heads=8,. 
+00001530: 2020 2020 2020 206d 6178 5f70 6f73 6974         max_posit
+00001540: 696f 6e5f 656d 6265 6464 696e 6773 3d35  ion_embeddings=5
+00001550: 3132 2c0a 2020 2020 2020 2020 6869 6464  12,.        hidd
+00001560: 656e 5f61 6374 3d22 6765 6c75 222c 0a20  en_act="gelu",. 
+00001570: 2020 2020 2020 206c 6179 6572 5f6e 6f72         layer_nor
+00001580: 6d5f 6570 733d 3165 2d31 322c 0a20 2020  m_eps=1e-12,.   
+00001590: 2020 2020 2068 6964 6465 6e5f 6472 6f70       hidden_drop
+000015a0: 6f75 745f 7072 6f62 3d30 2e30 2c0a 2020  out_prob=0.0,.  
+000015b0: 2020 2020 2020 6174 7465 6e74 696f 6e5f        attention_
+000015c0: 7072 6f62 735f 6472 6f70 6f75 745f 7072  probs_dropout_pr
+000015d0: 6f62 3d30 2e30 2c0a 2020 2020 2020 2020  ob=0.0,.        
+000015e0: 696e 6974 6961 6c69 7a65 725f 7261 6e67  initializer_rang
+000015f0: 653d 302e 3032 2c0a 2020 2020 2020 2020  e=0.02,.        
+00001600: 626f 735f 746f 6b65 6e5f 6964 3d33 3035  bos_token_id=305
+00001610: 3232 2c0a 2020 2020 2020 2020 656f 735f  22,.        eos_
+00001620: 746f 6b65 6e5f 6964 3d32 2c0a 2020 2020  token_id=2,.    
+00001630: 2020 2020 7061 645f 746f 6b65 6e5f 6964      pad_token_id
+00001640: 3d30 2c0a 2020 2020 2020 2020 7365 705f  =0,.        sep_
+00001650: 746f 6b65 6e5f 6964 3d31 3032 2c0a 2020  token_id=102,.  
+00001660: 2020 2020 2020 6973 5f64 6563 6f64 6572        is_decoder
+00001670: 3d54 7275 652c 0a20 2020 2020 2020 2075  =True,.        u
+00001680: 7365 5f63 6163 6865 3d54 7275 652c 0a20  se_cache=True,. 
+00001690: 2020 2020 2020 206c 6162 656c 5f73 6d6f         label_smo
+000016a0: 6f74 6869 6e67 3d30 2e30 2c0a 2020 2020  othing=0.0,.    
+000016b0: 2020 2020 2a2a 6b77 6172 6773 2c0a 2020      **kwargs,.  
+000016c0: 2020 293a 0a20 2020 2020 2020 2073 7570    ):.        sup
+000016d0: 6572 2829 2e5f 5f69 6e69 745f 5f28 0a20  er().__init__(. 
+000016e0: 2020 2020 2020 2020 2020 2070 6164 5f74             pad_t
+000016f0: 6f6b 656e 5f69 643d 7061 645f 746f 6b65  oken_id=pad_toke
+00001700: 6e5f 6964 2c0a 2020 2020 2020 2020 2020  n_id,.          
+00001710: 2020 626f 735f 746f 6b65 6e5f 6964 3d62    bos_token_id=b
+00001720: 6f73 5f74 6f6b 656e 5f69 642c 0a20 2020  os_token_id,.   
+00001730: 2020 2020 2020 2020 2065 6f73 5f74 6f6b           eos_tok
+00001740: 656e 5f69 643d 656f 735f 746f 6b65 6e5f  en_id=eos_token_
+00001750: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
+00001760: 7365 705f 746f 6b65 6e5f 6964 3d73 6570  sep_token_id=sep
+00001770: 5f74 6f6b 656e 5f69 642c 0a20 2020 2020  _token_id,.     
+00001780: 2020 2020 2020 202a 2a6b 7761 7267 732c         **kwargs,
+00001790: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+000017a0: 2020 2020 7365 6c66 2e76 6f63 6162 5f73      self.vocab_s
+000017b0: 697a 6520 3d20 766f 6361 625f 7369 7a65  ize = vocab_size
+000017c0: 0a20 2020 2020 2020 2073 656c 662e 6869  .        self.hi
+000017d0: 6464 656e 5f73 697a 6520 3d20 6869 6464  dden_size = hidd
+000017e0: 656e 5f73 697a 650a 2020 2020 2020 2020  en_size.        
+000017f0: 7365 6c66 2e65 6e63 6f64 6572 5f68 6964  self.encoder_hid
+00001800: 6465 6e5f 7369 7a65 203d 2065 6e63 6f64  den_size = encod
+00001810: 6572 5f68 6964 6465 6e5f 7369 7a65 0a20  er_hidden_size. 
+00001820: 2020 2020 2020 2073 656c 662e 696e 7465         self.inte
+00001830: 726d 6564 6961 7465 5f73 697a 6520 3d20  rmediate_size = 
+00001840: 696e 7465 726d 6564 6961 7465 5f73 697a  intermediate_siz
+00001850: 650a 2020 2020 2020 2020 7365 6c66 2e70  e.        self.p
+00001860: 726f 6a65 6374 696f 6e5f 6469 6d20 3d20  rojection_dim = 
+00001870: 7072 6f6a 6563 7469 6f6e 5f64 696d 0a20  projection_dim. 
+00001880: 2020 2020 2020 2073 656c 662e 6869 6464         self.hidd
+00001890: 656e 5f64 726f 706f 7574 5f70 726f 6220  en_dropout_prob 
+000018a0: 3d20 6869 6464 656e 5f64 726f 706f 7574  = hidden_dropout
+000018b0: 5f70 726f 620a 2020 2020 2020 2020 7365  _prob.        se
+000018c0: 6c66 2e6e 756d 5f68 6964 6465 6e5f 6c61  lf.num_hidden_la
+000018d0: 7965 7273 203d 206e 756d 5f68 6964 6465  yers = num_hidde
+000018e0: 6e5f 6c61 7965 7273 0a20 2020 2020 2020  n_layers.       
+000018f0: 2073 656c 662e 6e75 6d5f 6174 7465 6e74   self.num_attent
+00001900: 696f 6e5f 6865 6164 7320 3d20 6e75 6d5f  ion_heads = num_
+00001910: 6174 7465 6e74 696f 6e5f 6865 6164 730a  attention_heads.
+00001920: 2020 2020 2020 2020 7365 6c66 2e6d 6178          self.max
+00001930: 5f70 6f73 6974 696f 6e5f 656d 6265 6464  _position_embedd
+00001940: 696e 6773 203d 206d 6178 5f70 6f73 6974  ings = max_posit
+00001950: 696f 6e5f 656d 6265 6464 696e 6773 0a20  ion_embeddings. 
+00001960: 2020 2020 2020 2073 656c 662e 6c61 7965         self.laye
+00001970: 725f 6e6f 726d 5f65 7073 203d 206c 6179  r_norm_eps = lay
+00001980: 6572 5f6e 6f72 6d5f 6570 730a 2020 2020  er_norm_eps.    
+00001990: 2020 2020 7365 6c66 2e68 6964 6465 6e5f      self.hidden_
+000019a0: 6163 7420 3d20 6869 6464 656e 5f61 6374  act = hidden_act
+000019b0: 0a20 2020 2020 2020 2073 656c 662e 696e  .        self.in
+000019c0: 6974 6961 6c69 7a65 725f 7261 6e67 6520  itializer_range 
+000019d0: 3d20 696e 6974 6961 6c69 7a65 725f 7261  = initializer_ra
+000019e0: 6e67 650a 2020 2020 2020 2020 7365 6c66  nge.        self
+000019f0: 2e61 7474 656e 7469 6f6e 5f70 726f 6273  .attention_probs
+00001a00: 5f64 726f 706f 7574 5f70 726f 6220 3d20  _dropout_prob = 
+00001a10: 6174 7465 6e74 696f 6e5f 7072 6f62 735f  attention_probs_
+00001a20: 6472 6f70 6f75 745f 7072 6f62 0a20 2020  dropout_prob.   
+00001a30: 2020 2020 2073 656c 662e 6973 5f64 6563       self.is_dec
+00001a40: 6f64 6572 203d 2069 735f 6465 636f 6465  oder = is_decode
+00001a50: 720a 2020 2020 2020 2020 7365 6c66 2e75  r.        self.u
+00001a60: 7365 5f63 6163 6865 203d 2075 7365 5f63  se_cache = use_c
+00001a70: 6163 6865 0a20 2020 2020 2020 2073 656c  ache.        sel
+00001a80: 662e 6c61 6265 6c5f 736d 6f6f 7468 696e  f.label_smoothin
+00001a90: 6720 3d20 6c61 6265 6c5f 736d 6f6f 7468  g = label_smooth
+00001aa0: 696e 670a 0a20 2020 2040 636c 6173 736d  ing..    @classm
+00001ab0: 6574 686f 640a 2020 2020 6465 6620 6672  ethod.    def fr
+00001ac0: 6f6d 5f70 7265 7472 6169 6e65 6428 636c  om_pretrained(cl
+00001ad0: 732c 2070 7265 7472 6169 6e65 645f 6d6f  s, pretrained_mo
+00001ae0: 6465 6c5f 6e61 6d65 5f6f 725f 7061 7468  del_name_or_path
+00001af0: 3a20 556e 696f 6e5b 7374 722c 206f 732e  : Union[str, os.
+00001b00: 5061 7468 4c69 6b65 5d2c 202a 2a6b 7761  PathLike], **kwa
+00001b10: 7267 7329 202d 3e20 2250 7265 7472 6169  rgs) -> "Pretrai
+00001b20: 6e65 6443 6f6e 6669 6722 3a0a 2020 2020  nedConfig":.    
+00001b30: 2020 2020 636f 6e66 6967 5f64 6963 742c      config_dict,
+00001b40: 206b 7761 7267 7320 3d20 636c 732e 6765   kwargs = cls.ge
+00001b50: 745f 636f 6e66 6967 5f64 6963 7428 7072  t_config_dict(pr
+00001b60: 6574 7261 696e 6564 5f6d 6f64 656c 5f6e  etrained_model_n
+00001b70: 616d 655f 6f72 5f70 6174 682c 202a 2a6b  ame_or_path, **k
+00001b80: 7761 7267 7329 0a0a 2020 2020 2020 2020  wargs)..        
+00001b90: 2320 6765 7420 7468 6520 7465 7874 2063  # get the text c
+00001ba0: 6f6e 6669 6720 6469 6374 2069 6620 7765  onfig dict if we
+00001bb0: 2061 7265 206c 6f61 6469 6e67 2066 726f   are loading fro
+00001bc0: 6d20 426c 6970 436f 6e66 6967 0a20 2020  m BlipConfig.   
+00001bd0: 2020 2020 2069 6620 636f 6e66 6967 5f64       if config_d
+00001be0: 6963 742e 6765 7428 226d 6f64 656c 5f74  ict.get("model_t
+00001bf0: 7970 6522 2920 3d3d 2022 626c 6970 223a  ype") == "blip":
+00001c00: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+00001c10: 6669 675f 6469 6374 203d 2063 6f6e 6669  fig_dict = confi
+00001c20: 675f 6469 6374 5b22 7465 7874 5f63 6f6e  g_dict["text_con
+00001c30: 6669 6722 5d0a 0a20 2020 2020 2020 2069  fig"]..        i
+00001c40: 6620 226d 6f64 656c 5f74 7970 6522 2069  f "model_type" i
+00001c50: 6e20 636f 6e66 6967 5f64 6963 7420 616e  n config_dict an
+00001c60: 6420 6861 7361 7474 7228 636c 732c 2022  d hasattr(cls, "
+00001c70: 6d6f 6465 6c5f 7479 7065 2229 2061 6e64  model_type") and
+00001c80: 2063 6f6e 6669 675f 6469 6374 5b22 6d6f   config_dict["mo
+00001c90: 6465 6c5f 7479 7065 225d 2021 3d20 636c  del_type"] != cl
+00001ca0: 732e 6d6f 6465 6c5f 7479 7065 3a0a 2020  s.model_type:.  
+00001cb0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+00001cc0: 2e77 6172 6e69 6e67 280a 2020 2020 2020  .warning(.      
+00001cd0: 2020 2020 2020 2020 2020 6622 596f 7520            f"You 
+00001ce0: 6172 6520 7573 696e 6720 6120 6d6f 6465  are using a mode
+00001cf0: 6c20 6f66 2074 7970 6520 7b63 6f6e 6669  l of type {confi
+00001d00: 675f 6469 6374 5b27 6d6f 6465 6c5f 7479  g_dict['model_ty
+00001d10: 7065 275d 7d20 746f 2069 6e73 7461 6e74  pe']} to instant
+00001d20: 6961 7465 2061 206d 6f64 656c 206f 6620  iate a model of 
+00001d30: 7479 7065 2022 0a20 2020 2020 2020 2020  type ".         
+00001d40: 2020 2020 2020 2066 227b 636c 732e 6d6f         f"{cls.mo
+00001d50: 6465 6c5f 7479 7065 7d2e 2054 6869 7320  del_type}. This 
+00001d60: 6973 206e 6f74 2073 7570 706f 7274 6564  is not supported
+00001d70: 2066 6f72 2061 6c6c 2063 6f6e 6669 6775   for all configu
+00001d80: 7261 7469 6f6e 7320 6f66 206d 6f64 656c  rations of model
+00001d90: 7320 616e 6420 6361 6e20 7969 656c 6420  s and can yield 
+00001da0: 6572 726f 7273 2e22 0a20 2020 2020 2020  errors.".       
+00001db0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00001dc0: 7265 7475 726e 2063 6c73 2e66 726f 6d5f  return cls.from_
+00001dd0: 6469 6374 2863 6f6e 6669 675f 6469 6374  dict(config_dict
+00001de0: 2c20 2a2a 6b77 6172 6773 290a 0a0a 636c  , **kwargs)...cl
+00001df0: 6173 7320 426c 6970 5669 7369 6f6e 436f  ass BlipVisionCo
+00001e00: 6e66 6967 2850 7265 7472 6169 6e65 6443  nfig(PretrainedC
+00001e10: 6f6e 6669 6729 3a0a 2020 2020 7222 2222  onfig):.    r"""
+00001e20: 0a20 2020 2054 6869 7320 6973 2074 6865  .    This is the
+00001e30: 2063 6f6e 6669 6775 7261 7469 6f6e 2063   configuration c
+00001e40: 6c61 7373 2074 6f20 7374 6f72 6520 7468  lass to store th
+00001e50: 6520 636f 6e66 6967 7572 6174 696f 6e20  e configuration 
+00001e60: 6f66 2061 205b 6042 6c69 7056 6973 696f  of a [`BlipVisio
+00001e70: 6e4d 6f64 656c 605d 2e20 4974 2069 7320  nModel`]. It is 
+00001e80: 7573 6564 2074 6f20 696e 7374 616e 7469  used to instanti
+00001e90: 6174 6520 610a 2020 2020 424c 4950 2076  ate a.    BLIP v
+00001ea0: 6973 696f 6e20 6d6f 6465 6c20 6163 636f  ision model acco
+00001eb0: 7264 696e 6720 746f 2074 6865 2073 7065  rding to the spe
+00001ec0: 6369 6669 6564 2061 7267 756d 656e 7473  cified arguments
+00001ed0: 2c20 6465 6669 6e69 6e67 2074 6865 206d  , defining the m
+00001ee0: 6f64 656c 2061 7263 6869 7465 6374 7572  odel architectur
+00001ef0: 652e 2049 6e73 7461 6e74 6961 7469 6e67  e. Instantiating
+00001f00: 2061 0a20 2020 2063 6f6e 6669 6775 7261   a.    configura
+00001f10: 7469 6f6e 2064 6566 6175 6c74 7320 7769  tion defaults wi
+00001f20: 6c6c 2079 6965 6c64 2061 2073 696d 696c  ll yield a simil
+00001f30: 6172 2063 6f6e 6669 6775 7261 7469 6f6e  ar configuration
+00001f40: 2074 6f20 7468 6174 206f 6620 7468 6520   to that of the 
+00001f50: 426c 6970 2d62 6173 650a 2020 2020 5b53  Blip-base.    [S
+00001f60: 616c 6573 666f 7263 652f 626c 6970 2d76  alesforce/blip-v
+00001f70: 7161 2d62 6173 655d 2868 7474 7073 3a2f  qa-base](https:/
+00001f80: 2f68 7567 6769 6e67 6661 6365 2e63 6f2f  /huggingface.co/
+00001f90: 5361 6c65 7366 6f72 6365 2f62 6c69 702d  Salesforce/blip-
+00001fa0: 7671 612d 6261 7365 2920 6172 6368 6974  vqa-base) archit
+00001fb0: 6563 7475 7265 2e0a 0a20 2020 2043 6f6e  ecture...    Con
+00001fc0: 6669 6775 7261 7469 6f6e 206f 626a 6563  figuration objec
+00001fd0: 7473 2069 6e68 6572 6974 2066 726f 6d20  ts inherit from 
+00001fe0: 5b60 5072 6574 7261 696e 6564 436f 6e66  [`PretrainedConf
+00001ff0: 6967 605d 2061 6e64 2063 616e 2062 6520  ig`] and can be 
+00002000: 7573 6564 2074 6f20 636f 6e74 726f 6c20  used to control 
+00002010: 7468 6520 6d6f 6465 6c20 6f75 7470 7574  the model output
+00002020: 732e 2052 6561 6420 7468 650a 2020 2020  s. Read the.    
+00002030: 646f 6375 6d65 6e74 6174 696f 6e20 6672  documentation fr
+00002040: 6f6d 205b 6050 7265 7472 6169 6e65 6443  om [`PretrainedC
+00002050: 6f6e 6669 6760 5d20 666f 7220 6d6f 7265  onfig`] for more
+00002060: 2069 6e66 6f72 6d61 7469 6f6e 2e0a 0a0a   information....
+00002070: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+00002080: 2020 6869 6464 656e 5f73 697a 6520 2860    hidden_size (`
+00002090: 696e 7460 2c20 2a6f 7074 696f 6e61 6c2a  int`, *optional*
+000020a0: 2c20 6465 6661 756c 7473 2074 6f20 3736  , defaults to 76
+000020b0: 3829 3a0a 2020 2020 2020 2020 2020 2020  8):.            
+000020c0: 4469 6d65 6e73 696f 6e61 6c69 7479 206f  Dimensionality o
+000020d0: 6620 7468 6520 656e 636f 6465 7220 6c61  f the encoder la
+000020e0: 7965 7273 2061 6e64 2074 6865 2070 6f6f  yers and the poo
+000020f0: 6c65 7220 6c61 7965 722e 0a20 2020 2020  ler layer..     
+00002100: 2020 2069 6e74 6572 6d65 6469 6174 655f     intermediate_
+00002110: 7369 7a65 2028 6069 6e74 602c 202a 6f70  size (`int`, *op
+00002120: 7469 6f6e 616c 2a2c 2064 6566 6175 6c74  tional*, default
+00002130: 7320 746f 2033 3037 3229 3a0a 2020 2020  s to 3072):.    
+00002140: 2020 2020 2020 2020 4469 6d65 6e73 696f          Dimensio
+00002150: 6e61 6c69 7479 206f 6620 7468 6520 2269  nality of the "i
+00002160: 6e74 6572 6d65 6469 6174 6522 2028 692e  ntermediate" (i.
+00002170: 652e 2c20 6665 6564 2d66 6f72 7761 7264  e., feed-forward
+00002180: 2920 6c61 7965 7220 696e 2074 6865 2054  ) layer in the T
+00002190: 7261 6e73 666f 726d 6572 2065 6e63 6f64  ransformer encod
+000021a0: 6572 2e0a 2020 2020 2020 2020 6e75 6d5f  er..        num_
+000021b0: 6869 6464 656e 5f6c 6179 6572 7320 2860  hidden_layers (`
+000021c0: 696e 7460 2c20 2a6f 7074 696f 6e61 6c2a  int`, *optional*
+000021d0: 2c20 6465 6661 756c 7473 2074 6f20 3132  , defaults to 12
+000021e0: 293a 0a20 2020 2020 2020 2020 2020 204e  ):.            N
+000021f0: 756d 6265 7220 6f66 2068 6964 6465 6e20  umber of hidden 
+00002200: 6c61 7965 7273 2069 6e20 7468 6520 5472  layers in the Tr
+00002210: 616e 7366 6f72 6d65 7220 656e 636f 6465  ansformer encode
+00002220: 722e 0a20 2020 2020 2020 206e 756d 5f61  r..        num_a
+00002230: 7474 656e 7469 6f6e 5f68 6561 6473 2028  ttention_heads (
+00002240: 6069 6e74 602c 202a 6f70 7469 6f6e 616c  `int`, *optional
+00002250: 2a2c 2064 6566 6175 6c74 7320 746f 2031  *, defaults to 1
+00002260: 3229 3a0a 2020 2020 2020 2020 2020 2020  2):.            
+00002270: 4e75 6d62 6572 206f 6620 6174 7465 6e74  Number of attent
+00002280: 696f 6e20 6865 6164 7320 666f 7220 6561  ion heads for ea
+00002290: 6368 2061 7474 656e 7469 6f6e 206c 6179  ch attention lay
+000022a0: 6572 2069 6e20 7468 6520 5472 616e 7366  er in the Transf
+000022b0: 6f72 6d65 7220 656e 636f 6465 722e 0a20  ormer encoder.. 
+000022c0: 2020 2020 2020 2069 6d61 6765 5f73 697a         image_siz
+000022d0: 6520 2860 696e 7460 2c20 2a6f 7074 696f  e (`int`, *optio
+000022e0: 6e61 6c2a 2c20 6465 6661 756c 7473 2074  nal*, defaults t
+000022f0: 6f20 3338 3429 3a0a 2020 2020 2020 2020  o 384):.        
+00002300: 2020 2020 5468 6520 7369 7a65 2028 7265      The size (re
+00002310: 736f 6c75 7469 6f6e 2920 6f66 2065 6163  solution) of eac
+00002320: 6820 696d 6167 652e 0a20 2020 2020 2020  h image..       
+00002330: 2070 6174 6368 5f73 697a 6520 2860 696e   patch_size (`in
+00002340: 7460 2c20 2a6f 7074 696f 6e61 6c2a 2c20  t`, *optional*, 
+00002350: 6465 6661 756c 7473 2074 6f20 3136 293a  defaults to 16):
+00002360: 0a20 2020 2020 2020 2020 2020 2054 6865  .            The
+00002370: 2073 697a 6520 2872 6573 6f6c 7574 696f   size (resolutio
+00002380: 6e29 206f 6620 6561 6368 2070 6174 6368  n) of each patch
+00002390: 2e0a 2020 2020 2020 2020 6869 6464 656e  ..        hidden
+000023a0: 5f61 6374 2028 6073 7472 6020 6f72 2060  _act (`str` or `
+000023b0: 6675 6e63 7469 6f6e 602c 202a 6f70 7469  function`, *opti
+000023c0: 6f6e 616c 2a2c 2064 6566 6175 6c74 7320  onal*, defaults 
+000023d0: 746f 2060 2267 656c 7522 6029 3a0a 2020  to `"gelu"`):.  
+000023e0: 2020 2020 2020 2020 2020 5468 6520 6e6f            The no
+000023f0: 6e2d 6c69 6e65 6172 2061 6374 6976 6174  n-linear activat
+00002400: 696f 6e20 6675 6e63 7469 6f6e 2028 6675  ion function (fu
+00002410: 6e63 7469 6f6e 206f 7220 7374 7269 6e67  nction or string
+00002420: 2920 696e 2074 6865 2065 6e63 6f64 6572  ) in the encoder
+00002430: 2061 6e64 2070 6f6f 6c65 722e 2049 6620   and pooler. If 
+00002440: 7374 7269 6e67 2c20 6022 6765 6c75 2260  string, `"gelu"`
+00002450: 2c0a 2020 2020 2020 2020 2020 2020 6022  ,.            `"
+00002460: 7265 6c75 2260 2c20 6022 7365 6c75 2260  relu"`, `"selu"`
+00002470: 2061 6e64 2060 2267 656c 755f 6e65 7722   and `"gelu_new"
+00002480: 6020 6060 2267 656c 7522 6020 6172 6520  ` ``"gelu"` are 
+00002490: 7375 7070 6f72 7465 642e 0a20 2020 2020  supported..     
+000024a0: 2020 206c 6179 6572 5f6e 6f72 6d5f 6570     layer_norm_ep
+000024b0: 7320 2860 666c 6f61 7460 2c20 2a6f 7074  s (`float`, *opt
+000024c0: 696f 6e61 6c2a 2c20 6465 6661 756c 7473  ional*, defaults
+000024d0: 2074 6f20 3165 2d35 293a 0a20 2020 2020   to 1e-5):.     
+000024e0: 2020 2020 2020 2054 6865 2065 7073 696c         The epsil
+000024f0: 6f6e 2075 7365 6420 6279 2074 6865 206c  on used by the l
+00002500: 6179 6572 206e 6f72 6d61 6c69 7a61 7469  ayer normalizati
+00002510: 6f6e 206c 6179 6572 732e 0a20 2020 2020  on layers..     
+00002520: 2020 2061 7474 656e 7469 6f6e 5f64 726f     attention_dro
+00002530: 706f 7574 2028 6066 6c6f 6174 602c 202a  pout (`float`, *
+00002540: 6f70 7469 6f6e 616c 2a2c 2064 6566 6175  optional*, defau
+00002550: 6c74 7320 746f 2030 2e30 293a 0a20 2020  lts to 0.0):.   
+00002560: 2020 2020 2020 2020 2054 6865 2064 726f           The dro
+00002570: 706f 7574 2072 6174 696f 2066 6f72 2074  pout ratio for t
+00002580: 6865 2061 7474 656e 7469 6f6e 2070 726f  he attention pro
+00002590: 6261 6269 6c69 7469 6573 2e0a 2020 2020  babilities..    
+000025a0: 2020 2020 696e 6974 6961 6c69 7a65 725f      initializer_
+000025b0: 7261 6e67 6520 2860 666c 6f61 7460 2c20  range (`float`, 
+000025c0: 2a6f 7074 696f 6e61 6c2a 2c20 6465 6661  *optional*, defa
+000025d0: 756c 7473 2074 6f20 3165 2d31 3029 3a0a  ults to 1e-10):.
+000025e0: 2020 2020 2020 2020 2020 2020 5468 6520              The 
+000025f0: 7374 616e 6461 7264 2064 6576 6961 7469  standard deviati
+00002600: 6f6e 206f 6620 7468 6520 7472 756e 6361  on of the trunca
+00002610: 7465 645f 6e6f 726d 616c 5f69 6e69 7469  ted_normal_initi
+00002620: 616c 697a 6572 2066 6f72 2069 6e69 7469  alizer for initi
+00002630: 616c 697a 696e 6720 616c 6c20 7765 6967  alizing all weig
+00002640: 6874 206d 6174 7269 6365 732e 0a0a 2020  ht matrices...  
+00002650: 2020 4578 616d 706c 653a 0a0a 2020 2020    Example:..    
+00002660: 6060 6070 7974 686f 6e0a 2020 2020 3e3e  ```python.    >>
+00002670: 3e20 6672 6f6d 2074 7261 6e73 666f 726d  > from transform
+00002680: 6572 7320 696d 706f 7274 2042 6c69 7056  ers import BlipV
+00002690: 6973 696f 6e43 6f6e 6669 672c 2042 6c69  isionConfig, Bli
+000026a0: 7056 6973 696f 6e4d 6f64 656c 0a0a 2020  pVisionModel..  
+000026b0: 2020 3e3e 3e20 2320 496e 6974 6961 6c69    >>> # Initiali
+000026c0: 7a69 6e67 2061 2042 6c69 7056 6973 696f  zing a BlipVisio
+000026d0: 6e43 6f6e 6669 6720 7769 7468 2053 616c  nConfig with Sal
+000026e0: 6573 666f 7263 652f 626c 6970 2d76 7161  esforce/blip-vqa
+000026f0: 2d62 6173 6520 7374 796c 6520 636f 6e66  -base style conf
+00002700: 6967 7572 6174 696f 6e0a 2020 2020 3e3e  iguration.    >>
+00002710: 3e20 636f 6e66 6967 7572 6174 696f 6e20  > configuration 
+00002720: 3d20 426c 6970 5669 7369 6f6e 436f 6e66  = BlipVisionConf
+00002730: 6967 2829 0a0a 2020 2020 3e3e 3e20 2320  ig()..    >>> # 
+00002740: 496e 6974 6961 6c69 7a69 6e67 2061 2042  Initializing a B
+00002750: 6c69 7056 6973 696f 6e4d 6f64 656c 2028  lipVisionModel (
+00002760: 7769 7468 2072 616e 646f 6d20 7765 6967  with random weig
+00002770: 6874 7329 2066 726f 6d20 7468 6520 5361  hts) from the Sa
+00002780: 6c65 7366 6f72 6365 2f62 6c69 702d 7671  lesforce/blip-vq
+00002790: 612d 6261 7365 2073 7479 6c65 2063 6f6e  a-base style con
+000027a0: 6669 6775 7261 7469 6f6e 0a20 2020 203e  figuration.    >
+000027b0: 3e3e 206d 6f64 656c 203d 2042 6c69 7056  >> model = BlipV
+000027c0: 6973 696f 6e4d 6f64 656c 2863 6f6e 6669  isionModel(confi
+000027d0: 6775 7261 7469 6f6e 290a 0a20 2020 203e  guration)..    >
+000027e0: 3e3e 2023 2041 6363 6573 7369 6e67 2074  >> # Accessing t
+000027f0: 6865 206d 6f64 656c 2063 6f6e 6669 6775  he model configu
+00002800: 7261 7469 6f6e 0a20 2020 203e 3e3e 2063  ration.    >>> c
+00002810: 6f6e 6669 6775 7261 7469 6f6e 203d 206d  onfiguration = m
+00002820: 6f64 656c 2e63 6f6e 6669 670a 2020 2020  odel.config.    
+00002830: 6060 6022 2222 0a0a 2020 2020 6d6f 6465  ```"""..    mode
+00002840: 6c5f 7479 7065 203d 2022 626c 6970 5f76  l_type = "blip_v
+00002850: 6973 696f 6e5f 6d6f 6465 6c22 0a0a 2020  ision_model"..  
+00002860: 2020 6465 6620 5f5f 696e 6974 5f5f 280a    def __init__(.
+00002870: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+00002880: 2020 2020 2020 6869 6464 656e 5f73 697a        hidden_siz
+00002890: 653d 3736 382c 0a20 2020 2020 2020 2069  e=768,.        i
+000028a0: 6e74 6572 6d65 6469 6174 655f 7369 7a65  ntermediate_size
+000028b0: 3d33 3037 322c 0a20 2020 2020 2020 2070  =3072,.        p
+000028c0: 726f 6a65 6374 696f 6e5f 6469 6d3d 3531  rojection_dim=51
+000028d0: 322c 0a20 2020 2020 2020 206e 756d 5f68  2,.        num_h
+000028e0: 6964 6465 6e5f 6c61 7965 7273 3d31 322c  idden_layers=12,
+000028f0: 0a20 2020 2020 2020 206e 756d 5f61 7474  .        num_att
+00002900: 656e 7469 6f6e 5f68 6561 6473 3d31 322c  ention_heads=12,
+00002910: 0a20 2020 2020 2020 2069 6d61 6765 5f73  .        image_s
+00002920: 697a 653d 3338 342c 0a20 2020 2020 2020  ize=384,.       
+00002930: 2070 6174 6368 5f73 697a 653d 3136 2c0a   patch_size=16,.
+00002940: 2020 2020 2020 2020 6869 6464 656e 5f61          hidden_a
+00002950: 6374 3d22 6765 6c75 222c 0a20 2020 2020  ct="gelu",.     
+00002960: 2020 206c 6179 6572 5f6e 6f72 6d5f 6570     layer_norm_ep
+00002970: 733d 3165 2d35 2c0a 2020 2020 2020 2020  s=1e-5,.        
+00002980: 6174 7465 6e74 696f 6e5f 6472 6f70 6f75  attention_dropou
+00002990: 743d 302e 302c 0a20 2020 2020 2020 2069  t=0.0,.        i
+000029a0: 6e69 7469 616c 697a 6572 5f72 616e 6765  nitializer_range
+000029b0: 3d31 652d 3130 2c0a 2020 2020 2020 2020  =1e-10,.        
+000029c0: 2a2a 6b77 6172 6773 2c0a 2020 2020 293a  **kwargs,.    ):
+000029d0: 0a20 2020 2020 2020 2073 7570 6572 2829  .        super()
+000029e0: 2e5f 5f69 6e69 745f 5f28 2a2a 6b77 6172  .__init__(**kwar
+000029f0: 6773 290a 0a20 2020 2020 2020 2073 656c  gs)..        sel
+00002a00: 662e 6869 6464 656e 5f73 697a 6520 3d20  f.hidden_size = 
+00002a10: 6869 6464 656e 5f73 697a 650a 2020 2020  hidden_size.    
+00002a20: 2020 2020 7365 6c66 2e69 6e74 6572 6d65      self.interme
+00002a30: 6469 6174 655f 7369 7a65 203d 2069 6e74  diate_size = int
+00002a40: 6572 6d65 6469 6174 655f 7369 7a65 0a20  ermediate_size. 
+00002a50: 2020 2020 2020 2073 656c 662e 7072 6f6a         self.proj
+00002a60: 6563 7469 6f6e 5f64 696d 203d 2070 726f  ection_dim = pro
+00002a70: 6a65 6374 696f 6e5f 6469 6d0a 2020 2020  jection_dim.    
+00002a80: 2020 2020 7365 6c66 2e6e 756d 5f68 6964      self.num_hid
+00002a90: 6465 6e5f 6c61 7965 7273 203d 206e 756d  den_layers = num
+00002aa0: 5f68 6964 6465 6e5f 6c61 7965 7273 0a20  _hidden_layers. 
+00002ab0: 2020 2020 2020 2073 656c 662e 6e75 6d5f         self.num_
+00002ac0: 6174 7465 6e74 696f 6e5f 6865 6164 7320  attention_heads 
+00002ad0: 3d20 6e75 6d5f 6174 7465 6e74 696f 6e5f  = num_attention_
+00002ae0: 6865 6164 730a 2020 2020 2020 2020 7365  heads.        se
+00002af0: 6c66 2e70 6174 6368 5f73 697a 6520 3d20  lf.patch_size = 
+00002b00: 7061 7463 685f 7369 7a65 0a20 2020 2020  patch_size.     
+00002b10: 2020 2073 656c 662e 696d 6167 655f 7369     self.image_si
+00002b20: 7a65 203d 2069 6d61 6765 5f73 697a 650a  ze = image_size.
+00002b30: 2020 2020 2020 2020 7365 6c66 2e69 6e69          self.ini
+00002b40: 7469 616c 697a 6572 5f72 616e 6765 203d  tializer_range =
+00002b50: 2069 6e69 7469 616c 697a 6572 5f72 616e   initializer_ran
+00002b60: 6765 0a20 2020 2020 2020 2073 656c 662e  ge.        self.
+00002b70: 6174 7465 6e74 696f 6e5f 6472 6f70 6f75  attention_dropou
+00002b80: 7420 3d20 6174 7465 6e74 696f 6e5f 6472  t = attention_dr
+00002b90: 6f70 6f75 740a 2020 2020 2020 2020 7365  opout.        se
+00002ba0: 6c66 2e6c 6179 6572 5f6e 6f72 6d5f 6570  lf.layer_norm_ep
+00002bb0: 7320 3d20 6c61 7965 725f 6e6f 726d 5f65  s = layer_norm_e
+00002bc0: 7073 0a20 2020 2020 2020 2073 656c 662e  ps.        self.
+00002bd0: 6869 6464 656e 5f61 6374 203d 2068 6964  hidden_act = hid
+00002be0: 6465 6e5f 6163 740a 0a20 2020 2040 636c  den_act..    @cl
+00002bf0: 6173 736d 6574 686f 640a 2020 2020 6465  assmethod.    de
+00002c00: 6620 6672 6f6d 5f70 7265 7472 6169 6e65  f from_pretraine
+00002c10: 6428 636c 732c 2070 7265 7472 6169 6e65  d(cls, pretraine
+00002c20: 645f 6d6f 6465 6c5f 6e61 6d65 5f6f 725f  d_model_name_or_
+00002c30: 7061 7468 3a20 556e 696f 6e5b 7374 722c  path: Union[str,
+00002c40: 206f 732e 5061 7468 4c69 6b65 5d2c 202a   os.PathLike], *
+00002c50: 2a6b 7761 7267 7329 202d 3e20 2250 7265  *kwargs) -> "Pre
+00002c60: 7472 6169 6e65 6443 6f6e 6669 6722 3a0a  trainedConfig":.
+00002c70: 2020 2020 2020 2020 636f 6e66 6967 5f64          config_d
+00002c80: 6963 742c 206b 7761 7267 7320 3d20 636c  ict, kwargs = cl
+00002c90: 732e 6765 745f 636f 6e66 6967 5f64 6963  s.get_config_dic
+00002ca0: 7428 7072 6574 7261 696e 6564 5f6d 6f64  t(pretrained_mod
+00002cb0: 656c 5f6e 616d 655f 6f72 5f70 6174 682c  el_name_or_path,
+00002cc0: 202a 2a6b 7761 7267 7329 0a0a 2020 2020   **kwargs)..    
+00002cd0: 2020 2020 2320 6765 7420 7468 6520 7669      # get the vi
+00002ce0: 7369 6f6e 2063 6f6e 6669 6720 6469 6374  sion config dict
+00002cf0: 2069 6620 7765 2061 7265 206c 6f61 6469   if we are loadi
+00002d00: 6e67 2066 726f 6d20 426c 6970 436f 6e66  ng from BlipConf
+00002d10: 6967 0a20 2020 2020 2020 2069 6620 636f  ig.        if co
+00002d20: 6e66 6967 5f64 6963 742e 6765 7428 226d  nfig_dict.get("m
+00002d30: 6f64 656c 5f74 7970 6522 2920 3d3d 2022  odel_type") == "
+00002d40: 626c 6970 223a 0a20 2020 2020 2020 2020  blip":.         
+00002d50: 2020 2063 6f6e 6669 675f 6469 6374 203d     config_dict =
+00002d60: 2063 6f6e 6669 675f 6469 6374 5b22 7669   config_dict["vi
+00002d70: 7369 6f6e 5f63 6f6e 6669 6722 5d0a 0a20  sion_config"].. 
+00002d80: 2020 2020 2020 2069 6620 226d 6f64 656c         if "model
+00002d90: 5f74 7970 6522 2069 6e20 636f 6e66 6967  _type" in config
+00002da0: 5f64 6963 7420 616e 6420 6861 7361 7474  _dict and hasatt
+00002db0: 7228 636c 732c 2022 6d6f 6465 6c5f 7479  r(cls, "model_ty
+00002dc0: 7065 2229 2061 6e64 2063 6f6e 6669 675f  pe") and config_
+00002dd0: 6469 6374 5b22 6d6f 6465 6c5f 7479 7065  dict["model_type
+00002de0: 225d 2021 3d20 636c 732e 6d6f 6465 6c5f  "] != cls.model_
+00002df0: 7479 7065 3a0a 2020 2020 2020 2020 2020  type:.          
+00002e00: 2020 6c6f 6767 6572 2e77 6172 6e69 6e67    logger.warning
+00002e10: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00002e20: 2020 6622 596f 7520 6172 6520 7573 696e    f"You are usin
+00002e30: 6720 6120 6d6f 6465 6c20 6f66 2074 7970  g a model of typ
+00002e40: 6520 7b63 6f6e 6669 675f 6469 6374 5b27  e {config_dict['
+00002e50: 6d6f 6465 6c5f 7479 7065 275d 7d20 746f  model_type']} to
+00002e60: 2069 6e73 7461 6e74 6961 7465 2061 206d   instantiate a m
+00002e70: 6f64 656c 206f 6620 7479 7065 2022 0a20  odel of type ". 
+00002e80: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00002e90: 227b 636c 732e 6d6f 6465 6c5f 7479 7065  "{cls.model_type
+00002ea0: 7d2e 2054 6869 7320 6973 206e 6f74 2073  }. This is not s
+00002eb0: 7570 706f 7274 6564 2066 6f72 2061 6c6c  upported for all
+00002ec0: 2063 6f6e 6669 6775 7261 7469 6f6e 7320   configurations 
+00002ed0: 6f66 206d 6f64 656c 7320 616e 6420 6361  of models and ca
+00002ee0: 6e20 7969 656c 6420 6572 726f 7273 2e22  n yield errors."
+00002ef0: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+00002f00: 2020 2020 2020 2020 7265 7475 726e 2063          return c
+00002f10: 6c73 2e66 726f 6d5f 6469 6374 2863 6f6e  ls.from_dict(con
+00002f20: 6669 675f 6469 6374 2c20 2a2a 6b77 6172  fig_dict, **kwar
+00002f30: 6773 290a 0a0a 636c 6173 7320 426c 6970  gs)...class Blip
+00002f40: 436f 6e66 6967 2850 7265 7472 6169 6e65  Config(Pretraine
+00002f50: 6443 6f6e 6669 6729 3a0a 2020 2020 7222  dConfig):.    r"
+00002f60: 2222 0a20 2020 205b 6042 6c69 7043 6f6e  "".    [`BlipCon
+00002f70: 6669 6760 5d20 6973 2074 6865 2063 6f6e  fig`] is the con
+00002f80: 6669 6775 7261 7469 6f6e 2063 6c61 7373  figuration class
+00002f90: 2074 6f20 7374 6f72 6520 7468 6520 636f   to store the co
+00002fa0: 6e66 6967 7572 6174 696f 6e20 6f66 2061  nfiguration of a
+00002fb0: 205b 6042 6c69 704d 6f64 656c 605d 2e20   [`BlipModel`]. 
+00002fc0: 4974 2069 7320 7573 6564 2074 6f20 696e  It is used to in
+00002fd0: 7374 616e 7469 6174 650a 2020 2020 6120  stantiate.    a 
+00002fe0: 424c 4950 206d 6f64 656c 2061 6363 6f72  BLIP model accor
+00002ff0: 6469 6e67 2074 6f20 7468 6520 7370 6563  ding to the spec
+00003000: 6966 6965 6420 6172 6775 6d65 6e74 732c  ified arguments,
+00003010: 2064 6566 696e 696e 6720 7468 6520 7465   defining the te
+00003020: 7874 206d 6f64 656c 2061 6e64 2076 6973  xt model and vis
+00003030: 696f 6e20 6d6f 6465 6c20 636f 6e66 6967  ion model config
+00003040: 732e 2049 6e73 7461 6e74 6961 7469 6e67  s. Instantiating
+00003050: 0a20 2020 2061 2063 6f6e 6669 6775 7261  .    a configura
+00003060: 7469 6f6e 2077 6974 6820 7468 6520 6465  tion with the de
+00003070: 6661 756c 7473 2077 696c 6c20 7969 656c  faults will yiel
+00003080: 6420 6120 7369 6d69 6c61 7220 636f 6e66  d a similar conf
+00003090: 6967 7572 6174 696f 6e20 746f 2074 6861  iguration to tha
+000030a0: 7420 6f66 2074 6865 2042 4c49 502d 6261  t of the BLIP-ba
+000030b0: 7365 0a20 2020 205b 5361 6c65 7366 6f72  se.    [Salesfor
+000030c0: 6365 2f62 6c69 702d 7671 612d 6261 7365  ce/blip-vqa-base
+000030d0: 5d28 6874 7470 733a 2f2f 6875 6767 696e  ](https://huggin
+000030e0: 6766 6163 652e 636f 2f53 616c 6573 666f  gface.co/Salesfo
+000030f0: 7263 652f 626c 6970 2d76 7161 2d62 6173  rce/blip-vqa-bas
+00003100: 6529 2061 7263 6869 7465 6374 7572 652e  e) architecture.
+00003110: 0a0a 2020 2020 436f 6e66 6967 7572 6174  ..    Configurat
+00003120: 696f 6e20 6f62 6a65 6374 7320 696e 6865  ion objects inhe
+00003130: 7269 7420 6672 6f6d 205b 6050 7265 7472  rit from [`Pretr
+00003140: 6169 6e65 6443 6f6e 6669 6760 5d20 616e  ainedConfig`] an
+00003150: 6420 6361 6e20 6265 2075 7365 6420 746f  d can be used to
+00003160: 2063 6f6e 7472 6f6c 2074 6865 206d 6f64   control the mod
+00003170: 656c 206f 7574 7075 7473 2e20 5265 6164  el outputs. Read
+00003180: 2074 6865 0a20 2020 2064 6f63 756d 656e   the.    documen
+00003190: 7461 7469 6f6e 2066 726f 6d20 5b60 5072  tation from [`Pr
+000031a0: 6574 7261 696e 6564 436f 6e66 6967 605d  etrainedConfig`]
+000031b0: 2066 6f72 206d 6f72 6520 696e 666f 726d   for more inform
+000031c0: 6174 696f 6e2e 0a0a 2020 2020 4172 6773  ation...    Args
+000031d0: 3a0a 2020 2020 2020 2020 7465 7874 5f63  :.        text_c
+000031e0: 6f6e 6669 6720 2860 6469 6374 602c 202a  onfig (`dict`, *
+000031f0: 6f70 7469 6f6e 616c 2a29 3a0a 2020 2020  optional*):.    
+00003200: 2020 2020 2020 2020 4469 6374 696f 6e61          Dictiona
+00003210: 7279 206f 6620 636f 6e66 6967 7572 6174  ry of configurat
+00003220: 696f 6e20 6f70 7469 6f6e 7320 7573 6564  ion options used
+00003230: 2074 6f20 696e 6974 6961 6c69 7a65 205b   to initialize [
+00003240: 6042 6c69 7054 6578 7443 6f6e 6669 6760  `BlipTextConfig`
+00003250: 5d2e 0a20 2020 2020 2020 2076 6973 696f  ]..        visio
+00003260: 6e5f 636f 6e66 6967 2028 6064 6963 7460  n_config (`dict`
+00003270: 2c20 2a6f 7074 696f 6e61 6c2a 293a 0a20  , *optional*):. 
+00003280: 2020 2020 2020 2020 2020 2044 6963 7469             Dicti
+00003290: 6f6e 6172 7920 6f66 2063 6f6e 6669 6775  onary of configu
+000032a0: 7261 7469 6f6e 206f 7074 696f 6e73 2075  ration options u
+000032b0: 7365 6420 746f 2069 6e69 7469 616c 697a  sed to initializ
+000032c0: 6520 5b60 426c 6970 5669 7369 6f6e 436f  e [`BlipVisionCo
+000032d0: 6e66 6967 605d 2e0a 2020 2020 2020 2020  nfig`]..        
+000032e0: 7072 6f6a 6563 7469 6f6e 5f64 696d 2028  projection_dim (
+000032f0: 6069 6e74 602c 202a 6f70 7469 6f6e 616c  `int`, *optional
+00003300: 2a2c 2064 6566 6175 6c74 7320 746f 2035  *, defaults to 5
+00003310: 3132 293a 0a20 2020 2020 2020 2020 2020  12):.           
+00003320: 2044 696d 656e 7469 6f6e 616c 6974 7920   Dimentionality 
+00003330: 6f66 2074 6578 7420 616e 6420 7669 7369  of text and visi
+00003340: 6f6e 2070 726f 6a65 6374 696f 6e20 6c61  on projection la
+00003350: 7965 7273 2e0a 2020 2020 2020 2020 6c6f  yers..        lo
+00003360: 6769 745f 7363 616c 655f 696e 6974 5f76  git_scale_init_v
+00003370: 616c 7565 2028 6066 6c6f 6174 602c 202a  alue (`float`, *
+00003380: 6f70 7469 6f6e 616c 2a2c 2064 6566 6175  optional*, defau
+00003390: 6c74 7320 746f 2032 2e36 3539 3229 3a0a  lts to 2.6592):.
+000033a0: 2020 2020 2020 2020 2020 2020 5468 6520              The 
+000033b0: 696e 6974 616c 2076 616c 7565 206f 6620  inital value of 
+000033c0: 7468 6520 2a6c 6f67 6974 5f73 6361 6c65  the *logit_scale
+000033d0: 2a20 7061 7261 6d74 6572 2e20 4465 6661  * paramter. Defa
+000033e0: 756c 7420 6973 2075 7365 6420 6173 2070  ult is used as p
+000033f0: 6572 2074 6865 206f 7269 6769 6e61 6c20  er the original 
+00003400: 424c 4950 2069 6d70 6c65 6d65 6e74 6174  BLIP implementat
+00003410: 696f 6e2e 0a20 2020 2020 2020 2069 6d61  ion..        ima
+00003420: 6765 5f74 6578 745f 6869 6464 656e 5f73  ge_text_hidden_s
+00003430: 697a 6520 2860 696e 7460 2c20 2a6f 7074  ize (`int`, *opt
+00003440: 696f 6e61 6c2a 2c20 6465 6661 756c 7473  ional*, defaults
+00003450: 2074 6f20 3235 3629 3a0a 2020 2020 2020   to 256):.      
+00003460: 2020 2020 2020 4469 6d65 6e74 696f 6e61        Dimentiona
+00003470: 6c69 7479 206f 6620 7468 6520 6869 6464  lity of the hidd
+00003480: 656e 2073 7461 7465 206f 6620 7468 6520  en state of the 
+00003490: 696d 6167 652d 7465 7874 2066 7573 696f  image-text fusio
+000034a0: 6e20 6c61 7965 722e 0a20 2020 2020 2020  n layer..       
+000034b0: 206c 6162 656c 5f73 6d6f 6f74 6869 6e67   label_smoothing
+000034c0: 2028 666c 6f61 742c 206f 7074 696f 6e61   (float, optiona
+000034d0: 6c2c 202a 6f70 7469 6f6e 616c 2a2c 2064  l, *optional*, d
+000034e0: 6566 6175 6c74 7320 746f 2030 2e30 293a  efaults to 0.0):
+000034f0: 0a20 2020 2020 2020 2020 2020 2041 2066  .            A f
+00003500: 6c6f 6174 2069 6e20 5b30 2e30 2c20 312e  loat in [0.0, 1.
+00003510: 305d 2e20 5370 6563 6966 6965 7320 7468  0]. Specifies th
+00003520: 6520 616d 6f75 6e74 206f 6620 736d 6f6f  e amount of smoo
+00003530: 7468 696e 6720 7768 656e 2063 6f6d 7075  thing when compu
+00003540: 7469 6e67 2074 6865 206c 6f73 732c 2077  ting the loss, w
+00003550: 6865 7265 2030 2e30 206d 6561 6e73 206e  here 0.0 means n
+00003560: 6f20 736d 6f6f 7468 696e 672e 2054 6865  o smoothing. The
+00003570: 2074 6172 6765 7473 0a20 2020 2020 2020   targets.       
+00003580: 2020 2020 2062 6563 6f6d 6520 6120 6d69       become a mi
+00003590: 7874 7572 6520 6f66 2074 6865 206f 7269  xture of the ori
+000035a0: 6769 6e61 6c20 6772 6f75 6e64 2074 7275  ginal ground tru
+000035b0: 7468 2061 6e64 2061 2075 6e69 666f 726d  th and a uniform
+000035c0: 2064 6973 7472 6962 7574 696f 6e20 6173   distribution as
+000035d0: 2064 6573 6372 6962 6564 2069 6e0a 2020   described in.  
+000035e0: 2020 2020 2020 2020 2020 6052 6574 6869            `Rethi
+000035f0: 6e6b 696e 6720 7468 6520 496e 6365 7074  nking the Incept
+00003600: 696f 6e20 4172 6368 6974 6563 7475 7265  ion Architecture
+00003610: 2066 6f72 2043 6f6d 7075 7465 7220 5669   for Computer Vi
+00003620: 7369 6f6e 203c 6874 7470 733a 2f2f 6172  sion <https://ar
+00003630: 7869 762e 6f72 672f 6162 732f 3135 3132  xiv.org/abs/1512
+00003640: 2e30 3035 3637 3e60 5f5f 2e20 4465 6661  .00567>`__. Defa
+00003650: 756c 743a 203a 6d61 7468 3a60 302e 3060  ult: :math:`0.0`
+00003660: 2e0a 2020 2020 2020 2020 6b77 6172 6773  ..        kwargs
+00003670: 2028 2a6f 7074 696f 6e61 6c2a 293a 0a20   (*optional*):. 
+00003680: 2020 2020 2020 2020 2020 2044 6963 7469             Dicti
+00003690: 6f6e 6172 7920 6f66 206b 6579 776f 7264  onary of keyword
+000036a0: 2061 7267 756d 656e 7473 2e0a 0a20 2020   arguments...   
+000036b0: 2045 7861 6d70 6c65 3a0a 0a20 2020 2060   Example:..    `
+000036c0: 6060 7079 7468 6f6e 0a20 2020 203e 3e3e  ``python.    >>>
+000036d0: 2066 726f 6d20 7472 616e 7366 6f72 6d65   from transforme
+000036e0: 7273 2069 6d70 6f72 7420 426c 6970 436f  rs import BlipCo
+000036f0: 6e66 6967 2c20 426c 6970 4d6f 6465 6c0a  nfig, BlipModel.
+00003700: 0a20 2020 203e 3e3e 2023 2049 6e69 7469  .    >>> # Initi
+00003710: 616c 697a 696e 6720 6120 426c 6970 436f  alizing a BlipCo
+00003720: 6e66 6967 2077 6974 6820 5361 6c65 7366  nfig with Salesf
+00003730: 6f72 6365 2f62 6c69 702d 7671 612d 6261  orce/blip-vqa-ba
+00003740: 7365 2073 7479 6c65 2063 6f6e 6669 6775  se style configu
+00003750: 7261 7469 6f6e 0a20 2020 203e 3e3e 2063  ration.    >>> c
+00003760: 6f6e 6669 6775 7261 7469 6f6e 203d 2042  onfiguration = B
+00003770: 6c69 7043 6f6e 6669 6728 290a 0a20 2020  lipConfig()..   
+00003780: 203e 3e3e 2023 2049 6e69 7469 616c 697a   >>> # Initializ
+00003790: 696e 6720 6120 426c 6970 504d 6f64 656c  ing a BlipPModel
+000037a0: 2028 7769 7468 2072 616e 646f 6d20 7765   (with random we
+000037b0: 6967 6874 7329 2066 726f 6d20 7468 6520  ights) from the 
+000037c0: 5361 6c65 7366 6f72 6365 2f62 6c69 702d  Salesforce/blip-
+000037d0: 7671 612d 6261 7365 2073 7479 6c65 2063  vqa-base style c
+000037e0: 6f6e 6669 6775 7261 7469 6f6e 0a20 2020  onfiguration.   
+000037f0: 203e 3e3e 206d 6f64 656c 203d 2042 6c69   >>> model = Bli
+00003800: 704d 6f64 656c 2863 6f6e 6669 6775 7261  pModel(configura
+00003810: 7469 6f6e 290a 0a20 2020 203e 3e3e 2023  tion)..    >>> #
+00003820: 2041 6363 6573 7369 6e67 2074 6865 206d   Accessing the m
+00003830: 6f64 656c 2063 6f6e 6669 6775 7261 7469  odel configurati
+00003840: 6f6e 0a20 2020 203e 3e3e 2063 6f6e 6669  on.    >>> confi
+00003850: 6775 7261 7469 6f6e 203d 206d 6f64 656c  guration = model
+00003860: 2e63 6f6e 6669 670a 0a20 2020 203e 3e3e  .config..    >>>
+00003870: 2023 2057 6520 6361 6e20 616c 736f 2069   # We can also i
+00003880: 6e69 7469 616c 697a 6520 6120 426c 6970  nitialize a Blip
+00003890: 436f 6e66 6967 2066 726f 6d20 6120 426c  Config from a Bl
+000038a0: 6970 5465 7874 436f 6e66 6967 2061 6e64  ipTextConfig and
+000038b0: 2061 2042 6c69 7056 6973 696f 6e43 6f6e   a BlipVisionCon
+000038c0: 6669 670a 0a20 2020 203e 3e3e 2023 2049  fig..    >>> # I
+000038d0: 6e69 7469 616c 697a 696e 6720 6120 424c  nitializing a BL
+000038e0: 4950 5465 7874 2061 6e64 2042 4c49 5056  IPText and BLIPV
+000038f0: 6973 696f 6e20 636f 6e66 6967 7572 6174  ision configurat
+00003900: 696f 6e0a 2020 2020 3e3e 3e20 636f 6e66  ion.    >>> conf
+00003910: 6967 5f74 6578 7420 3d20 426c 6970 5465  ig_text = BlipTe
+00003920: 7874 436f 6e66 6967 2829 0a20 2020 203e  xtConfig().    >
+00003930: 3e3e 2063 6f6e 6669 675f 7669 7369 6f6e  >> config_vision
+00003940: 203d 2042 6c69 7056 6973 696f 6e43 6f6e   = BlipVisionCon
+00003950: 6669 6728 290a 0a20 2020 203e 3e3e 2063  fig()..    >>> c
+00003960: 6f6e 6669 6720 3d20 426c 6970 436f 6e66  onfig = BlipConf
+00003970: 6967 2e66 726f 6d5f 7465 7874 5f76 6973  ig.from_text_vis
+00003980: 696f 6e5f 636f 6e66 6967 7328 636f 6e66  ion_configs(conf
+00003990: 6967 5f74 6578 742c 2063 6f6e 6669 675f  ig_text, config_
+000039a0: 7669 7369 6f6e 290a 2020 2020 6060 6022  vision).    ```"
+000039b0: 2222 0a0a 2020 2020 6d6f 6465 6c5f 7479  ""..    model_ty
+000039c0: 7065 203d 2022 626c 6970 220a 0a20 2020  pe = "blip"..   
+000039d0: 2064 6566 205f 5f69 6e69 745f 5f28 0a20   def __init__(. 
+000039e0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+000039f0: 2020 2020 2074 6578 745f 636f 6e66 6967       text_config
+00003a00: 3d4e 6f6e 652c 0a20 2020 2020 2020 2076  =None,.        v
+00003a10: 6973 696f 6e5f 636f 6e66 6967 3d4e 6f6e  ision_config=Non
+00003a20: 652c 0a20 2020 2020 2020 2070 726f 6a65  e,.        proje
+00003a30: 6374 696f 6e5f 6469 6d3d 3531 322c 0a20  ction_dim=512,. 
+00003a40: 2020 2020 2020 206c 6f67 6974 5f73 6361         logit_sca
+00003a50: 6c65 5f69 6e69 745f 7661 6c75 653d 322e  le_init_value=2.
+00003a60: 3635 3932 2c0a 2020 2020 2020 2020 696d  6592,.        im
+00003a70: 6167 655f 7465 7874 5f68 6964 6465 6e5f  age_text_hidden_
+00003a80: 7369 7a65 3d32 3536 2c0a 2020 2020 2020  size=256,.      
+00003a90: 2020 6c61 6265 6c5f 736d 6f6f 7468 696e    label_smoothin
+00003aa0: 673d 302e 302c 0a20 2020 2020 2020 202a  g=0.0,.        *
+00003ab0: 2a6b 7761 7267 732c 0a20 2020 2029 3a0a  *kwargs,.    ):.
+00003ac0: 2020 2020 2020 2020 7375 7065 7228 292e          super().
+00003ad0: 5f5f 696e 6974 5f5f 282a 2a6b 7761 7267  __init__(**kwarg
+00003ae0: 7329 0a0a 2020 2020 2020 2020 6966 2074  s)..        if t
+00003af0: 6578 745f 636f 6e66 6967 2069 7320 4e6f  ext_config is No
+00003b00: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00003b10: 7465 7874 5f63 6f6e 6669 6720 3d20 7b7d  text_config = {}
+00003b20: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+00003b30: 6765 722e 696e 666f 2822 6074 6578 745f  ger.info("`text_
+00003b40: 636f 6e66 6967 6020 6973 2060 4e6f 6e65  config` is `None
+00003b50: 602e 2049 6e69 7469 616c 697a 696e 6720  `. Initializing 
+00003b60: 7468 6520 6042 6c69 7054 6578 7443 6f6e  the `BlipTextCon
+00003b70: 6669 6760 2077 6974 6820 6465 6661 756c  fig` with defaul
+00003b80: 7420 7661 6c75 6573 2e22 290a 0a20 2020  t values.")..   
+00003b90: 2020 2020 2069 6620 7669 7369 6f6e 5f63       if vision_c
+00003ba0: 6f6e 6669 6720 6973 204e 6f6e 653a 0a20  onfig is None:. 
+00003bb0: 2020 2020 2020 2020 2020 2076 6973 696f             visio
+00003bc0: 6e5f 636f 6e66 6967 203d 207b 7d0a 2020  n_config = {}.  
+00003bd0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+00003be0: 2e69 6e66 6f28 2260 7669 7369 6f6e 5f63  .info("`vision_c
+00003bf0: 6f6e 6669 6760 2069 7320 604e 6f6e 6560  onfig` is `None`
+00003c00: 2e20 496e 6974 6961 6c69 7a69 6e67 2074  . Initializing t
+00003c10: 6865 2060 426c 6970 5669 7369 6f6e 436f  he `BlipVisionCo
+00003c20: 6e66 6967 6020 7769 7468 2064 6566 6175  nfig` with defau
+00003c30: 6c74 2076 616c 7565 732e 2229 0a0a 2020  lt values.")..  
+00003c40: 2020 2020 2020 7365 6c66 2e74 6578 745f        self.text_
+00003c50: 636f 6e66 6967 203d 2042 6c69 7054 6578  config = BlipTex
+00003c60: 7443 6f6e 6669 6728 2a2a 7465 7874 5f63  tConfig(**text_c
+00003c70: 6f6e 6669 6729 0a20 2020 2020 2020 2073  onfig).        s
+00003c80: 656c 662e 7669 7369 6f6e 5f63 6f6e 6669  elf.vision_confi
+00003c90: 6720 3d20 426c 6970 5669 7369 6f6e 436f  g = BlipVisionCo
+00003ca0: 6e66 6967 282a 2a76 6973 696f 6e5f 636f  nfig(**vision_co
+00003cb0: 6e66 6967 290a 0a20 2020 2020 2020 2073  nfig)..        s
+00003cc0: 656c 662e 7465 7874 5f63 6f6e 6669 672e  elf.text_config.
+00003cd0: 656e 636f 6465 725f 6869 6464 656e 5f73  encoder_hidden_s
+00003ce0: 697a 6520 3d20 7365 6c66 2e76 6973 696f  ize = self.visio
+00003cf0: 6e5f 636f 6e66 6967 2e68 6964 6465 6e5f  n_config.hidden_
+00003d00: 7369 7a65 0a0a 2020 2020 2020 2020 7365  size..        se
+00003d10: 6c66 2e70 726f 6a65 6374 696f 6e5f 6469  lf.projection_di
+00003d20: 6d20 3d20 7072 6f6a 6563 7469 6f6e 5f64  m = projection_d
+00003d30: 696d 0a20 2020 2020 2020 2073 656c 662e  im.        self.
+00003d40: 6c6f 6769 745f 7363 616c 655f 696e 6974  logit_scale_init
+00003d50: 5f76 616c 7565 203d 206c 6f67 6974 5f73  _value = logit_s
+00003d60: 6361 6c65 5f69 6e69 745f 7661 6c75 650a  cale_init_value.
+00003d70: 2020 2020 2020 2020 7365 6c66 2e69 6e69          self.ini
+00003d80: 7469 616c 697a 6572 5f66 6163 746f 7220  tializer_factor 
+00003d90: 3d20 312e 300a 2020 2020 2020 2020 7365  = 1.0.        se
+00003da0: 6c66 2e69 6e69 7469 616c 697a 6572 5f72  lf.initializer_r
+00003db0: 616e 6765 203d 2030 2e30 320a 2020 2020  ange = 0.02.    
+00003dc0: 2020 2020 7365 6c66 2e69 6d61 6765 5f74      self.image_t
+00003dd0: 6578 745f 6869 6464 656e 5f73 697a 6520  ext_hidden_size 
+00003de0: 3d20 696d 6167 655f 7465 7874 5f68 6964  = image_text_hid
+00003df0: 6465 6e5f 7369 7a65 0a20 2020 2020 2020  den_size.       
+00003e00: 2073 656c 662e 6c61 6265 6c5f 736d 6f6f   self.label_smoo
+00003e10: 7468 696e 6720 3d20 6c61 6265 6c5f 736d  thing = label_sm
+00003e20: 6f6f 7468 696e 670a 0a20 2020 2040 636c  oothing..    @cl
+00003e30: 6173 736d 6574 686f 640a 2020 2020 6465  assmethod.    de
+00003e40: 6620 6672 6f6d 5f74 6578 745f 7669 7369  f from_text_visi
+00003e50: 6f6e 5f63 6f6e 6669 6773 2863 6c73 2c20  on_configs(cls, 
+00003e60: 7465 7874 5f63 6f6e 6669 673a 2042 6c69  text_config: Bli
+00003e70: 7054 6578 7443 6f6e 6669 672c 2076 6973  pTextConfig, vis
+00003e80: 696f 6e5f 636f 6e66 6967 3a20 426c 6970  ion_config: Blip
+00003e90: 5669 7369 6f6e 436f 6e66 6967 2c20 2a2a  VisionConfig, **
+00003ea0: 6b77 6172 6773 293a 0a20 2020 2020 2020  kwargs):.       
+00003eb0: 2072 2222 220a 2020 2020 2020 2020 496e   r""".        In
+00003ec0: 7374 616e 7469 6174 6520 6120 5b60 426c  stantiate a [`Bl
+00003ed0: 6970 436f 6e66 6967 605d 2028 6f72 2061  ipConfig`] (or a
+00003ee0: 2064 6572 6976 6564 2063 6c61 7373 2920   derived class) 
+00003ef0: 6672 6f6d 2062 6c69 7020 7465 7874 206d  from blip text m
+00003f00: 6f64 656c 2063 6f6e 6669 6775 7261 7469  odel configurati
+00003f10: 6f6e 2061 6e64 2062 6c69 7020 7669 7369  on and blip visi
+00003f20: 6f6e 206d 6f64 656c 0a20 2020 2020 2020  on model.       
+00003f30: 2063 6f6e 6669 6775 7261 7469 6f6e 2e0a   configuration..
+00003f40: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
+00003f50: 3a0a 2020 2020 2020 2020 2020 2020 5b60  :.            [`
+00003f60: 426c 6970 436f 6e66 6967 605d 3a20 416e  BlipConfig`]: An
+00003f70: 2069 6e73 7461 6e63 6520 6f66 2061 2063   instance of a c
+00003f80: 6f6e 6669 6775 7261 7469 6f6e 206f 626a  onfiguration obj
+00003f90: 6563 740a 2020 2020 2020 2020 2222 220a  ect.        """.
+00003fa0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00003fb0: 636c 7328 7465 7874 5f63 6f6e 6669 673d  cls(text_config=
+00003fc0: 7465 7874 5f63 6f6e 6669 672e 746f 5f64  text_config.to_d
+00003fd0: 6963 7428 292c 2076 6973 696f 6e5f 636f  ict(), vision_co
+00003fe0: 6e66 6967 3d76 6973 696f 6e5f 636f 6e66  nfig=vision_conf
+00003ff0: 6967 2e74 6f5f 6469 6374 2829 2c20 2a2a  ig.to_dict(), **
+00004000: 6b77 6172 6773 290a 0a5f 5f61 6c6c 5f5f  kwargs)..__all__
+00004010: 203d 205b 2742 6c69 7043 6f6e 6669 6727   = ['BlipConfig'
+00004020: 2c20 2742 6c69 7056 6973 696f 6e43 6f6e  , 'BlipVisionCon
+00004030: 6669 6727 2c20 2742 6c69 7054 6578 7443  fig', 'BlipTextC
+00004040: 6f6e 6669 6727 5d0a                      onfig'].
```

## mindnlp/transformers/models/blip/image_processing_blip.py

```diff
@@ -0,0 +1,984 @@
+00000000: 2320 636f 6469 6e67 3d75 7466 2d38 0a23  # coding=utf-8.#
+00000010: 2043 6f70 7972 6967 6874 2032 3032 3220   Copyright 2022 
+00000020: 5468 6520 4875 6767 696e 6746 6163 6520  The HuggingFace 
+00000030: 496e 632e 2074 6561 6d2e 2041 6c6c 2072  Inc. team. All r
+00000040: 6967 6874 7320 7265 7365 7276 6564 2e0a  ights reserved..
+00000050: 230a 2320 4c69 6365 6e73 6564 2075 6e64  #.# Licensed und
+00000060: 6572 2074 6865 2041 7061 6368 6520 4c69  er the Apache Li
+00000070: 6365 6e73 652c 2056 6572 7369 6f6e 2032  cense, Version 2
+00000080: 2e30 2028 7468 6520 224c 6963 656e 7365  .0 (the "License
+00000090: 2229 3b0a 2320 796f 7520 6d61 7920 6e6f  ");.# you may no
+000000a0: 7420 7573 6520 7468 6973 2066 696c 6520  t use this file 
+000000b0: 6578 6365 7074 2069 6e20 636f 6d70 6c69  except in compli
+000000c0: 616e 6365 2077 6974 6820 7468 6520 4c69  ance with the Li
+000000d0: 6365 6e73 652e 0a23 2059 6f75 206d 6179  cense..# You may
+000000e0: 206f 6274 6169 6e20 6120 636f 7079 206f   obtain a copy o
+000000f0: 6620 7468 6520 4c69 6365 6e73 6520 6174  f the License at
+00000100: 0a23 0a23 2020 2020 2068 7474 703a 2f2f  .#.#     http://
+00000110: 7777 772e 6170 6163 6865 2e6f 7267 2f6c  www.apache.org/l
+00000120: 6963 656e 7365 732f 4c49 4345 4e53 452d  icenses/LICENSE-
+00000130: 322e 300a 230a 2320 556e 6c65 7373 2072  2.0.#.# Unless r
+00000140: 6571 7569 7265 6420 6279 2061 7070 6c69  equired by appli
+00000150: 6361 626c 6520 6c61 7720 6f72 2061 6772  cable law or agr
+00000160: 6565 6420 746f 2069 6e20 7772 6974 696e  eed to in writin
+00000170: 672c 2073 6f66 7477 6172 650a 2320 6469  g, software.# di
+00000180: 7374 7269 6275 7465 6420 756e 6465 7220  stributed under 
+00000190: 7468 6520 4c69 6365 6e73 6520 6973 2064  the License is d
+000001a0: 6973 7472 6962 7574 6564 206f 6e20 616e  istributed on an
+000001b0: 2022 4153 2049 5322 2042 4153 4953 2c0a   "AS IS" BASIS,.
+000001c0: 2320 5749 5448 4f55 5420 5741 5252 414e  # WITHOUT WARRAN
+000001d0: 5449 4553 204f 5220 434f 4e44 4954 494f  TIES OR CONDITIO
+000001e0: 4e53 204f 4620 414e 5920 4b49 4e44 2c20  NS OF ANY KIND, 
+000001f0: 6569 7468 6572 2065 7870 7265 7373 206f  either express o
+00000200: 7220 696d 706c 6965 642e 0a23 2053 6565  r implied..# See
+00000210: 2074 6865 204c 6963 656e 7365 2066 6f72   the License for
+00000220: 2074 6865 2073 7065 6369 6669 6320 6c61   the specific la
+00000230: 6e67 7561 6765 2067 6f76 6572 6e69 6e67  nguage governing
+00000240: 2070 6572 6d69 7373 696f 6e73 2061 6e64   permissions and
+00000250: 0a23 206c 696d 6974 6174 696f 6e73 2075  .# limitations u
+00000260: 6e64 6572 2074 6865 204c 6963 656e 7365  nder the License
+00000270: 2e0a 2222 2249 6d61 6765 2070 726f 6365  .."""Image proce
+00000280: 7373 6f72 2063 6c61 7373 2066 6f72 2042  ssor class for B
+00000290: 4c49 502e 2222 220a 0a66 726f 6d20 7479  LIP."""..from ty
+000002a0: 7069 6e67 2069 6d70 6f72 7420 4469 6374  ping import Dict
+000002b0: 2c20 4c69 7374 2c20 4f70 7469 6f6e 616c  , List, Optional
+000002c0: 2c20 556e 696f 6e0a 0a69 6d70 6f72 7420  , Union..import 
+000002d0: 6e75 6d70 7920 6173 206e 700a 0a66 726f  numpy as np..fro
+000002e0: 6d20 2e2e 2e2e 636f 6e66 6967 7320 696d  m ....configs im
+000002f0: 706f 7274 204f 5045 4e41 495f 434c 4950  port OPENAI_CLIP
+00000300: 5f4d 4541 4e2c 204f 5045 4e41 495f 434c  _MEAN, OPENAI_CL
+00000310: 4950 5f53 5444 0a66 726f 6d20 2e2e 2e69  IP_STD.from ...i
+00000320: 6d61 6765 5f70 726f 6365 7373 696e 675f  mage_processing_
+00000330: 7574 696c 7320 696d 706f 7274 2042 6173  utils import Bas
+00000340: 6549 6d61 6765 5072 6f63 6573 736f 722c  eImageProcessor,
+00000350: 2042 6174 6368 4665 6174 7572 652c 2067   BatchFeature, g
+00000360: 6574 5f73 697a 655f 6469 6374 0a66 726f  et_size_dict.fro
+00000370: 6d20 2e2e 2e69 6d61 6765 5f74 7261 6e73  m ...image_trans
+00000380: 666f 726d 7320 696d 706f 7274 2063 6f6e  forms import con
+00000390: 7665 7274 5f74 6f5f 7267 622c 2072 6573  vert_to_rgb, res
+000003a0: 697a 652c 2074 6f5f 6368 616e 6e65 6c5f  ize, to_channel_
+000003b0: 6469 6d65 6e73 696f 6e5f 666f 726d 6174  dimension_format
+000003c0: 0a66 726f 6d20 2e2e 2e69 6d61 6765 5f75  .from ...image_u
+000003d0: 7469 6c73 2069 6d70 6f72 7420 280a 2020  tils import (.  
+000003e0: 2020 4368 616e 6e65 6c44 696d 656e 7369    ChannelDimensi
+000003f0: 6f6e 2c0a 2020 2020 496d 6167 6549 6e70  on,.    ImageInp
+00000400: 7574 2c0a 2020 2020 5049 4c49 6d61 6765  ut,.    PILImage
+00000410: 5265 7361 6d70 6c69 6e67 2c0a 2020 2020  Resampling,.    
+00000420: 696e 6665 725f 6368 616e 6e65 6c5f 6469  infer_channel_di
+00000430: 6d65 6e73 696f 6e5f 666f 726d 6174 2c0a  mension_format,.
+00000440: 2020 2020 6973 5f73 6361 6c65 645f 696d      is_scaled_im
+00000450: 6167 652c 0a20 2020 206d 616b 655f 6c69  age,.    make_li
+00000460: 7374 5f6f 665f 696d 6167 6573 2c0a 2020  st_of_images,.  
+00000470: 2020 746f 5f6e 756d 7079 5f61 7272 6179    to_numpy_array
+00000480: 2c0a 2020 2020 7661 6c69 645f 696d 6167  ,.    valid_imag
+00000490: 6573 2c0a 2020 2020 7661 6c69 6461 7465  es,.    validate
+000004a0: 5f6b 7761 7267 732c 0a20 2020 2076 616c  _kwargs,.    val
+000004b0: 6964 6174 655f 7072 6570 726f 6365 7373  idate_preprocess
+000004c0: 5f61 7267 756d 656e 7473 2c0a 290a 6672  _arguments,.).fr
+000004d0: 6f6d 202e 2e2e 2e75 7469 6c73 2069 6d70  om ....utils imp
+000004e0: 6f72 7420 5465 6e73 6f72 5479 7065 2c20  ort TensorType, 
+000004f0: 6973 5f76 6973 696f 6e5f 6176 6169 6c61  is_vision_availa
+00000500: 626c 652c 206c 6f67 6769 6e67 0a0a 0a69  ble, logging...i
+00000510: 6620 6973 5f76 6973 696f 6e5f 6176 6169  f is_vision_avai
+00000520: 6c61 626c 6528 293a 0a20 2020 2069 6d70  lable():.    imp
+00000530: 6f72 7420 5049 4c0a 0a0a 6c6f 6767 6572  ort PIL...logger
+00000540: 203d 206c 6f67 6769 6e67 2e67 6574 5f6c   = logging.get_l
+00000550: 6f67 6765 7228 5f5f 6e61 6d65 5f5f 290a  ogger(__name__).
+00000560: 0a0a 636c 6173 7320 426c 6970 496d 6167  ..class BlipImag
+00000570: 6550 726f 6365 7373 6f72 2842 6173 6549  eProcessor(BaseI
+00000580: 6d61 6765 5072 6f63 6573 736f 7229 3a0a  mageProcessor):.
+00000590: 2020 2020 7222 2222 0a20 2020 2043 6f6e      r""".    Con
+000005a0: 7374 7275 6374 7320 6120 424c 4950 2069  structs a BLIP i
+000005b0: 6d61 6765 2070 726f 6365 7373 6f72 2e0a  mage processor..
+000005c0: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
+000005d0: 2020 2064 6f5f 7265 7369 7a65 2028 6062     do_resize (`b
+000005e0: 6f6f 6c60 2c20 2a6f 7074 696f 6e61 6c2a  ool`, *optional*
+000005f0: 2c20 6465 6661 756c 7473 2074 6f20 6054  , defaults to `T
+00000600: 7275 6560 293a 0a20 2020 2020 2020 2020  rue`):.         
+00000610: 2020 2057 6865 7468 6572 2074 6f20 7265     Whether to re
+00000620: 7369 7a65 2074 6865 2069 6d61 6765 2773  size the image's
+00000630: 2028 6865 6967 6874 2c20 7769 6474 6829   (height, width)
+00000640: 2064 696d 656e 7369 6f6e 7320 746f 2074   dimensions to t
+00000650: 6865 2073 7065 6369 6669 6564 2060 7369  he specified `si
+00000660: 7a65 602e 2043 616e 2062 6520 6f76 6572  ze`. Can be over
+00000670: 7269 6464 656e 2062 7920 7468 650a 2020  ridden by the.  
+00000680: 2020 2020 2020 2020 2020 6064 6f5f 7265            `do_re
+00000690: 7369 7a65 6020 7061 7261 6d65 7465 7220  size` parameter 
+000006a0: 696e 2074 6865 2060 7072 6570 726f 6365  in the `preproce
+000006b0: 7373 6020 6d65 7468 6f64 2e0a 2020 2020  ss` method..    
+000006c0: 2020 2020 7369 7a65 2028 6064 6963 7460      size (`dict`
+000006d0: 2c20 2a6f 7074 696f 6e61 6c2a 2c20 6465  , *optional*, de
+000006e0: 6661 756c 7473 2074 6f20 607b 2268 6569  faults to `{"hei
+000006f0: 6768 7422 3a20 3338 342c 2022 7769 6474  ght": 384, "widt
+00000700: 6822 3a20 3338 347d 6029 3a0a 2020 2020  h": 384}`):.    
+00000710: 2020 2020 2020 2020 5369 7a65 206f 6620          Size of 
+00000720: 7468 6520 6f75 7470 7574 2069 6d61 6765  the output image
+00000730: 2061 6674 6572 2072 6573 697a 696e 672e   after resizing.
+00000740: 2043 616e 2062 6520 6f76 6572 7269 6464   Can be overridd
+00000750: 656e 2062 7920 7468 6520 6073 697a 6560  en by the `size`
+00000760: 2070 6172 616d 6574 6572 2069 6e20 7468   parameter in th
+00000770: 6520 6070 7265 7072 6f63 6573 7360 0a20  e `preprocess`. 
+00000780: 2020 2020 2020 2020 2020 206d 6574 686f             metho
+00000790: 642e 0a20 2020 2020 2020 2072 6573 616d  d..        resam
+000007a0: 706c 6520 2860 5049 4c49 6d61 6765 5265  ple (`PILImageRe
+000007b0: 7361 6d70 6c69 6e67 602c 202a 6f70 7469  sampling`, *opti
+000007c0: 6f6e 616c 2a2c 2064 6566 6175 6c74 7320  onal*, defaults 
+000007d0: 746f 2060 5265 7361 6d70 6c69 6e67 2e42  to `Resampling.B
+000007e0: 4943 5542 4943 6029 3a0a 2020 2020 2020  ICUBIC`):.      
+000007f0: 2020 2020 2020 5265 7361 6d70 6c69 6e67        Resampling
+00000800: 2066 696c 7465 7220 746f 2075 7365 2069   filter to use i
+00000810: 6620 7265 7369 7a69 6e67 2074 6865 2069  f resizing the i
+00000820: 6d61 6765 2e20 4f6e 6c79 2068 6173 2061  mage. Only has a
+00000830: 6e20 6566 6665 6374 2069 6620 6064 6f5f  n effect if `do_
+00000840: 7265 7369 7a65 6020 6973 2073 6574 2074  resize` is set t
+00000850: 6f20 6054 7275 6560 2e20 4361 6e20 6265  o `True`. Can be
+00000860: 0a20 2020 2020 2020 2020 2020 206f 7665  .            ove
+00000870: 7272 6964 6465 6e20 6279 2074 6865 2060  rridden by the `
+00000880: 7265 7361 6d70 6c65 6020 7061 7261 6d65  resample` parame
+00000890: 7465 7220 696e 2074 6865 2060 7072 6570  ter in the `prep
+000008a0: 726f 6365 7373 6020 6d65 7468 6f64 2e0a  rocess` method..
+000008b0: 2020 2020 2020 2020 646f 5f72 6573 6361          do_resca
+000008c0: 6c65 2028 6062 6f6f 6c60 2c20 2a6f 7074  le (`bool`, *opt
+000008d0: 696f 6e61 6c2a 2c20 6465 6661 756c 7473  ional*, defaults
+000008e0: 2074 6f20 6054 7275 6560 293a 0a20 2020   to `True`):.   
+000008f0: 2020 2020 2020 2020 2057 6865 7468 6572           Whether
+00000900: 2074 6f20 7265 7363 616c 6520 7468 6520   to rescale the 
+00000910: 696d 6167 6520 6279 2074 6865 2073 7065  image by the spe
+00000920: 6369 6669 6564 2073 6361 6c65 2060 7265  cified scale `re
+00000930: 7363 616c 655f 6661 6374 6f72 602e 2043  scale_factor`. C
+00000940: 616e 2062 6520 6f76 6572 7269 6464 656e  an be overridden
+00000950: 2062 7920 7468 650a 2020 2020 2020 2020   by the.        
+00000960: 2020 2020 6064 6f5f 7265 7363 616c 6560      `do_rescale`
+00000970: 2070 6172 616d 6574 6572 2069 6e20 7468   parameter in th
+00000980: 6520 6070 7265 7072 6f63 6573 7360 206d  e `preprocess` m
+00000990: 6574 686f 642e 0a20 2020 2020 2020 2072  ethod..        r
+000009a0: 6573 6361 6c65 5f66 6163 746f 7220 2860  escale_factor (`
+000009b0: 696e 7460 206f 7220 6066 6c6f 6174 602c  int` or `float`,
+000009c0: 202a 6f70 7469 6f6e 616c 2a2c 2064 6566   *optional*, def
+000009d0: 6175 6c74 7320 746f 2060 312f 3235 3560  aults to `1/255`
+000009e0: 293a 0a20 2020 2020 2020 2020 2020 2053  ):.            S
+000009f0: 6361 6c65 2066 6163 746f 7220 746f 2075  cale factor to u
+00000a00: 7365 2069 6620 7265 7363 616c 696e 6720  se if rescaling 
+00000a10: 7468 6520 696d 6167 652e 204f 6e6c 7920  the image. Only 
+00000a20: 6861 7320 616e 2065 6666 6563 7420 6966  has an effect if
+00000a30: 2060 646f 5f72 6573 6361 6c65 6020 6973   `do_rescale` is
+00000a40: 2073 6574 2074 6f20 6054 7275 6560 2e20   set to `True`. 
+00000a50: 4361 6e20 6265 0a20 2020 2020 2020 2020  Can be.         
+00000a60: 2020 206f 7665 7272 6964 6465 6e20 6279     overridden by
+00000a70: 2074 6865 2060 7265 7363 616c 655f 6661   the `rescale_fa
+00000a80: 6374 6f72 6020 7061 7261 6d65 7465 7220  ctor` parameter 
+00000a90: 696e 2074 6865 2060 7072 6570 726f 6365  in the `preproce
+00000aa0: 7373 6020 6d65 7468 6f64 2e0a 2020 2020  ss` method..    
+00000ab0: 2020 2020 646f 5f6e 6f72 6d61 6c69 7a65      do_normalize
+00000ac0: 2028 6062 6f6f 6c60 2c20 2a6f 7074 696f   (`bool`, *optio
+00000ad0: 6e61 6c2a 2c20 6465 6661 756c 7473 2074  nal*, defaults t
+00000ae0: 6f20 6054 7275 6560 293a 0a20 2020 2020  o `True`):.     
+00000af0: 2020 2020 2020 2057 6865 7468 6572 2074         Whether t
+00000b00: 6f20 6e6f 726d 616c 697a 6520 7468 6520  o normalize the 
+00000b10: 696d 6167 652e 2043 616e 2062 6520 6f76  image. Can be ov
+00000b20: 6572 7269 6464 656e 2062 7920 7468 6520  erridden by the 
+00000b30: 6064 6f5f 6e6f 726d 616c 697a 6560 2070  `do_normalize` p
+00000b40: 6172 616d 6574 6572 2069 6e20 7468 6520  arameter in the 
+00000b50: 6070 7265 7072 6f63 6573 7360 0a20 2020  `preprocess`.   
+00000b60: 2020 2020 2020 2020 206d 6574 686f 642e           method.
+00000b70: 2043 616e 2062 6520 6f76 6572 7269 6464   Can be overridd
+00000b80: 656e 2062 7920 7468 6520 6064 6f5f 6e6f  en by the `do_no
+00000b90: 726d 616c 697a 6560 2070 6172 616d 6574  rmalize` paramet
+00000ba0: 6572 2069 6e20 7468 6520 6070 7265 7072  er in the `prepr
+00000bb0: 6f63 6573 7360 206d 6574 686f 642e 0a20  ocess` method.. 
+00000bc0: 2020 2020 2020 2069 6d61 6765 5f6d 6561         image_mea
+00000bd0: 6e20 2860 666c 6f61 7460 206f 7220 604c  n (`float` or `L
+00000be0: 6973 745b 666c 6f61 745d 602c 202a 6f70  ist[float]`, *op
+00000bf0: 7469 6f6e 616c 2a2c 2064 6566 6175 6c74  tional*, default
+00000c00: 7320 746f 2060 494d 4147 454e 4554 5f53  s to `IMAGENET_S
+00000c10: 5441 4e44 4152 445f 4d45 414e 6029 3a0a  TANDARD_MEAN`):.
+00000c20: 2020 2020 2020 2020 2020 2020 4d65 616e              Mean
+00000c30: 2074 6f20 7573 6520 6966 206e 6f72 6d61   to use if norma
+00000c40: 6c69 7a69 6e67 2074 6865 2069 6d61 6765  lizing the image
+00000c50: 2e20 5468 6973 2069 7320 6120 666c 6f61  . This is a floa
+00000c60: 7420 6f72 206c 6973 7420 6f66 2066 6c6f  t or list of flo
+00000c70: 6174 7320 7468 6520 6c65 6e67 7468 206f  ats the length o
+00000c80: 6620 7468 6520 6e75 6d62 6572 206f 660a  f the number of.
+00000c90: 2020 2020 2020 2020 2020 2020 6368 616e              chan
+00000ca0: 6e65 6c73 2069 6e20 7468 6520 696d 6167  nels in the imag
+00000cb0: 652e 2043 616e 2062 6520 6f76 6572 7269  e. Can be overri
+00000cc0: 6464 656e 2062 7920 7468 6520 6069 6d61  dden by the `ima
+00000cd0: 6765 5f6d 6561 6e60 2070 6172 616d 6574  ge_mean` paramet
+00000ce0: 6572 2069 6e20 7468 6520 6070 7265 7072  er in the `prepr
+00000cf0: 6f63 6573 7360 206d 6574 686f 642e 2043  ocess` method. C
+00000d00: 616e 2062 650a 2020 2020 2020 2020 2020  an be.          
+00000d10: 2020 6f76 6572 7269 6464 656e 2062 7920    overridden by 
+00000d20: 7468 6520 6069 6d61 6765 5f6d 6561 6e60  the `image_mean`
+00000d30: 2070 6172 616d 6574 6572 2069 6e20 7468   parameter in th
+00000d40: 6520 6070 7265 7072 6f63 6573 7360 206d  e `preprocess` m
+00000d50: 6574 686f 642e 0a20 2020 2020 2020 2069  ethod..        i
+00000d60: 6d61 6765 5f73 7464 2028 6066 6c6f 6174  mage_std (`float
+00000d70: 6020 6f72 2060 4c69 7374 5b66 6c6f 6174  ` or `List[float
+00000d80: 5d60 2c20 2a6f 7074 696f 6e61 6c2a 2c20  ]`, *optional*, 
+00000d90: 6465 6661 756c 7473 2074 6f20 6049 4d41  defaults to `IMA
+00000da0: 4745 4e45 545f 5354 414e 4441 5244 5f53  GENET_STANDARD_S
+00000db0: 5444 6029 3a0a 2020 2020 2020 2020 2020  TD`):.          
+00000dc0: 2020 5374 616e 6461 7264 2064 6576 6961    Standard devia
+00000dd0: 7469 6f6e 2074 6f20 7573 6520 6966 206e  tion to use if n
+00000de0: 6f72 6d61 6c69 7a69 6e67 2074 6865 2069  ormalizing the i
+00000df0: 6d61 6765 2e20 5468 6973 2069 7320 6120  mage. This is a 
+00000e00: 666c 6f61 7420 6f72 206c 6973 7420 6f66  float or list of
+00000e10: 2066 6c6f 6174 7320 7468 6520 6c65 6e67   floats the leng
+00000e20: 7468 206f 6620 7468 650a 2020 2020 2020  th of the.      
+00000e30: 2020 2020 2020 6e75 6d62 6572 206f 6620        number of 
+00000e40: 6368 616e 6e65 6c73 2069 6e20 7468 6520  channels in the 
+00000e50: 696d 6167 652e 2043 616e 2062 6520 6f76  image. Can be ov
+00000e60: 6572 7269 6464 656e 2062 7920 7468 6520  erridden by the 
+00000e70: 6069 6d61 6765 5f73 7464 6020 7061 7261  `image_std` para
+00000e80: 6d65 7465 7220 696e 2074 6865 2060 7072  meter in the `pr
+00000e90: 6570 726f 6365 7373 6020 6d65 7468 6f64  eprocess` method
+00000ea0: 2e0a 2020 2020 2020 2020 2020 2020 4361  ..            Ca
+00000eb0: 6e20 6265 206f 7665 7272 6964 6465 6e20  n be overridden 
+00000ec0: 6279 2074 6865 2060 696d 6167 655f 7374  by the `image_st
+00000ed0: 6460 2070 6172 616d 6574 6572 2069 6e20  d` parameter in 
+00000ee0: 7468 6520 6070 7265 7072 6f63 6573 7360  the `preprocess`
+00000ef0: 206d 6574 686f 642e 0a20 2020 2020 2020   method..       
+00000f00: 2064 6f5f 636f 6e76 6572 745f 7267 6220   do_convert_rgb 
+00000f10: 2860 626f 6f6c 602c 202a 6f70 7469 6f6e  (`bool`, *option
+00000f20: 616c 2a2c 2064 6566 6175 6c74 7320 746f  al*, defaults to
+00000f30: 2060 5472 7565 6029 3a0a 2020 2020 2020   `True`):.      
+00000f40: 2020 2020 2020 5768 6574 6865 7220 746f        Whether to
+00000f50: 2063 6f6e 7665 7274 2074 6865 2069 6d61   convert the ima
+00000f60: 6765 2074 6f20 5247 422e 0a20 2020 2022  ge to RGB..    "
+00000f70: 2222 0a0a 2020 2020 6d6f 6465 6c5f 696e  ""..    model_in
+00000f80: 7075 745f 6e61 6d65 7320 3d20 5b22 7069  put_names = ["pi
+00000f90: 7865 6c5f 7661 6c75 6573 225d 0a0a 2020  xel_values"]..  
+00000fa0: 2020 6465 6620 5f5f 696e 6974 5f5f 280a    def __init__(.
+00000fb0: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+00000fc0: 2020 2020 2020 646f 5f72 6573 697a 653a        do_resize:
+00000fd0: 2062 6f6f 6c20 3d20 5472 7565 2c0a 2020   bool = True,.  
+00000fe0: 2020 2020 2020 7369 7a65 3a20 4469 6374        size: Dict
+00000ff0: 5b73 7472 2c20 696e 745d 203d 204e 6f6e  [str, int] = Non
+00001000: 652c 0a20 2020 2020 2020 2072 6573 616d  e,.        resam
+00001010: 706c 653a 2050 494c 496d 6167 6552 6573  ple: PILImageRes
+00001020: 616d 706c 696e 6720 3d20 5049 4c49 6d61  ampling = PILIma
+00001030: 6765 5265 7361 6d70 6c69 6e67 2e42 4943  geResampling.BIC
+00001040: 5542 4943 2c0a 2020 2020 2020 2020 646f  UBIC,.        do
+00001050: 5f72 6573 6361 6c65 3a20 626f 6f6c 203d  _rescale: bool =
+00001060: 2054 7275 652c 0a20 2020 2020 2020 2072   True,.        r
+00001070: 6573 6361 6c65 5f66 6163 746f 723a 2055  escale_factor: U
+00001080: 6e69 6f6e 5b69 6e74 2c20 666c 6f61 745d  nion[int, float]
+00001090: 203d 2031 202f 2032 3535 2c0a 2020 2020   = 1 / 255,.    
+000010a0: 2020 2020 646f 5f6e 6f72 6d61 6c69 7a65      do_normalize
+000010b0: 3a20 626f 6f6c 203d 2054 7275 652c 0a20  : bool = True,. 
+000010c0: 2020 2020 2020 2069 6d61 6765 5f6d 6561         image_mea
+000010d0: 6e3a 204f 7074 696f 6e61 6c5b 556e 696f  n: Optional[Unio
+000010e0: 6e5b 666c 6f61 742c 204c 6973 745b 666c  n[float, List[fl
+000010f0: 6f61 745d 5d5d 203d 204e 6f6e 652c 0a20  oat]]] = None,. 
+00001100: 2020 2020 2020 2069 6d61 6765 5f73 7464         image_std
+00001110: 3a20 4f70 7469 6f6e 616c 5b55 6e69 6f6e  : Optional[Union
+00001120: 5b66 6c6f 6174 2c20 4c69 7374 5b66 6c6f  [float, List[flo
+00001130: 6174 5d5d 5d20 3d20 4e6f 6e65 2c0a 2020  at]]] = None,.  
+00001140: 2020 2020 2020 646f 5f63 6f6e 7665 7274        do_convert
+00001150: 5f72 6762 3a20 626f 6f6c 203d 2054 7275  _rgb: bool = Tru
+00001160: 652c 0a20 2020 2020 2020 202a 2a6b 7761  e,.        **kwa
+00001170: 7267 732c 0a20 2020 2029 202d 3e20 4e6f  rgs,.    ) -> No
+00001180: 6e65 3a0a 2020 2020 2020 2020 7375 7065  ne:.        supe
+00001190: 7228 292e 5f5f 696e 6974 5f5f 282a 2a6b  r().__init__(**k
+000011a0: 7761 7267 7329 0a20 2020 2020 2020 2073  wargs).        s
+000011b0: 697a 6520 3d20 7369 7a65 2069 6620 7369  ize = size if si
+000011c0: 7a65 2069 7320 6e6f 7420 4e6f 6e65 2065  ze is not None e
+000011d0: 6c73 6520 7b22 6865 6967 6874 223a 2033  lse {"height": 3
+000011e0: 3834 2c20 2277 6964 7468 223a 2033 3834  84, "width": 384
+000011f0: 7d0a 2020 2020 2020 2020 7369 7a65 203d  }.        size =
+00001200: 2067 6574 5f73 697a 655f 6469 6374 2873   get_size_dict(s
+00001210: 697a 652c 2064 6566 6175 6c74 5f74 6f5f  ize, default_to_
+00001220: 7371 7561 7265 3d54 7275 6529 0a0a 2020  square=True)..  
+00001230: 2020 2020 2020 7365 6c66 2e64 6f5f 7265        self.do_re
+00001240: 7369 7a65 203d 2064 6f5f 7265 7369 7a65  size = do_resize
+00001250: 0a20 2020 2020 2020 2073 656c 662e 7369  .        self.si
+00001260: 7a65 203d 2073 697a 650a 2020 2020 2020  ze = size.      
+00001270: 2020 7365 6c66 2e72 6573 616d 706c 6520    self.resample 
+00001280: 3d20 7265 7361 6d70 6c65 0a20 2020 2020  = resample.     
+00001290: 2020 2073 656c 662e 646f 5f72 6573 6361     self.do_resca
+000012a0: 6c65 203d 2064 6f5f 7265 7363 616c 650a  le = do_rescale.
+000012b0: 2020 2020 2020 2020 7365 6c66 2e72 6573          self.res
+000012c0: 6361 6c65 5f66 6163 746f 7220 3d20 7265  cale_factor = re
+000012d0: 7363 616c 655f 6661 6374 6f72 0a20 2020  scale_factor.   
+000012e0: 2020 2020 2073 656c 662e 646f 5f6e 6f72       self.do_nor
+000012f0: 6d61 6c69 7a65 203d 2064 6f5f 6e6f 726d  malize = do_norm
+00001300: 616c 697a 650a 2020 2020 2020 2020 7365  alize.        se
+00001310: 6c66 2e69 6d61 6765 5f6d 6561 6e20 3d20  lf.image_mean = 
+00001320: 696d 6167 655f 6d65 616e 2069 6620 696d  image_mean if im
+00001330: 6167 655f 6d65 616e 2069 7320 6e6f 7420  age_mean is not 
+00001340: 4e6f 6e65 2065 6c73 6520 4f50 454e 4149  None else OPENAI
+00001350: 5f43 4c49 505f 4d45 414e 0a20 2020 2020  _CLIP_MEAN.     
+00001360: 2020 2073 656c 662e 696d 6167 655f 7374     self.image_st
+00001370: 6420 3d20 696d 6167 655f 7374 6420 6966  d = image_std if
+00001380: 2069 6d61 6765 5f73 7464 2069 7320 6e6f   image_std is no
+00001390: 7420 4e6f 6e65 2065 6c73 6520 4f50 454e  t None else OPEN
+000013a0: 4149 5f43 4c49 505f 5354 440a 2020 2020  AI_CLIP_STD.    
+000013b0: 2020 2020 7365 6c66 2e64 6f5f 636f 6e76      self.do_conv
+000013c0: 6572 745f 7267 6220 3d20 646f 5f63 6f6e  ert_rgb = do_con
+000013d0: 7665 7274 5f72 6762 0a20 2020 2020 2020  vert_rgb.       
+000013e0: 2073 656c 662e 5f76 616c 6964 5f70 726f   self._valid_pro
+000013f0: 6365 7373 6f72 5f6b 6579 7320 3d20 5b0a  cessor_keys = [.
+00001400: 2020 2020 2020 2020 2020 2020 2269 6d61              "ima
+00001410: 6765 7322 2c0a 2020 2020 2020 2020 2020  ges",.          
+00001420: 2020 2264 6f5f 7265 7369 7a65 222c 0a20    "do_resize",. 
+00001430: 2020 2020 2020 2020 2020 2022 7369 7a65             "size
+00001440: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
+00001450: 7265 7361 6d70 6c65 222c 0a20 2020 2020  resample",.     
+00001460: 2020 2020 2020 2022 646f 5f72 6573 6361         "do_resca
+00001470: 6c65 222c 0a20 2020 2020 2020 2020 2020  le",.           
+00001480: 2022 7265 7363 616c 655f 6661 6374 6f72   "rescale_factor
+00001490: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
+000014a0: 646f 5f6e 6f72 6d61 6c69 7a65 222c 0a20  do_normalize",. 
+000014b0: 2020 2020 2020 2020 2020 2022 696d 6167             "imag
+000014c0: 655f 6d65 616e 222c 0a20 2020 2020 2020  e_mean",.       
+000014d0: 2020 2020 2022 696d 6167 655f 7374 6422       "image_std"
+000014e0: 2c0a 2020 2020 2020 2020 2020 2020 2264  ,.            "d
+000014f0: 6f5f 636f 6e76 6572 745f 7267 6222 2c0a  o_convert_rgb",.
+00001500: 2020 2020 2020 2020 2020 2020 2272 6574              "ret
+00001510: 7572 6e5f 7465 6e73 6f72 7322 2c0a 2020  urn_tensors",.  
+00001520: 2020 2020 2020 2020 2020 2264 6174 615f            "data_
+00001530: 666f 726d 6174 222c 0a20 2020 2020 2020  format",.       
+00001540: 2020 2020 2022 696e 7075 745f 6461 7461       "input_data
+00001550: 5f66 6f72 6d61 7422 2c0a 2020 2020 2020  _format",.      
+00001560: 2020 5d0a 0a20 2020 2023 2043 6f70 6965    ]..    # Copie
+00001570: 6420 6672 6f6d 2074 7261 6e73 666f 726d  d from transform
+00001580: 6572 732e 6d6f 6465 6c73 2e76 6974 2e69  ers.models.vit.i
+00001590: 6d61 6765 5f70 726f 6365 7373 696e 675f  mage_processing_
+000015a0: 7669 742e 5669 5449 6d61 6765 5072 6f63  vit.ViTImageProc
+000015b0: 6573 736f 722e 7265 7369 7a65 2077 6974  essor.resize wit
+000015c0: 6820 5049 4c49 6d61 6765 5265 7361 6d70  h PILImageResamp
+000015d0: 6c69 6e67 2e42 494c 494e 4541 522d 3e50  ling.BILINEAR->P
+000015e0: 494c 496d 6167 6552 6573 616d 706c 696e  ILImageResamplin
+000015f0: 672e 4249 4355 4249 430a 2020 2020 6465  g.BICUBIC.    de
+00001600: 6620 7265 7369 7a65 280a 2020 2020 2020  f resize(.      
+00001610: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+00001620: 696d 6167 653a 206e 702e 6e64 6172 7261  image: np.ndarra
+00001630: 792c 0a20 2020 2020 2020 2073 697a 653a  y,.        size:
+00001640: 2044 6963 745b 7374 722c 2069 6e74 5d2c   Dict[str, int],
+00001650: 0a20 2020 2020 2020 2072 6573 616d 706c  .        resampl
+00001660: 653a 2050 494c 496d 6167 6552 6573 616d  e: PILImageResam
+00001670: 706c 696e 6720 3d20 5049 4c49 6d61 6765  pling = PILImage
+00001680: 5265 7361 6d70 6c69 6e67 2e42 4943 5542  Resampling.BICUB
+00001690: 4943 2c0a 2020 2020 2020 2020 6461 7461  IC,.        data
+000016a0: 5f66 6f72 6d61 743a 204f 7074 696f 6e61  _format: Optiona
+000016b0: 6c5b 556e 696f 6e5b 7374 722c 2043 6861  l[Union[str, Cha
+000016c0: 6e6e 656c 4469 6d65 6e73 696f 6e5d 5d20  nnelDimension]] 
+000016d0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+000016e0: 696e 7075 745f 6461 7461 5f66 6f72 6d61  input_data_forma
+000016f0: 743a 204f 7074 696f 6e61 6c5b 556e 696f  t: Optional[Unio
+00001700: 6e5b 7374 722c 2043 6861 6e6e 656c 4469  n[str, ChannelDi
+00001710: 6d65 6e73 696f 6e5d 5d20 3d20 4e6f 6e65  mension]] = None
+00001720: 2c0a 2020 2020 2020 2020 2a2a 6b77 6172  ,.        **kwar
+00001730: 6773 2c0a 2020 2020 2920 2d3e 206e 702e  gs,.    ) -> np.
+00001740: 6e64 6172 7261 793a 0a20 2020 2020 2020  ndarray:.       
+00001750: 2022 2222 0a20 2020 2020 2020 2052 6573   """.        Res
+00001760: 697a 6520 616e 2069 6d61 6765 2074 6f20  ize an image to 
+00001770: 6028 7369 7a65 5b22 6865 6967 6874 225d  `(size["height"]
+00001780: 2c20 7369 7a65 5b22 7769 6474 6822 5d29  , size["width"])
+00001790: 602e 0a0a 2020 2020 2020 2020 4172 6773  `...        Args
+000017a0: 3a0a 2020 2020 2020 2020 2020 2020 696d  :.            im
+000017b0: 6167 6520 2860 6e70 2e6e 6461 7272 6179  age (`np.ndarray
+000017c0: 6029 3a0a 2020 2020 2020 2020 2020 2020  `):.            
+000017d0: 2020 2020 496d 6167 6520 746f 2072 6573      Image to res
+000017e0: 697a 652e 0a20 2020 2020 2020 2020 2020  ize..           
+000017f0: 2073 697a 6520 2860 4469 6374 5b73 7472   size (`Dict[str
+00001800: 2c20 696e 745d 6029 3a0a 2020 2020 2020  , int]`):.      
+00001810: 2020 2020 2020 2020 2020 4469 6374 696f            Dictio
+00001820: 6e61 7279 2069 6e20 7468 6520 666f 726d  nary in the form
+00001830: 6174 2060 7b22 6865 6967 6874 223a 2069  at `{"height": i
+00001840: 6e74 2c20 2277 6964 7468 223a 2069 6e74  nt, "width": int
+00001850: 7d60 2073 7065 6369 6679 696e 6720 7468  }` specifying th
+00001860: 6520 7369 7a65 206f 6620 7468 6520 6f75  e size of the ou
+00001870: 7470 7574 2069 6d61 6765 2e0a 2020 2020  tput image..    
+00001880: 2020 2020 2020 2020 7265 7361 6d70 6c65          resample
+00001890: 2028 6050 494c 496d 6167 6552 6573 616d   (`PILImageResam
+000018a0: 706c 696e 6760 2c20 2a6f 7074 696f 6e61  pling`, *optiona
+000018b0: 6c2a 2c20 6465 6661 756c 7473 2074 6f20  l*, defaults to 
+000018c0: 6050 494c 496d 6167 6552 6573 616d 706c  `PILImageResampl
+000018d0: 696e 672e 4249 4355 4249 4360 293a 0a20  ing.BICUBIC`):. 
+000018e0: 2020 2020 2020 2020 2020 2020 2020 2060                 `
+000018f0: 5049 4c49 6d61 6765 5265 7361 6d70 6c69  PILImageResampli
+00001900: 6e67 6020 6669 6c74 6572 2074 6f20 7573  ng` filter to us
+00001910: 6520 7768 656e 2072 6573 697a 696e 6720  e when resizing 
+00001920: 7468 6520 696d 6167 6520 652e 672e 2060  the image e.g. `
+00001930: 5049 4c49 6d61 6765 5265 7361 6d70 6c69  PILImageResampli
+00001940: 6e67 2e42 4943 5542 4943 602e 0a20 2020  ng.BICUBIC`..   
+00001950: 2020 2020 2020 2020 2064 6174 615f 666f           data_fo
+00001960: 726d 6174 2028 6043 6861 6e6e 656c 4469  rmat (`ChannelDi
+00001970: 6d65 6e73 696f 6e60 206f 7220 6073 7472  mension` or `str
+00001980: 602c 202a 6f70 7469 6f6e 616c 2a29 3a0a  `, *optional*):.
+00001990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000019a0: 5468 6520 6368 616e 6e65 6c20 6469 6d65  The channel dime
+000019b0: 6e73 696f 6e20 666f 726d 6174 2066 6f72  nsion format for
+000019c0: 2074 6865 206f 7574 7075 7420 696d 6167   the output imag
+000019d0: 652e 2049 6620 756e 7365 742c 2074 6865  e. If unset, the
+000019e0: 2063 6861 6e6e 656c 2064 696d 656e 7369   channel dimensi
+000019f0: 6f6e 2066 6f72 6d61 7420 6f66 2074 6865  on format of the
+00001a00: 2069 6e70 7574 0a20 2020 2020 2020 2020   input.         
+00001a10: 2020 2020 2020 2069 6d61 6765 2069 7320         image is 
+00001a20: 7573 6564 2e20 4361 6e20 6265 206f 6e65  used. Can be one
+00001a30: 206f 663a 0a20 2020 2020 2020 2020 2020   of:.           
+00001a40: 2020 2020 202d 2060 2263 6861 6e6e 656c       - `"channel
+00001a50: 735f 6669 7273 7422 6020 6f72 2060 4368  s_first"` or `Ch
+00001a60: 616e 6e65 6c44 696d 656e 7369 6f6e 2e46  annelDimension.F
+00001a70: 4952 5354 603a 2069 6d61 6765 2069 6e20  IRST`: image in 
+00001a80: 286e 756d 5f63 6861 6e6e 656c 732c 2068  (num_channels, h
+00001a90: 6569 6768 742c 2077 6964 7468 2920 666f  eight, width) fo
+00001aa0: 726d 6174 2e0a 2020 2020 2020 2020 2020  rmat..          
+00001ab0: 2020 2020 2020 2d20 6022 6368 616e 6e65        - `"channe
+00001ac0: 6c73 5f6c 6173 7422 6020 6f72 2060 4368  ls_last"` or `Ch
+00001ad0: 616e 6e65 6c44 696d 656e 7369 6f6e 2e4c  annelDimension.L
+00001ae0: 4153 5460 3a20 696d 6167 6520 696e 2028  AST`: image in (
+00001af0: 6865 6967 6874 2c20 7769 6474 682c 206e  height, width, n
+00001b00: 756d 5f63 6861 6e6e 656c 7329 2066 6f72  um_channels) for
+00001b10: 6d61 742e 0a20 2020 2020 2020 2020 2020  mat..           
+00001b20: 2020 2020 202d 2060 226e 6f6e 6522 6020       - `"none"` 
+00001b30: 6f72 2060 4368 616e 6e65 6c44 696d 656e  or `ChannelDimen
+00001b40: 7369 6f6e 2e4e 4f4e 4560 3a20 696d 6167  sion.NONE`: imag
+00001b50: 6520 696e 2028 6865 6967 6874 2c20 7769  e in (height, wi
+00001b60: 6474 6829 2066 6f72 6d61 742e 0a20 2020  dth) format..   
+00001b70: 2020 2020 2020 2020 2069 6e70 7574 5f64           input_d
+00001b80: 6174 615f 666f 726d 6174 2028 6043 6861  ata_format (`Cha
+00001b90: 6e6e 656c 4469 6d65 6e73 696f 6e60 206f  nnelDimension` o
+00001ba0: 7220 6073 7472 602c 202a 6f70 7469 6f6e  r `str`, *option
+00001bb0: 616c 2a29 3a0a 2020 2020 2020 2020 2020  al*):.          
+00001bc0: 2020 2020 2020 5468 6520 6368 616e 6e65        The channe
+00001bd0: 6c20 6469 6d65 6e73 696f 6e20 666f 726d  l dimension form
+00001be0: 6174 2066 6f72 2074 6865 2069 6e70 7574  at for the input
+00001bf0: 2069 6d61 6765 2e20 4966 2075 6e73 6574   image. If unset
+00001c00: 2c20 7468 6520 6368 616e 6e65 6c20 6469  , the channel di
+00001c10: 6d65 6e73 696f 6e20 666f 726d 6174 2069  mension format i
+00001c20: 7320 696e 6665 7272 6564 0a20 2020 2020  s inferred.     
+00001c30: 2020 2020 2020 2020 2020 2066 726f 6d20             from 
+00001c40: 7468 6520 696e 7075 7420 696d 6167 652e  the input image.
+00001c50: 2043 616e 2062 6520 6f6e 6520 6f66 3a0a   Can be one of:.
+00001c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001c70: 2d20 6022 6368 616e 6e65 6c73 5f66 6972  - `"channels_fir
+00001c80: 7374 2260 206f 7220 6043 6861 6e6e 656c  st"` or `Channel
+00001c90: 4469 6d65 6e73 696f 6e2e 4649 5253 5460  Dimension.FIRST`
+00001ca0: 3a20 696d 6167 6520 696e 2028 6e75 6d5f  : image in (num_
+00001cb0: 6368 616e 6e65 6c73 2c20 6865 6967 6874  channels, height
+00001cc0: 2c20 7769 6474 6829 2066 6f72 6d61 742e  , width) format.
+00001cd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00001ce0: 202d 2060 2263 6861 6e6e 656c 735f 6c61   - `"channels_la
+00001cf0: 7374 2260 206f 7220 6043 6861 6e6e 656c  st"` or `Channel
+00001d00: 4469 6d65 6e73 696f 6e2e 4c41 5354 603a  Dimension.LAST`:
+00001d10: 2069 6d61 6765 2069 6e20 2868 6569 6768   image in (heigh
+00001d20: 742c 2077 6964 7468 2c20 6e75 6d5f 6368  t, width, num_ch
+00001d30: 616e 6e65 6c73 2920 666f 726d 6174 2e0a  annels) format..
+00001d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001d50: 2d20 6022 6e6f 6e65 2260 206f 7220 6043  - `"none"` or `C
+00001d60: 6861 6e6e 656c 4469 6d65 6e73 696f 6e2e  hannelDimension.
+00001d70: 4e4f 4e45 603a 2069 6d61 6765 2069 6e20  NONE`: image in 
+00001d80: 2868 6569 6768 742c 2077 6964 7468 2920  (height, width) 
+00001d90: 666f 726d 6174 2e0a 0a20 2020 2020 2020  format...       
+00001da0: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+00001db0: 2020 2020 2020 606e 702e 6e64 6172 7261        `np.ndarra
+00001dc0: 7960 3a20 5468 6520 7265 7369 7a65 6420  y`: The resized 
+00001dd0: 696d 6167 652e 0a20 2020 2020 2020 2022  image..        "
+00001de0: 2222 0a20 2020 2020 2020 2073 697a 6520  "".        size 
+00001df0: 3d20 6765 745f 7369 7a65 5f64 6963 7428  = get_size_dict(
+00001e00: 7369 7a65 290a 2020 2020 2020 2020 6966  size).        if
+00001e10: 2022 6865 6967 6874 2220 6e6f 7420 696e   "height" not in
+00001e20: 2073 697a 6520 6f72 2022 7769 6474 6822   size or "width"
+00001e30: 206e 6f74 2069 6e20 7369 7a65 3a0a 2020   not in size:.  
+00001e40: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00001e50: 5661 6c75 6545 7272 6f72 2866 2254 6865  ValueError(f"The
+00001e60: 2060 7369 7a65 6020 6469 6374 696f 6e61   `size` dictiona
+00001e70: 7279 206d 7573 7420 636f 6e74 6169 6e20  ry must contain 
+00001e80: 7468 6520 6b65 7973 2060 6865 6967 6874  the keys `height
+00001e90: 6020 616e 6420 6077 6964 7468 602e 2047  ` and `width`. G
+00001ea0: 6f74 207b 7369 7a65 2e6b 6579 7328 297d  ot {size.keys()}
+00001eb0: 2229 0a20 2020 2020 2020 206f 7574 7075  ").        outpu
+00001ec0: 745f 7369 7a65 203d 2028 7369 7a65 5b22  t_size = (size["
+00001ed0: 6865 6967 6874 225d 2c20 7369 7a65 5b22  height"], size["
+00001ee0: 7769 6474 6822 5d29 0a20 2020 2020 2020  width"]).       
+00001ef0: 2072 6574 7572 6e20 7265 7369 7a65 280a   return resize(.
+00001f00: 2020 2020 2020 2020 2020 2020 696d 6167              imag
+00001f10: 652c 0a20 2020 2020 2020 2020 2020 2073  e,.            s
+00001f20: 697a 653d 6f75 7470 7574 5f73 697a 652c  ize=output_size,
+00001f30: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+00001f40: 616d 706c 653d 7265 7361 6d70 6c65 2c0a  ample=resample,.
+00001f50: 2020 2020 2020 2020 2020 2020 6461 7461              data
+00001f60: 5f66 6f72 6d61 743d 6461 7461 5f66 6f72  _format=data_for
+00001f70: 6d61 742c 0a20 2020 2020 2020 2020 2020  mat,.           
+00001f80: 2069 6e70 7574 5f64 6174 615f 666f 726d   input_data_form
+00001f90: 6174 3d69 6e70 7574 5f64 6174 615f 666f  at=input_data_fo
+00001fa0: 726d 6174 2c0a 2020 2020 2020 2020 2020  rmat,.          
+00001fb0: 2020 2a2a 6b77 6172 6773 2c0a 2020 2020    **kwargs,.    
+00001fc0: 2020 2020 290a 0a20 2020 2064 6566 2070      )..    def p
+00001fd0: 7265 7072 6f63 6573 7328 0a20 2020 2020  reprocess(.     
+00001fe0: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+00001ff0: 2069 6d61 6765 733a 2049 6d61 6765 496e   images: ImageIn
+00002000: 7075 742c 0a20 2020 2020 2020 2064 6f5f  put,.        do_
+00002010: 7265 7369 7a65 3a20 4f70 7469 6f6e 616c  resize: Optional
+00002020: 5b62 6f6f 6c5d 203d 204e 6f6e 652c 0a20  [bool] = None,. 
+00002030: 2020 2020 2020 2073 697a 653a 204f 7074         size: Opt
+00002040: 696f 6e61 6c5b 4469 6374 5b73 7472 2c20  ional[Dict[str, 
+00002050: 696e 745d 5d20 3d20 4e6f 6e65 2c0a 2020  int]] = None,.  
+00002060: 2020 2020 2020 7265 7361 6d70 6c65 3a20        resample: 
+00002070: 5049 4c49 6d61 6765 5265 7361 6d70 6c69  PILImageResampli
+00002080: 6e67 203d 204e 6f6e 652c 0a20 2020 2020  ng = None,.     
+00002090: 2020 2064 6f5f 7265 7363 616c 653a 204f     do_rescale: O
+000020a0: 7074 696f 6e61 6c5b 626f 6f6c 5d20 3d20  ptional[bool] = 
+000020b0: 4e6f 6e65 2c0a 2020 2020 2020 2020 7265  None,.        re
+000020c0: 7363 616c 655f 6661 6374 6f72 3a20 4f70  scale_factor: Op
+000020d0: 7469 6f6e 616c 5b66 6c6f 6174 5d20 3d20  tional[float] = 
+000020e0: 4e6f 6e65 2c0a 2020 2020 2020 2020 646f  None,.        do
+000020f0: 5f6e 6f72 6d61 6c69 7a65 3a20 4f70 7469  _normalize: Opti
+00002100: 6f6e 616c 5b62 6f6f 6c5d 203d 204e 6f6e  onal[bool] = Non
+00002110: 652c 0a20 2020 2020 2020 2069 6d61 6765  e,.        image
+00002120: 5f6d 6561 6e3a 204f 7074 696f 6e61 6c5b  _mean: Optional[
+00002130: 556e 696f 6e5b 666c 6f61 742c 204c 6973  Union[float, Lis
+00002140: 745b 666c 6f61 745d 5d5d 203d 204e 6f6e  t[float]]] = Non
+00002150: 652c 0a20 2020 2020 2020 2069 6d61 6765  e,.        image
+00002160: 5f73 7464 3a20 4f70 7469 6f6e 616c 5b55  _std: Optional[U
+00002170: 6e69 6f6e 5b66 6c6f 6174 2c20 4c69 7374  nion[float, List
+00002180: 5b66 6c6f 6174 5d5d 5d20 3d20 4e6f 6e65  [float]]] = None
+00002190: 2c0a 2020 2020 2020 2020 7265 7475 726e  ,.        return
+000021a0: 5f74 656e 736f 7273 3a20 4f70 7469 6f6e  _tensors: Option
+000021b0: 616c 5b55 6e69 6f6e 5b73 7472 2c20 5465  al[Union[str, Te
+000021c0: 6e73 6f72 5479 7065 5d5d 203d 204e 6f6e  nsorType]] = Non
+000021d0: 652c 0a20 2020 2020 2020 2064 6f5f 636f  e,.        do_co
+000021e0: 6e76 6572 745f 7267 623a 2062 6f6f 6c20  nvert_rgb: bool 
+000021f0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00002200: 6461 7461 5f66 6f72 6d61 743a 2043 6861  data_format: Cha
+00002210: 6e6e 656c 4469 6d65 6e73 696f 6e20 3d20  nnelDimension = 
+00002220: 4368 616e 6e65 6c44 696d 656e 7369 6f6e  ChannelDimension
+00002230: 2e46 4952 5354 2c0a 2020 2020 2020 2020  .FIRST,.        
+00002240: 696e 7075 745f 6461 7461 5f66 6f72 6d61  input_data_forma
+00002250: 743a 204f 7074 696f 6e61 6c5b 556e 696f  t: Optional[Unio
+00002260: 6e5b 7374 722c 2043 6861 6e6e 656c 4469  n[str, ChannelDi
+00002270: 6d65 6e73 696f 6e5d 5d20 3d20 4e6f 6e65  mension]] = None
+00002280: 2c0a 2020 2020 2020 2020 2a2a 6b77 6172  ,.        **kwar
+00002290: 6773 2c0a 2020 2020 2920 2d3e 2050 494c  gs,.    ) -> PIL
+000022a0: 2e49 6d61 6765 2e49 6d61 6765 3a0a 2020  .Image.Image:.  
+000022b0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+000022c0: 2020 5072 6570 726f 6365 7373 2061 6e20    Preprocess an 
+000022d0: 696d 6167 6520 6f72 2062 6174 6368 206f  image or batch o
+000022e0: 6620 696d 6167 6573 2e0a 0a20 2020 2020  f images...     
+000022f0: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+00002300: 2020 2020 2069 6d61 6765 7320 2860 496d       images (`Im
+00002310: 6167 6549 6e70 7574 6029 3a0a 2020 2020  ageInput`):.    
+00002320: 2020 2020 2020 2020 2020 2020 496d 6167              Imag
+00002330: 6520 746f 2070 7265 7072 6f63 6573 732e  e to preprocess.
+00002340: 2045 7870 6563 7473 2061 2073 696e 676c   Expects a singl
+00002350: 6520 6f72 2062 6174 6368 206f 6620 696d  e or batch of im
+00002360: 6167 6573 2077 6974 6820 7069 7865 6c20  ages with pixel 
+00002370: 7661 6c75 6573 2072 616e 6769 6e67 2066  values ranging f
+00002380: 726f 6d20 3020 746f 2032 3535 2e20 4966  rom 0 to 255. If
+00002390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000023a0: 2070 6173 7369 6e67 2069 6e20 696d 6167   passing in imag
+000023b0: 6573 2077 6974 6820 7069 7865 6c20 7661  es with pixel va
+000023c0: 6c75 6573 2062 6574 7765 656e 2030 2061  lues between 0 a
+000023d0: 6e64 2031 2c20 7365 7420 6064 6f5f 7265  nd 1, set `do_re
+000023e0: 7363 616c 653d 4661 6c73 6560 2e0a 2020  scale=False`..  
+000023f0: 2020 2020 2020 2020 2020 646f 5f72 6573            do_res
+00002400: 697a 6520 2860 626f 6f6c 602c 202a 6f70  ize (`bool`, *op
+00002410: 7469 6f6e 616c 2a2c 2064 6566 6175 6c74  tional*, default
+00002420: 7320 746f 2060 7365 6c66 2e64 6f5f 7265  s to `self.do_re
+00002430: 7369 7a65 6029 3a0a 2020 2020 2020 2020  size`):.        
+00002440: 2020 2020 2020 2020 5768 6574 6865 7220          Whether 
+00002450: 746f 2072 6573 697a 6520 7468 6520 696d  to resize the im
+00002460: 6167 652e 0a20 2020 2020 2020 2020 2020  age..           
+00002470: 2073 697a 6520 2860 4469 6374 5b73 7472   size (`Dict[str
+00002480: 2c20 696e 745d 602c 202a 6f70 7469 6f6e  , int]`, *option
+00002490: 616c 2a2c 2064 6566 6175 6c74 7320 746f  al*, defaults to
+000024a0: 2060 7365 6c66 2e73 697a 6560 293a 0a20   `self.size`):. 
+000024b0: 2020 2020 2020 2020 2020 2020 2020 2043                 C
+000024c0: 6f6e 7472 6f6c 7320 7468 6520 7369 7a65  ontrols the size
+000024d0: 206f 6620 7468 6520 696d 6167 6520 6166   of the image af
+000024e0: 7465 7220 6072 6573 697a 6560 2e20 5468  ter `resize`. Th
+000024f0: 6520 7368 6f72 7465 7374 2065 6467 6520  e shortest edge 
+00002500: 6f66 2074 6865 2069 6d61 6765 2069 7320  of the image is 
+00002510: 7265 7369 7a65 6420 746f 0a20 2020 2020  resized to.     
+00002520: 2020 2020 2020 2020 2020 2060 7369 7a65             `size
+00002530: 5b22 7368 6f72 7465 7374 5f65 6467 6522  ["shortest_edge"
+00002540: 5d60 2077 6869 6c73 7420 7072 6573 6572  ]` whilst preser
+00002550: 7669 6e67 2074 6865 2061 7370 6563 7420  ving the aspect 
+00002560: 7261 7469 6f2e 2049 6620 7468 6520 6c6f  ratio. If the lo
+00002570: 6e67 6573 7420 6564 6765 206f 6620 7468  ngest edge of th
+00002580: 6973 2072 6573 697a 6564 2069 6d61 6765  is resized image
+00002590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000025a0: 2069 7320 3e20 6069 6e74 2873 697a 655b   is > `int(size[
+000025b0: 2273 686f 7274 6573 745f 6564 6765 225d  "shortest_edge"]
+000025c0: 202a 2028 3133 3333 202f 2038 3030 2929   * (1333 / 800))
+000025d0: 602c 2074 6865 6e20 7468 6520 696d 6167  `, then the imag
+000025e0: 6520 6973 2072 6573 697a 6564 2061 6761  e is resized aga
+000025f0: 696e 2074 6f20 6d61 6b65 2074 6865 206c  in to make the l
+00002600: 6f6e 6765 7374 0a20 2020 2020 2020 2020  ongest.         
+00002610: 2020 2020 2020 2065 6467 6520 6571 7561         edge equa
+00002620: 6c20 746f 2060 696e 7428 7369 7a65 5b22  l to `int(size["
+00002630: 7368 6f72 7465 7374 5f65 6467 6522 5d20  shortest_edge"] 
+00002640: 2a20 2831 3333 3320 2f20 3830 3029 2960  * (1333 / 800))`
+00002650: 2e0a 2020 2020 2020 2020 2020 2020 7265  ..            re
+00002660: 7361 6d70 6c65 2028 6050 494c 496d 6167  sample (`PILImag
+00002670: 6552 6573 616d 706c 696e 6760 2c20 2a6f  eResampling`, *o
+00002680: 7074 696f 6e61 6c2a 2c20 6465 6661 756c  ptional*, defaul
+00002690: 7473 2074 6f20 6073 656c 662e 7265 7361  ts to `self.resa
+000026a0: 6d70 6c65 6029 3a0a 2020 2020 2020 2020  mple`):.        
+000026b0: 2020 2020 2020 2020 5265 7361 6d70 6c69          Resampli
+000026c0: 6e67 2066 696c 7465 7220 746f 2075 7365  ng filter to use
+000026d0: 2069 6620 7265 7369 7a69 6e67 2074 6865   if resizing the
+000026e0: 2069 6d61 6765 2e20 4f6e 6c79 2068 6173   image. Only has
+000026f0: 2061 6e20 6566 6665 6374 2069 6620 6064   an effect if `d
+00002700: 6f5f 7265 7369 7a65 6020 6973 2073 6574  o_resize` is set
+00002710: 2074 6f20 6054 7275 6560 2e0a 2020 2020   to `True`..    
+00002720: 2020 2020 2020 2020 646f 5f72 6573 6361          do_resca
+00002730: 6c65 2028 6062 6f6f 6c60 2c20 2a6f 7074  le (`bool`, *opt
+00002740: 696f 6e61 6c2a 2c20 6465 6661 756c 7473  ional*, defaults
+00002750: 2074 6f20 6073 656c 662e 646f 5f72 6573   to `self.do_res
+00002760: 6361 6c65 6029 3a0a 2020 2020 2020 2020  cale`):.        
+00002770: 2020 2020 2020 2020 5768 6574 6865 7220          Whether 
+00002780: 746f 2072 6573 6361 6c65 2074 6865 2069  to rescale the i
+00002790: 6d61 6765 2076 616c 7565 7320 6265 7477  mage values betw
+000027a0: 6565 6e20 5b30 202d 2031 5d2e 0a20 2020  een [0 - 1]..   
+000027b0: 2020 2020 2020 2020 2072 6573 6361 6c65           rescale
+000027c0: 5f66 6163 746f 7220 2860 666c 6f61 7460  _factor (`float`
+000027d0: 2c20 2a6f 7074 696f 6e61 6c2a 2c20 6465  , *optional*, de
+000027e0: 6661 756c 7473 2074 6f20 6073 656c 662e  faults to `self.
+000027f0: 7265 7363 616c 655f 6661 6374 6f72 6029  rescale_factor`)
+00002800: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00002810: 2020 5265 7363 616c 6520 6661 6374 6f72    Rescale factor
+00002820: 2074 6f20 7265 7363 616c 6520 7468 6520   to rescale the 
+00002830: 696d 6167 6520 6279 2069 6620 6064 6f5f  image by if `do_
+00002840: 7265 7363 616c 6560 2069 7320 7365 7420  rescale` is set 
+00002850: 746f 2060 5472 7565 602e 0a20 2020 2020  to `True`..     
+00002860: 2020 2020 2020 2064 6f5f 6e6f 726d 616c         do_normal
+00002870: 697a 6520 2860 626f 6f6c 602c 202a 6f70  ize (`bool`, *op
+00002880: 7469 6f6e 616c 2a2c 2064 6566 6175 6c74  tional*, default
+00002890: 7320 746f 2060 7365 6c66 2e64 6f5f 6e6f  s to `self.do_no
+000028a0: 726d 616c 697a 6560 293a 0a20 2020 2020  rmalize`):.     
+000028b0: 2020 2020 2020 2020 2020 2057 6865 7468             Wheth
+000028c0: 6572 2074 6f20 6e6f 726d 616c 697a 6520  er to normalize 
+000028d0: 7468 6520 696d 6167 652e 0a20 2020 2020  the image..     
+000028e0: 2020 2020 2020 2069 6d61 6765 5f6d 6561         image_mea
+000028f0: 6e20 2860 666c 6f61 7460 206f 7220 604c  n (`float` or `L
+00002900: 6973 745b 666c 6f61 745d 602c 202a 6f70  ist[float]`, *op
+00002910: 7469 6f6e 616c 2a2c 2064 6566 6175 6c74  tional*, default
+00002920: 7320 746f 2060 7365 6c66 2e69 6d61 6765  s to `self.image
+00002930: 5f6d 6561 6e60 293a 0a20 2020 2020 2020  _mean`):.       
+00002940: 2020 2020 2020 2020 2049 6d61 6765 206d           Image m
+00002950: 6561 6e20 746f 206e 6f72 6d61 6c69 7a65  ean to normalize
+00002960: 2074 6865 2069 6d61 6765 2062 7920 6966   the image by if
+00002970: 2060 646f 5f6e 6f72 6d61 6c69 7a65 6020   `do_normalize` 
+00002980: 6973 2073 6574 2074 6f20 6054 7275 6560  is set to `True`
+00002990: 2e0a 2020 2020 2020 2020 2020 2020 696d  ..            im
+000029a0: 6167 655f 7374 6420 2860 666c 6f61 7460  age_std (`float`
+000029b0: 206f 7220 604c 6973 745b 666c 6f61 745d   or `List[float]
+000029c0: 602c 202a 6f70 7469 6f6e 616c 2a2c 2064  `, *optional*, d
+000029d0: 6566 6175 6c74 7320 746f 2060 7365 6c66  efaults to `self
+000029e0: 2e69 6d61 6765 5f73 7464 6029 3a0a 2020  .image_std`):.  
+000029f0: 2020 2020 2020 2020 2020 2020 2020 496d                Im
+00002a00: 6167 6520 7374 616e 6461 7264 2064 6576  age standard dev
+00002a10: 6961 7469 6f6e 2074 6f20 6e6f 726d 616c  iation to normal
+00002a20: 697a 6520 7468 6520 696d 6167 6520 6279  ize the image by
+00002a30: 2069 6620 6064 6f5f 6e6f 726d 616c 697a   if `do_normaliz
+00002a40: 6560 2069 7320 7365 7420 746f 2060 5472  e` is set to `Tr
+00002a50: 7565 602e 0a20 2020 2020 2020 2020 2020  ue`..           
+00002a60: 2064 6f5f 636f 6e76 6572 745f 7267 6220   do_convert_rgb 
+00002a70: 2860 626f 6f6c 602c 202a 6f70 7469 6f6e  (`bool`, *option
+00002a80: 616c 2a2c 2064 6566 6175 6c74 7320 746f  al*, defaults to
+00002a90: 2060 7365 6c66 2e64 6f5f 636f 6e76 6572   `self.do_conver
+00002aa0: 745f 7267 6260 293a 0a20 2020 2020 2020  t_rgb`):.       
+00002ab0: 2020 2020 2020 2020 2057 6865 7468 6572           Whether
+00002ac0: 2074 6f20 636f 6e76 6572 7420 7468 6520   to convert the 
+00002ad0: 696d 6167 6520 746f 2052 4742 2e0a 2020  image to RGB..  
+00002ae0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00002af0: 5f74 656e 736f 7273 2028 6073 7472 6020  _tensors (`str` 
+00002b00: 6f72 2060 5465 6e73 6f72 5479 7065 602c  or `TensorType`,
+00002b10: 202a 6f70 7469 6f6e 616c 2a29 3a0a 2020   *optional*):.  
+00002b20: 2020 2020 2020 2020 2020 2020 2020 5468                Th
+00002b30: 6520 7479 7065 206f 6620 7465 6e73 6f72  e type of tensor
+00002b40: 7320 746f 2072 6574 7572 6e2e 2043 616e  s to return. Can
+00002b50: 2062 6520 6f6e 6520 6f66 3a0a 2020 2020   be one of:.    
+00002b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002b70: 2d20 556e 7365 743a 2052 6574 7572 6e20  - Unset: Return 
+00002b80: 6120 6c69 7374 206f 6620 606e 702e 6e64  a list of `np.nd
+00002b90: 6172 7261 7960 2e0a 2020 2020 2020 2020  array`..        
+00002ba0: 2020 2020 2020 2020 2020 2020 2d20 6054              - `T
+00002bb0: 656e 736f 7254 7970 652e 5445 4e53 4f52  ensorType.TENSOR
+00002bc0: 464c 4f57 6020 6f72 2060 2774 6627 603a  FLOW` or `'tf'`:
+00002bd0: 2052 6574 7572 6e20 6120 6261 7463 6820   Return a batch 
+00002be0: 6f66 2074 7970 6520 6074 662e 5465 6e73  of type `tf.Tens
+00002bf0: 6f72 602e 0a20 2020 2020 2020 2020 2020  or`..           
+00002c00: 2020 2020 2020 2020 202d 2060 5465 6e73           - `Tens
+00002c10: 6f72 5479 7065 2e50 5954 4f52 4348 6020  orType.PYTORCH` 
+00002c20: 6f72 2060 2770 7427 603a 2052 6574 7572  or `'pt'`: Retur
+00002c30: 6e20 6120 6261 7463 6820 6f66 2074 7970  n a batch of typ
+00002c40: 6520 6074 6f72 6368 2e54 656e 736f 7260  e `torch.Tensor`
+00002c50: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00002c60: 2020 2020 2020 2d20 6054 656e 736f 7254        - `TensorT
+00002c70: 7970 652e 4e55 4d50 5960 206f 7220 6027  ype.NUMPY` or `'
+00002c80: 6e70 2760 3a20 5265 7475 726e 2061 2062  np'`: Return a b
+00002c90: 6174 6368 206f 6620 7479 7065 2060 6e70  atch of type `np
+00002ca0: 2e6e 6461 7272 6179 602e 0a20 2020 2020  .ndarray`..     
+00002cb0: 2020 2020 2020 2020 2020 2020 2020 202d                 -
+00002cc0: 2060 5465 6e73 6f72 5479 7065 2e4a 4158   `TensorType.JAX
+00002cd0: 6020 6f72 2060 276a 6178 2760 3a20 5265  ` or `'jax'`: Re
+00002ce0: 7475 726e 2061 2062 6174 6368 206f 6620  turn a batch of 
+00002cf0: 7479 7065 2060 6a61 782e 6e75 6d70 792e  type `jax.numpy.
+00002d00: 6e64 6172 7261 7960 2e0a 2020 2020 2020  ndarray`..      
+00002d10: 2020 2020 2020 6461 7461 5f66 6f72 6d61        data_forma
+00002d20: 7420 2860 4368 616e 6e65 6c44 696d 656e  t (`ChannelDimen
+00002d30: 7369 6f6e 6020 6f72 2060 7374 7260 2c20  sion` or `str`, 
+00002d40: 2a6f 7074 696f 6e61 6c2a 2c20 6465 6661  *optional*, defa
+00002d50: 756c 7473 2074 6f20 6043 6861 6e6e 656c  ults to `Channel
+00002d60: 4469 6d65 6e73 696f 6e2e 4649 5253 5460  Dimension.FIRST`
+00002d70: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00002d80: 2020 2054 6865 2063 6861 6e6e 656c 2064     The channel d
+00002d90: 696d 656e 7369 6f6e 2066 6f72 6d61 7420  imension format 
+00002da0: 666f 7220 7468 6520 6f75 7470 7574 2069  for the output i
+00002db0: 6d61 6765 2e20 4361 6e20 6265 206f 6e65  mage. Can be one
+00002dc0: 206f 663a 0a20 2020 2020 2020 2020 2020   of:.           
+00002dd0: 2020 2020 202d 2060 2263 6861 6e6e 656c       - `"channel
+00002de0: 735f 6669 7273 7422 6020 6f72 2060 4368  s_first"` or `Ch
+00002df0: 616e 6e65 6c44 696d 656e 7369 6f6e 2e46  annelDimension.F
+00002e00: 4952 5354 603a 2069 6d61 6765 2069 6e20  IRST`: image in 
+00002e10: 286e 756d 5f63 6861 6e6e 656c 732c 2068  (num_channels, h
+00002e20: 6569 6768 742c 2077 6964 7468 2920 666f  eight, width) fo
+00002e30: 726d 6174 2e0a 2020 2020 2020 2020 2020  rmat..          
+00002e40: 2020 2020 2020 2d20 6022 6368 616e 6e65        - `"channe
+00002e50: 6c73 5f6c 6173 7422 6020 6f72 2060 4368  ls_last"` or `Ch
+00002e60: 616e 6e65 6c44 696d 656e 7369 6f6e 2e4c  annelDimension.L
+00002e70: 4153 5460 3a20 696d 6167 6520 696e 2028  AST`: image in (
+00002e80: 6865 6967 6874 2c20 7769 6474 682c 206e  height, width, n
+00002e90: 756d 5f63 6861 6e6e 656c 7329 2066 6f72  um_channels) for
+00002ea0: 6d61 742e 0a20 2020 2020 2020 2020 2020  mat..           
+00002eb0: 2020 2020 202d 2055 6e73 6574 3a20 5573       - Unset: Us
+00002ec0: 6520 7468 6520 6368 616e 6e65 6c20 6469  e the channel di
+00002ed0: 6d65 6e73 696f 6e20 666f 726d 6174 206f  mension format o
+00002ee0: 6620 7468 6520 696e 7075 7420 696d 6167  f the input imag
+00002ef0: 652e 0a20 2020 2020 2020 2020 2020 2069  e..            i
+00002f00: 6e70 7574 5f64 6174 615f 666f 726d 6174  nput_data_format
+00002f10: 2028 6043 6861 6e6e 656c 4469 6d65 6e73   (`ChannelDimens
+00002f20: 696f 6e60 206f 7220 6073 7472 602c 202a  ion` or `str`, *
+00002f30: 6f70 7469 6f6e 616c 2a29 3a0a 2020 2020  optional*):.    
+00002f40: 2020 2020 2020 2020 2020 2020 5468 6520              The 
+00002f50: 6368 616e 6e65 6c20 6469 6d65 6e73 696f  channel dimensio
+00002f60: 6e20 666f 726d 6174 2066 6f72 2074 6865  n format for the
+00002f70: 2069 6e70 7574 2069 6d61 6765 2e20 4966   input image. If
+00002f80: 2075 6e73 6574 2c20 7468 6520 6368 616e   unset, the chan
+00002f90: 6e65 6c20 6469 6d65 6e73 696f 6e20 666f  nel dimension fo
+00002fa0: 726d 6174 2069 7320 696e 6665 7272 6564  rmat is inferred
+00002fb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00002fc0: 2066 726f 6d20 7468 6520 696e 7075 7420   from the input 
+00002fd0: 696d 6167 652e 2043 616e 2062 6520 6f6e  image. Can be on
+00002fe0: 6520 6f66 3a0a 2020 2020 2020 2020 2020  e of:.          
+00002ff0: 2020 2020 2020 2d20 6022 6368 616e 6e65        - `"channe
+00003000: 6c73 5f66 6972 7374 2260 206f 7220 6043  ls_first"` or `C
+00003010: 6861 6e6e 656c 4469 6d65 6e73 696f 6e2e  hannelDimension.
+00003020: 4649 5253 5460 3a20 696d 6167 6520 696e  FIRST`: image in
+00003030: 2028 6e75 6d5f 6368 616e 6e65 6c73 2c20   (num_channels, 
+00003040: 6865 6967 6874 2c20 7769 6474 6829 2066  height, width) f
+00003050: 6f72 6d61 742e 0a20 2020 2020 2020 2020  ormat..         
+00003060: 2020 2020 2020 202d 2060 2263 6861 6e6e         - `"chann
+00003070: 656c 735f 6c61 7374 2260 206f 7220 6043  els_last"` or `C
+00003080: 6861 6e6e 656c 4469 6d65 6e73 696f 6e2e  hannelDimension.
+00003090: 4c41 5354 603a 2069 6d61 6765 2069 6e20  LAST`: image in 
+000030a0: 2868 6569 6768 742c 2077 6964 7468 2c20  (height, width, 
+000030b0: 6e75 6d5f 6368 616e 6e65 6c73 2920 666f  num_channels) fo
+000030c0: 726d 6174 2e0a 2020 2020 2020 2020 2020  rmat..          
+000030d0: 2020 2020 2020 2d20 6022 6e6f 6e65 2260        - `"none"`
+000030e0: 206f 7220 6043 6861 6e6e 656c 4469 6d65   or `ChannelDime
+000030f0: 6e73 696f 6e2e 4e4f 4e45 603a 2069 6d61  nsion.NONE`: ima
+00003100: 6765 2069 6e20 2868 6569 6768 742c 2077  ge in (height, w
+00003110: 6964 7468 2920 666f 726d 6174 2e0a 2020  idth) format..  
+00003120: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00003130: 2020 646f 5f72 6573 697a 6520 3d20 646f    do_resize = do
+00003140: 5f72 6573 697a 6520 6966 2064 6f5f 7265  _resize if do_re
+00003150: 7369 7a65 2069 7320 6e6f 7420 4e6f 6e65  size is not None
+00003160: 2065 6c73 6520 7365 6c66 2e64 6f5f 7265   else self.do_re
+00003170: 7369 7a65 0a20 2020 2020 2020 2072 6573  size.        res
+00003180: 616d 706c 6520 3d20 7265 7361 6d70 6c65  ample = resample
+00003190: 2069 6620 7265 7361 6d70 6c65 2069 7320   if resample is 
+000031a0: 6e6f 7420 4e6f 6e65 2065 6c73 6520 7365  not None else se
+000031b0: 6c66 2e72 6573 616d 706c 650a 2020 2020  lf.resample.    
+000031c0: 2020 2020 646f 5f72 6573 6361 6c65 203d      do_rescale =
+000031d0: 2064 6f5f 7265 7363 616c 6520 6966 2064   do_rescale if d
+000031e0: 6f5f 7265 7363 616c 6520 6973 206e 6f74  o_rescale is not
+000031f0: 204e 6f6e 6520 656c 7365 2073 656c 662e   None else self.
+00003200: 646f 5f72 6573 6361 6c65 0a20 2020 2020  do_rescale.     
+00003210: 2020 2072 6573 6361 6c65 5f66 6163 746f     rescale_facto
+00003220: 7220 3d20 7265 7363 616c 655f 6661 6374  r = rescale_fact
+00003230: 6f72 2069 6620 7265 7363 616c 655f 6661  or if rescale_fa
+00003240: 6374 6f72 2069 7320 6e6f 7420 4e6f 6e65  ctor is not None
+00003250: 2065 6c73 6520 7365 6c66 2e72 6573 6361   else self.resca
+00003260: 6c65 5f66 6163 746f 720a 2020 2020 2020  le_factor.      
+00003270: 2020 646f 5f6e 6f72 6d61 6c69 7a65 203d    do_normalize =
+00003280: 2064 6f5f 6e6f 726d 616c 697a 6520 6966   do_normalize if
+00003290: 2064 6f5f 6e6f 726d 616c 697a 6520 6973   do_normalize is
+000032a0: 206e 6f74 204e 6f6e 6520 656c 7365 2073   not None else s
+000032b0: 656c 662e 646f 5f6e 6f72 6d61 6c69 7a65  elf.do_normalize
+000032c0: 0a20 2020 2020 2020 2069 6d61 6765 5f6d  .        image_m
+000032d0: 6561 6e20 3d20 696d 6167 655f 6d65 616e  ean = image_mean
+000032e0: 2069 6620 696d 6167 655f 6d65 616e 2069   if image_mean i
+000032f0: 7320 6e6f 7420 4e6f 6e65 2065 6c73 6520  s not None else 
+00003300: 7365 6c66 2e69 6d61 6765 5f6d 6561 6e0a  self.image_mean.
+00003310: 2020 2020 2020 2020 696d 6167 655f 7374          image_st
+00003320: 6420 3d20 696d 6167 655f 7374 6420 6966  d = image_std if
+00003330: 2069 6d61 6765 5f73 7464 2069 7320 6e6f   image_std is no
+00003340: 7420 4e6f 6e65 2065 6c73 6520 7365 6c66  t None else self
+00003350: 2e69 6d61 6765 5f73 7464 0a20 2020 2020  .image_std.     
+00003360: 2020 2064 6f5f 636f 6e76 6572 745f 7267     do_convert_rg
+00003370: 6220 3d20 646f 5f63 6f6e 7665 7274 5f72  b = do_convert_r
+00003380: 6762 2069 6620 646f 5f63 6f6e 7665 7274  gb if do_convert
+00003390: 5f72 6762 2069 7320 6e6f 7420 4e6f 6e65  _rgb is not None
+000033a0: 2065 6c73 6520 7365 6c66 2e64 6f5f 636f   else self.do_co
+000033b0: 6e76 6572 745f 7267 620a 0a20 2020 2020  nvert_rgb..     
+000033c0: 2020 2073 697a 6520 3d20 7369 7a65 2069     size = size i
+000033d0: 6620 7369 7a65 2069 7320 6e6f 7420 4e6f  f size is not No
+000033e0: 6e65 2065 6c73 6520 7365 6c66 2e73 697a  ne else self.siz
+000033f0: 650a 2020 2020 2020 2020 7369 7a65 203d  e.        size =
+00003400: 2067 6574 5f73 697a 655f 6469 6374 2873   get_size_dict(s
+00003410: 697a 652c 2064 6566 6175 6c74 5f74 6f5f  ize, default_to_
+00003420: 7371 7561 7265 3d46 616c 7365 290a 0a20  square=False).. 
+00003430: 2020 2020 2020 2069 6d61 6765 7320 3d20         images = 
+00003440: 6d61 6b65 5f6c 6973 745f 6f66 5f69 6d61  make_list_of_ima
+00003450: 6765 7328 696d 6167 6573 290a 0a20 2020  ges(images)..   
+00003460: 2020 2020 2076 616c 6964 6174 655f 6b77       validate_kw
+00003470: 6172 6773 2863 6170 7475 7265 645f 6b77  args(captured_kw
+00003480: 6172 6773 3d6b 7761 7267 732e 6b65 7973  args=kwargs.keys
+00003490: 2829 2c20 7661 6c69 645f 7072 6f63 6573  (), valid_proces
+000034a0: 736f 725f 6b65 7973 3d73 656c 662e 5f76  sor_keys=self._v
+000034b0: 616c 6964 5f70 726f 6365 7373 6f72 5f6b  alid_processor_k
+000034c0: 6579 7329 0a0a 2020 2020 2020 2020 6966  eys)..        if
+000034d0: 206e 6f74 2076 616c 6964 5f69 6d61 6765   not valid_image
+000034e0: 7328 696d 6167 6573 293a 0a20 2020 2020  s(images):.     
+000034f0: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+00003500: 7565 4572 726f 7228 0a20 2020 2020 2020  ueError(.       
+00003510: 2020 2020 2020 2020 2022 496e 7661 6c69           "Invali
+00003520: 6420 696d 6167 6520 7479 7065 2e20 4d75  d image type. Mu
+00003530: 7374 2062 6520 6f66 2074 7970 6520 5049  st be of type PI
+00003540: 4c2e 496d 6167 652e 496d 6167 652c 206e  L.Image.Image, n
+00003550: 756d 7079 2e6e 6461 7272 6179 2c20 220a  umpy.ndarray, ".
+00003560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003570: 2274 6f72 6368 2e54 656e 736f 722c 2074  "torch.Tensor, t
+00003580: 662e 5465 6e73 6f72 206f 7220 6a61 782e  f.Tensor or jax.
+00003590: 6e64 6172 7261 792e 220a 2020 2020 2020  ndarray.".      
+000035a0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+000035b0: 2076 616c 6964 6174 655f 7072 6570 726f   validate_prepro
+000035c0: 6365 7373 5f61 7267 756d 656e 7473 280a  cess_arguments(.
+000035d0: 2020 2020 2020 2020 2020 2020 646f 5f72              do_r
+000035e0: 6573 6361 6c65 3d64 6f5f 7265 7363 616c  escale=do_rescal
+000035f0: 652c 0a20 2020 2020 2020 2020 2020 2072  e,.            r
+00003600: 6573 6361 6c65 5f66 6163 746f 723d 7265  escale_factor=re
+00003610: 7363 616c 655f 6661 6374 6f72 2c0a 2020  scale_factor,.  
+00003620: 2020 2020 2020 2020 2020 646f 5f6e 6f72            do_nor
+00003630: 6d61 6c69 7a65 3d64 6f5f 6e6f 726d 616c  malize=do_normal
+00003640: 697a 652c 0a20 2020 2020 2020 2020 2020  ize,.           
+00003650: 2069 6d61 6765 5f6d 6561 6e3d 696d 6167   image_mean=imag
+00003660: 655f 6d65 616e 2c0a 2020 2020 2020 2020  e_mean,.        
+00003670: 2020 2020 696d 6167 655f 7374 643d 696d      image_std=im
+00003680: 6167 655f 7374 642c 0a20 2020 2020 2020  age_std,.       
+00003690: 2020 2020 2064 6f5f 7265 7369 7a65 3d64       do_resize=d
+000036a0: 6f5f 7265 7369 7a65 2c0a 2020 2020 2020  o_resize,.      
+000036b0: 2020 2020 2020 7369 7a65 3d73 697a 652c        size=size,
+000036c0: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+000036d0: 616d 706c 653d 7265 7361 6d70 6c65 2c0a  ample=resample,.
+000036e0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000036f0: 2020 2320 5049 4c20 5247 4241 2069 6d61    # PIL RGBA ima
+00003700: 6765 7320 6172 6520 636f 6e76 6572 7465  ges are converte
+00003710: 6420 746f 2052 4742 0a20 2020 2020 2020  d to RGB.       
+00003720: 2069 6620 646f 5f63 6f6e 7665 7274 5f72   if do_convert_r
+00003730: 6762 3a0a 2020 2020 2020 2020 2020 2020  gb:.            
+00003740: 696d 6167 6573 203d 205b 636f 6e76 6572  images = [conver
+00003750: 745f 746f 5f72 6762 2869 6d61 6765 2920  t_to_rgb(image) 
+00003760: 666f 7220 696d 6167 6520 696e 2069 6d61  for image in ima
+00003770: 6765 735d 0a0a 2020 2020 2020 2020 2320  ges]..        # 
+00003780: 416c 6c20 7472 616e 7366 6f72 6d61 7469  All transformati
+00003790: 6f6e 7320 6578 7065 6374 206e 756d 7079  ons expect numpy
+000037a0: 2061 7272 6179 732e 0a20 2020 2020 2020   arrays..       
+000037b0: 2069 6d61 6765 7320 3d20 5b74 6f5f 6e75   images = [to_nu
+000037c0: 6d70 795f 6172 7261 7928 696d 6167 6529  mpy_array(image)
+000037d0: 2066 6f72 2069 6d61 6765 2069 6e20 696d   for image in im
+000037e0: 6167 6573 5d0a 0a20 2020 2020 2020 2069  ages]..        i
+000037f0: 6620 6973 5f73 6361 6c65 645f 696d 6167  f is_scaled_imag
+00003800: 6528 696d 6167 6573 5b30 5d29 2061 6e64  e(images[0]) and
+00003810: 2064 6f5f 7265 7363 616c 653a 0a20 2020   do_rescale:.   
+00003820: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+00003830: 7761 726e 696e 675f 6f6e 6365 280a 2020  warning_once(.  
+00003840: 2020 2020 2020 2020 2020 2020 2020 2249                "I
+00003850: 7420 6c6f 6f6b 7320 6c69 6b65 2079 6f75  t looks like you
+00003860: 2061 7265 2074 7279 696e 6720 746f 2072   are trying to r
+00003870: 6573 6361 6c65 2061 6c72 6561 6479 2072  escale already r
+00003880: 6573 6361 6c65 6420 696d 6167 6573 2e20  escaled images. 
+00003890: 4966 2074 6865 2069 6e70 7574 220a 2020  If the input".  
+000038a0: 2020 2020 2020 2020 2020 2020 2020 2220                " 
+000038b0: 696d 6167 6573 2068 6176 6520 7069 7865  images have pixe
+000038c0: 6c20 7661 6c75 6573 2062 6574 7765 656e  l values between
+000038d0: 2030 2061 6e64 2031 2c20 7365 7420 6064   0 and 1, set `d
+000038e0: 6f5f 7265 7363 616c 653d 4661 6c73 6560  o_rescale=False`
+000038f0: 2074 6f20 6176 6f69 6420 7265 7363 616c   to avoid rescal
+00003900: 696e 6720 7468 656d 2061 6761 696e 2e22  ing them again."
+00003910: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+00003920: 2020 2020 2020 2020 6966 2069 6e70 7574          if input
+00003930: 5f64 6174 615f 666f 726d 6174 2069 7320  _data_format is 
+00003940: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00003950: 2020 2320 5765 2061 7373 756d 6520 7468    # We assume th
+00003960: 6174 2061 6c6c 2069 6d61 6765 7320 6861  at all images ha
+00003970: 7665 2074 6865 2073 616d 6520 6368 616e  ve the same chan
+00003980: 6e65 6c20 6469 6d65 6e73 696f 6e20 666f  nel dimension fo
+00003990: 726d 6174 2e0a 2020 2020 2020 2020 2020  rmat..          
+000039a0: 2020 696e 7075 745f 6461 7461 5f66 6f72    input_data_for
+000039b0: 6d61 7420 3d20 696e 6665 725f 6368 616e  mat = infer_chan
+000039c0: 6e65 6c5f 6469 6d65 6e73 696f 6e5f 666f  nel_dimension_fo
+000039d0: 726d 6174 2869 6d61 6765 735b 305d 290a  rmat(images[0]).
+000039e0: 0a20 2020 2020 2020 2069 6620 646f 5f72  .        if do_r
+000039f0: 6573 697a 653a 0a20 2020 2020 2020 2020  esize:.         
+00003a00: 2020 2069 6d61 6765 7320 3d20 5b0a 2020     images = [.  
+00003a10: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00003a20: 6c66 2e72 6573 697a 6528 696d 6167 653d  lf.resize(image=
+00003a30: 696d 6167 652c 2073 697a 653d 7369 7a65  image, size=size
+00003a40: 2c20 7265 7361 6d70 6c65 3d72 6573 616d  , resample=resam
+00003a50: 706c 652c 2069 6e70 7574 5f64 6174 615f  ple, input_data_
+00003a60: 666f 726d 6174 3d69 6e70 7574 5f64 6174  format=input_dat
+00003a70: 615f 666f 726d 6174 290a 2020 2020 2020  a_format).      
+00003a80: 2020 2020 2020 2020 2020 666f 7220 696d            for im
+00003a90: 6167 6520 696e 2069 6d61 6765 730a 2020  age in images.  
+00003aa0: 2020 2020 2020 2020 2020 5d0a 0a20 2020            ]..   
+00003ab0: 2020 2020 2069 6620 646f 5f72 6573 6361       if do_resca
+00003ac0: 6c65 3a0a 2020 2020 2020 2020 2020 2020  le:.            
+00003ad0: 696d 6167 6573 203d 205b 0a20 2020 2020  images = [.     
+00003ae0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00003af0: 7265 7363 616c 6528 696d 6167 653d 696d  rescale(image=im
+00003b00: 6167 652c 2073 6361 6c65 3d72 6573 6361  age, scale=resca
+00003b10: 6c65 5f66 6163 746f 722c 2069 6e70 7574  le_factor, input
+00003b20: 5f64 6174 615f 666f 726d 6174 3d69 6e70  _data_format=inp
+00003b30: 7574 5f64 6174 615f 666f 726d 6174 290a  ut_data_format).
+00003b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003b50: 666f 7220 696d 6167 6520 696e 2069 6d61  for image in ima
+00003b60: 6765 730a 2020 2020 2020 2020 2020 2020  ges.            
+00003b70: 5d0a 0a20 2020 2020 2020 2069 6620 646f  ]..        if do
+00003b80: 5f6e 6f72 6d61 6c69 7a65 3a0a 2020 2020  _normalize:.    
+00003b90: 2020 2020 2020 2020 696d 6167 6573 203d          images =
+00003ba0: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
+00003bb0: 2020 2073 656c 662e 6e6f 726d 616c 697a     self.normaliz
+00003bc0: 6528 696d 6167 653d 696d 6167 652c 206d  e(image=image, m
+00003bd0: 6561 6e3d 696d 6167 655f 6d65 616e 2c20  ean=image_mean, 
+00003be0: 7374 643d 696d 6167 655f 7374 642c 2069  std=image_std, i
+00003bf0: 6e70 7574 5f64 6174 615f 666f 726d 6174  nput_data_format
+00003c00: 3d69 6e70 7574 5f64 6174 615f 666f 726d  =input_data_form
+00003c10: 6174 290a 2020 2020 2020 2020 2020 2020  at).            
+00003c20: 2020 2020 666f 7220 696d 6167 6520 696e      for image in
+00003c30: 2069 6d61 6765 730a 2020 2020 2020 2020   images.        
+00003c40: 2020 2020 5d0a 0a20 2020 2020 2020 2069      ]..        i
+00003c50: 6d61 6765 7320 3d20 5b0a 2020 2020 2020  mages = [.      
+00003c60: 2020 2020 2020 746f 5f63 6861 6e6e 656c        to_channel
+00003c70: 5f64 696d 656e 7369 6f6e 5f66 6f72 6d61  _dimension_forma
+00003c80: 7428 696d 6167 652c 2064 6174 615f 666f  t(image, data_fo
+00003c90: 726d 6174 2c20 696e 7075 745f 6368 616e  rmat, input_chan
+00003ca0: 6e65 6c5f 6469 6d3d 696e 7075 745f 6461  nel_dim=input_da
+00003cb0: 7461 5f66 6f72 6d61 7429 2066 6f72 2069  ta_format) for i
+00003cc0: 6d61 6765 2069 6e20 696d 6167 6573 0a20  mage in images. 
+00003cd0: 2020 2020 2020 205d 0a0a 2020 2020 2020         ]..      
+00003ce0: 2020 656e 636f 6465 645f 6f75 7470 7574    encoded_output
+00003cf0: 7320 3d20 4261 7463 6846 6561 7475 7265  s = BatchFeature
+00003d00: 2864 6174 613d 7b22 7069 7865 6c5f 7661  (data={"pixel_va
+00003d10: 6c75 6573 223a 2069 6d61 6765 737d 2c20  lues": images}, 
+00003d20: 7465 6e73 6f72 5f74 7970 653d 7265 7475  tensor_type=retu
+00003d30: 726e 5f74 656e 736f 7273 290a 0a20 2020  rn_tensors)..   
+00003d40: 2020 2020 2072 6574 7572 6e20 656e 636f       return enco
+00003d50: 6465 645f 6f75 7470 7574 730a 0a5f 5f61  ded_outputs..__a
+00003d60: 6c6c 5f5f 203d 205b 2742 6c69 7049 6d61  ll__ = ['BlipIma
+00003d70: 6765 5072 6f63 6573 736f 7227 5d0a       geProcessor'].
```

## mindnlp/transformers/models/blip/modeling_blip.py

```diff
@@ -0,0 +1,3362 @@
+00000000: 2320 636f 6469 6e67 3d75 7466 2d38 0a23  # coding=utf-8.#
+00000010: 2043 6f70 7972 6967 6874 2032 3032 3220   Copyright 2022 
+00000020: 5468 6520 5361 6c65 7366 6f72 6365 2054  The Salesforce T
+00000030: 6561 6d20 4175 7468 6f72 7320 616e 6420  eam Authors and 
+00000040: 5468 6520 4875 6767 696e 6746 6163 6520  The HuggingFace 
+00000050: 5465 616d 2e20 416c 6c20 7269 6768 7473  Team. All rights
+00000060: 2072 6573 6572 7665 642e 0a23 0a23 204c   reserved..#.# L
+00000070: 6963 656e 7365 6420 756e 6465 7220 7468  icensed under th
+00000080: 6520 4170 6163 6865 204c 6963 656e 7365  e Apache License
+00000090: 2c20 5665 7273 696f 6e20 322e 3020 2874  , Version 2.0 (t
+000000a0: 6865 2022 4c69 6365 6e73 6522 293b 0a23  he "License");.#
+000000b0: 2079 6f75 206d 6179 206e 6f74 2075 7365   you may not use
+000000c0: 2074 6869 7320 6669 6c65 2065 7863 6570   this file excep
+000000d0: 7420 696e 2063 6f6d 706c 6961 6e63 6520  t in compliance 
+000000e0: 7769 7468 2074 6865 204c 6963 656e 7365  with the License
+000000f0: 2e0a 2320 596f 7520 6d61 7920 6f62 7461  ..# You may obta
+00000100: 696e 2061 2063 6f70 7920 6f66 2074 6865  in a copy of the
+00000110: 204c 6963 656e 7365 2061 740a 230a 2320   License at.#.# 
+00000120: 2020 2020 6874 7470 3a2f 2f77 7777 2e61      http://www.a
+00000130: 7061 6368 652e 6f72 672f 6c69 6365 6e73  pache.org/licens
+00000140: 6573 2f4c 4943 454e 5345 2d32 2e30 0a23  es/LICENSE-2.0.#
+00000150: 0a23 2055 6e6c 6573 7320 7265 7175 6972  .# Unless requir
+00000160: 6564 2062 7920 6170 706c 6963 6162 6c65  ed by applicable
+00000170: 206c 6177 206f 7220 6167 7265 6564 2074   law or agreed t
+00000180: 6f20 696e 2077 7269 7469 6e67 2c20 736f  o in writing, so
+00000190: 6674 7761 7265 0a23 2064 6973 7472 6962  ftware.# distrib
+000001a0: 7574 6564 2075 6e64 6572 2074 6865 204c  uted under the L
+000001b0: 6963 656e 7365 2069 7320 6469 7374 7269  icense is distri
+000001c0: 6275 7465 6420 6f6e 2061 6e20 2241 5320  buted on an "AS 
+000001d0: 4953 2220 4241 5349 532c 0a23 2057 4954  IS" BASIS,.# WIT
+000001e0: 484f 5554 2057 4152 5241 4e54 4945 5320  HOUT WARRANTIES 
+000001f0: 4f52 2043 4f4e 4449 5449 4f4e 5320 4f46  OR CONDITIONS OF
+00000200: 2041 4e59 204b 494e 442c 2065 6974 6865   ANY KIND, eithe
+00000210: 7220 6578 7072 6573 7320 6f72 2069 6d70  r express or imp
+00000220: 6c69 6564 2e0a 2320 5365 6520 7468 6520  lied..# See the 
+00000230: 4c69 6365 6e73 6520 666f 7220 7468 6520  License for the 
+00000240: 7370 6563 6966 6963 206c 616e 6775 6167  specific languag
+00000250: 6520 676f 7665 726e 696e 6720 7065 726d  e governing perm
+00000260: 6973 7369 6f6e 7320 616e 640a 2320 6c69  issions and.# li
+00000270: 6d69 7461 7469 6f6e 7320 756e 6465 7220  mitations under 
+00000280: 7468 6520 4c69 6365 6e73 652e 0a22 2222  the License.."""
+00000290: 204d 696e 6453 706f 7265 2042 4c49 5020   MindSpore BLIP 
+000002a0: 6d6f 6465 6c2e 2222 220a 0a69 6d70 6f72  model."""..impor
+000002b0: 7420 7761 726e 696e 6773 0a66 726f 6d20  t warnings.from 
+000002c0: 6461 7461 636c 6173 7365 7320 696d 706f  dataclasses impo
+000002d0: 7274 2064 6174 6163 6c61 7373 0a66 726f  rt dataclass.fro
+000002e0: 6d20 7479 7069 6e67 2069 6d70 6f72 7420  m typing import 
+000002f0: 416e 792c 204f 7074 696f 6e61 6c2c 2054  Any, Optional, T
+00000300: 7570 6c65 2c20 556e 696f 6e0a 0a69 6d70  uple, Union..imp
+00000310: 6f72 7420 6d69 6e64 7370 6f72 650a 6672  ort mindspore.fr
+00000320: 6f6d 206d 696e 6473 706f 7265 2069 6d70  om mindspore imp
+00000330: 6f72 7420 6e6e 2c20 6f70 732c 2050 6172  ort nn, ops, Par
+00000340: 616d 6574 6572 0a66 726f 6d20 6d69 6e64  ameter.from mind
+00000350: 7370 6f72 652e 636f 6d6d 6f6e 2e69 6e69  spore.common.ini
+00000360: 7469 616c 697a 6572 2069 6d70 6f72 7420  tializer import 
+00000370: 696e 6974 6961 6c69 7a65 722c 204e 6f72  initializer, Nor
+00000380: 6d61 6c2c 2054 7275 6e63 6174 6564 4e6f  mal, TruncatedNo
+00000390: 726d 616c 0a0a 6672 6f6d 202e 2e2e 6163  rmal..from ...ac
+000003a0: 7469 7661 7469 6f6e 7320 696d 706f 7274  tivations import
+000003b0: 2041 4354 3246 4e0a 6672 6f6d 202e 2e2e   ACT2FN.from ...
+000003c0: 6d6f 6465 6c69 6e67 5f6f 7574 7075 7473  modeling_outputs
+000003d0: 2069 6d70 6f72 7420 4261 7365 4d6f 6465   import BaseMode
+000003e0: 6c4f 7574 7075 742c 2042 6173 654d 6f64  lOutput, BaseMod
+000003f0: 656c 4f75 7470 7574 5769 7468 506f 6f6c  elOutputWithPool
+00000400: 696e 670a 6672 6f6d 202e 2e2e 6d6f 6465  ing.from ...mode
+00000410: 6c69 6e67 5f75 7469 6c73 2069 6d70 6f72  ling_utils impor
+00000420: 7420 5072 6554 7261 696e 6564 4d6f 6465  t PreTrainedMode
+00000430: 6c0a 6672 6f6d 202e 2e2e 2e75 7469 6c73  l.from ....utils
+00000440: 2069 6d70 6f72 7420 280a 2020 2020 4d6f   import (.    Mo
+00000450: 6465 6c4f 7574 7075 742c 0a20 2020 206c  delOutput,.    l
+00000460: 6f67 6769 6e67 2c0a 290a 6672 6f6d 202e  ogging,.).from .
+00000470: 636f 6e66 6967 7572 6174 696f 6e5f 626c  configuration_bl
+00000480: 6970 2069 6d70 6f72 7420 426c 6970 436f  ip import BlipCo
+00000490: 6e66 6967 2c20 426c 6970 5465 7874 436f  nfig, BlipTextCo
+000004a0: 6e66 6967 2c20 426c 6970 5669 7369 6f6e  nfig, BlipVision
+000004b0: 436f 6e66 6967 0a66 726f 6d20 2e6d 6f64  Config.from .mod
+000004c0: 656c 696e 675f 626c 6970 5f74 6578 7420  eling_blip_text 
+000004d0: 696d 706f 7274 2042 6c69 7054 6578 744c  import BlipTextL
+000004e0: 4d48 6561 644d 6f64 656c 2c20 426c 6970  MHeadModel, Blip
+000004f0: 5465 7874 4d6f 6465 6c0a 0a0a 6c6f 6767  TextModel...logg
+00000500: 6572 203d 206c 6f67 6769 6e67 2e67 6574  er = logging.get
+00000510: 5f6c 6f67 6765 7228 5f5f 6e61 6d65 5f5f  _logger(__name__
+00000520: 290a 0a5f 4348 4543 4b50 4f49 4e54 5f46  ).._CHECKPOINT_F
+00000530: 4f52 5f44 4f43 203d 2022 5361 6c65 7366  OR_DOC = "Salesf
+00000540: 6f72 6365 2f62 6c69 702d 7671 612d 6261  orce/blip-vqa-ba
+00000550: 7365 220a 0a64 6566 206e 6f72 6d61 6c69  se"..def normali
+00000560: 7a65 2869 6e70 7574 2c20 703d 322e 302c  ze(input, p=2.0,
+00000570: 2064 696d 3d31 293a 0a20 2020 2072 6574   dim=1):.    ret
+00000580: 7572 6e20 696e 7075 7420 2f20 6f70 732e  urn input / ops.
+00000590: 6e6f 726d 2869 6e70 7574 2c20 6f72 643d  norm(input, ord=
+000005a0: 702c 2064 696d 3d64 696d 2c20 6b65 6570  p, dim=dim, keep
+000005b0: 6469 6d3d 5472 7565 290a 0a0a 2320 436f  dim=True)...# Co
+000005c0: 7069 6564 2066 726f 6d20 7472 616e 7366  pied from transf
+000005d0: 6f72 6d65 7273 2e6d 6f64 656c 732e 636c  ormers.models.cl
+000005e0: 6970 2e6d 6f64 656c 696e 675f 636c 6970  ip.modeling_clip
+000005f0: 2e63 6f6e 7472 6173 7469 7665 5f6c 6f73  .contrastive_los
+00000600: 730a 6465 6620 636f 6e74 7261 7374 6976  s.def contrastiv
+00000610: 655f 6c6f 7373 286c 6f67 6974 733a 206d  e_loss(logits: m
+00000620: 696e 6473 706f 7265 2e54 656e 736f 7229  indspore.Tensor)
+00000630: 202d 3e20 6d69 6e64 7370 6f72 652e 5465   -> mindspore.Te
+00000640: 6e73 6f72 3a0a 2020 2020 7265 7475 726e  nsor:.    return
+00000650: 206f 7073 2e63 726f 7373 5f65 6e74 726f   ops.cross_entro
+00000660: 7079 286c 6f67 6974 732c 206f 7073 2e61  py(logits, ops.a
+00000670: 7261 6e67 6528 6c65 6e28 6c6f 6769 7473  range(len(logits
+00000680: 2929 290a 0a0a 2320 436f 7069 6564 2066  )))...# Copied f
+00000690: 726f 6d20 7472 616e 7366 6f72 6d65 7273  rom transformers
+000006a0: 2e6d 6f64 656c 732e 636c 6970 2e6d 6f64  .models.clip.mod
+000006b0: 656c 696e 675f 636c 6970 2e63 6c69 705f  eling_clip.clip_
+000006c0: 6c6f 7373 2077 6974 6820 636c 6970 2d3e  loss with clip->
+000006d0: 626c 6970 0a64 6566 2062 6c69 705f 6c6f  blip.def blip_lo
+000006e0: 7373 2873 696d 696c 6172 6974 793a 206d  ss(similarity: m
+000006f0: 696e 6473 706f 7265 2e54 656e 736f 7229  indspore.Tensor)
+00000700: 202d 3e20 6d69 6e64 7370 6f72 652e 5465   -> mindspore.Te
+00000710: 6e73 6f72 3a0a 2020 2020 6361 7074 696f  nsor:.    captio
+00000720: 6e5f 6c6f 7373 203d 2063 6f6e 7472 6173  n_loss = contras
+00000730: 7469 7665 5f6c 6f73 7328 7369 6d69 6c61  tive_loss(simila
+00000740: 7269 7479 290a 2020 2020 696d 6167 655f  rity).    image_
+00000750: 6c6f 7373 203d 2063 6f6e 7472 6173 7469  loss = contrasti
+00000760: 7665 5f6c 6f73 7328 7369 6d69 6c61 7269  ve_loss(similari
+00000770: 7479 2e74 2829 290a 2020 2020 7265 7475  ty.t()).    retu
+00000780: 726e 2028 6361 7074 696f 6e5f 6c6f 7373  rn (caption_loss
+00000790: 202b 2069 6d61 6765 5f6c 6f73 7329 202f   + image_loss) /
+000007a0: 2032 2e30 0a0a 0a40 6461 7461 636c 6173   2.0...@dataclas
+000007b0: 730a 636c 6173 7320 426c 6970 466f 7243  s.class BlipForC
+000007c0: 6f6e 6469 7469 6f6e 616c 4765 6e65 7261  onditionalGenera
+000007d0: 7469 6f6e 4d6f 6465 6c4f 7574 7075 7428  tionModelOutput(
+000007e0: 4d6f 6465 6c4f 7574 7075 7429 3a0a 2020  ModelOutput):.  
+000007f0: 2020 2222 220a 2020 2020 4164 6170 7465    """.    Adapte
+00000800: 6420 6672 6f6d 2074 6865 2062 6173 6520  d from the base 
+00000810: 636c 6173 7320 666f 7220 7669 7369 6f6e  class for vision
+00000820: 206d 6f64 656c 2773 206f 7574 7075 7473   model's outputs
+00000830: 2074 6861 7420 616c 736f 2063 6f6e 7461   that also conta
+00000840: 696e 7320 696d 6167 6520 656d 6265 6464  ins image embedd
+00000850: 696e 6773 206f 6620 7468 6520 706f 6f6c  ings of the pool
+00000860: 696e 6720 6f66 2074 6865 0a20 2020 206c  ing of the.    l
+00000870: 6173 7420 6869 6464 656e 2073 7461 7465  ast hidden state
+00000880: 732e 2054 6869 7320 636c 6173 7320 616c  s. This class al
+00000890: 736f 2061 6464 7320 7468 6520 6c6f 7373  so adds the loss
+000008a0: 2074 6572 6d20 6672 6f6d 2074 6865 2074   term from the t
+000008b0: 6578 7420 6465 636f 6465 722e 0a0a 2020  ext decoder...  
+000008c0: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+000008d0: 6c6f 7373 2028 606d 696e 6473 706f 7265  loss (`mindspore
+000008e0: 2e54 656e 736f 7260 2c20 2a6f 7074 696f  .Tensor`, *optio
+000008f0: 6e61 6c2a 2c20 7265 7475 726e 6564 2077  nal*, returned w
+00000900: 6865 6e20 606c 6162 656c 7360 2069 7320  hen `labels` is 
+00000910: 7072 6f76 6964 6564 2c20 606d 696e 6473  provided, `minds
+00000920: 706f 7265 2e54 656e 736f 7260 206f 6620  pore.Tensor` of 
+00000930: 7368 6170 6520 6028 312c 2960 293a 0a20  shape `(1,)`):. 
+00000940: 2020 2020 2020 2020 2020 204c 616e 6775             Langu
+00000950: 6765 206d 6f64 656c 696e 6720 6c6f 7373  ge modeling loss
+00000960: 2066 726f 6d20 7468 6520 7465 7874 2064   from the text d
+00000970: 6563 6f64 6572 2e0a 2020 2020 2020 2020  ecoder..        
+00000980: 6c6f 6769 7473 2028 606d 696e 6473 706f  logits (`mindspo
+00000990: 7265 2e54 656e 736f 7260 206f 6620 7368  re.Tensor` of sh
+000009a0: 6170 6520 6028 6261 7463 685f 7369 7a65  ape `(batch_size
+000009b0: 2c20 7365 7175 656e 6365 5f6c 656e 6774  , sequence_lengt
+000009c0: 682c 2063 6f6e 6669 672e 766f 6361 625f  h, config.vocab_
+000009d0: 7369 7a65 2960 2c20 2a6f 7074 696f 6e61  size)`, *optiona
+000009e0: 6c2a 293a 0a20 2020 2020 2020 2020 2020  l*):.           
+000009f0: 2050 7265 6469 6374 696f 6e20 7363 6f72   Prediction scor
+00000a00: 6573 206f 6620 7468 6520 6c61 6e67 7561  es of the langua
+00000a10: 6765 206d 6f64 656c 696e 6720 6865 6164  ge modeling head
+00000a20: 206f 6620 7468 6520 7465 7874 2064 6563   of the text dec
+00000a30: 6f64 6572 206d 6f64 656c 2e0a 2020 2020  oder model..    
+00000a40: 2020 2020 696d 6167 655f 656d 6265 6473      image_embeds
+00000a50: 2028 606d 696e 6473 706f 7265 2e54 656e   (`mindspore.Ten
+00000a60: 736f 7260 206f 6620 7368 6170 6520 6028  sor` of shape `(
+00000a70: 6261 7463 685f 7369 7a65 2c20 6f75 7470  batch_size, outp
+00000a80: 7574 5f64 696d 2960 2c20 2a6f 7074 696f  ut_dim)`, *optio
+00000a90: 6e61 6c2a 293a 0a20 2020 2020 2020 2020  nal*):.         
+00000aa0: 2020 2054 6865 2069 6d61 6765 2065 6d62     The image emb
+00000ab0: 6564 6469 6e67 7320 6f62 7461 696e 6564  eddings obtained
+00000ac0: 2061 6674 6572 2061 7070 6c79 696e 6720   after applying 
+00000ad0: 7468 6520 5669 7369 6f6e 2054 7261 6e73  the Vision Trans
+00000ae0: 666f 726d 6572 206d 6f64 656c 2074 6f20  former model to 
+00000af0: 7468 6520 696e 7075 7420 696d 6167 652e  the input image.
+00000b00: 0a20 2020 2020 2020 206c 6173 745f 6869  .        last_hi
+00000b10: 6464 656e 5f73 7461 7465 2028 606d 696e  dden_state (`min
+00000b20: 6473 706f 7265 2e54 656e 736f 7260 206f  dspore.Tensor` o
+00000b30: 6620 7368 6170 6520 6028 6261 7463 685f  f shape `(batch_
+00000b40: 7369 7a65 2c20 7365 7175 656e 6365 5f6c  size, sequence_l
+00000b50: 656e 6774 682c 2068 6964 6465 6e5f 7369  ength, hidden_si
+00000b60: 7a65 2960 2c20 2a6f 7074 696f 6e61 6c2a  ze)`, *optional*
+00000b70: 293a 0a20 2020 2020 2020 2020 2020 2053  ):.            S
+00000b80: 6571 7565 6e63 6520 6f66 2068 6964 6465  equence of hidde
+00000b90: 6e2d 7374 6174 6573 2061 7420 7468 6520  n-states at the 
+00000ba0: 6f75 7470 7574 206f 6620 7468 6520 6c61  output of the la
+00000bb0: 7374 206c 6179 6572 206f 6620 7468 6520  st layer of the 
+00000bc0: 6d6f 6465 6c2e 0a20 2020 2020 2020 2068  model..        h
+00000bd0: 6964 6465 6e5f 7374 6174 6573 2028 6074  idden_states (`t
+00000be0: 7570 6c65 286d 696e 6473 706f 7265 2e54  uple(mindspore.T
+00000bf0: 656e 736f 7229 602c 202a 6f70 7469 6f6e  ensor)`, *option
+00000c00: 616c 2a2c 2072 6574 7572 6e65 6420 7768  al*, returned wh
+00000c10: 656e 2060 6f75 7470 7574 5f68 6964 6465  en `output_hidde
+00000c20: 6e5f 7374 6174 6573 3d54 7275 6560 293a  n_states=True`):
+00000c30: 0a20 2020 2020 2020 2020 2020 2054 7570  .            Tup
+00000c40: 6c65 206f 6620 606d 696e 6473 706f 7265  le of `mindspore
+00000c50: 2e54 656e 736f 7260 2028 6f6e 6520 666f  .Tensor` (one fo
+00000c60: 7220 7468 6520 6f75 7470 7574 206f 6620  r the output of 
+00000c70: 7468 6520 656d 6265 6464 696e 6773 2c20  the embeddings, 
+00000c80: 6966 2074 6865 206d 6f64 656c 2068 6173  if the model has
+00000c90: 2061 6e20 656d 6265 6464 696e 6720 6c61   an embedding la
+00000ca0: 7965 722c 202b 0a20 2020 2020 2020 2020  yer, +.         
+00000cb0: 2020 206f 6e65 2066 6f72 2074 6865 206f     one for the o
+00000cc0: 7574 7075 7420 6f66 2065 6163 6820 6c61  utput of each la
+00000cd0: 7965 7229 206f 6620 7368 6170 6520 6028  yer) of shape `(
+00000ce0: 6261 7463 685f 7369 7a65 2c20 7365 7175  batch_size, sequ
+00000cf0: 656e 6365 5f6c 656e 6774 682c 2068 6964  ence_length, hid
+00000d00: 6465 6e5f 7369 7a65 2960 2e0a 0a20 2020  den_size)`...   
+00000d10: 2020 2020 2020 2020 2048 6964 6465 6e2d           Hidden-
+00000d20: 7374 6174 6573 206f 6620 7468 6520 6d6f  states of the mo
+00000d30: 6465 6c20 6174 2074 6865 206f 7574 7075  del at the outpu
+00000d40: 7420 6f66 2065 6163 6820 6c61 7965 7220  t of each layer 
+00000d50: 706c 7573 2074 6865 206f 7074 696f 6e61  plus the optiona
+00000d60: 6c20 696e 6974 6961 6c20 656d 6265 6464  l initial embedd
+00000d70: 696e 6720 6f75 7470 7574 732e 0a20 2020  ing outputs..   
+00000d80: 2020 2020 2061 7474 656e 7469 6f6e 7320       attentions 
+00000d90: 2860 7475 706c 6528 6d69 6e64 7370 6f72  (`tuple(mindspor
+00000da0: 652e 5465 6e73 6f72 2960 2c20 2a6f 7074  e.Tensor)`, *opt
+00000db0: 696f 6e61 6c2a 2c20 7265 7475 726e 6564  ional*, returned
+00000dc0: 2077 6865 6e20 606f 7574 7075 745f 6174   when `output_at
+00000dd0: 7465 6e74 696f 6e73 3d54 7275 6560 2069  tentions=True` i
+00000de0: 7320 7061 7373 6564 293a 0a20 2020 2020  s passed):.     
+00000df0: 2020 2020 2020 2054 7570 6c65 206f 6620         Tuple of 
+00000e00: 606d 696e 6473 706f 7265 2e54 656e 736f  `mindspore.Tenso
+00000e10: 7260 2028 6f6e 6520 666f 7220 6561 6368  r` (one for each
+00000e20: 206c 6179 6572 2920 6f66 2073 6861 7065   layer) of shape
+00000e30: 2060 2862 6174 6368 5f73 697a 652c 206e   `(batch_size, n
+00000e40: 756d 5f68 6561 6473 2c20 7365 7175 656e  um_heads, sequen
+00000e50: 6365 5f6c 656e 6774 682c 0a20 2020 2020  ce_length,.     
+00000e60: 2020 2020 2020 2073 6571 7565 6e63 655f         sequence_
+00000e70: 6c65 6e67 7468 2960 2e0a 0a20 2020 2020  length)`...     
+00000e80: 2020 2020 2020 2041 7474 656e 7469 6f6e         Attention
+00000e90: 7320 7765 6967 6874 7320 6166 7465 7220  s weights after 
+00000ea0: 7468 6520 6174 7465 6e74 696f 6e20 736f  the attention so
+00000eb0: 6674 6d61 782c 2075 7365 6420 746f 2063  ftmax, used to c
+00000ec0: 6f6d 7075 7465 2074 6865 2077 6569 6768  ompute the weigh
+00000ed0: 7465 6420 6176 6572 6167 6520 696e 2074  ted average in t
+00000ee0: 6865 2073 656c 662d 6174 7465 6e74 696f  he self-attentio
+00000ef0: 6e0a 2020 2020 2020 2020 2020 2020 6865  n.            he
+00000f00: 6164 732e 0a20 2020 2022 2222 0a0a 2020  ads..    """..  
+00000f10: 2020 6c6f 7373 3a20 4f70 7469 6f6e 616c    loss: Optional
+00000f20: 5b54 7570 6c65 5b6d 696e 6473 706f 7265  [Tuple[mindspore
+00000f30: 2e54 656e 736f 725d 5d20 3d20 4e6f 6e65  .Tensor]] = None
+00000f40: 0a20 2020 206c 6f67 6974 733a 204f 7074  .    logits: Opt
+00000f50: 696f 6e61 6c5b 5475 706c 655b 6d69 6e64  ional[Tuple[mind
+00000f60: 7370 6f72 652e 5465 6e73 6f72 5d5d 203d  spore.Tensor]] =
+00000f70: 204e 6f6e 650a 2020 2020 696d 6167 655f   None.    image_
+00000f80: 656d 6265 6473 3a20 4f70 7469 6f6e 616c  embeds: Optional
+00000f90: 5b6d 696e 6473 706f 7265 2e54 656e 736f  [mindspore.Tenso
+00000fa0: 725d 203d 204e 6f6e 650a 2020 2020 6c61  r] = None.    la
+00000fb0: 7374 5f68 6964 6465 6e5f 7374 6174 653a  st_hidden_state:
+00000fc0: 206d 696e 6473 706f 7265 2e54 656e 736f   mindspore.Tenso
+00000fd0: 7220 3d20 4e6f 6e65 0a20 2020 2068 6964  r = None.    hid
+00000fe0: 6465 6e5f 7374 6174 6573 3a20 4f70 7469  den_states: Opti
+00000ff0: 6f6e 616c 5b54 7570 6c65 5b6d 696e 6473  onal[Tuple[minds
+00001000: 706f 7265 2e54 656e 736f 722c 202e 2e2e  pore.Tensor, ...
+00001010: 5d5d 203d 204e 6f6e 650a 2020 2020 6174  ]] = None.    at
+00001020: 7465 6e74 696f 6e73 3a20 4f70 7469 6f6e  tentions: Option
+00001030: 616c 5b54 7570 6c65 5b6d 696e 6473 706f  al[Tuple[mindspo
+00001040: 7265 2e54 656e 736f 722c 202e 2e2e 5d5d  re.Tensor, ...]]
+00001050: 203d 204e 6f6e 650a 0a20 2020 2040 7072   = None..    @pr
+00001060: 6f70 6572 7479 0a20 2020 2064 6566 2064  operty.    def d
+00001070: 6563 6f64 6572 5f6c 6f67 6974 7328 7365  ecoder_logits(se
+00001080: 6c66 293a 0a20 2020 2020 2020 2077 6172  lf):.        war
+00001090: 6e69 6e67 732e 7761 726e 280a 2020 2020  nings.warn(.    
+000010a0: 2020 2020 2020 2020 2260 6465 636f 6465          "`decode
+000010b0: 725f 6c6f 6769 7473 6020 6174 7472 6962  r_logits` attrib
+000010c0: 7574 6520 6973 2064 6570 7265 6361 7465  ute is deprecate
+000010d0: 6420 616e 6420 7769 6c6c 2062 6520 7265  d and will be re
+000010e0: 6d6f 7665 6420 696e 2076 6572 7369 6f6e  moved in version
+000010f0: 2035 206f 6620 5472 616e 7366 6f72 6d65   5 of Transforme
+00001100: 7273 2e22 0a20 2020 2020 2020 2020 2020  rs.".           
+00001110: 2022 2050 6c65 6173 6520 7573 6520 7468   " Please use th
+00001120: 6520 606c 6f67 6974 7360 2061 7474 7269  e `logits` attri
+00001130: 6275 7465 2074 6f20 7265 7472 6965 7665  bute to retrieve
+00001140: 2074 6865 2066 696e 616c 206f 7574 7075   the final outpu
+00001150: 7420 696e 7374 6561 642e 222c 0a20 2020  t instead.",.   
+00001160: 2020 2020 2020 2020 2046 7574 7572 6557           FutureW
+00001170: 6172 6e69 6e67 2c0a 2020 2020 2020 2020  arning,.        
+00001180: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00001190: 2073 656c 662e 6c6f 6769 7473 0a0a 0a40   self.logits...@
+000011a0: 6461 7461 636c 6173 730a 636c 6173 7320  dataclass.class 
+000011b0: 426c 6970 5465 7874 5669 7369 6f6e 4d6f  BlipTextVisionMo
+000011c0: 6465 6c4f 7574 7075 7428 4d6f 6465 6c4f  delOutput(ModelO
+000011d0: 7574 7075 7429 3a0a 2020 2020 2222 220a  utput):.    """.
+000011e0: 2020 2020 4164 6170 7465 6420 6672 6f6d      Adapted from
+000011f0: 2074 6865 2062 6173 6520 636c 6173 7320   the base class 
+00001200: 666f 7220 7669 7369 6f6e 206d 6f64 656c  for vision model
+00001210: 2773 206f 7574 7075 7473 2074 6861 7420  's outputs that 
+00001220: 616c 736f 2063 6f6e 7461 696e 7320 696d  also contains im
+00001230: 6167 6520 656d 6265 6464 696e 6773 206f  age embeddings o
+00001240: 6620 7468 6520 706f 6f6c 696e 6720 6f66  f the pooling of
+00001250: 2074 6865 0a20 2020 206c 6173 7420 6869   the.    last hi
+00001260: 6464 656e 2073 7461 7465 732e 2054 6869  dden states. Thi
+00001270: 7320 636c 6173 7320 616c 736f 2061 6464  s class also add
+00001280: 7320 7468 6520 6c6f 7373 2074 6572 6d20  s the loss term 
+00001290: 6672 6f6d 2074 6865 2074 6578 7420 6465  from the text de
+000012a0: 636f 6465 722e 0a0a 2020 2020 4172 6773  coder...    Args
+000012b0: 3a0a 2020 2020 2020 2020 6c6f 7373 2028  :.        loss (
+000012c0: 606d 696e 6473 706f 7265 2e54 656e 736f  `mindspore.Tenso
+000012d0: 7260 206f 6620 7368 6170 6520 6028 312c  r` of shape `(1,
+000012e0: 2960 2c20 2a6f 7074 696f 6e61 6c2a 2c20  )`, *optional*, 
+000012f0: 7265 7475 726e 6564 2077 6865 6e20 606c  returned when `l
+00001300: 6162 656c 7360 2069 7320 7072 6f76 6964  abels` is provid
+00001310: 6564 293a 0a20 2020 2020 2020 2020 2020  ed):.           
+00001320: 204c 616e 6775 6765 206d 6f64 656c 696e   Languge modelin
+00001330: 6720 6c6f 7373 2066 726f 6d20 7468 6520  g loss from the 
+00001340: 7465 7874 2064 6563 6f64 6572 2e0a 2020  text decoder..  
+00001350: 2020 2020 2020 696d 6167 655f 656d 6265        image_embe
+00001360: 6473 2028 606d 696e 6473 706f 7265 2e54  ds (`mindspore.T
+00001370: 656e 736f 7260 206f 6620 7368 6170 6520  ensor` of shape 
+00001380: 6028 6261 7463 685f 7369 7a65 2c20 6f75  `(batch_size, ou
+00001390: 7470 7574 5f64 696d 2960 202a 6f70 7469  tput_dim)` *opti
+000013a0: 6f6e 616c 2a20 7265 7475 726e 6564 2077  onal* returned w
+000013b0: 6865 6e20 6d6f 6465 6c20 6973 2069 6e69  hen model is ini
+000013c0: 7469 616c 697a 6564 2077 6974 6820 6077  tialized with `w
+000013d0: 6974 685f 7072 6f6a 6563 7469 6f6e 3d54  ith_projection=T
+000013e0: 7275 6560 293a 0a20 2020 2020 2020 2020  rue`):.         
+000013f0: 2020 2054 6865 2069 6d61 6765 2065 6d62     The image emb
+00001400: 6564 6469 6e67 7320 6f62 7461 696e 6564  eddings obtained
+00001410: 2062 7920 6170 706c 7969 6e67 2074 6865   by applying the
+00001420: 2070 726f 6a65 6374 696f 6e20 6c61 7965   projection laye
+00001430: 7220 746f 2074 6865 2070 6f6f 6c65 725f  r to the pooler_
+00001440: 6f75 7470 7574 2e0a 2020 2020 2020 2020  output..        
+00001450: 6c61 7374 5f68 6964 6465 6e5f 7374 6174  last_hidden_stat
+00001460: 6520 2860 6d69 6e64 7370 6f72 652e 5465  e (`mindspore.Te
+00001470: 6e73 6f72 6020 6f66 2073 6861 7065 2060  nsor` of shape `
+00001480: 2862 6174 6368 5f73 697a 652c 2073 6571  (batch_size, seq
+00001490: 7565 6e63 655f 6c65 6e67 7468 2c20 6869  uence_length, hi
+000014a0: 6464 656e 5f73 697a 6529 6029 3a0a 2020  dden_size)`):.  
+000014b0: 2020 2020 2020 2020 2020 5365 7175 656e            Sequen
+000014c0: 6365 206f 6620 6869 6464 656e 2d73 7461  ce of hidden-sta
+000014d0: 7465 7320 6174 2074 6865 206f 7574 7075  tes at the outpu
+000014e0: 7420 6f66 2074 6865 206c 6173 7420 6c61  t of the last la
+000014f0: 7965 7220 6f66 2074 6865 206d 6f64 656c  yer of the model
+00001500: 2e0a 2020 2020 2020 2020 6869 6464 656e  ..        hidden
+00001510: 5f73 7461 7465 7320 2860 7475 706c 6528  _states (`tuple(
+00001520: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+00001530: 2960 2c20 2a6f 7074 696f 6e61 6c2a 2c20  )`, *optional*, 
+00001540: 7265 7475 726e 6564 2077 6865 6e20 606f  returned when `o
+00001550: 7574 7075 745f 6869 6464 656e 5f73 7461  utput_hidden_sta
+00001560: 7465 733d 5472 7565 6020 6973 2070 6173  tes=True` is pas
+00001570: 7365 6420 6f72 2077 6865 6e20 6063 6f6e  sed or when `con
+00001580: 6669 672e 6f75 7470 7574 5f68 6964 6465  fig.output_hidde
+00001590: 6e5f 7374 6174 6573 3d54 7275 6560 293a  n_states=True`):
+000015a0: 0a20 2020 2020 2020 2020 2020 2054 7570  .            Tup
+000015b0: 6c65 206f 6620 606d 696e 6473 706f 7265  le of `mindspore
+000015c0: 2e54 656e 736f 7260 2028 6f6e 6520 666f  .Tensor` (one fo
+000015d0: 7220 7468 6520 6f75 7470 7574 206f 6620  r the output of 
+000015e0: 7468 6520 656d 6265 6464 696e 6773 2c20  the embeddings, 
+000015f0: 6966 2074 6865 206d 6f64 656c 2068 6173  if the model has
+00001600: 2061 6e20 656d 6265 6464 696e 6720 6c61   an embedding la
+00001610: 7965 722c 202b 0a20 2020 2020 2020 2020  yer, +.         
+00001620: 2020 206f 6e65 2066 6f72 2074 6865 206f     one for the o
+00001630: 7574 7075 7420 6f66 2065 6163 6820 6c61  utput of each la
+00001640: 7965 7229 206f 6620 7368 6170 6520 6028  yer) of shape `(
+00001650: 6261 7463 685f 7369 7a65 2c20 7365 7175  batch_size, sequ
+00001660: 656e 6365 5f6c 656e 6774 682c 2068 6964  ence_length, hid
+00001670: 6465 6e5f 7369 7a65 2960 2e0a 0a20 2020  den_size)`...   
+00001680: 2020 2020 2020 2020 2048 6964 6465 6e2d           Hidden-
+00001690: 7374 6174 6573 206f 6620 7468 6520 6d6f  states of the mo
+000016a0: 6465 6c20 6174 2074 6865 206f 7574 7075  del at the outpu
+000016b0: 7420 6f66 2065 6163 6820 6c61 7965 7220  t of each layer 
+000016c0: 706c 7573 2074 6865 206f 7074 696f 6e61  plus the optiona
+000016d0: 6c20 696e 6974 6961 6c20 656d 6265 6464  l initial embedd
+000016e0: 696e 6720 6f75 7470 7574 732e 0a20 2020  ing outputs..   
+000016f0: 2020 2020 2061 7474 656e 7469 6f6e 7320       attentions 
+00001700: 2860 7475 706c 6528 6d69 6e64 7370 6f72  (`tuple(mindspor
+00001710: 652e 5465 6e73 6f72 2960 2c20 2a6f 7074  e.Tensor)`, *opt
+00001720: 696f 6e61 6c2a 2c20 7265 7475 726e 6564  ional*, returned
+00001730: 2077 6865 6e20 606f 7574 7075 745f 6174   when `output_at
+00001740: 7465 6e74 696f 6e73 3d54 7275 6560 2069  tentions=True` i
+00001750: 7320 7061 7373 6564 206f 7220 7768 656e  s passed or when
+00001760: 2060 636f 6e66 6967 2e6f 7574 7075 745f   `config.output_
+00001770: 6174 7465 6e74 696f 6e73 3d54 7275 6560  attentions=True`
+00001780: 293a 0a20 2020 2020 2020 2020 2020 2054  ):.            T
+00001790: 7570 6c65 206f 6620 606d 696e 6473 706f  uple of `mindspo
+000017a0: 7265 2e54 656e 736f 7260 2028 6f6e 6520  re.Tensor` (one 
+000017b0: 666f 7220 6561 6368 206c 6179 6572 2920  for each layer) 
+000017c0: 6f66 2073 6861 7065 2060 2862 6174 6368  of shape `(batch
+000017d0: 5f73 697a 652c 206e 756d 5f68 6561 6473  _size, num_heads
+000017e0: 2c20 7365 7175 656e 6365 5f6c 656e 6774  , sequence_lengt
+000017f0: 682c 0a20 2020 2020 2020 2020 2020 2073  h,.            s
+00001800: 6571 7565 6e63 655f 6c65 6e67 7468 2960  equence_length)`
+00001810: 2e0a 0a20 2020 2020 2020 2020 2020 2041  ...            A
+00001820: 7474 656e 7469 6f6e 7320 7765 6967 6874  ttentions weight
+00001830: 7320 6166 7465 7220 7468 6520 6174 7465  s after the atte
+00001840: 6e74 696f 6e20 736f 6674 6d61 782c 2075  ntion softmax, u
+00001850: 7365 6420 746f 2063 6f6d 7075 7465 2074  sed to compute t
+00001860: 6865 2077 6569 6768 7465 6420 6176 6572  he weighted aver
+00001870: 6167 6520 696e 2074 6865 2073 656c 662d  age in the self-
+00001880: 6174 7465 6e74 696f 6e0a 2020 2020 2020  attention.      
+00001890: 2020 2020 2020 6865 6164 732e 0a20 2020        heads..   
+000018a0: 2022 2222 0a0a 2020 2020 6c6f 7373 3a20   """..    loss: 
+000018b0: 4f70 7469 6f6e 616c 5b6d 696e 6473 706f  Optional[mindspo
+000018c0: 7265 2e54 656e 736f 725d 203d 204e 6f6e  re.Tensor] = Non
+000018d0: 650a 2020 2020 696d 6167 655f 656d 6265  e.    image_embe
+000018e0: 6473 3a20 4f70 7469 6f6e 616c 5b6d 696e  ds: Optional[min
+000018f0: 6473 706f 7265 2e54 656e 736f 725d 203d  dspore.Tensor] =
+00001900: 204e 6f6e 650a 2020 2020 6c61 7374 5f68   None.    last_h
+00001910: 6964 6465 6e5f 7374 6174 653a 206d 696e  idden_state: min
+00001920: 6473 706f 7265 2e54 656e 736f 7220 3d20  dspore.Tensor = 
+00001930: 4e6f 6e65 0a20 2020 2068 6964 6465 6e5f  None.    hidden_
+00001940: 7374 6174 6573 3a20 4f70 7469 6f6e 616c  states: Optional
+00001950: 5b54 7570 6c65 5b6d 696e 6473 706f 7265  [Tuple[mindspore
+00001960: 2e54 656e 736f 722c 202e 2e2e 5d5d 203d  .Tensor, ...]] =
+00001970: 204e 6f6e 650a 2020 2020 6174 7465 6e74   None.    attent
+00001980: 696f 6e73 3a20 4f70 7469 6f6e 616c 5b54  ions: Optional[T
+00001990: 7570 6c65 5b6d 696e 6473 706f 7265 2e54  uple[mindspore.T
+000019a0: 656e 736f 722c 202e 2e2e 5d5d 203d 204e  ensor, ...]] = N
+000019b0: 6f6e 650a 0a0a 4064 6174 6163 6c61 7373  one...@dataclass
+000019c0: 0a63 6c61 7373 2042 6c69 7049 6d61 6765  .class BlipImage
+000019d0: 5465 7874 4d61 7463 6869 6e67 4d6f 6465  TextMatchingMode
+000019e0: 6c4f 7574 7075 7428 4d6f 6465 6c4f 7574  lOutput(ModelOut
+000019f0: 7075 7429 3a0a 2020 2020 2222 220a 2020  put):.    """.  
+00001a00: 2020 4164 6170 7465 6420 6672 6f6d 2074    Adapted from t
+00001a10: 6865 2062 6173 6520 636c 6173 7320 666f  he base class fo
+00001a20: 7220 7669 7369 6f6e 206d 6f64 656c 2773  r vision model's
+00001a30: 206f 7574 7075 7473 2074 6861 7420 616c   outputs that al
+00001a40: 736f 2063 6f6e 7461 696e 7320 696d 6167  so contains imag
+00001a50: 6520 656d 6265 6464 696e 6773 206f 6620  e embeddings of 
+00001a60: 7468 6520 706f 6f6c 696e 6720 6f66 2074  the pooling of t
+00001a70: 6865 0a20 2020 206c 6173 7420 6869 6464  he.    last hidd
+00001a80: 656e 2073 7461 7465 732e 2054 6869 7320  en states. This 
+00001a90: 636c 6173 7320 616c 736f 2061 6464 7320  class also adds 
+00001aa0: 7468 6520 6c6f 7373 2074 6572 6d20 6672  the loss term fr
+00001ab0: 6f6d 2074 6865 2074 6578 7420 6465 636f  om the text deco
+00001ac0: 6465 7220 6173 2077 656c 6c20 6173 2074  der as well as t
+00001ad0: 6865 2069 6d61 6765 2d74 6578 7420 7369  he image-text si
+00001ae0: 6d69 6c61 7269 7479 0a20 2020 2073 636f  milarity.    sco
+00001af0: 7265 732e 0a0a 2020 2020 4172 6773 3a0a  res...    Args:.
+00001b00: 2020 2020 2020 2020 6974 6d5f 7363 6f72          itm_scor
+00001b10: 6520 2860 6d69 6e64 7370 6f72 652e 5465  e (`mindspore.Te
+00001b20: 6e73 6f72 6029 3a0a 2020 2020 2020 2020  nsor`):.        
+00001b30: 2020 2020 5468 6520 696d 6167 652d 7465      The image-te
+00001b40: 7874 2073 696d 696c 6172 6974 7920 7363  xt similarity sc
+00001b50: 6f72 6573 2e0a 2020 2020 2020 2020 6c6f  ores..        lo
+00001b60: 7373 2028 606d 696e 6473 706f 7265 2e54  ss (`mindspore.T
+00001b70: 656e 736f 7260 206f 6620 7368 6170 6520  ensor` of shape 
+00001b80: 6028 312c 2960 2c20 2a6f 7074 696f 6e61  `(1,)`, *optiona
+00001b90: 6c2a 2c20 7265 7475 726e 6564 2077 6865  l*, returned whe
+00001ba0: 6e20 606c 6162 656c 7360 2069 7320 7072  n `labels` is pr
+00001bb0: 6f76 6964 6564 293a 0a20 2020 2020 2020  ovided):.       
+00001bc0: 2020 2020 204c 616e 6775 6765 206d 6f64       Languge mod
+00001bd0: 656c 696e 6720 6c6f 7373 2066 726f 6d20  eling loss from 
+00001be0: 7468 6520 7465 7874 2064 6563 6f64 6572  the text decoder
+00001bf0: 2e0a 2020 2020 2020 2020 696d 6167 655f  ..        image_
+00001c00: 656d 6265 6473 2028 606d 696e 6473 706f  embeds (`mindspo
+00001c10: 7265 2e54 656e 736f 7260 206f 6620 7368  re.Tensor` of sh
+00001c20: 6170 6520 6028 6261 7463 685f 7369 7a65  ape `(batch_size
+00001c30: 2c20 6f75 7470 7574 5f64 696d 2960 202a  , output_dim)` *
+00001c40: 6f70 7469 6f6e 616c 2a20 7265 7475 726e  optional* return
+00001c50: 6564 2077 6865 6e20 6d6f 6465 6c20 6973  ed when model is
+00001c60: 2069 6e69 7469 616c 697a 6564 2077 6974   initialized wit
+00001c70: 6820 6077 6974 685f 7072 6f6a 6563 7469  h `with_projecti
+00001c80: 6f6e 3d54 7275 6560 293a 0a20 2020 2020  on=True`):.     
+00001c90: 2020 2020 2020 2054 6865 2069 6d61 6765         The image
+00001ca0: 2065 6d62 6564 6469 6e67 7320 6f62 7461   embeddings obta
+00001cb0: 696e 6564 2062 7920 6170 706c 7969 6e67  ined by applying
+00001cc0: 2074 6865 2070 726f 6a65 6374 696f 6e20   the projection 
+00001cd0: 6c61 7965 7220 746f 2074 6865 2070 6f6f  layer to the poo
+00001ce0: 6c65 725f 6f75 7470 7574 2e0a 2020 2020  ler_output..    
+00001cf0: 2020 2020 6c61 7374 5f68 6964 6465 6e5f      last_hidden_
+00001d00: 7374 6174 6520 2860 6d69 6e64 7370 6f72  state (`mindspor
+00001d10: 652e 5465 6e73 6f72 6020 6f66 2073 6861  e.Tensor` of sha
+00001d20: 7065 2060 2862 6174 6368 5f73 697a 652c  pe `(batch_size,
+00001d30: 2073 6571 7565 6e63 655f 6c65 6e67 7468   sequence_length
+00001d40: 2c20 6869 6464 656e 5f73 697a 6529 6029  , hidden_size)`)
+00001d50: 3a0a 2020 2020 2020 2020 2020 2020 5365  :.            Se
+00001d60: 7175 656e 6365 206f 6620 6869 6464 656e  quence of hidden
+00001d70: 2d73 7461 7465 7320 6174 2074 6865 206f  -states at the o
+00001d80: 7574 7075 7420 6f66 2074 6865 206c 6173  utput of the las
+00001d90: 7420 6c61 7965 7220 6f66 2074 6865 206d  t layer of the m
+00001da0: 6f64 656c 2e0a 2020 2020 2020 2020 6869  odel..        hi
+00001db0: 6464 656e 5f73 7461 7465 7320 2860 7475  dden_states (`tu
+00001dc0: 706c 6528 6d69 6e64 7370 6f72 652e 5465  ple(mindspore.Te
+00001dd0: 6e73 6f72 2960 2c20 2a6f 7074 696f 6e61  nsor)`, *optiona
+00001de0: 6c2a 2c20 7265 7475 726e 6564 2077 6865  l*, returned whe
+00001df0: 6e20 606f 7574 7075 745f 6869 6464 656e  n `output_hidden
+00001e00: 5f73 7461 7465 733d 5472 7565 6020 6973  _states=True` is
+00001e10: 2070 6173 7365 6420 6f72 2077 6865 6e20   passed or when 
+00001e20: 6063 6f6e 6669 672e 6f75 7470 7574 5f68  `config.output_h
+00001e30: 6964 6465 6e5f 7374 6174 6573 3d54 7275  idden_states=Tru
+00001e40: 6560 293a 0a20 2020 2020 2020 2020 2020  e`):.           
+00001e50: 2054 7570 6c65 206f 6620 606d 696e 6473   Tuple of `minds
+00001e60: 706f 7265 2e54 656e 736f 7260 2028 6f6e  pore.Tensor` (on
+00001e70: 6520 666f 7220 7468 6520 6f75 7470 7574  e for the output
+00001e80: 206f 6620 7468 6520 656d 6265 6464 696e   of the embeddin
+00001e90: 6773 2c20 6966 2074 6865 206d 6f64 656c  gs, if the model
+00001ea0: 2068 6173 2061 6e20 656d 6265 6464 696e   has an embeddin
+00001eb0: 6720 6c61 7965 722c 202b 0a20 2020 2020  g layer, +.     
+00001ec0: 2020 2020 2020 206f 6e65 2066 6f72 2074         one for t
+00001ed0: 6865 206f 7574 7075 7420 6f66 2065 6163  he output of eac
+00001ee0: 6820 6c61 7965 7229 206f 6620 7368 6170  h layer) of shap
+00001ef0: 6520 6028 6261 7463 685f 7369 7a65 2c20  e `(batch_size, 
+00001f00: 7365 7175 656e 6365 5f6c 656e 6774 682c  sequence_length,
+00001f10: 2068 6964 6465 6e5f 7369 7a65 2960 2e0a   hidden_size)`..
+00001f20: 0a20 2020 2020 2020 2020 2020 2048 6964  .            Hid
+00001f30: 6465 6e2d 7374 6174 6573 206f 6620 7468  den-states of th
+00001f40: 6520 6d6f 6465 6c20 6174 2074 6865 206f  e model at the o
+00001f50: 7574 7075 7420 6f66 2065 6163 6820 6c61  utput of each la
+00001f60: 7965 7220 706c 7573 2074 6865 206f 7074  yer plus the opt
+00001f70: 696f 6e61 6c20 696e 6974 6961 6c20 656d  ional initial em
+00001f80: 6265 6464 696e 6720 6f75 7470 7574 732e  bedding outputs.
+00001f90: 0a20 2020 2020 2020 2076 6973 696f 6e5f  .        vision_
+00001fa0: 706f 6f6c 6572 5f6f 7574 7075 7420 2860  pooler_output (`
+00001fb0: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+00001fc0: 6020 6f66 2073 6861 7065 2060 2862 6174  ` of shape `(bat
+00001fd0: 6368 5f73 697a 652c 2068 6964 6465 6e5f  ch_size, hidden_
+00001fe0: 7369 7a65 2960 2c20 2a6f 7074 696f 6e61  size)`, *optiona
+00001ff0: 6c2a 293a 0a20 2020 2020 2020 2020 2020  l*):.           
+00002000: 204c 6173 7420 6c61 7965 7220 6869 6464   Last layer hidd
+00002010: 656e 2d73 7461 7465 206f 6620 7468 6520  en-state of the 
+00002020: 7669 7369 6f6e 206f 6620 7468 6520 7669  vision of the vi
+00002030: 7369 6f6e 2d6f 6e6c 7920 6272 616e 6368  sion-only branch
+00002040: 206f 6620 7468 6520 6d6f 6465 6c2e 0a20   of the model.. 
+00002050: 2020 2020 2020 2061 7474 656e 7469 6f6e         attention
+00002060: 7320 2860 7475 706c 6528 6d69 6e64 7370  s (`tuple(mindsp
+00002070: 6f72 652e 5465 6e73 6f72 2960 2c20 2a6f  ore.Tensor)`, *o
+00002080: 7074 696f 6e61 6c2a 2c20 7265 7475 726e  ptional*, return
+00002090: 6564 2077 6865 6e20 606f 7574 7075 745f  ed when `output_
+000020a0: 6174 7465 6e74 696f 6e73 3d54 7275 6560  attentions=True`
+000020b0: 2069 7320 7061 7373 6564 206f 7220 7768   is passed or wh
+000020c0: 656e 2060 636f 6e66 6967 2e6f 7574 7075  en `config.outpu
+000020d0: 745f 6174 7465 6e74 696f 6e73 3d54 7275  t_attentions=Tru
+000020e0: 6560 293a 0a20 2020 2020 2020 2020 2020  e`):.           
+000020f0: 2054 7570 6c65 206f 6620 606d 696e 6473   Tuple of `minds
+00002100: 706f 7265 2e54 656e 736f 7260 2028 6f6e  pore.Tensor` (on
+00002110: 6520 666f 7220 6561 6368 206c 6179 6572  e for each layer
+00002120: 2920 6f66 2073 6861 7065 2060 2862 6174  ) of shape `(bat
+00002130: 6368 5f73 697a 652c 206e 756d 5f68 6561  ch_size, num_hea
+00002140: 6473 2c20 7365 7175 656e 6365 5f6c 656e  ds, sequence_len
+00002150: 6774 682c 0a20 2020 2020 2020 2020 2020  gth,.           
+00002160: 2073 6571 7565 6e63 655f 6c65 6e67 7468   sequence_length
+00002170: 2960 2e0a 0a20 2020 2020 2020 2020 2020  )`...           
+00002180: 2041 7474 656e 7469 6f6e 7320 7765 6967   Attentions weig
+00002190: 6874 7320 6166 7465 7220 7468 6520 6174  hts after the at
+000021a0: 7465 6e74 696f 6e20 736f 6674 6d61 782c  tention softmax,
+000021b0: 2075 7365 6420 746f 2063 6f6d 7075 7465   used to compute
+000021c0: 2074 6865 2077 6569 6768 7465 6420 6176   the weighted av
+000021d0: 6572 6167 6520 696e 2074 6865 2073 656c  erage in the sel
+000021e0: 662d 6174 7465 6e74 696f 6e0a 2020 2020  f-attention.    
+000021f0: 2020 2020 2020 2020 6865 6164 732e 0a20          heads.. 
+00002200: 2020 2020 2020 2071 7565 7374 696f 6e5f         question_
+00002210: 656d 6265 6473 2028 606d 696e 6473 706f  embeds (`mindspo
+00002220: 7265 2e54 656e 736f 7260 293a 0a20 2020  re.Tensor`):.   
+00002230: 2020 2020 2020 2020 2054 6865 2071 7565           The que
+00002240: 7374 696f 6e20 656d 6265 6464 696e 6773  stion embeddings
+00002250: 206f 6274 6169 6e65 6420 6279 2074 6865   obtained by the
+00002260: 2074 6578 7420 7072 6f6a 6563 7469 6f6e   text projection
+00002270: 206c 6179 6572 2e0a 2020 2020 2222 220a   layer..    """.
+00002280: 0a20 2020 2069 746d 5f73 636f 7265 3a20  .    itm_score: 
+00002290: 4f70 7469 6f6e 616c 5b6d 696e 6473 706f  Optional[mindspo
+000022a0: 7265 2e54 656e 736f 725d 203d 204e 6f6e  re.Tensor] = Non
+000022b0: 650a 2020 2020 6c6f 7373 3a20 4f70 7469  e.    loss: Opti
+000022c0: 6f6e 616c 5b6d 696e 6473 706f 7265 2e54  onal[mindspore.T
+000022d0: 656e 736f 725d 203d 204e 6f6e 650a 2020  ensor] = None.  
+000022e0: 2020 696d 6167 655f 656d 6265 6473 3a20    image_embeds: 
+000022f0: 4f70 7469 6f6e 616c 5b6d 696e 6473 706f  Optional[mindspo
+00002300: 7265 2e54 656e 736f 725d 203d 204e 6f6e  re.Tensor] = Non
+00002310: 650a 2020 2020 6c61 7374 5f68 6964 6465  e.    last_hidde
+00002320: 6e5f 7374 6174 653a 206d 696e 6473 706f  n_state: mindspo
+00002330: 7265 2e54 656e 736f 7220 3d20 4e6f 6e65  re.Tensor = None
+00002340: 0a20 2020 2068 6964 6465 6e5f 7374 6174  .    hidden_stat
+00002350: 6573 3a20 4f70 7469 6f6e 616c 5b54 7570  es: Optional[Tup
+00002360: 6c65 5b6d 696e 6473 706f 7265 2e54 656e  le[mindspore.Ten
+00002370: 736f 722c 202e 2e2e 5d5d 203d 204e 6f6e  sor, ...]] = Non
+00002380: 650a 2020 2020 7669 7369 6f6e 5f70 6f6f  e.    vision_poo
+00002390: 6c65 725f 6f75 7470 7574 3a20 4f70 7469  ler_output: Opti
+000023a0: 6f6e 616c 5b6d 696e 6473 706f 7265 2e54  onal[mindspore.T
+000023b0: 656e 736f 725d 203d 204e 6f6e 650a 2020  ensor] = None.  
+000023c0: 2020 6174 7465 6e74 696f 6e73 3a20 4f70    attentions: Op
+000023d0: 7469 6f6e 616c 5b54 7570 6c65 5b6d 696e  tional[Tuple[min
+000023e0: 6473 706f 7265 2e54 656e 736f 722c 202e  dspore.Tensor, .
+000023f0: 2e2e 5d5d 203d 204e 6f6e 650a 2020 2020  ..]] = None.    
+00002400: 7175 6573 7469 6f6e 5f65 6d62 6564 733a  question_embeds:
+00002410: 204f 7074 696f 6e61 6c5b 5475 706c 655b   Optional[Tuple[
+00002420: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+00002430: 5d5d 203d 204e 6f6e 650a 0a0a 4064 6174  ]] = None...@dat
+00002440: 6163 6c61 7373 0a63 6c61 7373 2042 6c69  aclass.class Bli
+00002450: 704f 7574 7075 7428 4d6f 6465 6c4f 7574  pOutput(ModelOut
+00002460: 7075 7429 3a0a 2020 2020 2222 220a 2020  put):.    """.  
+00002470: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+00002480: 6c6f 7373 2028 606d 696e 6473 706f 7265  loss (`mindspore
+00002490: 2e54 656e 736f 7260 206f 6620 7368 6170  .Tensor` of shap
+000024a0: 6520 6028 312c 2960 2c20 2a6f 7074 696f  e `(1,)`, *optio
+000024b0: 6e61 6c2a 2c20 7265 7475 726e 6564 2077  nal*, returned w
+000024c0: 6865 6e20 6072 6574 7572 6e5f 6c6f 7373  hen `return_loss
+000024d0: 6020 6973 2060 5472 7565 6029 3a0a 2020  ` is `True`):.  
+000024e0: 2020 2020 2020 2020 2020 436f 6e74 7261            Contra
+000024f0: 7374 6976 6520 6c6f 7373 2066 6f72 2069  stive loss for i
+00002500: 6d61 6765 2d74 6578 7420 7369 6d69 6c61  mage-text simila
+00002510: 7269 7479 2e0a 2020 2020 2020 2020 6c6f  rity..        lo
+00002520: 6769 7473 5f70 6572 5f69 6d61 6765 3a28  gits_per_image:(
+00002530: 606d 696e 6473 706f 7265 2e54 656e 736f  `mindspore.Tenso
+00002540: 7260 206f 6620 7368 6170 6520 6028 696d  r` of shape `(im
+00002550: 6167 655f 6261 7463 685f 7369 7a65 2c20  age_batch_size, 
+00002560: 7465 7874 5f62 6174 6368 5f73 697a 6529  text_batch_size)
+00002570: 6029 3a0a 2020 2020 2020 2020 2020 2020  `):.            
+00002580: 5468 6520 7363 616c 6564 2064 6f74 2070  The scaled dot p
+00002590: 726f 6475 6374 2073 636f 7265 7320 6265  roduct scores be
+000025a0: 7477 6565 6e20 6069 6d61 6765 5f65 6d62  tween `image_emb
+000025b0: 6564 7360 2061 6e64 2060 7465 7874 5f65  eds` and `text_e
+000025c0: 6d62 6564 7360 2e20 5468 6973 2072 6570  mbeds`. This rep
+000025d0: 7265 7365 6e74 7320 7468 6520 696d 6167  resents the imag
+000025e0: 652d 7465 7874 0a20 2020 2020 2020 2020  e-text.         
+000025f0: 2020 2073 696d 696c 6172 6974 7920 7363     similarity sc
+00002600: 6f72 6573 2e0a 2020 2020 2020 2020 6c6f  ores..        lo
+00002610: 6769 7473 5f70 6572 5f74 6578 743a 2860  gits_per_text:(`
+00002620: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+00002630: 6020 6f66 2073 6861 7065 2060 2874 6578  ` of shape `(tex
+00002640: 745f 6261 7463 685f 7369 7a65 2c20 696d  t_batch_size, im
+00002650: 6167 655f 6261 7463 685f 7369 7a65 2960  age_batch_size)`
+00002660: 293a 0a20 2020 2020 2020 2020 2020 2054  ):.            T
+00002670: 6865 2073 6361 6c65 6420 646f 7420 7072  he scaled dot pr
+00002680: 6f64 7563 7420 7363 6f72 6573 2062 6574  oduct scores bet
+00002690: 7765 656e 2060 7465 7874 5f65 6d62 6564  ween `text_embed
+000026a0: 7360 2061 6e64 2060 696d 6167 655f 656d  s` and `image_em
+000026b0: 6265 6473 602e 2054 6869 7320 7265 7072  beds`. This repr
+000026c0: 6573 656e 7473 2074 6865 2074 6578 742d  esents the text-
+000026d0: 696d 6167 650a 2020 2020 2020 2020 2020  image.          
+000026e0: 2020 7369 6d69 6c61 7269 7479 2073 636f    similarity sco
+000026f0: 7265 732e 0a20 2020 2020 2020 2074 6578  res..        tex
+00002700: 745f 656d 6265 6473 2860 6d69 6e64 7370  t_embeds(`mindsp
+00002710: 6f72 652e 5465 6e73 6f72 6020 6f66 2073  ore.Tensor` of s
+00002720: 6861 7065 2060 2862 6174 6368 5f73 697a  hape `(batch_siz
+00002730: 652c 206f 7574 7075 745f 6469 6d60 293a  e, output_dim`):
+00002740: 0a20 2020 2020 2020 2020 2020 2054 6865  .            The
+00002750: 2074 6578 7420 656d 6265 6464 696e 6773   text embeddings
+00002760: 206f 6274 6169 6e65 6420 6279 2061 7070   obtained by app
+00002770: 6c79 696e 6720 7468 6520 7072 6f6a 6563  lying the projec
+00002780: 7469 6f6e 206c 6179 6572 2074 6f20 7468  tion layer to th
+00002790: 6520 706f 6f6c 6564 206f 7574 7075 7420  e pooled output 
+000027a0: 6f66 205b 6042 6c69 7054 6578 744d 6f64  of [`BlipTextMod
+000027b0: 656c 605d 2e0a 2020 2020 2020 2020 696d  el`]..        im
+000027c0: 6167 655f 656d 6265 6473 2860 6d69 6e64  age_embeds(`mind
+000027d0: 7370 6f72 652e 5465 6e73 6f72 6020 6f66  spore.Tensor` of
+000027e0: 2073 6861 7065 2060 2862 6174 6368 5f73   shape `(batch_s
+000027f0: 697a 652c 206f 7574 7075 745f 6469 6d60  ize, output_dim`
+00002800: 293a 0a20 2020 2020 2020 2020 2020 2054  ):.            T
+00002810: 6865 2069 6d61 6765 2065 6d62 6564 6469  he image embeddi
+00002820: 6e67 7320 6f62 7461 696e 6564 2062 7920  ngs obtained by 
+00002830: 6170 706c 7969 6e67 2074 6865 2070 726f  applying the pro
+00002840: 6a65 6374 696f 6e20 6c61 7965 7220 746f  jection layer to
+00002850: 2074 6865 2070 6f6f 6c65 6420 6f75 7470   the pooled outp
+00002860: 7574 206f 6620 5b60 426c 6970 5669 7369  ut of [`BlipVisi
+00002870: 6f6e 4d6f 6465 6c60 5d2e 0a20 2020 2020  onModel`]..     
+00002880: 2020 2074 6578 745f 6d6f 6465 6c5f 6f75     text_model_ou
+00002890: 7470 7574 2860 4261 7365 4d6f 6465 6c4f  tput(`BaseModelO
+000028a0: 7574 7075 7457 6974 6850 6f6f 6c69 6e67  utputWithPooling
+000028b0: 6029 3a0a 2020 2020 2020 2020 2020 2020  `):.            
+000028c0: 5468 6520 6f75 7470 7574 206f 6620 7468  The output of th
+000028d0: 6520 5b60 426c 6970 5465 7874 4d6f 6465  e [`BlipTextMode
+000028e0: 6c60 5d2e 0a20 2020 2020 2020 2076 6973  l`]..        vis
+000028f0: 696f 6e5f 6d6f 6465 6c5f 6f75 7470 7574  ion_model_output
+00002900: 2860 4261 7365 4d6f 6465 6c4f 7574 7075  (`BaseModelOutpu
+00002910: 7457 6974 6850 6f6f 6c69 6e67 6029 3a0a  tWithPooling`):.
+00002920: 2020 2020 2020 2020 2020 2020 5468 6520              The 
+00002930: 6f75 7470 7574 206f 6620 7468 6520 5b60  output of the [`
+00002940: 426c 6970 5669 7369 6f6e 4d6f 6465 6c60  BlipVisionModel`
+00002950: 5d2e 0a20 2020 2022 2222 0a0a 2020 2020  ]..    """..    
+00002960: 6c6f 7373 3a20 4f70 7469 6f6e 616c 5b6d  loss: Optional[m
+00002970: 696e 6473 706f 7265 2e54 656e 736f 725d  indspore.Tensor]
+00002980: 203d 204e 6f6e 650a 2020 2020 6c6f 6769   = None.    logi
+00002990: 7473 5f70 6572 5f69 6d61 6765 3a20 6d69  ts_per_image: mi
+000029a0: 6e64 7370 6f72 652e 5465 6e73 6f72 203d  ndspore.Tensor =
+000029b0: 204e 6f6e 650a 2020 2020 6c6f 6769 7473   None.    logits
+000029c0: 5f70 6572 5f74 6578 743a 206d 696e 6473  _per_text: minds
+000029d0: 706f 7265 2e54 656e 736f 7220 3d20 4e6f  pore.Tensor = No
+000029e0: 6e65 0a20 2020 2074 6578 745f 656d 6265  ne.    text_embe
+000029f0: 6473 3a20 6d69 6e64 7370 6f72 652e 5465  ds: mindspore.Te
+00002a00: 6e73 6f72 203d 204e 6f6e 650a 2020 2020  nsor = None.    
+00002a10: 696d 6167 655f 656d 6265 6473 3a20 6d69  image_embeds: mi
+00002a20: 6e64 7370 6f72 652e 5465 6e73 6f72 203d  ndspore.Tensor =
+00002a30: 204e 6f6e 650a 2020 2020 7465 7874 5f6d   None.    text_m
+00002a40: 6f64 656c 5f6f 7574 7075 743a 2042 6173  odel_output: Bas
+00002a50: 654d 6f64 656c 4f75 7470 7574 5769 7468  eModelOutputWith
+00002a60: 506f 6f6c 696e 6720 3d20 4e6f 6e65 0a20  Pooling = None. 
+00002a70: 2020 2076 6973 696f 6e5f 6d6f 6465 6c5f     vision_model_
+00002a80: 6f75 7470 7574 3a20 4261 7365 4d6f 6465  output: BaseMode
+00002a90: 6c4f 7574 7075 7457 6974 6850 6f6f 6c69  lOutputWithPooli
+00002aa0: 6e67 203d 204e 6f6e 650a 0a20 2020 2064  ng = None..    d
+00002ab0: 6566 2074 6f5f 7475 706c 6528 7365 6c66  ef to_tuple(self
+00002ac0: 2920 2d3e 2054 7570 6c65 5b41 6e79 5d3a  ) -> Tuple[Any]:
+00002ad0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00002ae0: 7475 706c 6528 0a20 2020 2020 2020 2020  tuple(.         
+00002af0: 2020 2073 656c 665b 6b5d 2069 6620 6b20     self[k] if k 
+00002b00: 6e6f 7420 696e 205b 2274 6578 745f 6d6f  not in ["text_mo
+00002b10: 6465 6c5f 6f75 7470 7574 222c 2022 7669  del_output", "vi
+00002b20: 7369 6f6e 5f6d 6f64 656c 5f6f 7574 7075  sion_model_outpu
+00002b30: 7422 5d20 656c 7365 2067 6574 6174 7472  t"] else getattr
+00002b40: 2873 656c 662c 206b 292e 746f 5f74 7570  (self, k).to_tup
+00002b50: 6c65 2829 0a20 2020 2020 2020 2020 2020  le().           
+00002b60: 2066 6f72 206b 2069 6e20 7365 6c66 2e6b   for k in self.k
+00002b70: 6579 7328 290a 2020 2020 2020 2020 290a  eys().        ).
+00002b80: 0a0a 636c 6173 7320 426c 6970 5669 7369  ..class BlipVisi
+00002b90: 6f6e 456d 6265 6464 696e 6773 286e 6e2e  onEmbeddings(nn.
+00002ba0: 4365 6c6c 293a 0a20 2020 2064 6566 205f  Cell):.    def _
+00002bb0: 5f69 6e69 745f 5f28 7365 6c66 2c20 636f  _init__(self, co
+00002bc0: 6e66 6967 3a20 426c 6970 5669 7369 6f6e  nfig: BlipVision
+00002bd0: 436f 6e66 6967 293a 0a20 2020 2020 2020  Config):.       
+00002be0: 2073 7570 6572 2829 2e5f 5f69 6e69 745f   super().__init_
+00002bf0: 5f28 290a 2020 2020 2020 2020 7365 6c66  _().        self
+00002c00: 2e63 6f6e 6669 6720 3d20 636f 6e66 6967  .config = config
+00002c10: 0a20 2020 2020 2020 2073 656c 662e 656d  .        self.em
+00002c20: 6265 645f 6469 6d20 3d20 636f 6e66 6967  bed_dim = config
+00002c30: 2e68 6964 6465 6e5f 7369 7a65 0a20 2020  .hidden_size.   
+00002c40: 2020 2020 2073 656c 662e 696d 6167 655f       self.image_
+00002c50: 7369 7a65 203d 2063 6f6e 6669 672e 696d  size = config.im
+00002c60: 6167 655f 7369 7a65 0a20 2020 2020 2020  age_size.       
+00002c70: 2073 656c 662e 7061 7463 685f 7369 7a65   self.patch_size
+00002c80: 203d 2063 6f6e 6669 672e 7061 7463 685f   = config.patch_
+00002c90: 7369 7a65 0a0a 2020 2020 2020 2020 7365  size..        se
+00002ca0: 6c66 2e63 6c61 7373 5f65 6d62 6564 6469  lf.class_embeddi
+00002cb0: 6e67 203d 2050 6172 616d 6574 6572 286f  ng = Parameter(o
+00002cc0: 7073 2e72 616e 646e 2831 2c20 312c 2073  ps.randn(1, 1, s
+00002cd0: 656c 662e 656d 6265 645f 6469 6d29 290a  elf.embed_dim)).
+00002ce0: 0a20 2020 2020 2020 2073 656c 662e 7061  .        self.pa
+00002cf0: 7463 685f 656d 6265 6464 696e 6720 3d20  tch_embedding = 
+00002d00: 6e6e 2e43 6f6e 7632 6428 0a20 2020 2020  nn.Conv2d(.     
+00002d10: 2020 2020 2020 2069 6e5f 6368 616e 6e65         in_channe
+00002d20: 6c73 3d33 2c20 6f75 745f 6368 616e 6e65  ls=3, out_channe
+00002d30: 6c73 3d73 656c 662e 656d 6265 645f 6469  ls=self.embed_di
+00002d40: 6d2c 206b 6572 6e65 6c5f 7369 7a65 3d73  m, kernel_size=s
+00002d50: 656c 662e 7061 7463 685f 7369 7a65 2c20  elf.patch_size, 
+00002d60: 7374 7269 6465 3d73 656c 662e 7061 7463  stride=self.patc
+00002d70: 685f 7369 7a65 2c20 6861 735f 6269 6173  h_size, has_bias
+00002d80: 3d54 7275 650a 2020 2020 2020 2020 290a  =True.        ).
+00002d90: 0a20 2020 2020 2020 2073 656c 662e 6e75  .        self.nu
+00002da0: 6d5f 7061 7463 6865 7320 3d20 2873 656c  m_patches = (sel
+00002db0: 662e 696d 6167 655f 7369 7a65 202f 2f20  f.image_size // 
+00002dc0: 7365 6c66 2e70 6174 6368 5f73 697a 6529  self.patch_size)
+00002dd0: 202a 2a20 320a 2020 2020 2020 2020 7365   ** 2.        se
+00002de0: 6c66 2e6e 756d 5f70 6f73 6974 696f 6e73  lf.num_positions
+00002df0: 203d 2073 656c 662e 6e75 6d5f 7061 7463   = self.num_patc
+00002e00: 6865 7320 2b20 310a 0a20 2020 2020 2020  hes + 1..       
+00002e10: 2073 656c 662e 706f 7369 7469 6f6e 5f65   self.position_e
+00002e20: 6d62 6564 6469 6e67 203d 2050 6172 616d  mbedding = Param
+00002e30: 6574 6572 286f 7073 2e72 616e 646e 2831  eter(ops.randn(1
+00002e40: 2c20 7365 6c66 2e6e 756d 5f70 6f73 6974  , self.num_posit
+00002e50: 696f 6e73 2c20 7365 6c66 2e65 6d62 6564  ions, self.embed
+00002e60: 5f64 696d 2929 0a0a 2020 2020 6465 6620  _dim))..    def 
+00002e70: 636f 6e73 7472 7563 7428 7365 6c66 2c20  construct(self, 
+00002e80: 7069 7865 6c5f 7661 6c75 6573 3a20 6d69  pixel_values: mi
+00002e90: 6e64 7370 6f72 652e 5465 6e73 6f72 2920  ndspore.Tensor) 
+00002ea0: 2d3e 206d 696e 6473 706f 7265 2e54 656e  -> mindspore.Ten
+00002eb0: 736f 723a 0a20 2020 2020 2020 2062 6174  sor:.        bat
+00002ec0: 6368 5f73 697a 6520 3d20 7069 7865 6c5f  ch_size = pixel_
+00002ed0: 7661 6c75 6573 2e73 6861 7065 5b30 5d0a  values.shape[0].
+00002ee0: 2020 2020 2020 2020 7461 7267 6574 5f64          target_d
+00002ef0: 7479 7065 203d 2073 656c 662e 7061 7463  type = self.patc
+00002f00: 685f 656d 6265 6464 696e 672e 7765 6967  h_embedding.weig
+00002f10: 6874 2e64 7479 7065 0a20 2020 2020 2020  ht.dtype.       
+00002f20: 2070 6174 6368 5f65 6d62 6564 7320 3d20   patch_embeds = 
+00002f30: 7365 6c66 2e70 6174 6368 5f65 6d62 6564  self.patch_embed
+00002f40: 6469 6e67 2870 6978 656c 5f76 616c 7565  ding(pixel_value
+00002f50: 732e 746f 2864 7479 7065 3d74 6172 6765  s.to(dtype=targe
+00002f60: 745f 6474 7970 6529 2920 2023 2073 6861  t_dtype))  # sha
+00002f70: 7065 203d 205b 2a2c 2077 6964 7468 2c20  pe = [*, width, 
+00002f80: 6772 6964 2c20 6772 6964 5d0a 2020 2020  grid, grid].    
+00002f90: 2020 2020 7061 7463 685f 656d 6265 6473      patch_embeds
+00002fa0: 203d 2070 6174 6368 5f65 6d62 6564 732e   = patch_embeds.
+00002fb0: 666c 6174 7465 6e28 7374 6172 745f 6469  flatten(start_di
+00002fc0: 6d3d 3229 2e73 7761 7061 7865 7328 312c  m=2).swapaxes(1,
+00002fd0: 2032 290a 0a20 2020 2020 2020 2063 6c61   2)..        cla
+00002fe0: 7373 5f65 6d62 6564 7320 3d20 7365 6c66  ss_embeds = self
+00002ff0: 2e63 6c61 7373 5f65 6d62 6564 6469 6e67  .class_embedding
+00003000: 2e65 7870 616e 6428 6261 7463 685f 7369  .expand(batch_si
+00003010: 7a65 2c20 312c 202d 3129 2e74 6f28 7461  ze, 1, -1).to(ta
+00003020: 7267 6574 5f64 7479 7065 290a 2020 2020  rget_dtype).    
+00003030: 2020 2020 656d 6265 6464 696e 6773 203d      embeddings =
+00003040: 206f 7073 2e63 6174 285b 636c 6173 735f   ops.cat([class_
+00003050: 656d 6265 6473 2c20 7061 7463 685f 656d  embeds, patch_em
+00003060: 6265 6473 5d2c 2061 7869 733d 3129 0a20  beds], axis=1). 
+00003070: 2020 2020 2020 2065 6d62 6564 6469 6e67         embedding
+00003080: 7320 3d20 656d 6265 6464 696e 6773 202b  s = embeddings +
+00003090: 2073 656c 662e 706f 7369 7469 6f6e 5f65   self.position_e
+000030a0: 6d62 6564 6469 6e67 5b3a 2c20 3a20 656d  mbedding[:, : em
+000030b0: 6265 6464 696e 6773 2e73 6861 7065 5b31  beddings.shape[1
+000030c0: 5d2c 203a 5d2e 746f 2874 6172 6765 745f  ], :].to(target_
+000030d0: 6474 7970 6529 0a20 2020 2020 2020 2072  dtype).        r
+000030e0: 6574 7572 6e20 656d 6265 6464 696e 6773  eturn embeddings
+000030f0: 0a0a 0a23 2043 6f70 6965 6420 6672 6f6d  ...# Copied from
+00003100: 2074 7261 6e73 666f 726d 6572 732e 6d6f   transformers.mo
+00003110: 6465 6c73 2e63 6c69 702e 6d6f 6465 6c69  dels.clip.modeli
+00003120: 6e67 5f63 6c69 702e 434c 4950 5465 7874  ng_clip.CLIPText
+00003130: 456d 6265 6464 696e 6773 2077 6974 6820  Embeddings with 
+00003140: 434c 4950 2d3e 426c 6970 0a63 6c61 7373  CLIP->Blip.class
+00003150: 2042 6c69 7054 6578 7445 6d62 6564 6469   BlipTextEmbeddi
+00003160: 6e67 7328 6e6e 2e43 656c 6c29 3a0a 2020  ngs(nn.Cell):.  
+00003170: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
+00003180: 656c 662c 2063 6f6e 6669 673a 2042 6c69  elf, config: Bli
+00003190: 7054 6578 7443 6f6e 6669 6729 3a0a 2020  pTextConfig):.  
+000031a0: 2020 2020 2020 7375 7065 7228 292e 5f5f        super().__
+000031b0: 696e 6974 5f5f 2829 0a20 2020 2020 2020  init__().       
+000031c0: 2065 6d62 6564 5f64 696d 203d 2063 6f6e   embed_dim = con
+000031d0: 6669 672e 6869 6464 656e 5f73 697a 650a  fig.hidden_size.
+000031e0: 0a20 2020 2020 2020 2073 656c 662e 746f  .        self.to
+000031f0: 6b65 6e5f 656d 6265 6464 696e 6720 3d20  ken_embedding = 
+00003200: 6e6e 2e45 6d62 6564 6469 6e67 2863 6f6e  nn.Embedding(con
+00003210: 6669 672e 766f 6361 625f 7369 7a65 2c20  fig.vocab_size, 
+00003220: 656d 6265 645f 6469 6d29 0a20 2020 2020  embed_dim).     
+00003230: 2020 2073 656c 662e 706f 7369 7469 6f6e     self.position
+00003240: 5f65 6d62 6564 6469 6e67 203d 206e 6e2e  _embedding = nn.
+00003250: 456d 6265 6464 696e 6728 636f 6e66 6967  Embedding(config
+00003260: 2e6d 6178 5f70 6f73 6974 696f 6e5f 656d  .max_position_em
+00003270: 6265 6464 696e 6773 2c20 656d 6265 645f  beddings, embed_
+00003280: 6469 6d29 0a0a 2020 2020 2020 2020 2320  dim)..        # 
+00003290: 706f 7369 7469 6f6e 5f69 6473 2028 312c  position_ids (1,
+000032a0: 206c 656e 2070 6f73 6974 696f 6e20 656d   len position em
+000032b0: 6229 2069 7320 636f 6e74 6967 756f 7573  b) is contiguous
+000032c0: 2069 6e20 6d65 6d6f 7279 2061 6e64 2065   in memory and e
+000032d0: 7870 6f72 7465 6420 7768 656e 2073 6572  xported when ser
+000032e0: 6961 6c69 7a65 640a 2020 2020 2020 2020  ialized.        
+000032f0: 7365 6c66 2e70 6f73 6974 696f 6e5f 6964  self.position_id
+00003300: 7320 3d20 6f70 732e 6172 616e 6765 2863  s = ops.arange(c
+00003310: 6f6e 6669 672e 6d61 785f 706f 7369 7469  onfig.max_positi
+00003320: 6f6e 5f65 6d62 6564 6469 6e67 7329 2e65  on_embeddings).e
+00003330: 7870 616e 6428 2831 2c20 2d31 2929 0a0a  xpand((1, -1))..
+00003340: 2020 2020 6465 6620 636f 6e73 7472 7563      def construc
+00003350: 7428 0a20 2020 2020 2020 2073 656c 662c  t(.        self,
+00003360: 0a20 2020 2020 2020 2069 6e70 7574 5f69  .        input_i
+00003370: 6473 3a20 4f70 7469 6f6e 616c 5b6d 696e  ds: Optional[min
+00003380: 6473 706f 7265 2e54 656e 736f 725d 203d  dspore.Tensor] =
+00003390: 204e 6f6e 652c 0a20 2020 2020 2020 2070   None,.        p
+000033a0: 6f73 6974 696f 6e5f 6964 733a 204f 7074  osition_ids: Opt
+000033b0: 696f 6e61 6c5b 6d69 6e64 7370 6f72 652e  ional[mindspore.
+000033c0: 5465 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a  Tensor] = None,.
+000033d0: 2020 2020 2020 2020 696e 7075 7473 5f65          inputs_e
+000033e0: 6d62 6564 733a 204f 7074 696f 6e61 6c5b  mbeds: Optional[
+000033f0: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+00003400: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2920  ] = None,.    ) 
+00003410: 2d3e 206d 696e 6473 706f 7265 2e54 656e  -> mindspore.Ten
+00003420: 736f 723a 0a20 2020 2020 2020 2073 6571  sor:.        seq
+00003430: 5f6c 656e 6774 6820 3d20 696e 7075 745f  _length = input_
+00003440: 6964 732e 7368 6170 655b 2d31 5d20 6966  ids.shape[-1] if
+00003450: 2069 6e70 7574 5f69 6473 2069 7320 6e6f   input_ids is no
+00003460: 7420 4e6f 6e65 2065 6c73 6520 696e 7075  t None else inpu
+00003470: 7473 5f65 6d62 6564 732e 7368 6170 655b  ts_embeds.shape[
+00003480: 2d32 5d0a 0a20 2020 2020 2020 2069 6620  -2]..        if 
+00003490: 706f 7369 7469 6f6e 5f69 6473 2069 7320  position_ids is 
+000034a0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+000034b0: 2020 706f 7369 7469 6f6e 5f69 6473 203d    position_ids =
+000034c0: 2073 656c 662e 706f 7369 7469 6f6e 5f69   self.position_i
+000034d0: 6473 5b3a 2c20 3a73 6571 5f6c 656e 6774  ds[:, :seq_lengt
+000034e0: 685d 0a0a 2020 2020 2020 2020 6966 2069  h]..        if i
+000034f0: 6e70 7574 735f 656d 6265 6473 2069 7320  nputs_embeds is 
+00003500: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00003510: 2020 696e 7075 7473 5f65 6d62 6564 7320    inputs_embeds 
+00003520: 3d20 7365 6c66 2e74 6f6b 656e 5f65 6d62  = self.token_emb
+00003530: 6564 6469 6e67 2869 6e70 7574 5f69 6473  edding(input_ids
+00003540: 290a 0a20 2020 2020 2020 2070 6f73 6974  )..        posit
+00003550: 696f 6e5f 656d 6265 6464 696e 6773 203d  ion_embeddings =
+00003560: 2073 656c 662e 706f 7369 7469 6f6e 5f65   self.position_e
+00003570: 6d62 6564 6469 6e67 2870 6f73 6974 696f  mbedding(positio
+00003580: 6e5f 6964 7329 0a20 2020 2020 2020 2065  n_ids).        e
+00003590: 6d62 6564 6469 6e67 7320 3d20 696e 7075  mbeddings = inpu
+000035a0: 7473 5f65 6d62 6564 7320 2b20 706f 7369  ts_embeds + posi
+000035b0: 7469 6f6e 5f65 6d62 6564 6469 6e67 730a  tion_embeddings.
+000035c0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000035d0: 656d 6265 6464 696e 6773 0a0a 0a63 6c61  embeddings...cla
+000035e0: 7373 2042 6c69 7041 7474 656e 7469 6f6e  ss BlipAttention
+000035f0: 286e 6e2e 4365 6c6c 293a 0a20 2020 2022  (nn.Cell):.    "
+00003600: 2222 4d75 6c74 692d 6865 6164 6564 2061  ""Multi-headed a
+00003610: 7474 656e 7469 6f6e 2066 726f 6d20 2741  ttention from 'A
+00003620: 7474 656e 7469 6f6e 2049 7320 416c 6c20  ttention Is All 
+00003630: 596f 7520 4e65 6564 2720 7061 7065 7222  You Need' paper"
+00003640: 2222 0a0a 2020 2020 6465 6620 5f5f 696e  ""..    def __in
+00003650: 6974 5f5f 2873 656c 662c 2063 6f6e 6669  it__(self, confi
+00003660: 6729 3a0a 2020 2020 2020 2020 7375 7065  g):.        supe
+00003670: 7228 292e 5f5f 696e 6974 5f5f 2829 0a20  r().__init__(). 
+00003680: 2020 2020 2020 2073 656c 662e 636f 6e66         self.conf
+00003690: 6967 203d 2063 6f6e 6669 670a 2020 2020  ig = config.    
+000036a0: 2020 2020 7365 6c66 2e65 6d62 6564 5f64      self.embed_d
+000036b0: 696d 203d 2063 6f6e 6669 672e 6869 6464  im = config.hidd
+000036c0: 656e 5f73 697a 650a 2020 2020 2020 2020  en_size.        
+000036d0: 7365 6c66 2e6e 756d 5f68 6561 6473 203d  self.num_heads =
+000036e0: 2063 6f6e 6669 672e 6e75 6d5f 6174 7465   config.num_atte
+000036f0: 6e74 696f 6e5f 6865 6164 730a 2020 2020  ntion_heads.    
+00003700: 2020 2020 7365 6c66 2e68 6561 645f 6469      self.head_di
+00003710: 6d20 3d20 7365 6c66 2e65 6d62 6564 5f64  m = self.embed_d
+00003720: 696d 202f 2f20 7365 6c66 2e6e 756d 5f68  im // self.num_h
+00003730: 6561 6473 0a20 2020 2020 2020 2069 6620  eads.        if 
+00003740: 7365 6c66 2e68 6561 645f 6469 6d20 2a20  self.head_dim * 
+00003750: 7365 6c66 2e6e 756d 5f68 6561 6473 2021  self.num_heads !
+00003760: 3d20 7365 6c66 2e65 6d62 6564 5f64 696d  = self.embed_dim
+00003770: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+00003780: 6973 6520 5661 6c75 6545 7272 6f72 280a  ise ValueError(.
+00003790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000037a0: 6622 656d 6265 645f 6469 6d20 6d75 7374  f"embed_dim must
+000037b0: 2062 6520 6469 7669 7369 626c 6520 6279   be divisible by
+000037c0: 206e 756d 5f68 6561 6473 2028 676f 7420   num_heads (got 
+000037d0: 6065 6d62 6564 5f64 696d 603a 207b 7365  `embed_dim`: {se
+000037e0: 6c66 2e65 6d62 6564 5f64 696d 7d20 616e  lf.embed_dim} an
+000037f0: 6420 606e 756d 5f68 6561 6473 603a 220a  d `num_heads`:".
+00003800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003810: 6622 207b 7365 6c66 2e6e 756d 5f68 6561  f" {self.num_hea
+00003820: 6473 7d29 2e22 0a20 2020 2020 2020 2020  ds}).".         
+00003830: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
+00003840: 662e 7363 616c 6520 3d20 7365 6c66 2e68  f.scale = self.h
+00003850: 6561 645f 6469 6d2a 2a2d 302e 350a 2020  ead_dim**-0.5.  
+00003860: 2020 2020 2020 7365 6c66 2e64 726f 706f        self.dropo
+00003870: 7574 203d 206e 6e2e 4472 6f70 6f75 7428  ut = nn.Dropout(
+00003880: 703d 636f 6e66 6967 2e61 7474 656e 7469  p=config.attenti
+00003890: 6f6e 5f64 726f 706f 7574 290a 0a20 2020  on_dropout)..   
+000038a0: 2020 2020 2073 656c 662e 716b 7620 3d20       self.qkv = 
+000038b0: 6e6e 2e44 656e 7365 2873 656c 662e 656d  nn.Dense(self.em
+000038c0: 6265 645f 6469 6d2c 2033 202a 2073 656c  bed_dim, 3 * sel
+000038d0: 662e 656d 6265 645f 6469 6d29 0a0a 2020  f.embed_dim)..  
+000038e0: 2020 2020 2020 7365 6c66 2e70 726f 6a65        self.proje
+000038f0: 6374 696f 6e20 3d20 6e6e 2e44 656e 7365  ction = nn.Dense
+00003900: 2873 656c 662e 656d 6265 645f 6469 6d2c  (self.embed_dim,
+00003910: 2073 656c 662e 656d 6265 645f 6469 6d29   self.embed_dim)
+00003920: 0a0a 2020 2020 6465 6620 5f73 6861 7065  ..    def _shape
+00003930: 2873 656c 662c 2074 656e 736f 723a 206d  (self, tensor: m
+00003940: 696e 6473 706f 7265 2e54 656e 736f 722c  indspore.Tensor,
+00003950: 2073 6571 5f6c 656e 3a20 696e 742c 2062   seq_len: int, b
+00003960: 737a 3a20 696e 7429 3a0a 2020 2020 2020  sz: int):.      
+00003970: 2020 7265 7475 726e 2074 656e 736f 722e    return tensor.
+00003980: 7669 6577 2862 737a 2c20 7365 715f 6c65  view(bsz, seq_le
+00003990: 6e2c 2073 656c 662e 6e75 6d5f 6865 6164  n, self.num_head
+000039a0: 732c 2073 656c 662e 6865 6164 5f64 696d  s, self.head_dim
+000039b0: 292e 7377 6170 6178 6573 2831 2c20 3229  ).swapaxes(1, 2)
+000039c0: 0a0a 2020 2020 6465 6620 636f 6e73 7472  ..    def constr
+000039d0: 7563 7428 0a20 2020 2020 2020 2073 656c  uct(.        sel
+000039e0: 662c 0a20 2020 2020 2020 2068 6964 6465  f,.        hidde
+000039f0: 6e5f 7374 6174 6573 3a20 6d69 6e64 7370  n_states: mindsp
+00003a00: 6f72 652e 5465 6e73 6f72 2c0a 2020 2020  ore.Tensor,.    
+00003a10: 2020 2020 6865 6164 5f6d 6173 6b3a 204f      head_mask: O
+00003a20: 7074 696f 6e61 6c5b 6d69 6e64 7370 6f72  ptional[mindspor
+00003a30: 652e 5465 6e73 6f72 5d20 3d20 4e6f 6e65  e.Tensor] = None
+00003a40: 2c0a 2020 2020 2020 2020 6f75 7470 7574  ,.        output
+00003a50: 5f61 7474 656e 7469 6f6e 733a 204f 7074  _attentions: Opt
+00003a60: 696f 6e61 6c5b 626f 6f6c 5d20 3d20 4661  ional[bool] = Fa
+00003a70: 6c73 652c 0a20 2020 2029 202d 3e20 5475  lse,.    ) -> Tu
+00003a80: 706c 655b 6d69 6e64 7370 6f72 652e 5465  ple[mindspore.Te
+00003a90: 6e73 6f72 2c20 4f70 7469 6f6e 616c 5b6d  nsor, Optional[m
+00003aa0: 696e 6473 706f 7265 2e54 656e 736f 725d  indspore.Tensor]
+00003ab0: 2c20 4f70 7469 6f6e 616c 5b54 7570 6c65  , Optional[Tuple
+00003ac0: 5b6d 696e 6473 706f 7265 2e54 656e 736f  [mindspore.Tenso
+00003ad0: 725d 5d5d 3a0a 2020 2020 2020 2020 2222  r]]]:.        ""
+00003ae0: 2249 6e70 7574 2073 6861 7065 3a20 4261  "Input shape: Ba
+00003af0: 7463 6820 7820 5469 6d65 2078 2043 6861  tch x Time x Cha
+00003b00: 6e6e 656c 2222 220a 0a20 2020 2020 2020  nnel"""..       
+00003b10: 2062 737a 2c20 7467 745f 6c65 6e2c 2065   bsz, tgt_len, e
+00003b20: 6d62 6564 5f64 696d 203d 2068 6964 6465  mbed_dim = hidde
+00003b30: 6e5f 7374 6174 6573 2e73 6861 7065 0a0a  n_states.shape..
+00003b40: 2020 2020 2020 2020 6d69 7865 645f 716b          mixed_qk
+00003b50: 7620 3d20 280a 2020 2020 2020 2020 2020  v = (.          
+00003b60: 2020 7365 6c66 2e71 6b76 2868 6964 6465    self.qkv(hidde
+00003b70: 6e5f 7374 6174 6573 290a 2020 2020 2020  n_states).      
+00003b80: 2020 2020 2020 2e72 6573 6861 7065 2862        .reshape(b
+00003b90: 737a 2c20 7467 745f 6c65 6e2c 2033 2c20  sz, tgt_len, 3, 
+00003ba0: 7365 6c66 2e6e 756d 5f68 6561 6473 2c20  self.num_heads, 
+00003bb0: 656d 6265 645f 6469 6d20 2f2f 2073 656c  embed_dim // sel
+00003bc0: 662e 6e75 6d5f 6865 6164 7329 0a20 2020  f.num_heads).   
+00003bd0: 2020 2020 2020 2020 202e 7065 726d 7574           .permut
+00003be0: 6528 322c 2030 2c20 332c 2031 2c20 3429  e(2, 0, 3, 1, 4)
+00003bf0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00003c00: 2020 2071 7565 7279 5f73 7461 7465 732c     query_states,
+00003c10: 206b 6579 5f73 7461 7465 732c 2076 616c   key_states, val
+00003c20: 7565 5f73 7461 7465 7320 3d20 6d69 7865  ue_states = mixe
+00003c30: 645f 716b 765b 305d 2c20 6d69 7865 645f  d_qkv[0], mixed_
+00003c40: 716b 765b 315d 2c20 6d69 7865 645f 716b  qkv[1], mixed_qk
+00003c50: 765b 325d 0a0a 2020 2020 2020 2020 2320  v[2]..        # 
+00003c60: 5461 6b65 2074 6865 2064 6f74 2070 726f  Take the dot pro
+00003c70: 6475 6374 2062 6574 7765 656e 2022 7175  duct between "qu
+00003c80: 6572 7922 2061 6e64 2022 6b65 7922 2074  ery" and "key" t
+00003c90: 6f20 6765 7420 7468 6520 7261 7720 6174  o get the raw at
+00003ca0: 7465 6e74 696f 6e20 7363 6f72 6573 2e0a  tention scores..
+00003cb0: 2020 2020 2020 2020 6174 7465 6e74 696f          attentio
+00003cc0: 6e5f 7363 6f72 6573 203d 206f 7073 2e6d  n_scores = ops.m
+00003cd0: 6174 6d75 6c28 7175 6572 795f 7374 6174  atmul(query_stat
+00003ce0: 6573 2c20 6b65 795f 7374 6174 6573 2e73  es, key_states.s
+00003cf0: 7761 7061 7865 7328 2d31 2c20 2d32 2929  wapaxes(-1, -2))
+00003d00: 0a0a 2020 2020 2020 2020 6174 7465 6e74  ..        attent
+00003d10: 696f 6e5f 7363 6f72 6573 203d 2061 7474  ion_scores = att
+00003d20: 656e 7469 6f6e 5f73 636f 7265 7320 2a20  ention_scores * 
+00003d30: 7365 6c66 2e73 6361 6c65 0a0a 2020 2020  self.scale..    
+00003d40: 2020 2020 2320 4e6f 726d 616c 697a 6520      # Normalize 
+00003d50: 7468 6520 6174 7465 6e74 696f 6e20 7363  the attention sc
+00003d60: 6f72 6573 2074 6f20 7072 6f62 6162 696c  ores to probabil
+00003d70: 6974 6965 732e 0a20 2020 2020 2020 2061  ities..        a
+00003d80: 7474 656e 7469 6f6e 5f70 726f 6273 203d  ttention_probs =
+00003d90: 206f 7073 2e73 6f66 746d 6178 2861 7474   ops.softmax(att
+00003da0: 656e 7469 6f6e 5f73 636f 7265 732c 2061  ention_scores, a
+00003db0: 7869 733d 2d31 290a 0a20 2020 2020 2020  xis=-1)..       
+00003dc0: 2023 2054 6869 7320 6973 2061 6374 7561   # This is actua
+00003dd0: 6c6c 7920 6472 6f70 7069 6e67 206f 7574  lly dropping out
+00003de0: 2065 6e74 6972 6520 746f 6b65 6e73 2074   entire tokens t
+00003df0: 6f20 6174 7465 6e64 2074 6f2c 2077 6869  o attend to, whi
+00003e00: 6368 206d 6967 6874 0a20 2020 2020 2020  ch might.       
+00003e10: 2023 2073 6565 6d20 6120 6269 7420 756e   # seem a bit un
+00003e20: 7573 7561 6c2c 2062 7574 2069 7320 7461  usual, but is ta
+00003e30: 6b65 6e20 6672 6f6d 2074 6865 206f 7269  ken from the ori
+00003e40: 6769 6e61 6c20 5472 616e 7366 6f72 6d65  ginal Transforme
+00003e50: 7220 7061 7065 722e 0a20 2020 2020 2020  r paper..       
+00003e60: 2061 7474 656e 7469 6f6e 5f70 726f 6273   attention_probs
+00003e70: 203d 2073 656c 662e 6472 6f70 6f75 7428   = self.dropout(
+00003e80: 6174 7465 6e74 696f 6e5f 7072 6f62 7329  attention_probs)
+00003e90: 0a0a 2020 2020 2020 2020 2320 4d61 736b  ..        # Mask
+00003ea0: 2068 6561 6473 2069 6620 7765 2077 616e   heads if we wan
+00003eb0: 7420 746f 0a20 2020 2020 2020 2069 6620  t to.        if 
+00003ec0: 6865 6164 5f6d 6173 6b20 6973 206e 6f74  head_mask is not
+00003ed0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00003ee0: 2020 2061 7474 656e 7469 6f6e 5f70 726f     attention_pro
+00003ef0: 6273 203d 2061 7474 656e 7469 6f6e 5f70  bs = attention_p
+00003f00: 726f 6273 202a 2068 6561 645f 6d61 736b  robs * head_mask
+00003f10: 0a0a 2020 2020 2020 2020 636f 6e74 6578  ..        contex
+00003f20: 745f 6c61 7965 7220 3d20 6f70 732e 6d61  t_layer = ops.ma
+00003f30: 746d 756c 2861 7474 656e 7469 6f6e 5f70  tmul(attention_p
+00003f40: 726f 6273 2c20 7661 6c75 655f 7374 6174  robs, value_stat
+00003f50: 6573 292e 7065 726d 7574 6528 302c 2032  es).permute(0, 2
+00003f60: 2c20 312c 2033 290a 0a20 2020 2020 2020  , 1, 3)..       
+00003f70: 206e 6577 5f63 6f6e 7465 7874 5f6c 6179   new_context_lay
+00003f80: 6572 5f73 6861 7065 203d 2063 6f6e 7465  er_shape = conte
+00003f90: 7874 5f6c 6179 6572 2e73 6861 7065 5b3a  xt_layer.shape[:
+00003fa0: 2d32 5d20 2b20 2873 656c 662e 656d 6265  -2] + (self.embe
+00003fb0: 645f 6469 6d2c 290a 2020 2020 2020 2020  d_dim,).        
+00003fc0: 636f 6e74 6578 745f 6c61 7965 7220 3d20  context_layer = 
+00003fd0: 636f 6e74 6578 745f 6c61 7965 722e 7265  context_layer.re
+00003fe0: 7368 6170 6528 6e65 775f 636f 6e74 6578  shape(new_contex
+00003ff0: 745f 6c61 7965 725f 7368 6170 6529 0a0a  t_layer_shape)..
+00004000: 2020 2020 2020 2020 6f75 7470 7574 203d          output =
+00004010: 2073 656c 662e 7072 6f6a 6563 7469 6f6e   self.projection
+00004020: 2863 6f6e 7465 7874 5f6c 6179 6572 290a  (context_layer).
+00004030: 0a20 2020 2020 2020 206f 7574 7075 7473  .        outputs
+00004040: 203d 2028 6f75 7470 7574 2c20 6174 7465   = (output, atte
+00004050: 6e74 696f 6e5f 7072 6f62 7329 2069 6620  ntion_probs) if 
+00004060: 6f75 7470 7574 5f61 7474 656e 7469 6f6e  output_attention
+00004070: 7320 656c 7365 2028 6f75 7470 7574 2c20  s else (output, 
+00004080: 4e6f 6e65 290a 0a20 2020 2020 2020 2072  None)..        r
+00004090: 6574 7572 6e20 6f75 7470 7574 730a 0a0a  eturn outputs...
+000040a0: 2320 436f 7069 6564 2066 726f 6d20 7472  # Copied from tr
+000040b0: 616e 7366 6f72 6d65 7273 2e6d 6f64 656c  ansformers.model
+000040c0: 732e 636c 6970 2e6d 6f64 656c 696e 675f  s.clip.modeling_
+000040d0: 636c 6970 2e43 4c49 504d 4c50 2077 6974  clip.CLIPMLP wit
+000040e0: 6820 434c 4950 2d3e 426c 6970 0a63 6c61  h CLIP->Blip.cla
+000040f0: 7373 2042 6c69 704d 4c50 286e 6e2e 4365  ss BlipMLP(nn.Ce
+00004100: 6c6c 293a 0a20 2020 2064 6566 205f 5f69  ll):.    def __i
+00004110: 6e69 745f 5f28 7365 6c66 2c20 636f 6e66  nit__(self, conf
+00004120: 6967 293a 0a20 2020 2020 2020 2073 7570  ig):.        sup
+00004130: 6572 2829 2e5f 5f69 6e69 745f 5f28 290a  er().__init__().
+00004140: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
+00004150: 6669 6720 3d20 636f 6e66 6967 0a20 2020  fig = config.   
+00004160: 2020 2020 2073 656c 662e 6163 7469 7661       self.activa
+00004170: 7469 6f6e 5f66 6e20 3d20 4143 5432 464e  tion_fn = ACT2FN
+00004180: 5b63 6f6e 6669 672e 6869 6464 656e 5f61  [config.hidden_a
+00004190: 6374 5d0a 2020 2020 2020 2020 7365 6c66  ct].        self
+000041a0: 2e66 6331 203d 206e 6e2e 4465 6e73 6528  .fc1 = nn.Dense(
+000041b0: 636f 6e66 6967 2e68 6964 6465 6e5f 7369  config.hidden_si
+000041c0: 7a65 2c20 636f 6e66 6967 2e69 6e74 6572  ze, config.inter
+000041d0: 6d65 6469 6174 655f 7369 7a65 290a 2020  mediate_size).  
+000041e0: 2020 2020 2020 7365 6c66 2e66 6332 203d        self.fc2 =
+000041f0: 206e 6e2e 4465 6e73 6528 636f 6e66 6967   nn.Dense(config
+00004200: 2e69 6e74 6572 6d65 6469 6174 655f 7369  .intermediate_si
+00004210: 7a65 2c20 636f 6e66 6967 2e68 6964 6465  ze, config.hidde
+00004220: 6e5f 7369 7a65 290a 0a20 2020 2064 6566  n_size)..    def
+00004230: 2063 6f6e 7374 7275 6374 2873 656c 662c   construct(self,
+00004240: 2068 6964 6465 6e5f 7374 6174 6573 3a20   hidden_states: 
+00004250: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+00004260: 2920 2d3e 206d 696e 6473 706f 7265 2e54  ) -> mindspore.T
+00004270: 656e 736f 723a 0a20 2020 2020 2020 2068  ensor:.        h
+00004280: 6964 6465 6e5f 7374 6174 6573 203d 2073  idden_states = s
+00004290: 656c 662e 6663 3128 6869 6464 656e 5f73  elf.fc1(hidden_s
+000042a0: 7461 7465 7329 0a20 2020 2020 2020 2068  tates).        h
+000042b0: 6964 6465 6e5f 7374 6174 6573 203d 2073  idden_states = s
+000042c0: 656c 662e 6163 7469 7661 7469 6f6e 5f66  elf.activation_f
+000042d0: 6e28 6869 6464 656e 5f73 7461 7465 7329  n(hidden_states)
+000042e0: 0a20 2020 2020 2020 2068 6964 6465 6e5f  .        hidden_
+000042f0: 7374 6174 6573 203d 2073 656c 662e 6663  states = self.fc
+00004300: 3228 6869 6464 656e 5f73 7461 7465 7329  2(hidden_states)
+00004310: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00004320: 6869 6464 656e 5f73 7461 7465 730a 0a0a  hidden_states...
+00004330: 636c 6173 7320 426c 6970 456e 636f 6465  class BlipEncode
+00004340: 724c 6179 6572 286e 6e2e 4365 6c6c 293a  rLayer(nn.Cell):
+00004350: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+00004360: 5f28 7365 6c66 2c20 636f 6e66 6967 3a20  _(self, config: 
+00004370: 426c 6970 436f 6e66 6967 293a 0a20 2020  BlipConfig):.   
+00004380: 2020 2020 2073 7570 6572 2829 2e5f 5f69       super().__i
+00004390: 6e69 745f 5f28 290a 2020 2020 2020 2020  nit__().        
+000043a0: 7365 6c66 2e65 6d62 6564 5f64 696d 203d  self.embed_dim =
+000043b0: 2063 6f6e 6669 672e 6869 6464 656e 5f73   config.hidden_s
+000043c0: 697a 650a 2020 2020 2020 2020 7365 6c66  ize.        self
+000043d0: 2e73 656c 665f 6174 746e 203d 2042 6c69  .self_attn = Bli
+000043e0: 7041 7474 656e 7469 6f6e 2863 6f6e 6669  pAttention(confi
+000043f0: 6729 0a20 2020 2020 2020 2073 656c 662e  g).        self.
+00004400: 6c61 7965 725f 6e6f 726d 3120 3d20 6e6e  layer_norm1 = nn
+00004410: 2e4c 6179 6572 4e6f 726d 2873 656c 662e  .LayerNorm(self.
+00004420: 656d 6265 645f 6469 6d2c 2065 7073 696c  embed_dim, epsil
+00004430: 6f6e 3d63 6f6e 6669 672e 6c61 7965 725f  on=config.layer_
+00004440: 6e6f 726d 5f65 7073 290a 2020 2020 2020  norm_eps).      
+00004450: 2020 7365 6c66 2e6d 6c70 203d 2042 6c69    self.mlp = Bli
+00004460: 704d 4c50 2863 6f6e 6669 6729 0a20 2020  pMLP(config).   
+00004470: 2020 2020 2073 656c 662e 6c61 7965 725f       self.layer_
+00004480: 6e6f 726d 3220 3d20 6e6e 2e4c 6179 6572  norm2 = nn.Layer
+00004490: 4e6f 726d 2873 656c 662e 656d 6265 645f  Norm(self.embed_
+000044a0: 6469 6d2c 2065 7073 696c 6f6e 3d63 6f6e  dim, epsilon=con
+000044b0: 6669 672e 6c61 7965 725f 6e6f 726d 5f65  fig.layer_norm_e
+000044c0: 7073 290a 0a20 2020 2064 6566 2063 6f6e  ps)..    def con
+000044d0: 7374 7275 6374 280a 2020 2020 2020 2020  struct(.        
+000044e0: 7365 6c66 2c0a 2020 2020 2020 2020 6869  self,.        hi
+000044f0: 6464 656e 5f73 7461 7465 733a 206d 696e  dden_states: min
+00004500: 6473 706f 7265 2e54 656e 736f 722c 0a20  dspore.Tensor,. 
+00004510: 2020 2020 2020 2061 7474 656e 7469 6f6e         attention
+00004520: 5f6d 6173 6b3a 206d 696e 6473 706f 7265  _mask: mindspore
+00004530: 2e54 656e 736f 722c 0a20 2020 2020 2020  .Tensor,.       
+00004540: 206f 7574 7075 745f 6174 7465 6e74 696f   output_attentio
+00004550: 6e73 3a20 4f70 7469 6f6e 616c 5b62 6f6f  ns: Optional[boo
+00004560: 6c5d 203d 2046 616c 7365 2c0a 2020 2020  l] = False,.    
+00004570: 2920 2d3e 2054 7570 6c65 5b6d 696e 6473  ) -> Tuple[minds
+00004580: 706f 7265 2e54 656e 736f 725d 3a0a 2020  pore.Tensor]:.  
+00004590: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+000045a0: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+000045b0: 2020 2020 6869 6464 656e 5f73 7461 7465      hidden_state
+000045c0: 7320 2860 6d69 6e64 7370 6f72 652e 5465  s (`mindspore.Te
+000045d0: 6e73 6f72 6029 3a20 696e 7075 7420 746f  nsor`): input to
+000045e0: 2074 6865 206c 6179 6572 206f 6620 7368   the layer of sh
+000045f0: 6170 6520 6028 6261 7463 682c 2073 6571  ape `(batch, seq
+00004600: 5f6c 656e 2c20 656d 6265 645f 6469 6d29  _len, embed_dim)
+00004610: 600a 2020 2020 2020 2020 2020 2020 6174  `.            at
+00004620: 7465 6e74 696f 6e5f 6d61 736b 2028 606d  tention_mask (`m
+00004630: 696e 6473 706f 7265 2e54 656e 736f 7260  indspore.Tensor`
+00004640: 293a 2061 7474 656e 7469 6f6e 206d 6173  ): attention mas
+00004650: 6b20 6f66 2073 697a 650a 2020 2020 2020  k of size.      
+00004660: 2020 2020 2020 2020 2020 6028 6261 7463            `(batc
+00004670: 682c 2031 2c20 7467 745f 6c65 6e2c 2073  h, 1, tgt_len, s
+00004680: 7263 5f6c 656e 2960 2077 6865 7265 2070  rc_len)` where p
+00004690: 6164 6469 6e67 2065 6c65 6d65 6e74 7320  adding elements 
+000046a0: 6172 6520 696e 6469 6361 7465 6420 6279  are indicated by
+000046b0: 2076 6572 7920 6c61 7267 6520 6e65 6761   very large nega
+000046c0: 7469 7665 2076 616c 7565 732e 0a20 2020  tive values..   
+000046d0: 2020 2020 2020 2020 2020 2020 2060 2863               `(c
+000046e0: 6f6e 6669 672e 656e 636f 6465 725f 6174  onfig.encoder_at
+000046f0: 7465 6e74 696f 6e5f 6865 6164 732c 2960  tention_heads,)`
+00004700: 2e0a 2020 2020 2020 2020 2020 2020 6f75  ..            ou
+00004710: 7470 7574 5f61 7474 656e 7469 6f6e 7320  tput_attentions 
+00004720: 2860 626f 6f6c 602c 202a 6f70 7469 6f6e  (`bool`, *option
+00004730: 616c 2a29 3a0a 2020 2020 2020 2020 2020  al*):.          
+00004740: 2020 2020 2020 5768 6574 6865 7220 6f72        Whether or
+00004750: 206e 6f74 2074 6f20 7265 7475 726e 2074   not to return t
+00004760: 6865 2061 7474 656e 7469 6f6e 7320 7465  he attentions te
+00004770: 6e73 6f72 7320 6f66 2061 6c6c 2061 7474  nsors of all att
+00004780: 656e 7469 6f6e 206c 6179 6572 732e 2053  ention layers. S
+00004790: 6565 2060 6174 7465 6e74 696f 6e73 6020  ee `attentions` 
+000047a0: 756e 6465 720a 2020 2020 2020 2020 2020  under.          
+000047b0: 2020 2020 2020 7265 7475 726e 6564 2074        returned t
+000047c0: 656e 736f 7273 2066 6f72 206d 6f72 6520  ensors for more 
+000047d0: 6465 7461 696c 2e0a 2020 2020 2020 2020  detail..        
+000047e0: 2222 220a 2020 2020 2020 2020 7265 7369  """.        resi
+000047f0: 6475 616c 203d 2068 6964 6465 6e5f 7374  dual = hidden_st
+00004800: 6174 6573 0a0a 2020 2020 2020 2020 6869  ates..        hi
+00004810: 6464 656e 5f73 7461 7465 7320 3d20 7365  dden_states = se
+00004820: 6c66 2e6c 6179 6572 5f6e 6f72 6d31 2868  lf.layer_norm1(h
+00004830: 6964 6465 6e5f 7374 6174 6573 290a 2020  idden_states).  
+00004840: 2020 2020 2020 6869 6464 656e 5f73 7461        hidden_sta
+00004850: 7465 732c 2061 7474 6e5f 7765 6967 6874  tes, attn_weight
+00004860: 7320 3d20 7365 6c66 2e73 656c 665f 6174  s = self.self_at
+00004870: 746e 280a 2020 2020 2020 2020 2020 2020  tn(.            
+00004880: 6869 6464 656e 5f73 7461 7465 733d 6869  hidden_states=hi
+00004890: 6464 656e 5f73 7461 7465 732c 0a20 2020  dden_states,.   
+000048a0: 2020 2020 2020 2020 2068 6561 645f 6d61           head_ma
+000048b0: 736b 3d61 7474 656e 7469 6f6e 5f6d 6173  sk=attention_mas
+000048c0: 6b2c 0a20 2020 2020 2020 2020 2020 206f  k,.            o
+000048d0: 7574 7075 745f 6174 7465 6e74 696f 6e73  utput_attentions
+000048e0: 3d6f 7574 7075 745f 6174 7465 6e74 696f  =output_attentio
+000048f0: 6e73 2c0a 2020 2020 2020 2020 290a 2020  ns,.        ).  
+00004900: 2020 2020 2020 6869 6464 656e 5f73 7461        hidden_sta
+00004910: 7465 7320 3d20 6869 6464 656e 5f73 7461  tes = hidden_sta
+00004920: 7465 7320 2b20 7265 7369 6475 616c 0a20  tes + residual. 
+00004930: 2020 2020 2020 2072 6573 6964 7561 6c20         residual 
+00004940: 3d20 6869 6464 656e 5f73 7461 7465 730a  = hidden_states.
+00004950: 2020 2020 2020 2020 6869 6464 656e 5f73          hidden_s
+00004960: 7461 7465 7320 3d20 7365 6c66 2e6c 6179  tates = self.lay
+00004970: 6572 5f6e 6f72 6d32 2868 6964 6465 6e5f  er_norm2(hidden_
+00004980: 7374 6174 6573 290a 2020 2020 2020 2020  states).        
+00004990: 6869 6464 656e 5f73 7461 7465 7320 3d20  hidden_states = 
+000049a0: 7365 6c66 2e6d 6c70 2868 6964 6465 6e5f  self.mlp(hidden_
+000049b0: 7374 6174 6573 290a 0a20 2020 2020 2020  states)..       
+000049c0: 2068 6964 6465 6e5f 7374 6174 6573 203d   hidden_states =
+000049d0: 2068 6964 6465 6e5f 7374 6174 6573 202b   hidden_states +
+000049e0: 2072 6573 6964 7561 6c0a 0a20 2020 2020   residual..     
+000049f0: 2020 206f 7574 7075 7473 203d 2028 6869     outputs = (hi
+00004a00: 6464 656e 5f73 7461 7465 732c 290a 0a20  dden_states,).. 
+00004a10: 2020 2020 2020 2069 6620 6f75 7470 7574         if output
+00004a20: 5f61 7474 656e 7469 6f6e 733a 0a20 2020  _attentions:.   
+00004a30: 2020 2020 2020 2020 206f 7574 7075 7473           outputs
+00004a40: 202b 3d20 2861 7474 6e5f 7765 6967 6874   += (attn_weight
+00004a50: 732c 290a 0a20 2020 2020 2020 2072 6574  s,)..        ret
+00004a60: 7572 6e20 6f75 7470 7574 730a 0a0a 636c  urn outputs...cl
+00004a70: 6173 7320 426c 6970 5072 6554 7261 696e  ass BlipPreTrain
+00004a80: 6564 4d6f 6465 6c28 5072 6554 7261 696e  edModel(PreTrain
+00004a90: 6564 4d6f 6465 6c29 3a0a 2020 2020 2222  edModel):.    ""
+00004aa0: 220a 2020 2020 416e 2061 6273 7472 6163  ".    An abstrac
+00004ab0: 7420 636c 6173 7320 746f 2068 616e 646c  t class to handl
+00004ac0: 6520 7765 6967 6874 7320 696e 6974 6961  e weights initia
+00004ad0: 6c69 7a61 7469 6f6e 2061 6e64 2061 2073  lization and a s
+00004ae0: 696d 706c 6520 696e 7465 7266 6163 6520  imple interface 
+00004af0: 666f 7220 646f 776e 6c6f 6164 696e 6720  for downloading 
+00004b00: 616e 6420 6c6f 6164 696e 6720 7072 6574  and loading pret
+00004b10: 7261 696e 6564 0a20 2020 206d 6f64 656c  rained.    model
+00004b20: 732e 0a20 2020 2022 2222 0a0a 2020 2020  s..    """..    
+00004b30: 636f 6e66 6967 5f63 6c61 7373 203d 2042  config_class = B
+00004b40: 6c69 7043 6f6e 6669 670a 2020 2020 6261  lipConfig.    ba
+00004b50: 7365 5f6d 6f64 656c 5f70 7265 6669 7820  se_model_prefix 
+00004b60: 3d20 2262 6c69 7022 0a20 2020 2073 7570  = "blip".    sup
+00004b70: 706f 7274 735f 6772 6164 6965 6e74 5f63  ports_gradient_c
+00004b80: 6865 636b 706f 696e 7469 6e67 203d 2054  heckpointing = T
+00004b90: 7275 650a 0a20 2020 2064 6566 205f 696e  rue..    def _in
+00004ba0: 6974 5f77 6569 6768 7473 2873 656c 662c  it_weights(self,
+00004bb0: 2063 656c 6c29 3a0a 2020 2020 2020 2020   cell):.        
+00004bc0: 2222 2249 6e69 7469 616c 697a 6520 7468  """Initialize th
+00004bd0: 6520 7765 6967 6874 7322 2222 0a20 2020  e weights""".   
+00004be0: 2020 2020 2066 6163 746f 7220 3d20 7365       factor = se
+00004bf0: 6c66 2e63 6f6e 6669 672e 696e 6974 6961  lf.config.initia
+00004c00: 6c69 7a65 725f 7261 6e67 650a 2020 2020  lizer_range.    
+00004c10: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+00004c20: 6528 6365 6c6c 2c20 286e 6e2e 436f 6e76  e(cell, (nn.Conv
+00004c30: 3264 2c20 6e6e 2e44 656e 7365 2c20 6e6e  2d, nn.Dense, nn
+00004c40: 2e45 6d62 6564 6469 6e67 2929 3a0a 2020  .Embedding)):.  
+00004c50: 2020 2020 2020 2020 2020 6365 6c6c 2e77            cell.w
+00004c60: 6569 6768 742e 7365 745f 6461 7461 2869  eight.set_data(i
+00004c70: 6e69 7469 616c 697a 6572 284e 6f72 6d61  nitializer(Norma
+00004c80: 6c28 6661 6374 6f72 292c 2063 656c 6c2e  l(factor), cell.
+00004c90: 7765 6967 6874 2e73 6861 7065 2c20 6365  weight.shape, ce
+00004ca0: 6c6c 2e77 6569 6768 742e 6474 7970 6529  ll.weight.dtype)
+00004cb0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+00004cc0: 2068 6173 6174 7472 2863 656c 6c2c 2022   hasattr(cell, "
+00004cd0: 6269 6173 2229 2061 6e64 2063 656c 6c2e  bias") and cell.
+00004ce0: 6269 6173 2069 7320 6e6f 7420 4e6f 6e65  bias is not None
+00004cf0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00004d00: 2020 6365 6c6c 2e62 6961 732e 7365 745f    cell.bias.set_
+00004d10: 6461 7461 2869 6e69 7469 616c 697a 6572  data(initializer
+00004d20: 2827 7a65 726f 7327 2c20 6365 6c6c 2e62  ('zeros', cell.b
+00004d30: 6961 732e 7368 6170 652c 2063 656c 6c2e  ias.shape, cell.
+00004d40: 6269 6173 2e64 7479 7065 2929 0a0a 2020  bias.dtype))..  
+00004d50: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+00004d60: 6e63 6528 6365 6c6c 2c20 426c 6970 5669  nce(cell, BlipVi
+00004d70: 7369 6f6e 456d 6265 6464 696e 6773 293a  sionEmbeddings):
+00004d80: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00004d90: 6861 7361 7474 7228 7365 6c66 2e63 6f6e  hasattr(self.con
+00004da0: 6669 672c 2022 7669 7369 6f6e 5f63 6f6e  fig, "vision_con
+00004db0: 6669 6722 293a 0a20 2020 2020 2020 2020  fig"):.         
+00004dc0: 2020 2020 2020 2066 6163 746f 7220 3d20         factor = 
+00004dd0: 7365 6c66 2e63 6f6e 6669 672e 7669 7369  self.config.visi
+00004de0: 6f6e 5f63 6f6e 6669 672e 696e 6974 6961  on_config.initia
+00004df0: 6c69 7a65 725f 7261 6e67 650a 0a20 2020  lizer_range..   
+00004e00: 2020 2020 2020 2020 2063 656c 6c2e 706f           cell.po
+00004e10: 7369 7469 6f6e 5f65 6d62 6564 6469 6e67  sition_embedding
+00004e20: 2e73 6574 5f64 6174 6128 696e 6974 6961  .set_data(initia
+00004e30: 6c69 7a65 7228 5472 756e 6361 7465 644e  lizer(TruncatedN
+00004e40: 6f72 6d61 6c28 6661 6374 6f72 292c 2063  ormal(factor), c
+00004e50: 656c 6c2e 706f 7369 7469 6f6e 5f65 6d62  ell.position_emb
+00004e60: 6564 6469 6e67 2e73 6861 7065 2c20 6365  edding.shape, ce
+00004e70: 6c6c 2e70 6f73 6974 696f 6e5f 656d 6265  ll.position_embe
+00004e80: 6464 696e 672e 6474 7970 6529 290a 2020  dding.dtype)).  
+00004e90: 2020 2020 2020 2020 2020 6365 6c6c 2e63            cell.c
+00004ea0: 6c61 7373 5f65 6d62 6564 6469 6e67 2e73  lass_embedding.s
+00004eb0: 6574 5f64 6174 6128 696e 6974 6961 6c69  et_data(initiali
+00004ec0: 7a65 7228 5472 756e 6361 7465 644e 6f72  zer(TruncatedNor
+00004ed0: 6d61 6c28 6661 6374 6f72 292c 2063 656c  mal(factor), cel
+00004ee0: 6c2e 636c 6173 735f 656d 6265 6464 696e  l.class_embeddin
+00004ef0: 672e 7368 6170 652c 2063 656c 6c2e 636c  g.shape, cell.cl
+00004f00: 6173 735f 656d 6265 6464 696e 672e 6474  ass_embedding.dt
+00004f10: 7970 6529 290a 0a20 2020 2020 2020 2065  ype))..        e
+00004f20: 6c69 6620 6973 696e 7374 616e 6365 2863  lif isinstance(c
+00004f30: 656c 6c2c 206e 6e2e 4c61 7965 724e 6f72  ell, nn.LayerNor
+00004f40: 6d29 3a0a 2020 2020 2020 2020 2020 2020  m):.            
+00004f50: 6365 6c6c 2e77 6569 6768 742e 7365 745f  cell.weight.set_
+00004f60: 6461 7461 2869 6e69 7469 616c 697a 6572  data(initializer
+00004f70: 2827 6f6e 6573 272c 2063 656c 6c2e 7765  ('ones', cell.we
+00004f80: 6967 6874 2e73 6861 7065 2c20 6365 6c6c  ight.shape, cell
+00004f90: 2e77 6569 6768 742e 6474 7970 6529 290a  .weight.dtype)).
+00004fa0: 2020 2020 2020 2020 2020 2020 6365 6c6c              cell
+00004fb0: 2e62 6961 732e 7365 745f 6461 7461 2869  .bias.set_data(i
+00004fc0: 6e69 7469 616c 697a 6572 2827 7a65 726f  nitializer('zero
+00004fd0: 7327 2c20 6365 6c6c 2e62 6961 732e 7368  s', cell.bias.sh
+00004fe0: 6170 652c 2063 656c 6c2e 6269 6173 2e64  ape, cell.bias.d
+00004ff0: 7479 7065 2929 0a0a 2020 2020 2020 2020  type))..        
+00005000: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
+00005010: 6365 6c6c 2c20 6e6e 2e44 656e 7365 2920  cell, nn.Dense) 
+00005020: 616e 6420 6365 6c6c 2e62 6961 7320 6973  and cell.bias is
+00005030: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00005040: 2020 2020 2020 2063 656c 6c2e 6269 6173         cell.bias
+00005050: 2e73 6574 5f64 6174 6128 696e 6974 6961  .set_data(initia
+00005060: 6c69 7a65 7228 277a 6572 6f73 272c 2063  lizer('zeros', c
+00005070: 656c 6c2e 6269 6173 2e73 6861 7065 2c20  ell.bias.shape, 
+00005080: 6365 6c6c 2e62 6961 732e 6474 7970 6529  cell.bias.dtype)
+00005090: 290a 0a0a 636c 6173 7320 426c 6970 456e  )...class BlipEn
+000050a0: 636f 6465 7228 6e6e 2e43 656c 6c29 3a0a  coder(nn.Cell):.
+000050b0: 2020 2020 2222 220a 2020 2020 5472 616e      """.    Tran
+000050c0: 7366 6f72 6d65 7220 656e 636f 6465 7220  sformer encoder 
+000050d0: 636f 6e73 6973 7469 6e67 206f 6620 6063  consisting of `c
+000050e0: 6f6e 6669 672e 6e75 6d5f 6869 6464 656e  onfig.num_hidden
+000050f0: 5f6c 6179 6572 7360 2073 656c 6620 6174  _layers` self at
+00005100: 7465 6e74 696f 6e20 6c61 7965 7273 2e20  tention layers. 
+00005110: 4561 6368 206c 6179 6572 2069 7320 610a  Each layer is a.
+00005120: 2020 2020 5b60 426c 6970 456e 636f 6465      [`BlipEncode
+00005130: 724c 6179 6572 605d 2e0a 0a20 2020 2041  rLayer`]...    A
+00005140: 7267 733a 0a20 2020 2020 2020 2063 6f6e  rgs:.        con
+00005150: 6669 6720 2860 426c 6970 436f 6e66 6967  fig (`BlipConfig
+00005160: 6029 3a0a 2020 2020 2020 2020 2020 2020  `):.            
+00005170: 5468 6520 636f 7272 6573 706f 6e64 696e  The correspondin
+00005180: 6720 7669 7369 6f6e 2063 6f6e 6669 6775  g vision configu
+00005190: 7261 7469 6f6e 2066 6f72 2074 6865 2060  ration for the `
+000051a0: 426c 6970 456e 636f 6465 7260 2e0a 2020  BlipEncoder`..  
+000051b0: 2020 2222 220a 0a20 2020 2064 6566 205f    """..    def _
+000051c0: 5f69 6e69 745f 5f28 7365 6c66 2c20 636f  _init__(self, co
+000051d0: 6e66 6967 3a20 426c 6970 436f 6e66 6967  nfig: BlipConfig
+000051e0: 293a 0a20 2020 2020 2020 2073 7570 6572  ):.        super
+000051f0: 2829 2e5f 5f69 6e69 745f 5f28 290a 2020  ().__init__().  
+00005200: 2020 2020 2020 7365 6c66 2e63 6f6e 6669        self.confi
+00005210: 6720 3d20 636f 6e66 6967 0a20 2020 2020  g = config.     
+00005220: 2020 2073 656c 662e 6c61 7965 7273 203d     self.layers =
+00005230: 206e 6e2e 4365 6c6c 4c69 7374 285b 426c   nn.CellList([Bl
+00005240: 6970 456e 636f 6465 724c 6179 6572 2863  ipEncoderLayer(c
+00005250: 6f6e 6669 6729 2066 6f72 205f 2069 6e20  onfig) for _ in 
+00005260: 7261 6e67 6528 636f 6e66 6967 2e6e 756d  range(config.num
+00005270: 5f68 6964 6465 6e5f 6c61 7965 7273 295d  _hidden_layers)]
+00005280: 290a 2020 2020 2020 2020 7365 6c66 2e67  ).        self.g
+00005290: 7261 6469 656e 745f 6368 6563 6b70 6f69  radient_checkpoi
+000052a0: 6e74 696e 6720 3d20 4661 6c73 650a 0a20  nting = False.. 
+000052b0: 2020 2064 6566 2063 6f6e 7374 7275 6374     def construct
+000052c0: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+000052d0: 2020 2020 2020 2020 696e 7075 7473 5f65          inputs_e
+000052e0: 6d62 6564 732c 0a20 2020 2020 2020 2061  mbeds,.        a
+000052f0: 7474 656e 7469 6f6e 5f6d 6173 6b3a 204f  ttention_mask: O
+00005300: 7074 696f 6e61 6c5b 6d69 6e64 7370 6f72  ptional[mindspor
+00005310: 652e 5465 6e73 6f72 5d20 3d20 4e6f 6e65  e.Tensor] = None
+00005320: 2c0a 2020 2020 2020 2020 6f75 7470 7574  ,.        output
+00005330: 5f61 7474 656e 7469 6f6e 733a 204f 7074  _attentions: Opt
+00005340: 696f 6e61 6c5b 626f 6f6c 5d20 3d20 4e6f  ional[bool] = No
+00005350: 6e65 2c0a 2020 2020 2020 2020 6f75 7470  ne,.        outp
+00005360: 7574 5f68 6964 6465 6e5f 7374 6174 6573  ut_hidden_states
+00005370: 3a20 4f70 7469 6f6e 616c 5b62 6f6f 6c5d  : Optional[bool]
+00005380: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00005390: 2072 6574 7572 6e5f 6469 6374 3a20 4f70   return_dict: Op
+000053a0: 7469 6f6e 616c 5b62 6f6f 6c5d 203d 204e  tional[bool] = N
+000053b0: 6f6e 652c 0a20 2020 2029 202d 3e20 556e  one,.    ) -> Un
+000053c0: 696f 6e5b 5475 706c 652c 2042 6173 654d  ion[Tuple, BaseM
+000053d0: 6f64 656c 4f75 7470 7574 5d3a 0a20 2020  odelOutput]:.   
+000053e0: 2020 2020 2072 2222 220a 2020 2020 2020       r""".      
+000053f0: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+00005400: 2020 2020 696e 7075 7473 5f65 6d62 6564      inputs_embed
+00005410: 7320 2860 6d69 6e64 7370 6f72 652e 5465  s (`mindspore.Te
+00005420: 6e73 6f72 6020 6f66 2073 6861 7065 2060  nsor` of shape `
+00005430: 2862 6174 6368 5f73 697a 652c 2073 6571  (batch_size, seq
+00005440: 7565 6e63 655f 6c65 6e67 7468 2c20 6869  uence_length, hi
+00005450: 6464 656e 5f73 697a 6529 6029 3a0a 2020  dden_size)`):.  
+00005460: 2020 2020 2020 2020 2020 2020 2020 456d                Em
+00005470: 6265 6464 6564 2072 6570 7265 7365 6e74  bedded represent
+00005480: 6174 696f 6e20 6f66 2074 6865 2069 6e70  ation of the inp
+00005490: 7574 732e 2053 686f 756c 6420 6265 2066  uts. Should be f
+000054a0: 6c6f 6174 2c20 6e6f 7420 696e 7420 746f  loat, not int to
+000054b0: 6b65 6e73 2e0a 2020 2020 2020 2020 2020  kens..          
+000054c0: 2020 6174 7465 6e74 696f 6e5f 6d61 736b    attention_mask
+000054d0: 2028 606d 696e 6473 706f 7265 2e54 656e   (`mindspore.Ten
+000054e0: 736f 7260 206f 6620 7368 6170 6520 6028  sor` of shape `(
+000054f0: 6261 7463 685f 7369 7a65 2c20 7365 7175  batch_size, sequ
+00005500: 656e 6365 5f6c 656e 6774 6829 602c 202a  ence_length)`, *
+00005510: 6f70 7469 6f6e 616c 2a29 3a0a 2020 2020  optional*):.    
+00005520: 2020 2020 2020 2020 2020 2020 4d61 736b              Mask
+00005530: 2074 6f20 6176 6f69 6420 7065 7266 6f72   to avoid perfor
+00005540: 6d69 6e67 2061 7474 656e 7469 6f6e 206f  ming attention o
+00005550: 6e20 7061 6464 696e 6720 746f 6b65 6e20  n padding token 
+00005560: 696e 6469 6365 732e 204d 6173 6b20 7661  indices. Mask va
+00005570: 6c75 6573 2073 656c 6563 7465 6420 696e  lues selected in
+00005580: 2060 5b30 2c20 315d 603a 0a0a 2020 2020   `[0, 1]`:..    
+00005590: 2020 2020 2020 2020 2020 2020 2d20 3120              - 1 
+000055a0: 666f 7220 746f 6b65 6e73 2074 6861 7420  for tokens that 
+000055b0: 6172 6520 2a2a 6e6f 7420 6d61 736b 6564  are **not masked
+000055c0: 2a2a 2c0a 2020 2020 2020 2020 2020 2020  **,.            
+000055d0: 2020 2020 2d20 3020 666f 7220 746f 6b65      - 0 for toke
+000055e0: 6e73 2074 6861 7420 6172 6520 2a2a 6d61  ns that are **ma
+000055f0: 736b 6564 2a2a 2e0a 0a20 2020 2020 2020  sked**...       
+00005600: 2020 2020 2020 2020 205b 5768 6174 2061           [What a
+00005610: 7265 2061 7474 656e 7469 6f6e 206d 6173  re attention mas
+00005620: 6b73 3f5d 282e 2e2f 676c 6f73 7361 7279  ks?](../glossary
+00005630: 2361 7474 656e 7469 6f6e 2d6d 6173 6b29  #attention-mask)
+00005640: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
+00005650: 7075 745f 6174 7465 6e74 696f 6e73 2028  put_attentions (
+00005660: 6062 6f6f 6c60 2c20 2a6f 7074 696f 6e61  `bool`, *optiona
+00005670: 6c2a 293a 0a20 2020 2020 2020 2020 2020  l*):.           
+00005680: 2020 2020 2057 6865 7468 6572 206f 7220       Whether or 
+00005690: 6e6f 7420 746f 2072 6574 7572 6e20 7468  not to return th
+000056a0: 6520 6174 7465 6e74 696f 6e73 2074 656e  e attentions ten
+000056b0: 736f 7273 206f 6620 616c 6c20 6174 7465  sors of all atte
+000056c0: 6e74 696f 6e20 6c61 7965 7273 2e20 5365  ntion layers. Se
+000056d0: 6520 6061 7474 656e 7469 6f6e 7360 2075  e `attentions` u
+000056e0: 6e64 6572 0a20 2020 2020 2020 2020 2020  nder.           
+000056f0: 2020 2020 2072 6574 7572 6e65 6420 7465       returned te
+00005700: 6e73 6f72 7320 666f 7220 6d6f 7265 2064  nsors for more d
+00005710: 6574 6169 6c2e 0a20 2020 2020 2020 2020  etail..         
+00005720: 2020 206f 7574 7075 745f 6869 6464 656e     output_hidden
+00005730: 5f73 7461 7465 7320 2860 626f 6f6c 602c  _states (`bool`,
+00005740: 202a 6f70 7469 6f6e 616c 2a29 3a0a 2020   *optional*):.  
+00005750: 2020 2020 2020 2020 2020 2020 2020 5768                Wh
+00005760: 6574 6865 7220 6f72 206e 6f74 2074 6f20  ether or not to 
+00005770: 7265 7475 726e 2074 6865 2068 6964 6465  return the hidde
+00005780: 6e20 7374 6174 6573 206f 6620 616c 6c20  n states of all 
+00005790: 6c61 7965 7273 2e20 5365 6520 6068 6964  layers. See `hid
+000057a0: 6465 6e5f 7374 6174 6573 6020 756e 6465  den_states` unde
+000057b0: 7220 7265 7475 726e 6564 2074 656e 736f  r returned tenso
+000057c0: 7273 0a20 2020 2020 2020 2020 2020 2020  rs.             
+000057d0: 2020 2066 6f72 206d 6f72 6520 6465 7461     for more deta
+000057e0: 696c 2e0a 2020 2020 2020 2020 2020 2020  il..            
+000057f0: 7265 7475 726e 5f64 6963 7420 2860 626f  return_dict (`bo
+00005800: 6f6c 602c 202a 6f70 7469 6f6e 616c 2a29  ol`, *optional*)
+00005810: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00005820: 2020 5768 6574 6865 7220 6f72 206e 6f74    Whether or not
+00005830: 2074 6f20 7265 7475 726e 2061 205b 607e   to return a [`~
+00005840: 7574 696c 732e 4d6f 6465 6c4f 7574 7075  utils.ModelOutpu
+00005850: 7460 5d20 696e 7374 6561 6420 6f66 2061  t`] instead of a
+00005860: 2070 6c61 696e 2074 7570 6c65 2e0a 2020   plain tuple..  
+00005870: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00005880: 2020 6f75 7470 7574 5f61 7474 656e 7469    output_attenti
+00005890: 6f6e 7320 3d20 6f75 7470 7574 5f61 7474  ons = output_att
+000058a0: 656e 7469 6f6e 7320 6966 206f 7574 7075  entions if outpu
+000058b0: 745f 6174 7465 6e74 696f 6e73 2069 7320  t_attentions is 
+000058c0: 6e6f 7420 4e6f 6e65 2065 6c73 6520 7365  not None else se
+000058d0: 6c66 2e63 6f6e 6669 672e 6f75 7470 7574  lf.config.output
+000058e0: 5f61 7474 656e 7469 6f6e 730a 2020 2020  _attentions.    
+000058f0: 2020 2020 6f75 7470 7574 5f68 6964 6465      output_hidde
+00005900: 6e5f 7374 6174 6573 203d 2028 0a20 2020  n_states = (.   
+00005910: 2020 2020 2020 2020 206f 7574 7075 745f           output_
+00005920: 6869 6464 656e 5f73 7461 7465 7320 6966  hidden_states if
+00005930: 206f 7574 7075 745f 6869 6464 656e 5f73   output_hidden_s
+00005940: 7461 7465 7320 6973 206e 6f74 204e 6f6e  tates is not Non
+00005950: 6520 656c 7365 2073 656c 662e 636f 6e66  e else self.conf
+00005960: 6967 2e6f 7574 7075 745f 6869 6464 656e  ig.output_hidden
+00005970: 5f73 7461 7465 730a 2020 2020 2020 2020  _states.        
+00005980: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00005990: 5f64 6963 7420 3d20 7265 7475 726e 5f64  _dict = return_d
+000059a0: 6963 7420 6966 2072 6574 7572 6e5f 6469  ict if return_di
+000059b0: 6374 2069 7320 6e6f 7420 4e6f 6e65 2065  ct is not None e
+000059c0: 6c73 6520 7365 6c66 2e63 6f6e 6669 672e  lse self.config.
+000059d0: 7573 655f 7265 7475 726e 5f64 6963 740a  use_return_dict.
+000059e0: 0a20 2020 2020 2020 2065 6e63 6f64 6572  .        encoder
+000059f0: 5f73 7461 7465 7320 3d20 2829 2069 6620  _states = () if 
+00005a00: 6f75 7470 7574 5f68 6964 6465 6e5f 7374  output_hidden_st
+00005a10: 6174 6573 2065 6c73 6520 4e6f 6e65 0a20  ates else None. 
+00005a20: 2020 2020 2020 2061 6c6c 5f61 7474 656e         all_atten
+00005a30: 7469 6f6e 7320 3d20 2829 2069 6620 6f75  tions = () if ou
+00005a40: 7470 7574 5f61 7474 656e 7469 6f6e 7320  tput_attentions 
+00005a50: 656c 7365 204e 6f6e 650a 0a20 2020 2020  else None..     
+00005a60: 2020 2068 6964 6465 6e5f 7374 6174 6573     hidden_states
+00005a70: 203d 2069 6e70 7574 735f 656d 6265 6473   = inputs_embeds
+00005a80: 0a20 2020 2020 2020 2066 6f72 2069 6478  .        for idx
+00005a90: 2c20 656e 636f 6465 725f 6c61 7965 7220  , encoder_layer 
+00005aa0: 696e 2065 6e75 6d65 7261 7465 2873 656c  in enumerate(sel
+00005ab0: 662e 6c61 7965 7273 293a 0a20 2020 2020  f.layers):.     
+00005ac0: 2020 2020 2020 2069 6620 6f75 7470 7574         if output
+00005ad0: 5f68 6964 6465 6e5f 7374 6174 6573 3a0a  _hidden_states:.
+00005ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005af0: 656e 636f 6465 725f 7374 6174 6573 203d  encoder_states =
+00005b00: 2065 6e63 6f64 6572 5f73 7461 7465 7320   encoder_states 
+00005b10: 2b20 2868 6964 6465 6e5f 7374 6174 6573  + (hidden_states
+00005b20: 2c29 0a20 2020 2020 2020 2020 2020 2069  ,).            i
+00005b30: 6620 7365 6c66 2e67 7261 6469 656e 745f  f self.gradient_
+00005b40: 6368 6563 6b70 6f69 6e74 696e 6720 616e  checkpointing an
+00005b50: 6420 7365 6c66 2e74 7261 696e 696e 673a  d self.training:
+00005b60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005b70: 206c 6179 6572 5f6f 7574 7075 7473 203d   layer_outputs =
+00005b80: 2073 656c 662e 5f67 7261 6469 656e 745f   self._gradient_
+00005b90: 6368 6563 6b70 6f69 6e74 696e 675f 6675  checkpointing_fu
+00005ba0: 6e63 280a 2020 2020 2020 2020 2020 2020  nc(.            
+00005bb0: 2020 2020 2020 2020 656e 636f 6465 725f          encoder_
+00005bc0: 6c61 7965 722e 5f5f 6361 6c6c 5f5f 2c0a  layer.__call__,.
+00005bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005be0: 2020 2020 6869 6464 656e 5f73 7461 7465      hidden_state
+00005bf0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+00005c00: 2020 2020 2020 2061 7474 656e 7469 6f6e         attention
+00005c10: 5f6d 6173 6b2c 0a20 2020 2020 2020 2020  _mask,.         
+00005c20: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
+00005c30: 745f 6174 7465 6e74 696f 6e73 2c0a 2020  t_attentions,.  
+00005c40: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00005c50: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00005c60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00005c70: 2020 6c61 7965 725f 6f75 7470 7574 7320    layer_outputs 
+00005c80: 3d20 656e 636f 6465 725f 6c61 7965 7228  = encoder_layer(
+00005c90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005ca0: 2020 2020 2068 6964 6465 6e5f 7374 6174       hidden_stat
+00005cb0: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+00005cc0: 2020 2020 2020 2020 6174 7465 6e74 696f          attentio
+00005cd0: 6e5f 6d61 736b 2c0a 2020 2020 2020 2020  n_mask,.        
+00005ce0: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
+00005cf0: 7574 5f61 7474 656e 7469 6f6e 733d 6f75  ut_attentions=ou
+00005d00: 7470 7574 5f61 7474 656e 7469 6f6e 732c  tput_attentions,
+00005d10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005d20: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
+00005d30: 6869 6464 656e 5f73 7461 7465 7320 3d20  hidden_states = 
+00005d40: 6c61 7965 725f 6f75 7470 7574 735b 305d  layer_outputs[0]
+00005d50: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+00005d60: 206f 7574 7075 745f 6174 7465 6e74 696f   output_attentio
+00005d70: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
+00005d80: 2020 2020 616c 6c5f 6174 7465 6e74 696f      all_attentio
+00005d90: 6e73 203d 2061 6c6c 5f61 7474 656e 7469  ns = all_attenti
+00005da0: 6f6e 7320 2b20 286c 6179 6572 5f6f 7574  ons + (layer_out
+00005db0: 7075 7473 5b31 5d2c 290a 0a20 2020 2020  puts[1],)..     
+00005dc0: 2020 2069 6620 6f75 7470 7574 5f68 6964     if output_hid
+00005dd0: 6465 6e5f 7374 6174 6573 3a0a 2020 2020  den_states:.    
+00005de0: 2020 2020 2020 2020 656e 636f 6465 725f          encoder_
+00005df0: 7374 6174 6573 203d 2065 6e63 6f64 6572  states = encoder
+00005e00: 5f73 7461 7465 7320 2b20 2868 6964 6465  _states + (hidde
+00005e10: 6e5f 7374 6174 6573 2c29 0a0a 2020 2020  n_states,)..    
+00005e20: 2020 2020 6966 206e 6f74 2072 6574 7572      if not retur
+00005e30: 6e5f 6469 6374 3a0a 2020 2020 2020 2020  n_dict:.        
+00005e40: 2020 2020 7265 7475 726e 2074 7570 6c65      return tuple
+00005e50: 2876 2066 6f72 2076 2069 6e20 5b68 6964  (v for v in [hid
+00005e60: 6465 6e5f 7374 6174 6573 2c20 656e 636f  den_states, enco
+00005e70: 6465 725f 7374 6174 6573 2c20 616c 6c5f  der_states, all_
+00005e80: 6174 7465 6e74 696f 6e73 5d20 6966 2076  attentions] if v
+00005e90: 2069 7320 6e6f 7420 4e6f 6e65 290a 2020   is not None).  
+00005ea0: 2020 2020 2020 7265 7475 726e 2042 6173        return Bas
+00005eb0: 654d 6f64 656c 4f75 7470 7574 280a 2020  eModelOutput(.  
+00005ec0: 2020 2020 2020 2020 2020 6c61 7374 5f68            last_h
+00005ed0: 6964 6465 6e5f 7374 6174 653d 6869 6464  idden_state=hidd
+00005ee0: 656e 5f73 7461 7465 732c 2068 6964 6465  en_states, hidde
+00005ef0: 6e5f 7374 6174 6573 3d65 6e63 6f64 6572  n_states=encoder
+00005f00: 5f73 7461 7465 732c 2061 7474 656e 7469  _states, attenti
+00005f10: 6f6e 733d 616c 6c5f 6174 7465 6e74 696f  ons=all_attentio
+00005f20: 6e73 0a20 2020 2020 2020 2029 0a0a 0a63  ns.        )...c
+00005f30: 6c61 7373 2042 6c69 7056 6973 696f 6e4d  lass BlipVisionM
+00005f40: 6f64 656c 2842 6c69 7050 7265 5472 6169  odel(BlipPreTrai
+00005f50: 6e65 644d 6f64 656c 293a 0a20 2020 206d  nedModel):.    m
+00005f60: 6169 6e5f 696e 7075 745f 6e61 6d65 203d  ain_input_name =
+00005f70: 2022 7069 7865 6c5f 7661 6c75 6573 220a   "pixel_values".
+00005f80: 2020 2020 636f 6e66 6967 5f63 6c61 7373      config_class
+00005f90: 203d 2042 6c69 7056 6973 696f 6e43 6f6e   = BlipVisionCon
+00005fa0: 6669 670a 0a20 2020 2064 6566 205f 5f69  fig..    def __i
+00005fb0: 6e69 745f 5f28 7365 6c66 2c20 636f 6e66  nit__(self, conf
+00005fc0: 6967 3a20 426c 6970 5669 7369 6f6e 436f  ig: BlipVisionCo
+00005fd0: 6e66 6967 293a 0a20 2020 2020 2020 2073  nfig):.        s
+00005fe0: 7570 6572 2829 2e5f 5f69 6e69 745f 5f28  uper().__init__(
+00005ff0: 636f 6e66 6967 290a 2020 2020 2020 2020  config).        
+00006000: 7365 6c66 2e63 6f6e 6669 6720 3d20 636f  self.config = co
+00006010: 6e66 6967 0a20 2020 2020 2020 2065 6d62  nfig.        emb
+00006020: 6564 5f64 696d 203d 2063 6f6e 6669 672e  ed_dim = config.
+00006030: 6869 6464 656e 5f73 697a 650a 0a20 2020  hidden_size..   
+00006040: 2020 2020 2073 656c 662e 656d 6265 6464       self.embedd
+00006050: 696e 6773 203d 2042 6c69 7056 6973 696f  ings = BlipVisio
+00006060: 6e45 6d62 6564 6469 6e67 7328 636f 6e66  nEmbeddings(conf
+00006070: 6967 290a 2020 2020 2020 2020 7365 6c66  ig).        self
+00006080: 2e65 6e63 6f64 6572 203d 2042 6c69 7045  .encoder = BlipE
+00006090: 6e63 6f64 6572 2863 6f6e 6669 6729 0a20  ncoder(config). 
+000060a0: 2020 2020 2020 2073 656c 662e 706f 7374         self.post
+000060b0: 5f6c 6179 6572 6e6f 726d 203d 206e 6e2e  _layernorm = nn.
+000060c0: 4c61 7965 724e 6f72 6d28 656d 6265 645f  LayerNorm(embed_
+000060d0: 6469 6d2c 2065 7073 696c 6f6e 3d63 6f6e  dim, epsilon=con
+000060e0: 6669 672e 6c61 7965 725f 6e6f 726d 5f65  fig.layer_norm_e
+000060f0: 7073 290a 0a20 2020 2020 2020 2073 656c  ps)..        sel
+00006100: 662e 706f 7374 5f69 6e69 7428 290a 0a20  f.post_init().. 
+00006110: 2020 2064 6566 2063 6f6e 7374 7275 6374     def construct
+00006120: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+00006130: 2020 2020 2020 2020 7069 7865 6c5f 7661          pixel_va
+00006140: 6c75 6573 3a20 4f70 7469 6f6e 616c 5b6d  lues: Optional[m
+00006150: 696e 6473 706f 7265 2e54 656e 736f 725d  indspore.Tensor]
+00006160: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00006170: 206f 7574 7075 745f 6174 7465 6e74 696f   output_attentio
+00006180: 6e73 3a20 4f70 7469 6f6e 616c 5b62 6f6f  ns: Optional[boo
+00006190: 6c5d 203d 204e 6f6e 652c 0a20 2020 2020  l] = None,.     
+000061a0: 2020 206f 7574 7075 745f 6869 6464 656e     output_hidden
+000061b0: 5f73 7461 7465 733a 204f 7074 696f 6e61  _states: Optiona
+000061c0: 6c5b 626f 6f6c 5d20 3d20 4e6f 6e65 2c0a  l[bool] = None,.
+000061d0: 2020 2020 2020 2020 7265 7475 726e 5f64          return_d
+000061e0: 6963 743a 204f 7074 696f 6e61 6c5b 626f  ict: Optional[bo
+000061f0: 6f6c 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ol] = None,.    
+00006200: 2920 2d3e 2055 6e69 6f6e 5b54 7570 6c65  ) -> Union[Tuple
+00006210: 2c20 4261 7365 4d6f 6465 6c4f 7574 7075  , BaseModelOutpu
+00006220: 7457 6974 6850 6f6f 6c69 6e67 5d3a 0a20  tWithPooling]:. 
+00006230: 2020 2020 2020 2072 2222 220a 2020 2020         r""".    
+00006240: 2020 2020 5265 7475 726e 733a 0a0a 2020      Returns:..  
+00006250: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00006260: 2020 6f75 7470 7574 5f61 7474 656e 7469    output_attenti
+00006270: 6f6e 7320 3d20 6f75 7470 7574 5f61 7474  ons = output_att
+00006280: 656e 7469 6f6e 7320 6966 206f 7574 7075  entions if outpu
+00006290: 745f 6174 7465 6e74 696f 6e73 2069 7320  t_attentions is 
+000062a0: 6e6f 7420 4e6f 6e65 2065 6c73 6520 7365  not None else se
+000062b0: 6c66 2e63 6f6e 6669 672e 6f75 7470 7574  lf.config.output
+000062c0: 5f61 7474 656e 7469 6f6e 730a 2020 2020  _attentions.    
+000062d0: 2020 2020 6f75 7470 7574 5f68 6964 6465      output_hidde
+000062e0: 6e5f 7374 6174 6573 203d 2028 0a20 2020  n_states = (.   
+000062f0: 2020 2020 2020 2020 206f 7574 7075 745f           output_
+00006300: 6869 6464 656e 5f73 7461 7465 7320 6966  hidden_states if
+00006310: 206f 7574 7075 745f 6869 6464 656e 5f73   output_hidden_s
+00006320: 7461 7465 7320 6973 206e 6f74 204e 6f6e  tates is not Non
+00006330: 6520 656c 7365 2073 656c 662e 636f 6e66  e else self.conf
+00006340: 6967 2e6f 7574 7075 745f 6869 6464 656e  ig.output_hidden
+00006350: 5f73 7461 7465 730a 2020 2020 2020 2020  _states.        
+00006360: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00006370: 5f64 6963 7420 3d20 7265 7475 726e 5f64  _dict = return_d
+00006380: 6963 7420 6966 2072 6574 7572 6e5f 6469  ict if return_di
+00006390: 6374 2069 7320 6e6f 7420 4e6f 6e65 2065  ct is not None e
+000063a0: 6c73 6520 7365 6c66 2e63 6f6e 6669 672e  lse self.config.
+000063b0: 7573 655f 7265 7475 726e 5f64 6963 740a  use_return_dict.
+000063c0: 0a20 2020 2020 2020 2069 6620 7069 7865  .        if pixe
+000063d0: 6c5f 7661 6c75 6573 2069 7320 4e6f 6e65  l_values is None
+000063e0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+000063f0: 6973 6520 5661 6c75 6545 7272 6f72 2822  ise ValueError("
+00006400: 596f 7520 6861 7665 2074 6f20 7370 6563  You have to spec
+00006410: 6966 7920 7069 7865 6c5f 7661 6c75 6573  ify pixel_values
+00006420: 2229 0a0a 2020 2020 2020 2020 6869 6464  ")..        hidd
+00006430: 656e 5f73 7461 7465 7320 3d20 7365 6c66  en_states = self
+00006440: 2e65 6d62 6564 6469 6e67 7328 7069 7865  .embeddings(pixe
+00006450: 6c5f 7661 6c75 6573 290a 0a20 2020 2020  l_values)..     
+00006460: 2020 2065 6e63 6f64 6572 5f6f 7574 7075     encoder_outpu
+00006470: 7473 203d 2073 656c 662e 656e 636f 6465  ts = self.encode
+00006480: 7228 0a20 2020 2020 2020 2020 2020 2069  r(.            i
+00006490: 6e70 7574 735f 656d 6265 6473 3d68 6964  nputs_embeds=hid
+000064a0: 6465 6e5f 7374 6174 6573 2c0a 2020 2020  den_states,.    
+000064b0: 2020 2020 2020 2020 6f75 7470 7574 5f61          output_a
+000064c0: 7474 656e 7469 6f6e 733d 6f75 7470 7574  ttentions=output
+000064d0: 5f61 7474 656e 7469 6f6e 732c 0a20 2020  _attentions,.   
+000064e0: 2020 2020 2020 2020 206f 7574 7075 745f           output_
+000064f0: 6869 6464 656e 5f73 7461 7465 733d 6f75  hidden_states=ou
+00006500: 7470 7574 5f68 6964 6465 6e5f 7374 6174  tput_hidden_stat
+00006510: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+00006520: 7265 7475 726e 5f64 6963 743d 7265 7475  return_dict=retu
+00006530: 726e 5f64 6963 742c 0a20 2020 2020 2020  rn_dict,.       
+00006540: 2029 0a0a 2020 2020 2020 2020 6c61 7374   )..        last
+00006550: 5f68 6964 6465 6e5f 7374 6174 6520 3d20  _hidden_state = 
+00006560: 656e 636f 6465 725f 6f75 7470 7574 735b  encoder_outputs[
+00006570: 305d 0a20 2020 2020 2020 206c 6173 745f  0].        last_
+00006580: 6869 6464 656e 5f73 7461 7465 203d 2073  hidden_state = s
+00006590: 656c 662e 706f 7374 5f6c 6179 6572 6e6f  elf.post_layerno
+000065a0: 726d 286c 6173 745f 6869 6464 656e 5f73  rm(last_hidden_s
+000065b0: 7461 7465 290a 0a20 2020 2020 2020 2070  tate)..        p
+000065c0: 6f6f 6c65 645f 6f75 7470 7574 203d 206c  ooled_output = l
+000065d0: 6173 745f 6869 6464 656e 5f73 7461 7465  ast_hidden_state
+000065e0: 5b3a 2c20 302c 203a 5d0a 2020 2020 2020  [:, 0, :].      
+000065f0: 2020 706f 6f6c 6564 5f6f 7574 7075 7420    pooled_output 
+00006600: 3d20 7365 6c66 2e70 6f73 745f 6c61 7965  = self.post_laye
+00006610: 726e 6f72 6d28 706f 6f6c 6564 5f6f 7574  rnorm(pooled_out
+00006620: 7075 7429 0a0a 2020 2020 2020 2020 6966  put)..        if
+00006630: 206e 6f74 2072 6574 7572 6e5f 6469 6374   not return_dict
+00006640: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00006650: 7475 726e 2028 6c61 7374 5f68 6964 6465  turn (last_hidde
+00006660: 6e5f 7374 6174 652c 2070 6f6f 6c65 645f  n_state, pooled_
+00006670: 6f75 7470 7574 2920 2b20 656e 636f 6465  output) + encode
+00006680: 725f 6f75 7470 7574 735b 313a 5d0a 0a20  r_outputs[1:].. 
+00006690: 2020 2020 2020 2072 6574 7572 6e20 4261         return Ba
+000066a0: 7365 4d6f 6465 6c4f 7574 7075 7457 6974  seModelOutputWit
+000066b0: 6850 6f6f 6c69 6e67 280a 2020 2020 2020  hPooling(.      
+000066c0: 2020 2020 2020 6c61 7374 5f68 6964 6465        last_hidde
+000066d0: 6e5f 7374 6174 653d 6c61 7374 5f68 6964  n_state=last_hid
+000066e0: 6465 6e5f 7374 6174 652c 0a20 2020 2020  den_state,.     
+000066f0: 2020 2020 2020 2070 6f6f 6c65 725f 6f75         pooler_ou
+00006700: 7470 7574 3d70 6f6f 6c65 645f 6f75 7470  tput=pooled_outp
+00006710: 7574 2c0a 2020 2020 2020 2020 2020 2020  ut,.            
+00006720: 6869 6464 656e 5f73 7461 7465 733d 656e  hidden_states=en
+00006730: 636f 6465 725f 6f75 7470 7574 732e 6869  coder_outputs.hi
+00006740: 6464 656e 5f73 7461 7465 732c 0a20 2020  dden_states,.   
+00006750: 2020 2020 2020 2020 2061 7474 656e 7469           attenti
+00006760: 6f6e 733d 656e 636f 6465 725f 6f75 7470  ons=encoder_outp
+00006770: 7574 732e 6174 7465 6e74 696f 6e73 2c0a  uts.attentions,.
+00006780: 2020 2020 2020 2020 290a 0a20 2020 2064          )..    d
+00006790: 6566 2067 6574 5f69 6e70 7574 5f65 6d62  ef get_input_emb
+000067a0: 6564 6469 6e67 7328 7365 6c66 293a 0a20  eddings(self):. 
+000067b0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+000067c0: 6c66 2e65 6d62 6564 6469 6e67 730a 0a0a  lf.embeddings...
+000067d0: 636c 6173 7320 426c 6970 4d6f 6465 6c28  class BlipModel(
+000067e0: 426c 6970 5072 6554 7261 696e 6564 4d6f  BlipPreTrainedMo
+000067f0: 6465 6c29 3a0a 2020 2020 636f 6e66 6967  del):.    config
+00006800: 5f63 6c61 7373 203d 2042 6c69 7043 6f6e  _class = BlipCon
+00006810: 6669 670a 0a20 2020 2064 6566 205f 5f69  fig..    def __i
+00006820: 6e69 745f 5f28 7365 6c66 2c20 636f 6e66  nit__(self, conf
+00006830: 6967 3a20 426c 6970 436f 6e66 6967 293a  ig: BlipConfig):
+00006840: 0a20 2020 2020 2020 2073 7570 6572 2829  .        super()
+00006850: 2e5f 5f69 6e69 745f 5f28 636f 6e66 6967  .__init__(config
+00006860: 290a 0a20 2020 2020 2020 2069 6620 6e6f  )..        if no
+00006870: 7420 6973 696e 7374 616e 6365 2863 6f6e  t isinstance(con
+00006880: 6669 672e 7465 7874 5f63 6f6e 6669 672c  fig.text_config,
+00006890: 2042 6c69 7054 6578 7443 6f6e 6669 6729   BlipTextConfig)
+000068a0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+000068b0: 6973 6520 5661 6c75 6545 7272 6f72 280a  ise ValueError(.
+000068c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000068d0: 2263 6f6e 6669 672e 7465 7874 5f63 6f6e  "config.text_con
+000068e0: 6669 6720 6973 2065 7870 6563 7465 6420  fig is expected 
+000068f0: 746f 2062 6520 6f66 2074 7970 6520 426c  to be of type Bl
+00006900: 6970 5465 7874 436f 6e66 6967 2062 7574  ipTextConfig but
+00006910: 2069 7320 6f66 2074 7970 6522 0a20 2020   is of type".   
+00006920: 2020 2020 2020 2020 2020 2020 2066 2220               f" 
+00006930: 7b74 7970 6528 636f 6e66 6967 2e74 6578  {type(config.tex
+00006940: 745f 636f 6e66 6967 297d 2e22 0a20 2020  t_config)}.".   
+00006950: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+00006960: 2020 2020 6966 206e 6f74 2069 7369 6e73      if not isins
+00006970: 7461 6e63 6528 636f 6e66 6967 2e76 6973  tance(config.vis
+00006980: 696f 6e5f 636f 6e66 6967 2c20 426c 6970  ion_config, Blip
+00006990: 5669 7369 6f6e 436f 6e66 6967 293a 0a20  VisionConfig):. 
+000069a0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+000069b0: 2056 616c 7565 4572 726f 7228 0a20 2020   ValueError(.   
+000069c0: 2020 2020 2020 2020 2020 2020 2022 636f               "co
+000069d0: 6e66 6967 2e76 6973 696f 6e5f 636f 6e66  nfig.vision_conf
+000069e0: 6967 2069 7320 6578 7065 6374 6564 2074  ig is expected t
+000069f0: 6f20 6265 206f 6620 7479 7065 2042 6c69  o be of type Bli
+00006a00: 7056 6973 696f 6e43 6f6e 6669 6720 6275  pVisionConfig bu
+00006a10: 7420 6973 206f 6620 7479 7065 220a 2020  t is of type".  
+00006a20: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+00006a30: 207b 7479 7065 2863 6f6e 6669 672e 7669   {type(config.vi
+00006a40: 7369 6f6e 5f63 6f6e 6669 6729 7d2e 220a  sion_config)}.".
+00006a50: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+00006a60: 2020 2020 2020 2074 6578 745f 636f 6e66         text_conf
+00006a70: 6967 203d 2063 6f6e 6669 672e 7465 7874  ig = config.text
+00006a80: 5f63 6f6e 6669 670a 2020 2020 2020 2020  _config.        
+00006a90: 7669 7369 6f6e 5f63 6f6e 6669 6720 3d20  vision_config = 
+00006aa0: 636f 6e66 6967 2e76 6973 696f 6e5f 636f  config.vision_co
+00006ab0: 6e66 6967 0a0a 2020 2020 2020 2020 7365  nfig..        se
+00006ac0: 6c66 2e70 726f 6a65 6374 696f 6e5f 6469  lf.projection_di
+00006ad0: 6d20 3d20 636f 6e66 6967 2e70 726f 6a65  m = config.proje
+00006ae0: 6374 696f 6e5f 6469 6d0a 2020 2020 2020  ction_dim.      
+00006af0: 2020 7365 6c66 2e74 6578 745f 656d 6265    self.text_embe
+00006b00: 645f 6469 6d20 3d20 7465 7874 5f63 6f6e  d_dim = text_con
+00006b10: 6669 672e 6869 6464 656e 5f73 697a 650a  fig.hidden_size.
+00006b20: 2020 2020 2020 2020 7365 6c66 2e76 6973          self.vis
+00006b30: 696f 6e5f 656d 6265 645f 6469 6d20 3d20  ion_embed_dim = 
+00006b40: 7669 7369 6f6e 5f63 6f6e 6669 672e 6869  vision_config.hi
+00006b50: 6464 656e 5f73 697a 650a 0a20 2020 2020  dden_size..     
+00006b60: 2020 2073 656c 662e 7465 7874 5f6d 6f64     self.text_mod
+00006b70: 656c 203d 2042 6c69 7054 6578 744d 6f64  el = BlipTextMod
+00006b80: 656c 2874 6578 745f 636f 6e66 6967 290a  el(text_config).
+00006b90: 2020 2020 2020 2020 7365 6c66 2e76 6973          self.vis
+00006ba0: 696f 6e5f 6d6f 6465 6c20 3d20 426c 6970  ion_model = Blip
+00006bb0: 5669 7369 6f6e 4d6f 6465 6c28 7669 7369  VisionModel(visi
+00006bc0: 6f6e 5f63 6f6e 6669 6729 0a0a 2020 2020  on_config)..    
+00006bd0: 2020 2020 7365 6c66 2e76 6973 7561 6c5f      self.visual_
+00006be0: 7072 6f6a 6563 7469 6f6e 203d 206e 6e2e  projection = nn.
+00006bf0: 4465 6e73 6528 7365 6c66 2e76 6973 696f  Dense(self.visio
+00006c00: 6e5f 656d 6265 645f 6469 6d2c 2073 656c  n_embed_dim, sel
+00006c10: 662e 7072 6f6a 6563 7469 6f6e 5f64 696d  f.projection_dim
+00006c20: 2c20 6861 735f 6269 6173 3d46 616c 7365  , has_bias=False
+00006c30: 290a 2020 2020 2020 2020 7365 6c66 2e74  ).        self.t
+00006c40: 6578 745f 7072 6f6a 6563 7469 6f6e 203d  ext_projection =
+00006c50: 206e 6e2e 4465 6e73 6528 7365 6c66 2e74   nn.Dense(self.t
+00006c60: 6578 745f 656d 6265 645f 6469 6d2c 2073  ext_embed_dim, s
+00006c70: 656c 662e 7072 6f6a 6563 7469 6f6e 5f64  elf.projection_d
+00006c80: 696d 2c20 6861 735f 6269 6173 3d46 616c  im, has_bias=Fal
+00006c90: 7365 290a 2020 2020 2020 2020 7365 6c66  se).        self
+00006ca0: 2e6c 6f67 6974 5f73 6361 6c65 203d 2050  .logit_scale = P
+00006cb0: 6172 616d 6574 6572 286d 696e 6473 706f  arameter(mindspo
+00006cc0: 7265 2e74 656e 736f 7228 7365 6c66 2e63  re.tensor(self.c
+00006cd0: 6f6e 6669 672e 6c6f 6769 745f 7363 616c  onfig.logit_scal
+00006ce0: 655f 696e 6974 5f76 616c 7565 2929 0a0a  e_init_value))..
+00006cf0: 2020 2020 2020 2020 2320 496e 6974 6961          # Initia
+00006d00: 6c69 7a65 2077 6569 6768 7473 2061 6e64  lize weights and
+00006d10: 2061 7070 6c79 2066 696e 616c 2070 726f   apply final pro
+00006d20: 6365 7373 696e 670a 2020 2020 2020 2020  cessing.        
+00006d30: 7365 6c66 2e70 6f73 745f 696e 6974 2829  self.post_init()
+00006d40: 0a0a 2020 2020 6465 6620 6765 745f 7465  ..    def get_te
+00006d50: 7874 5f66 6561 7475 7265 7328 0a20 2020  xt_features(.   
+00006d60: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+00006d70: 2020 2069 6e70 7574 5f69 6473 3a20 4f70     input_ids: Op
+00006d80: 7469 6f6e 616c 5b6d 696e 6473 706f 7265  tional[mindspore
+00006d90: 2e54 656e 736f 725d 203d 204e 6f6e 652c  .Tensor] = None,
+00006da0: 0a20 2020 2020 2020 2061 7474 656e 7469  .        attenti
+00006db0: 6f6e 5f6d 6173 6b3a 204f 7074 696f 6e61  on_mask: Optiona
+00006dc0: 6c5b 6d69 6e64 7370 6f72 652e 5465 6e73  l[mindspore.Tens
+00006dd0: 6f72 5d20 3d20 4e6f 6e65 2c0a 2020 2020  or] = None,.    
+00006de0: 2020 2020 706f 7369 7469 6f6e 5f69 6473      position_ids
+00006df0: 3a20 4f70 7469 6f6e 616c 5b6d 696e 6473  : Optional[minds
+00006e00: 706f 7265 2e54 656e 736f 725d 203d 204e  pore.Tensor] = N
+00006e10: 6f6e 652c 0a20 2020 2020 2020 2072 6574  one,.        ret
+00006e20: 7572 6e5f 6469 6374 3a20 4f70 7469 6f6e  urn_dict: Option
+00006e30: 616c 5b62 6f6f 6c5d 203d 204e 6f6e 652c  al[bool] = None,
+00006e40: 0a20 2020 2029 202d 3e20 6d69 6e64 7370  .    ) -> mindsp
+00006e50: 6f72 652e 5465 6e73 6f72 3a0a 2020 2020  ore.Tensor:.    
+00006e60: 2020 2020 7222 2222 0a20 2020 2020 2020      r""".       
+00006e70: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+00006e80: 2020 2020 2020 7465 7874 5f66 6561 7475        text_featu
+00006e90: 7265 7320 2860 6d69 6e64 7370 6f72 652e  res (`mindspore.
+00006ea0: 5465 6e73 6f72 6020 6f66 2073 6861 7065  Tensor` of shape
+00006eb0: 2060 2862 6174 6368 5f73 697a 652c 206f   `(batch_size, o
+00006ec0: 7574 7075 745f 6469 6d60 293a 2054 6865  utput_dim`): The
+00006ed0: 2074 6578 7420 656d 6265 6464 696e 6773   text embeddings
+00006ee0: 206f 6274 6169 6e65 6420 6279 0a20 2020   obtained by.   
+00006ef0: 2020 2020 2020 2020 2061 7070 6c79 696e           applyin
+00006f00: 6720 7468 6520 7072 6f6a 6563 7469 6f6e  g the projection
+00006f10: 206c 6179 6572 2074 6f20 7468 6520 706f   layer to the po
+00006f20: 6f6c 6564 206f 7574 7075 7420 6f66 205b  oled output of [
+00006f30: 6042 6c69 7054 6578 744d 6f64 656c 605d  `BlipTextModel`]
+00006f40: 2e0a 0a20 2020 2020 2020 2045 7861 6d70  ...        Examp
+00006f50: 6c65 733a 0a0a 2020 2020 2020 2020 6060  les:..        ``
+00006f60: 6070 7974 686f 6e0a 2020 2020 2020 2020  `python.        
+00006f70: 3e3e 3e20 6672 6f6d 2074 7261 6e73 666f  >>> from transfo
+00006f80: 726d 6572 7320 696d 706f 7274 2041 7574  rmers import Aut
+00006f90: 6f50 726f 6365 7373 6f72 2c20 426c 6970  oProcessor, Blip
+00006fa0: 4d6f 6465 6c0a 0a20 2020 2020 2020 203e  Model..        >
+00006fb0: 3e3e 206d 6f64 656c 203d 2042 6c69 704d  >> model = BlipM
+00006fc0: 6f64 656c 2e66 726f 6d5f 7072 6574 7261  odel.from_pretra
+00006fd0: 696e 6564 2822 5361 6c65 7366 6f72 6365  ined("Salesforce
+00006fe0: 2f62 6c69 702d 696d 6167 652d 6361 7074  /blip-image-capt
+00006ff0: 696f 6e69 6e67 2d62 6173 6522 290a 2020  ioning-base").  
+00007000: 2020 2020 2020 3e3e 3e20 7072 6f63 6573        >>> proces
+00007010: 736f 7220 3d20 4175 746f 5072 6f63 6573  sor = AutoProces
+00007020: 736f 722e 6672 6f6d 5f70 7265 7472 6169  sor.from_pretrai
+00007030: 6e65 6428 2253 616c 6573 666f 7263 652f  ned("Salesforce/
+00007040: 626c 6970 2d69 6d61 6765 2d63 6170 7469  blip-image-capti
+00007050: 6f6e 696e 672d 6261 7365 2229 0a0a 2020  oning-base")..  
+00007060: 2020 2020 2020 3e3e 3e20 696e 7075 7473        >>> inputs
+00007070: 203d 2070 726f 6365 7373 6f72 2874 6578   = processor(tex
+00007080: 743d 5b22 6120 7068 6f74 6f20 6f66 2061  t=["a photo of a
+00007090: 2063 6174 222c 2022 6120 7068 6f74 6f20   cat", "a photo 
+000070a0: 6f66 2061 2064 6f67 225d 2c20 7061 6464  of a dog"], padd
+000070b0: 696e 673d 5472 7565 2c20 7265 7475 726e  ing=True, return
+000070c0: 5f74 656e 736f 7273 3d22 7074 2229 0a20  _tensors="pt"). 
+000070d0: 2020 2020 2020 203e 3e3e 2074 6578 745f         >>> text_
+000070e0: 6665 6174 7572 6573 203d 206d 6f64 656c  features = model
+000070f0: 2e67 6574 5f74 6578 745f 6665 6174 7572  .get_text_featur
+00007100: 6573 282a 2a69 6e70 7574 7329 0a20 2020  es(**inputs).   
+00007110: 2020 2020 2060 6060 2222 220a 2020 2020       ```""".    
+00007120: 2020 2020 7265 7475 726e 5f64 6963 7420      return_dict 
+00007130: 3d20 7265 7475 726e 5f64 6963 7420 6966  = return_dict if
+00007140: 2072 6574 7572 6e5f 6469 6374 2069 7320   return_dict is 
+00007150: 6e6f 7420 4e6f 6e65 2065 6c73 6520 7365  not None else se
+00007160: 6c66 2e63 6f6e 6669 672e 7573 655f 7265  lf.config.use_re
+00007170: 7475 726e 5f64 6963 740a 0a20 2020 2020  turn_dict..     
+00007180: 2020 2074 6578 745f 6f75 7470 7574 7320     text_outputs 
+00007190: 3d20 7365 6c66 2e74 6578 745f 6d6f 6465  = self.text_mode
+000071a0: 6c28 0a20 2020 2020 2020 2020 2020 2069  l(.            i
+000071b0: 6e70 7574 5f69 6473 3d69 6e70 7574 5f69  nput_ids=input_i
+000071c0: 6473 2c0a 2020 2020 2020 2020 2020 2020  ds,.            
+000071d0: 6174 7465 6e74 696f 6e5f 6d61 736b 3d61  attention_mask=a
+000071e0: 7474 656e 7469 6f6e 5f6d 6173 6b2c 0a20  ttention_mask,. 
+000071f0: 2020 2020 2020 2020 2020 2070 6f73 6974             posit
+00007200: 696f 6e5f 6964 733d 706f 7369 7469 6f6e  ion_ids=position
+00007210: 5f69 6473 2c0a 2020 2020 2020 2020 2020  _ids,.          
+00007220: 2020 7265 7475 726e 5f64 6963 743d 7265    return_dict=re
+00007230: 7475 726e 5f64 6963 742c 0a20 2020 2020  turn_dict,.     
+00007240: 2020 2029 0a0a 2020 2020 2020 2020 706f     )..        po
+00007250: 6f6c 6564 5f6f 7574 7075 7420 3d20 7465  oled_output = te
+00007260: 7874 5f6f 7574 7075 7473 5b31 5d0a 2020  xt_outputs[1].  
+00007270: 2020 2020 2020 7465 7874 5f66 6561 7475        text_featu
+00007280: 7265 7320 3d20 7365 6c66 2e74 6578 745f  res = self.text_
+00007290: 7072 6f6a 6563 7469 6f6e 2870 6f6f 6c65  projection(poole
+000072a0: 645f 6f75 7470 7574 290a 0a20 2020 2020  d_output)..     
+000072b0: 2020 2072 6574 7572 6e20 7465 7874 5f66     return text_f
+000072c0: 6561 7475 7265 730a 0a20 2020 2064 6566  eatures..    def
+000072d0: 2067 6574 5f69 6d61 6765 5f66 6561 7475   get_image_featu
+000072e0: 7265 7328 0a20 2020 2020 2020 2073 656c  res(.        sel
+000072f0: 662c 0a20 2020 2020 2020 2070 6978 656c  f,.        pixel
+00007300: 5f76 616c 7565 733a 204f 7074 696f 6e61  _values: Optiona
+00007310: 6c5b 6d69 6e64 7370 6f72 652e 5465 6e73  l[mindspore.Tens
+00007320: 6f72 5d20 3d20 4e6f 6e65 2c0a 2020 2020  or] = None,.    
+00007330: 2020 2020 7265 7475 726e 5f64 6963 743a      return_dict:
+00007340: 204f 7074 696f 6e61 6c5b 626f 6f6c 5d20   Optional[bool] 
+00007350: 3d20 4e6f 6e65 2c0a 2020 2020 2920 2d3e  = None,.    ) ->
+00007360: 206d 696e 6473 706f 7265 2e54 656e 736f   mindspore.Tenso
+00007370: 723a 0a20 2020 2020 2020 2072 2222 220a  r:.        r""".
+00007380: 2020 2020 2020 2020 5265 7475 726e 733a          Returns:
+00007390: 0a20 2020 2020 2020 2020 2020 2069 6d61  .            ima
+000073a0: 6765 5f66 6561 7475 7265 7320 2860 6d69  ge_features (`mi
+000073b0: 6e64 7370 6f72 652e 5465 6e73 6f72 6020  ndspore.Tensor` 
+000073c0: 6f66 2073 6861 7065 2060 2862 6174 6368  of shape `(batch
+000073d0: 5f73 697a 652c 206f 7574 7075 745f 6469  _size, output_di
+000073e0: 6d60 293a 2054 6865 2069 6d61 6765 2065  m`): The image e
+000073f0: 6d62 6564 6469 6e67 7320 6f62 7461 696e  mbeddings obtain
+00007400: 6564 2062 790a 2020 2020 2020 2020 2020  ed by.          
+00007410: 2020 6170 706c 7969 6e67 2074 6865 2070    applying the p
+00007420: 726f 6a65 6374 696f 6e20 6c61 7965 7220  rojection layer 
+00007430: 746f 2074 6865 2070 6f6f 6c65 6420 6f75  to the pooled ou
+00007440: 7470 7574 206f 6620 5b60 426c 6970 5669  tput of [`BlipVi
+00007450: 7369 6f6e 4d6f 6465 6c60 5d2e 0a0a 2020  sionModel`]...  
+00007460: 2020 2020 2020 4578 616d 706c 6573 3a0a        Examples:.
+00007470: 0a20 2020 2020 2020 2060 6060 7079 7468  .        ```pyth
+00007480: 6f6e 0a20 2020 2020 2020 203e 3e3e 2066  on.        >>> f
+00007490: 726f 6d20 5049 4c20 696d 706f 7274 2049  rom PIL import I
+000074a0: 6d61 6765 0a20 2020 2020 2020 203e 3e3e  mage.        >>>
+000074b0: 2069 6d70 6f72 7420 7265 7175 6573 7473   import requests
+000074c0: 0a20 2020 2020 2020 203e 3e3e 2066 726f  .        >>> fro
+000074d0: 6d20 7472 616e 7366 6f72 6d65 7273 2069  m transformers i
+000074e0: 6d70 6f72 7420 4175 746f 5072 6f63 6573  mport AutoProces
+000074f0: 736f 722c 2042 6c69 704d 6f64 656c 0a0a  sor, BlipModel..
+00007500: 2020 2020 2020 2020 3e3e 3e20 6d6f 6465          >>> mode
+00007510: 6c20 3d20 426c 6970 4d6f 6465 6c2e 6672  l = BlipModel.fr
+00007520: 6f6d 5f70 7265 7472 6169 6e65 6428 2253  om_pretrained("S
+00007530: 616c 6573 666f 7263 652f 626c 6970 2d69  alesforce/blip-i
+00007540: 6d61 6765 2d63 6170 7469 6f6e 696e 672d  mage-captioning-
+00007550: 6261 7365 2229 0a20 2020 2020 2020 203e  base").        >
+00007560: 3e3e 2070 726f 6365 7373 6f72 203d 2041  >> processor = A
+00007570: 7574 6f50 726f 6365 7373 6f72 2e66 726f  utoProcessor.fro
+00007580: 6d5f 7072 6574 7261 696e 6564 2822 5361  m_pretrained("Sa
+00007590: 6c65 7366 6f72 6365 2f62 6c69 702d 696d  lesforce/blip-im
+000075a0: 6167 652d 6361 7074 696f 6e69 6e67 2d62  age-captioning-b
+000075b0: 6173 6522 290a 0a20 2020 2020 2020 203e  ase")..        >
+000075c0: 3e3e 2075 726c 203d 2022 6874 7470 3a2f  >> url = "http:/
+000075d0: 2f69 6d61 6765 732e 636f 636f 6461 7461  /images.cocodata
+000075e0: 7365 742e 6f72 672f 7661 6c32 3031 372f  set.org/val2017/
+000075f0: 3030 3030 3030 3033 3937 3639 2e6a 7067  000000039769.jpg
+00007600: 220a 2020 2020 2020 2020 3e3e 3e20 696d  ".        >>> im
+00007610: 6167 6520 3d20 496d 6167 652e 6f70 656e  age = Image.open
+00007620: 2872 6571 7565 7374 732e 6765 7428 7572  (requests.get(ur
+00007630: 6c2c 2073 7472 6561 6d3d 5472 7565 292e  l, stream=True).
+00007640: 7261 7729 0a0a 2020 2020 2020 2020 3e3e  raw)..        >>
+00007650: 3e20 696e 7075 7473 203d 2070 726f 6365  > inputs = proce
+00007660: 7373 6f72 2869 6d61 6765 733d 696d 6167  ssor(images=imag
+00007670: 652c 2072 6574 7572 6e5f 7465 6e73 6f72  e, return_tensor
+00007680: 733d 2270 7422 290a 0a20 2020 2020 2020  s="pt")..       
+00007690: 203e 3e3e 2069 6d61 6765 5f66 6561 7475   >>> image_featu
+000076a0: 7265 7320 3d20 6d6f 6465 6c2e 6765 745f  res = model.get_
+000076b0: 696d 6167 655f 6665 6174 7572 6573 282a  image_features(*
+000076c0: 2a69 6e70 7574 7329 0a20 2020 2020 2020  *inputs).       
+000076d0: 2060 6060 2222 220a 2020 2020 2020 2020   ```""".        
+000076e0: 7265 7475 726e 5f64 6963 7420 3d20 7265  return_dict = re
+000076f0: 7475 726e 5f64 6963 7420 6966 2072 6574  turn_dict if ret
+00007700: 7572 6e5f 6469 6374 2069 7320 6e6f 7420  urn_dict is not 
+00007710: 4e6f 6e65 2065 6c73 6520 7365 6c66 2e63  None else self.c
+00007720: 6f6e 6669 672e 7573 655f 7265 7475 726e  onfig.use_return
+00007730: 5f64 6963 740a 0a20 2020 2020 2020 2076  _dict..        v
+00007740: 6973 696f 6e5f 6f75 7470 7574 7320 3d20  ision_outputs = 
+00007750: 7365 6c66 2e76 6973 696f 6e5f 6d6f 6465  self.vision_mode
+00007760: 6c28 7069 7865 6c5f 7661 6c75 6573 3d70  l(pixel_values=p
+00007770: 6978 656c 5f76 616c 7565 732c 2072 6574  ixel_values, ret
+00007780: 7572 6e5f 6469 6374 3d72 6574 7572 6e5f  urn_dict=return_
+00007790: 6469 6374 290a 0a20 2020 2020 2020 2070  dict)..        p
+000077a0: 6f6f 6c65 645f 6f75 7470 7574 203d 2076  ooled_output = v
+000077b0: 6973 696f 6e5f 6f75 7470 7574 735b 315d  ision_outputs[1]
+000077c0: 2020 2320 706f 6f6c 6564 5f6f 7574 7075    # pooled_outpu
+000077d0: 740a 2020 2020 2020 2020 696d 6167 655f  t.        image_
+000077e0: 6665 6174 7572 6573 203d 2073 656c 662e  features = self.
+000077f0: 7669 7375 616c 5f70 726f 6a65 6374 696f  visual_projectio
+00007800: 6e28 706f 6f6c 6564 5f6f 7574 7075 7429  n(pooled_output)
+00007810: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+00007820: 2069 6d61 6765 5f66 6561 7475 7265 730a   image_features.
+00007830: 0a20 2020 2064 6566 2063 6f6e 7374 7275  .    def constru
+00007840: 6374 280a 2020 2020 2020 2020 7365 6c66  ct(.        self
+00007850: 2c0a 2020 2020 2020 2020 696e 7075 745f  ,.        input_
+00007860: 6964 733a 204f 7074 696f 6e61 6c5b 6d69  ids: Optional[mi
+00007870: 6e64 7370 6f72 652e 5465 6e73 6f72 5d20  ndspore.Tensor] 
+00007880: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00007890: 7069 7865 6c5f 7661 6c75 6573 3a20 4f70  pixel_values: Op
+000078a0: 7469 6f6e 616c 5b6d 696e 6473 706f 7265  tional[mindspore
+000078b0: 2e54 656e 736f 725d 203d 204e 6f6e 652c  .Tensor] = None,
+000078c0: 0a20 2020 2020 2020 2061 7474 656e 7469  .        attenti
+000078d0: 6f6e 5f6d 6173 6b3a 204f 7074 696f 6e61  on_mask: Optiona
+000078e0: 6c5b 6d69 6e64 7370 6f72 652e 5465 6e73  l[mindspore.Tens
+000078f0: 6f72 5d20 3d20 4e6f 6e65 2c0a 2020 2020  or] = None,.    
+00007900: 2020 2020 706f 7369 7469 6f6e 5f69 6473      position_ids
+00007910: 3a20 4f70 7469 6f6e 616c 5b6d 696e 6473  : Optional[minds
+00007920: 706f 7265 2e54 656e 736f 725d 203d 204e  pore.Tensor] = N
+00007930: 6f6e 652c 0a20 2020 2020 2020 2072 6574  one,.        ret
+00007940: 7572 6e5f 6c6f 7373 3a20 4f70 7469 6f6e  urn_loss: Option
+00007950: 616c 5b62 6f6f 6c5d 203d 204e 6f6e 652c  al[bool] = None,
+00007960: 0a20 2020 2020 2020 206f 7574 7075 745f  .        output_
+00007970: 6174 7465 6e74 696f 6e73 3a20 4f70 7469  attentions: Opti
+00007980: 6f6e 616c 5b62 6f6f 6c5d 203d 204e 6f6e  onal[bool] = Non
+00007990: 652c 0a20 2020 2020 2020 206f 7574 7075  e,.        outpu
+000079a0: 745f 6869 6464 656e 5f73 7461 7465 733a  t_hidden_states:
+000079b0: 204f 7074 696f 6e61 6c5b 626f 6f6c 5d20   Optional[bool] 
+000079c0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+000079d0: 7265 7475 726e 5f64 6963 743a 204f 7074  return_dict: Opt
+000079e0: 696f 6e61 6c5b 626f 6f6c 5d20 3d20 4e6f  ional[bool] = No
+000079f0: 6e65 2c0a 2020 2020 2920 2d3e 2055 6e69  ne,.    ) -> Uni
+00007a00: 6f6e 5b54 7570 6c65 2c20 426c 6970 4f75  on[Tuple, BlipOu
+00007a10: 7470 7574 5d3a 0a20 2020 2020 2020 2072  tput]:.        r
+00007a20: 2222 220a 2020 2020 2020 2020 5265 7475  """.        Retu
+00007a30: 726e 733a 0a0a 2020 2020 2020 2020 4578  rns:..        Ex
+00007a40: 616d 706c 6573 3a0a 0a20 2020 2020 2020  amples:..       
+00007a50: 2060 6060 7079 7468 6f6e 0a20 2020 2020   ```python.     
+00007a60: 2020 203e 3e3e 2066 726f 6d20 5049 4c20     >>> from PIL 
+00007a70: 696d 706f 7274 2049 6d61 6765 0a20 2020  import Image.   
+00007a80: 2020 2020 203e 3e3e 2069 6d70 6f72 7420       >>> import 
+00007a90: 7265 7175 6573 7473 0a20 2020 2020 2020  requests.       
+00007aa0: 203e 3e3e 2066 726f 6d20 7472 616e 7366   >>> from transf
+00007ab0: 6f72 6d65 7273 2069 6d70 6f72 7420 4175  ormers import Au
+00007ac0: 746f 5072 6f63 6573 736f 722c 2042 6c69  toProcessor, Bli
+00007ad0: 704d 6f64 656c 0a0a 2020 2020 2020 2020  pModel..        
+00007ae0: 3e3e 3e20 6d6f 6465 6c20 3d20 426c 6970  >>> model = Blip
+00007af0: 4d6f 6465 6c2e 6672 6f6d 5f70 7265 7472  Model.from_pretr
+00007b00: 6169 6e65 6428 2253 616c 6573 666f 7263  ained("Salesforc
+00007b10: 652f 626c 6970 2d69 6d61 6765 2d63 6170  e/blip-image-cap
+00007b20: 7469 6f6e 696e 672d 6261 7365 2229 0a20  tioning-base"). 
+00007b30: 2020 2020 2020 203e 3e3e 2070 726f 6365         >>> proce
+00007b40: 7373 6f72 203d 2041 7574 6f50 726f 6365  ssor = AutoProce
+00007b50: 7373 6f72 2e66 726f 6d5f 7072 6574 7261  ssor.from_pretra
+00007b60: 696e 6564 2822 5361 6c65 7366 6f72 6365  ined("Salesforce
+00007b70: 2f62 6c69 702d 696d 6167 652d 6361 7074  /blip-image-capt
+00007b80: 696f 6e69 6e67 2d62 6173 6522 290a 0a20  ioning-base").. 
+00007b90: 2020 2020 2020 203e 3e3e 2075 726c 203d         >>> url =
+00007ba0: 2022 6874 7470 3a2f 2f69 6d61 6765 732e   "http://images.
+00007bb0: 636f 636f 6461 7461 7365 742e 6f72 672f  cocodataset.org/
+00007bc0: 7661 6c32 3031 372f 3030 3030 3030 3033  val2017/00000003
+00007bd0: 3937 3639 2e6a 7067 220a 2020 2020 2020  9769.jpg".      
+00007be0: 2020 3e3e 3e20 696d 6167 6520 3d20 496d    >>> image = Im
+00007bf0: 6167 652e 6f70 656e 2872 6571 7565 7374  age.open(request
+00007c00: 732e 6765 7428 7572 6c2c 2073 7472 6561  s.get(url, strea
+00007c10: 6d3d 5472 7565 292e 7261 7729 0a0a 2020  m=True).raw)..  
+00007c20: 2020 2020 2020 3e3e 3e20 696e 7075 7473        >>> inputs
+00007c30: 203d 2070 726f 6365 7373 6f72 280a 2020   = processor(.  
+00007c40: 2020 2020 2020 2e2e 2e20 2020 2020 7465        ...     te
+00007c50: 7874 3d5b 2261 2070 686f 746f 206f 6620  xt=["a photo of 
+00007c60: 6120 6361 7422 2c20 2261 2070 686f 746f  a cat", "a photo
+00007c70: 206f 6620 6120 646f 6722 5d2c 2069 6d61   of a dog"], ima
+00007c80: 6765 733d 696d 6167 652c 2072 6574 7572  ges=image, retur
+00007c90: 6e5f 7465 6e73 6f72 733d 2270 7422 2c20  n_tensors="pt", 
+00007ca0: 7061 6464 696e 673d 5472 7565 0a20 2020  padding=True.   
+00007cb0: 2020 2020 202e 2e2e 2029 0a0a 2020 2020       ... )..    
+00007cc0: 2020 2020 3e3e 3e20 6f75 7470 7574 7320      >>> outputs 
+00007cd0: 3d20 6d6f 6465 6c28 2a2a 696e 7075 7473  = model(**inputs
+00007ce0: 290a 2020 2020 2020 2020 3e3e 3e20 6c6f  ).        >>> lo
+00007cf0: 6769 7473 5f70 6572 5f69 6d61 6765 203d  gits_per_image =
+00007d00: 206f 7574 7075 7473 2e6c 6f67 6974 735f   outputs.logits_
+00007d10: 7065 725f 696d 6167 6520 2023 2074 6869  per_image  # thi
+00007d20: 7320 6973 2074 6865 2069 6d61 6765 2d74  s is the image-t
+00007d30: 6578 7420 7369 6d69 6c61 7269 7479 2073  ext similarity s
+00007d40: 636f 7265 0a20 2020 2020 2020 203e 3e3e  core.        >>>
+00007d50: 2070 726f 6273 203d 206c 6f67 6974 735f   probs = logits_
+00007d60: 7065 725f 696d 6167 652e 736f 6674 6d61  per_image.softma
+00007d70: 7828 6469 6d3d 3129 2020 2320 7765 2063  x(dim=1)  # we c
+00007d80: 616e 2074 616b 6520 7468 6520 736f 6674  an take the soft
+00007d90: 6d61 7820 746f 2067 6574 2074 6865 206c  max to get the l
+00007da0: 6162 656c 2070 726f 6261 6269 6c69 7469  abel probabiliti
+00007db0: 6573 0a20 2020 2020 2020 2060 6060 2222  es.        ```""
+00007dc0: 220a 2020 2020 2020 2020 2320 5573 6520  ".        # Use 
+00007dd0: 424c 4950 206d 6f64 656c 2773 2063 6f6e  BLIP model's con
+00007de0: 6669 6720 666f 7220 736f 6d65 2066 6965  fig for some fie
+00007df0: 6c64 7320 2869 6620 7370 6563 6966 6965  lds (if specifie
+00007e00: 6429 2069 6e73 7465 6164 206f 6620 7468  d) instead of th
+00007e10: 6f73 6520 6f66 2076 6973 696f 6e20 2620  ose of vision & 
+00007e20: 7465 7874 2063 6f6d 706f 6e65 6e74 732e  text components.
+00007e30: 0a20 2020 2020 2020 206f 7574 7075 745f  .        output_
+00007e40: 6174 7465 6e74 696f 6e73 203d 206f 7574  attentions = out
+00007e50: 7075 745f 6174 7465 6e74 696f 6e73 2069  put_attentions i
+00007e60: 6620 6f75 7470 7574 5f61 7474 656e 7469  f output_attenti
+00007e70: 6f6e 7320 6973 206e 6f74 204e 6f6e 6520  ons is not None 
+00007e80: 656c 7365 2073 656c 662e 636f 6e66 6967  else self.config
+00007e90: 2e6f 7574 7075 745f 6174 7465 6e74 696f  .output_attentio
+00007ea0: 6e73 0a20 2020 2020 2020 206f 7574 7075  ns.        outpu
+00007eb0: 745f 6869 6464 656e 5f73 7461 7465 7320  t_hidden_states 
+00007ec0: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+00007ed0: 6f75 7470 7574 5f68 6964 6465 6e5f 7374  output_hidden_st
+00007ee0: 6174 6573 2069 6620 6f75 7470 7574 5f68  ates if output_h
+00007ef0: 6964 6465 6e5f 7374 6174 6573 2069 7320  idden_states is 
+00007f00: 6e6f 7420 4e6f 6e65 2065 6c73 6520 7365  not None else se
+00007f10: 6c66 2e63 6f6e 6669 672e 6f75 7470 7574  lf.config.output
+00007f20: 5f68 6964 6465 6e5f 7374 6174 6573 0a20  _hidden_states. 
+00007f30: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00007f40: 2072 6574 7572 6e5f 6469 6374 203d 2072   return_dict = r
+00007f50: 6574 7572 6e5f 6469 6374 2069 6620 7265  eturn_dict if re
+00007f60: 7475 726e 5f64 6963 7420 6973 206e 6f74  turn_dict is not
+00007f70: 204e 6f6e 6520 656c 7365 2073 656c 662e   None else self.
+00007f80: 636f 6e66 6967 2e75 7365 5f72 6574 7572  config.use_retur
+00007f90: 6e5f 6469 6374 0a0a 2020 2020 2020 2020  n_dict..        
+00007fa0: 7669 7369 6f6e 5f6f 7574 7075 7473 203d  vision_outputs =
+00007fb0: 2073 656c 662e 7669 7369 6f6e 5f6d 6f64   self.vision_mod
+00007fc0: 656c 280a 2020 2020 2020 2020 2020 2020  el(.            
+00007fd0: 7069 7865 6c5f 7661 6c75 6573 3d70 6978  pixel_values=pix
+00007fe0: 656c 5f76 616c 7565 732c 0a20 2020 2020  el_values,.     
+00007ff0: 2020 2020 2020 206f 7574 7075 745f 6174         output_at
+00008000: 7465 6e74 696f 6e73 3d6f 7574 7075 745f  tentions=output_
+00008010: 6174 7465 6e74 696f 6e73 2c0a 2020 2020  attentions,.    
+00008020: 2020 2020 2020 2020 6f75 7470 7574 5f68          output_h
+00008030: 6964 6465 6e5f 7374 6174 6573 3d6f 7574  idden_states=out
+00008040: 7075 745f 6869 6464 656e 5f73 7461 7465  put_hidden_state
+00008050: 732c 0a20 2020 2020 2020 2020 2020 2072  s,.            r
+00008060: 6574 7572 6e5f 6469 6374 3d72 6574 7572  eturn_dict=retur
+00008070: 6e5f 6469 6374 2c0a 2020 2020 2020 2020  n_dict,.        
+00008080: 290a 0a20 2020 2020 2020 2074 6578 745f  )..        text_
+00008090: 6f75 7470 7574 7320 3d20 7365 6c66 2e74  outputs = self.t
+000080a0: 6578 745f 6d6f 6465 6c28 0a20 2020 2020  ext_model(.     
+000080b0: 2020 2020 2020 2069 6e70 7574 5f69 6473         input_ids
+000080c0: 3d69 6e70 7574 5f69 6473 2c0a 2020 2020  =input_ids,.    
+000080d0: 2020 2020 2020 2020 6174 7465 6e74 696f          attentio
+000080e0: 6e5f 6d61 736b 3d61 7474 656e 7469 6f6e  n_mask=attention
+000080f0: 5f6d 6173 6b2c 0a20 2020 2020 2020 2020  _mask,.         
+00008100: 2020 2070 6f73 6974 696f 6e5f 6964 733d     position_ids=
+00008110: 706f 7369 7469 6f6e 5f69 6473 2c0a 2020  position_ids,.  
+00008120: 2020 2020 2020 2020 2020 6f75 7470 7574            output
+00008130: 5f61 7474 656e 7469 6f6e 733d 6f75 7470  _attentions=outp
+00008140: 7574 5f61 7474 656e 7469 6f6e 732c 0a20  ut_attentions,. 
+00008150: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
+00008160: 745f 6869 6464 656e 5f73 7461 7465 733d  t_hidden_states=
+00008170: 6f75 7470 7574 5f68 6964 6465 6e5f 7374  output_hidden_st
+00008180: 6174 6573 2c0a 2020 2020 2020 2020 2020  ates,.          
+00008190: 2020 7265 7475 726e 5f64 6963 743d 7265    return_dict=re
+000081a0: 7475 726e 5f64 6963 742c 0a20 2020 2020  turn_dict,.     
+000081b0: 2020 2029 0a0a 2020 2020 2020 2020 696d     )..        im
+000081c0: 6167 655f 656d 6265 6473 203d 2076 6973  age_embeds = vis
+000081d0: 696f 6e5f 6f75 7470 7574 735b 315d 0a20  ion_outputs[1]. 
+000081e0: 2020 2020 2020 2069 6d61 6765 5f65 6d62         image_emb
+000081f0: 6564 7320 3d20 7365 6c66 2e76 6973 7561  eds = self.visua
+00008200: 6c5f 7072 6f6a 6563 7469 6f6e 2869 6d61  l_projection(ima
+00008210: 6765 5f65 6d62 6564 7329 0a0a 2020 2020  ge_embeds)..    
+00008220: 2020 2020 7465 7874 5f65 6d62 6564 7320      text_embeds 
+00008230: 3d20 7465 7874 5f6f 7574 7075 7473 5b31  = text_outputs[1
+00008240: 5d0a 2020 2020 2020 2020 7465 7874 5f65  ].        text_e
+00008250: 6d62 6564 7320 3d20 7365 6c66 2e74 6578  mbeds = self.tex
+00008260: 745f 7072 6f6a 6563 7469 6f6e 2874 6578  t_projection(tex
+00008270: 745f 656d 6265 6473 290a 0a20 2020 2020  t_embeds)..     
+00008280: 2020 2023 206e 6f72 6d61 6c69 7a65 6420     # normalized 
+00008290: 6665 6174 7572 6573 0a20 2020 2020 2020  features.       
+000082a0: 2069 6d61 6765 5f65 6d62 6564 7320 3d20   image_embeds = 
+000082b0: 696d 6167 655f 656d 6265 6473 202f 2069  image_embeds / i
+000082c0: 6d61 6765 5f65 6d62 6564 732e 6e6f 726d  mage_embeds.norm
+000082d0: 286f 7264 3d32 2c20 6469 6d3d 2d31 2c20  (ord=2, dim=-1, 
+000082e0: 6b65 6570 6469 6d3d 5472 7565 290a 2020  keepdim=True).  
+000082f0: 2020 2020 2020 7465 7874 5f65 6d62 6564        text_embed
+00008300: 7320 3d20 7465 7874 5f65 6d62 6564 7320  s = text_embeds 
+00008310: 2f20 7465 7874 5f65 6d62 6564 732e 6e6f  / text_embeds.no
+00008320: 726d 286f 7264 3d32 2c20 6469 6d3d 2d31  rm(ord=2, dim=-1
+00008330: 2c20 6b65 6570 6469 6d3d 5472 7565 290a  , keepdim=True).
+00008340: 0a20 2020 2020 2020 2023 2063 6f73 696e  .        # cosin
+00008350: 6520 7369 6d69 6c61 7269 7479 2061 7320  e similarity as 
+00008360: 6c6f 6769 7473 0a20 2020 2020 2020 206c  logits.        l
+00008370: 6f67 6974 5f73 6361 6c65 203d 2073 656c  ogit_scale = sel
+00008380: 662e 6c6f 6769 745f 7363 616c 652e 6578  f.logit_scale.ex
+00008390: 7028 290a 2020 2020 2020 2020 6c6f 6769  p().        logi
+000083a0: 7473 5f70 6572 5f74 6578 7420 3d20 6f70  ts_per_text = op
+000083b0: 732e 6d61 746d 756c 2874 6578 745f 656d  s.matmul(text_em
+000083c0: 6265 6473 2c20 696d 6167 655f 656d 6265  beds, image_embe
+000083d0: 6473 2e74 2829 2920 2a20 6c6f 6769 745f  ds.t()) * logit_
+000083e0: 7363 616c 650a 2020 2020 2020 2020 6c6f  scale.        lo
+000083f0: 6769 7473 5f70 6572 5f69 6d61 6765 203d  gits_per_image =
+00008400: 206c 6f67 6974 735f 7065 725f 7465 7874   logits_per_text
+00008410: 2e74 2829 0a0a 2020 2020 2020 2020 6c6f  .t()..        lo
+00008420: 7373 203d 204e 6f6e 650a 2020 2020 2020  ss = None.      
+00008430: 2020 6966 2072 6574 7572 6e5f 6c6f 7373    if return_loss
+00008440: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
+00008450: 7373 203d 2062 6c69 705f 6c6f 7373 286c  ss = blip_loss(l
+00008460: 6f67 6974 735f 7065 725f 7465 7874 290a  ogits_per_text).
+00008470: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+00008480: 7265 7475 726e 5f64 6963 743a 0a20 2020  return_dict:.   
+00008490: 2020 2020 2020 2020 206f 7574 7075 7420           output 
+000084a0: 3d20 286c 6f67 6974 735f 7065 725f 696d  = (logits_per_im
+000084b0: 6167 652c 206c 6f67 6974 735f 7065 725f  age, logits_per_
+000084c0: 7465 7874 2c20 7465 7874 5f65 6d62 6564  text, text_embed
+000084d0: 732c 2069 6d61 6765 5f65 6d62 6564 732c  s, image_embeds,
+000084e0: 2074 6578 745f 6f75 7470 7574 732c 2076   text_outputs, v
+000084f0: 6973 696f 6e5f 6f75 7470 7574 7329 0a20  ision_outputs). 
+00008500: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00008510: 6e20 2828 6c6f 7373 2c29 202b 206f 7574  n ((loss,) + out
+00008520: 7075 7429 2069 6620 6c6f 7373 2069 7320  put) if loss is 
+00008530: 6e6f 7420 4e6f 6e65 2065 6c73 6520 6f75  not None else ou
+00008540: 7470 7574 0a0a 2020 2020 2020 2020 7265  tput..        re
+00008550: 7475 726e 2042 6c69 704f 7574 7075 7428  turn BlipOutput(
+00008560: 0a20 2020 2020 2020 2020 2020 206c 6f73  .            los
+00008570: 733d 6c6f 7373 2c0a 2020 2020 2020 2020  s=loss,.        
+00008580: 2020 2020 6c6f 6769 7473 5f70 6572 5f69      logits_per_i
+00008590: 6d61 6765 3d6c 6f67 6974 735f 7065 725f  mage=logits_per_
+000085a0: 696d 6167 652c 0a20 2020 2020 2020 2020  image,.         
+000085b0: 2020 206c 6f67 6974 735f 7065 725f 7465     logits_per_te
+000085c0: 7874 3d6c 6f67 6974 735f 7065 725f 7465  xt=logits_per_te
+000085d0: 7874 2c0a 2020 2020 2020 2020 2020 2020  xt,.            
+000085e0: 7465 7874 5f65 6d62 6564 733d 7465 7874  text_embeds=text
+000085f0: 5f65 6d62 6564 732c 0a20 2020 2020 2020  _embeds,.       
+00008600: 2020 2020 2069 6d61 6765 5f65 6d62 6564       image_embed
+00008610: 733d 696d 6167 655f 656d 6265 6473 2c0a  s=image_embeds,.
+00008620: 2020 2020 2020 2020 2020 2020 7465 7874              text
+00008630: 5f6d 6f64 656c 5f6f 7574 7075 743d 7465  _model_output=te
+00008640: 7874 5f6f 7574 7075 7473 2c0a 2020 2020  xt_outputs,.    
+00008650: 2020 2020 2020 2020 7669 7369 6f6e 5f6d          vision_m
+00008660: 6f64 656c 5f6f 7574 7075 743d 7669 7369  odel_output=visi
+00008670: 6f6e 5f6f 7574 7075 7473 2c0a 2020 2020  on_outputs,.    
+00008680: 2020 2020 290a 0a0a 636c 6173 7320 426c      )...class Bl
+00008690: 6970 466f 7243 6f6e 6469 7469 6f6e 616c  ipForConditional
+000086a0: 4765 6e65 7261 7469 6f6e 2842 6c69 7050  Generation(BlipP
+000086b0: 7265 5472 6169 6e65 644d 6f64 656c 293a  reTrainedModel):
+000086c0: 0a20 2020 2063 6f6e 6669 675f 636c 6173  .    config_clas
+000086d0: 7320 3d20 426c 6970 436f 6e66 6967 0a20  s = BlipConfig. 
+000086e0: 2020 205f 7469 6564 5f77 6569 6768 7473     _tied_weights
+000086f0: 5f6b 6579 7320 3d20 5b22 7465 7874 5f64  _keys = ["text_d
+00008700: 6563 6f64 6572 2e63 6c73 2e70 7265 6469  ecoder.cls.predi
+00008710: 6374 696f 6e73 2e64 6563 6f64 6572 2e62  ctions.decoder.b
+00008720: 6961 7322 5d0a 2020 2020 6d61 696e 5f69  ias"].    main_i
+00008730: 6e70 7574 5f6e 616d 6520 3d20 2270 6978  nput_name = "pix
+00008740: 656c 5f76 616c 7565 7322 0a0a 2020 2020  el_values"..    
+00008750: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
+00008760: 662c 2063 6f6e 6669 673a 2042 6c69 7043  f, config: BlipC
+00008770: 6f6e 6669 6729 3a0a 2020 2020 2020 2020  onfig):.        
+00008780: 7375 7065 7228 292e 5f5f 696e 6974 5f5f  super().__init__
+00008790: 2863 6f6e 6669 6729 0a0a 2020 2020 2020  (config)..      
+000087a0: 2020 7365 6c66 2e76 6973 696f 6e5f 6d6f    self.vision_mo
+000087b0: 6465 6c20 3d20 426c 6970 5669 7369 6f6e  del = BlipVision
+000087c0: 4d6f 6465 6c28 636f 6e66 6967 2e76 6973  Model(config.vis
+000087d0: 696f 6e5f 636f 6e66 6967 290a 0a20 2020  ion_config)..   
+000087e0: 2020 2020 2073 656c 662e 7465 7874 5f64       self.text_d
+000087f0: 6563 6f64 6572 203d 2042 6c69 7054 6578  ecoder = BlipTex
+00008800: 744c 4d48 6561 644d 6f64 656c 2863 6f6e  tLMHeadModel(con
+00008810: 6669 672e 7465 7874 5f63 6f6e 6669 6729  fig.text_config)
+00008820: 0a0a 2020 2020 2020 2020 7365 6c66 2e64  ..        self.d
+00008830: 6563 6f64 6572 5f69 6e70 7574 5f69 6473  ecoder_input_ids
+00008840: 203d 2063 6f6e 6669 672e 7465 7874 5f63   = config.text_c
+00008850: 6f6e 6669 672e 626f 735f 746f 6b65 6e5f  onfig.bos_token_
+00008860: 6964 0a20 2020 2020 2020 2073 656c 662e  id.        self.
+00008870: 6465 636f 6465 725f 7061 645f 746f 6b65  decoder_pad_toke
+00008880: 6e5f 6964 203d 2063 6f6e 6669 672e 7465  n_id = config.te
+00008890: 7874 5f63 6f6e 6669 672e 7061 645f 746f  xt_config.pad_to
+000088a0: 6b65 6e5f 6964 0a0a 2020 2020 2020 2020  ken_id..        
+000088b0: 2320 496e 6974 6961 6c69 7a65 2077 6569  # Initialize wei
+000088c0: 6768 7473 2061 6e64 2061 7070 6c79 2066  ghts and apply f
+000088d0: 696e 616c 2070 726f 6365 7373 696e 670a  inal processing.
+000088e0: 2020 2020 2020 2020 7365 6c66 2e70 6f73          self.pos
+000088f0: 745f 696e 6974 2829 0a0a 2020 2020 6465  t_init()..    de
+00008900: 6620 6765 745f 696e 7075 745f 656d 6265  f get_input_embe
+00008910: 6464 696e 6773 2873 656c 6629 202d 3e20  ddings(self) -> 
+00008920: 6e6e 2e43 656c 6c3a 0a20 2020 2020 2020  nn.Cell:.       
+00008930: 2072 6574 7572 6e20 7365 6c66 2e76 6973   return self.vis
+00008940: 696f 6e5f 6d6f 6465 6c2e 656d 6265 6464  ion_model.embedd
+00008950: 696e 6773 2e70 6174 6368 5f65 6d62 6564  ings.patch_embed
+00008960: 6469 6e67 0a0a 2020 2020 6465 6620 636f  ding..    def co
+00008970: 6e73 7472 7563 7428 0a20 2020 2020 2020  nstruct(.       
+00008980: 2073 656c 662c 0a20 2020 2020 2020 2070   self,.        p
+00008990: 6978 656c 5f76 616c 7565 733a 206d 696e  ixel_values: min
+000089a0: 6473 706f 7265 2e54 656e 736f 722c 0a20  dspore.Tensor,. 
+000089b0: 2020 2020 2020 2069 6e70 7574 5f69 6473         input_ids
+000089c0: 3a20 4f70 7469 6f6e 616c 5b6d 696e 6473  : Optional[minds
+000089d0: 706f 7265 2e54 656e 736f 725d 203d 204e  pore.Tensor] = N
+000089e0: 6f6e 652c 0a20 2020 2020 2020 2061 7474  one,.        att
+000089f0: 656e 7469 6f6e 5f6d 6173 6b3a 204f 7074  ention_mask: Opt
+00008a00: 696f 6e61 6c5b 6d69 6e64 7370 6f72 652e  ional[mindspore.
+00008a10: 5465 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a  Tensor] = None,.
+00008a20: 2020 2020 2020 2020 6f75 7470 7574 5f61          output_a
+00008a30: 7474 656e 7469 6f6e 733a 204f 7074 696f  ttentions: Optio
+00008a40: 6e61 6c5b 626f 6f6c 5d20 3d20 4e6f 6e65  nal[bool] = None
+00008a50: 2c0a 2020 2020 2020 2020 6f75 7470 7574  ,.        output
+00008a60: 5f68 6964 6465 6e5f 7374 6174 6573 3a20  _hidden_states: 
+00008a70: 4f70 7469 6f6e 616c 5b62 6f6f 6c5d 203d  Optional[bool] =
+00008a80: 204e 6f6e 652c 0a20 2020 2020 2020 206c   None,.        l
+00008a90: 6162 656c 733a 204f 7074 696f 6e61 6c5b  abels: Optional[
+00008aa0: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+00008ab0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+00008ac0: 2020 7265 7475 726e 5f64 6963 743a 204f    return_dict: O
+00008ad0: 7074 696f 6e61 6c5b 626f 6f6c 5d20 3d20  ptional[bool] = 
+00008ae0: 4e6f 6e65 2c0a 2020 2020 2920 2d3e 2055  None,.    ) -> U
+00008af0: 6e69 6f6e 5b54 7570 6c65 2c20 426c 6970  nion[Tuple, Blip
+00008b00: 466f 7243 6f6e 6469 7469 6f6e 616c 4765  ForConditionalGe
+00008b10: 6e65 7261 7469 6f6e 4d6f 6465 6c4f 7574  nerationModelOut
+00008b20: 7075 745d 3a0a 2020 2020 2020 2020 7222  put]:.        r"
+00008b30: 2222 0a20 2020 2020 2020 2052 6574 7572  "".        Retur
+00008b40: 6e73 3a0a 0a20 2020 2020 2020 2045 7861  ns:..        Exa
+00008b50: 6d70 6c65 733a 0a0a 2020 2020 2020 2020  mples:..        
+00008b60: 6060 6070 7974 686f 6e0a 2020 2020 2020  ```python.      
+00008b70: 2020 3e3e 3e20 6672 6f6d 2050 494c 2069    >>> from PIL i
+00008b80: 6d70 6f72 7420 496d 6167 650a 2020 2020  mport Image.    
+00008b90: 2020 2020 3e3e 3e20 696d 706f 7274 2072      >>> import r
+00008ba0: 6571 7565 7374 730a 2020 2020 2020 2020  equests.        
+00008bb0: 3e3e 3e20 6672 6f6d 2074 7261 6e73 666f  >>> from transfo
+00008bc0: 726d 6572 7320 696d 706f 7274 2041 7574  rmers import Aut
+00008bd0: 6f50 726f 6365 7373 6f72 2c20 426c 6970  oProcessor, Blip
+00008be0: 466f 7243 6f6e 6469 7469 6f6e 616c 4765  ForConditionalGe
+00008bf0: 6e65 7261 7469 6f6e 0a0a 2020 2020 2020  neration..      
+00008c00: 2020 3e3e 3e20 7072 6f63 6573 736f 7220    >>> processor 
+00008c10: 3d20 4175 746f 5072 6f63 6573 736f 722e  = AutoProcessor.
+00008c20: 6672 6f6d 5f70 7265 7472 6169 6e65 6428  from_pretrained(
+00008c30: 2253 616c 6573 666f 7263 652f 626c 6970  "Salesforce/blip
+00008c40: 2d69 6d61 6765 2d63 6170 7469 6f6e 696e  -image-captionin
+00008c50: 672d 6261 7365 2229 0a20 2020 2020 2020  g-base").       
+00008c60: 203e 3e3e 206d 6f64 656c 203d 2042 6c69   >>> model = Bli
+00008c70: 7046 6f72 436f 6e64 6974 696f 6e61 6c47  pForConditionalG
+00008c80: 656e 6572 6174 696f 6e2e 6672 6f6d 5f70  eneration.from_p
+00008c90: 7265 7472 6169 6e65 6428 2253 616c 6573  retrained("Sales
+00008ca0: 666f 7263 652f 626c 6970 2d69 6d61 6765  force/blip-image
+00008cb0: 2d63 6170 7469 6f6e 696e 672d 6261 7365  -captioning-base
+00008cc0: 2229 0a0a 2020 2020 2020 2020 3e3e 3e20  ")..        >>> 
+00008cd0: 7572 6c20 3d20 2268 7474 703a 2f2f 696d  url = "http://im
+00008ce0: 6167 6573 2e63 6f63 6f64 6174 6173 6574  ages.cocodataset
+00008cf0: 2e6f 7267 2f76 616c 3230 3137 2f30 3030  .org/val2017/000
+00008d00: 3030 3030 3339 3736 392e 6a70 6722 0a20  000039769.jpg". 
+00008d10: 2020 2020 2020 203e 3e3e 2069 6d61 6765         >>> image
+00008d20: 203d 2049 6d61 6765 2e6f 7065 6e28 7265   = Image.open(re
+00008d30: 7175 6573 7473 2e67 6574 2875 726c 2c20  quests.get(url, 
+00008d40: 7374 7265 616d 3d54 7275 6529 2e72 6177  stream=True).raw
+00008d50: 290a 2020 2020 2020 2020 3e3e 3e20 7465  ).        >>> te
+00008d60: 7874 203d 2022 4120 7069 6374 7572 6520  xt = "A picture 
+00008d70: 6f66 220a 0a20 2020 2020 2020 203e 3e3e  of"..        >>>
+00008d80: 2069 6e70 7574 7320 3d20 7072 6f63 6573   inputs = proces
+00008d90: 736f 7228 696d 6167 6573 3d69 6d61 6765  sor(images=image
+00008da0: 2c20 7465 7874 3d74 6578 742c 2072 6574  , text=text, ret
+00008db0: 7572 6e5f 7465 6e73 6f72 733d 2270 7422  urn_tensors="pt"
+00008dc0: 290a 0a20 2020 2020 2020 203e 3e3e 206f  )..        >>> o
+00008dd0: 7574 7075 7473 203d 206d 6f64 656c 282a  utputs = model(*
+00008de0: 2a69 6e70 7574 7329 0a20 2020 2020 2020  *inputs).       
+00008df0: 2060 6060 2222 220a 0a20 2020 2020 2020   ```"""..       
+00008e00: 2072 6574 7572 6e5f 6469 6374 203d 2072   return_dict = r
+00008e10: 6574 7572 6e5f 6469 6374 2069 6620 7265  eturn_dict if re
+00008e20: 7475 726e 5f64 6963 7420 6973 206e 6f74  turn_dict is not
+00008e30: 204e 6f6e 6520 656c 7365 2073 656c 662e   None else self.
+00008e40: 636f 6e66 6967 2e75 7365 5f72 6574 7572  config.use_retur
+00008e50: 6e5f 6469 6374 0a20 2020 2020 2020 206f  n_dict.        o
+00008e60: 7574 7075 745f 6174 7465 6e74 696f 6e73  utput_attentions
+00008e70: 203d 206f 7574 7075 745f 6174 7465 6e74   = output_attent
+00008e80: 696f 6e73 2069 6620 6f75 7470 7574 5f61  ions if output_a
+00008e90: 7474 656e 7469 6f6e 7320 6973 206e 6f74  ttentions is not
+00008ea0: 204e 6f6e 6520 656c 7365 2073 656c 662e   None else self.
+00008eb0: 636f 6e66 6967 2e6f 7574 7075 745f 6174  config.output_at
+00008ec0: 7465 6e74 696f 6e73 0a20 2020 2020 2020  tentions.       
+00008ed0: 206f 7574 7075 745f 6869 6464 656e 5f73   output_hidden_s
+00008ee0: 7461 7465 7320 3d20 280a 2020 2020 2020  tates = (.      
+00008ef0: 2020 2020 2020 6f75 7470 7574 5f68 6964        output_hid
+00008f00: 6465 6e5f 7374 6174 6573 2069 6620 6f75  den_states if ou
+00008f10: 7470 7574 5f68 6964 6465 6e5f 7374 6174  tput_hidden_stat
+00008f20: 6573 2069 7320 6e6f 7420 4e6f 6e65 2065  es is not None e
+00008f30: 6c73 6520 7365 6c66 2e63 6f6e 6669 672e  lse self.config.
+00008f40: 6f75 7470 7574 5f68 6964 6465 6e5f 7374  output_hidden_st
+00008f50: 6174 6573 0a20 2020 2020 2020 2029 0a0a  ates.        )..
+00008f60: 2020 2020 2020 2020 7669 7369 6f6e 5f6f          vision_o
+00008f70: 7574 7075 7473 203d 2073 656c 662e 7669  utputs = self.vi
+00008f80: 7369 6f6e 5f6d 6f64 656c 280a 2020 2020  sion_model(.    
+00008f90: 2020 2020 2020 2020 7069 7865 6c5f 7661          pixel_va
+00008fa0: 6c75 6573 3d70 6978 656c 5f76 616c 7565  lues=pixel_value
+00008fb0: 732c 0a20 2020 2020 2020 2020 2020 206f  s,.            o
+00008fc0: 7574 7075 745f 6174 7465 6e74 696f 6e73  utput_attentions
+00008fd0: 3d6f 7574 7075 745f 6174 7465 6e74 696f  =output_attentio
+00008fe0: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
+00008ff0: 6f75 7470 7574 5f68 6964 6465 6e5f 7374  output_hidden_st
+00009000: 6174 6573 3d6f 7574 7075 745f 6869 6464  ates=output_hidd
+00009010: 656e 5f73 7461 7465 732c 0a20 2020 2020  en_states,.     
+00009020: 2020 2020 2020 2072 6574 7572 6e5f 6469         return_di
+00009030: 6374 3d72 6574 7572 6e5f 6469 6374 2c0a  ct=return_dict,.
+00009040: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00009050: 2020 2069 6d61 6765 5f65 6d62 6564 7320     image_embeds 
+00009060: 3d20 7669 7369 6f6e 5f6f 7574 7075 7473  = vision_outputs
+00009070: 5b30 5d0a 0a20 2020 2020 2020 206f 7574  [0]..        out
+00009080: 7075 7473 203d 2073 656c 662e 7465 7874  puts = self.text
+00009090: 5f64 6563 6f64 6572 280a 2020 2020 2020  _decoder(.      
+000090a0: 2020 2020 2020 696e 7075 745f 6964 733d        input_ids=
+000090b0: 696e 7075 745f 6964 732c 0a20 2020 2020  input_ids,.     
+000090c0: 2020 2020 2020 2061 7474 656e 7469 6f6e         attention
+000090d0: 5f6d 6173 6b3d 6174 7465 6e74 696f 6e5f  _mask=attention_
+000090e0: 6d61 736b 2c0a 2020 2020 2020 2020 2020  mask,.          
+000090f0: 2020 656e 636f 6465 725f 6869 6464 656e    encoder_hidden
+00009100: 5f73 7461 7465 733d 696d 6167 655f 656d  _states=image_em
+00009110: 6265 6473 2c0a 2020 2020 2020 2020 2020  beds,.          
+00009120: 2020 6c61 6265 6c73 3d6c 6162 656c 732c    labels=labels,
+00009130: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00009140: 7572 6e5f 6469 6374 3d72 6574 7572 6e5f  urn_dict=return_
+00009150: 6469 6374 2c0a 2020 2020 2020 2020 2020  dict,.          
+00009160: 2020 7265 6475 6374 696f 6e3d 226d 6561    reduction="mea
+00009170: 6e22 2c0a 2020 2020 2020 2020 290a 0a20  n",.        ).. 
+00009180: 2020 2020 2020 2069 6620 6e6f 7420 7265         if not re
+00009190: 7475 726e 5f64 6963 743a 0a20 2020 2020  turn_dict:.     
+000091a0: 2020 2020 2020 206f 7574 7075 7473 203d         outputs =
+000091b0: 2028 6f75 7470 7574 735b 305d 2c20 6f75   (outputs[0], ou
+000091c0: 7470 7574 735b 315d 2c20 696d 6167 655f  tputs[1], image_
+000091d0: 656d 6265 6473 2c20 7669 7369 6f6e 5f6f  embeds, vision_o
+000091e0: 7574 7075 7473 5b30 5d29 202b 2076 6973  utputs[0]) + vis
+000091f0: 696f 6e5f 6f75 7470 7574 735b 323a 5d0a  ion_outputs[2:].
+00009200: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00009210: 726e 2074 7570 6c65 286f 7574 7075 7420  rn tuple(output 
+00009220: 666f 7220 6f75 7470 7574 2069 6e20 6f75  for output in ou
+00009230: 7470 7574 7320 6966 206f 7574 7075 7420  tputs if output 
+00009240: 6973 206e 6f74 204e 6f6e 6529 0a0a 2020  is not None)..  
+00009250: 2020 2020 2020 7265 7475 726e 2042 6c69        return Bli
+00009260: 7046 6f72 436f 6e64 6974 696f 6e61 6c47  pForConditionalG
+00009270: 656e 6572 6174 696f 6e4d 6f64 656c 4f75  enerationModelOu
+00009280: 7470 7574 280a 2020 2020 2020 2020 2020  tput(.          
+00009290: 2020 6c6f 7373 3d6f 7574 7075 7473 2e6c    loss=outputs.l
+000092a0: 6f73 732c 0a20 2020 2020 2020 2020 2020  oss,.           
+000092b0: 206c 6f67 6974 733d 6f75 7470 7574 732e   logits=outputs.
+000092c0: 6c6f 6769 7473 2c0a 2020 2020 2020 2020  logits,.        
+000092d0: 2020 2020 696d 6167 655f 656d 6265 6473      image_embeds
+000092e0: 3d69 6d61 6765 5f65 6d62 6564 732c 0a20  =image_embeds,. 
+000092f0: 2020 2020 2020 2020 2020 206c 6173 745f             last_
+00009300: 6869 6464 656e 5f73 7461 7465 3d76 6973  hidden_state=vis
+00009310: 696f 6e5f 6f75 7470 7574 732e 6c61 7374  ion_outputs.last
+00009320: 5f68 6964 6465 6e5f 7374 6174 652c 0a20  _hidden_state,. 
+00009330: 2020 2020 2020 2020 2020 2068 6964 6465             hidde
+00009340: 6e5f 7374 6174 6573 3d76 6973 696f 6e5f  n_states=vision_
+00009350: 6f75 7470 7574 732e 6869 6464 656e 5f73  outputs.hidden_s
+00009360: 7461 7465 732c 0a20 2020 2020 2020 2020  tates,.         
+00009370: 2020 2061 7474 656e 7469 6f6e 733d 7669     attentions=vi
+00009380: 7369 6f6e 5f6f 7574 7075 7473 2e61 7474  sion_outputs.att
+00009390: 656e 7469 6f6e 732c 0a20 2020 2020 2020  entions,.       
+000093a0: 2029 0a0a 2020 2020 6465 6620 6765 6e65   )..    def gene
+000093b0: 7261 7465 280a 2020 2020 2020 2020 7365  rate(.        se
+000093c0: 6c66 2c0a 2020 2020 2020 2020 7069 7865  lf,.        pixe
+000093d0: 6c5f 7661 6c75 6573 3a20 6d69 6e64 7370  l_values: mindsp
+000093e0: 6f72 652e 5465 6e73 6f72 2c0a 2020 2020  ore.Tensor,.    
+000093f0: 2020 2020 696e 7075 745f 6964 733a 204f      input_ids: O
+00009400: 7074 696f 6e61 6c5b 6d69 6e64 7370 6f72  ptional[mindspor
+00009410: 652e 5465 6e73 6f72 5d20 3d20 4e6f 6e65  e.Tensor] = None
+00009420: 2c0a 2020 2020 2020 2020 6174 7465 6e74  ,.        attent
+00009430: 696f 6e5f 6d61 736b 3a20 4f70 7469 6f6e  ion_mask: Option
+00009440: 616c 5b6d 696e 6473 706f 7265 2e54 656e  al[mindspore.Ten
+00009450: 736f 725d 203d 204e 6f6e 652c 0a20 2020  sor] = None,.   
+00009460: 2020 2020 202a 2a67 656e 6572 6174 655f       **generate_
+00009470: 6b77 6172 6773 2c0a 2020 2020 2920 2d3e  kwargs,.    ) ->
+00009480: 206d 696e 6473 706f 7265 2e54 656e 736f   mindspore.Tenso
+00009490: 723a 0a20 2020 2020 2020 2072 2222 220a  r:.        r""".
+000094a0: 2020 2020 2020 2020 4f76 6572 7269 6465          Override
+000094b0: 7320 2a67 656e 6572 6174 652a 2066 756e  s *generate* fun
+000094c0: 6374 696f 6e20 746f 2062 6520 6162 6c65  ction to be able
+000094d0: 2074 6f20 7573 6520 7468 6520 6d6f 6465   to use the mode
+000094e0: 6c20 6173 2061 2063 6f6e 6469 7469 6f6e  l as a condition
+000094f0: 616c 2067 656e 6572 6174 6f72 0a0a 2020  al generator..  
+00009500: 2020 2020 2020 5061 7261 6d65 7465 7273        Parameters
+00009510: 3a0a 2020 2020 2020 2020 2020 2020 7069  :.            pi
+00009520: 7865 6c5f 7661 6c75 6573 2028 2a6d 696e  xel_values (*min
+00009530: 6473 706f 7265 2e54 656e 736f 722a 206f  dspore.Tensor* o
+00009540: 6620 7368 6170 6520 2a28 6261 7463 685f  f shape *(batch_
+00009550: 7369 7a65 2c20 6e75 6d5f 6368 616e 6e65  size, num_channe
+00009560: 6c73 2c20 696d 6167 655f 6865 6967 6874  ls, image_height
+00009570: 2c20 696d 6167 655f 7769 6474 6829 2a3a  , image_width)*:
+00009580: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009590: 2049 6e70 7574 2069 6d61 6765 2074 6f20   Input image to 
+000095a0: 6265 2070 726f 6365 7373 6564 0a20 2020  be processed.   
+000095b0: 2020 2020 2020 2020 2069 6e70 7574 5f69           input_i
+000095c0: 6473 2028 2a6d 696e 6473 706f 7265 2e54  ds (*mindspore.T
+000095d0: 656e 736f 722a 206f 6620 7368 6170 6520  ensor* of shape 
+000095e0: 2a28 6261 7463 685f 7369 7a65 2c20 7365  *(batch_size, se
+000095f0: 7175 656e 6365 5f6c 656e 6774 6829 2a2c  quence_length)*,
+00009600: 202a 6f70 7469 6f6e 616c 2a29 3a0a 2020   *optional*):.  
+00009610: 2020 2020 2020 2020 2020 2020 2020 5468                Th
+00009620: 6520 7365 7175 656e 6365 2075 7365 6420  e sequence used 
+00009630: 6173 2061 2070 726f 6d70 7420 666f 7220  as a prompt for 
+00009640: 7468 6520 6765 6e65 7261 7469 6f6e 2e0a  the generation..
+00009650: 2020 2020 2020 2020 2020 2020 6174 7465              atte
+00009660: 6e74 696f 6e5f 6d61 736b 2028 2a6d 696e  ntion_mask (*min
+00009670: 6473 706f 7265 2e54 656e 736f 722a 206f  dspore.Tensor* o
+00009680: 6620 7368 6170 6520 2a28 6261 7463 685f  f shape *(batch_
+00009690: 7369 7a65 2c20 7365 7175 656e 6365 5f6c  size, sequence_l
+000096a0: 656e 6774 6829 2a2c 202a 6f70 7469 6f6e  ength)*, *option
+000096b0: 616c 2a29 3a0a 2020 2020 2020 2020 2020  al*):.          
+000096c0: 2020 2020 2020 4d61 736b 2074 6f20 6176        Mask to av
+000096d0: 6f69 6420 7065 7266 6f72 6d69 6e67 2061  oid performing a
+000096e0: 7474 656e 7469 6f6e 206f 6e20 7061 6464  ttention on padd
+000096f0: 696e 6720 746f 6b65 6e20 696e 6469 6365  ing token indice
+00009700: 732e 204d 6173 6b20 7661 6c75 6573 2073  s. Mask values s
+00009710: 656c 6563 7465 6420 696e 2060 5b30 2c20  elected in `[0, 
+00009720: 315d 603a 0a0a 0a20 2020 2020 2020 2045  1]`:...        E
+00009730: 7861 6d70 6c65 733a 0a20 2020 2020 2020  xamples:.       
+00009740: 2060 6060 7079 7468 6f6e 0a20 2020 2020   ```python.     
+00009750: 2020 203e 3e3e 2066 726f 6d20 5049 4c20     >>> from PIL 
+00009760: 696d 706f 7274 2049 6d61 6765 0a20 2020  import Image.   
+00009770: 2020 2020 203e 3e3e 2069 6d70 6f72 7420       >>> import 
+00009780: 7265 7175 6573 7473 0a20 2020 2020 2020  requests.       
+00009790: 203e 3e3e 2066 726f 6d20 7472 616e 7366   >>> from transf
+000097a0: 6f72 6d65 7273 2069 6d70 6f72 7420 4175  ormers import Au
+000097b0: 746f 5072 6f63 6573 736f 722c 2042 6c69  toProcessor, Bli
+000097c0: 7046 6f72 436f 6e64 6974 696f 6e61 6c47  pForConditionalG
+000097d0: 656e 6572 6174 696f 6e0a 0a20 2020 2020  eneration..     
+000097e0: 2020 203e 3e3e 206d 6f64 656c 203d 2042     >>> model = B
+000097f0: 6c69 7046 6f72 436f 6e64 6974 696f 6e61  lipForConditiona
+00009800: 6c47 656e 6572 6174 696f 6e2e 6672 6f6d  lGeneration.from
+00009810: 5f70 7265 7472 6169 6e65 6428 2253 616c  _pretrained("Sal
+00009820: 6573 666f 7263 652f 626c 6970 2d69 6d61  esforce/blip-ima
+00009830: 6765 2d63 6170 7469 6f6e 696e 672d 6261  ge-captioning-ba
+00009840: 7365 2229 0a20 2020 2020 2020 203e 3e3e  se").        >>>
+00009850: 2070 726f 6365 7373 6f72 203d 2041 7574   processor = Aut
+00009860: 6f50 726f 6365 7373 6f72 2e66 726f 6d5f  oProcessor.from_
+00009870: 7072 6574 7261 696e 6564 2822 5361 6c65  pretrained("Sale
+00009880: 7366 6f72 6365 2f62 6c69 702d 696d 6167  sforce/blip-imag
+00009890: 652d 6361 7074 696f 6e69 6e67 2d62 6173  e-captioning-bas
+000098a0: 6522 290a 0a20 2020 2020 2020 203e 3e3e  e")..        >>>
+000098b0: 2075 726c 203d 2022 6874 7470 3a2f 2f69   url = "http://i
+000098c0: 6d61 6765 732e 636f 636f 6461 7461 7365  mages.cocodatase
+000098d0: 742e 6f72 672f 7661 6c32 3031 372f 3030  t.org/val2017/00
+000098e0: 3030 3030 3033 3937 3639 2e6a 7067 220a  0000039769.jpg".
+000098f0: 2020 2020 2020 2020 3e3e 3e20 696d 6167          >>> imag
+00009900: 6520 3d20 496d 6167 652e 6f70 656e 2872  e = Image.open(r
+00009910: 6571 7565 7374 732e 6765 7428 7572 6c2c  equests.get(url,
+00009920: 2073 7472 6561 6d3d 5472 7565 292e 7261   stream=True).ra
+00009930: 7729 0a0a 2020 2020 2020 2020 3e3e 3e20  w)..        >>> 
+00009940: 696e 7075 7473 203d 2070 726f 6365 7373  inputs = process
+00009950: 6f72 2869 6d61 6765 733d 696d 6167 652c  or(images=image,
+00009960: 2072 6574 7572 6e5f 7465 6e73 6f72 733d   return_tensors=
+00009970: 2270 7422 290a 0a20 2020 2020 2020 203e  "pt")..        >
+00009980: 3e3e 206f 7574 7075 7473 203d 206d 6f64  >> outputs = mod
+00009990: 656c 2e67 656e 6572 6174 6528 2a2a 696e  el.generate(**in
+000099a0: 7075 7473 290a 2020 2020 2020 2020 3e3e  puts).        >>
+000099b0: 3e20 7072 696e 7428 7072 6f63 6573 736f  > print(processo
+000099c0: 722e 6465 636f 6465 286f 7574 7075 7473  r.decode(outputs
+000099d0: 5b30 5d2c 2073 6b69 705f 7370 6563 6961  [0], skip_specia
+000099e0: 6c5f 746f 6b65 6e73 3d54 7275 6529 290a  l_tokens=True)).
+000099f0: 2020 2020 2020 2020 7477 6f20 6361 7473          two cats
+00009a00: 2073 6c65 6570 696e 6720 6f6e 2061 2063   sleeping on a c
+00009a10: 6f75 6368 0a20 2020 2020 2020 2060 6060  ouch.        ```
+00009a20: 0a20 2020 2020 2020 2022 2222 0a0a 2020  .        """..  
+00009a30: 2020 2020 2020 6261 7463 685f 7369 7a65        batch_size
+00009a40: 203d 2070 6978 656c 5f76 616c 7565 732e   = pixel_values.
+00009a50: 7368 6170 655b 305d 0a20 2020 2020 2020  shape[0].       
+00009a60: 2076 6973 696f 6e5f 6f75 7470 7574 7320   vision_outputs 
+00009a70: 3d20 7365 6c66 2e76 6973 696f 6e5f 6d6f  = self.vision_mo
+00009a80: 6465 6c28 7069 7865 6c5f 7661 6c75 6573  del(pixel_values
+00009a90: 3d70 6978 656c 5f76 616c 7565 7329 0a0a  =pixel_values)..
+00009aa0: 2020 2020 2020 2020 696d 6167 655f 656d          image_em
+00009ab0: 6265 6473 203d 2076 6973 696f 6e5f 6f75  beds = vision_ou
+00009ac0: 7470 7574 735b 305d 0a0a 2020 2020 2020  tputs[0]..      
+00009ad0: 2020 696d 6167 655f 6174 7465 6e74 696f    image_attentio
+00009ae0: 6e5f 6d61 736b 203d 206f 7073 2e6f 6e65  n_mask = ops.one
+00009af0: 7328 696d 6167 655f 656d 6265 6473 2e73  s(image_embeds.s
+00009b00: 6861 7065 5b3a 2d31 5d2c 2064 7479 7065  hape[:-1], dtype
+00009b10: 3d6d 696e 6473 706f 7265 2e69 6e74 3634  =mindspore.int64
+00009b20: 290a 0a20 2020 2020 2020 2069 6620 6973  )..        if is
+00009b30: 696e 7374 616e 6365 2869 6e70 7574 5f69  instance(input_i
+00009b40: 6473 2c20 6c69 7374 293a 0a20 2020 2020  ds, list):.     
+00009b50: 2020 2020 2020 2069 6e70 7574 5f69 6473         input_ids
+00009b60: 203d 206d 696e 6473 706f 7265 2e54 656e   = mindspore.Ten
+00009b70: 736f 7228 696e 7075 745f 6964 7329 0a20  sor(input_ids). 
+00009b80: 2020 2020 2020 2065 6c69 6620 696e 7075         elif inpu
+00009b90: 745f 6964 7320 6973 204e 6f6e 653a 0a20  t_ids is None:. 
+00009ba0: 2020 2020 2020 2020 2020 2069 6e70 7574             input
+00009bb0: 5f69 6473 203d 2028 0a20 2020 2020 2020  _ids = (.       
+00009bc0: 2020 2020 2020 2020 206d 696e 6473 706f           mindspo
+00009bd0: 7265 2e54 656e 736f 7228 5b5b 7365 6c66  re.Tensor([[self
+00009be0: 2e64 6563 6f64 6572 5f69 6e70 7574 5f69  .decoder_input_i
+00009bf0: 6473 2c20 7365 6c66 2e63 6f6e 6669 672e  ds, self.config.
+00009c00: 7465 7874 5f63 6f6e 6669 672e 656f 735f  text_config.eos_
+00009c10: 746f 6b65 6e5f 6964 5d5d 290a 2020 2020  token_id]]).    
+00009c20: 2020 2020 2020 2020 2020 2020 2e72 6570              .rep
+00009c30: 6561 7428 6261 7463 685f 7369 7a65 2c20  eat(batch_size, 
+00009c40: 3129 0a20 2020 2020 2020 2020 2020 2029  1).            )
+00009c50: 0a0a 2020 2020 2020 2020 696e 7075 745f  ..        input_
+00009c60: 6964 735b 3a2c 2030 5d20 3d20 7365 6c66  ids[:, 0] = self
+00009c70: 2e63 6f6e 6669 672e 7465 7874 5f63 6f6e  .config.text_con
+00009c80: 6669 672e 626f 735f 746f 6b65 6e5f 6964  fig.bos_token_id
+00009c90: 0a20 2020 2020 2020 2061 7474 656e 7469  .        attenti
+00009ca0: 6f6e 5f6d 6173 6b20 3d20 6174 7465 6e74  on_mask = attent
+00009cb0: 696f 6e5f 6d61 736b 5b3a 2c20 3a2d 315d  ion_mask[:, :-1]
+00009cc0: 2069 6620 6174 7465 6e74 696f 6e5f 6d61   if attention_ma
+00009cd0: 736b 2069 7320 6e6f 7420 4e6f 6e65 2065  sk is not None e
+00009ce0: 6c73 6520 4e6f 6e65 0a0a 2020 2020 2020  lse None..      
+00009cf0: 2020 6f75 7470 7574 7320 3d20 7365 6c66    outputs = self
+00009d00: 2e74 6578 745f 6465 636f 6465 722e 6765  .text_decoder.ge
+00009d10: 6e65 7261 7465 280a 2020 2020 2020 2020  nerate(.        
+00009d20: 2020 2020 696e 7075 745f 6964 733d 696e      input_ids=in
+00009d30: 7075 745f 6964 735b 3a2c 203a 2d31 5d2c  put_ids[:, :-1],
+00009d40: 0a20 2020 2020 2020 2020 2020 2065 6f73  .            eos
+00009d50: 5f74 6f6b 656e 5f69 643d 7365 6c66 2e63  _token_id=self.c
+00009d60: 6f6e 6669 672e 7465 7874 5f63 6f6e 6669  onfig.text_confi
+00009d70: 672e 7365 705f 746f 6b65 6e5f 6964 2c0a  g.sep_token_id,.
+00009d80: 2020 2020 2020 2020 2020 2020 7061 645f              pad_
+00009d90: 746f 6b65 6e5f 6964 3d73 656c 662e 636f  token_id=self.co
+00009da0: 6e66 6967 2e74 6578 745f 636f 6e66 6967  nfig.text_config
+00009db0: 2e70 6164 5f74 6f6b 656e 5f69 642c 0a20  .pad_token_id,. 
+00009dc0: 2020 2020 2020 2020 2020 2061 7474 656e             atten
+00009dd0: 7469 6f6e 5f6d 6173 6b3d 6174 7465 6e74  tion_mask=attent
+00009de0: 696f 6e5f 6d61 736b 2c0a 2020 2020 2020  ion_mask,.      
+00009df0: 2020 2020 2020 656e 636f 6465 725f 6869        encoder_hi
+00009e00: 6464 656e 5f73 7461 7465 733d 696d 6167  dden_states=imag
+00009e10: 655f 656d 6265 6473 2c0a 2020 2020 2020  e_embeds,.      
+00009e20: 2020 2020 2020 656e 636f 6465 725f 6174        encoder_at
+00009e30: 7465 6e74 696f 6e5f 6d61 736b 3d69 6d61  tention_mask=ima
+00009e40: 6765 5f61 7474 656e 7469 6f6e 5f6d 6173  ge_attention_mas
+00009e50: 6b2c 0a20 2020 2020 2020 2020 2020 202a  k,.            *
+00009e60: 2a67 656e 6572 6174 655f 6b77 6172 6773  *generate_kwargs
+00009e70: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
+00009e80: 2020 2020 2072 6574 7572 6e20 6f75 7470       return outp
+00009e90: 7574 730a 0a0a 636c 6173 7320 426c 6970  uts...class Blip
+00009ea0: 466f 7251 7565 7374 696f 6e41 6e73 7765  ForQuestionAnswe
+00009eb0: 7269 6e67 2842 6c69 7050 7265 5472 6169  ring(BlipPreTrai
+00009ec0: 6e65 644d 6f64 656c 293a 0a20 2020 2063  nedModel):.    c
+00009ed0: 6f6e 6669 675f 636c 6173 7320 3d20 426c  onfig_class = Bl
+00009ee0: 6970 436f 6e66 6967 0a20 2020 205f 7469  ipConfig.    _ti
+00009ef0: 6564 5f77 6569 6768 7473 5f6b 6579 7320  ed_weights_keys 
+00009f00: 3d20 5b22 7465 7874 5f64 6563 6f64 6572  = ["text_decoder
+00009f10: 2e63 6c73 2e70 7265 6469 6374 696f 6e73  .cls.predictions
+00009f20: 2e64 6563 6f64 6572 2e62 6961 7322 5d0a  .decoder.bias"].
+00009f30: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+00009f40: 5f28 7365 6c66 2c20 636f 6e66 6967 3a20  _(self, config: 
+00009f50: 426c 6970 436f 6e66 6967 293a 0a20 2020  BlipConfig):.   
+00009f60: 2020 2020 2073 7570 6572 2829 2e5f 5f69       super().__i
+00009f70: 6e69 745f 5f28 636f 6e66 6967 290a 0a20  nit__(config).. 
+00009f80: 2020 2020 2020 2073 656c 662e 7669 7369         self.visi
+00009f90: 6f6e 5f6d 6f64 656c 203d 2042 6c69 7056  on_model = BlipV
+00009fa0: 6973 696f 6e4d 6f64 656c 2863 6f6e 6669  isionModel(confi
+00009fb0: 672e 7669 7369 6f6e 5f63 6f6e 6669 6729  g.vision_config)
+00009fc0: 0a0a 2020 2020 2020 2020 7365 6c66 2e74  ..        self.t
+00009fd0: 6578 745f 656e 636f 6465 7220 3d20 426c  ext_encoder = Bl
+00009fe0: 6970 5465 7874 4d6f 6465 6c28 636f 6e66  ipTextModel(conf
+00009ff0: 6967 2e74 6578 745f 636f 6e66 6967 2c20  ig.text_config, 
+0000a000: 6164 645f 706f 6f6c 696e 675f 6c61 7965  add_pooling_laye
+0000a010: 723d 4661 6c73 6529 0a0a 2020 2020 2020  r=False)..      
+0000a020: 2020 7365 6c66 2e74 6578 745f 6465 636f    self.text_deco
+0000a030: 6465 7220 3d20 426c 6970 5465 7874 4c4d  der = BlipTextLM
+0000a040: 4865 6164 4d6f 6465 6c28 636f 6e66 6967  HeadModel(config
+0000a050: 2e74 6578 745f 636f 6e66 6967 290a 0a20  .text_config).. 
+0000a060: 2020 2020 2020 2073 656c 662e 6465 636f         self.deco
+0000a070: 6465 725f 7061 645f 746f 6b65 6e5f 6964  der_pad_token_id
+0000a080: 203d 2063 6f6e 6669 672e 7465 7874 5f63   = config.text_c
+0000a090: 6f6e 6669 672e 7061 645f 746f 6b65 6e5f  onfig.pad_token_
+0000a0a0: 6964 0a20 2020 2020 2020 2073 656c 662e  id.        self.
+0000a0b0: 6465 636f 6465 725f 7374 6172 745f 746f  decoder_start_to
+0000a0c0: 6b65 6e5f 6964 203d 2063 6f6e 6669 672e  ken_id = config.
+0000a0d0: 7465 7874 5f63 6f6e 6669 672e 626f 735f  text_config.bos_
+0000a0e0: 746f 6b65 6e5f 6964 0a0a 2020 2020 2020  token_id..      
+0000a0f0: 2020 2320 496e 6974 6961 6c69 7a65 2077    # Initialize w
+0000a100: 6569 6768 7473 2061 6e64 2061 7070 6c79  eights and apply
+0000a110: 2066 696e 616c 2070 726f 6365 7373 696e   final processin
+0000a120: 670a 2020 2020 2020 2020 7365 6c66 2e70  g.        self.p
+0000a130: 6f73 745f 696e 6974 2829 0a0a 2020 2020  ost_init()..    
+0000a140: 6465 6620 6765 745f 696e 7075 745f 656d  def get_input_em
+0000a150: 6265 6464 696e 6773 2873 656c 6629 202d  beddings(self) -
+0000a160: 3e20 6e6e 2e43 656c 6c3a 0a20 2020 2020  > nn.Cell:.     
+0000a170: 2020 2072 6574 7572 6e20 7365 6c66 2e76     return self.v
+0000a180: 6973 696f 6e5f 6d6f 6465 6c2e 656d 6265  ision_model.embe
+0000a190: 6464 696e 6773 2e70 6174 6368 5f65 6d62  ddings.patch_emb
+0000a1a0: 6564 6469 6e67 0a0a 2020 2020 6465 6620  edding..    def 
+0000a1b0: 636f 6e73 7472 7563 7428 0a20 2020 2020  construct(.     
+0000a1c0: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+0000a1d0: 2069 6e70 7574 5f69 6473 3a20 6d69 6e64   input_ids: mind
+0000a1e0: 7370 6f72 652e 5465 6e73 6f72 2c0a 2020  spore.Tensor,.  
+0000a1f0: 2020 2020 2020 7069 7865 6c5f 7661 6c75        pixel_valu
+0000a200: 6573 3a20 6d69 6e64 7370 6f72 652e 5465  es: mindspore.Te
+0000a210: 6e73 6f72 2c0a 2020 2020 2020 2020 6465  nsor,.        de
+0000a220: 636f 6465 725f 696e 7075 745f 6964 733a  coder_input_ids:
+0000a230: 204f 7074 696f 6e61 6c5b 6d69 6e64 7370   Optional[mindsp
+0000a240: 6f72 652e 5465 6e73 6f72 5d20 3d20 4e6f  ore.Tensor] = No
+0000a250: 6e65 2c0a 2020 2020 2020 2020 6465 636f  ne,.        deco
+0000a260: 6465 725f 6174 7465 6e74 696f 6e5f 6d61  der_attention_ma
+0000a270: 736b 3a20 4f70 7469 6f6e 616c 5b6d 696e  sk: Optional[min
+0000a280: 6473 706f 7265 2e54 656e 736f 725d 203d  dspore.Tensor] =
+0000a290: 204e 6f6e 652c 0a20 2020 2020 2020 2061   None,.        a
+0000a2a0: 7474 656e 7469 6f6e 5f6d 6173 6b3a 204f  ttention_mask: O
+0000a2b0: 7074 696f 6e61 6c5b 6d69 6e64 7370 6f72  ptional[mindspor
+0000a2c0: 652e 5465 6e73 6f72 5d20 3d20 4e6f 6e65  e.Tensor] = None
+0000a2d0: 2c0a 2020 2020 2020 2020 6f75 7470 7574  ,.        output
+0000a2e0: 5f61 7474 656e 7469 6f6e 733a 204f 7074  _attentions: Opt
+0000a2f0: 696f 6e61 6c5b 626f 6f6c 5d20 3d20 4e6f  ional[bool] = No
+0000a300: 6e65 2c0a 2020 2020 2020 2020 6f75 7470  ne,.        outp
+0000a310: 7574 5f68 6964 6465 6e5f 7374 6174 6573  ut_hidden_states
+0000a320: 3a20 4f70 7469 6f6e 616c 5b62 6f6f 6c5d  : Optional[bool]
+0000a330: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+0000a340: 206c 6162 656c 733a 204f 7074 696f 6e61   labels: Optiona
+0000a350: 6c5b 6d69 6e64 7370 6f72 652e 5465 6e73  l[mindspore.Tens
+0000a360: 6f72 5d20 3d20 4e6f 6e65 2c0a 2020 2020  or] = None,.    
+0000a370: 2020 2020 7265 7475 726e 5f64 6963 743a      return_dict:
+0000a380: 204f 7074 696f 6e61 6c5b 626f 6f6c 5d20   Optional[bool] 
+0000a390: 3d20 4e6f 6e65 2c0a 2020 2020 2920 2d3e  = None,.    ) ->
+0000a3a0: 2055 6e69 6f6e 5b54 7570 6c65 2c20 426c   Union[Tuple, Bl
+0000a3b0: 6970 5465 7874 5669 7369 6f6e 4d6f 6465  ipTextVisionMode
+0000a3c0: 6c4f 7574 7075 745d 3a0a 2020 2020 2020  lOutput]:.      
+0000a3d0: 2020 7222 2222 0a20 2020 2020 2020 2052    r""".        R
+0000a3e0: 6574 7572 6e73 3a0a 0a20 2020 2020 2020  eturns:..       
+0000a3f0: 2045 7861 6d70 6c65 733a 0a0a 2020 2020   Examples:..    
+0000a400: 2020 2020 6060 6070 7974 686f 6e0a 2020      ```python.  
+0000a410: 2020 2020 2020 3e3e 3e20 6672 6f6d 2050        >>> from P
+0000a420: 494c 2069 6d70 6f72 7420 496d 6167 650a  IL import Image.
+0000a430: 2020 2020 2020 2020 3e3e 3e20 696d 706f          >>> impo
+0000a440: 7274 2072 6571 7565 7374 730a 2020 2020  rt requests.    
+0000a450: 2020 2020 3e3e 3e20 6672 6f6d 2074 7261      >>> from tra
+0000a460: 6e73 666f 726d 6572 7320 696d 706f 7274  nsformers import
+0000a470: 2041 7574 6f50 726f 6365 7373 6f72 2c20   AutoProcessor, 
+0000a480: 426c 6970 466f 7251 7565 7374 696f 6e41  BlipForQuestionA
+0000a490: 6e73 7765 7269 6e67 0a0a 2020 2020 2020  nswering..      
+0000a4a0: 2020 3e3e 3e20 6d6f 6465 6c20 3d20 426c    >>> model = Bl
+0000a4b0: 6970 466f 7251 7565 7374 696f 6e41 6e73  ipForQuestionAns
+0000a4c0: 7765 7269 6e67 2e66 726f 6d5f 7072 6574  wering.from_pret
+0000a4d0: 7261 696e 6564 2822 5361 6c65 7366 6f72  rained("Salesfor
+0000a4e0: 6365 2f62 6c69 702d 7671 612d 6261 7365  ce/blip-vqa-base
+0000a4f0: 2229 0a20 2020 2020 2020 203e 3e3e 2070  ").        >>> p
+0000a500: 726f 6365 7373 6f72 203d 2041 7574 6f50  rocessor = AutoP
+0000a510: 726f 6365 7373 6f72 2e66 726f 6d5f 7072  rocessor.from_pr
+0000a520: 6574 7261 696e 6564 2822 5361 6c65 7366  etrained("Salesf
+0000a530: 6f72 6365 2f62 6c69 702d 7671 612d 6261  orce/blip-vqa-ba
+0000a540: 7365 2229 0a0a 2020 2020 2020 2020 3e3e  se")..        >>
+0000a550: 3e20 7572 6c20 3d20 2268 7474 703a 2f2f  > url = "http://
+0000a560: 696d 6167 6573 2e63 6f63 6f64 6174 6173  images.cocodatas
+0000a570: 6574 2e6f 7267 2f76 616c 3230 3137 2f30  et.org/val2017/0
+0000a580: 3030 3030 3030 3339 3736 392e 6a70 6722  00000039769.jpg"
+0000a590: 0a20 2020 2020 2020 203e 3e3e 2069 6d61  .        >>> ima
+0000a5a0: 6765 203d 2049 6d61 6765 2e6f 7065 6e28  ge = Image.open(
+0000a5b0: 7265 7175 6573 7473 2e67 6574 2875 726c  requests.get(url
+0000a5c0: 2c20 7374 7265 616d 3d54 7275 6529 2e72  , stream=True).r
+0000a5d0: 6177 290a 0a20 2020 2020 2020 203e 3e3e  aw)..        >>>
+0000a5e0: 2023 2074 7261 696e 696e 670a 2020 2020   # training.    
+0000a5f0: 2020 2020 3e3e 3e20 7465 7874 203d 2022      >>> text = "
+0000a600: 486f 7720 6d61 6e79 2063 6174 7320 6172  How many cats ar
+0000a610: 6520 696e 2074 6865 2070 6963 7475 7265  e in the picture
+0000a620: 3f22 0a20 2020 2020 2020 203e 3e3e 206c  ?".        >>> l
+0000a630: 6162 656c 203d 2022 3222 0a20 2020 2020  abel = "2".     
+0000a640: 2020 203e 3e3e 2069 6e70 7574 7320 3d20     >>> inputs = 
+0000a650: 7072 6f63 6573 736f 7228 696d 6167 6573  processor(images
+0000a660: 3d69 6d61 6765 2c20 7465 7874 3d74 6578  =image, text=tex
+0000a670: 742c 2072 6574 7572 6e5f 7465 6e73 6f72  t, return_tensor
+0000a680: 733d 2270 7422 290a 2020 2020 2020 2020  s="pt").        
+0000a690: 3e3e 3e20 6c61 6265 6c73 203d 2070 726f  >>> labels = pro
+0000a6a0: 6365 7373 6f72 2874 6578 743d 6c61 6265  cessor(text=labe
+0000a6b0: 6c2c 2072 6574 7572 6e5f 7465 6e73 6f72  l, return_tensor
+0000a6c0: 733d 2270 7422 292e 696e 7075 745f 6964  s="pt").input_id
+0000a6d0: 730a 0a20 2020 2020 2020 203e 3e3e 2069  s..        >>> i
+0000a6e0: 6e70 7574 735b 226c 6162 656c 7322 5d20  nputs["labels"] 
+0000a6f0: 3d20 6c61 6265 6c73 0a20 2020 2020 2020  = labels.       
+0000a700: 203e 3e3e 206f 7574 7075 7473 203d 206d   >>> outputs = m
+0000a710: 6f64 656c 282a 2a69 6e70 7574 7329 0a20  odel(**inputs). 
+0000a720: 2020 2020 2020 203e 3e3e 206c 6f73 7320         >>> loss 
+0000a730: 3d20 6f75 7470 7574 732e 6c6f 7373 0a20  = outputs.loss. 
+0000a740: 2020 2020 2020 203e 3e3e 206c 6f73 732e         >>> loss.
+0000a750: 6261 636b 7761 7264 2829 0a0a 2020 2020  backward()..    
+0000a760: 2020 2020 3e3e 3e20 2320 696e 6665 7265      >>> # infere
+0000a770: 6e63 650a 2020 2020 2020 2020 3e3e 3e20  nce.        >>> 
+0000a780: 7465 7874 203d 2022 486f 7720 6d61 6e79  text = "How many
+0000a790: 2063 6174 7320 6172 6520 696e 2074 6865   cats are in the
+0000a7a0: 2070 6963 7475 7265 3f22 0a20 2020 2020   picture?".     
+0000a7b0: 2020 203e 3e3e 2069 6e70 7574 7320 3d20     >>> inputs = 
+0000a7c0: 7072 6f63 6573 736f 7228 696d 6167 6573  processor(images
+0000a7d0: 3d69 6d61 6765 2c20 7465 7874 3d74 6578  =image, text=tex
+0000a7e0: 742c 2072 6574 7572 6e5f 7465 6e73 6f72  t, return_tensor
+0000a7f0: 733d 2270 7422 290a 2020 2020 2020 2020  s="pt").        
+0000a800: 3e3e 3e20 6f75 7470 7574 7320 3d20 6d6f  >>> outputs = mo
+0000a810: 6465 6c2e 6765 6e65 7261 7465 282a 2a69  del.generate(**i
+0000a820: 6e70 7574 7329 0a20 2020 2020 2020 203e  nputs).        >
+0000a830: 3e3e 2070 7269 6e74 2870 726f 6365 7373  >> print(process
+0000a840: 6f72 2e64 6563 6f64 6528 6f75 7470 7574  or.decode(output
+0000a850: 735b 305d 2c20 736b 6970 5f73 7065 6369  s[0], skip_speci
+0000a860: 616c 5f74 6f6b 656e 733d 5472 7565 2929  al_tokens=True))
+0000a870: 0a20 2020 2020 2020 2032 0a20 2020 2020  .        2.     
+0000a880: 2020 2060 6060 2222 220a 2020 2020 2020     ```""".      
+0000a890: 2020 6966 206c 6162 656c 7320 6973 204e    if labels is N
+0000a8a0: 6f6e 6520 616e 6420 6465 636f 6465 725f  one and decoder_
+0000a8b0: 696e 7075 745f 6964 7320 6973 204e 6f6e  input_ids is Non
+0000a8c0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+0000a8d0: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+0000a8e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a8f0: 2022 4569 7468 6572 2060 6465 636f 6465   "Either `decode
+0000a900: 725f 696e 7075 745f 6964 7360 206f 7220  r_input_ids` or 
+0000a910: 606c 6162 656c 7360 2073 686f 756c 6420  `labels` should 
+0000a920: 6265 2070 6173 7365 6420 7768 656e 2063  be passed when c
+0000a930: 616c 6c69 6e67 2060 666f 7277 6172 6460  alling `forward`
+0000a940: 2077 6974 6822 0a20 2020 2020 2020 2020   with".         
+0000a950: 2020 2020 2020 2022 2060 426c 6970 466f         " `BlipFo
+0000a960: 7251 7565 7374 696f 6e41 6e73 7765 7269  rQuestionAnsweri
+0000a970: 6e67 602e 2069 6620 796f 7520 6172 6520  ng`. if you are 
+0000a980: 7472 6169 6e69 6e67 2074 6865 206d 6f64  training the mod
+0000a990: 656c 206d 616b 6520 7375 7265 2074 6861  el make sure tha
+0000a9a0: 7420 606c 6162 656c 7360 2069 7320 7061  t `labels` is pa
+0000a9b0: 7373 6564 2c20 6966 2079 6f75 220a 2020  ssed, if you".  
+0000a9c0: 2020 2020 2020 2020 2020 2020 2020 2220                " 
+0000a9d0: 6172 6520 7573 696e 6720 7468 6520 6d6f  are using the mo
+0000a9e0: 6465 6c20 666f 7220 696e 6665 7265 6e63  del for inferenc
+0000a9f0: 6520 6d61 6b65 2073 7572 6520 7468 6174  e make sure that
+0000aa00: 2060 6465 636f 6465 725f 696e 7075 745f   `decoder_input_
+0000aa10: 6964 7360 2069 7320 7061 7373 6564 206f  ids` is passed o
+0000aa20: 7220 6361 6c6c 2060 6765 6e65 7261 7465  r call `generate
+0000aa30: 6022 0a20 2020 2020 2020 2020 2020 2029  `".            )
+0000aa40: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+0000aa50: 5f64 6963 7420 3d20 7265 7475 726e 5f64  _dict = return_d
+0000aa60: 6963 7420 6966 2072 6574 7572 6e5f 6469  ict if return_di
+0000aa70: 6374 2069 7320 6e6f 7420 4e6f 6e65 2065  ct is not None e
+0000aa80: 6c73 6520 7365 6c66 2e63 6f6e 6669 672e  lse self.config.
+0000aa90: 7573 655f 7265 7475 726e 5f64 6963 740a  use_return_dict.
+0000aaa0: 2020 2020 2020 2020 6f75 7470 7574 5f61          output_a
+0000aab0: 7474 656e 7469 6f6e 7320 3d20 6f75 7470  ttentions = outp
+0000aac0: 7574 5f61 7474 656e 7469 6f6e 7320 6966  ut_attentions if
+0000aad0: 206f 7574 7075 745f 6174 7465 6e74 696f   output_attentio
+0000aae0: 6e73 2069 7320 6e6f 7420 4e6f 6e65 2065  ns is not None e
+0000aaf0: 6c73 6520 7365 6c66 2e63 6f6e 6669 672e  lse self.config.
+0000ab00: 6f75 7470 7574 5f61 7474 656e 7469 6f6e  output_attention
+0000ab10: 730a 2020 2020 2020 2020 6f75 7470 7574  s.        output
+0000ab20: 5f68 6964 6465 6e5f 7374 6174 6573 203d  _hidden_states =
+0000ab30: 2028 0a20 2020 2020 2020 2020 2020 206f   (.            o
+0000ab40: 7574 7075 745f 6869 6464 656e 5f73 7461  utput_hidden_sta
+0000ab50: 7465 7320 6966 206f 7574 7075 745f 6869  tes if output_hi
+0000ab60: 6464 656e 5f73 7461 7465 7320 6973 206e  dden_states is n
+0000ab70: 6f74 204e 6f6e 6520 656c 7365 2073 656c  ot None else sel
+0000ab80: 662e 636f 6e66 6967 2e6f 7574 7075 745f  f.config.output_
+0000ab90: 6869 6464 656e 5f73 7461 7465 730a 2020  hidden_states.  
+0000aba0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+0000abb0: 2076 6973 696f 6e5f 6f75 7470 7574 7320   vision_outputs 
+0000abc0: 3d20 7365 6c66 2e76 6973 696f 6e5f 6d6f  = self.vision_mo
+0000abd0: 6465 6c28 0a20 2020 2020 2020 2020 2020  del(.           
+0000abe0: 2070 6978 656c 5f76 616c 7565 733d 7069   pixel_values=pi
+0000abf0: 7865 6c5f 7661 6c75 6573 2c0a 2020 2020  xel_values,.    
+0000ac00: 2020 2020 2020 2020 6f75 7470 7574 5f61          output_a
+0000ac10: 7474 656e 7469 6f6e 733d 6f75 7470 7574  ttentions=output
+0000ac20: 5f61 7474 656e 7469 6f6e 732c 0a20 2020  _attentions,.   
+0000ac30: 2020 2020 2020 2020 206f 7574 7075 745f           output_
+0000ac40: 6869 6464 656e 5f73 7461 7465 733d 6f75  hidden_states=ou
+0000ac50: 7470 7574 5f68 6964 6465 6e5f 7374 6174  tput_hidden_stat
+0000ac60: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+0000ac70: 7265 7475 726e 5f64 6963 743d 7265 7475  return_dict=retu
+0000ac80: 726e 5f64 6963 742c 0a20 2020 2020 2020  rn_dict,.       
+0000ac90: 2029 0a0a 2020 2020 2020 2020 696d 6167   )..        imag
+0000aca0: 655f 656d 6265 6473 203d 2076 6973 696f  e_embeds = visio
+0000acb0: 6e5f 6f75 7470 7574 735b 305d 0a20 2020  n_outputs[0].   
+0000acc0: 2020 2020 2069 6d61 6765 5f61 7474 656e       image_atten
+0000acd0: 7469 6f6e 5f6d 6173 6b20 3d20 6f70 732e  tion_mask = ops.
+0000ace0: 6f6e 6573 2869 6d61 6765 5f65 6d62 6564  ones(image_embed
+0000acf0: 732e 7368 6170 655b 3a2d 315d 2c20 6474  s.shape[:-1], dt
+0000ad00: 7970 653d 6d69 6e64 7370 6f72 652e 696e  ype=mindspore.in
+0000ad10: 7436 3429 0a0a 2020 2020 2020 2020 7175  t64)..        qu
+0000ad20: 6573 7469 6f6e 5f65 6d62 6564 7320 3d20  estion_embeds = 
+0000ad30: 7365 6c66 2e74 6578 745f 656e 636f 6465  self.text_encode
+0000ad40: 7228 0a20 2020 2020 2020 2020 2020 2069  r(.            i
+0000ad50: 6e70 7574 5f69 6473 3d69 6e70 7574 5f69  nput_ids=input_i
+0000ad60: 6473 2c0a 2020 2020 2020 2020 2020 2020  ds,.            
+0000ad70: 6174 7465 6e74 696f 6e5f 6d61 736b 3d61  attention_mask=a
+0000ad80: 7474 656e 7469 6f6e 5f6d 6173 6b2c 0a20  ttention_mask,. 
+0000ad90: 2020 2020 2020 2020 2020 2065 6e63 6f64             encod
+0000ada0: 6572 5f68 6964 6465 6e5f 7374 6174 6573  er_hidden_states
+0000adb0: 3d69 6d61 6765 5f65 6d62 6564 732c 0a20  =image_embeds,. 
+0000adc0: 2020 2020 2020 2020 2020 2065 6e63 6f64             encod
+0000add0: 6572 5f61 7474 656e 7469 6f6e 5f6d 6173  er_attention_mas
+0000ade0: 6b3d 696d 6167 655f 6174 7465 6e74 696f  k=image_attentio
+0000adf0: 6e5f 6d61 736b 2c0a 2020 2020 2020 2020  n_mask,.        
+0000ae00: 2020 2020 7265 7475 726e 5f64 6963 743d      return_dict=
+0000ae10: 7265 7475 726e 5f64 6963 742c 0a20 2020  return_dict,.   
+0000ae20: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+0000ae30: 6966 206c 6162 656c 7320 6973 206e 6f74  if labels is not
+0000ae40: 204e 6f6e 6520 616e 6420 6465 636f 6465   None and decode
+0000ae50: 725f 696e 7075 745f 6964 7320 6973 204e  r_input_ids is N
+0000ae60: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0000ae70: 2023 206c 6162 656c 7320 6172 6520 616c   # labels are al
+0000ae80: 7265 6164 7920 7368 6966 7465 6420 7269  ready shifted ri
+0000ae90: 6768 742c 2073 6565 3a20 6874 7470 733a  ght, see: https:
+0000aea0: 2f2f 6769 7468 7562 2e63 6f6d 2f68 7567  //github.com/hug
+0000aeb0: 6769 6e67 6661 6365 2f74 7261 6e73 666f  gingface/transfo
+0000aec0: 726d 6572 732f 7075 6c6c 2f32 3331 3533  rmers/pull/23153
+0000aed0: 0a20 2020 2020 2020 2020 2020 2064 6563  .            dec
+0000aee0: 6f64 6572 5f69 6e70 7574 5f69 6473 203d  oder_input_ids =
+0000aef0: 206c 6162 656c 730a 0a20 2020 2020 2020   labels..       
+0000af00: 2071 7565 7374 696f 6e5f 656d 6265 6473   question_embeds
+0000af10: 203d 2071 7565 7374 696f 6e5f 656d 6265   = question_embe
+0000af20: 6473 5b30 5d20 6966 206e 6f74 2072 6574  ds[0] if not ret
+0000af30: 7572 6e5f 6469 6374 2065 6c73 6520 7175  urn_dict else qu
+0000af40: 6573 7469 6f6e 5f65 6d62 6564 732e 6c61  estion_embeds.la
+0000af50: 7374 5f68 6964 6465 6e5f 7374 6174 650a  st_hidden_state.
+0000af60: 0a20 2020 2020 2020 2061 6e73 7765 725f  .        answer_
+0000af70: 6f75 7470 7574 203d 2073 656c 662e 7465  output = self.te
+0000af80: 7874 5f64 6563 6f64 6572 280a 2020 2020  xt_decoder(.    
+0000af90: 2020 2020 2020 2020 696e 7075 745f 6964          input_id
+0000afa0: 733d 6465 636f 6465 725f 696e 7075 745f  s=decoder_input_
+0000afb0: 6964 732c 0a20 2020 2020 2020 2020 2020  ids,.           
+0000afc0: 2061 7474 656e 7469 6f6e 5f6d 6173 6b3d   attention_mask=
+0000afd0: 6465 636f 6465 725f 6174 7465 6e74 696f  decoder_attentio
+0000afe0: 6e5f 6d61 736b 2c0a 2020 2020 2020 2020  n_mask,.        
+0000aff0: 2020 2020 656e 636f 6465 725f 6869 6464      encoder_hidd
+0000b000: 656e 5f73 7461 7465 733d 7175 6573 7469  en_states=questi
+0000b010: 6f6e 5f65 6d62 6564 732c 0a20 2020 2020  on_embeds,.     
+0000b020: 2020 2020 2020 2065 6e63 6f64 6572 5f61         encoder_a
+0000b030: 7474 656e 7469 6f6e 5f6d 6173 6b3d 6174  ttention_mask=at
+0000b040: 7465 6e74 696f 6e5f 6d61 736b 2c0a 2020  tention_mask,.  
+0000b050: 2020 2020 2020 2020 2020 6c61 6265 6c73            labels
+0000b060: 3d6c 6162 656c 732c 0a20 2020 2020 2020  =labels,.       
+0000b070: 2020 2020 2072 6574 7572 6e5f 6469 6374       return_dict
+0000b080: 3d72 6574 7572 6e5f 6469 6374 2c0a 2020  =return_dict,.  
+0000b090: 2020 2020 2020 2020 2020 7265 6475 6374            reduct
+0000b0a0: 696f 6e3d 226d 6561 6e22 2c0a 2020 2020  ion="mean",.    
+0000b0b0: 2020 2020 290a 0a20 2020 2020 2020 2069      )..        i
+0000b0c0: 6620 6c61 6265 6c73 2069 7320 6e6f 7420  f labels is not 
+0000b0d0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0000b0e0: 2020 6465 636f 6465 725f 6c6f 7373 203d    decoder_loss =
+0000b0f0: 2061 6e73 7765 725f 6f75 7470 7574 2e6c   answer_output.l
+0000b100: 6f73 732e 6d65 616e 2829 2069 6620 7265  oss.mean() if re
+0000b110: 7475 726e 5f64 6963 7420 656c 7365 2061  turn_dict else a
+0000b120: 6e73 7765 725f 6f75 7470 7574 5b30 5d2e  nswer_output[0].
+0000b130: 6d65 616e 2829 0a20 2020 2020 2020 2065  mean().        e
+0000b140: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0000b150: 2064 6563 6f64 6572 5f6c 6f73 7320 3d20   decoder_loss = 
+0000b160: 4e6f 6e65 0a0a 2020 2020 2020 2020 6966  None..        if
+0000b170: 206e 6f74 2072 6574 7572 6e5f 6469 6374   not return_dict
+0000b180: 3a0a 2020 2020 2020 2020 2020 2020 6f75  :.            ou
+0000b190: 7470 7574 7320 3d20 2864 6563 6f64 6572  tputs = (decoder
+0000b1a0: 5f6c 6f73 732c 2069 6d61 6765 5f65 6d62  _loss, image_emb
+0000b1b0: 6564 732c 2076 6973 696f 6e5f 6f75 7470  eds, vision_outp
+0000b1c0: 7574 735b 305d 2920 2b20 7669 7369 6f6e  uts[0]) + vision
+0000b1d0: 5f6f 7574 7075 7473 5b32 3a5d 0a20 2020  _outputs[2:].   
+0000b1e0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0000b1f0: 7475 706c 6528 6f75 7470 7574 2066 6f72  tuple(output for
+0000b200: 206f 7574 7075 7420 696e 206f 7574 7075   output in outpu
+0000b210: 7473 2069 6620 6f75 7470 7574 2069 7320  ts if output is 
+0000b220: 6e6f 7420 4e6f 6e65 290a 0a20 2020 2020  not None)..     
+0000b230: 2020 2072 6574 7572 6e20 426c 6970 5465     return BlipTe
+0000b240: 7874 5669 7369 6f6e 4d6f 6465 6c4f 7574  xtVisionModelOut
+0000b250: 7075 7428 0a20 2020 2020 2020 2020 2020  put(.           
+0000b260: 206c 6f73 733d 6465 636f 6465 725f 6c6f   loss=decoder_lo
+0000b270: 7373 2c0a 2020 2020 2020 2020 2020 2020  ss,.            
+0000b280: 696d 6167 655f 656d 6265 6473 3d69 6d61  image_embeds=ima
+0000b290: 6765 5f65 6d62 6564 732c 0a20 2020 2020  ge_embeds,.     
+0000b2a0: 2020 2020 2020 206c 6173 745f 6869 6464         last_hidd
+0000b2b0: 656e 5f73 7461 7465 3d76 6973 696f 6e5f  en_state=vision_
+0000b2c0: 6f75 7470 7574 732e 6c61 7374 5f68 6964  outputs.last_hid
+0000b2d0: 6465 6e5f 7374 6174 652c 0a20 2020 2020  den_state,.     
+0000b2e0: 2020 2020 2020 2068 6964 6465 6e5f 7374         hidden_st
+0000b2f0: 6174 6573 3d76 6973 696f 6e5f 6f75 7470  ates=vision_outp
+0000b300: 7574 732e 6869 6464 656e 5f73 7461 7465  uts.hidden_state
+0000b310: 732c 0a20 2020 2020 2020 2020 2020 2061  s,.            a
+0000b320: 7474 656e 7469 6f6e 733d 7669 7369 6f6e  ttentions=vision
+0000b330: 5f6f 7574 7075 7473 2e61 7474 656e 7469  _outputs.attenti
+0000b340: 6f6e 732c 0a20 2020 2020 2020 2029 0a0a  ons,.        )..
+0000b350: 2020 2020 6465 6620 6765 6e65 7261 7465      def generate
+0000b360: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+0000b370: 2020 2020 2020 2020 696e 7075 745f 6964          input_id
+0000b380: 733a 206d 696e 6473 706f 7265 2e54 656e  s: mindspore.Ten
+0000b390: 736f 722c 0a20 2020 2020 2020 2070 6978  sor,.        pix
+0000b3a0: 656c 5f76 616c 7565 733a 206d 696e 6473  el_values: minds
+0000b3b0: 706f 7265 2e54 656e 736f 722c 0a20 2020  pore.Tensor,.   
+0000b3c0: 2020 2020 2061 7474 656e 7469 6f6e 5f6d       attention_m
+0000b3d0: 6173 6b3a 204f 7074 696f 6e61 6c5b 6d69  ask: Optional[mi
+0000b3e0: 6e64 7370 6f72 652e 5465 6e73 6f72 5d20  ndspore.Tensor] 
+0000b3f0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+0000b400: 2a2a 6765 6e65 7261 7465 5f6b 7761 7267  **generate_kwarg
+0000b410: 732c 0a20 2020 2029 202d 3e20 6d69 6e64  s,.    ) -> mind
+0000b420: 7370 6f72 652e 5465 6e73 6f72 3a0a 2020  spore.Tensor:.  
+0000b430: 2020 2020 2020 7222 2222 0a20 2020 2020        r""".     
+0000b440: 2020 204f 7665 7272 6964 6573 202a 6765     Overrides *ge
+0000b450: 6e65 7261 7465 2a20 6675 6e63 7469 6f6e  nerate* function
+0000b460: 2074 6f20 6265 2061 626c 6520 746f 2075   to be able to u
+0000b470: 7365 2074 6865 206d 6f64 656c 2061 7320  se the model as 
+0000b480: 6120 636f 6e64 6974 696f 6e61 6c20 6765  a conditional ge
+0000b490: 6e65 7261 746f 720a 0a20 2020 2020 2020  nerator..       
+0000b4a0: 2050 6172 616d 6574 6572 733a 0a20 2020   Parameters:.   
+0000b4b0: 2020 2020 2020 2020 2069 6e70 7574 5f69           input_i
+0000b4c0: 6473 2028 2a6d 696e 6473 706f 7265 2e54  ds (*mindspore.T
+0000b4d0: 656e 736f 722a 206f 6620 7368 6170 6520  ensor* of shape 
+0000b4e0: 2a28 6261 7463 685f 7369 7a65 2c20 7365  *(batch_size, se
+0000b4f0: 7175 656e 6365 5f6c 656e 6774 6829 2a29  quence_length)*)
+0000b500: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000b510: 2020 5468 6520 7365 7175 656e 6365 2075    The sequence u
+0000b520: 7365 6420 6173 2061 2070 726f 6d70 7420  sed as a prompt 
+0000b530: 666f 7220 7468 6520 6765 6e65 7261 7469  for the generati
+0000b540: 6f6e 2e0a 2020 2020 2020 2020 2020 2020  on..            
+0000b550: 7069 7865 6c5f 7661 6c75 6573 2028 2a6d  pixel_values (*m
+0000b560: 696e 6473 706f 7265 2e54 656e 736f 722a  indspore.Tensor*
+0000b570: 206f 6620 7368 6170 6520 2a28 6261 7463   of shape *(batc
+0000b580: 685f 7369 7a65 2c20 6e75 6d5f 6368 616e  h_size, num_chan
+0000b590: 6e65 6c73 2c20 696d 6167 655f 6865 6967  nels, image_heig
+0000b5a0: 6874 2c20 696d 6167 655f 7769 6474 6829  ht, image_width)
+0000b5b0: 2a3a 0a20 2020 2020 2020 2020 2020 2020  *:.             
+0000b5c0: 2020 2049 6e70 7574 2069 6d61 6765 2074     Input image t
+0000b5d0: 6f20 6265 2070 726f 6365 7373 6564 0a20  o be processed. 
+0000b5e0: 2020 2020 2020 2020 2020 2061 7474 656e             atten
+0000b5f0: 7469 6f6e 5f6d 6173 6b20 282a 6d69 6e64  tion_mask (*mind
+0000b600: 7370 6f72 652e 5465 6e73 6f72 2a20 6f66  spore.Tensor* of
+0000b610: 2073 6861 7065 202a 2862 6174 6368 5f73   shape *(batch_s
+0000b620: 697a 652c 2073 6571 7565 6e63 655f 6c65  ize, sequence_le
+0000b630: 6e67 7468 292a 2c20 2a6f 7074 696f 6e61  ngth)*, *optiona
+0000b640: 6c2a 293a 0a20 2020 2020 2020 2020 2020  l*):.           
+0000b650: 2020 2020 204d 6173 6b20 746f 2061 766f       Mask to avo
+0000b660: 6964 2070 6572 666f 726d 696e 6720 6174  id performing at
+0000b670: 7465 6e74 696f 6e20 6f6e 2070 6164 6469  tention on paddi
+0000b680: 6e67 2074 6f6b 656e 2069 6e64 6963 6573  ng token indices
+0000b690: 2e20 4d61 736b 2076 616c 7565 7320 7365  . Mask values se
+0000b6a0: 6c65 6374 6564 2069 6e20 605b 302c 2031  lected in `[0, 1
+0000b6b0: 5d60 2e20 6031 6020 666f 720a 2020 2020  ]`. `1` for.    
+0000b6c0: 2020 2020 2020 2020 2020 2020 746f 6b65              toke
+0000b6d0: 6e73 2074 6861 7420 6172 6520 4e4f 5420  ns that are NOT 
+0000b6e0: 4d41 534b 4544 2c20 6030 6020 666f 7220  MASKED, `0` for 
+0000b6f0: 4d41 534b 4544 2074 6f6b 656e 732e 0a20  MASKED tokens.. 
+0000b700: 2020 2020 2020 2020 2020 202a 2a67 656e             **gen
+0000b710: 6572 6174 655f 6b77 6172 6773 3a0a 2020  erate_kwargs:.  
+0000b720: 2020 2020 2020 2020 2020 2020 2020 4164                Ad
+0000b730: 6469 7469 6f6e 616c 2061 7267 756d 656e  ditional argumen
+0000b740: 7473 2070 6173 7365 6420 746f 2074 6865  ts passed to the
+0000b750: 202a 6765 6e65 7261 7465 2a20 6675 6e63   *generate* func
+0000b760: 7469 6f6e 206f 6620 7468 6520 6465 636f  tion of the deco
+0000b770: 6465 720a 0a0a 2020 2020 2020 2020 4578  der...        Ex
+0000b780: 616d 706c 6573 3a0a 2020 2020 2020 2020  amples:.        
+0000b790: 6060 6070 7974 686f 6e0a 2020 2020 2020  ```python.      
+0000b7a0: 2020 3e3e 3e20 6672 6f6d 2050 494c 2069    >>> from PIL i
+0000b7b0: 6d70 6f72 7420 496d 6167 650a 2020 2020  mport Image.    
+0000b7c0: 2020 2020 3e3e 3e20 696d 706f 7274 2072      >>> import r
+0000b7d0: 6571 7565 7374 730a 2020 2020 2020 2020  equests.        
+0000b7e0: 3e3e 3e20 6672 6f6d 2074 7261 6e73 666f  >>> from transfo
+0000b7f0: 726d 6572 7320 696d 706f 7274 2041 7574  rmers import Aut
+0000b800: 6f50 726f 6365 7373 6f72 2c20 426c 6970  oProcessor, Blip
+0000b810: 466f 7251 7565 7374 696f 6e41 6e73 7765  ForQuestionAnswe
+0000b820: 7269 6e67 0a0a 2020 2020 2020 2020 3e3e  ring..        >>
+0000b830: 3e20 6d6f 6465 6c20 3d20 426c 6970 466f  > model = BlipFo
+0000b840: 7251 7565 7374 696f 6e41 6e73 7765 7269  rQuestionAnsweri
+0000b850: 6e67 2e66 726f 6d5f 7072 6574 7261 696e  ng.from_pretrain
+0000b860: 6564 2822 5361 6c65 7366 6f72 6365 2f62  ed("Salesforce/b
+0000b870: 6c69 702d 7671 612d 6261 7365 2229 0a20  lip-vqa-base"). 
+0000b880: 2020 2020 2020 203e 3e3e 2070 726f 6365         >>> proce
+0000b890: 7373 6f72 203d 2041 7574 6f50 726f 6365  ssor = AutoProce
+0000b8a0: 7373 6f72 2e66 726f 6d5f 7072 6574 7261  ssor.from_pretra
+0000b8b0: 696e 6564 2822 5361 6c65 7366 6f72 6365  ined("Salesforce
+0000b8c0: 2f62 6c69 702d 7671 612d 6261 7365 2229  /blip-vqa-base")
+0000b8d0: 0a0a 2020 2020 2020 2020 3e3e 3e20 7572  ..        >>> ur
+0000b8e0: 6c20 3d20 2268 7474 703a 2f2f 696d 6167  l = "http://imag
+0000b8f0: 6573 2e63 6f63 6f64 6174 6173 6574 2e6f  es.cocodataset.o
+0000b900: 7267 2f76 616c 3230 3137 2f30 3030 3030  rg/val2017/00000
+0000b910: 3030 3339 3736 392e 6a70 6722 0a20 2020  0039769.jpg".   
+0000b920: 2020 2020 203e 3e3e 2069 6d61 6765 203d       >>> image =
+0000b930: 2049 6d61 6765 2e6f 7065 6e28 7265 7175   Image.open(requ
+0000b940: 6573 7473 2e67 6574 2875 726c 2c20 7374  ests.get(url, st
+0000b950: 7265 616d 3d54 7275 6529 2e72 6177 290a  ream=True).raw).
+0000b960: 2020 2020 2020 2020 3e3e 3e20 7465 7874          >>> text
+0000b970: 203d 2022 486f 7720 6d61 6e79 2063 6174   = "How many cat
+0000b980: 7320 6172 6520 696e 2074 6865 2070 6963  s are in the pic
+0000b990: 7475 7265 3f22 0a0a 2020 2020 2020 2020  ture?"..        
+0000b9a0: 3e3e 3e20 696e 7075 7473 203d 2070 726f  >>> inputs = pro
+0000b9b0: 6365 7373 6f72 2869 6d61 6765 733d 696d  cessor(images=im
+0000b9c0: 6167 652c 2074 6578 743d 7465 7874 2c20  age, text=text, 
+0000b9d0: 7265 7475 726e 5f74 656e 736f 7273 3d22  return_tensors="
+0000b9e0: 7074 2229 0a0a 2020 2020 2020 2020 3e3e  pt")..        >>
+0000b9f0: 3e20 6f75 7470 7574 7320 3d20 6d6f 6465  > outputs = mode
+0000ba00: 6c2e 6765 6e65 7261 7465 282a 2a69 6e70  l.generate(**inp
+0000ba10: 7574 7329 0a20 2020 2020 2020 203e 3e3e  uts).        >>>
+0000ba20: 2070 7269 6e74 2870 726f 6365 7373 6f72   print(processor
+0000ba30: 2e64 6563 6f64 6528 6f75 7470 7574 735b  .decode(outputs[
+0000ba40: 305d 2c20 736b 6970 5f73 7065 6369 616c  0], skip_special
+0000ba50: 5f74 6f6b 656e 733d 5472 7565 2929 0a20  _tokens=True)). 
+0000ba60: 2020 2020 2020 2032 0a20 2020 2020 2020         2.       
+0000ba70: 2060 6060 0a20 2020 2020 2020 2022 2222   ```.        """
+0000ba80: 0a20 2020 2020 2020 2076 6973 696f 6e5f  .        vision_
+0000ba90: 6f75 7470 7574 7320 3d20 7365 6c66 2e76  outputs = self.v
+0000baa0: 6973 696f 6e5f 6d6f 6465 6c28 7069 7865  ision_model(pixe
+0000bab0: 6c5f 7661 6c75 6573 3d70 6978 656c 5f76  l_values=pixel_v
+0000bac0: 616c 7565 7329 0a0a 2020 2020 2020 2020  alues)..        
+0000bad0: 696d 6167 655f 656d 6265 6473 203d 2076  image_embeds = v
+0000bae0: 6973 696f 6e5f 6f75 7470 7574 735b 305d  ision_outputs[0]
+0000baf0: 0a0a 2020 2020 2020 2020 696d 6167 655f  ..        image_
+0000bb00: 6174 7465 6e74 696f 6e5f 6d61 736b 203d  attention_mask =
+0000bb10: 206f 7073 2e6f 6e65 7328 696d 6167 655f   ops.ones(image_
+0000bb20: 656d 6265 6473 2e73 6861 7065 5b3a 2d31  embeds.shape[:-1
+0000bb30: 5d2c 2064 7479 7065 3d6d 696e 6473 706f  ], dtype=mindspo
+0000bb40: 7265 2e69 6e74 3634 290a 0a20 2020 2020  re.int64)..     
+0000bb50: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+0000bb60: 2869 6e70 7574 5f69 6473 2c20 6c69 7374  (input_ids, list
+0000bb70: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
+0000bb80: 6e70 7574 5f69 6473 203d 206d 696e 6473  nput_ids = minds
+0000bb90: 706f 7265 2e54 656e 736f 7228 696e 7075  pore.Tensor(inpu
+0000bba0: 745f 6964 7329 0a0a 2020 2020 2020 2020  t_ids)..        
+0000bbb0: 7175 6573 7469 6f6e 5f6f 7574 7075 7473  question_outputs
+0000bbc0: 203d 2073 656c 662e 7465 7874 5f65 6e63   = self.text_enc
+0000bbd0: 6f64 6572 280a 2020 2020 2020 2020 2020  oder(.          
+0000bbe0: 2020 696e 7075 745f 6964 733d 696e 7075    input_ids=inpu
+0000bbf0: 745f 6964 732c 0a20 2020 2020 2020 2020  t_ids,.         
+0000bc00: 2020 2061 7474 656e 7469 6f6e 5f6d 6173     attention_mas
+0000bc10: 6b3d 6174 7465 6e74 696f 6e5f 6d61 736b  k=attention_mask
+0000bc20: 2c0a 2020 2020 2020 2020 2020 2020 656e  ,.            en
+0000bc30: 636f 6465 725f 6869 6464 656e 5f73 7461  coder_hidden_sta
+0000bc40: 7465 733d 696d 6167 655f 656d 6265 6473  tes=image_embeds
+0000bc50: 2c0a 2020 2020 2020 2020 2020 2020 656e  ,.            en
+0000bc60: 636f 6465 725f 6174 7465 6e74 696f 6e5f  coder_attention_
+0000bc70: 6d61 736b 3d69 6d61 6765 5f61 7474 656e  mask=image_atten
+0000bc80: 7469 6f6e 5f6d 6173 6b2c 0a20 2020 2020  tion_mask,.     
+0000bc90: 2020 2020 2020 2072 6574 7572 6e5f 6469         return_di
+0000bca0: 6374 3d46 616c 7365 2c0a 2020 2020 2020  ct=False,.      
+0000bcb0: 2020 290a 0a20 2020 2020 2020 2071 7565    )..        que
+0000bcc0: 7374 696f 6e5f 656d 6265 6473 203d 2071  stion_embeds = q
+0000bcd0: 7565 7374 696f 6e5f 6f75 7470 7574 735b  uestion_outputs[
+0000bce0: 305d 0a0a 2020 2020 2020 2020 7175 6573  0]..        ques
+0000bcf0: 7469 6f6e 5f61 7474 656e 7469 6f6e 5f6d  tion_attention_m
+0000bd00: 6173 6b20 3d20 6f70 732e 6f6e 6573 2871  ask = ops.ones(q
+0000bd10: 7565 7374 696f 6e5f 656d 6265 6473 2e73  uestion_embeds.s
+0000bd20: 6861 7065 5b3a 2d31 5d2c 2064 7479 7065  hape[:-1], dtype
+0000bd30: 3d6d 696e 6473 706f 7265 2e69 6e74 3634  =mindspore.int64
+0000bd40: 290a 0a20 2020 2020 2020 2062 6f73 5f69  )..        bos_i
+0000bd50: 6473 203d 206f 7073 2e66 756c 6c28 0a20  ds = ops.full(. 
+0000bd60: 2020 2020 2020 2020 2020 2028 7175 6573             (ques
+0000bd70: 7469 6f6e 5f65 6d62 6564 732e 7368 6170  tion_embeds.shap
+0000bd80: 655b 305d 2c20 3129 2c20 6669 6c6c 5f76  e[0], 1), fill_v
+0000bd90: 616c 7565 3d73 656c 662e 6465 636f 6465  alue=self.decode
+0000bda0: 725f 7374 6172 745f 746f 6b65 6e5f 6964  r_start_token_id
+0000bdb0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+0000bdc0: 2020 2020 6f75 7470 7574 7320 3d20 7365      outputs = se
+0000bdd0: 6c66 2e74 6578 745f 6465 636f 6465 722e  lf.text_decoder.
+0000bde0: 6765 6e65 7261 7465 280a 2020 2020 2020  generate(.      
+0000bdf0: 2020 2020 2020 696e 7075 745f 6964 733d        input_ids=
+0000be00: 626f 735f 6964 732c 0a20 2020 2020 2020  bos_ids,.       
+0000be10: 2020 2020 2065 6f73 5f74 6f6b 656e 5f69       eos_token_i
+0000be20: 643d 7365 6c66 2e63 6f6e 6669 672e 7465  d=self.config.te
+0000be30: 7874 5f63 6f6e 6669 672e 7365 705f 746f  xt_config.sep_to
+0000be40: 6b65 6e5f 6964 2c0a 2020 2020 2020 2020  ken_id,.        
+0000be50: 2020 2020 7061 645f 746f 6b65 6e5f 6964      pad_token_id
+0000be60: 3d73 656c 662e 636f 6e66 6967 2e74 6578  =self.config.tex
+0000be70: 745f 636f 6e66 6967 2e70 6164 5f74 6f6b  t_config.pad_tok
+0000be80: 656e 5f69 642c 0a20 2020 2020 2020 2020  en_id,.         
+0000be90: 2020 2065 6e63 6f64 6572 5f68 6964 6465     encoder_hidde
+0000bea0: 6e5f 7374 6174 6573 3d71 7565 7374 696f  n_states=questio
+0000beb0: 6e5f 656d 6265 6473 2c0a 2020 2020 2020  n_embeds,.      
+0000bec0: 2020 2020 2020 656e 636f 6465 725f 6174        encoder_at
+0000bed0: 7465 6e74 696f 6e5f 6d61 736b 3d71 7565  tention_mask=que
+0000bee0: 7374 696f 6e5f 6174 7465 6e74 696f 6e5f  stion_attention_
+0000bef0: 6d61 736b 2c0a 2020 2020 2020 2020 2020  mask,.          
+0000bf00: 2020 2a2a 6765 6e65 7261 7465 5f6b 7761    **generate_kwa
+0000bf10: 7267 732c 0a20 2020 2020 2020 2029 0a0a  rgs,.        )..
+0000bf20: 2020 2020 2020 2020 7265 7475 726e 206f          return o
+0000bf30: 7574 7075 7473 0a0a 0a63 6c61 7373 2042  utputs...class B
+0000bf40: 6c69 7046 6f72 496d 6167 6554 6578 7452  lipForImageTextR
+0000bf50: 6574 7269 6576 616c 2842 6c69 7050 7265  etrieval(BlipPre
+0000bf60: 5472 6169 6e65 644d 6f64 656c 293a 0a20  TrainedModel):. 
+0000bf70: 2020 2063 6f6e 6669 675f 636c 6173 7320     config_class 
+0000bf80: 3d20 426c 6970 436f 6e66 6967 0a0a 2020  = BlipConfig..  
+0000bf90: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
+0000bfa0: 656c 662c 2063 6f6e 6669 673a 2042 6c69  elf, config: Bli
+0000bfb0: 7043 6f6e 6669 6729 3a0a 2020 2020 2020  pConfig):.      
+0000bfc0: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
+0000bfd0: 5f5f 2863 6f6e 6669 6729 0a0a 2020 2020  __(config)..    
+0000bfe0: 2020 2020 7365 6c66 2e76 6973 696f 6e5f      self.vision_
+0000bff0: 6d6f 6465 6c20 3d20 426c 6970 5669 7369  model = BlipVisi
+0000c000: 6f6e 4d6f 6465 6c28 636f 6e66 6967 2e76  onModel(config.v
+0000c010: 6973 696f 6e5f 636f 6e66 6967 290a 0a20  ision_config).. 
+0000c020: 2020 2020 2020 2073 656c 662e 7465 7874         self.text
+0000c030: 5f65 6e63 6f64 6572 203d 2042 6c69 7054  _encoder = BlipT
+0000c040: 6578 744d 6f64 656c 2863 6f6e 6669 672e  extModel(config.
+0000c050: 7465 7874 5f63 6f6e 6669 672c 2061 6464  text_config, add
+0000c060: 5f70 6f6f 6c69 6e67 5f6c 6179 6572 3d46  _pooling_layer=F
+0000c070: 616c 7365 290a 0a20 2020 2020 2020 2023  alse)..        #
+0000c080: 2076 6973 696f 6e20 7072 6f6a 6563 7469   vision projecti
+0000c090: 6f6e 206c 6179 6572 0a20 2020 2020 2020  on layer.       
+0000c0a0: 2073 656c 662e 7669 7369 6f6e 5f70 726f   self.vision_pro
+0000c0b0: 6a20 3d20 6e6e 2e44 656e 7365 2863 6f6e  j = nn.Dense(con
+0000c0c0: 6669 672e 7669 7369 6f6e 5f63 6f6e 6669  fig.vision_confi
+0000c0d0: 672e 6869 6464 656e 5f73 697a 652c 2063  g.hidden_size, c
+0000c0e0: 6f6e 6669 672e 696d 6167 655f 7465 7874  onfig.image_text
+0000c0f0: 5f68 6964 6465 6e5f 7369 7a65 290a 0a20  _hidden_size).. 
+0000c100: 2020 2020 2020 2023 2074 6578 7420 7072         # text pr
+0000c110: 6f6a 6563 7469 6f6e 206c 6179 6572 0a20  ojection layer. 
+0000c120: 2020 2020 2020 2073 656c 662e 7465 7874         self.text
+0000c130: 5f70 726f 6a20 3d20 6e6e 2e44 656e 7365  _proj = nn.Dense
+0000c140: 2863 6f6e 6669 672e 7465 7874 5f63 6f6e  (config.text_con
+0000c150: 6669 672e 6869 6464 656e 5f73 697a 652c  fig.hidden_size,
+0000c160: 2063 6f6e 6669 672e 696d 6167 655f 7465   config.image_te
+0000c170: 7874 5f68 6964 6465 6e5f 7369 7a65 290a  xt_hidden_size).
+0000c180: 0a20 2020 2020 2020 2023 2069 6d61 6765  .        # image
+0000c190: 2074 6578 7420 6d61 7463 6869 6e67 2068   text matching h
+0000c1a0: 6561 640a 2020 2020 2020 2020 7365 6c66  ead.        self
+0000c1b0: 2e69 746d 5f68 6561 6420 3d20 6e6e 2e44  .itm_head = nn.D
+0000c1c0: 656e 7365 2863 6f6e 6669 672e 7465 7874  ense(config.text
+0000c1d0: 5f63 6f6e 6669 672e 6869 6464 656e 5f73  _config.hidden_s
+0000c1e0: 697a 652c 2032 290a 0a20 2020 2020 2020  ize, 2)..       
+0000c1f0: 2073 656c 662e 6465 636f 6465 725f 7061   self.decoder_pa
+0000c200: 645f 746f 6b65 6e5f 6964 203d 2028 0a20  d_token_id = (. 
+0000c210: 2020 2020 2020 2020 2020 2063 6f6e 6669             confi
+0000c220: 672e 7465 7874 5f63 6f6e 6669 672e 7061  g.text_config.pa
+0000c230: 645f 746f 6b65 6e5f 6964 0a20 2020 2020  d_token_id.     
+0000c240: 2020 2020 2020 2069 6620 6e6f 7420 6861         if not ha
+0000c250: 7361 7474 7228 636f 6e66 6967 2c20 2264  sattr(config, "d
+0000c260: 6563 6f64 6572 5f70 6164 5f74 6f6b 656e  ecoder_pad_token
+0000c270: 5f69 6422 290a 2020 2020 2020 2020 2020  _id").          
+0000c280: 2020 656c 7365 2063 6f6e 6669 672e 6465    else config.de
+0000c290: 636f 6465 725f 7061 645f 746f 6b65 6e5f  coder_pad_token_
+0000c2a0: 6964 0a20 2020 2020 2020 2029 0a20 2020  id.        ).   
+0000c2b0: 2020 2020 2073 656c 662e 6465 636f 6465       self.decode
+0000c2c0: 725f 7374 6172 745f 746f 6b65 6e5f 6964  r_start_token_id
+0000c2d0: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+0000c2e0: 2063 6f6e 6669 672e 7465 7874 5f63 6f6e   config.text_con
+0000c2f0: 6669 672e 626f 735f 746f 6b65 6e5f 6964  fig.bos_token_id
+0000c300: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0000c310: 6e6f 7420 6861 7361 7474 7228 636f 6e66  not hasattr(conf
+0000c320: 6967 2c20 2264 6563 6f64 6572 5f73 7461  ig, "decoder_sta
+0000c330: 7274 5f74 6f6b 656e 5f69 6422 290a 2020  rt_token_id").  
+0000c340: 2020 2020 2020 2020 2020 656c 7365 2063            else c
+0000c350: 6f6e 6669 672e 6465 636f 6465 725f 7374  onfig.decoder_st
+0000c360: 6172 745f 746f 6b65 6e5f 6964 0a20 2020  art_token_id.   
+0000c370: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+0000c380: 2320 496e 6974 6961 6c69 7a65 2077 6569  # Initialize wei
+0000c390: 6768 7473 2061 6e64 2061 7070 6c79 2066  ghts and apply f
+0000c3a0: 696e 616c 2070 726f 6365 7373 696e 670a  inal processing.
+0000c3b0: 2020 2020 2020 2020 7365 6c66 2e70 6f73          self.pos
+0000c3c0: 745f 696e 6974 2829 0a0a 2020 2020 6465  t_init()..    de
+0000c3d0: 6620 6765 745f 696e 7075 745f 656d 6265  f get_input_embe
+0000c3e0: 6464 696e 6773 2873 656c 6629 202d 3e20  ddings(self) -> 
+0000c3f0: 6e6e 2e43 656c 6c3a 0a20 2020 2020 2020  nn.Cell:.       
+0000c400: 2072 6574 7572 6e20 7365 6c66 2e76 6973   return self.vis
+0000c410: 696f 6e5f 6d6f 6465 6c2e 656d 6265 6464  ion_model.embedd
+0000c420: 696e 6773 2e70 6174 6368 5f65 6d62 6564  ings.patch_embed
+0000c430: 6469 6e67 0a0a 2020 2020 6465 6620 636f  ding..    def co
+0000c440: 6e73 7472 7563 7428 0a20 2020 2020 2020  nstruct(.       
+0000c450: 2073 656c 662c 0a20 2020 2020 2020 2069   self,.        i
+0000c460: 6e70 7574 5f69 6473 3a20 6d69 6e64 7370  nput_ids: mindsp
+0000c470: 6f72 652e 5465 6e73 6f72 2c0a 2020 2020  ore.Tensor,.    
+0000c480: 2020 2020 7069 7865 6c5f 7661 6c75 6573      pixel_values
+0000c490: 3a20 6d69 6e64 7370 6f72 652e 5465 6e73  : mindspore.Tens
+0000c4a0: 6f72 2c0a 2020 2020 2020 2020 7573 655f  or,.        use_
+0000c4b0: 6974 6d5f 6865 6164 3a20 4f70 7469 6f6e  itm_head: Option
+0000c4c0: 616c 5b62 6f6f 6c5d 203d 2054 7275 652c  al[bool] = True,
+0000c4d0: 0a20 2020 2020 2020 2061 7474 656e 7469  .        attenti
+0000c4e0: 6f6e 5f6d 6173 6b3a 204f 7074 696f 6e61  on_mask: Optiona
+0000c4f0: 6c5b 6d69 6e64 7370 6f72 652e 5465 6e73  l[mindspore.Tens
+0000c500: 6f72 5d20 3d20 4e6f 6e65 2c0a 2020 2020  or] = None,.    
+0000c510: 2020 2020 6f75 7470 7574 5f61 7474 656e      output_atten
+0000c520: 7469 6f6e 733a 204f 7074 696f 6e61 6c5b  tions: Optional[
+0000c530: 626f 6f6c 5d20 3d20 4e6f 6e65 2c0a 2020  bool] = None,.  
+0000c540: 2020 2020 2020 6f75 7470 7574 5f68 6964        output_hid
+0000c550: 6465 6e5f 7374 6174 6573 3a20 4f70 7469  den_states: Opti
+0000c560: 6f6e 616c 5b62 6f6f 6c5d 203d 204e 6f6e  onal[bool] = Non
+0000c570: 652c 0a20 2020 2020 2020 2072 6574 7572  e,.        retur
+0000c580: 6e5f 6469 6374 3a20 4f70 7469 6f6e 616c  n_dict: Optional
+0000c590: 5b62 6f6f 6c5d 203d 204e 6f6e 652c 0a20  [bool] = None,. 
+0000c5a0: 2020 2029 202d 3e20 556e 696f 6e5b 5475     ) -> Union[Tu
+0000c5b0: 706c 652c 2042 6c69 7054 6578 7456 6973  ple, BlipTextVis
+0000c5c0: 696f 6e4d 6f64 656c 4f75 7470 7574 5d3a  ionModelOutput]:
+0000c5d0: 0a20 2020 2020 2020 2072 2222 220a 2020  .        r""".  
+0000c5e0: 2020 2020 2020 5265 7475 726e 733a 0a0a        Returns:..
+0000c5f0: 2020 2020 2020 2020 4578 616d 706c 6573          Examples
+0000c600: 3a0a 0a20 2020 2020 2020 2060 6060 7079  :..        ```py
+0000c610: 7468 6f6e 0a20 2020 2020 2020 203e 3e3e  thon.        >>>
+0000c620: 2066 726f 6d20 5049 4c20 696d 706f 7274   from PIL import
+0000c630: 2049 6d61 6765 0a20 2020 2020 2020 203e   Image.        >
+0000c640: 3e3e 2069 6d70 6f72 7420 7265 7175 6573  >> import reques
+0000c650: 7473 0a20 2020 2020 2020 203e 3e3e 2066  ts.        >>> f
+0000c660: 726f 6d20 7472 616e 7366 6f72 6d65 7273  rom transformers
+0000c670: 2069 6d70 6f72 7420 4175 746f 5072 6f63   import AutoProc
+0000c680: 6573 736f 722c 2042 6c69 7046 6f72 496d  essor, BlipForIm
+0000c690: 6167 6554 6578 7452 6574 7269 6576 616c  ageTextRetrieval
+0000c6a0: 0a0a 2020 2020 2020 2020 3e3e 3e20 6d6f  ..        >>> mo
+0000c6b0: 6465 6c20 3d20 426c 6970 466f 7249 6d61  del = BlipForIma
+0000c6c0: 6765 5465 7874 5265 7472 6965 7661 6c2e  geTextRetrieval.
+0000c6d0: 6672 6f6d 5f70 7265 7472 6169 6e65 6428  from_pretrained(
+0000c6e0: 2253 616c 6573 666f 7263 652f 626c 6970  "Salesforce/blip
+0000c6f0: 2d69 746d 2d62 6173 652d 636f 636f 2229  -itm-base-coco")
+0000c700: 0a20 2020 2020 2020 203e 3e3e 2070 726f  .        >>> pro
+0000c710: 6365 7373 6f72 203d 2041 7574 6f50 726f  cessor = AutoPro
+0000c720: 6365 7373 6f72 2e66 726f 6d5f 7072 6574  cessor.from_pret
+0000c730: 7261 696e 6564 2822 5361 6c65 7366 6f72  rained("Salesfor
+0000c740: 6365 2f62 6c69 702d 6974 6d2d 6261 7365  ce/blip-itm-base
+0000c750: 2d63 6f63 6f22 290a 0a20 2020 2020 2020  -coco")..       
+0000c760: 203e 3e3e 2075 726c 203d 2022 6874 7470   >>> url = "http
+0000c770: 3a2f 2f69 6d61 6765 732e 636f 636f 6461  ://images.cocoda
+0000c780: 7461 7365 742e 6f72 672f 7661 6c32 3031  taset.org/val201
+0000c790: 372f 3030 3030 3030 3033 3937 3639 2e6a  7/000000039769.j
+0000c7a0: 7067 220a 2020 2020 2020 2020 3e3e 3e20  pg".        >>> 
+0000c7b0: 696d 6167 6520 3d20 496d 6167 652e 6f70  image = Image.op
+0000c7c0: 656e 2872 6571 7565 7374 732e 6765 7428  en(requests.get(
+0000c7d0: 7572 6c2c 2073 7472 6561 6d3d 5472 7565  url, stream=True
+0000c7e0: 292e 7261 7729 0a20 2020 2020 2020 203e  ).raw).        >
+0000c7f0: 3e3e 2074 6578 7420 3d20 2261 6e20 696d  >> text = "an im
+0000c800: 6167 6520 6f66 2061 2063 6174 220a 0a20  age of a cat".. 
+0000c810: 2020 2020 2020 203e 3e3e 2069 6e70 7574         >>> input
+0000c820: 7320 3d20 7072 6f63 6573 736f 7228 696d  s = processor(im
+0000c830: 6167 6573 3d69 6d61 6765 2c20 7465 7874  ages=image, text
+0000c840: 3d74 6578 742c 2072 6574 7572 6e5f 7465  =text, return_te
+0000c850: 6e73 6f72 733d 2270 7422 290a 2020 2020  nsors="pt").    
+0000c860: 2020 2020 3e3e 3e20 6f75 7470 7574 7320      >>> outputs 
+0000c870: 3d20 6d6f 6465 6c28 2a2a 696e 7075 7473  = model(**inputs
+0000c880: 290a 2020 2020 2020 2020 6060 600a 2020  ).        ```.  
+0000c890: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0000c8a0: 2020 7265 7475 726e 5f64 6963 7420 3d20    return_dict = 
+0000c8b0: 7265 7475 726e 5f64 6963 7420 6966 2072  return_dict if r
+0000c8c0: 6574 7572 6e5f 6469 6374 2069 7320 6e6f  eturn_dict is no
+0000c8d0: 7420 4e6f 6e65 2065 6c73 6520 7365 6c66  t None else self
+0000c8e0: 2e63 6f6e 6669 672e 7573 655f 7265 7475  .config.use_retu
+0000c8f0: 726e 5f64 6963 740a 2020 2020 2020 2020  rn_dict.        
+0000c900: 6f75 7470 7574 5f61 7474 656e 7469 6f6e  output_attention
+0000c910: 7320 3d20 6f75 7470 7574 5f61 7474 656e  s = output_atten
+0000c920: 7469 6f6e 7320 6966 206f 7574 7075 745f  tions if output_
+0000c930: 6174 7465 6e74 696f 6e73 2069 7320 6e6f  attentions is no
+0000c940: 7420 4e6f 6e65 2065 6c73 6520 7365 6c66  t None else self
+0000c950: 2e63 6f6e 6669 672e 6f75 7470 7574 5f61  .config.output_a
+0000c960: 7474 656e 7469 6f6e 730a 2020 2020 2020  ttentions.      
+0000c970: 2020 6f75 7470 7574 5f68 6964 6465 6e5f    output_hidden_
+0000c980: 7374 6174 6573 203d 2028 0a20 2020 2020  states = (.     
+0000c990: 2020 2020 2020 206f 7574 7075 745f 6869         output_hi
+0000c9a0: 6464 656e 5f73 7461 7465 7320 6966 206f  dden_states if o
+0000c9b0: 7574 7075 745f 6869 6464 656e 5f73 7461  utput_hidden_sta
+0000c9c0: 7465 7320 6973 206e 6f74 204e 6f6e 6520  tes is not None 
+0000c9d0: 656c 7365 2073 656c 662e 636f 6e66 6967  else self.config
+0000c9e0: 2e6f 7574 7075 745f 6869 6464 656e 5f73  .output_hidden_s
+0000c9f0: 7461 7465 730a 2020 2020 2020 2020 290a  tates.        ).
+0000ca00: 0a20 2020 2020 2020 2076 6973 696f 6e5f  .        vision_
+0000ca10: 6f75 7470 7574 7320 3d20 7365 6c66 2e76  outputs = self.v
+0000ca20: 6973 696f 6e5f 6d6f 6465 6c28 0a20 2020  ision_model(.   
+0000ca30: 2020 2020 2020 2020 2070 6978 656c 5f76           pixel_v
+0000ca40: 616c 7565 733d 7069 7865 6c5f 7661 6c75  alues=pixel_valu
+0000ca50: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+0000ca60: 6f75 7470 7574 5f61 7474 656e 7469 6f6e  output_attention
+0000ca70: 733d 6f75 7470 7574 5f61 7474 656e 7469  s=output_attenti
+0000ca80: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
+0000ca90: 206f 7574 7075 745f 6869 6464 656e 5f73   output_hidden_s
+0000caa0: 7461 7465 733d 6f75 7470 7574 5f68 6964  tates=output_hid
+0000cab0: 6465 6e5f 7374 6174 6573 2c0a 2020 2020  den_states,.    
+0000cac0: 2020 2020 2020 2020 7265 7475 726e 5f64          return_d
+0000cad0: 6963 743d 7265 7475 726e 5f64 6963 742c  ict=return_dict,
+0000cae0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+0000caf0: 2020 2020 696d 6167 655f 656d 6265 6473      image_embeds
+0000cb00: 203d 2076 6973 696f 6e5f 6f75 7470 7574   = vision_output
+0000cb10: 735b 305d 0a20 2020 2020 2020 2069 6d61  s[0].        ima
+0000cb20: 6765 5f61 7474 7320 3d20 6f70 732e 6f6e  ge_atts = ops.on
+0000cb30: 6573 2869 6d61 6765 5f65 6d62 6564 732e  es(image_embeds.
+0000cb40: 7368 6170 655b 3a2d 315d 2c20 6474 7970  shape[:-1], dtyp
+0000cb50: 653d 6d69 6e64 7370 6f72 652e 696e 7436  e=mindspore.int6
+0000cb60: 3429 0a0a 2020 2020 2020 2020 6966 2075  4)..        if u
+0000cb70: 7365 5f69 746d 5f68 6561 643a 0a20 2020  se_itm_head:.   
+0000cb80: 2020 2020 2020 2020 2071 7565 7374 696f           questio
+0000cb90: 6e5f 656d 6265 6473 203d 2073 656c 662e  n_embeds = self.
+0000cba0: 7465 7874 5f65 6e63 6f64 6572 280a 2020  text_encoder(.  
+0000cbb0: 2020 2020 2020 2020 2020 2020 2020 696e                in
+0000cbc0: 7075 745f 6964 733d 696e 7075 745f 6964  put_ids=input_id
+0000cbd0: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+0000cbe0: 2020 2061 7474 656e 7469 6f6e 5f6d 6173     attention_mas
+0000cbf0: 6b3d 6174 7465 6e74 696f 6e5f 6d61 736b  k=attention_mask
+0000cc00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000cc10: 2020 656e 636f 6465 725f 6869 6464 656e    encoder_hidden
+0000cc20: 5f73 7461 7465 733d 696d 6167 655f 656d  _states=image_em
+0000cc30: 6265 6473 2c0a 2020 2020 2020 2020 2020  beds,.          
+0000cc40: 2020 2020 2020 656e 636f 6465 725f 6174        encoder_at
+0000cc50: 7465 6e74 696f 6e5f 6d61 736b 3d69 6d61  tention_mask=ima
+0000cc60: 6765 5f61 7474 732c 0a20 2020 2020 2020  ge_atts,.       
+0000cc70: 2020 2020 2020 2020 2072 6574 7572 6e5f           return_
+0000cc80: 6469 6374 3d72 6574 7572 6e5f 6469 6374  dict=return_dict
+0000cc90: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+0000cca0: 2020 2020 2020 2020 2020 2020 7175 6573              ques
+0000ccb0: 7469 6f6e 5f65 6d62 6564 7320 3d20 7175  tion_embeds = qu
+0000ccc0: 6573 7469 6f6e 5f65 6d62 6564 735b 305d  estion_embeds[0]
+0000ccd0: 2069 6620 6e6f 7420 7265 7475 726e 5f64   if not return_d
+0000cce0: 6963 7420 656c 7365 2071 7565 7374 696f  ict else questio
+0000ccf0: 6e5f 656d 6265 6473 2e6c 6173 745f 6869  n_embeds.last_hi
+0000cd00: 6464 656e 5f73 7461 7465 0a0a 2020 2020  dden_state..    
+0000cd10: 2020 2020 2020 2020 6f75 7470 7574 203d          output =
+0000cd20: 2073 656c 662e 6974 6d5f 6865 6164 2871   self.itm_head(q
+0000cd30: 7565 7374 696f 6e5f 656d 6265 6473 5b3a  uestion_embeds[:
+0000cd40: 2c20 302c 203a 5d29 0a20 2020 2020 2020  , 0, :]).       
+0000cd50: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0000cd60: 2020 2071 7565 7374 696f 6e5f 656d 6265     question_embe
+0000cd70: 6473 203d 2073 656c 662e 7465 7874 5f65  ds = self.text_e
+0000cd80: 6e63 6f64 6572 280a 2020 2020 2020 2020  ncoder(.        
+0000cd90: 2020 2020 2020 2020 696e 7075 745f 6964          input_id
+0000cda0: 733d 696e 7075 745f 6964 732c 0a20 2020  s=input_ids,.   
+0000cdb0: 2020 2020 2020 2020 2020 2020 2061 7474               att
+0000cdc0: 656e 7469 6f6e 5f6d 6173 6b3d 6174 7465  ention_mask=atte
+0000cdd0: 6e74 696f 6e5f 6d61 736b 2c0a 2020 2020  ntion_mask,.    
+0000cde0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000cdf0: 726e 5f64 6963 743d 7265 7475 726e 5f64  rn_dict=return_d
+0000ce00: 6963 742c 0a20 2020 2020 2020 2020 2020  ict,.           
+0000ce10: 2029 0a20 2020 2020 2020 2020 2020 2071   ).            q
+0000ce20: 7565 7374 696f 6e5f 656d 6265 6473 203d  uestion_embeds =
+0000ce30: 2071 7565 7374 696f 6e5f 656d 6265 6473   question_embeds
+0000ce40: 5b30 5d20 6966 206e 6f74 2072 6574 7572  [0] if not retur
+0000ce50: 6e5f 6469 6374 2065 6c73 6520 7175 6573  n_dict else ques
+0000ce60: 7469 6f6e 5f65 6d62 6564 732e 6c61 7374  tion_embeds.last
+0000ce70: 5f68 6964 6465 6e5f 7374 6174 650a 0a20  _hidden_state.. 
+0000ce80: 2020 2020 2020 2020 2020 2069 6d61 6765             image
+0000ce90: 5f66 6561 7420 3d20 6e6f 726d 616c 697a  _feat = normaliz
+0000cea0: 6528 7365 6c66 2e76 6973 696f 6e5f 7072  e(self.vision_pr
+0000ceb0: 6f6a 2869 6d61 6765 5f65 6d62 6564 735b  oj(image_embeds[
+0000cec0: 3a2c 2030 2c20 3a5d 292c 2064 696d 3d2d  :, 0, :]), dim=-
+0000ced0: 3129 0a20 2020 2020 2020 2020 2020 2074  1).            t
+0000cee0: 6578 745f 6665 6174 203d 206e 6f72 6d61  ext_feat = norma
+0000cef0: 6c69 7a65 2873 656c 662e 7465 7874 5f70  lize(self.text_p
+0000cf00: 726f 6a28 7175 6573 7469 6f6e 5f65 6d62  roj(question_emb
+0000cf10: 6564 735b 3a2c 2030 2c20 3a5d 292c 2064  eds[:, 0, :]), d
+0000cf20: 696d 3d2d 3129 0a0a 2020 2020 2020 2020  im=-1)..        
+0000cf30: 2020 2020 6f75 7470 7574 203d 2069 6d61      output = ima
+0000cf40: 6765 5f66 6561 7420 4020 7465 7874 5f66  ge_feat @ text_f
+0000cf50: 6561 742e 7428 290a 0a20 2020 2020 2020  eat.t()..       
+0000cf60: 2069 6620 6e6f 7420 7265 7475 726e 5f64   if not return_d
+0000cf70: 6963 743a 0a20 2020 2020 2020 2020 2020  ict:.           
+0000cf80: 206f 7574 7075 7473 203d 2028 6f75 7470   outputs = (outp
+0000cf90: 7574 2c20 7669 7369 6f6e 5f6f 7574 7075  ut, vision_outpu
+0000cfa0: 7473 5b30 5d29 202b 2076 6973 696f 6e5f  ts[0]) + vision_
+0000cfb0: 6f75 7470 7574 735b 323a 5d20 2b20 2871  outputs[2:] + (q
+0000cfc0: 7565 7374 696f 6e5f 656d 6265 6473 2c29  uestion_embeds,)
+0000cfd0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0000cfe0: 7572 6e20 7475 706c 6528 6f75 7470 7574  urn tuple(output
+0000cff0: 2066 6f72 206f 7574 7075 7420 696e 206f   for output in o
+0000d000: 7574 7075 7473 2069 6620 6f75 7470 7574  utputs if output
+0000d010: 2069 7320 6e6f 7420 4e6f 6e65 290a 0a20   is not None).. 
+0000d020: 2020 2020 2020 2072 6574 7572 6e20 426c         return Bl
+0000d030: 6970 496d 6167 6554 6578 744d 6174 6368  ipImageTextMatch
+0000d040: 696e 674d 6f64 656c 4f75 7470 7574 280a  ingModelOutput(.
+0000d050: 2020 2020 2020 2020 2020 2020 6974 6d5f              itm_
+0000d060: 7363 6f72 653d 6f75 7470 7574 2c0a 2020  score=output,.  
+0000d070: 2020 2020 2020 2020 2020 6c61 7374 5f68            last_h
+0000d080: 6964 6465 6e5f 7374 6174 653d 7669 7369  idden_state=visi
+0000d090: 6f6e 5f6f 7574 7075 7473 2e6c 6173 745f  on_outputs.last_
+0000d0a0: 6869 6464 656e 5f73 7461 7465 2c0a 2020  hidden_state,.  
+0000d0b0: 2020 2020 2020 2020 2020 6869 6464 656e            hidden
+0000d0c0: 5f73 7461 7465 733d 7669 7369 6f6e 5f6f  _states=vision_o
+0000d0d0: 7574 7075 7473 2e68 6964 6465 6e5f 7374  utputs.hidden_st
+0000d0e0: 6174 6573 2c0a 2020 2020 2020 2020 2020  ates,.          
+0000d0f0: 2020 6174 7465 6e74 696f 6e73 3d76 6973    attentions=vis
+0000d100: 696f 6e5f 6f75 7470 7574 732e 6174 7465  ion_outputs.atte
+0000d110: 6e74 696f 6e73 2c0a 2020 2020 2020 2020  ntions,.        
+0000d120: 2020 2020 7175 6573 7469 6f6e 5f65 6d62      question_emb
+0000d130: 6564 733d 7175 6573 7469 6f6e 5f65 6d62  eds=question_emb
+0000d140: 6564 732c 0a20 2020 2020 2020 2029 0a0a  eds,.        )..
+0000d150: 5f5f 616c 6c5f 5f20 3d20 5b0a 2020 2020  __all__ = [.    
+0000d160: 2242 6c69 704d 6f64 656c 222c 0a20 2020  "BlipModel",.   
+0000d170: 2022 426c 6970 5072 6554 7261 696e 6564   "BlipPreTrained
+0000d180: 4d6f 6465 6c22 2c0a 2020 2020 2242 6c69  Model",.    "Bli
+0000d190: 7046 6f72 436f 6e64 6974 696f 6e61 6c47  pForConditionalG
+0000d1a0: 656e 6572 6174 696f 6e22 2c0a 2020 2020  eneration",.    
+0000d1b0: 2242 6c69 7046 6f72 5175 6573 7469 6f6e  "BlipForQuestion
+0000d1c0: 416e 7377 6572 696e 6722 2c0a 2020 2020  Answering",.    
+0000d1d0: 2242 6c69 7056 6973 696f 6e4d 6f64 656c  "BlipVisionModel
+0000d1e0: 222c 0a20 2020 2022 426c 6970 5465 7874  ",.    "BlipText
+0000d1f0: 4d6f 6465 6c22 2c0a 2020 2020 2242 6c69  Model",.    "Bli
+0000d200: 7046 6f72 496d 6167 6554 6578 7452 6574  pForImageTextRet
+0000d210: 7269 6576 616c 222c 0a5d 0a              rieval",.].
```

## mindnlp/transformers/models/blip/modeling_blip_text.py

```diff
@@ -0,0 +1,2722 @@
+00000000: 2320 636f 6469 6e67 3d75 7466 2d38 0a23  # coding=utf-8.#
+00000010: 2043 6f70 7972 6967 6874 2032 3032 3220   Copyright 2022 
+00000020: 5468 6520 5361 6c65 7366 6f72 6365 2054  The Salesforce T
+00000030: 6561 6d20 4175 7468 6f72 7320 616e 6420  eam Authors and 
+00000040: 5468 6520 4875 6767 696e 6746 6163 6520  The HuggingFace 
+00000050: 5465 616d 2e20 416c 6c20 7269 6768 7473  Team. All rights
+00000060: 2072 6573 6572 7665 642e 0a23 0a23 204c   reserved..#.# L
+00000070: 6963 656e 7365 6420 756e 6465 7220 7468  icensed under th
+00000080: 6520 4253 442d 332d 636c 6175 7365 206c  e BSD-3-clause l
+00000090: 6963 656e 7365 2028 7468 6520 224c 6963  icense (the "Lic
+000000a0: 656e 7365 2229 3b0a 2320 796f 7520 6d61  ense");.# you ma
+000000b0: 7920 6e6f 7420 7573 6520 7468 6973 2066  y not use this f
+000000c0: 696c 6520 6578 6365 7074 2069 6e20 636f  ile except in co
+000000d0: 6d70 6c69 616e 6365 2077 6974 6820 7468  mpliance with th
+000000e0: 6520 4c69 6365 6e73 652e 0a23 2059 6f75  e License..# You
+000000f0: 206d 6179 206f 6274 6169 6e20 6120 636f   may obtain a co
+00000100: 7079 206f 6620 7468 6520 4c69 6365 6e73  py of the Licens
+00000110: 6520 6174 0a23 0a23 2020 2020 2068 7474  e at.#.#     htt
+00000120: 7073 3a2f 2f6f 7065 6e73 6f75 7263 652e  ps://opensource.
+00000130: 6f72 672f 6c69 6365 6e73 6573 2f42 5344  org/licenses/BSD
+00000140: 2d33 2d43 6c61 7573 650a 230a 2320 556e  -3-Clause.#.# Un
+00000150: 6c65 7373 2072 6571 7569 7265 6420 6279  less required by
+00000160: 2061 7070 6c69 6361 626c 6520 6c61 7720   applicable law 
+00000170: 6f72 2061 6772 6565 6420 746f 2069 6e20  or agreed to in 
+00000180: 7772 6974 696e 672c 2073 6f66 7477 6172  writing, softwar
+00000190: 650a 2320 6469 7374 7269 6275 7465 6420  e.# distributed 
+000001a0: 756e 6465 7220 7468 6520 4c69 6365 6e73  under the Licens
+000001b0: 6520 6973 2064 6973 7472 6962 7574 6564  e is distributed
+000001c0: 206f 6e20 616e 2022 4153 2049 5322 2042   on an "AS IS" B
+000001d0: 4153 4953 2c0a 2320 5749 5448 4f55 5420  ASIS,.# WITHOUT 
+000001e0: 5741 5252 414e 5449 4553 204f 5220 434f  WARRANTIES OR CO
+000001f0: 4e44 4954 494f 4e53 204f 4620 414e 5920  NDITIONS OF ANY 
+00000200: 4b49 4e44 2c20 6569 7468 6572 2065 7870  KIND, either exp
+00000210: 7265 7373 206f 7220 696d 706c 6965 642e  ress or implied.
+00000220: 0a23 2053 6565 2074 6865 204c 6963 656e  .# See the Licen
+00000230: 7365 2066 6f72 2074 6865 2073 7065 6369  se for the speci
+00000240: 6669 6320 6c61 6e67 7561 6765 2067 6f76  fic language gov
+00000250: 6572 6e69 6e67 2070 6572 6d69 7373 696f  erning permissio
+00000260: 6e73 2061 6e64 0a23 206c 696d 6974 6174  ns and.# limitat
+00000270: 696f 6e73 2075 6e64 6572 2074 6865 204c  ions under the L
+00000280: 6963 656e 7365 2e0a 2222 2220 4d69 6e64  icense..""" Mind
+00000290: 5370 6f72 6520 424c 4950 2054 6578 7420  Spore BLIP Text 
+000002a0: 6d6f 6465 6c2e 2222 220a 0a69 6d70 6f72  model."""..impor
+000002b0: 7420 6d61 7468 0a66 726f 6d20 7479 7069  t math.from typi
+000002c0: 6e67 2069 6d70 6f72 7420 4c69 7374 2c20  ng import List, 
+000002d0: 4f70 7469 6f6e 616c 2c20 5475 706c 652c  Optional, Tuple,
+000002e0: 2055 6e69 6f6e 0a0a 696d 706f 7274 206d   Union..import m
+000002f0: 696e 6473 706f 7265 0a66 726f 6d20 6d69  indspore.from mi
+00000300: 6e64 7370 6f72 6520 696d 706f 7274 206e  ndspore import n
+00000310: 6e2c 206f 7073 2c20 5061 7261 6d65 7465  n, ops, Paramete
+00000320: 720a 6672 6f6d 206d 696e 6473 706f 7265  r.from mindspore
+00000330: 2e63 6f6d 6d6f 6e2e 696e 6974 6961 6c69  .common.initiali
+00000340: 7a65 7220 696d 706f 7274 2069 6e69 7469  zer import initi
+00000350: 616c 697a 6572 2c20 4e6f 726d 616c 0a0a  alizer, Normal..
+00000360: 6672 6f6d 202e 2e2e 6163 7469 7661 7469  from ...activati
+00000370: 6f6e 7320 696d 706f 7274 2041 4354 3246  ons import ACT2F
+00000380: 4e0a 6672 6f6d 202e 2e2e 6d6f 6465 6c69  N.from ...modeli
+00000390: 6e67 5f6f 7574 7075 7473 2069 6d70 6f72  ng_outputs impor
+000003a0: 7420 280a 2020 2020 4261 7365 4d6f 6465  t (.    BaseMode
+000003b0: 6c4f 7574 7075 7457 6974 6850 6173 7441  lOutputWithPastA
+000003c0: 6e64 4372 6f73 7341 7474 656e 7469 6f6e  ndCrossAttention
+000003d0: 732c 0a20 2020 2042 6173 654d 6f64 656c  s,.    BaseModel
+000003e0: 4f75 7470 7574 5769 7468 506f 6f6c 696e  OutputWithPoolin
+000003f0: 6741 6e64 4372 6f73 7341 7474 656e 7469  gAndCrossAttenti
+00000400: 6f6e 732c 0a20 2020 2043 6175 7361 6c4c  ons,.    CausalL
+00000410: 4d4f 7574 7075 7457 6974 6843 726f 7373  MOutputWithCross
+00000420: 4174 7465 6e74 696f 6e73 2c0a 290a 6672  Attentions,.).fr
+00000430: 6f6d 202e 2e2e 6d6f 6465 6c69 6e67 5f75  om ...modeling_u
+00000440: 7469 6c73 2069 6d70 6f72 7420 5072 6554  tils import PreT
+00000450: 7261 696e 6564 4d6f 6465 6c0a 6672 6f6d  rainedModel.from
+00000460: 202e 2e2e 6d73 5f75 7469 6c73 2069 6d70   ...ms_utils imp
+00000470: 6f72 7420 280a 2020 2020 6170 706c 795f  ort (.    apply_
+00000480: 6368 756e 6b69 6e67 5f74 6f5f 666f 7277  chunking_to_forw
+00000490: 6172 642c 0a20 2020 2066 696e 645f 7072  ard,.    find_pr
+000004a0: 756e 6561 626c 655f 6865 6164 735f 616e  uneable_heads_an
+000004b0: 645f 696e 6469 6365 732c 0a20 2020 2070  d_indices,.    p
+000004c0: 7275 6e65 5f6c 696e 6561 725f 6c61 7965  rune_linear_laye
+000004d0: 722c 0a29 0a66 726f 6d20 2e2e 2e2e 7574  r,.).from ....ut
+000004e0: 696c 7320 696d 706f 7274 206c 6f67 6769  ils import loggi
+000004f0: 6e67 0a66 726f 6d20 2e63 6f6e 6669 6775  ng.from .configu
+00000500: 7261 7469 6f6e 5f62 6c69 7020 696d 706f  ration_blip impo
+00000510: 7274 2042 6c69 7054 6578 7443 6f6e 6669  rt BlipTextConfi
+00000520: 670a 0a0a 6c6f 6767 6572 203d 206c 6f67  g...logger = log
+00000530: 6769 6e67 2e67 6574 5f6c 6f67 6765 7228  ging.get_logger(
+00000540: 5f5f 6e61 6d65 5f5f 290a 0a0a 2320 4164  __name__)...# Ad
+00000550: 6170 7465 6420 6672 6f6d 2068 7474 7073  apted from https
+00000560: 3a2f 2f67 6974 6875 622e 636f 6d2f 7361  ://github.com/sa
+00000570: 6c65 7366 6f72 6365 2f42 4c49 502f 626c  lesforce/BLIP/bl
+00000580: 6f62 2f6d 6169 6e2f 6d6f 6465 6c73 2f6d  ob/main/models/m
+00000590: 6564 2e70 7923 4c35 320a 636c 6173 7320  ed.py#L52.class 
+000005a0: 426c 6970 5465 7874 456d 6265 6464 696e  BlipTextEmbeddin
+000005b0: 6773 286e 6e2e 4365 6c6c 293a 0a20 2020  gs(nn.Cell):.   
+000005c0: 2022 2222 436f 6e73 7472 7563 7420 7468   """Construct th
+000005d0: 6520 656d 6265 6464 696e 6773 2066 726f  e embeddings fro
+000005e0: 6d20 776f 7264 2061 6e64 2070 6f73 6974  m word and posit
+000005f0: 696f 6e20 656d 6265 6464 696e 6773 2e22  ion embeddings."
+00000600: 2222 0a0a 2020 2020 6465 6620 5f5f 696e  ""..    def __in
+00000610: 6974 5f5f 2873 656c 662c 2063 6f6e 6669  it__(self, confi
+00000620: 6729 3a0a 2020 2020 2020 2020 7375 7065  g):.        supe
+00000630: 7228 292e 5f5f 696e 6974 5f5f 2829 0a20  r().__init__(). 
+00000640: 2020 2020 2020 2073 656c 662e 776f 7264         self.word
+00000650: 5f65 6d62 6564 6469 6e67 7320 3d20 6e6e  _embeddings = nn
+00000660: 2e45 6d62 6564 6469 6e67 2863 6f6e 6669  .Embedding(confi
+00000670: 672e 766f 6361 625f 7369 7a65 2c20 636f  g.vocab_size, co
+00000680: 6e66 6967 2e68 6964 6465 6e5f 7369 7a65  nfig.hidden_size
+00000690: 2c20 7061 6464 696e 675f 6964 783d 636f  , padding_idx=co
+000006a0: 6e66 6967 2e70 6164 5f74 6f6b 656e 5f69  nfig.pad_token_i
+000006b0: 6429 0a20 2020 2020 2020 2073 656c 662e  d).        self.
+000006c0: 706f 7369 7469 6f6e 5f65 6d62 6564 6469  position_embeddi
+000006d0: 6e67 7320 3d20 6e6e 2e45 6d62 6564 6469  ngs = nn.Embeddi
+000006e0: 6e67 2863 6f6e 6669 672e 6d61 785f 706f  ng(config.max_po
+000006f0: 7369 7469 6f6e 5f65 6d62 6564 6469 6e67  sition_embedding
+00000700: 732c 2063 6f6e 6669 672e 6869 6464 656e  s, config.hidden
+00000710: 5f73 697a 6529 0a0a 2020 2020 2020 2020  _size)..        
+00000720: 2320 7365 6c66 2e4c 6179 6572 4e6f 726d  # self.LayerNorm
+00000730: 2069 7320 6e6f 7420 736e 616b 652d 6361   is not snake-ca
+00000740: 7365 6420 746f 2073 7469 636b 2077 6974  sed to stick wit
+00000750: 6820 5465 6e73 6f72 466c 6f77 206d 6f64  h TensorFlow mod
+00000760: 656c 2076 6172 6961 626c 6520 6e61 6d65  el variable name
+00000770: 2061 6e64 2062 6520 6162 6c65 2074 6f20   and be able to 
+00000780: 6c6f 6164 0a20 2020 2020 2020 2023 2061  load.        # a
+00000790: 6e79 2054 656e 736f 7246 6c6f 7720 6368  ny TensorFlow ch
+000007a0: 6563 6b70 6f69 6e74 2066 696c 650a 2020  eckpoint file.  
+000007b0: 2020 2020 2020 7365 6c66 2e4c 6179 6572        self.Layer
+000007c0: 4e6f 726d 203d 206e 6e2e 4c61 7965 724e  Norm = nn.LayerN
+000007d0: 6f72 6d28 636f 6e66 6967 2e68 6964 6465  orm(config.hidde
+000007e0: 6e5f 7369 7a65 2c20 6570 7369 6c6f 6e3d  n_size, epsilon=
+000007f0: 636f 6e66 6967 2e6c 6179 6572 5f6e 6f72  config.layer_nor
+00000800: 6d5f 6570 7329 0a20 2020 2020 2020 2073  m_eps).        s
+00000810: 656c 662e 6472 6f70 6f75 7420 3d20 6e6e  elf.dropout = nn
+00000820: 2e44 726f 706f 7574 2870 3d63 6f6e 6669  .Dropout(p=confi
+00000830: 672e 6869 6464 656e 5f64 726f 706f 7574  g.hidden_dropout
+00000840: 5f70 726f 6229 0a0a 2020 2020 2020 2020  _prob)..        
+00000850: 2320 706f 7369 7469 6f6e 5f69 6473 2028  # position_ids (
+00000860: 312c 206c 656e 2070 6f73 6974 696f 6e20  1, len position 
+00000870: 656d 6229 2069 7320 636f 6e74 6967 756f  emb) is contiguo
+00000880: 7573 2069 6e20 6d65 6d6f 7279 2061 6e64  us in memory and
+00000890: 2065 7870 6f72 7465 6420 7768 656e 2073   exported when s
+000008a0: 6572 6961 6c69 7a65 640a 2020 2020 2020  erialized.      
+000008b0: 2020 7365 6c66 2e70 6f73 6974 696f 6e5f    self.position_
+000008c0: 6964 7320 3d20 6f70 732e 6172 616e 6765  ids = ops.arange
+000008d0: 2863 6f6e 6669 672e 6d61 785f 706f 7369  (config.max_posi
+000008e0: 7469 6f6e 5f65 6d62 6564 6469 6e67 7329  tion_embeddings)
+000008f0: 2e65 7870 616e 6428 2831 2c20 2d31 2929  .expand((1, -1))
+00000900: 0a20 2020 2020 2020 2073 656c 662e 706f  .        self.po
+00000910: 7369 7469 6f6e 5f65 6d62 6564 6469 6e67  sition_embedding
+00000920: 5f74 7970 6520 3d20 6765 7461 7474 7228  _type = getattr(
+00000930: 636f 6e66 6967 2c20 2270 6f73 6974 696f  config, "positio
+00000940: 6e5f 656d 6265 6464 696e 675f 7479 7065  n_embedding_type
+00000950: 222c 2022 6162 736f 6c75 7465 2229 0a0a  ", "absolute")..
+00000960: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
+00000970: 6669 6720 3d20 636f 6e66 6967 0a0a 2020  fig = config..  
+00000980: 2020 6465 6620 636f 6e73 7472 7563 7428    def construct(
+00000990: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+000009a0: 2020 2020 2020 2069 6e70 7574 5f69 6473         input_ids
+000009b0: 3a20 4f70 7469 6f6e 616c 5b6d 696e 6473  : Optional[minds
+000009c0: 706f 7265 2e54 656e 736f 725d 203d 204e  pore.Tensor] = N
+000009d0: 6f6e 652c 0a20 2020 2020 2020 2070 6f73  one,.        pos
+000009e0: 6974 696f 6e5f 6964 733a 204f 7074 696f  ition_ids: Optio
+000009f0: 6e61 6c5b 6d69 6e64 7370 6f72 652e 5465  nal[mindspore.Te
+00000a00: 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a 2020  nsor] = None,.  
+00000a10: 2020 2020 2020 696e 7075 7473 5f65 6d62        inputs_emb
+00000a20: 6564 733a 204f 7074 696f 6e61 6c5b 6d69  eds: Optional[mi
+00000a30: 6e64 7370 6f72 652e 5465 6e73 6f72 5d20  ndspore.Tensor] 
+00000a40: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00000a50: 7061 7374 5f6b 6579 5f76 616c 7565 735f  past_key_values_
+00000a60: 6c65 6e67 7468 3a20 696e 7420 3d20 302c  length: int = 0,
+00000a70: 0a20 2020 2029 202d 3e20 6d69 6e64 7370  .    ) -> mindsp
+00000a80: 6f72 652e 5465 6e73 6f72 3a0a 2020 2020  ore.Tensor:.    
+00000a90: 2020 2020 6966 2069 6e70 7574 5f69 6473      if input_ids
+00000aa0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00000ab0: 2020 2020 2020 2020 2020 696e 7075 745f            input_
+00000ac0: 7368 6170 6520 3d20 696e 7075 745f 6964  shape = input_id
+00000ad0: 732e 7368 6170 650a 2020 2020 2020 2020  s.shape.        
+00000ae0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00000af0: 2020 696e 7075 745f 7368 6170 6520 3d20    input_shape = 
+00000b00: 696e 7075 7473 5f65 6d62 6564 732e 7368  inputs_embeds.sh
+00000b10: 6170 655b 3a2d 315d 0a0a 2020 2020 2020  ape[:-1]..      
+00000b20: 2020 7365 715f 6c65 6e67 7468 203d 2069    seq_length = i
+00000b30: 6e70 7574 5f73 6861 7065 5b31 5d0a 0a20  nput_shape[1].. 
+00000b40: 2020 2020 2020 2069 6620 706f 7369 7469         if positi
+00000b50: 6f6e 5f69 6473 2069 7320 4e6f 6e65 3a0a  on_ids is None:.
+00000b60: 2020 2020 2020 2020 2020 2020 706f 7369              posi
+00000b70: 7469 6f6e 5f69 6473 203d 2073 656c 662e  tion_ids = self.
+00000b80: 706f 7369 7469 6f6e 5f69 6473 5b3a 2c20  position_ids[:, 
+00000b90: 7061 7374 5f6b 6579 5f76 616c 7565 735f  past_key_values_
+00000ba0: 6c65 6e67 7468 203a 2073 6571 5f6c 656e  length : seq_len
+00000bb0: 6774 6820 2b20 7061 7374 5f6b 6579 5f76  gth + past_key_v
+00000bc0: 616c 7565 735f 6c65 6e67 7468 5d0a 0a20  alues_length].. 
+00000bd0: 2020 2020 2020 2069 6620 696e 7075 7473         if inputs
+00000be0: 5f65 6d62 6564 7320 6973 204e 6f6e 653a  _embeds is None:
+00000bf0: 0a20 2020 2020 2020 2020 2020 2069 6e70  .            inp
+00000c00: 7574 735f 656d 6265 6473 203d 2073 656c  uts_embeds = sel
+00000c10: 662e 776f 7264 5f65 6d62 6564 6469 6e67  f.word_embedding
+00000c20: 7328 696e 7075 745f 6964 7329 0a0a 2020  s(input_ids)..  
+00000c30: 2020 2020 2020 656d 6265 6464 696e 6773        embeddings
+00000c40: 203d 2069 6e70 7574 735f 656d 6265 6473   = inputs_embeds
+00000c50: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+00000c60: 662e 706f 7369 7469 6f6e 5f65 6d62 6564  f.position_embed
+00000c70: 6469 6e67 5f74 7970 6520 3d3d 2022 6162  ding_type == "ab
+00000c80: 736f 6c75 7465 223a 0a20 2020 2020 2020  solute":.       
+00000c90: 2020 2020 2070 6f73 6974 696f 6e5f 656d       position_em
+00000ca0: 6265 6464 696e 6773 203d 2073 656c 662e  beddings = self.
+00000cb0: 706f 7369 7469 6f6e 5f65 6d62 6564 6469  position_embeddi
+00000cc0: 6e67 7328 706f 7369 7469 6f6e 5f69 6473  ngs(position_ids
+00000cd0: 290a 2020 2020 2020 2020 2020 2020 656d  ).            em
+00000ce0: 6265 6464 696e 6773 202b 3d20 706f 7369  beddings += posi
+00000cf0: 7469 6f6e 5f65 6d62 6564 6469 6e67 730a  tion_embeddings.
+00000d00: 2020 2020 2020 2020 656d 6265 6464 696e          embeddin
+00000d10: 6773 203d 2073 656c 662e 4c61 7965 724e  gs = self.LayerN
+00000d20: 6f72 6d28 656d 6265 6464 696e 6773 290a  orm(embeddings).
+00000d30: 2020 2020 2020 2020 656d 6265 6464 696e          embeddin
+00000d40: 6773 203d 2073 656c 662e 6472 6f70 6f75  gs = self.dropou
+00000d50: 7428 656d 6265 6464 696e 6773 290a 2020  t(embeddings).  
+00000d60: 2020 2020 2020 7265 7475 726e 2065 6d62        return emb
+00000d70: 6564 6469 6e67 730a 0a0a 2320 4164 6170  eddings...# Adap
+00000d80: 7465 6420 6672 6f6d 2068 7474 7073 3a2f  ted from https:/
+00000d90: 2f67 6974 6875 622e 636f 6d2f 7361 6c65  /github.com/sale
+00000da0: 7366 6f72 6365 2f42 4c49 502f 626c 6f62  sforce/BLIP/blob
+00000db0: 2f6d 6169 6e2f 6d6f 6465 6c73 2f6d 6564  /main/models/med
+00000dc0: 2e70 7923 4c39 370a 636c 6173 7320 426c  .py#L97.class Bl
+00000dd0: 6970 5465 7874 5365 6c66 4174 7465 6e74  ipTextSelfAttent
+00000de0: 696f 6e28 6e6e 2e43 656c 6c29 3a0a 2020  ion(nn.Cell):.  
+00000df0: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
+00000e00: 656c 662c 2063 6f6e 6669 672c 2069 735f  elf, config, is_
+00000e10: 6372 6f73 735f 6174 7465 6e74 696f 6e29  cross_attention)
+00000e20: 3a0a 2020 2020 2020 2020 7375 7065 7228  :.        super(
+00000e30: 292e 5f5f 696e 6974 5f5f 2829 0a20 2020  ).__init__().   
+00000e40: 2020 2020 2073 656c 662e 636f 6e66 6967       self.config
+00000e50: 203d 2063 6f6e 6669 670a 2020 2020 2020   = config.      
+00000e60: 2020 6966 2063 6f6e 6669 672e 6869 6464    if config.hidd
+00000e70: 656e 5f73 697a 6520 2520 636f 6e66 6967  en_size % config
+00000e80: 2e6e 756d 5f61 7474 656e 7469 6f6e 5f68  .num_attention_h
+00000e90: 6561 6473 2021 3d20 3020 616e 6420 6e6f  eads != 0 and no
+00000ea0: 7420 6861 7361 7474 7228 636f 6e66 6967  t hasattr(config
+00000eb0: 2c20 2265 6d62 6564 6469 6e67 5f73 697a  , "embedding_siz
+00000ec0: 6522 293a 0a20 2020 2020 2020 2020 2020  e"):.           
+00000ed0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+00000ee0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+00000ef0: 2020 2022 5468 6520 6869 6464 656e 2073     "The hidden s
+00000f00: 697a 6520 2825 6429 2069 7320 6e6f 7420  ize (%d) is not 
+00000f10: 6120 6d75 6c74 6970 6c65 206f 6620 7468  a multiple of th
+00000f20: 6520 6e75 6d62 6572 206f 6620 6174 7465  e number of atte
+00000f30: 6e74 696f 6e20 6865 6164 7320 2825 6429  ntion heads (%d)
+00000f40: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00000f50: 2020 2520 2863 6f6e 6669 672e 6869 6464    % (config.hidd
+00000f60: 656e 5f73 697a 652c 2063 6f6e 6669 672e  en_size, config.
+00000f70: 6e75 6d5f 6174 7465 6e74 696f 6e5f 6865  num_attention_he
+00000f80: 6164 7329 0a20 2020 2020 2020 2020 2020  ads).           
+00000f90: 2029 0a0a 2020 2020 2020 2020 7365 6c66   )..        self
+00000fa0: 2e6e 756d 5f61 7474 656e 7469 6f6e 5f68  .num_attention_h
+00000fb0: 6561 6473 203d 2063 6f6e 6669 672e 6e75  eads = config.nu
+00000fc0: 6d5f 6174 7465 6e74 696f 6e5f 6865 6164  m_attention_head
+00000fd0: 730a 2020 2020 2020 2020 7365 6c66 2e61  s.        self.a
+00000fe0: 7474 656e 7469 6f6e 5f68 6561 645f 7369  ttention_head_si
+00000ff0: 7a65 203d 2069 6e74 2863 6f6e 6669 672e  ze = int(config.
+00001000: 6869 6464 656e 5f73 697a 6520 2f20 636f  hidden_size / co
+00001010: 6e66 6967 2e6e 756d 5f61 7474 656e 7469  nfig.num_attenti
+00001020: 6f6e 5f68 6561 6473 290a 2020 2020 2020  on_heads).      
+00001030: 2020 7365 6c66 2e61 6c6c 5f68 6561 645f    self.all_head_
+00001040: 7369 7a65 203d 2073 656c 662e 6e75 6d5f  size = self.num_
+00001050: 6174 7465 6e74 696f 6e5f 6865 6164 7320  attention_heads 
+00001060: 2a20 7365 6c66 2e61 7474 656e 7469 6f6e  * self.attention
+00001070: 5f68 6561 645f 7369 7a65 0a0a 2020 2020  _head_size..    
+00001080: 2020 2020 7365 6c66 2e71 7565 7279 203d      self.query =
+00001090: 206e 6e2e 4465 6e73 6528 636f 6e66 6967   nn.Dense(config
+000010a0: 2e68 6964 6465 6e5f 7369 7a65 2c20 7365  .hidden_size, se
+000010b0: 6c66 2e61 6c6c 5f68 6561 645f 7369 7a65  lf.all_head_size
+000010c0: 290a 2020 2020 2020 2020 6966 2069 735f  ).        if is_
+000010d0: 6372 6f73 735f 6174 7465 6e74 696f 6e3a  cross_attention:
+000010e0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000010f0: 662e 6b65 7920 3d20 6e6e 2e44 656e 7365  f.key = nn.Dense
+00001100: 2863 6f6e 6669 672e 656e 636f 6465 725f  (config.encoder_
+00001110: 6869 6464 656e 5f73 697a 652c 2073 656c  hidden_size, sel
+00001120: 662e 616c 6c5f 6865 6164 5f73 697a 6529  f.all_head_size)
+00001130: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00001140: 662e 7661 6c75 6520 3d20 6e6e 2e44 656e  f.value = nn.Den
+00001150: 7365 2863 6f6e 6669 672e 656e 636f 6465  se(config.encode
+00001160: 725f 6869 6464 656e 5f73 697a 652c 2073  r_hidden_size, s
+00001170: 656c 662e 616c 6c5f 6865 6164 5f73 697a  elf.all_head_siz
+00001180: 6529 0a20 2020 2020 2020 2065 6c73 653a  e).        else:
+00001190: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000011a0: 662e 6b65 7920 3d20 6e6e 2e44 656e 7365  f.key = nn.Dense
+000011b0: 2863 6f6e 6669 672e 6869 6464 656e 5f73  (config.hidden_s
+000011c0: 697a 652c 2073 656c 662e 616c 6c5f 6865  ize, self.all_he
+000011d0: 6164 5f73 697a 6529 0a20 2020 2020 2020  ad_size).       
+000011e0: 2020 2020 2073 656c 662e 7661 6c75 6520       self.value 
+000011f0: 3d20 6e6e 2e44 656e 7365 2863 6f6e 6669  = nn.Dense(confi
+00001200: 672e 6869 6464 656e 5f73 697a 652c 2073  g.hidden_size, s
+00001210: 656c 662e 616c 6c5f 6865 6164 5f73 697a  elf.all_head_siz
+00001220: 6529 0a0a 2020 2020 2020 2020 7365 6c66  e)..        self
+00001230: 2e64 726f 706f 7574 203d 206e 6e2e 4472  .dropout = nn.Dr
+00001240: 6f70 6f75 7428 703d 636f 6e66 6967 2e61  opout(p=config.a
+00001250: 7474 656e 7469 6f6e 5f70 726f 6273 5f64  ttention_probs_d
+00001260: 726f 706f 7574 5f70 726f 6229 0a20 2020  ropout_prob).   
+00001270: 2020 2020 2073 656c 662e 706f 7369 7469       self.positi
+00001280: 6f6e 5f65 6d62 6564 6469 6e67 5f74 7970  on_embedding_typ
+00001290: 6520 3d20 6765 7461 7474 7228 636f 6e66  e = getattr(conf
+000012a0: 6967 2c20 2270 6f73 6974 696f 6e5f 656d  ig, "position_em
+000012b0: 6265 6464 696e 675f 7479 7065 222c 2022  bedding_type", "
+000012c0: 6162 736f 6c75 7465 2229 0a20 2020 2020  absolute").     
+000012d0: 2020 2069 6620 7365 6c66 2e70 6f73 6974     if self.posit
+000012e0: 696f 6e5f 656d 6265 6464 696e 675f 7479  ion_embedding_ty
+000012f0: 7065 2069 6e20 2827 7265 6c61 7469 7665  pe in ('relative
+00001300: 5f6b 6579 272c 2027 7265 6c61 7469 7665  _key', 'relative
+00001310: 5f6b 6579 5f71 7565 7279 2729 3a0a 2020  _key_query'):.  
+00001320: 2020 2020 2020 2020 2020 7365 6c66 2e6d            self.m
+00001330: 6178 5f70 6f73 6974 696f 6e5f 656d 6265  ax_position_embe
+00001340: 6464 696e 6773 203d 2063 6f6e 6669 672e  ddings = config.
+00001350: 6d61 785f 706f 7369 7469 6f6e 5f65 6d62  max_position_emb
+00001360: 6564 6469 6e67 730a 2020 2020 2020 2020  eddings.        
+00001370: 2020 2020 7365 6c66 2e64 6973 7461 6e63      self.distanc
+00001380: 655f 656d 6265 6464 696e 6720 3d20 6e6e  e_embedding = nn
+00001390: 2e45 6d62 6564 6469 6e67 2832 202a 2063  .Embedding(2 * c
+000013a0: 6f6e 6669 672e 6d61 785f 706f 7369 7469  onfig.max_positi
+000013b0: 6f6e 5f65 6d62 6564 6469 6e67 7320 2d20  on_embeddings - 
+000013c0: 312c 2073 656c 662e 6174 7465 6e74 696f  1, self.attentio
+000013d0: 6e5f 6865 6164 5f73 697a 6529 0a0a 2020  n_head_size)..  
+000013e0: 2020 6465 6620 7361 7665 5f61 7474 6e5f    def save_attn_
+000013f0: 6772 6164 6965 6e74 7328 7365 6c66 2c20  gradients(self, 
+00001400: 6174 746e 5f67 7261 6469 656e 7473 293a  attn_gradients):
+00001410: 0a20 2020 2020 2020 2073 656c 662e 6174  .        self.at
+00001420: 746e 5f67 7261 6469 656e 7473 203d 2061  tn_gradients = a
+00001430: 7474 6e5f 6772 6164 6965 6e74 730a 0a20  ttn_gradients.. 
+00001440: 2020 2064 6566 2067 6574 5f61 7474 6e5f     def get_attn_
+00001450: 6772 6164 6965 6e74 7328 7365 6c66 293a  gradients(self):
+00001460: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00001470: 7365 6c66 2e61 7474 6e5f 6772 6164 6965  self.attn_gradie
+00001480: 6e74 730a 0a20 2020 2064 6566 2073 6176  nts..    def sav
+00001490: 655f 6174 7465 6e74 696f 6e5f 6d61 7028  e_attention_map(
+000014a0: 7365 6c66 2c20 6174 7465 6e74 696f 6e5f  self, attention_
+000014b0: 6d61 7029 3a0a 2020 2020 2020 2020 7365  map):.        se
+000014c0: 6c66 2e61 7474 656e 7469 6f6e 5f6d 6170  lf.attention_map
+000014d0: 203d 2061 7474 656e 7469 6f6e 5f6d 6170   = attention_map
+000014e0: 0a0a 2020 2020 6465 6620 6765 745f 6174  ..    def get_at
+000014f0: 7465 6e74 696f 6e5f 6d61 7028 7365 6c66  tention_map(self
+00001500: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+00001510: 6e20 7365 6c66 2e61 7474 656e 7469 6f6e  n self.attention
+00001520: 5f6d 6170 0a0a 2020 2020 6465 6620 7377  _map..    def sw
+00001530: 6170 6178 6573 5f66 6f72 5f73 636f 7265  apaxes_for_score
+00001540: 7328 7365 6c66 2c20 7829 3a0a 2020 2020  s(self, x):.    
+00001550: 2020 2020 6e65 775f 785f 7368 6170 6520      new_x_shape 
+00001560: 3d20 782e 7368 6170 655b 3a2d 315d 202b  = x.shape[:-1] +
+00001570: 2028 7365 6c66 2e6e 756d 5f61 7474 656e   (self.num_atten
+00001580: 7469 6f6e 5f68 6561 6473 2c20 7365 6c66  tion_heads, self
+00001590: 2e61 7474 656e 7469 6f6e 5f68 6561 645f  .attention_head_
+000015a0: 7369 7a65 290a 2020 2020 2020 2020 7820  size).        x 
+000015b0: 3d20 782e 7669 6577 282a 6e65 775f 785f  = x.view(*new_x_
+000015c0: 7368 6170 6529 0a20 2020 2020 2020 2072  shape).        r
+000015d0: 6574 7572 6e20 782e 7065 726d 7574 6528  eturn x.permute(
+000015e0: 302c 2032 2c20 312c 2033 290a 0a20 2020  0, 2, 1, 3)..   
+000015f0: 2064 6566 2063 6f6e 7374 7275 6374 280a   def construct(.
+00001600: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+00001610: 2020 2020 2020 6869 6464 656e 5f73 7461        hidden_sta
+00001620: 7465 733a 206d 696e 6473 706f 7265 2e54  tes: mindspore.T
+00001630: 656e 736f 722c 0a20 2020 2020 2020 2061  ensor,.        a
+00001640: 7474 656e 7469 6f6e 5f6d 6173 6b3a 204f  ttention_mask: O
+00001650: 7074 696f 6e61 6c5b 6d69 6e64 7370 6f72  ptional[mindspor
+00001660: 652e 5465 6e73 6f72 5d20 3d20 4e6f 6e65  e.Tensor] = None
+00001670: 2c0a 2020 2020 2020 2020 6865 6164 5f6d  ,.        head_m
+00001680: 6173 6b3a 204f 7074 696f 6e61 6c5b 6d69  ask: Optional[mi
+00001690: 6e64 7370 6f72 652e 5465 6e73 6f72 5d20  ndspore.Tensor] 
+000016a0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+000016b0: 656e 636f 6465 725f 6869 6464 656e 5f73  encoder_hidden_s
+000016c0: 7461 7465 733a 204f 7074 696f 6e61 6c5b  tates: Optional[
+000016d0: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+000016e0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+000016f0: 2020 656e 636f 6465 725f 6174 7465 6e74    encoder_attent
+00001700: 696f 6e5f 6d61 736b 3a20 4f70 7469 6f6e  ion_mask: Option
+00001710: 616c 5b6d 696e 6473 706f 7265 2e54 656e  al[mindspore.Ten
+00001720: 736f 725d 203d 204e 6f6e 652c 0a20 2020  sor] = None,.   
+00001730: 2020 2020 2070 6173 745f 6b65 795f 7661       past_key_va
+00001740: 6c75 653a 204f 7074 696f 6e61 6c5b 5475  lue: Optional[Tu
+00001750: 706c 655b 5475 706c 655b 6d69 6e64 7370  ple[Tuple[mindsp
+00001760: 6f72 652e 5465 6e73 6f72 5d5d 5d20 3d20  ore.Tensor]]] = 
+00001770: 4e6f 6e65 2c0a 2020 2020 2020 2020 6f75  None,.        ou
+00001780: 7470 7574 5f61 7474 656e 7469 6f6e 733a  tput_attentions:
+00001790: 204f 7074 696f 6e61 6c5b 626f 6f6c 5d20   Optional[bool] 
+000017a0: 3d20 4661 6c73 652c 0a20 2020 2029 202d  = False,.    ) -
+000017b0: 3e20 5475 706c 655b 6d69 6e64 7370 6f72  > Tuple[mindspor
+000017c0: 652e 5465 6e73 6f72 5d3a 0a20 2020 2020  e.Tensor]:.     
+000017d0: 2020 206d 6978 6564 5f71 7565 7279 5f6c     mixed_query_l
+000017e0: 6179 6572 203d 2073 656c 662e 7175 6572  ayer = self.quer
+000017f0: 7928 6869 6464 656e 5f73 7461 7465 7329  y(hidden_states)
+00001800: 0a0a 2020 2020 2020 2020 2320 4966 2074  ..        # If t
+00001810: 6869 7320 6973 2069 6e73 7461 6e74 6961  his is instantia
+00001820: 7465 6420 6173 2061 2063 726f 7373 2d61  ted as a cross-a
+00001830: 7474 656e 7469 6f6e 206d 6f64 756c 652c  ttention module,
+00001840: 2074 6865 206b 6579 730a 2020 2020 2020   the keys.      
+00001850: 2020 2320 616e 6420 7661 6c75 6573 2063    # and values c
+00001860: 6f6d 6520 6672 6f6d 2061 6e20 656e 636f  ome from an enco
+00001870: 6465 723b 2074 6865 2061 7474 656e 7469  der; the attenti
+00001880: 6f6e 206d 6173 6b20 6e65 6564 7320 746f  on mask needs to
+00001890: 2062 650a 2020 2020 2020 2020 2320 7375   be.        # su
+000018a0: 6368 2074 6861 7420 7468 6520 656e 636f  ch that the enco
+000018b0: 6465 7227 7320 7061 6464 696e 6720 746f  der's padding to
+000018c0: 6b65 6e73 2061 7265 206e 6f74 2061 7474  kens are not att
+000018d0: 656e 6465 6420 746f 2e0a 2020 2020 2020  ended to..      
+000018e0: 2020 6973 5f63 726f 7373 5f61 7474 656e    is_cross_atten
+000018f0: 7469 6f6e 203d 2065 6e63 6f64 6572 5f68  tion = encoder_h
+00001900: 6964 6465 6e5f 7374 6174 6573 2069 7320  idden_states is 
+00001910: 6e6f 7420 4e6f 6e65 0a0a 2020 2020 2020  not None..      
+00001920: 2020 6966 2069 735f 6372 6f73 735f 6174    if is_cross_at
+00001930: 7465 6e74 696f 6e3a 0a20 2020 2020 2020  tention:.       
+00001940: 2020 2020 206b 6579 5f6c 6179 6572 203d       key_layer =
+00001950: 2073 656c 662e 7377 6170 6178 6573 5f66   self.swapaxes_f
+00001960: 6f72 5f73 636f 7265 7328 7365 6c66 2e6b  or_scores(self.k
+00001970: 6579 2865 6e63 6f64 6572 5f68 6964 6465  ey(encoder_hidde
+00001980: 6e5f 7374 6174 6573 2929 0a20 2020 2020  n_states)).     
+00001990: 2020 2020 2020 2076 616c 7565 5f6c 6179         value_lay
+000019a0: 6572 203d 2073 656c 662e 7377 6170 6178  er = self.swapax
+000019b0: 6573 5f66 6f72 5f73 636f 7265 7328 7365  es_for_scores(se
+000019c0: 6c66 2e76 616c 7565 2865 6e63 6f64 6572  lf.value(encoder
+000019d0: 5f68 6964 6465 6e5f 7374 6174 6573 2929  _hidden_states))
+000019e0: 0a20 2020 2020 2020 2020 2020 2061 7474  .            att
+000019f0: 656e 7469 6f6e 5f6d 6173 6b20 3d20 656e  ention_mask = en
+00001a00: 636f 6465 725f 6174 7465 6e74 696f 6e5f  coder_attention_
+00001a10: 6d61 736b 0a20 2020 2020 2020 2065 6c69  mask.        eli
+00001a20: 6620 7061 7374 5f6b 6579 5f76 616c 7565  f past_key_value
+00001a30: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00001a40: 2020 2020 2020 2020 2020 6b65 795f 6c61            key_la
+00001a50: 7965 7220 3d20 7365 6c66 2e73 7761 7061  yer = self.swapa
+00001a60: 7865 735f 666f 725f 7363 6f72 6573 2873  xes_for_scores(s
+00001a70: 656c 662e 6b65 7928 6869 6464 656e 5f73  elf.key(hidden_s
+00001a80: 7461 7465 7329 290a 2020 2020 2020 2020  tates)).        
+00001a90: 2020 2020 7661 6c75 655f 6c61 7965 7220      value_layer 
+00001aa0: 3d20 7365 6c66 2e73 7761 7061 7865 735f  = self.swapaxes_
+00001ab0: 666f 725f 7363 6f72 6573 2873 656c 662e  for_scores(self.
+00001ac0: 7661 6c75 6528 6869 6464 656e 5f73 7461  value(hidden_sta
+00001ad0: 7465 7329 290a 2020 2020 2020 2020 2020  tes)).          
+00001ae0: 2020 6b65 795f 6c61 7965 7220 3d20 6f70    key_layer = op
+00001af0: 732e 6361 7428 5b70 6173 745f 6b65 795f  s.cat([past_key_
+00001b00: 7661 6c75 655b 305d 2c20 6b65 795f 6c61  value[0], key_la
+00001b10: 7965 725d 2c20 6178 6973 3d32 290a 2020  yer], axis=2).  
+00001b20: 2020 2020 2020 2020 2020 7661 6c75 655f            value_
+00001b30: 6c61 7965 7220 3d20 6f70 732e 6361 7428  layer = ops.cat(
+00001b40: 5b70 6173 745f 6b65 795f 7661 6c75 655b  [past_key_value[
+00001b50: 315d 2c20 7661 6c75 655f 6c61 7965 725d  1], value_layer]
+00001b60: 2c20 6178 6973 3d32 290a 2020 2020 2020  , axis=2).      
+00001b70: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00001b80: 2020 2020 6b65 795f 6c61 7965 7220 3d20      key_layer = 
+00001b90: 7365 6c66 2e73 7761 7061 7865 735f 666f  self.swapaxes_fo
+00001ba0: 725f 7363 6f72 6573 2873 656c 662e 6b65  r_scores(self.ke
+00001bb0: 7928 6869 6464 656e 5f73 7461 7465 7329  y(hidden_states)
+00001bc0: 290a 2020 2020 2020 2020 2020 2020 7661  ).            va
+00001bd0: 6c75 655f 6c61 7965 7220 3d20 7365 6c66  lue_layer = self
+00001be0: 2e73 7761 7061 7865 735f 666f 725f 7363  .swapaxes_for_sc
+00001bf0: 6f72 6573 2873 656c 662e 7661 6c75 6528  ores(self.value(
+00001c00: 6869 6464 656e 5f73 7461 7465 7329 290a  hidden_states)).
+00001c10: 0a20 2020 2020 2020 2071 7565 7279 5f6c  .        query_l
+00001c20: 6179 6572 203d 2073 656c 662e 7377 6170  ayer = self.swap
+00001c30: 6178 6573 5f66 6f72 5f73 636f 7265 7328  axes_for_scores(
+00001c40: 6d69 7865 645f 7175 6572 795f 6c61 7965  mixed_query_laye
+00001c50: 7229 0a0a 2020 2020 2020 2020 7061 7374  r)..        past
+00001c60: 5f6b 6579 5f76 616c 7565 203d 2028 6b65  _key_value = (ke
+00001c70: 795f 6c61 7965 722c 2076 616c 7565 5f6c  y_layer, value_l
+00001c80: 6179 6572 290a 0a20 2020 2020 2020 2023  ayer)..        #
+00001c90: 2054 616b 6520 7468 6520 646f 7420 7072   Take the dot pr
+00001ca0: 6f64 7563 7420 6265 7477 6565 6e20 2271  oduct between "q
+00001cb0: 7565 7279 2220 616e 6420 226b 6579 2220  uery" and "key" 
+00001cc0: 746f 2067 6574 2074 6865 2072 6177 2061  to get the raw a
+00001cd0: 7474 656e 7469 6f6e 2073 636f 7265 732e  ttention scores.
+00001ce0: 0a20 2020 2020 2020 2061 7474 656e 7469  .        attenti
+00001cf0: 6f6e 5f73 636f 7265 7320 3d20 6f70 732e  on_scores = ops.
+00001d00: 6d61 746d 756c 2871 7565 7279 5f6c 6179  matmul(query_lay
+00001d10: 6572 2c20 6b65 795f 6c61 7965 722e 7377  er, key_layer.sw
+00001d20: 6170 6178 6573 282d 312c 202d 3229 290a  apaxes(-1, -2)).
+00001d30: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+00001d40: 2e70 6f73 6974 696f 6e5f 656d 6265 6464  .position_embedd
+00001d50: 696e 675f 7479 7065 2069 6e20 2827 7265  ing_type in ('re
+00001d60: 6c61 7469 7665 5f6b 6579 272c 2027 7265  lative_key', 're
+00001d70: 6c61 7469 7665 5f6b 6579 5f71 7565 7279  lative_key_query
+00001d80: 2729 3a0a 2020 2020 2020 2020 2020 2020  '):.            
+00001d90: 7365 715f 6c65 6e67 7468 203d 2068 6964  seq_length = hid
+00001da0: 6465 6e5f 7374 6174 6573 2e73 6861 7065  den_states.shape
+00001db0: 5b31 5d0a 2020 2020 2020 2020 2020 2020  [1].            
+00001dc0: 706f 7369 7469 6f6e 5f69 6473 5f6c 203d  position_ids_l =
+00001dd0: 206f 7073 2e61 7261 6e67 6528 7365 715f   ops.arange(seq_
+00001de0: 6c65 6e67 7468 2c20 6474 7970 653d 6d69  length, dtype=mi
+00001df0: 6e64 7370 6f72 652e 696e 7436 3429 2e76  ndspore.int64).v
+00001e00: 6965 7728 2d31 2c20 3129 0a20 2020 2020  iew(-1, 1).     
+00001e10: 2020 2020 2020 2070 6f73 6974 696f 6e5f         position_
+00001e20: 6964 735f 7220 3d20 6f70 732e 6172 616e  ids_r = ops.aran
+00001e30: 6765 2873 6571 5f6c 656e 6774 682c 2064  ge(seq_length, d
+00001e40: 7479 7065 3d6d 696e 6473 706f 7265 2e69  type=mindspore.i
+00001e50: 6e74 3634 292e 7669 6577 2831 2c20 2d31  nt64).view(1, -1
+00001e60: 290a 2020 2020 2020 2020 2020 2020 6469  ).            di
+00001e70: 7374 616e 6365 203d 2070 6f73 6974 696f  stance = positio
+00001e80: 6e5f 6964 735f 6c20 2d20 706f 7369 7469  n_ids_l - positi
+00001e90: 6f6e 5f69 6473 5f72 0a20 2020 2020 2020  on_ids_r.       
+00001ea0: 2020 2020 2070 6f73 6974 696f 6e61 6c5f       positional_
+00001eb0: 656d 6265 6464 696e 6720 3d20 7365 6c66  embedding = self
+00001ec0: 2e64 6973 7461 6e63 655f 656d 6265 6464  .distance_embedd
+00001ed0: 696e 6728 6469 7374 616e 6365 202b 2073  ing(distance + s
+00001ee0: 656c 662e 6d61 785f 706f 7369 7469 6f6e  elf.max_position
+00001ef0: 5f65 6d62 6564 6469 6e67 7320 2d20 3129  _embeddings - 1)
+00001f00: 0a20 2020 2020 2020 2020 2020 2070 6f73  .            pos
+00001f10: 6974 696f 6e61 6c5f 656d 6265 6464 696e  itional_embeddin
+00001f20: 6720 3d20 706f 7369 7469 6f6e 616c 5f65  g = positional_e
+00001f30: 6d62 6564 6469 6e67 2e74 6f28 6474 7970  mbedding.to(dtyp
+00001f40: 653d 7175 6572 795f 6c61 7965 722e 6474  e=query_layer.dt
+00001f50: 7970 6529 2020 2320 6670 3136 2063 6f6d  ype)  # fp16 com
+00001f60: 7061 7469 6269 6c69 7479 0a0a 2020 2020  patibility..    
+00001f70: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00001f80: 706f 7369 7469 6f6e 5f65 6d62 6564 6469  position_embeddi
+00001f90: 6e67 5f74 7970 6520 3d3d 2022 7265 6c61  ng_type == "rela
+00001fa0: 7469 7665 5f6b 6579 223a 0a20 2020 2020  tive_key":.     
+00001fb0: 2020 2020 2020 2020 2020 2072 656c 6174             relat
+00001fc0: 6976 655f 706f 7369 7469 6f6e 5f73 636f  ive_position_sco
+00001fd0: 7265 7320 3d20 6f70 732e 6569 6e73 756d  res = ops.einsum
+00001fe0: 2822 6268 6c64 2c6c 7264 2d3e 6268 6c72  ("bhld,lrd->bhlr
+00001ff0: 222c 2071 7565 7279 5f6c 6179 6572 2c20  ", query_layer, 
+00002000: 706f 7369 7469 6f6e 616c 5f65 6d62 6564  positional_embed
+00002010: 6469 6e67 290a 2020 2020 2020 2020 2020  ding).          
+00002020: 2020 2020 2020 6174 7465 6e74 696f 6e5f        attention_
+00002030: 7363 6f72 6573 203d 2061 7474 656e 7469  scores = attenti
+00002040: 6f6e 5f73 636f 7265 7320 2b20 7265 6c61  on_scores + rela
+00002050: 7469 7665 5f70 6f73 6974 696f 6e5f 7363  tive_position_sc
+00002060: 6f72 6573 0a20 2020 2020 2020 2020 2020  ores.           
+00002070: 2065 6c69 6620 7365 6c66 2e70 6f73 6974   elif self.posit
+00002080: 696f 6e5f 656d 6265 6464 696e 675f 7479  ion_embedding_ty
+00002090: 7065 203d 3d20 2272 656c 6174 6976 655f  pe == "relative_
+000020a0: 6b65 795f 7175 6572 7922 3a0a 2020 2020  key_query":.    
+000020b0: 2020 2020 2020 2020 2020 2020 7265 6c61              rela
+000020c0: 7469 7665 5f70 6f73 6974 696f 6e5f 7363  tive_position_sc
+000020d0: 6f72 6573 5f71 7565 7279 203d 206f 7073  ores_query = ops
+000020e0: 2e65 696e 7375 6d28 2262 686c 642c 6c72  .einsum("bhld,lr
+000020f0: 642d 3e62 686c 7222 2c20 7175 6572 795f  d->bhlr", query_
+00002100: 6c61 7965 722c 2070 6f73 6974 696f 6e61  layer, positiona
+00002110: 6c5f 656d 6265 6464 696e 6729 0a20 2020  l_embedding).   
+00002120: 2020 2020 2020 2020 2020 2020 2072 656c               rel
+00002130: 6174 6976 655f 706f 7369 7469 6f6e 5f73  ative_position_s
+00002140: 636f 7265 735f 6b65 7920 3d20 6f70 732e  cores_key = ops.
+00002150: 6569 6e73 756d 2822 6268 7264 2c6c 7264  einsum("bhrd,lrd
+00002160: 2d3e 6268 6c72 222c 206b 6579 5f6c 6179  ->bhlr", key_lay
+00002170: 6572 2c20 706f 7369 7469 6f6e 616c 5f65  er, positional_e
+00002180: 6d62 6564 6469 6e67 290a 2020 2020 2020  mbedding).      
+00002190: 2020 2020 2020 2020 2020 6174 7465 6e74            attent
+000021a0: 696f 6e5f 7363 6f72 6573 203d 2061 7474  ion_scores = att
+000021b0: 656e 7469 6f6e 5f73 636f 7265 7320 2b20  ention_scores + 
+000021c0: 7265 6c61 7469 7665 5f70 6f73 6974 696f  relative_positio
+000021d0: 6e5f 7363 6f72 6573 5f71 7565 7279 202b  n_scores_query +
+000021e0: 2072 656c 6174 6976 655f 706f 7369 7469   relative_positi
+000021f0: 6f6e 5f73 636f 7265 735f 6b65 790a 0a20  on_scores_key.. 
+00002200: 2020 2020 2020 2061 7474 656e 7469 6f6e         attention
+00002210: 5f73 636f 7265 7320 3d20 6174 7465 6e74  _scores = attent
+00002220: 696f 6e5f 7363 6f72 6573 202f 206d 6174  ion_scores / mat
+00002230: 682e 7371 7274 2873 656c 662e 6174 7465  h.sqrt(self.atte
+00002240: 6e74 696f 6e5f 6865 6164 5f73 697a 6529  ntion_head_size)
+00002250: 0a20 2020 2020 2020 2069 6620 6174 7465  .        if atte
+00002260: 6e74 696f 6e5f 6d61 736b 2069 7320 6e6f  ntion_mask is no
+00002270: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00002280: 2020 2020 2320 4170 706c 7920 7468 6520      # Apply the 
+00002290: 6174 7465 6e74 696f 6e20 6d61 736b 2069  attention mask i
+000022a0: 7320 2870 7265 636f 6d70 7574 6564 2066  s (precomputed f
+000022b0: 6f72 2061 6c6c 206c 6179 6572 7320 696e  or all layers in
+000022c0: 2042 6c69 7054 6578 744d 6f64 656c 2066   BlipTextModel f
+000022d0: 6f72 7761 7264 2829 2066 756e 6374 696f  orward() functio
+000022e0: 6e29 0a20 2020 2020 2020 2020 2020 2061  n).            a
+000022f0: 7474 656e 7469 6f6e 5f73 636f 7265 7320  ttention_scores 
+00002300: 3d20 6174 7465 6e74 696f 6e5f 7363 6f72  = attention_scor
+00002310: 6573 202b 2061 7474 656e 7469 6f6e 5f6d  es + attention_m
+00002320: 6173 6b0a 0a20 2020 2020 2020 2023 204e  ask..        # N
+00002330: 6f72 6d61 6c69 7a65 2074 6865 2061 7474  ormalize the att
+00002340: 656e 7469 6f6e 2073 636f 7265 7320 746f  ention scores to
+00002350: 2070 726f 6261 6269 6c69 7469 6573 2e0a   probabilities..
+00002360: 2020 2020 2020 2020 6174 7465 6e74 696f          attentio
+00002370: 6e5f 7072 6f62 7320 3d20 6f70 732e 736f  n_probs = ops.so
+00002380: 6674 6d61 7828 6174 7465 6e74 696f 6e5f  ftmax(attention_
+00002390: 7363 6f72 6573 2c20 6178 6973 3d2d 3129  scores, axis=-1)
+000023a0: 0a0a 2020 2020 2020 2020 2320 5468 6973  ..        # This
+000023b0: 2069 7320 6163 7475 616c 6c79 2064 726f   is actually dro
+000023c0: 7070 696e 6720 6f75 7420 656e 7469 7265  pping out entire
+000023d0: 2074 6f6b 656e 7320 746f 2061 7474 656e   tokens to atten
+000023e0: 6420 746f 2c20 7768 6963 6820 6d69 6768  d to, which migh
+000023f0: 740a 2020 2020 2020 2020 2320 7365 656d  t.        # seem
+00002400: 2061 2062 6974 2075 6e75 7375 616c 2c20   a bit unusual, 
+00002410: 6275 7420 6973 2074 616b 656e 2066 726f  but is taken fro
+00002420: 6d20 7468 6520 6f72 6967 696e 616c 2054  m the original T
+00002430: 7261 6e73 666f 726d 6572 2070 6170 6572  ransformer paper
+00002440: 2e0a 2020 2020 2020 2020 6174 7465 6e74  ..        attent
+00002450: 696f 6e5f 7072 6f62 735f 6472 6f70 7065  ion_probs_droppe
+00002460: 6420 3d20 7365 6c66 2e64 726f 706f 7574  d = self.dropout
+00002470: 2861 7474 656e 7469 6f6e 5f70 726f 6273  (attention_probs
+00002480: 290a 0a20 2020 2020 2020 2023 204d 6173  )..        # Mas
+00002490: 6b20 6865 6164 7320 6966 2077 6520 7761  k heads if we wa
+000024a0: 6e74 2074 6f0a 2020 2020 2020 2020 6966  nt to.        if
+000024b0: 2068 6561 645f 6d61 736b 2069 7320 6e6f   head_mask is no
+000024c0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+000024d0: 2020 2020 6174 7465 6e74 696f 6e5f 7072      attention_pr
+000024e0: 6f62 735f 6472 6f70 7065 6420 3d20 6174  obs_dropped = at
+000024f0: 7465 6e74 696f 6e5f 7072 6f62 735f 6472  tention_probs_dr
+00002500: 6f70 7065 6420 2a20 6865 6164 5f6d 6173  opped * head_mas
+00002510: 6b0a 0a20 2020 2020 2020 2063 6f6e 7465  k..        conte
+00002520: 7874 5f6c 6179 6572 203d 206f 7073 2e6d  xt_layer = ops.m
+00002530: 6174 6d75 6c28 6174 7465 6e74 696f 6e5f  atmul(attention_
+00002540: 7072 6f62 735f 6472 6f70 7065 642c 2076  probs_dropped, v
+00002550: 616c 7565 5f6c 6179 6572 290a 0a20 2020  alue_layer)..   
+00002560: 2020 2020 2063 6f6e 7465 7874 5f6c 6179       context_lay
+00002570: 6572 203d 2063 6f6e 7465 7874 5f6c 6179  er = context_lay
+00002580: 6572 2e70 6572 6d75 7465 2830 2c20 322c  er.permute(0, 2,
+00002590: 2031 2c20 3329 0a20 2020 2020 2020 206e   1, 3).        n
+000025a0: 6577 5f63 6f6e 7465 7874 5f6c 6179 6572  ew_context_layer
+000025b0: 5f73 6861 7065 203d 2063 6f6e 7465 7874  _shape = context
+000025c0: 5f6c 6179 6572 2e73 6861 7065 5b3a 2d32  _layer.shape[:-2
+000025d0: 5d20 2b20 2873 656c 662e 616c 6c5f 6865  ] + (self.all_he
+000025e0: 6164 5f73 697a 652c 290a 2020 2020 2020  ad_size,).      
+000025f0: 2020 636f 6e74 6578 745f 6c61 7965 7220    context_layer 
+00002600: 3d20 636f 6e74 6578 745f 6c61 7965 722e  = context_layer.
+00002610: 7669 6577 282a 6e65 775f 636f 6e74 6578  view(*new_contex
+00002620: 745f 6c61 7965 725f 7368 6170 6529 0a0a  t_layer_shape)..
+00002630: 2020 2020 2020 2020 6f75 7470 7574 7320          outputs 
+00002640: 3d20 2863 6f6e 7465 7874 5f6c 6179 6572  = (context_layer
+00002650: 2c20 6174 7465 6e74 696f 6e5f 7072 6f62  , attention_prob
+00002660: 7329 2069 6620 6f75 7470 7574 5f61 7474  s) if output_att
+00002670: 656e 7469 6f6e 7320 656c 7365 2028 636f  entions else (co
+00002680: 6e74 6578 745f 6c61 7965 722c 290a 0a20  ntext_layer,).. 
+00002690: 2020 2020 2020 206f 7574 7075 7473 203d         outputs =
+000026a0: 206f 7574 7075 7473 202b 2028 7061 7374   outputs + (past
+000026b0: 5f6b 6579 5f76 616c 7565 2c29 0a20 2020  _key_value,).   
+000026c0: 2020 2020 2072 6574 7572 6e20 6f75 7470       return outp
+000026d0: 7574 730a 0a0a 2320 436f 7069 6564 2066  uts...# Copied f
+000026e0: 726f 6d20 7472 616e 7366 6f72 6d65 7273  rom transformers
+000026f0: 2e6d 6f64 656c 732e 6265 7274 2e6d 6f64  .models.bert.mod
+00002700: 656c 696e 675f 6265 7274 2e42 6572 7453  eling_bert.BertS
+00002710: 656c 664f 7574 7075 7420 7769 7468 2042  elfOutput with B
+00002720: 6572 7420 2d3e 2042 6c69 7054 6578 740a  ert -> BlipText.
+00002730: 636c 6173 7320 426c 6970 5465 7874 5365  class BlipTextSe
+00002740: 6c66 4f75 7470 7574 286e 6e2e 4365 6c6c  lfOutput(nn.Cell
+00002750: 293a 0a20 2020 2064 6566 205f 5f69 6e69  ):.    def __ini
+00002760: 745f 5f28 7365 6c66 2c20 636f 6e66 6967  t__(self, config
+00002770: 293a 0a20 2020 2020 2020 2073 7570 6572  ):.        super
+00002780: 2829 2e5f 5f69 6e69 745f 5f28 290a 2020  ().__init__().  
+00002790: 2020 2020 2020 7365 6c66 2e64 656e 7365        self.dense
+000027a0: 203d 206e 6e2e 4465 6e73 6528 636f 6e66   = nn.Dense(conf
+000027b0: 6967 2e68 6964 6465 6e5f 7369 7a65 2c20  ig.hidden_size, 
+000027c0: 636f 6e66 6967 2e68 6964 6465 6e5f 7369  config.hidden_si
+000027d0: 7a65 290a 2020 2020 2020 2020 7365 6c66  ze).        self
+000027e0: 2e4c 6179 6572 4e6f 726d 203d 206e 6e2e  .LayerNorm = nn.
+000027f0: 4c61 7965 724e 6f72 6d28 636f 6e66 6967  LayerNorm(config
+00002800: 2e68 6964 6465 6e5f 7369 7a65 2c20 6570  .hidden_size, ep
+00002810: 7369 6c6f 6e3d 636f 6e66 6967 2e6c 6179  silon=config.lay
+00002820: 6572 5f6e 6f72 6d5f 6570 7329 0a20 2020  er_norm_eps).   
+00002830: 2020 2020 2073 656c 662e 6472 6f70 6f75       self.dropou
+00002840: 7420 3d20 6e6e 2e44 726f 706f 7574 2870  t = nn.Dropout(p
+00002850: 3d63 6f6e 6669 672e 6869 6464 656e 5f64  =config.hidden_d
+00002860: 726f 706f 7574 5f70 726f 6229 0a0a 2020  ropout_prob)..  
+00002870: 2020 6465 6620 636f 6e73 7472 7563 7428    def construct(
+00002880: 7365 6c66 2c20 6869 6464 656e 5f73 7461  self, hidden_sta
+00002890: 7465 733a 206d 696e 6473 706f 7265 2e54  tes: mindspore.T
+000028a0: 656e 736f 722c 2069 6e70 7574 5f74 656e  ensor, input_ten
+000028b0: 736f 723a 206d 696e 6473 706f 7265 2e54  sor: mindspore.T
+000028c0: 656e 736f 7229 202d 3e20 6d69 6e64 7370  ensor) -> mindsp
+000028d0: 6f72 652e 5465 6e73 6f72 3a0a 2020 2020  ore.Tensor:.    
+000028e0: 2020 2020 6869 6464 656e 5f73 7461 7465      hidden_state
+000028f0: 7320 3d20 7365 6c66 2e64 656e 7365 2868  s = self.dense(h
+00002900: 6964 6465 6e5f 7374 6174 6573 290a 2020  idden_states).  
+00002910: 2020 2020 2020 6869 6464 656e 5f73 7461        hidden_sta
+00002920: 7465 7320 3d20 7365 6c66 2e64 726f 706f  tes = self.dropo
+00002930: 7574 2868 6964 6465 6e5f 7374 6174 6573  ut(hidden_states
+00002940: 290a 2020 2020 2020 2020 6869 6464 656e  ).        hidden
+00002950: 5f73 7461 7465 7320 3d20 7365 6c66 2e4c  _states = self.L
+00002960: 6179 6572 4e6f 726d 2868 6964 6465 6e5f  ayerNorm(hidden_
+00002970: 7374 6174 6573 202b 2069 6e70 7574 5f74  states + input_t
+00002980: 656e 736f 7229 0a20 2020 2020 2020 2072  ensor).        r
+00002990: 6574 7572 6e20 6869 6464 656e 5f73 7461  eturn hidden_sta
+000029a0: 7465 730a 0a0a 2320 4164 6170 7465 6420  tes...# Adapted 
+000029b0: 6672 6f6d 2068 7474 7073 3a2f 2f67 6974  from https://git
+000029c0: 6875 622e 636f 6d2f 7361 6c65 7366 6f72  hub.com/salesfor
+000029d0: 6365 2f42 4c49 502f 626c 6f62 2f6d 6169  ce/BLIP/blob/mai
+000029e0: 6e2f 6d6f 6465 6c73 2f6d 6564 2e70 7923  n/models/med.py#
+000029f0: 3234 320a 636c 6173 7320 426c 6970 5465  242.class BlipTe
+00002a00: 7874 4174 7465 6e74 696f 6e28 6e6e 2e43  xtAttention(nn.C
+00002a10: 656c 6c29 3a0a 2020 2020 6465 6620 5f5f  ell):.    def __
+00002a20: 696e 6974 5f5f 2873 656c 662c 2063 6f6e  init__(self, con
+00002a30: 6669 672c 2069 735f 6372 6f73 735f 6174  fig, is_cross_at
+00002a40: 7465 6e74 696f 6e3d 4661 6c73 6529 3a0a  tention=False):.
+00002a50: 2020 2020 2020 2020 7375 7065 7228 292e          super().
+00002a60: 5f5f 696e 6974 5f5f 2829 0a20 2020 2020  __init__().     
+00002a70: 2020 2073 656c 662e 7365 6c66 203d 2042     self.self = B
+00002a80: 6c69 7054 6578 7453 656c 6641 7474 656e  lipTextSelfAtten
+00002a90: 7469 6f6e 2863 6f6e 6669 672c 2069 735f  tion(config, is_
+00002aa0: 6372 6f73 735f 6174 7465 6e74 696f 6e29  cross_attention)
+00002ab0: 0a20 2020 2020 2020 2073 656c 662e 6f75  .        self.ou
+00002ac0: 7470 7574 203d 2042 6c69 7054 6578 7453  tput = BlipTextS
+00002ad0: 656c 664f 7574 7075 7428 636f 6e66 6967  elfOutput(config
+00002ae0: 290a 2020 2020 2020 2020 7365 6c66 2e70  ).        self.p
+00002af0: 7275 6e65 645f 6865 6164 7320 3d20 7365  runed_heads = se
+00002b00: 7428 290a 0a20 2020 2064 6566 2070 7275  t()..    def pru
+00002b10: 6e65 5f68 6561 6473 2873 656c 662c 2068  ne_heads(self, h
+00002b20: 6561 6473 293a 0a20 2020 2020 2020 2069  eads):.        i
+00002b30: 6620 6c65 6e28 6865 6164 7329 203d 3d20  f len(heads) == 
+00002b40: 303a 0a20 2020 2020 2020 2020 2020 2072  0:.            r
+00002b50: 6574 7572 6e0a 2020 2020 2020 2020 6865  eturn.        he
+00002b60: 6164 732c 2069 6e64 6578 203d 2066 696e  ads, index = fin
+00002b70: 645f 7072 756e 6561 626c 655f 6865 6164  d_pruneable_head
+00002b80: 735f 616e 645f 696e 6469 6365 7328 0a20  s_and_indices(. 
+00002b90: 2020 2020 2020 2020 2020 2068 6561 6473             heads
+00002ba0: 2c20 7365 6c66 2e73 656c 662e 6e75 6d5f  , self.self.num_
+00002bb0: 6174 7465 6e74 696f 6e5f 6865 6164 732c  attention_heads,
+00002bc0: 2073 656c 662e 7365 6c66 2e61 7474 656e   self.self.atten
+00002bd0: 7469 6f6e 5f68 6561 645f 7369 7a65 2c20  tion_head_size, 
+00002be0: 7365 6c66 2e70 7275 6e65 645f 6865 6164  self.pruned_head
+00002bf0: 730a 2020 2020 2020 2020 290a 0a20 2020  s.        )..   
+00002c00: 2020 2020 2023 2050 7275 6e65 206c 696e       # Prune lin
+00002c10: 6561 7220 6c61 7965 7273 0a20 2020 2020  ear layers.     
+00002c20: 2020 2073 656c 662e 7365 6c66 2e71 7565     self.self.que
+00002c30: 7279 203d 2070 7275 6e65 5f6c 696e 6561  ry = prune_linea
+00002c40: 725f 6c61 7965 7228 7365 6c66 2e73 656c  r_layer(self.sel
+00002c50: 662e 7175 6572 792c 2069 6e64 6578 290a  f.query, index).
+00002c60: 2020 2020 2020 2020 7365 6c66 2e73 656c          self.sel
+00002c70: 662e 6b65 7920 3d20 7072 756e 655f 6c69  f.key = prune_li
+00002c80: 6e65 6172 5f6c 6179 6572 2873 656c 662e  near_layer(self.
+00002c90: 7365 6c66 2e6b 6579 2c20 696e 6465 7829  self.key, index)
+00002ca0: 0a20 2020 2020 2020 2073 656c 662e 7365  .        self.se
+00002cb0: 6c66 2e76 616c 7565 203d 2070 7275 6e65  lf.value = prune
+00002cc0: 5f6c 696e 6561 725f 6c61 7965 7228 7365  _linear_layer(se
+00002cd0: 6c66 2e73 656c 662e 7661 6c75 652c 2069  lf.self.value, i
+00002ce0: 6e64 6578 290a 2020 2020 2020 2020 7365  ndex).        se
+00002cf0: 6c66 2e6f 7574 7075 742e 6465 6e73 6520  lf.output.dense 
+00002d00: 3d20 7072 756e 655f 6c69 6e65 6172 5f6c  = prune_linear_l
+00002d10: 6179 6572 2873 656c 662e 6f75 7470 7574  ayer(self.output
+00002d20: 2e64 656e 7365 2c20 696e 6465 782c 2061  .dense, index, a
+00002d30: 7869 733d 3129 0a0a 2020 2020 2020 2020  xis=1)..        
+00002d40: 2320 5570 6461 7465 2068 7970 6572 2070  # Update hyper p
+00002d50: 6172 616d 7320 616e 6420 7374 6f72 6520  arams and store 
+00002d60: 7072 756e 6564 2068 6561 6473 0a20 2020  pruned heads.   
+00002d70: 2020 2020 2073 656c 662e 7365 6c66 2e6e       self.self.n
+00002d80: 756d 5f61 7474 656e 7469 6f6e 5f68 6561  um_attention_hea
+00002d90: 6473 203d 2073 656c 662e 7365 6c66 2e6e  ds = self.self.n
+00002da0: 756d 5f61 7474 656e 7469 6f6e 5f68 6561  um_attention_hea
+00002db0: 6473 202d 206c 656e 2868 6561 6473 290a  ds - len(heads).
+00002dc0: 2020 2020 2020 2020 7365 6c66 2e73 656c          self.sel
+00002dd0: 662e 616c 6c5f 6865 6164 5f73 697a 6520  f.all_head_size 
+00002de0: 3d20 7365 6c66 2e73 656c 662e 6174 7465  = self.self.atte
+00002df0: 6e74 696f 6e5f 6865 6164 5f73 697a 6520  ntion_head_size 
+00002e00: 2a20 7365 6c66 2e73 656c 662e 6e75 6d5f  * self.self.num_
+00002e10: 6174 7465 6e74 696f 6e5f 6865 6164 730a  attention_heads.
+00002e20: 2020 2020 2020 2020 7365 6c66 2e70 7275          self.pru
+00002e30: 6e65 645f 6865 6164 7320 3d20 7365 6c66  ned_heads = self
+00002e40: 2e70 7275 6e65 645f 6865 6164 732e 756e  .pruned_heads.un
+00002e50: 696f 6e28 6865 6164 7329 0a0a 2020 2020  ion(heads)..    
+00002e60: 6465 6620 636f 6e73 7472 7563 7428 0a20  def construct(. 
+00002e70: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+00002e80: 2020 2020 2068 6964 6465 6e5f 7374 6174       hidden_stat
+00002e90: 6573 3a20 6d69 6e64 7370 6f72 652e 5465  es: mindspore.Te
+00002ea0: 6e73 6f72 2c0a 2020 2020 2020 2020 6174  nsor,.        at
+00002eb0: 7465 6e74 696f 6e5f 6d61 736b 3a20 4f70  tention_mask: Op
+00002ec0: 7469 6f6e 616c 5b6d 696e 6473 706f 7265  tional[mindspore
+00002ed0: 2e54 656e 736f 725d 203d 204e 6f6e 652c  .Tensor] = None,
+00002ee0: 0a20 2020 2020 2020 2068 6561 645f 6d61  .        head_ma
+00002ef0: 736b 3a20 4f70 7469 6f6e 616c 5b6d 696e  sk: Optional[min
+00002f00: 6473 706f 7265 2e54 656e 736f 725d 203d  dspore.Tensor] =
+00002f10: 204e 6f6e 652c 0a20 2020 2020 2020 2065   None,.        e
+00002f20: 6e63 6f64 6572 5f68 6964 6465 6e5f 7374  ncoder_hidden_st
+00002f30: 6174 6573 3a20 4f70 7469 6f6e 616c 5b6d  ates: Optional[m
+00002f40: 696e 6473 706f 7265 2e54 656e 736f 725d  indspore.Tensor]
+00002f50: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00002f60: 2065 6e63 6f64 6572 5f61 7474 656e 7469   encoder_attenti
+00002f70: 6f6e 5f6d 6173 6b3a 204f 7074 696f 6e61  on_mask: Optiona
+00002f80: 6c5b 6d69 6e64 7370 6f72 652e 5465 6e73  l[mindspore.Tens
+00002f90: 6f72 5d20 3d20 4e6f 6e65 2c0a 2020 2020  or] = None,.    
+00002fa0: 2020 2020 7061 7374 5f6b 6579 5f76 616c      past_key_val
+00002fb0: 7565 3a20 4f70 7469 6f6e 616c 5b54 7570  ue: Optional[Tup
+00002fc0: 6c65 5b54 7570 6c65 5b6d 696e 6473 706f  le[Tuple[mindspo
+00002fd0: 7265 2e54 656e 736f 725d 5d5d 203d 204e  re.Tensor]]] = N
+00002fe0: 6f6e 652c 0a20 2020 2020 2020 206f 7574  one,.        out
+00002ff0: 7075 745f 6174 7465 6e74 696f 6e73 3a20  put_attentions: 
+00003000: 4f70 7469 6f6e 616c 5b62 6f6f 6c5d 203d  Optional[bool] =
+00003010: 2046 616c 7365 2c0a 2020 2020 2920 2d3e   False,.    ) ->
+00003020: 2054 7570 6c65 5b6d 696e 6473 706f 7265   Tuple[mindspore
+00003030: 2e54 656e 736f 725d 3a0a 2020 2020 2020  .Tensor]:.      
+00003040: 2020 7365 6c66 5f6f 7574 7075 7473 203d    self_outputs =
+00003050: 2073 656c 662e 7365 6c66 280a 2020 2020   self.self(.    
+00003060: 2020 2020 2020 2020 6869 6464 656e 5f73          hidden_s
+00003070: 7461 7465 732c 0a20 2020 2020 2020 2020  tates,.         
+00003080: 2020 2061 7474 656e 7469 6f6e 5f6d 6173     attention_mas
+00003090: 6b2c 0a20 2020 2020 2020 2020 2020 2068  k,.            h
+000030a0: 6561 645f 6d61 736b 2c0a 2020 2020 2020  ead_mask,.      
+000030b0: 2020 2020 2020 656e 636f 6465 725f 6869        encoder_hi
+000030c0: 6464 656e 5f73 7461 7465 732c 0a20 2020  dden_states,.   
+000030d0: 2020 2020 2020 2020 2065 6e63 6f64 6572           encoder
+000030e0: 5f61 7474 656e 7469 6f6e 5f6d 6173 6b2c  _attention_mask,
+000030f0: 0a20 2020 2020 2020 2020 2020 2070 6173  .            pas
+00003100: 745f 6b65 795f 7661 6c75 652c 0a20 2020  t_key_value,.   
+00003110: 2020 2020 2020 2020 206f 7574 7075 745f           output_
+00003120: 6174 7465 6e74 696f 6e73 2c0a 2020 2020  attentions,.    
+00003130: 2020 2020 290a 2020 2020 2020 2020 6174      ).        at
+00003140: 7465 6e74 696f 6e5f 6f75 7470 7574 203d  tention_output =
+00003150: 2073 656c 662e 6f75 7470 7574 2873 656c   self.output(sel
+00003160: 665f 6f75 7470 7574 735b 305d 2c20 6869  f_outputs[0], hi
+00003170: 6464 656e 5f73 7461 7465 7329 0a20 2020  dden_states).   
+00003180: 2020 2020 206f 7574 7075 7473 203d 2028       outputs = (
+00003190: 6174 7465 6e74 696f 6e5f 6f75 7470 7574  attention_output
+000031a0: 2c29 202b 2073 656c 665f 6f75 7470 7574  ,) + self_output
+000031b0: 735b 313a 5d20 2023 2061 6464 2061 7474  s[1:]  # add att
+000031c0: 656e 7469 6f6e 7320 6966 2077 6520 6f75  entions if we ou
+000031d0: 7470 7574 2074 6865 6d0a 2020 2020 2020  tput them.      
+000031e0: 2020 7265 7475 726e 206f 7574 7075 7473    return outputs
+000031f0: 0a0a 0a23 2043 6f70 6965 6420 6672 6f6d  ...# Copied from
+00003200: 2074 7261 6e73 666f 726d 6572 732e 6d6f   transformers.mo
+00003210: 6465 6c73 2e62 6572 742e 6d6f 6465 6c69  dels.bert.modeli
+00003220: 6e67 5f62 6572 742e 4265 7274 496e 7465  ng_bert.BertInte
+00003230: 726d 6564 6961 7465 2077 6974 6820 4265  rmediate with Be
+00003240: 7274 202d 3e20 426c 6970 5465 7874 0a63  rt -> BlipText.c
+00003250: 6c61 7373 2042 6c69 7054 6578 7449 6e74  lass BlipTextInt
+00003260: 6572 6d65 6469 6174 6528 6e6e 2e43 656c  ermediate(nn.Cel
+00003270: 6c29 3a0a 2020 2020 6465 6620 5f5f 696e  l):.    def __in
+00003280: 6974 5f5f 2873 656c 662c 2063 6f6e 6669  it__(self, confi
+00003290: 6729 3a0a 2020 2020 2020 2020 7375 7065  g):.        supe
+000032a0: 7228 292e 5f5f 696e 6974 5f5f 2829 0a20  r().__init__(). 
+000032b0: 2020 2020 2020 2073 656c 662e 6465 6e73         self.dens
+000032c0: 6520 3d20 6e6e 2e44 656e 7365 2863 6f6e  e = nn.Dense(con
+000032d0: 6669 672e 6869 6464 656e 5f73 697a 652c  fig.hidden_size,
+000032e0: 2063 6f6e 6669 672e 696e 7465 726d 6564   config.intermed
+000032f0: 6961 7465 5f73 697a 6529 0a20 2020 2020  iate_size).     
+00003300: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+00003310: 2863 6f6e 6669 672e 6869 6464 656e 5f61  (config.hidden_a
+00003320: 6374 2c20 7374 7229 3a0a 2020 2020 2020  ct, str):.      
+00003330: 2020 2020 2020 7365 6c66 2e69 6e74 6572        self.inter
+00003340: 6d65 6469 6174 655f 6163 745f 666e 203d  mediate_act_fn =
+00003350: 2041 4354 3246 4e5b 636f 6e66 6967 2e68   ACT2FN[config.h
+00003360: 6964 6465 6e5f 6163 745d 0a20 2020 2020  idden_act].     
+00003370: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00003380: 2020 2020 2073 656c 662e 696e 7465 726d       self.interm
+00003390: 6564 6961 7465 5f61 6374 5f66 6e20 3d20  ediate_act_fn = 
+000033a0: 636f 6e66 6967 2e68 6964 6465 6e5f 6163  config.hidden_ac
+000033b0: 740a 0a20 2020 2064 6566 2063 6f6e 7374  t..    def const
+000033c0: 7275 6374 2873 656c 662c 2068 6964 6465  ruct(self, hidde
+000033d0: 6e5f 7374 6174 6573 3a20 6d69 6e64 7370  n_states: mindsp
+000033e0: 6f72 652e 5465 6e73 6f72 2920 2d3e 206d  ore.Tensor) -> m
+000033f0: 696e 6473 706f 7265 2e54 656e 736f 723a  indspore.Tensor:
+00003400: 0a20 2020 2020 2020 2068 6964 6465 6e5f  .        hidden_
+00003410: 7374 6174 6573 203d 2073 656c 662e 6465  states = self.de
+00003420: 6e73 6528 6869 6464 656e 5f73 7461 7465  nse(hidden_state
+00003430: 7329 0a20 2020 2020 2020 2068 6964 6465  s).        hidde
+00003440: 6e5f 7374 6174 6573 203d 2073 656c 662e  n_states = self.
+00003450: 696e 7465 726d 6564 6961 7465 5f61 6374  intermediate_act
+00003460: 5f66 6e28 6869 6464 656e 5f73 7461 7465  _fn(hidden_state
+00003470: 7329 0a20 2020 2020 2020 2072 6574 7572  s).        retur
+00003480: 6e20 6869 6464 656e 5f73 7461 7465 730a  n hidden_states.
+00003490: 0a0a 2320 436f 7069 6564 2066 726f 6d20  ..# Copied from 
+000034a0: 7472 616e 7366 6f72 6d65 7273 2e6d 6f64  transformers.mod
+000034b0: 656c 732e 6265 7274 2e6d 6f64 656c 696e  els.bert.modelin
+000034c0: 675f 6265 7274 2e42 6572 744f 7574 7075  g_bert.BertOutpu
+000034d0: 7420 7769 7468 2042 6572 7420 2d3e 2042  t with Bert -> B
+000034e0: 6c69 7054 6578 740a 636c 6173 7320 426c  lipText.class Bl
+000034f0: 6970 5465 7874 4f75 7470 7574 286e 6e2e  ipTextOutput(nn.
+00003500: 4365 6c6c 293a 0a20 2020 2064 6566 205f  Cell):.    def _
+00003510: 5f69 6e69 745f 5f28 7365 6c66 2c20 636f  _init__(self, co
+00003520: 6e66 6967 293a 0a20 2020 2020 2020 2073  nfig):.        s
+00003530: 7570 6572 2829 2e5f 5f69 6e69 745f 5f28  uper().__init__(
+00003540: 290a 2020 2020 2020 2020 7365 6c66 2e64  ).        self.d
+00003550: 656e 7365 203d 206e 6e2e 4465 6e73 6528  ense = nn.Dense(
+00003560: 636f 6e66 6967 2e69 6e74 6572 6d65 6469  config.intermedi
+00003570: 6174 655f 7369 7a65 2c20 636f 6e66 6967  ate_size, config
+00003580: 2e68 6964 6465 6e5f 7369 7a65 290a 2020  .hidden_size).  
+00003590: 2020 2020 2020 7365 6c66 2e4c 6179 6572        self.Layer
+000035a0: 4e6f 726d 203d 206e 6e2e 4c61 7965 724e  Norm = nn.LayerN
+000035b0: 6f72 6d28 636f 6e66 6967 2e68 6964 6465  orm(config.hidde
+000035c0: 6e5f 7369 7a65 2c20 6570 7369 6c6f 6e3d  n_size, epsilon=
+000035d0: 636f 6e66 6967 2e6c 6179 6572 5f6e 6f72  config.layer_nor
+000035e0: 6d5f 6570 7329 0a20 2020 2020 2020 2073  m_eps).        s
+000035f0: 656c 662e 6472 6f70 6f75 7420 3d20 6e6e  elf.dropout = nn
+00003600: 2e44 726f 706f 7574 2870 3d63 6f6e 6669  .Dropout(p=confi
+00003610: 672e 6869 6464 656e 5f64 726f 706f 7574  g.hidden_dropout
+00003620: 5f70 726f 6229 0a0a 2020 2020 6465 6620  _prob)..    def 
+00003630: 636f 6e73 7472 7563 7428 7365 6c66 2c20  construct(self, 
+00003640: 6869 6464 656e 5f73 7461 7465 733a 206d  hidden_states: m
+00003650: 696e 6473 706f 7265 2e54 656e 736f 722c  indspore.Tensor,
+00003660: 2069 6e70 7574 5f74 656e 736f 723a 206d   input_tensor: m
+00003670: 696e 6473 706f 7265 2e54 656e 736f 7229  indspore.Tensor)
+00003680: 202d 3e20 6d69 6e64 7370 6f72 652e 5465   -> mindspore.Te
+00003690: 6e73 6f72 3a0a 2020 2020 2020 2020 6869  nsor:.        hi
+000036a0: 6464 656e 5f73 7461 7465 7320 3d20 7365  dden_states = se
+000036b0: 6c66 2e64 656e 7365 2868 6964 6465 6e5f  lf.dense(hidden_
+000036c0: 7374 6174 6573 290a 2020 2020 2020 2020  states).        
+000036d0: 6869 6464 656e 5f73 7461 7465 7320 3d20  hidden_states = 
+000036e0: 7365 6c66 2e64 726f 706f 7574 2868 6964  self.dropout(hid
+000036f0: 6465 6e5f 7374 6174 6573 290a 2020 2020  den_states).    
+00003700: 2020 2020 6869 6464 656e 5f73 7461 7465      hidden_state
+00003710: 7320 3d20 7365 6c66 2e4c 6179 6572 4e6f  s = self.LayerNo
+00003720: 726d 2868 6964 6465 6e5f 7374 6174 6573  rm(hidden_states
+00003730: 202b 2069 6e70 7574 5f74 656e 736f 7229   + input_tensor)
+00003740: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00003750: 6869 6464 656e 5f73 7461 7465 730a 0a0a  hidden_states...
+00003760: 636c 6173 7320 426c 6970 5465 7874 4c61  class BlipTextLa
+00003770: 7965 7228 6e6e 2e43 656c 6c29 3a0a 2020  yer(nn.Cell):.  
+00003780: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
+00003790: 656c 662c 2063 6f6e 6669 672c 206c 6179  elf, config, lay
+000037a0: 6572 5f6e 756d 293a 0a20 2020 2020 2020  er_num):.       
+000037b0: 2073 7570 6572 2829 2e5f 5f69 6e69 745f   super().__init_
+000037c0: 5f28 290a 2020 2020 2020 2020 7365 6c66  _().        self
+000037d0: 2e63 6f6e 6669 6720 3d20 636f 6e66 6967  .config = config
+000037e0: 0a20 2020 2020 2020 2073 656c 662e 6368  .        self.ch
+000037f0: 756e 6b5f 7369 7a65 5f66 6565 645f 666f  unk_size_feed_fo
+00003800: 7277 6172 6420 3d20 636f 6e66 6967 2e63  rward = config.c
+00003810: 6875 6e6b 5f73 697a 655f 6665 6564 5f66  hunk_size_feed_f
+00003820: 6f72 7761 7264 0a20 2020 2020 2020 2073  orward.        s
+00003830: 656c 662e 7365 715f 6c65 6e5f 6469 6d20  elf.seq_len_dim 
+00003840: 3d20 310a 2020 2020 2020 2020 7365 6c66  = 1.        self
+00003850: 2e61 7474 656e 7469 6f6e 203d 2042 6c69  .attention = Bli
+00003860: 7054 6578 7441 7474 656e 7469 6f6e 2863  pTextAttention(c
+00003870: 6f6e 6669 6729 0a20 2020 2020 2020 2073  onfig).        s
+00003880: 656c 662e 6c61 7965 725f 6e75 6d20 3d20  elf.layer_num = 
+00003890: 6c61 7965 725f 6e75 6d0a 2020 2020 2020  layer_num.      
+000038a0: 2020 6966 2073 656c 662e 636f 6e66 6967    if self.config
+000038b0: 2e69 735f 6465 636f 6465 723a 0a20 2020  .is_decoder:.   
+000038c0: 2020 2020 2020 2020 2073 656c 662e 6372           self.cr
+000038d0: 6f73 7361 7474 656e 7469 6f6e 203d 2042  ossattention = B
+000038e0: 6c69 7054 6578 7441 7474 656e 7469 6f6e  lipTextAttention
+000038f0: 2863 6f6e 6669 672c 2069 735f 6372 6f73  (config, is_cros
+00003900: 735f 6174 7465 6e74 696f 6e3d 7365 6c66  s_attention=self
+00003910: 2e63 6f6e 6669 672e 6973 5f64 6563 6f64  .config.is_decod
+00003920: 6572 290a 2020 2020 2020 2020 7365 6c66  er).        self
+00003930: 2e69 6e74 6572 6d65 6469 6174 6520 3d20  .intermediate = 
+00003940: 426c 6970 5465 7874 496e 7465 726d 6564  BlipTextIntermed
+00003950: 6961 7465 2863 6f6e 6669 6729 0a20 2020  iate(config).   
+00003960: 2020 2020 2073 656c 662e 6f75 7470 7574       self.output
+00003970: 203d 2042 6c69 7054 6578 744f 7574 7075   = BlipTextOutpu
+00003980: 7428 636f 6e66 6967 290a 0a20 2020 2064  t(config)..    d
+00003990: 6566 2063 6f6e 7374 7275 6374 280a 2020  ef construct(.  
+000039a0: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+000039b0: 2020 2020 6869 6464 656e 5f73 7461 7465      hidden_state
+000039c0: 733a 206d 696e 6473 706f 7265 2e54 656e  s: mindspore.Ten
+000039d0: 736f 722c 0a20 2020 2020 2020 2061 7474  sor,.        att
+000039e0: 656e 7469 6f6e 5f6d 6173 6b3a 204f 7074  ention_mask: Opt
+000039f0: 696f 6e61 6c5b 6d69 6e64 7370 6f72 652e  ional[mindspore.
+00003a00: 5465 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a  Tensor] = None,.
+00003a10: 2020 2020 2020 2020 6865 6164 5f6d 6173          head_mas
+00003a20: 6b3a 204f 7074 696f 6e61 6c5b 6d69 6e64  k: Optional[mind
+00003a30: 7370 6f72 652e 5465 6e73 6f72 5d20 3d20  spore.Tensor] = 
+00003a40: 4e6f 6e65 2c0a 2020 2020 2020 2020 656e  None,.        en
+00003a50: 636f 6465 725f 6869 6464 656e 5f73 7461  coder_hidden_sta
+00003a60: 7465 733a 204f 7074 696f 6e61 6c5b 6d69  tes: Optional[mi
+00003a70: 6e64 7370 6f72 652e 5465 6e73 6f72 5d20  ndspore.Tensor] 
+00003a80: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00003a90: 656e 636f 6465 725f 6174 7465 6e74 696f  encoder_attentio
+00003aa0: 6e5f 6d61 736b 3a20 4f70 7469 6f6e 616c  n_mask: Optional
+00003ab0: 5b6d 696e 6473 706f 7265 2e54 656e 736f  [mindspore.Tenso
+00003ac0: 725d 203d 204e 6f6e 652c 0a20 2020 2020  r] = None,.     
+00003ad0: 2020 2070 6173 745f 6b65 795f 7661 6c75     past_key_valu
+00003ae0: 653a 204f 7074 696f 6e61 6c5b 5475 706c  e: Optional[Tupl
+00003af0: 655b 5475 706c 655b 6d69 6e64 7370 6f72  e[Tuple[mindspor
+00003b00: 652e 5465 6e73 6f72 5d5d 5d20 3d20 4e6f  e.Tensor]]] = No
+00003b10: 6e65 2c0a 2020 2020 2020 2020 6f75 7470  ne,.        outp
+00003b20: 7574 5f61 7474 656e 7469 6f6e 733a 204f  ut_attentions: O
+00003b30: 7074 696f 6e61 6c5b 626f 6f6c 5d20 3d20  ptional[bool] = 
+00003b40: 4661 6c73 652c 0a20 2020 2029 202d 3e20  False,.    ) -> 
+00003b50: 5475 706c 655b 6d69 6e64 7370 6f72 652e  Tuple[mindspore.
+00003b60: 5465 6e73 6f72 5d3a 0a20 2020 2020 2020  Tensor]:.       
+00003b70: 2023 2064 6563 6f64 6572 2075 6e69 2d64   # decoder uni-d
+00003b80: 6972 6563 7469 6f6e 616c 2073 656c 662d  irectional self-
+00003b90: 6174 7465 6e74 696f 6e20 6361 6368 6564  attention cached
+00003ba0: 206b 6579 2f76 616c 7565 7320 7475 706c   key/values tupl
+00003bb0: 6520 6973 2061 7420 706f 7369 7469 6f6e  e is at position
+00003bc0: 7320 312c 320a 2020 2020 2020 2020 7365  s 1,2.        se
+00003bd0: 6c66 5f61 7474 6e5f 7061 7374 5f6b 6579  lf_attn_past_key
+00003be0: 5f76 616c 7565 203d 2070 6173 745f 6b65  _value = past_ke
+00003bf0: 795f 7661 6c75 655b 3a32 5d20 6966 2070  y_value[:2] if p
+00003c00: 6173 745f 6b65 795f 7661 6c75 6520 6973  ast_key_value is
+00003c10: 206e 6f74 204e 6f6e 6520 656c 7365 204e   not None else N
+00003c20: 6f6e 650a 2020 2020 2020 2020 7365 6c66  one.        self
+00003c30: 5f61 7474 656e 7469 6f6e 5f6f 7574 7075  _attention_outpu
+00003c40: 7473 203d 2073 656c 662e 6174 7465 6e74  ts = self.attent
+00003c50: 696f 6e28 0a20 2020 2020 2020 2020 2020  ion(.           
+00003c60: 2068 6964 6465 6e5f 7374 6174 6573 2c0a   hidden_states,.
+00003c70: 2020 2020 2020 2020 2020 2020 6174 7465              atte
+00003c80: 6e74 696f 6e5f 6d61 736b 2c0a 2020 2020  ntion_mask,.    
+00003c90: 2020 2020 2020 2020 6865 6164 5f6d 6173          head_mas
+00003ca0: 6b2c 0a20 2020 2020 2020 2020 2020 206f  k,.            o
+00003cb0: 7574 7075 745f 6174 7465 6e74 696f 6e73  utput_attentions
+00003cc0: 3d6f 7574 7075 745f 6174 7465 6e74 696f  =output_attentio
+00003cd0: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
+00003ce0: 7061 7374 5f6b 6579 5f76 616c 7565 3d73  past_key_value=s
+00003cf0: 656c 665f 6174 746e 5f70 6173 745f 6b65  elf_attn_past_ke
+00003d00: 795f 7661 6c75 652c 0a20 2020 2020 2020  y_value,.       
+00003d10: 2029 0a20 2020 2020 2020 2061 7474 656e   ).        atten
+00003d20: 7469 6f6e 5f6f 7574 7075 7420 3d20 7365  tion_output = se
+00003d30: 6c66 5f61 7474 656e 7469 6f6e 5f6f 7574  lf_attention_out
+00003d40: 7075 7473 5b30 5d0a 0a20 2020 2020 2020  puts[0]..       
+00003d50: 206f 7574 7075 7473 203d 2073 656c 665f   outputs = self_
+00003d60: 6174 7465 6e74 696f 6e5f 6f75 7470 7574  attention_output
+00003d70: 735b 313a 2d31 5d0a 2020 2020 2020 2020  s[1:-1].        
+00003d80: 7072 6573 656e 745f 6b65 795f 7661 6c75  present_key_valu
+00003d90: 6520 3d20 7365 6c66 5f61 7474 656e 7469  e = self_attenti
+00003da0: 6f6e 5f6f 7574 7075 7473 5b2d 315d 0a0a  on_outputs[-1]..
+00003db0: 2020 2020 2020 2020 6966 2065 6e63 6f64          if encod
+00003dc0: 6572 5f68 6964 6465 6e5f 7374 6174 6573  er_hidden_states
+00003dd0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00003de0: 2020 2020 2020 2020 2020 6372 6f73 735f            cross_
+00003df0: 6174 7465 6e74 696f 6e5f 6f75 7470 7574  attention_output
+00003e00: 7320 3d20 7365 6c66 2e63 726f 7373 6174  s = self.crossat
+00003e10: 7465 6e74 696f 6e28 0a20 2020 2020 2020  tention(.       
+00003e20: 2020 2020 2020 2020 2061 7474 656e 7469           attenti
+00003e30: 6f6e 5f6f 7574 7075 742c 0a20 2020 2020  on_output,.     
+00003e40: 2020 2020 2020 2020 2020 2061 7474 656e             atten
+00003e50: 7469 6f6e 5f6d 6173 6b2c 0a20 2020 2020  tion_mask,.     
+00003e60: 2020 2020 2020 2020 2020 2068 6561 645f             head_
+00003e70: 6d61 736b 2c0a 2020 2020 2020 2020 2020  mask,.          
+00003e80: 2020 2020 2020 656e 636f 6465 725f 6869        encoder_hi
+00003e90: 6464 656e 5f73 7461 7465 732c 0a20 2020  dden_states,.   
+00003ea0: 2020 2020 2020 2020 2020 2020 2065 6e63               enc
+00003eb0: 6f64 6572 5f61 7474 656e 7469 6f6e 5f6d  oder_attention_m
+00003ec0: 6173 6b2c 0a20 2020 2020 2020 2020 2020  ask,.           
+00003ed0: 2020 2020 206f 7574 7075 745f 6174 7465       output_atte
+00003ee0: 6e74 696f 6e73 3d6f 7574 7075 745f 6174  ntions=output_at
+00003ef0: 7465 6e74 696f 6e73 2c0a 2020 2020 2020  tentions,.      
+00003f00: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00003f10: 2020 2020 6174 7465 6e74 696f 6e5f 6f75      attention_ou
+00003f20: 7470 7574 203d 2063 726f 7373 5f61 7474  tput = cross_att
+00003f30: 656e 7469 6f6e 5f6f 7574 7075 7473 5b30  ention_outputs[0
+00003f40: 5d0a 2020 2020 2020 2020 2020 2020 6f75  ].            ou
+00003f50: 7470 7574 7320 3d20 6f75 7470 7574 7320  tputs = outputs 
+00003f60: 2b20 6372 6f73 735f 6174 7465 6e74 696f  + cross_attentio
+00003f70: 6e5f 6f75 7470 7574 735b 313a 2d31 5d20  n_outputs[1:-1] 
+00003f80: 2023 2061 6464 2063 726f 7373 2061 7474   # add cross att
+00003f90: 656e 7469 6f6e 7320 6966 2077 6520 6f75  entions if we ou
+00003fa0: 7470 7574 2061 7474 656e 7469 6f6e 2077  tput attention w
+00003fb0: 6569 6768 7473 0a20 2020 2020 2020 206c  eights.        l
+00003fc0: 6179 6572 5f6f 7574 7075 7420 3d20 6170  ayer_output = ap
+00003fd0: 706c 795f 6368 756e 6b69 6e67 5f74 6f5f  ply_chunking_to_
+00003fe0: 666f 7277 6172 6428 0a20 2020 2020 2020  forward(.       
+00003ff0: 2020 2020 2073 656c 662e 6665 6564 5f66       self.feed_f
+00004000: 6f72 7761 7264 5f63 6875 6e6b 2c20 7365  orward_chunk, se
+00004010: 6c66 2e63 6875 6e6b 5f73 697a 655f 6665  lf.chunk_size_fe
+00004020: 6564 5f66 6f72 7761 7264 2c20 7365 6c66  ed_forward, self
+00004030: 2e73 6571 5f6c 656e 5f64 696d 2c20 6174  .seq_len_dim, at
+00004040: 7465 6e74 696f 6e5f 6f75 7470 7574 0a20  tention_output. 
+00004050: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00004060: 206f 7574 7075 7473 203d 2028 6c61 7965   outputs = (laye
+00004070: 725f 6f75 7470 7574 2c29 202b 206f 7574  r_output,) + out
+00004080: 7075 7473 0a0a 2020 2020 2020 2020 6f75  puts..        ou
+00004090: 7470 7574 7320 3d20 6f75 7470 7574 7320  tputs = outputs 
+000040a0: 2b20 2870 7265 7365 6e74 5f6b 6579 5f76  + (present_key_v
+000040b0: 616c 7565 2c29 0a0a 2020 2020 2020 2020  alue,)..        
+000040c0: 7265 7475 726e 206f 7574 7075 7473 0a0a  return outputs..
+000040d0: 2020 2020 6465 6620 6665 6564 5f66 6f72      def feed_for
+000040e0: 7761 7264 5f63 6875 6e6b 2873 656c 662c  ward_chunk(self,
+000040f0: 2061 7474 656e 7469 6f6e 5f6f 7574 7075   attention_outpu
+00004100: 7429 3a0a 2020 2020 2020 2020 696e 7465  t):.        inte
+00004110: 726d 6564 6961 7465 5f6f 7574 7075 7420  rmediate_output 
+00004120: 3d20 7365 6c66 2e69 6e74 6572 6d65 6469  = self.intermedi
+00004130: 6174 6528 6174 7465 6e74 696f 6e5f 6f75  ate(attention_ou
+00004140: 7470 7574 290a 2020 2020 2020 2020 6c61  tput).        la
+00004150: 7965 725f 6f75 7470 7574 203d 2073 656c  yer_output = sel
+00004160: 662e 6f75 7470 7574 2869 6e74 6572 6d65  f.output(interme
+00004170: 6469 6174 655f 6f75 7470 7574 2c20 6174  diate_output, at
+00004180: 7465 6e74 696f 6e5f 6f75 7470 7574 290a  tention_output).
+00004190: 2020 2020 2020 2020 7265 7475 726e 206c          return l
+000041a0: 6179 6572 5f6f 7574 7075 740a 0a0a 2320  ayer_output...# 
+000041b0: 4164 6170 7465 6420 6672 6f6d 2068 7474  Adapted from htt
+000041c0: 7073 3a2f 2f67 6974 6875 622e 636f 6d2f  ps://github.com/
+000041d0: 7361 6c65 7366 6f72 6365 2f42 4c49 502f  salesforce/BLIP/
+000041e0: 626c 6f62 2f6d 6169 6e2f 6d6f 6465 6c73  blob/main/models
+000041f0: 2f6d 6564 2e70 7923 4c33 3836 0a63 6c61  /med.py#L386.cla
+00004200: 7373 2042 6c69 7054 6578 7445 6e63 6f64  ss BlipTextEncod
+00004210: 6572 286e 6e2e 4365 6c6c 293a 0a20 2020  er(nn.Cell):.   
+00004220: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
+00004230: 6c66 2c20 636f 6e66 6967 293a 0a20 2020  lf, config):.   
+00004240: 2020 2020 2073 7570 6572 2829 2e5f 5f69       super().__i
+00004250: 6e69 745f 5f28 290a 2020 2020 2020 2020  nit__().        
+00004260: 7365 6c66 2e63 6f6e 6669 6720 3d20 636f  self.config = co
+00004270: 6e66 6967 0a20 2020 2020 2020 2073 656c  nfig.        sel
+00004280: 662e 6c61 7965 7220 3d20 6e6e 2e43 656c  f.layer = nn.Cel
+00004290: 6c4c 6973 7428 5b42 6c69 7054 6578 744c  lList([BlipTextL
+000042a0: 6179 6572 2863 6f6e 6669 672c 2069 2920  ayer(config, i) 
+000042b0: 666f 7220 6920 696e 2072 616e 6765 2863  for i in range(c
+000042c0: 6f6e 6669 672e 6e75 6d5f 6869 6464 656e  onfig.num_hidden
+000042d0: 5f6c 6179 6572 7329 5d29 0a20 2020 2020  _layers)]).     
+000042e0: 2020 2073 656c 662e 6772 6164 6965 6e74     self.gradient
+000042f0: 5f63 6865 636b 706f 696e 7469 6e67 203d  _checkpointing =
+00004300: 2046 616c 7365 0a0a 2020 2020 6465 6620   False..    def 
+00004310: 636f 6e73 7472 7563 7428 0a20 2020 2020  construct(.     
+00004320: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+00004330: 2068 6964 6465 6e5f 7374 6174 6573 3a20   hidden_states: 
+00004340: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+00004350: 2c0a 2020 2020 2020 2020 6174 7465 6e74  ,.        attent
+00004360: 696f 6e5f 6d61 736b 3a20 4f70 7469 6f6e  ion_mask: Option
+00004370: 616c 5b6d 696e 6473 706f 7265 2e54 656e  al[mindspore.Ten
+00004380: 736f 725d 203d 204e 6f6e 652c 0a20 2020  sor] = None,.   
+00004390: 2020 2020 2068 6561 645f 6d61 736b 3a20       head_mask: 
+000043a0: 4f70 7469 6f6e 616c 5b6d 696e 6473 706f  Optional[mindspo
+000043b0: 7265 2e54 656e 736f 725d 203d 204e 6f6e  re.Tensor] = Non
+000043c0: 652c 0a20 2020 2020 2020 2065 6e63 6f64  e,.        encod
+000043d0: 6572 5f68 6964 6465 6e5f 7374 6174 6573  er_hidden_states
+000043e0: 3a20 4f70 7469 6f6e 616c 5b6d 696e 6473  : Optional[minds
+000043f0: 706f 7265 2e54 656e 736f 725d 203d 204e  pore.Tensor] = N
+00004400: 6f6e 652c 0a20 2020 2020 2020 2065 6e63  one,.        enc
+00004410: 6f64 6572 5f61 7474 656e 7469 6f6e 5f6d  oder_attention_m
+00004420: 6173 6b3a 204f 7074 696f 6e61 6c5b 6d69  ask: Optional[mi
+00004430: 6e64 7370 6f72 652e 5465 6e73 6f72 5d20  ndspore.Tensor] 
+00004440: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00004450: 7061 7374 5f6b 6579 5f76 616c 7565 733a  past_key_values:
+00004460: 204f 7074 696f 6e61 6c5b 5475 706c 655b   Optional[Tuple[
+00004470: 5475 706c 655b 6d69 6e64 7370 6f72 652e  Tuple[mindspore.
+00004480: 5465 6e73 6f72 5d5d 5d20 3d20 4e6f 6e65  Tensor]]] = None
+00004490: 2c0a 2020 2020 2020 2020 7573 655f 6361  ,.        use_ca
+000044a0: 6368 653a 204f 7074 696f 6e61 6c5b 626f  che: Optional[bo
+000044b0: 6f6c 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ol] = None,.    
+000044c0: 2020 2020 6f75 7470 7574 5f61 7474 656e      output_atten
+000044d0: 7469 6f6e 733a 204f 7074 696f 6e61 6c5b  tions: Optional[
+000044e0: 626f 6f6c 5d20 3d20 4661 6c73 652c 0a20  bool] = False,. 
+000044f0: 2020 2020 2020 206f 7574 7075 745f 6869         output_hi
+00004500: 6464 656e 5f73 7461 7465 733a 204f 7074  dden_states: Opt
+00004510: 696f 6e61 6c5b 626f 6f6c 5d20 3d20 4661  ional[bool] = Fa
+00004520: 6c73 652c 0a20 2020 2020 2020 2072 6574  lse,.        ret
+00004530: 7572 6e5f 6469 6374 3a20 4f70 7469 6f6e  urn_dict: Option
+00004540: 616c 5b62 6f6f 6c5d 203d 2054 7275 652c  al[bool] = True,
+00004550: 0a20 2020 2029 202d 3e20 556e 696f 6e5b  .    ) -> Union[
+00004560: 5475 706c 655b 6d69 6e64 7370 6f72 652e  Tuple[mindspore.
+00004570: 5465 6e73 6f72 5d2c 2042 6173 654d 6f64  Tensor], BaseMod
+00004580: 656c 4f75 7470 7574 5769 7468 5061 7374  elOutputWithPast
+00004590: 416e 6443 726f 7373 4174 7465 6e74 696f  AndCrossAttentio
+000045a0: 6e73 5d3a 0a20 2020 2020 2020 2069 6620  ns]:.        if 
+000045b0: 7365 6c66 2e67 7261 6469 656e 745f 6368  self.gradient_ch
+000045c0: 6563 6b70 6f69 6e74 696e 6720 616e 6420  eckpointing and 
+000045d0: 7365 6c66 2e74 7261 696e 696e 673a 0a20  self.training:. 
+000045e0: 2020 2020 2020 2020 2020 2069 6620 7573             if us
+000045f0: 655f 6361 6368 653a 0a20 2020 2020 2020  e_cache:.       
+00004600: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+00004610: 7761 726e 696e 6728 0a20 2020 2020 2020  warning(.       
+00004620: 2020 2020 2020 2020 2020 2020 2022 6075               "`u
+00004630: 7365 5f63 6163 6865 3d54 7275 6560 2069  se_cache=True` i
+00004640: 7320 696e 636f 6d70 6174 6962 6c65 2077  s incompatible w
+00004650: 6974 6820 6772 6164 6965 6e74 2063 6865  ith gradient che
+00004660: 636b 706f 696e 7469 6e67 2e20 5365 7474  ckpointing. Sett
+00004670: 696e 6720 6075 7365 5f63 6163 6865 3d46  ing `use_cache=F
+00004680: 616c 7365 602e 2e2e 220a 2020 2020 2020  alse`...".      
+00004690: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+000046a0: 2020 2020 2020 2020 2020 2020 7573 655f              use_
+000046b0: 6361 6368 6520 3d20 4661 6c73 650a 2020  cache = False.  
+000046c0: 2020 2020 2020 616c 6c5f 6869 6464 656e        all_hidden
+000046d0: 5f73 7461 7465 7320 3d20 2829 2069 6620  _states = () if 
+000046e0: 6f75 7470 7574 5f68 6964 6465 6e5f 7374  output_hidden_st
+000046f0: 6174 6573 2065 6c73 6520 4e6f 6e65 0a20  ates else None. 
+00004700: 2020 2020 2020 2061 6c6c 5f73 656c 665f         all_self_
+00004710: 6174 7465 6e74 696f 6e73 203d 2028 2920  attentions = () 
+00004720: 6966 206f 7574 7075 745f 6174 7465 6e74  if output_attent
+00004730: 696f 6e73 2065 6c73 6520 4e6f 6e65 0a20  ions else None. 
+00004740: 2020 2020 2020 2061 6c6c 5f63 726f 7373         all_cross
+00004750: 5f61 7474 656e 7469 6f6e 7320 3d20 2829  _attentions = ()
+00004760: 2069 6620 6f75 7470 7574 5f61 7474 656e   if output_atten
+00004770: 7469 6f6e 7320 616e 6420 7365 6c66 2e63  tions and self.c
+00004780: 6f6e 6669 672e 6973 5f64 6563 6f64 6572  onfig.is_decoder
+00004790: 2065 6c73 6520 4e6f 6e65 0a0a 2020 2020   else None..    
+000047a0: 2020 2020 6e65 7874 5f64 6563 6f64 6572      next_decoder
+000047b0: 5f63 6163 6865 203d 2028 2920 6966 2075  _cache = () if u
+000047c0: 7365 5f63 6163 6865 2065 6c73 6520 4e6f  se_cache else No
+000047d0: 6e65 0a0a 2020 2020 2020 2020 666f 7220  ne..        for 
+000047e0: 6920 696e 2072 616e 6765 2873 656c 662e  i in range(self.
+000047f0: 636f 6e66 6967 2e6e 756d 5f68 6964 6465  config.num_hidde
+00004800: 6e5f 6c61 7965 7273 293a 0a20 2020 2020  n_layers):.     
+00004810: 2020 2020 2020 206c 6179 6572 5f6d 6f64         layer_mod
+00004820: 756c 6520 3d20 7365 6c66 2e6c 6179 6572  ule = self.layer
+00004830: 5b69 5d0a 2020 2020 2020 2020 2020 2020  [i].            
+00004840: 6966 206f 7574 7075 745f 6869 6464 656e  if output_hidden
+00004850: 5f73 7461 7465 733a 0a20 2020 2020 2020  _states:.       
+00004860: 2020 2020 2020 2020 2061 6c6c 5f68 6964           all_hid
+00004870: 6465 6e5f 7374 6174 6573 203d 2061 6c6c  den_states = all
+00004880: 5f68 6964 6465 6e5f 7374 6174 6573 202b  _hidden_states +
+00004890: 2028 6869 6464 656e 5f73 7461 7465 732c   (hidden_states,
+000048a0: 290a 0a20 2020 2020 2020 2020 2020 206c  )..            l
+000048b0: 6179 6572 5f68 6561 645f 6d61 736b 203d  ayer_head_mask =
+000048c0: 2068 6561 645f 6d61 736b 5b69 5d20 6966   head_mask[i] if
+000048d0: 2068 6561 645f 6d61 736b 2069 7320 6e6f   head_mask is no
+000048e0: 7420 4e6f 6e65 2065 6c73 6520 4e6f 6e65  t None else None
+000048f0: 0a20 2020 2020 2020 2020 2020 2070 6173  .            pas
+00004900: 745f 6b65 795f 7661 6c75 6520 3d20 7061  t_key_value = pa
+00004910: 7374 5f6b 6579 5f76 616c 7565 735b 695d  st_key_values[i]
+00004920: 2069 6620 7061 7374 5f6b 6579 5f76 616c   if past_key_val
+00004930: 7565 7320 6973 206e 6f74 204e 6f6e 6520  ues is not None 
+00004940: 656c 7365 204e 6f6e 650a 0a20 2020 2020  else None..     
+00004950: 2020 2020 2020 2069 6620 7365 6c66 2e67         if self.g
+00004960: 7261 6469 656e 745f 6368 6563 6b70 6f69  radient_checkpoi
+00004970: 6e74 696e 6720 616e 6420 7365 6c66 2e74  nting and self.t
+00004980: 7261 696e 696e 673a 0a20 2020 2020 2020  raining:.       
+00004990: 2020 2020 2020 2020 206c 6179 6572 5f6f           layer_o
+000049a0: 7574 7075 7473 203d 2073 656c 662e 5f67  utputs = self._g
+000049b0: 7261 6469 656e 745f 6368 6563 6b70 6f69  radient_checkpoi
+000049c0: 6e74 696e 675f 6675 6e63 280a 2020 2020  nting_func(.    
+000049d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000049e0: 6c61 7965 725f 6d6f 6475 6c65 2e5f 5f63  layer_module.__c
+000049f0: 616c 6c5f 5f2c 0a20 2020 2020 2020 2020  all__,.         
+00004a00: 2020 2020 2020 2020 2020 2068 6964 6465             hidde
+00004a10: 6e5f 7374 6174 6573 2c0a 2020 2020 2020  n_states,.      
+00004a20: 2020 2020 2020 2020 2020 2020 2020 6174                at
+00004a30: 7465 6e74 696f 6e5f 6d61 736b 2c0a 2020  tention_mask,.  
+00004a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004a50: 2020 6c61 7965 725f 6865 6164 5f6d 6173    layer_head_mas
+00004a60: 6b2c 0a20 2020 2020 2020 2020 2020 2020  k,.             
+00004a70: 2020 2020 2020 2065 6e63 6f64 6572 5f68         encoder_h
+00004a80: 6964 6465 6e5f 7374 6174 6573 2c0a 2020  idden_states,.  
+00004a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004aa0: 2020 656e 636f 6465 725f 6174 7465 6e74    encoder_attent
+00004ab0: 696f 6e5f 6d61 736b 2c0a 2020 2020 2020  ion_mask,.      
+00004ac0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+00004ad0: 7374 5f6b 6579 5f76 616c 7565 2c0a 2020  st_key_value,.  
+00004ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004af0: 2020 6f75 7470 7574 5f61 7474 656e 7469    output_attenti
+00004b00: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
+00004b10: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00004b20: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00004b30: 2020 2020 2020 2020 206c 6179 6572 5f6f           layer_o
+00004b40: 7574 7075 7473 203d 206c 6179 6572 5f6d  utputs = layer_m
+00004b50: 6f64 756c 6528 0a20 2020 2020 2020 2020  odule(.         
+00004b60: 2020 2020 2020 2020 2020 2068 6964 6465             hidde
+00004b70: 6e5f 7374 6174 6573 2c0a 2020 2020 2020  n_states,.      
+00004b80: 2020 2020 2020 2020 2020 2020 2020 6174                at
+00004b90: 7465 6e74 696f 6e5f 6d61 736b 2c0a 2020  tention_mask,.  
+00004ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004bb0: 2020 6c61 7965 725f 6865 6164 5f6d 6173    layer_head_mas
+00004bc0: 6b2c 0a20 2020 2020 2020 2020 2020 2020  k,.             
+00004bd0: 2020 2020 2020 2065 6e63 6f64 6572 5f68         encoder_h
+00004be0: 6964 6465 6e5f 7374 6174 6573 2c0a 2020  idden_states,.  
+00004bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004c00: 2020 656e 636f 6465 725f 6174 7465 6e74    encoder_attent
+00004c10: 696f 6e5f 6d61 736b 2c0a 2020 2020 2020  ion_mask,.      
+00004c20: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+00004c30: 7374 5f6b 6579 5f76 616c 7565 2c0a 2020  st_key_value,.  
+00004c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004c50: 2020 6f75 7470 7574 5f61 7474 656e 7469    output_attenti
+00004c60: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
+00004c70: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00004c80: 2020 2020 6869 6464 656e 5f73 7461 7465      hidden_state
+00004c90: 7320 3d20 6c61 7965 725f 6f75 7470 7574  s = layer_output
+00004ca0: 735b 305d 0a20 2020 2020 2020 2020 2020  s[0].           
+00004cb0: 2069 6620 7573 655f 6361 6368 653a 0a20   if use_cache:. 
+00004cc0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00004cd0: 6578 745f 6465 636f 6465 725f 6361 6368  ext_decoder_cach
+00004ce0: 6520 2b3d 2028 6c61 7965 725f 6f75 7470  e += (layer_outp
+00004cf0: 7574 735b 2d31 5d2c 290a 2020 2020 2020  uts[-1],).      
+00004d00: 2020 2020 2020 6966 206f 7574 7075 745f        if output_
+00004d10: 6174 7465 6e74 696f 6e73 3a0a 2020 2020  attentions:.    
+00004d20: 2020 2020 2020 2020 2020 2020 616c 6c5f              all_
+00004d30: 7365 6c66 5f61 7474 656e 7469 6f6e 7320  self_attentions 
+00004d40: 3d20 616c 6c5f 7365 6c66 5f61 7474 656e  = all_self_atten
+00004d50: 7469 6f6e 7320 2b20 286c 6179 6572 5f6f  tions + (layer_o
+00004d60: 7574 7075 7473 5b31 5d2c 290a 2020 2020  utputs[1],).    
+00004d70: 2020 2020 2020 2020 2020 2020 616c 6c5f              all_
+00004d80: 6372 6f73 735f 6174 7465 6e74 696f 6e73  cross_attentions
+00004d90: 203d 2061 6c6c 5f63 726f 7373 5f61 7474   = all_cross_att
+00004da0: 656e 7469 6f6e 7320 2b20 286c 6179 6572  entions + (layer
+00004db0: 5f6f 7574 7075 7473 5b32 5d2c 290a 0a20  _outputs[2],).. 
+00004dc0: 2020 2020 2020 2069 6620 6f75 7470 7574         if output
+00004dd0: 5f68 6964 6465 6e5f 7374 6174 6573 3a0a  _hidden_states:.
+00004de0: 2020 2020 2020 2020 2020 2020 616c 6c5f              all_
+00004df0: 6869 6464 656e 5f73 7461 7465 7320 3d20  hidden_states = 
+00004e00: 616c 6c5f 6869 6464 656e 5f73 7461 7465  all_hidden_state
+00004e10: 7320 2b20 2868 6964 6465 6e5f 7374 6174  s + (hidden_stat
+00004e20: 6573 2c29 0a0a 2020 2020 2020 2020 6966  es,)..        if
+00004e30: 206e 6f74 2072 6574 7572 6e5f 6469 6374   not return_dict
+00004e40: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00004e50: 7475 726e 2074 7570 6c65 280a 2020 2020  turn tuple(.    
+00004e60: 2020 2020 2020 2020 2020 2020 760a 2020              v.  
+00004e70: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00004e80: 7220 7620 696e 205b 0a20 2020 2020 2020  r v in [.       
+00004e90: 2020 2020 2020 2020 2020 2020 2068 6964               hid
+00004ea0: 6465 6e5f 7374 6174 6573 2c0a 2020 2020  den_states,.    
+00004eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004ec0: 6e65 7874 5f64 6563 6f64 6572 5f63 6163  next_decoder_cac
+00004ed0: 6865 2c0a 2020 2020 2020 2020 2020 2020  he,.            
+00004ee0: 2020 2020 2020 2020 616c 6c5f 6869 6464          all_hidd
+00004ef0: 656e 5f73 7461 7465 732c 0a20 2020 2020  en_states,.     
+00004f00: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00004f10: 6c6c 5f73 656c 665f 6174 7465 6e74 696f  ll_self_attentio
+00004f20: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
+00004f30: 2020 2020 2020 2020 616c 6c5f 6372 6f73          all_cros
+00004f40: 735f 6174 7465 6e74 696f 6e73 2c0a 2020  s_attentions,.  
+00004f50: 2020 2020 2020 2020 2020 2020 2020 5d0a                ].
+00004f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004f70: 6966 2076 2069 7320 6e6f 7420 4e6f 6e65  if v is not None
+00004f80: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00004f90: 2020 2020 2020 2072 6574 7572 6e20 4261         return Ba
+00004fa0: 7365 4d6f 6465 6c4f 7574 7075 7457 6974  seModelOutputWit
+00004fb0: 6850 6173 7441 6e64 4372 6f73 7341 7474  hPastAndCrossAtt
+00004fc0: 656e 7469 6f6e 7328 0a20 2020 2020 2020  entions(.       
+00004fd0: 2020 2020 206c 6173 745f 6869 6464 656e       last_hidden
+00004fe0: 5f73 7461 7465 3d68 6964 6465 6e5f 7374  _state=hidden_st
+00004ff0: 6174 6573 2c0a 2020 2020 2020 2020 2020  ates,.          
+00005000: 2020 7061 7374 5f6b 6579 5f76 616c 7565    past_key_value
+00005010: 733d 6e65 7874 5f64 6563 6f64 6572 5f63  s=next_decoder_c
+00005020: 6163 6865 2c0a 2020 2020 2020 2020 2020  ache,.          
+00005030: 2020 6869 6464 656e 5f73 7461 7465 733d    hidden_states=
+00005040: 616c 6c5f 6869 6464 656e 5f73 7461 7465  all_hidden_state
+00005050: 732c 0a20 2020 2020 2020 2020 2020 2061  s,.            a
+00005060: 7474 656e 7469 6f6e 733d 616c 6c5f 7365  ttentions=all_se
+00005070: 6c66 5f61 7474 656e 7469 6f6e 732c 0a20  lf_attentions,. 
+00005080: 2020 2020 2020 2020 2020 2063 726f 7373             cross
+00005090: 5f61 7474 656e 7469 6f6e 733d 616c 6c5f  _attentions=all_
+000050a0: 6372 6f73 735f 6174 7465 6e74 696f 6e73  cross_attentions
+000050b0: 2c0a 2020 2020 2020 2020 290a 0a0a 2320  ,.        )...# 
+000050c0: 436f 7069 6564 2066 726f 6d20 7472 616e  Copied from tran
+000050d0: 7366 6f72 6d65 7273 2e6d 6f64 656c 732e  sformers.models.
+000050e0: 6265 7274 2e6d 6f64 656c 696e 675f 6265  bert.modeling_be
+000050f0: 7274 2e42 6572 7450 6f6f 6c65 7220 7769  rt.BertPooler wi
+00005100: 7468 2042 6572 742d 3e42 6c69 7054 6578  th Bert->BlipTex
+00005110: 740a 636c 6173 7320 426c 6970 5465 7874  t.class BlipText
+00005120: 506f 6f6c 6572 286e 6e2e 4365 6c6c 293a  Pooler(nn.Cell):
+00005130: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+00005140: 5f28 7365 6c66 2c20 636f 6e66 6967 293a  _(self, config):
+00005150: 0a20 2020 2020 2020 2073 7570 6572 2829  .        super()
+00005160: 2e5f 5f69 6e69 745f 5f28 290a 2020 2020  .__init__().    
+00005170: 2020 2020 7365 6c66 2e64 656e 7365 203d      self.dense =
+00005180: 206e 6e2e 4465 6e73 6528 636f 6e66 6967   nn.Dense(config
+00005190: 2e68 6964 6465 6e5f 7369 7a65 2c20 636f  .hidden_size, co
+000051a0: 6e66 6967 2e68 6964 6465 6e5f 7369 7a65  nfig.hidden_size
+000051b0: 290a 2020 2020 2020 2020 7365 6c66 2e61  ).        self.a
+000051c0: 6374 6976 6174 696f 6e20 3d20 6e6e 2e54  ctivation = nn.T
+000051d0: 616e 6828 290a 0a20 2020 2064 6566 2063  anh()..    def c
+000051e0: 6f6e 7374 7275 6374 2873 656c 662c 2068  onstruct(self, h
+000051f0: 6964 6465 6e5f 7374 6174 6573 3a20 6d69  idden_states: mi
+00005200: 6e64 7370 6f72 652e 5465 6e73 6f72 2920  ndspore.Tensor) 
+00005210: 2d3e 206d 696e 6473 706f 7265 2e54 656e  -> mindspore.Ten
+00005220: 736f 723a 0a20 2020 2020 2020 2023 2057  sor:.        # W
+00005230: 6520 2270 6f6f 6c22 2074 6865 206d 6f64  e "pool" the mod
+00005240: 656c 2062 7920 7369 6d70 6c79 2074 616b  el by simply tak
+00005250: 696e 6720 7468 6520 6869 6464 656e 2073  ing the hidden s
+00005260: 7461 7465 2063 6f72 7265 7370 6f6e 6469  tate correspondi
+00005270: 6e67 0a20 2020 2020 2020 2023 2074 6f20  ng.        # to 
+00005280: 7468 6520 6669 7273 7420 746f 6b65 6e2e  the first token.
+00005290: 0a20 2020 2020 2020 2066 6972 7374 5f74  .        first_t
+000052a0: 6f6b 656e 5f74 656e 736f 7220 3d20 6869  oken_tensor = hi
+000052b0: 6464 656e 5f73 7461 7465 735b 3a2c 2030  dden_states[:, 0
+000052c0: 5d0a 2020 2020 2020 2020 706f 6f6c 6564  ].        pooled
+000052d0: 5f6f 7574 7075 7420 3d20 7365 6c66 2e64  _output = self.d
+000052e0: 656e 7365 2866 6972 7374 5f74 6f6b 656e  ense(first_token
+000052f0: 5f74 656e 736f 7229 0a20 2020 2020 2020  _tensor).       
+00005300: 2070 6f6f 6c65 645f 6f75 7470 7574 203d   pooled_output =
+00005310: 2073 656c 662e 6163 7469 7661 7469 6f6e   self.activation
+00005320: 2870 6f6f 6c65 645f 6f75 7470 7574 290a  (pooled_output).
+00005330: 2020 2020 2020 2020 7265 7475 726e 2070          return p
+00005340: 6f6f 6c65 645f 6f75 7470 7574 0a0a 0a23  ooled_output...#
+00005350: 2043 6f70 6965 6420 6672 6f6d 2074 7261   Copied from tra
+00005360: 6e73 666f 726d 6572 732e 6d6f 6465 6c73  nsformers.models
+00005370: 2e62 6572 742e 6d6f 6465 6c69 6e67 5f62  .bert.modeling_b
+00005380: 6572 742e 4265 7274 5072 6564 6963 7469  ert.BertPredicti
+00005390: 6f6e 4865 6164 5472 616e 7366 6f72 6d20  onHeadTransform 
+000053a0: 7769 7468 2042 6572 742d 3e42 6c69 7054  with Bert->BlipT
+000053b0: 6578 740a 636c 6173 7320 426c 6970 5465  ext.class BlipTe
+000053c0: 7874 5072 6564 6963 7469 6f6e 4865 6164  xtPredictionHead
+000053d0: 5472 616e 7366 6f72 6d28 6e6e 2e43 656c  Transform(nn.Cel
+000053e0: 6c29 3a0a 2020 2020 6465 6620 5f5f 696e  l):.    def __in
+000053f0: 6974 5f5f 2873 656c 662c 2063 6f6e 6669  it__(self, confi
+00005400: 6729 3a0a 2020 2020 2020 2020 7375 7065  g):.        supe
+00005410: 7228 292e 5f5f 696e 6974 5f5f 2829 0a20  r().__init__(). 
+00005420: 2020 2020 2020 2073 656c 662e 6465 6e73         self.dens
+00005430: 6520 3d20 6e6e 2e44 656e 7365 2863 6f6e  e = nn.Dense(con
+00005440: 6669 672e 6869 6464 656e 5f73 697a 652c  fig.hidden_size,
+00005450: 2063 6f6e 6669 672e 6869 6464 656e 5f73   config.hidden_s
+00005460: 697a 6529 0a20 2020 2020 2020 2069 6620  ize).        if 
+00005470: 6973 696e 7374 616e 6365 2863 6f6e 6669  isinstance(confi
+00005480: 672e 6869 6464 656e 5f61 6374 2c20 7374  g.hidden_act, st
+00005490: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+000054a0: 7365 6c66 2e74 7261 6e73 666f 726d 5f61  self.transform_a
+000054b0: 6374 5f66 6e20 3d20 4143 5432 464e 5b63  ct_fn = ACT2FN[c
+000054c0: 6f6e 6669 672e 6869 6464 656e 5f61 6374  onfig.hidden_act
+000054d0: 5d0a 2020 2020 2020 2020 656c 7365 3a0a  ].        else:.
+000054e0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000054f0: 2e74 7261 6e73 666f 726d 5f61 6374 5f66  .transform_act_f
+00005500: 6e20 3d20 636f 6e66 6967 2e68 6964 6465  n = config.hidde
+00005510: 6e5f 6163 740a 2020 2020 2020 2020 7365  n_act.        se
+00005520: 6c66 2e4c 6179 6572 4e6f 726d 203d 206e  lf.LayerNorm = n
+00005530: 6e2e 4c61 7965 724e 6f72 6d28 636f 6e66  n.LayerNorm(conf
+00005540: 6967 2e68 6964 6465 6e5f 7369 7a65 2c20  ig.hidden_size, 
+00005550: 6570 7369 6c6f 6e3d 636f 6e66 6967 2e6c  epsilon=config.l
+00005560: 6179 6572 5f6e 6f72 6d5f 6570 7329 0a0a  ayer_norm_eps)..
+00005570: 2020 2020 6465 6620 636f 6e73 7472 7563      def construc
+00005580: 7428 7365 6c66 2c20 6869 6464 656e 5f73  t(self, hidden_s
+00005590: 7461 7465 733a 206d 696e 6473 706f 7265  tates: mindspore
+000055a0: 2e54 656e 736f 7229 202d 3e20 6d69 6e64  .Tensor) -> mind
+000055b0: 7370 6f72 652e 5465 6e73 6f72 3a0a 2020  spore.Tensor:.  
+000055c0: 2020 2020 2020 6869 6464 656e 5f73 7461        hidden_sta
+000055d0: 7465 7320 3d20 7365 6c66 2e64 656e 7365  tes = self.dense
+000055e0: 2868 6964 6465 6e5f 7374 6174 6573 290a  (hidden_states).
+000055f0: 2020 2020 2020 2020 6869 6464 656e 5f73          hidden_s
+00005600: 7461 7465 7320 3d20 7365 6c66 2e74 7261  tates = self.tra
+00005610: 6e73 666f 726d 5f61 6374 5f66 6e28 6869  nsform_act_fn(hi
+00005620: 6464 656e 5f73 7461 7465 7329 0a20 2020  dden_states).   
+00005630: 2020 2020 2068 6964 6465 6e5f 7374 6174       hidden_stat
+00005640: 6573 203d 2073 656c 662e 4c61 7965 724e  es = self.LayerN
+00005650: 6f72 6d28 6869 6464 656e 5f73 7461 7465  orm(hidden_state
+00005660: 7329 0a20 2020 2020 2020 2072 6574 7572  s).        retur
+00005670: 6e20 6869 6464 656e 5f73 7461 7465 730a  n hidden_states.
+00005680: 0a0a 2320 436f 7069 6564 2066 726f 6d20  ..# Copied from 
+00005690: 7472 616e 7366 6f72 6d65 7273 2e6d 6f64  transformers.mod
+000056a0: 656c 732e 6265 7274 2e6d 6f64 656c 696e  els.bert.modelin
+000056b0: 675f 6265 7274 2e42 6572 744c 4d50 7265  g_bert.BertLMPre
+000056c0: 6469 6374 696f 6e48 6561 6420 7769 7468  dictionHead with
+000056d0: 2042 6572 742d 3e42 6c69 7054 6578 740a   Bert->BlipText.
+000056e0: 636c 6173 7320 426c 6970 5465 7874 4c4d  class BlipTextLM
+000056f0: 5072 6564 6963 7469 6f6e 4865 6164 286e  PredictionHead(n
+00005700: 6e2e 4365 6c6c 293a 0a20 2020 2064 6566  n.Cell):.    def
+00005710: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
+00005720: 636f 6e66 6967 293a 0a20 2020 2020 2020  config):.       
+00005730: 2073 7570 6572 2829 2e5f 5f69 6e69 745f   super().__init_
+00005740: 5f28 290a 2020 2020 2020 2020 7365 6c66  _().        self
+00005750: 2e74 7261 6e73 666f 726d 203d 2042 6c69  .transform = Bli
+00005760: 7054 6578 7450 7265 6469 6374 696f 6e48  pTextPredictionH
+00005770: 6561 6454 7261 6e73 666f 726d 2863 6f6e  eadTransform(con
+00005780: 6669 6729 0a0a 2020 2020 2020 2020 2320  fig)..        # 
+00005790: 5468 6520 6f75 7470 7574 2077 6569 6768  The output weigh
+000057a0: 7473 2061 7265 2074 6865 2073 616d 6520  ts are the same 
+000057b0: 6173 2074 6865 2069 6e70 7574 2065 6d62  as the input emb
+000057c0: 6564 6469 6e67 732c 2062 7574 2074 6865  eddings, but the
+000057d0: 7265 2069 730a 2020 2020 2020 2020 2320  re is.        # 
+000057e0: 616e 206f 7574 7075 742d 6f6e 6c79 2062  an output-only b
+000057f0: 6961 7320 666f 7220 6561 6368 2074 6f6b  ias for each tok
+00005800: 656e 2e0a 2020 2020 2020 2020 7365 6c66  en..        self
+00005810: 2e64 6563 6f64 6572 203d 206e 6e2e 4465  .decoder = nn.De
+00005820: 6e73 6528 636f 6e66 6967 2e68 6964 6465  nse(config.hidde
+00005830: 6e5f 7369 7a65 2c20 636f 6e66 6967 2e76  n_size, config.v
+00005840: 6f63 6162 5f73 697a 652c 2068 6173 5f62  ocab_size, has_b
+00005850: 6961 733d 4661 6c73 6529 0a0a 2020 2020  ias=False)..    
+00005860: 2020 2020 7365 6c66 2e62 6961 7320 3d20      self.bias = 
+00005870: 5061 7261 6d65 7465 7228 6f70 732e 7a65  Parameter(ops.ze
+00005880: 726f 7328 636f 6e66 6967 2e76 6f63 6162  ros(config.vocab
+00005890: 5f73 697a 6529 290a 0a20 2020 2020 2020  _size))..       
+000058a0: 2023 204e 6565 6420 6120 6c69 6e6b 2062   # Need a link b
+000058b0: 6574 7765 656e 2074 6865 2074 776f 2076  etween the two v
+000058c0: 6172 6961 626c 6573 2073 6f20 7468 6174  ariables so that
+000058d0: 2074 6865 2062 6961 7320 6973 2063 6f72   the bias is cor
+000058e0: 7265 6374 6c79 2072 6573 697a 6564 2077  rectly resized w
+000058f0: 6974 6820 6072 6573 697a 655f 746f 6b65  ith `resize_toke
+00005900: 6e5f 656d 6265 6464 696e 6773 600a 2020  n_embeddings`.  
+00005910: 2020 2020 2020 7365 6c66 2e64 6563 6f64        self.decod
+00005920: 6572 2e62 6961 7320 3d20 7365 6c66 2e62  er.bias = self.b
+00005930: 6961 730a 0a20 2020 2064 6566 2063 6f6e  ias..    def con
+00005940: 7374 7275 6374 2873 656c 662c 2068 6964  struct(self, hid
+00005950: 6465 6e5f 7374 6174 6573 293a 0a20 2020  den_states):.   
+00005960: 2020 2020 2068 6964 6465 6e5f 7374 6174       hidden_stat
+00005970: 6573 203d 2073 656c 662e 7472 616e 7366  es = self.transf
+00005980: 6f72 6d28 6869 6464 656e 5f73 7461 7465  orm(hidden_state
+00005990: 7329 0a20 2020 2020 2020 2068 6964 6465  s).        hidde
+000059a0: 6e5f 7374 6174 6573 203d 2073 656c 662e  n_states = self.
+000059b0: 6465 636f 6465 7228 6869 6464 656e 5f73  decoder(hidden_s
+000059c0: 7461 7465 7329 0a20 2020 2020 2020 2072  tates).        r
+000059d0: 6574 7572 6e20 6869 6464 656e 5f73 7461  eturn hidden_sta
+000059e0: 7465 730a 0a0a 2320 436f 7069 6564 2066  tes...# Copied f
+000059f0: 726f 6d20 7472 616e 7366 6f72 6d65 7273  rom transformers
+00005a00: 2e6d 6f64 656c 732e 6265 7274 2e6d 6f64  .models.bert.mod
+00005a10: 656c 696e 675f 6265 7274 2e42 6572 744f  eling_bert.BertO
+00005a20: 6e6c 794d 4c4d 4865 6164 2077 6974 6820  nlyMLMHead with 
+00005a30: 4265 7274 2d3e 426c 6970 5465 7874 0a63  Bert->BlipText.c
+00005a40: 6c61 7373 2042 6c69 7054 6578 744f 6e6c  lass BlipTextOnl
+00005a50: 794d 4c4d 4865 6164 286e 6e2e 4365 6c6c  yMLMHead(nn.Cell
+00005a60: 293a 0a20 2020 2064 6566 205f 5f69 6e69  ):.    def __ini
+00005a70: 745f 5f28 7365 6c66 2c20 636f 6e66 6967  t__(self, config
+00005a80: 293a 0a20 2020 2020 2020 2073 7570 6572  ):.        super
+00005a90: 2829 2e5f 5f69 6e69 745f 5f28 290a 2020  ().__init__().  
+00005aa0: 2020 2020 2020 7365 6c66 2e70 7265 6469        self.predi
+00005ab0: 6374 696f 6e73 203d 2042 6c69 7054 6578  ctions = BlipTex
+00005ac0: 744c 4d50 7265 6469 6374 696f 6e48 6561  tLMPredictionHea
+00005ad0: 6428 636f 6e66 6967 290a 0a20 2020 2064  d(config)..    d
+00005ae0: 6566 2063 6f6e 7374 7275 6374 2873 656c  ef construct(sel
+00005af0: 662c 2073 6571 7565 6e63 655f 6f75 7470  f, sequence_outp
+00005b00: 7574 3a20 6d69 6e64 7370 6f72 652e 5465  ut: mindspore.Te
+00005b10: 6e73 6f72 2920 2d3e 206d 696e 6473 706f  nsor) -> mindspo
+00005b20: 7265 2e54 656e 736f 723a 0a20 2020 2020  re.Tensor:.     
+00005b30: 2020 2070 7265 6469 6374 696f 6e5f 7363     prediction_sc
+00005b40: 6f72 6573 203d 2073 656c 662e 7072 6564  ores = self.pred
+00005b50: 6963 7469 6f6e 7328 7365 7175 656e 6365  ictions(sequence
+00005b60: 5f6f 7574 7075 7429 0a20 2020 2020 2020  _output).       
+00005b70: 2072 6574 7572 6e20 7072 6564 6963 7469   return predicti
+00005b80: 6f6e 5f73 636f 7265 730a 0a0a 2320 4164  on_scores...# Ad
+00005b90: 6170 7465 6420 6672 6f6d 2068 7474 7073  apted from https
+00005ba0: 3a2f 2f67 6974 6875 622e 636f 6d2f 7361  ://github.com/sa
+00005bb0: 6c65 7366 6f72 6365 2f42 4c49 502f 626c  lesforce/BLIP/bl
+00005bc0: 6f62 2f6d 6169 6e2f 6d6f 6465 6c73 2f6d  ob/main/models/m
+00005bd0: 6564 2e70 7923 4c35 3438 0a63 6c61 7373  ed.py#L548.class
+00005be0: 2042 6c69 7054 6578 7450 7265 5472 6169   BlipTextPreTrai
+00005bf0: 6e65 644d 6f64 656c 2850 7265 5472 6169  nedModel(PreTrai
+00005c00: 6e65 644d 6f64 656c 293a 0a20 2020 2022  nedModel):.    "
+00005c10: 2222 0a20 2020 2041 6e20 6162 7374 7261  "".    An abstra
+00005c20: 6374 2063 6c61 7373 2074 6f20 6861 6e64  ct class to hand
+00005c30: 6c65 2077 6569 6768 7473 2069 6e69 7469  le weights initi
+00005c40: 616c 697a 6174 696f 6e20 616e 6420 6120  alization and a 
+00005c50: 7369 6d70 6c65 2069 6e74 6572 6661 6365  simple interface
+00005c60: 2066 6f72 2064 6f77 6e6c 6f61 6469 6e67   for downloading
+00005c70: 2061 6e64 206c 6f61 6469 6e67 2070 7265   and loading pre
+00005c80: 7472 6169 6e65 640a 2020 2020 6d6f 6465  trained.    mode
+00005c90: 6c73 2e0a 2020 2020 2222 220a 0a20 2020  ls..    """..   
+00005ca0: 2063 6f6e 6669 675f 636c 6173 7320 3d20   config_class = 
+00005cb0: 426c 6970 5465 7874 436f 6e66 6967 0a20  BlipTextConfig. 
+00005cc0: 2020 2062 6173 655f 6d6f 6465 6c5f 7072     base_model_pr
+00005cd0: 6566 6978 203d 2022 6265 7274 220a 0a20  efix = "bert".. 
+00005ce0: 2020 2064 6566 205f 696e 6974 5f77 6569     def _init_wei
+00005cf0: 6768 7473 2873 656c 662c 2063 656c 6c29  ghts(self, cell)
+00005d00: 3a0a 2020 2020 2020 2020 2222 2249 6e69  :.        """Ini
+00005d10: 7469 616c 697a 6520 7468 6520 7765 6967  tialize the weig
+00005d20: 6874 7322 2222 0a20 2020 2020 2020 2069  hts""".        i
+00005d30: 6620 6973 696e 7374 616e 6365 2863 656c  f isinstance(cel
+00005d40: 6c2c 2028 6e6e 2e44 656e 7365 2c20 6e6e  l, (nn.Dense, nn
+00005d50: 2e45 6d62 6564 6469 6e67 2929 3a0a 2020  .Embedding)):.  
+00005d60: 2020 2020 2020 2020 2020 2320 536c 6967            # Slig
+00005d70: 6874 6c79 2064 6966 6665 7265 6e74 2066  htly different f
+00005d80: 726f 6d20 7468 6520 5446 2076 6572 7369  rom the TF versi
+00005d90: 6f6e 2077 6869 6368 2075 7365 7320 7472  on which uses tr
+00005da0: 756e 6361 7465 645f 6e6f 726d 616c 2066  uncated_normal f
+00005db0: 6f72 2069 6e69 7469 616c 697a 6174 696f  or initializatio
+00005dc0: 6e0a 2020 2020 2020 2020 2020 2020 2320  n.            # 
+00005dd0: 6366 2068 7474 7073 3a2f 2f67 6974 6875  cf https://githu
+00005de0: 622e 636f 6d2f 7079 746f 7263 682f 7079  b.com/pytorch/py
+00005df0: 746f 7263 682f 7075 6c6c 2f35 3631 370a  torch/pull/5617.
+00005e00: 2020 2020 2020 2020 2020 2020 6365 6c6c              cell
+00005e10: 2e77 6569 6768 742e 7365 745f 6461 7461  .weight.set_data
+00005e20: 2869 6e69 7469 616c 697a 6572 284e 6f72  (initializer(Nor
+00005e30: 6d61 6c28 7365 6c66 2e63 6f6e 6669 672e  mal(self.config.
+00005e40: 696e 6974 6961 6c69 7a65 725f 7261 6e67  initializer_rang
+00005e50: 6529 2c0a 2020 2020 2020 2020 2020 2020  e),.            
+00005e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005e80: 2020 2020 2020 2020 6365 6c6c 2e77 6569          cell.wei
+00005e90: 6768 742e 7368 6170 652c 2063 656c 6c2e  ght.shape, cell.
+00005ea0: 7765 6967 6874 2e64 7479 7065 2929 0a20  weight.dtype)). 
+00005eb0: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+00005ec0: 616e 6365 2863 656c 6c2c 206e 6e2e 4c61  ance(cell, nn.La
+00005ed0: 7965 724e 6f72 6d29 3a0a 2020 2020 2020  yerNorm):.      
+00005ee0: 2020 2020 2020 6365 6c6c 2e77 6569 6768        cell.weigh
+00005ef0: 742e 7365 745f 6461 7461 2869 6e69 7469  t.set_data(initi
+00005f00: 616c 697a 6572 2827 6f6e 6573 272c 2063  alizer('ones', c
+00005f10: 656c 6c2e 7765 6967 6874 2e73 6861 7065  ell.weight.shape
+00005f20: 2c20 6365 6c6c 2e77 6569 6768 742e 6474  , cell.weight.dt
+00005f30: 7970 6529 290a 2020 2020 2020 2020 2020  ype)).          
+00005f40: 2020 6365 6c6c 2e62 6961 732e 7365 745f    cell.bias.set_
+00005f50: 6461 7461 2869 6e69 7469 616c 697a 6572  data(initializer
+00005f60: 2827 7a65 726f 7327 2c20 6365 6c6c 2e62  ('zeros', cell.b
+00005f70: 6961 732e 7368 6170 652c 2063 656c 6c2e  ias.shape, cell.
+00005f80: 6269 6173 2e64 7479 7065 2929 0a0a 2020  bias.dtype))..  
+00005f90: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
+00005fa0: 6e63 6528 6365 6c6c 2c20 6e6e 2e44 656e  nce(cell, nn.Den
+00005fb0: 7365 2920 616e 6420 6365 6c6c 2e62 6961  se) and cell.bia
+00005fc0: 7320 6973 206e 6f74 204e 6f6e 653a 0a20  s is not None:. 
+00005fd0: 2020 2020 2020 2020 2020 2063 656c 6c2e             cell.
+00005fe0: 6269 6173 2e73 6574 5f64 6174 6128 696e  bias.set_data(in
+00005ff0: 6974 6961 6c69 7a65 7228 277a 6572 6f73  itializer('zeros
+00006000: 272c 2063 656c 6c2e 6269 6173 2e73 6861  ', cell.bias.sha
+00006010: 7065 2c20 6365 6c6c 2e62 6961 732e 6474  pe, cell.bias.dt
+00006020: 7970 6529 290a 0a0a 2320 4164 6170 7465  ype))...# Adapte
+00006030: 6420 6672 6f6d 2068 7474 7073 3a2f 2f67  d from https://g
+00006040: 6974 6875 622e 636f 6d2f 7361 6c65 7366  ithub.com/salesf
+00006050: 6f72 6365 2f42 4c49 502f 626c 6f62 2f33  orce/BLIP/blob/3
+00006060: 6132 3962 3734 3130 3437 3662 6635 6632  a29b7410476bf5f2
+00006070: 6261 3039 3535 3832 3733 3930 6562 3665  ba0955827390eb6e
+00006080: 6131 6634 6639 642f 6d6f 6465 6c73 2f6d  a1f4f9d/models/m
+00006090: 6564 2e70 7923 4c35 3731 0a63 6c61 7373  ed.py#L571.class
+000060a0: 2042 6c69 7054 6578 744d 6f64 656c 2842   BlipTextModel(B
+000060b0: 6c69 7054 6578 7450 7265 5472 6169 6e65  lipTextPreTraine
+000060c0: 644d 6f64 656c 293a 0a20 2020 2022 2222  dModel):.    """
+000060d0: 0a20 2020 2054 6865 206d 6f64 656c 2063  .    The model c
+000060e0: 616e 2062 6568 6176 6520 6173 2061 6e20  an behave as an 
+000060f0: 656e 636f 6465 7220 2877 6974 6820 6f6e  encoder (with on
+00006100: 6c79 2073 656c 662d 6174 7465 6e74 696f  ly self-attentio
+00006110: 6e29 2061 7320 7765 6c6c 2061 7320 6120  n) as well as a 
+00006120: 6465 636f 6465 722c 2069 6e20 7768 6963  decoder, in whic
+00006130: 6820 6361 7365 2061 206c 6179 6572 206f  h case a layer o
+00006140: 660a 2020 2020 6372 6f73 732d 6174 7465  f.    cross-atte
+00006150: 6e74 696f 6e20 6973 2061 6464 6564 2062  ntion is added b
+00006160: 6574 7765 656e 2074 6865 2073 656c 662d  etween the self-
+00006170: 6174 7465 6e74 696f 6e20 6c61 7965 7273  attention layers
+00006180: 2c20 666f 6c6c 6f77 696e 6720 7468 6520  , following the 
+00006190: 6172 6368 6974 6563 7475 7265 2064 6573  architecture des
+000061a0: 6372 6962 6564 2069 6e20 5b41 7474 656e  cribed in [Atten
+000061b0: 7469 6f6e 2069 730a 2020 2020 616c 6c20  tion is.    all 
+000061c0: 796f 7520 6e65 6564 5d28 6874 7470 733a  you need](https:
+000061d0: 2f2f 6172 7869 762e 6f72 672f 6162 732f  //arxiv.org/abs/
+000061e0: 3137 3036 2e30 3337 3632 2920 6279 2041  1706.03762) by A
+000061f0: 7368 6973 6820 5661 7377 616e 692c 204e  shish Vaswani, N
+00006200: 6f61 6d20 5368 617a 6565 722c 204e 696b  oam Shazeer, Nik
+00006210: 6920 5061 726d 6172 2c20 4a61 6b6f 6220  i Parmar, Jakob 
+00006220: 5573 7a6b 6f72 6569 742c 0a20 2020 204c  Uszkoreit,.    L
+00006230: 6c69 6f6e 204a 6f6e 6573 2c20 4169 6461  lion Jones, Aida
+00006240: 6e20 4e2e 2047 6f6d 657a 2c20 4c75 6b61  n N. Gomez, Luka
+00006250: 737a 204b 6169 7365 7220 616e 6420 496c  sz Kaiser and Il
+00006260: 6c69 6120 506f 6c6f 7375 6b68 696e 2e20  lia Polosukhin. 
+00006270: 6172 6775 6d65 6e74 2061 6e64 2060 6973  argument and `is
+00006280: 5f64 6563 6f64 6572 6020 7365 7420 746f  _decoder` set to
+00006290: 2060 5472 7565 603b 2061 6e0a 2020 2020   `True`; an.    
+000062a0: 6065 6e63 6f64 6572 5f68 6964 6465 6e5f  `encoder_hidden_
+000062b0: 7374 6174 6573 6020 6973 2074 6865 6e20  states` is then 
+000062c0: 6578 7065 6374 6564 2061 7320 616e 2069  expected as an i
+000062d0: 6e70 7574 2074 6f20 7468 6520 666f 7277  nput to the forw
+000062e0: 6172 6420 7061 7373 2e0a 2020 2020 2222  ard pass..    ""
+000062f0: 220a 0a20 2020 2064 6566 205f 5f69 6e69  "..    def __ini
+00006300: 745f 5f28 7365 6c66 2c20 636f 6e66 6967  t__(self, config
+00006310: 2c20 6164 645f 706f 6f6c 696e 675f 6c61  , add_pooling_la
+00006320: 7965 723d 5472 7565 293a 0a20 2020 2020  yer=True):.     
+00006330: 2020 2073 7570 6572 2829 2e5f 5f69 6e69     super().__ini
+00006340: 745f 5f28 636f 6e66 6967 290a 2020 2020  t__(config).    
+00006350: 2020 2020 7365 6c66 2e63 6f6e 6669 6720      self.config 
+00006360: 3d20 636f 6e66 6967 0a0a 2020 2020 2020  = config..      
+00006370: 2020 7365 6c66 2e65 6d62 6564 6469 6e67    self.embedding
+00006380: 7320 3d20 426c 6970 5465 7874 456d 6265  s = BlipTextEmbe
+00006390: 6464 696e 6773 2863 6f6e 6669 6729 0a20  ddings(config). 
+000063a0: 2020 2020 2020 2073 656c 662e 656e 636f         self.enco
+000063b0: 6465 7220 3d20 426c 6970 5465 7874 456e  der = BlipTextEn
+000063c0: 636f 6465 7228 636f 6e66 6967 290a 2020  coder(config).  
+000063d0: 2020 2020 2020 7365 6c66 2e70 6f6f 6c65        self.poole
+000063e0: 7220 3d20 426c 6970 5465 7874 506f 6f6c  r = BlipTextPool
+000063f0: 6572 2863 6f6e 6669 6729 2069 6620 6164  er(config) if ad
+00006400: 645f 706f 6f6c 696e 675f 6c61 7965 7220  d_pooling_layer 
+00006410: 656c 7365 204e 6f6e 650a 0a20 2020 2020  else None..     
+00006420: 2020 2073 656c 662e 706f 7374 5f69 6e69     self.post_ini
+00006430: 7428 290a 0a20 2020 2064 6566 2067 6574  t()..    def get
+00006440: 5f69 6e70 7574 5f65 6d62 6564 6469 6e67  _input_embedding
+00006450: 7328 7365 6c66 293a 0a20 2020 2020 2020  s(self):.       
+00006460: 2072 6574 7572 6e20 7365 6c66 2e65 6d62   return self.emb
+00006470: 6564 6469 6e67 732e 776f 7264 5f65 6d62  eddings.word_emb
+00006480: 6564 6469 6e67 730a 0a20 2020 2064 6566  eddings..    def
+00006490: 2073 6574 5f69 6e70 7574 5f65 6d62 6564   set_input_embed
+000064a0: 6469 6e67 7328 7365 6c66 2c20 7661 6c75  dings(self, valu
+000064b0: 6529 3a0a 2020 2020 2020 2020 7365 6c66  e):.        self
+000064c0: 2e65 6d62 6564 6469 6e67 732e 776f 7264  .embeddings.word
+000064d0: 5f65 6d62 6564 6469 6e67 7320 3d20 7661  _embeddings = va
+000064e0: 6c75 650a 0a20 2020 2023 2043 6f70 6965  lue..    # Copie
+000064f0: 6420 6672 6f6d 2074 7261 6e73 666f 726d  d from transform
+00006500: 6572 732e 6d6f 6465 6c73 2e62 6572 742e  ers.models.bert.
+00006510: 6d6f 6465 6c69 6e67 5f62 6572 742e 4265  modeling_bert.Be
+00006520: 7274 4d6f 6465 6c2e 5f70 7275 6e65 5f68  rtModel._prune_h
+00006530: 6561 6473 0a20 2020 2064 6566 205f 7072  eads.    def _pr
+00006540: 756e 655f 6865 6164 7328 7365 6c66 2c20  une_heads(self, 
+00006550: 6865 6164 735f 746f 5f70 7275 6e65 293a  heads_to_prune):
+00006560: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00006570: 2020 2020 2050 7275 6e65 7320 6865 6164       Prunes head
+00006580: 7320 6f66 2074 6865 206d 6f64 656c 2e20  s of the model. 
+00006590: 6865 6164 735f 746f 5f70 7275 6e65 3a20  heads_to_prune: 
+000065a0: 6469 6374 206f 6620 7b6c 6179 6572 5f6e  dict of {layer_n
+000065b0: 756d 3a20 6c69 7374 206f 6620 6865 6164  um: list of head
+000065c0: 7320 746f 2070 7275 6e65 2069 6e20 7468  s to prune in th
+000065d0: 6973 206c 6179 6572 7d20 5365 6520 6261  is layer} See ba
+000065e0: 7365 0a20 2020 2020 2020 2063 6c61 7373  se.        class
+000065f0: 2050 7265 5472 6169 6e65 644d 6f64 656c   PreTrainedModel
+00006600: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00006610: 2020 2020 2066 6f72 206c 6179 6572 2c20       for layer, 
+00006620: 6865 6164 7320 696e 2068 6561 6473 5f74  heads in heads_t
+00006630: 6f5f 7072 756e 652e 6974 656d 7328 293a  o_prune.items():
+00006640: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00006650: 662e 656e 636f 6465 722e 6c61 7965 725b  f.encoder.layer[
+00006660: 6c61 7965 725d 2e61 7474 656e 7469 6f6e  layer].attention
+00006670: 2e70 7275 6e65 5f68 6561 6473 2868 6561  .prune_heads(hea
+00006680: 6473 290a 0a20 2020 2064 6566 2067 6574  ds)..    def get
+00006690: 5f65 7874 656e 6465 645f 6174 7465 6e74  _extended_attent
+000066a0: 696f 6e5f 6d61 736b 280a 2020 2020 2020  ion_mask(.      
+000066b0: 2020 7365 6c66 2c20 6174 7465 6e74 696f    self, attentio
+000066c0: 6e5f 6d61 736b 3a20 6d69 6e64 7370 6f72  n_mask: mindspor
+000066d0: 652e 5465 6e73 6f72 2c20 696e 7075 745f  e.Tensor, input_
+000066e0: 7368 6170 653a 2054 7570 6c65 5b69 6e74  shape: Tuple[int
+000066f0: 5d2c 2069 735f 6465 636f 6465 723a 2062  ], is_decoder: b
+00006700: 6f6f 6c0a 2020 2020 2920 2d3e 206d 696e  ool.    ) -> min
+00006710: 6473 706f 7265 2e54 656e 736f 723a 0a20  dspore.Tensor:. 
+00006720: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00006730: 2020 204d 616b 6573 2062 726f 6164 6361     Makes broadca
+00006740: 7374 6162 6c65 2061 7474 656e 7469 6f6e  stable attention
+00006750: 2061 6e64 2063 6175 7361 6c20 6d61 736b   and causal mask
+00006760: 7320 736f 2074 6861 7420 6675 7475 7265  s so that future
+00006770: 2061 6e64 206d 6173 6b65 6420 746f 6b65   and masked toke
+00006780: 6e73 2061 7265 2069 676e 6f72 6564 2e0a  ns are ignored..
+00006790: 0a20 2020 2020 2020 2041 7267 756d 656e  .        Argumen
+000067a0: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+000067b0: 6174 7465 6e74 696f 6e5f 6d61 736b 2028  attention_mask (
+000067c0: 606d 696e 6473 706f 7265 2e54 656e 736f  `mindspore.Tenso
+000067d0: 7260 293a 0a20 2020 2020 2020 2020 2020  r`):.           
+000067e0: 2020 2020 204d 6173 6b20 7769 7468 206f       Mask with o
+000067f0: 6e65 7320 696e 6469 6361 7469 6e67 2074  nes indicating t
+00006800: 6f6b 656e 7320 746f 2061 7474 656e 6420  okens to attend 
+00006810: 746f 2c20 7a65 726f 7320 666f 7220 746f  to, zeros for to
+00006820: 6b65 6e73 2074 6f20 6967 6e6f 7265 2e0a  kens to ignore..
+00006830: 2020 2020 2020 2020 2020 2020 696e 7075              inpu
+00006840: 745f 7368 6170 6520 2860 5475 706c 655b  t_shape (`Tuple[
+00006850: 696e 745d 6029 3a0a 2020 2020 2020 2020  int]`):.        
+00006860: 2020 2020 2020 2020 5468 6520 7368 6170          The shap
+00006870: 6520 6f66 2074 6865 2069 6e70 7574 2074  e of the input t
+00006880: 6f20 7468 6520 6d6f 6465 6c2e 0a0a 2020  o the model...  
+00006890: 2020 2020 2020 5265 7475 726e 733a 0a20        Returns:. 
+000068a0: 2020 2020 2020 2020 2020 2060 6d69 6e64             `mind
+000068b0: 7370 6f72 652e 5465 6e73 6f72 6020 5468  spore.Tensor` Th
+000068c0: 6520 6578 7465 6e64 6564 2061 7474 656e  e extended atten
+000068d0: 7469 6f6e 206d 6173 6b2c 2077 6974 6820  tion mask, with 
+000068e0: 6120 7468 6520 7361 6d65 2064 7479 7065  a the same dtype
+000068f0: 2061 7320 6061 7474 656e 7469 6f6e 5f6d   as `attention_m
+00006900: 6173 6b2e 6474 7970 6560 2e0a 2020 2020  ask.dtype`..    
+00006910: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00006920: 2320 5765 2063 616e 2070 726f 7669 6465  # We can provide
+00006930: 2061 2073 656c 662d 6174 7465 6e74 696f   a self-attentio
+00006940: 6e20 6d61 736b 206f 6620 6469 6d65 6e73  n mask of dimens
+00006950: 696f 6e73 205b 6261 7463 685f 7369 7a65  ions [batch_size
+00006960: 2c20 6672 6f6d 5f73 6571 5f6c 656e 6774  , from_seq_lengt
+00006970: 682c 2074 6f5f 7365 715f 6c65 6e67 7468  h, to_seq_length
+00006980: 5d0a 2020 2020 2020 2020 2320 6f75 7273  ].        # ours
+00006990: 656c 7665 7320 696e 2077 6869 6368 2063  elves in which c
+000069a0: 6173 6520 7765 206a 7573 7420 6e65 6564  ase we just need
+000069b0: 2074 6f20 6d61 6b65 2069 7420 6272 6f61   to make it broa
+000069c0: 6463 6173 7461 626c 6520 746f 2061 6c6c  dcastable to all
+000069d0: 2068 6561 6473 2e0a 2020 2020 2020 2020   heads..        
+000069e0: 6966 2061 7474 656e 7469 6f6e 5f6d 6173  if attention_mas
+000069f0: 6b2e 6e64 696d 203d 3d20 333a 0a20 2020  k.ndim == 3:.   
+00006a00: 2020 2020 2020 2020 2065 7874 656e 6465           extende
+00006a10: 645f 6174 7465 6e74 696f 6e5f 6d61 736b  d_attention_mask
+00006a20: 203d 2061 7474 656e 7469 6f6e 5f6d 6173   = attention_mas
+00006a30: 6b5b 3a2c 204e 6f6e 652c 203a 2c20 3a5d  k[:, None, :, :]
+00006a40: 0a20 2020 2020 2020 2065 6c69 6620 6174  .        elif at
+00006a50: 7465 6e74 696f 6e5f 6d61 736b 2e6e 6469  tention_mask.ndi
+00006a60: 6d20 3d3d 2032 3a0a 2020 2020 2020 2020  m == 2:.        
+00006a70: 2020 2020 2320 5072 6f76 6964 6564 2061      # Provided a
+00006a80: 2070 6164 6469 6e67 206d 6173 6b20 6f66   padding mask of
+00006a90: 2064 696d 656e 7369 6f6e 7320 5b62 6174   dimensions [bat
+00006aa0: 6368 5f73 697a 652c 2073 6571 5f6c 656e  ch_size, seq_len
+00006ab0: 6774 685d 0a20 2020 2020 2020 2020 2020  gth].           
+00006ac0: 2023 202d 2069 6620 7468 6520 6d6f 6465   # - if the mode
+00006ad0: 6c20 6973 2061 2064 6563 6f64 6572 2c20  l is a decoder, 
+00006ae0: 6170 706c 7920 6120 6361 7573 616c 206d  apply a causal m
+00006af0: 6173 6b20 696e 2061 6464 6974 696f 6e20  ask in addition 
+00006b00: 746f 2074 6865 2070 6164 6469 6e67 206d  to the padding m
+00006b10: 6173 6b0a 2020 2020 2020 2020 2020 2020  ask.            
+00006b20: 2320 2d20 6966 2074 6865 206d 6f64 656c  # - if the model
+00006b30: 2069 7320 616e 2065 6e63 6f64 6572 2c20   is an encoder, 
+00006b40: 6d61 6b65 2074 6865 206d 6173 6b20 6272  make the mask br
+00006b50: 6f61 6463 6173 7461 626c 6520 746f 205b  oadcastable to [
+00006b60: 6261 7463 685f 7369 7a65 2c20 6e75 6d5f  batch_size, num_
+00006b70: 6865 6164 732c 2073 6571 5f6c 656e 6774  heads, seq_lengt
+00006b80: 682c 2073 6571 5f6c 656e 6774 685d 0a20  h, seq_length]. 
+00006b90: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+00006ba0: 5f64 6563 6f64 6572 3a0a 2020 2020 2020  _decoder:.      
+00006bb0: 2020 2020 2020 2020 2020 6261 7463 685f            batch_
+00006bc0: 7369 7a65 2c20 7365 715f 6c65 6e67 7468  size, seq_length
+00006bd0: 203d 2069 6e70 7574 5f73 6861 7065 0a0a   = input_shape..
+00006be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006bf0: 7365 715f 6964 7320 3d20 6f70 732e 6172  seq_ids = ops.ar
+00006c00: 616e 6765 2873 6571 5f6c 656e 6774 6829  ange(seq_length)
+00006c10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006c20: 2063 6175 7361 6c5f 6d61 736b 203d 2073   causal_mask = s
+00006c30: 6571 5f69 6473 5b4e 6f6e 652c 204e 6f6e  eq_ids[None, Non
+00006c40: 652c 203a 5d2e 7265 7065 6174 2862 6174  e, :].repeat(bat
+00006c50: 6368 5f73 697a 652c 2073 6571 5f6c 656e  ch_size, seq_len
+00006c60: 6774 682c 2031 2920 3c3d 2073 6571 5f69  gth, 1) <= seq_i
+00006c70: 6473 5b4e 6f6e 652c 203a 2c20 4e6f 6e65  ds[None, :, None
+00006c80: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00006c90: 2020 2320 696e 2063 6173 6520 7061 7374    # in case past
+00006ca0: 5f6b 6579 5f76 616c 7565 7320 6172 6520  _key_values are 
+00006cb0: 7573 6564 2077 6520 6e65 6564 2074 6f20  used we need to 
+00006cc0: 6164 6420 6120 7072 6566 6978 206f 6e65  add a prefix one
+00006cd0: 7320 6d61 736b 2074 6f20 7468 6520 6361  s mask to the ca
+00006ce0: 7573 616c 206d 6173 6b0a 2020 2020 2020  usal mask.      
+00006cf0: 2020 2020 2020 2020 2020 2320 6361 7573            # caus
+00006d00: 616c 2061 6e64 2061 7474 656e 7469 6f6e  al and attention
+00006d10: 206d 6173 6b73 206d 7573 7420 6861 7665   masks must have
+00006d20: 2073 616d 6520 7479 7065 2077 6974 6820   same type with 
+00006d30: 7079 746f 7263 6820 7665 7273 696f 6e20  pytorch version 
+00006d40: 3c20 312e 330a 2020 2020 2020 2020 2020  < 1.3.          
+00006d50: 2020 2020 2020 6361 7573 616c 5f6d 6173        causal_mas
+00006d60: 6b20 3d20 6361 7573 616c 5f6d 6173 6b2e  k = causal_mask.
+00006d70: 746f 2861 7474 656e 7469 6f6e 5f6d 6173  to(attention_mas
+00006d80: 6b2e 6474 7970 6529 0a0a 2020 2020 2020  k.dtype)..      
+00006d90: 2020 2020 2020 2020 2020 6966 2063 6175            if cau
+00006da0: 7361 6c5f 6d61 736b 2e73 6861 7065 5b31  sal_mask.shape[1
+00006db0: 5d20 3c20 6174 7465 6e74 696f 6e5f 6d61  ] < attention_ma
+00006dc0: 736b 2e73 6861 7065 5b31 5d3a 0a20 2020  sk.shape[1]:.   
+00006dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006de0: 2070 7265 6669 785f 7365 715f 6c65 6e20   prefix_seq_len 
+00006df0: 3d20 6174 7465 6e74 696f 6e5f 6d61 736b  = attention_mask
+00006e00: 2e73 6861 7065 5b31 5d20 2d20 6361 7573  .shape[1] - caus
+00006e10: 616c 5f6d 6173 6b2e 7368 6170 655b 315d  al_mask.shape[1]
+00006e20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006e30: 2020 2020 2063 6175 7361 6c5f 6d61 736b       causal_mask
+00006e40: 203d 206f 7073 2e63 6174 280a 2020 2020   = ops.cat(.    
+00006e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006e60: 2020 2020 5b0a 2020 2020 2020 2020 2020      [.          
+00006e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006e80: 2020 6f70 732e 6f6e 6573 280a 2020 2020    ops.ones(.    
+00006e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006ea0: 2020 2020 2020 2020 2020 2020 2862 6174              (bat
+00006eb0: 6368 5f73 697a 652c 2073 6571 5f6c 656e  ch_size, seq_len
+00006ec0: 6774 682c 2070 7265 6669 785f 7365 715f  gth, prefix_seq_
+00006ed0: 6c65 6e29 2c20 6474 7970 653d 6361 7573  len), dtype=caus
+00006ee0: 616c 5f6d 6173 6b2e 6474 7970 650a 2020  al_mask.dtype.  
+00006ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006f00: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
+00006f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006f20: 2020 2020 2020 2020 2063 6175 7361 6c5f           causal_
+00006f30: 6d61 736b 2c0a 2020 2020 2020 2020 2020  mask,.          
+00006f40: 2020 2020 2020 2020 2020 2020 2020 5d2c                ],
+00006f50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006f60: 2020 2020 2020 2020 2061 7869 733d 2d31           axis=-1
+00006f70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00006f80: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00006f90: 2020 2020 2020 2020 2065 7874 656e 6465           extende
+00006fa0: 645f 6174 7465 6e74 696f 6e5f 6d61 736b  d_attention_mask
+00006fb0: 203d 2063 6175 7361 6c5f 6d61 736b 5b3a   = causal_mask[:
+00006fc0: 2c20 4e6f 6e65 2c20 3a2c 203a 5d20 2a20  , None, :, :] * 
+00006fd0: 6174 7465 6e74 696f 6e5f 6d61 736b 5b3a  attention_mask[:
+00006fe0: 2c20 4e6f 6e65 2c20 4e6f 6e65 2c20 3a5d  , None, None, :]
+00006ff0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00007000: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00007010: 2020 2065 7874 656e 6465 645f 6174 7465     extended_atte
+00007020: 6e74 696f 6e5f 6d61 736b 203d 2061 7474  ntion_mask = att
+00007030: 656e 7469 6f6e 5f6d 6173 6b5b 3a2c 204e  ention_mask[:, N
+00007040: 6f6e 652c 204e 6f6e 652c 203a 5d0a 2020  one, None, :].  
+00007050: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00007060: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
+00007070: 6c75 6545 7272 6f72 280a 2020 2020 2020  lueError(.      
+00007080: 2020 2020 2020 2020 2020 2257 726f 6e67            "Wrong
+00007090: 2073 6861 7065 2066 6f72 2069 6e70 7574   shape for input
+000070a0: 5f69 6473 2028 7368 6170 6520 7b7d 2920  _ids (shape {}) 
+000070b0: 6f72 2061 7474 656e 7469 6f6e 5f6d 6173  or attention_mas
+000070c0: 6b20 2873 6861 7065 207b 7d29 222e 666f  k (shape {})".fo
+000070d0: 726d 6174 280a 2020 2020 2020 2020 2020  rmat(.          
+000070e0: 2020 2020 2020 2020 2020 696e 7075 745f            input_
+000070f0: 7368 6170 652c 2061 7474 656e 7469 6f6e  shape, attention
+00007100: 5f6d 6173 6b2e 7368 6170 650a 2020 2020  _mask.shape.    
+00007110: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00007120: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+00007130: 2020 2020 2023 2053 696e 6365 2061 7474       # Since att
+00007140: 656e 7469 6f6e 5f6d 6173 6b20 6973 2031  ention_mask is 1
+00007150: 2e30 2066 6f72 2070 6f73 6974 696f 6e73  .0 for positions
+00007160: 2077 6520 7761 6e74 2074 6f20 6174 7465   we want to atte
+00007170: 6e64 2061 6e64 2030 2e30 2066 6f72 0a20  nd and 0.0 for. 
+00007180: 2020 2020 2020 2023 206d 6173 6b65 6420         # masked 
+00007190: 706f 7369 7469 6f6e 732c 2074 6869 7320  positions, this 
+000071a0: 6f70 6572 6174 696f 6e20 7769 6c6c 2063  operation will c
+000071b0: 7265 6174 6520 6120 7465 6e73 6f72 2077  reate a tensor w
+000071c0: 6869 6368 2069 7320 302e 3020 666f 720a  hich is 0.0 for.
+000071d0: 2020 2020 2020 2020 2320 706f 7369 7469          # positi
+000071e0: 6f6e 7320 7765 2077 616e 7420 746f 2061  ons we want to a
+000071f0: 7474 656e 6420 616e 6420 2d31 3030 3030  ttend and -10000
+00007200: 2e30 2066 6f72 206d 6173 6b65 6420 706f  .0 for masked po
+00007210: 7369 7469 6f6e 732e 0a20 2020 2020 2020  sitions..       
+00007220: 2023 2053 696e 6365 2077 6520 6172 6520   # Since we are 
+00007230: 6164 6469 6e67 2069 7420 746f 2074 6865  adding it to the
+00007240: 2072 6177 2073 636f 7265 7320 6265 666f   raw scores befo
+00007250: 7265 2074 6865 2073 6f66 746d 6178 2c20  re the softmax, 
+00007260: 7468 6973 2069 730a 2020 2020 2020 2020  this is.        
+00007270: 2320 6566 6665 6374 6976 656c 7920 7468  # effectively th
+00007280: 6520 7361 6d65 2061 7320 7265 6d6f 7669  e same as removi
+00007290: 6e67 2074 6865 7365 2065 6e74 6972 656c  ng these entirel
+000072a0: 792e 0a20 2020 2020 2020 2065 7874 656e  y..        exten
+000072b0: 6465 645f 6174 7465 6e74 696f 6e5f 6d61  ded_attention_ma
+000072c0: 736b 203d 2065 7874 656e 6465 645f 6174  sk = extended_at
+000072d0: 7465 6e74 696f 6e5f 6d61 736b 2e74 6f28  tention_mask.to(
+000072e0: 6474 7970 653d 7365 6c66 2e64 7479 7065  dtype=self.dtype
+000072f0: 2920 2023 2066 7031 3620 636f 6d70 6174  )  # fp16 compat
+00007300: 6962 696c 6974 790a 2020 2020 2020 2020  ibility.        
+00007310: 6578 7465 6e64 6564 5f61 7474 656e 7469  extended_attenti
+00007320: 6f6e 5f6d 6173 6b20 3d20 2831 2e30 202d  on_mask = (1.0 -
+00007330: 2065 7874 656e 6465 645f 6174 7465 6e74   extended_attent
+00007340: 696f 6e5f 6d61 736b 2920 2a20 2d31 3030  ion_mask) * -100
+00007350: 3030 2e30 0a20 2020 2020 2020 2072 6574  00.0.        ret
+00007360: 7572 6e20 6578 7465 6e64 6564 5f61 7474  urn extended_att
+00007370: 656e 7469 6f6e 5f6d 6173 6b0a 0a20 2020  ention_mask..   
+00007380: 2064 6566 2063 6f6e 7374 7275 6374 280a   def construct(.
+00007390: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+000073a0: 2020 2020 2020 696e 7075 745f 6964 733a        input_ids:
+000073b0: 204f 7074 696f 6e61 6c5b 6d69 6e64 7370   Optional[mindsp
+000073c0: 6f72 652e 5465 6e73 6f72 5d20 3d20 4e6f  ore.Tensor] = No
+000073d0: 6e65 2c0a 2020 2020 2020 2020 6174 7465  ne,.        atte
+000073e0: 6e74 696f 6e5f 6d61 736b 3a20 4f70 7469  ntion_mask: Opti
+000073f0: 6f6e 616c 5b6d 696e 6473 706f 7265 2e54  onal[mindspore.T
+00007400: 656e 736f 725d 203d 204e 6f6e 652c 0a20  ensor] = None,. 
+00007410: 2020 2020 2020 2070 6f73 6974 696f 6e5f         position_
+00007420: 6964 733a 204f 7074 696f 6e61 6c5b 6d69  ids: Optional[mi
+00007430: 6e64 7370 6f72 652e 5465 6e73 6f72 5d20  ndspore.Tensor] 
+00007440: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00007450: 6865 6164 5f6d 6173 6b3a 204f 7074 696f  head_mask: Optio
+00007460: 6e61 6c5b 6d69 6e64 7370 6f72 652e 5465  nal[mindspore.Te
+00007470: 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a 2020  nsor] = None,.  
+00007480: 2020 2020 2020 696e 7075 7473 5f65 6d62        inputs_emb
+00007490: 6564 733a 204f 7074 696f 6e61 6c5b 6d69  eds: Optional[mi
+000074a0: 6e64 7370 6f72 652e 5465 6e73 6f72 5d20  ndspore.Tensor] 
+000074b0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+000074c0: 656e 636f 6465 725f 656d 6265 6473 3a20  encoder_embeds: 
+000074d0: 4f70 7469 6f6e 616c 5b6d 696e 6473 706f  Optional[mindspo
+000074e0: 7265 2e54 656e 736f 725d 203d 204e 6f6e  re.Tensor] = Non
+000074f0: 652c 0a20 2020 2020 2020 2065 6e63 6f64  e,.        encod
+00007500: 6572 5f68 6964 6465 6e5f 7374 6174 6573  er_hidden_states
+00007510: 3a20 4f70 7469 6f6e 616c 5b6d 696e 6473  : Optional[minds
+00007520: 706f 7265 2e54 656e 736f 725d 203d 204e  pore.Tensor] = N
+00007530: 6f6e 652c 0a20 2020 2020 2020 2065 6e63  one,.        enc
+00007540: 6f64 6572 5f61 7474 656e 7469 6f6e 5f6d  oder_attention_m
+00007550: 6173 6b3a 204f 7074 696f 6e61 6c5b 6d69  ask: Optional[mi
+00007560: 6e64 7370 6f72 652e 5465 6e73 6f72 5d20  ndspore.Tensor] 
+00007570: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00007580: 7061 7374 5f6b 6579 5f76 616c 7565 733a  past_key_values:
+00007590: 204f 7074 696f 6e61 6c5b 4c69 7374 5b6d   Optional[List[m
+000075a0: 696e 6473 706f 7265 2e54 656e 736f 725d  indspore.Tensor]
+000075b0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+000075c0: 2020 7573 655f 6361 6368 653a 204f 7074    use_cache: Opt
+000075d0: 696f 6e61 6c5b 626f 6f6c 5d20 3d20 4e6f  ional[bool] = No
+000075e0: 6e65 2c0a 2020 2020 2020 2020 6f75 7470  ne,.        outp
+000075f0: 7574 5f61 7474 656e 7469 6f6e 733a 204f  ut_attentions: O
+00007600: 7074 696f 6e61 6c5b 626f 6f6c 5d20 3d20  ptional[bool] = 
+00007610: 4e6f 6e65 2c0a 2020 2020 2020 2020 6f75  None,.        ou
+00007620: 7470 7574 5f68 6964 6465 6e5f 7374 6174  tput_hidden_stat
+00007630: 6573 3a20 4f70 7469 6f6e 616c 5b62 6f6f  es: Optional[boo
+00007640: 6c5d 203d 204e 6f6e 652c 0a20 2020 2020  l] = None,.     
+00007650: 2020 2072 6574 7572 6e5f 6469 6374 3a20     return_dict: 
+00007660: 4f70 7469 6f6e 616c 5b62 6f6f 6c5d 203d  Optional[bool] =
+00007670: 204e 6f6e 652c 0a20 2020 2020 2020 2069   None,.        i
+00007680: 735f 6465 636f 6465 723a 204f 7074 696f  s_decoder: Optio
+00007690: 6e61 6c5b 626f 6f6c 5d20 3d20 4661 6c73  nal[bool] = Fals
+000076a0: 652c 0a20 2020 2029 202d 3e20 556e 696f  e,.    ) -> Unio
+000076b0: 6e5b 5475 706c 655b 6d69 6e64 7370 6f72  n[Tuple[mindspor
+000076c0: 652e 5465 6e73 6f72 5d2c 2042 6173 654d  e.Tensor], BaseM
+000076d0: 6f64 656c 4f75 7470 7574 5769 7468 506f  odelOutputWithPo
+000076e0: 6f6c 696e 6741 6e64 4372 6f73 7341 7474  olingAndCrossAtt
+000076f0: 656e 7469 6f6e 735d 3a0a 2020 2020 2020  entions]:.      
+00007700: 2020 7222 2222 0a20 2020 2020 2020 2065    r""".        e
+00007710: 6e63 6f64 6572 5f68 6964 6465 6e5f 7374  ncoder_hidden_st
+00007720: 6174 6573 2020 2860 6d69 6e64 7370 6f72  ates  (`mindspor
+00007730: 652e 5465 6e73 6f72 602c 202a 6f70 7469  e.Tensor`, *opti
+00007740: 6f6e 616c 2a29 3a0a 2020 2020 2020 2020  onal*):.        
+00007750: 2020 2020 5365 7175 656e 6365 206f 6620      Sequence of 
+00007760: 6869 6464 656e 2d73 7461 7465 7320 6174  hidden-states at
+00007770: 2074 6865 206f 7574 7075 7420 6f66 2074   the output of t
+00007780: 6865 206c 6173 7420 6c61 7965 7220 6f66  he last layer of
+00007790: 2074 6865 2065 6e63 6f64 6572 2e20 5573   the encoder. Us
+000077a0: 6564 2069 6e20 7468 6520 6372 6f73 732d  ed in the cross-
+000077b0: 6174 7465 6e74 696f 6e20 6966 0a20 2020  attention if.   
+000077c0: 2020 2020 2020 2020 2074 6865 206d 6f64           the mod
+000077d0: 656c 2069 7320 636f 6e66 6967 7572 6564  el is configured
+000077e0: 2061 7320 6120 6465 636f 6465 722e 0a20   as a decoder.. 
+000077f0: 2020 2020 2020 2065 6e63 6f64 6572 5f61         encoder_a
+00007800: 7474 656e 7469 6f6e 5f6d 6173 6b20 2860  ttention_mask (`
+00007810: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+00007820: 602c 202a 6f70 7469 6f6e 616c 2a29 3a0a  `, *optional*):.
+00007830: 2020 2020 2020 2020 2020 2020 4d61 736b              Mask
+00007840: 2074 6f20 6176 6f69 6420 7065 7266 6f72   to avoid perfor
+00007850: 6d69 6e67 2061 7474 656e 7469 6f6e 206f  ming attention o
+00007860: 6e20 7468 6520 7061 6464 696e 6720 746f  n the padding to
+00007870: 6b65 6e20 696e 6469 6365 7320 6f66 2074  ken indices of t
+00007880: 6865 2065 6e63 6f64 6572 2069 6e70 7574  he encoder input
+00007890: 2e20 5468 6973 206d 6173 6b20 6973 2075  . This mask is u
+000078a0: 7365 6420 696e 0a20 2020 2020 2020 2020  sed in.         
+000078b0: 2020 2074 6865 2063 726f 7373 2d61 7474     the cross-att
+000078c0: 656e 7469 6f6e 2069 6620 7468 6520 6d6f  ention if the mo
+000078d0: 6465 6c20 6973 2063 6f6e 6669 6775 7265  del is configure
+000078e0: 6420 6173 2061 2064 6563 6f64 6572 2e20  d as a decoder. 
+000078f0: 4d61 736b 2076 616c 7565 7320 7365 6c65  Mask values sele
+00007900: 6374 6564 2069 6e20 605b 302c 2031 5d60  cted in `[0, 1]`
+00007910: 3a0a 2020 2020 2020 2020 2020 2020 2d20  :.            - 
+00007920: 3120 666f 7220 746f 6b65 6e73 2074 6861  1 for tokens tha
+00007930: 7420 6172 6520 2a2a 6e6f 7420 6d61 736b  t are **not mask
+00007940: 6564 2a2a 2c0a 2020 2020 2020 2020 2020  ed**,.          
+00007950: 2020 2d20 3020 666f 7220 746f 6b65 6e73    - 0 for tokens
+00007960: 2074 6861 7420 6172 6520 2a2a 6d61 736b   that are **mask
+00007970: 6564 2a2a 2e0a 2020 2020 2020 2020 7061  ed**..        pa
+00007980: 7374 5f6b 6579 5f76 616c 7565 7320 2860  st_key_values (`
+00007990: 7475 706c 6528 7475 706c 6528 6d69 6e64  tuple(tuple(mind
+000079a0: 7370 6f72 652e 5465 6e73 6f72 2929 602c  spore.Tensor))`,
+000079b0: 202a 6f70 7469 6f6e 616c 2a29 3a0a 2020   *optional*):.  
+000079c0: 2020 2020 2020 2020 2020 436f 6e74 6169            Contai
+000079d0: 6e73 2070 7265 636f 6d70 7574 6564 206b  ns precomputed k
+000079e0: 6579 2061 6e64 2076 616c 7565 2068 6964  ey and value hid
+000079f0: 6465 6e20 7374 6174 6573 206f 6620 7468  den states of th
+00007a00: 6520 6174 7465 6e74 696f 6e20 626c 6f63  e attention bloc
+00007a10: 6b73 2e20 4361 6e20 6265 2075 7365 6420  ks. Can be used 
+00007a20: 746f 2073 7065 6564 2075 7020 6465 636f  to speed up deco
+00007a30: 6469 6e67 2e0a 2020 2020 2020 2020 2020  ding..          
+00007a40: 2020 4966 2060 7061 7374 5f6b 6579 5f76    If `past_key_v
+00007a50: 616c 7565 7360 2061 7265 2075 7365 642c  alues` are used,
+00007a60: 2074 6865 2075 7365 7220 6361 6e20 6f70   the user can op
+00007a70: 7469 6f6e 616c 6c79 2069 6e70 7574 206f  tionally input o
+00007a80: 6e6c 7920 7468 6520 6c61 7374 2060 6465  nly the last `de
+00007a90: 636f 6465 725f 696e 7075 745f 6964 7360  coder_input_ids`
+00007aa0: 2028 7468 6f73 6520 7468 6174 0a20 2020   (those that.   
+00007ab0: 2020 2020 2020 2020 2064 6f6e 2774 2068           don't h
+00007ac0: 6176 6520 7468 6569 7220 7061 7374 206b  ave their past k
+00007ad0: 6579 2076 616c 7565 2073 7461 7465 7320  ey value states 
+00007ae0: 6769 7665 6e20 746f 2074 6869 7320 6d6f  given to this mo
+00007af0: 6465 6c29 206f 6620 7368 6170 6520 6028  del) of shape `(
+00007b00: 6261 7463 685f 7369 7a65 2c20 3129 6020  batch_size, 1)` 
+00007b10: 696e 7374 6561 6420 6f66 2061 6c6c 0a20  instead of all. 
+00007b20: 2020 2020 2020 2020 2020 2060 6465 636f             `deco
+00007b30: 6465 725f 696e 7075 745f 6964 7360 206f  der_input_ids` o
+00007b40: 6620 7368 6170 6520 6028 6261 7463 685f  f shape `(batch_
+00007b50: 7369 7a65 2c20 7365 7175 656e 6365 5f6c  size, sequence_l
+00007b60: 656e 6774 6829 602e 0a20 2020 2020 2020  ength)`..       
+00007b70: 2075 7365 5f63 6163 6865 2028 6062 6f6f   use_cache (`boo
+00007b80: 6c60 2c20 2a6f 7074 696f 6e61 6c2a 293a  l`, *optional*):
+00007b90: 0a20 2020 2020 2020 2020 2020 2049 6620  .            If 
+00007ba0: 7365 7420 746f 2060 5472 7565 602c 2060  set to `True`, `
+00007bb0: 7061 7374 5f6b 6579 5f76 616c 7565 7360  past_key_values`
+00007bc0: 206b 6579 2076 616c 7565 2073 7461 7465   key value state
+00007bd0: 7320 6172 6520 7265 7475 726e 6564 2061  s are returned a
+00007be0: 6e64 2063 616e 2062 6520 7573 6564 2074  nd can be used t
+00007bf0: 6f20 7370 6565 6420 7570 2064 6563 6f64  o speed up decod
+00007c00: 696e 6720 2873 6565 0a20 2020 2020 2020  ing (see.       
+00007c10: 2020 2020 2060 7061 7374 5f6b 6579 5f76       `past_key_v
+00007c20: 616c 7565 7360 292e 0a20 2020 2020 2020  alues`)..       
+00007c30: 2022 2222 0a20 2020 2020 2020 206f 7574   """.        out
+00007c40: 7075 745f 6174 7465 6e74 696f 6e73 203d  put_attentions =
+00007c50: 206f 7574 7075 745f 6174 7465 6e74 696f   output_attentio
+00007c60: 6e73 2069 6620 6f75 7470 7574 5f61 7474  ns if output_att
+00007c70: 656e 7469 6f6e 7320 6973 206e 6f74 204e  entions is not N
+00007c80: 6f6e 6520 656c 7365 2073 656c 662e 636f  one else self.co
+00007c90: 6e66 6967 2e6f 7574 7075 745f 6174 7465  nfig.output_atte
+00007ca0: 6e74 696f 6e73 0a20 2020 2020 2020 206f  ntions.        o
+00007cb0: 7574 7075 745f 6869 6464 656e 5f73 7461  utput_hidden_sta
+00007cc0: 7465 7320 3d20 280a 2020 2020 2020 2020  tes = (.        
+00007cd0: 2020 2020 6f75 7470 7574 5f68 6964 6465      output_hidde
+00007ce0: 6e5f 7374 6174 6573 2069 6620 6f75 7470  n_states if outp
+00007cf0: 7574 5f68 6964 6465 6e5f 7374 6174 6573  ut_hidden_states
+00007d00: 2069 7320 6e6f 7420 4e6f 6e65 2065 6c73   is not None els
+00007d10: 6520 7365 6c66 2e63 6f6e 6669 672e 6f75  e self.config.ou
+00007d20: 7470 7574 5f68 6964 6465 6e5f 7374 6174  tput_hidden_stat
+00007d30: 6573 0a20 2020 2020 2020 2029 0a20 2020  es.        ).   
+00007d40: 2020 2020 2072 6574 7572 6e5f 6469 6374       return_dict
+00007d50: 203d 2072 6574 7572 6e5f 6469 6374 2069   = return_dict i
+00007d60: 6620 7265 7475 726e 5f64 6963 7420 6973  f return_dict is
+00007d70: 206e 6f74 204e 6f6e 6520 656c 7365 2073   not None else s
+00007d80: 656c 662e 636f 6e66 6967 2e75 7365 5f72  elf.config.use_r
+00007d90: 6574 7572 6e5f 6469 6374 0a0a 2020 2020  eturn_dict..    
+00007da0: 2020 2020 6966 2069 735f 6465 636f 6465      if is_decode
+00007db0: 723a 0a20 2020 2020 2020 2020 2020 2075  r:.            u
+00007dc0: 7365 5f63 6163 6865 203d 2075 7365 5f63  se_cache = use_c
+00007dd0: 6163 6865 2069 6620 7573 655f 6361 6368  ache if use_cach
+00007de0: 6520 6973 206e 6f74 204e 6f6e 6520 656c  e is not None el
+00007df0: 7365 2073 656c 662e 636f 6e66 6967 2e75  se self.config.u
+00007e00: 7365 5f63 6163 6865 0a20 2020 2020 2020  se_cache.       
+00007e10: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00007e20: 2020 2075 7365 5f63 6163 6865 203d 2046     use_cache = F
+00007e30: 616c 7365 0a0a 2020 2020 2020 2020 6966  alse..        if
+00007e40: 2069 6e70 7574 5f69 6473 2069 7320 6e6f   input_ids is no
+00007e50: 7420 4e6f 6e65 2061 6e64 2069 6e70 7574  t None and input
+00007e60: 735f 656d 6265 6473 2069 7320 6e6f 7420  s_embeds is not 
+00007e70: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00007e80: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+00007e90: 6f72 2822 596f 7520 6361 6e6e 6f74 2073  or("You cannot s
+00007ea0: 7065 6369 6679 2062 6f74 6820 696e 7075  pecify both inpu
+00007eb0: 745f 6964 7320 616e 6420 696e 7075 7473  t_ids and inputs
+00007ec0: 5f65 6d62 6564 7320 6174 2074 6865 2073  _embeds at the s
+00007ed0: 616d 6520 7469 6d65 2229 0a20 2020 2020  ame time").     
+00007ee0: 2020 2065 6c69 6620 696e 7075 745f 6964     elif input_id
+00007ef0: 7320 6973 206e 6f74 204e 6f6e 653a 0a20  s is not None:. 
+00007f00: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00007f10: 7761 726e 5f69 665f 7061 6464 696e 675f  warn_if_padding_
+00007f20: 616e 645f 6e6f 5f61 7474 656e 7469 6f6e  and_no_attention
+00007f30: 5f6d 6173 6b28 696e 7075 745f 6964 732c  _mask(input_ids,
+00007f40: 2061 7474 656e 7469 6f6e 5f6d 6173 6b29   attention_mask)
+00007f50: 0a20 2020 2020 2020 2020 2020 2069 6e70  .            inp
+00007f60: 7574 5f73 6861 7065 203d 2069 6e70 7574  ut_shape = input
+00007f70: 5f69 6473 2e73 6861 7065 0a20 2020 2020  _ids.shape.     
+00007f80: 2020 2020 2020 2062 6174 6368 5f73 697a         batch_siz
+00007f90: 652c 2073 6571 5f6c 656e 6774 6820 3d20  e, seq_length = 
+00007fa0: 696e 7075 745f 7368 6170 650a 2020 2020  input_shape.    
+00007fb0: 2020 2020 656c 6966 2069 6e70 7574 735f      elif inputs_
+00007fc0: 656d 6265 6473 2069 7320 6e6f 7420 4e6f  embeds is not No
+00007fd0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00007fe0: 696e 7075 745f 7368 6170 6520 3d20 696e  input_shape = in
+00007ff0: 7075 7473 5f65 6d62 6564 732e 7368 6170  puts_embeds.shap
+00008000: 655b 3a2d 315d 0a20 2020 2020 2020 2020  e[:-1].         
+00008010: 2020 2062 6174 6368 5f73 697a 652c 2073     batch_size, s
+00008020: 6571 5f6c 656e 6774 6820 3d20 696e 7075  eq_length = inpu
+00008030: 745f 7368 6170 650a 2020 2020 2020 2020  t_shape.        
+00008040: 656c 6966 2065 6e63 6f64 6572 5f65 6d62  elif encoder_emb
+00008050: 6564 7320 6973 206e 6f74 204e 6f6e 653a  eds is not None:
+00008060: 0a20 2020 2020 2020 2020 2020 2069 6e70  .            inp
+00008070: 7574 5f73 6861 7065 203d 2065 6e63 6f64  ut_shape = encod
+00008080: 6572 5f65 6d62 6564 732e 7368 6170 655b  er_embeds.shape[
+00008090: 3a2d 315d 0a20 2020 2020 2020 2020 2020  :-1].           
+000080a0: 2062 6174 6368 5f73 697a 652c 2073 6571   batch_size, seq
+000080b0: 5f6c 656e 6774 6820 3d20 696e 7075 745f  _length = input_
+000080c0: 7368 6170 650a 2020 2020 2020 2020 656c  shape.        el
+000080d0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000080e0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+000080f0: 2822 596f 7520 6861 7665 2074 6f20 7370  ("You have to sp
+00008100: 6563 6966 7920 6569 7468 6572 2069 6e70  ecify either inp
+00008110: 7574 5f69 6473 206f 7220 696e 7075 7473  ut_ids or inputs
+00008120: 5f65 6d62 6564 7320 6f72 2065 6e63 6f64  _embeds or encod
+00008130: 6572 5f65 6d62 6564 7322 290a 0a20 2020  er_embeds")..   
+00008140: 2020 2020 2023 2070 6173 745f 6b65 795f       # past_key_
+00008150: 7661 6c75 6573 5f6c 656e 6774 680a 2020  values_length.  
+00008160: 2020 2020 2020 7061 7374 5f6b 6579 5f76        past_key_v
+00008170: 616c 7565 735f 6c65 6e67 7468 203d 2070  alues_length = p
+00008180: 6173 745f 6b65 795f 7661 6c75 6573 5b30  ast_key_values[0
+00008190: 5d5b 305d 2e73 6861 7065 5b32 5d20 6966  ][0].shape[2] if
+000081a0: 2070 6173 745f 6b65 795f 7661 6c75 6573   past_key_values
+000081b0: 2069 7320 6e6f 7420 4e6f 6e65 2065 6c73   is not None els
+000081c0: 6520 300a 0a20 2020 2020 2020 2069 6620  e 0..        if 
+000081d0: 6174 7465 6e74 696f 6e5f 6d61 736b 2069  attention_mask i
+000081e0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+000081f0: 2020 2020 6174 7465 6e74 696f 6e5f 6d61      attention_ma
+00008200: 736b 203d 206f 7073 2e6f 6e65 7328 2828  sk = ops.ones(((
+00008210: 6261 7463 685f 7369 7a65 2c20 7365 715f  batch_size, seq_
+00008220: 6c65 6e67 7468 202b 2070 6173 745f 6b65  length + past_ke
+00008230: 795f 7661 6c75 6573 5f6c 656e 6774 6829  y_values_length)
+00008240: 2929 0a0a 2020 2020 2020 2020 2320 5765  ))..        # We
+00008250: 2063 616e 2070 726f 7669 6465 2061 2073   can provide a s
+00008260: 656c 662d 6174 7465 6e74 696f 6e20 6d61  elf-attention ma
+00008270: 736b 206f 6620 6469 6d65 6e73 696f 6e73  sk of dimensions
+00008280: 205b 6261 7463 685f 7369 7a65 2c20 6672   [batch_size, fr
+00008290: 6f6d 5f73 6571 5f6c 656e 6774 682c 2074  om_seq_length, t
+000082a0: 6f5f 7365 715f 6c65 6e67 7468 5d0a 2020  o_seq_length].  
+000082b0: 2020 2020 2020 2320 6f75 7273 656c 7665        # ourselve
+000082c0: 7320 696e 2077 6869 6368 2063 6173 6520  s in which case 
+000082d0: 7765 206a 7573 7420 6e65 6564 2074 6f20  we just need to 
+000082e0: 6d61 6b65 2069 7420 6272 6f61 6463 6173  make it broadcas
+000082f0: 7461 626c 6520 746f 2061 6c6c 2068 6561  table to all hea
+00008300: 6473 2e0a 2020 2020 2020 2020 6578 7465  ds..        exte
+00008310: 6e64 6564 5f61 7474 656e 7469 6f6e 5f6d  nded_attention_m
+00008320: 6173 6b3a 206d 696e 6473 706f 7265 2e54  ask: mindspore.T
+00008330: 656e 736f 7220 3d20 7365 6c66 2e67 6574  ensor = self.get
+00008340: 5f65 7874 656e 6465 645f 6174 7465 6e74  _extended_attent
+00008350: 696f 6e5f 6d61 736b 280a 2020 2020 2020  ion_mask(.      
+00008360: 2020 2020 2020 6174 7465 6e74 696f 6e5f        attention_
+00008370: 6d61 736b 2c20 696e 7075 745f 7368 6170  mask, input_shap
+00008380: 652c 2069 735f 6465 636f 6465 720a 2020  e, is_decoder.  
+00008390: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+000083a0: 2023 2049 6620 6120 3244 206f 7220 3344   # If a 2D or 3D
+000083b0: 2061 7474 656e 7469 6f6e 206d 6173 6b20   attention mask 
+000083c0: 6973 2070 726f 7669 6465 6420 666f 7220  is provided for 
+000083d0: 7468 6520 6372 6f73 732d 6174 7465 6e74  the cross-attent
+000083e0: 696f 6e0a 2020 2020 2020 2020 2320 7765  ion.        # we
+000083f0: 206e 6565 6420 746f 206d 616b 6520 6272   need to make br
+00008400: 6f61 6463 6173 7461 626c 6520 746f 205b  oadcastable to [
+00008410: 6261 7463 685f 7369 7a65 2c20 6e75 6d5f  batch_size, num_
+00008420: 6865 6164 732c 2073 6571 5f6c 656e 6774  heads, seq_lengt
+00008430: 682c 2073 6571 5f6c 656e 6774 685d 0a20  h, seq_length]. 
+00008440: 2020 2020 2020 2069 6620 656e 636f 6465         if encode
+00008450: 725f 6869 6464 656e 5f73 7461 7465 7320  r_hidden_states 
+00008460: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00008470: 2020 2020 2020 2020 2069 6620 6973 696e           if isin
+00008480: 7374 616e 6365 2865 6e63 6f64 6572 5f68  stance(encoder_h
+00008490: 6964 6465 6e5f 7374 6174 6573 2c20 6c69  idden_states, li
+000084a0: 7374 293a 0a20 2020 2020 2020 2020 2020  st):.           
+000084b0: 2020 2020 2065 6e63 6f64 6572 5f62 6174       encoder_bat
+000084c0: 6368 5f73 697a 652c 2065 6e63 6f64 6572  ch_size, encoder
+000084d0: 5f73 6571 7565 6e63 655f 6c65 6e67 7468  _sequence_length
+000084e0: 2c20 5f20 3d20 656e 636f 6465 725f 6869  , _ = encoder_hi
+000084f0: 6464 656e 5f73 7461 7465 735b 305d 2e73  dden_states[0].s
+00008500: 6861 7065 0a20 2020 2020 2020 2020 2020  hape.           
+00008510: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00008520: 2020 2020 2020 2065 6e63 6f64 6572 5f62         encoder_b
+00008530: 6174 6368 5f73 697a 652c 2065 6e63 6f64  atch_size, encod
+00008540: 6572 5f73 6571 7565 6e63 655f 6c65 6e67  er_sequence_leng
+00008550: 7468 2c20 5f20 3d20 656e 636f 6465 725f  th, _ = encoder_
+00008560: 6869 6464 656e 5f73 7461 7465 732e 7368  hidden_states.sh
+00008570: 6170 650a 2020 2020 2020 2020 2020 2020  ape.            
+00008580: 656e 636f 6465 725f 6869 6464 656e 5f73  encoder_hidden_s
+00008590: 6861 7065 203d 2028 656e 636f 6465 725f  hape = (encoder_
+000085a0: 6261 7463 685f 7369 7a65 2c20 656e 636f  batch_size, enco
+000085b0: 6465 725f 7365 7175 656e 6365 5f6c 656e  der_sequence_len
+000085c0: 6774 6829 0a0a 2020 2020 2020 2020 2020  gth)..          
+000085d0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+000085e0: 656e 636f 6465 725f 6174 7465 6e74 696f  encoder_attentio
+000085f0: 6e5f 6d61 736b 2c20 6c69 7374 293a 0a20  n_mask, list):. 
+00008600: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00008610: 6e63 6f64 6572 5f65 7874 656e 6465 645f  ncoder_extended_
+00008620: 6174 7465 6e74 696f 6e5f 6d61 736b 203d  attention_mask =
+00008630: 205b 7365 6c66 2e69 6e76 6572 745f 6174   [self.invert_at
+00008640: 7465 6e74 696f 6e5f 6d61 736b 286d 6173  tention_mask(mas
+00008650: 6b29 2066 6f72 206d 6173 6b20 696e 2065  k) for mask in e
+00008660: 6e63 6f64 6572 5f61 7474 656e 7469 6f6e  ncoder_attention
+00008670: 5f6d 6173 6b5d 0a20 2020 2020 2020 2020  _mask].         
+00008680: 2020 2065 6c69 6620 656e 636f 6465 725f     elif encoder_
+00008690: 6174 7465 6e74 696f 6e5f 6d61 736b 2069  attention_mask i
+000086a0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+000086b0: 2020 2020 2020 2020 656e 636f 6465 725f          encoder_
+000086c0: 6174 7465 6e74 696f 6e5f 6d61 736b 203d  attention_mask =
+000086d0: 206f 7073 2e6f 6e65 7328 656e 636f 6465   ops.ones(encode
+000086e0: 725f 6869 6464 656e 5f73 6861 7065 290a  r_hidden_shape).
+000086f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008700: 656e 636f 6465 725f 6578 7465 6e64 6564  encoder_extended
+00008710: 5f61 7474 656e 7469 6f6e 5f6d 6173 6b20  _attention_mask 
+00008720: 3d20 7365 6c66 2e69 6e76 6572 745f 6174  = self.invert_at
+00008730: 7465 6e74 696f 6e5f 6d61 736b 2865 6e63  tention_mask(enc
+00008740: 6f64 6572 5f61 7474 656e 7469 6f6e 5f6d  oder_attention_m
+00008750: 6173 6b29 0a20 2020 2020 2020 2020 2020  ask).           
+00008760: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00008770: 2020 2020 2020 2065 6e63 6f64 6572 5f65         encoder_e
+00008780: 7874 656e 6465 645f 6174 7465 6e74 696f  xtended_attentio
+00008790: 6e5f 6d61 736b 203d 2073 656c 662e 696e  n_mask = self.in
+000087a0: 7665 7274 5f61 7474 656e 7469 6f6e 5f6d  vert_attention_m
+000087b0: 6173 6b28 656e 636f 6465 725f 6174 7465  ask(encoder_atte
+000087c0: 6e74 696f 6e5f 6d61 736b 290a 2020 2020  ntion_mask).    
+000087d0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000087e0: 2020 2020 2020 656e 636f 6465 725f 6578        encoder_ex
+000087f0: 7465 6e64 6564 5f61 7474 656e 7469 6f6e  tended_attention
+00008800: 5f6d 6173 6b20 3d20 4e6f 6e65 0a0a 2020  _mask = None..  
+00008810: 2020 2020 2020 2320 5072 6570 6172 6520        # Prepare 
+00008820: 6865 6164 206d 6173 6b20 6966 206e 6565  head mask if nee
+00008830: 6465 640a 2020 2020 2020 2020 2320 312e  ded.        # 1.
+00008840: 3020 696e 2068 6561 645f 6d61 736b 2069  0 in head_mask i
+00008850: 6e64 6963 6174 6520 7765 206b 6565 7020  ndicate we keep 
+00008860: 7468 6520 6865 6164 0a20 2020 2020 2020  the head.       
+00008870: 2023 2061 7474 656e 7469 6f6e 5f70 726f   # attention_pro
+00008880: 6273 2068 6173 2073 6861 7065 2062 737a  bs has shape bsz
+00008890: 2078 206e 5f68 6561 6473 2078 204e 2078   x n_heads x N x
+000088a0: 204e 0a20 2020 2020 2020 2023 2069 6e70   N.        # inp
+000088b0: 7574 2068 6561 645f 6d61 736b 2068 6173  ut head_mask has
+000088c0: 2073 6861 7065 205b 6e75 6d5f 6865 6164   shape [num_head
+000088d0: 735d 206f 7220 5b6e 756d 5f68 6964 6465  s] or [num_hidde
+000088e0: 6e5f 6c61 7965 7273 2078 206e 756d 5f68  n_layers x num_h
+000088f0: 6561 6473 5d0a 2020 2020 2020 2020 2320  eads].        # 
+00008900: 616e 6420 6865 6164 5f6d 6173 6b20 6973  and head_mask is
+00008910: 2063 6f6e 7665 7274 6564 2074 6f20 7368   converted to sh
+00008920: 6170 6520 5b6e 756d 5f68 6964 6465 6e5f  ape [num_hidden_
+00008930: 6c61 7965 7273 2078 2062 6174 6368 2078  layers x batch x
+00008940: 206e 756d 5f68 6561 6473 2078 2073 6571   num_heads x seq
+00008950: 5f6c 656e 6774 6820 7820 7365 715f 6c65  _length x seq_le
+00008960: 6e67 7468 5d0a 2020 2020 2020 2020 6865  ngth].        he
+00008970: 6164 5f6d 6173 6b20 3d20 7365 6c66 2e67  ad_mask = self.g
+00008980: 6574 5f68 6561 645f 6d61 736b 2868 6561  et_head_mask(hea
+00008990: 645f 6d61 736b 2c20 7365 6c66 2e63 6f6e  d_mask, self.con
+000089a0: 6669 672e 6e75 6d5f 6869 6464 656e 5f6c  fig.num_hidden_l
+000089b0: 6179 6572 7329 0a0a 2020 2020 2020 2020  ayers)..        
+000089c0: 6966 2065 6e63 6f64 6572 5f65 6d62 6564  if encoder_embed
+000089d0: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
+000089e0: 2020 2020 2020 2065 6d62 6564 6469 6e67         embedding
+000089f0: 5f6f 7574 7075 7420 3d20 7365 6c66 2e65  _output = self.e
+00008a00: 6d62 6564 6469 6e67 7328 0a20 2020 2020  mbeddings(.     
+00008a10: 2020 2020 2020 2020 2020 2069 6e70 7574             input
+00008a20: 5f69 6473 3d69 6e70 7574 5f69 6473 2c0a  _ids=input_ids,.
+00008a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008a40: 706f 7369 7469 6f6e 5f69 6473 3d70 6f73  position_ids=pos
+00008a50: 6974 696f 6e5f 6964 732c 0a20 2020 2020  ition_ids,.     
+00008a60: 2020 2020 2020 2020 2020 2069 6e70 7574             input
+00008a70: 735f 656d 6265 6473 3d69 6e70 7574 735f  s_embeds=inputs_
+00008a80: 656d 6265 6473 2c0a 2020 2020 2020 2020  embeds,.        
+00008a90: 2020 2020 2020 2020 7061 7374 5f6b 6579          past_key
+00008aa0: 5f76 616c 7565 735f 6c65 6e67 7468 3d70  _values_length=p
+00008ab0: 6173 745f 6b65 795f 7661 6c75 6573 5f6c  ast_key_values_l
+00008ac0: 656e 6774 682c 0a20 2020 2020 2020 2020  ength,.         
+00008ad0: 2020 2029 0a20 2020 2020 2020 2065 6c73     ).        els
+00008ae0: 653a 0a20 2020 2020 2020 2020 2020 2065  e:.            e
+00008af0: 6d62 6564 6469 6e67 5f6f 7574 7075 7420  mbedding_output 
+00008b00: 3d20 656e 636f 6465 725f 656d 6265 6473  = encoder_embeds
+00008b10: 0a0a 2020 2020 2020 2020 656e 636f 6465  ..        encode
+00008b20: 725f 6f75 7470 7574 7320 3d20 7365 6c66  r_outputs = self
+00008b30: 2e65 6e63 6f64 6572 280a 2020 2020 2020  .encoder(.      
+00008b40: 2020 2020 2020 656d 6265 6464 696e 675f        embedding_
+00008b50: 6f75 7470 7574 2c0a 2020 2020 2020 2020  output,.        
+00008b60: 2020 2020 6174 7465 6e74 696f 6e5f 6d61      attention_ma
+00008b70: 736b 3d65 7874 656e 6465 645f 6174 7465  sk=extended_atte
+00008b80: 6e74 696f 6e5f 6d61 736b 2c0a 2020 2020  ntion_mask,.    
+00008b90: 2020 2020 2020 2020 6865 6164 5f6d 6173          head_mas
+00008ba0: 6b3d 6865 6164 5f6d 6173 6b2c 0a20 2020  k=head_mask,.   
+00008bb0: 2020 2020 2020 2020 2065 6e63 6f64 6572           encoder
+00008bc0: 5f68 6964 6465 6e5f 7374 6174 6573 3d65  _hidden_states=e
+00008bd0: 6e63 6f64 6572 5f68 6964 6465 6e5f 7374  ncoder_hidden_st
+00008be0: 6174 6573 2c0a 2020 2020 2020 2020 2020  ates,.          
+00008bf0: 2020 656e 636f 6465 725f 6174 7465 6e74    encoder_attent
+00008c00: 696f 6e5f 6d61 736b 3d65 6e63 6f64 6572  ion_mask=encoder
+00008c10: 5f65 7874 656e 6465 645f 6174 7465 6e74  _extended_attent
+00008c20: 696f 6e5f 6d61 736b 2c0a 2020 2020 2020  ion_mask,.      
+00008c30: 2020 2020 2020 7061 7374 5f6b 6579 5f76        past_key_v
+00008c40: 616c 7565 733d 7061 7374 5f6b 6579 5f76  alues=past_key_v
+00008c50: 616c 7565 732c 0a20 2020 2020 2020 2020  alues,.         
+00008c60: 2020 2075 7365 5f63 6163 6865 3d75 7365     use_cache=use
+00008c70: 5f63 6163 6865 2c0a 2020 2020 2020 2020  _cache,.        
+00008c80: 2020 2020 6f75 7470 7574 5f61 7474 656e      output_atten
+00008c90: 7469 6f6e 733d 6f75 7470 7574 5f61 7474  tions=output_att
+00008ca0: 656e 7469 6f6e 732c 0a20 2020 2020 2020  entions,.       
+00008cb0: 2020 2020 206f 7574 7075 745f 6869 6464       output_hidd
+00008cc0: 656e 5f73 7461 7465 733d 6f75 7470 7574  en_states=output
+00008cd0: 5f68 6964 6465 6e5f 7374 6174 6573 2c0a  _hidden_states,.
+00008ce0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00008cf0: 726e 5f64 6963 743d 7265 7475 726e 5f64  rn_dict=return_d
+00008d00: 6963 742c 0a20 2020 2020 2020 2029 0a20  ict,.        ). 
+00008d10: 2020 2020 2020 2073 6571 7565 6e63 655f         sequence_
+00008d20: 6f75 7470 7574 203d 2065 6e63 6f64 6572  output = encoder
+00008d30: 5f6f 7574 7075 7473 5b30 5d0a 2020 2020  _outputs[0].    
+00008d40: 2020 2020 706f 6f6c 6564 5f6f 7574 7075      pooled_outpu
+00008d50: 7420 3d20 7365 6c66 2e70 6f6f 6c65 7228  t = self.pooler(
+00008d60: 7365 7175 656e 6365 5f6f 7574 7075 7429  sequence_output)
+00008d70: 2069 6620 7365 6c66 2e70 6f6f 6c65 7220   if self.pooler 
+00008d80: 6973 206e 6f74 204e 6f6e 6520 656c 7365  is not None else
+00008d90: 204e 6f6e 650a 0a20 2020 2020 2020 2069   None..        i
+00008da0: 6620 6e6f 7420 7265 7475 726e 5f64 6963  f not return_dic
+00008db0: 743a 0a20 2020 2020 2020 2020 2020 2072  t:.            r
+00008dc0: 6574 7572 6e20 2873 6571 7565 6e63 655f  eturn (sequence_
+00008dd0: 6f75 7470 7574 2c20 706f 6f6c 6564 5f6f  output, pooled_o
+00008de0: 7574 7075 7429 202b 2065 6e63 6f64 6572  utput) + encoder
+00008df0: 5f6f 7574 7075 7473 5b31 3a5d 0a0a 2020  _outputs[1:]..  
+00008e00: 2020 2020 2020 7265 7475 726e 2042 6173        return Bas
+00008e10: 654d 6f64 656c 4f75 7470 7574 5769 7468  eModelOutputWith
+00008e20: 506f 6f6c 696e 6741 6e64 4372 6f73 7341  PoolingAndCrossA
+00008e30: 7474 656e 7469 6f6e 7328 0a20 2020 2020  ttentions(.     
+00008e40: 2020 2020 2020 206c 6173 745f 6869 6464         last_hidd
+00008e50: 656e 5f73 7461 7465 3d73 6571 7565 6e63  en_state=sequenc
+00008e60: 655f 6f75 7470 7574 2c0a 2020 2020 2020  e_output,.      
+00008e70: 2020 2020 2020 706f 6f6c 6572 5f6f 7574        pooler_out
+00008e80: 7075 743d 706f 6f6c 6564 5f6f 7574 7075  put=pooled_outpu
+00008e90: 742c 0a20 2020 2020 2020 2020 2020 2070  t,.            p
+00008ea0: 6173 745f 6b65 795f 7661 6c75 6573 3d65  ast_key_values=e
+00008eb0: 6e63 6f64 6572 5f6f 7574 7075 7473 2e70  ncoder_outputs.p
+00008ec0: 6173 745f 6b65 795f 7661 6c75 6573 2c0a  ast_key_values,.
+00008ed0: 2020 2020 2020 2020 2020 2020 6869 6464              hidd
+00008ee0: 656e 5f73 7461 7465 733d 656e 636f 6465  en_states=encode
+00008ef0: 725f 6f75 7470 7574 732e 6869 6464 656e  r_outputs.hidden
+00008f00: 5f73 7461 7465 732c 0a20 2020 2020 2020  _states,.       
+00008f10: 2020 2020 2061 7474 656e 7469 6f6e 733d       attentions=
+00008f20: 656e 636f 6465 725f 6f75 7470 7574 732e  encoder_outputs.
+00008f30: 6174 7465 6e74 696f 6e73 2c0a 2020 2020  attentions,.    
+00008f40: 2020 2020 2020 2020 6372 6f73 735f 6174          cross_at
+00008f50: 7465 6e74 696f 6e73 3d65 6e63 6f64 6572  tentions=encoder
+00008f60: 5f6f 7574 7075 7473 2e63 726f 7373 5f61  _outputs.cross_a
+00008f70: 7474 656e 7469 6f6e 732c 0a20 2020 2020  ttentions,.     
+00008f80: 2020 2029 0a0a 0a23 2041 6461 7074 6564     )...# Adapted
+00008f90: 2066 726f 6d20 6874 7470 733a 2f2f 6769   from https://gi
+00008fa0: 7468 7562 2e63 6f6d 2f73 616c 6573 666f  thub.com/salesfo
+00008fb0: 7263 652f 424c 4950 2f62 6c6f 622f 6d61  rce/BLIP/blob/ma
+00008fc0: 696e 2f6d 6f64 656c 732f 6d65 642e 7079  in/models/med.py
+00008fd0: 234c 3831 310a 636c 6173 7320 426c 6970  #L811.class Blip
+00008fe0: 5465 7874 4c4d 4865 6164 4d6f 6465 6c28  TextLMHeadModel(
+00008ff0: 426c 6970 5465 7874 5072 6554 7261 696e  BlipTextPreTrain
+00009000: 6564 4d6f 6465 6c29 3a0a 2020 2020 6465  edModel):.    de
+00009010: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
+00009020: 2063 6f6e 6669 6729 3a0a 2020 2020 2020   config):.      
+00009030: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
+00009040: 5f5f 2863 6f6e 6669 6729 0a0a 2020 2020  __(config)..    
+00009050: 2020 2020 7365 6c66 2e62 6572 7420 3d20      self.bert = 
+00009060: 426c 6970 5465 7874 4d6f 6465 6c28 636f  BlipTextModel(co
+00009070: 6e66 6967 2c20 6164 645f 706f 6f6c 696e  nfig, add_poolin
+00009080: 675f 6c61 7965 723d 4661 6c73 6529 0a20  g_layer=False). 
+00009090: 2020 2020 2020 2073 656c 662e 636c 7320         self.cls 
+000090a0: 3d20 426c 6970 5465 7874 4f6e 6c79 4d4c  = BlipTextOnlyML
+000090b0: 4d48 6561 6428 636f 6e66 6967 290a 2020  MHead(config).  
+000090c0: 2020 2020 2020 7365 6c66 2e6c 6162 656c        self.label
+000090d0: 5f73 6d6f 6f74 6869 6e67 203d 2063 6f6e  _smoothing = con
+000090e0: 6669 672e 6c61 6265 6c5f 736d 6f6f 7468  fig.label_smooth
+000090f0: 696e 670a 0a20 2020 2064 6566 2067 6574  ing..    def get
+00009100: 5f6f 7574 7075 745f 656d 6265 6464 696e  _output_embeddin
+00009110: 6773 2873 656c 6629 3a0a 2020 2020 2020  gs(self):.      
+00009120: 2020 7265 7475 726e 2073 656c 662e 636c    return self.cl
+00009130: 732e 7072 6564 6963 7469 6f6e 732e 6465  s.predictions.de
+00009140: 636f 6465 720a 0a20 2020 2064 6566 2073  coder..    def s
+00009150: 6574 5f6f 7574 7075 745f 656d 6265 6464  et_output_embedd
+00009160: 696e 6773 2873 656c 662c 206e 6577 5f65  ings(self, new_e
+00009170: 6d62 6564 6469 6e67 7329 3a0a 2020 2020  mbeddings):.    
+00009180: 2020 2020 7365 6c66 2e63 6c73 2e70 7265      self.cls.pre
+00009190: 6469 6374 696f 6e73 2e64 6563 6f64 6572  dictions.decoder
+000091a0: 203d 206e 6577 5f65 6d62 6564 6469 6e67   = new_embedding
+000091b0: 730a 0a20 2020 2064 6566 2063 6f6e 7374  s..    def const
+000091c0: 7275 6374 280a 2020 2020 2020 2020 7365  ruct(.        se
+000091d0: 6c66 2c0a 2020 2020 2020 2020 696e 7075  lf,.        inpu
+000091e0: 745f 6964 733a 204f 7074 696f 6e61 6c5b  t_ids: Optional[
+000091f0: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+00009200: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+00009210: 2020 6174 7465 6e74 696f 6e5f 6d61 736b    attention_mask
+00009220: 3a20 4f70 7469 6f6e 616c 5b6d 696e 6473  : Optional[minds
+00009230: 706f 7265 2e54 656e 736f 725d 203d 204e  pore.Tensor] = N
+00009240: 6f6e 652c 0a20 2020 2020 2020 2070 6f73  one,.        pos
+00009250: 6974 696f 6e5f 6964 733a 204f 7074 696f  ition_ids: Optio
+00009260: 6e61 6c5b 6d69 6e64 7370 6f72 652e 5465  nal[mindspore.Te
+00009270: 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a 2020  nsor] = None,.  
+00009280: 2020 2020 2020 6865 6164 5f6d 6173 6b3a        head_mask:
+00009290: 204f 7074 696f 6e61 6c5b 6d69 6e64 7370   Optional[mindsp
+000092a0: 6f72 652e 5465 6e73 6f72 5d20 3d20 4e6f  ore.Tensor] = No
+000092b0: 6e65 2c0a 2020 2020 2020 2020 696e 7075  ne,.        inpu
+000092c0: 7473 5f65 6d62 6564 733a 204f 7074 696f  ts_embeds: Optio
+000092d0: 6e61 6c5b 6d69 6e64 7370 6f72 652e 5465  nal[mindspore.Te
+000092e0: 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a 2020  nsor] = None,.  
+000092f0: 2020 2020 2020 656e 636f 6465 725f 6869        encoder_hi
+00009300: 6464 656e 5f73 7461 7465 733a 204f 7074  dden_states: Opt
+00009310: 696f 6e61 6c5b 6d69 6e64 7370 6f72 652e  ional[mindspore.
+00009320: 5465 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a  Tensor] = None,.
+00009330: 2020 2020 2020 2020 656e 636f 6465 725f          encoder_
+00009340: 6174 7465 6e74 696f 6e5f 6d61 736b 3a20  attention_mask: 
+00009350: 4f70 7469 6f6e 616c 5b6d 696e 6473 706f  Optional[mindspo
+00009360: 7265 2e54 656e 736f 725d 203d 204e 6f6e  re.Tensor] = Non
+00009370: 652c 0a20 2020 2020 2020 206c 6162 656c  e,.        label
+00009380: 733a 204f 7074 696f 6e61 6c5b 6d69 6e64  s: Optional[mind
+00009390: 7370 6f72 652e 5465 6e73 6f72 5d20 3d20  spore.Tensor] = 
+000093a0: 4e6f 6e65 2c0a 2020 2020 2020 2020 7061  None,.        pa
+000093b0: 7374 5f6b 6579 5f76 616c 7565 733a 204f  st_key_values: O
+000093c0: 7074 696f 6e61 6c5b 4c69 7374 5b6d 696e  ptional[List[min
+000093d0: 6473 706f 7265 2e54 656e 736f 725d 5d20  dspore.Tensor]] 
+000093e0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+000093f0: 7573 655f 6361 6368 653a 204f 7074 696f  use_cache: Optio
+00009400: 6e61 6c5b 626f 6f6c 5d20 3d20 4e6f 6e65  nal[bool] = None
+00009410: 2c0a 2020 2020 2020 2020 6f75 7470 7574  ,.        output
+00009420: 5f61 7474 656e 7469 6f6e 733a 204f 7074  _attentions: Opt
+00009430: 696f 6e61 6c5b 626f 6f6c 5d20 3d20 4e6f  ional[bool] = No
+00009440: 6e65 2c0a 2020 2020 2020 2020 6f75 7470  ne,.        outp
+00009450: 7574 5f68 6964 6465 6e5f 7374 6174 6573  ut_hidden_states
+00009460: 3a20 4f70 7469 6f6e 616c 5b62 6f6f 6c5d  : Optional[bool]
+00009470: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00009480: 2072 6574 7572 6e5f 6469 6374 3a20 4f70   return_dict: Op
+00009490: 7469 6f6e 616c 5b62 6f6f 6c5d 203d 204e  tional[bool] = N
+000094a0: 6f6e 652c 0a20 2020 2020 2020 2072 6574  one,.        ret
+000094b0: 7572 6e5f 6c6f 6769 7473 3a20 4f70 7469  urn_logits: Opti
+000094c0: 6f6e 616c 5b62 6f6f 6c5d 203d 2046 616c  onal[bool] = Fal
+000094d0: 7365 2c0a 2020 2020 2020 2020 6973 5f64  se,.        is_d
+000094e0: 6563 6f64 6572 3a20 4f70 7469 6f6e 616c  ecoder: Optional
+000094f0: 5b62 6f6f 6c5d 203d 2054 7275 652c 0a20  [bool] = True,. 
+00009500: 2020 2020 2020 2072 6564 7563 7469 6f6e         reduction
+00009510: 3a20 4f70 7469 6f6e 616c 5b73 7472 5d20  : Optional[str] 
+00009520: 3d20 226d 6561 6e22 2c0a 2020 2020 2920  = "mean",.    ) 
+00009530: 2d3e 2055 6e69 6f6e 5b54 7570 6c65 5b6d  -> Union[Tuple[m
+00009540: 696e 6473 706f 7265 2e54 656e 736f 725d  indspore.Tensor]
+00009550: 2c20 4361 7573 616c 4c4d 4f75 7470 7574  , CausalLMOutput
+00009560: 5769 7468 4372 6f73 7341 7474 656e 7469  WithCrossAttenti
+00009570: 6f6e 735d 3a0a 2020 2020 2020 2020 7222  ons]:.        r"
+00009580: 2222 0a20 2020 2020 2020 2065 6e63 6f64  "".        encod
+00009590: 6572 5f68 6964 6465 6e5f 7374 6174 6573  er_hidden_states
+000095a0: 2028 606d 696e 6473 706f 7265 2e54 656e   (`mindspore.Ten
+000095b0: 736f 7260 2c20 2a6f 7074 696f 6e61 6c2a  sor`, *optional*
+000095c0: 293a 2053 6571 7565 6e63 6520 6f66 0a20  ): Sequence of. 
+000095d0: 2020 2020 2020 2020 2020 2068 6964 6465             hidde
+000095e0: 6e2d 7374 6174 6573 2061 7420 7468 6520  n-states at the 
+000095f0: 6f75 7470 7574 206f 6620 7468 6520 6c61  output of the la
+00009600: 7374 206c 6179 6572 206f 6620 7468 6520  st layer of the 
+00009610: 656e 636f 6465 722e 2055 7365 6420 696e  encoder. Used in
+00009620: 2074 6865 2063 726f 7373 2d61 7474 656e   the cross-atten
+00009630: 7469 6f6e 2069 6620 7468 6520 6d6f 6465  tion if the mode
+00009640: 6c20 6973 0a20 2020 2020 2020 2020 2020  l is.           
+00009650: 2063 6f6e 6669 6775 7265 6420 6173 2061   configured as a
+00009660: 2064 6563 6f64 6572 2e0a 2020 2020 2020   decoder..      
+00009670: 2020 656e 636f 6465 725f 6174 7465 6e74    encoder_attent
+00009680: 696f 6e5f 6d61 736b 2028 606d 696e 6473  ion_mask (`minds
+00009690: 706f 7265 2e54 656e 736f 7260 2c20 2a6f  pore.Tensor`, *o
+000096a0: 7074 696f 6e61 6c2a 293a 0a20 2020 2020  ptional*):.     
+000096b0: 2020 2020 2020 204d 6173 6b20 746f 2061         Mask to a
+000096c0: 766f 6964 2070 6572 666f 726d 696e 6720  void performing 
+000096d0: 6174 7465 6e74 696f 6e20 6f6e 2074 6865  attention on the
+000096e0: 2070 6164 6469 6e67 2074 6f6b 656e 2069   padding token i
+000096f0: 6e64 6963 6573 206f 6620 7468 6520 656e  ndices of the en
+00009700: 636f 6465 7220 696e 7075 742e 2054 6869  coder input. Thi
+00009710: 7320 6d61 736b 2069 7320 7573 6564 2069  s mask is used i
+00009720: 6e0a 2020 2020 2020 2020 2020 2020 7468  n.            th
+00009730: 6520 6372 6f73 732d 6174 7465 6e74 696f  e cross-attentio
+00009740: 6e20 6966 2074 6865 206d 6f64 656c 2069  n if the model i
+00009750: 7320 636f 6e66 6967 7572 6564 2061 7320  s configured as 
+00009760: 6120 6465 636f 6465 722e 204d 6173 6b20  a decoder. Mask 
+00009770: 7661 6c75 6573 2073 656c 6563 7465 6420  values selected 
+00009780: 696e 2060 5b30 2c20 315d 603a 0a20 2020  in `[0, 1]`:.   
+00009790: 2020 2020 2020 2020 202d 2031 2066 6f72           - 1 for
+000097a0: 2074 6f6b 656e 7320 7468 6174 2061 7265   tokens that are
+000097b0: 202a 2a6e 6f74 206d 6173 6b65 642a 2a2c   **not masked**,
+000097c0: 0a20 2020 2020 2020 2020 2020 202d 2030  .            - 0
+000097d0: 2066 6f72 2074 6f6b 656e 7320 7468 6174   for tokens that
+000097e0: 2061 7265 202a 2a6d 6173 6b65 642a 2a2e   are **masked**.
+000097f0: 0a20 2020 2020 2020 206c 6162 656c 7320  .        labels 
+00009800: 2860 6d69 6e64 7370 6f72 652e 5465 6e73  (`mindspore.Tens
+00009810: 6f72 602c 202a 6f70 7469 6f6e 616c 2a29  or`, *optional*)
+00009820: 3a0a 2020 2020 2020 2020 2020 2020 4c61  :.            La
+00009830: 6265 6c73 2066 6f72 2063 6f6d 7075 7469  bels for computi
+00009840: 6e67 2074 6865 206c 6566 742d 746f 2d72  ng the left-to-r
+00009850: 6967 6874 206c 616e 6775 6167 6520 6d6f  ight language mo
+00009860: 6465 6c69 6e67 206c 6f73 7320 286e 6578  deling loss (nex
+00009870: 7420 776f 7264 2070 7265 6469 6374 696f  t word predictio
+00009880: 6e29 2e20 496e 6469 6365 7320 7368 6f75  n). Indices shou
+00009890: 6c64 2062 6520 696e 0a20 2020 2020 2020  ld be in.       
+000098a0: 2020 2020 2060 5b2d 3130 302c 2030 2c20       `[-100, 0, 
+000098b0: 2e2e 2e2c 2063 6f6e 6669 672e 766f 6361  ..., config.voca
+000098c0: 625f 7369 7a65 5d60 2028 7365 6520 6069  b_size]` (see `i
+000098d0: 6e70 7574 5f69 6473 6020 646f 6373 7472  nput_ids` docstr
+000098e0: 696e 6729 2054 6f6b 656e 7320 7769 7468  ing) Tokens with
+000098f0: 2069 6e64 6963 6573 2073 6574 2074 6f20   indices set to 
+00009900: 602d 3130 3060 2061 7265 0a20 2020 2020  `-100` are.     
+00009910: 2020 2020 2020 2069 676e 6f72 6564 2028         ignored (
+00009920: 6d61 736b 6564 292c 2074 6865 206c 6f73  masked), the los
+00009930: 7320 6973 206f 6e6c 7920 636f 6d70 7574  s is only comput
+00009940: 6564 2066 6f72 2074 6865 2074 6f6b 656e  ed for the token
+00009950: 7320 7769 7468 206c 6162 656c 7320 6e20  s with labels n 
+00009960: 605b 302c 202e 2e2e 2c20 636f 6e66 6967  `[0, ..., config
+00009970: 2e76 6f63 6162 5f73 697a 655d 600a 2020  .vocab_size]`.  
+00009980: 2020 2020 2020 7061 7374 5f6b 6579 5f76        past_key_v
+00009990: 616c 7565 7320 2860 7475 706c 6528 7475  alues (`tuple(tu
+000099a0: 706c 6528 6d69 6e64 7370 6f72 652e 5465  ple(mindspore.Te
+000099b0: 6e73 6f72 2929 602c 202a 6f70 7469 6f6e  nsor))`, *option
+000099c0: 616c 2a29 3a0a 2020 2020 2020 2020 2020  al*):.          
+000099d0: 2020 436f 6e74 6169 6e73 2070 7265 636f    Contains preco
+000099e0: 6d70 7574 6564 206b 6579 2061 6e64 2076  mputed key and v
+000099f0: 616c 7565 2068 6964 6465 6e20 7374 6174  alue hidden stat
+00009a00: 6573 206f 6620 7468 6520 6174 7465 6e74  es of the attent
+00009a10: 696f 6e20 626c 6f63 6b73 2e20 4361 6e20  ion blocks. Can 
+00009a20: 6265 2075 7365 6420 746f 2073 7065 6564  be used to speed
+00009a30: 2075 7020 6465 636f 6469 6e67 2e0a 2020   up decoding..  
+00009a40: 2020 2020 2020 2020 2020 4966 2060 7061            If `pa
+00009a50: 7374 5f6b 6579 5f76 616c 7565 7360 2061  st_key_values` a
+00009a60: 7265 2075 7365 642c 2074 6865 2075 7365  re used, the use
+00009a70: 7220 6361 6e20 6f70 7469 6f6e 616c 6c79  r can optionally
+00009a80: 2069 6e70 7574 206f 6e6c 7920 7468 6520   input only the 
+00009a90: 6c61 7374 2060 6465 636f 6465 725f 696e  last `decoder_in
+00009aa0: 7075 745f 6964 7360 2028 7468 6f73 6520  put_ids` (those 
+00009ab0: 7468 6174 0a20 2020 2020 2020 2020 2020  that.           
+00009ac0: 2064 6f6e 2774 2068 6176 6520 7468 6569   don't have thei
+00009ad0: 7220 7061 7374 206b 6579 2076 616c 7565  r past key value
+00009ae0: 2073 7461 7465 7320 6769 7665 6e20 746f   states given to
+00009af0: 2074 6869 7320 6d6f 6465 6c29 206f 6620   this model) of 
+00009b00: 7368 6170 6520 6028 6261 7463 685f 7369  shape `(batch_si
+00009b10: 7a65 2c20 3129 6020 696e 7374 6561 6420  ze, 1)` instead 
+00009b20: 6f66 2061 6c6c 0a20 2020 2020 2020 2020  of all.         
+00009b30: 2020 2060 6465 636f 6465 725f 696e 7075     `decoder_inpu
+00009b40: 745f 6964 7360 206f 6620 7368 6170 6520  t_ids` of shape 
+00009b50: 6028 6261 7463 685f 7369 7a65 2c20 7365  `(batch_size, se
+00009b60: 7175 656e 6365 5f6c 656e 6774 6829 602e  quence_length)`.
+00009b70: 0a20 2020 2020 2020 2075 7365 5f63 6163  .        use_cac
+00009b80: 6865 2028 6062 6f6f 6c60 2c20 2a6f 7074  he (`bool`, *opt
+00009b90: 696f 6e61 6c2a 293a 0a20 2020 2020 2020  ional*):.       
+00009ba0: 2020 2020 2049 6620 7365 7420 746f 2060       If set to `
+00009bb0: 5472 7565 602c 2060 7061 7374 5f6b 6579  True`, `past_key
+00009bc0: 5f76 616c 7565 7360 206b 6579 2076 616c  _values` key val
+00009bd0: 7565 2073 7461 7465 7320 6172 6520 7265  ue states are re
+00009be0: 7475 726e 6564 2061 6e64 2063 616e 2062  turned and can b
+00009bf0: 6520 7573 6564 2074 6f20 7370 6565 6420  e used to speed 
+00009c00: 7570 2064 6563 6f64 696e 6720 2873 6565  up decoding (see
+00009c10: 0a20 2020 2020 2020 2020 2020 2060 7061  .            `pa
+00009c20: 7374 5f6b 6579 5f76 616c 7565 7360 292e  st_key_values`).
+00009c30: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00009c40: 2020 2020 2072 6574 7572 6e5f 6469 6374       return_dict
+00009c50: 203d 2072 6574 7572 6e5f 6469 6374 2069   = return_dict i
+00009c60: 6620 7265 7475 726e 5f64 6963 7420 6973  f return_dict is
+00009c70: 206e 6f74 204e 6f6e 6520 656c 7365 2073   not None else s
+00009c80: 656c 662e 636f 6e66 6967 2e75 7365 5f72  elf.config.use_r
+00009c90: 6574 7572 6e5f 6469 6374 0a20 2020 2020  eturn_dict.     
+00009ca0: 2020 2069 6620 6c61 6265 6c73 2069 7320     if labels is 
+00009cb0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+00009cc0: 2020 2020 2020 7573 655f 6361 6368 6520        use_cache 
+00009cd0: 3d20 4661 6c73 650a 0a20 2020 2020 2020  = False..       
+00009ce0: 206f 7574 7075 7473 203d 2073 656c 662e   outputs = self.
+00009cf0: 6265 7274 280a 2020 2020 2020 2020 2020  bert(.          
+00009d00: 2020 696e 7075 745f 6964 732c 0a20 2020    input_ids,.   
+00009d10: 2020 2020 2020 2020 2061 7474 656e 7469           attenti
+00009d20: 6f6e 5f6d 6173 6b3d 6174 7465 6e74 696f  on_mask=attentio
+00009d30: 6e5f 6d61 736b 2c0a 2020 2020 2020 2020  n_mask,.        
+00009d40: 2020 2020 706f 7369 7469 6f6e 5f69 6473      position_ids
+00009d50: 3d70 6f73 6974 696f 6e5f 6964 732c 0a20  =position_ids,. 
+00009d60: 2020 2020 2020 2020 2020 2068 6561 645f             head_
+00009d70: 6d61 736b 3d68 6561 645f 6d61 736b 2c0a  mask=head_mask,.
+00009d80: 2020 2020 2020 2020 2020 2020 696e 7075              inpu
+00009d90: 7473 5f65 6d62 6564 733d 696e 7075 7473  ts_embeds=inputs
+00009da0: 5f65 6d62 6564 732c 0a20 2020 2020 2020  _embeds,.       
+00009db0: 2020 2020 2065 6e63 6f64 6572 5f68 6964       encoder_hid
+00009dc0: 6465 6e5f 7374 6174 6573 3d65 6e63 6f64  den_states=encod
+00009dd0: 6572 5f68 6964 6465 6e5f 7374 6174 6573  er_hidden_states
+00009de0: 2c0a 2020 2020 2020 2020 2020 2020 656e  ,.            en
+00009df0: 636f 6465 725f 6174 7465 6e74 696f 6e5f  coder_attention_
+00009e00: 6d61 736b 3d65 6e63 6f64 6572 5f61 7474  mask=encoder_att
+00009e10: 656e 7469 6f6e 5f6d 6173 6b2c 0a20 2020  ention_mask,.   
+00009e20: 2020 2020 2020 2020 2070 6173 745f 6b65           past_ke
+00009e30: 795f 7661 6c75 6573 3d70 6173 745f 6b65  y_values=past_ke
+00009e40: 795f 7661 6c75 6573 2c0a 2020 2020 2020  y_values,.      
+00009e50: 2020 2020 2020 7573 655f 6361 6368 653d        use_cache=
+00009e60: 7573 655f 6361 6368 652c 0a20 2020 2020  use_cache,.     
+00009e70: 2020 2020 2020 206f 7574 7075 745f 6174         output_at
+00009e80: 7465 6e74 696f 6e73 3d6f 7574 7075 745f  tentions=output_
+00009e90: 6174 7465 6e74 696f 6e73 2c0a 2020 2020  attentions,.    
+00009ea0: 2020 2020 2020 2020 6f75 7470 7574 5f68          output_h
+00009eb0: 6964 6465 6e5f 7374 6174 6573 3d6f 7574  idden_states=out
+00009ec0: 7075 745f 6869 6464 656e 5f73 7461 7465  put_hidden_state
+00009ed0: 732c 0a20 2020 2020 2020 2020 2020 2072  s,.            r
+00009ee0: 6574 7572 6e5f 6469 6374 3d72 6574 7572  eturn_dict=retur
+00009ef0: 6e5f 6469 6374 2c0a 2020 2020 2020 2020  n_dict,.        
+00009f00: 2020 2020 6973 5f64 6563 6f64 6572 3d69      is_decoder=i
+00009f10: 735f 6465 636f 6465 722c 0a20 2020 2020  s_decoder,.     
+00009f20: 2020 2029 0a0a 2020 2020 2020 2020 7365     )..        se
+00009f30: 7175 656e 6365 5f6f 7574 7075 7420 3d20  quence_output = 
+00009f40: 6f75 7470 7574 735b 305d 0a20 2020 2020  outputs[0].     
+00009f50: 2020 2070 7265 6469 6374 696f 6e5f 7363     prediction_sc
+00009f60: 6f72 6573 203d 2073 656c 662e 636c 7328  ores = self.cls(
+00009f70: 7365 7175 656e 6365 5f6f 7574 7075 7429  sequence_output)
+00009f80: 0a0a 2020 2020 2020 2020 6966 2072 6574  ..        if ret
+00009f90: 7572 6e5f 6c6f 6769 7473 3a0a 2020 2020  urn_logits:.    
+00009fa0: 2020 2020 2020 2020 7265 7475 726e 2070          return p
+00009fb0: 7265 6469 6374 696f 6e5f 7363 6f72 6573  rediction_scores
+00009fc0: 5b3a 2c20 3a2d 312c 203a 5d0a 0a20 2020  [:, :-1, :]..   
+00009fd0: 2020 2020 206c 6d5f 6c6f 7373 203d 204e       lm_loss = N
+00009fe0: 6f6e 650a 2020 2020 2020 2020 6966 206c  one.        if l
+00009ff0: 6162 656c 7320 6973 206e 6f74 204e 6f6e  abels is not Non
+0000a000: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
+0000a010: 2077 6520 6172 6520 646f 696e 6720 6e65   we are doing ne
+0000a020: 7874 2d74 6f6b 656e 2070 7265 6469 6374  xt-token predict
+0000a030: 696f 6e3b 2073 6869 6674 2070 7265 6469  ion; shift predi
+0000a040: 6374 696f 6e20 7363 6f72 6573 2061 6e64  ction scores and
+0000a050: 2069 6e70 7574 2069 6473 2062 7920 6f6e   input ids by on
+0000a060: 650a 2020 2020 2020 2020 2020 2020 7368  e.            sh
+0000a070: 6966 7465 645f 7072 6564 6963 7469 6f6e  ifted_prediction
+0000a080: 5f73 636f 7265 7320 3d20 7072 6564 6963  _scores = predic
+0000a090: 7469 6f6e 5f73 636f 7265 735b 3a2c 203a  tion_scores[:, :
+0000a0a0: 2d31 2c20 3a5d 0a20 2020 2020 2020 2020  -1, :].         
+0000a0b0: 2020 206c 6162 656c 7320 3d20 6c61 6265     labels = labe
+0000a0c0: 6c73 5b3a 2c20 313a 5d0a 2020 2020 2020  ls[:, 1:].      
+0000a0d0: 2020 2020 2020 6c6d 5f6c 6f73 7320 3d20        lm_loss = 
+0000a0e0: 6f70 732e 6372 6f73 735f 656e 7472 6f70  ops.cross_entrop
+0000a0f0: 7928 7368 6966 7465 645f 7072 6564 6963  y(shifted_predic
+0000a100: 7469 6f6e 5f73 636f 7265 732e 7669 6577  tion_scores.view
+0000a110: 282d 312c 2073 656c 662e 636f 6e66 6967  (-1, self.config
+0000a120: 2e76 6f63 6162 5f73 697a 6529 2c20 6c61  .vocab_size), la
+0000a130: 6265 6c73 2e76 6965 7728 2d31 292c 0a20  bels.view(-1),. 
+0000a140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a160: 2020 2020 2020 2072 6564 7563 7469 6f6e         reduction
+0000a170: 3d72 6564 7563 7469 6f6e 2c20 6c61 6265  =reduction, labe
+0000a180: 6c5f 736d 6f6f 7468 696e 673d 7365 6c66  l_smoothing=self
+0000a190: 2e6c 6162 656c 5f73 6d6f 6f74 6869 6e67  .label_smoothing
+0000a1a0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+0000a1b0: 2072 6564 7563 7469 6f6e 203d 3d20 226e   reduction == "n
+0000a1c0: 6f6e 6522 3a0a 2020 2020 2020 2020 2020  one":.          
+0000a1d0: 2020 2020 2020 6c6d 5f6c 6f73 7320 3d20        lm_loss = 
+0000a1e0: 6c6d 5f6c 6f73 732e 7669 6577 2870 7265  lm_loss.view(pre
+0000a1f0: 6469 6374 696f 6e5f 7363 6f72 6573 2e73  diction_scores.s
+0000a200: 6861 7065 5b30 5d2c 202d 3129 2e73 756d  hape[0], -1).sum
+0000a210: 2831 290a 0a20 2020 2020 2020 2069 6620  (1)..        if 
+0000a220: 6e6f 7420 7265 7475 726e 5f64 6963 743a  not return_dict:
+0000a230: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
+0000a240: 7075 7420 3d20 2870 7265 6469 6374 696f  put = (predictio
+0000a250: 6e5f 7363 6f72 6573 2c29 202b 206f 7574  n_scores,) + out
+0000a260: 7075 7473 5b32 3a5d 0a20 2020 2020 2020  puts[2:].       
+0000a270: 2020 2020 2072 6574 7572 6e20 2828 6c6d       return ((lm
+0000a280: 5f6c 6f73 732c 2920 2b20 6f75 7470 7574  _loss,) + output
+0000a290: 2920 6966 206c 6d5f 6c6f 7373 2069 7320  ) if lm_loss is 
+0000a2a0: 6e6f 7420 4e6f 6e65 2065 6c73 6520 6f75  not None else ou
+0000a2b0: 7470 7574 0a0a 2020 2020 2020 2020 7265  tput..        re
+0000a2c0: 7475 726e 2043 6175 7361 6c4c 4d4f 7574  turn CausalLMOut
+0000a2d0: 7075 7457 6974 6843 726f 7373 4174 7465  putWithCrossAtte
+0000a2e0: 6e74 696f 6e73 280a 2020 2020 2020 2020  ntions(.        
+0000a2f0: 2020 2020 6c6f 7373 3d6c 6d5f 6c6f 7373      loss=lm_loss
+0000a300: 2c0a 2020 2020 2020 2020 2020 2020 6c6f  ,.            lo
+0000a310: 6769 7473 3d70 7265 6469 6374 696f 6e5f  gits=prediction_
+0000a320: 7363 6f72 6573 2c0a 2020 2020 2020 2020  scores,.        
+0000a330: 2020 2020 7061 7374 5f6b 6579 5f76 616c      past_key_val
+0000a340: 7565 733d 6f75 7470 7574 732e 7061 7374  ues=outputs.past
+0000a350: 5f6b 6579 5f76 616c 7565 732c 0a20 2020  _key_values,.   
+0000a360: 2020 2020 2020 2020 2068 6964 6465 6e5f           hidden_
+0000a370: 7374 6174 6573 3d6f 7574 7075 7473 2e68  states=outputs.h
+0000a380: 6964 6465 6e5f 7374 6174 6573 2c0a 2020  idden_states,.  
+0000a390: 2020 2020 2020 2020 2020 6174 7465 6e74            attent
+0000a3a0: 696f 6e73 3d6f 7574 7075 7473 2e61 7474  ions=outputs.att
+0000a3b0: 656e 7469 6f6e 732c 0a20 2020 2020 2020  entions,.       
+0000a3c0: 2020 2020 2063 726f 7373 5f61 7474 656e       cross_atten
+0000a3d0: 7469 6f6e 733d 6f75 7470 7574 732e 6372  tions=outputs.cr
+0000a3e0: 6f73 735f 6174 7465 6e74 696f 6e73 2c0a  oss_attentions,.
+0000a3f0: 2020 2020 2020 2020 290a 0a20 2020 2064          )..    d
+0000a400: 6566 2070 7265 7061 7265 5f69 6e70 7574  ef prepare_input
+0000a410: 735f 666f 725f 6765 6e65 7261 7469 6f6e  s_for_generation
+0000a420: 2873 656c 662c 2069 6e70 7574 5f69 6473  (self, input_ids
+0000a430: 2c20 7061 7374 5f6b 6579 5f76 616c 7565  , past_key_value
+0000a440: 733d 4e6f 6e65 2c20 6174 7465 6e74 696f  s=None, attentio
+0000a450: 6e5f 6d61 736b 3d4e 6f6e 652c 202a 2a6d  n_mask=None, **m
+0000a460: 6f64 656c 5f6b 7761 7267 7329 3a0a 2020  odel_kwargs):.  
+0000a470: 2020 2020 2020 696e 7075 745f 7368 6170        input_shap
+0000a480: 6520 3d20 696e 7075 745f 6964 732e 7368  e = input_ids.sh
+0000a490: 6170 650a 2020 2020 2020 2020 2320 6966  ape.        # if
+0000a4a0: 206d 6f64 656c 2069 7320 7573 6564 2061   model is used a
+0000a4b0: 7320 6120 6465 636f 6465 7220 696e 2065  s a decoder in e
+0000a4c0: 6e63 6f64 6572 2d64 6563 6f64 6572 206d  ncoder-decoder m
+0000a4d0: 6f64 656c 2c20 7468 6520 6465 636f 6465  odel, the decode
+0000a4e0: 7220 6174 7465 6e74 696f 6e20 6d61 736b  r attention mask
+0000a4f0: 2069 7320 6372 6561 7465 6420 6f6e 2074   is created on t
+0000a500: 6865 2066 6c79 0a20 2020 2020 2020 2069  he fly.        i
+0000a510: 6620 6174 7465 6e74 696f 6e5f 6d61 736b  f attention_mask
+0000a520: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0000a530: 2020 2020 2020 6174 7465 6e74 696f 6e5f        attention_
+0000a540: 6d61 736b 203d 2069 6e70 7574 5f69 6473  mask = input_ids
+0000a550: 2e6e 6577 5f6f 6e65 7328 696e 7075 745f  .new_ones(input_
+0000a560: 7368 6170 6529 0a0a 2020 2020 2020 2020  shape)..        
+0000a570: 2320 6375 7420 6465 636f 6465 725f 696e  # cut decoder_in
+0000a580: 7075 745f 6964 7320 6966 2070 6173 745f  put_ids if past_
+0000a590: 6b65 795f 7661 6c75 6573 2069 7320 7573  key_values is us
+0000a5a0: 6564 0a20 2020 2020 2020 2069 6620 7061  ed.        if pa
+0000a5b0: 7374 5f6b 6579 5f76 616c 7565 7320 6973  st_key_values is
+0000a5c0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+0000a5d0: 2020 2020 2020 2070 6173 745f 6c65 6e67         past_leng
+0000a5e0: 7468 203d 2070 6173 745f 6b65 795f 7661  th = past_key_va
+0000a5f0: 6c75 6573 5b30 5d5b 305d 2e73 6861 7065  lues[0][0].shape
+0000a600: 5b32 5d0a 0a20 2020 2020 2020 2020 2020  [2]..           
+0000a610: 2023 2053 6f6d 6520 6765 6e65 7261 7469   # Some generati
+0000a620: 6f6e 206d 6574 686f 6473 2061 6c72 6561  on methods alrea
+0000a630: 6479 2070 6173 7320 6f6e 6c79 2074 6865  dy pass only the
+0000a640: 206c 6173 7420 696e 7075 7420 4944 0a20   last input ID. 
+0000a650: 2020 2020 2020 2020 2020 2069 6620 696e             if in
+0000a660: 7075 745f 6964 732e 7368 6170 655b 315d  put_ids.shape[1]
+0000a670: 203e 2070 6173 745f 6c65 6e67 7468 3a0a   > past_length:.
+0000a680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a690: 7265 6d6f 7665 5f70 7265 6669 785f 6c65  remove_prefix_le
+0000a6a0: 6e67 7468 203d 2070 6173 745f 6c65 6e67  ngth = past_leng
+0000a6b0: 7468 0a20 2020 2020 2020 2020 2020 2065  th.            e
+0000a6c0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0000a6d0: 2020 2020 2023 2044 6566 6175 6c74 2074       # Default t
+0000a6e0: 6f20 6f6c 6420 6265 6861 7669 6f72 3a20  o old behavior: 
+0000a6f0: 6b65 6570 206f 6e6c 7920 6669 6e61 6c20  keep only final 
+0000a700: 4944 0a20 2020 2020 2020 2020 2020 2020  ID.             
+0000a710: 2020 2072 656d 6f76 655f 7072 6566 6978     remove_prefix
+0000a720: 5f6c 656e 6774 6820 3d20 696e 7075 745f  _length = input_
+0000a730: 6964 732e 7368 6170 655b 315d 202d 2031  ids.shape[1] - 1
+0000a740: 0a0a 2020 2020 2020 2020 2020 2020 696e  ..            in
+0000a750: 7075 745f 6964 7320 3d20 696e 7075 745f  put_ids = input_
+0000a760: 6964 735b 3a2c 2072 656d 6f76 655f 7072  ids[:, remove_pr
+0000a770: 6566 6978 5f6c 656e 6774 683a 5d0a 0a20  efix_length:].. 
+0000a780: 2020 2020 2020 2072 6574 7572 6e20 7b0a         return {.
+0000a790: 2020 2020 2020 2020 2020 2020 2269 6e70              "inp
+0000a7a0: 7574 5f69 6473 223a 2069 6e70 7574 5f69  ut_ids": input_i
+0000a7b0: 6473 2c0a 2020 2020 2020 2020 2020 2020  ds,.            
+0000a7c0: 2261 7474 656e 7469 6f6e 5f6d 6173 6b22  "attention_mask"
+0000a7d0: 3a20 6174 7465 6e74 696f 6e5f 6d61 736b  : attention_mask
+0000a7e0: 2c0a 2020 2020 2020 2020 2020 2020 2270  ,.            "p
+0000a7f0: 6173 745f 6b65 795f 7661 6c75 6573 223a  ast_key_values":
+0000a800: 2070 6173 745f 6b65 795f 7661 6c75 6573   past_key_values
+0000a810: 2c0a 2020 2020 2020 2020 2020 2020 2265  ,.            "e
+0000a820: 6e63 6f64 6572 5f68 6964 6465 6e5f 7374  ncoder_hidden_st
+0000a830: 6174 6573 223a 206d 6f64 656c 5f6b 7761  ates": model_kwa
+0000a840: 7267 732e 6765 7428 2265 6e63 6f64 6572  rgs.get("encoder
+0000a850: 5f68 6964 6465 6e5f 7374 6174 6573 222c  _hidden_states",
+0000a860: 204e 6f6e 6529 2c0a 2020 2020 2020 2020   None),.        
+0000a870: 2020 2020 2265 6e63 6f64 6572 5f61 7474      "encoder_att
+0000a880: 656e 7469 6f6e 5f6d 6173 6b22 3a20 6d6f  ention_mask": mo
+0000a890: 6465 6c5f 6b77 6172 6773 2e67 6574 2822  del_kwargs.get("
+0000a8a0: 656e 636f 6465 725f 6174 7465 6e74 696f  encoder_attentio
+0000a8b0: 6e5f 6d61 736b 222c 204e 6f6e 6529 2c0a  n_mask", None),.
+0000a8c0: 2020 2020 2020 2020 2020 2020 2269 735f              "is_
+0000a8d0: 6465 636f 6465 7222 3a20 5472 7565 2c0a  decoder": True,.
+0000a8e0: 2020 2020 2020 2020 7d0a 0a20 2020 2064          }..    d
+0000a8f0: 6566 205f 7265 6f72 6465 725f 6361 6368  ef _reorder_cach
+0000a900: 6528 7365 6c66 2c20 7061 7374 5f6b 6579  e(self, past_key
+0000a910: 5f76 616c 7565 732c 2062 6561 6d5f 6964  _values, beam_id
+0000a920: 7829 3a0a 2020 2020 2020 2020 7265 6f72  x):.        reor
+0000a930: 6465 7265 645f 7061 7374 203d 2028 290a  dered_past = ().
+0000a940: 2020 2020 2020 2020 666f 7220 6c61 7965          for laye
+0000a950: 725f 7061 7374 2069 6e20 7061 7374 5f6b  r_past in past_k
+0000a960: 6579 5f76 616c 7565 733a 0a20 2020 2020  ey_values:.     
+0000a970: 2020 2020 2020 2072 656f 7264 6572 6564         reordered
+0000a980: 5f70 6173 7420 2b3d 2028 0a20 2020 2020  _past += (.     
+0000a990: 2020 2020 2020 2020 2020 2074 7570 6c65             tuple
+0000a9a0: 2870 6173 745f 7374 6174 652e 696e 6465  (past_state.inde
+0000a9b0: 785f 7365 6c65 6374 2830 2c20 6265 616d  x_select(0, beam
+0000a9c0: 5f69 6478 2920 666f 7220 7061 7374 5f73  _idx) for past_s
+0000a9d0: 7461 7465 2069 6e20 6c61 7965 725f 7061  tate in layer_pa
+0000a9e0: 7374 292c 0a20 2020 2020 2020 2020 2020  st),.           
+0000a9f0: 2029 0a20 2020 2020 2020 2072 6574 7572   ).        retur
+0000aa00: 6e20 7265 6f72 6465 7265 645f 7061 7374  n reordered_past
+0000aa10: 0a                                       .
```

## mindnlp/transformers/models/blip/processing_blip.py

```diff
@@ -0,0 +1,390 @@
+00000000: 2320 636f 6469 6e67 3d75 7466 2d38 0a23  # coding=utf-8.#
+00000010: 2043 6f70 7972 6967 6874 2032 3032 3220   Copyright 2022 
+00000020: 5468 6520 4875 6767 696e 6746 6163 6520  The HuggingFace 
+00000030: 496e 632e 2074 6561 6d2e 0a23 0a23 204c  Inc. team..#.# L
+00000040: 6963 656e 7365 6420 756e 6465 7220 7468  icensed under th
+00000050: 6520 4170 6163 6865 204c 6963 656e 7365  e Apache License
+00000060: 2c20 5665 7273 696f 6e20 322e 3020 2874  , Version 2.0 (t
+00000070: 6865 2022 4c69 6365 6e73 6522 293b 0a23  he "License");.#
+00000080: 2079 6f75 206d 6179 206e 6f74 2075 7365   you may not use
+00000090: 2074 6869 7320 6669 6c65 2065 7863 6570   this file excep
+000000a0: 7420 696e 2063 6f6d 706c 6961 6e63 6520  t in compliance 
+000000b0: 7769 7468 2074 6865 204c 6963 656e 7365  with the License
+000000c0: 2e0a 2320 596f 7520 6d61 7920 6f62 7461  ..# You may obta
+000000d0: 696e 2061 2063 6f70 7920 6f66 2074 6865  in a copy of the
+000000e0: 204c 6963 656e 7365 2061 740a 230a 2320   License at.#.# 
+000000f0: 2020 2020 6874 7470 3a2f 2f77 7777 2e61      http://www.a
+00000100: 7061 6368 652e 6f72 672f 6c69 6365 6e73  pache.org/licens
+00000110: 6573 2f4c 4943 454e 5345 2d32 2e30 0a23  es/LICENSE-2.0.#
+00000120: 0a23 2055 6e6c 6573 7320 7265 7175 6972  .# Unless requir
+00000130: 6564 2062 7920 6170 706c 6963 6162 6c65  ed by applicable
+00000140: 206c 6177 206f 7220 6167 7265 6564 2074   law or agreed t
+00000150: 6f20 696e 2077 7269 7469 6e67 2c20 736f  o in writing, so
+00000160: 6674 7761 7265 0a23 2064 6973 7472 6962  ftware.# distrib
+00000170: 7574 6564 2075 6e64 6572 2074 6865 204c  uted under the L
+00000180: 6963 656e 7365 2069 7320 6469 7374 7269  icense is distri
+00000190: 6275 7465 6420 6f6e 2061 6e20 2241 5320  buted on an "AS 
+000001a0: 4953 2220 4241 5349 532c 0a23 2057 4954  IS" BASIS,.# WIT
+000001b0: 484f 5554 2057 4152 5241 4e54 4945 5320  HOUT WARRANTIES 
+000001c0: 4f52 2043 4f4e 4449 5449 4f4e 5320 4f46  OR CONDITIONS OF
+000001d0: 2041 4e59 204b 494e 442c 2065 6974 6865   ANY KIND, eithe
+000001e0: 7220 6578 7072 6573 7320 6f72 2069 6d70  r express or imp
+000001f0: 6c69 6564 2e0a 2320 5365 6520 7468 6520  lied..# See the 
+00000200: 4c69 6365 6e73 6520 666f 7220 7468 6520  License for the 
+00000210: 7370 6563 6966 6963 206c 616e 6775 6167  specific languag
+00000220: 6520 676f 7665 726e 696e 6720 7065 726d  e governing perm
+00000230: 6973 7369 6f6e 7320 616e 640a 2320 6c69  issions and.# li
+00000240: 6d69 7461 7469 6f6e 7320 756e 6465 7220  mitations under 
+00000250: 7468 6520 4c69 6365 6e73 652e 0a22 2222  the License.."""
+00000260: 0a50 726f 6365 7373 6f72 2063 6c61 7373  .Processor class
+00000270: 2066 6f72 2042 6c69 702e 0a22 2222 0a0a   for Blip.."""..
+00000280: 6672 6f6d 2074 7970 696e 6720 696d 706f  from typing impo
+00000290: 7274 204c 6973 742c 204f 7074 696f 6e61  rt List, Optiona
+000002a0: 6c2c 2055 6e69 6f6e 0a0a 6672 6f6d 202e  l, Union..from .
+000002b0: 2e2e 696d 6167 655f 7574 696c 7320 696d  ..image_utils im
+000002c0: 706f 7274 2049 6d61 6765 496e 7075 740a  port ImageInput.
+000002d0: 6672 6f6d 202e 2e2e 7072 6f63 6573 7369  from ...processi
+000002e0: 6e67 5f75 7469 6c73 2069 6d70 6f72 7420  ng_utils import 
+000002f0: 5072 6f63 6573 736f 724d 6978 696e 0a66  ProcessorMixin.f
+00000300: 726f 6d20 2e2e 2e74 6f6b 656e 697a 6174  rom ...tokenizat
+00000310: 696f 6e5f 7574 696c 735f 6261 7365 2069  ion_utils_base i
+00000320: 6d70 6f72 7420 4261 7463 6845 6e63 6f64  mport BatchEncod
+00000330: 696e 672c 2050 6164 6469 6e67 5374 7261  ing, PaddingStra
+00000340: 7465 6779 2c20 5072 6554 6f6b 656e 697a  tegy, PreTokeniz
+00000350: 6564 496e 7075 742c 2054 6578 7449 6e70  edInput, TextInp
+00000360: 7574 2c20 5472 756e 6361 7469 6f6e 5374  ut, TruncationSt
+00000370: 7261 7465 6779 0a66 726f 6d20 2e2e 2e2e  rategy.from ....
+00000380: 7574 696c 7320 696d 706f 7274 2054 656e  utils import Ten
+00000390: 736f 7254 7970 650a 0a0a 636c 6173 7320  sorType...class 
+000003a0: 426c 6970 5072 6f63 6573 736f 7228 5072  BlipProcessor(Pr
+000003b0: 6f63 6573 736f 724d 6978 696e 293a 0a20  ocessorMixin):. 
+000003c0: 2020 2072 2222 220a 2020 2020 436f 6e73     r""".    Cons
+000003d0: 7472 7563 7473 2061 2042 4c49 5020 7072  tructs a BLIP pr
+000003e0: 6f63 6573 736f 7220 7768 6963 6820 7772  ocessor which wr
+000003f0: 6170 7320 6120 4245 5254 2074 6f6b 656e  aps a BERT token
+00000400: 697a 6572 2061 6e64 2042 4c49 5020 696d  izer and BLIP im
+00000410: 6167 6520 7072 6f63 6573 736f 7220 696e  age processor in
+00000420: 746f 2061 2073 696e 676c 6520 7072 6f63  to a single proc
+00000430: 6573 736f 722e 0a0a 2020 2020 5b60 426c  essor...    [`Bl
+00000440: 6970 5072 6f63 6573 736f 7260 5d20 6f66  ipProcessor`] of
+00000450: 6665 7273 2061 6c6c 2074 6865 2066 756e  fers all the fun
+00000460: 6374 696f 6e61 6c69 7469 6573 206f 6620  ctionalities of 
+00000470: 5b60 426c 6970 496d 6167 6550 726f 6365  [`BlipImageProce
+00000480: 7373 6f72 605d 2061 6e64 205b 6042 6572  ssor`] and [`Ber
+00000490: 7454 6f6b 656e 697a 6572 4661 7374 605d  tTokenizerFast`]
+000004a0: 2e20 5365 6520 7468 650a 2020 2020 646f  . See the.    do
+000004b0: 6373 7472 696e 6720 6f66 205b 607e 426c  cstring of [`~Bl
+000004c0: 6970 5072 6f63 6573 736f 722e 5f5f 6361  ipProcessor.__ca
+000004d0: 6c6c 5f5f 605d 2061 6e64 205b 607e 426c  ll__`] and [`~Bl
+000004e0: 6970 5072 6f63 6573 736f 722e 6465 636f  ipProcessor.deco
+000004f0: 6465 605d 2066 6f72 206d 6f72 6520 696e  de`] for more in
+00000500: 666f 726d 6174 696f 6e2e 0a0a 2020 2020  formation...    
+00000510: 4172 6773 3a0a 2020 2020 2020 2020 696d  Args:.        im
+00000520: 6167 655f 7072 6f63 6573 736f 7220 2860  age_processor (`
+00000530: 426c 6970 496d 6167 6550 726f 6365 7373  BlipImageProcess
+00000540: 6f72 6029 3a0a 2020 2020 2020 2020 2020  or`):.          
+00000550: 2020 416e 2069 6e73 7461 6e63 6520 6f66    An instance of
+00000560: 205b 6042 6c69 7049 6d61 6765 5072 6f63   [`BlipImageProc
+00000570: 6573 736f 7260 5d2e 2054 6865 2069 6d61  essor`]. The ima
+00000580: 6765 2070 726f 6365 7373 6f72 2069 7320  ge processor is 
+00000590: 6120 7265 7175 6972 6564 2069 6e70 7574  a required input
+000005a0: 2e0a 2020 2020 2020 2020 746f 6b65 6e69  ..        tokeni
+000005b0: 7a65 7220 2860 4265 7274 546f 6b65 6e69  zer (`BertTokeni
+000005c0: 7a65 7246 6173 7460 293a 0a20 2020 2020  zerFast`):.     
+000005d0: 2020 2020 2020 2041 6e20 696e 7374 616e         An instan
+000005e0: 6365 206f 6620 5b27 4265 7274 546f 6b65  ce of ['BertToke
+000005f0: 6e69 7a65 7246 6173 7460 5d2e 2054 6865  nizerFast`]. The
+00000600: 2074 6f6b 656e 697a 6572 2069 7320 6120   tokenizer is a 
+00000610: 7265 7175 6972 6564 2069 6e70 7574 2e0a  required input..
+00000620: 2020 2020 2222 220a 0a20 2020 2061 7474      """..    att
+00000630: 7269 6275 7465 7320 3d20 5b22 696d 6167  ributes = ["imag
+00000640: 655f 7072 6f63 6573 736f 7222 2c20 2274  e_processor", "t
+00000650: 6f6b 656e 697a 6572 225d 0a20 2020 2069  okenizer"].    i
+00000660: 6d61 6765 5f70 726f 6365 7373 6f72 5f63  mage_processor_c
+00000670: 6c61 7373 203d 2022 426c 6970 496d 6167  lass = "BlipImag
+00000680: 6550 726f 6365 7373 6f72 220a 2020 2020  eProcessor".    
+00000690: 746f 6b65 6e69 7a65 725f 636c 6173 7320  tokenizer_class 
+000006a0: 3d20 2822 4265 7274 546f 6b65 6e69 7a65  = ("BertTokenize
+000006b0: 7222 2c20 2242 6572 7454 6f6b 656e 697a  r", "BertTokeniz
+000006c0: 6572 4661 7374 2229 0a0a 2020 2020 6465  erFast")..    de
+000006d0: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
+000006e0: 2069 6d61 6765 5f70 726f 6365 7373 6f72   image_processor
+000006f0: 2c20 746f 6b65 6e69 7a65 7229 3a0a 2020  , tokenizer):.  
+00000700: 2020 2020 2020 746f 6b65 6e69 7a65 722e        tokenizer.
+00000710: 7265 7475 726e 5f74 6f6b 656e 5f74 7970  return_token_typ
+00000720: 655f 6964 7320 3d20 4661 6c73 650a 2020  e_ids = False.  
+00000730: 2020 2020 2020 7375 7065 7228 292e 5f5f        super().__
+00000740: 696e 6974 5f5f 2869 6d61 6765 5f70 726f  init__(image_pro
+00000750: 6365 7373 6f72 2c20 746f 6b65 6e69 7a65  cessor, tokenize
+00000760: 7229 0a20 2020 2020 2020 2073 656c 662e  r).        self.
+00000770: 6375 7272 656e 745f 7072 6f63 6573 736f  current_processo
+00000780: 7220 3d20 7365 6c66 2e69 6d61 6765 5f70  r = self.image_p
+00000790: 726f 6365 7373 6f72 0a0a 2020 2020 6465  rocessor..    de
+000007a0: 6620 5f5f 6361 6c6c 5f5f 280a 2020 2020  f __call__(.    
+000007b0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+000007c0: 2020 696d 6167 6573 3a20 496d 6167 6549    images: ImageI
+000007d0: 6e70 7574 203d 204e 6f6e 652c 0a20 2020  nput = None,.   
+000007e0: 2020 2020 2074 6578 743a 2055 6e69 6f6e       text: Union
+000007f0: 5b54 6578 7449 6e70 7574 2c20 5072 6554  [TextInput, PreT
+00000800: 6f6b 656e 697a 6564 496e 7075 742c 204c  okenizedInput, L
+00000810: 6973 745b 5465 7874 496e 7075 745d 2c20  ist[TextInput], 
+00000820: 4c69 7374 5b50 7265 546f 6b65 6e69 7a65  List[PreTokenize
+00000830: 6449 6e70 7574 5d5d 203d 204e 6f6e 652c  dInput]] = None,
+00000840: 0a20 2020 2020 2020 2061 6464 5f73 7065  .        add_spe
+00000850: 6369 616c 5f74 6f6b 656e 733a 2062 6f6f  cial_tokens: boo
+00000860: 6c20 3d20 5472 7565 2c0a 2020 2020 2020  l = True,.      
+00000870: 2020 7061 6464 696e 673a 2055 6e69 6f6e    padding: Union
+00000880: 5b62 6f6f 6c2c 2073 7472 2c20 5061 6464  [bool, str, Padd
+00000890: 696e 6753 7472 6174 6567 795d 203d 2046  ingStrategy] = F
+000008a0: 616c 7365 2c0a 2020 2020 2020 2020 7472  alse,.        tr
+000008b0: 756e 6361 7469 6f6e 3a20 556e 696f 6e5b  uncation: Union[
+000008c0: 626f 6f6c 2c20 7374 722c 2054 7275 6e63  bool, str, Trunc
+000008d0: 6174 696f 6e53 7472 6174 6567 795d 203d  ationStrategy] =
+000008e0: 204e 6f6e 652c 0a20 2020 2020 2020 206d   None,.        m
+000008f0: 6178 5f6c 656e 6774 683a 204f 7074 696f  ax_length: Optio
+00000900: 6e61 6c5b 696e 745d 203d 204e 6f6e 652c  nal[int] = None,
+00000910: 0a20 2020 2020 2020 2073 7472 6964 653a  .        stride:
+00000920: 2069 6e74 203d 2030 2c0a 2020 2020 2020   int = 0,.      
+00000930: 2020 7061 645f 746f 5f6d 756c 7469 706c    pad_to_multipl
+00000940: 655f 6f66 3a20 4f70 7469 6f6e 616c 5b69  e_of: Optional[i
+00000950: 6e74 5d20 3d20 4e6f 6e65 2c0a 2020 2020  nt] = None,.    
+00000960: 2020 2020 7265 7475 726e 5f61 7474 656e      return_atten
+00000970: 7469 6f6e 5f6d 6173 6b3a 204f 7074 696f  tion_mask: Optio
+00000980: 6e61 6c5b 626f 6f6c 5d20 3d20 4e6f 6e65  nal[bool] = None
+00000990: 2c0a 2020 2020 2020 2020 7265 7475 726e  ,.        return
+000009a0: 5f6f 7665 7266 6c6f 7769 6e67 5f74 6f6b  _overflowing_tok
+000009b0: 656e 733a 2062 6f6f 6c20 3d20 4661 6c73  ens: bool = Fals
+000009c0: 652c 0a20 2020 2020 2020 2072 6574 7572  e,.        retur
+000009d0: 6e5f 7370 6563 6961 6c5f 746f 6b65 6e73  n_special_tokens
+000009e0: 5f6d 6173 6b3a 2062 6f6f 6c20 3d20 4661  _mask: bool = Fa
+000009f0: 6c73 652c 0a20 2020 2020 2020 2072 6574  lse,.        ret
+00000a00: 7572 6e5f 6f66 6673 6574 735f 6d61 7070  urn_offsets_mapp
+00000a10: 696e 673a 2062 6f6f 6c20 3d20 4661 6c73  ing: bool = Fals
+00000a20: 652c 0a20 2020 2020 2020 2072 6574 7572  e,.        retur
+00000a30: 6e5f 746f 6b65 6e5f 7479 7065 5f69 6473  n_token_type_ids
+00000a40: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
+00000a50: 2020 2020 2020 2020 7265 7475 726e 5f6c          return_l
+00000a60: 656e 6774 683a 2062 6f6f 6c20 3d20 4661  ength: bool = Fa
+00000a70: 6c73 652c 0a20 2020 2020 2020 2076 6572  lse,.        ver
+00000a80: 626f 7365 3a20 626f 6f6c 203d 2054 7275  bose: bool = Tru
+00000a90: 652c 0a20 2020 2020 2020 2072 6574 7572  e,.        retur
+00000aa0: 6e5f 7465 6e73 6f72 733a 204f 7074 696f  n_tensors: Optio
+00000ab0: 6e61 6c5b 556e 696f 6e5b 7374 722c 2054  nal[Union[str, T
+00000ac0: 656e 736f 7254 7970 655d 5d20 3d20 4e6f  ensorType]] = No
+00000ad0: 6e65 2c0a 2020 2020 2020 2020 2a2a 6b77  ne,.        **kw
+00000ae0: 6172 6773 2c0a 2020 2020 2920 2d3e 2042  args,.    ) -> B
+00000af0: 6174 6368 456e 636f 6469 6e67 3a0a 2020  atchEncoding:.  
+00000b00: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00000b10: 2020 5468 6973 206d 6574 686f 6420 7573    This method us
+00000b20: 6573 205b 6042 6c69 7049 6d61 6765 5072  es [`BlipImagePr
+00000b30: 6f63 6573 736f 722e 5f5f 6361 6c6c 5f5f  ocessor.__call__
+00000b40: 605d 206d 6574 686f 6420 746f 2070 7265  `] method to pre
+00000b50: 7061 7265 2069 6d61 6765 2873 2920 666f  pare image(s) fo
+00000b60: 7220 7468 6520 6d6f 6465 6c2c 2061 6e64  r the model, and
+00000b70: 0a20 2020 2020 2020 205b 6042 6572 7454  .        [`BertT
+00000b80: 6f6b 656e 697a 6572 4661 7374 2e5f 5f63  okenizerFast.__c
+00000b90: 616c 6c5f 5f60 5d20 746f 2070 7265 7061  all__`] to prepa
+00000ba0: 7265 2074 6578 7420 666f 7220 7468 6520  re text for the 
+00000bb0: 6d6f 6465 6c2e 0a0a 2020 2020 2020 2020  model...        
+00000bc0: 506c 6561 7365 2072 6566 6572 2074 6f20  Please refer to 
+00000bd0: 7468 6520 646f 6373 7472 696e 6720 6f66  the docstring of
+00000be0: 2074 6865 2061 626f 7665 2074 776f 206d   the above two m
+00000bf0: 6574 686f 6473 2066 6f72 206d 6f72 6520  ethods for more 
+00000c00: 696e 666f 726d 6174 696f 6e2e 0a20 2020  information..   
+00000c10: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00000c20: 2069 6620 696d 6167 6573 2069 7320 4e6f   if images is No
+00000c30: 6e65 2061 6e64 2074 6578 7420 6973 204e  ne and text is N
+00000c40: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00000c50: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+00000c60: 7228 2259 6f75 2068 6176 6520 746f 2073  r("You have to s
+00000c70: 7065 6369 6679 2065 6974 6865 7220 696d  pecify either im
+00000c80: 6167 6573 206f 7220 7465 7874 2e22 290a  ages or text.").
+00000c90: 0a20 2020 2020 2020 2023 2047 6574 206f  .        # Get o
+00000ca0: 6e6c 7920 7465 7874 0a20 2020 2020 2020  nly text.       
+00000cb0: 2069 6620 696d 6167 6573 2069 7320 4e6f   if images is No
+00000cc0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00000cd0: 7365 6c66 2e63 7572 7265 6e74 5f70 726f  self.current_pro
+00000ce0: 6365 7373 6f72 203d 2073 656c 662e 746f  cessor = self.to
+00000cf0: 6b65 6e69 7a65 720a 2020 2020 2020 2020  kenizer.        
+00000d00: 2020 2020 7465 7874 5f65 6e63 6f64 696e      text_encodin
+00000d10: 6720 3d20 7365 6c66 2e74 6f6b 656e 697a  g = self.tokeniz
+00000d20: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
+00000d30: 2020 2020 7465 7874 3d74 6578 742c 0a20      text=text,. 
+00000d40: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00000d50: 6464 5f73 7065 6369 616c 5f74 6f6b 656e  dd_special_token
+00000d60: 733d 6164 645f 7370 6563 6961 6c5f 746f  s=add_special_to
+00000d70: 6b65 6e73 2c0a 2020 2020 2020 2020 2020  kens,.          
+00000d80: 2020 2020 2020 7061 6464 696e 673d 7061        padding=pa
+00000d90: 6464 696e 672c 0a20 2020 2020 2020 2020  dding,.         
+00000da0: 2020 2020 2020 2074 7275 6e63 6174 696f         truncatio
+00000db0: 6e3d 7472 756e 6361 7469 6f6e 2c0a 2020  n=truncation,.  
+00000dc0: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
+00000dd0: 785f 6c65 6e67 7468 3d6d 6178 5f6c 656e  x_length=max_len
+00000de0: 6774 682c 0a20 2020 2020 2020 2020 2020  gth,.           
+00000df0: 2020 2020 2073 7472 6964 653d 7374 7269       stride=stri
+00000e00: 6465 2c0a 2020 2020 2020 2020 2020 2020  de,.            
+00000e10: 2020 2020 7061 645f 746f 5f6d 756c 7469      pad_to_multi
+00000e20: 706c 655f 6f66 3d70 6164 5f74 6f5f 6d75  ple_of=pad_to_mu
+00000e30: 6c74 6970 6c65 5f6f 662c 0a20 2020 2020  ltiple_of,.     
+00000e40: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00000e50: 6e5f 6174 7465 6e74 696f 6e5f 6d61 736b  n_attention_mask
+00000e60: 3d72 6574 7572 6e5f 6174 7465 6e74 696f  =return_attentio
+00000e70: 6e5f 6d61 736b 2c0a 2020 2020 2020 2020  n_mask,.        
+00000e80: 2020 2020 2020 2020 7265 7475 726e 5f6f          return_o
+00000e90: 7665 7266 6c6f 7769 6e67 5f74 6f6b 656e  verflowing_token
+00000ea0: 733d 7265 7475 726e 5f6f 7665 7266 6c6f  s=return_overflo
+00000eb0: 7769 6e67 5f74 6f6b 656e 732c 0a20 2020  wing_tokens,.   
+00000ec0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00000ed0: 7572 6e5f 7370 6563 6961 6c5f 746f 6b65  urn_special_toke
+00000ee0: 6e73 5f6d 6173 6b3d 7265 7475 726e 5f73  ns_mask=return_s
+00000ef0: 7065 6369 616c 5f74 6f6b 656e 735f 6d61  pecial_tokens_ma
+00000f00: 736b 2c0a 2020 2020 2020 2020 2020 2020  sk,.            
+00000f10: 2020 2020 7265 7475 726e 5f6f 6666 7365      return_offse
+00000f20: 7473 5f6d 6170 7069 6e67 3d72 6574 7572  ts_mapping=retur
+00000f30: 6e5f 6f66 6673 6574 735f 6d61 7070 696e  n_offsets_mappin
+00000f40: 672c 0a20 2020 2020 2020 2020 2020 2020  g,.             
+00000f50: 2020 2072 6574 7572 6e5f 746f 6b65 6e5f     return_token_
+00000f60: 7479 7065 5f69 6473 3d72 6574 7572 6e5f  type_ids=return_
+00000f70: 746f 6b65 6e5f 7479 7065 5f69 6473 2c0a  token_type_ids,.
+00000f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000f90: 7265 7475 726e 5f6c 656e 6774 683d 7265  return_length=re
+00000fa0: 7475 726e 5f6c 656e 6774 682c 0a20 2020  turn_length,.   
+00000fb0: 2020 2020 2020 2020 2020 2020 2076 6572               ver
+00000fc0: 626f 7365 3d76 6572 626f 7365 2c0a 2020  bose=verbose,.  
+00000fd0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00000fe0: 7475 726e 5f74 656e 736f 7273 3d72 6574  turn_tensors=ret
+00000ff0: 7572 6e5f 7465 6e73 6f72 732c 0a20 2020  urn_tensors,.   
+00001000: 2020 2020 2020 2020 2020 2020 202a 2a6b               **k
+00001010: 7761 7267 732c 0a20 2020 2020 2020 2020  wargs,.         
+00001020: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00001030: 2072 6574 7572 6e20 7465 7874 5f65 6e63   return text_enc
+00001040: 6f64 696e 670a 0a20 2020 2020 2020 2023  oding..        #
+00001050: 2061 6464 2070 6978 656c 5f76 616c 7565   add pixel_value
+00001060: 730a 2020 2020 2020 2020 656e 636f 6469  s.        encodi
+00001070: 6e67 5f69 6d61 6765 5f70 726f 6365 7373  ng_image_process
+00001080: 6f72 203d 2073 656c 662e 696d 6167 655f  or = self.image_
+00001090: 7072 6f63 6573 736f 7228 696d 6167 6573  processor(images
+000010a0: 2c20 7265 7475 726e 5f74 656e 736f 7273  , return_tensors
+000010b0: 3d72 6574 7572 6e5f 7465 6e73 6f72 7329  =return_tensors)
+000010c0: 0a0a 2020 2020 2020 2020 6966 2074 6578  ..        if tex
+000010d0: 7420 6973 206e 6f74 204e 6f6e 653a 0a20  t is not None:. 
+000010e0: 2020 2020 2020 2020 2020 2074 6578 745f             text_
+000010f0: 656e 636f 6469 6e67 203d 2073 656c 662e  encoding = self.
+00001100: 746f 6b65 6e69 7a65 7228 0a20 2020 2020  tokenizer(.     
+00001110: 2020 2020 2020 2020 2020 2074 6578 743d             text=
+00001120: 7465 7874 2c0a 2020 2020 2020 2020 2020  text,.          
+00001130: 2020 2020 2020 6164 645f 7370 6563 6961        add_specia
+00001140: 6c5f 746f 6b65 6e73 3d61 6464 5f73 7065  l_tokens=add_spe
+00001150: 6369 616c 5f74 6f6b 656e 732c 0a20 2020  cial_tokens,.   
+00001160: 2020 2020 2020 2020 2020 2020 2070 6164               pad
+00001170: 6469 6e67 3d70 6164 6469 6e67 2c0a 2020  ding=padding,.  
+00001180: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+00001190: 756e 6361 7469 6f6e 3d74 7275 6e63 6174  uncation=truncat
+000011a0: 696f 6e2c 0a20 2020 2020 2020 2020 2020  ion,.           
+000011b0: 2020 2020 206d 6178 5f6c 656e 6774 683d       max_length=
+000011c0: 6d61 785f 6c65 6e67 7468 2c0a 2020 2020  max_length,.    
+000011d0: 2020 2020 2020 2020 2020 2020 7374 7269              stri
+000011e0: 6465 3d73 7472 6964 652c 0a20 2020 2020  de=stride,.     
+000011f0: 2020 2020 2020 2020 2020 2070 6164 5f74             pad_t
+00001200: 6f5f 6d75 6c74 6970 6c65 5f6f 663d 7061  o_multiple_of=pa
+00001210: 645f 746f 5f6d 756c 7469 706c 655f 6f66  d_to_multiple_of
+00001220: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00001230: 2020 7265 7475 726e 5f61 7474 656e 7469    return_attenti
+00001240: 6f6e 5f6d 6173 6b3d 7265 7475 726e 5f61  on_mask=return_a
+00001250: 7474 656e 7469 6f6e 5f6d 6173 6b2c 0a20  ttention_mask,. 
+00001260: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00001270: 6574 7572 6e5f 6f76 6572 666c 6f77 696e  eturn_overflowin
+00001280: 675f 746f 6b65 6e73 3d72 6574 7572 6e5f  g_tokens=return_
+00001290: 6f76 6572 666c 6f77 696e 675f 746f 6b65  overflowing_toke
+000012a0: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
+000012b0: 2020 2020 7265 7475 726e 5f73 7065 6369      return_speci
+000012c0: 616c 5f74 6f6b 656e 735f 6d61 736b 3d72  al_tokens_mask=r
+000012d0: 6574 7572 6e5f 7370 6563 6961 6c5f 746f  eturn_special_to
+000012e0: 6b65 6e73 5f6d 6173 6b2c 0a20 2020 2020  kens_mask,.     
+000012f0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00001300: 6e5f 6f66 6673 6574 735f 6d61 7070 696e  n_offsets_mappin
+00001310: 673d 7265 7475 726e 5f6f 6666 7365 7473  g=return_offsets
+00001320: 5f6d 6170 7069 6e67 2c0a 2020 2020 2020  _mapping,.      
+00001330: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00001340: 5f74 6f6b 656e 5f74 7970 655f 6964 733d  _token_type_ids=
+00001350: 7265 7475 726e 5f74 6f6b 656e 5f74 7970  return_token_typ
+00001360: 655f 6964 732c 0a20 2020 2020 2020 2020  e_ids,.         
+00001370: 2020 2020 2020 2072 6574 7572 6e5f 6c65         return_le
+00001380: 6e67 7468 3d72 6574 7572 6e5f 6c65 6e67  ngth=return_leng
+00001390: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
+000013a0: 2020 2020 7665 7262 6f73 653d 7665 7262      verbose=verb
+000013b0: 6f73 652c 0a20 2020 2020 2020 2020 2020  ose,.           
+000013c0: 2020 2020 2072 6574 7572 6e5f 7465 6e73       return_tens
+000013d0: 6f72 733d 7265 7475 726e 5f74 656e 736f  ors=return_tenso
+000013e0: 7273 2c0a 2020 2020 2020 2020 2020 2020  rs,.            
+000013f0: 2020 2020 2a2a 6b77 6172 6773 2c0a 2020      **kwargs,.  
+00001400: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00001410: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00001420: 2020 2020 2020 7465 7874 5f65 6e63 6f64        text_encod
+00001430: 696e 6720 3d20 4e6f 6e65 0a0a 2020 2020  ing = None..    
+00001440: 2020 2020 6966 2074 6578 745f 656e 636f      if text_enco
+00001450: 6469 6e67 2069 7320 6e6f 7420 4e6f 6e65  ding is not None
+00001460: 3a0a 2020 2020 2020 2020 2020 2020 656e  :.            en
+00001470: 636f 6469 6e67 5f69 6d61 6765 5f70 726f  coding_image_pro
+00001480: 6365 7373 6f72 2e75 7064 6174 6528 7465  cessor.update(te
+00001490: 7874 5f65 6e63 6f64 696e 6729 0a0a 2020  xt_encoding)..  
+000014a0: 2020 2020 2020 7265 7475 726e 2065 6e63        return enc
+000014b0: 6f64 696e 675f 696d 6167 655f 7072 6f63  oding_image_proc
+000014c0: 6573 736f 720a 0a20 2020 2064 6566 2062  essor..    def b
+000014d0: 6174 6368 5f64 6563 6f64 6528 7365 6c66  atch_decode(self
+000014e0: 2c20 2a61 7267 732c 202a 2a6b 7761 7267  , *args, **kwarg
+000014f0: 7329 3a0a 2020 2020 2020 2020 2222 220a  s):.        """.
+00001500: 2020 2020 2020 2020 5468 6973 206d 6574          This met
+00001510: 686f 6420 666f 7277 6172 6473 2061 6c6c  hod forwards all
+00001520: 2069 7473 2061 7267 756d 656e 7473 2074   its arguments t
+00001530: 6f20 4265 7274 546f 6b65 6e69 7a65 7246  o BertTokenizerF
+00001540: 6173 7427 7320 5b60 7e50 7265 5472 6169  ast's [`~PreTrai
+00001550: 6e65 6454 6f6b 656e 697a 6572 2e62 6174  nedTokenizer.bat
+00001560: 6368 5f64 6563 6f64 6560 5d2e 2050 6c65  ch_decode`]. Ple
+00001570: 6173 650a 2020 2020 2020 2020 7265 6665  ase.        refe
+00001580: 7220 746f 2074 6865 2064 6f63 7374 7269  r to the docstri
+00001590: 6e67 206f 6620 7468 6973 206d 6574 686f  ng of this metho
+000015a0: 6420 666f 7220 6d6f 7265 2069 6e66 6f72  d for more infor
+000015b0: 6d61 7469 6f6e 2e0a 2020 2020 2020 2020  mation..        
+000015c0: 2222 220a 2020 2020 2020 2020 7265 7475  """.        retu
+000015d0: 726e 2073 656c 662e 746f 6b65 6e69 7a65  rn self.tokenize
+000015e0: 722e 6261 7463 685f 6465 636f 6465 282a  r.batch_decode(*
+000015f0: 6172 6773 2c20 2a2a 6b77 6172 6773 290a  args, **kwargs).
+00001600: 0a20 2020 2064 6566 2064 6563 6f64 6528  .    def decode(
+00001610: 7365 6c66 2c20 2a61 7267 732c 202a 2a6b  self, *args, **k
+00001620: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
+00001630: 2222 220a 2020 2020 2020 2020 5468 6973  """.        This
+00001640: 206d 6574 686f 6420 666f 7277 6172 6473   method forwards
+00001650: 2061 6c6c 2069 7473 2061 7267 756d 656e   all its argumen
+00001660: 7473 2074 6f20 4265 7274 546f 6b65 6e69  ts to BertTokeni
+00001670: 7a65 7246 6173 7427 7320 5b60 7e50 7265  zerFast's [`~Pre
+00001680: 5472 6169 6e65 6454 6f6b 656e 697a 6572  TrainedTokenizer
+00001690: 2e64 6563 6f64 6560 5d2e 2050 6c65 6173  .decode`]. Pleas
+000016a0: 6520 7265 6665 7220 746f 0a20 2020 2020  e refer to.     
+000016b0: 2020 2074 6865 2064 6f63 7374 7269 6e67     the docstring
+000016c0: 206f 6620 7468 6973 206d 6574 686f 6420   of this method 
+000016d0: 666f 7220 6d6f 7265 2069 6e66 6f72 6d61  for more informa
+000016e0: 7469 6f6e 2e0a 2020 2020 2020 2020 2222  tion..        ""
+000016f0: 220a 2020 2020 2020 2020 7265 7475 726e  ".        return
+00001700: 2073 656c 662e 746f 6b65 6e69 7a65 722e   self.tokenizer.
+00001710: 6465 636f 6465 282a 6172 6773 2c20 2a2a  decode(*args, **
+00001720: 6b77 6172 6773 290a 0a20 2020 2040 7072  kwargs)..    @pr
+00001730: 6f70 6572 7479 0a20 2020 2064 6566 206d  operty.    def m
+00001740: 6f64 656c 5f69 6e70 7574 5f6e 616d 6573  odel_input_names
+00001750: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+00001760: 746f 6b65 6e69 7a65 725f 696e 7075 745f  tokenizer_input_
+00001770: 6e61 6d65 7320 3d20 7365 6c66 2e74 6f6b  names = self.tok
+00001780: 656e 697a 6572 2e6d 6f64 656c 5f69 6e70  enizer.model_inp
+00001790: 7574 5f6e 616d 6573 0a20 2020 2020 2020  ut_names.       
+000017a0: 2069 6d61 6765 5f70 726f 6365 7373 6f72   image_processor
+000017b0: 5f69 6e70 7574 5f6e 616d 6573 203d 2073  _input_names = s
+000017c0: 656c 662e 696d 6167 655f 7072 6f63 6573  elf.image_proces
+000017d0: 736f 722e 6d6f 6465 6c5f 696e 7075 745f  sor.model_input_
+000017e0: 6e61 6d65 730a 2020 2020 2020 2020 7265  names.        re
+000017f0: 7475 726e 206c 6973 7428 6469 6374 2e66  turn list(dict.f
+00001800: 726f 6d6b 6579 7328 746f 6b65 6e69 7a65  romkeys(tokenize
+00001810: 725f 696e 7075 745f 6e61 6d65 7320 2b20  r_input_names + 
+00001820: 696d 6167 655f 7072 6f63 6573 736f 725f  image_processor_
+00001830: 696e 7075 745f 6e61 6d65 7329 290a 0a5f  input_names)).._
+00001840: 5f61 6c6c 5f5f 203d 205b 2742 6c69 7050  _all__ = ['BlipP
+00001850: 726f 6365 7373 6f72 275d 0a              rocessor'].
```

## mindnlp/transformers/models/blip_2/__init__.py

```diff
@@ -1,17 +1,26 @@
-# Copyright 2023 Huawei Technologies Co., Ltd
+# Copyright 2024 Huawei Technologies Co., Ltd
 #
 # Licensed under the Apache License, Version 2.0 (the "License");
 # you may not use this file except in compliance with the License.
 # You may obtain a copy of the License at
 #
 # http://www.apache.org/licenses/LICENSE-2.0
 #
 # Unless required by applicable law or agreed to in writing, software
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
 # ============================================================================
 """
-Blip_2 Model.
+Blip2 Model.
 """
+from . import configuration_blip_2, modeling_blip_2, processing_blip_2
+from .configuration_blip_2 import *
+from .modeling_blip_2 import *
+from .processing_blip_2 import *
+
+__all__ = []
+__all__.extend(configuration_blip_2.__all__)
+__all__.extend(modeling_blip_2.__all__)
+__all__.extend(processing_blip_2.__all__)
```

## mindnlp/transformers/models/blip_2/configuration_blip_2.py

```diff
@@ -0,0 +1,1030 @@
+00000000: 2320 636f 6469 6e67 3d75 7466 2d38 0a23  # coding=utf-8.#
+00000010: 2043 6f70 7972 6967 6874 2032 3032 3320   Copyright 2023 
+00000020: 5468 6520 4875 6767 696e 6746 6163 6520  The HuggingFace 
+00000030: 496e 632e 2074 6561 6d2e 2041 6c6c 2072  Inc. team. All r
+00000040: 6967 6874 7320 7265 7365 7276 6564 2e0a  ights reserved..
+00000050: 230a 2320 4c69 6365 6e73 6564 2075 6e64  #.# Licensed und
+00000060: 6572 2074 6865 2041 7061 6368 6520 4c69  er the Apache Li
+00000070: 6365 6e73 652c 2056 6572 7369 6f6e 2032  cense, Version 2
+00000080: 2e30 2028 7468 6520 224c 6963 656e 7365  .0 (the "License
+00000090: 2229 3b0a 2320 796f 7520 6d61 7920 6e6f  ");.# you may no
+000000a0: 7420 7573 6520 7468 6973 2066 696c 6520  t use this file 
+000000b0: 6578 6365 7074 2069 6e20 636f 6d70 6c69  except in compli
+000000c0: 616e 6365 2077 6974 6820 7468 6520 4c69  ance with the Li
+000000d0: 6365 6e73 652e 0a23 2059 6f75 206d 6179  cense..# You may
+000000e0: 206f 6274 6169 6e20 6120 636f 7079 206f   obtain a copy o
+000000f0: 6620 7468 6520 4c69 6365 6e73 6520 6174  f the License at
+00000100: 0a23 0a23 2020 2020 2068 7474 703a 2f2f  .#.#     http://
+00000110: 7777 772e 6170 6163 6865 2e6f 7267 2f6c  www.apache.org/l
+00000120: 6963 656e 7365 732f 4c49 4345 4e53 452d  icenses/LICENSE-
+00000130: 322e 300a 230a 2320 556e 6c65 7373 2072  2.0.#.# Unless r
+00000140: 6571 7569 7265 6420 6279 2061 7070 6c69  equired by appli
+00000150: 6361 626c 6520 6c61 7720 6f72 2061 6772  cable law or agr
+00000160: 6565 6420 746f 2069 6e20 7772 6974 696e  eed to in writin
+00000170: 672c 2073 6f66 7477 6172 650a 2320 6469  g, software.# di
+00000180: 7374 7269 6275 7465 6420 756e 6465 7220  stributed under 
+00000190: 7468 6520 4c69 6365 6e73 6520 6973 2064  the License is d
+000001a0: 6973 7472 6962 7574 6564 206f 6e20 616e  istributed on an
+000001b0: 2022 4153 2049 5322 2042 4153 4953 2c0a   "AS IS" BASIS,.
+000001c0: 2320 5749 5448 4f55 5420 5741 5252 414e  # WITHOUT WARRAN
+000001d0: 5449 4553 204f 5220 434f 4e44 4954 494f  TIES OR CONDITIO
+000001e0: 4e53 204f 4620 414e 5920 4b49 4e44 2c20  NS OF ANY KIND, 
+000001f0: 6569 7468 6572 2065 7870 7265 7373 206f  either express o
+00000200: 7220 696d 706c 6965 642e 0a23 2053 6565  r implied..# See
+00000210: 2074 6865 204c 6963 656e 7365 2066 6f72   the License for
+00000220: 2074 6865 2073 7065 6369 6669 6320 6c61   the specific la
+00000230: 6e67 7561 6765 2067 6f76 6572 6e69 6e67  nguage governing
+00000240: 2070 6572 6d69 7373 696f 6e73 2061 6e64   permissions and
+00000250: 0a23 206c 696d 6974 6174 696f 6e73 2075  .# limitations u
+00000260: 6e64 6572 2074 6865 204c 6963 656e 7365  nder the License
+00000270: 2e0a 2222 2220 424c 4950 2d32 206d 6f64  ..""" BLIP-2 mod
+00000280: 656c 2063 6f6e 6669 6775 7261 7469 6f6e  el configuration
+00000290: 2222 220a 0a69 6d70 6f72 7420 6f73 0a66  """..import os.f
+000002a0: 726f 6d20 7479 7069 6e67 2069 6d70 6f72  rom typing impor
+000002b0: 7420 556e 696f 6e0a 0a66 726f 6d20 2e2e  t Union..from ..
+000002c0: 2e63 6f6e 6669 6775 7261 7469 6f6e 5f75  .configuration_u
+000002d0: 7469 6c73 2069 6d70 6f72 7420 5072 6574  tils import Pret
+000002e0: 7261 696e 6564 436f 6e66 6967 0a66 726f  rainedConfig.fro
+000002f0: 6d20 2e2e 2e6d 6f64 656c 732e 6175 746f  m ...models.auto
+00000300: 2e6d 6f64 656c 696e 675f 6175 746f 2069  .modeling_auto i
+00000310: 6d70 6f72 7420 4d4f 4445 4c5f 464f 525f  mport MODEL_FOR_
+00000320: 4341 5553 414c 5f4c 4d5f 4d41 5050 494e  CAUSAL_LM_MAPPIN
+00000330: 475f 4e41 4d45 530a 6672 6f6d 202e 2e2e  G_NAMES.from ...
+00000340: 2e75 7469 6c73 2069 6d70 6f72 7420 6c6f  .utils import lo
+00000350: 6767 696e 670a 6672 6f6d 202e 2e61 7574  gging.from ..aut
+00000360: 6f20 696d 706f 7274 2043 4f4e 4649 475f  o import CONFIG_
+00000370: 4d41 5050 494e 470a 0a6c 6f67 6765 7220  MAPPING..logger 
+00000380: 3d20 6c6f 6767 696e 672e 6765 745f 6c6f  = logging.get_lo
+00000390: 6767 6572 285f 5f6e 616d 655f 5f29 0a0a  gger(__name__)..
+000003a0: 0a63 6c61 7373 2042 6c69 7032 5669 7369  .class Blip2Visi
+000003b0: 6f6e 436f 6e66 6967 2850 7265 7472 6169  onConfig(Pretrai
+000003c0: 6e65 6443 6f6e 6669 6729 3a0a 2020 2020  nedConfig):.    
+000003d0: 7222 2222 0a20 2020 2054 6869 7320 6973  r""".    This is
+000003e0: 2074 6865 2063 6f6e 6669 6775 7261 7469   the configurati
+000003f0: 6f6e 2063 6c61 7373 2074 6f20 7374 6f72  on class to stor
+00000400: 6520 7468 6520 636f 6e66 6967 7572 6174  e the configurat
+00000410: 696f 6e20 6f66 2061 205b 6042 6c69 7032  ion of a [`Blip2
+00000420: 5669 7369 6f6e 4d6f 6465 6c60 5d2e 2049  VisionModel`]. I
+00000430: 7420 6973 2075 7365 6420 746f 2069 6e73  t is used to ins
+00000440: 7461 6e74 6961 7465 2061 0a20 2020 2042  tantiate a.    B
+00000450: 4c49 502d 3220 7669 7369 6f6e 2065 6e63  LIP-2 vision enc
+00000460: 6f64 6572 2061 6363 6f72 6469 6e67 2074  oder according t
+00000470: 6f20 7468 6520 7370 6563 6966 6965 6420  o the specified 
+00000480: 6172 6775 6d65 6e74 732c 2064 6566 696e  arguments, defin
+00000490: 696e 6720 7468 6520 6d6f 6465 6c20 6172  ing the model ar
+000004a0: 6368 6974 6563 7475 7265 2e20 496e 7374  chitecture. Inst
+000004b0: 616e 7469 6174 696e 6720 610a 2020 2020  antiating a.    
+000004c0: 636f 6e66 6967 7572 6174 696f 6e20 6465  configuration de
+000004d0: 6661 756c 7473 2077 696c 6c20 7969 656c  faults will yiel
+000004e0: 6420 6120 7369 6d69 6c61 7220 636f 6e66  d a similar conf
+000004f0: 6967 7572 6174 696f 6e20 746f 2074 6861  iguration to tha
+00000500: 7420 6f66 2074 6865 2042 4c49 502d 320a  t of the BLIP-2.
+00000510: 2020 2020 5b53 616c 6573 666f 7263 652f      [Salesforce/
+00000520: 626c 6970 322d 6f70 742d 322e 3762 5d28  blip2-opt-2.7b](
+00000530: 6874 7470 733a 2f2f 6875 6767 696e 6766  https://huggingf
+00000540: 6163 652e 636f 2f53 616c 6573 666f 7263  ace.co/Salesforc
+00000550: 652f 626c 6970 322d 6f70 742d 322e 3762  e/blip2-opt-2.7b
+00000560: 2920 6172 6368 6974 6563 7475 7265 2e0a  ) architecture..
+00000570: 0a20 2020 2043 6f6e 6669 6775 7261 7469  .    Configurati
+00000580: 6f6e 206f 626a 6563 7473 2069 6e68 6572  on objects inher
+00000590: 6974 2066 726f 6d20 5b60 5072 6574 7261  it from [`Pretra
+000005a0: 696e 6564 436f 6e66 6967 605d 2061 6e64  inedConfig`] and
+000005b0: 2063 616e 2062 6520 7573 6564 2074 6f20   can be used to 
+000005c0: 636f 6e74 726f 6c20 7468 6520 6d6f 6465  control the mode
+000005d0: 6c20 6f75 7470 7574 732e 2052 6561 6420  l outputs. Read 
+000005e0: 7468 650a 2020 2020 646f 6375 6d65 6e74  the.    document
+000005f0: 6174 696f 6e20 6672 6f6d 205b 6050 7265  ation from [`Pre
+00000600: 7472 6169 6e65 6443 6f6e 6669 6760 5d20  trainedConfig`] 
+00000610: 666f 7220 6d6f 7265 2069 6e66 6f72 6d61  for more informa
+00000620: 7469 6f6e 2e0a 0a20 2020 2041 7267 733a  tion...    Args:
+00000630: 0a20 2020 2020 2020 2068 6964 6465 6e5f  .        hidden_
+00000640: 7369 7a65 2028 6069 6e74 602c 202a 6f70  size (`int`, *op
+00000650: 7469 6f6e 616c 2a2c 2064 6566 6175 6c74  tional*, default
+00000660: 7320 746f 2031 3430 3829 3a0a 2020 2020  s to 1408):.    
+00000670: 2020 2020 2020 2020 4469 6d65 6e73 696f          Dimensio
+00000680: 6e61 6c69 7479 206f 6620 7468 6520 656e  nality of the en
+00000690: 636f 6465 7220 6c61 7965 7273 2061 6e64  coder layers and
+000006a0: 2074 6865 2070 6f6f 6c65 7220 6c61 7965   the pooler laye
+000006b0: 722e 0a20 2020 2020 2020 2069 6e74 6572  r..        inter
+000006c0: 6d65 6469 6174 655f 7369 7a65 2028 6069  mediate_size (`i
+000006d0: 6e74 602c 202a 6f70 7469 6f6e 616c 2a2c  nt`, *optional*,
+000006e0: 2064 6566 6175 6c74 7320 746f 2036 3134   defaults to 614
+000006f0: 3429 3a0a 2020 2020 2020 2020 2020 2020  4):.            
+00000700: 4469 6d65 6e73 696f 6e61 6c69 7479 206f  Dimensionality o
+00000710: 6620 7468 6520 2269 6e74 6572 6d65 6469  f the "intermedi
+00000720: 6174 6522 2028 692e 652e 2c20 6665 6564  ate" (i.e., feed
+00000730: 2d66 6f72 7761 7264 2920 6c61 7965 7220  -forward) layer 
+00000740: 696e 2074 6865 2054 7261 6e73 666f 726d  in the Transform
+00000750: 6572 2065 6e63 6f64 6572 2e0a 2020 2020  er encoder..    
+00000760: 2020 2020 6e75 6d5f 6869 6464 656e 5f6c      num_hidden_l
+00000770: 6179 6572 7320 2860 696e 7460 2c20 2a6f  ayers (`int`, *o
+00000780: 7074 696f 6e61 6c2a 2c20 6465 6661 756c  ptional*, defaul
+00000790: 7473 2074 6f20 3339 293a 0a20 2020 2020  ts to 39):.     
+000007a0: 2020 2020 2020 204e 756d 6265 7220 6f66         Number of
+000007b0: 2068 6964 6465 6e20 6c61 7965 7273 2069   hidden layers i
+000007c0: 6e20 7468 6520 5472 616e 7366 6f72 6d65  n the Transforme
+000007d0: 7220 656e 636f 6465 722e 0a20 2020 2020  r encoder..     
+000007e0: 2020 206e 756d 5f61 7474 656e 7469 6f6e     num_attention
+000007f0: 5f68 6561 6473 2028 6069 6e74 602c 202a  _heads (`int`, *
+00000800: 6f70 7469 6f6e 616c 2a2c 2064 6566 6175  optional*, defau
+00000810: 6c74 7320 746f 2031 3629 3a0a 2020 2020  lts to 16):.    
+00000820: 2020 2020 2020 2020 4e75 6d62 6572 206f          Number o
+00000830: 6620 6174 7465 6e74 696f 6e20 6865 6164  f attention head
+00000840: 7320 666f 7220 6561 6368 2061 7474 656e  s for each atten
+00000850: 7469 6f6e 206c 6179 6572 2069 6e20 7468  tion layer in th
+00000860: 6520 5472 616e 7366 6f72 6d65 7220 656e  e Transformer en
+00000870: 636f 6465 722e 0a20 2020 2020 2020 2069  coder..        i
+00000880: 6d61 6765 5f73 697a 6520 2860 696e 7460  mage_size (`int`
+00000890: 2c20 2a6f 7074 696f 6e61 6c2a 2c20 6465  , *optional*, de
+000008a0: 6661 756c 7473 2074 6f20 3232 3429 3a0a  faults to 224):.
+000008b0: 2020 2020 2020 2020 2020 2020 5468 6520              The 
+000008c0: 7369 7a65 2028 7265 736f 6c75 7469 6f6e  size (resolution
+000008d0: 2920 6f66 2065 6163 6820 696d 6167 652e  ) of each image.
+000008e0: 0a20 2020 2020 2020 2070 6174 6368 5f73  .        patch_s
+000008f0: 697a 6520 2860 696e 7460 2c20 2a6f 7074  ize (`int`, *opt
+00000900: 696f 6e61 6c2a 2c20 6465 6661 756c 7473  ional*, defaults
+00000910: 2074 6f20 3134 293a 0a20 2020 2020 2020   to 14):.       
+00000920: 2020 2020 2054 6865 2073 697a 6520 2872       The size (r
+00000930: 6573 6f6c 7574 696f 6e29 206f 6620 6561  esolution) of ea
+00000940: 6368 2070 6174 6368 2e0a 2020 2020 2020  ch patch..      
+00000950: 2020 6869 6464 656e 5f61 6374 2028 6073    hidden_act (`s
+00000960: 7472 6020 6f72 2060 6675 6e63 7469 6f6e  tr` or `function
+00000970: 602c 202a 6f70 7469 6f6e 616c 2a2c 2064  `, *optional*, d
+00000980: 6566 6175 6c74 7320 746f 2060 2267 656c  efaults to `"gel
+00000990: 7522 6029 3a0a 2020 2020 2020 2020 2020  u"`):.          
+000009a0: 2020 5468 6520 6e6f 6e2d 6c69 6e65 6172    The non-linear
+000009b0: 2061 6374 6976 6174 696f 6e20 6675 6e63   activation func
+000009c0: 7469 6f6e 2028 6675 6e63 7469 6f6e 206f  tion (function o
+000009d0: 7220 7374 7269 6e67 2920 696e 2074 6865  r string) in the
+000009e0: 2065 6e63 6f64 6572 2061 6e64 2070 6f6f   encoder and poo
+000009f0: 6c65 722e 2049 6620 7374 7269 6e67 2c20  ler. If string, 
+00000a00: 6022 6765 6c75 2260 2c0a 2020 2020 2020  `"gelu"`,.      
+00000a10: 2020 2020 2020 6022 7265 6c75 2260 2c20        `"relu"`, 
+00000a20: 6022 7365 6c75 2260 2061 6e64 2060 2267  `"selu"` and `"g
+00000a30: 656c 755f 6e65 7722 6020 6060 2267 656c  elu_new"` ``"gel
+00000a40: 7522 6020 6172 6520 7375 7070 6f72 7465  u"` are supporte
+00000a50: 642e 206c 6179 6572 5f6e 6f72 6d5f 6570  d. layer_norm_ep
+00000a60: 7320 2860 666c 6f61 7460 2c20 2a6f 7074  s (`float`, *opt
+00000a70: 696f 6e61 6c2a 2c20 6465 6661 756c 7473  ional*, defaults
+00000a80: 0a20 2020 2020 2020 2020 2020 2074 6f20  .            to 
+00000a90: 3165 2d35 293a 2054 6865 2065 7073 696c  1e-5): The epsil
+00000aa0: 6f6e 2075 7365 6420 6279 2074 6865 206c  on used by the l
+00000ab0: 6179 6572 206e 6f72 6d61 6c69 7a61 7469  ayer normalizati
+00000ac0: 6f6e 206c 6179 6572 732e 0a20 2020 2020  on layers..     
+00000ad0: 2020 2061 7474 656e 7469 6f6e 5f64 726f     attention_dro
+00000ae0: 706f 7574 2028 6066 6c6f 6174 602c 202a  pout (`float`, *
+00000af0: 6f70 7469 6f6e 616c 2a2c 2064 6566 6175  optional*, defau
+00000b00: 6c74 7320 746f 2030 2e30 293a 0a20 2020  lts to 0.0):.   
+00000b10: 2020 2020 2020 2020 2054 6865 2064 726f           The dro
+00000b20: 706f 7574 2072 6174 696f 2066 6f72 2074  pout ratio for t
+00000b30: 6865 2061 7474 656e 7469 6f6e 2070 726f  he attention pro
+00000b40: 6261 6269 6c69 7469 6573 2e0a 2020 2020  babilities..    
+00000b50: 2020 2020 696e 6974 6961 6c69 7a65 725f      initializer_
+00000b60: 7261 6e67 6520 2860 666c 6f61 7460 2c20  range (`float`, 
+00000b70: 2a6f 7074 696f 6e61 6c2a 2c20 6465 6661  *optional*, defa
+00000b80: 756c 7473 2074 6f20 302e 3032 293a 0a20  ults to 0.02):. 
+00000b90: 2020 2020 2020 2020 2020 2054 6865 2073             The s
+00000ba0: 7461 6e64 6172 6420 6465 7669 6174 696f  tandard deviatio
+00000bb0: 6e20 6f66 2074 6865 2074 7275 6e63 6174  n of the truncat
+00000bc0: 6564 5f6e 6f72 6d61 6c5f 696e 6974 6961  ed_normal_initia
+00000bd0: 6c69 7a65 7220 666f 7220 696e 6974 6961  lizer for initia
+00000be0: 6c69 7a69 6e67 2061 6c6c 2077 6569 6768  lizing all weigh
+00000bf0: 7420 6d61 7472 6963 6573 2e0a 2020 2020  t matrices..    
+00000c00: 2020 2020 716b 765f 6269 6173 2028 6062      qkv_bias (`b
+00000c10: 6f6f 6c60 2c20 2a6f 7074 696f 6e61 6c2a  ool`, *optional*
+00000c20: 2c20 6465 6661 756c 7473 2074 6f20 6054  , defaults to `T
+00000c30: 7275 6560 293a 0a20 2020 2020 2020 2020  rue`):.         
+00000c40: 2020 2057 6865 7468 6572 2074 6f20 6164     Whether to ad
+00000c50: 6420 6120 6269 6173 2074 6f20 7468 6520  d a bias to the 
+00000c60: 7175 6572 6965 7320 616e 6420 7661 6c75  queries and valu
+00000c70: 6573 2069 6e20 7468 6520 7365 6c66 2d61  es in the self-a
+00000c80: 7474 656e 7469 6f6e 206c 6179 6572 732e  ttention layers.
+00000c90: 0a0a 2020 2020 4578 616d 706c 653a 0a0a  ..    Example:..
+00000ca0: 2020 2020 6060 6070 7974 686f 6e0a 2020      ```python.  
+00000cb0: 2020 3e3e 3e20 6672 6f6d 2074 7261 6e73    >>> from trans
+00000cc0: 666f 726d 6572 7320 696d 706f 7274 2042  formers import B
+00000cd0: 6c69 7032 5669 7369 6f6e 436f 6e66 6967  lip2VisionConfig
+00000ce0: 2c20 426c 6970 3256 6973 696f 6e4d 6f64  , Blip2VisionMod
+00000cf0: 656c 0a0a 2020 2020 3e3e 3e20 2320 496e  el..    >>> # In
+00000d00: 6974 6961 6c69 7a69 6e67 2061 2042 6c69  itializing a Bli
+00000d10: 7032 5669 7369 6f6e 436f 6e66 6967 2077  p2VisionConfig w
+00000d20: 6974 6820 5361 6c65 7366 6f72 6365 2f62  ith Salesforce/b
+00000d30: 6c69 7032 2d6f 7074 2d32 2e37 6220 7374  lip2-opt-2.7b st
+00000d40: 796c 6520 636f 6e66 6967 7572 6174 696f  yle configuratio
+00000d50: 6e0a 2020 2020 3e3e 3e20 636f 6e66 6967  n.    >>> config
+00000d60: 7572 6174 696f 6e20 3d20 426c 6970 3256  uration = Blip2V
+00000d70: 6973 696f 6e43 6f6e 6669 6728 290a 0a20  isionConfig().. 
+00000d80: 2020 203e 3e3e 2023 2049 6e69 7469 616c     >>> # Initial
+00000d90: 697a 696e 6720 6120 426c 6970 3256 6973  izing a Blip2Vis
+00000da0: 696f 6e4d 6f64 656c 2028 7769 7468 2072  ionModel (with r
+00000db0: 616e 646f 6d20 7765 6967 6874 7329 2066  andom weights) f
+00000dc0: 726f 6d20 7468 6520 5361 6c65 7366 6f72  rom the Salesfor
+00000dd0: 6365 2f62 6c69 7032 2d6f 7074 2d32 2e37  ce/blip2-opt-2.7
+00000de0: 6220 7374 796c 6520 636f 6e66 6967 7572  b style configur
+00000df0: 6174 696f 6e0a 2020 2020 3e3e 3e20 6d6f  ation.    >>> mo
+00000e00: 6465 6c20 3d20 426c 6970 3256 6973 696f  del = Blip2Visio
+00000e10: 6e4d 6f64 656c 2863 6f6e 6669 6775 7261  nModel(configura
+00000e20: 7469 6f6e 290a 0a20 2020 203e 3e3e 2023  tion)..    >>> #
+00000e30: 2041 6363 6573 7369 6e67 2074 6865 206d   Accessing the m
+00000e40: 6f64 656c 2063 6f6e 6669 6775 7261 7469  odel configurati
+00000e50: 6f6e 0a20 2020 203e 3e3e 2063 6f6e 6669  on.    >>> confi
+00000e60: 6775 7261 7469 6f6e 203d 206d 6f64 656c  guration = model
+00000e70: 2e63 6f6e 6669 670a 2020 2020 6060 6022  .config.    ```"
+00000e80: 2222 0a0a 2020 2020 6d6f 6465 6c5f 7479  ""..    model_ty
+00000e90: 7065 203d 2022 626c 6970 5f32 5f76 6973  pe = "blip_2_vis
+00000ea0: 696f 6e5f 6d6f 6465 6c22 0a0a 2020 2020  ion_model"..    
+00000eb0: 6465 6620 5f5f 696e 6974 5f5f 280a 2020  def __init__(.  
+00000ec0: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+00000ed0: 2020 2020 6869 6464 656e 5f73 697a 653d      hidden_size=
+00000ee0: 3134 3038 2c0a 2020 2020 2020 2020 696e  1408,.        in
+00000ef0: 7465 726d 6564 6961 7465 5f73 697a 653d  termediate_size=
+00000f00: 3631 3434 2c0a 2020 2020 2020 2020 6e75  6144,.        nu
+00000f10: 6d5f 6869 6464 656e 5f6c 6179 6572 733d  m_hidden_layers=
+00000f20: 3339 2c0a 2020 2020 2020 2020 6e75 6d5f  39,.        num_
+00000f30: 6174 7465 6e74 696f 6e5f 6865 6164 733d  attention_heads=
+00000f40: 3136 2c0a 2020 2020 2020 2020 696d 6167  16,.        imag
+00000f50: 655f 7369 7a65 3d32 3234 2c0a 2020 2020  e_size=224,.    
+00000f60: 2020 2020 7061 7463 685f 7369 7a65 3d31      patch_size=1
+00000f70: 342c 0a20 2020 2020 2020 2068 6964 6465  4,.        hidde
+00000f80: 6e5f 6163 743d 2267 656c 7522 2c0a 2020  n_act="gelu",.  
+00000f90: 2020 2020 2020 6c61 7965 725f 6e6f 726d        layer_norm
+00000fa0: 5f65 7073 3d31 652d 362c 0a20 2020 2020  _eps=1e-6,.     
+00000fb0: 2020 2061 7474 656e 7469 6f6e 5f64 726f     attention_dro
+00000fc0: 706f 7574 3d30 2e30 2c0a 2020 2020 2020  pout=0.0,.      
+00000fd0: 2020 696e 6974 6961 6c69 7a65 725f 7261    initializer_ra
+00000fe0: 6e67 653d 3165 2d31 302c 0a20 2020 2020  nge=1e-10,.     
+00000ff0: 2020 2071 6b76 5f62 6961 733d 5472 7565     qkv_bias=True
+00001000: 2c0a 2020 2020 2020 2020 2a2a 6b77 6172  ,.        **kwar
+00001010: 6773 2c0a 2020 2020 293a 0a20 2020 2020  gs,.    ):.     
+00001020: 2020 2073 7570 6572 2829 2e5f 5f69 6e69     super().__ini
+00001030: 745f 5f28 2a2a 6b77 6172 6773 290a 0a20  t__(**kwargs).. 
+00001040: 2020 2020 2020 2073 656c 662e 6869 6464         self.hidd
+00001050: 656e 5f73 697a 6520 3d20 6869 6464 656e  en_size = hidden
+00001060: 5f73 697a 650a 2020 2020 2020 2020 7365  _size.        se
+00001070: 6c66 2e69 6e74 6572 6d65 6469 6174 655f  lf.intermediate_
+00001080: 7369 7a65 203d 2069 6e74 6572 6d65 6469  size = intermedi
+00001090: 6174 655f 7369 7a65 0a20 2020 2020 2020  ate_size.       
+000010a0: 2073 656c 662e 6e75 6d5f 6869 6464 656e   self.num_hidden
+000010b0: 5f6c 6179 6572 7320 3d20 6e75 6d5f 6869  _layers = num_hi
+000010c0: 6464 656e 5f6c 6179 6572 730a 2020 2020  dden_layers.    
+000010d0: 2020 2020 7365 6c66 2e6e 756d 5f61 7474      self.num_att
+000010e0: 656e 7469 6f6e 5f68 6561 6473 203d 206e  ention_heads = n
+000010f0: 756d 5f61 7474 656e 7469 6f6e 5f68 6561  um_attention_hea
+00001100: 6473 0a20 2020 2020 2020 2073 656c 662e  ds.        self.
+00001110: 7061 7463 685f 7369 7a65 203d 2070 6174  patch_size = pat
+00001120: 6368 5f73 697a 650a 2020 2020 2020 2020  ch_size.        
+00001130: 7365 6c66 2e69 6d61 6765 5f73 697a 6520  self.image_size 
+00001140: 3d20 696d 6167 655f 7369 7a65 0a20 2020  = image_size.   
+00001150: 2020 2020 2073 656c 662e 696e 6974 6961       self.initia
+00001160: 6c69 7a65 725f 7261 6e67 6520 3d20 696e  lizer_range = in
+00001170: 6974 6961 6c69 7a65 725f 7261 6e67 650a  itializer_range.
+00001180: 2020 2020 2020 2020 7365 6c66 2e61 7474          self.att
+00001190: 656e 7469 6f6e 5f64 726f 706f 7574 203d  ention_dropout =
+000011a0: 2061 7474 656e 7469 6f6e 5f64 726f 706f   attention_dropo
+000011b0: 7574 0a20 2020 2020 2020 2073 656c 662e  ut.        self.
+000011c0: 6c61 7965 725f 6e6f 726d 5f65 7073 203d  layer_norm_eps =
+000011d0: 206c 6179 6572 5f6e 6f72 6d5f 6570 730a   layer_norm_eps.
+000011e0: 2020 2020 2020 2020 7365 6c66 2e68 6964          self.hid
+000011f0: 6465 6e5f 6163 7420 3d20 6869 6464 656e  den_act = hidden
+00001200: 5f61 6374 0a20 2020 2020 2020 2073 656c  _act.        sel
+00001210: 662e 716b 765f 6269 6173 203d 2071 6b76  f.qkv_bias = qkv
+00001220: 5f62 6961 730a 0a20 2020 2040 636c 6173  _bias..    @clas
+00001230: 736d 6574 686f 640a 2020 2020 6465 6620  smethod.    def 
+00001240: 6672 6f6d 5f70 7265 7472 6169 6e65 6428  from_pretrained(
+00001250: 636c 732c 2070 7265 7472 6169 6e65 645f  cls, pretrained_
+00001260: 6d6f 6465 6c5f 6e61 6d65 5f6f 725f 7061  model_name_or_pa
+00001270: 7468 3a20 556e 696f 6e5b 7374 722c 206f  th: Union[str, o
+00001280: 732e 5061 7468 4c69 6b65 5d2c 202a 2a6b  s.PathLike], **k
+00001290: 7761 7267 7329 202d 3e20 2250 7265 7472  wargs) -> "Pretr
+000012a0: 6169 6e65 6443 6f6e 6669 6722 3a0a 2020  ainedConfig":.  
+000012b0: 2020 2020 2020 636f 6e66 6967 5f64 6963        config_dic
+000012c0: 742c 206b 7761 7267 7320 3d20 636c 732e  t, kwargs = cls.
+000012d0: 6765 745f 636f 6e66 6967 5f64 6963 7428  get_config_dict(
+000012e0: 7072 6574 7261 696e 6564 5f6d 6f64 656c  pretrained_model
+000012f0: 5f6e 616d 655f 6f72 5f70 6174 682c 202a  _name_or_path, *
+00001300: 2a6b 7761 7267 7329 0a0a 2020 2020 2020  *kwargs)..      
+00001310: 2020 2320 6765 7420 7468 6520 7669 7369    # get the visi
+00001320: 6f6e 2063 6f6e 6669 6720 6469 6374 2069  on config dict i
+00001330: 6620 7765 2061 7265 206c 6f61 6469 6e67  f we are loading
+00001340: 2066 726f 6d20 426c 6970 3243 6f6e 6669   from Blip2Confi
+00001350: 670a 2020 2020 2020 2020 6966 2063 6f6e  g.        if con
+00001360: 6669 675f 6469 6374 2e67 6574 2822 6d6f  fig_dict.get("mo
+00001370: 6465 6c5f 7479 7065 2229 203d 3d20 2262  del_type") == "b
+00001380: 6c69 702d 3222 3a0a 2020 2020 2020 2020  lip-2":.        
+00001390: 2020 2020 636f 6e66 6967 5f64 6963 7420      config_dict 
+000013a0: 3d20 636f 6e66 6967 5f64 6963 745b 2276  = config_dict["v
+000013b0: 6973 696f 6e5f 636f 6e66 6967 225d 0a0a  ision_config"]..
+000013c0: 2020 2020 2020 2020 6966 2022 6d6f 6465          if "mode
+000013d0: 6c5f 7479 7065 2220 696e 2063 6f6e 6669  l_type" in confi
+000013e0: 675f 6469 6374 2061 6e64 2068 6173 6174  g_dict and hasat
+000013f0: 7472 2863 6c73 2c20 226d 6f64 656c 5f74  tr(cls, "model_t
+00001400: 7970 6522 2920 616e 6420 636f 6e66 6967  ype") and config
+00001410: 5f64 6963 745b 226d 6f64 656c 5f74 7970  _dict["model_typ
+00001420: 6522 5d20 213d 2063 6c73 2e6d 6f64 656c  e"] != cls.model
+00001430: 5f74 7970 653a 0a20 2020 2020 2020 2020  _type:.         
+00001440: 2020 206c 6f67 6765 722e 7761 726e 696e     logger.warnin
+00001450: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
+00001460: 2020 2066 2259 6f75 2061 7265 2075 7369     f"You are usi
+00001470: 6e67 2061 206d 6f64 656c 206f 6620 7479  ng a model of ty
+00001480: 7065 207b 636f 6e66 6967 5f64 6963 745b  pe {config_dict[
+00001490: 276d 6f64 656c 5f74 7970 6527 5d7d 2074  'model_type']} t
+000014a0: 6f20 696e 7374 616e 7469 6174 6520 6120  o instantiate a 
+000014b0: 6d6f 6465 6c20 6f66 2074 7970 6520 220a  model of type ".
+000014c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000014d0: 6622 7b63 6c73 2e6d 6f64 656c 5f74 7970  f"{cls.model_typ
+000014e0: 657d 2e20 5468 6973 2069 7320 6e6f 7420  e}. This is not 
+000014f0: 7375 7070 6f72 7465 6420 666f 7220 616c  supported for al
+00001500: 6c20 636f 6e66 6967 7572 6174 696f 6e73  l configurations
+00001510: 206f 6620 6d6f 6465 6c73 2061 6e64 2063   of models and c
+00001520: 616e 2079 6965 6c64 2065 7272 6f72 732e  an yield errors.
+00001530: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
+00001540: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00001550: 636c 732e 6672 6f6d 5f64 6963 7428 636f  cls.from_dict(co
+00001560: 6e66 6967 5f64 6963 742c 202a 2a6b 7761  nfig_dict, **kwa
+00001570: 7267 7329 0a0a 0a63 6c61 7373 2042 6c69  rgs)...class Bli
+00001580: 7032 5146 6f72 6d65 7243 6f6e 6669 6728  p2QFormerConfig(
+00001590: 5072 6574 7261 696e 6564 436f 6e66 6967  PretrainedConfig
+000015a0: 293a 0a20 2020 2072 2222 220a 2020 2020  ):.    r""".    
+000015b0: 5468 6973 2069 7320 7468 6520 636f 6e66  This is the conf
+000015c0: 6967 7572 6174 696f 6e20 636c 6173 7320  iguration class 
+000015d0: 746f 2073 746f 7265 2074 6865 2063 6f6e  to store the con
+000015e0: 6669 6775 7261 7469 6f6e 206f 6620 6120  figuration of a 
+000015f0: 5b60 426c 6970 3251 466f 726d 6572 4d6f  [`Blip2QFormerMo
+00001600: 6465 6c60 5d2e 2049 7420 6973 2075 7365  del`]. It is use
+00001610: 6420 746f 2069 6e73 7461 6e74 6961 7465  d to instantiate
+00001620: 2061 0a20 2020 2042 4c49 502d 3220 5175   a.    BLIP-2 Qu
+00001630: 6572 7969 6e67 2054 7261 6e73 666f 726d  erying Transform
+00001640: 6572 2028 512d 466f 726d 6572 2920 6d6f  er (Q-Former) mo
+00001650: 6465 6c20 6163 636f 7264 696e 6720 746f  del according to
+00001660: 2074 6865 2073 7065 6369 6669 6564 2061   the specified a
+00001670: 7267 756d 656e 7473 2c20 6465 6669 6e69  rguments, defini
+00001680: 6e67 2074 6865 206d 6f64 656c 2061 7263  ng the model arc
+00001690: 6869 7465 6374 7572 652e 0a20 2020 2049  hitecture..    I
+000016a0: 6e73 7461 6e74 6961 7469 6e67 2061 2063  nstantiating a c
+000016b0: 6f6e 6669 6775 7261 7469 6f6e 2077 6974  onfiguration wit
+000016c0: 6820 7468 6520 6465 6661 756c 7473 2077  h the defaults w
+000016d0: 696c 6c20 7969 656c 6420 6120 7369 6d69  ill yield a simi
+000016e0: 6c61 7220 636f 6e66 6967 7572 6174 696f  lar configuratio
+000016f0: 6e20 746f 2074 6861 7420 6f66 2074 6865  n to that of the
+00001700: 2042 4c49 502d 320a 2020 2020 5b53 616c   BLIP-2.    [Sal
+00001710: 6573 666f 7263 652f 626c 6970 322d 6f70  esforce/blip2-op
+00001720: 742d 322e 3762 5d28 6874 7470 733a 2f2f  t-2.7b](https://
+00001730: 6875 6767 696e 6766 6163 652e 636f 2f53  huggingface.co/S
+00001740: 616c 6573 666f 7263 652f 626c 6970 322d  alesforce/blip2-
+00001750: 6f70 742d 322e 3762 2920 6172 6368 6974  opt-2.7b) archit
+00001760: 6563 7475 7265 2e20 436f 6e66 6967 7572  ecture. Configur
+00001770: 6174 696f 6e20 6f62 6a65 6374 730a 2020  ation objects.  
+00001780: 2020 696e 6865 7269 7420 6672 6f6d 205b    inherit from [
+00001790: 6050 7265 7472 6169 6e65 6443 6f6e 6669  `PretrainedConfi
+000017a0: 6760 5d20 616e 6420 6361 6e20 6265 2075  g`] and can be u
+000017b0: 7365 6420 746f 2063 6f6e 7472 6f6c 2074  sed to control t
+000017c0: 6865 206d 6f64 656c 206f 7574 7075 7473  he model outputs
+000017d0: 2e20 5265 6164 2074 6865 2064 6f63 756d  . Read the docum
+000017e0: 656e 7461 7469 6f6e 2066 726f 6d0a 2020  entation from.  
+000017f0: 2020 5b60 5072 6574 7261 696e 6564 436f    [`PretrainedCo
+00001800: 6e66 6967 605d 2066 6f72 206d 6f72 6520  nfig`] for more 
+00001810: 696e 666f 726d 6174 696f 6e2e 0a0a 2020  information...  
+00001820: 2020 4e6f 7465 2074 6861 7420 5b60 426c    Note that [`Bl
+00001830: 6970 3251 466f 726d 6572 4d6f 6465 6c60  ip2QFormerModel`
+00001840: 5d20 6973 2076 6572 7920 7369 6d69 6c61  ] is very simila
+00001850: 7220 746f 205b 6042 6572 744c 4d48 6561  r to [`BertLMHea
+00001860: 644d 6f64 656c 605d 2077 6974 6820 696e  dModel`] with in
+00001870: 7465 726c 6561 7665 6420 6372 6f73 732d  terleaved cross-
+00001880: 6174 7465 6e74 696f 6e2e 0a0a 2020 2020  attention...    
+00001890: 4172 6773 3a0a 2020 2020 2020 2020 766f  Args:.        vo
+000018a0: 6361 625f 7369 7a65 2028 6069 6e74 602c  cab_size (`int`,
+000018b0: 202a 6f70 7469 6f6e 616c 2a2c 2064 6566   *optional*, def
+000018c0: 6175 6c74 7320 746f 2033 3035 3232 293a  aults to 30522):
+000018d0: 0a20 2020 2020 2020 2020 2020 2056 6f63  .            Voc
+000018e0: 6162 756c 6172 7920 7369 7a65 206f 6620  abulary size of 
+000018f0: 7468 6520 512d 466f 726d 6572 206d 6f64  the Q-Former mod
+00001900: 656c 2e20 4465 6669 6e65 7320 7468 6520  el. Defines the 
+00001910: 6e75 6d62 6572 206f 6620 6469 6666 6572  number of differ
+00001920: 656e 7420 746f 6b65 6e73 2074 6861 7420  ent tokens that 
+00001930: 6361 6e20 6265 2072 6570 7265 7365 6e74  can be represent
+00001940: 6564 2062 790a 2020 2020 2020 2020 2020  ed by.          
+00001950: 2020 7468 6520 6069 6e70 7574 735f 6964    the `inputs_id
+00001960: 7360 2070 6173 7365 6420 7768 656e 2063  s` passed when c
+00001970: 616c 6c69 6e67 2074 6865 206d 6f64 656c  alling the model
+00001980: 2e0a 2020 2020 2020 2020 6869 6464 656e  ..        hidden
+00001990: 5f73 697a 6520 2860 696e 7460 2c20 2a6f  _size (`int`, *o
+000019a0: 7074 696f 6e61 6c2a 2c20 6465 6661 756c  ptional*, defaul
+000019b0: 7473 2074 6f20 3736 3829 3a0a 2020 2020  ts to 768):.    
+000019c0: 2020 2020 2020 2020 4469 6d65 6e73 696f          Dimensio
+000019d0: 6e61 6c69 7479 206f 6620 7468 6520 656e  nality of the en
+000019e0: 636f 6465 7220 6c61 7965 7273 2061 6e64  coder layers and
+000019f0: 2074 6865 2070 6f6f 6c65 7220 6c61 7965   the pooler laye
+00001a00: 722e 0a20 2020 2020 2020 206e 756d 5f68  r..        num_h
+00001a10: 6964 6465 6e5f 6c61 7965 7273 2028 6069  idden_layers (`i
+00001a20: 6e74 602c 202a 6f70 7469 6f6e 616c 2a2c  nt`, *optional*,
+00001a30: 2064 6566 6175 6c74 7320 746f 2031 3229   defaults to 12)
+00001a40: 3a0a 2020 2020 2020 2020 2020 2020 4e75  :.            Nu
+00001a50: 6d62 6572 206f 6620 6869 6464 656e 206c  mber of hidden l
+00001a60: 6179 6572 7320 696e 2074 6865 2054 7261  ayers in the Tra
+00001a70: 6e73 666f 726d 6572 2065 6e63 6f64 6572  nsformer encoder
+00001a80: 2e0a 2020 2020 2020 2020 6e75 6d5f 6174  ..        num_at
+00001a90: 7465 6e74 696f 6e5f 6865 6164 7320 2860  tention_heads (`
+00001aa0: 696e 7460 2c20 2a6f 7074 696f 6e61 6c2a  int`, *optional*
+00001ab0: 2c20 6465 6661 756c 7473 2074 6f20 3132  , defaults to 12
+00001ac0: 293a 0a20 2020 2020 2020 2020 2020 204e  ):.            N
+00001ad0: 756d 6265 7220 6f66 2061 7474 656e 7469  umber of attenti
+00001ae0: 6f6e 2068 6561 6473 2066 6f72 2065 6163  on heads for eac
+00001af0: 6820 6174 7465 6e74 696f 6e20 6c61 7965  h attention laye
+00001b00: 7220 696e 2074 6865 2054 7261 6e73 666f  r in the Transfo
+00001b10: 726d 6572 2065 6e63 6f64 6572 2e0a 2020  rmer encoder..  
+00001b20: 2020 2020 2020 696e 7465 726d 6564 6961        intermedia
+00001b30: 7465 5f73 697a 6520 2860 696e 7460 2c20  te_size (`int`, 
+00001b40: 2a6f 7074 696f 6e61 6c2a 2c20 6465 6661  *optional*, defa
+00001b50: 756c 7473 2074 6f20 3330 3732 293a 0a20  ults to 3072):. 
+00001b60: 2020 2020 2020 2020 2020 2044 696d 656e             Dimen
+00001b70: 7369 6f6e 616c 6974 7920 6f66 2074 6865  sionality of the
+00001b80: 2022 696e 7465 726d 6564 6961 7465 2220   "intermediate" 
+00001b90: 286f 6674 656e 206e 616d 6564 2066 6565  (often named fee
+00001ba0: 642d 666f 7277 6172 6429 206c 6179 6572  d-forward) layer
+00001bb0: 2069 6e20 7468 6520 5472 616e 7366 6f72   in the Transfor
+00001bc0: 6d65 7220 656e 636f 6465 722e 0a20 2020  mer encoder..   
+00001bd0: 2020 2020 2068 6964 6465 6e5f 6163 7420       hidden_act 
+00001be0: 2860 7374 7260 206f 7220 6043 616c 6c61  (`str` or `Calla
+00001bf0: 626c 6560 2c20 2a6f 7074 696f 6e61 6c2a  ble`, *optional*
+00001c00: 2c20 6465 6661 756c 7473 2074 6f20 6022  , defaults to `"
+00001c10: 6765 6c75 2260 293a 0a20 2020 2020 2020  gelu"`):.       
+00001c20: 2020 2020 2054 6865 206e 6f6e 2d6c 696e       The non-lin
+00001c30: 6561 7220 6163 7469 7661 7469 6f6e 2066  ear activation f
+00001c40: 756e 6374 696f 6e20 2866 756e 6374 696f  unction (functio
+00001c50: 6e20 6f72 2073 7472 696e 6729 2069 6e20  n or string) in 
+00001c60: 7468 6520 656e 636f 6465 7220 616e 6420  the encoder and 
+00001c70: 706f 6f6c 6572 2e20 4966 2073 7472 696e  pooler. If strin
+00001c80: 672c 2060 2267 656c 7522 602c 0a20 2020  g, `"gelu"`,.   
+00001c90: 2020 2020 2020 2020 2060 2272 656c 7522           `"relu"
+00001ca0: 602c 2060 2273 696c 7522 6020 616e 6420  `, `"silu"` and 
+00001cb0: 6022 6765 6c75 5f6e 6577 2260 2061 7265  `"gelu_new"` are
+00001cc0: 2073 7570 706f 7274 6564 2e0a 2020 2020   supported..    
+00001cd0: 2020 2020 6869 6464 656e 5f64 726f 706f      hidden_dropo
+00001ce0: 7574 5f70 726f 6220 2860 666c 6f61 7460  ut_prob (`float`
+00001cf0: 2c20 2a6f 7074 696f 6e61 6c2a 2c20 6465  , *optional*, de
+00001d00: 6661 756c 7473 2074 6f20 302e 3129 3a0a  faults to 0.1):.
+00001d10: 2020 2020 2020 2020 2020 2020 5468 6520              The 
+00001d20: 6472 6f70 6f75 7420 7072 6f62 6162 696c  dropout probabil
+00001d30: 6974 7920 666f 7220 616c 6c20 6675 6c6c  ity for all full
+00001d40: 7920 636f 6e6e 6563 7465 6420 6c61 7965  y connected laye
+00001d50: 7273 2069 6e20 7468 6520 656d 6265 6464  rs in the embedd
+00001d60: 696e 6773 2c20 656e 636f 6465 722c 2061  ings, encoder, a
+00001d70: 6e64 2070 6f6f 6c65 722e 0a20 2020 2020  nd pooler..     
+00001d80: 2020 2061 7474 656e 7469 6f6e 5f70 726f     attention_pro
+00001d90: 6273 5f64 726f 706f 7574 5f70 726f 6220  bs_dropout_prob 
+00001da0: 2860 666c 6f61 7460 2c20 2a6f 7074 696f  (`float`, *optio
+00001db0: 6e61 6c2a 2c20 6465 6661 756c 7473 2074  nal*, defaults t
+00001dc0: 6f20 302e 3129 3a0a 2020 2020 2020 2020  o 0.1):.        
+00001dd0: 2020 2020 5468 6520 6472 6f70 6f75 7420      The dropout 
+00001de0: 7261 7469 6f20 666f 7220 7468 6520 6174  ratio for the at
+00001df0: 7465 6e74 696f 6e20 7072 6f62 6162 696c  tention probabil
+00001e00: 6974 6965 732e 0a20 2020 2020 2020 206d  ities..        m
+00001e10: 6178 5f70 6f73 6974 696f 6e5f 656d 6265  ax_position_embe
+00001e20: 6464 696e 6773 2028 6069 6e74 602c 202a  ddings (`int`, *
+00001e30: 6f70 7469 6f6e 616c 2a2c 2064 6566 6175  optional*, defau
+00001e40: 6c74 7320 746f 2035 3132 293a 0a20 2020  lts to 512):.   
+00001e50: 2020 2020 2020 2020 2054 6865 206d 6178           The max
+00001e60: 696d 756d 2073 6571 7565 6e63 6520 6c65  imum sequence le
+00001e70: 6e67 7468 2074 6861 7420 7468 6973 206d  ngth that this m
+00001e80: 6f64 656c 206d 6967 6874 2065 7665 7220  odel might ever 
+00001e90: 6265 2075 7365 6420 7769 7468 2e20 5479  be used with. Ty
+00001ea0: 7069 6361 6c6c 7920 7365 7420 7468 6973  pically set this
+00001eb0: 2074 6f20 736f 6d65 7468 696e 6720 6c61   to something la
+00001ec0: 7267 650a 2020 2020 2020 2020 2020 2020  rge.            
+00001ed0: 6a75 7374 2069 6e20 6361 7365 2028 652e  just in case (e.
+00001ee0: 672e 2c20 3531 3220 6f72 2031 3032 3420  g., 512 or 1024 
+00001ef0: 6f72 2032 3034 3829 2e0a 2020 2020 2020  or 2048)..      
+00001f00: 2020 696e 6974 6961 6c69 7a65 725f 7261    initializer_ra
+00001f10: 6e67 6520 2860 666c 6f61 7460 2c20 2a6f  nge (`float`, *o
+00001f20: 7074 696f 6e61 6c2a 2c20 6465 6661 756c  ptional*, defaul
+00001f30: 7473 2074 6f20 302e 3032 293a 0a20 2020  ts to 0.02):.   
+00001f40: 2020 2020 2020 2020 2054 6865 2073 7461           The sta
+00001f50: 6e64 6172 6420 6465 7669 6174 696f 6e20  ndard deviation 
+00001f60: 6f66 2074 6865 2074 7275 6e63 6174 6564  of the truncated
+00001f70: 5f6e 6f72 6d61 6c5f 696e 6974 6961 6c69  _normal_initiali
+00001f80: 7a65 7220 666f 7220 696e 6974 6961 6c69  zer for initiali
+00001f90: 7a69 6e67 2061 6c6c 2077 6569 6768 7420  zing all weight 
+00001fa0: 6d61 7472 6963 6573 2e0a 2020 2020 2020  matrices..      
+00001fb0: 2020 6c61 7965 725f 6e6f 726d 5f65 7073    layer_norm_eps
+00001fc0: 2028 6066 6c6f 6174 602c 202a 6f70 7469   (`float`, *opti
+00001fd0: 6f6e 616c 2a2c 2064 6566 6175 6c74 7320  onal*, defaults 
+00001fe0: 746f 2031 652d 3132 293a 0a20 2020 2020  to 1e-12):.     
+00001ff0: 2020 2020 2020 2054 6865 2065 7073 696c         The epsil
+00002000: 6f6e 2075 7365 6420 6279 2074 6865 206c  on used by the l
+00002010: 6179 6572 206e 6f72 6d61 6c69 7a61 7469  ayer normalizati
+00002020: 6f6e 206c 6179 6572 732e 0a20 2020 2020  on layers..     
+00002030: 2020 2070 6f73 6974 696f 6e5f 656d 6265     position_embe
+00002040: 6464 696e 675f 7479 7065 2028 6073 7472  dding_type (`str
+00002050: 602c 202a 6f70 7469 6f6e 616c 2a2c 2064  `, *optional*, d
+00002060: 6566 6175 6c74 7320 746f 2060 2261 6273  efaults to `"abs
+00002070: 6f6c 7574 6522 6029 3a0a 2020 2020 2020  olute"`):.      
+00002080: 2020 2020 2020 5479 7065 206f 6620 706f        Type of po
+00002090: 7369 7469 6f6e 2065 6d62 6564 6469 6e67  sition embedding
+000020a0: 2e20 4368 6f6f 7365 206f 6e65 206f 6620  . Choose one of 
+000020b0: 6022 6162 736f 6c75 7465 2260 2c20 6022  `"absolute"`, `"
+000020c0: 7265 6c61 7469 7665 5f6b 6579 2260 2c20  relative_key"`, 
+000020d0: 6022 7265 6c61 7469 7665 5f6b 6579 5f71  `"relative_key_q
+000020e0: 7565 7279 2260 2e20 466f 720a 2020 2020  uery"`. For.    
+000020f0: 2020 2020 2020 2020 706f 7369 7469 6f6e          position
+00002100: 616c 2065 6d62 6564 6469 6e67 7320 7573  al embeddings us
+00002110: 6520 6022 6162 736f 6c75 7465 2260 2e20  e `"absolute"`. 
+00002120: 466f 7220 6d6f 7265 2069 6e66 6f72 6d61  For more informa
+00002130: 7469 6f6e 206f 6e20 6022 7265 6c61 7469  tion on `"relati
+00002140: 7665 5f6b 6579 2260 2c20 706c 6561 7365  ve_key"`, please
+00002150: 2072 6566 6572 2074 6f0a 2020 2020 2020   refer to.      
+00002160: 2020 2020 2020 5b53 656c 662d 4174 7465        [Self-Atte
+00002170: 6e74 696f 6e20 7769 7468 2052 656c 6174  ntion with Relat
+00002180: 6976 6520 506f 7369 7469 6f6e 2052 6570  ive Position Rep
+00002190: 7265 7365 6e74 6174 696f 6e73 2028 5368  resentations (Sh
+000021a0: 6177 2065 7420 616c 2e29 5d28 6874 7470  aw et al.)](http
+000021b0: 733a 2f2f 6172 7869 762e 6f72 672f 6162  s://arxiv.org/ab
+000021c0: 732f 3138 3033 2e30 3231 3535 292e 0a20  s/1803.02155).. 
+000021d0: 2020 2020 2020 2020 2020 2046 6f72 206d             For m
+000021e0: 6f72 6520 696e 666f 726d 6174 696f 6e20  ore information 
+000021f0: 6f6e 2060 2272 656c 6174 6976 655f 6b65  on `"relative_ke
+00002200: 795f 7175 6572 7922 602c 2070 6c65 6173  y_query"`, pleas
+00002210: 6520 7265 6665 7220 746f 202a 4d65 7468  e refer to *Meth
+00002220: 6f64 2034 2a20 696e 205b 496d 7072 6f76  od 4* in [Improv
+00002230: 6520 5472 616e 7366 6f72 6d65 7220 4d6f  e Transformer Mo
+00002240: 6465 6c73 0a20 2020 2020 2020 2020 2020  dels.           
+00002250: 2077 6974 6820 4265 7474 6572 2052 656c   with Better Rel
+00002260: 6174 6976 6520 506f 7369 7469 6f6e 2045  ative Position E
+00002270: 6d62 6564 6469 6e67 7320 2848 7561 6e67  mbeddings (Huang
+00002280: 2065 7420 616c 2e29 5d28 6874 7470 733a   et al.)](https:
+00002290: 2f2f 6172 7869 762e 6f72 672f 6162 732f  //arxiv.org/abs/
+000022a0: 3230 3039 2e31 3336 3538 292e 0a20 2020  2009.13658)..   
+000022b0: 2020 2020 2063 726f 7373 5f61 7474 656e       cross_atten
+000022c0: 7469 6f6e 5f66 7265 7175 656e 6379 2028  tion_frequency (
+000022d0: 6069 6e74 602c 202a 6f70 7469 6f6e 616c  `int`, *optional
+000022e0: 2a2c 2064 6566 6175 6c74 7320 746f 2032  *, defaults to 2
+000022f0: 293a 0a20 2020 2020 2020 2020 2020 2054  ):.            T
+00002300: 6865 2066 7265 7175 656e 6379 206f 6620  he frequency of 
+00002310: 6164 6469 6e67 2063 726f 7373 2d61 7474  adding cross-att
+00002320: 656e 7469 6f6e 2074 6f20 7468 6520 5472  ention to the Tr
+00002330: 616e 7366 6f72 6d65 7220 6c61 7965 7273  ansformer layers
+00002340: 2e0a 2020 2020 2020 2020 656e 636f 6465  ..        encode
+00002350: 725f 6869 6464 656e 5f73 697a 6520 2860  r_hidden_size (`
+00002360: 696e 7460 2c20 2a6f 7074 696f 6e61 6c2a  int`, *optional*
+00002370: 2c20 6465 6661 756c 7473 2074 6f20 3134  , defaults to 14
+00002380: 3038 293a 0a20 2020 2020 2020 2020 2020  08):.           
+00002390: 2054 6865 2068 6964 6465 6e20 7369 7a65   The hidden size
+000023a0: 206f 6620 7468 6520 6869 6464 656e 2073   of the hidden s
+000023b0: 7461 7465 7320 666f 7220 6372 6f73 732d  tates for cross-
+000023c0: 6174 7465 6e74 696f 6e2e 0a0a 2020 2020  attention...    
+000023d0: 4578 616d 706c 6573 3a0a 0a20 2020 2060  Examples:..    `
+000023e0: 6060 7079 7468 6f6e 0a20 2020 203e 3e3e  ``python.    >>>
+000023f0: 2066 726f 6d20 7472 616e 7366 6f72 6d65   from transforme
+00002400: 7273 2069 6d70 6f72 7420 426c 6970 3251  rs import Blip2Q
+00002410: 466f 726d 6572 436f 6e66 6967 2c20 426c  FormerConfig, Bl
+00002420: 6970 3251 466f 726d 6572 4d6f 6465 6c0a  ip2QFormerModel.
+00002430: 0a20 2020 203e 3e3e 2023 2049 6e69 7469  .    >>> # Initi
+00002440: 616c 697a 696e 6720 6120 424c 4950 2d32  alizing a BLIP-2
+00002450: 2053 616c 6573 666f 7263 652f 626c 6970   Salesforce/blip
+00002460: 322d 6f70 742d 322e 3762 2073 7479 6c65  2-opt-2.7b style
+00002470: 2063 6f6e 6669 6775 7261 7469 6f6e 0a20   configuration. 
+00002480: 2020 203e 3e3e 2063 6f6e 6669 6775 7261     >>> configura
+00002490: 7469 6f6e 203d 2042 6c69 7032 5146 6f72  tion = Blip2QFor
+000024a0: 6d65 7243 6f6e 6669 6728 290a 0a20 2020  merConfig()..   
+000024b0: 203e 3e3e 2023 2049 6e69 7469 616c 697a   >>> # Initializ
+000024c0: 696e 6720 6120 6d6f 6465 6c20 2877 6974  ing a model (wit
+000024d0: 6820 7261 6e64 6f6d 2077 6569 6768 7473  h random weights
+000024e0: 2920 6672 6f6d 2074 6865 2053 616c 6573  ) from the Sales
+000024f0: 666f 7263 652f 626c 6970 322d 6f70 742d  force/blip2-opt-
+00002500: 322e 3762 2073 7479 6c65 2063 6f6e 6669  2.7b style confi
+00002510: 6775 7261 7469 6f6e 0a20 2020 203e 3e3e  guration.    >>>
+00002520: 206d 6f64 656c 203d 2042 6c69 7032 5146   model = Blip2QF
+00002530: 6f72 6d65 724d 6f64 656c 2863 6f6e 6669  ormerModel(confi
+00002540: 6775 7261 7469 6f6e 290a 2020 2020 3e3e  guration).    >>
+00002550: 3e20 2320 4163 6365 7373 696e 6720 7468  > # Accessing th
+00002560: 6520 6d6f 6465 6c20 636f 6e66 6967 7572  e model configur
+00002570: 6174 696f 6e0a 2020 2020 3e3e 3e20 636f  ation.    >>> co
+00002580: 6e66 6967 7572 6174 696f 6e20 3d20 6d6f  nfiguration = mo
+00002590: 6465 6c2e 636f 6e66 6967 0a20 2020 2060  del.config.    `
+000025a0: 6060 2222 220a 0a20 2020 206d 6f64 656c  ``"""..    model
+000025b0: 5f74 7970 6520 3d20 2262 6c69 705f 325f  _type = "blip_2_
+000025c0: 7166 6f72 6d65 7222 0a0a 2020 2020 6465  qformer"..    de
+000025d0: 6620 5f5f 696e 6974 5f5f 280a 2020 2020  f __init__(.    
+000025e0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+000025f0: 2020 766f 6361 625f 7369 7a65 3d33 3035    vocab_size=305
+00002600: 3232 2c0a 2020 2020 2020 2020 6869 6464  22,.        hidd
+00002610: 656e 5f73 697a 653d 3736 382c 0a20 2020  en_size=768,.   
+00002620: 2020 2020 206e 756d 5f68 6964 6465 6e5f       num_hidden_
+00002630: 6c61 7965 7273 3d31 322c 0a20 2020 2020  layers=12,.     
+00002640: 2020 206e 756d 5f61 7474 656e 7469 6f6e     num_attention
+00002650: 5f68 6561 6473 3d31 322c 0a20 2020 2020  _heads=12,.     
+00002660: 2020 2069 6e74 6572 6d65 6469 6174 655f     intermediate_
+00002670: 7369 7a65 3d33 3037 322c 0a20 2020 2020  size=3072,.     
+00002680: 2020 2068 6964 6465 6e5f 6163 743d 2267     hidden_act="g
+00002690: 656c 7522 2c0a 2020 2020 2020 2020 6869  elu",.        hi
+000026a0: 6464 656e 5f64 726f 706f 7574 5f70 726f  dden_dropout_pro
+000026b0: 623d 302e 312c 0a20 2020 2020 2020 2061  b=0.1,.        a
+000026c0: 7474 656e 7469 6f6e 5f70 726f 6273 5f64  ttention_probs_d
+000026d0: 726f 706f 7574 5f70 726f 623d 302e 312c  ropout_prob=0.1,
+000026e0: 0a20 2020 2020 2020 206d 6178 5f70 6f73  .        max_pos
+000026f0: 6974 696f 6e5f 656d 6265 6464 696e 6773  ition_embeddings
+00002700: 3d35 3132 2c0a 2020 2020 2020 2020 696e  =512,.        in
+00002710: 6974 6961 6c69 7a65 725f 7261 6e67 653d  itializer_range=
+00002720: 302e 3032 2c0a 2020 2020 2020 2020 6c61  0.02,.        la
+00002730: 7965 725f 6e6f 726d 5f65 7073 3d31 652d  yer_norm_eps=1e-
+00002740: 3132 2c0a 2020 2020 2020 2020 7061 645f  12,.        pad_
+00002750: 746f 6b65 6e5f 6964 3d30 2c0a 2020 2020  token_id=0,.    
+00002760: 2020 2020 706f 7369 7469 6f6e 5f65 6d62      position_emb
+00002770: 6564 6469 6e67 5f74 7970 653d 2261 6273  edding_type="abs
+00002780: 6f6c 7574 6522 2c0a 2020 2020 2020 2020  olute",.        
+00002790: 6372 6f73 735f 6174 7465 6e74 696f 6e5f  cross_attention_
+000027a0: 6672 6571 7565 6e63 793d 322c 0a20 2020  frequency=2,.   
+000027b0: 2020 2020 2065 6e63 6f64 6572 5f68 6964       encoder_hid
+000027c0: 6465 6e5f 7369 7a65 3d31 3430 382c 0a20  den_size=1408,. 
+000027d0: 2020 2020 2020 202a 2a6b 7761 7267 732c         **kwargs,
+000027e0: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
+000027f0: 7375 7065 7228 292e 5f5f 696e 6974 5f5f  super().__init__
+00002800: 2870 6164 5f74 6f6b 656e 5f69 643d 7061  (pad_token_id=pa
+00002810: 645f 746f 6b65 6e5f 6964 2c20 2a2a 6b77  d_token_id, **kw
+00002820: 6172 6773 290a 0a20 2020 2020 2020 2073  args)..        s
+00002830: 656c 662e 766f 6361 625f 7369 7a65 203d  elf.vocab_size =
+00002840: 2076 6f63 6162 5f73 697a 650a 2020 2020   vocab_size.    
+00002850: 2020 2020 7365 6c66 2e68 6964 6465 6e5f      self.hidden_
+00002860: 7369 7a65 203d 2068 6964 6465 6e5f 7369  size = hidden_si
+00002870: 7a65 0a20 2020 2020 2020 2073 656c 662e  ze.        self.
+00002880: 6e75 6d5f 6869 6464 656e 5f6c 6179 6572  num_hidden_layer
+00002890: 7320 3d20 6e75 6d5f 6869 6464 656e 5f6c  s = num_hidden_l
+000028a0: 6179 6572 730a 2020 2020 2020 2020 7365  ayers.        se
+000028b0: 6c66 2e6e 756d 5f61 7474 656e 7469 6f6e  lf.num_attention
+000028c0: 5f68 6561 6473 203d 206e 756d 5f61 7474  _heads = num_att
+000028d0: 656e 7469 6f6e 5f68 6561 6473 0a20 2020  ention_heads.   
+000028e0: 2020 2020 2073 656c 662e 6869 6464 656e       self.hidden
+000028f0: 5f61 6374 203d 2068 6964 6465 6e5f 6163  _act = hidden_ac
+00002900: 740a 2020 2020 2020 2020 7365 6c66 2e69  t.        self.i
+00002910: 6e74 6572 6d65 6469 6174 655f 7369 7a65  ntermediate_size
+00002920: 203d 2069 6e74 6572 6d65 6469 6174 655f   = intermediate_
+00002930: 7369 7a65 0a20 2020 2020 2020 2073 656c  size.        sel
+00002940: 662e 6869 6464 656e 5f64 726f 706f 7574  f.hidden_dropout
+00002950: 5f70 726f 6220 3d20 6869 6464 656e 5f64  _prob = hidden_d
+00002960: 726f 706f 7574 5f70 726f 620a 2020 2020  ropout_prob.    
+00002970: 2020 2020 7365 6c66 2e61 7474 656e 7469      self.attenti
+00002980: 6f6e 5f70 726f 6273 5f64 726f 706f 7574  on_probs_dropout
+00002990: 5f70 726f 6220 3d20 6174 7465 6e74 696f  _prob = attentio
+000029a0: 6e5f 7072 6f62 735f 6472 6f70 6f75 745f  n_probs_dropout_
+000029b0: 7072 6f62 0a20 2020 2020 2020 2073 656c  prob.        sel
+000029c0: 662e 6d61 785f 706f 7369 7469 6f6e 5f65  f.max_position_e
+000029d0: 6d62 6564 6469 6e67 7320 3d20 6d61 785f  mbeddings = max_
+000029e0: 706f 7369 7469 6f6e 5f65 6d62 6564 6469  position_embeddi
+000029f0: 6e67 730a 2020 2020 2020 2020 7365 6c66  ngs.        self
+00002a00: 2e69 6e69 7469 616c 697a 6572 5f72 616e  .initializer_ran
+00002a10: 6765 203d 2069 6e69 7469 616c 697a 6572  ge = initializer
+00002a20: 5f72 616e 6765 0a20 2020 2020 2020 2073  _range.        s
+00002a30: 656c 662e 6c61 7965 725f 6e6f 726d 5f65  elf.layer_norm_e
+00002a40: 7073 203d 206c 6179 6572 5f6e 6f72 6d5f  ps = layer_norm_
+00002a50: 6570 730a 2020 2020 2020 2020 7365 6c66  eps.        self
+00002a60: 2e70 6f73 6974 696f 6e5f 656d 6265 6464  .position_embedd
+00002a70: 696e 675f 7479 7065 203d 2070 6f73 6974  ing_type = posit
+00002a80: 696f 6e5f 656d 6265 6464 696e 675f 7479  ion_embedding_ty
+00002a90: 7065 0a20 2020 2020 2020 2073 656c 662e  pe.        self.
+00002aa0: 6372 6f73 735f 6174 7465 6e74 696f 6e5f  cross_attention_
+00002ab0: 6672 6571 7565 6e63 7920 3d20 6372 6f73  frequency = cros
+00002ac0: 735f 6174 7465 6e74 696f 6e5f 6672 6571  s_attention_freq
+00002ad0: 7565 6e63 790a 2020 2020 2020 2020 7365  uency.        se
+00002ae0: 6c66 2e65 6e63 6f64 6572 5f68 6964 6465  lf.encoder_hidde
+00002af0: 6e5f 7369 7a65 203d 2065 6e63 6f64 6572  n_size = encoder
+00002b00: 5f68 6964 6465 6e5f 7369 7a65 0a0a 2020  _hidden_size..  
+00002b10: 2020 4063 6c61 7373 6d65 7468 6f64 0a20    @classmethod. 
+00002b20: 2020 2064 6566 2066 726f 6d5f 7072 6574     def from_pret
+00002b30: 7261 696e 6564 2863 6c73 2c20 7072 6574  rained(cls, pret
+00002b40: 7261 696e 6564 5f6d 6f64 656c 5f6e 616d  rained_model_nam
+00002b50: 655f 6f72 5f70 6174 683a 2055 6e69 6f6e  e_or_path: Union
+00002b60: 5b73 7472 2c20 6f73 2e50 6174 684c 696b  [str, os.PathLik
+00002b70: 655d 2c20 2a2a 6b77 6172 6773 2920 2d3e  e], **kwargs) ->
+00002b80: 2022 5072 6574 7261 696e 6564 436f 6e66   "PretrainedConf
+00002b90: 6967 223a 0a20 2020 2020 2020 2063 6f6e  ig":.        con
+00002ba0: 6669 675f 6469 6374 2c20 6b77 6172 6773  fig_dict, kwargs
+00002bb0: 203d 2063 6c73 2e67 6574 5f63 6f6e 6669   = cls.get_confi
+00002bc0: 675f 6469 6374 2870 7265 7472 6169 6e65  g_dict(pretraine
+00002bd0: 645f 6d6f 6465 6c5f 6e61 6d65 5f6f 725f  d_model_name_or_
+00002be0: 7061 7468 2c20 2a2a 6b77 6172 6773 290a  path, **kwargs).
+00002bf0: 0a20 2020 2020 2020 2023 2067 6574 2074  .        # get t
+00002c00: 6865 2071 666f 726d 6572 2063 6f6e 6669  he qformer confi
+00002c10: 6720 6469 6374 2069 6620 7765 2061 7265  g dict if we are
+00002c20: 206c 6f61 6469 6e67 2066 726f 6d20 426c   loading from Bl
+00002c30: 6970 3243 6f6e 6669 670a 2020 2020 2020  ip2Config.      
+00002c40: 2020 6966 2063 6f6e 6669 675f 6469 6374    if config_dict
+00002c50: 2e67 6574 2822 6d6f 6465 6c5f 7479 7065  .get("model_type
+00002c60: 2229 203d 3d20 2262 6c69 702d 3222 3a0a  ") == "blip-2":.
+00002c70: 2020 2020 2020 2020 2020 2020 636f 6e66              conf
+00002c80: 6967 5f64 6963 7420 3d20 636f 6e66 6967  ig_dict = config
+00002c90: 5f64 6963 745b 2271 666f 726d 6572 5f63  _dict["qformer_c
+00002ca0: 6f6e 6669 6722 5d0a 0a20 2020 2020 2020  onfig"]..       
+00002cb0: 2069 6620 226d 6f64 656c 5f74 7970 6522   if "model_type"
+00002cc0: 2069 6e20 636f 6e66 6967 5f64 6963 7420   in config_dict 
+00002cd0: 616e 6420 6861 7361 7474 7228 636c 732c  and hasattr(cls,
+00002ce0: 2022 6d6f 6465 6c5f 7479 7065 2229 2061   "model_type") a
+00002cf0: 6e64 2063 6f6e 6669 675f 6469 6374 5b22  nd config_dict["
+00002d00: 6d6f 6465 6c5f 7479 7065 225d 2021 3d20  model_type"] != 
+00002d10: 636c 732e 6d6f 6465 6c5f 7479 7065 3a0a  cls.model_type:.
+00002d20: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+00002d30: 6572 2e77 6172 6e69 6e67 280a 2020 2020  er.warning(.    
+00002d40: 2020 2020 2020 2020 2020 2020 6622 596f              f"Yo
+00002d50: 7520 6172 6520 7573 696e 6720 6120 6d6f  u are using a mo
+00002d60: 6465 6c20 6f66 2074 7970 6520 7b63 6f6e  del of type {con
+00002d70: 6669 675f 6469 6374 5b27 6d6f 6465 6c5f  fig_dict['model_
+00002d80: 7479 7065 275d 7d20 746f 2069 6e73 7461  type']} to insta
+00002d90: 6e74 6961 7465 2061 206d 6f64 656c 206f  ntiate a model o
+00002da0: 6620 7479 7065 2022 0a20 2020 2020 2020  f type ".       
+00002db0: 2020 2020 2020 2020 2066 227b 636c 732e           f"{cls.
+00002dc0: 6d6f 6465 6c5f 7479 7065 7d2e 2054 6869  model_type}. Thi
+00002dd0: 7320 6973 206e 6f74 2073 7570 706f 7274  s is not support
+00002de0: 6564 2066 6f72 2061 6c6c 2063 6f6e 6669  ed for all confi
+00002df0: 6775 7261 7469 6f6e 7320 6f66 206d 6f64  gurations of mod
+00002e00: 656c 7320 616e 6420 6361 6e20 7969 656c  els and can yiel
+00002e10: 6420 6572 726f 7273 2e22 0a20 2020 2020  d errors.".     
+00002e20: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00002e30: 2020 7265 7475 726e 2063 6c73 2e66 726f    return cls.fro
+00002e40: 6d5f 6469 6374 2863 6f6e 6669 675f 6469  m_dict(config_di
+00002e50: 6374 2c20 2a2a 6b77 6172 6773 290a 0a0a  ct, **kwargs)...
+00002e60: 636c 6173 7320 426c 6970 3243 6f6e 6669  class Blip2Confi
+00002e70: 6728 5072 6574 7261 696e 6564 436f 6e66  g(PretrainedConf
+00002e80: 6967 293a 0a20 2020 2072 2222 220a 2020  ig):.    r""".  
+00002e90: 2020 5b60 426c 6970 3243 6f6e 6669 6760    [`Blip2Config`
+00002ea0: 5d20 6973 2074 6865 2063 6f6e 6669 6775  ] is the configu
+00002eb0: 7261 7469 6f6e 2063 6c61 7373 2074 6f20  ration class to 
+00002ec0: 7374 6f72 6520 7468 6520 636f 6e66 6967  store the config
+00002ed0: 7572 6174 696f 6e20 6f66 2061 205b 6042  uration of a [`B
+00002ee0: 6c69 7032 466f 7243 6f6e 6469 7469 6f6e  lip2ForCondition
+00002ef0: 616c 4765 6e65 7261 7469 6f6e 605d 2e20  alGeneration`]. 
+00002f00: 4974 2069 730a 2020 2020 7573 6564 2074  It is.    used t
+00002f10: 6f20 696e 7374 616e 7469 6174 6520 6120  o instantiate a 
+00002f20: 424c 4950 2d32 206d 6f64 656c 2061 6363  BLIP-2 model acc
+00002f30: 6f72 6469 6e67 2074 6f20 7468 6520 7370  ording to the sp
+00002f40: 6563 6966 6965 6420 6172 6775 6d65 6e74  ecified argument
+00002f50: 732c 2064 6566 696e 696e 6720 7468 6520  s, defining the 
+00002f60: 7669 7369 6f6e 206d 6f64 656c 2c20 512d  vision model, Q-
+00002f70: 466f 726d 6572 206d 6f64 656c 0a20 2020  Former model.   
+00002f80: 2061 6e64 206c 616e 6775 6167 6520 6d6f   and language mo
+00002f90: 6465 6c20 636f 6e66 6967 732e 2049 6e73  del configs. Ins
+00002fa0: 7461 6e74 6961 7469 6e67 2061 2063 6f6e  tantiating a con
+00002fb0: 6669 6775 7261 7469 6f6e 2077 6974 6820  figuration with 
+00002fc0: 7468 6520 6465 6661 756c 7473 2077 696c  the defaults wil
+00002fd0: 6c20 7969 656c 6420 6120 7369 6d69 6c61  l yield a simila
+00002fe0: 7220 636f 6e66 6967 7572 6174 696f 6e20  r configuration 
+00002ff0: 746f 0a20 2020 2074 6861 7420 6f66 2074  to.    that of t
+00003000: 6865 2042 4c49 502d 3220 5b53 616c 6573  he BLIP-2 [Sales
+00003010: 666f 7263 652f 626c 6970 322d 6f70 742d  force/blip2-opt-
+00003020: 322e 3762 5d28 6874 7470 733a 2f2f 6875  2.7b](https://hu
+00003030: 6767 696e 6766 6163 652e 636f 2f53 616c  ggingface.co/Sal
+00003040: 6573 666f 7263 652f 626c 6970 322d 6f70  esforce/blip2-op
+00003050: 742d 322e 3762 2920 6172 6368 6974 6563  t-2.7b) architec
+00003060: 7475 7265 2e0a 0a20 2020 2043 6f6e 6669  ture...    Confi
+00003070: 6775 7261 7469 6f6e 206f 626a 6563 7473  guration objects
+00003080: 2069 6e68 6572 6974 2066 726f 6d20 5b60   inherit from [`
+00003090: 5072 6574 7261 696e 6564 436f 6e66 6967  PretrainedConfig
+000030a0: 605d 2061 6e64 2063 616e 2062 6520 7573  `] and can be us
+000030b0: 6564 2074 6f20 636f 6e74 726f 6c20 7468  ed to control th
+000030c0: 6520 6d6f 6465 6c20 6f75 7470 7574 732e  e model outputs.
+000030d0: 2052 6561 6420 7468 650a 2020 2020 646f   Read the.    do
+000030e0: 6375 6d65 6e74 6174 696f 6e20 6672 6f6d  cumentation from
+000030f0: 205b 6050 7265 7472 6169 6e65 6443 6f6e   [`PretrainedCon
+00003100: 6669 6760 5d20 666f 7220 6d6f 7265 2069  fig`] for more i
+00003110: 6e66 6f72 6d61 7469 6f6e 2e0a 0a20 2020  nformation...   
+00003120: 2041 7267 733a 0a20 2020 2020 2020 2076   Args:.        v
+00003130: 6973 696f 6e5f 636f 6e66 6967 2028 6064  ision_config (`d
+00003140: 6963 7460 2c20 2a6f 7074 696f 6e61 6c2a  ict`, *optional*
+00003150: 293a 0a20 2020 2020 2020 2020 2020 2044  ):.            D
+00003160: 6963 7469 6f6e 6172 7920 6f66 2063 6f6e  ictionary of con
+00003170: 6669 6775 7261 7469 6f6e 206f 7074 696f  figuration optio
+00003180: 6e73 2075 7365 6420 746f 2069 6e69 7469  ns used to initi
+00003190: 616c 697a 6520 5b60 426c 6970 3256 6973  alize [`Blip2Vis
+000031a0: 696f 6e43 6f6e 6669 6760 5d2e 0a20 2020  ionConfig`]..   
+000031b0: 2020 2020 2071 666f 726d 6572 5f63 6f6e       qformer_con
+000031c0: 6669 6720 2860 6469 6374 602c 202a 6f70  fig (`dict`, *op
+000031d0: 7469 6f6e 616c 2a29 3a0a 2020 2020 2020  tional*):.      
+000031e0: 2020 2020 2020 4469 6374 696f 6e61 7279        Dictionary
+000031f0: 206f 6620 636f 6e66 6967 7572 6174 696f   of configuratio
+00003200: 6e20 6f70 7469 6f6e 7320 7573 6564 2074  n options used t
+00003210: 6f20 696e 6974 6961 6c69 7a65 205b 6042  o initialize [`B
+00003220: 6c69 7032 5146 6f72 6d65 7243 6f6e 6669  lip2QFormerConfi
+00003230: 6760 5d2e 0a20 2020 2020 2020 2074 6578  g`]..        tex
+00003240: 745f 636f 6e66 6967 2028 6064 6963 7460  t_config (`dict`
+00003250: 2c20 2a6f 7074 696f 6e61 6c2a 293a 0a20  , *optional*):. 
+00003260: 2020 2020 2020 2020 2020 2044 6963 7469             Dicti
+00003270: 6f6e 6172 7920 6f66 2063 6f6e 6669 6775  onary of configu
+00003280: 7261 7469 6f6e 206f 7074 696f 6e73 2075  ration options u
+00003290: 7365 6420 746f 2069 6e69 7469 616c 697a  sed to initializ
+000032a0: 6520 616e 7920 5b60 5072 6574 7261 696e  e any [`Pretrain
+000032b0: 6564 436f 6e66 6967 605d 2e0a 2020 2020  edConfig`]..    
+000032c0: 2020 2020 6e75 6d5f 7175 6572 795f 746f      num_query_to
+000032d0: 6b65 6e73 2028 6069 6e74 602c 202a 6f70  kens (`int`, *op
+000032e0: 7469 6f6e 616c 2a2c 2064 6566 6175 6c74  tional*, default
+000032f0: 7320 746f 2033 3229 3a0a 2020 2020 2020  s to 32):.      
+00003300: 2020 2020 2020 5468 6520 6e75 6d62 6572        The number
+00003310: 206f 6620 7175 6572 7920 746f 6b65 6e73   of query tokens
+00003320: 2070 6173 7365 6420 7468 726f 7567 6820   passed through 
+00003330: 7468 6520 5472 616e 7366 6f72 6d65 722e  the Transformer.
+00003340: 0a0a 2020 2020 2020 2020 6b77 6172 6773  ..        kwargs
+00003350: 2028 2a6f 7074 696f 6e61 6c2a 293a 0a20   (*optional*):. 
+00003360: 2020 2020 2020 2020 2020 2044 6963 7469             Dicti
+00003370: 6f6e 6172 7920 6f66 206b 6579 776f 7264  onary of keyword
+00003380: 2061 7267 756d 656e 7473 2e0a 0a20 2020   arguments...   
+00003390: 2045 7861 6d70 6c65 3a0a 0a20 2020 2060   Example:..    `
+000033a0: 6060 7079 7468 6f6e 0a20 2020 203e 3e3e  ``python.    >>>
+000033b0: 2066 726f 6d20 7472 616e 7366 6f72 6d65   from transforme
+000033c0: 7273 2069 6d70 6f72 7420 280a 2020 2020  rs import (.    
+000033d0: 2e2e 2e20 2020 2020 426c 6970 3256 6973  ...     Blip2Vis
+000033e0: 696f 6e43 6f6e 6669 672c 0a20 2020 202e  ionConfig,.    .
+000033f0: 2e2e 2020 2020 2042 6c69 7032 5146 6f72  ..     Blip2QFor
+00003400: 6d65 7243 6f6e 6669 672c 0a20 2020 202e  merConfig,.    .
+00003410: 2e2e 2020 2020 204f 5054 436f 6e66 6967  ..     OPTConfig
+00003420: 2c0a 2020 2020 2e2e 2e20 2020 2020 426c  ,.    ...     Bl
+00003430: 6970 3243 6f6e 6669 672c 0a20 2020 202e  ip2Config,.    .
+00003440: 2e2e 2020 2020 2042 6c69 7032 466f 7243  ..     Blip2ForC
+00003450: 6f6e 6469 7469 6f6e 616c 4765 6e65 7261  onditionalGenera
+00003460: 7469 6f6e 2c0a 2020 2020 2e2e 2e20 290a  tion,.    ... ).
+00003470: 0a20 2020 203e 3e3e 2023 2049 6e69 7469  .    >>> # Initi
+00003480: 616c 697a 696e 6720 6120 426c 6970 3243  alizing a Blip2C
+00003490: 6f6e 6669 6720 7769 7468 2053 616c 6573  onfig with Sales
+000034a0: 666f 7263 652f 626c 6970 322d 6f70 742d  force/blip2-opt-
+000034b0: 322e 3762 2073 7479 6c65 2063 6f6e 6669  2.7b style confi
+000034c0: 6775 7261 7469 6f6e 0a20 2020 203e 3e3e  guration.    >>>
+000034d0: 2063 6f6e 6669 6775 7261 7469 6f6e 203d   configuration =
+000034e0: 2042 6c69 7032 436f 6e66 6967 2829 0a0a   Blip2Config()..
+000034f0: 2020 2020 3e3e 3e20 2320 496e 6974 6961      >>> # Initia
+00003500: 6c69 7a69 6e67 2061 2042 6c69 7032 466f  lizing a Blip2Fo
+00003510: 7243 6f6e 6469 7469 6f6e 616c 4765 6e65  rConditionalGene
+00003520: 7261 7469 6f6e 2028 7769 7468 2072 616e  ration (with ran
+00003530: 646f 6d20 7765 6967 6874 7329 2066 726f  dom weights) fro
+00003540: 6d20 7468 6520 5361 6c65 7366 6f72 6365  m the Salesforce
+00003550: 2f62 6c69 7032 2d6f 7074 2d32 2e37 6220  /blip2-opt-2.7b 
+00003560: 7374 796c 6520 636f 6e66 6967 7572 6174  style configurat
+00003570: 696f 6e0a 2020 2020 3e3e 3e20 6d6f 6465  ion.    >>> mode
+00003580: 6c20 3d20 426c 6970 3246 6f72 436f 6e64  l = Blip2ForCond
+00003590: 6974 696f 6e61 6c47 656e 6572 6174 696f  itionalGeneratio
+000035a0: 6e28 636f 6e66 6967 7572 6174 696f 6e29  n(configuration)
+000035b0: 0a0a 2020 2020 3e3e 3e20 2320 4163 6365  ..    >>> # Acce
+000035c0: 7373 696e 6720 7468 6520 6d6f 6465 6c20  ssing the model 
+000035d0: 636f 6e66 6967 7572 6174 696f 6e0a 2020  configuration.  
+000035e0: 2020 3e3e 3e20 636f 6e66 6967 7572 6174    >>> configurat
+000035f0: 696f 6e20 3d20 6d6f 6465 6c2e 636f 6e66  ion = model.conf
+00003600: 6967 0a0a 2020 2020 3e3e 3e20 2320 5765  ig..    >>> # We
+00003610: 2063 616e 2061 6c73 6f20 696e 6974 6961   can also initia
+00003620: 6c69 7a65 2061 2042 6c69 7032 436f 6e66  lize a Blip2Conf
+00003630: 6967 2066 726f 6d20 6120 426c 6970 3256  ig from a Blip2V
+00003640: 6973 696f 6e43 6f6e 6669 672c 2042 6c69  isionConfig, Bli
+00003650: 7032 5146 6f72 6d65 7243 6f6e 6669 6720  p2QFormerConfig 
+00003660: 616e 6420 616e 7920 5072 6574 7261 696e  and any Pretrain
+00003670: 6564 436f 6e66 6967 0a0a 2020 2020 3e3e  edConfig..    >>
+00003680: 3e20 2320 496e 6974 6961 6c69 7a69 6e67  > # Initializing
+00003690: 2042 4c49 502d 3220 7669 7369 6f6e 2c20   BLIP-2 vision, 
+000036a0: 424c 4950 2d32 2051 2d46 6f72 6d65 7220  BLIP-2 Q-Former 
+000036b0: 616e 6420 6c61 6e67 7561 6765 206d 6f64  and language mod
+000036c0: 656c 2063 6f6e 6669 6775 7261 7469 6f6e  el configuration
+000036d0: 730a 2020 2020 3e3e 3e20 7669 7369 6f6e  s.    >>> vision
+000036e0: 5f63 6f6e 6669 6720 3d20 426c 6970 3256  _config = Blip2V
+000036f0: 6973 696f 6e43 6f6e 6669 6728 290a 2020  isionConfig().  
+00003700: 2020 3e3e 3e20 7166 6f72 6d65 725f 636f    >>> qformer_co
+00003710: 6e66 6967 203d 2042 6c69 7032 5146 6f72  nfig = Blip2QFor
+00003720: 6d65 7243 6f6e 6669 6728 290a 2020 2020  merConfig().    
+00003730: 3e3e 3e20 7465 7874 5f63 6f6e 6669 6720  >>> text_config 
+00003740: 3d20 4f50 5443 6f6e 6669 6728 290a 0a20  = OPTConfig().. 
+00003750: 2020 203e 3e3e 2063 6f6e 6669 6720 3d20     >>> config = 
+00003760: 426c 6970 3243 6f6e 6669 672e 6672 6f6d  Blip2Config.from
+00003770: 5f74 6578 745f 7669 7369 6f6e 5f63 6f6e  _text_vision_con
+00003780: 6669 6773 2876 6973 696f 6e5f 636f 6e66  figs(vision_conf
+00003790: 6967 2c20 7166 6f72 6d65 725f 636f 6e66  ig, qformer_conf
+000037a0: 6967 2c20 7465 7874 5f63 6f6e 6669 6729  ig, text_config)
+000037b0: 0a20 2020 2060 6060 2222 220a 0a20 2020  .    ```"""..   
+000037c0: 206d 6f64 656c 5f74 7970 6520 3d20 2262   model_type = "b
+000037d0: 6c69 702d 3222 0a0a 2020 2020 6465 6620  lip-2"..    def 
+000037e0: 5f5f 696e 6974 5f5f 2873 656c 662c 2076  __init__(self, v
+000037f0: 6973 696f 6e5f 636f 6e66 6967 3d4e 6f6e  ision_config=Non
+00003800: 652c 2071 666f 726d 6572 5f63 6f6e 6669  e, qformer_confi
+00003810: 673d 4e6f 6e65 2c20 7465 7874 5f63 6f6e  g=None, text_con
+00003820: 6669 673d 4e6f 6e65 2c20 6e75 6d5f 7175  fig=None, num_qu
+00003830: 6572 795f 746f 6b65 6e73 3d33 322c 202a  ery_tokens=32, *
+00003840: 2a6b 7761 7267 7329 3a0a 2020 2020 2020  *kwargs):.      
+00003850: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
+00003860: 5f5f 282a 2a6b 7761 7267 7329 0a0a 2020  __(**kwargs)..  
+00003870: 2020 2020 2020 6966 2076 6973 696f 6e5f        if vision_
+00003880: 636f 6e66 6967 2069 7320 4e6f 6e65 3a0a  config is None:.
+00003890: 2020 2020 2020 2020 2020 2020 7669 7369              visi
+000038a0: 6f6e 5f63 6f6e 6669 6720 3d20 7b7d 0a20  on_config = {}. 
+000038b0: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+000038c0: 722e 696e 666f 2822 7669 7369 6f6e 5f63  r.info("vision_c
+000038d0: 6f6e 6669 6720 6973 204e 6f6e 652e 2069  onfig is None. i
+000038e0: 6e69 7469 616c 697a 696e 6720 7468 6520  nitializing the 
+000038f0: 426c 6970 3256 6973 696f 6e43 6f6e 6669  Blip2VisionConfi
+00003900: 6720 7769 7468 2064 6566 6175 6c74 2076  g with default v
+00003910: 616c 7565 732e 2229 0a0a 2020 2020 2020  alues.")..      
+00003920: 2020 6966 2071 666f 726d 6572 5f63 6f6e    if qformer_con
+00003930: 6669 6720 6973 204e 6f6e 653a 0a20 2020  fig is None:.   
+00003940: 2020 2020 2020 2020 2071 666f 726d 6572           qformer
+00003950: 5f63 6f6e 6669 6720 3d20 7b7d 0a20 2020  _config = {}.   
+00003960: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
+00003970: 696e 666f 2822 7166 6f72 6d65 725f 636f  info("qformer_co
+00003980: 6e66 6967 2069 7320 4e6f 6e65 2e20 496e  nfig is None. In
+00003990: 6974 6961 6c69 7a69 6e67 2074 6865 2042  itializing the B
+000039a0: 6c69 7032 5146 6f72 6d65 7243 6f6e 6669  lip2QFormerConfi
+000039b0: 6720 7769 7468 2064 6566 6175 6c74 2076  g with default v
+000039c0: 616c 7565 732e 2229 0a0a 2020 2020 2020  alues.")..      
+000039d0: 2020 6966 2074 6578 745f 636f 6e66 6967    if text_config
+000039e0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+000039f0: 2020 2020 2020 7465 7874 5f63 6f6e 6669        text_confi
+00003a00: 6720 3d20 7b7d 0a20 2020 2020 2020 2020  g = {}.         
+00003a10: 2020 206c 6f67 6765 722e 696e 666f 2822     logger.info("
+00003a20: 7465 7874 5f63 6f6e 6669 6720 6973 204e  text_config is N
+00003a30: 6f6e 652e 2049 6e69 7469 616c 697a 696e  one. Initializin
+00003a40: 6720 7468 6520 7465 7874 2063 6f6e 6669  g the text confi
+00003a50: 6720 7769 7468 2064 6566 6175 6c74 2076  g with default v
+00003a60: 616c 7565 7320 2860 4f50 5443 6f6e 6669  alues (`OPTConfi
+00003a70: 6760 292e 2229 0a0a 2020 2020 2020 2020  g`).")..        
+00003a80: 7365 6c66 2e76 6973 696f 6e5f 636f 6e66  self.vision_conf
+00003a90: 6967 203d 2042 6c69 7032 5669 7369 6f6e  ig = Blip2Vision
+00003aa0: 436f 6e66 6967 282a 2a76 6973 696f 6e5f  Config(**vision_
+00003ab0: 636f 6e66 6967 290a 2020 2020 2020 2020  config).        
+00003ac0: 7365 6c66 2e71 666f 726d 6572 5f63 6f6e  self.qformer_con
+00003ad0: 6669 6720 3d20 426c 6970 3251 466f 726d  fig = Blip2QForm
+00003ae0: 6572 436f 6e66 6967 282a 2a71 666f 726d  erConfig(**qform
+00003af0: 6572 5f63 6f6e 6669 6729 0a20 2020 2020  er_config).     
+00003b00: 2020 2074 6578 745f 6d6f 6465 6c5f 7479     text_model_ty
+00003b10: 7065 203d 2074 6578 745f 636f 6e66 6967  pe = text_config
+00003b20: 5b22 6d6f 6465 6c5f 7479 7065 225d 2069  ["model_type"] i
+00003b30: 6620 226d 6f64 656c 5f74 7970 6522 2069  f "model_type" i
+00003b40: 6e20 7465 7874 5f63 6f6e 6669 6720 656c  n text_config el
+00003b50: 7365 2022 6f70 7422 0a20 2020 2020 2020  se "opt".       
+00003b60: 2073 656c 662e 7465 7874 5f63 6f6e 6669   self.text_confi
+00003b70: 6720 3d20 434f 4e46 4947 5f4d 4150 5049  g = CONFIG_MAPPI
+00003b80: 4e47 5b74 6578 745f 6d6f 6465 6c5f 7479  NG[text_model_ty
+00003b90: 7065 5d28 2a2a 7465 7874 5f63 6f6e 6669  pe](**text_confi
+00003ba0: 6729 0a0a 2020 2020 2020 2020 7365 6c66  g)..        self
+00003bb0: 2e74 6965 5f77 6f72 645f 656d 6265 6464  .tie_word_embedd
+00003bc0: 696e 6773 203d 2073 656c 662e 7465 7874  ings = self.text
+00003bd0: 5f63 6f6e 6669 672e 7469 655f 776f 7264  _config.tie_word
+00003be0: 5f65 6d62 6564 6469 6e67 730a 2020 2020  _embeddings.    
+00003bf0: 2020 2020 7365 6c66 2e69 735f 656e 636f      self.is_enco
+00003c00: 6465 725f 6465 636f 6465 7220 3d20 7365  der_decoder = se
+00003c10: 6c66 2e74 6578 745f 636f 6e66 6967 2e69  lf.text_config.i
+00003c20: 735f 656e 636f 6465 725f 6465 636f 6465  s_encoder_decode
+00003c30: 720a 0a20 2020 2020 2020 2073 656c 662e  r..        self.
+00003c40: 6e75 6d5f 7175 6572 795f 746f 6b65 6e73  num_query_tokens
+00003c50: 203d 206e 756d 5f71 7565 7279 5f74 6f6b   = num_query_tok
+00003c60: 656e 730a 2020 2020 2020 2020 7365 6c66  ens.        self
+00003c70: 2e71 666f 726d 6572 5f63 6f6e 6669 672e  .qformer_config.
+00003c80: 656e 636f 6465 725f 6869 6464 656e 5f73  encoder_hidden_s
+00003c90: 697a 6520 3d20 7365 6c66 2e76 6973 696f  ize = self.visio
+00003ca0: 6e5f 636f 6e66 6967 2e68 6964 6465 6e5f  n_config.hidden_
+00003cb0: 7369 7a65 0a20 2020 2020 2020 2073 656c  size.        sel
+00003cc0: 662e 7573 655f 6465 636f 6465 725f 6f6e  f.use_decoder_on
+00003cd0: 6c79 5f6c 616e 6775 6167 655f 6d6f 6465  ly_language_mode
+00003ce0: 6c20 3d20 7365 6c66 2e74 6578 745f 636f  l = self.text_co
+00003cf0: 6e66 6967 2e6d 6f64 656c 5f74 7970 6520  nfig.model_type 
+00003d00: 696e 204d 4f44 454c 5f46 4f52 5f43 4155  in MODEL_FOR_CAU
+00003d10: 5341 4c5f 4c4d 5f4d 4150 5049 4e47 5f4e  SAL_LM_MAPPING_N
+00003d20: 414d 4553 0a20 2020 2020 2020 2073 656c  AMES.        sel
+00003d30: 662e 696e 6974 6961 6c69 7a65 725f 6661  f.initializer_fa
+00003d40: 6374 6f72 203d 2031 2e30 0a20 2020 2020  ctor = 1.0.     
+00003d50: 2020 2073 656c 662e 696e 6974 6961 6c69     self.initiali
+00003d60: 7a65 725f 7261 6e67 6520 3d20 302e 3032  zer_range = 0.02
+00003d70: 0a0a 2020 2020 4063 6c61 7373 6d65 7468  ..    @classmeth
+00003d80: 6f64 0a20 2020 2064 6566 2066 726f 6d5f  od.    def from_
+00003d90: 7669 7369 6f6e 5f71 666f 726d 6572 5f74  vision_qformer_t
+00003da0: 6578 745f 636f 6e66 6967 7328 0a20 2020  ext_configs(.   
+00003db0: 2020 2020 2063 6c73 2c0a 2020 2020 2020       cls,.      
+00003dc0: 2020 7669 7369 6f6e 5f63 6f6e 6669 673a    vision_config:
+00003dd0: 2042 6c69 7032 5669 7369 6f6e 436f 6e66   Blip2VisionConf
+00003de0: 6967 2c0a 2020 2020 2020 2020 7166 6f72  ig,.        qfor
+00003df0: 6d65 725f 636f 6e66 6967 3a20 426c 6970  mer_config: Blip
+00003e00: 3251 466f 726d 6572 436f 6e66 6967 2c0a  2QFormerConfig,.
+00003e10: 2020 2020 2020 2020 7465 7874 5f63 6f6e          text_con
+00003e20: 6669 673a 2050 7265 7472 6169 6e65 6443  fig: PretrainedC
+00003e30: 6f6e 6669 672c 0a20 2020 2020 2020 202a  onfig,.        *
+00003e40: 2a6b 7761 7267 732c 0a20 2020 2029 3a0a  *kwargs,.    ):.
+00003e50: 2020 2020 2020 2020 7222 2222 0a20 2020          r""".   
+00003e60: 2020 2020 2049 6e73 7461 6e74 6961 7465       Instantiate
+00003e70: 2061 205b 6042 6c69 7032 436f 6e66 6967   a [`Blip2Config
+00003e80: 605d 2028 6f72 2061 2064 6572 6976 6564  `] (or a derived
+00003e90: 2063 6c61 7373 2920 6672 6f6d 2061 2042   class) from a B
+00003ea0: 4c49 502d 3220 7669 7369 6f6e 206d 6f64  LIP-2 vision mod
+00003eb0: 656c 2c20 512d 466f 726d 6572 2061 6e64  el, Q-Former and
+00003ec0: 206c 616e 6775 6167 6520 6d6f 6465 6c0a   language model.
+00003ed0: 2020 2020 2020 2020 636f 6e66 6967 7572          configur
+00003ee0: 6174 696f 6e73 2e0a 0a20 2020 2020 2020  ations...       
+00003ef0: 2052 6574 7572 6e73 3a0a 2020 2020 2020   Returns:.      
+00003f00: 2020 2020 2020 5b60 426c 6970 3243 6f6e        [`Blip2Con
+00003f10: 6669 6760 5d3a 2041 6e20 696e 7374 616e  fig`]: An instan
+00003f20: 6365 206f 6620 6120 636f 6e66 6967 7572  ce of a configur
+00003f30: 6174 696f 6e20 6f62 6a65 6374 0a20 2020  ation object.   
+00003f40: 2020 2020 2022 2222 0a0a 2020 2020 2020       """..      
+00003f50: 2020 7265 7475 726e 2063 6c73 280a 2020    return cls(.  
+00003f60: 2020 2020 2020 2020 2020 7669 7369 6f6e            vision
+00003f70: 5f63 6f6e 6669 673d 7669 7369 6f6e 5f63  _config=vision_c
+00003f80: 6f6e 6669 672e 746f 5f64 6963 7428 292c  onfig.to_dict(),
+00003f90: 0a20 2020 2020 2020 2020 2020 2071 666f  .            qfo
+00003fa0: 726d 6572 5f63 6f6e 6669 673d 7166 6f72  rmer_config=qfor
+00003fb0: 6d65 725f 636f 6e66 6967 2e74 6f5f 6469  mer_config.to_di
+00003fc0: 6374 2829 2c0a 2020 2020 2020 2020 2020  ct(),.          
+00003fd0: 2020 7465 7874 5f63 6f6e 6669 673d 7465    text_config=te
+00003fe0: 7874 5f63 6f6e 6669 672e 746f 5f64 6963  xt_config.to_dic
+00003ff0: 7428 292c 0a20 2020 2020 2020 2020 2020  t(),.           
+00004000: 202a 2a6b 7761 7267 732c 0a20 2020 2020   **kwargs,.     
+00004010: 2020 2029 0a0a 5f5f 616c 6c5f 5f20 3d20     )..__all__ = 
+00004020: 5b27 426c 6970 3243 6f6e 6669 6727 2c20  ['Blip2Config', 
+00004030: 2742 6c69 7032 5146 6f72 6d65 7243 6f6e  'Blip2QFormerCon
+00004040: 6669 6727 2c20 2742 6c69 7032 5669 7369  fig', 'Blip2Visi
+00004050: 6f6e 436f 6e66 6967 275d 0a              onConfig'].
```

## mindnlp/transformers/models/blip_2/modeling_blip_2.py

```diff
@@ -0,0 +1,4471 @@
+00000000: 2320 636f 6469 6e67 3d75 7466 2d38 0a23  # coding=utf-8.#
+00000010: 2043 6f70 7972 6967 6874 2032 3032 3320   Copyright 2023 
+00000020: 5468 6520 5361 6c65 7366 6f72 6365 2041  The Salesforce A
+00000030: 7574 686f 7273 2061 6e64 2054 6865 2048  uthors and The H
+00000040: 7567 6769 6e67 4661 6365 2054 6561 6d2e  uggingFace Team.
+00000050: 2041 6c6c 2072 6967 6874 7320 7265 7365   All rights rese
+00000060: 7276 6564 2e0a 230a 2320 4c69 6365 6e73  rved..#.# Licens
+00000070: 6564 2075 6e64 6572 2074 6865 2041 7061  ed under the Apa
+00000080: 6368 6520 4c69 6365 6e73 652c 2056 6572  che License, Ver
+00000090: 7369 6f6e 2032 2e30 2028 7468 6520 224c  sion 2.0 (the "L
+000000a0: 6963 656e 7365 2229 3b0a 2320 796f 7520  icense");.# you 
+000000b0: 6d61 7920 6e6f 7420 7573 6520 7468 6973  may not use this
+000000c0: 2066 696c 6520 6578 6365 7074 2069 6e20   file except in 
+000000d0: 636f 6d70 6c69 616e 6365 2077 6974 6820  compliance with 
+000000e0: 7468 6520 4c69 6365 6e73 652e 0a23 2059  the License..# Y
+000000f0: 6f75 206d 6179 206f 6274 6169 6e20 6120  ou may obtain a 
+00000100: 636f 7079 206f 6620 7468 6520 4c69 6365  copy of the Lice
+00000110: 6e73 6520 6174 0a23 0a23 2020 2020 2068  nse at.#.#     h
+00000120: 7474 703a 2f2f 7777 772e 6170 6163 6865  ttp://www.apache
+00000130: 2e6f 7267 2f6c 6963 656e 7365 732f 4c49  .org/licenses/LI
+00000140: 4345 4e53 452d 322e 300a 230a 2320 556e  CENSE-2.0.#.# Un
+00000150: 6c65 7373 2072 6571 7569 7265 6420 6279  less required by
+00000160: 2061 7070 6c69 6361 626c 6520 6c61 7720   applicable law 
+00000170: 6f72 2061 6772 6565 6420 746f 2069 6e20  or agreed to in 
+00000180: 7772 6974 696e 672c 2073 6f66 7477 6172  writing, softwar
+00000190: 650a 2320 6469 7374 7269 6275 7465 6420  e.# distributed 
+000001a0: 756e 6465 7220 7468 6520 4c69 6365 6e73  under the Licens
+000001b0: 6520 6973 2064 6973 7472 6962 7574 6564  e is distributed
+000001c0: 206f 6e20 616e 2022 4153 2049 5322 2042   on an "AS IS" B
+000001d0: 4153 4953 2c0a 2320 5749 5448 4f55 5420  ASIS,.# WITHOUT 
+000001e0: 5741 5252 414e 5449 4553 204f 5220 434f  WARRANTIES OR CO
+000001f0: 4e44 4954 494f 4e53 204f 4620 414e 5920  NDITIONS OF ANY 
+00000200: 4b49 4e44 2c20 6569 7468 6572 2065 7870  KIND, either exp
+00000210: 7265 7373 206f 7220 696d 706c 6965 642e  ress or implied.
+00000220: 0a23 2053 6565 2074 6865 204c 6963 656e  .# See the Licen
+00000230: 7365 2066 6f72 2074 6865 2073 7065 6369  se for the speci
+00000240: 6669 6320 6c61 6e67 7561 6765 2067 6f76  fic language gov
+00000250: 6572 6e69 6e67 2070 6572 6d69 7373 696f  erning permissio
+00000260: 6e73 2061 6e64 0a23 206c 696d 6974 6174  ns and.# limitat
+00000270: 696f 6e73 2075 6e64 6572 2074 6865 204c  ions under the L
+00000280: 6963 656e 7365 2e0a 2222 2220 4d69 6e64  icense..""" Mind
+00000290: 5370 6f72 6520 424c 4950 2d32 206d 6f64  Spore BLIP-2 mod
+000002a0: 656c 2e22 2222 0a0a 696d 706f 7274 206d  el."""..import m
+000002b0: 6174 680a 6672 6f6d 2064 6174 6163 6c61  ath.from datacla
+000002c0: 7373 6573 2069 6d70 6f72 7420 6461 7461  sses import data
+000002d0: 636c 6173 730a 6672 6f6d 2074 7970 696e  class.from typin
+000002e0: 6720 696d 706f 7274 2041 6e79 2c20 4f70  g import Any, Op
+000002f0: 7469 6f6e 616c 2c20 5475 706c 652c 2055  tional, Tuple, U
+00000300: 6e69 6f6e 0a0a 696d 706f 7274 206d 696e  nion..import min
+00000310: 6473 706f 7265 0a66 726f 6d20 6d69 6e64  dspore.from mind
+00000320: 7370 6f72 6520 696d 706f 7274 206e 6e2c  spore import nn,
+00000330: 206f 7073 2c20 5061 7261 6d65 7465 720a   ops, Parameter.
+00000340: 6672 6f6d 206d 696e 6473 706f 7265 2e63  from mindspore.c
+00000350: 6f6d 6d6f 6e2e 696e 6974 6961 6c69 7a65  ommon.initialize
+00000360: 7220 696d 706f 7274 2069 6e69 7469 616c  r import initial
+00000370: 697a 6572 2c20 4e6f 726d 616c 2c20 5472  izer, Normal, Tr
+00000380: 756e 6361 7465 644e 6f72 6d61 6c0a 0a66  uncatedNormal..f
+00000390: 726f 6d20 2e2e 2e61 6374 6976 6174 696f  rom ...activatio
+000003a0: 6e73 2069 6d70 6f72 7420 4143 5432 464e  ns import ACT2FN
+000003b0: 0a66 726f 6d20 2e2e 2e6d 6f64 656c 696e  .from ...modelin
+000003c0: 675f 6f75 7470 7574 7320 696d 706f 7274  g_outputs import
+000003d0: 2028 0a20 2020 2042 6173 654d 6f64 656c   (.    BaseModel
+000003e0: 4f75 7470 7574 2c0a 2020 2020 4261 7365  Output,.    Base
+000003f0: 4d6f 6465 6c4f 7574 7075 7457 6974 6850  ModelOutputWithP
+00000400: 6173 7441 6e64 4372 6f73 7341 7474 656e  astAndCrossAtten
+00000410: 7469 6f6e 732c 0a20 2020 2042 6173 654d  tions,.    BaseM
+00000420: 6f64 656c 4f75 7470 7574 5769 7468 506f  odelOutputWithPo
+00000430: 6f6c 696e 672c 0a20 2020 2042 6173 654d  oling,.    BaseM
+00000440: 6f64 656c 4f75 7470 7574 5769 7468 506f  odelOutputWithPo
+00000450: 6f6c 696e 6741 6e64 4372 6f73 7341 7474  olingAndCrossAtt
+00000460: 656e 7469 6f6e 732c 0a29 0a66 726f 6d20  entions,.).from 
+00000470: 2e2e 2e6d 6f64 656c 696e 675f 7574 696c  ...modeling_util
+00000480: 7320 696d 706f 7274 2050 7265 5472 6169  s import PreTrai
+00000490: 6e65 644d 6f64 656c 0a66 726f 6d20 2e2e  nedModel.from ..
+000004a0: 2e6d 735f 7574 696c 7320 696d 706f 7274  .ms_utils import
+000004b0: 2061 7070 6c79 5f63 6875 6e6b 696e 675f   apply_chunking_
+000004c0: 746f 5f66 6f72 7761 7264 2c20 6669 6e64  to_forward, find
+000004d0: 5f70 7275 6e65 6162 6c65 5f68 6561 6473  _pruneable_heads
+000004e0: 5f61 6e64 5f69 6e64 6963 6573 2c20 7072  _and_indices, pr
+000004f0: 756e 655f 6c69 6e65 6172 5f6c 6179 6572  une_linear_layer
+00000500: 0a66 726f 6d20 2e2e 2e2e 7574 696c 7320  .from ....utils 
+00000510: 696d 706f 7274 2028 0a20 2020 204d 6f64  import (.    Mod
+00000520: 656c 4f75 7470 7574 2c0a 2020 2020 6c6f  elOutput,.    lo
+00000530: 6767 696e 672c 0a29 0a66 726f 6d20 2e2e  gging,.).from ..
+00000540: 6175 746f 2069 6d70 6f72 7420 4175 746f  auto import Auto
+00000550: 4d6f 6465 6c46 6f72 4361 7573 616c 4c4d  ModelForCausalLM
+00000560: 2c20 4175 746f 4d6f 6465 6c46 6f72 5365  , AutoModelForSe
+00000570: 7132 5365 714c 4d0a 6672 6f6d 202e 636f  q2SeqLM.from .co
+00000580: 6e66 6967 7572 6174 696f 6e5f 626c 6970  nfiguration_blip
+00000590: 5f32 2069 6d70 6f72 7420 426c 6970 3243  _2 import Blip2C
+000005a0: 6f6e 6669 672c 2042 6c69 7032 5146 6f72  onfig, Blip2QFor
+000005b0: 6d65 7243 6f6e 6669 672c 2042 6c69 7032  merConfig, Blip2
+000005c0: 5669 7369 6f6e 436f 6e66 6967 0a0a 0a6c  VisionConfig...l
+000005d0: 6f67 6765 7220 3d20 6c6f 6767 696e 672e  ogger = logging.
+000005e0: 6765 745f 6c6f 6767 6572 285f 5f6e 616d  get_logger(__nam
+000005f0: 655f 5f29 0a0a 5f43 4845 434b 504f 494e  e__).._CHECKPOIN
+00000600: 545f 464f 525f 444f 4320 3d20 2253 616c  T_FOR_DOC = "Sal
+00000610: 6573 666f 7263 652f 626c 6970 322d 6f70  esforce/blip2-op
+00000620: 742d 322e 3762 220a 0a0a 4064 6174 6163  t-2.7b"...@datac
+00000630: 6c61 7373 0a63 6c61 7373 2042 6c69 7032  lass.class Blip2
+00000640: 466f 7243 6f6e 6469 7469 6f6e 616c 4765  ForConditionalGe
+00000650: 6e65 7261 7469 6f6e 4d6f 6465 6c4f 7574  nerationModelOut
+00000660: 7075 7428 4d6f 6465 6c4f 7574 7075 7429  put(ModelOutput)
+00000670: 3a0a 2020 2020 2222 220a 2020 2020 436c  :.    """.    Cl
+00000680: 6173 7320 6465 6669 6e69 6e67 2074 6865  ass defining the
+00000690: 206f 7574 7075 7473 206f 6620 5b60 426c   outputs of [`Bl
+000006a0: 6970 3246 6f72 436f 6e64 6974 696f 6e61  ip2ForConditiona
+000006b0: 6c47 656e 6572 6174 696f 6e60 5d2e 0a0a  lGeneration`]...
+000006c0: 2020 2020 4172 6773 3a0a 2020 2020 2020      Args:.      
+000006d0: 2020 6c6f 7373 2028 606d 696e 6473 706f    loss (`mindspo
+000006e0: 7265 2e54 656e 736f 7260 2c20 2a6f 7074  re.Tensor`, *opt
+000006f0: 696f 6e61 6c2a 2c20 7265 7475 726e 6564  ional*, returned
+00000700: 2077 6865 6e20 606c 6162 656c 7360 2069   when `labels` i
+00000710: 7320 7072 6f76 6964 6564 2c20 606d 696e  s provided, `min
+00000720: 6473 706f 7265 2e54 656e 736f 7260 206f  dspore.Tensor` o
+00000730: 6620 7368 6170 6520 6028 312c 2960 293a  f shape `(1,)`):
+00000740: 0a20 2020 2020 2020 2020 2020 204c 616e  .            Lan
+00000750: 6775 6167 6520 6d6f 6465 6c69 6e67 206c  guage modeling l
+00000760: 6f73 7320 6672 6f6d 2074 6865 206c 616e  oss from the lan
+00000770: 6775 6167 6520 6d6f 6465 6c2e 0a20 2020  guage model..   
+00000780: 2020 2020 206c 6f67 6974 7320 2860 6d69       logits (`mi
+00000790: 6e64 7370 6f72 652e 5465 6e73 6f72 6020  ndspore.Tensor` 
+000007a0: 6f66 2073 6861 7065 2060 2862 6174 6368  of shape `(batch
+000007b0: 5f73 697a 652c 2073 6571 7565 6e63 655f  _size, sequence_
+000007c0: 6c65 6e67 7468 2c20 636f 6e66 6967 2e76  length, config.v
+000007d0: 6f63 6162 5f73 697a 6529 6029 3a0a 2020  ocab_size)`):.  
+000007e0: 2020 2020 2020 2020 2020 5072 6564 6963            Predic
+000007f0: 7469 6f6e 2073 636f 7265 7320 6f66 2074  tion scores of t
+00000800: 6865 206c 616e 6775 6167 6520 6d6f 6465  he language mode
+00000810: 6c69 6e67 2068 6561 6420 6f66 2074 6865  ling head of the
+00000820: 206c 616e 6775 6167 6520 6d6f 6465 6c2e   language model.
+00000830: 0a20 2020 2020 2020 2076 6973 696f 6e5f  .        vision_
+00000840: 6f75 7470 7574 7320 2860 4261 7365 4d6f  outputs (`BaseMo
+00000850: 6465 6c4f 7574 7075 7457 6974 6850 6f6f  delOutputWithPoo
+00000860: 6c69 6e67 6029 3a0a 2020 2020 2020 2020  ling`):.        
+00000870: 2020 2020 4f75 7470 7574 7320 6f66 2074      Outputs of t
+00000880: 6865 2076 6973 696f 6e20 656e 636f 6465  he vision encode
+00000890: 722e 0a20 2020 2020 2020 2071 666f 726d  r..        qform
+000008a0: 6572 5f6f 7574 7075 7473 2028 6042 6173  er_outputs (`Bas
+000008b0: 654d 6f64 656c 4f75 7470 7574 5769 7468  eModelOutputWith
+000008c0: 506f 6f6c 696e 6741 6e64 4372 6f73 7341  PoolingAndCrossA
+000008d0: 7474 656e 7469 6f6e 7360 293a 0a20 2020  ttentions`):.   
+000008e0: 2020 2020 2020 2020 204f 7574 7075 7473           Outputs
+000008f0: 206f 6620 7468 6520 512d 466f 726d 6572   of the Q-Former
+00000900: 2028 5175 6572 7969 6e67 2054 7261 6e73   (Querying Trans
+00000910: 666f 726d 6572 292e 0a20 2020 2020 2020  former)..       
+00000920: 206c 616e 6775 6167 655f 6d6f 6465 6c5f   language_model_
+00000930: 6f75 7470 7574 7320 2860 4361 7573 616c  outputs (`Causal
+00000940: 4c4d 4f75 7470 7574 5769 7468 5061 7374  LMOutputWithPast
+00000950: 6020 6f72 2060 5365 7132 5365 714c 4d4f  ` or `Seq2SeqLMO
+00000960: 7574 7075 7460 293a 0a20 2020 2020 2020  utput`):.       
+00000970: 2020 2020 204f 7574 7075 7473 206f 6620       Outputs of 
+00000980: 7468 6520 6c61 6e67 7561 6765 206d 6f64  the language mod
+00000990: 656c 2e0a 2020 2020 2222 220a 0a20 2020  el..    """..   
+000009a0: 206c 6f73 733a 204f 7074 696f 6e61 6c5b   loss: Optional[
+000009b0: 5475 706c 655b 6d69 6e64 7370 6f72 652e  Tuple[mindspore.
+000009c0: 5465 6e73 6f72 5d5d 203d 204e 6f6e 650a  Tensor]] = None.
+000009d0: 2020 2020 6c6f 6769 7473 3a20 4f70 7469      logits: Opti
+000009e0: 6f6e 616c 5b54 7570 6c65 5b6d 696e 6473  onal[Tuple[minds
+000009f0: 706f 7265 2e54 656e 736f 725d 5d20 3d20  pore.Tensor]] = 
+00000a00: 4e6f 6e65 0a20 2020 2076 6973 696f 6e5f  None.    vision_
+00000a10: 6f75 7470 7574 733a 204f 7074 696f 6e61  outputs: Optiona
+00000a20: 6c5b 6d69 6e64 7370 6f72 652e 5465 6e73  l[mindspore.Tens
+00000a30: 6f72 5d20 3d20 4e6f 6e65 0a20 2020 2071  or] = None.    q
+00000a40: 666f 726d 6572 5f6f 7574 7075 7473 3a20  former_outputs: 
+00000a50: 4f70 7469 6f6e 616c 5b54 7570 6c65 5b6d  Optional[Tuple[m
+00000a60: 696e 6473 706f 7265 2e54 656e 736f 725d  indspore.Tensor]
+00000a70: 5d20 3d20 4e6f 6e65 0a20 2020 206c 616e  ] = None.    lan
+00000a80: 6775 6167 655f 6d6f 6465 6c5f 6f75 7470  guage_model_outp
+00000a90: 7574 733a 204f 7074 696f 6e61 6c5b 5475  uts: Optional[Tu
+00000aa0: 706c 655b 6d69 6e64 7370 6f72 652e 5465  ple[mindspore.Te
+00000ab0: 6e73 6f72 5d5d 203d 204e 6f6e 650a 0a20  nsor]] = None.. 
+00000ac0: 2020 2064 6566 2074 6f5f 7475 706c 6528     def to_tuple(
+00000ad0: 7365 6c66 2920 2d3e 2054 7570 6c65 5b41  self) -> Tuple[A
+00000ae0: 6e79 5d3a 0a20 2020 2020 2020 2072 6574  ny]:.        ret
+00000af0: 7572 6e20 7475 706c 6528 0a20 2020 2020  urn tuple(.     
+00000b00: 2020 2020 2020 2073 656c 665b 6b5d 0a20         self[k]. 
+00000b10: 2020 2020 2020 2020 2020 2069 6620 6b20             if k 
+00000b20: 6e6f 7420 696e 205b 2276 6973 696f 6e5f  not in ["vision_
+00000b30: 6f75 7470 7574 7322 2c20 2271 666f 726d  outputs", "qform
+00000b40: 6572 5f6f 7574 7075 7473 222c 2022 6c61  er_outputs", "la
+00000b50: 6e67 7561 6765 5f6d 6f64 656c 5f6f 7574  nguage_model_out
+00000b60: 7075 7473 225d 0a20 2020 2020 2020 2020  puts"].         
+00000b70: 2020 2065 6c73 6520 6765 7461 7474 7228     else getattr(
+00000b80: 7365 6c66 2c20 6b29 2e74 6f5f 7475 706c  self, k).to_tupl
+00000b90: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
+00000ba0: 666f 7220 6b20 696e 2073 656c 662e 6b65  for k in self.ke
+00000bb0: 7973 2829 0a20 2020 2020 2020 2029 0a0a  ys().        )..
+00000bc0: 0a23 2043 6f70 6965 6420 6672 6f6d 2074  .# Copied from t
+00000bd0: 7261 6e73 666f 726d 6572 732e 6d6f 6465  ransformers.mode
+00000be0: 6c73 2e62 6c69 702e 6d6f 6465 6c69 6e67  ls.blip.modeling
+00000bf0: 5f62 6c69 702e 426c 6970 5669 7369 6f6e  _blip.BlipVision
+00000c00: 456d 6265 6464 696e 6773 2077 6974 6820  Embeddings with 
+00000c10: 426c 6970 2d3e 426c 6970 320a 636c 6173  Blip->Blip2.clas
+00000c20: 7320 426c 6970 3256 6973 696f 6e45 6d62  s Blip2VisionEmb
+00000c30: 6564 6469 6e67 7328 6e6e 2e43 656c 6c29  eddings(nn.Cell)
+00000c40: 3a0a 2020 2020 6465 6620 5f5f 696e 6974  :.    def __init
+00000c50: 5f5f 2873 656c 662c 2063 6f6e 6669 673a  __(self, config:
+00000c60: 2042 6c69 7032 5669 7369 6f6e 436f 6e66   Blip2VisionConf
+00000c70: 6967 293a 0a20 2020 2020 2020 2073 7570  ig):.        sup
+00000c80: 6572 2829 2e5f 5f69 6e69 745f 5f28 290a  er().__init__().
+00000c90: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
+00000ca0: 6669 6720 3d20 636f 6e66 6967 0a20 2020  fig = config.   
+00000cb0: 2020 2020 2073 656c 662e 656d 6265 645f       self.embed_
+00000cc0: 6469 6d20 3d20 636f 6e66 6967 2e68 6964  dim = config.hid
+00000cd0: 6465 6e5f 7369 7a65 0a20 2020 2020 2020  den_size.       
+00000ce0: 2073 656c 662e 696d 6167 655f 7369 7a65   self.image_size
+00000cf0: 203d 2063 6f6e 6669 672e 696d 6167 655f   = config.image_
+00000d00: 7369 7a65 0a20 2020 2020 2020 2073 656c  size.        sel
+00000d10: 662e 7061 7463 685f 7369 7a65 203d 2063  f.patch_size = c
+00000d20: 6f6e 6669 672e 7061 7463 685f 7369 7a65  onfig.patch_size
+00000d30: 0a0a 2020 2020 2020 2020 7365 6c66 2e63  ..        self.c
+00000d40: 6c61 7373 5f65 6d62 6564 6469 6e67 203d  lass_embedding =
+00000d50: 2050 6172 616d 6574 6572 286f 7073 2e72   Parameter(ops.r
+00000d60: 616e 646e 2831 2c20 312c 2073 656c 662e  andn(1, 1, self.
+00000d70: 656d 6265 645f 6469 6d29 290a 0a20 2020  embed_dim))..   
+00000d80: 2020 2020 2073 656c 662e 7061 7463 685f       self.patch_
+00000d90: 656d 6265 6464 696e 6720 3d20 6e6e 2e43  embedding = nn.C
+00000da0: 6f6e 7632 6428 0a20 2020 2020 2020 2020  onv2d(.         
+00000db0: 2020 2069 6e5f 6368 616e 6e65 6c73 3d33     in_channels=3
+00000dc0: 2c20 6f75 745f 6368 616e 6e65 6c73 3d73  , out_channels=s
+00000dd0: 656c 662e 656d 6265 645f 6469 6d2c 206b  elf.embed_dim, k
+00000de0: 6572 6e65 6c5f 7369 7a65 3d73 656c 662e  ernel_size=self.
+00000df0: 7061 7463 685f 7369 7a65 2c20 7374 7269  patch_size, stri
+00000e00: 6465 3d73 656c 662e 7061 7463 685f 7369  de=self.patch_si
+00000e10: 7a65 2c0a 2020 2020 2020 2020 2020 2020  ze,.            
+00000e20: 6861 735f 6269 6173 3d54 7275 652c 2070  has_bias=True, p
+00000e30: 6164 5f6d 6f64 653d 2776 616c 6964 270a  ad_mode='valid'.
+00000e40: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00000e50: 2020 2073 656c 662e 6e75 6d5f 7061 7463     self.num_patc
+00000e60: 6865 7320 3d20 2873 656c 662e 696d 6167  hes = (self.imag
+00000e70: 655f 7369 7a65 202f 2f20 7365 6c66 2e70  e_size // self.p
+00000e80: 6174 6368 5f73 697a 6529 202a 2a20 320a  atch_size) ** 2.
+00000e90: 2020 2020 2020 2020 7365 6c66 2e6e 756d          self.num
+00000ea0: 5f70 6f73 6974 696f 6e73 203d 2073 656c  _positions = sel
+00000eb0: 662e 6e75 6d5f 7061 7463 6865 7320 2b20  f.num_patches + 
+00000ec0: 310a 0a20 2020 2020 2020 2073 656c 662e  1..        self.
+00000ed0: 706f 7369 7469 6f6e 5f65 6d62 6564 6469  position_embeddi
+00000ee0: 6e67 203d 2050 6172 616d 6574 6572 286f  ng = Parameter(o
+00000ef0: 7073 2e72 616e 646e 2831 2c20 7365 6c66  ps.randn(1, self
+00000f00: 2e6e 756d 5f70 6f73 6974 696f 6e73 2c20  .num_positions, 
+00000f10: 7365 6c66 2e65 6d62 6564 5f64 696d 2929  self.embed_dim))
+00000f20: 0a0a 2020 2020 6465 6620 636f 6e73 7472  ..    def constr
+00000f30: 7563 7428 7365 6c66 2c20 7069 7865 6c5f  uct(self, pixel_
+00000f40: 7661 6c75 6573 3a20 6d69 6e64 7370 6f72  values: mindspor
+00000f50: 652e 5465 6e73 6f72 2920 2d3e 206d 696e  e.Tensor) -> min
+00000f60: 6473 706f 7265 2e54 656e 736f 723a 0a20  dspore.Tensor:. 
+00000f70: 2020 2020 2020 2062 6174 6368 5f73 697a         batch_siz
+00000f80: 6520 3d20 7069 7865 6c5f 7661 6c75 6573  e = pixel_values
+00000f90: 2e73 6861 7065 5b30 5d0a 2020 2020 2020  .shape[0].      
+00000fa0: 2020 7461 7267 6574 5f64 7479 7065 203d    target_dtype =
+00000fb0: 2073 656c 662e 7061 7463 685f 656d 6265   self.patch_embe
+00000fc0: 6464 696e 672e 7765 6967 6874 2e64 7479  dding.weight.dty
+00000fd0: 7065 0a20 2020 2020 2020 2070 6174 6368  pe.        patch
+00000fe0: 5f65 6d62 6564 7320 3d20 7365 6c66 2e70  _embeds = self.p
+00000ff0: 6174 6368 5f65 6d62 6564 6469 6e67 2870  atch_embedding(p
+00001000: 6978 656c 5f76 616c 7565 732e 746f 2864  ixel_values.to(d
+00001010: 7479 7065 3d74 6172 6765 745f 6474 7970  type=target_dtyp
+00001020: 6529 2920 2023 2073 6861 7065 203d 205b  e))  # shape = [
+00001030: 2a2c 2077 6964 7468 2c20 6772 6964 2c20  *, width, grid, 
+00001040: 6772 6964 5d0a 2020 2020 2020 2020 7061  grid].        pa
+00001050: 7463 685f 656d 6265 6473 203d 2070 6174  tch_embeds = pat
+00001060: 6368 5f65 6d62 6564 732e 666c 6174 7465  ch_embeds.flatte
+00001070: 6e28 7374 6172 745f 6469 6d3d 3229 2e73  n(start_dim=2).s
+00001080: 7761 7061 7865 7328 312c 2032 290a 0a20  wapaxes(1, 2).. 
+00001090: 2020 2020 2020 2063 6c61 7373 5f65 6d62         class_emb
+000010a0: 6564 7320 3d20 7365 6c66 2e63 6c61 7373  eds = self.class
+000010b0: 5f65 6d62 6564 6469 6e67 2e65 7870 616e  _embedding.expan
+000010c0: 6428 6261 7463 685f 7369 7a65 2c20 312c  d(batch_size, 1,
+000010d0: 202d 3129 2e74 6f28 7461 7267 6574 5f64   -1).to(target_d
+000010e0: 7479 7065 290a 2020 2020 2020 2020 656d  type).        em
+000010f0: 6265 6464 696e 6773 203d 206f 7073 2e63  beddings = ops.c
+00001100: 6174 285b 636c 6173 735f 656d 6265 6473  at([class_embeds
+00001110: 2c20 7061 7463 685f 656d 6265 6473 5d2c  , patch_embeds],
+00001120: 2061 7869 733d 3129 0a20 2020 2020 2020   axis=1).       
+00001130: 2065 6d62 6564 6469 6e67 7320 3d20 656d   embeddings = em
+00001140: 6265 6464 696e 6773 202b 2073 656c 662e  beddings + self.
+00001150: 706f 7369 7469 6f6e 5f65 6d62 6564 6469  position_embeddi
+00001160: 6e67 5b3a 2c20 3a20 656d 6265 6464 696e  ng[:, : embeddin
+00001170: 6773 2e73 6861 7065 5b31 5d2c 203a 5d2e  gs.shape[1], :].
+00001180: 746f 2874 6172 6765 745f 6474 7970 6529  to(target_dtype)
+00001190: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000011a0: 656d 6265 6464 696e 6773 0a0a 0a63 6c61  embeddings...cla
+000011b0: 7373 2042 6c69 7032 4174 7465 6e74 696f  ss Blip2Attentio
+000011c0: 6e28 6e6e 2e43 656c 6c29 3a0a 2020 2020  n(nn.Cell):.    
+000011d0: 2222 224d 756c 7469 2d68 6561 6465 6420  """Multi-headed 
+000011e0: 6174 7465 6e74 696f 6e20 6672 6f6d 2027  attention from '
+000011f0: 4174 7465 6e74 696f 6e20 4973 2041 6c6c  Attention Is All
+00001200: 2059 6f75 204e 6565 6427 2070 6170 6572   You Need' paper
+00001210: 2222 220a 0a20 2020 2064 6566 205f 5f69  """..    def __i
+00001220: 6e69 745f 5f28 7365 6c66 2c20 636f 6e66  nit__(self, conf
+00001230: 6967 293a 0a20 2020 2020 2020 2073 7570  ig):.        sup
+00001240: 6572 2829 2e5f 5f69 6e69 745f 5f28 290a  er().__init__().
+00001250: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
+00001260: 6669 6720 3d20 636f 6e66 6967 0a20 2020  fig = config.   
+00001270: 2020 2020 2073 656c 662e 656d 6265 645f       self.embed_
+00001280: 6469 6d20 3d20 636f 6e66 6967 2e68 6964  dim = config.hid
+00001290: 6465 6e5f 7369 7a65 0a20 2020 2020 2020  den_size.       
+000012a0: 2073 656c 662e 6e75 6d5f 6865 6164 7320   self.num_heads 
+000012b0: 3d20 636f 6e66 6967 2e6e 756d 5f61 7474  = config.num_att
+000012c0: 656e 7469 6f6e 5f68 6561 6473 0a20 2020  ention_heads.   
+000012d0: 2020 2020 2073 656c 662e 6865 6164 5f64       self.head_d
+000012e0: 696d 203d 2073 656c 662e 656d 6265 645f  im = self.embed_
+000012f0: 6469 6d20 2f2f 2073 656c 662e 6e75 6d5f  dim // self.num_
+00001300: 6865 6164 730a 2020 2020 2020 2020 6966  heads.        if
+00001310: 2073 656c 662e 6865 6164 5f64 696d 202a   self.head_dim *
+00001320: 2073 656c 662e 6e75 6d5f 6865 6164 7320   self.num_heads 
+00001330: 213d 2073 656c 662e 656d 6265 645f 6469  != self.embed_di
+00001340: 6d3a 0a20 2020 2020 2020 2020 2020 2072  m:.            r
+00001350: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+00001360: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00001370: 2066 2265 6d62 6564 5f64 696d 206d 7573   f"embed_dim mus
+00001380: 7420 6265 2064 6976 6973 6962 6c65 2062  t be divisible b
+00001390: 7920 6e75 6d5f 6865 6164 7320 2867 6f74  y num_heads (got
+000013a0: 2060 656d 6265 645f 6469 6d60 3a20 7b73   `embed_dim`: {s
+000013b0: 656c 662e 656d 6265 645f 6469 6d7d 2061  elf.embed_dim} a
+000013c0: 6e64 2060 6e75 6d5f 6865 6164 7360 3a22  nd `num_heads`:"
+000013d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000013e0: 2066 2220 7b73 656c 662e 6e75 6d5f 6865   f" {self.num_he
+000013f0: 6164 737d 292e 220a 2020 2020 2020 2020  ads}).".        
+00001400: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
+00001410: 6c66 2e73 6361 6c65 203d 2073 656c 662e  lf.scale = self.
+00001420: 6865 6164 5f64 696d 2a2a 2d30 2e35 0a20  head_dim**-0.5. 
+00001430: 2020 2020 2020 2073 656c 662e 6472 6f70         self.drop
+00001440: 6f75 7420 3d20 6e6e 2e44 726f 706f 7574  out = nn.Dropout
+00001450: 2870 3d63 6f6e 6669 672e 6174 7465 6e74  (p=config.attent
+00001460: 696f 6e5f 6472 6f70 6f75 7429 0a0a 2020  ion_dropout)..  
+00001470: 2020 2020 2020 2320 736d 616c 6c20 7477        # small tw
+00001480: 6561 6b20 6865 7265 2063 6f6d 7061 7265  eak here compare
+00001490: 6420 746f 2043 4c49 502c 206e 6f20 6269  d to CLIP, no bi
+000014a0: 6173 2068 6572 650a 2020 2020 2020 2020  as here.        
+000014b0: 7365 6c66 2e71 6b76 203d 206e 6e2e 4465  self.qkv = nn.De
+000014c0: 6e73 6528 7365 6c66 2e65 6d62 6564 5f64  nse(self.embed_d
+000014d0: 696d 2c20 3320 2a20 7365 6c66 2e65 6d62  im, 3 * self.emb
+000014e0: 6564 5f64 696d 2c20 6861 735f 6269 6173  ed_dim, has_bias
+000014f0: 3d46 616c 7365 290a 0a20 2020 2020 2020  =False)..       
+00001500: 2069 6620 636f 6e66 6967 2e71 6b76 5f62   if config.qkv_b
+00001510: 6961 733a 0a20 2020 2020 2020 2020 2020  ias:.           
+00001520: 2071 5f62 6961 7320 3d20 5061 7261 6d65   q_bias = Parame
+00001530: 7465 7228 6f70 732e 7a65 726f 7328 7365  ter(ops.zeros(se
+00001540: 6c66 2e65 6d62 6564 5f64 696d 2929 0a20  lf.embed_dim)). 
+00001550: 2020 2020 2020 2020 2020 2076 5f62 6961             v_bia
+00001560: 7320 3d20 5061 7261 6d65 7465 7228 6f70  s = Parameter(op
+00001570: 732e 7a65 726f 7328 7365 6c66 2e65 6d62  s.zeros(self.emb
+00001580: 6564 5f64 696d 2929 0a20 2020 2020 2020  ed_dim)).       
+00001590: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000015a0: 2020 2071 5f62 6961 7320 3d20 4e6f 6e65     q_bias = None
+000015b0: 0a20 2020 2020 2020 2020 2020 2076 5f62  .            v_b
+000015c0: 6961 7320 3d20 4e6f 6e65 0a0a 2020 2020  ias = None..    
+000015d0: 2020 2020 6966 2071 5f62 6961 7320 6973      if q_bias is
+000015e0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+000015f0: 2020 2020 2020 2071 6b76 5f62 6961 7320         qkv_bias 
+00001600: 3d20 6f70 732e 6361 7428 2871 5f62 6961  = ops.cat((q_bia
+00001610: 732c 206f 7073 2e7a 6572 6f73 5f6c 696b  s, ops.zeros_lik
+00001620: 6528 765f 6269 6173 292c 2076 5f62 6961  e(v_bias), v_bia
+00001630: 7329 290a 2020 2020 2020 2020 2020 2020  s)).            
+00001640: 7365 6c66 2e71 6b76 2e62 6961 7320 3d20  self.qkv.bias = 
+00001650: 5061 7261 6d65 7465 7228 716b 765f 6269  Parameter(qkv_bi
+00001660: 6173 290a 0a20 2020 2020 2020 2073 656c  as)..        sel
+00001670: 662e 7072 6f6a 6563 7469 6f6e 203d 206e  f.projection = n
+00001680: 6e2e 4465 6e73 6528 7365 6c66 2e65 6d62  n.Dense(self.emb
+00001690: 6564 5f64 696d 2c20 7365 6c66 2e65 6d62  ed_dim, self.emb
+000016a0: 6564 5f64 696d 290a 0a20 2020 2064 6566  ed_dim)..    def
+000016b0: 205f 7368 6170 6528 7365 6c66 2c20 7465   _shape(self, te
+000016c0: 6e73 6f72 3a20 6d69 6e64 7370 6f72 652e  nsor: mindspore.
+000016d0: 5465 6e73 6f72 2c20 7365 715f 6c65 6e3a  Tensor, seq_len:
+000016e0: 2069 6e74 2c20 6273 7a3a 2069 6e74 293a   int, bsz: int):
+000016f0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00001700: 7465 6e73 6f72 2e76 6965 7728 6273 7a2c  tensor.view(bsz,
+00001710: 2073 6571 5f6c 656e 2c20 7365 6c66 2e6e   seq_len, self.n
+00001720: 756d 5f68 6561 6473 2c20 7365 6c66 2e68  um_heads, self.h
+00001730: 6561 645f 6469 6d29 2e73 7761 7061 7865  ead_dim).swapaxe
+00001740: 7328 312c 2032 290a 0a20 2020 2064 6566  s(1, 2)..    def
+00001750: 2063 6f6e 7374 7275 6374 280a 2020 2020   construct(.    
+00001760: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+00001770: 2020 6869 6464 656e 5f73 7461 7465 733a    hidden_states:
+00001780: 206d 696e 6473 706f 7265 2e54 656e 736f   mindspore.Tenso
+00001790: 722c 0a20 2020 2020 2020 2068 6561 645f  r,.        head_
+000017a0: 6d61 736b 3a20 4f70 7469 6f6e 616c 5b6d  mask: Optional[m
+000017b0: 696e 6473 706f 7265 2e54 656e 736f 725d  indspore.Tensor]
+000017c0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+000017d0: 206f 7574 7075 745f 6174 7465 6e74 696f   output_attentio
+000017e0: 6e73 3a20 4f70 7469 6f6e 616c 5b62 6f6f  ns: Optional[boo
+000017f0: 6c5d 203d 2046 616c 7365 2c0a 2020 2020  l] = False,.    
+00001800: 2920 2d3e 2054 7570 6c65 5b6d 696e 6473  ) -> Tuple[minds
+00001810: 706f 7265 2e54 656e 736f 722c 204f 7074  pore.Tensor, Opt
+00001820: 696f 6e61 6c5b 6d69 6e64 7370 6f72 652e  ional[mindspore.
+00001830: 5465 6e73 6f72 5d2c 204f 7074 696f 6e61  Tensor], Optiona
+00001840: 6c5b 5475 706c 655b 6d69 6e64 7370 6f72  l[Tuple[mindspor
+00001850: 652e 5465 6e73 6f72 5d5d 5d3a 0a20 2020  e.Tensor]]]:.   
+00001860: 2020 2020 2022 2222 496e 7075 7420 7368       """Input sh
+00001870: 6170 653a 2042 6174 6368 2078 2054 696d  ape: Batch x Tim
+00001880: 6520 7820 4368 616e 6e65 6c22 2222 0a0a  e x Channel"""..
+00001890: 2020 2020 2020 2020 6273 7a2c 2074 6774          bsz, tgt
+000018a0: 5f6c 656e 2c20 656d 6265 645f 6469 6d20  _len, embed_dim 
+000018b0: 3d20 6869 6464 656e 5f73 7461 7465 732e  = hidden_states.
+000018c0: 7368 6170 650a 0a20 2020 2020 2020 206d  shape..        m
+000018d0: 6978 6564 5f71 6b76 203d 2073 656c 662e  ixed_qkv = self.
+000018e0: 716b 7628 6869 6464 656e 5f73 7461 7465  qkv(hidden_state
+000018f0: 7329 0a0a 2020 2020 2020 2020 6d69 7865  s)..        mixe
+00001900: 645f 716b 7620 3d20 6d69 7865 645f 716b  d_qkv = mixed_qk
+00001910: 762e 7265 7368 6170 6528 6273 7a2c 2074  v.reshape(bsz, t
+00001920: 6774 5f6c 656e 2c20 332c 2073 656c 662e  gt_len, 3, self.
+00001930: 6e75 6d5f 6865 6164 732c 2065 6d62 6564  num_heads, embed
+00001940: 5f64 696d 202f 2f20 7365 6c66 2e6e 756d  _dim // self.num
+00001950: 5f68 6561 6473 292e 7065 726d 7574 6528  _heads).permute(
+00001960: 0a20 2020 2020 2020 2020 2020 2032 2c20  .            2, 
+00001970: 302c 2033 2c20 312c 2034 0a20 2020 2020  0, 3, 1, 4.     
+00001980: 2020 2029 0a20 2020 2020 2020 2071 7565     ).        que
+00001990: 7279 5f73 7461 7465 732c 206b 6579 5f73  ry_states, key_s
+000019a0: 7461 7465 732c 2076 616c 7565 5f73 7461  tates, value_sta
+000019b0: 7465 7320 3d20 6d69 7865 645f 716b 765b  tes = mixed_qkv[
+000019c0: 305d 2c20 6d69 7865 645f 716b 765b 315d  0], mixed_qkv[1]
+000019d0: 2c20 6d69 7865 645f 716b 765b 325d 0a0a  , mixed_qkv[2]..
+000019e0: 2020 2020 2020 2020 2320 5461 6b65 2074          # Take t
+000019f0: 6865 2064 6f74 2070 726f 6475 6374 2062  he dot product b
+00001a00: 6574 7765 656e 2022 7175 6572 7922 2061  etween "query" a
+00001a10: 6e64 2022 6b65 7922 2074 6f20 6765 7420  nd "key" to get 
+00001a20: 7468 6520 7261 7720 6174 7465 6e74 696f  the raw attentio
+00001a30: 6e20 7363 6f72 6573 2e0a 2020 2020 2020  n scores..      
+00001a40: 2020 6174 7465 6e74 696f 6e5f 7363 6f72    attention_scor
+00001a50: 6573 203d 206f 7073 2e6d 6174 6d75 6c28  es = ops.matmul(
+00001a60: 7175 6572 795f 7374 6174 6573 2c20 6b65  query_states, ke
+00001a70: 795f 7374 6174 6573 2e73 7761 7061 7865  y_states.swapaxe
+00001a80: 7328 2d31 2c20 2d32 2929 0a0a 2020 2020  s(-1, -2))..    
+00001a90: 2020 2020 6174 7465 6e74 696f 6e5f 7363      attention_sc
+00001aa0: 6f72 6573 203d 2061 7474 656e 7469 6f6e  ores = attention
+00001ab0: 5f73 636f 7265 7320 2a20 7365 6c66 2e73  _scores * self.s
+00001ac0: 6361 6c65 0a0a 2020 2020 2020 2020 2320  cale..        # 
+00001ad0: 4e6f 726d 616c 697a 6520 7468 6520 6174  Normalize the at
+00001ae0: 7465 6e74 696f 6e20 7363 6f72 6573 2074  tention scores t
+00001af0: 6f20 7072 6f62 6162 696c 6974 6965 732e  o probabilities.
+00001b00: 0a20 2020 2020 2020 2061 7474 656e 7469  .        attenti
+00001b10: 6f6e 5f70 726f 6273 203d 206f 7073 2e73  on_probs = ops.s
+00001b20: 6f66 746d 6178 2861 7474 656e 7469 6f6e  oftmax(attention
+00001b30: 5f73 636f 7265 732c 2061 7869 733d 2d31  _scores, axis=-1
+00001b40: 290a 0a20 2020 2020 2020 2023 2054 6869  )..        # Thi
+00001b50: 7320 6973 2061 6374 7561 6c6c 7920 6472  s is actually dr
+00001b60: 6f70 7069 6e67 206f 7574 2065 6e74 6972  opping out entir
+00001b70: 6520 746f 6b65 6e73 2074 6f20 6174 7465  e tokens to atte
+00001b80: 6e64 2074 6f2c 2077 6869 6368 206d 6967  nd to, which mig
+00001b90: 6874 0a20 2020 2020 2020 2023 2073 6565  ht.        # see
+00001ba0: 6d20 6120 6269 7420 756e 7573 7561 6c2c  m a bit unusual,
+00001bb0: 2062 7574 2069 7320 7461 6b65 6e20 6672   but is taken fr
+00001bc0: 6f6d 2074 6865 206f 7269 6769 6e61 6c20  om the original 
+00001bd0: 5472 616e 7366 6f72 6d65 7220 7061 7065  Transformer pape
+00001be0: 722e 0a20 2020 2020 2020 2061 7474 656e  r..        atten
+00001bf0: 7469 6f6e 5f70 726f 6273 203d 2073 656c  tion_probs = sel
+00001c00: 662e 6472 6f70 6f75 7428 6174 7465 6e74  f.dropout(attent
+00001c10: 696f 6e5f 7072 6f62 7329 0a0a 2020 2020  ion_probs)..    
+00001c20: 2020 2020 2320 4d61 736b 2068 6561 6473      # Mask heads
+00001c30: 2069 6620 7765 2077 616e 7420 746f 0a20   if we want to. 
+00001c40: 2020 2020 2020 2069 6620 6865 6164 5f6d         if head_m
+00001c50: 6173 6b20 6973 206e 6f74 204e 6f6e 653a  ask is not None:
+00001c60: 0a20 2020 2020 2020 2020 2020 2061 7474  .            att
+00001c70: 656e 7469 6f6e 5f70 726f 6273 203d 2061  ention_probs = a
+00001c80: 7474 656e 7469 6f6e 5f70 726f 6273 202a  ttention_probs *
+00001c90: 2068 6561 645f 6d61 736b 0a0a 2020 2020   head_mask..    
+00001ca0: 2020 2020 636f 6e74 6578 745f 6c61 7965      context_laye
+00001cb0: 7220 3d20 6f70 732e 6d61 746d 756c 2861  r = ops.matmul(a
+00001cc0: 7474 656e 7469 6f6e 5f70 726f 6273 2c20  ttention_probs, 
+00001cd0: 7661 6c75 655f 7374 6174 6573 292e 7065  value_states).pe
+00001ce0: 726d 7574 6528 302c 2032 2c20 312c 2033  rmute(0, 2, 1, 3
+00001cf0: 290a 0a20 2020 2020 2020 206e 6577 5f63  )..        new_c
+00001d00: 6f6e 7465 7874 5f6c 6179 6572 5f73 6861  ontext_layer_sha
+00001d10: 7065 203d 2063 6f6e 7465 7874 5f6c 6179  pe = context_lay
+00001d20: 6572 2e73 6861 7065 5b3a 2d32 5d20 2b20  er.shape[:-2] + 
+00001d30: 2873 656c 662e 656d 6265 645f 6469 6d2c  (self.embed_dim,
+00001d40: 290a 2020 2020 2020 2020 636f 6e74 6578  ).        contex
+00001d50: 745f 6c61 7965 7220 3d20 636f 6e74 6578  t_layer = contex
+00001d60: 745f 6c61 7965 722e 7265 7368 6170 6528  t_layer.reshape(
+00001d70: 6e65 775f 636f 6e74 6578 745f 6c61 7965  new_context_laye
+00001d80: 725f 7368 6170 6529 0a0a 2020 2020 2020  r_shape)..      
+00001d90: 2020 6f75 7470 7574 203d 2073 656c 662e    output = self.
+00001da0: 7072 6f6a 6563 7469 6f6e 2863 6f6e 7465  projection(conte
+00001db0: 7874 5f6c 6179 6572 290a 0a20 2020 2020  xt_layer)..     
+00001dc0: 2020 206f 7574 7075 7473 203d 2028 6f75     outputs = (ou
+00001dd0: 7470 7574 2c20 6174 7465 6e74 696f 6e5f  tput, attention_
+00001de0: 7072 6f62 7329 2069 6620 6f75 7470 7574  probs) if output
+00001df0: 5f61 7474 656e 7469 6f6e 7320 656c 7365  _attentions else
+00001e00: 2028 6f75 7470 7574 2c20 4e6f 6e65 290a   (output, None).
+00001e10: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00001e20: 6f75 7470 7574 730a 0a0a 2320 436f 7069  outputs...# Copi
+00001e30: 6564 2066 726f 6d20 7472 616e 7366 6f72  ed from transfor
+00001e40: 6d65 7273 2e6d 6f64 656c 732e 626c 6970  mers.models.blip
+00001e50: 2e6d 6f64 656c 696e 675f 626c 6970 2e42  .modeling_blip.B
+00001e60: 6c69 704d 4c50 0a63 6c61 7373 2042 6c69  lipMLP.class Bli
+00001e70: 7032 4d4c 5028 6e6e 2e43 656c 6c29 3a0a  p2MLP(nn.Cell):.
+00001e80: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
+00001e90: 2873 656c 662c 2063 6f6e 6669 6729 3a0a  (self, config):.
+00001ea0: 2020 2020 2020 2020 7375 7065 7228 292e          super().
+00001eb0: 5f5f 696e 6974 5f5f 2829 0a20 2020 2020  __init__().     
+00001ec0: 2020 2073 656c 662e 636f 6e66 6967 203d     self.config =
+00001ed0: 2063 6f6e 6669 670a 2020 2020 2020 2020   config.        
+00001ee0: 7365 6c66 2e61 6374 6976 6174 696f 6e5f  self.activation_
+00001ef0: 666e 203d 2041 4354 3246 4e5b 636f 6e66  fn = ACT2FN[conf
+00001f00: 6967 2e68 6964 6465 6e5f 6163 745d 0a20  ig.hidden_act]. 
+00001f10: 2020 2020 2020 2073 656c 662e 6663 3120         self.fc1 
+00001f20: 3d20 6e6e 2e44 656e 7365 2863 6f6e 6669  = nn.Dense(confi
+00001f30: 672e 6869 6464 656e 5f73 697a 652c 2063  g.hidden_size, c
+00001f40: 6f6e 6669 672e 696e 7465 726d 6564 6961  onfig.intermedia
+00001f50: 7465 5f73 697a 6529 0a20 2020 2020 2020  te_size).       
+00001f60: 2073 656c 662e 6663 3220 3d20 6e6e 2e44   self.fc2 = nn.D
+00001f70: 656e 7365 2863 6f6e 6669 672e 696e 7465  ense(config.inte
+00001f80: 726d 6564 6961 7465 5f73 697a 652c 2063  rmediate_size, c
+00001f90: 6f6e 6669 672e 6869 6464 656e 5f73 697a  onfig.hidden_siz
+00001fa0: 6529 0a0a 2020 2020 6465 6620 636f 6e73  e)..    def cons
+00001fb0: 7472 7563 7428 7365 6c66 2c20 6869 6464  truct(self, hidd
+00001fc0: 656e 5f73 7461 7465 733a 206d 696e 6473  en_states: minds
+00001fd0: 706f 7265 2e54 656e 736f 7229 202d 3e20  pore.Tensor) -> 
+00001fe0: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+00001ff0: 3a0a 2020 2020 2020 2020 6869 6464 656e  :.        hidden
+00002000: 5f73 7461 7465 7320 3d20 7365 6c66 2e66  _states = self.f
+00002010: 6331 2868 6964 6465 6e5f 7374 6174 6573  c1(hidden_states
+00002020: 290a 2020 2020 2020 2020 6869 6464 656e  ).        hidden
+00002030: 5f73 7461 7465 7320 3d20 7365 6c66 2e61  _states = self.a
+00002040: 6374 6976 6174 696f 6e5f 666e 2868 6964  ctivation_fn(hid
+00002050: 6465 6e5f 7374 6174 6573 290a 2020 2020  den_states).    
+00002060: 2020 2020 6869 6464 656e 5f73 7461 7465      hidden_state
+00002070: 7320 3d20 7365 6c66 2e66 6332 2868 6964  s = self.fc2(hid
+00002080: 6465 6e5f 7374 6174 6573 290a 2020 2020  den_states).    
+00002090: 2020 2020 7265 7475 726e 2068 6964 6465      return hidde
+000020a0: 6e5f 7374 6174 6573 0a0a 0a23 2043 6f70  n_states...# Cop
+000020b0: 6965 6420 6672 6f6d 2074 7261 6e73 666f  ied from transfo
+000020c0: 726d 6572 732e 6d6f 6465 6c73 2e62 6c69  rmers.models.bli
+000020d0: 702e 6d6f 6465 6c69 6e67 5f62 6c69 702e  p.modeling_blip.
+000020e0: 426c 6970 456e 636f 6465 724c 6179 6572  BlipEncoderLayer
+000020f0: 2077 6974 6820 426c 6970 2d3e 426c 6970   with Blip->Blip
+00002100: 320a 636c 6173 7320 426c 6970 3245 6e63  2.class Blip2Enc
+00002110: 6f64 6572 4c61 7965 7228 6e6e 2e43 656c  oderLayer(nn.Cel
+00002120: 6c29 3a0a 2020 2020 6465 6620 5f5f 696e  l):.    def __in
+00002130: 6974 5f5f 2873 656c 662c 2063 6f6e 6669  it__(self, confi
+00002140: 673a 2042 6c69 7032 436f 6e66 6967 293a  g: Blip2Config):
+00002150: 0a20 2020 2020 2020 2073 7570 6572 2829  .        super()
+00002160: 2e5f 5f69 6e69 745f 5f28 290a 2020 2020  .__init__().    
+00002170: 2020 2020 7365 6c66 2e65 6d62 6564 5f64      self.embed_d
+00002180: 696d 203d 2063 6f6e 6669 672e 6869 6464  im = config.hidd
+00002190: 656e 5f73 697a 650a 2020 2020 2020 2020  en_size.        
+000021a0: 7365 6c66 2e73 656c 665f 6174 746e 203d  self.self_attn =
+000021b0: 2042 6c69 7032 4174 7465 6e74 696f 6e28   Blip2Attention(
+000021c0: 636f 6e66 6967 290a 2020 2020 2020 2020  config).        
+000021d0: 7365 6c66 2e6c 6179 6572 5f6e 6f72 6d31  self.layer_norm1
+000021e0: 203d 206e 6e2e 4c61 7965 724e 6f72 6d28   = nn.LayerNorm(
+000021f0: 7365 6c66 2e65 6d62 6564 5f64 696d 2c20  self.embed_dim, 
+00002200: 6570 7369 6c6f 6e3d 636f 6e66 6967 2e6c  epsilon=config.l
+00002210: 6179 6572 5f6e 6f72 6d5f 6570 7329 0a20  ayer_norm_eps). 
+00002220: 2020 2020 2020 2073 656c 662e 6d6c 7020         self.mlp 
+00002230: 3d20 426c 6970 324d 4c50 2863 6f6e 6669  = Blip2MLP(confi
+00002240: 6729 0a20 2020 2020 2020 2073 656c 662e  g).        self.
+00002250: 6c61 7965 725f 6e6f 726d 3220 3d20 6e6e  layer_norm2 = nn
+00002260: 2e4c 6179 6572 4e6f 726d 2873 656c 662e  .LayerNorm(self.
+00002270: 656d 6265 645f 6469 6d2c 2065 7073 696c  embed_dim, epsil
+00002280: 6f6e 3d63 6f6e 6669 672e 6c61 7965 725f  on=config.layer_
+00002290: 6e6f 726d 5f65 7073 290a 0a20 2020 2064  norm_eps)..    d
+000022a0: 6566 2063 6f6e 7374 7275 6374 280a 2020  ef construct(.  
+000022b0: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+000022c0: 2020 2020 6869 6464 656e 5f73 7461 7465      hidden_state
+000022d0: 733a 206d 696e 6473 706f 7265 2e54 656e  s: mindspore.Ten
+000022e0: 736f 722c 0a20 2020 2020 2020 2061 7474  sor,.        att
+000022f0: 656e 7469 6f6e 5f6d 6173 6b3a 206d 696e  ention_mask: min
+00002300: 6473 706f 7265 2e54 656e 736f 722c 0a20  dspore.Tensor,. 
+00002310: 2020 2020 2020 206f 7574 7075 745f 6174         output_at
+00002320: 7465 6e74 696f 6e73 3a20 4f70 7469 6f6e  tentions: Option
+00002330: 616c 5b62 6f6f 6c5d 203d 2046 616c 7365  al[bool] = False
+00002340: 2c0a 2020 2020 2920 2d3e 2054 7570 6c65  ,.    ) -> Tuple
+00002350: 5b6d 696e 6473 706f 7265 2e54 656e 736f  [mindspore.Tenso
+00002360: 725d 3a0a 2020 2020 2020 2020 2222 220a  r]:.        """.
+00002370: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
+00002380: 2020 2020 2020 2020 2020 6869 6464 656e            hidden
+00002390: 5f73 7461 7465 7320 2860 6d69 6e64 7370  _states (`mindsp
+000023a0: 6f72 652e 5465 6e73 6f72 6029 3a20 696e  ore.Tensor`): in
+000023b0: 7075 7420 746f 2074 6865 206c 6179 6572  put to the layer
+000023c0: 206f 6620 7368 6170 6520 6028 6261 7463   of shape `(batc
+000023d0: 682c 2073 6571 5f6c 656e 2c20 656d 6265  h, seq_len, embe
+000023e0: 645f 6469 6d29 600a 2020 2020 2020 2020  d_dim)`.        
+000023f0: 2020 2020 6174 7465 6e74 696f 6e5f 6d61      attention_ma
+00002400: 736b 2028 606d 696e 6473 706f 7265 2e54  sk (`mindspore.T
+00002410: 656e 736f 7260 293a 2061 7474 656e 7469  ensor`): attenti
+00002420: 6f6e 206d 6173 6b20 6f66 2073 697a 650a  on mask of size.
+00002430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002440: 6028 6261 7463 682c 2031 2c20 7467 745f  `(batch, 1, tgt_
+00002450: 6c65 6e2c 2073 7263 5f6c 656e 2960 2077  len, src_len)` w
+00002460: 6865 7265 2070 6164 6469 6e67 2065 6c65  here padding ele
+00002470: 6d65 6e74 7320 6172 6520 696e 6469 6361  ments are indica
+00002480: 7465 6420 6279 2076 6572 7920 6c61 7267  ted by very larg
+00002490: 6520 6e65 6761 7469 7665 2076 616c 7565  e negative value
+000024a0: 732e 0a20 2020 2020 2020 2020 2020 2020  s..             
+000024b0: 2020 2060 2863 6f6e 6669 672e 656e 636f     `(config.enco
+000024c0: 6465 725f 6174 7465 6e74 696f 6e5f 6865  der_attention_he
+000024d0: 6164 732c 2960 2e0a 2020 2020 2020 2020  ads,)`..        
+000024e0: 2020 2020 6f75 7470 7574 5f61 7474 656e      output_atten
+000024f0: 7469 6f6e 7320 2860 626f 6f6c 602c 202a  tions (`bool`, *
+00002500: 6f70 7469 6f6e 616c 2a29 3a0a 2020 2020  optional*):.    
+00002510: 2020 2020 2020 2020 2020 2020 5768 6574              Whet
+00002520: 6865 7220 6f72 206e 6f74 2074 6f20 7265  her or not to re
+00002530: 7475 726e 2074 6865 2061 7474 656e 7469  turn the attenti
+00002540: 6f6e 7320 7465 6e73 6f72 7320 6f66 2061  ons tensors of a
+00002550: 6c6c 2061 7474 656e 7469 6f6e 206c 6179  ll attention lay
+00002560: 6572 732e 2053 6565 2060 6174 7465 6e74  ers. See `attent
+00002570: 696f 6e73 6020 756e 6465 720a 2020 2020  ions` under.    
+00002580: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00002590: 726e 6564 2074 656e 736f 7273 2066 6f72  rned tensors for
+000025a0: 206d 6f72 6520 6465 7461 696c 2e0a 2020   more detail..  
+000025b0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+000025c0: 2020 7265 7369 6475 616c 203d 2068 6964    residual = hid
+000025d0: 6465 6e5f 7374 6174 6573 0a0a 2020 2020  den_states..    
+000025e0: 2020 2020 6869 6464 656e 5f73 7461 7465      hidden_state
+000025f0: 7320 3d20 7365 6c66 2e6c 6179 6572 5f6e  s = self.layer_n
+00002600: 6f72 6d31 2868 6964 6465 6e5f 7374 6174  orm1(hidden_stat
+00002610: 6573 290a 2020 2020 2020 2020 6869 6464  es).        hidd
+00002620: 656e 5f73 7461 7465 732c 2061 7474 6e5f  en_states, attn_
+00002630: 7765 6967 6874 7320 3d20 7365 6c66 2e73  weights = self.s
+00002640: 656c 665f 6174 746e 280a 2020 2020 2020  elf_attn(.      
+00002650: 2020 2020 2020 6869 6464 656e 5f73 7461        hidden_sta
+00002660: 7465 733d 6869 6464 656e 5f73 7461 7465  tes=hidden_state
+00002670: 732c 0a20 2020 2020 2020 2020 2020 2068  s,.            h
+00002680: 6561 645f 6d61 736b 3d61 7474 656e 7469  ead_mask=attenti
+00002690: 6f6e 5f6d 6173 6b2c 0a20 2020 2020 2020  on_mask,.       
+000026a0: 2020 2020 206f 7574 7075 745f 6174 7465       output_atte
+000026b0: 6e74 696f 6e73 3d6f 7574 7075 745f 6174  ntions=output_at
+000026c0: 7465 6e74 696f 6e73 2c0a 2020 2020 2020  tentions,.      
+000026d0: 2020 290a 0a20 2020 2020 2020 2068 6964    )..        hid
+000026e0: 6465 6e5f 7374 6174 6573 203d 2068 6964  den_states = hid
+000026f0: 6465 6e5f 7374 6174 6573 202b 2072 6573  den_states + res
+00002700: 6964 7561 6c0a 2020 2020 2020 2020 7265  idual.        re
+00002710: 7369 6475 616c 203d 2068 6964 6465 6e5f  sidual = hidden_
+00002720: 7374 6174 6573 0a20 2020 2020 2020 2068  states.        h
+00002730: 6964 6465 6e5f 7374 6174 6573 203d 2073  idden_states = s
+00002740: 656c 662e 6c61 7965 725f 6e6f 726d 3228  elf.layer_norm2(
+00002750: 6869 6464 656e 5f73 7461 7465 7329 0a20  hidden_states). 
+00002760: 2020 2020 2020 2068 6964 6465 6e5f 7374         hidden_st
+00002770: 6174 6573 203d 2073 656c 662e 6d6c 7028  ates = self.mlp(
+00002780: 6869 6464 656e 5f73 7461 7465 7329 0a0a  hidden_states)..
+00002790: 2020 2020 2020 2020 6869 6464 656e 5f73          hidden_s
+000027a0: 7461 7465 7320 3d20 6869 6464 656e 5f73  tates = hidden_s
+000027b0: 7461 7465 7320 2b20 7265 7369 6475 616c  tates + residual
+000027c0: 0a20 2020 2020 2020 206f 7574 7075 7473  .        outputs
+000027d0: 203d 2028 6869 6464 656e 5f73 7461 7465   = (hidden_state
+000027e0: 732c 290a 0a20 2020 2020 2020 2069 6620  s,)..        if 
+000027f0: 6f75 7470 7574 5f61 7474 656e 7469 6f6e  output_attention
+00002800: 733a 0a20 2020 2020 2020 2020 2020 206f  s:.            o
+00002810: 7574 7075 7473 202b 3d20 2861 7474 6e5f  utputs += (attn_
+00002820: 7765 6967 6874 732c 290a 0a20 2020 2020  weights,)..     
+00002830: 2020 2072 6574 7572 6e20 6f75 7470 7574     return output
+00002840: 730a 0a0a 636c 6173 7320 426c 6970 3250  s...class Blip2P
+00002850: 7265 5472 6169 6e65 644d 6f64 656c 2850  reTrainedModel(P
+00002860: 7265 5472 6169 6e65 644d 6f64 656c 293a  reTrainedModel):
+00002870: 0a20 2020 2022 2222 0a20 2020 2041 6e20  .    """.    An 
+00002880: 6162 7374 7261 6374 2063 6c61 7373 2074  abstract class t
+00002890: 6f20 6861 6e64 6c65 2077 6569 6768 7473  o handle weights
+000028a0: 2069 6e69 7469 616c 697a 6174 696f 6e20   initialization 
+000028b0: 616e 6420 6120 7369 6d70 6c65 2069 6e74  and a simple int
+000028c0: 6572 6661 6365 2066 6f72 2064 6f77 6e6c  erface for downl
+000028d0: 6f61 6469 6e67 2061 6e64 206c 6f61 6469  oading and loadi
+000028e0: 6e67 2070 7265 7472 6169 6e65 640a 2020  ng pretrained.  
+000028f0: 2020 6d6f 6465 6c73 2e0a 2020 2020 2222    models..    ""
+00002900: 220a 0a20 2020 2063 6f6e 6669 675f 636c  "..    config_cl
+00002910: 6173 7320 3d20 426c 6970 3243 6f6e 6669  ass = Blip2Confi
+00002920: 670a 2020 2020 6261 7365 5f6d 6f64 656c  g.    base_model
+00002930: 5f70 7265 6669 7820 3d20 2262 6c69 7022  _prefix = "blip"
+00002940: 0a20 2020 2073 7570 706f 7274 735f 6772  .    supports_gr
+00002950: 6164 6965 6e74 5f63 6865 636b 706f 696e  adient_checkpoin
+00002960: 7469 6e67 203d 2054 7275 650a 2020 2020  ting = True.    
+00002970: 5f6e 6f5f 7370 6c69 745f 6d6f 6475 6c65  _no_split_module
+00002980: 7320 3d20 5b22 426c 6970 3241 7474 656e  s = ["Blip2Atten
+00002990: 7469 6f6e 222c 2022 5435 426c 6f63 6b22  tion", "T5Block"
+000029a0: 2c20 224f 5054 4465 636f 6465 724c 6179  , "OPTDecoderLay
+000029b0: 6572 225d 0a20 2020 205f 736b 6970 5f6b  er"].    _skip_k
+000029c0: 6579 735f 6465 7669 6365 5f70 6c61 6365  eys_device_place
+000029d0: 6d65 6e74 203d 2022 7061 7374 5f6b 6579  ment = "past_key
+000029e0: 5f76 616c 7565 7322 0a20 2020 205f 6b65  _values".    _ke
+000029f0: 6570 5f69 6e5f 6670 3332 5f6d 6f64 756c  ep_in_fp32_modul
+00002a00: 6573 203d 205b 2277 6f22 5d0a 0a20 2020  es = ["wo"]..   
+00002a10: 2064 6566 205f 696e 6974 5f77 6569 6768   def _init_weigh
+00002a20: 7473 2873 656c 662c 2063 656c 6c29 3a0a  ts(self, cell):.
+00002a30: 2020 2020 2020 2020 2222 2249 6e69 7469          """Initi
+00002a40: 616c 697a 6520 7468 6520 7765 6967 6874  alize the weight
+00002a50: 7322 2222 0a20 2020 2020 2020 2066 6163  s""".        fac
+00002a60: 746f 7220 3d20 7365 6c66 2e63 6f6e 6669  tor = self.confi
+00002a70: 672e 696e 6974 6961 6c69 7a65 725f 7261  g.initializer_ra
+00002a80: 6e67 650a 2020 2020 2020 2020 6966 2069  nge.        if i
+00002a90: 7369 6e73 7461 6e63 6528 6365 6c6c 2c20  sinstance(cell, 
+00002aa0: 286e 6e2e 436f 6e76 3264 2c20 6e6e 2e44  (nn.Conv2d, nn.D
+00002ab0: 656e 7365 2c20 6e6e 2e45 6d62 6564 6469  ense, nn.Embeddi
+00002ac0: 6e67 2929 3a0a 2020 2020 2020 2020 2020  ng)):.          
+00002ad0: 2020 6365 6c6c 2e77 6569 6768 742e 7365    cell.weight.se
+00002ae0: 745f 6461 7461 2869 6e69 7469 616c 697a  t_data(initializ
+00002af0: 6572 284e 6f72 6d61 6c28 6661 6374 6f72  er(Normal(factor
+00002b00: 292c 2063 656c 6c2e 7765 6967 6874 2e73  ), cell.weight.s
+00002b10: 6861 7065 2c20 6365 6c6c 2e77 6569 6768  hape, cell.weigh
+00002b20: 742e 6474 7970 6529 290a 2020 2020 2020  t.dtype)).      
+00002b30: 2020 2020 2020 6966 2068 6173 6174 7472        if hasattr
+00002b40: 2863 656c 6c2c 2022 6269 6173 2229 2061  (cell, "bias") a
+00002b50: 6e64 2063 656c 6c2e 6269 6173 2069 7320  nd cell.bias is 
+00002b60: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+00002b70: 2020 2020 2020 2020 2020 6365 6c6c 2e62            cell.b
+00002b80: 6961 732e 7365 745f 6461 7461 2869 6e69  ias.set_data(ini
+00002b90: 7469 616c 697a 6572 2827 7a65 726f 7327  tializer('zeros'
+00002ba0: 2c20 6365 6c6c 2e62 6961 732e 7368 6170  , cell.bias.shap
+00002bb0: 652c 2063 656c 6c2e 6269 6173 2e64 7479  e, cell.bias.dty
+00002bc0: 7065 2929 0a0a 2020 2020 2020 2020 6966  pe))..        if
+00002bd0: 2069 7369 6e73 7461 6e63 6528 6365 6c6c   isinstance(cell
+00002be0: 2c20 426c 6970 3256 6973 696f 6e45 6d62  , Blip2VisionEmb
+00002bf0: 6564 6469 6e67 7329 3a0a 2020 2020 2020  eddings):.      
+00002c00: 2020 2020 2020 6966 2068 6173 6174 7472        if hasattr
+00002c10: 2873 656c 662e 636f 6e66 6967 2c20 2276  (self.config, "v
+00002c20: 6973 696f 6e5f 636f 6e66 6967 2229 3a0a  ision_config"):.
+00002c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002c40: 6661 6374 6f72 203d 2073 656c 662e 636f  factor = self.co
+00002c50: 6e66 6967 2e76 6973 696f 6e5f 636f 6e66  nfig.vision_conf
+00002c60: 6967 2e69 6e69 7469 616c 697a 6572 5f72  ig.initializer_r
+00002c70: 616e 6765 0a0a 2020 2020 2020 2020 2020  ange..          
+00002c80: 2020 6365 6c6c 2e70 6f73 6974 696f 6e5f    cell.position_
+00002c90: 656d 6265 6464 696e 672e 7365 745f 6461  embedding.set_da
+00002ca0: 7461 2869 6e69 7469 616c 697a 6572 2854  ta(initializer(T
+00002cb0: 7275 6e63 6174 6564 4e6f 726d 616c 2866  runcatedNormal(f
+00002cc0: 6163 746f 7229 2c20 6365 6c6c 2e70 6f73  actor), cell.pos
+00002cd0: 6974 696f 6e5f 656d 6265 6464 696e 672e  ition_embedding.
+00002ce0: 7368 6170 652c 2063 656c 6c2e 706f 7369  shape, cell.posi
+00002cf0: 7469 6f6e 5f65 6d62 6564 6469 6e67 2e64  tion_embedding.d
+00002d00: 7479 7065 2929 0a20 2020 2020 2020 2020  type)).         
+00002d10: 2020 2063 656c 6c2e 636c 6173 735f 656d     cell.class_em
+00002d20: 6265 6464 696e 672e 7365 745f 6461 7461  bedding.set_data
+00002d30: 2869 6e69 7469 616c 697a 6572 2854 7275  (initializer(Tru
+00002d40: 6e63 6174 6564 4e6f 726d 616c 2866 6163  ncatedNormal(fac
+00002d50: 746f 7229 2c20 6365 6c6c 2e63 6c61 7373  tor), cell.class
+00002d60: 5f65 6d62 6564 6469 6e67 2e73 6861 7065  _embedding.shape
+00002d70: 2c20 6365 6c6c 2e63 6c61 7373 5f65 6d62  , cell.class_emb
+00002d80: 6564 6469 6e67 2e64 7479 7065 2929 0a0a  edding.dtype))..
+00002d90: 2020 2020 2020 2020 656c 6966 2069 7369          elif isi
+00002da0: 6e73 7461 6e63 6528 6365 6c6c 2c20 6e6e  nstance(cell, nn
+00002db0: 2e4c 6179 6572 4e6f 726d 293a 0a20 2020  .LayerNorm):.   
+00002dc0: 2020 2020 2020 2020 2063 656c 6c2e 7765           cell.we
+00002dd0: 6967 6874 2e73 6574 5f64 6174 6128 696e  ight.set_data(in
+00002de0: 6974 6961 6c69 7a65 7228 276f 6e65 7327  itializer('ones'
+00002df0: 2c20 6365 6c6c 2e77 6569 6768 742e 7368  , cell.weight.sh
+00002e00: 6170 652c 2063 656c 6c2e 7765 6967 6874  ape, cell.weight
+00002e10: 2e64 7479 7065 2929 0a20 2020 2020 2020  .dtype)).       
+00002e20: 2020 2020 2063 656c 6c2e 6269 6173 2e73       cell.bias.s
+00002e30: 6574 5f64 6174 6128 696e 6974 6961 6c69  et_data(initiali
+00002e40: 7a65 7228 277a 6572 6f73 272c 2063 656c  zer('zeros', cel
+00002e50: 6c2e 6269 6173 2e73 6861 7065 2c20 6365  l.bias.shape, ce
+00002e60: 6c6c 2e62 6961 732e 6474 7970 6529 290a  ll.bias.dtype)).
+00002e70: 0a20 2020 2020 2020 2065 6c69 6620 6973  .        elif is
+00002e80: 696e 7374 616e 6365 2863 656c 6c2c 206e  instance(cell, n
+00002e90: 6e2e 4465 6e73 6529 2061 6e64 2063 656c  n.Dense) and cel
+00002ea0: 6c2e 6269 6173 2069 7320 6e6f 7420 4e6f  l.bias is not No
+00002eb0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00002ec0: 6365 6c6c 2e62 6961 732e 7365 745f 6461  cell.bias.set_da
+00002ed0: 7461 2869 6e69 7469 616c 697a 6572 2827  ta(initializer('
+00002ee0: 7a65 726f 7327 2c20 6365 6c6c 2e62 6961  zeros', cell.bia
+00002ef0: 732e 7368 6170 652c 2063 656c 6c2e 6269  s.shape, cell.bi
+00002f00: 6173 2e64 7479 7065 2929 0a0a 0a23 2043  as.dtype))...# C
+00002f10: 6f70 6965 6420 6672 6f6d 2074 7261 6e73  opied from trans
+00002f20: 666f 726d 6572 732e 6d6f 6465 6c73 2e62  formers.models.b
+00002f30: 6c69 702e 6d6f 6465 6c69 6e67 5f62 6c69  lip.modeling_bli
+00002f40: 702e 426c 6970 456e 636f 6465 7220 7769  p.BlipEncoder wi
+00002f50: 7468 2042 6c69 702d 3e42 6c69 7032 0a63  th Blip->Blip2.c
+00002f60: 6c61 7373 2042 6c69 7032 456e 636f 6465  lass Blip2Encode
+00002f70: 7228 6e6e 2e43 656c 6c29 3a0a 2020 2020  r(nn.Cell):.    
+00002f80: 2222 220a 2020 2020 5472 616e 7366 6f72  """.    Transfor
+00002f90: 6d65 7220 656e 636f 6465 7220 636f 6e73  mer encoder cons
+00002fa0: 6973 7469 6e67 206f 6620 6063 6f6e 6669  isting of `confi
+00002fb0: 672e 6e75 6d5f 6869 6464 656e 5f6c 6179  g.num_hidden_lay
+00002fc0: 6572 7360 2073 656c 6620 6174 7465 6e74  ers` self attent
+00002fd0: 696f 6e20 6c61 7965 7273 2e20 4561 6368  ion layers. Each
+00002fe0: 206c 6179 6572 2069 7320 610a 2020 2020   layer is a.    
+00002ff0: 5b60 426c 6970 3245 6e63 6f64 6572 4c61  [`Blip2EncoderLa
+00003000: 7965 7260 5d2e 0a0a 2020 2020 4172 6773  yer`]...    Args
+00003010: 3a0a 2020 2020 2020 2020 636f 6e66 6967  :.        config
+00003020: 2028 6042 6c69 7032 436f 6e66 6967 6029   (`Blip2Config`)
+00003030: 3a0a 2020 2020 2020 2020 2020 2020 5468  :.            Th
+00003040: 6520 636f 7272 6573 706f 6e64 696e 6720  e corresponding 
+00003050: 7669 7369 6f6e 2063 6f6e 6669 6775 7261  vision configura
+00003060: 7469 6f6e 2066 6f72 2074 6865 2060 426c  tion for the `Bl
+00003070: 6970 3245 6e63 6f64 6572 602e 0a20 2020  ip2Encoder`..   
+00003080: 2022 2222 0a0a 2020 2020 6465 6620 5f5f   """..    def __
+00003090: 696e 6974 5f5f 2873 656c 662c 2063 6f6e  init__(self, con
+000030a0: 6669 673a 2042 6c69 7032 436f 6e66 6967  fig: Blip2Config
+000030b0: 293a 0a20 2020 2020 2020 2073 7570 6572  ):.        super
+000030c0: 2829 2e5f 5f69 6e69 745f 5f28 290a 2020  ().__init__().  
+000030d0: 2020 2020 2020 7365 6c66 2e63 6f6e 6669        self.confi
+000030e0: 6720 3d20 636f 6e66 6967 0a20 2020 2020  g = config.     
+000030f0: 2020 2073 656c 662e 6c61 7965 7273 203d     self.layers =
+00003100: 206e 6e2e 4365 6c6c 4c69 7374 285b 426c   nn.CellList([Bl
+00003110: 6970 3245 6e63 6f64 6572 4c61 7965 7228  ip2EncoderLayer(
+00003120: 636f 6e66 6967 2920 666f 7220 5f20 696e  config) for _ in
+00003130: 2072 616e 6765 2863 6f6e 6669 672e 6e75   range(config.nu
+00003140: 6d5f 6869 6464 656e 5f6c 6179 6572 7329  m_hidden_layers)
+00003150: 5d29 0a20 2020 2020 2020 2073 656c 662e  ]).        self.
+00003160: 6772 6164 6965 6e74 5f63 6865 636b 706f  gradient_checkpo
+00003170: 696e 7469 6e67 203d 2046 616c 7365 0a0a  inting = False..
+00003180: 2020 2020 6465 6620 636f 6e73 7472 7563      def construc
+00003190: 7428 0a20 2020 2020 2020 2073 656c 662c  t(.        self,
+000031a0: 0a20 2020 2020 2020 2069 6e70 7574 735f  .        inputs_
+000031b0: 656d 6265 6473 2c0a 2020 2020 2020 2020  embeds,.        
+000031c0: 6174 7465 6e74 696f 6e5f 6d61 736b 3a20  attention_mask: 
+000031d0: 4f70 7469 6f6e 616c 5b6d 696e 6473 706f  Optional[mindspo
+000031e0: 7265 2e54 656e 736f 725d 203d 204e 6f6e  re.Tensor] = Non
+000031f0: 652c 0a20 2020 2020 2020 206f 7574 7075  e,.        outpu
+00003200: 745f 6174 7465 6e74 696f 6e73 3a20 4f70  t_attentions: Op
+00003210: 7469 6f6e 616c 5b62 6f6f 6c5d 203d 204e  tional[bool] = N
+00003220: 6f6e 652c 0a20 2020 2020 2020 206f 7574  one,.        out
+00003230: 7075 745f 6869 6464 656e 5f73 7461 7465  put_hidden_state
+00003240: 733a 204f 7074 696f 6e61 6c5b 626f 6f6c  s: Optional[bool
+00003250: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+00003260: 2020 7265 7475 726e 5f64 6963 743a 204f    return_dict: O
+00003270: 7074 696f 6e61 6c5b 626f 6f6c 5d20 3d20  ptional[bool] = 
+00003280: 4e6f 6e65 2c0a 2020 2020 2920 2d3e 2055  None,.    ) -> U
+00003290: 6e69 6f6e 5b54 7570 6c65 2c20 4261 7365  nion[Tuple, Base
+000032a0: 4d6f 6465 6c4f 7574 7075 745d 3a0a 2020  ModelOutput]:.  
+000032b0: 2020 2020 2020 7222 2222 0a20 2020 2020        r""".     
+000032c0: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+000032d0: 2020 2020 2069 6e70 7574 735f 656d 6265       inputs_embe
+000032e0: 6473 2028 606d 696e 6473 706f 7265 2e54  ds (`mindspore.T
+000032f0: 656e 736f 7260 206f 6620 7368 6170 6520  ensor` of shape 
+00003300: 6028 6261 7463 685f 7369 7a65 2c20 7365  `(batch_size, se
+00003310: 7175 656e 6365 5f6c 656e 6774 682c 2068  quence_length, h
+00003320: 6964 6465 6e5f 7369 7a65 2960 293a 0a20  idden_size)`):. 
+00003330: 2020 2020 2020 2020 2020 2020 2020 2045                 E
+00003340: 6d62 6564 6465 6420 7265 7072 6573 656e  mbedded represen
+00003350: 7461 7469 6f6e 206f 6620 7468 6520 696e  tation of the in
+00003360: 7075 7473 2e20 5368 6f75 6c64 2062 6520  puts. Should be 
+00003370: 666c 6f61 742c 206e 6f74 2069 6e74 2074  float, not int t
+00003380: 6f6b 656e 732e 0a20 2020 2020 2020 2020  okens..         
+00003390: 2020 2061 7474 656e 7469 6f6e 5f6d 6173     attention_mas
+000033a0: 6b20 2860 6d69 6e64 7370 6f72 652e 5465  k (`mindspore.Te
+000033b0: 6e73 6f72 6020 6f66 2073 6861 7065 2060  nsor` of shape `
+000033c0: 2862 6174 6368 5f73 697a 652c 2073 6571  (batch_size, seq
+000033d0: 7565 6e63 655f 6c65 6e67 7468 2960 2c20  uence_length)`, 
+000033e0: 2a6f 7074 696f 6e61 6c2a 293a 0a20 2020  *optional*):.   
+000033f0: 2020 2020 2020 2020 2020 2020 204d 6173               Mas
+00003400: 6b20 746f 2061 766f 6964 2070 6572 666f  k to avoid perfo
+00003410: 726d 696e 6720 6174 7465 6e74 696f 6e20  rming attention 
+00003420: 6f6e 2070 6164 6469 6e67 2074 6f6b 656e  on padding token
+00003430: 2069 6e64 6963 6573 2e20 4d61 736b 2076   indices. Mask v
+00003440: 616c 7565 7320 7365 6c65 6374 6564 2069  alues selected i
+00003450: 6e20 605b 302c 2031 5d60 3a0a 0a20 2020  n `[0, 1]`:..   
+00003460: 2020 2020 2020 2020 2020 2020 202d 2031               - 1
+00003470: 2066 6f72 2074 6f6b 656e 7320 7468 6174   for tokens that
+00003480: 2061 7265 202a 2a6e 6f74 206d 6173 6b65   are **not maske
+00003490: 642a 2a2c 0a20 2020 2020 2020 2020 2020  d**,.           
+000034a0: 2020 2020 202d 2030 2066 6f72 2074 6f6b       - 0 for tok
+000034b0: 656e 7320 7468 6174 2061 7265 202a 2a6d  ens that are **m
+000034c0: 6173 6b65 642a 2a2e 0a0a 2020 2020 2020  asked**...      
+000034d0: 2020 2020 2020 2020 2020 5b57 6861 7420            [What 
+000034e0: 6172 6520 6174 7465 6e74 696f 6e20 6d61  are attention ma
+000034f0: 736b 733f 5d28 2e2e 2f67 6c6f 7373 6172  sks?](../glossar
+00003500: 7923 6174 7465 6e74 696f 6e2d 6d61 736b  y#attention-mask
+00003510: 290a 2020 2020 2020 2020 2020 2020 6f75  ).            ou
+00003520: 7470 7574 5f61 7474 656e 7469 6f6e 7320  tput_attentions 
+00003530: 2860 626f 6f6c 602c 202a 6f70 7469 6f6e  (`bool`, *option
+00003540: 616c 2a29 3a0a 2020 2020 2020 2020 2020  al*):.          
+00003550: 2020 2020 2020 5768 6574 6865 7220 6f72        Whether or
+00003560: 206e 6f74 2074 6f20 7265 7475 726e 2074   not to return t
+00003570: 6865 2061 7474 656e 7469 6f6e 7320 7465  he attentions te
+00003580: 6e73 6f72 7320 6f66 2061 6c6c 2061 7474  nsors of all att
+00003590: 656e 7469 6f6e 206c 6179 6572 732e 2053  ention layers. S
+000035a0: 6565 2060 6174 7465 6e74 696f 6e73 6020  ee `attentions` 
+000035b0: 756e 6465 720a 2020 2020 2020 2020 2020  under.          
+000035c0: 2020 2020 2020 7265 7475 726e 6564 2074        returned t
+000035d0: 656e 736f 7273 2066 6f72 206d 6f72 6520  ensors for more 
+000035e0: 6465 7461 696c 2e0a 2020 2020 2020 2020  detail..        
+000035f0: 2020 2020 6f75 7470 7574 5f68 6964 6465      output_hidde
+00003600: 6e5f 7374 6174 6573 2028 6062 6f6f 6c60  n_states (`bool`
+00003610: 2c20 2a6f 7074 696f 6e61 6c2a 293a 0a20  , *optional*):. 
+00003620: 2020 2020 2020 2020 2020 2020 2020 2057                 W
+00003630: 6865 7468 6572 206f 7220 6e6f 7420 746f  hether or not to
+00003640: 2072 6574 7572 6e20 7468 6520 6869 6464   return the hidd
+00003650: 656e 2073 7461 7465 7320 6f66 2061 6c6c  en states of all
+00003660: 206c 6179 6572 732e 2053 6565 2060 6869   layers. See `hi
+00003670: 6464 656e 5f73 7461 7465 7360 2075 6e64  dden_states` und
+00003680: 6572 2072 6574 7572 6e65 6420 7465 6e73  er returned tens
+00003690: 6f72 730a 2020 2020 2020 2020 2020 2020  ors.            
+000036a0: 2020 2020 666f 7220 6d6f 7265 2064 6574      for more det
+000036b0: 6169 6c2e 0a20 2020 2020 2020 2020 2020  ail..           
+000036c0: 2072 6574 7572 6e5f 6469 6374 2028 6062   return_dict (`b
+000036d0: 6f6f 6c60 2c20 2a6f 7074 696f 6e61 6c2a  ool`, *optional*
+000036e0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000036f0: 2020 2057 6865 7468 6572 206f 7220 6e6f     Whether or no
+00003700: 7420 746f 2072 6574 7572 6e20 6120 5b60  t to return a [`
+00003710: 7e75 7469 6c73 2e4d 6f64 656c 4f75 7470  ~utils.ModelOutp
+00003720: 7574 605d 2069 6e73 7465 6164 206f 6620  ut`] instead of 
+00003730: 6120 706c 6169 6e20 7475 706c 652e 0a20  a plain tuple.. 
+00003740: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00003750: 2020 206f 7574 7075 745f 6174 7465 6e74     output_attent
+00003760: 696f 6e73 203d 206f 7574 7075 745f 6174  ions = output_at
+00003770: 7465 6e74 696f 6e73 2069 6620 6f75 7470  tentions if outp
+00003780: 7574 5f61 7474 656e 7469 6f6e 7320 6973  ut_attentions is
+00003790: 206e 6f74 204e 6f6e 6520 656c 7365 2073   not None else s
+000037a0: 656c 662e 636f 6e66 6967 2e6f 7574 7075  elf.config.outpu
+000037b0: 745f 6174 7465 6e74 696f 6e73 0a20 2020  t_attentions.   
+000037c0: 2020 2020 206f 7574 7075 745f 6869 6464       output_hidd
+000037d0: 656e 5f73 7461 7465 7320 3d20 280a 2020  en_states = (.  
+000037e0: 2020 2020 2020 2020 2020 6f75 7470 7574            output
+000037f0: 5f68 6964 6465 6e5f 7374 6174 6573 2069  _hidden_states i
+00003800: 6620 6f75 7470 7574 5f68 6964 6465 6e5f  f output_hidden_
+00003810: 7374 6174 6573 2069 7320 6e6f 7420 4e6f  states is not No
+00003820: 6e65 2065 6c73 6520 7365 6c66 2e63 6f6e  ne else self.con
+00003830: 6669 672e 6f75 7470 7574 5f68 6964 6465  fig.output_hidde
+00003840: 6e5f 7374 6174 6573 0a20 2020 2020 2020  n_states.       
+00003850: 2029 0a20 2020 2020 2020 2072 6574 7572   ).        retur
+00003860: 6e5f 6469 6374 203d 2072 6574 7572 6e5f  n_dict = return_
+00003870: 6469 6374 2069 6620 7265 7475 726e 5f64  dict if return_d
+00003880: 6963 7420 6973 206e 6f74 204e 6f6e 6520  ict is not None 
+00003890: 656c 7365 2073 656c 662e 636f 6e66 6967  else self.config
+000038a0: 2e75 7365 5f72 6574 7572 6e5f 6469 6374  .use_return_dict
+000038b0: 0a0a 2020 2020 2020 2020 656e 636f 6465  ..        encode
+000038c0: 725f 7374 6174 6573 203d 2028 2920 6966  r_states = () if
+000038d0: 206f 7574 7075 745f 6869 6464 656e 5f73   output_hidden_s
+000038e0: 7461 7465 7320 656c 7365 204e 6f6e 650a  tates else None.
+000038f0: 2020 2020 2020 2020 616c 6c5f 6174 7465          all_atte
+00003900: 6e74 696f 6e73 203d 2028 2920 6966 206f  ntions = () if o
+00003910: 7574 7075 745f 6174 7465 6e74 696f 6e73  utput_attentions
+00003920: 2065 6c73 6520 4e6f 6e65 0a0a 2020 2020   else None..    
+00003930: 2020 2020 6869 6464 656e 5f73 7461 7465      hidden_state
+00003940: 7320 3d20 696e 7075 7473 5f65 6d62 6564  s = inputs_embed
+00003950: 730a 2020 2020 2020 2020 666f 7220 6964  s.        for id
+00003960: 782c 2065 6e63 6f64 6572 5f6c 6179 6572  x, encoder_layer
+00003970: 2069 6e20 656e 756d 6572 6174 6528 7365   in enumerate(se
+00003980: 6c66 2e6c 6179 6572 7329 3a0a 2020 2020  lf.layers):.    
+00003990: 2020 2020 2020 2020 6966 206f 7574 7075          if outpu
+000039a0: 745f 6869 6464 656e 5f73 7461 7465 733a  t_hidden_states:
+000039b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000039c0: 2065 6e63 6f64 6572 5f73 7461 7465 7320   encoder_states 
+000039d0: 3d20 656e 636f 6465 725f 7374 6174 6573  = encoder_states
+000039e0: 202b 2028 6869 6464 656e 5f73 7461 7465   + (hidden_state
+000039f0: 732c 290a 2020 2020 2020 2020 2020 2020  s,).            
+00003a00: 6966 2073 656c 662e 6772 6164 6965 6e74  if self.gradient
+00003a10: 5f63 6865 636b 706f 696e 7469 6e67 2061  _checkpointing a
+00003a20: 6e64 2073 656c 662e 7472 6169 6e69 6e67  nd self.training
+00003a30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00003a40: 2020 6c61 7965 725f 6f75 7470 7574 7320    layer_outputs 
+00003a50: 3d20 7365 6c66 2e5f 6772 6164 6965 6e74  = self._gradient
+00003a60: 5f63 6865 636b 706f 696e 7469 6e67 5f66  _checkpointing_f
+00003a70: 756e 6328 0a20 2020 2020 2020 2020 2020  unc(.           
+00003a80: 2020 2020 2020 2020 2065 6e63 6f64 6572           encoder
+00003a90: 5f6c 6179 6572 2e5f 5f63 616c 6c5f 5f2c  _layer.__call__,
+00003aa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003ab0: 2020 2020 2068 6964 6465 6e5f 7374 6174       hidden_stat
+00003ac0: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+00003ad0: 2020 2020 2020 2020 6174 7465 6e74 696f          attentio
+00003ae0: 6e5f 6d61 736b 2c0a 2020 2020 2020 2020  n_mask,.        
+00003af0: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
+00003b00: 7574 5f61 7474 656e 7469 6f6e 732c 0a20  ut_attentions,. 
+00003b10: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00003b20: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00003b30: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00003b40: 2020 206c 6179 6572 5f6f 7574 7075 7473     layer_outputs
+00003b50: 203d 2065 6e63 6f64 6572 5f6c 6179 6572   = encoder_layer
+00003b60: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00003b70: 2020 2020 2020 6869 6464 656e 5f73 7461        hidden_sta
+00003b80: 7465 732c 0a20 2020 2020 2020 2020 2020  tes,.           
+00003b90: 2020 2020 2020 2020 2061 7474 656e 7469           attenti
+00003ba0: 6f6e 5f6d 6173 6b2c 0a20 2020 2020 2020  on_mask,.       
+00003bb0: 2020 2020 2020 2020 2020 2020 206f 7574               out
+00003bc0: 7075 745f 6174 7465 6e74 696f 6e73 3d6f  put_attentions=o
+00003bd0: 7574 7075 745f 6174 7465 6e74 696f 6e73  utput_attentions
+00003be0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00003bf0: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+00003c00: 2068 6964 6465 6e5f 7374 6174 6573 203d   hidden_states =
+00003c10: 206c 6179 6572 5f6f 7574 7075 7473 5b30   layer_outputs[0
+00003c20: 5d0a 0a20 2020 2020 2020 2020 2020 2069  ]..            i
+00003c30: 6620 6f75 7470 7574 5f61 7474 656e 7469  f output_attenti
+00003c40: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
+00003c50: 2020 2020 2061 6c6c 5f61 7474 656e 7469       all_attenti
+00003c60: 6f6e 7320 3d20 616c 6c5f 6174 7465 6e74  ons = all_attent
+00003c70: 696f 6e73 202b 2028 6c61 7965 725f 6f75  ions + (layer_ou
+00003c80: 7470 7574 735b 315d 2c29 0a0a 2020 2020  tputs[1],)..    
+00003c90: 2020 2020 6966 206f 7574 7075 745f 6869      if output_hi
+00003ca0: 6464 656e 5f73 7461 7465 733a 0a20 2020  dden_states:.   
+00003cb0: 2020 2020 2020 2020 2065 6e63 6f64 6572           encoder
+00003cc0: 5f73 7461 7465 7320 3d20 656e 636f 6465  _states = encode
+00003cd0: 725f 7374 6174 6573 202b 2028 6869 6464  r_states + (hidd
+00003ce0: 656e 5f73 7461 7465 732c 290a 0a20 2020  en_states,)..   
+00003cf0: 2020 2020 2069 6620 6e6f 7420 7265 7475       if not retu
+00003d00: 726e 5f64 6963 743a 0a20 2020 2020 2020  rn_dict:.       
+00003d10: 2020 2020 2072 6574 7572 6e20 7475 706c       return tupl
+00003d20: 6528 7620 666f 7220 7620 696e 205b 6869  e(v for v in [hi
+00003d30: 6464 656e 5f73 7461 7465 732c 2065 6e63  dden_states, enc
+00003d40: 6f64 6572 5f73 7461 7465 732c 2061 6c6c  oder_states, all
+00003d50: 5f61 7474 656e 7469 6f6e 735d 2069 6620  _attentions] if 
+00003d60: 7620 6973 206e 6f74 204e 6f6e 6529 0a20  v is not None). 
+00003d70: 2020 2020 2020 2072 6574 7572 6e20 4261         return Ba
+00003d80: 7365 4d6f 6465 6c4f 7574 7075 7428 0a20  seModelOutput(. 
+00003d90: 2020 2020 2020 2020 2020 206c 6173 745f             last_
+00003da0: 6869 6464 656e 5f73 7461 7465 3d68 6964  hidden_state=hid
+00003db0: 6465 6e5f 7374 6174 6573 2c20 6869 6464  den_states, hidd
+00003dc0: 656e 5f73 7461 7465 733d 656e 636f 6465  en_states=encode
+00003dd0: 725f 7374 6174 6573 2c20 6174 7465 6e74  r_states, attent
+00003de0: 696f 6e73 3d61 6c6c 5f61 7474 656e 7469  ions=all_attenti
+00003df0: 6f6e 730a 2020 2020 2020 2020 290a 0a0a  ons.        )...
+00003e00: 2320 436f 7069 6564 2066 726f 6d20 7472  # Copied from tr
+00003e10: 616e 7366 6f72 6d65 7273 2e6d 6f64 656c  ansformers.model
+00003e20: 732e 626c 6970 2e6d 6f64 656c 696e 675f  s.blip.modeling_
+00003e30: 626c 6970 2e42 6c69 7056 6973 696f 6e4d  blip.BlipVisionM
+00003e40: 6f64 656c 2077 6974 6820 426c 6970 2d3e  odel with Blip->
+00003e50: 426c 6970 322c 2042 4c49 502d 3e42 4c49  Blip2, BLIP->BLI
+00003e60: 505f 320a 636c 6173 7320 426c 6970 3256  P_2.class Blip2V
+00003e70: 6973 696f 6e4d 6f64 656c 2842 6c69 7032  isionModel(Blip2
+00003e80: 5072 6554 7261 696e 6564 4d6f 6465 6c29  PreTrainedModel)
+00003e90: 3a0a 2020 2020 6d61 696e 5f69 6e70 7574  :.    main_input
+00003ea0: 5f6e 616d 6520 3d20 2270 6978 656c 5f76  _name = "pixel_v
+00003eb0: 616c 7565 7322 0a20 2020 2063 6f6e 6669  alues".    confi
+00003ec0: 675f 636c 6173 7320 3d20 426c 6970 3256  g_class = Blip2V
+00003ed0: 6973 696f 6e43 6f6e 6669 670a 0a20 2020  isionConfig..   
+00003ee0: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
+00003ef0: 6c66 2c20 636f 6e66 6967 3a20 426c 6970  lf, config: Blip
+00003f00: 3256 6973 696f 6e43 6f6e 6669 6729 3a0a  2VisionConfig):.
+00003f10: 2020 2020 2020 2020 7375 7065 7228 292e          super().
+00003f20: 5f5f 696e 6974 5f5f 2863 6f6e 6669 6729  __init__(config)
+00003f30: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
+00003f40: 6e66 6967 203d 2063 6f6e 6669 670a 2020  nfig = config.  
+00003f50: 2020 2020 2020 656d 6265 645f 6469 6d20        embed_dim 
+00003f60: 3d20 636f 6e66 6967 2e68 6964 6465 6e5f  = config.hidden_
+00003f70: 7369 7a65 0a0a 2020 2020 2020 2020 7365  size..        se
+00003f80: 6c66 2e65 6d62 6564 6469 6e67 7320 3d20  lf.embeddings = 
+00003f90: 426c 6970 3256 6973 696f 6e45 6d62 6564  Blip2VisionEmbed
+00003fa0: 6469 6e67 7328 636f 6e66 6967 290a 2020  dings(config).  
+00003fb0: 2020 2020 2020 7365 6c66 2e65 6e63 6f64        self.encod
+00003fc0: 6572 203d 2042 6c69 7032 456e 636f 6465  er = Blip2Encode
+00003fd0: 7228 636f 6e66 6967 290a 2020 2020 2020  r(config).      
+00003fe0: 2020 7365 6c66 2e70 6f73 745f 6c61 7965    self.post_laye
+00003ff0: 726e 6f72 6d20 3d20 6e6e 2e4c 6179 6572  rnorm = nn.Layer
+00004000: 4e6f 726d 2865 6d62 6564 5f64 696d 2c20  Norm(embed_dim, 
+00004010: 6570 7369 6c6f 6e3d 636f 6e66 6967 2e6c  epsilon=config.l
+00004020: 6179 6572 5f6e 6f72 6d5f 6570 7329 0a0a  ayer_norm_eps)..
+00004030: 2020 2020 2020 2020 7365 6c66 2e70 6f73          self.pos
+00004040: 745f 696e 6974 2829 0a0a 2020 2020 6465  t_init()..    de
+00004050: 6620 636f 6e73 7472 7563 7428 0a20 2020  f construct(.   
+00004060: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+00004070: 2020 2070 6978 656c 5f76 616c 7565 733a     pixel_values:
+00004080: 204f 7074 696f 6e61 6c5b 6d69 6e64 7370   Optional[mindsp
+00004090: 6f72 652e 5465 6e73 6f72 5d20 3d20 4e6f  ore.Tensor] = No
+000040a0: 6e65 2c0a 2020 2020 2020 2020 6f75 7470  ne,.        outp
+000040b0: 7574 5f61 7474 656e 7469 6f6e 733a 204f  ut_attentions: O
+000040c0: 7074 696f 6e61 6c5b 626f 6f6c 5d20 3d20  ptional[bool] = 
+000040d0: 4e6f 6e65 2c0a 2020 2020 2020 2020 6f75  None,.        ou
+000040e0: 7470 7574 5f68 6964 6465 6e5f 7374 6174  tput_hidden_stat
+000040f0: 6573 3a20 4f70 7469 6f6e 616c 5b62 6f6f  es: Optional[boo
+00004100: 6c5d 203d 204e 6f6e 652c 0a20 2020 2020  l] = None,.     
+00004110: 2020 2072 6574 7572 6e5f 6469 6374 3a20     return_dict: 
+00004120: 4f70 7469 6f6e 616c 5b62 6f6f 6c5d 203d  Optional[bool] =
+00004130: 204e 6f6e 652c 0a20 2020 2029 202d 3e20   None,.    ) -> 
+00004140: 556e 696f 6e5b 5475 706c 652c 2042 6173  Union[Tuple, Bas
+00004150: 654d 6f64 656c 4f75 7470 7574 5769 7468  eModelOutputWith
+00004160: 506f 6f6c 696e 675d 3a0a 2020 2020 2020  Pooling]:.      
+00004170: 2020 7222 2222 0a20 2020 2020 2020 2052    r""".        R
+00004180: 6574 7572 6e73 3a0a 0a20 2020 2020 2020  eturns:..       
+00004190: 2022 2222 0a20 2020 2020 2020 206f 7574   """.        out
+000041a0: 7075 745f 6174 7465 6e74 696f 6e73 203d  put_attentions =
+000041b0: 206f 7574 7075 745f 6174 7465 6e74 696f   output_attentio
+000041c0: 6e73 2069 6620 6f75 7470 7574 5f61 7474  ns if output_att
+000041d0: 656e 7469 6f6e 7320 6973 206e 6f74 204e  entions is not N
+000041e0: 6f6e 6520 656c 7365 2073 656c 662e 636f  one else self.co
+000041f0: 6e66 6967 2e6f 7574 7075 745f 6174 7465  nfig.output_atte
+00004200: 6e74 696f 6e73 0a20 2020 2020 2020 206f  ntions.        o
+00004210: 7574 7075 745f 6869 6464 656e 5f73 7461  utput_hidden_sta
+00004220: 7465 7320 3d20 280a 2020 2020 2020 2020  tes = (.        
+00004230: 2020 2020 6f75 7470 7574 5f68 6964 6465      output_hidde
+00004240: 6e5f 7374 6174 6573 2069 6620 6f75 7470  n_states if outp
+00004250: 7574 5f68 6964 6465 6e5f 7374 6174 6573  ut_hidden_states
+00004260: 2069 7320 6e6f 7420 4e6f 6e65 2065 6c73   is not None els
+00004270: 6520 7365 6c66 2e63 6f6e 6669 672e 6f75  e self.config.ou
+00004280: 7470 7574 5f68 6964 6465 6e5f 7374 6174  tput_hidden_stat
+00004290: 6573 0a20 2020 2020 2020 2029 0a20 2020  es.        ).   
+000042a0: 2020 2020 2072 6574 7572 6e5f 6469 6374       return_dict
+000042b0: 203d 2072 6574 7572 6e5f 6469 6374 2069   = return_dict i
+000042c0: 6620 7265 7475 726e 5f64 6963 7420 6973  f return_dict is
+000042d0: 206e 6f74 204e 6f6e 6520 656c 7365 2073   not None else s
+000042e0: 656c 662e 636f 6e66 6967 2e75 7365 5f72  elf.config.use_r
+000042f0: 6574 7572 6e5f 6469 6374 0a0a 2020 2020  eturn_dict..    
+00004300: 2020 2020 6966 2070 6978 656c 5f76 616c      if pixel_val
+00004310: 7565 7320 6973 204e 6f6e 653a 0a20 2020  ues is None:.   
+00004320: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+00004330: 616c 7565 4572 726f 7228 2259 6f75 2068  alueError("You h
+00004340: 6176 6520 746f 2073 7065 6369 6679 2070  ave to specify p
+00004350: 6978 656c 5f76 616c 7565 7322 290a 0a20  ixel_values").. 
+00004360: 2020 2020 2020 2068 6964 6465 6e5f 7374         hidden_st
+00004370: 6174 6573 203d 2073 656c 662e 656d 6265  ates = self.embe
+00004380: 6464 696e 6773 2870 6978 656c 5f76 616c  ddings(pixel_val
+00004390: 7565 7329 0a0a 2020 2020 2020 2020 656e  ues)..        en
+000043a0: 636f 6465 725f 6f75 7470 7574 7320 3d20  coder_outputs = 
+000043b0: 7365 6c66 2e65 6e63 6f64 6572 280a 2020  self.encoder(.  
+000043c0: 2020 2020 2020 2020 2020 696e 7075 7473            inputs
+000043d0: 5f65 6d62 6564 733d 6869 6464 656e 5f73  _embeds=hidden_s
+000043e0: 7461 7465 732c 0a20 2020 2020 2020 2020  tates,.         
+000043f0: 2020 206f 7574 7075 745f 6174 7465 6e74     output_attent
+00004400: 696f 6e73 3d6f 7574 7075 745f 6174 7465  ions=output_atte
+00004410: 6e74 696f 6e73 2c0a 2020 2020 2020 2020  ntions,.        
+00004420: 2020 2020 6f75 7470 7574 5f68 6964 6465      output_hidde
+00004430: 6e5f 7374 6174 6573 3d6f 7574 7075 745f  n_states=output_
+00004440: 6869 6464 656e 5f73 7461 7465 732c 0a20  hidden_states,. 
+00004450: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00004460: 6e5f 6469 6374 3d72 6574 7572 6e5f 6469  n_dict=return_di
+00004470: 6374 2c0a 2020 2020 2020 2020 290a 0a20  ct,.        ).. 
+00004480: 2020 2020 2020 206c 6173 745f 6869 6464         last_hidd
+00004490: 656e 5f73 7461 7465 203d 2065 6e63 6f64  en_state = encod
+000044a0: 6572 5f6f 7574 7075 7473 5b30 5d0a 2020  er_outputs[0].  
+000044b0: 2020 2020 2020 6c61 7374 5f68 6964 6465        last_hidde
+000044c0: 6e5f 7374 6174 6520 3d20 7365 6c66 2e70  n_state = self.p
+000044d0: 6f73 745f 6c61 7965 726e 6f72 6d28 6c61  ost_layernorm(la
+000044e0: 7374 5f68 6964 6465 6e5f 7374 6174 6529  st_hidden_state)
+000044f0: 0a0a 2020 2020 2020 2020 706f 6f6c 6564  ..        pooled
+00004500: 5f6f 7574 7075 7420 3d20 6c61 7374 5f68  _output = last_h
+00004510: 6964 6465 6e5f 7374 6174 655b 3a2c 2030  idden_state[:, 0
+00004520: 2c20 3a5d 0a20 2020 2020 2020 2070 6f6f  , :].        poo
+00004530: 6c65 645f 6f75 7470 7574 203d 2073 656c  led_output = sel
+00004540: 662e 706f 7374 5f6c 6179 6572 6e6f 726d  f.post_layernorm
+00004550: 2870 6f6f 6c65 645f 6f75 7470 7574 290a  (pooled_output).
+00004560: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+00004570: 7265 7475 726e 5f64 6963 743a 0a20 2020  return_dict:.   
+00004580: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00004590: 286c 6173 745f 6869 6464 656e 5f73 7461  (last_hidden_sta
+000045a0: 7465 2c20 706f 6f6c 6564 5f6f 7574 7075  te, pooled_outpu
+000045b0: 7429 202b 2065 6e63 6f64 6572 5f6f 7574  t) + encoder_out
+000045c0: 7075 7473 5b31 3a5d 0a0a 2020 2020 2020  puts[1:]..      
+000045d0: 2020 7265 7475 726e 2042 6173 654d 6f64    return BaseMod
+000045e0: 656c 4f75 7470 7574 5769 7468 506f 6f6c  elOutputWithPool
+000045f0: 696e 6728 0a20 2020 2020 2020 2020 2020  ing(.           
+00004600: 206c 6173 745f 6869 6464 656e 5f73 7461   last_hidden_sta
+00004610: 7465 3d6c 6173 745f 6869 6464 656e 5f73  te=last_hidden_s
+00004620: 7461 7465 2c0a 2020 2020 2020 2020 2020  tate,.          
+00004630: 2020 706f 6f6c 6572 5f6f 7574 7075 743d    pooler_output=
+00004640: 706f 6f6c 6564 5f6f 7574 7075 742c 0a20  pooled_output,. 
+00004650: 2020 2020 2020 2020 2020 2068 6964 6465             hidde
+00004660: 6e5f 7374 6174 6573 3d65 6e63 6f64 6572  n_states=encoder
+00004670: 5f6f 7574 7075 7473 2e68 6964 6465 6e5f  _outputs.hidden_
+00004680: 7374 6174 6573 2c0a 2020 2020 2020 2020  states,.        
+00004690: 2020 2020 6174 7465 6e74 696f 6e73 3d65      attentions=e
+000046a0: 6e63 6f64 6572 5f6f 7574 7075 7473 2e61  ncoder_outputs.a
+000046b0: 7474 656e 7469 6f6e 732c 0a20 2020 2020  ttentions,.     
+000046c0: 2020 2029 0a0a 2020 2020 6465 6620 6765     )..    def ge
+000046d0: 745f 696e 7075 745f 656d 6265 6464 696e  t_input_embeddin
+000046e0: 6773 2873 656c 6629 3a0a 2020 2020 2020  gs(self):.      
+000046f0: 2020 7265 7475 726e 2073 656c 662e 656d    return self.em
+00004700: 6265 6464 696e 6773 0a0a 0a63 6c61 7373  beddings...class
+00004710: 2042 6c69 7032 5146 6f72 6d65 724d 756c   Blip2QFormerMul
+00004720: 7469 4865 6164 4174 7465 6e74 696f 6e28  tiHeadAttention(
+00004730: 6e6e 2e43 656c 6c29 3a0a 2020 2020 6465  nn.Cell):.    de
+00004740: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
+00004750: 2063 6f6e 6669 672c 2069 735f 6372 6f73   config, is_cros
+00004760: 735f 6174 7465 6e74 696f 6e3d 4661 6c73  s_attention=Fals
+00004770: 6529 3a0a 2020 2020 2020 2020 7375 7065  e):.        supe
+00004780: 7228 292e 5f5f 696e 6974 5f5f 2829 0a20  r().__init__(). 
+00004790: 2020 2020 2020 2073 656c 662e 636f 6e66         self.conf
+000047a0: 6967 203d 2063 6f6e 6669 670a 2020 2020  ig = config.    
+000047b0: 2020 2020 6966 2063 6f6e 6669 672e 6869      if config.hi
+000047c0: 6464 656e 5f73 697a 6520 2520 636f 6e66  dden_size % conf
+000047d0: 6967 2e6e 756d 5f61 7474 656e 7469 6f6e  ig.num_attention
+000047e0: 5f68 6561 6473 2021 3d20 3020 616e 6420  _heads != 0 and 
+000047f0: 6e6f 7420 6861 7361 7474 7228 636f 6e66  not hasattr(conf
+00004800: 6967 2c20 2265 6d62 6564 6469 6e67 5f73  ig, "embedding_s
+00004810: 697a 6522 293a 0a20 2020 2020 2020 2020  ize"):.         
+00004820: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+00004830: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
+00004840: 2020 2020 2022 5468 6520 6869 6464 656e       "The hidden
+00004850: 2073 697a 6520 2825 6429 2069 7320 6e6f   size (%d) is no
+00004860: 7420 6120 6d75 6c74 6970 6c65 206f 6620  t a multiple of 
+00004870: 7468 6520 6e75 6d62 6572 206f 6620 6174  the number of at
+00004880: 7465 6e74 696f 6e20 6865 6164 7320 2825  tention heads (%
+00004890: 6429 220a 2020 2020 2020 2020 2020 2020  d)".            
+000048a0: 2020 2020 2520 2863 6f6e 6669 672e 6869      % (config.hi
+000048b0: 6464 656e 5f73 697a 652c 2063 6f6e 6669  dden_size, confi
+000048c0: 672e 6e75 6d5f 6174 7465 6e74 696f 6e5f  g.num_attention_
+000048d0: 6865 6164 7329 0a20 2020 2020 2020 2020  heads).         
+000048e0: 2020 2029 0a0a 2020 2020 2020 2020 7365     )..        se
+000048f0: 6c66 2e6e 756d 5f61 7474 656e 7469 6f6e  lf.num_attention
+00004900: 5f68 6561 6473 203d 2063 6f6e 6669 672e  _heads = config.
+00004910: 6e75 6d5f 6174 7465 6e74 696f 6e5f 6865  num_attention_he
+00004920: 6164 730a 2020 2020 2020 2020 7365 6c66  ads.        self
+00004930: 2e61 7474 656e 7469 6f6e 5f68 6561 645f  .attention_head_
+00004940: 7369 7a65 203d 2069 6e74 2863 6f6e 6669  size = int(confi
+00004950: 672e 6869 6464 656e 5f73 697a 6520 2f20  g.hidden_size / 
+00004960: 636f 6e66 6967 2e6e 756d 5f61 7474 656e  config.num_atten
+00004970: 7469 6f6e 5f68 6561 6473 290a 2020 2020  tion_heads).    
+00004980: 2020 2020 7365 6c66 2e61 6c6c 5f68 6561      self.all_hea
+00004990: 645f 7369 7a65 203d 2073 656c 662e 6e75  d_size = self.nu
+000049a0: 6d5f 6174 7465 6e74 696f 6e5f 6865 6164  m_attention_head
+000049b0: 7320 2a20 7365 6c66 2e61 7474 656e 7469  s * self.attenti
+000049c0: 6f6e 5f68 6561 645f 7369 7a65 0a0a 2020  on_head_size..  
+000049d0: 2020 2020 2020 7365 6c66 2e71 7565 7279        self.query
+000049e0: 203d 206e 6e2e 4465 6e73 6528 636f 6e66   = nn.Dense(conf
+000049f0: 6967 2e68 6964 6465 6e5f 7369 7a65 2c20  ig.hidden_size, 
+00004a00: 7365 6c66 2e61 6c6c 5f68 6561 645f 7369  self.all_head_si
+00004a10: 7a65 290a 2020 2020 2020 2020 6966 2069  ze).        if i
+00004a20: 735f 6372 6f73 735f 6174 7465 6e74 696f  s_cross_attentio
+00004a30: 6e3a 0a20 2020 2020 2020 2020 2020 2073  n:.            s
+00004a40: 656c 662e 6b65 7920 3d20 6e6e 2e44 656e  elf.key = nn.Den
+00004a50: 7365 2863 6f6e 6669 672e 656e 636f 6465  se(config.encode
+00004a60: 725f 6869 6464 656e 5f73 697a 652c 2073  r_hidden_size, s
+00004a70: 656c 662e 616c 6c5f 6865 6164 5f73 697a  elf.all_head_siz
+00004a80: 6529 0a20 2020 2020 2020 2020 2020 2073  e).            s
+00004a90: 656c 662e 7661 6c75 6520 3d20 6e6e 2e44  elf.value = nn.D
+00004aa0: 656e 7365 2863 6f6e 6669 672e 656e 636f  ense(config.enco
+00004ab0: 6465 725f 6869 6464 656e 5f73 697a 652c  der_hidden_size,
+00004ac0: 2073 656c 662e 616c 6c5f 6865 6164 5f73   self.all_head_s
+00004ad0: 697a 6529 0a20 2020 2020 2020 2065 6c73  ize).        els
+00004ae0: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
+00004af0: 656c 662e 6b65 7920 3d20 6e6e 2e44 656e  elf.key = nn.Den
+00004b00: 7365 2863 6f6e 6669 672e 6869 6464 656e  se(config.hidden
+00004b10: 5f73 697a 652c 2073 656c 662e 616c 6c5f  _size, self.all_
+00004b20: 6865 6164 5f73 697a 6529 0a20 2020 2020  head_size).     
+00004b30: 2020 2020 2020 2073 656c 662e 7661 6c75         self.valu
+00004b40: 6520 3d20 6e6e 2e44 656e 7365 2863 6f6e  e = nn.Dense(con
+00004b50: 6669 672e 6869 6464 656e 5f73 697a 652c  fig.hidden_size,
+00004b60: 2073 656c 662e 616c 6c5f 6865 6164 5f73   self.all_head_s
+00004b70: 697a 6529 0a0a 2020 2020 2020 2020 7365  ize)..        se
+00004b80: 6c66 2e64 726f 706f 7574 203d 206e 6e2e  lf.dropout = nn.
+00004b90: 4472 6f70 6f75 7428 703d 636f 6e66 6967  Dropout(p=config
+00004ba0: 2e61 7474 656e 7469 6f6e 5f70 726f 6273  .attention_probs
+00004bb0: 5f64 726f 706f 7574 5f70 726f 6229 0a20  _dropout_prob). 
+00004bc0: 2020 2020 2020 2073 656c 662e 706f 7369         self.posi
+00004bd0: 7469 6f6e 5f65 6d62 6564 6469 6e67 5f74  tion_embedding_t
+00004be0: 7970 6520 3d20 6765 7461 7474 7228 636f  ype = getattr(co
+00004bf0: 6e66 6967 2c20 2270 6f73 6974 696f 6e5f  nfig, "position_
+00004c00: 656d 6265 6464 696e 675f 7479 7065 222c  embedding_type",
+00004c10: 2022 6162 736f 6c75 7465 2229 0a20 2020   "absolute").   
+00004c20: 2020 2020 2069 6620 7365 6c66 2e70 6f73       if self.pos
+00004c30: 6974 696f 6e5f 656d 6265 6464 696e 675f  ition_embedding_
+00004c40: 7479 7065 2069 6e20 2827 7265 6c61 7469  type in ('relati
+00004c50: 7665 5f6b 6579 272c 2027 7265 6c61 7469  ve_key', 'relati
+00004c60: 7665 5f6b 6579 5f71 7565 7279 2729 3a0a  ve_key_query'):.
+00004c70: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00004c80: 2e6d 6178 5f70 6f73 6974 696f 6e5f 656d  .max_position_em
+00004c90: 6265 6464 696e 6773 203d 2063 6f6e 6669  beddings = confi
+00004ca0: 672e 6d61 785f 706f 7369 7469 6f6e 5f65  g.max_position_e
+00004cb0: 6d62 6564 6469 6e67 730a 2020 2020 2020  mbeddings.      
+00004cc0: 2020 2020 2020 7365 6c66 2e64 6973 7461        self.dista
+00004cd0: 6e63 655f 656d 6265 6464 696e 6720 3d20  nce_embedding = 
+00004ce0: 6e6e 2e45 6d62 6564 6469 6e67 2832 202a  nn.Embedding(2 *
+00004cf0: 2063 6f6e 6669 672e 6d61 785f 706f 7369   config.max_posi
+00004d00: 7469 6f6e 5f65 6d62 6564 6469 6e67 7320  tion_embeddings 
+00004d10: 2d20 312c 2073 656c 662e 6174 7465 6e74  - 1, self.attent
+00004d20: 696f 6e5f 6865 6164 5f73 697a 6529 0a20  ion_head_size). 
+00004d30: 2020 2020 2020 2073 656c 662e 7361 7665         self.save
+00004d40: 5f61 7474 656e 7469 6f6e 203d 2046 616c  _attention = Fal
+00004d50: 7365 0a0a 2020 2020 6465 6620 7361 7665  se..    def save
+00004d60: 5f61 7474 6e5f 6772 6164 6965 6e74 7328  _attn_gradients(
+00004d70: 7365 6c66 2c20 6174 746e 5f67 7261 6469  self, attn_gradi
+00004d80: 656e 7473 293a 0a20 2020 2020 2020 2073  ents):.        s
+00004d90: 656c 662e 6174 746e 5f67 7261 6469 656e  elf.attn_gradien
+00004da0: 7473 203d 2061 7474 6e5f 6772 6164 6965  ts = attn_gradie
+00004db0: 6e74 730a 0a20 2020 2064 6566 2067 6574  nts..    def get
+00004dc0: 5f61 7474 6e5f 6772 6164 6965 6e74 7328  _attn_gradients(
+00004dd0: 7365 6c66 293a 0a20 2020 2020 2020 2072  self):.        r
+00004de0: 6574 7572 6e20 7365 6c66 2e61 7474 6e5f  eturn self.attn_
+00004df0: 6772 6164 6965 6e74 730a 0a20 2020 2064  gradients..    d
+00004e00: 6566 2073 6176 655f 6174 7465 6e74 696f  ef save_attentio
+00004e10: 6e5f 6d61 7028 7365 6c66 2c20 6174 7465  n_map(self, atte
+00004e20: 6e74 696f 6e5f 6d61 7029 3a0a 2020 2020  ntion_map):.    
+00004e30: 2020 2020 7365 6c66 2e61 7474 656e 7469      self.attenti
+00004e40: 6f6e 5f6d 6170 203d 2061 7474 656e 7469  on_map = attenti
+00004e50: 6f6e 5f6d 6170 0a0a 2020 2020 6465 6620  on_map..    def 
+00004e60: 6765 745f 6174 7465 6e74 696f 6e5f 6d61  get_attention_ma
+00004e70: 7028 7365 6c66 293a 0a20 2020 2020 2020  p(self):.       
+00004e80: 2072 6574 7572 6e20 7365 6c66 2e61 7474   return self.att
+00004e90: 656e 7469 6f6e 5f6d 6170 0a0a 2020 2020  ention_map..    
+00004ea0: 6465 6620 7377 6170 6178 6573 5f66 6f72  def swapaxes_for
+00004eb0: 5f73 636f 7265 7328 7365 6c66 2c20 7829  _scores(self, x)
+00004ec0: 3a0a 2020 2020 2020 2020 6e65 775f 785f  :.        new_x_
+00004ed0: 7368 6170 6520 3d20 782e 7368 6170 655b  shape = x.shape[
+00004ee0: 3a2d 315d 202b 2028 7365 6c66 2e6e 756d  :-1] + (self.num
+00004ef0: 5f61 7474 656e 7469 6f6e 5f68 6561 6473  _attention_heads
+00004f00: 2c20 7365 6c66 2e61 7474 656e 7469 6f6e  , self.attention
+00004f10: 5f68 6561 645f 7369 7a65 290a 2020 2020  _head_size).    
+00004f20: 2020 2020 7820 3d20 782e 7669 6577 282a      x = x.view(*
+00004f30: 6e65 775f 785f 7368 6170 6529 0a20 2020  new_x_shape).   
+00004f40: 2020 2020 2072 6574 7572 6e20 782e 7065       return x.pe
+00004f50: 726d 7574 6528 302c 2032 2c20 312c 2033  rmute(0, 2, 1, 3
+00004f60: 290a 0a20 2020 2064 6566 2063 6f6e 7374  )..    def const
+00004f70: 7275 6374 280a 2020 2020 2020 2020 7365  ruct(.        se
+00004f80: 6c66 2c0a 2020 2020 2020 2020 6869 6464  lf,.        hidd
+00004f90: 656e 5f73 7461 7465 732c 0a20 2020 2020  en_states,.     
+00004fa0: 2020 2061 7474 656e 7469 6f6e 5f6d 6173     attention_mas
+00004fb0: 6b3d 4e6f 6e65 2c0a 2020 2020 2020 2020  k=None,.        
+00004fc0: 6865 6164 5f6d 6173 6b3d 4e6f 6e65 2c0a  head_mask=None,.
+00004fd0: 2020 2020 2020 2020 656e 636f 6465 725f          encoder_
+00004fe0: 6869 6464 656e 5f73 7461 7465 733d 4e6f  hidden_states=No
+00004ff0: 6e65 2c0a 2020 2020 2020 2020 656e 636f  ne,.        enco
+00005000: 6465 725f 6174 7465 6e74 696f 6e5f 6d61  der_attention_ma
+00005010: 736b 3d4e 6f6e 652c 0a20 2020 2020 2020  sk=None,.       
+00005020: 2070 6173 745f 6b65 795f 7661 6c75 653d   past_key_value=
+00005030: 4e6f 6e65 2c0a 2020 2020 2020 2020 6f75  None,.        ou
+00005040: 7470 7574 5f61 7474 656e 7469 6f6e 733d  tput_attentions=
+00005050: 4661 6c73 652c 0a20 2020 2029 3a0a 2020  False,.    ):.  
+00005060: 2020 2020 2020 2320 4966 2074 6869 7320        # If this 
+00005070: 6973 2069 6e73 7461 6e74 6961 7465 6420  is instantiated 
+00005080: 6173 2061 2063 726f 7373 2d61 7474 656e  as a cross-atten
+00005090: 7469 6f6e 206d 6f64 756c 652c 2074 6865  tion module, the
+000050a0: 206b 6579 730a 2020 2020 2020 2020 2320   keys.        # 
+000050b0: 616e 6420 7661 6c75 6573 2063 6f6d 6520  and values come 
+000050c0: 6672 6f6d 2061 6e20 656e 636f 6465 723b  from an encoder;
+000050d0: 2074 6865 2061 7474 656e 7469 6f6e 206d   the attention m
+000050e0: 6173 6b20 6e65 6564 7320 746f 2062 650a  ask needs to be.
+000050f0: 2020 2020 2020 2020 2320 7375 6368 2074          # such t
+00005100: 6861 7420 7468 6520 656e 636f 6465 7227  hat the encoder'
+00005110: 7320 7061 6464 696e 6720 746f 6b65 6e73  s padding tokens
+00005120: 2061 7265 206e 6f74 2061 7474 656e 6465   are not attende
+00005130: 6420 746f 2e0a 2020 2020 2020 2020 6973  d to..        is
+00005140: 5f63 726f 7373 5f61 7474 656e 7469 6f6e  _cross_attention
+00005150: 203d 2065 6e63 6f64 6572 5f68 6964 6465   = encoder_hidde
+00005160: 6e5f 7374 6174 6573 2069 7320 6e6f 7420  n_states is not 
+00005170: 4e6f 6e65 0a0a 2020 2020 2020 2020 6966  None..        if
+00005180: 2069 735f 6372 6f73 735f 6174 7465 6e74   is_cross_attent
+00005190: 696f 6e3a 0a20 2020 2020 2020 2020 2020  ion:.           
+000051a0: 206b 6579 5f6c 6179 6572 203d 2073 656c   key_layer = sel
+000051b0: 662e 7377 6170 6178 6573 5f66 6f72 5f73  f.swapaxes_for_s
+000051c0: 636f 7265 7328 7365 6c66 2e6b 6579 2865  cores(self.key(e
+000051d0: 6e63 6f64 6572 5f68 6964 6465 6e5f 7374  ncoder_hidden_st
+000051e0: 6174 6573 2929 0a20 2020 2020 2020 2020  ates)).         
+000051f0: 2020 2076 616c 7565 5f6c 6179 6572 203d     value_layer =
+00005200: 2073 656c 662e 7377 6170 6178 6573 5f66   self.swapaxes_f
+00005210: 6f72 5f73 636f 7265 7328 7365 6c66 2e76  or_scores(self.v
+00005220: 616c 7565 2865 6e63 6f64 6572 5f68 6964  alue(encoder_hid
+00005230: 6465 6e5f 7374 6174 6573 2929 0a20 2020  den_states)).   
+00005240: 2020 2020 2020 2020 2061 7474 656e 7469           attenti
+00005250: 6f6e 5f6d 6173 6b20 3d20 656e 636f 6465  on_mask = encode
+00005260: 725f 6174 7465 6e74 696f 6e5f 6d61 736b  r_attention_mask
+00005270: 0a20 2020 2020 2020 2065 6c69 6620 7061  .        elif pa
+00005280: 7374 5f6b 6579 5f76 616c 7565 2069 7320  st_key_value is 
+00005290: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+000052a0: 2020 2020 2020 6b65 795f 6c61 7965 7220        key_layer 
+000052b0: 3d20 7365 6c66 2e73 7761 7061 7865 735f  = self.swapaxes_
+000052c0: 666f 725f 7363 6f72 6573 2873 656c 662e  for_scores(self.
+000052d0: 6b65 7928 6869 6464 656e 5f73 7461 7465  key(hidden_state
+000052e0: 7329 290a 2020 2020 2020 2020 2020 2020  s)).            
+000052f0: 7661 6c75 655f 6c61 7965 7220 3d20 7365  value_layer = se
+00005300: 6c66 2e73 7761 7061 7865 735f 666f 725f  lf.swapaxes_for_
+00005310: 7363 6f72 6573 2873 656c 662e 7661 6c75  scores(self.valu
+00005320: 6528 6869 6464 656e 5f73 7461 7465 7329  e(hidden_states)
+00005330: 290a 2020 2020 2020 2020 2020 2020 6b65  ).            ke
+00005340: 795f 6c61 7965 7220 3d20 6f70 732e 6361  y_layer = ops.ca
+00005350: 7428 5b70 6173 745f 6b65 795f 7661 6c75  t([past_key_valu
+00005360: 655b 305d 2c20 6b65 795f 6c61 7965 725d  e[0], key_layer]
+00005370: 2c20 6178 6973 3d32 290a 2020 2020 2020  , axis=2).      
+00005380: 2020 2020 2020 7661 6c75 655f 6c61 7965        value_laye
+00005390: 7220 3d20 6f70 732e 6361 7428 5b70 6173  r = ops.cat([pas
+000053a0: 745f 6b65 795f 7661 6c75 655b 315d 2c20  t_key_value[1], 
+000053b0: 7661 6c75 655f 6c61 7965 725d 2c20 6178  value_layer], ax
+000053c0: 6973 3d32 290a 2020 2020 2020 2020 656c  is=2).        el
+000053d0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000053e0: 6b65 795f 6c61 7965 7220 3d20 7365 6c66  key_layer = self
+000053f0: 2e73 7761 7061 7865 735f 666f 725f 7363  .swapaxes_for_sc
+00005400: 6f72 6573 2873 656c 662e 6b65 7928 6869  ores(self.key(hi
+00005410: 6464 656e 5f73 7461 7465 7329 290a 2020  dden_states)).  
+00005420: 2020 2020 2020 2020 2020 7661 6c75 655f            value_
+00005430: 6c61 7965 7220 3d20 7365 6c66 2e73 7761  layer = self.swa
+00005440: 7061 7865 735f 666f 725f 7363 6f72 6573  paxes_for_scores
+00005450: 2873 656c 662e 7661 6c75 6528 6869 6464  (self.value(hidd
+00005460: 656e 5f73 7461 7465 7329 290a 0a20 2020  en_states))..   
+00005470: 2020 2020 206d 6978 6564 5f71 7565 7279       mixed_query
+00005480: 5f6c 6179 6572 203d 2073 656c 662e 7175  _layer = self.qu
+00005490: 6572 7928 6869 6464 656e 5f73 7461 7465  ery(hidden_state
+000054a0: 7329 0a0a 2020 2020 2020 2020 7175 6572  s)..        quer
+000054b0: 795f 6c61 7965 7220 3d20 7365 6c66 2e73  y_layer = self.s
+000054c0: 7761 7061 7865 735f 666f 725f 7363 6f72  wapaxes_for_scor
+000054d0: 6573 286d 6978 6564 5f71 7565 7279 5f6c  es(mixed_query_l
+000054e0: 6179 6572 290a 0a20 2020 2020 2020 2070  ayer)..        p
+000054f0: 6173 745f 6b65 795f 7661 6c75 6520 3d20  ast_key_value = 
+00005500: 286b 6579 5f6c 6179 6572 2c20 7661 6c75  (key_layer, valu
+00005510: 655f 6c61 7965 7229 0a0a 2020 2020 2020  e_layer)..      
+00005520: 2020 2320 5461 6b65 2074 6865 2064 6f74    # Take the dot
+00005530: 2070 726f 6475 6374 2062 6574 7765 656e   product between
+00005540: 2022 7175 6572 7922 2061 6e64 2022 6b65   "query" and "ke
+00005550: 7922 2074 6f20 6765 7420 7468 6520 7261  y" to get the ra
+00005560: 7720 6174 7465 6e74 696f 6e20 7363 6f72  w attention scor
+00005570: 6573 2e0a 2020 2020 2020 2020 6174 7465  es..        atte
+00005580: 6e74 696f 6e5f 7363 6f72 6573 203d 206f  ntion_scores = o
+00005590: 7073 2e6d 6174 6d75 6c28 7175 6572 795f  ps.matmul(query_
+000055a0: 6c61 7965 722c 206b 6579 5f6c 6179 6572  layer, key_layer
+000055b0: 2e73 7761 7061 7865 7328 2d31 2c20 2d32  .swapaxes(-1, -2
+000055c0: 2929 0a0a 2020 2020 2020 2020 6966 2073  ))..        if s
+000055d0: 656c 662e 706f 7369 7469 6f6e 5f65 6d62  elf.position_emb
+000055e0: 6564 6469 6e67 5f74 7970 6520 696e 2028  edding_type in (
+000055f0: 2772 656c 6174 6976 655f 6b65 7927 2c20  'relative_key', 
+00005600: 2772 656c 6174 6976 655f 6b65 795f 7175  'relative_key_qu
+00005610: 6572 7927 293a 0a20 2020 2020 2020 2020  ery'):.         
+00005620: 2020 2073 6571 5f6c 656e 6774 6820 3d20     seq_length = 
+00005630: 6869 6464 656e 5f73 7461 7465 732e 7368  hidden_states.sh
+00005640: 6170 655b 315d 0a20 2020 2020 2020 2020  ape[1].         
+00005650: 2020 2070 6f73 6974 696f 6e5f 6964 735f     position_ids_
+00005660: 6c20 3d20 6f70 732e 6172 616e 6765 2873  l = ops.arange(s
+00005670: 6571 5f6c 656e 6774 682c 2064 7479 7065  eq_length, dtype
+00005680: 3d6d 696e 6473 706f 7265 2e69 6e74 3634  =mindspore.int64
+00005690: 292e 7669 6577 282d 312c 2031 290a 2020  ).view(-1, 1).  
+000056a0: 2020 2020 2020 2020 2020 706f 7369 7469            positi
+000056b0: 6f6e 5f69 6473 5f72 203d 206f 7073 2e61  on_ids_r = ops.a
+000056c0: 7261 6e67 6528 7365 715f 6c65 6e67 7468  range(seq_length
+000056d0: 2c20 6474 7970 653d 6d69 6e64 7370 6f72  , dtype=mindspor
+000056e0: 652e 696e 7436 3429 2e76 6965 7728 312c  e.int64).view(1,
+000056f0: 202d 3129 0a20 2020 2020 2020 2020 2020   -1).           
+00005700: 2064 6973 7461 6e63 6520 3d20 706f 7369   distance = posi
+00005710: 7469 6f6e 5f69 6473 5f6c 202d 2070 6f73  tion_ids_l - pos
+00005720: 6974 696f 6e5f 6964 735f 720a 2020 2020  ition_ids_r.    
+00005730: 2020 2020 2020 2020 706f 7369 7469 6f6e          position
+00005740: 616c 5f65 6d62 6564 6469 6e67 203d 2073  al_embedding = s
+00005750: 656c 662e 6469 7374 616e 6365 5f65 6d62  elf.distance_emb
+00005760: 6564 6469 6e67 2864 6973 7461 6e63 6520  edding(distance 
+00005770: 2b20 7365 6c66 2e6d 6178 5f70 6f73 6974  + self.max_posit
+00005780: 696f 6e5f 656d 6265 6464 696e 6773 202d  ion_embeddings -
+00005790: 2031 290a 2020 2020 2020 2020 2020 2020   1).            
+000057a0: 706f 7369 7469 6f6e 616c 5f65 6d62 6564  positional_embed
+000057b0: 6469 6e67 203d 2070 6f73 6974 696f 6e61  ding = positiona
+000057c0: 6c5f 656d 6265 6464 696e 672e 746f 2864  l_embedding.to(d
+000057d0: 7479 7065 3d71 7565 7279 5f6c 6179 6572  type=query_layer
+000057e0: 2e64 7479 7065 2920 2023 2066 7031 3620  .dtype)  # fp16 
+000057f0: 636f 6d70 6174 6962 696c 6974 790a 0a20  compatibility.. 
+00005800: 2020 2020 2020 2020 2020 2069 6620 7365             if se
+00005810: 6c66 2e70 6f73 6974 696f 6e5f 656d 6265  lf.position_embe
+00005820: 6464 696e 675f 7479 7065 203d 3d20 2272  dding_type == "r
+00005830: 656c 6174 6976 655f 6b65 7922 3a0a 2020  elative_key":.  
+00005840: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00005850: 6c61 7469 7665 5f70 6f73 6974 696f 6e5f  lative_position_
+00005860: 7363 6f72 6573 203d 206f 7073 2e65 696e  scores = ops.ein
+00005870: 7375 6d28 2262 686c 642c 6c72 642d 3e62  sum("bhld,lrd->b
+00005880: 686c 7222 2c20 7175 6572 795f 6c61 7965  hlr", query_laye
+00005890: 722c 2070 6f73 6974 696f 6e61 6c5f 656d  r, positional_em
+000058a0: 6265 6464 696e 6729 0a20 2020 2020 2020  bedding).       
+000058b0: 2020 2020 2020 2020 2061 7474 656e 7469           attenti
+000058c0: 6f6e 5f73 636f 7265 7320 3d20 6174 7465  on_scores = atte
+000058d0: 6e74 696f 6e5f 7363 6f72 6573 202b 2072  ntion_scores + r
+000058e0: 656c 6174 6976 655f 706f 7369 7469 6f6e  elative_position
+000058f0: 5f73 636f 7265 730a 2020 2020 2020 2020  _scores.        
+00005900: 2020 2020 656c 6966 2073 656c 662e 706f      elif self.po
+00005910: 7369 7469 6f6e 5f65 6d62 6564 6469 6e67  sition_embedding
+00005920: 5f74 7970 6520 3d3d 2022 7265 6c61 7469  _type == "relati
+00005930: 7665 5f6b 6579 5f71 7565 7279 223a 0a20  ve_key_query":. 
+00005940: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00005950: 656c 6174 6976 655f 706f 7369 7469 6f6e  elative_position
+00005960: 5f73 636f 7265 735f 7175 6572 7920 3d20  _scores_query = 
+00005970: 6f70 732e 6569 6e73 756d 2822 6268 6c64  ops.einsum("bhld
+00005980: 2c6c 7264 2d3e 6268 6c72 222c 2071 7565  ,lrd->bhlr", que
+00005990: 7279 5f6c 6179 6572 2c20 706f 7369 7469  ry_layer, positi
+000059a0: 6f6e 616c 5f65 6d62 6564 6469 6e67 290a  onal_embedding).
+000059b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000059c0: 7265 6c61 7469 7665 5f70 6f73 6974 696f  relative_positio
+000059d0: 6e5f 7363 6f72 6573 5f6b 6579 203d 206f  n_scores_key = o
+000059e0: 7073 2e65 696e 7375 6d28 2262 6872 642c  ps.einsum("bhrd,
+000059f0: 6c72 642d 3e62 686c 7222 2c20 6b65 795f  lrd->bhlr", key_
+00005a00: 6c61 7965 722c 2070 6f73 6974 696f 6e61  layer, positiona
+00005a10: 6c5f 656d 6265 6464 696e 6729 0a20 2020  l_embedding).   
+00005a20: 2020 2020 2020 2020 2020 2020 2061 7474               att
+00005a30: 656e 7469 6f6e 5f73 636f 7265 7320 3d20  ention_scores = 
+00005a40: 6174 7465 6e74 696f 6e5f 7363 6f72 6573  attention_scores
+00005a50: 202b 2072 656c 6174 6976 655f 706f 7369   + relative_posi
+00005a60: 7469 6f6e 5f73 636f 7265 735f 7175 6572  tion_scores_quer
+00005a70: 7920 2b20 7265 6c61 7469 7665 5f70 6f73  y + relative_pos
+00005a80: 6974 696f 6e5f 7363 6f72 6573 5f6b 6579  ition_scores_key
+00005a90: 0a0a 2020 2020 2020 2020 6174 7465 6e74  ..        attent
+00005aa0: 696f 6e5f 7363 6f72 6573 203d 2061 7474  ion_scores = att
+00005ab0: 656e 7469 6f6e 5f73 636f 7265 7320 2f20  ention_scores / 
+00005ac0: 6d61 7468 2e73 7172 7428 7365 6c66 2e61  math.sqrt(self.a
+00005ad0: 7474 656e 7469 6f6e 5f68 6561 645f 7369  ttention_head_si
+00005ae0: 7a65 290a 0a20 2020 2020 2020 2069 6620  ze)..        if 
+00005af0: 6174 7465 6e74 696f 6e5f 6d61 736b 2069  attention_mask i
+00005b00: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00005b10: 2020 2020 2020 2020 2320 4170 706c 7920          # Apply 
+00005b20: 7468 6520 6174 7465 6e74 696f 6e20 6d61  the attention ma
+00005b30: 736b 2069 7320 2870 7265 636f 6d70 7574  sk is (precomput
+00005b40: 6564 2066 6f72 2061 6c6c 206c 6179 6572  ed for all layer
+00005b50: 7320 696e 2042 6572 744d 6f64 656c 2066  s in BertModel f
+00005b60: 6f72 7761 7264 2829 2066 756e 6374 696f  orward() functio
+00005b70: 6e29 0a20 2020 2020 2020 2020 2020 2061  n).            a
+00005b80: 7474 656e 7469 6f6e 5f73 636f 7265 7320  ttention_scores 
+00005b90: 3d20 6174 7465 6e74 696f 6e5f 7363 6f72  = attention_scor
+00005ba0: 6573 202b 2061 7474 656e 7469 6f6e 5f6d  es + attention_m
+00005bb0: 6173 6b0a 0a20 2020 2020 2020 2023 204e  ask..        # N
+00005bc0: 6f72 6d61 6c69 7a65 2074 6865 2061 7474  ormalize the att
+00005bd0: 656e 7469 6f6e 2073 636f 7265 7320 746f  ention scores to
+00005be0: 2070 726f 6261 6269 6c69 7469 6573 2e0a   probabilities..
+00005bf0: 2020 2020 2020 2020 6174 7465 6e74 696f          attentio
+00005c00: 6e5f 7072 6f62 7320 3d20 6f70 732e 736f  n_probs = ops.so
+00005c10: 6674 6d61 7828 6174 7465 6e74 696f 6e5f  ftmax(attention_
+00005c20: 7363 6f72 6573 290a 0a20 2020 2020 2020  scores)..       
+00005c30: 2069 6620 6973 5f63 726f 7373 5f61 7474   if is_cross_att
+00005c40: 656e 7469 6f6e 2061 6e64 2073 656c 662e  ention and self.
+00005c50: 7361 7665 5f61 7474 656e 7469 6f6e 3a0a  save_attention:.
+00005c60: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00005c70: 2e73 6176 655f 6174 7465 6e74 696f 6e5f  .save_attention_
+00005c80: 6d61 7028 6174 7465 6e74 696f 6e5f 7072  map(attention_pr
+00005c90: 6f62 7329 0a20 2020 2020 2020 2020 2020  obs).           
+00005ca0: 2061 7474 656e 7469 6f6e 5f70 726f 6273   attention_probs
+00005cb0: 2e72 6567 6973 7465 725f 686f 6f6b 2873  .register_hook(s
+00005cc0: 656c 662e 7361 7665 5f61 7474 6e5f 6772  elf.save_attn_gr
+00005cd0: 6164 6965 6e74 7329 0a0a 2020 2020 2020  adients)..      
+00005ce0: 2020 2320 5468 6973 2069 7320 6163 7475    # This is actu
+00005cf0: 616c 6c79 2064 726f 7070 696e 6720 6f75  ally dropping ou
+00005d00: 7420 656e 7469 7265 2074 6f6b 656e 7320  t entire tokens 
+00005d10: 746f 2061 7474 656e 6420 746f 2c20 7768  to attend to, wh
+00005d20: 6963 6820 6d69 6768 740a 2020 2020 2020  ich might.      
+00005d30: 2020 2320 7365 656d 2061 2062 6974 2075    # seem a bit u
+00005d40: 6e75 7375 616c 2c20 6275 7420 6973 2074  nusual, but is t
+00005d50: 616b 656e 2066 726f 6d20 7468 6520 6f72  aken from the or
+00005d60: 6967 696e 616c 2054 7261 6e73 666f 726d  iginal Transform
+00005d70: 6572 2070 6170 6572 2e0a 2020 2020 2020  er paper..      
+00005d80: 2020 6174 7465 6e74 696f 6e5f 7072 6f62    attention_prob
+00005d90: 735f 6472 6f70 7065 6420 3d20 7365 6c66  s_dropped = self
+00005da0: 2e64 726f 706f 7574 2861 7474 656e 7469  .dropout(attenti
+00005db0: 6f6e 5f70 726f 6273 290a 0a20 2020 2020  on_probs)..     
+00005dc0: 2020 2023 204d 6173 6b20 6865 6164 7320     # Mask heads 
+00005dd0: 6966 2077 6520 7761 6e74 2074 6f0a 2020  if we want to.  
+00005de0: 2020 2020 2020 6966 2068 6561 645f 6d61        if head_ma
+00005df0: 736b 2069 7320 6e6f 7420 4e6f 6e65 3a0a  sk is not None:.
+00005e00: 2020 2020 2020 2020 2020 2020 6174 7465              atte
+00005e10: 6e74 696f 6e5f 7072 6f62 735f 6472 6f70  ntion_probs_drop
+00005e20: 7065 6420 3d20 6174 7465 6e74 696f 6e5f  ped = attention_
+00005e30: 7072 6f62 735f 6472 6f70 7065 6420 2a20  probs_dropped * 
+00005e40: 6865 6164 5f6d 6173 6b0a 0a20 2020 2020  head_mask..     
+00005e50: 2020 2063 6f6e 7465 7874 5f6c 6179 6572     context_layer
+00005e60: 203d 206f 7073 2e6d 6174 6d75 6c28 6174   = ops.matmul(at
+00005e70: 7465 6e74 696f 6e5f 7072 6f62 735f 6472  tention_probs_dr
+00005e80: 6f70 7065 642c 2076 616c 7565 5f6c 6179  opped, value_lay
+00005e90: 6572 290a 0a20 2020 2020 2020 2063 6f6e  er)..        con
+00005ea0: 7465 7874 5f6c 6179 6572 203d 2063 6f6e  text_layer = con
+00005eb0: 7465 7874 5f6c 6179 6572 2e70 6572 6d75  text_layer.permu
+00005ec0: 7465 2830 2c20 322c 2031 2c20 3329 0a20  te(0, 2, 1, 3). 
+00005ed0: 2020 2020 2020 206e 6577 5f63 6f6e 7465         new_conte
+00005ee0: 7874 5f6c 6179 6572 5f73 6861 7065 203d  xt_layer_shape =
+00005ef0: 2063 6f6e 7465 7874 5f6c 6179 6572 2e73   context_layer.s
+00005f00: 6861 7065 5b3a 2d32 5d20 2b20 2873 656c  hape[:-2] + (sel
+00005f10: 662e 616c 6c5f 6865 6164 5f73 697a 652c  f.all_head_size,
+00005f20: 290a 2020 2020 2020 2020 636f 6e74 6578  ).        contex
+00005f30: 745f 6c61 7965 7220 3d20 636f 6e74 6578  t_layer = contex
+00005f40: 745f 6c61 7965 722e 7669 6577 282a 6e65  t_layer.view(*ne
+00005f50: 775f 636f 6e74 6578 745f 6c61 7965 725f  w_context_layer_
+00005f60: 7368 6170 6529 0a0a 2020 2020 2020 2020  shape)..        
+00005f70: 6f75 7470 7574 7320 3d20 2863 6f6e 7465  outputs = (conte
+00005f80: 7874 5f6c 6179 6572 2c20 6174 7465 6e74  xt_layer, attent
+00005f90: 696f 6e5f 7072 6f62 7329 2069 6620 6f75  ion_probs) if ou
+00005fa0: 7470 7574 5f61 7474 656e 7469 6f6e 7320  tput_attentions 
+00005fb0: 656c 7365 2028 636f 6e74 6578 745f 6c61  else (context_la
+00005fc0: 7965 722c 290a 0a20 2020 2020 2020 206f  yer,)..        o
+00005fd0: 7574 7075 7473 203d 206f 7574 7075 7473  utputs = outputs
+00005fe0: 202b 2028 7061 7374 5f6b 6579 5f76 616c   + (past_key_val
+00005ff0: 7565 2c29 0a20 2020 2020 2020 2072 6574  ue,).        ret
+00006000: 7572 6e20 6f75 7470 7574 730a 0a0a 2320  urn outputs...# 
+00006010: 436f 7069 6564 2066 726f 6d20 7472 616e  Copied from tran
+00006020: 7366 6f72 6d65 7273 2e6d 6f64 656c 732e  sformers.models.
+00006030: 6265 7274 2e6d 6f64 656c 696e 675f 6265  bert.modeling_be
+00006040: 7274 2e42 6572 7453 656c 664f 7574 7075  rt.BertSelfOutpu
+00006050: 7420 7769 7468 2042 6572 742d 3e42 6c69  t with Bert->Bli
+00006060: 7032 5146 6f72 6d65 720a 636c 6173 7320  p2QFormer.class 
+00006070: 426c 6970 3251 466f 726d 6572 5365 6c66  Blip2QFormerSelf
+00006080: 4f75 7470 7574 286e 6e2e 4365 6c6c 293a  Output(nn.Cell):
+00006090: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+000060a0: 5f28 7365 6c66 2c20 636f 6e66 6967 293a  _(self, config):
+000060b0: 0a20 2020 2020 2020 2073 7570 6572 2829  .        super()
+000060c0: 2e5f 5f69 6e69 745f 5f28 290a 2020 2020  .__init__().    
+000060d0: 2020 2020 7365 6c66 2e64 656e 7365 203d      self.dense =
+000060e0: 206e 6e2e 4465 6e73 6528 636f 6e66 6967   nn.Dense(config
+000060f0: 2e68 6964 6465 6e5f 7369 7a65 2c20 636f  .hidden_size, co
+00006100: 6e66 6967 2e68 6964 6465 6e5f 7369 7a65  nfig.hidden_size
+00006110: 290a 2020 2020 2020 2020 7365 6c66 2e4c  ).        self.L
+00006120: 6179 6572 4e6f 726d 203d 206e 6e2e 4c61  ayerNorm = nn.La
+00006130: 7965 724e 6f72 6d28 636f 6e66 6967 2e68  yerNorm(config.h
+00006140: 6964 6465 6e5f 7369 7a65 2c20 6570 7369  idden_size, epsi
+00006150: 6c6f 6e3d 636f 6e66 6967 2e6c 6179 6572  lon=config.layer
+00006160: 5f6e 6f72 6d5f 6570 7329 0a20 2020 2020  _norm_eps).     
+00006170: 2020 2073 656c 662e 6472 6f70 6f75 7420     self.dropout 
+00006180: 3d20 6e6e 2e44 726f 706f 7574 2870 3d63  = nn.Dropout(p=c
+00006190: 6f6e 6669 672e 6869 6464 656e 5f64 726f  onfig.hidden_dro
+000061a0: 706f 7574 5f70 726f 6229 0a0a 2020 2020  pout_prob)..    
+000061b0: 6465 6620 636f 6e73 7472 7563 7428 7365  def construct(se
+000061c0: 6c66 2c20 6869 6464 656e 5f73 7461 7465  lf, hidden_state
+000061d0: 733a 206d 696e 6473 706f 7265 2e54 656e  s: mindspore.Ten
+000061e0: 736f 722c 2069 6e70 7574 5f74 656e 736f  sor, input_tenso
+000061f0: 723a 206d 696e 6473 706f 7265 2e54 656e  r: mindspore.Ten
+00006200: 736f 7229 202d 3e20 6d69 6e64 7370 6f72  sor) -> mindspor
+00006210: 652e 5465 6e73 6f72 3a0a 2020 2020 2020  e.Tensor:.      
+00006220: 2020 6869 6464 656e 5f73 7461 7465 7320    hidden_states 
+00006230: 3d20 7365 6c66 2e64 656e 7365 2868 6964  = self.dense(hid
+00006240: 6465 6e5f 7374 6174 6573 290a 2020 2020  den_states).    
+00006250: 2020 2020 6869 6464 656e 5f73 7461 7465      hidden_state
+00006260: 7320 3d20 7365 6c66 2e64 726f 706f 7574  s = self.dropout
+00006270: 2868 6964 6465 6e5f 7374 6174 6573 290a  (hidden_states).
+00006280: 2020 2020 2020 2020 6869 6464 656e 5f73          hidden_s
+00006290: 7461 7465 7320 3d20 7365 6c66 2e4c 6179  tates = self.Lay
+000062a0: 6572 4e6f 726d 2868 6964 6465 6e5f 7374  erNorm(hidden_st
+000062b0: 6174 6573 202b 2069 6e70 7574 5f74 656e  ates + input_ten
+000062c0: 736f 7229 0a20 2020 2020 2020 2072 6574  sor).        ret
+000062d0: 7572 6e20 6869 6464 656e 5f73 7461 7465  urn hidden_state
+000062e0: 730a 0a0a 636c 6173 7320 426c 6970 3251  s...class Blip2Q
+000062f0: 466f 726d 6572 4174 7465 6e74 696f 6e28  FormerAttention(
+00006300: 6e6e 2e43 656c 6c29 3a0a 2020 2020 6465  nn.Cell):.    de
+00006310: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
+00006320: 2063 6f6e 6669 672c 2069 735f 6372 6f73   config, is_cros
+00006330: 735f 6174 7465 6e74 696f 6e3d 4661 6c73  s_attention=Fals
+00006340: 6529 3a0a 2020 2020 2020 2020 7375 7065  e):.        supe
+00006350: 7228 292e 5f5f 696e 6974 5f5f 2829 0a20  r().__init__(). 
+00006360: 2020 2020 2020 2073 656c 662e 6174 7465         self.atte
+00006370: 6e74 696f 6e20 3d20 426c 6970 3251 466f  ntion = Blip2QFo
+00006380: 726d 6572 4d75 6c74 6948 6561 6441 7474  rmerMultiHeadAtt
+00006390: 656e 7469 6f6e 2863 6f6e 6669 672c 2069  ention(config, i
+000063a0: 735f 6372 6f73 735f 6174 7465 6e74 696f  s_cross_attentio
+000063b0: 6e29 0a20 2020 2020 2020 2073 656c 662e  n).        self.
+000063c0: 6f75 7470 7574 203d 2042 6c69 7032 5146  output = Blip2QF
+000063d0: 6f72 6d65 7253 656c 664f 7574 7075 7428  ormerSelfOutput(
+000063e0: 636f 6e66 6967 290a 2020 2020 2020 2020  config).        
+000063f0: 7365 6c66 2e70 7275 6e65 645f 6865 6164  self.pruned_head
+00006400: 7320 3d20 7365 7428 290a 0a20 2020 2064  s = set()..    d
+00006410: 6566 2070 7275 6e65 5f68 6561 6473 2873  ef prune_heads(s
+00006420: 656c 662c 2068 6561 6473 293a 0a20 2020  elf, heads):.   
+00006430: 2020 2020 2069 6620 6c65 6e28 6865 6164       if len(head
+00006440: 7329 203d 3d20 303a 0a20 2020 2020 2020  s) == 0:.       
+00006450: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
+00006460: 2020 2020 6865 6164 732c 2069 6e64 6578      heads, index
+00006470: 203d 2066 696e 645f 7072 756e 6561 626c   = find_pruneabl
+00006480: 655f 6865 6164 735f 616e 645f 696e 6469  e_heads_and_indi
+00006490: 6365 7328 0a20 2020 2020 2020 2020 2020  ces(.           
+000064a0: 2068 6561 6473 2c20 7365 6c66 2e61 7474   heads, self.att
+000064b0: 656e 7469 6f6e 2e6e 756d 5f61 7474 656e  ention.num_atten
+000064c0: 7469 6f6e 5f68 6561 6473 2c20 7365 6c66  tion_heads, self
+000064d0: 2e61 7474 656e 7469 6f6e 2e61 7474 656e  .attention.atten
+000064e0: 7469 6f6e 5f68 6561 645f 7369 7a65 2c20  tion_head_size, 
+000064f0: 7365 6c66 2e70 7275 6e65 645f 6865 6164  self.pruned_head
+00006500: 730a 2020 2020 2020 2020 290a 0a20 2020  s.        )..   
+00006510: 2020 2020 2023 2050 7275 6e65 206c 696e       # Prune lin
+00006520: 6561 7220 6c61 7965 7273 0a20 2020 2020  ear layers.     
+00006530: 2020 2073 656c 662e 6174 7465 6e74 696f     self.attentio
+00006540: 6e2e 7175 6572 7920 3d20 7072 756e 655f  n.query = prune_
+00006550: 6c69 6e65 6172 5f6c 6179 6572 2873 656c  linear_layer(sel
+00006560: 662e 6174 7465 6e74 696f 6e2e 7175 6572  f.attention.quer
+00006570: 792c 2069 6e64 6578 290a 2020 2020 2020  y, index).      
+00006580: 2020 7365 6c66 2e61 7474 656e 7469 6f6e    self.attention
+00006590: 2e6b 6579 203d 2070 7275 6e65 5f6c 696e  .key = prune_lin
+000065a0: 6561 725f 6c61 7965 7228 7365 6c66 2e61  ear_layer(self.a
+000065b0: 7474 656e 7469 6f6e 2e6b 6579 2c20 696e  ttention.key, in
+000065c0: 6465 7829 0a20 2020 2020 2020 2073 656c  dex).        sel
+000065d0: 662e 6174 7465 6e74 696f 6e2e 7661 6c75  f.attention.valu
+000065e0: 6520 3d20 7072 756e 655f 6c69 6e65 6172  e = prune_linear
+000065f0: 5f6c 6179 6572 2873 656c 662e 6174 7465  _layer(self.atte
+00006600: 6e74 696f 6e2e 7661 6c75 652c 2069 6e64  ntion.value, ind
+00006610: 6578 290a 2020 2020 2020 2020 7365 6c66  ex).        self
+00006620: 2e6f 7574 7075 742e 6465 6e73 6520 3d20  .output.dense = 
+00006630: 7072 756e 655f 6c69 6e65 6172 5f6c 6179  prune_linear_lay
+00006640: 6572 2873 656c 662e 6f75 7470 7574 2e64  er(self.output.d
+00006650: 656e 7365 2c20 696e 6465 782c 2061 7869  ense, index, axi
+00006660: 733d 3129 0a0a 2020 2020 2020 2020 2320  s=1)..        # 
+00006670: 5570 6461 7465 2068 7970 6572 2070 6172  Update hyper par
+00006680: 616d 7320 616e 6420 7374 6f72 6520 7072  ams and store pr
+00006690: 756e 6564 2068 6561 6473 0a20 2020 2020  uned heads.     
+000066a0: 2020 2073 656c 662e 6174 7465 6e74 696f     self.attentio
+000066b0: 6e2e 6e75 6d5f 6174 7465 6e74 696f 6e5f  n.num_attention_
+000066c0: 6865 6164 7320 3d20 7365 6c66 2e61 7474  heads = self.att
+000066d0: 656e 7469 6f6e 2e6e 756d 5f61 7474 656e  ention.num_atten
+000066e0: 7469 6f6e 5f68 6561 6473 202d 206c 656e  tion_heads - len
+000066f0: 2868 6561 6473 290a 2020 2020 2020 2020  (heads).        
+00006700: 7365 6c66 2e61 7474 656e 7469 6f6e 2e61  self.attention.a
+00006710: 6c6c 5f68 6561 645f 7369 7a65 203d 2073  ll_head_size = s
+00006720: 656c 662e 6174 7465 6e74 696f 6e2e 6174  elf.attention.at
+00006730: 7465 6e74 696f 6e5f 6865 6164 5f73 697a  tention_head_siz
+00006740: 6520 2a20 7365 6c66 2e61 7474 656e 7469  e * self.attenti
+00006750: 6f6e 2e6e 756d 5f61 7474 656e 7469 6f6e  on.num_attention
+00006760: 5f68 6561 6473 0a20 2020 2020 2020 2073  _heads.        s
+00006770: 656c 662e 7072 756e 6564 5f68 6561 6473  elf.pruned_heads
+00006780: 203d 2073 656c 662e 7072 756e 6564 5f68   = self.pruned_h
+00006790: 6561 6473 2e75 6e69 6f6e 2868 6561 6473  eads.union(heads
+000067a0: 290a 0a20 2020 2064 6566 2063 6f6e 7374  )..    def const
+000067b0: 7275 6374 280a 2020 2020 2020 2020 7365  ruct(.        se
+000067c0: 6c66 2c0a 2020 2020 2020 2020 6869 6464  lf,.        hidd
+000067d0: 656e 5f73 7461 7465 733a 206d 696e 6473  en_states: minds
+000067e0: 706f 7265 2e54 656e 736f 722c 0a20 2020  pore.Tensor,.   
+000067f0: 2020 2020 2061 7474 656e 7469 6f6e 5f6d       attention_m
+00006800: 6173 6b3a 204f 7074 696f 6e61 6c5b 6d69  ask: Optional[mi
+00006810: 6e64 7370 6f72 652e 5465 6e73 6f72 5d20  ndspore.Tensor] 
+00006820: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00006830: 6865 6164 5f6d 6173 6b3a 204f 7074 696f  head_mask: Optio
+00006840: 6e61 6c5b 6d69 6e64 7370 6f72 652e 5465  nal[mindspore.Te
+00006850: 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a 2020  nsor] = None,.  
+00006860: 2020 2020 2020 656e 636f 6465 725f 6869        encoder_hi
+00006870: 6464 656e 5f73 7461 7465 733a 204f 7074  dden_states: Opt
+00006880: 696f 6e61 6c5b 6d69 6e64 7370 6f72 652e  ional[mindspore.
+00006890: 5465 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a  Tensor] = None,.
+000068a0: 2020 2020 2020 2020 656e 636f 6465 725f          encoder_
+000068b0: 6174 7465 6e74 696f 6e5f 6d61 736b 3a20  attention_mask: 
+000068c0: 4f70 7469 6f6e 616c 5b6d 696e 6473 706f  Optional[mindspo
+000068d0: 7265 2e54 656e 736f 725d 203d 204e 6f6e  re.Tensor] = Non
+000068e0: 652c 0a20 2020 2020 2020 2070 6173 745f  e,.        past_
+000068f0: 6b65 795f 7661 6c75 653a 204f 7074 696f  key_value: Optio
+00006900: 6e61 6c5b 5475 706c 655b 5475 706c 655b  nal[Tuple[Tuple[
+00006910: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+00006920: 5d5d 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ]]] = None,.    
+00006930: 2020 2020 6f75 7470 7574 5f61 7474 656e      output_atten
+00006940: 7469 6f6e 733a 204f 7074 696f 6e61 6c5b  tions: Optional[
+00006950: 626f 6f6c 5d20 3d20 4661 6c73 652c 0a20  bool] = False,. 
+00006960: 2020 2029 202d 3e20 5475 706c 655b 6d69     ) -> Tuple[mi
+00006970: 6e64 7370 6f72 652e 5465 6e73 6f72 5d3a  ndspore.Tensor]:
+00006980: 0a20 2020 2020 2020 2073 656c 665f 6f75  .        self_ou
+00006990: 7470 7574 7320 3d20 7365 6c66 2e61 7474  tputs = self.att
+000069a0: 656e 7469 6f6e 280a 2020 2020 2020 2020  ention(.        
+000069b0: 2020 2020 6869 6464 656e 5f73 7461 7465      hidden_state
+000069c0: 732c 0a20 2020 2020 2020 2020 2020 2061  s,.            a
+000069d0: 7474 656e 7469 6f6e 5f6d 6173 6b2c 0a20  ttention_mask,. 
+000069e0: 2020 2020 2020 2020 2020 2068 6561 645f             head_
+000069f0: 6d61 736b 2c0a 2020 2020 2020 2020 2020  mask,.          
+00006a00: 2020 656e 636f 6465 725f 6869 6464 656e    encoder_hidden
+00006a10: 5f73 7461 7465 732c 0a20 2020 2020 2020  _states,.       
+00006a20: 2020 2020 2065 6e63 6f64 6572 5f61 7474       encoder_att
+00006a30: 656e 7469 6f6e 5f6d 6173 6b2c 0a20 2020  ention_mask,.   
+00006a40: 2020 2020 2020 2020 2070 6173 745f 6b65           past_ke
+00006a50: 795f 7661 6c75 652c 0a20 2020 2020 2020  y_value,.       
+00006a60: 2020 2020 206f 7574 7075 745f 6174 7465       output_atte
+00006a70: 6e74 696f 6e73 2c0a 2020 2020 2020 2020  ntions,.        
+00006a80: 290a 2020 2020 2020 2020 6174 7465 6e74  ).        attent
+00006a90: 696f 6e5f 6f75 7470 7574 203d 2073 656c  ion_output = sel
+00006aa0: 662e 6f75 7470 7574 2873 656c 665f 6f75  f.output(self_ou
+00006ab0: 7470 7574 735b 305d 2c20 6869 6464 656e  tputs[0], hidden
+00006ac0: 5f73 7461 7465 7329 0a20 2020 2020 2020  _states).       
+00006ad0: 206f 7574 7075 7473 203d 2028 6174 7465   outputs = (atte
+00006ae0: 6e74 696f 6e5f 6f75 7470 7574 2c29 202b  ntion_output,) +
+00006af0: 2073 656c 665f 6f75 7470 7574 735b 313a   self_outputs[1:
+00006b00: 5d20 2023 2061 6464 2061 7474 656e 7469  ]  # add attenti
+00006b10: 6f6e 7320 6966 2077 6520 6f75 7470 7574  ons if we output
+00006b20: 2074 6865 6d0a 2020 2020 2020 2020 7265   them.        re
+00006b30: 7475 726e 206f 7574 7075 7473 0a0a 0a23  turn outputs...#
+00006b40: 2043 6f70 6965 6420 6672 6f6d 2074 7261   Copied from tra
+00006b50: 6e73 666f 726d 6572 732e 6d6f 6465 6c73  nsformers.models
+00006b60: 2e62 6572 742e 6d6f 6465 6c69 6e67 5f62  .bert.modeling_b
+00006b70: 6572 742e 4265 7274 496e 7465 726d 6564  ert.BertIntermed
+00006b80: 6961 7465 2077 6974 6820 4265 7274 2d3e  iate with Bert->
+00006b90: 426c 6970 3251 466f 726d 6572 0a63 6c61  Blip2QFormer.cla
+00006ba0: 7373 2042 6c69 7032 5146 6f72 6d65 7249  ss Blip2QFormerI
+00006bb0: 6e74 6572 6d65 6469 6174 6528 6e6e 2e43  ntermediate(nn.C
+00006bc0: 656c 6c29 3a0a 2020 2020 6465 6620 5f5f  ell):.    def __
+00006bd0: 696e 6974 5f5f 2873 656c 662c 2063 6f6e  init__(self, con
+00006be0: 6669 6729 3a0a 2020 2020 2020 2020 7375  fig):.        su
+00006bf0: 7065 7228 292e 5f5f 696e 6974 5f5f 2829  per().__init__()
+00006c00: 0a20 2020 2020 2020 2073 656c 662e 6465  .        self.de
+00006c10: 6e73 6520 3d20 6e6e 2e44 656e 7365 2863  nse = nn.Dense(c
+00006c20: 6f6e 6669 672e 6869 6464 656e 5f73 697a  onfig.hidden_siz
+00006c30: 652c 2063 6f6e 6669 672e 696e 7465 726d  e, config.interm
+00006c40: 6564 6961 7465 5f73 697a 6529 0a20 2020  ediate_size).   
+00006c50: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+00006c60: 6365 2863 6f6e 6669 672e 6869 6464 656e  ce(config.hidden
+00006c70: 5f61 6374 2c20 7374 7229 3a0a 2020 2020  _act, str):.    
+00006c80: 2020 2020 2020 2020 7365 6c66 2e69 6e74          self.int
+00006c90: 6572 6d65 6469 6174 655f 6163 745f 666e  ermediate_act_fn
+00006ca0: 203d 2041 4354 3246 4e5b 636f 6e66 6967   = ACT2FN[config
+00006cb0: 2e68 6964 6465 6e5f 6163 745d 0a20 2020  .hidden_act].   
+00006cc0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00006cd0: 2020 2020 2020 2073 656c 662e 696e 7465         self.inte
+00006ce0: 726d 6564 6961 7465 5f61 6374 5f66 6e20  rmediate_act_fn 
+00006cf0: 3d20 636f 6e66 6967 2e68 6964 6465 6e5f  = config.hidden_
+00006d00: 6163 740a 0a20 2020 2064 6566 2063 6f6e  act..    def con
+00006d10: 7374 7275 6374 2873 656c 662c 2068 6964  struct(self, hid
+00006d20: 6465 6e5f 7374 6174 6573 3a20 6d69 6e64  den_states: mind
+00006d30: 7370 6f72 652e 5465 6e73 6f72 2920 2d3e  spore.Tensor) ->
+00006d40: 206d 696e 6473 706f 7265 2e54 656e 736f   mindspore.Tenso
+00006d50: 723a 0a20 2020 2020 2020 2068 6964 6465  r:.        hidde
+00006d60: 6e5f 7374 6174 6573 203d 2073 656c 662e  n_states = self.
+00006d70: 6465 6e73 6528 6869 6464 656e 5f73 7461  dense(hidden_sta
+00006d80: 7465 7329 0a20 2020 2020 2020 2068 6964  tes).        hid
+00006d90: 6465 6e5f 7374 6174 6573 203d 2073 656c  den_states = sel
+00006da0: 662e 696e 7465 726d 6564 6961 7465 5f61  f.intermediate_a
+00006db0: 6374 5f66 6e28 6869 6464 656e 5f73 7461  ct_fn(hidden_sta
+00006dc0: 7465 7329 0a20 2020 2020 2020 2072 6574  tes).        ret
+00006dd0: 7572 6e20 6869 6464 656e 5f73 7461 7465  urn hidden_state
+00006de0: 730a 0a0a 2320 436f 7069 6564 2066 726f  s...# Copied fro
+00006df0: 6d20 7472 616e 7366 6f72 6d65 7273 2e6d  m transformers.m
+00006e00: 6f64 656c 732e 6265 7274 2e6d 6f64 656c  odels.bert.model
+00006e10: 696e 675f 6265 7274 2e42 6572 744f 7574  ing_bert.BertOut
+00006e20: 7075 7420 7769 7468 2042 6572 742d 3e42  put with Bert->B
+00006e30: 6c69 7032 5146 6f72 6d65 720a 636c 6173  lip2QFormer.clas
+00006e40: 7320 426c 6970 3251 466f 726d 6572 4f75  s Blip2QFormerOu
+00006e50: 7470 7574 286e 6e2e 4365 6c6c 293a 0a20  tput(nn.Cell):. 
+00006e60: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
+00006e70: 7365 6c66 2c20 636f 6e66 6967 293a 0a20  self, config):. 
+00006e80: 2020 2020 2020 2073 7570 6572 2829 2e5f         super()._
+00006e90: 5f69 6e69 745f 5f28 290a 2020 2020 2020  _init__().      
+00006ea0: 2020 7365 6c66 2e64 656e 7365 203d 206e    self.dense = n
+00006eb0: 6e2e 4465 6e73 6528 636f 6e66 6967 2e69  n.Dense(config.i
+00006ec0: 6e74 6572 6d65 6469 6174 655f 7369 7a65  ntermediate_size
+00006ed0: 2c20 636f 6e66 6967 2e68 6964 6465 6e5f  , config.hidden_
+00006ee0: 7369 7a65 290a 2020 2020 2020 2020 7365  size).        se
+00006ef0: 6c66 2e4c 6179 6572 4e6f 726d 203d 206e  lf.LayerNorm = n
+00006f00: 6e2e 4c61 7965 724e 6f72 6d28 636f 6e66  n.LayerNorm(conf
+00006f10: 6967 2e68 6964 6465 6e5f 7369 7a65 2c20  ig.hidden_size, 
+00006f20: 6570 7369 6c6f 6e3d 636f 6e66 6967 2e6c  epsilon=config.l
+00006f30: 6179 6572 5f6e 6f72 6d5f 6570 7329 0a20  ayer_norm_eps). 
+00006f40: 2020 2020 2020 2073 656c 662e 6472 6f70         self.drop
+00006f50: 6f75 7420 3d20 6e6e 2e44 726f 706f 7574  out = nn.Dropout
+00006f60: 2870 3d63 6f6e 6669 672e 6869 6464 656e  (p=config.hidden
+00006f70: 5f64 726f 706f 7574 5f70 726f 6229 0a0a  _dropout_prob)..
+00006f80: 2020 2020 6465 6620 636f 6e73 7472 7563      def construc
+00006f90: 7428 7365 6c66 2c20 6869 6464 656e 5f73  t(self, hidden_s
+00006fa0: 7461 7465 733a 206d 696e 6473 706f 7265  tates: mindspore
+00006fb0: 2e54 656e 736f 722c 2069 6e70 7574 5f74  .Tensor, input_t
+00006fc0: 656e 736f 723a 206d 696e 6473 706f 7265  ensor: mindspore
+00006fd0: 2e54 656e 736f 7229 202d 3e20 6d69 6e64  .Tensor) -> mind
+00006fe0: 7370 6f72 652e 5465 6e73 6f72 3a0a 2020  spore.Tensor:.  
+00006ff0: 2020 2020 2020 6869 6464 656e 5f73 7461        hidden_sta
+00007000: 7465 7320 3d20 7365 6c66 2e64 656e 7365  tes = self.dense
+00007010: 2868 6964 6465 6e5f 7374 6174 6573 290a  (hidden_states).
+00007020: 2020 2020 2020 2020 6869 6464 656e 5f73          hidden_s
+00007030: 7461 7465 7320 3d20 7365 6c66 2e64 726f  tates = self.dro
+00007040: 706f 7574 2868 6964 6465 6e5f 7374 6174  pout(hidden_stat
+00007050: 6573 290a 2020 2020 2020 2020 6869 6464  es).        hidd
+00007060: 656e 5f73 7461 7465 7320 3d20 7365 6c66  en_states = self
+00007070: 2e4c 6179 6572 4e6f 726d 2868 6964 6465  .LayerNorm(hidde
+00007080: 6e5f 7374 6174 6573 202b 2069 6e70 7574  n_states + input
+00007090: 5f74 656e 736f 7229 0a20 2020 2020 2020  _tensor).       
+000070a0: 2072 6574 7572 6e20 6869 6464 656e 5f73   return hidden_s
+000070b0: 7461 7465 730a 0a0a 636c 6173 7320 426c  tates...class Bl
+000070c0: 6970 3251 466f 726d 6572 4c61 7965 7228  ip2QFormerLayer(
+000070d0: 6e6e 2e43 656c 6c29 3a0a 2020 2020 6465  nn.Cell):.    de
+000070e0: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
+000070f0: 2063 6f6e 6669 672c 206c 6179 6572 5f69   config, layer_i
+00007100: 6478 293a 0a20 2020 2020 2020 2073 7570  dx):.        sup
+00007110: 6572 2829 2e5f 5f69 6e69 745f 5f28 290a  er().__init__().
+00007120: 2020 2020 2020 2020 7365 6c66 2e63 6875          self.chu
+00007130: 6e6b 5f73 697a 655f 6665 6564 5f66 6f72  nk_size_feed_for
+00007140: 7761 7264 203d 2063 6f6e 6669 672e 6368  ward = config.ch
+00007150: 756e 6b5f 7369 7a65 5f66 6565 645f 666f  unk_size_feed_fo
+00007160: 7277 6172 640a 2020 2020 2020 2020 7365  rward.        se
+00007170: 6c66 2e73 6571 5f6c 656e 5f64 696d 203d  lf.seq_len_dim =
+00007180: 2031 0a20 2020 2020 2020 2073 656c 662e   1.        self.
+00007190: 6174 7465 6e74 696f 6e20 3d20 426c 6970  attention = Blip
+000071a0: 3251 466f 726d 6572 4174 7465 6e74 696f  2QFormerAttentio
+000071b0: 6e28 636f 6e66 6967 290a 0a20 2020 2020  n(config)..     
+000071c0: 2020 2073 656c 662e 6c61 7965 725f 6964     self.layer_id
+000071d0: 7820 3d20 6c61 7965 725f 6964 780a 0a20  x = layer_idx.. 
+000071e0: 2020 2020 2020 2069 6620 6c61 7965 725f         if layer_
+000071f0: 6964 7820 2520 636f 6e66 6967 2e63 726f  idx % config.cro
+00007200: 7373 5f61 7474 656e 7469 6f6e 5f66 7265  ss_attention_fre
+00007210: 7175 656e 6379 203d 3d20 303a 0a20 2020  quency == 0:.   
+00007220: 2020 2020 2020 2020 2073 656c 662e 6372           self.cr
+00007230: 6f73 7361 7474 656e 7469 6f6e 203d 2042  ossattention = B
+00007240: 6c69 7032 5146 6f72 6d65 7241 7474 656e  lip2QFormerAtten
+00007250: 7469 6f6e 2863 6f6e 6669 672c 2069 735f  tion(config, is_
+00007260: 6372 6f73 735f 6174 7465 6e74 696f 6e3d  cross_attention=
+00007270: 5472 7565 290a 2020 2020 2020 2020 2020  True).          
+00007280: 2020 7365 6c66 2e68 6173 5f63 726f 7373    self.has_cross
+00007290: 5f61 7474 656e 7469 6f6e 203d 2054 7275  _attention = Tru
+000072a0: 650a 2020 2020 2020 2020 656c 7365 3a0a  e.        else:.
+000072b0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000072c0: 2e68 6173 5f63 726f 7373 5f61 7474 656e  .has_cross_atten
+000072d0: 7469 6f6e 203d 2046 616c 7365 0a0a 2020  tion = False..  
+000072e0: 2020 2020 2020 7365 6c66 2e69 6e74 6572        self.inter
+000072f0: 6d65 6469 6174 655f 7175 6572 7920 3d20  mediate_query = 
+00007300: 426c 6970 3251 466f 726d 6572 496e 7465  Blip2QFormerInte
+00007310: 726d 6564 6961 7465 2863 6f6e 6669 6729  rmediate(config)
+00007320: 0a20 2020 2020 2020 2073 656c 662e 6f75  .        self.ou
+00007330: 7470 7574 5f71 7565 7279 203d 2042 6c69  tput_query = Bli
+00007340: 7032 5146 6f72 6d65 724f 7574 7075 7428  p2QFormerOutput(
+00007350: 636f 6e66 6967 290a 0a20 2020 2064 6566  config)..    def
+00007360: 2063 6f6e 7374 7275 6374 280a 2020 2020   construct(.    
+00007370: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+00007380: 2020 6869 6464 656e 5f73 7461 7465 732c    hidden_states,
+00007390: 0a20 2020 2020 2020 2061 7474 656e 7469  .        attenti
+000073a0: 6f6e 5f6d 6173 6b3d 4e6f 6e65 2c0a 2020  on_mask=None,.  
+000073b0: 2020 2020 2020 6865 6164 5f6d 6173 6b3d        head_mask=
+000073c0: 4e6f 6e65 2c0a 2020 2020 2020 2020 656e  None,.        en
+000073d0: 636f 6465 725f 6869 6464 656e 5f73 7461  coder_hidden_sta
+000073e0: 7465 733d 4e6f 6e65 2c0a 2020 2020 2020  tes=None,.      
+000073f0: 2020 656e 636f 6465 725f 6174 7465 6e74    encoder_attent
+00007400: 696f 6e5f 6d61 736b 3d4e 6f6e 652c 0a20  ion_mask=None,. 
+00007410: 2020 2020 2020 2070 6173 745f 6b65 795f         past_key_
+00007420: 7661 6c75 653d 4e6f 6e65 2c0a 2020 2020  value=None,.    
+00007430: 2020 2020 6f75 7470 7574 5f61 7474 656e      output_atten
+00007440: 7469 6f6e 733d 4661 6c73 652c 0a20 2020  tions=False,.   
+00007450: 2020 2020 2071 7565 7279 5f6c 656e 6774       query_lengt
+00007460: 683d 302c 0a20 2020 2029 3a0a 2020 2020  h=0,.    ):.    
+00007470: 2020 2020 2320 6465 636f 6465 7220 756e      # decoder un
+00007480: 692d 6469 7265 6374 696f 6e61 6c20 7365  i-directional se
+00007490: 6c66 2d61 7474 656e 7469 6f6e 2063 6163  lf-attention cac
+000074a0: 6865 6420 6b65 792f 7661 6c75 6573 2074  hed key/values t
+000074b0: 7570 6c65 2069 7320 6174 2070 6f73 6974  uple is at posit
+000074c0: 696f 6e73 2031 2c32 0a20 2020 2020 2020  ions 1,2.       
+000074d0: 2073 656c 665f 6174 746e 5f70 6173 745f   self_attn_past_
+000074e0: 6b65 795f 7661 6c75 6520 3d20 7061 7374  key_value = past
+000074f0: 5f6b 6579 5f76 616c 7565 5b3a 325d 2069  _key_value[:2] i
+00007500: 6620 7061 7374 5f6b 6579 5f76 616c 7565  f past_key_value
+00007510: 2069 7320 6e6f 7420 4e6f 6e65 2065 6c73   is not None els
+00007520: 6520 4e6f 6e65 0a20 2020 2020 2020 2073  e None.        s
+00007530: 656c 665f 6174 7465 6e74 696f 6e5f 6f75  elf_attention_ou
+00007540: 7470 7574 7320 3d20 7365 6c66 2e61 7474  tputs = self.att
+00007550: 656e 7469 6f6e 280a 2020 2020 2020 2020  ention(.        
+00007560: 2020 2020 6869 6464 656e 5f73 7461 7465      hidden_state
+00007570: 732c 0a20 2020 2020 2020 2020 2020 2061  s,.            a
+00007580: 7474 656e 7469 6f6e 5f6d 6173 6b2c 0a20  ttention_mask,. 
+00007590: 2020 2020 2020 2020 2020 2068 6561 645f             head_
+000075a0: 6d61 736b 2c0a 2020 2020 2020 2020 2020  mask,.          
+000075b0: 2020 6f75 7470 7574 5f61 7474 656e 7469    output_attenti
+000075c0: 6f6e 733d 6f75 7470 7574 5f61 7474 656e  ons=output_atten
+000075d0: 7469 6f6e 732c 0a20 2020 2020 2020 2020  tions,.         
+000075e0: 2020 2070 6173 745f 6b65 795f 7661 6c75     past_key_valu
+000075f0: 653d 7365 6c66 5f61 7474 6e5f 7061 7374  e=self_attn_past
+00007600: 5f6b 6579 5f76 616c 7565 2c0a 2020 2020  _key_value,.    
+00007610: 2020 2020 290a 2020 2020 2020 2020 6174      ).        at
+00007620: 7465 6e74 696f 6e5f 6f75 7470 7574 203d  tention_output =
+00007630: 2073 656c 665f 6174 7465 6e74 696f 6e5f   self_attention_
+00007640: 6f75 7470 7574 735b 305d 0a20 2020 2020  outputs[0].     
+00007650: 2020 206f 7574 7075 7473 203d 2073 656c     outputs = sel
+00007660: 665f 6174 7465 6e74 696f 6e5f 6f75 7470  f_attention_outp
+00007670: 7574 735b 313a 2d31 5d0a 0a20 2020 2020  uts[1:-1]..     
+00007680: 2020 2070 7265 7365 6e74 5f6b 6579 5f76     present_key_v
+00007690: 616c 7565 203d 2073 656c 665f 6174 7465  alue = self_atte
+000076a0: 6e74 696f 6e5f 6f75 7470 7574 735b 2d31  ntion_outputs[-1
+000076b0: 5d0a 0a20 2020 2020 2020 2069 6620 7175  ]..        if qu
+000076c0: 6572 795f 6c65 6e67 7468 203e 2030 3a0a  ery_length > 0:.
+000076d0: 2020 2020 2020 2020 2020 2020 7175 6572              quer
+000076e0: 795f 6174 7465 6e74 696f 6e5f 6f75 7470  y_attention_outp
+000076f0: 7574 203d 2061 7474 656e 7469 6f6e 5f6f  ut = attention_o
+00007700: 7574 7075 745b 3a2c 203a 7175 6572 795f  utput[:, :query_
+00007710: 6c65 6e67 7468 2c20 3a5d 0a0a 2020 2020  length, :]..    
+00007720: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00007730: 6861 735f 6372 6f73 735f 6174 7465 6e74  has_cross_attent
+00007740: 696f 6e3a 0a20 2020 2020 2020 2020 2020  ion:.           
+00007750: 2020 2020 2069 6620 656e 636f 6465 725f       if encoder_
+00007760: 6869 6464 656e 5f73 7461 7465 7320 6973  hidden_states is
+00007770: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00007780: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00007790: 2056 616c 7565 4572 726f 7228 2265 6e63   ValueError("enc
+000077a0: 6f64 6572 5f68 6964 6465 6e5f 7374 6174  oder_hidden_stat
+000077b0: 6573 206d 7573 7420 6265 2067 6976 656e  es must be given
+000077c0: 2066 6f72 2063 726f 7373 2d61 7474 656e   for cross-atten
+000077d0: 7469 6f6e 206c 6179 6572 7322 290a 2020  tion layers").  
+000077e0: 2020 2020 2020 2020 2020 2020 2020 6372                cr
+000077f0: 6f73 735f 6174 7465 6e74 696f 6e5f 6f75  oss_attention_ou
+00007800: 7470 7574 7320 3d20 7365 6c66 2e63 726f  tputs = self.cro
+00007810: 7373 6174 7465 6e74 696f 6e28 0a20 2020  ssattention(.   
+00007820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007830: 2071 7565 7279 5f61 7474 656e 7469 6f6e   query_attention
+00007840: 5f6f 7574 7075 742c 0a20 2020 2020 2020  _output,.       
+00007850: 2020 2020 2020 2020 2020 2020 2061 7474               att
+00007860: 656e 7469 6f6e 5f6d 6173 6b2c 0a20 2020  ention_mask,.   
+00007870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007880: 2068 6561 645f 6d61 736b 2c0a 2020 2020   head_mask,.    
+00007890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000078a0: 656e 636f 6465 725f 6869 6464 656e 5f73  encoder_hidden_s
+000078b0: 7461 7465 732c 0a20 2020 2020 2020 2020  tates,.         
+000078c0: 2020 2020 2020 2020 2020 2065 6e63 6f64             encod
+000078d0: 6572 5f61 7474 656e 7469 6f6e 5f6d 6173  er_attention_mas
+000078e0: 6b2c 0a20 2020 2020 2020 2020 2020 2020  k,.             
+000078f0: 2020 2020 2020 206f 7574 7075 745f 6174         output_at
+00007900: 7465 6e74 696f 6e73 3d6f 7574 7075 745f  tentions=output_
+00007910: 6174 7465 6e74 696f 6e73 2c0a 2020 2020  attentions,.    
+00007920: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00007930: 2020 2020 2020 2020 2020 2020 2020 7175                qu
+00007940: 6572 795f 6174 7465 6e74 696f 6e5f 6f75  ery_attention_ou
+00007950: 7470 7574 203d 2063 726f 7373 5f61 7474  tput = cross_att
+00007960: 656e 7469 6f6e 5f6f 7574 7075 7473 5b30  ention_outputs[0
+00007970: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00007980: 2020 2320 6164 6420 6372 6f73 7320 6174    # add cross at
+00007990: 7465 6e74 696f 6e73 2069 6620 7765 206f  tentions if we o
+000079a0: 7574 7075 7420 6174 7465 6e74 696f 6e20  utput attention 
+000079b0: 7765 6967 6874 730a 2020 2020 2020 2020  weights.        
+000079c0: 2020 2020 2020 2020 6f75 7470 7574 7320          outputs 
+000079d0: 3d20 6f75 7470 7574 7320 2b20 6372 6f73  = outputs + cros
+000079e0: 735f 6174 7465 6e74 696f 6e5f 6f75 7470  s_attention_outp
+000079f0: 7574 735b 313a 2d31 5d0a 0a20 2020 2020  uts[1:-1]..     
+00007a00: 2020 2020 2020 206c 6179 6572 5f6f 7574         layer_out
+00007a10: 7075 7420 3d20 6170 706c 795f 6368 756e  put = apply_chun
+00007a20: 6b69 6e67 5f74 6f5f 666f 7277 6172 6428  king_to_forward(
+00007a30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007a40: 2073 656c 662e 6665 6564 5f66 6f72 7761   self.feed_forwa
+00007a50: 7264 5f63 6875 6e6b 5f71 7565 7279 2c0a  rd_chunk_query,.
+00007a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007a70: 7365 6c66 2e63 6875 6e6b 5f73 697a 655f  self.chunk_size_
+00007a80: 6665 6564 5f66 6f72 7761 7264 2c0a 2020  feed_forward,.  
+00007a90: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00007aa0: 6c66 2e73 6571 5f6c 656e 5f64 696d 2c0a  lf.seq_len_dim,.
+00007ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007ac0: 7175 6572 795f 6174 7465 6e74 696f 6e5f  query_attention_
+00007ad0: 6f75 7470 7574 2c0a 2020 2020 2020 2020  output,.        
+00007ae0: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+00007af0: 2020 2069 6620 6174 7465 6e74 696f 6e5f     if attention_
+00007b00: 6f75 7470 7574 2e73 6861 7065 5b31 5d20  output.shape[1] 
+00007b10: 3e20 7175 6572 795f 6c65 6e67 7468 3a0a  > query_length:.
+00007b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007b30: 6c61 7965 725f 6f75 7470 7574 5f74 6578  layer_output_tex
+00007b40: 7420 3d20 6170 706c 795f 6368 756e 6b69  t = apply_chunki
+00007b50: 6e67 5f74 6f5f 666f 7277 6172 6428 0a20  ng_to_forward(. 
+00007b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007b70: 2020 2073 656c 662e 6665 6564 5f66 6f72     self.feed_for
+00007b80: 7761 7264 5f63 6875 6e6b 2c0a 2020 2020  ward_chunk,.    
+00007b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007ba0: 7365 6c66 2e63 6875 6e6b 5f73 697a 655f  self.chunk_size_
+00007bb0: 6665 6564 5f66 6f72 7761 7264 2c0a 2020  feed_forward,.  
+00007bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007bd0: 2020 7365 6c66 2e73 6571 5f6c 656e 5f64    self.seq_len_d
+00007be0: 696d 2c0a 2020 2020 2020 2020 2020 2020  im,.            
+00007bf0: 2020 2020 2020 2020 6174 7465 6e74 696f          attentio
+00007c00: 6e5f 6f75 7470 7574 5b3a 2c20 7175 6572  n_output[:, quer
+00007c10: 795f 6c65 6e67 7468 3a2c 203a 5d2c 0a20  y_length:, :],. 
+00007c20: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00007c30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007c40: 206c 6179 6572 5f6f 7574 7075 7420 3d20   layer_output = 
+00007c50: 6f70 732e 6361 7428 5b6c 6179 6572 5f6f  ops.cat([layer_o
+00007c60: 7574 7075 742c 206c 6179 6572 5f6f 7574  utput, layer_out
+00007c70: 7075 745f 7465 7874 5d2c 2061 7869 733d  put_text], axis=
+00007c80: 3129 0a20 2020 2020 2020 2065 6c73 653a  1).        else:
+00007c90: 0a20 2020 2020 2020 2020 2020 206c 6179  .            lay
+00007ca0: 6572 5f6f 7574 7075 7420 3d20 6170 706c  er_output = appl
+00007cb0: 795f 6368 756e 6b69 6e67 5f74 6f5f 666f  y_chunking_to_fo
+00007cc0: 7277 6172 6428 0a20 2020 2020 2020 2020  rward(.         
+00007cd0: 2020 2020 2020 2073 656c 662e 6665 6564         self.feed
+00007ce0: 5f66 6f72 7761 7264 5f63 6875 6e6b 2c0a  _forward_chunk,.
+00007cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007d00: 7365 6c66 2e63 6875 6e6b 5f73 697a 655f  self.chunk_size_
+00007d10: 6665 6564 5f66 6f72 7761 7264 2c0a 2020  feed_forward,.  
+00007d20: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00007d30: 6c66 2e73 6571 5f6c 656e 5f64 696d 2c0a  lf.seq_len_dim,.
+00007d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007d50: 6174 7465 6e74 696f 6e5f 6f75 7470 7574  attention_output
+00007d60: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+00007d70: 2020 2020 2020 2020 6f75 7470 7574 7320          outputs 
+00007d80: 3d20 286c 6179 6572 5f6f 7574 7075 742c  = (layer_output,
+00007d90: 2920 2b20 6f75 7470 7574 730a 0a20 2020  ) + outputs..   
+00007da0: 2020 2020 206f 7574 7075 7473 203d 206f       outputs = o
+00007db0: 7574 7075 7473 202b 2028 7072 6573 656e  utputs + (presen
+00007dc0: 745f 6b65 795f 7661 6c75 652c 290a 0a20  t_key_value,).. 
+00007dd0: 2020 2020 2020 2072 6574 7572 6e20 6f75         return ou
+00007de0: 7470 7574 730a 0a20 2020 2064 6566 2066  tputs..    def f
+00007df0: 6565 645f 666f 7277 6172 645f 6368 756e  eed_forward_chun
+00007e00: 6b28 7365 6c66 2c20 6174 7465 6e74 696f  k(self, attentio
+00007e10: 6e5f 6f75 7470 7574 293a 0a20 2020 2020  n_output):.     
+00007e20: 2020 2069 6e74 6572 6d65 6469 6174 655f     intermediate_
+00007e30: 6f75 7470 7574 203d 2073 656c 662e 696e  output = self.in
+00007e40: 7465 726d 6564 6961 7465 2861 7474 656e  termediate(atten
+00007e50: 7469 6f6e 5f6f 7574 7075 7429 0a20 2020  tion_output).   
+00007e60: 2020 2020 206c 6179 6572 5f6f 7574 7075       layer_outpu
+00007e70: 7420 3d20 7365 6c66 2e6f 7574 7075 7428  t = self.output(
+00007e80: 696e 7465 726d 6564 6961 7465 5f6f 7574  intermediate_out
+00007e90: 7075 742c 2061 7474 656e 7469 6f6e 5f6f  put, attention_o
+00007ea0: 7574 7075 7429 0a20 2020 2020 2020 2072  utput).        r
+00007eb0: 6574 7572 6e20 6c61 7965 725f 6f75 7470  eturn layer_outp
+00007ec0: 7574 0a0a 2020 2020 6465 6620 6665 6564  ut..    def feed
+00007ed0: 5f66 6f72 7761 7264 5f63 6875 6e6b 5f71  _forward_chunk_q
+00007ee0: 7565 7279 2873 656c 662c 2061 7474 656e  uery(self, atten
+00007ef0: 7469 6f6e 5f6f 7574 7075 7429 3a0a 2020  tion_output):.  
+00007f00: 2020 2020 2020 696e 7465 726d 6564 6961        intermedia
+00007f10: 7465 5f6f 7574 7075 7420 3d20 7365 6c66  te_output = self
+00007f20: 2e69 6e74 6572 6d65 6469 6174 655f 7175  .intermediate_qu
+00007f30: 6572 7928 6174 7465 6e74 696f 6e5f 6f75  ery(attention_ou
+00007f40: 7470 7574 290a 2020 2020 2020 2020 6c61  tput).        la
+00007f50: 7965 725f 6f75 7470 7574 203d 2073 656c  yer_output = sel
+00007f60: 662e 6f75 7470 7574 5f71 7565 7279 2869  f.output_query(i
+00007f70: 6e74 6572 6d65 6469 6174 655f 6f75 7470  ntermediate_outp
+00007f80: 7574 2c20 6174 7465 6e74 696f 6e5f 6f75  ut, attention_ou
+00007f90: 7470 7574 290a 2020 2020 2020 2020 7265  tput).        re
+00007fa0: 7475 726e 206c 6179 6572 5f6f 7574 7075  turn layer_outpu
+00007fb0: 740a 0a0a 636c 6173 7320 426c 6970 3251  t...class Blip2Q
+00007fc0: 466f 726d 6572 456e 636f 6465 7228 6e6e  FormerEncoder(nn
+00007fd0: 2e43 656c 6c29 3a0a 2020 2020 6465 6620  .Cell):.    def 
+00007fe0: 5f5f 696e 6974 5f5f 2873 656c 662c 2063  __init__(self, c
+00007ff0: 6f6e 6669 6729 3a0a 2020 2020 2020 2020  onfig):.        
+00008000: 7375 7065 7228 292e 5f5f 696e 6974 5f5f  super().__init__
+00008010: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
+00008020: 636f 6e66 6967 203d 2063 6f6e 6669 670a  config = config.
+00008030: 2020 2020 2020 2020 7365 6c66 2e6c 6179          self.lay
+00008040: 6572 203d 206e 6e2e 4365 6c6c 4c69 7374  er = nn.CellList
+00008050: 280a 2020 2020 2020 2020 2020 2020 5b42  (.            [B
+00008060: 6c69 7032 5146 6f72 6d65 724c 6179 6572  lip2QFormerLayer
+00008070: 2863 6f6e 6669 672c 206c 6179 6572 5f69  (config, layer_i
+00008080: 6478 2920 666f 7220 6c61 7965 725f 6964  dx) for layer_id
+00008090: 7820 696e 2072 616e 6765 2863 6f6e 6669  x in range(confi
+000080a0: 672e 6e75 6d5f 6869 6464 656e 5f6c 6179  g.num_hidden_lay
+000080b0: 6572 7329 5d0a 2020 2020 2020 2020 290a  ers)].        ).
+000080c0: 2020 2020 2020 2020 7365 6c66 2e67 7261          self.gra
+000080d0: 6469 656e 745f 6368 6563 6b70 6f69 6e74  dient_checkpoint
+000080e0: 696e 6720 3d20 4661 6c73 650a 0a20 2020  ing = False..   
+000080f0: 2064 6566 2063 6f6e 7374 7275 6374 280a   def construct(.
+00008100: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+00008110: 2020 2020 2020 6869 6464 656e 5f73 7461        hidden_sta
+00008120: 7465 732c 0a20 2020 2020 2020 2061 7474  tes,.        att
+00008130: 656e 7469 6f6e 5f6d 6173 6b3d 4e6f 6e65  ention_mask=None
+00008140: 2c0a 2020 2020 2020 2020 6865 6164 5f6d  ,.        head_m
+00008150: 6173 6b3d 4e6f 6e65 2c0a 2020 2020 2020  ask=None,.      
+00008160: 2020 656e 636f 6465 725f 6869 6464 656e    encoder_hidden
+00008170: 5f73 7461 7465 733d 4e6f 6e65 2c0a 2020  _states=None,.  
+00008180: 2020 2020 2020 656e 636f 6465 725f 6174        encoder_at
+00008190: 7465 6e74 696f 6e5f 6d61 736b 3d4e 6f6e  tention_mask=Non
+000081a0: 652c 0a20 2020 2020 2020 2070 6173 745f  e,.        past_
+000081b0: 6b65 795f 7661 6c75 6573 3d4e 6f6e 652c  key_values=None,
+000081c0: 0a20 2020 2020 2020 2075 7365 5f63 6163  .        use_cac
+000081d0: 6865 3d4e 6f6e 652c 0a20 2020 2020 2020  he=None,.       
+000081e0: 206f 7574 7075 745f 6174 7465 6e74 696f   output_attentio
+000081f0: 6e73 3d46 616c 7365 2c0a 2020 2020 2020  ns=False,.      
+00008200: 2020 6f75 7470 7574 5f68 6964 6465 6e5f    output_hidden_
+00008210: 7374 6174 6573 3d46 616c 7365 2c0a 2020  states=False,.  
+00008220: 2020 2020 2020 7265 7475 726e 5f64 6963        return_dic
+00008230: 743d 5472 7565 2c0a 2020 2020 2020 2020  t=True,.        
+00008240: 7175 6572 795f 6c65 6e67 7468 3d30 2c0a  query_length=0,.
+00008250: 2020 2020 293a 0a20 2020 2020 2020 2061      ):.        a
+00008260: 6c6c 5f68 6964 6465 6e5f 7374 6174 6573  ll_hidden_states
+00008270: 203d 2028 2920 6966 206f 7574 7075 745f   = () if output_
+00008280: 6869 6464 656e 5f73 7461 7465 7320 656c  hidden_states el
+00008290: 7365 204e 6f6e 650a 2020 2020 2020 2020  se None.        
+000082a0: 616c 6c5f 7365 6c66 5f61 7474 656e 7469  all_self_attenti
+000082b0: 6f6e 7320 3d20 2829 2069 6620 6f75 7470  ons = () if outp
+000082c0: 7574 5f61 7474 656e 7469 6f6e 7320 656c  ut_attentions el
+000082d0: 7365 204e 6f6e 650a 2020 2020 2020 2020  se None.        
+000082e0: 616c 6c5f 6372 6f73 735f 6174 7465 6e74  all_cross_attent
+000082f0: 696f 6e73 203d 2028 2920 6966 206f 7574  ions = () if out
+00008300: 7075 745f 6174 7465 6e74 696f 6e73 2065  put_attentions e
+00008310: 6c73 6520 4e6f 6e65 0a0a 2020 2020 2020  lse None..      
+00008320: 2020 6e65 7874 5f64 6563 6f64 6572 5f63    next_decoder_c
+00008330: 6163 6865 203d 2028 2920 6966 2075 7365  ache = () if use
+00008340: 5f63 6163 6865 2065 6c73 6520 4e6f 6e65  _cache else None
+00008350: 0a0a 2020 2020 2020 2020 666f 7220 6920  ..        for i 
+00008360: 696e 2072 616e 6765 2873 656c 662e 636f  in range(self.co
+00008370: 6e66 6967 2e6e 756d 5f68 6964 6465 6e5f  nfig.num_hidden_
+00008380: 6c61 7965 7273 293a 0a20 2020 2020 2020  layers):.       
+00008390: 2020 2020 206c 6179 6572 5f6d 6f64 756c       layer_modul
+000083a0: 6520 3d20 7365 6c66 2e6c 6179 6572 5b69  e = self.layer[i
+000083b0: 5d0a 2020 2020 2020 2020 2020 2020 6966  ].            if
+000083c0: 206f 7574 7075 745f 6869 6464 656e 5f73   output_hidden_s
+000083d0: 7461 7465 733a 0a20 2020 2020 2020 2020  tates:.         
+000083e0: 2020 2020 2020 2061 6c6c 5f68 6964 6465         all_hidde
+000083f0: 6e5f 7374 6174 6573 203d 2061 6c6c 5f68  n_states = all_h
+00008400: 6964 6465 6e5f 7374 6174 6573 202b 2028  idden_states + (
+00008410: 6869 6464 656e 5f73 7461 7465 732c 290a  hidden_states,).
+00008420: 0a20 2020 2020 2020 2020 2020 206c 6179  .            lay
+00008430: 6572 5f68 6561 645f 6d61 736b 203d 2068  er_head_mask = h
+00008440: 6561 645f 6d61 736b 5b69 5d20 6966 2068  ead_mask[i] if h
+00008450: 6561 645f 6d61 736b 2069 7320 6e6f 7420  ead_mask is not 
+00008460: 4e6f 6e65 2065 6c73 6520 4e6f 6e65 0a20  None else None. 
+00008470: 2020 2020 2020 2020 2020 2070 6173 745f             past_
+00008480: 6b65 795f 7661 6c75 6520 3d20 7061 7374  key_value = past
+00008490: 5f6b 6579 5f76 616c 7565 735b 695d 2069  _key_values[i] i
+000084a0: 6620 7061 7374 5f6b 6579 5f76 616c 7565  f past_key_value
+000084b0: 7320 6973 206e 6f74 204e 6f6e 6520 656c  s is not None el
+000084c0: 7365 204e 6f6e 650a 0a20 2020 2020 2020  se None..       
+000084d0: 2020 2020 2069 6620 6765 7461 7474 7228       if getattr(
+000084e0: 7365 6c66 2e63 6f6e 6669 672c 2022 6772  self.config, "gr
+000084f0: 6164 6965 6e74 5f63 6865 636b 706f 696e  adient_checkpoin
+00008500: 7469 6e67 222c 2046 616c 7365 2920 616e  ting", False) an
+00008510: 6420 7365 6c66 2e74 7261 696e 696e 673a  d self.training:
+00008520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008530: 2069 6620 7573 655f 6361 6368 653a 0a20   if use_cache:. 
+00008540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008550: 2020 206c 6f67 6765 722e 7761 726e 696e     logger.warnin
+00008560: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
+00008570: 2020 2020 2020 2020 2020 2022 6075 7365             "`use
+00008580: 5f63 6163 6865 3d54 7275 6560 2069 7320  _cache=True` is 
+00008590: 696e 636f 6d70 6174 6962 6c65 2077 6974  incompatible wit
+000085a0: 6820 6772 6164 6965 6e74 2063 6865 636b  h gradient check
+000085b0: 706f 696e 7469 6e67 2e20 5365 7474 696e  pointing. Settin
+000085c0: 6720 6075 7365 5f63 6163 6865 3d46 616c  g `use_cache=Fal
+000085d0: 7365 602e 2e2e 220a 2020 2020 2020 2020  se`...".        
+000085e0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+000085f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008600: 2020 7573 655f 6361 6368 6520 3d20 4661    use_cache = Fa
+00008610: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
+00008620: 2020 2020 6c61 7965 725f 6f75 7470 7574      layer_output
+00008630: 7320 3d20 7365 6c66 2e5f 6772 6164 6965  s = self._gradie
+00008640: 6e74 5f63 6865 636b 706f 696e 7469 6e67  nt_checkpointing
+00008650: 5f66 756e 6328 0a20 2020 2020 2020 2020  _func(.         
+00008660: 2020 2020 2020 2020 2020 206c 6179 6572             layer
+00008670: 5f6d 6f64 756c 652e 5f5f 6361 6c6c 5f5f  _module.__call__
+00008680: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00008690: 2020 2020 2020 6869 6464 656e 5f73 7461        hidden_sta
+000086a0: 7465 732c 0a20 2020 2020 2020 2020 2020  tes,.           
+000086b0: 2020 2020 2020 2020 2061 7474 656e 7469           attenti
+000086c0: 6f6e 5f6d 6173 6b2c 0a20 2020 2020 2020  on_mask,.       
+000086d0: 2020 2020 2020 2020 2020 2020 206c 6179               lay
+000086e0: 6572 5f68 6561 645f 6d61 736b 2c0a 2020  er_head_mask,.  
+000086f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008700: 2020 656e 636f 6465 725f 6869 6464 656e    encoder_hidden
+00008710: 5f73 7461 7465 732c 0a20 2020 2020 2020  _states,.       
+00008720: 2020 2020 2020 2020 2020 2020 2065 6e63               enc
+00008730: 6f64 6572 5f61 7474 656e 7469 6f6e 5f6d  oder_attention_m
+00008740: 6173 6b2c 0a20 2020 2020 2020 2020 2020  ask,.           
+00008750: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00008760: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00008770: 2020 2020 2020 2020 206c 6179 6572 5f6f           layer_o
+00008780: 7574 7075 7473 203d 206c 6179 6572 5f6d  utputs = layer_m
+00008790: 6f64 756c 6528 0a20 2020 2020 2020 2020  odule(.         
+000087a0: 2020 2020 2020 2020 2020 2068 6964 6465             hidde
+000087b0: 6e5f 7374 6174 6573 2c0a 2020 2020 2020  n_states,.      
+000087c0: 2020 2020 2020 2020 2020 2020 2020 6174                at
+000087d0: 7465 6e74 696f 6e5f 6d61 736b 2c0a 2020  tention_mask,.  
+000087e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000087f0: 2020 6c61 7965 725f 6865 6164 5f6d 6173    layer_head_mas
+00008800: 6b2c 0a20 2020 2020 2020 2020 2020 2020  k,.             
+00008810: 2020 2020 2020 2065 6e63 6f64 6572 5f68         encoder_h
+00008820: 6964 6465 6e5f 7374 6174 6573 2c0a 2020  idden_states,.  
+00008830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008840: 2020 656e 636f 6465 725f 6174 7465 6e74    encoder_attent
+00008850: 696f 6e5f 6d61 736b 2c0a 2020 2020 2020  ion_mask,.      
+00008860: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+00008870: 7374 5f6b 6579 5f76 616c 7565 2c0a 2020  st_key_value,.  
+00008880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008890: 2020 6f75 7470 7574 5f61 7474 656e 7469    output_attenti
+000088a0: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
+000088b0: 2020 2020 2020 2020 2071 7565 7279 5f6c           query_l
+000088c0: 656e 6774 682c 0a20 2020 2020 2020 2020  ength,.         
+000088d0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+000088e0: 2020 2020 2020 6869 6464 656e 5f73 7461        hidden_sta
+000088f0: 7465 7320 3d20 6c61 7965 725f 6f75 7470  tes = layer_outp
+00008900: 7574 735b 305d 0a20 2020 2020 2020 2020  uts[0].         
+00008910: 2020 2069 6620 7573 655f 6361 6368 653a     if use_cache:
+00008920: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008930: 206e 6578 745f 6465 636f 6465 725f 6361   next_decoder_ca
+00008940: 6368 6520 2b3d 2028 6c61 7965 725f 6f75  che += (layer_ou
+00008950: 7470 7574 735b 2d31 5d2c 290a 2020 2020  tputs[-1],).    
+00008960: 2020 2020 2020 2020 6966 206f 7574 7075          if outpu
+00008970: 745f 6174 7465 6e74 696f 6e73 3a0a 2020  t_attentions:.  
+00008980: 2020 2020 2020 2020 2020 2020 2020 616c                al
+00008990: 6c5f 7365 6c66 5f61 7474 656e 7469 6f6e  l_self_attention
+000089a0: 7320 3d20 616c 6c5f 7365 6c66 5f61 7474  s = all_self_att
+000089b0: 656e 7469 6f6e 7320 2b20 286c 6179 6572  entions + (layer
+000089c0: 5f6f 7574 7075 7473 5b31 5d2c 290a 2020  _outputs[1],).  
+000089d0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+000089e0: 206c 6179 6572 5f6d 6f64 756c 652e 6861   layer_module.ha
+000089f0: 735f 6372 6f73 735f 6174 7465 6e74 696f  s_cross_attentio
+00008a00: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
+00008a10: 2020 2020 2020 2061 6c6c 5f63 726f 7373         all_cross
+00008a20: 5f61 7474 656e 7469 6f6e 7320 3d20 616c  _attentions = al
+00008a30: 6c5f 6372 6f73 735f 6174 7465 6e74 696f  l_cross_attentio
+00008a40: 6e73 202b 2028 6c61 7965 725f 6f75 7470  ns + (layer_outp
+00008a50: 7574 735b 325d 2c29 0a0a 2020 2020 2020  uts[2],)..      
+00008a60: 2020 6966 206f 7574 7075 745f 6869 6464    if output_hidd
+00008a70: 656e 5f73 7461 7465 733a 0a20 2020 2020  en_states:.     
+00008a80: 2020 2020 2020 2061 6c6c 5f68 6964 6465         all_hidde
+00008a90: 6e5f 7374 6174 6573 203d 2061 6c6c 5f68  n_states = all_h
+00008aa0: 6964 6465 6e5f 7374 6174 6573 202b 2028  idden_states + (
+00008ab0: 6869 6464 656e 5f73 7461 7465 732c 290a  hidden_states,).
+00008ac0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+00008ad0: 7265 7475 726e 5f64 6963 743a 0a20 2020  return_dict:.   
+00008ae0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00008af0: 7475 706c 6528 0a20 2020 2020 2020 2020  tuple(.         
+00008b00: 2020 2020 2020 2076 0a20 2020 2020 2020         v.       
+00008b10: 2020 2020 2020 2020 2066 6f72 2076 2069           for v i
+00008b20: 6e20 5b0a 2020 2020 2020 2020 2020 2020  n [.            
+00008b30: 2020 2020 2020 2020 6869 6464 656e 5f73          hidden_s
+00008b40: 7461 7465 732c 0a20 2020 2020 2020 2020  tates,.         
+00008b50: 2020 2020 2020 2020 2020 206e 6578 745f             next_
+00008b60: 6465 636f 6465 725f 6361 6368 652c 0a20  decoder_cache,. 
+00008b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008b80: 2020 2061 6c6c 5f68 6964 6465 6e5f 7374     all_hidden_st
+00008b90: 6174 6573 2c0a 2020 2020 2020 2020 2020  ates,.          
+00008ba0: 2020 2020 2020 2020 2020 616c 6c5f 7365            all_se
+00008bb0: 6c66 5f61 7474 656e 7469 6f6e 732c 0a20  lf_attentions,. 
+00008bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008bd0: 2020 2061 6c6c 5f63 726f 7373 5f61 7474     all_cross_att
+00008be0: 656e 7469 6f6e 732c 0a20 2020 2020 2020  entions,.       
+00008bf0: 2020 2020 2020 2020 205d 0a20 2020 2020           ].     
+00008c00: 2020 2020 2020 2020 2020 2069 6620 7620             if v 
+00008c10: 6973 206e 6f74 204e 6f6e 650a 2020 2020  is not None.    
+00008c20: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00008c30: 2020 7265 7475 726e 2042 6173 654d 6f64    return BaseMod
+00008c40: 656c 4f75 7470 7574 5769 7468 5061 7374  elOutputWithPast
+00008c50: 416e 6443 726f 7373 4174 7465 6e74 696f  AndCrossAttentio
+00008c60: 6e73 280a 2020 2020 2020 2020 2020 2020  ns(.            
+00008c70: 6c61 7374 5f68 6964 6465 6e5f 7374 6174  last_hidden_stat
+00008c80: 653d 6869 6464 656e 5f73 7461 7465 732c  e=hidden_states,
+00008c90: 0a20 2020 2020 2020 2020 2020 2070 6173  .            pas
+00008ca0: 745f 6b65 795f 7661 6c75 6573 3d6e 6578  t_key_values=nex
+00008cb0: 745f 6465 636f 6465 725f 6361 6368 652c  t_decoder_cache,
+00008cc0: 0a20 2020 2020 2020 2020 2020 2068 6964  .            hid
+00008cd0: 6465 6e5f 7374 6174 6573 3d61 6c6c 5f68  den_states=all_h
+00008ce0: 6964 6465 6e5f 7374 6174 6573 2c0a 2020  idden_states,.  
+00008cf0: 2020 2020 2020 2020 2020 6174 7465 6e74            attent
+00008d00: 696f 6e73 3d61 6c6c 5f73 656c 665f 6174  ions=all_self_at
+00008d10: 7465 6e74 696f 6e73 2c0a 2020 2020 2020  tentions,.      
+00008d20: 2020 2020 2020 6372 6f73 735f 6174 7465        cross_atte
+00008d30: 6e74 696f 6e73 3d61 6c6c 5f63 726f 7373  ntions=all_cross
+00008d40: 5f61 7474 656e 7469 6f6e 732c 0a20 2020  _attentions,.   
+00008d50: 2020 2020 2029 0a0a 0a63 6c61 7373 2042       )...class B
+00008d60: 6c69 7032 5146 6f72 6d65 724d 6f64 656c  lip2QFormerModel
+00008d70: 2842 6c69 7032 5072 6554 7261 696e 6564  (Blip2PreTrained
+00008d80: 4d6f 6465 6c29 3a0a 2020 2020 2222 220a  Model):.    """.
+00008d90: 2020 2020 5175 6572 7969 6e67 2054 7261      Querying Tra
+00008da0: 6e73 666f 726d 6572 2028 512d 466f 726d  nsformer (Q-Form
+00008db0: 6572 292c 2075 7365 6420 696e 2042 4c49  er), used in BLI
+00008dc0: 502d 322e 0a20 2020 2022 2222 0a0a 2020  P-2..    """..  
+00008dd0: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
+00008de0: 656c 662c 2063 6f6e 6669 673a 2042 6c69  elf, config: Bli
+00008df0: 7032 5146 6f72 6d65 7243 6f6e 6669 6729  p2QFormerConfig)
+00008e00: 3a0a 2020 2020 2020 2020 7375 7065 7228  :.        super(
+00008e10: 292e 5f5f 696e 6974 5f5f 2863 6f6e 6669  ).__init__(confi
+00008e20: 6729 0a20 2020 2020 2020 2073 656c 662e  g).        self.
+00008e30: 636f 6e66 6967 203d 2063 6f6e 6669 670a  config = config.
+00008e40: 0a20 2020 2020 2020 2073 656c 662e 6c61  .        self.la
+00008e50: 7965 726e 6f72 6d20 3d20 6e6e 2e4c 6179  yernorm = nn.Lay
+00008e60: 6572 4e6f 726d 2863 6f6e 6669 672e 6869  erNorm(config.hi
+00008e70: 6464 656e 5f73 697a 652c 2065 7073 696c  dden_size, epsil
+00008e80: 6f6e 3d63 6f6e 6669 672e 6c61 7965 725f  on=config.layer_
+00008e90: 6e6f 726d 5f65 7073 290a 2020 2020 2020  norm_eps).      
+00008ea0: 2020 7365 6c66 2e64 726f 706f 7574 203d    self.dropout =
+00008eb0: 206e 6e2e 4472 6f70 6f75 7428 703d 636f   nn.Dropout(p=co
+00008ec0: 6e66 6967 2e68 6964 6465 6e5f 6472 6f70  nfig.hidden_drop
+00008ed0: 6f75 745f 7072 6f62 290a 0a20 2020 2020  out_prob)..     
+00008ee0: 2020 2073 656c 662e 656e 636f 6465 7220     self.encoder 
+00008ef0: 3d20 426c 6970 3251 466f 726d 6572 456e  = Blip2QFormerEn
+00008f00: 636f 6465 7228 636f 6e66 6967 290a 0a20  coder(config).. 
+00008f10: 2020 2020 2020 2073 656c 662e 706f 7374         self.post
+00008f20: 5f69 6e69 7428 290a 0a20 2020 2064 6566  _init()..    def
+00008f30: 2067 6574 5f69 6e70 7574 5f65 6d62 6564   get_input_embed
+00008f40: 6469 6e67 7328 7365 6c66 293a 0a20 2020  dings(self):.   
+00008f50: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+00008f60: 2e65 6d62 6564 6469 6e67 732e 776f 7264  .embeddings.word
+00008f70: 5f65 6d62 6564 6469 6e67 730a 0a20 2020  _embeddings..   
+00008f80: 2064 6566 2073 6574 5f69 6e70 7574 5f65   def set_input_e
+00008f90: 6d62 6564 6469 6e67 7328 7365 6c66 2c20  mbeddings(self, 
+00008fa0: 7661 6c75 6529 3a0a 2020 2020 2020 2020  value):.        
+00008fb0: 7365 6c66 2e65 6d62 6564 6469 6e67 732e  self.embeddings.
+00008fc0: 776f 7264 5f65 6d62 6564 6469 6e67 7320  word_embeddings 
+00008fd0: 3d20 7661 6c75 650a 0a20 2020 2064 6566  = value..    def
+00008fe0: 205f 7072 756e 655f 6865 6164 7328 7365   _prune_heads(se
+00008ff0: 6c66 2c20 6865 6164 735f 746f 5f70 7275  lf, heads_to_pru
+00009000: 6e65 293a 0a20 2020 2020 2020 2022 2222  ne):.        """
+00009010: 0a20 2020 2020 2020 2050 7275 6e65 7320  .        Prunes 
+00009020: 6865 6164 7320 6f66 2074 6865 206d 6f64  heads of the mod
+00009030: 656c 2e20 6865 6164 735f 746f 5f70 7275  el. heads_to_pru
+00009040: 6e65 3a20 6469 6374 206f 6620 7b6c 6179  ne: dict of {lay
+00009050: 6572 5f6e 756d 3a20 6c69 7374 206f 6620  er_num: list of 
+00009060: 6865 6164 7320 746f 2070 7275 6e65 2069  heads to prune i
+00009070: 6e20 7468 6973 206c 6179 6572 7d20 5365  n this layer} Se
+00009080: 6520 6261 7365 0a20 2020 2020 2020 2063  e base.        c
+00009090: 6c61 7373 2050 7265 5472 6169 6e65 644d  lass PreTrainedM
+000090a0: 6f64 656c 0a20 2020 2020 2020 2022 2222  odel.        """
+000090b0: 0a20 2020 2020 2020 2066 6f72 206c 6179  .        for lay
+000090c0: 6572 2c20 6865 6164 7320 696e 2068 6561  er, heads in hea
+000090d0: 6473 5f74 6f5f 7072 756e 652e 6974 656d  ds_to_prune.item
+000090e0: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+000090f0: 2073 656c 662e 656e 636f 6465 722e 6c61   self.encoder.la
+00009100: 7965 725b 6c61 7965 725d 2e61 7474 656e  yer[layer].atten
+00009110: 7469 6f6e 2e70 7275 6e65 5f68 6561 6473  tion.prune_heads
+00009120: 2868 6561 6473 290a 0a20 2020 2064 6566  (heads)..    def
+00009130: 2067 6574 5f65 7874 656e 6465 645f 6174   get_extended_at
+00009140: 7465 6e74 696f 6e5f 6d61 736b 280a 2020  tention_mask(.  
+00009150: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+00009160: 2020 2020 6174 7465 6e74 696f 6e5f 6d61      attention_ma
+00009170: 736b 3a20 6d69 6e64 7370 6f72 652e 5465  sk: mindspore.Te
+00009180: 6e73 6f72 2c0a 2020 2020 2020 2020 696e  nsor,.        in
+00009190: 7075 745f 7368 6170 653a 2054 7570 6c65  put_shape: Tuple
+000091a0: 5b69 6e74 5d2c 0a20 2020 2020 2020 2068  [int],.        h
+000091b0: 6173 5f71 7565 7279 3a20 626f 6f6c 203d  as_query: bool =
+000091c0: 2046 616c 7365 2c0a 2020 2020 2920 2d3e   False,.    ) ->
+000091d0: 206d 696e 6473 706f 7265 2e54 656e 736f   mindspore.Tenso
+000091e0: 723a 0a20 2020 2020 2020 2022 2222 0a20  r:.        """. 
+000091f0: 2020 2020 2020 204d 616b 6573 2062 726f         Makes bro
+00009200: 6164 6361 7374 6162 6c65 2061 7474 656e  adcastable atten
+00009210: 7469 6f6e 2061 6e64 2063 6175 7361 6c20  tion and causal 
+00009220: 6d61 736b 7320 736f 2074 6861 7420 6675  masks so that fu
+00009230: 7475 7265 2061 6e64 206d 6173 6b65 6420  ture and masked 
+00009240: 746f 6b65 6e73 2061 7265 2069 676e 6f72  tokens are ignor
+00009250: 6564 2e0a 0a20 2020 2020 2020 2041 7267  ed...        Arg
+00009260: 756d 656e 7473 3a0a 2020 2020 2020 2020  uments:.        
+00009270: 2020 2020 6174 7465 6e74 696f 6e5f 6d61      attention_ma
+00009280: 736b 2028 606d 696e 6473 706f 7265 2e54  sk (`mindspore.T
+00009290: 656e 736f 7260 293a 0a20 2020 2020 2020  ensor`):.       
+000092a0: 2020 2020 2020 2020 204d 6173 6b20 7769           Mask wi
+000092b0: 7468 206f 6e65 7320 696e 6469 6361 7469  th ones indicati
+000092c0: 6e67 2074 6f6b 656e 7320 746f 2061 7474  ng tokens to att
+000092d0: 656e 6420 746f 2c20 7a65 726f 7320 666f  end to, zeros fo
+000092e0: 7220 746f 6b65 6e73 2074 6f20 6967 6e6f  r tokens to igno
+000092f0: 7265 2e0a 2020 2020 2020 2020 2020 2020  re..            
+00009300: 696e 7075 745f 7368 6170 6520 2860 5475  input_shape (`Tu
+00009310: 706c 655b 696e 745d 6029 3a0a 2020 2020  ple[int]`):.    
+00009320: 2020 2020 2020 2020 2020 2020 5468 6520              The 
+00009330: 7368 6170 6520 6f66 2074 6865 2069 6e70  shape of the inp
+00009340: 7574 2074 6f20 7468 6520 6d6f 6465 6c2e  ut to the model.
+00009350: 0a0a 2020 2020 2020 2020 5265 7475 726e  ..        Return
+00009360: 733a 0a20 2020 2020 2020 2020 2020 2060  s:.            `
+00009370: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+00009380: 6020 5468 6520 6578 7465 6e64 6564 2061  ` The extended a
+00009390: 7474 656e 7469 6f6e 206d 6173 6b2c 2077  ttention mask, w
+000093a0: 6974 6820 6120 7468 6520 7361 6d65 2064  ith a the same d
+000093b0: 7479 7065 2061 7320 6061 7474 656e 7469  type as `attenti
+000093c0: 6f6e 5f6d 6173 6b2e 6474 7970 6560 2e0a  on_mask.dtype`..
+000093d0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+000093e0: 2020 2020 2320 5765 2063 616e 2070 726f      # We can pro
+000093f0: 7669 6465 2061 2073 656c 662d 6174 7465  vide a self-atte
+00009400: 6e74 696f 6e20 6d61 736b 206f 6620 6469  ntion mask of di
+00009410: 6d65 6e73 696f 6e73 205b 6261 7463 685f  mensions [batch_
+00009420: 7369 7a65 2c20 6672 6f6d 5f73 6571 5f6c  size, from_seq_l
+00009430: 656e 6774 682c 2074 6f5f 7365 715f 6c65  ength, to_seq_le
+00009440: 6e67 7468 5d0a 2020 2020 2020 2020 2320  ngth].        # 
+00009450: 6f75 7273 656c 7665 7320 696e 2077 6869  ourselves in whi
+00009460: 6368 2063 6173 6520 7765 206a 7573 7420  ch case we just 
+00009470: 6e65 6564 2074 6f20 6d61 6b65 2069 7420  need to make it 
+00009480: 6272 6f61 6463 6173 7461 626c 6520 746f  broadcastable to
+00009490: 2061 6c6c 2068 6561 6473 2e0a 2020 2020   all heads..    
+000094a0: 2020 2020 6966 2061 7474 656e 7469 6f6e      if attention
+000094b0: 5f6d 6173 6b2e 6e64 696d 203d 3d20 333a  _mask.ndim == 3:
+000094c0: 0a20 2020 2020 2020 2020 2020 2065 7874  .            ext
+000094d0: 656e 6465 645f 6174 7465 6e74 696f 6e5f  ended_attention_
+000094e0: 6d61 736b 203d 2061 7474 656e 7469 6f6e  mask = attention
+000094f0: 5f6d 6173 6b5b 3a2c 204e 6f6e 652c 203a  _mask[:, None, :
+00009500: 2c20 3a5d 0a20 2020 2020 2020 2065 6c69  , :].        eli
+00009510: 6620 6174 7465 6e74 696f 6e5f 6d61 736b  f attention_mask
+00009520: 2e6e 6469 6d20 3d3d 2032 3a0a 2020 2020  .ndim == 2:.    
+00009530: 2020 2020 2020 2020 2320 5072 6f76 6964          # Provid
+00009540: 6564 2061 2070 6164 6469 6e67 206d 6173  ed a padding mas
+00009550: 6b20 6f66 2064 696d 656e 7369 6f6e 7320  k of dimensions 
+00009560: 5b62 6174 6368 5f73 697a 652c 2073 6571  [batch_size, seq
+00009570: 5f6c 656e 6774 685d 0a20 2020 2020 2020  _length].       
+00009580: 2020 2020 2023 202d 2074 6865 206d 6f64       # - the mod
+00009590: 656c 2069 7320 616e 2065 6e63 6f64 6572  el is an encoder
+000095a0: 2c20 736f 206d 616b 6520 7468 6520 6d61  , so make the ma
+000095b0: 736b 2062 726f 6164 6361 7374 6162 6c65  sk broadcastable
+000095c0: 2074 6f20 5b62 6174 6368 5f73 697a 652c   to [batch_size,
+000095d0: 206e 756d 5f68 6561 6473 2c20 7365 715f   num_heads, seq_
+000095e0: 6c65 6e67 7468 2c20 7365 715f 6c65 6e67  length, seq_leng
+000095f0: 7468 5d0a 2020 2020 2020 2020 2020 2020  th].            
+00009600: 6578 7465 6e64 6564 5f61 7474 656e 7469  extended_attenti
+00009610: 6f6e 5f6d 6173 6b20 3d20 6174 7465 6e74  on_mask = attent
+00009620: 696f 6e5f 6d61 736b 5b3a 2c20 4e6f 6e65  ion_mask[:, None
+00009630: 2c20 4e6f 6e65 2c20 3a5d 0a20 2020 2020  , None, :].     
+00009640: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00009650: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+00009660: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+00009670: 2020 2020 2020 2022 5772 6f6e 6720 7368         "Wrong sh
+00009680: 6170 6520 666f 7220 696e 7075 745f 6964  ape for input_id
+00009690: 7320 2873 6861 7065 207b 7d29 206f 7220  s (shape {}) or 
+000096a0: 6174 7465 6e74 696f 6e5f 6d61 736b 2028  attention_mask (
+000096b0: 7368 6170 6520 7b7d 2922 2e66 6f72 6d61  shape {})".forma
+000096c0: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+000096d0: 2020 2020 2020 2069 6e70 7574 5f73 6861         input_sha
+000096e0: 7065 2c20 6174 7465 6e74 696f 6e5f 6d61  pe, attention_ma
+000096f0: 736b 2e73 6861 7065 0a20 2020 2020 2020  sk.shape.       
+00009700: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00009710: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00009720: 2020 2320 5369 6e63 6520 6174 7465 6e74    # Since attent
+00009730: 696f 6e5f 6d61 736b 2069 7320 312e 3020  ion_mask is 1.0 
+00009740: 666f 7220 706f 7369 7469 6f6e 7320 7765  for positions we
+00009750: 2077 616e 7420 746f 2061 7474 656e 6420   want to attend 
+00009760: 616e 6420 302e 3020 666f 720a 2020 2020  and 0.0 for.    
+00009770: 2020 2020 2320 6d61 736b 6564 2070 6f73      # masked pos
+00009780: 6974 696f 6e73 2c20 7468 6973 206f 7065  itions, this ope
+00009790: 7261 7469 6f6e 2077 696c 6c20 6372 6561  ration will crea
+000097a0: 7465 2061 2074 656e 736f 7220 7768 6963  te a tensor whic
+000097b0: 6820 6973 2030 2e30 2066 6f72 0a20 2020  h is 0.0 for.   
+000097c0: 2020 2020 2023 2070 6f73 6974 696f 6e73       # positions
+000097d0: 2077 6520 7761 6e74 2074 6f20 6174 7465   we want to atte
+000097e0: 6e64 2061 6e64 202d 3130 3030 302e 3020  nd and -10000.0 
+000097f0: 666f 7220 6d61 736b 6564 2070 6f73 6974  for masked posit
+00009800: 696f 6e73 2e0a 2020 2020 2020 2020 2320  ions..        # 
+00009810: 5369 6e63 6520 7765 2061 7265 2061 6464  Since we are add
+00009820: 696e 6720 6974 2074 6f20 7468 6520 7261  ing it to the ra
+00009830: 7720 7363 6f72 6573 2062 6566 6f72 6520  w scores before 
+00009840: 7468 6520 736f 6674 6d61 782c 2074 6869  the softmax, thi
+00009850: 7320 6973 0a20 2020 2020 2020 2023 2065  s is.        # e
+00009860: 6666 6563 7469 7665 6c79 2074 6865 2073  ffectively the s
+00009870: 616d 6520 6173 2072 656d 6f76 696e 6720  ame as removing 
+00009880: 7468 6573 6520 656e 7469 7265 6c79 2e0a  these entirely..
+00009890: 2020 2020 2020 2020 6578 7465 6e64 6564          extended
+000098a0: 5f61 7474 656e 7469 6f6e 5f6d 6173 6b20  _attention_mask 
+000098b0: 3d20 6578 7465 6e64 6564 5f61 7474 656e  = extended_atten
+000098c0: 7469 6f6e 5f6d 6173 6b2e 746f 2864 7479  tion_mask.to(dty
+000098d0: 7065 3d73 656c 662e 6474 7970 6529 2020  pe=self.dtype)  
+000098e0: 2320 6670 3136 2063 6f6d 7061 7469 6269  # fp16 compatibi
+000098f0: 6c69 7479 0a20 2020 2020 2020 2065 7874  lity.        ext
+00009900: 656e 6465 645f 6174 7465 6e74 696f 6e5f  ended_attention_
+00009910: 6d61 736b 203d 2028 312e 3020 2d20 6578  mask = (1.0 - ex
+00009920: 7465 6e64 6564 5f61 7474 656e 7469 6f6e  tended_attention
+00009930: 5f6d 6173 6b29 202a 202d 3130 3030 302e  _mask) * -10000.
+00009940: 300a 2020 2020 2020 2020 7265 7475 726e  0.        return
+00009950: 2065 7874 656e 6465 645f 6174 7465 6e74   extended_attent
+00009960: 696f 6e5f 6d61 736b 0a0a 2020 2020 6465  ion_mask..    de
+00009970: 6620 636f 6e73 7472 7563 7428 0a20 2020  f construct(.   
+00009980: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+00009990: 2020 2071 7565 7279 5f65 6d62 6564 733a     query_embeds:
+000099a0: 206d 696e 6473 706f 7265 2e54 656e 736f   mindspore.Tenso
+000099b0: 722c 0a20 2020 2020 2020 2061 7474 656e  r,.        atten
+000099c0: 7469 6f6e 5f6d 6173 6b3a 204f 7074 696f  tion_mask: Optio
+000099d0: 6e61 6c5b 6d69 6e64 7370 6f72 652e 5465  nal[mindspore.Te
+000099e0: 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a 2020  nsor] = None,.  
+000099f0: 2020 2020 2020 6865 6164 5f6d 6173 6b3a        head_mask:
+00009a00: 204f 7074 696f 6e61 6c5b 6d69 6e64 7370   Optional[mindsp
+00009a10: 6f72 652e 5465 6e73 6f72 5d20 3d20 4e6f  ore.Tensor] = No
+00009a20: 6e65 2c0a 2020 2020 2020 2020 656e 636f  ne,.        enco
+00009a30: 6465 725f 6869 6464 656e 5f73 7461 7465  der_hidden_state
+00009a40: 733a 204f 7074 696f 6e61 6c5b 6d69 6e64  s: Optional[mind
+00009a50: 7370 6f72 652e 5465 6e73 6f72 5d20 3d20  spore.Tensor] = 
+00009a60: 4e6f 6e65 2c0a 2020 2020 2020 2020 656e  None,.        en
+00009a70: 636f 6465 725f 6174 7465 6e74 696f 6e5f  coder_attention_
+00009a80: 6d61 736b 3a20 4f70 7469 6f6e 616c 5b6d  mask: Optional[m
+00009a90: 696e 6473 706f 7265 2e54 656e 736f 725d  indspore.Tensor]
+00009aa0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00009ab0: 2070 6173 745f 6b65 795f 7661 6c75 6573   past_key_values
+00009ac0: 3a20 4f70 7469 6f6e 616c 5b54 7570 6c65  : Optional[Tuple
+00009ad0: 5b54 7570 6c65 5b6d 696e 6473 706f 7265  [Tuple[mindspore
+00009ae0: 2e54 656e 736f 725d 5d5d 203d 204e 6f6e  .Tensor]]] = Non
+00009af0: 652c 0a20 2020 2020 2020 2075 7365 5f63  e,.        use_c
+00009b00: 6163 6865 3a20 4f70 7469 6f6e 616c 5b62  ache: Optional[b
+00009b10: 6f6f 6c5d 203d 204e 6f6e 652c 0a20 2020  ool] = None,.   
+00009b20: 2020 2020 206f 7574 7075 745f 6174 7465       output_atte
+00009b30: 6e74 696f 6e73 3a20 4f70 7469 6f6e 616c  ntions: Optional
+00009b40: 5b62 6f6f 6c5d 203d 204e 6f6e 652c 0a20  [bool] = None,. 
+00009b50: 2020 2020 2020 206f 7574 7075 745f 6869         output_hi
+00009b60: 6464 656e 5f73 7461 7465 733a 204f 7074  dden_states: Opt
+00009b70: 696f 6e61 6c5b 626f 6f6c 5d20 3d20 4e6f  ional[bool] = No
+00009b80: 6e65 2c0a 2020 2020 2020 2020 7265 7475  ne,.        retu
+00009b90: 726e 5f64 6963 743a 204f 7074 696f 6e61  rn_dict: Optiona
+00009ba0: 6c5b 626f 6f6c 5d20 3d20 4e6f 6e65 2c0a  l[bool] = None,.
+00009bb0: 2020 2020 2920 2d3e 2055 6e69 6f6e 5b54      ) -> Union[T
+00009bc0: 7570 6c65 5b6d 696e 6473 706f 7265 2e54  uple[mindspore.T
+00009bd0: 656e 736f 725d 2c20 4261 7365 4d6f 6465  ensor], BaseMode
+00009be0: 6c4f 7574 7075 7457 6974 6850 6f6f 6c69  lOutputWithPooli
+00009bf0: 6e67 416e 6443 726f 7373 4174 7465 6e74  ngAndCrossAttent
+00009c00: 696f 6e73 5d3a 0a20 2020 2020 2020 2072  ions]:.        r
+00009c10: 2222 220a 2020 2020 2020 2020 656e 636f  """.        enco
+00009c20: 6465 725f 6869 6464 656e 5f73 7461 7465  der_hidden_state
+00009c30: 7320 2028 606d 696e 6473 706f 7265 2e54  s  (`mindspore.T
+00009c40: 656e 736f 7260 206f 6620 7368 6170 6520  ensor` of shape 
+00009c50: 6028 6261 7463 685f 7369 7a65 2c20 7365  `(batch_size, se
+00009c60: 7175 656e 6365 5f6c 656e 6774 682c 2068  quence_length, h
+00009c70: 6964 6465 6e5f 7369 7a65 2960 2c20 606f  idden_size)`, `o
+00009c80: 7074 696f 6e61 6c60 293a 0a20 2020 2020  ptional`):.     
+00009c90: 2020 2020 2020 2053 6571 7565 6e63 6520         Sequence 
+00009ca0: 6f66 2068 6964 6465 6e2d 7374 6174 6573  of hidden-states
+00009cb0: 2061 7420 7468 6520 6f75 7470 7574 206f   at the output o
+00009cc0: 6620 7468 6520 6c61 7374 206c 6179 6572  f the last layer
+00009cd0: 206f 6620 7468 6520 656e 636f 6465 722e   of the encoder.
+00009ce0: 2055 7365 6420 696e 2074 6865 2063 726f   Used in the cro
+00009cf0: 7373 2d61 7474 656e 7469 6f6e 2069 660a  ss-attention if.
+00009d00: 2020 2020 2020 2020 2020 2020 7468 6520              the 
+00009d10: 6d6f 6465 6c20 6973 2063 6f6e 6669 6775  model is configu
+00009d20: 7265 6420 6173 2061 2064 6563 6f64 6572  red as a decoder
+00009d30: 2e0a 2020 2020 2020 2020 656e 636f 6465  ..        encode
+00009d40: 725f 6174 7465 6e74 696f 6e5f 6d61 736b  r_attention_mask
+00009d50: 2028 606d 696e 6473 706f 7265 2e54 656e   (`mindspore.Ten
+00009d60: 736f 7260 206f 6620 7368 6170 6520 6028  sor` of shape `(
+00009d70: 6261 7463 685f 7369 7a65 2c20 7365 7175  batch_size, sequ
+00009d80: 656e 6365 5f6c 656e 6774 6829 602c 2060  ence_length)`, `
+00009d90: 6f70 7469 6f6e 616c 6029 3a0a 2020 2020  optional`):.    
+00009da0: 2020 2020 2020 2020 4d61 736b 2074 6f20          Mask to 
+00009db0: 6176 6f69 6420 7065 7266 6f72 6d69 6e67  avoid performing
+00009dc0: 2061 7474 656e 7469 6f6e 206f 6e20 7468   attention on th
+00009dd0: 6520 7061 6464 696e 6720 746f 6b65 6e20  e padding token 
+00009de0: 696e 6469 6365 7320 6f66 2074 6865 2065  indices of the e
+00009df0: 6e63 6f64 6572 2069 6e70 7574 2e20 5468  ncoder input. Th
+00009e00: 6973 206d 6173 6b20 6973 2075 7365 6420  is mask is used 
+00009e10: 696e 0a20 2020 2020 2020 2020 2020 2074  in.            t
+00009e20: 6865 2063 726f 7373 2d61 7474 656e 7469  he cross-attenti
+00009e30: 6f6e 2069 6620 7468 6520 6d6f 6465 6c20  on if the model 
+00009e40: 6973 2063 6f6e 6669 6775 7265 6420 6173  is configured as
+00009e50: 2061 2064 6563 6f64 6572 2e20 4d61 736b   a decoder. Mask
+00009e60: 2076 616c 7565 7320 7365 6c65 6374 6564   values selected
+00009e70: 2069 6e20 605b 302c 2031 5d60 3a0a 2020   in `[0, 1]`:.  
+00009e80: 2020 2020 2020 2020 2020 2d20 3120 666f            - 1 fo
+00009e90: 7220 746f 6b65 6e73 2074 6861 7420 6172  r tokens that ar
+00009ea0: 6520 2a2a 6e6f 7420 6d61 736b 6564 2a2a  e **not masked**
+00009eb0: 2c0a 2020 2020 2020 2020 2020 2020 2d20  ,.            - 
+00009ec0: 3020 666f 7220 746f 6b65 6e73 2074 6861  0 for tokens tha
+00009ed0: 7420 6172 6520 2a2a 6d61 736b 6564 2a2a  t are **masked**
+00009ee0: 2e0a 2020 2020 2020 2020 7061 7374 5f6b  ..        past_k
+00009ef0: 6579 5f76 616c 7565 7320 2860 7475 706c  ey_values (`tupl
+00009f00: 6528 7475 706c 6528 6d69 6e64 7370 6f72  e(tuple(mindspor
+00009f10: 652e 5465 6e73 6f72 2929 6020 6f66 206c  e.Tensor))` of l
+00009f20: 656e 6774 6820 6063 6f6e 6669 672e 6e5f  ength `config.n_
+00009f30: 6c61 7965 7273 6020 7769 7468 2065 6163  layers` with eac
+00009f40: 6820 7475 706c 6520 6861 7669 6e67 2034  h tuple having 4
+00009f50: 2074 656e 736f 7273 206f 663a 0a20 2020   tensors of:.   
+00009f60: 2020 2020 2020 2020 2073 6861 7065 2060           shape `
+00009f70: 2862 6174 6368 5f73 697a 652c 206e 756d  (batch_size, num
+00009f80: 5f68 6561 6473 2c20 7365 7175 656e 6365  _heads, sequence
+00009f90: 5f6c 656e 6774 6820 2d20 312c 2065 6d62  _length - 1, emb
+00009fa0: 6564 5f73 697a 655f 7065 725f 6865 6164  ed_size_per_head
+00009fb0: 2960 293a 2043 6f6e 7461 696e 7320 7072  )`): Contains pr
+00009fc0: 6563 6f6d 7075 7465 6420 6b65 7920 616e  ecomputed key an
+00009fd0: 640a 2020 2020 2020 2020 2020 2020 7661  d.            va
+00009fe0: 6c75 6520 6869 6464 656e 2073 7461 7465  lue hidden state
+00009ff0: 7320 6f66 2074 6865 2061 7474 656e 7469  s of the attenti
+0000a000: 6f6e 2062 6c6f 636b 732e 2043 616e 2062  on blocks. Can b
+0000a010: 6520 7573 6564 2074 6f20 7370 6565 6420  e used to speed 
+0000a020: 7570 2064 6563 6f64 696e 672e 2049 6620  up decoding. If 
+0000a030: 6070 6173 745f 6b65 795f 7661 6c75 6573  `past_key_values
+0000a040: 6020 6172 650a 2020 2020 2020 2020 2020  ` are.          
+0000a050: 2020 7573 6564 2c20 7468 6520 7573 6572    used, the user
+0000a060: 2063 616e 206f 7074 696f 6e61 6c6c 7920   can optionally 
+0000a070: 696e 7075 7420 6f6e 6c79 2074 6865 206c  input only the l
+0000a080: 6173 7420 6064 6563 6f64 6572 5f69 6e70  ast `decoder_inp
+0000a090: 7574 5f69 6473 6020 2874 686f 7365 2074  ut_ids` (those t
+0000a0a0: 6861 7420 646f 6e27 7420 6861 7665 2074  hat don't have t
+0000a0b0: 6865 6972 2070 6173 7420 6b65 790a 2020  heir past key.  
+0000a0c0: 2020 2020 2020 2020 2020 7661 6c75 6520            value 
+0000a0d0: 7374 6174 6573 2067 6976 656e 2074 6f20  states given to 
+0000a0e0: 7468 6973 206d 6f64 656c 2920 6f66 2073  this model) of s
+0000a0f0: 6861 7065 2060 2862 6174 6368 5f73 697a  hape `(batch_siz
+0000a100: 652c 2031 2960 2069 6e73 7465 6164 206f  e, 1)` instead o
+0000a110: 6620 616c 6c20 6064 6563 6f64 6572 5f69  f all `decoder_i
+0000a120: 6e70 7574 5f69 6473 6020 6f66 2073 6861  nput_ids` of sha
+0000a130: 7065 0a20 2020 2020 2020 2020 2020 2060  pe.            `
+0000a140: 2862 6174 6368 5f73 697a 652c 2073 6571  (batch_size, seq
+0000a150: 7565 6e63 655f 6c65 6e67 7468 2960 2e0a  uence_length)`..
+0000a160: 2020 2020 2020 2020 7573 655f 6361 6368          use_cach
+0000a170: 6520 2860 626f 6f6c 602c 2060 6f70 7469  e (`bool`, `opti
+0000a180: 6f6e 616c 6029 3a0a 2020 2020 2020 2020  onal`):.        
+0000a190: 2020 2020 4966 2073 6574 2074 6f20 6054      If set to `T
+0000a1a0: 7275 6560 2c20 6070 6173 745f 6b65 795f  rue`, `past_key_
+0000a1b0: 7661 6c75 6573 6020 6b65 7920 7661 6c75  values` key valu
+0000a1c0: 6520 7374 6174 6573 2061 7265 2072 6574  e states are ret
+0000a1d0: 7572 6e65 6420 616e 6420 6361 6e20 6265  urned and can be
+0000a1e0: 2075 7365 6420 746f 2073 7065 6564 2075   used to speed u
+0000a1f0: 7020 6465 636f 6469 6e67 2028 7365 650a  p decoding (see.
+0000a200: 2020 2020 2020 2020 2020 2020 6070 6173              `pas
+0000a210: 745f 6b65 795f 7661 6c75 6573 6029 2e0a  t_key_values`)..
+0000a220: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0000a230: 2020 2020 6f75 7470 7574 5f61 7474 656e      output_atten
+0000a240: 7469 6f6e 7320 3d20 6f75 7470 7574 5f61  tions = output_a
+0000a250: 7474 656e 7469 6f6e 7320 6966 206f 7574  ttentions if out
+0000a260: 7075 745f 6174 7465 6e74 696f 6e73 2069  put_attentions i
+0000a270: 7320 6e6f 7420 4e6f 6e65 2065 6c73 6520  s not None else 
+0000a280: 7365 6c66 2e63 6f6e 6669 672e 6f75 7470  self.config.outp
+0000a290: 7574 5f61 7474 656e 7469 6f6e 730a 2020  ut_attentions.  
+0000a2a0: 2020 2020 2020 6f75 7470 7574 5f68 6964        output_hid
+0000a2b0: 6465 6e5f 7374 6174 6573 203d 2028 0a20  den_states = (. 
+0000a2c0: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
+0000a2d0: 745f 6869 6464 656e 5f73 7461 7465 7320  t_hidden_states 
+0000a2e0: 6966 206f 7574 7075 745f 6869 6464 656e  if output_hidden
+0000a2f0: 5f73 7461 7465 7320 6973 206e 6f74 204e  _states is not N
+0000a300: 6f6e 6520 656c 7365 2073 656c 662e 636f  one else self.co
+0000a310: 6e66 6967 2e6f 7574 7075 745f 6869 6464  nfig.output_hidd
+0000a320: 656e 5f73 7461 7465 730a 2020 2020 2020  en_states.      
+0000a330: 2020 290a 2020 2020 2020 2020 7265 7475    ).        retu
+0000a340: 726e 5f64 6963 7420 3d20 7265 7475 726e  rn_dict = return
+0000a350: 5f64 6963 7420 6966 2072 6574 7572 6e5f  _dict if return_
+0000a360: 6469 6374 2069 7320 6e6f 7420 4e6f 6e65  dict is not None
+0000a370: 2065 6c73 6520 7365 6c66 2e63 6f6e 6669   else self.confi
+0000a380: 672e 7573 655f 7265 7475 726e 5f64 6963  g.use_return_dic
+0000a390: 740a 0a20 2020 2020 2020 2023 2070 6173  t..        # pas
+0000a3a0: 745f 6b65 795f 7661 6c75 6573 5f6c 656e  t_key_values_len
+0000a3b0: 6774 680a 2020 2020 2020 2020 7061 7374  gth.        past
+0000a3c0: 5f6b 6579 5f76 616c 7565 735f 6c65 6e67  _key_values_leng
+0000a3d0: 7468 203d 2028 0a20 2020 2020 2020 2020  th = (.         
+0000a3e0: 2020 2070 6173 745f 6b65 795f 7661 6c75     past_key_valu
+0000a3f0: 6573 5b30 5d5b 305d 2e73 6861 7065 5b32  es[0][0].shape[2
+0000a400: 5d20 2d20 7365 6c66 2e63 6f6e 6669 672e  ] - self.config.
+0000a410: 7175 6572 795f 6c65 6e67 7468 2069 6620  query_length if 
+0000a420: 7061 7374 5f6b 6579 5f76 616c 7565 7320  past_key_values 
+0000a430: 6973 206e 6f74 204e 6f6e 6520 656c 7365  is not None else
+0000a440: 2030 0a20 2020 2020 2020 2029 0a0a 2020   0.        )..  
+0000a450: 2020 2020 2020 7175 6572 795f 6c65 6e67        query_leng
+0000a460: 7468 203d 2071 7565 7279 5f65 6d62 6564  th = query_embed
+0000a470: 732e 7368 6170 655b 315d 2069 6620 7175  s.shape[1] if qu
+0000a480: 6572 795f 656d 6265 6473 2069 7320 6e6f  ery_embeds is no
+0000a490: 7420 4e6f 6e65 2065 6c73 6520 300a 0a20  t None else 0.. 
+0000a4a0: 2020 2020 2020 2065 6d62 6564 6469 6e67         embedding
+0000a4b0: 5f6f 7574 7075 7420 3d20 7365 6c66 2e6c  _output = self.l
+0000a4c0: 6179 6572 6e6f 726d 2871 7565 7279 5f65  ayernorm(query_e
+0000a4d0: 6d62 6564 7329 0a20 2020 2020 2020 2065  mbeds).        e
+0000a4e0: 6d62 6564 6469 6e67 5f6f 7574 7075 7420  mbedding_output 
+0000a4f0: 3d20 7365 6c66 2e64 726f 706f 7574 2865  = self.dropout(e
+0000a500: 6d62 6564 6469 6e67 5f6f 7574 7075 7429  mbedding_output)
+0000a510: 0a0a 2020 2020 2020 2020 696e 7075 745f  ..        input_
+0000a520: 7368 6170 6520 3d20 656d 6265 6464 696e  shape = embeddin
+0000a530: 675f 6f75 7470 7574 2e73 6861 7065 5b3a  g_output.shape[:
+0000a540: 2d31 5d0a 2020 2020 2020 2020 6261 7463  -1].        batc
+0000a550: 685f 7369 7a65 2c20 7365 715f 6c65 6e67  h_size, seq_leng
+0000a560: 7468 203d 2069 6e70 7574 5f73 6861 7065  th = input_shape
+0000a570: 0a0a 2020 2020 2020 2020 6966 2061 7474  ..        if att
+0000a580: 656e 7469 6f6e 5f6d 6173 6b20 6973 204e  ention_mask is N
+0000a590: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0000a5a0: 2061 7474 656e 7469 6f6e 5f6d 6173 6b20   attention_mask 
+0000a5b0: 3d20 6f70 732e 6f6e 6573 2828 2862 6174  = ops.ones(((bat
+0000a5c0: 6368 5f73 697a 652c 2073 6571 5f6c 656e  ch_size, seq_len
+0000a5d0: 6774 6820 2b20 7061 7374 5f6b 6579 5f76  gth + past_key_v
+0000a5e0: 616c 7565 735f 6c65 6e67 7468 2929 290a  alues_length))).
+0000a5f0: 0a20 2020 2020 2020 2023 2057 6520 6361  .        # We ca
+0000a600: 6e20 7072 6f76 6964 6520 6120 7365 6c66  n provide a self
+0000a610: 2d61 7474 656e 7469 6f6e 206d 6173 6b20  -attention mask 
+0000a620: 6f66 2064 696d 656e 7369 6f6e 7320 5b62  of dimensions [b
+0000a630: 6174 6368 5f73 697a 652c 2066 726f 6d5f  atch_size, from_
+0000a640: 7365 715f 6c65 6e67 7468 2c20 746f 5f73  seq_length, to_s
+0000a650: 6571 5f6c 656e 6774 685d 0a20 2020 2020  eq_length].     
+0000a660: 2020 2023 206f 7572 7365 6c76 6573 2069     # ourselves i
+0000a670: 6e20 7768 6963 6820 6361 7365 2077 6520  n which case we 
+0000a680: 6a75 7374 206e 6565 6420 746f 206d 616b  just need to mak
+0000a690: 6520 6974 2062 726f 6164 6361 7374 6162  e it broadcastab
+0000a6a0: 6c65 2074 6f20 616c 6c20 6865 6164 732e  le to all heads.
+0000a6b0: 0a20 2020 2020 2020 2065 7874 656e 6465  .        extende
+0000a6c0: 645f 6174 7465 6e74 696f 6e5f 6d61 736b  d_attention_mask
+0000a6d0: 203d 2073 656c 662e 6765 745f 6578 7465   = self.get_exte
+0000a6e0: 6e64 6564 5f61 7474 656e 7469 6f6e 5f6d  nded_attention_m
+0000a6f0: 6173 6b28 6174 7465 6e74 696f 6e5f 6d61  ask(attention_ma
+0000a700: 736b 2c20 696e 7075 745f 7368 6170 6529  sk, input_shape)
+0000a710: 0a0a 2020 2020 2020 2020 2320 4966 2061  ..        # If a
+0000a720: 2032 4420 6f72 2033 4420 6174 7465 6e74   2D or 3D attent
+0000a730: 696f 6e20 6d61 736b 2069 7320 7072 6f76  ion mask is prov
+0000a740: 6964 6564 2066 6f72 2074 6865 2063 726f  ided for the cro
+0000a750: 7373 2d61 7474 656e 7469 6f6e 0a20 2020  ss-attention.   
+0000a760: 2020 2020 2023 2077 6520 6e65 6564 2074       # we need t
+0000a770: 6f20 6d61 6b65 2062 726f 6164 6361 7374  o make broadcast
+0000a780: 6162 6c65 2074 6f20 5b62 6174 6368 5f73  able to [batch_s
+0000a790: 697a 652c 206e 756d 5f68 6561 6473 2c20  ize, num_heads, 
+0000a7a0: 7365 715f 6c65 6e67 7468 2c20 7365 715f  seq_length, seq_
+0000a7b0: 6c65 6e67 7468 5d0a 2020 2020 2020 2020  length].        
+0000a7c0: 6966 2065 6e63 6f64 6572 5f68 6964 6465  if encoder_hidde
+0000a7d0: 6e5f 7374 6174 6573 2069 7320 6e6f 7420  n_states is not 
+0000a7e0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0000a7f0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+0000a800: 656e 636f 6465 725f 6869 6464 656e 5f73  encoder_hidden_s
+0000a810: 7461 7465 732c 206c 6973 7429 3a0a 2020  tates, list):.  
+0000a820: 2020 2020 2020 2020 2020 2020 2020 656e                en
+0000a830: 636f 6465 725f 6261 7463 685f 7369 7a65  coder_batch_size
+0000a840: 2c20 656e 636f 6465 725f 7365 7175 656e  , encoder_sequen
+0000a850: 6365 5f6c 656e 6774 682c 205f 203d 2065  ce_length, _ = e
+0000a860: 6e63 6f64 6572 5f68 6964 6465 6e5f 7374  ncoder_hidden_st
+0000a870: 6174 6573 5b30 5d2e 7368 6170 650a 2020  ates[0].shape.  
+0000a880: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0000a890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a8a0: 656e 636f 6465 725f 6261 7463 685f 7369  encoder_batch_si
+0000a8b0: 7a65 2c20 656e 636f 6465 725f 7365 7175  ze, encoder_sequ
+0000a8c0: 656e 6365 5f6c 656e 6774 682c 205f 203d  ence_length, _ =
+0000a8d0: 2065 6e63 6f64 6572 5f68 6964 6465 6e5f   encoder_hidden_
+0000a8e0: 7374 6174 6573 2e73 6861 7065 0a20 2020  states.shape.   
+0000a8f0: 2020 2020 2020 2020 2065 6e63 6f64 6572           encoder
+0000a900: 5f68 6964 6465 6e5f 7368 6170 6520 3d20  _hidden_shape = 
+0000a910: 2865 6e63 6f64 6572 5f62 6174 6368 5f73  (encoder_batch_s
+0000a920: 697a 652c 2065 6e63 6f64 6572 5f73 6571  ize, encoder_seq
+0000a930: 7565 6e63 655f 6c65 6e67 7468 290a 0a20  uence_length).. 
+0000a940: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+0000a950: 696e 7374 616e 6365 2865 6e63 6f64 6572  instance(encoder
+0000a960: 5f61 7474 656e 7469 6f6e 5f6d 6173 6b2c  _attention_mask,
+0000a970: 206c 6973 7429 3a0a 2020 2020 2020 2020   list):.        
+0000a980: 2020 2020 2020 2020 656e 636f 6465 725f          encoder_
+0000a990: 6578 7465 6e64 6564 5f61 7474 656e 7469  extended_attenti
+0000a9a0: 6f6e 5f6d 6173 6b20 3d20 5b73 656c 662e  on_mask = [self.
+0000a9b0: 696e 7665 7274 5f61 7474 656e 7469 6f6e  invert_attention
+0000a9c0: 5f6d 6173 6b28 6d61 736b 2920 666f 7220  _mask(mask) for 
+0000a9d0: 6d61 736b 2069 6e20 656e 636f 6465 725f  mask in encoder_
+0000a9e0: 6174 7465 6e74 696f 6e5f 6d61 736b 5d0a  attention_mask].
+0000a9f0: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+0000aa00: 2065 6e63 6f64 6572 5f61 7474 656e 7469   encoder_attenti
+0000aa10: 6f6e 5f6d 6173 6b20 6973 204e 6f6e 653a  on_mask is None:
+0000aa20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000aa30: 2065 6e63 6f64 6572 5f61 7474 656e 7469   encoder_attenti
+0000aa40: 6f6e 5f6d 6173 6b20 3d20 6f70 732e 6f6e  on_mask = ops.on
+0000aa50: 6573 2865 6e63 6f64 6572 5f68 6964 6465  es(encoder_hidde
+0000aa60: 6e5f 7368 6170 6529 0a20 2020 2020 2020  n_shape).       
+0000aa70: 2020 2020 2020 2020 2065 6e63 6f64 6572           encoder
+0000aa80: 5f65 7874 656e 6465 645f 6174 7465 6e74  _extended_attent
+0000aa90: 696f 6e5f 6d61 736b 203d 2073 656c 662e  ion_mask = self.
+0000aaa0: 696e 7665 7274 5f61 7474 656e 7469 6f6e  invert_attention
+0000aab0: 5f6d 6173 6b28 656e 636f 6465 725f 6174  _mask(encoder_at
+0000aac0: 7465 6e74 696f 6e5f 6d61 736b 290a 2020  tention_mask).  
+0000aad0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0000aae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000aaf0: 656e 636f 6465 725f 6578 7465 6e64 6564  encoder_extended
+0000ab00: 5f61 7474 656e 7469 6f6e 5f6d 6173 6b20  _attention_mask 
+0000ab10: 3d20 7365 6c66 2e69 6e76 6572 745f 6174  = self.invert_at
+0000ab20: 7465 6e74 696f 6e5f 6d61 736b 2865 6e63  tention_mask(enc
+0000ab30: 6f64 6572 5f61 7474 656e 7469 6f6e 5f6d  oder_attention_m
+0000ab40: 6173 6b29 0a20 2020 2020 2020 2065 6c73  ask).        els
+0000ab50: 653a 0a20 2020 2020 2020 2020 2020 2065  e:.            e
+0000ab60: 6e63 6f64 6572 5f65 7874 656e 6465 645f  ncoder_extended_
+0000ab70: 6174 7465 6e74 696f 6e5f 6d61 736b 203d  attention_mask =
+0000ab80: 204e 6f6e 650a 0a20 2020 2020 2020 2023   None..        #
+0000ab90: 2050 7265 7061 7265 2068 6561 6420 6d61   Prepare head ma
+0000aba0: 736b 2069 6620 6e65 6564 6564 0a20 2020  sk if needed.   
+0000abb0: 2020 2020 2023 2031 2e30 2069 6e20 6865       # 1.0 in he
+0000abc0: 6164 5f6d 6173 6b20 696e 6469 6361 7465  ad_mask indicate
+0000abd0: 2077 6520 6b65 6570 2074 6865 2068 6561   we keep the hea
+0000abe0: 640a 2020 2020 2020 2020 2320 6174 7465  d.        # atte
+0000abf0: 6e74 696f 6e5f 7072 6f62 7320 6861 7320  ntion_probs has 
+0000ac00: 7368 6170 6520 6273 7a20 7820 6e5f 6865  shape bsz x n_he
+0000ac10: 6164 7320 7820 4e20 7820 4e0a 2020 2020  ads x N x N.    
+0000ac20: 2020 2020 2320 696e 7075 7420 6865 6164      # input head
+0000ac30: 5f6d 6173 6b20 6861 7320 7368 6170 6520  _mask has shape 
+0000ac40: 5b6e 756d 5f68 6561 6473 5d20 6f72 205b  [num_heads] or [
+0000ac50: 6e75 6d5f 6869 6464 656e 5f6c 6179 6572  num_hidden_layer
+0000ac60: 7320 7820 6e75 6d5f 6865 6164 735d 0a20  s x num_heads]. 
+0000ac70: 2020 2020 2020 2023 2061 6e64 2068 6561         # and hea
+0000ac80: 645f 6d61 736b 2069 7320 636f 6e76 6572  d_mask is conver
+0000ac90: 7465 6420 746f 2073 6861 7065 205b 6e75  ted to shape [nu
+0000aca0: 6d5f 6869 6464 656e 5f6c 6179 6572 7320  m_hidden_layers 
+0000acb0: 7820 6261 7463 6820 7820 6e75 6d5f 6865  x batch x num_he
+0000acc0: 6164 7320 7820 7365 715f 6c65 6e67 7468  ads x seq_length
+0000acd0: 2078 2073 6571 5f6c 656e 6774 685d 0a20   x seq_length]. 
+0000ace0: 2020 2020 2020 2068 6561 645f 6d61 736b         head_mask
+0000acf0: 203d 2073 656c 662e 6765 745f 6865 6164   = self.get_head
+0000ad00: 5f6d 6173 6b28 6865 6164 5f6d 6173 6b2c  _mask(head_mask,
+0000ad10: 2073 656c 662e 636f 6e66 6967 2e6e 756d   self.config.num
+0000ad20: 5f68 6964 6465 6e5f 6c61 7965 7273 290a  _hidden_layers).
+0000ad30: 0a20 2020 2020 2020 2065 6e63 6f64 6572  .        encoder
+0000ad40: 5f6f 7574 7075 7473 203d 2073 656c 662e  _outputs = self.
+0000ad50: 656e 636f 6465 7228 0a20 2020 2020 2020  encoder(.       
+0000ad60: 2020 2020 2065 6d62 6564 6469 6e67 5f6f       embedding_o
+0000ad70: 7574 7075 742c 0a20 2020 2020 2020 2020  utput,.         
+0000ad80: 2020 2061 7474 656e 7469 6f6e 5f6d 6173     attention_mas
+0000ad90: 6b3d 6578 7465 6e64 6564 5f61 7474 656e  k=extended_atten
+0000ada0: 7469 6f6e 5f6d 6173 6b2c 0a20 2020 2020  tion_mask,.     
+0000adb0: 2020 2020 2020 2068 6561 645f 6d61 736b         head_mask
+0000adc0: 3d68 6561 645f 6d61 736b 2c0a 2020 2020  =head_mask,.    
+0000add0: 2020 2020 2020 2020 656e 636f 6465 725f          encoder_
+0000ade0: 6869 6464 656e 5f73 7461 7465 733d 656e  hidden_states=en
+0000adf0: 636f 6465 725f 6869 6464 656e 5f73 7461  coder_hidden_sta
+0000ae00: 7465 732c 0a20 2020 2020 2020 2020 2020  tes,.           
+0000ae10: 2065 6e63 6f64 6572 5f61 7474 656e 7469   encoder_attenti
+0000ae20: 6f6e 5f6d 6173 6b3d 656e 636f 6465 725f  on_mask=encoder_
+0000ae30: 6578 7465 6e64 6564 5f61 7474 656e 7469  extended_attenti
+0000ae40: 6f6e 5f6d 6173 6b2c 0a20 2020 2020 2020  on_mask,.       
+0000ae50: 2020 2020 2070 6173 745f 6b65 795f 7661       past_key_va
+0000ae60: 6c75 6573 3d70 6173 745f 6b65 795f 7661  lues=past_key_va
+0000ae70: 6c75 6573 2c0a 2020 2020 2020 2020 2020  lues,.          
+0000ae80: 2020 7573 655f 6361 6368 653d 7573 655f    use_cache=use_
+0000ae90: 6361 6368 652c 0a20 2020 2020 2020 2020  cache,.         
+0000aea0: 2020 206f 7574 7075 745f 6174 7465 6e74     output_attent
+0000aeb0: 696f 6e73 3d6f 7574 7075 745f 6174 7465  ions=output_atte
+0000aec0: 6e74 696f 6e73 2c0a 2020 2020 2020 2020  ntions,.        
+0000aed0: 2020 2020 6f75 7470 7574 5f68 6964 6465      output_hidde
+0000aee0: 6e5f 7374 6174 6573 3d6f 7574 7075 745f  n_states=output_
+0000aef0: 6869 6464 656e 5f73 7461 7465 732c 0a20  hidden_states,. 
+0000af00: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000af10: 6e5f 6469 6374 3d72 6574 7572 6e5f 6469  n_dict=return_di
+0000af20: 6374 2c0a 2020 2020 2020 2020 2020 2020  ct,.            
+0000af30: 7175 6572 795f 6c65 6e67 7468 3d71 7565  query_length=que
+0000af40: 7279 5f6c 656e 6774 682c 0a20 2020 2020  ry_length,.     
+0000af50: 2020 2029 0a20 2020 2020 2020 2073 6571     ).        seq
+0000af60: 7565 6e63 655f 6f75 7470 7574 203d 2065  uence_output = e
+0000af70: 6e63 6f64 6572 5f6f 7574 7075 7473 5b30  ncoder_outputs[0
+0000af80: 5d0a 2020 2020 2020 2020 706f 6f6c 6564  ].        pooled
+0000af90: 5f6f 7574 7075 7420 3d20 7365 7175 656e  _output = sequen
+0000afa0: 6365 5f6f 7574 7075 745b 3a2c 2030 2c20  ce_output[:, 0, 
+0000afb0: 3a5d 0a0a 2020 2020 2020 2020 6966 206e  :]..        if n
+0000afc0: 6f74 2072 6574 7572 6e5f 6469 6374 3a0a  ot return_dict:.
+0000afd0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000afe0: 726e 2028 7365 7175 656e 6365 5f6f 7574  rn (sequence_out
+0000aff0: 7075 742c 2070 6f6f 6c65 645f 6f75 7470  put, pooled_outp
+0000b000: 7574 2920 2b20 656e 636f 6465 725f 6f75  ut) + encoder_ou
+0000b010: 7470 7574 735b 313a 5d0a 0a20 2020 2020  tputs[1:]..     
+0000b020: 2020 2072 6574 7572 6e20 4261 7365 4d6f     return BaseMo
+0000b030: 6465 6c4f 7574 7075 7457 6974 6850 6f6f  delOutputWithPoo
+0000b040: 6c69 6e67 416e 6443 726f 7373 4174 7465  lingAndCrossAtte
+0000b050: 6e74 696f 6e73 280a 2020 2020 2020 2020  ntions(.        
+0000b060: 2020 2020 6c61 7374 5f68 6964 6465 6e5f      last_hidden_
+0000b070: 7374 6174 653d 7365 7175 656e 6365 5f6f  state=sequence_o
+0000b080: 7574 7075 742c 0a20 2020 2020 2020 2020  utput,.         
+0000b090: 2020 2070 6f6f 6c65 725f 6f75 7470 7574     pooler_output
+0000b0a0: 3d70 6f6f 6c65 645f 6f75 7470 7574 2c0a  =pooled_output,.
+0000b0b0: 2020 2020 2020 2020 2020 2020 7061 7374              past
+0000b0c0: 5f6b 6579 5f76 616c 7565 733d 656e 636f  _key_values=enco
+0000b0d0: 6465 725f 6f75 7470 7574 732e 7061 7374  der_outputs.past
+0000b0e0: 5f6b 6579 5f76 616c 7565 732c 0a20 2020  _key_values,.   
+0000b0f0: 2020 2020 2020 2020 2068 6964 6465 6e5f           hidden_
+0000b100: 7374 6174 6573 3d65 6e63 6f64 6572 5f6f  states=encoder_o
+0000b110: 7574 7075 7473 2e68 6964 6465 6e5f 7374  utputs.hidden_st
+0000b120: 6174 6573 2c0a 2020 2020 2020 2020 2020  ates,.          
+0000b130: 2020 6174 7465 6e74 696f 6e73 3d65 6e63    attentions=enc
+0000b140: 6f64 6572 5f6f 7574 7075 7473 2e61 7474  oder_outputs.att
+0000b150: 656e 7469 6f6e 732c 0a20 2020 2020 2020  entions,.       
+0000b160: 2020 2020 2063 726f 7373 5f61 7474 656e       cross_atten
+0000b170: 7469 6f6e 733d 656e 636f 6465 725f 6f75  tions=encoder_ou
+0000b180: 7470 7574 732e 6372 6f73 735f 6174 7465  tputs.cross_atte
+0000b190: 6e74 696f 6e73 2c0a 2020 2020 2020 2020  ntions,.        
+0000b1a0: 290a 0a0a 636c 6173 7320 426c 6970 324d  )...class Blip2M
+0000b1b0: 6f64 656c 2842 6c69 7032 5072 6554 7261  odel(Blip2PreTra
+0000b1c0: 696e 6564 4d6f 6465 6c29 3a0a 2020 2020  inedModel):.    
+0000b1d0: 636f 6e66 6967 5f63 6c61 7373 203d 2042  config_class = B
+0000b1e0: 6c69 7032 436f 6e66 6967 0a20 2020 206d  lip2Config.    m
+0000b1f0: 6169 6e5f 696e 7075 745f 6e61 6d65 203d  ain_input_name =
+0000b200: 2022 7069 7865 6c5f 7661 6c75 6573 220a   "pixel_values".
+0000b210: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+0000b220: 5f28 7365 6c66 2c20 636f 6e66 6967 3a20  _(self, config: 
+0000b230: 426c 6970 3243 6f6e 6669 6729 3a0a 2020  Blip2Config):.  
+0000b240: 2020 2020 2020 7375 7065 7228 292e 5f5f        super().__
+0000b250: 696e 6974 5f5f 2863 6f6e 6669 6729 0a0a  init__(config)..
+0000b260: 2020 2020 2020 2020 7365 6c66 2e76 6973          self.vis
+0000b270: 696f 6e5f 6d6f 6465 6c20 3d20 426c 6970  ion_model = Blip
+0000b280: 3256 6973 696f 6e4d 6f64 656c 2863 6f6e  2VisionModel(con
+0000b290: 6669 672e 7669 7369 6f6e 5f63 6f6e 6669  fig.vision_confi
+0000b2a0: 6729 0a0a 2020 2020 2020 2020 7365 6c66  g)..        self
+0000b2b0: 2e71 7565 7279 5f74 6f6b 656e 7320 3d20  .query_tokens = 
+0000b2c0: 5061 7261 6d65 7465 7228 6f70 732e 7a65  Parameter(ops.ze
+0000b2d0: 726f 7328 312c 2063 6f6e 6669 672e 6e75  ros(1, config.nu
+0000b2e0: 6d5f 7175 6572 795f 746f 6b65 6e73 2c20  m_query_tokens, 
+0000b2f0: 636f 6e66 6967 2e71 666f 726d 6572 5f63  config.qformer_c
+0000b300: 6f6e 6669 672e 6869 6464 656e 5f73 697a  onfig.hidden_siz
+0000b310: 6529 290a 2020 2020 2020 2020 7365 6c66  e)).        self
+0000b320: 2e71 666f 726d 6572 203d 2042 6c69 7032  .qformer = Blip2
+0000b330: 5146 6f72 6d65 724d 6f64 656c 2863 6f6e  QFormerModel(con
+0000b340: 6669 672e 7166 6f72 6d65 725f 636f 6e66  fig.qformer_conf
+0000b350: 6967 290a 0a20 2020 2020 2020 2073 656c  ig)..        sel
+0000b360: 662e 6c61 6e67 7561 6765 5f70 726f 6a65  f.language_proje
+0000b370: 6374 696f 6e20 3d20 6e6e 2e44 656e 7365  ction = nn.Dense
+0000b380: 2863 6f6e 6669 672e 7166 6f72 6d65 725f  (config.qformer_
+0000b390: 636f 6e66 6967 2e68 6964 6465 6e5f 7369  config.hidden_si
+0000b3a0: 7a65 2c20 636f 6e66 6967 2e74 6578 745f  ze, config.text_
+0000b3b0: 636f 6e66 6967 2e68 6964 6465 6e5f 7369  config.hidden_si
+0000b3c0: 7a65 290a 2020 2020 2020 2020 6966 2063  ze).        if c
+0000b3d0: 6f6e 6669 672e 7573 655f 6465 636f 6465  onfig.use_decode
+0000b3e0: 725f 6f6e 6c79 5f6c 616e 6775 6167 655f  r_only_language_
+0000b3f0: 6d6f 6465 6c3a 0a20 2020 2020 2020 2020  model:.         
+0000b400: 2020 206c 616e 6775 6167 655f 6d6f 6465     language_mode
+0000b410: 6c20 3d20 4175 746f 4d6f 6465 6c46 6f72  l = AutoModelFor
+0000b420: 4361 7573 616c 4c4d 2e66 726f 6d5f 636f  CausalLM.from_co
+0000b430: 6e66 6967 2863 6f6e 6669 672e 7465 7874  nfig(config.text
+0000b440: 5f63 6f6e 6669 6729 0a20 2020 2020 2020  _config).       
+0000b450: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0000b460: 2020 206c 616e 6775 6167 655f 6d6f 6465     language_mode
+0000b470: 6c20 3d20 4175 746f 4d6f 6465 6c46 6f72  l = AutoModelFor
+0000b480: 5365 7132 5365 714c 4d2e 6672 6f6d 5f63  Seq2SeqLM.from_c
+0000b490: 6f6e 6669 6728 636f 6e66 6967 2e74 6578  onfig(config.tex
+0000b4a0: 745f 636f 6e66 6967 290a 0a20 2020 2020  t_config)..     
+0000b4b0: 2020 2023 2055 7064 6174 6520 5f74 6965     # Update _tie
+0000b4c0: 645f 7765 6967 6874 735f 6b65 7973 2075  d_weights_keys u
+0000b4d0: 7369 6e67 2074 6865 2062 6173 6520 6d6f  sing the base mo
+0000b4e0: 6465 6c20 7573 6564 2e0a 2020 2020 2020  del used..      
+0000b4f0: 2020 6966 206c 616e 6775 6167 655f 6d6f    if language_mo
+0000b500: 6465 6c2e 5f74 6965 645f 7765 6967 6874  del._tied_weight
+0000b510: 735f 6b65 7973 2069 7320 6e6f 7420 4e6f  s_keys is not No
+0000b520: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0000b530: 7365 6c66 2e5f 7469 6564 5f77 6569 6768  self._tied_weigh
+0000b540: 7473 5f6b 6579 7320 3d20 5b66 226c 616e  ts_keys = [f"lan
+0000b550: 6775 6167 655f 6d6f 6465 6c2e 7b6b 7d22  guage_model.{k}"
+0000b560: 2066 6f72 206b 2069 6e20 6c61 6e67 7561   for k in langua
+0000b570: 6765 5f6d 6f64 656c 2e5f 7469 6564 5f77  ge_model._tied_w
+0000b580: 6569 6768 7473 5f6b 6579 735d 0a0a 2020  eights_keys]..  
+0000b590: 2020 2020 2020 7365 6c66 2e6c 616e 6775        self.langu
+0000b5a0: 6167 655f 6d6f 6465 6c20 3d20 6c61 6e67  age_model = lang
+0000b5b0: 7561 6765 5f6d 6f64 656c 0a0a 2020 2020  uage_model..    
+0000b5c0: 2020 2020 2320 496e 6974 6961 6c69 7a65      # Initialize
+0000b5d0: 2077 6569 6768 7473 2061 6e64 2061 7070   weights and app
+0000b5e0: 6c79 2066 696e 616c 2070 726f 6365 7373  ly final process
+0000b5f0: 696e 670a 2020 2020 2020 2020 7365 6c66  ing.        self
+0000b600: 2e70 6f73 745f 696e 6974 2829 0a0a 2020  .post_init()..  
+0000b610: 2020 6465 6620 6765 745f 696e 7075 745f    def get_input_
+0000b620: 656d 6265 6464 696e 6773 2873 656c 6629  embeddings(self)
+0000b630: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+0000b640: 2073 656c 662e 6c61 6e67 7561 6765 5f6d   self.language_m
+0000b650: 6f64 656c 2e67 6574 5f69 6e70 7574 5f65  odel.get_input_e
+0000b660: 6d62 6564 6469 6e67 7328 290a 0a20 2020  mbeddings()..   
+0000b670: 2064 6566 2073 6574 5f69 6e70 7574 5f65   def set_input_e
+0000b680: 6d62 6564 6469 6e67 7328 7365 6c66 2c20  mbeddings(self, 
+0000b690: 7661 6c75 6529 3a0a 2020 2020 2020 2020  value):.        
+0000b6a0: 7365 6c66 2e6c 616e 6775 6167 655f 6d6f  self.language_mo
+0000b6b0: 6465 6c2e 7365 745f 696e 7075 745f 656d  del.set_input_em
+0000b6c0: 6265 6464 696e 6773 2876 616c 7565 290a  beddings(value).
+0000b6d0: 0a20 2020 2064 6566 2073 6574 5f6f 7574  .    def set_out
+0000b6e0: 7075 745f 656d 6265 6464 696e 6773 2873  put_embeddings(s
+0000b6f0: 656c 662c 206e 6577 5f65 6d62 6564 6469  elf, new_embeddi
+0000b700: 6e67 7329 3a0a 2020 2020 2020 2020 7365  ngs):.        se
+0000b710: 6c66 2e6c 616e 6775 6167 655f 6d6f 6465  lf.language_mode
+0000b720: 6c2e 7365 745f 6f75 7470 7574 5f65 6d62  l.set_output_emb
+0000b730: 6564 6469 6e67 7328 6e65 775f 656d 6265  eddings(new_embe
+0000b740: 6464 696e 6773 290a 0a20 2020 2064 6566  ddings)..    def
+0000b750: 2067 6574 5f6f 7574 7075 745f 656d 6265   get_output_embe
+0000b760: 6464 696e 6773 2873 656c 6629 202d 3e20  ddings(self) -> 
+0000b770: 6e6e 2e43 656c 6c3a 0a20 2020 2020 2020  nn.Cell:.       
+0000b780: 2072 6574 7572 6e20 7365 6c66 2e6c 616e   return self.lan
+0000b790: 6775 6167 655f 6d6f 6465 6c2e 6765 745f  guage_model.get_
+0000b7a0: 6f75 7470 7574 5f65 6d62 6564 6469 6e67  output_embedding
+0000b7b0: 7328 290a 0a20 2020 2064 6566 2067 6574  s()..    def get
+0000b7c0: 5f65 6e63 6f64 6572 2873 656c 6629 3a0a  _encoder(self):.
+0000b7d0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+0000b7e0: 656c 662e 6c61 6e67 7561 6765 5f6d 6f64  elf.language_mod
+0000b7f0: 656c 2e67 6574 5f65 6e63 6f64 6572 2829  el.get_encoder()
+0000b800: 0a0a 2020 2020 6465 6620 6765 745f 6465  ..    def get_de
+0000b810: 636f 6465 7228 7365 6c66 293a 0a20 2020  coder(self):.   
+0000b820: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+0000b830: 2e6c 616e 6775 6167 655f 6d6f 6465 6c2e  .language_model.
+0000b840: 6765 745f 6465 636f 6465 7228 290a 0a20  get_decoder().. 
+0000b850: 2020 2064 6566 205f 7469 655f 7765 6967     def _tie_weig
+0000b860: 6874 7328 7365 6c66 293a 0a20 2020 2020  hts(self):.     
+0000b870: 2020 2069 6620 6e6f 7420 7365 6c66 2e63     if not self.c
+0000b880: 6f6e 6669 672e 7573 655f 6465 636f 6465  onfig.use_decode
+0000b890: 725f 6f6e 6c79 5f6c 616e 6775 6167 655f  r_only_language_
+0000b8a0: 6d6f 6465 6c3a 0a20 2020 2020 2020 2020  model:.         
+0000b8b0: 2020 2073 656c 662e 6c61 6e67 7561 6765     self.language
+0000b8c0: 5f6d 6f64 656c 2e65 6e63 6f64 6572 2e65  _model.encoder.e
+0000b8d0: 6d62 6564 5f74 6f6b 656e 7320 3d20 7365  mbed_tokens = se
+0000b8e0: 6c66 2e6c 616e 6775 6167 655f 6d6f 6465  lf.language_mode
+0000b8f0: 6c2e 7368 6172 6564 0a20 2020 2020 2020  l.shared.       
+0000b900: 2020 2020 2073 656c 662e 6c61 6e67 7561       self.langua
+0000b910: 6765 5f6d 6f64 656c 2e64 6563 6f64 6572  ge_model.decoder
+0000b920: 2e65 6d62 6564 5f74 6f6b 656e 7320 3d20  .embed_tokens = 
+0000b930: 7365 6c66 2e6c 616e 6775 6167 655f 6d6f  self.language_mo
+0000b940: 6465 6c2e 7368 6172 6564 0a0a 2020 2020  del.shared..    
+0000b950: 6465 6620 6765 745f 7465 7874 5f66 6561  def get_text_fea
+0000b960: 7475 7265 7328 0a20 2020 2020 2020 2073  tures(.        s
+0000b970: 656c 662c 0a20 2020 2020 2020 2069 6e70  elf,.        inp
+0000b980: 7574 5f69 6473 3a20 4f70 7469 6f6e 616c  ut_ids: Optional
+0000b990: 5b6d 696e 6473 706f 7265 2e54 656e 736f  [mindspore.Tenso
+0000b9a0: 725d 203d 204e 6f6e 652c 0a20 2020 2020  r] = None,.     
+0000b9b0: 2020 2061 7474 656e 7469 6f6e 5f6d 6173     attention_mas
+0000b9c0: 6b3a 204f 7074 696f 6e61 6c5b 6d69 6e64  k: Optional[mind
+0000b9d0: 7370 6f72 652e 5465 6e73 6f72 5d20 3d20  spore.Tensor] = 
+0000b9e0: 4e6f 6e65 2c0a 2020 2020 2020 2020 6465  None,.        de
+0000b9f0: 636f 6465 725f 696e 7075 745f 6964 733a  coder_input_ids:
+0000ba00: 204f 7074 696f 6e61 6c5b 6d69 6e64 7370   Optional[mindsp
+0000ba10: 6f72 652e 5465 6e73 6f72 5d20 3d20 4e6f  ore.Tensor] = No
+0000ba20: 6e65 2c0a 2020 2020 2020 2020 6465 636f  ne,.        deco
+0000ba30: 6465 725f 6174 7465 6e74 696f 6e5f 6d61  der_attention_ma
+0000ba40: 736b 3a20 4f70 7469 6f6e 616c 5b6d 696e  sk: Optional[min
+0000ba50: 6473 706f 7265 2e54 656e 736f 725d 203d  dspore.Tensor] =
+0000ba60: 204e 6f6e 652c 0a20 2020 2020 2020 206c   None,.        l
+0000ba70: 6162 656c 733a 204f 7074 696f 6e61 6c5b  abels: Optional[
+0000ba80: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+0000ba90: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+0000baa0: 2020 6f75 7470 7574 5f61 7474 656e 7469    output_attenti
+0000bab0: 6f6e 733a 204f 7074 696f 6e61 6c5b 626f  ons: Optional[bo
+0000bac0: 6f6c 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ol] = None,.    
+0000bad0: 2020 2020 6f75 7470 7574 5f68 6964 6465      output_hidde
+0000bae0: 6e5f 7374 6174 6573 3a20 4f70 7469 6f6e  n_states: Option
+0000baf0: 616c 5b62 6f6f 6c5d 203d 204e 6f6e 652c  al[bool] = None,
+0000bb00: 0a20 2020 2020 2020 2072 6574 7572 6e5f  .        return_
+0000bb10: 6469 6374 3a20 4f70 7469 6f6e 616c 5b62  dict: Optional[b
+0000bb20: 6f6f 6c5d 203d 204e 6f6e 652c 0a20 2020  ool] = None,.   
+0000bb30: 2029 3a0a 2020 2020 2020 2020 7222 2222   ):.        r"""
+0000bb40: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
+0000bb50: 3a0a 2020 2020 2020 2020 2020 2020 7465  :.            te
+0000bb60: 7874 5f6f 7574 7075 7473 2028 6043 6175  xt_outputs (`Cau
+0000bb70: 7361 6c4c 4d4f 7574 7075 7457 6974 6850  salLMOutputWithP
+0000bb80: 6173 7460 2c20 6f72 2060 7475 706c 6528  ast`, or `tuple(
+0000bb90: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+0000bba0: 2960 2069 6620 6072 6574 7572 6e5f 6469  )` if `return_di
+0000bbb0: 6374 3d46 616c 7365 6029 3a0a 2020 2020  ct=False`):.    
+0000bbc0: 2020 2020 2020 2020 2020 2020 5468 6520              The 
+0000bbd0: 6c61 6e67 7561 6765 206d 6f64 656c 206f  language model o
+0000bbe0: 7574 7075 7473 2e20 4966 2060 7265 7475  utputs. If `retu
+0000bbf0: 726e 5f64 6963 743d 5472 7565 602c 2074  rn_dict=True`, t
+0000bc00: 6865 206f 7574 7075 7420 6973 2061 205b  he output is a [
+0000bc10: 6043 6175 7361 6c4c 4d4f 7574 7075 7457  `CausalLMOutputW
+0000bc20: 6974 6850 6173 7460 5d20 7468 6174 0a20  ithPast`] that. 
+0000bc30: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0000bc40: 6f6e 7461 696e 7320 7468 6520 6c61 6e67  ontains the lang
+0000bc50: 7561 6765 206d 6f64 656c 206c 6f67 6974  uage model logit
+0000bc60: 732c 2074 6865 2070 6173 7420 6b65 7920  s, the past key 
+0000bc70: 7661 6c75 6573 2061 6e64 2074 6865 2068  values and the h
+0000bc80: 6964 6465 6e20 7374 6174 6573 2069 660a  idden states if.
+0000bc90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bca0: 606f 7574 7075 745f 6869 6464 656e 5f73  `output_hidden_s
+0000bcb0: 7461 7465 733d 5472 7565 602e 0a20 2020  tates=True`..   
+0000bcc0: 2020 2020 2045 7861 6d70 6c65 733a 0a20       Examples:. 
+0000bcd0: 2020 2020 2020 2060 6060 7079 7468 6f6e         ```python
+0000bce0: 0a20 2020 2020 2020 203e 3e3e 2069 6d70  .        >>> imp
+0000bcf0: 6f72 7420 746f 7263 680a 2020 2020 2020  ort torch.      
+0000bd00: 2020 3e3e 3e20 6672 6f6d 2074 7261 6e73    >>> from trans
+0000bd10: 666f 726d 6572 7320 696d 706f 7274 2041  formers import A
+0000bd20: 7574 6f54 6f6b 656e 697a 6572 2c20 426c  utoTokenizer, Bl
+0000bd30: 6970 324d 6f64 656c 0a0a 2020 2020 2020  ip2Model..      
+0000bd40: 2020 3e3e 3e20 6d6f 6465 6c20 3d20 426c    >>> model = Bl
+0000bd50: 6970 324d 6f64 656c 2e66 726f 6d5f 7072  ip2Model.from_pr
+0000bd60: 6574 7261 696e 6564 2822 5361 6c65 7366  etrained("Salesf
+0000bd70: 6f72 6365 2f62 6c69 7032 2d6f 7074 2d32  orce/blip2-opt-2
+0000bd80: 2e37 6222 290a 0a20 2020 2020 2020 203e  .7b")..        >
+0000bd90: 3e3e 2074 6f6b 656e 697a 6572 203d 2041  >> tokenizer = A
+0000bda0: 7574 6f54 6f6b 656e 697a 6572 2e66 726f  utoTokenizer.fro
+0000bdb0: 6d5f 7072 6574 7261 696e 6564 2822 5361  m_pretrained("Sa
+0000bdc0: 6c65 7366 6f72 6365 2f62 6c69 7032 2d6f  lesforce/blip2-o
+0000bdd0: 7074 2d32 2e37 6222 290a 2020 2020 2020  pt-2.7b").      
+0000bde0: 2020 3e3e 3e20 696e 7075 7473 203d 2074    >>> inputs = t
+0000bdf0: 6f6b 656e 697a 6572 285b 2261 2070 686f  okenizer(["a pho
+0000be00: 746f 206f 6620 6120 6361 7422 5d2c 2070  to of a cat"], p
+0000be10: 6164 6469 6e67 3d54 7275 652c 2072 6574  adding=True, ret
+0000be20: 7572 6e5f 7465 6e73 6f72 733d 2270 7422  urn_tensors="pt"
+0000be30: 290a 2020 2020 2020 2020 3e3e 3e20 7465  ).        >>> te
+0000be40: 7874 5f66 6561 7475 7265 7320 3d20 6d6f  xt_features = mo
+0000be50: 6465 6c2e 6765 745f 7465 7874 5f66 6561  del.get_text_fea
+0000be60: 7475 7265 7328 2a2a 696e 7075 7473 290a  tures(**inputs).
+0000be70: 2020 2020 2020 2020 6060 6022 2222 0a20          ```""". 
+0000be80: 2020 2020 2020 206f 7574 7075 745f 6174         output_at
+0000be90: 7465 6e74 696f 6e73 203d 206f 7574 7075  tentions = outpu
+0000bea0: 745f 6174 7465 6e74 696f 6e73 2069 6620  t_attentions if 
+0000beb0: 6f75 7470 7574 5f61 7474 656e 7469 6f6e  output_attention
+0000bec0: 7320 6973 206e 6f74 204e 6f6e 6520 656c  s is not None el
+0000bed0: 7365 2073 656c 662e 636f 6e66 6967 2e6f  se self.config.o
+0000bee0: 7574 7075 745f 6174 7465 6e74 696f 6e73  utput_attentions
+0000bef0: 0a20 2020 2020 2020 206f 7574 7075 745f  .        output_
+0000bf00: 6869 6464 656e 5f73 7461 7465 7320 3d20  hidden_states = 
+0000bf10: 280a 2020 2020 2020 2020 2020 2020 6f75  (.            ou
+0000bf20: 7470 7574 5f68 6964 6465 6e5f 7374 6174  tput_hidden_stat
+0000bf30: 6573 2069 6620 6f75 7470 7574 5f68 6964  es if output_hid
+0000bf40: 6465 6e5f 7374 6174 6573 2069 7320 6e6f  den_states is no
+0000bf50: 7420 4e6f 6e65 2065 6c73 6520 7365 6c66  t None else self
+0000bf60: 2e63 6f6e 6669 672e 6f75 7470 7574 5f68  .config.output_h
+0000bf70: 6964 6465 6e5f 7374 6174 6573 0a20 2020  idden_states.   
+0000bf80: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
+0000bf90: 6574 7572 6e5f 6469 6374 203d 2072 6574  eturn_dict = ret
+0000bfa0: 7572 6e5f 6469 6374 2069 6620 7265 7475  urn_dict if retu
+0000bfb0: 726e 5f64 6963 7420 6973 206e 6f74 204e  rn_dict is not N
+0000bfc0: 6f6e 6520 656c 7365 2073 656c 662e 636f  one else self.co
+0000bfd0: 6e66 6967 2e75 7365 5f72 6574 7572 6e5f  nfig.use_return_
+0000bfe0: 6469 6374 0a0a 2020 2020 2020 2020 6966  dict..        if
+0000bff0: 2073 656c 662e 636f 6e66 6967 2e75 7365   self.config.use
+0000c000: 5f64 6563 6f64 6572 5f6f 6e6c 795f 6c61  _decoder_only_la
+0000c010: 6e67 7561 6765 5f6d 6f64 656c 3a0a 2020  nguage_model:.  
+0000c020: 2020 2020 2020 2020 2020 7465 7874 5f6f            text_o
+0000c030: 7574 7075 7473 203d 2073 656c 662e 6c61  utputs = self.la
+0000c040: 6e67 7561 6765 5f6d 6f64 656c 280a 2020  nguage_model(.  
+0000c050: 2020 2020 2020 2020 2020 2020 2020 696e                in
+0000c060: 7075 745f 6964 733d 696e 7075 745f 6964  put_ids=input_id
+0000c070: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+0000c080: 2020 2061 7474 656e 7469 6f6e 5f6d 6173     attention_mas
+0000c090: 6b3d 6174 7465 6e74 696f 6e5f 6d61 736b  k=attention_mask
+0000c0a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000c0b0: 2020 6f75 7470 7574 5f61 7474 656e 7469    output_attenti
+0000c0c0: 6f6e 733d 6f75 7470 7574 5f61 7474 656e  ons=output_atten
+0000c0d0: 7469 6f6e 732c 0a20 2020 2020 2020 2020  tions,.         
+0000c0e0: 2020 2020 2020 206f 7574 7075 745f 6869         output_hi
+0000c0f0: 6464 656e 5f73 7461 7465 733d 6f75 7470  dden_states=outp
+0000c100: 7574 5f68 6964 6465 6e5f 7374 6174 6573  ut_hidden_states
+0000c110: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000c120: 2020 7265 7475 726e 5f64 6963 743d 7265    return_dict=re
+0000c130: 7475 726e 5f64 6963 742c 0a20 2020 2020  turn_dict,.     
+0000c140: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0000c150: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0000c160: 2020 2069 6e70 7574 735f 656d 6265 6473     inputs_embeds
+0000c170: 203d 2073 656c 662e 6c61 6e67 7561 6765   = self.language
+0000c180: 5f6d 6f64 656c 2e67 6574 5f69 6e70 7574  _model.get_input
+0000c190: 5f65 6d62 6564 6469 6e67 7328 2928 696e  _embeddings()(in
+0000c1a0: 7075 745f 6964 7329 0a0a 2020 2020 2020  put_ids)..      
+0000c1b0: 2020 2020 2020 7465 7874 5f6f 7574 7075        text_outpu
+0000c1c0: 7473 203d 2073 656c 662e 6c61 6e67 7561  ts = self.langua
+0000c1d0: 6765 5f6d 6f64 656c 280a 2020 2020 2020  ge_model(.      
+0000c1e0: 2020 2020 2020 2020 2020 696e 7075 7473            inputs
+0000c1f0: 5f65 6d62 6564 733d 696e 7075 7473 5f65  _embeds=inputs_e
+0000c200: 6d62 6564 732c 0a20 2020 2020 2020 2020  mbeds,.         
+0000c210: 2020 2020 2020 2061 7474 656e 7469 6f6e         attention
+0000c220: 5f6d 6173 6b3d 6174 7465 6e74 696f 6e5f  _mask=attention_
+0000c230: 6d61 736b 2c0a 2020 2020 2020 2020 2020  mask,.          
+0000c240: 2020 2020 2020 6465 636f 6465 725f 696e        decoder_in
+0000c250: 7075 745f 6964 733d 6465 636f 6465 725f  put_ids=decoder_
+0000c260: 696e 7075 745f 6964 732c 0a20 2020 2020  input_ids,.     
+0000c270: 2020 2020 2020 2020 2020 2064 6563 6f64             decod
+0000c280: 6572 5f61 7474 656e 7469 6f6e 5f6d 6173  er_attention_mas
+0000c290: 6b3d 6465 636f 6465 725f 6174 7465 6e74  k=decoder_attent
+0000c2a0: 696f 6e5f 6d61 736b 2c0a 2020 2020 2020  ion_mask,.      
+0000c2b0: 2020 2020 2020 2020 2020 6f75 7470 7574            output
+0000c2c0: 5f61 7474 656e 7469 6f6e 733d 6f75 7470  _attentions=outp
+0000c2d0: 7574 5f61 7474 656e 7469 6f6e 732c 0a20  ut_attentions,. 
+0000c2e0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+0000c2f0: 7574 7075 745f 6869 6464 656e 5f73 7461  utput_hidden_sta
+0000c300: 7465 733d 6f75 7470 7574 5f68 6964 6465  tes=output_hidde
+0000c310: 6e5f 7374 6174 6573 2c0a 2020 2020 2020  n_states,.      
+0000c320: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000c330: 5f64 6963 743d 7265 7475 726e 5f64 6963  _dict=return_dic
+0000c340: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+0000c350: 2020 206c 6162 656c 733d 6c61 6265 6c73     labels=labels
+0000c360: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+0000c370: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000c380: 7465 7874 5f6f 7574 7075 7473 0a0a 2020  text_outputs..  
+0000c390: 2020 6465 6620 6765 745f 696d 6167 655f    def get_image_
+0000c3a0: 6665 6174 7572 6573 280a 2020 2020 2020  features(.      
+0000c3b0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+0000c3c0: 7069 7865 6c5f 7661 6c75 6573 3a20 4f70  pixel_values: Op
+0000c3d0: 7469 6f6e 616c 5b6d 696e 6473 706f 7265  tional[mindspore
+0000c3e0: 2e54 656e 736f 725d 203d 204e 6f6e 652c  .Tensor] = None,
+0000c3f0: 0a20 2020 2020 2020 206f 7574 7075 745f  .        output_
+0000c400: 6174 7465 6e74 696f 6e73 3a20 4f70 7469  attentions: Opti
+0000c410: 6f6e 616c 5b62 6f6f 6c5d 203d 204e 6f6e  onal[bool] = Non
+0000c420: 652c 0a20 2020 2020 2020 206f 7574 7075  e,.        outpu
+0000c430: 745f 6869 6464 656e 5f73 7461 7465 733a  t_hidden_states:
+0000c440: 204f 7074 696f 6e61 6c5b 626f 6f6c 5d20   Optional[bool] 
+0000c450: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+0000c460: 7265 7475 726e 5f64 6963 743a 204f 7074  return_dict: Opt
+0000c470: 696f 6e61 6c5b 626f 6f6c 5d20 3d20 4e6f  ional[bool] = No
+0000c480: 6e65 2c0a 2020 2020 293a 0a20 2020 2020  ne,.    ):.     
+0000c490: 2020 2072 2222 220a 2020 2020 2020 2020     r""".        
+0000c4a0: 5265 7475 726e 733a 0a20 2020 2020 2020  Returns:.       
+0000c4b0: 2020 2020 2076 6973 696f 6e5f 6f75 7470       vision_outp
+0000c4c0: 7574 7320 2860 4261 7365 4d6f 6465 6c4f  uts (`BaseModelO
+0000c4d0: 7574 7075 7457 6974 6850 6f6f 6c69 6e67  utputWithPooling
+0000c4e0: 6020 6f72 2074 7570 6c65 206f 6620 606d  ` or tuple of `m
+0000c4f0: 696e 6473 706f 7265 2e54 656e 736f 7260  indspore.Tensor`
+0000c500: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0000c510: 2020 2054 6865 2076 6973 696f 6e20 6d6f     The vision mo
+0000c520: 6465 6c20 6f75 7470 7574 732e 2049 6620  del outputs. If 
+0000c530: 6072 6574 7572 6e5f 6469 6374 3d54 7275  `return_dict=Tru
+0000c540: 6560 2c20 7468 6520 6f75 7470 7574 2069  e`, the output i
+0000c550: 7320 6120 5b60 4261 7365 4d6f 6465 6c4f  s a [`BaseModelO
+0000c560: 7574 7075 7457 6974 6850 6f6f 6c69 6e67  utputWithPooling
+0000c570: 605d 2074 6861 740a 2020 2020 2020 2020  `] that.        
+0000c580: 2020 2020 2020 2020 636f 6e74 6169 6e73          contains
+0000c590: 2074 6865 2069 6d61 6765 2066 6561 7475   the image featu
+0000c5a0: 7265 732c 2074 6865 2070 6f6f 6c65 6420  res, the pooled 
+0000c5b0: 696d 6167 6520 6665 6174 7572 6573 2061  image features a
+0000c5c0: 6e64 2074 6865 2068 6964 6465 6e20 7374  nd the hidden st
+0000c5d0: 6174 6573 2069 660a 2020 2020 2020 2020  ates if.        
+0000c5e0: 2020 2020 2020 2020 606f 7574 7075 745f          `output_
+0000c5f0: 6869 6464 656e 5f73 7461 7465 733d 5472  hidden_states=Tr
+0000c600: 7565 602e 0a20 2020 2020 2020 2045 7861  ue`..        Exa
+0000c610: 6d70 6c65 733a 0a20 2020 2020 2020 2060  mples:.        `
+0000c620: 6060 7079 7468 6f6e 0a20 2020 2020 2020  ``python.       
+0000c630: 203e 3e3e 2069 6d70 6f72 7420 746f 7263   >>> import torc
+0000c640: 680a 2020 2020 2020 2020 3e3e 3e20 6672  h.        >>> fr
+0000c650: 6f6d 2050 494c 2069 6d70 6f72 7420 496d  om PIL import Im
+0000c660: 6167 650a 2020 2020 2020 2020 3e3e 3e20  age.        >>> 
+0000c670: 696d 706f 7274 2072 6571 7565 7374 730a  import requests.
+0000c680: 2020 2020 2020 2020 3e3e 3e20 6672 6f6d          >>> from
+0000c690: 2074 7261 6e73 666f 726d 6572 7320 696d   transformers im
+0000c6a0: 706f 7274 2041 7574 6f50 726f 6365 7373  port AutoProcess
+0000c6b0: 6f72 2c20 426c 6970 324d 6f64 656c 0a0a  or, Blip2Model..
+0000c6c0: 2020 2020 2020 2020 3e3e 3e20 6d6f 6465          >>> mode
+0000c6d0: 6c20 3d20 426c 6970 324d 6f64 656c 2e66  l = Blip2Model.f
+0000c6e0: 726f 6d5f 7072 6574 7261 696e 6564 2822  rom_pretrained("
+0000c6f0: 5361 6c65 7366 6f72 6365 2f62 6c69 7032  Salesforce/blip2
+0000c700: 2d6f 7074 2d32 2e37 6222 290a 0a20 2020  -opt-2.7b")..   
+0000c710: 2020 2020 203e 3e3e 2070 726f 6365 7373       >>> process
+0000c720: 6f72 203d 2041 7574 6f50 726f 6365 7373  or = AutoProcess
+0000c730: 6f72 2e66 726f 6d5f 7072 6574 7261 696e  or.from_pretrain
+0000c740: 6564 2822 5361 6c65 7366 6f72 6365 2f62  ed("Salesforce/b
+0000c750: 6c69 7032 2d6f 7074 2d32 2e37 6222 290a  lip2-opt-2.7b").
+0000c760: 2020 2020 2020 2020 3e3e 3e20 7572 6c20          >>> url 
+0000c770: 3d20 2268 7474 703a 2f2f 696d 6167 6573  = "http://images
+0000c780: 2e63 6f63 6f64 6174 6173 6574 2e6f 7267  .cocodataset.org
+0000c790: 2f76 616c 3230 3137 2f30 3030 3030 3030  /val2017/0000000
+0000c7a0: 3339 3736 392e 6a70 6722 0a20 2020 2020  39769.jpg".     
+0000c7b0: 2020 203e 3e3e 2069 6d61 6765 203d 2049     >>> image = I
+0000c7c0: 6d61 6765 2e6f 7065 6e28 7265 7175 6573  mage.open(reques
+0000c7d0: 7473 2e67 6574 2875 726c 2c20 7374 7265  ts.get(url, stre
+0000c7e0: 616d 3d54 7275 6529 2e72 6177 290a 2020  am=True).raw).  
+0000c7f0: 2020 2020 2020 3e3e 3e20 696e 7075 7473        >>> inputs
+0000c800: 203d 2070 726f 6365 7373 6f72 2869 6d61   = processor(ima
+0000c810: 6765 733d 696d 6167 652c 2072 6574 7572  ges=image, retur
+0000c820: 6e5f 7465 6e73 6f72 733d 2270 7422 290a  n_tensors="pt").
+0000c830: 2020 2020 2020 2020 3e3e 3e20 696d 6167          >>> imag
+0000c840: 655f 6f75 7470 7574 7320 3d20 6d6f 6465  e_outputs = mode
+0000c850: 6c2e 6765 745f 696d 6167 655f 6665 6174  l.get_image_feat
+0000c860: 7572 6573 282a 2a69 6e70 7574 7329 0a20  ures(**inputs). 
+0000c870: 2020 2020 2020 2060 6060 2222 220a 2020         ```""".  
+0000c880: 2020 2020 2020 6f75 7470 7574 5f61 7474        output_att
+0000c890: 656e 7469 6f6e 7320 3d20 6f75 7470 7574  entions = output
+0000c8a0: 5f61 7474 656e 7469 6f6e 7320 6966 206f  _attentions if o
+0000c8b0: 7574 7075 745f 6174 7465 6e74 696f 6e73  utput_attentions
+0000c8c0: 2069 7320 6e6f 7420 4e6f 6e65 2065 6c73   is not None els
+0000c8d0: 6520 7365 6c66 2e63 6f6e 6669 672e 6f75  e self.config.ou
+0000c8e0: 7470 7574 5f61 7474 656e 7469 6f6e 730a  tput_attentions.
+0000c8f0: 2020 2020 2020 2020 6f75 7470 7574 5f68          output_h
+0000c900: 6964 6465 6e5f 7374 6174 6573 203d 2028  idden_states = (
+0000c910: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
+0000c920: 7075 745f 6869 6464 656e 5f73 7461 7465  put_hidden_state
+0000c930: 7320 6966 206f 7574 7075 745f 6869 6464  s if output_hidd
+0000c940: 656e 5f73 7461 7465 7320 6973 206e 6f74  en_states is not
+0000c950: 204e 6f6e 6520 656c 7365 2073 656c 662e   None else self.
+0000c960: 636f 6e66 6967 2e6f 7574 7075 745f 6869  config.output_hi
+0000c970: 6464 656e 5f73 7461 7465 730a 2020 2020  dden_states.    
+0000c980: 2020 2020 290a 2020 2020 2020 2020 7265      ).        re
+0000c990: 7475 726e 5f64 6963 7420 3d20 7265 7475  turn_dict = retu
+0000c9a0: 726e 5f64 6963 7420 6966 2072 6574 7572  rn_dict if retur
+0000c9b0: 6e5f 6469 6374 2069 7320 6e6f 7420 4e6f  n_dict is not No
+0000c9c0: 6e65 2065 6c73 6520 7365 6c66 2e63 6f6e  ne else self.con
+0000c9d0: 6669 672e 7573 655f 7265 7475 726e 5f64  fig.use_return_d
+0000c9e0: 6963 740a 0a20 2020 2020 2020 2076 6973  ict..        vis
+0000c9f0: 696f 6e5f 6f75 7470 7574 7320 3d20 7365  ion_outputs = se
+0000ca00: 6c66 2e76 6973 696f 6e5f 6d6f 6465 6c28  lf.vision_model(
+0000ca10: 0a20 2020 2020 2020 2020 2020 2070 6978  .            pix
+0000ca20: 656c 5f76 616c 7565 733d 7069 7865 6c5f  el_values=pixel_
+0000ca30: 7661 6c75 6573 2c0a 2020 2020 2020 2020  values,.        
+0000ca40: 2020 2020 6f75 7470 7574 5f61 7474 656e      output_atten
+0000ca50: 7469 6f6e 733d 6f75 7470 7574 5f61 7474  tions=output_att
+0000ca60: 656e 7469 6f6e 732c 0a20 2020 2020 2020  entions,.       
+0000ca70: 2020 2020 206f 7574 7075 745f 6869 6464       output_hidd
+0000ca80: 656e 5f73 7461 7465 733d 6f75 7470 7574  en_states=output
+0000ca90: 5f68 6964 6465 6e5f 7374 6174 6573 2c0a  _hidden_states,.
+0000caa0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000cab0: 726e 5f64 6963 743d 7265 7475 726e 5f64  rn_dict=return_d
+0000cac0: 6963 742c 0a20 2020 2020 2020 2029 0a0a  ict,.        )..
+0000cad0: 2020 2020 2020 2020 7265 7475 726e 2076          return v
+0000cae0: 6973 696f 6e5f 6f75 7470 7574 730a 0a20  ision_outputs.. 
+0000caf0: 2020 2064 6566 2067 6574 5f71 666f 726d     def get_qform
+0000cb00: 6572 5f66 6561 7475 7265 7328 0a20 2020  er_features(.   
+0000cb10: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+0000cb20: 2020 2070 6978 656c 5f76 616c 7565 733a     pixel_values:
+0000cb30: 204f 7074 696f 6e61 6c5b 6d69 6e64 7370   Optional[mindsp
+0000cb40: 6f72 652e 5465 6e73 6f72 5d20 3d20 4e6f  ore.Tensor] = No
+0000cb50: 6e65 2c0a 2020 2020 2020 2020 6f75 7470  ne,.        outp
+0000cb60: 7574 5f61 7474 656e 7469 6f6e 733a 204f  ut_attentions: O
+0000cb70: 7074 696f 6e61 6c5b 626f 6f6c 5d20 3d20  ptional[bool] = 
+0000cb80: 4e6f 6e65 2c0a 2020 2020 2020 2020 6f75  None,.        ou
+0000cb90: 7470 7574 5f68 6964 6465 6e5f 7374 6174  tput_hidden_stat
+0000cba0: 6573 3a20 4f70 7469 6f6e 616c 5b62 6f6f  es: Optional[boo
+0000cbb0: 6c5d 203d 204e 6f6e 652c 0a20 2020 2020  l] = None,.     
+0000cbc0: 2020 2072 6574 7572 6e5f 6469 6374 3a20     return_dict: 
+0000cbd0: 4f70 7469 6f6e 616c 5b62 6f6f 6c5d 203d  Optional[bool] =
+0000cbe0: 204e 6f6e 652c 0a20 2020 2029 3a0a 2020   None,.    ):.  
+0000cbf0: 2020 2020 2020 7222 2222 0a20 2020 2020        r""".     
+0000cc00: 2020 2052 6574 7572 6e73 3a0a 2020 2020     Returns:.    
+0000cc10: 2020 2020 2020 2020 7669 7369 6f6e 5f6f          vision_o
+0000cc20: 7574 7075 7473 2028 6042 6173 654d 6f64  utputs (`BaseMod
+0000cc30: 656c 4f75 7470 7574 5769 7468 506f 6f6c  elOutputWithPool
+0000cc40: 696e 6760 206f 7220 7475 706c 6520 6f66  ing` or tuple of
+0000cc50: 2060 6d69 6e64 7370 6f72 652e 5465 6e73   `mindspore.Tens
+0000cc60: 6f72 6029 3a0a 2020 2020 2020 2020 2020  or`):.          
+0000cc70: 2020 2020 2020 5468 6520 7669 7369 6f6e        The vision
+0000cc80: 206d 6f64 656c 206f 7574 7075 7473 2e20   model outputs. 
+0000cc90: 4966 2060 7265 7475 726e 5f64 6963 743d  If `return_dict=
+0000cca0: 5472 7565 602c 2074 6865 206f 7574 7075  True`, the outpu
+0000ccb0: 7420 6973 2061 205b 6042 6173 654d 6f64  t is a [`BaseMod
+0000ccc0: 656c 4f75 7470 7574 5769 7468 506f 6f6c  elOutputWithPool
+0000ccd0: 696e 6760 5d20 7468 6174 0a20 2020 2020  ing`] that.     
+0000cce0: 2020 2020 2020 2020 2020 2063 6f6e 7461             conta
+0000ccf0: 696e 7320 7468 6520 696d 6167 6520 6665  ins the image fe
+0000cd00: 6174 7572 6573 2c20 7468 6520 706f 6f6c  atures, the pool
+0000cd10: 6564 2069 6d61 6765 2066 6561 7475 7265  ed image feature
+0000cd20: 7320 616e 6420 7468 6520 6869 6464 656e  s and the hidden
+0000cd30: 2073 7461 7465 7320 6966 0a20 2020 2020   states if.     
+0000cd40: 2020 2020 2020 2020 2020 2060 6f75 7470             `outp
+0000cd50: 7574 5f68 6964 6465 6e5f 7374 6174 6573  ut_hidden_states
+0000cd60: 3d54 7275 6560 2e0a 2020 2020 2020 2020  =True`..        
+0000cd70: 4578 616d 706c 6573 3a0a 2020 2020 2020  Examples:.      
+0000cd80: 2020 6060 6070 7974 686f 6e0a 2020 2020    ```python.    
+0000cd90: 2020 2020 3e3e 3e20 696d 706f 7274 2074      >>> import t
+0000cda0: 6f72 6368 0a20 2020 2020 2020 203e 3e3e  orch.        >>>
+0000cdb0: 2066 726f 6d20 5049 4c20 696d 706f 7274   from PIL import
+0000cdc0: 2049 6d61 6765 0a20 2020 2020 2020 203e   Image.        >
+0000cdd0: 3e3e 2069 6d70 6f72 7420 7265 7175 6573  >> import reques
+0000cde0: 7473 0a20 2020 2020 2020 203e 3e3e 2066  ts.        >>> f
+0000cdf0: 726f 6d20 7472 616e 7366 6f72 6d65 7273  rom transformers
+0000ce00: 2069 6d70 6f72 7420 426c 6970 3250 726f   import Blip2Pro
+0000ce10: 6365 7373 6f72 2c20 426c 6970 324d 6f64  cessor, Blip2Mod
+0000ce20: 656c 0a0a 2020 2020 2020 2020 3e3e 3e20  el..        >>> 
+0000ce30: 7072 6f63 6573 736f 7220 3d20 426c 6970  processor = Blip
+0000ce40: 3250 726f 6365 7373 6f72 2e66 726f 6d5f  2Processor.from_
+0000ce50: 7072 6574 7261 696e 6564 2822 5361 6c65  pretrained("Sale
+0000ce60: 7366 6f72 6365 2f62 6c69 7032 2d6f 7074  sforce/blip2-opt
+0000ce70: 2d32 2e37 6222 290a 2020 2020 2020 2020  -2.7b").        
+0000ce80: 3e3e 3e20 6d6f 6465 6c20 3d20 426c 6970  >>> model = Blip
+0000ce90: 324d 6f64 656c 2e66 726f 6d5f 7072 6574  2Model.from_pret
+0000cea0: 7261 696e 6564 2822 5361 6c65 7366 6f72  rained("Salesfor
+0000ceb0: 6365 2f62 6c69 7032 2d6f 7074 2d32 2e37  ce/blip2-opt-2.7
+0000cec0: 6222 290a 0a20 2020 2020 2020 203e 3e3e  b")..        >>>
+0000ced0: 2075 726c 203d 2022 6874 7470 3a2f 2f69   url = "http://i
+0000cee0: 6d61 6765 732e 636f 636f 6461 7461 7365  mages.cocodatase
+0000cef0: 742e 6f72 672f 7661 6c32 3031 372f 3030  t.org/val2017/00
+0000cf00: 3030 3030 3033 3937 3639 2e6a 7067 220a  0000039769.jpg".
+0000cf10: 2020 2020 2020 2020 3e3e 3e20 696d 6167          >>> imag
+0000cf20: 6520 3d20 496d 6167 652e 6f70 656e 2872  e = Image.open(r
+0000cf30: 6571 7565 7374 732e 6765 7428 7572 6c2c  equests.get(url,
+0000cf40: 2073 7472 6561 6d3d 5472 7565 292e 7261   stream=True).ra
+0000cf50: 7729 0a20 2020 2020 2020 203e 3e3e 2069  w).        >>> i
+0000cf60: 6e70 7574 7320 3d20 7072 6f63 6573 736f  nputs = processo
+0000cf70: 7228 696d 6167 6573 3d69 6d61 6765 2c20  r(images=image, 
+0000cf80: 7265 7475 726e 5f74 656e 736f 7273 3d22  return_tensors="
+0000cf90: 7074 2229 0a20 2020 2020 2020 203e 3e3e  pt").        >>>
+0000cfa0: 2071 666f 726d 6572 5f6f 7574 7075 7473   qformer_outputs
+0000cfb0: 203d 206d 6f64 656c 2e67 6574 5f71 666f   = model.get_qfo
+0000cfc0: 726d 6572 5f66 6561 7475 7265 7328 2a2a  rmer_features(**
+0000cfd0: 696e 7075 7473 290a 2020 2020 2020 2020  inputs).        
+0000cfe0: 6060 6022 2222 0a20 2020 2020 2020 206f  ```""".        o
+0000cff0: 7574 7075 745f 6174 7465 6e74 696f 6e73  utput_attentions
+0000d000: 203d 206f 7574 7075 745f 6174 7465 6e74   = output_attent
+0000d010: 696f 6e73 2069 6620 6f75 7470 7574 5f61  ions if output_a
+0000d020: 7474 656e 7469 6f6e 7320 6973 206e 6f74  ttentions is not
+0000d030: 204e 6f6e 6520 656c 7365 2073 656c 662e   None else self.
+0000d040: 636f 6e66 6967 2e6f 7574 7075 745f 6174  config.output_at
+0000d050: 7465 6e74 696f 6e73 0a20 2020 2020 2020  tentions.       
+0000d060: 206f 7574 7075 745f 6869 6464 656e 5f73   output_hidden_s
+0000d070: 7461 7465 7320 3d20 280a 2020 2020 2020  tates = (.      
+0000d080: 2020 2020 2020 6f75 7470 7574 5f68 6964        output_hid
+0000d090: 6465 6e5f 7374 6174 6573 2069 6620 6f75  den_states if ou
+0000d0a0: 7470 7574 5f68 6964 6465 6e5f 7374 6174  tput_hidden_stat
+0000d0b0: 6573 2069 7320 6e6f 7420 4e6f 6e65 2065  es is not None e
+0000d0c0: 6c73 6520 7365 6c66 2e63 6f6e 6669 672e  lse self.config.
+0000d0d0: 6f75 7470 7574 5f68 6964 6465 6e5f 7374  output_hidden_st
+0000d0e0: 6174 6573 0a20 2020 2020 2020 2029 0a20  ates.        ). 
+0000d0f0: 2020 2020 2020 2072 6574 7572 6e5f 6469         return_di
+0000d100: 6374 203d 2072 6574 7572 6e5f 6469 6374  ct = return_dict
+0000d110: 2069 6620 7265 7475 726e 5f64 6963 7420   if return_dict 
+0000d120: 6973 206e 6f74 204e 6f6e 6520 656c 7365  is not None else
+0000d130: 2073 656c 662e 636f 6e66 6967 2e75 7365   self.config.use
+0000d140: 5f72 6574 7572 6e5f 6469 6374 0a0a 2020  _return_dict..  
+0000d150: 2020 2020 2020 7669 7369 6f6e 5f6f 7574        vision_out
+0000d160: 7075 7473 203d 2073 656c 662e 7669 7369  puts = self.visi
+0000d170: 6f6e 5f6d 6f64 656c 280a 2020 2020 2020  on_model(.      
+0000d180: 2020 2020 2020 7069 7865 6c5f 7661 6c75        pixel_valu
+0000d190: 6573 3d70 6978 656c 5f76 616c 7565 732c  es=pixel_values,
+0000d1a0: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
+0000d1b0: 7075 745f 6174 7465 6e74 696f 6e73 3d6f  put_attentions=o
+0000d1c0: 7574 7075 745f 6174 7465 6e74 696f 6e73  utput_attentions
+0000d1d0: 2c0a 2020 2020 2020 2020 2020 2020 6f75  ,.            ou
+0000d1e0: 7470 7574 5f68 6964 6465 6e5f 7374 6174  tput_hidden_stat
+0000d1f0: 6573 3d6f 7574 7075 745f 6869 6464 656e  es=output_hidden
+0000d200: 5f73 7461 7465 732c 0a20 2020 2020 2020  _states,.       
+0000d210: 2020 2020 2072 6574 7572 6e5f 6469 6374       return_dict
+0000d220: 3d72 6574 7572 6e5f 6469 6374 2c0a 2020  =return_dict,.  
+0000d230: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+0000d240: 2069 6d61 6765 5f65 6d62 6564 7320 3d20   image_embeds = 
+0000d250: 7669 7369 6f6e 5f6f 7574 7075 7473 5b30  vision_outputs[0
+0000d260: 5d0a 0a20 2020 2020 2020 2023 2073 7465  ]..        # ste
+0000d270: 7020 323a 2066 6f72 7761 7264 2074 6865  p 2: forward the
+0000d280: 2071 7565 7279 2074 6f6b 656e 7320 7468   query tokens th
+0000d290: 726f 7567 6820 7468 6520 5146 6f72 6d65  rough the QForme
+0000d2a0: 722c 2075 7369 6e67 2074 6865 2069 6d61  r, using the ima
+0000d2b0: 6765 2065 6d62 6564 6469 6e67 7320 666f  ge embeddings fo
+0000d2c0: 7220 6372 6f73 732d 6174 7465 6e74 696f  r cross-attentio
+0000d2d0: 6e0a 2020 2020 2020 2020 696d 6167 655f  n.        image_
+0000d2e0: 6174 7465 6e74 696f 6e5f 6d61 736b 203d  attention_mask =
+0000d2f0: 206f 7073 2e6f 6e65 7328 696d 6167 655f   ops.ones(image_
+0000d300: 656d 6265 6473 2e73 6861 7065 5b3a 2d31  embeds.shape[:-1
+0000d310: 5d2c 2064 7479 7065 3d6d 696e 6473 706f  ], dtype=mindspo
+0000d320: 7265 2e69 6e74 3634 290a 0a20 2020 2020  re.int64)..     
+0000d330: 2020 2071 7565 7279 5f74 6f6b 656e 7320     query_tokens 
+0000d340: 3d20 7365 6c66 2e71 7565 7279 5f74 6f6b  = self.query_tok
+0000d350: 656e 732e 6578 7061 6e64 2869 6d61 6765  ens.expand(image
+0000d360: 5f65 6d62 6564 732e 7368 6170 655b 305d  _embeds.shape[0]
+0000d370: 2c20 2d31 2c20 2d31 290a 2020 2020 2020  , -1, -1).      
+0000d380: 2020 7175 6572 795f 6f75 7470 7574 7320    query_outputs 
+0000d390: 3d20 7365 6c66 2e71 666f 726d 6572 280a  = self.qformer(.
+0000d3a0: 2020 2020 2020 2020 2020 2020 7175 6572              quer
+0000d3b0: 795f 656d 6265 6473 3d71 7565 7279 5f74  y_embeds=query_t
+0000d3c0: 6f6b 656e 732c 0a20 2020 2020 2020 2020  okens,.         
+0000d3d0: 2020 2065 6e63 6f64 6572 5f68 6964 6465     encoder_hidde
+0000d3e0: 6e5f 7374 6174 6573 3d69 6d61 6765 5f65  n_states=image_e
+0000d3f0: 6d62 6564 732c 0a20 2020 2020 2020 2020  mbeds,.         
+0000d400: 2020 2065 6e63 6f64 6572 5f61 7474 656e     encoder_atten
+0000d410: 7469 6f6e 5f6d 6173 6b3d 696d 6167 655f  tion_mask=image_
+0000d420: 6174 7465 6e74 696f 6e5f 6d61 736b 2c0a  attention_mask,.
+0000d430: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
+0000d440: 7574 5f61 7474 656e 7469 6f6e 733d 6f75  ut_attentions=ou
+0000d450: 7470 7574 5f61 7474 656e 7469 6f6e 732c  tput_attentions,
+0000d460: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
+0000d470: 7075 745f 6869 6464 656e 5f73 7461 7465  put_hidden_state
+0000d480: 733d 6f75 7470 7574 5f68 6964 6465 6e5f  s=output_hidden_
+0000d490: 7374 6174 6573 2c0a 2020 2020 2020 2020  states,.        
+0000d4a0: 2020 2020 7265 7475 726e 5f64 6963 743d      return_dict=
+0000d4b0: 7265 7475 726e 5f64 6963 742c 0a20 2020  return_dict,.   
+0000d4c0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+0000d4d0: 7265 7475 726e 2071 7565 7279 5f6f 7574  return query_out
+0000d4e0: 7075 7473 0a0a 2020 2020 6465 6620 636f  puts..    def co
+0000d4f0: 6e73 7472 7563 7428 0a20 2020 2020 2020  nstruct(.       
+0000d500: 2073 656c 662c 0a20 2020 2020 2020 2070   self,.        p
+0000d510: 6978 656c 5f76 616c 7565 733a 206d 696e  ixel_values: min
+0000d520: 6473 706f 7265 2e54 656e 736f 722c 0a20  dspore.Tensor,. 
+0000d530: 2020 2020 2020 2069 6e70 7574 5f69 6473         input_ids
+0000d540: 3a20 6d69 6e64 7370 6f72 652e 5465 6e73  : mindspore.Tens
+0000d550: 6f72 2c0a 2020 2020 2020 2020 6174 7465  or,.        atte
+0000d560: 6e74 696f 6e5f 6d61 736b 3a20 4f70 7469  ntion_mask: Opti
+0000d570: 6f6e 616c 5b6d 696e 6473 706f 7265 2e54  onal[mindspore.T
+0000d580: 656e 736f 725d 203d 204e 6f6e 652c 0a20  ensor] = None,. 
+0000d590: 2020 2020 2020 2064 6563 6f64 6572 5f69         decoder_i
+0000d5a0: 6e70 7574 5f69 6473 3a20 4f70 7469 6f6e  nput_ids: Option
+0000d5b0: 616c 5b6d 696e 6473 706f 7265 2e54 656e  al[mindspore.Ten
+0000d5c0: 736f 725d 203d 204e 6f6e 652c 0a20 2020  sor] = None,.   
+0000d5d0: 2020 2020 2064 6563 6f64 6572 5f61 7474       decoder_att
+0000d5e0: 656e 7469 6f6e 5f6d 6173 6b3a 204f 7074  ention_mask: Opt
+0000d5f0: 696f 6e61 6c5b 6d69 6e64 7370 6f72 652e  ional[mindspore.
+0000d600: 5465 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a  Tensor] = None,.
+0000d610: 2020 2020 2020 2020 6f75 7470 7574 5f61          output_a
+0000d620: 7474 656e 7469 6f6e 733a 204f 7074 696f  ttentions: Optio
+0000d630: 6e61 6c5b 626f 6f6c 5d20 3d20 4e6f 6e65  nal[bool] = None
+0000d640: 2c0a 2020 2020 2020 2020 6f75 7470 7574  ,.        output
+0000d650: 5f68 6964 6465 6e5f 7374 6174 6573 3a20  _hidden_states: 
+0000d660: 4f70 7469 6f6e 616c 5b62 6f6f 6c5d 203d  Optional[bool] =
+0000d670: 204e 6f6e 652c 0a20 2020 2020 2020 206c   None,.        l
+0000d680: 6162 656c 733a 204f 7074 696f 6e61 6c5b  abels: Optional[
+0000d690: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+0000d6a0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+0000d6b0: 2020 7265 7475 726e 5f64 6963 743a 204f    return_dict: O
+0000d6c0: 7074 696f 6e61 6c5b 626f 6f6c 5d20 3d20  ptional[bool] = 
+0000d6d0: 4e6f 6e65 2c0a 2020 2020 2920 2d3e 2055  None,.    ) -> U
+0000d6e0: 6e69 6f6e 5b54 7570 6c65 2c20 426c 6970  nion[Tuple, Blip
+0000d6f0: 3246 6f72 436f 6e64 6974 696f 6e61 6c47  2ForConditionalG
+0000d700: 656e 6572 6174 696f 6e4d 6f64 656c 4f75  enerationModelOu
+0000d710: 7470 7574 5d3a 0a20 2020 2020 2020 2072  tput]:.        r
+0000d720: 2222 220a 2020 2020 2020 2020 5265 7475  """.        Retu
+0000d730: 726e 733a 0a0a 2020 2020 2020 2020 4578  rns:..        Ex
+0000d740: 616d 706c 6573 3a0a 0a20 2020 2020 2020  amples:..       
+0000d750: 2060 6060 7079 7468 6f6e 0a20 2020 2020   ```python.     
+0000d760: 2020 203e 3e3e 2066 726f 6d20 5049 4c20     >>> from PIL 
+0000d770: 696d 706f 7274 2049 6d61 6765 0a20 2020  import Image.   
+0000d780: 2020 2020 203e 3e3e 2069 6d70 6f72 7420       >>> import 
+0000d790: 7265 7175 6573 7473 0a20 2020 2020 2020  requests.       
+0000d7a0: 203e 3e3e 2066 726f 6d20 7472 616e 7366   >>> from transf
+0000d7b0: 6f72 6d65 7273 2069 6d70 6f72 7420 426c  ormers import Bl
+0000d7c0: 6970 3250 726f 6365 7373 6f72 2c20 426c  ip2Processor, Bl
+0000d7d0: 6970 324d 6f64 656c 0a20 2020 2020 2020  ip2Model.       
+0000d7e0: 203e 3e3e 2069 6d70 6f72 7420 746f 7263   >>> import torc
+0000d7f0: 680a 0a0a 2020 2020 2020 2020 3e3e 3e20  h...        >>> 
+0000d800: 7072 6f63 6573 736f 7220 3d20 426c 6970  processor = Blip
+0000d810: 3250 726f 6365 7373 6f72 2e66 726f 6d5f  2Processor.from_
+0000d820: 7072 6574 7261 696e 6564 2822 5361 6c65  pretrained("Sale
+0000d830: 7366 6f72 6365 2f62 6c69 7032 2d6f 7074  sforce/blip2-opt
+0000d840: 2d32 2e37 6222 290a 2020 2020 2020 2020  -2.7b").        
+0000d850: 3e3e 3e20 6d6f 6465 6c20 3d20 426c 6970  >>> model = Blip
+0000d860: 324d 6f64 656c 2e66 726f 6d5f 7072 6574  2Model.from_pret
+0000d870: 7261 696e 6564 2822 5361 6c65 7366 6f72  rained("Salesfor
+0000d880: 6365 2f62 6c69 7032 2d6f 7074 2d32 2e37  ce/blip2-opt-2.7
+0000d890: 6222 2c20 746f 7263 685f 6474 7970 653d  b", torch_dtype=
+0000d8a0: 746f 7263 682e 666c 6f61 7431 3629 0a0a  torch.float16)..
+0000d8b0: 2020 2020 2020 2020 3e3e 3e20 7572 6c20          >>> url 
+0000d8c0: 3d20 2268 7474 703a 2f2f 696d 6167 6573  = "http://images
+0000d8d0: 2e63 6f63 6f64 6174 6173 6574 2e6f 7267  .cocodataset.org
+0000d8e0: 2f76 616c 3230 3137 2f30 3030 3030 3030  /val2017/0000000
+0000d8f0: 3339 3736 392e 6a70 6722 0a20 2020 2020  39769.jpg".     
+0000d900: 2020 203e 3e3e 2069 6d61 6765 203d 2049     >>> image = I
+0000d910: 6d61 6765 2e6f 7065 6e28 7265 7175 6573  mage.open(reques
+0000d920: 7473 2e67 6574 2875 726c 2c20 7374 7265  ts.get(url, stre
+0000d930: 616d 3d54 7275 6529 2e72 6177 290a 0a20  am=True).raw).. 
+0000d940: 2020 2020 2020 203e 3e3e 2070 726f 6d70         >>> promp
+0000d950: 7420 3d20 2251 7565 7374 696f 6e3a 2068  t = "Question: h
+0000d960: 6f77 206d 616e 7920 6361 7473 2061 7265  ow many cats are
+0000d970: 2074 6865 7265 3f20 416e 7377 6572 3a22   there? Answer:"
+0000d980: 0a20 2020 2020 2020 203e 3e3e 2069 6e70  .        >>> inp
+0000d990: 7574 7320 3d20 7072 6f63 6573 736f 7228  uts = processor(
+0000d9a0: 696d 6167 6573 3d69 6d61 6765 2c20 7465  images=image, te
+0000d9b0: 7874 3d70 726f 6d70 742c 2072 6574 7572  xt=prompt, retur
+0000d9c0: 6e5f 7465 6e73 6f72 733d 2270 7422 292e  n_tensors="pt").
+0000d9d0: 746f 2874 6f72 6368 2e66 6c6f 6174 3136  to(torch.float16
+0000d9e0: 290a 0a20 2020 2020 2020 203e 3e3e 206f  )..        >>> o
+0000d9f0: 7574 7075 7473 203d 206d 6f64 656c 282a  utputs = model(*
+0000da00: 2a69 6e70 7574 7329 0a20 2020 2020 2020  *inputs).       
+0000da10: 2060 6060 2222 220a 2020 2020 2020 2020   ```""".        
+0000da20: 7265 7475 726e 5f64 6963 7420 3d20 7265  return_dict = re
+0000da30: 7475 726e 5f64 6963 7420 6966 2072 6574  turn_dict if ret
+0000da40: 7572 6e5f 6469 6374 2069 7320 6e6f 7420  urn_dict is not 
+0000da50: 4e6f 6e65 2065 6c73 6520 7365 6c66 2e63  None else self.c
+0000da60: 6f6e 6669 672e 7573 655f 7265 7475 726e  onfig.use_return
+0000da70: 5f64 6963 740a 0a20 2020 2020 2020 2023  _dict..        #
+0000da80: 2073 7465 7020 313a 2066 6f72 7761 7264   step 1: forward
+0000da90: 2074 6865 2069 6d61 6765 7320 7468 726f   the images thro
+0000daa0: 7567 6820 7468 6520 7669 7369 6f6e 2065  ugh the vision e
+0000dab0: 6e63 6f64 6572 2c0a 2020 2020 2020 2020  ncoder,.        
+0000dac0: 2320 746f 2067 6574 2069 6d61 6765 2065  # to get image e
+0000dad0: 6d62 6564 6469 6e67 7320 6f66 2073 6861  mbeddings of sha
+0000dae0: 7065 2028 6261 7463 685f 7369 7a65 2c20  pe (batch_size, 
+0000daf0: 7365 715f 6c65 6e2c 2068 6964 6465 6e5f  seq_len, hidden_
+0000db00: 7369 7a65 290a 2020 2020 2020 2020 7669  size).        vi
+0000db10: 7369 6f6e 5f6f 7574 7075 7473 203d 2073  sion_outputs = s
+0000db20: 656c 662e 7669 7369 6f6e 5f6d 6f64 656c  elf.vision_model
+0000db30: 280a 2020 2020 2020 2020 2020 2020 7069  (.            pi
+0000db40: 7865 6c5f 7661 6c75 6573 3d70 6978 656c  xel_values=pixel
+0000db50: 5f76 616c 7565 732c 0a20 2020 2020 2020  _values,.       
+0000db60: 2020 2020 206f 7574 7075 745f 6174 7465       output_atte
+0000db70: 6e74 696f 6e73 3d6f 7574 7075 745f 6174  ntions=output_at
+0000db80: 7465 6e74 696f 6e73 2c0a 2020 2020 2020  tentions,.      
+0000db90: 2020 2020 2020 6f75 7470 7574 5f68 6964        output_hid
+0000dba0: 6465 6e5f 7374 6174 6573 3d6f 7574 7075  den_states=outpu
+0000dbb0: 745f 6869 6464 656e 5f73 7461 7465 732c  t_hidden_states,
+0000dbc0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0000dbd0: 7572 6e5f 6469 6374 3d72 6574 7572 6e5f  urn_dict=return_
+0000dbe0: 6469 6374 2c0a 2020 2020 2020 2020 290a  dict,.        ).
+0000dbf0: 2020 2020 2020 2020 696d 6167 655f 656d          image_em
+0000dc00: 6265 6473 203d 2076 6973 696f 6e5f 6f75  beds = vision_ou
+0000dc10: 7470 7574 735b 305d 0a0a 2020 2020 2020  tputs[0]..      
+0000dc20: 2020 2320 7374 6570 2032 3a20 666f 7277    # step 2: forw
+0000dc30: 6172 6420 7468 6520 7175 6572 7920 746f  ard the query to
+0000dc40: 6b65 6e73 2074 6872 6f75 6768 2074 6865  kens through the
+0000dc50: 2051 466f 726d 6572 2c20 7573 696e 6720   QFormer, using 
+0000dc60: 7468 6520 696d 6167 6520 656d 6265 6464  the image embedd
+0000dc70: 696e 6773 2066 6f72 2063 726f 7373 2d61  ings for cross-a
+0000dc80: 7474 656e 7469 6f6e 0a20 2020 2020 2020  ttention.       
+0000dc90: 2069 6d61 6765 5f61 7474 656e 7469 6f6e   image_attention
+0000dca0: 5f6d 6173 6b20 3d20 6f70 732e 6f6e 6573  _mask = ops.ones
+0000dcb0: 2869 6d61 6765 5f65 6d62 6564 732e 7368  (image_embeds.sh
+0000dcc0: 6170 655b 3a2d 315d 2c20 6474 7970 653d  ape[:-1], dtype=
+0000dcd0: 6d69 6e64 7370 6f72 652e 696e 7436 3429  mindspore.int64)
+0000dce0: 0a0a 2020 2020 2020 2020 7175 6572 795f  ..        query_
+0000dcf0: 746f 6b65 6e73 203d 2073 656c 662e 7175  tokens = self.qu
+0000dd00: 6572 795f 746f 6b65 6e73 2e65 7870 616e  ery_tokens.expan
+0000dd10: 6428 696d 6167 655f 656d 6265 6473 2e73  d(image_embeds.s
+0000dd20: 6861 7065 5b30 5d2c 202d 312c 202d 3129  hape[0], -1, -1)
+0000dd30: 0a20 2020 2020 2020 2071 7565 7279 5f6f  .        query_o
+0000dd40: 7574 7075 7473 203d 2073 656c 662e 7166  utputs = self.qf
+0000dd50: 6f72 6d65 7228 0a20 2020 2020 2020 2020  ormer(.         
+0000dd60: 2020 2071 7565 7279 5f65 6d62 6564 733d     query_embeds=
+0000dd70: 7175 6572 795f 746f 6b65 6e73 2c0a 2020  query_tokens,.  
+0000dd80: 2020 2020 2020 2020 2020 656e 636f 6465            encode
+0000dd90: 725f 6869 6464 656e 5f73 7461 7465 733d  r_hidden_states=
+0000dda0: 696d 6167 655f 656d 6265 6473 2c0a 2020  image_embeds,.  
+0000ddb0: 2020 2020 2020 2020 2020 656e 636f 6465            encode
+0000ddc0: 725f 6174 7465 6e74 696f 6e5f 6d61 736b  r_attention_mask
+0000ddd0: 3d69 6d61 6765 5f61 7474 656e 7469 6f6e  =image_attention
+0000dde0: 5f6d 6173 6b2c 0a20 2020 2020 2020 2020  _mask,.         
+0000ddf0: 2020 206f 7574 7075 745f 6174 7465 6e74     output_attent
+0000de00: 696f 6e73 3d6f 7574 7075 745f 6174 7465  ions=output_atte
+0000de10: 6e74 696f 6e73 2c0a 2020 2020 2020 2020  ntions,.        
+0000de20: 2020 2020 6f75 7470 7574 5f68 6964 6465      output_hidde
+0000de30: 6e5f 7374 6174 6573 3d6f 7574 7075 745f  n_states=output_
+0000de40: 6869 6464 656e 5f73 7461 7465 732c 0a20  hidden_states,. 
+0000de50: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0000de60: 6e5f 6469 6374 3d72 6574 7572 6e5f 6469  n_dict=return_di
+0000de70: 6374 2c0a 2020 2020 2020 2020 290a 2020  ct,.        ).  
+0000de80: 2020 2020 2020 7175 6572 795f 6f75 7470        query_outp
+0000de90: 7574 203d 2071 7565 7279 5f6f 7574 7075  ut = query_outpu
+0000dea0: 7473 5b30 5d0a 0a20 2020 2020 2020 2023  ts[0]..        #
+0000deb0: 2073 7465 7020 333a 2075 7365 2074 6865   step 3: use the
+0000dec0: 206c 616e 6775 6167 6520 6d6f 6465 6c2c   language model,
+0000ded0: 2063 6f6e 6469 7469 6f6e 6564 206f 6e20   conditioned on 
+0000dee0: 7468 6520 7175 6572 7920 6f75 7470 7574  the query output
+0000def0: 7320 616e 6420 7468 6520 7072 6f6d 7074  s and the prompt
+0000df00: 0a20 2020 2020 2020 206c 616e 6775 6167  .        languag
+0000df10: 655f 6d6f 6465 6c5f 696e 7075 7473 203d  e_model_inputs =
+0000df20: 2073 656c 662e 6c61 6e67 7561 6765 5f70   self.language_p
+0000df30: 726f 6a65 6374 696f 6e28 7175 6572 795f  rojection(query_
+0000df40: 6f75 7470 7574 290a 2020 2020 2020 2020  output).        
+0000df50: 6c61 6e67 7561 6765 5f6d 6f64 656c 5f61  language_model_a
+0000df60: 7474 656e 7469 6f6e 5f6d 6173 6b20 3d20  ttention_mask = 
+0000df70: 6f70 732e 6f6e 6573 280a 2020 2020 2020  ops.ones(.      
+0000df80: 2020 2020 2020 6c61 6e67 7561 6765 5f6d        language_m
+0000df90: 6f64 656c 5f69 6e70 7574 732e 7368 6170  odel_inputs.shap
+0000dfa0: 655b 3a2d 315d 2c20 6474 7970 653d 6d69  e[:-1], dtype=mi
+0000dfb0: 6e64 7370 6f72 652e 696e 7436 340a 2020  ndspore.int64.  
+0000dfc0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0000dfd0: 696e 7075 7473 5f65 6d62 6564 7320 3d20  inputs_embeds = 
+0000dfe0: 7365 6c66 2e6c 616e 6775 6167 655f 6d6f  self.language_mo
+0000dff0: 6465 6c2e 6765 745f 696e 7075 745f 656d  del.get_input_em
+0000e000: 6265 6464 696e 6773 2829 2869 6e70 7574  beddings()(input
+0000e010: 5f69 6473 290a 2020 2020 2020 2020 696e  _ids).        in
+0000e020: 7075 7473 5f65 6d62 6564 7320 3d20 6f70  puts_embeds = op
+0000e030: 732e 6361 7428 5b6c 616e 6775 6167 655f  s.cat([language_
+0000e040: 6d6f 6465 6c5f 696e 7075 7473 2c20 696e  model_inputs, in
+0000e050: 7075 7473 5f65 6d62 6564 735d 2c20 6178  puts_embeds], ax
+0000e060: 6973 3d31 290a 0a20 2020 2020 2020 2069  is=1)..        i
+0000e070: 6620 6174 7465 6e74 696f 6e5f 6d61 736b  f attention_mask
+0000e080: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0000e090: 2020 2020 2020 6174 7465 6e74 696f 6e5f        attention_
+0000e0a0: 6d61 736b 203d 206f 7073 2e6f 6e65 735f  mask = ops.ones_
+0000e0b0: 6c69 6b65 2869 6e70 7574 5f69 6473 290a  like(input_ids).
+0000e0c0: 2020 2020 2020 2020 6174 7465 6e74 696f          attentio
+0000e0d0: 6e5f 6d61 736b 203d 206f 7073 2e63 6174  n_mask = ops.cat
+0000e0e0: 285b 6c61 6e67 7561 6765 5f6d 6f64 656c  ([language_model
+0000e0f0: 5f61 7474 656e 7469 6f6e 5f6d 6173 6b2c  _attention_mask,
+0000e100: 2061 7474 656e 7469 6f6e 5f6d 6173 6b5d   attention_mask]
+0000e110: 2c20 6178 6973 3d31 290a 0a20 2020 2020  , axis=1)..     
+0000e120: 2020 2069 6620 7365 6c66 2e63 6f6e 6669     if self.confi
+0000e130: 672e 7573 655f 6465 636f 6465 725f 6f6e  g.use_decoder_on
+0000e140: 6c79 5f6c 616e 6775 6167 655f 6d6f 6465  ly_language_mode
+0000e150: 6c3a 0a20 2020 2020 2020 2020 2020 206f  l:.            o
+0000e160: 7574 7075 7473 203d 2073 656c 662e 6c61  utputs = self.la
+0000e170: 6e67 7561 6765 5f6d 6f64 656c 280a 2020  nguage_model(.  
+0000e180: 2020 2020 2020 2020 2020 2020 2020 696e                in
+0000e190: 7075 7473 5f65 6d62 6564 733d 696e 7075  puts_embeds=inpu
+0000e1a0: 7473 5f65 6d62 6564 732c 0a20 2020 2020  ts_embeds,.     
+0000e1b0: 2020 2020 2020 2020 2020 2061 7474 656e             atten
+0000e1c0: 7469 6f6e 5f6d 6173 6b3d 6174 7465 6e74  tion_mask=attent
+0000e1d0: 696f 6e5f 6d61 736b 2c0a 2020 2020 2020  ion_mask,.      
+0000e1e0: 2020 2020 2020 2020 2020 6f75 7470 7574            output
+0000e1f0: 5f61 7474 656e 7469 6f6e 733d 6f75 7470  _attentions=outp
+0000e200: 7574 5f61 7474 656e 7469 6f6e 732c 0a20  ut_attentions,. 
+0000e210: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+0000e220: 7574 7075 745f 6869 6464 656e 5f73 7461  utput_hidden_sta
+0000e230: 7465 733d 6f75 7470 7574 5f68 6964 6465  tes=output_hidde
+0000e240: 6e5f 7374 6174 6573 2c0a 2020 2020 2020  n_states,.      
+0000e250: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000e260: 5f64 6963 743d 7265 7475 726e 5f64 6963  _dict=return_dic
+0000e270: 742c 0a20 2020 2020 2020 2020 2020 2029  t,.            )
+0000e280: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+0000e290: 6974 7320 3d20 6f75 7470 7574 732e 6c6f  its = outputs.lo
+0000e2a0: 6769 7473 2069 6620 7265 7475 726e 5f64  gits if return_d
+0000e2b0: 6963 7420 656c 7365 206f 7574 7075 7473  ict else outputs
+0000e2c0: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
+0000e2d0: 6c6f 7373 203d 204e 6f6e 650a 2020 2020  loss = None.    
+0000e2e0: 2020 2020 2020 2020 2320 7765 2063 6f6d          # we com
+0000e2f0: 7075 7465 2074 6865 206c 6f73 7320 6865  pute the loss he
+0000e300: 7265 2073 696e 6365 2077 6520 6e65 6564  re since we need
+0000e310: 2074 6f20 7461 6b65 2069 6e74 6f20 6163   to take into ac
+0000e320: 636f 756e 7420 7468 6520 7365 7175 656e  count the sequen
+0000e330: 6365 206c 656e 6774 6820 6f66 2074 6865  ce length of the
+0000e340: 2071 7565 7279 2065 6d62 6564 730a 2020   query embeds.  
+0000e350: 2020 2020 2020 2020 2020 6966 206c 6162            if lab
+0000e360: 656c 7320 6973 206e 6f74 204e 6f6e 653a  els is not None:
+0000e370: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e380: 206c 6f67 6974 7320 3d20 6c6f 6769 7473   logits = logits
+0000e390: 5b3a 2c20 2d6c 6162 656c 732e 7368 6170  [:, -labels.shap
+0000e3a0: 655b 315d 203a 2c20 3a5d 0a20 2020 2020  e[1] :, :].     
+0000e3b0: 2020 2020 2020 2020 2020 2023 2053 6869             # Shi
+0000e3c0: 6674 2073 6f20 7468 6174 2074 6f6b 656e  ft so that token
+0000e3d0: 7320 3c20 6e20 7072 6564 6963 7420 6e0a  s < n predict n.
+0000e3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e3f0: 7368 6966 745f 6c6f 6769 7473 203d 206c  shift_logits = l
+0000e400: 6f67 6974 735b 2e2e 2e2c 203a 2d31 2c20  ogits[..., :-1, 
+0000e410: 3a5d 0a20 2020 2020 2020 2020 2020 2020  :].             
+0000e420: 2020 2073 6869 6674 5f6c 6162 656c 7320     shift_labels 
+0000e430: 3d20 6c61 6265 6c73 5b2e 2e2e 2c20 313a  = labels[..., 1:
+0000e440: 5d0a 0a20 2020 2020 2020 2020 2020 2020  ]..             
+0000e450: 2020 2023 2046 6c61 7474 656e 2074 6865     # Flatten the
+0000e460: 2074 6f6b 656e 730a 2020 2020 2020 2020   tokens.        
+0000e470: 2020 2020 2020 2020 6c6f 7373 203d 206f          loss = o
+0000e480: 7073 2e63 726f 7373 5f65 6e74 726f 7079  ps.cross_entropy
+0000e490: 2873 6869 6674 5f6c 6f67 6974 732e 7669  (shift_logits.vi
+0000e4a0: 6577 282d 312c 2073 656c 662e 636f 6e66  ew(-1, self.conf
+0000e4b0: 6967 2e74 6578 745f 636f 6e66 6967 2e76  ig.text_config.v
+0000e4c0: 6f63 6162 5f73 697a 6529 2c20 7368 6966  ocab_size), shif
+0000e4d0: 745f 6c61 6265 6c73 2e76 6965 7728 2d31  t_labels.view(-1
+0000e4e0: 2929 0a20 2020 2020 2020 2065 6c73 653a  )).        else:
+0000e4f0: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
+0000e500: 7075 7473 203d 2073 656c 662e 6c61 6e67  puts = self.lang
+0000e510: 7561 6765 5f6d 6f64 656c 280a 2020 2020  uage_model(.    
+0000e520: 2020 2020 2020 2020 2020 2020 696e 7075              inpu
+0000e530: 7473 5f65 6d62 6564 733d 696e 7075 7473  ts_embeds=inputs
+0000e540: 5f65 6d62 6564 732c 0a20 2020 2020 2020  _embeds,.       
+0000e550: 2020 2020 2020 2020 2061 7474 656e 7469           attenti
+0000e560: 6f6e 5f6d 6173 6b3d 6174 7465 6e74 696f  on_mask=attentio
+0000e570: 6e5f 6d61 736b 2c0a 2020 2020 2020 2020  n_mask,.        
+0000e580: 2020 2020 2020 2020 6465 636f 6465 725f          decoder_
+0000e590: 696e 7075 745f 6964 733d 6465 636f 6465  input_ids=decode
+0000e5a0: 725f 696e 7075 745f 6964 732c 0a20 2020  r_input_ids,.   
+0000e5b0: 2020 2020 2020 2020 2020 2020 2064 6563               dec
+0000e5c0: 6f64 6572 5f61 7474 656e 7469 6f6e 5f6d  oder_attention_m
+0000e5d0: 6173 6b3d 6465 636f 6465 725f 6174 7465  ask=decoder_atte
+0000e5e0: 6e74 696f 6e5f 6d61 736b 2c0a 2020 2020  ntion_mask,.    
+0000e5f0: 2020 2020 2020 2020 2020 2020 6f75 7470              outp
+0000e600: 7574 5f61 7474 656e 7469 6f6e 733d 6f75  ut_attentions=ou
+0000e610: 7470 7574 5f61 7474 656e 7469 6f6e 732c  tput_attentions,
+0000e620: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e630: 206f 7574 7075 745f 6869 6464 656e 5f73   output_hidden_s
+0000e640: 7461 7465 733d 6f75 7470 7574 5f68 6964  tates=output_hid
+0000e650: 6465 6e5f 7374 6174 6573 2c0a 2020 2020  den_states,.    
+0000e660: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000e670: 726e 5f64 6963 743d 7265 7475 726e 5f64  rn_dict=return_d
+0000e680: 6963 742c 0a20 2020 2020 2020 2020 2020  ict,.           
+0000e690: 2020 2020 206c 6162 656c 733d 6c61 6265       labels=labe
+0000e6a0: 6c73 2c0a 2020 2020 2020 2020 2020 2020  ls,.            
+0000e6b0: 290a 2020 2020 2020 2020 2020 2020 6c6f  ).            lo
+0000e6c0: 7373 203d 206f 7574 7075 7473 2e6c 6f73  ss = outputs.los
+0000e6d0: 7320 6966 2072 6574 7572 6e5f 6469 6374  s if return_dict
+0000e6e0: 2065 6c73 6520 6f75 7470 7574 735b 305d   else outputs[0]
+0000e6f0: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+0000e700: 6974 7320 3d20 6f75 7470 7574 732e 6c6f  its = outputs.lo
+0000e710: 6769 7473 2069 6620 7265 7475 726e 5f64  gits if return_d
+0000e720: 6963 7420 656c 7365 206f 7574 7075 7473  ict else outputs
+0000e730: 5b31 5d0a 0a20 2020 2020 2020 2069 6620  [1]..        if 
+0000e740: 6e6f 7420 7265 7475 726e 5f64 6963 743a  not return_dict:
+0000e750: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
+0000e760: 7075 7420 3d20 286c 6f67 6974 732c 2076  put = (logits, v
+0000e770: 6973 696f 6e5f 6f75 7470 7574 732c 2071  ision_outputs, q
+0000e780: 7565 7279 5f6f 7574 7075 7473 2c20 6f75  uery_outputs, ou
+0000e790: 7470 7574 7329 0a20 2020 2020 2020 2020  tputs).         
+0000e7a0: 2020 2072 6574 7572 6e20 2828 6c6f 7373     return ((loss
+0000e7b0: 2c29 202b 206f 7574 7075 7429 2069 6620  ,) + output) if 
+0000e7c0: 6c6f 7373 2069 7320 6e6f 7420 4e6f 6e65  loss is not None
+0000e7d0: 2065 6c73 6520 6f75 7470 7574 0a0a 2020   else output..  
+0000e7e0: 2020 2020 2020 7265 7475 726e 2042 6c69        return Bli
+0000e7f0: 7032 466f 7243 6f6e 6469 7469 6f6e 616c  p2ForConditional
+0000e800: 4765 6e65 7261 7469 6f6e 4d6f 6465 6c4f  GenerationModelO
+0000e810: 7574 7075 7428 0a20 2020 2020 2020 2020  utput(.         
+0000e820: 2020 206c 6f73 733d 6c6f 7373 2c0a 2020     loss=loss,.  
+0000e830: 2020 2020 2020 2020 2020 6c6f 6769 7473            logits
+0000e840: 3d6c 6f67 6974 732c 0a20 2020 2020 2020  =logits,.       
+0000e850: 2020 2020 2076 6973 696f 6e5f 6f75 7470       vision_outp
+0000e860: 7574 733d 7669 7369 6f6e 5f6f 7574 7075  uts=vision_outpu
+0000e870: 7473 2c0a 2020 2020 2020 2020 2020 2020  ts,.            
+0000e880: 7166 6f72 6d65 725f 6f75 7470 7574 733d  qformer_outputs=
+0000e890: 7175 6572 795f 6f75 7470 7574 732c 0a20  query_outputs,. 
+0000e8a0: 2020 2020 2020 2020 2020 206c 616e 6775             langu
+0000e8b0: 6167 655f 6d6f 6465 6c5f 6f75 7470 7574  age_model_output
+0000e8c0: 733d 6f75 7470 7574 732c 0a20 2020 2020  s=outputs,.     
+0000e8d0: 2020 2029 0a0a 0a63 6c61 7373 2042 6c69     )...class Bli
+0000e8e0: 7032 466f 7243 6f6e 6469 7469 6f6e 616c  p2ForConditional
+0000e8f0: 4765 6e65 7261 7469 6f6e 2842 6c69 7032  Generation(Blip2
+0000e900: 5072 6554 7261 696e 6564 4d6f 6465 6c29  PreTrainedModel)
+0000e910: 3a0a 2020 2020 636f 6e66 6967 5f63 6c61  :.    config_cla
+0000e920: 7373 203d 2042 6c69 7032 436f 6e66 6967  ss = Blip2Config
+0000e930: 0a20 2020 206d 6169 6e5f 696e 7075 745f  .    main_input_
+0000e940: 6e61 6d65 203d 2022 7069 7865 6c5f 7661  name = "pixel_va
+0000e950: 6c75 6573 220a 0a20 2020 2064 6566 205f  lues"..    def _
+0000e960: 5f69 6e69 745f 5f28 7365 6c66 2c20 636f  _init__(self, co
+0000e970: 6e66 6967 3a20 426c 6970 3243 6f6e 6669  nfig: Blip2Confi
+0000e980: 6729 3a0a 2020 2020 2020 2020 7375 7065  g):.        supe
+0000e990: 7228 292e 5f5f 696e 6974 5f5f 2863 6f6e  r().__init__(con
+0000e9a0: 6669 6729 0a0a 2020 2020 2020 2020 7365  fig)..        se
+0000e9b0: 6c66 2e76 6973 696f 6e5f 6d6f 6465 6c20  lf.vision_model 
+0000e9c0: 3d20 426c 6970 3256 6973 696f 6e4d 6f64  = Blip2VisionMod
+0000e9d0: 656c 2863 6f6e 6669 672e 7669 7369 6f6e  el(config.vision
+0000e9e0: 5f63 6f6e 6669 6729 0a0a 2020 2020 2020  _config)..      
+0000e9f0: 2020 7365 6c66 2e71 7565 7279 5f74 6f6b    self.query_tok
+0000ea00: 656e 7320 3d20 5061 7261 6d65 7465 7228  ens = Parameter(
+0000ea10: 6f70 732e 7a65 726f 7328 312c 2063 6f6e  ops.zeros(1, con
+0000ea20: 6669 672e 6e75 6d5f 7175 6572 795f 746f  fig.num_query_to
+0000ea30: 6b65 6e73 2c20 636f 6e66 6967 2e71 666f  kens, config.qfo
+0000ea40: 726d 6572 5f63 6f6e 6669 672e 6869 6464  rmer_config.hidd
+0000ea50: 656e 5f73 697a 6529 290a 2020 2020 2020  en_size)).      
+0000ea60: 2020 7365 6c66 2e71 666f 726d 6572 203d    self.qformer =
+0000ea70: 2042 6c69 7032 5146 6f72 6d65 724d 6f64   Blip2QFormerMod
+0000ea80: 656c 2863 6f6e 6669 672e 7166 6f72 6d65  el(config.qforme
+0000ea90: 725f 636f 6e66 6967 290a 0a20 2020 2020  r_config)..     
+0000eaa0: 2020 2073 656c 662e 6c61 6e67 7561 6765     self.language
+0000eab0: 5f70 726f 6a65 6374 696f 6e20 3d20 6e6e  _projection = nn
+0000eac0: 2e44 656e 7365 2863 6f6e 6669 672e 7166  .Dense(config.qf
+0000ead0: 6f72 6d65 725f 636f 6e66 6967 2e68 6964  ormer_config.hid
+0000eae0: 6465 6e5f 7369 7a65 2c20 636f 6e66 6967  den_size, config
+0000eaf0: 2e74 6578 745f 636f 6e66 6967 2e68 6964  .text_config.hid
+0000eb00: 6465 6e5f 7369 7a65 290a 2020 2020 2020  den_size).      
+0000eb10: 2020 6966 2063 6f6e 6669 672e 7573 655f    if config.use_
+0000eb20: 6465 636f 6465 725f 6f6e 6c79 5f6c 616e  decoder_only_lan
+0000eb30: 6775 6167 655f 6d6f 6465 6c3a 0a20 2020  guage_model:.   
+0000eb40: 2020 2020 2020 2020 206c 616e 6775 6167           languag
+0000eb50: 655f 6d6f 6465 6c20 3d20 4175 746f 4d6f  e_model = AutoMo
+0000eb60: 6465 6c46 6f72 4361 7573 616c 4c4d 2e66  delForCausalLM.f
+0000eb70: 726f 6d5f 636f 6e66 6967 2863 6f6e 6669  rom_config(confi
+0000eb80: 672e 7465 7874 5f63 6f6e 6669 6729 0a20  g.text_config). 
+0000eb90: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0000eba0: 2020 2020 2020 2020 206c 616e 6775 6167           languag
+0000ebb0: 655f 6d6f 6465 6c20 3d20 4175 746f 4d6f  e_model = AutoMo
+0000ebc0: 6465 6c46 6f72 5365 7132 5365 714c 4d2e  delForSeq2SeqLM.
+0000ebd0: 6672 6f6d 5f63 6f6e 6669 6728 636f 6e66  from_config(conf
+0000ebe0: 6967 2e74 6578 745f 636f 6e66 6967 290a  ig.text_config).
+0000ebf0: 0a20 2020 2020 2020 2023 2055 7064 6174  .        # Updat
+0000ec00: 6520 5f74 6965 645f 7765 6967 6874 735f  e _tied_weights_
+0000ec10: 6b65 7973 2075 7369 6e67 2074 6865 2062  keys using the b
+0000ec20: 6173 6520 6d6f 6465 6c20 7573 6564 2e0a  ase model used..
+0000ec30: 2020 2020 2020 2020 6966 206c 616e 6775          if langu
+0000ec40: 6167 655f 6d6f 6465 6c2e 5f74 6965 645f  age_model._tied_
+0000ec50: 7765 6967 6874 735f 6b65 7973 2069 7320  weights_keys is 
+0000ec60: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+0000ec70: 2020 2020 2020 7365 6c66 2e5f 7469 6564        self._tied
+0000ec80: 5f77 6569 6768 7473 5f6b 6579 7320 3d20  _weights_keys = 
+0000ec90: 5b66 226c 616e 6775 6167 655f 6d6f 6465  [f"language_mode
+0000eca0: 6c2e 7b6b 7d22 2066 6f72 206b 2069 6e20  l.{k}" for k in 
+0000ecb0: 6c61 6e67 7561 6765 5f6d 6f64 656c 2e5f  language_model._
+0000ecc0: 7469 6564 5f77 6569 6768 7473 5f6b 6579  tied_weights_key
+0000ecd0: 735d 0a0a 2020 2020 2020 2020 7365 6c66  s]..        self
+0000ece0: 2e6c 616e 6775 6167 655f 6d6f 6465 6c20  .language_model 
+0000ecf0: 3d20 6c61 6e67 7561 6765 5f6d 6f64 656c  = language_model
+0000ed00: 0a0a 2020 2020 2020 2020 2320 496e 6974  ..        # Init
+0000ed10: 6961 6c69 7a65 2077 6569 6768 7473 2061  ialize weights a
+0000ed20: 6e64 2061 7070 6c79 2066 696e 616c 2070  nd apply final p
+0000ed30: 726f 6365 7373 696e 670a 2020 2020 2020  rocessing.      
+0000ed40: 2020 7365 6c66 2e70 6f73 745f 696e 6974    self.post_init
+0000ed50: 2829 0a0a 2020 2020 6465 6620 6765 745f  ()..    def get_
+0000ed60: 696e 7075 745f 656d 6265 6464 696e 6773  input_embeddings
+0000ed70: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0000ed80: 7265 7475 726e 2073 656c 662e 6c61 6e67  return self.lang
+0000ed90: 7561 6765 5f6d 6f64 656c 2e67 6574 5f69  uage_model.get_i
+0000eda0: 6e70 7574 5f65 6d62 6564 6469 6e67 7328  nput_embeddings(
+0000edb0: 290a 0a20 2020 2064 6566 2073 6574 5f69  )..    def set_i
+0000edc0: 6e70 7574 5f65 6d62 6564 6469 6e67 7328  nput_embeddings(
+0000edd0: 7365 6c66 2c20 7661 6c75 6529 3a0a 2020  self, value):.  
+0000ede0: 2020 2020 2020 7365 6c66 2e6c 616e 6775        self.langu
+0000edf0: 6167 655f 6d6f 6465 6c2e 7365 745f 696e  age_model.set_in
+0000ee00: 7075 745f 656d 6265 6464 696e 6773 2876  put_embeddings(v
+0000ee10: 616c 7565 290a 0a20 2020 2064 6566 2073  alue)..    def s
+0000ee20: 6574 5f6f 7574 7075 745f 656d 6265 6464  et_output_embedd
+0000ee30: 696e 6773 2873 656c 662c 206e 6577 5f65  ings(self, new_e
+0000ee40: 6d62 6564 6469 6e67 7329 3a0a 2020 2020  mbeddings):.    
+0000ee50: 2020 2020 7365 6c66 2e6c 616e 6775 6167      self.languag
+0000ee60: 655f 6d6f 6465 6c2e 7365 745f 6f75 7470  e_model.set_outp
+0000ee70: 7574 5f65 6d62 6564 6469 6e67 7328 6e65  ut_embeddings(ne
+0000ee80: 775f 656d 6265 6464 696e 6773 290a 0a20  w_embeddings).. 
+0000ee90: 2020 2064 6566 2067 6574 5f6f 7574 7075     def get_outpu
+0000eea0: 745f 656d 6265 6464 696e 6773 2873 656c  t_embeddings(sel
+0000eeb0: 6629 202d 3e20 6e6e 2e43 656c 6c3a 0a20  f) -> nn.Cell:. 
+0000eec0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+0000eed0: 6c66 2e6c 616e 6775 6167 655f 6d6f 6465  lf.language_mode
+0000eee0: 6c2e 6765 745f 6f75 7470 7574 5f65 6d62  l.get_output_emb
+0000eef0: 6564 6469 6e67 7328 290a 0a20 2020 2064  eddings()..    d
+0000ef00: 6566 2067 6574 5f65 6e63 6f64 6572 2873  ef get_encoder(s
+0000ef10: 656c 6629 3a0a 2020 2020 2020 2020 7265  elf):.        re
+0000ef20: 7475 726e 2073 656c 662e 6c61 6e67 7561  turn self.langua
+0000ef30: 6765 5f6d 6f64 656c 2e67 6574 5f65 6e63  ge_model.get_enc
+0000ef40: 6f64 6572 2829 0a0a 2020 2020 6465 6620  oder()..    def 
+0000ef50: 6765 745f 6465 636f 6465 7228 7365 6c66  get_decoder(self
+0000ef60: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+0000ef70: 6e20 7365 6c66 2e6c 616e 6775 6167 655f  n self.language_
+0000ef80: 6d6f 6465 6c2e 6765 745f 6465 636f 6465  model.get_decode
+0000ef90: 7228 290a 0a20 2020 2064 6566 205f 7469  r()..    def _ti
+0000efa0: 655f 7765 6967 6874 7328 7365 6c66 293a  e_weights(self):
+0000efb0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+0000efc0: 7365 6c66 2e63 6f6e 6669 672e 7573 655f  self.config.use_
+0000efd0: 6465 636f 6465 725f 6f6e 6c79 5f6c 616e  decoder_only_lan
+0000efe0: 6775 6167 655f 6d6f 6465 6c3a 0a20 2020  guage_model:.   
+0000eff0: 2020 2020 2020 2020 2073 656c 662e 6c61           self.la
+0000f000: 6e67 7561 6765 5f6d 6f64 656c 2e65 6e63  nguage_model.enc
+0000f010: 6f64 6572 2e65 6d62 6564 5f74 6f6b 656e  oder.embed_token
+0000f020: 7320 3d20 7365 6c66 2e6c 616e 6775 6167  s = self.languag
+0000f030: 655f 6d6f 6465 6c2e 7368 6172 6564 0a20  e_model.shared. 
+0000f040: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000f050: 6c61 6e67 7561 6765 5f6d 6f64 656c 2e64  language_model.d
+0000f060: 6563 6f64 6572 2e65 6d62 6564 5f74 6f6b  ecoder.embed_tok
+0000f070: 656e 7320 3d20 7365 6c66 2e6c 616e 6775  ens = self.langu
+0000f080: 6167 655f 6d6f 6465 6c2e 7368 6172 6564  age_model.shared
+0000f090: 0a0a 2020 2020 6465 6620 636f 6e73 7472  ..    def constr
+0000f0a0: 7563 7428 0a20 2020 2020 2020 2073 656c  uct(.        sel
+0000f0b0: 662c 0a20 2020 2020 2020 2070 6978 656c  f,.        pixel
+0000f0c0: 5f76 616c 7565 733a 206d 696e 6473 706f  _values: mindspo
+0000f0d0: 7265 2e54 656e 736f 722c 0a20 2020 2020  re.Tensor,.     
+0000f0e0: 2020 2069 6e70 7574 5f69 6473 3a20 6d69     input_ids: mi
+0000f0f0: 6e64 7370 6f72 652e 5465 6e73 6f72 2c0a  ndspore.Tensor,.
+0000f100: 2020 2020 2020 2020 6174 7465 6e74 696f          attentio
+0000f110: 6e5f 6d61 736b 3a20 4f70 7469 6f6e 616c  n_mask: Optional
+0000f120: 5b6d 696e 6473 706f 7265 2e54 656e 736f  [mindspore.Tenso
+0000f130: 725d 203d 204e 6f6e 652c 0a20 2020 2020  r] = None,.     
+0000f140: 2020 2064 6563 6f64 6572 5f69 6e70 7574     decoder_input
+0000f150: 5f69 6473 3a20 4f70 7469 6f6e 616c 5b6d  _ids: Optional[m
+0000f160: 696e 6473 706f 7265 2e54 656e 736f 725d  indspore.Tensor]
+0000f170: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+0000f180: 2064 6563 6f64 6572 5f61 7474 656e 7469   decoder_attenti
+0000f190: 6f6e 5f6d 6173 6b3a 204f 7074 696f 6e61  on_mask: Optiona
+0000f1a0: 6c5b 6d69 6e64 7370 6f72 652e 5465 6e73  l[mindspore.Tens
+0000f1b0: 6f72 5d20 3d20 4e6f 6e65 2c0a 2020 2020  or] = None,.    
+0000f1c0: 2020 2020 6f75 7470 7574 5f61 7474 656e      output_atten
+0000f1d0: 7469 6f6e 733a 204f 7074 696f 6e61 6c5b  tions: Optional[
+0000f1e0: 626f 6f6c 5d20 3d20 4e6f 6e65 2c0a 2020  bool] = None,.  
+0000f1f0: 2020 2020 2020 6f75 7470 7574 5f68 6964        output_hid
+0000f200: 6465 6e5f 7374 6174 6573 3a20 4f70 7469  den_states: Opti
+0000f210: 6f6e 616c 5b62 6f6f 6c5d 203d 204e 6f6e  onal[bool] = Non
+0000f220: 652c 0a20 2020 2020 2020 206c 6162 656c  e,.        label
+0000f230: 733a 204f 7074 696f 6e61 6c5b 6d69 6e64  s: Optional[mind
+0000f240: 7370 6f72 652e 5465 6e73 6f72 5d20 3d20  spore.Tensor] = 
+0000f250: 4e6f 6e65 2c0a 2020 2020 2020 2020 7265  None,.        re
+0000f260: 7475 726e 5f64 6963 743a 204f 7074 696f  turn_dict: Optio
+0000f270: 6e61 6c5b 626f 6f6c 5d20 3d20 4e6f 6e65  nal[bool] = None
+0000f280: 2c0a 2020 2020 2920 2d3e 2055 6e69 6f6e  ,.    ) -> Union
+0000f290: 5b54 7570 6c65 2c20 426c 6970 3246 6f72  [Tuple, Blip2For
+0000f2a0: 436f 6e64 6974 696f 6e61 6c47 656e 6572  ConditionalGener
+0000f2b0: 6174 696f 6e4d 6f64 656c 4f75 7470 7574  ationModelOutput
+0000f2c0: 5d3a 0a20 2020 2020 2020 2072 2222 220a  ]:.        r""".
+0000f2d0: 2020 2020 2020 2020 5265 7475 726e 733a          Returns:
+0000f2e0: 0a0a 2020 2020 2020 2020 4578 616d 706c  ..        Exampl
+0000f2f0: 6573 3a0a 0a20 2020 2020 2020 2050 7265  es:..        Pre
+0000f300: 7061 7265 2070 726f 6365 7373 6f72 2c20  pare processor, 
+0000f310: 6d6f 6465 6c20 616e 6420 696d 6167 6520  model and image 
+0000f320: 696e 7075 740a 0a20 2020 2020 2020 2060  input..        `
+0000f330: 6060 7079 7468 6f6e 0a20 2020 2020 2020  ``python.       
+0000f340: 203e 3e3e 2066 726f 6d20 5049 4c20 696d   >>> from PIL im
+0000f350: 706f 7274 2049 6d61 6765 0a20 2020 2020  port Image.     
+0000f360: 2020 203e 3e3e 2069 6d70 6f72 7420 7265     >>> import re
+0000f370: 7175 6573 7473 0a20 2020 2020 2020 203e  quests.        >
+0000f380: 3e3e 2066 726f 6d20 7472 616e 7366 6f72  >> from transfor
+0000f390: 6d65 7273 2069 6d70 6f72 7420 426c 6970  mers import Blip
+0000f3a0: 3250 726f 6365 7373 6f72 2c20 426c 6970  2Processor, Blip
+0000f3b0: 3246 6f72 436f 6e64 6974 696f 6e61 6c47  2ForConditionalG
+0000f3c0: 656e 6572 6174 696f 6e0a 2020 2020 2020  eneration.      
+0000f3d0: 2020 3e3e 3e20 696d 706f 7274 2074 6f72    >>> import tor
+0000f3e0: 6368 0a0a 0a20 2020 2020 2020 203e 3e3e  ch...        >>>
+0000f3f0: 2070 726f 6365 7373 6f72 203d 2042 6c69   processor = Bli
+0000f400: 7032 5072 6f63 6573 736f 722e 6672 6f6d  p2Processor.from
+0000f410: 5f70 7265 7472 6169 6e65 6428 2253 616c  _pretrained("Sal
+0000f420: 6573 666f 7263 652f 626c 6970 322d 6f70  esforce/blip2-op
+0000f430: 742d 322e 3762 2229 0a20 2020 2020 2020  t-2.7b").       
+0000f440: 203e 3e3e 206d 6f64 656c 203d 2042 6c69   >>> model = Bli
+0000f450: 7032 466f 7243 6f6e 6469 7469 6f6e 616c  p2ForConditional
+0000f460: 4765 6e65 7261 7469 6f6e 2e66 726f 6d5f  Generation.from_
+0000f470: 7072 6574 7261 696e 6564 280a 2020 2020  pretrained(.    
+0000f480: 2020 2020 2e2e 2e20 2020 2020 2253 616c      ...     "Sal
+0000f490: 6573 666f 7263 652f 626c 6970 322d 6f70  esforce/blip2-op
+0000f4a0: 742d 322e 3762 222c 206c 6f61 645f 696e  t-2.7b", load_in
+0000f4b0: 5f38 6269 743d 5472 7565 2c20 746f 7263  _8bit=True, torc
+0000f4c0: 685f 6474 7970 653d 746f 7263 682e 666c  h_dtype=torch.fl
+0000f4d0: 6f61 7431 360a 2020 2020 2020 2020 2e2e  oat16.        ..
+0000f4e0: 2e20 2920 2023 2064 6f63 7465 7374 3a20  . )  # doctest: 
+0000f4f0: 2b49 474e 4f52 455f 5245 5355 4c54 0a0a  +IGNORE_RESULT..
+0000f500: 2020 2020 2020 2020 3e3e 3e20 7572 6c20          >>> url 
+0000f510: 3d20 2268 7474 703a 2f2f 696d 6167 6573  = "http://images
+0000f520: 2e63 6f63 6f64 6174 6173 6574 2e6f 7267  .cocodataset.org
+0000f530: 2f76 616c 3230 3137 2f30 3030 3030 3030  /val2017/0000000
+0000f540: 3339 3736 392e 6a70 6722 0a20 2020 2020  39769.jpg".     
+0000f550: 2020 203e 3e3e 2069 6d61 6765 203d 2049     >>> image = I
+0000f560: 6d61 6765 2e6f 7065 6e28 7265 7175 6573  mage.open(reques
+0000f570: 7473 2e67 6574 2875 726c 2c20 7374 7265  ts.get(url, stre
+0000f580: 616d 3d54 7275 6529 2e72 6177 290a 2020  am=True).raw).  
+0000f590: 2020 2020 2020 6060 600a 0a20 2020 2020        ```..     
+0000f5a0: 2020 2049 6d61 6765 2063 6170 7469 6f6e     Image caption
+0000f5b0: 696e 6720 2877 6974 686f 7574 2070 726f  ing (without pro
+0000f5c0: 7669 6469 6e67 2061 2074 6578 7420 7072  viding a text pr
+0000f5d0: 6f6d 7074 293a 0a0a 2020 2020 2020 2020  ompt):..        
+0000f5e0: 6060 6070 7974 686f 6e0a 2020 2020 2020  ```python.      
+0000f5f0: 2020 3e3e 3e20 696e 7075 7473 203d 2070    >>> inputs = p
+0000f600: 726f 6365 7373 6f72 2869 6d61 6765 733d  rocessor(images=
+0000f610: 696d 6167 652c 2072 6574 7572 6e5f 7465  image, return_te
+0000f620: 6e73 6f72 733d 2270 7422 292e 746f 2874  nsors="pt").to(t
+0000f630: 6f72 6368 2e66 6c6f 6174 3136 290a 0a20  orch.float16).. 
+0000f640: 2020 2020 2020 203e 3e3e 2067 656e 6572         >>> gener
+0000f650: 6174 6564 5f69 6473 203d 206d 6f64 656c  ated_ids = model
+0000f660: 2e67 656e 6572 6174 6528 2a2a 696e 7075  .generate(**inpu
+0000f670: 7473 290a 2020 2020 2020 2020 3e3e 3e20  ts).        >>> 
+0000f680: 6765 6e65 7261 7465 645f 7465 7874 203d  generated_text =
+0000f690: 2070 726f 6365 7373 6f72 2e62 6174 6368   processor.batch
+0000f6a0: 5f64 6563 6f64 6528 6765 6e65 7261 7465  _decode(generate
+0000f6b0: 645f 6964 732c 2073 6b69 705f 7370 6563  d_ids, skip_spec
+0000f6c0: 6961 6c5f 746f 6b65 6e73 3d54 7275 6529  ial_tokens=True)
+0000f6d0: 5b30 5d2e 7374 7269 7028 290a 2020 2020  [0].strip().    
+0000f6e0: 2020 2020 3e3e 3e20 7072 696e 7428 6765      >>> print(ge
+0000f6f0: 6e65 7261 7465 645f 7465 7874 290a 2020  nerated_text).  
+0000f700: 2020 2020 2020 7477 6f20 6361 7473 206c        two cats l
+0000f710: 6179 696e 6720 6f6e 2061 2063 6f75 6368  aying on a couch
+0000f720: 0a20 2020 2020 2020 2060 6060 0a0a 2020  .        ```..  
+0000f730: 2020 2020 2020 5669 7375 616c 2071 7565        Visual que
+0000f740: 7374 696f 6e20 616e 7377 6572 696e 6720  stion answering 
+0000f750: 2870 726f 6d70 7420 3d20 7175 6573 7469  (prompt = questi
+0000f760: 6f6e 293a 0a0a 2020 2020 2020 2020 6060  on):..        ``
+0000f770: 6070 7974 686f 6e0a 2020 2020 2020 2020  `python.        
+0000f780: 3e3e 3e20 7072 6f6d 7074 203d 2022 5175  >>> prompt = "Qu
+0000f790: 6573 7469 6f6e 3a20 686f 7720 6d61 6e79  estion: how many
+0000f7a0: 2063 6174 7320 6172 6520 7468 6572 653f   cats are there?
+0000f7b0: 2041 6e73 7765 723a 220a 2020 2020 2020   Answer:".      
+0000f7c0: 2020 3e3e 3e20 696e 7075 7473 203d 2070    >>> inputs = p
+0000f7d0: 726f 6365 7373 6f72 2869 6d61 6765 733d  rocessor(images=
+0000f7e0: 696d 6167 652c 2074 6578 743d 7072 6f6d  image, text=prom
+0000f7f0: 7074 2c20 7265 7475 726e 5f74 656e 736f  pt, return_tenso
+0000f800: 7273 3d22 7074 2229 2e74 6f28 6474 7970  rs="pt").to(dtyp
+0000f810: 653d 746f 7263 682e 666c 6f61 7431 3629  e=torch.float16)
+0000f820: 0a0a 2020 2020 2020 2020 3e3e 3e20 6765  ..        >>> ge
+0000f830: 6e65 7261 7465 645f 6964 7320 3d20 6d6f  nerated_ids = mo
+0000f840: 6465 6c2e 6765 6e65 7261 7465 282a 2a69  del.generate(**i
+0000f850: 6e70 7574 7329 0a20 2020 2020 2020 203e  nputs).        >
+0000f860: 3e3e 2067 656e 6572 6174 6564 5f74 6578  >> generated_tex
+0000f870: 7420 3d20 7072 6f63 6573 736f 722e 6261  t = processor.ba
+0000f880: 7463 685f 6465 636f 6465 2867 656e 6572  tch_decode(gener
+0000f890: 6174 6564 5f69 6473 2c20 736b 6970 5f73  ated_ids, skip_s
+0000f8a0: 7065 6369 616c 5f74 6f6b 656e 733d 5472  pecial_tokens=Tr
+0000f8b0: 7565 295b 305d 2e73 7472 6970 2829 0a20  ue)[0].strip(). 
+0000f8c0: 2020 2020 2020 203e 3e3e 2070 7269 6e74         >>> print
+0000f8d0: 2867 656e 6572 6174 6564 5f74 6578 7429  (generated_text)
+0000f8e0: 0a20 2020 2020 2020 2074 776f 0a20 2020  .        two.   
+0000f8f0: 2020 2020 2060 6060 0a0a 2020 2020 2020       ```..      
+0000f900: 2020 4e6f 7465 2074 6861 7420 696e 7438    Note that int8
+0000f910: 2069 6e66 6572 656e 6365 2069 7320 616c   inference is al
+0000f920: 736f 2073 7570 706f 7274 6564 2074 6872  so supported thr
+0000f930: 6f75 6768 205b 6269 7473 616e 6462 7974  ough [bitsandbyt
+0000f940: 6573 5d28 6874 7470 733a 2f2f 6769 7468  es](https://gith
+0000f950: 7562 2e63 6f6d 2f54 696d 4465 7474 6d65  ub.com/TimDettme
+0000f960: 7273 2f62 6974 7361 6e64 6279 7465 7329  rs/bitsandbytes)
+0000f970: 2e0a 2020 2020 2020 2020 5468 6973 2067  ..        This g
+0000f980: 7265 6174 6c79 2072 6564 7563 6573 2074  reatly reduces t
+0000f990: 6865 2061 6d6f 756e 7420 6f66 206d 656d  he amount of mem
+0000f9a0: 6f72 7920 7573 6564 2062 7920 7468 6520  ory used by the 
+0000f9b0: 6d6f 6465 6c20 7768 696c 6520 6d61 696e  model while main
+0000f9c0: 7461 696e 696e 6720 7468 6520 7361 6d65  taining the same
+0000f9d0: 2070 6572 666f 726d 616e 6365 2e0a 0a20   performance... 
+0000f9e0: 2020 2020 2020 2060 6060 7079 7468 6f6e         ```python
+0000f9f0: 0a20 2020 2020 2020 203e 3e3e 206d 6f64  .        >>> mod
+0000fa00: 656c 203d 2042 6c69 7032 466f 7243 6f6e  el = Blip2ForCon
+0000fa10: 6469 7469 6f6e 616c 4765 6e65 7261 7469  ditionalGenerati
+0000fa20: 6f6e 2e66 726f 6d5f 7072 6574 7261 696e  on.from_pretrain
+0000fa30: 6564 280a 2020 2020 2020 2020 2e2e 2e20  ed(.        ... 
+0000fa40: 2020 2020 2253 616c 6573 666f 7263 652f      "Salesforce/
+0000fa50: 626c 6970 322d 6f70 742d 322e 3762 222c  blip2-opt-2.7b",
+0000fa60: 206c 6f61 645f 696e 5f38 6269 743d 5472   load_in_8bit=Tr
+0000fa70: 7565 2c20 746f 7263 685f 6474 7970 653d  ue, torch_dtype=
+0000fa80: 746f 7263 682e 6266 6c6f 6174 3136 0a20  torch.bfloat16. 
+0000fa90: 2020 2020 2020 202e 2e2e 2029 2020 2320         ... )  # 
+0000faa0: 646f 6374 6573 743a 202b 4947 4e4f 5245  doctest: +IGNORE
+0000fab0: 5f52 4553 554c 540a 0a20 2020 2020 2020  _RESULT..       
+0000fac0: 203e 3e3e 2069 6e70 7574 7320 3d20 7072   >>> inputs = pr
+0000fad0: 6f63 6573 736f 7228 696d 6167 6573 3d69  ocessor(images=i
+0000fae0: 6d61 6765 2c20 7465 7874 3d70 726f 6d70  mage, text=promp
+0000faf0: 742c 2072 6574 7572 6e5f 7465 6e73 6f72  t, return_tensor
+0000fb00: 733d 2270 7422 292e 746f 2864 7479 7065  s="pt").to(dtype
+0000fb10: 3d74 6f72 6368 2e62 666c 6f61 7431 3629  =torch.bfloat16)
+0000fb20: 0a0a 2020 2020 2020 2020 3e3e 3e20 6765  ..        >>> ge
+0000fb30: 6e65 7261 7465 645f 6964 7320 3d20 6d6f  nerated_ids = mo
+0000fb40: 6465 6c2e 6765 6e65 7261 7465 282a 2a69  del.generate(**i
+0000fb50: 6e70 7574 7329 0a20 2020 2020 2020 203e  nputs).        >
+0000fb60: 3e3e 2067 656e 6572 6174 6564 5f74 6578  >> generated_tex
+0000fb70: 7420 3d20 7072 6f63 6573 736f 722e 6261  t = processor.ba
+0000fb80: 7463 685f 6465 636f 6465 2867 656e 6572  tch_decode(gener
+0000fb90: 6174 6564 5f69 6473 2c20 736b 6970 5f73  ated_ids, skip_s
+0000fba0: 7065 6369 616c 5f74 6f6b 656e 733d 5472  pecial_tokens=Tr
+0000fbb0: 7565 295b 305d 2e73 7472 6970 2829 0a20  ue)[0].strip(). 
+0000fbc0: 2020 2020 2020 203e 3e3e 2070 7269 6e74         >>> print
+0000fbd0: 2867 656e 6572 6174 6564 5f74 6578 7429  (generated_text)
+0000fbe0: 0a20 2020 2020 2020 2074 776f 0a20 2020  .        two.   
+0000fbf0: 2020 2020 2060 6060 2222 220a 2020 2020       ```""".    
+0000fc00: 2020 2020 7265 7475 726e 5f64 6963 7420      return_dict 
+0000fc10: 3d20 7265 7475 726e 5f64 6963 7420 6966  = return_dict if
+0000fc20: 2072 6574 7572 6e5f 6469 6374 2069 7320   return_dict is 
+0000fc30: 6e6f 7420 4e6f 6e65 2065 6c73 6520 7365  not None else se
+0000fc40: 6c66 2e63 6f6e 6669 672e 7573 655f 7265  lf.config.use_re
+0000fc50: 7475 726e 5f64 6963 740a 0a20 2020 2020  turn_dict..     
+0000fc60: 2020 2023 2073 7465 7020 313a 2066 6f72     # step 1: for
+0000fc70: 7761 7264 2074 6865 2069 6d61 6765 7320  ward the images 
+0000fc80: 7468 726f 7567 6820 7468 6520 7669 7369  through the visi
+0000fc90: 6f6e 2065 6e63 6f64 6572 2c0a 2020 2020  on encoder,.    
+0000fca0: 2020 2020 2320 746f 2067 6574 2069 6d61      # to get ima
+0000fcb0: 6765 2065 6d62 6564 6469 6e67 7320 6f66  ge embeddings of
+0000fcc0: 2073 6861 7065 2028 6261 7463 685f 7369   shape (batch_si
+0000fcd0: 7a65 2c20 7365 715f 6c65 6e2c 2068 6964  ze, seq_len, hid
+0000fce0: 6465 6e5f 7369 7a65 290a 2020 2020 2020  den_size).      
+0000fcf0: 2020 7669 7369 6f6e 5f6f 7574 7075 7473    vision_outputs
+0000fd00: 203d 2073 656c 662e 7669 7369 6f6e 5f6d   = self.vision_m
+0000fd10: 6f64 656c 280a 2020 2020 2020 2020 2020  odel(.          
+0000fd20: 2020 7069 7865 6c5f 7661 6c75 6573 3d70    pixel_values=p
+0000fd30: 6978 656c 5f76 616c 7565 732c 0a20 2020  ixel_values,.   
+0000fd40: 2020 2020 2020 2020 206f 7574 7075 745f           output_
+0000fd50: 6174 7465 6e74 696f 6e73 3d6f 7574 7075  attentions=outpu
+0000fd60: 745f 6174 7465 6e74 696f 6e73 2c0a 2020  t_attentions,.  
+0000fd70: 2020 2020 2020 2020 2020 6f75 7470 7574            output
+0000fd80: 5f68 6964 6465 6e5f 7374 6174 6573 3d6f  _hidden_states=o
+0000fd90: 7574 7075 745f 6869 6464 656e 5f73 7461  utput_hidden_sta
+0000fda0: 7465 732c 0a20 2020 2020 2020 2020 2020  tes,.           
+0000fdb0: 2072 6574 7572 6e5f 6469 6374 3d72 6574   return_dict=ret
+0000fdc0: 7572 6e5f 6469 6374 2c0a 2020 2020 2020  urn_dict,.      
+0000fdd0: 2020 290a 2020 2020 2020 2020 696d 6167    ).        imag
+0000fde0: 655f 656d 6265 6473 203d 2076 6973 696f  e_embeds = visio
+0000fdf0: 6e5f 6f75 7470 7574 735b 305d 0a20 2020  n_outputs[0].   
+0000fe00: 2020 2020 2023 2073 7465 7020 323a 2066       # step 2: f
+0000fe10: 6f72 7761 7264 2074 6865 2071 7565 7279  orward the query
+0000fe20: 2074 6f6b 656e 7320 7468 726f 7567 6820   tokens through 
+0000fe30: 7468 6520 5146 6f72 6d65 722c 2075 7369  the QFormer, usi
+0000fe40: 6e67 2074 6865 2069 6d61 6765 2065 6d62  ng the image emb
+0000fe50: 6564 6469 6e67 7320 666f 7220 6372 6f73  eddings for cros
+0000fe60: 732d 6174 7465 6e74 696f 6e0a 2020 2020  s-attention.    
+0000fe70: 2020 2020 696d 6167 655f 6174 7465 6e74      image_attent
+0000fe80: 696f 6e5f 6d61 736b 203d 206f 7073 2e6f  ion_mask = ops.o
+0000fe90: 6e65 7328 696d 6167 655f 656d 6265 6473  nes(image_embeds
+0000fea0: 2e73 6861 7065 5b3a 2d31 5d2c 2064 7479  .shape[:-1], dty
+0000feb0: 7065 3d6d 696e 6473 706f 7265 2e69 6e74  pe=mindspore.int
+0000fec0: 3634 290a 0a20 2020 2020 2020 2071 7565  64)..        que
+0000fed0: 7279 5f74 6f6b 656e 7320 3d20 7365 6c66  ry_tokens = self
+0000fee0: 2e71 7565 7279 5f74 6f6b 656e 732e 6578  .query_tokens.ex
+0000fef0: 7061 6e64 2869 6d61 6765 5f65 6d62 6564  pand(image_embed
+0000ff00: 732e 7368 6170 655b 305d 2c20 2d31 2c20  s.shape[0], -1, 
+0000ff10: 2d31 290a 2020 2020 2020 2020 7175 6572  -1).        quer
+0000ff20: 795f 6f75 7470 7574 7320 3d20 7365 6c66  y_outputs = self
+0000ff30: 2e71 666f 726d 6572 280a 2020 2020 2020  .qformer(.      
+0000ff40: 2020 2020 2020 7175 6572 795f 656d 6265        query_embe
+0000ff50: 6473 3d71 7565 7279 5f74 6f6b 656e 732c  ds=query_tokens,
+0000ff60: 0a20 2020 2020 2020 2020 2020 2065 6e63  .            enc
+0000ff70: 6f64 6572 5f68 6964 6465 6e5f 7374 6174  oder_hidden_stat
+0000ff80: 6573 3d69 6d61 6765 5f65 6d62 6564 732c  es=image_embeds,
+0000ff90: 0a20 2020 2020 2020 2020 2020 2065 6e63  .            enc
+0000ffa0: 6f64 6572 5f61 7474 656e 7469 6f6e 5f6d  oder_attention_m
+0000ffb0: 6173 6b3d 696d 6167 655f 6174 7465 6e74  ask=image_attent
+0000ffc0: 696f 6e5f 6d61 736b 2c0a 2020 2020 2020  ion_mask,.      
+0000ffd0: 2020 2020 2020 6f75 7470 7574 5f61 7474        output_att
+0000ffe0: 656e 7469 6f6e 733d 6f75 7470 7574 5f61  entions=output_a
+0000fff0: 7474 656e 7469 6f6e 732c 0a20 2020 2020  ttentions,.     
+00010000: 2020 2020 2020 206f 7574 7075 745f 6869         output_hi
+00010010: 6464 656e 5f73 7461 7465 733d 6f75 7470  dden_states=outp
+00010020: 7574 5f68 6964 6465 6e5f 7374 6174 6573  ut_hidden_states
+00010030: 2c0a 2020 2020 2020 2020 2020 2020 7265  ,.            re
+00010040: 7475 726e 5f64 6963 743d 7265 7475 726e  turn_dict=return
+00010050: 5f64 6963 742c 0a20 2020 2020 2020 2029  _dict,.        )
+00010060: 0a20 2020 2020 2020 2071 7565 7279 5f6f  .        query_o
+00010070: 7574 7075 7420 3d20 7175 6572 795f 6f75  utput = query_ou
+00010080: 7470 7574 735b 305d 0a0a 2020 2020 2020  tputs[0]..      
+00010090: 2020 2320 7374 6570 2033 3a20 7573 6520    # step 3: use 
+000100a0: 7468 6520 6c61 6e67 7561 6765 206d 6f64  the language mod
+000100b0: 656c 2c20 636f 6e64 6974 696f 6e65 6420  el, conditioned 
+000100c0: 6f6e 2074 6865 2071 7565 7279 206f 7574  on the query out
+000100d0: 7075 7473 2061 6e64 2074 6865 2070 726f  puts and the pro
+000100e0: 6d70 740a 2020 2020 2020 2020 6c61 6e67  mpt.        lang
+000100f0: 7561 6765 5f6d 6f64 656c 5f69 6e70 7574  uage_model_input
+00010100: 7320 3d20 7365 6c66 2e6c 616e 6775 6167  s = self.languag
+00010110: 655f 7072 6f6a 6563 7469 6f6e 2871 7565  e_projection(que
+00010120: 7279 5f6f 7574 7075 7429 0a20 2020 2020  ry_output).     
+00010130: 2020 206c 616e 6775 6167 655f 6d6f 6465     language_mode
+00010140: 6c5f 6174 7465 6e74 696f 6e5f 6d61 736b  l_attention_mask
+00010150: 203d 206f 7073 2e6f 6e65 7328 0a20 2020   = ops.ones(.   
+00010160: 2020 2020 2020 2020 206c 616e 6775 6167           languag
+00010170: 655f 6d6f 6465 6c5f 696e 7075 7473 2e73  e_model_inputs.s
+00010180: 6861 7065 5b3a 2d31 5d2c 2064 7479 7065  hape[:-1], dtype
+00010190: 3d6d 696e 6473 706f 7265 2e69 6e74 3634  =mindspore.int64
+000101a0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+000101b0: 2020 2069 6e70 7574 735f 656d 6265 6473     inputs_embeds
+000101c0: 203d 2073 656c 662e 6c61 6e67 7561 6765   = self.language
+000101d0: 5f6d 6f64 656c 2e67 6574 5f69 6e70 7574  _model.get_input
+000101e0: 5f65 6d62 6564 6469 6e67 7328 2928 696e  _embeddings()(in
+000101f0: 7075 745f 6964 7329 0a20 2020 2020 2020  put_ids).       
+00010200: 2069 6e70 7574 735f 656d 6265 6473 203d   inputs_embeds =
+00010210: 206f 7073 2e63 6174 285b 6c61 6e67 7561   ops.cat([langua
+00010220: 6765 5f6d 6f64 656c 5f69 6e70 7574 732c  ge_model_inputs,
+00010230: 2069 6e70 7574 735f 656d 6265 6473 5d2c   inputs_embeds],
+00010240: 2061 7869 733d 3129 0a0a 2020 2020 2020   axis=1)..      
+00010250: 2020 6966 2061 7474 656e 7469 6f6e 5f6d    if attention_m
+00010260: 6173 6b20 6973 204e 6f6e 653a 0a20 2020  ask is None:.   
+00010270: 2020 2020 2020 2020 2061 7474 656e 7469           attenti
+00010280: 6f6e 5f6d 6173 6b20 3d20 6f70 732e 6f6e  on_mask = ops.on
+00010290: 6573 5f6c 696b 6528 696e 7075 745f 6964  es_like(input_id
+000102a0: 7329 0a20 2020 2020 2020 2061 7474 656e  s).        atten
+000102b0: 7469 6f6e 5f6d 6173 6b20 3d20 6f70 732e  tion_mask = ops.
+000102c0: 6361 7428 5b6c 616e 6775 6167 655f 6d6f  cat([language_mo
+000102d0: 6465 6c5f 6174 7465 6e74 696f 6e5f 6d61  del_attention_ma
+000102e0: 736b 2e61 7374 7970 6528 6d69 6e64 7370  sk.astype(mindsp
+000102f0: 6f72 652e 626f 6f6c 5f29 2c20 6174 7465  ore.bool_), atte
+00010300: 6e74 696f 6e5f 6d61 736b 2e61 7374 7970  ntion_mask.astyp
+00010310: 6528 6d69 6e64 7370 6f72 652e 626f 6f6c  e(mindspore.bool
+00010320: 5f29 5d2c 2061 7869 733d 3129 0a0a 2020  _)], axis=1)..  
+00010330: 2020 2020 2020 6966 2073 656c 662e 636f        if self.co
+00010340: 6e66 6967 2e75 7365 5f64 6563 6f64 6572  nfig.use_decoder
+00010350: 5f6f 6e6c 795f 6c61 6e67 7561 6765 5f6d  _only_language_m
+00010360: 6f64 656c 3a0a 2020 2020 2020 2020 2020  odel:.          
+00010370: 2020 6f75 7470 7574 7320 3d20 7365 6c66    outputs = self
+00010380: 2e6c 616e 6775 6167 655f 6d6f 6465 6c28  .language_model(
+00010390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000103a0: 2069 6e70 7574 735f 656d 6265 6473 3d69   inputs_embeds=i
+000103b0: 6e70 7574 735f 656d 6265 6473 2c0a 2020  nputs_embeds,.  
+000103c0: 2020 2020 2020 2020 2020 2020 2020 6174                at
+000103d0: 7465 6e74 696f 6e5f 6d61 736b 3d61 7474  tention_mask=att
+000103e0: 656e 7469 6f6e 5f6d 6173 6b2c 0a20 2020  ention_mask,.   
+000103f0: 2020 2020 2020 2020 2020 2020 206f 7574               out
+00010400: 7075 745f 6174 7465 6e74 696f 6e73 3d6f  put_attentions=o
+00010410: 7574 7075 745f 6174 7465 6e74 696f 6e73  utput_attentions
+00010420: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00010430: 2020 6f75 7470 7574 5f68 6964 6465 6e5f    output_hidden_
+00010440: 7374 6174 6573 3d6f 7574 7075 745f 6869  states=output_hi
+00010450: 6464 656e 5f73 7461 7465 732c 0a20 2020  dden_states,.   
+00010460: 2020 2020 2020 2020 2020 2020 2072 6574               ret
+00010470: 7572 6e5f 6469 6374 3d72 6574 7572 6e5f  urn_dict=return_
+00010480: 6469 6374 2c0a 2020 2020 2020 2020 2020  dict,.          
+00010490: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+000104a0: 6c6f 6769 7473 203d 206f 7574 7075 7473  logits = outputs
+000104b0: 2e6c 6f67 6974 7320 6966 2072 6574 7572  .logits if retur
+000104c0: 6e5f 6469 6374 2065 6c73 6520 6f75 7470  n_dict else outp
+000104d0: 7574 735b 305d 0a20 2020 2020 2020 2020  uts[0].         
+000104e0: 2020 206c 6f73 7320 3d20 4e6f 6e65 0a20     loss = None. 
+000104f0: 2020 2020 2020 2020 2020 2023 2077 6520             # we 
+00010500: 636f 6d70 7574 6520 7468 6520 6c6f 7373  compute the loss
+00010510: 2068 6572 6520 7369 6e63 6520 7765 206e   here since we n
+00010520: 6565 6420 746f 2074 616b 6520 696e 746f  eed to take into
+00010530: 2061 6363 6f75 6e74 2074 6865 2073 6571   account the seq
+00010540: 7565 6e63 6520 6c65 6e67 7468 206f 6620  uence length of 
+00010550: 7468 6520 7175 6572 7920 656d 6265 6473  the query embeds
+00010560: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00010570: 6c61 6265 6c73 2069 7320 6e6f 7420 4e6f  labels is not No
+00010580: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00010590: 2020 2020 6c6f 6769 7473 203d 206c 6f67      logits = log
+000105a0: 6974 735b 3a2c 202d 6c61 6265 6c73 2e73  its[:, -labels.s
+000105b0: 6861 7065 5b31 5d20 3a2c 203a 5d0a 2020  hape[1] :, :].  
+000105c0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+000105d0: 5368 6966 7420 736f 2074 6861 7420 746f  Shift so that to
+000105e0: 6b65 6e73 203c 206e 2070 7265 6469 6374  kens < n predict
+000105f0: 206e 0a20 2020 2020 2020 2020 2020 2020   n.             
+00010600: 2020 2073 6869 6674 5f6c 6f67 6974 7320     shift_logits 
+00010610: 3d20 6c6f 6769 7473 5b2e 2e2e 2c20 3a2d  = logits[..., :-
+00010620: 312c 203a 5d0a 2020 2020 2020 2020 2020  1, :].          
+00010630: 2020 2020 2020 7368 6966 745f 6c61 6265        shift_labe
+00010640: 6c73 203d 206c 6162 656c 735b 2e2e 2e2c  ls = labels[...,
+00010650: 2031 3a5d 0a0a 2020 2020 2020 2020 2020   1:]..          
+00010660: 2020 2020 2020 2320 466c 6174 7465 6e20        # Flatten 
+00010670: 7468 6520 746f 6b65 6e73 0a20 2020 2020  the tokens.     
+00010680: 2020 2020 2020 2020 2020 206c 6f73 7320             loss 
+00010690: 3d20 6f70 732e 6372 6f73 735f 656e 7472  = ops.cross_entr
+000106a0: 6f70 7928 7368 6966 745f 6c6f 6769 7473  opy(shift_logits
+000106b0: 2e76 6965 7728 2d31 2c20 7365 6c66 2e63  .view(-1, self.c
+000106c0: 6f6e 6669 672e 7465 7874 5f63 6f6e 6669  onfig.text_confi
+000106d0: 672e 766f 6361 625f 7369 7a65 292c 2073  g.vocab_size), s
+000106e0: 6869 6674 5f6c 6162 656c 732e 7669 6577  hift_labels.view
+000106f0: 282d 3129 290a 2020 2020 2020 2020 656c  (-1)).        el
+00010700: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00010710: 6f75 7470 7574 7320 3d20 7365 6c66 2e6c  outputs = self.l
+00010720: 616e 6775 6167 655f 6d6f 6465 6c28 0a20  anguage_model(. 
+00010730: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00010740: 6e70 7574 735f 656d 6265 6473 3d69 6e70  nputs_embeds=inp
+00010750: 7574 735f 656d 6265 6473 2c0a 2020 2020  uts_embeds,.    
+00010760: 2020 2020 2020 2020 2020 2020 6174 7465              atte
+00010770: 6e74 696f 6e5f 6d61 736b 3d61 7474 656e  ntion_mask=atten
+00010780: 7469 6f6e 5f6d 6173 6b2c 0a20 2020 2020  tion_mask,.     
+00010790: 2020 2020 2020 2020 2020 2064 6563 6f64             decod
+000107a0: 6572 5f69 6e70 7574 5f69 6473 3d64 6563  er_input_ids=dec
+000107b0: 6f64 6572 5f69 6e70 7574 5f69 6473 2c0a  oder_input_ids,.
+000107c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000107d0: 6465 636f 6465 725f 6174 7465 6e74 696f  decoder_attentio
+000107e0: 6e5f 6d61 736b 3d64 6563 6f64 6572 5f61  n_mask=decoder_a
+000107f0: 7474 656e 7469 6f6e 5f6d 6173 6b2c 0a20  ttention_mask,. 
+00010800: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00010810: 7574 7075 745f 6174 7465 6e74 696f 6e73  utput_attentions
+00010820: 3d6f 7574 7075 745f 6174 7465 6e74 696f  =output_attentio
+00010830: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
+00010840: 2020 2020 6f75 7470 7574 5f68 6964 6465      output_hidde
+00010850: 6e5f 7374 6174 6573 3d6f 7574 7075 745f  n_states=output_
+00010860: 6869 6464 656e 5f73 7461 7465 732c 0a20  hidden_states,. 
+00010870: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00010880: 6574 7572 6e5f 6469 6374 3d72 6574 7572  eturn_dict=retur
+00010890: 6e5f 6469 6374 2c0a 2020 2020 2020 2020  n_dict,.        
+000108a0: 2020 2020 2020 2020 6c61 6265 6c73 3d6c          labels=l
+000108b0: 6162 656c 732c 0a20 2020 2020 2020 2020  abels,.         
+000108c0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+000108d0: 206c 6f73 7320 3d20 6f75 7470 7574 732e   loss = outputs.
+000108e0: 6c6f 7373 2069 6620 7265 7475 726e 5f64  loss if return_d
+000108f0: 6963 7420 656c 7365 206f 7574 7075 7473  ict else outputs
+00010900: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
+00010910: 6c6f 6769 7473 203d 206f 7574 7075 7473  logits = outputs
+00010920: 2e6c 6f67 6974 7320 6966 2072 6574 7572  .logits if retur
+00010930: 6e5f 6469 6374 2065 6c73 6520 6f75 7470  n_dict else outp
+00010940: 7574 735b 315d 0a0a 2020 2020 2020 2020  uts[1]..        
+00010950: 6966 206e 6f74 2072 6574 7572 6e5f 6469  if not return_di
+00010960: 6374 3a0a 2020 2020 2020 2020 2020 2020  ct:.            
+00010970: 6f75 7470 7574 203d 2028 6c6f 6769 7473  output = (logits
+00010980: 2c20 7669 7369 6f6e 5f6f 7574 7075 7473  , vision_outputs
+00010990: 2c20 7175 6572 795f 6f75 7470 7574 732c  , query_outputs,
+000109a0: 206f 7574 7075 7473 290a 2020 2020 2020   outputs).      
+000109b0: 2020 2020 2020 7265 7475 726e 2028 286c        return ((l
+000109c0: 6f73 732c 2920 2b20 6f75 7470 7574 2920  oss,) + output) 
+000109d0: 6966 206c 6f73 7320 6973 206e 6f74 204e  if loss is not N
+000109e0: 6f6e 6520 656c 7365 206f 7574 7075 740a  one else output.
+000109f0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00010a00: 426c 6970 3246 6f72 436f 6e64 6974 696f  Blip2ForConditio
+00010a10: 6e61 6c47 656e 6572 6174 696f 6e4d 6f64  nalGenerationMod
+00010a20: 656c 4f75 7470 7574 280a 2020 2020 2020  elOutput(.      
+00010a30: 2020 2020 2020 6c6f 7373 3d6c 6f73 732c        loss=loss,
+00010a40: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+00010a50: 6974 733d 6c6f 6769 7473 2c0a 2020 2020  its=logits,.    
+00010a60: 2020 2020 2020 2020 7669 7369 6f6e 5f6f          vision_o
+00010a70: 7574 7075 7473 3d76 6973 696f 6e5f 6f75  utputs=vision_ou
+00010a80: 7470 7574 732c 0a20 2020 2020 2020 2020  tputs,.         
+00010a90: 2020 2071 666f 726d 6572 5f6f 7574 7075     qformer_outpu
+00010aa0: 7473 3d71 7565 7279 5f6f 7574 7075 7473  ts=query_outputs
+00010ab0: 2c0a 2020 2020 2020 2020 2020 2020 6c61  ,.            la
+00010ac0: 6e67 7561 6765 5f6d 6f64 656c 5f6f 7574  nguage_model_out
+00010ad0: 7075 7473 3d6f 7574 7075 7473 2c0a 2020  puts=outputs,.  
+00010ae0: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
+00010af0: 2067 656e 6572 6174 6528 0a20 2020 2020   generate(.     
+00010b00: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+00010b10: 2070 6978 656c 5f76 616c 7565 733a 206d   pixel_values: m
+00010b20: 696e 6473 706f 7265 2e54 656e 736f 722c  indspore.Tensor,
+00010b30: 0a20 2020 2020 2020 2069 6e70 7574 5f69  .        input_i
+00010b40: 6473 3a20 4f70 7469 6f6e 616c 5b6d 696e  ds: Optional[min
+00010b50: 6473 706f 7265 2e54 656e 736f 725d 203d  dspore.Tensor] =
+00010b60: 204e 6f6e 652c 0a20 2020 2020 2020 2061   None,.        a
+00010b70: 7474 656e 7469 6f6e 5f6d 6173 6b3a 204f  ttention_mask: O
+00010b80: 7074 696f 6e61 6c5b 6d69 6e64 7370 6f72  ptional[mindspor
+00010b90: 652e 5465 6e73 6f72 5d20 3d20 4e6f 6e65  e.Tensor] = None
+00010ba0: 2c0a 2020 2020 2020 2020 2a2a 6765 6e65  ,.        **gene
+00010bb0: 7261 7465 5f6b 7761 7267 732c 0a20 2020  rate_kwargs,.   
+00010bc0: 2029 202d 3e20 6d69 6e64 7370 6f72 652e   ) -> mindspore.
+00010bd0: 5465 6e73 6f72 3a0a 2020 2020 2020 2020  Tensor:.        
+00010be0: 2222 220a 2020 2020 2020 2020 4f76 6572  """.        Over
+00010bf0: 7269 6465 7320 6067 656e 6572 6174 6560  rides `generate`
+00010c00: 2066 756e 6374 696f 6e20 746f 2062 6520   function to be 
+00010c10: 6162 6c65 2074 6f20 7573 6520 7468 6520  able to use the 
+00010c20: 6d6f 6465 6c20 6173 2061 2063 6f6e 6469  model as a condi
+00010c30: 7469 6f6e 616c 2067 656e 6572 6174 6f72  tional generator
+00010c40: 2e0a 0a20 2020 2020 2020 2041 7267 733a  ...        Args:
+00010c50: 0a20 2020 2020 2020 2020 2020 2070 6978  .            pix
+00010c60: 656c 5f76 616c 7565 7320 2860 6d69 6e64  el_values (`mind
+00010c70: 7370 6f72 652e 5465 6e73 6f72 6020 6f66  spore.Tensor` of
+00010c80: 2073 6861 7065 2028 6261 7463 685f 7369   shape (batch_si
+00010c90: 7a65 2c20 6e75 6d5f 6368 616e 6e65 6c73  ze, num_channels
+00010ca0: 2c20 6865 6967 6874 2c20 7769 6474 6829  , height, width)
+00010cb0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00010cc0: 2020 2049 6e70 7574 2069 6d61 6765 7320     Input images 
+00010cd0: 746f 2062 6520 7072 6f63 6573 7365 642e  to be processed.
+00010ce0: 0a20 2020 2020 2020 2020 2020 2069 6e70  .            inp
+00010cf0: 7574 5f69 6473 2028 606d 696e 6473 706f  ut_ids (`mindspo
+00010d00: 7265 2e54 656e 736f 7260 206f 6620 7368  re.Tensor` of sh
+00010d10: 6170 6520 2862 6174 6368 5f73 697a 652c  ape (batch_size,
+00010d20: 2073 6571 7565 6e63 655f 6c65 6e67 7468   sequence_length
+00010d30: 292c 202a 6f70 7469 6f6e 616c 2a29 3a0a  ), *optional*):.
+00010d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010d50: 5468 6520 7365 7175 656e 6365 2075 7365  The sequence use
+00010d60: 6420 6173 2061 2070 726f 6d70 7420 666f  d as a prompt fo
+00010d70: 7220 7468 6520 6765 6e65 7261 7469 6f6e  r the generation
+00010d80: 2e0a 2020 2020 2020 2020 2020 2020 6174  ..            at
+00010d90: 7465 6e74 696f 6e5f 6d61 736b 2028 606d  tention_mask (`m
+00010da0: 696e 6473 706f 7265 2e54 656e 736f 7260  indspore.Tensor`
+00010db0: 206f 6620 7368 6170 6520 2862 6174 6368   of shape (batch
+00010dc0: 5f73 697a 652c 2073 6571 7565 6e63 655f  _size, sequence_
+00010dd0: 6c65 6e67 7468 292c 202a 6f70 7469 6f6e  length), *option
+00010de0: 616c 2a29 3a0a 2020 2020 2020 2020 2020  al*):.          
+00010df0: 2020 2020 2020 4d61 736b 2074 6f20 6176        Mask to av
+00010e00: 6f69 6420 7065 7266 6f72 6d69 6e67 2061  oid performing a
+00010e10: 7474 656e 7469 6f6e 206f 6e20 7061 6464  ttention on padd
+00010e20: 696e 6720 746f 6b65 6e20 696e 6469 6365  ing token indice
+00010e30: 730a 0a20 2020 2020 2020 2052 6574 7572  s..        Retur
+00010e40: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
+00010e50: 6361 7074 696f 6e73 2028 6c69 7374 293a  captions (list):
+00010e60: 2041 206c 6973 7420 6f66 2073 7472 696e   A list of strin
+00010e70: 6773 206f 6620 6c65 6e67 7468 2062 6174  gs of length bat
+00010e80: 6368 5f73 697a 6520 2a20 6e75 6d5f 6361  ch_size * num_ca
+00010e90: 7074 696f 6e73 2e0a 2020 2020 2020 2020  ptions..        
+00010ea0: 2222 220a 2020 2020 2020 2020 6261 7463  """.        batc
+00010eb0: 685f 7369 7a65 203d 2070 6978 656c 5f76  h_size = pixel_v
+00010ec0: 616c 7565 732e 7368 6170 655b 305d 0a20  alues.shape[0]. 
+00010ed0: 2020 2020 2020 2069 6d61 6765 5f65 6d62         image_emb
+00010ee0: 6564 7320 3d20 7365 6c66 2e76 6973 696f  eds = self.visio
+00010ef0: 6e5f 6d6f 6465 6c28 7069 7865 6c5f 7661  n_model(pixel_va
+00010f00: 6c75 6573 2c20 7265 7475 726e 5f64 6963  lues, return_dic
+00010f10: 743d 5472 7565 292e 6c61 7374 5f68 6964  t=True).last_hid
+00010f20: 6465 6e5f 7374 6174 650a 0a20 2020 2020  den_state..     
+00010f30: 2020 2069 6d61 6765 5f61 7474 656e 7469     image_attenti
+00010f40: 6f6e 5f6d 6173 6b20 3d20 6f70 732e 6f6e  on_mask = ops.on
+00010f50: 6573 2869 6d61 6765 5f65 6d62 6564 732e  es(image_embeds.
+00010f60: 7368 6170 655b 3a2d 315d 2c20 6474 7970  shape[:-1], dtyp
+00010f70: 653d 6d69 6e64 7370 6f72 652e 696e 7436  e=mindspore.int6
+00010f80: 3429 0a0a 2020 2020 2020 2020 7175 6572  4)..        quer
+00010f90: 795f 746f 6b65 6e73 203d 2073 656c 662e  y_tokens = self.
+00010fa0: 7175 6572 795f 746f 6b65 6e73 2e65 7870  query_tokens.exp
+00010fb0: 616e 6428 696d 6167 655f 656d 6265 6473  and(image_embeds
+00010fc0: 2e73 6861 7065 5b30 5d2c 202d 312c 202d  .shape[0], -1, -
+00010fd0: 3129 0a20 2020 2020 2020 2071 7565 7279  1).        query
+00010fe0: 5f6f 7574 7075 7473 203d 2073 656c 662e  _outputs = self.
+00010ff0: 7166 6f72 6d65 7228 0a20 2020 2020 2020  qformer(.       
+00011000: 2020 2020 2071 7565 7279 5f65 6d62 6564       query_embed
+00011010: 733d 7175 6572 795f 746f 6b65 6e73 2c0a  s=query_tokens,.
+00011020: 2020 2020 2020 2020 2020 2020 656e 636f              enco
+00011030: 6465 725f 6869 6464 656e 5f73 7461 7465  der_hidden_state
+00011040: 733d 696d 6167 655f 656d 6265 6473 2c0a  s=image_embeds,.
+00011050: 2020 2020 2020 2020 2020 2020 656e 636f              enco
+00011060: 6465 725f 6174 7465 6e74 696f 6e5f 6d61  der_attention_ma
+00011070: 736b 3d69 6d61 6765 5f61 7474 656e 7469  sk=image_attenti
+00011080: 6f6e 5f6d 6173 6b2c 0a20 2020 2020 2020  on_mask,.       
+00011090: 2020 2020 2072 6574 7572 6e5f 6469 6374       return_dict
+000110a0: 3d54 7275 652c 0a20 2020 2020 2020 2029  =True,.        )
+000110b0: 0a20 2020 2020 2020 2071 7565 7279 5f6f  .        query_o
+000110c0: 7574 7075 7420 3d20 7175 6572 795f 6f75  utput = query_ou
+000110d0: 7470 7574 732e 6c61 7374 5f68 6964 6465  tputs.last_hidde
+000110e0: 6e5f 7374 6174 650a 0a20 2020 2020 2020  n_state..       
+000110f0: 206c 616e 6775 6167 655f 6d6f 6465 6c5f   language_model_
+00011100: 696e 7075 7473 203d 2073 656c 662e 6c61  inputs = self.la
+00011110: 6e67 7561 6765 5f70 726f 6a65 6374 696f  nguage_projectio
+00011120: 6e28 7175 6572 795f 6f75 7470 7574 290a  n(query_output).
+00011130: 2020 2020 2020 2020 6c61 6e67 7561 6765          language
+00011140: 5f61 7474 656e 7469 6f6e 5f6d 6173 6b20  _attention_mask 
+00011150: 3d20 6f70 732e 6f6e 6573 280a 2020 2020  = ops.ones(.    
+00011160: 2020 2020 2020 2020 6c61 6e67 7561 6765          language
+00011170: 5f6d 6f64 656c 5f69 6e70 7574 732e 7368  _model_inputs.sh
+00011180: 6170 655b 3a2d 315d 2c20 6474 7970 653d  ape[:-1], dtype=
+00011190: 6d69 6e64 7370 6f72 652e 696e 7436 340a  mindspore.int64.
+000111a0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+000111b0: 2020 6966 2069 6e70 7574 5f69 6473 2069    if input_ids i
+000111c0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+000111d0: 2020 2020 696e 7075 745f 6964 7320 3d20      input_ids = 
+000111e0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000111f0: 2020 6d69 6e64 7370 6f72 652e 5465 6e73    mindspore.Tens
+00011200: 6f72 285b 5b73 656c 662e 636f 6e66 6967  or([[self.config
+00011210: 2e74 6578 745f 636f 6e66 6967 2e62 6f73  .text_config.bos
+00011220: 5f74 6f6b 656e 5f69 645d 5d29 0a20 2020  _token_id]]).   
+00011230: 2020 2020 2020 2020 2020 2020 202e 7265               .re
+00011240: 7065 6174 2862 6174 6368 5f73 697a 652c  peat(batch_size,
+00011250: 2031 290a 2020 2020 2020 2020 2020 2020   1).            
+00011260: 290a 2020 2020 2020 2020 6966 2061 7474  ).        if att
+00011270: 656e 7469 6f6e 5f6d 6173 6b20 6973 204e  ention_mask is N
+00011280: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00011290: 2061 7474 656e 7469 6f6e 5f6d 6173 6b20   attention_mask 
+000112a0: 3d20 6f70 732e 6f6e 6573 5f6c 696b 6528  = ops.ones_like(
+000112b0: 696e 7075 745f 6964 7329 0a20 2020 2020  input_ids).     
+000112c0: 2020 2061 7474 656e 7469 6f6e 5f6d 6173     attention_mas
+000112d0: 6b20 3d20 6f70 732e 6361 7428 5b6c 616e  k = ops.cat([lan
+000112e0: 6775 6167 655f 6174 7465 6e74 696f 6e5f  guage_attention_
+000112f0: 6d61 736b 2c20 6174 7465 6e74 696f 6e5f  mask, attention_
+00011300: 6d61 736b 5d2c 2061 7869 733d 3129 0a0a  mask], axis=1)..
+00011310: 2020 2020 2020 2020 2320 636f 6e63 6174          # concat
+00011320: 656e 6174 6520 7175 6572 7920 656d 6265  enate query embe
+00011330: 6464 696e 6773 2077 6974 6820 7072 6f6d  ddings with prom
+00011340: 7074 2065 6d62 6564 6469 6e67 730a 2020  pt embeddings.  
+00011350: 2020 2020 2020 696e 7075 7473 5f65 6d62        inputs_emb
+00011360: 6564 7320 3d20 7365 6c66 2e67 6574 5f69  eds = self.get_i
+00011370: 6e70 7574 5f65 6d62 6564 6469 6e67 7328  nput_embeddings(
+00011380: 2928 696e 7075 745f 6964 7329 0a20 2020  )(input_ids).   
+00011390: 2020 2020 2069 6e70 7574 735f 656d 6265       inputs_embe
+000113a0: 6473 203d 206f 7073 2e63 6174 285b 6c61  ds = ops.cat([la
+000113b0: 6e67 7561 6765 5f6d 6f64 656c 5f69 6e70  nguage_model_inp
+000113c0: 7574 732c 2069 6e70 7574 735f 656d 6265  uts, inputs_embe
+000113d0: 6473 5d2c 2061 7869 733d 3129 0a0a 2020  ds], axis=1)..  
+000113e0: 2020 2020 2020 2320 6164 6420 696d 6167        # add imag
+000113f0: 655f 656d 6265 6473 206c 656e 6774 6820  e_embeds length 
+00011400: 746f 206d 6178 5f6c 656e 6774 682c 2073  to max_length, s
+00011410: 6f20 7468 6174 2074 6865 2066 696e 616c  o that the final
+00011420: 206d 6178 5f6c 656e 6774 6820 696e 2063   max_length in c
+00011430: 6f75 6e74 6564 206f 6e6c 7920 6f6e 2074  ounted only on t
+00011440: 6f6b 656e 2065 6d62 6564 730a 2020 2020  oken embeds.    
+00011450: 2020 2020 2320 2d31 2069 7320 746f 2061      # -1 is to a
+00011460: 6363 6f75 6e74 2066 6f72 2074 6865 2070  ccount for the p
+00011470: 7265 7065 6e64 6564 2042 4f53 2061 6674  repended BOS aft
+00011480: 6572 2060 6765 6e65 7261 7465 2e60 0a20  er `generate.`. 
+00011490: 2020 2020 2020 2023 2054 4f44 4f20 286a         # TODO (j
+000114a0: 6f61 6f2c 2072 6175 7368 616e 293a 2072  oao, raushan): r
+000114b0: 6566 6163 746f 7220 6067 656e 6572 6174  efactor `generat
+000114c0: 6560 2074 6f20 6176 6f69 6420 7468 6573  e` to avoid thes
+000114d0: 6520 6f70 6572 6174 696f 6e73 2077 6974  e operations wit
+000114e0: 6820 564c 4d73 0a20 2020 2020 2020 2069  h VLMs.        i
+000114f0: 6620 6e6f 7420 7365 6c66 2e6c 616e 6775  f not self.langu
+00011500: 6167 655f 6d6f 6465 6c2e 636f 6e66 6967  age_model.config
+00011510: 2e69 735f 656e 636f 6465 725f 6465 636f  .is_encoder_deco
+00011520: 6465 723a 0a20 2020 2020 2020 2020 2020  der:.           
+00011530: 2067 656e 6572 6174 655f 6b77 6172 6773   generate_kwargs
+00011540: 5b22 6d61 785f 6c65 6e67 7468 225d 203d  ["max_length"] =
+00011550: 2067 656e 6572 6174 655f 6b77 6172 6773   generate_kwargs
+00011560: 2e67 6574 2822 6d61 785f 6c65 6e67 7468  .get("max_length
+00011570: 222c 2032 3029 202b 206c 616e 6775 6167  ", 20) + languag
+00011580: 655f 6d6f 6465 6c5f 696e 7075 7473 2e73  e_model_inputs.s
+00011590: 6861 7065 5b31 5d20 2d20 310a 2020 2020  hape[1] - 1.    
+000115a0: 2020 2020 2020 2020 6765 6e65 7261 7465          generate
+000115b0: 5f6b 7761 7267 735b 226d 696e 5f6c 656e  _kwargs["min_len
+000115c0: 6774 6822 5d20 3d20 6765 6e65 7261 7465  gth"] = generate
+000115d0: 5f6b 7761 7267 732e 6765 7428 226d 696e  _kwargs.get("min
+000115e0: 5f6c 656e 6774 6822 2c20 3029 202b 206c  _length", 0) + l
+000115f0: 616e 6775 6167 655f 6d6f 6465 6c5f 696e  anguage_model_in
+00011600: 7075 7473 2e73 6861 7065 5b31 5d0a 0a20  puts.shape[1].. 
+00011610: 2020 2020 2020 206f 7574 7075 7473 203d         outputs =
+00011620: 2073 656c 662e 6c61 6e67 7561 6765 5f6d   self.language_m
+00011630: 6f64 656c 2e67 656e 6572 6174 6528 0a20  odel.generate(. 
+00011640: 2020 2020 2020 2020 2020 2069 6e70 7574             input
+00011650: 735f 656d 6265 6473 3d69 6e70 7574 735f  s_embeds=inputs_
+00011660: 656d 6265 6473 2c0a 2020 2020 2020 2020  embeds,.        
+00011670: 2020 2020 6174 7465 6e74 696f 6e5f 6d61      attention_ma
+00011680: 736b 3d61 7474 656e 7469 6f6e 5f6d 6173  sk=attention_mas
+00011690: 6b2c 0a20 2020 2020 2020 2020 2020 202a  k,.            *
+000116a0: 2a67 656e 6572 6174 655f 6b77 6172 6773  *generate_kwargs
+000116b0: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
+000116c0: 2020 2020 2072 6574 7572 6e20 6f75 7470       return outp
+000116d0: 7574 730a 0a5f 5f61 6c6c 5f5f 203d 205b  uts..__all__ = [
+000116e0: 0a20 2020 2022 426c 6970 324d 6f64 656c  .    "Blip2Model
+000116f0: 222c 0a20 2020 2022 426c 6970 3251 466f  ",.    "Blip2QFo
+00011700: 726d 6572 4d6f 6465 6c22 2c0a 2020 2020  rmerModel",.    
+00011710: 2242 6c69 7032 5072 6554 7261 696e 6564  "Blip2PreTrained
+00011720: 4d6f 6465 6c22 2c0a 2020 2020 2242 6c69  Model",.    "Bli
+00011730: 7032 466f 7243 6f6e 6469 7469 6f6e 616c  p2ForConditional
+00011740: 4765 6e65 7261 7469 6f6e 222c 0a20 2020  Generation",.   
+00011750: 2022 426c 6970 3256 6973 696f 6e4d 6f64   "Blip2VisionMod
+00011760: 656c 222c 0a5d 0a                        el",.].
```

## mindnlp/transformers/models/blip_2/processing_blip_2.py

```diff
@@ -0,0 +1,421 @@
+00000000: 2320 636f 6469 6e67 3d75 7466 2d38 0a23  # coding=utf-8.#
+00000010: 2043 6f70 7972 6967 6874 2032 3032 3320   Copyright 2023 
+00000020: 5468 6520 4875 6767 696e 6746 6163 6520  The HuggingFace 
+00000030: 496e 632e 2074 6561 6d2e 0a23 0a23 204c  Inc. team..#.# L
+00000040: 6963 656e 7365 6420 756e 6465 7220 7468  icensed under th
+00000050: 6520 4170 6163 6865 204c 6963 656e 7365  e Apache License
+00000060: 2c20 5665 7273 696f 6e20 322e 3020 2874  , Version 2.0 (t
+00000070: 6865 2022 4c69 6365 6e73 6522 293b 0a23  he "License");.#
+00000080: 2079 6f75 206d 6179 206e 6f74 2075 7365   you may not use
+00000090: 2074 6869 7320 6669 6c65 2065 7863 6570   this file excep
+000000a0: 7420 696e 2063 6f6d 706c 6961 6e63 6520  t in compliance 
+000000b0: 7769 7468 2074 6865 204c 6963 656e 7365  with the License
+000000c0: 2e0a 2320 596f 7520 6d61 7920 6f62 7461  ..# You may obta
+000000d0: 696e 2061 2063 6f70 7920 6f66 2074 6865  in a copy of the
+000000e0: 204c 6963 656e 7365 2061 740a 230a 2320   License at.#.# 
+000000f0: 2020 2020 6874 7470 3a2f 2f77 7777 2e61      http://www.a
+00000100: 7061 6368 652e 6f72 672f 6c69 6365 6e73  pache.org/licens
+00000110: 6573 2f4c 4943 454e 5345 2d32 2e30 0a23  es/LICENSE-2.0.#
+00000120: 0a23 2055 6e6c 6573 7320 7265 7175 6972  .# Unless requir
+00000130: 6564 2062 7920 6170 706c 6963 6162 6c65  ed by applicable
+00000140: 206c 6177 206f 7220 6167 7265 6564 2074   law or agreed t
+00000150: 6f20 696e 2077 7269 7469 6e67 2c20 736f  o in writing, so
+00000160: 6674 7761 7265 0a23 2064 6973 7472 6962  ftware.# distrib
+00000170: 7574 6564 2075 6e64 6572 2074 6865 204c  uted under the L
+00000180: 6963 656e 7365 2069 7320 6469 7374 7269  icense is distri
+00000190: 6275 7465 6420 6f6e 2061 6e20 2241 5320  buted on an "AS 
+000001a0: 4953 2220 4241 5349 532c 0a23 2057 4954  IS" BASIS,.# WIT
+000001b0: 484f 5554 2057 4152 5241 4e54 4945 5320  HOUT WARRANTIES 
+000001c0: 4f52 2043 4f4e 4449 5449 4f4e 5320 4f46  OR CONDITIONS OF
+000001d0: 2041 4e59 204b 494e 442c 2065 6974 6865   ANY KIND, eithe
+000001e0: 7220 6578 7072 6573 7320 6f72 2069 6d70  r express or imp
+000001f0: 6c69 6564 2e0a 2320 5365 6520 7468 6520  lied..# See the 
+00000200: 4c69 6365 6e73 6520 666f 7220 7468 6520  License for the 
+00000210: 7370 6563 6966 6963 206c 616e 6775 6167  specific languag
+00000220: 6520 676f 7665 726e 696e 6720 7065 726d  e governing perm
+00000230: 6973 7369 6f6e 7320 616e 640a 2320 6c69  issions and.# li
+00000240: 6d69 7461 7469 6f6e 7320 756e 6465 7220  mitations under 
+00000250: 7468 6520 4c69 6365 6e73 652e 0a22 2222  the License.."""
+00000260: 0a50 726f 6365 7373 6f72 2063 6c61 7373  .Processor class
+00000270: 2066 6f72 2042 4c49 502d 322e 0a22 2222   for BLIP-2.."""
+00000280: 0a0a 6672 6f6d 2074 7970 696e 6720 696d  ..from typing im
+00000290: 706f 7274 204c 6973 742c 204f 7074 696f  port List, Optio
+000002a0: 6e61 6c2c 2055 6e69 6f6e 0a0a 6672 6f6d  nal, Union..from
+000002b0: 202e 2e2e 696d 6167 655f 7574 696c 7320   ...image_utils 
+000002c0: 696d 706f 7274 2049 6d61 6765 496e 7075  import ImageInpu
+000002d0: 740a 6672 6f6d 202e 2e2e 7072 6f63 6573  t.from ...proces
+000002e0: 7369 6e67 5f75 7469 6c73 2069 6d70 6f72  sing_utils impor
+000002f0: 7420 5072 6f63 6573 736f 724d 6978 696e  t ProcessorMixin
+00000300: 0a66 726f 6d20 2e2e 2e74 6f6b 656e 697a  .from ...tokeniz
+00000310: 6174 696f 6e5f 7574 696c 735f 6261 7365  ation_utils_base
+00000320: 2069 6d70 6f72 7420 4261 7463 6845 6e63   import BatchEnc
+00000330: 6f64 696e 672c 2050 6164 6469 6e67 5374  oding, PaddingSt
+00000340: 7261 7465 6779 2c20 5072 6554 6f6b 656e  rategy, PreToken
+00000350: 697a 6564 496e 7075 742c 2054 6578 7449  izedInput, TextI
+00000360: 6e70 7574 2c20 5472 756e 6361 7469 6f6e  nput, Truncation
+00000370: 5374 7261 7465 6779 0a66 726f 6d20 2e2e  Strategy.from ..
+00000380: 2e2e 7574 696c 7320 696d 706f 7274 2054  ..utils import T
+00000390: 656e 736f 7254 7970 650a 0a0a 636c 6173  ensorType...clas
+000003a0: 7320 426c 6970 3250 726f 6365 7373 6f72  s Blip2Processor
+000003b0: 2850 726f 6365 7373 6f72 4d69 7869 6e29  (ProcessorMixin)
+000003c0: 3a0a 2020 2020 7222 2222 0a20 2020 2043  :.    r""".    C
+000003d0: 6f6e 7374 7275 6374 7320 6120 424c 4950  onstructs a BLIP
+000003e0: 2d32 2070 726f 6365 7373 6f72 2077 6869  -2 processor whi
+000003f0: 6368 2077 7261 7073 2061 2042 4c49 5020  ch wraps a BLIP 
+00000400: 696d 6167 6520 7072 6f63 6573 736f 7220  image processor 
+00000410: 616e 6420 616e 204f 5054 2f54 3520 746f  and an OPT/T5 to
+00000420: 6b65 6e69 7a65 7220 696e 746f 2061 2073  kenizer into a s
+00000430: 696e 676c 6520 7072 6f63 6573 736f 722e  ingle processor.
+00000440: 0a0a 2020 2020 5b60 426c 6970 5072 6f63  ..    [`BlipProc
+00000450: 6573 736f 7260 5d20 6f66 6665 7273 2061  essor`] offers a
+00000460: 6c6c 2074 6865 2066 756e 6374 696f 6e61  ll the functiona
+00000470: 6c69 7469 6573 206f 6620 5b60 426c 6970  lities of [`Blip
+00000480: 496d 6167 6550 726f 6365 7373 6f72 605d  ImageProcessor`]
+00000490: 2061 6e64 205b 6041 7574 6f54 6f6b 656e   and [`AutoToken
+000004a0: 697a 6572 605d 2e20 5365 6520 7468 6520  izer`]. See the 
+000004b0: 646f 6373 7472 696e 670a 2020 2020 6f66  docstring.    of
+000004c0: 205b 607e 426c 6970 5072 6f63 6573 736f   [`~BlipProcesso
+000004d0: 722e 5f5f 6361 6c6c 5f5f 605d 2061 6e64  r.__call__`] and
+000004e0: 205b 607e 426c 6970 5072 6f63 6573 736f   [`~BlipProcesso
+000004f0: 722e 6465 636f 6465 605d 2066 6f72 206d  r.decode`] for m
+00000500: 6f72 6520 696e 666f 726d 6174 696f 6e2e  ore information.
+00000510: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
+00000520: 2020 2020 696d 6167 655f 7072 6f63 6573      image_proces
+00000530: 736f 7220 2860 426c 6970 496d 6167 6550  sor (`BlipImageP
+00000540: 726f 6365 7373 6f72 6029 3a0a 2020 2020  rocessor`):.    
+00000550: 2020 2020 2020 2020 416e 2069 6e73 7461          An insta
+00000560: 6e63 6520 6f66 205b 6042 6c69 7049 6d61  nce of [`BlipIma
+00000570: 6765 5072 6f63 6573 736f 7260 5d2e 2054  geProcessor`]. T
+00000580: 6865 2069 6d61 6765 2070 726f 6365 7373  he image process
+00000590: 6f72 2069 7320 6120 7265 7175 6972 6564  or is a required
+000005a0: 2069 6e70 7574 2e0a 2020 2020 2020 2020   input..        
+000005b0: 746f 6b65 6e69 7a65 7220 2860 4175 746f  tokenizer (`Auto
+000005c0: 546f 6b65 6e69 7a65 7260 293a 0a20 2020  Tokenizer`):.   
+000005d0: 2020 2020 2020 2020 2041 6e20 696e 7374           An inst
+000005e0: 616e 6365 206f 6620 5b27 5072 6554 7261  ance of ['PreTra
+000005f0: 696e 6564 546f 6b65 6e69 7a65 7260 5d2e  inedTokenizer`].
+00000600: 2054 6865 2074 6f6b 656e 697a 6572 2069   The tokenizer i
+00000610: 7320 6120 7265 7175 6972 6564 2069 6e70  s a required inp
+00000620: 7574 2e0a 2020 2020 2222 220a 0a20 2020  ut..    """..   
+00000630: 2061 7474 7269 6275 7465 7320 3d20 5b22   attributes = ["
+00000640: 696d 6167 655f 7072 6f63 6573 736f 7222  image_processor"
+00000650: 2c20 2274 6f6b 656e 697a 6572 225d 0a20  , "tokenizer"]. 
+00000660: 2020 2069 6d61 6765 5f70 726f 6365 7373     image_process
+00000670: 6f72 5f63 6c61 7373 203d 2022 426c 6970  or_class = "Blip
+00000680: 496d 6167 6550 726f 6365 7373 6f72 220a  ImageProcessor".
+00000690: 2020 2020 746f 6b65 6e69 7a65 725f 636c      tokenizer_cl
+000006a0: 6173 7320 3d20 2241 7574 6f54 6f6b 656e  ass = "AutoToken
+000006b0: 697a 6572 220a 0a20 2020 2023 2043 6f70  izer"..    # Cop
+000006c0: 6965 6420 6672 6f6d 2074 7261 6e73 666f  ied from transfo
+000006d0: 726d 6572 732e 6d6f 6465 6c73 2e62 6c69  rmers.models.bli
+000006e0: 702e 7072 6f63 6573 7369 6e67 5f62 6c69  p.processing_bli
+000006f0: 702e 426c 6970 5072 6f63 6573 736f 722e  p.BlipProcessor.
+00000700: 5f5f 696e 6974 5f5f 0a20 2020 2064 6566  __init__.    def
+00000710: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
+00000720: 696d 6167 655f 7072 6f63 6573 736f 722c  image_processor,
+00000730: 2074 6f6b 656e 697a 6572 293a 0a20 2020   tokenizer):.   
+00000740: 2020 2020 2074 6f6b 656e 697a 6572 2e72       tokenizer.r
+00000750: 6574 7572 6e5f 746f 6b65 6e5f 7479 7065  eturn_token_type
+00000760: 5f69 6473 203d 2046 616c 7365 0a20 2020  _ids = False.   
+00000770: 2020 2020 2073 7570 6572 2829 2e5f 5f69       super().__i
+00000780: 6e69 745f 5f28 696d 6167 655f 7072 6f63  nit__(image_proc
+00000790: 6573 736f 722c 2074 6f6b 656e 697a 6572  essor, tokenizer
+000007a0: 290a 2020 2020 2020 2020 7365 6c66 2e63  ).        self.c
+000007b0: 7572 7265 6e74 5f70 726f 6365 7373 6f72  urrent_processor
+000007c0: 203d 2073 656c 662e 696d 6167 655f 7072   = self.image_pr
+000007d0: 6f63 6573 736f 720a 0a20 2020 2023 2043  ocessor..    # C
+000007e0: 6f70 6965 6420 6672 6f6d 2074 7261 6e73  opied from trans
+000007f0: 666f 726d 6572 732e 6d6f 6465 6c73 2e62  formers.models.b
+00000800: 6c69 702e 7072 6f63 6573 7369 6e67 5f62  lip.processing_b
+00000810: 6c69 702e 426c 6970 5072 6f63 6573 736f  lip.BlipProcesso
+00000820: 722e 5f5f 6361 6c6c 5f5f 0a20 2020 2064  r.__call__.    d
+00000830: 6566 205f 5f63 616c 6c5f 5f28 0a20 2020  ef __call__(.   
+00000840: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+00000850: 2020 2069 6d61 6765 733a 2049 6d61 6765     images: Image
+00000860: 496e 7075 7420 3d20 4e6f 6e65 2c0a 2020  Input = None,.  
+00000870: 2020 2020 2020 7465 7874 3a20 556e 696f        text: Unio
+00000880: 6e5b 5465 7874 496e 7075 742c 2050 7265  n[TextInput, Pre
+00000890: 546f 6b65 6e69 7a65 6449 6e70 7574 2c20  TokenizedInput, 
+000008a0: 4c69 7374 5b54 6578 7449 6e70 7574 5d2c  List[TextInput],
+000008b0: 204c 6973 745b 5072 6554 6f6b 656e 697a   List[PreTokeniz
+000008c0: 6564 496e 7075 745d 5d20 3d20 4e6f 6e65  edInput]] = None
+000008d0: 2c0a 2020 2020 2020 2020 6164 645f 7370  ,.        add_sp
+000008e0: 6563 6961 6c5f 746f 6b65 6e73 3a20 626f  ecial_tokens: bo
+000008f0: 6f6c 203d 2054 7275 652c 0a20 2020 2020  ol = True,.     
+00000900: 2020 2070 6164 6469 6e67 3a20 556e 696f     padding: Unio
+00000910: 6e5b 626f 6f6c 2c20 7374 722c 2050 6164  n[bool, str, Pad
+00000920: 6469 6e67 5374 7261 7465 6779 5d20 3d20  dingStrategy] = 
+00000930: 4661 6c73 652c 0a20 2020 2020 2020 2074  False,.        t
+00000940: 7275 6e63 6174 696f 6e3a 2055 6e69 6f6e  runcation: Union
+00000950: 5b62 6f6f 6c2c 2073 7472 2c20 5472 756e  [bool, str, Trun
+00000960: 6361 7469 6f6e 5374 7261 7465 6779 5d20  cationStrategy] 
+00000970: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00000980: 6d61 785f 6c65 6e67 7468 3a20 4f70 7469  max_length: Opti
+00000990: 6f6e 616c 5b69 6e74 5d20 3d20 4e6f 6e65  onal[int] = None
+000009a0: 2c0a 2020 2020 2020 2020 7374 7269 6465  ,.        stride
+000009b0: 3a20 696e 7420 3d20 302c 0a20 2020 2020  : int = 0,.     
+000009c0: 2020 2070 6164 5f74 6f5f 6d75 6c74 6970     pad_to_multip
+000009d0: 6c65 5f6f 663a 204f 7074 696f 6e61 6c5b  le_of: Optional[
+000009e0: 696e 745d 203d 204e 6f6e 652c 0a20 2020  int] = None,.   
+000009f0: 2020 2020 2072 6574 7572 6e5f 6174 7465       return_atte
+00000a00: 6e74 696f 6e5f 6d61 736b 3a20 4f70 7469  ntion_mask: Opti
+00000a10: 6f6e 616c 5b62 6f6f 6c5d 203d 204e 6f6e  onal[bool] = Non
+00000a20: 652c 0a20 2020 2020 2020 2072 6574 7572  e,.        retur
+00000a30: 6e5f 6f76 6572 666c 6f77 696e 675f 746f  n_overflowing_to
+00000a40: 6b65 6e73 3a20 626f 6f6c 203d 2046 616c  kens: bool = Fal
+00000a50: 7365 2c0a 2020 2020 2020 2020 7265 7475  se,.        retu
+00000a60: 726e 5f73 7065 6369 616c 5f74 6f6b 656e  rn_special_token
+00000a70: 735f 6d61 736b 3a20 626f 6f6c 203d 2046  s_mask: bool = F
+00000a80: 616c 7365 2c0a 2020 2020 2020 2020 7265  alse,.        re
+00000a90: 7475 726e 5f6f 6666 7365 7473 5f6d 6170  turn_offsets_map
+00000aa0: 7069 6e67 3a20 626f 6f6c 203d 2046 616c  ping: bool = Fal
+00000ab0: 7365 2c0a 2020 2020 2020 2020 7265 7475  se,.        retu
+00000ac0: 726e 5f74 6f6b 656e 5f74 7970 655f 6964  rn_token_type_id
+00000ad0: 733a 2062 6f6f 6c20 3d20 4661 6c73 652c  s: bool = False,
+00000ae0: 0a20 2020 2020 2020 2072 6574 7572 6e5f  .        return_
+00000af0: 6c65 6e67 7468 3a20 626f 6f6c 203d 2046  length: bool = F
+00000b00: 616c 7365 2c0a 2020 2020 2020 2020 7665  alse,.        ve
+00000b10: 7262 6f73 653a 2062 6f6f 6c20 3d20 5472  rbose: bool = Tr
+00000b20: 7565 2c0a 2020 2020 2020 2020 7265 7475  ue,.        retu
+00000b30: 726e 5f74 656e 736f 7273 3a20 4f70 7469  rn_tensors: Opti
+00000b40: 6f6e 616c 5b55 6e69 6f6e 5b73 7472 2c20  onal[Union[str, 
+00000b50: 5465 6e73 6f72 5479 7065 5d5d 203d 204e  TensorType]] = N
+00000b60: 6f6e 652c 0a20 2020 2020 2020 202a 2a6b  one,.        **k
+00000b70: 7761 7267 732c 0a20 2020 2029 202d 3e20  wargs,.    ) -> 
+00000b80: 4261 7463 6845 6e63 6f64 696e 673a 0a20  BatchEncoding:. 
+00000b90: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00000ba0: 2020 2054 6869 7320 6d65 7468 6f64 2075     This method u
+00000bb0: 7365 7320 5b60 426c 6970 496d 6167 6550  ses [`BlipImageP
+00000bc0: 726f 6365 7373 6f72 2e5f 5f63 616c 6c5f  rocessor.__call_
+00000bd0: 5f60 5d20 6d65 7468 6f64 2074 6f20 7072  _`] method to pr
+00000be0: 6570 6172 6520 696d 6167 6528 7329 2066  epare image(s) f
+00000bf0: 6f72 2074 6865 206d 6f64 656c 2c20 616e  or the model, an
+00000c00: 640a 2020 2020 2020 2020 5b60 4265 7274  d.        [`Bert
+00000c10: 546f 6b65 6e69 7a65 7246 6173 742e 5f5f  TokenizerFast.__
+00000c20: 6361 6c6c 5f5f 605d 2074 6f20 7072 6570  call__`] to prep
+00000c30: 6172 6520 7465 7874 2066 6f72 2074 6865  are text for the
+00000c40: 206d 6f64 656c 2e0a 0a20 2020 2020 2020   model...       
+00000c50: 2050 6c65 6173 6520 7265 6665 7220 746f   Please refer to
+00000c60: 2074 6865 2064 6f63 7374 7269 6e67 206f   the docstring o
+00000c70: 6620 7468 6520 6162 6f76 6520 7477 6f20  f the above two 
+00000c80: 6d65 7468 6f64 7320 666f 7220 6d6f 7265  methods for more
+00000c90: 2069 6e66 6f72 6d61 7469 6f6e 2e0a 2020   information..  
+00000ca0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00000cb0: 2020 6966 2069 6d61 6765 7320 6973 204e    if images is N
+00000cc0: 6f6e 6520 616e 6420 7465 7874 2069 7320  one and text is 
+00000cd0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00000ce0: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+00000cf0: 6f72 2822 596f 7520 6861 7665 2074 6f20  or("You have to 
+00000d00: 7370 6563 6966 7920 6569 7468 6572 2069  specify either i
+00000d10: 6d61 6765 7320 6f72 2074 6578 742e 2229  mages or text.")
+00000d20: 0a0a 2020 2020 2020 2020 2320 4765 7420  ..        # Get 
+00000d30: 6f6e 6c79 2074 6578 740a 2020 2020 2020  only text.      
+00000d40: 2020 6966 2069 6d61 6765 7320 6973 204e    if images is N
+00000d50: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00000d60: 2073 656c 662e 6375 7272 656e 745f 7072   self.current_pr
+00000d70: 6f63 6573 736f 7220 3d20 7365 6c66 2e74  ocessor = self.t
+00000d80: 6f6b 656e 697a 6572 0a20 2020 2020 2020  okenizer.       
+00000d90: 2020 2020 2074 6578 745f 656e 636f 6469       text_encodi
+00000da0: 6e67 203d 2073 656c 662e 746f 6b65 6e69  ng = self.tokeni
+00000db0: 7a65 7228 0a20 2020 2020 2020 2020 2020  zer(.           
+00000dc0: 2020 2020 2074 6578 743d 7465 7874 2c0a       text=text,.
+00000dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00000de0: 6164 645f 7370 6563 6961 6c5f 746f 6b65  add_special_toke
+00000df0: 6e73 3d61 6464 5f73 7065 6369 616c 5f74  ns=add_special_t
+00000e00: 6f6b 656e 732c 0a20 2020 2020 2020 2020  okens,.         
+00000e10: 2020 2020 2020 2070 6164 6469 6e67 3d70         padding=p
+00000e20: 6164 6469 6e67 2c0a 2020 2020 2020 2020  adding,.        
+00000e30: 2020 2020 2020 2020 7472 756e 6361 7469          truncati
+00000e40: 6f6e 3d74 7275 6e63 6174 696f 6e2c 0a20  on=truncation,. 
+00000e50: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00000e60: 6178 5f6c 656e 6774 683d 6d61 785f 6c65  ax_length=max_le
+00000e70: 6e67 7468 2c0a 2020 2020 2020 2020 2020  ngth,.          
+00000e80: 2020 2020 2020 7374 7269 6465 3d73 7472        stride=str
+00000e90: 6964 652c 0a20 2020 2020 2020 2020 2020  ide,.           
+00000ea0: 2020 2020 2070 6164 5f74 6f5f 6d75 6c74       pad_to_mult
+00000eb0: 6970 6c65 5f6f 663d 7061 645f 746f 5f6d  iple_of=pad_to_m
+00000ec0: 756c 7469 706c 655f 6f66 2c0a 2020 2020  ultiple_of,.    
+00000ed0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00000ee0: 726e 5f61 7474 656e 7469 6f6e 5f6d 6173  rn_attention_mas
+00000ef0: 6b3d 7265 7475 726e 5f61 7474 656e 7469  k=return_attenti
+00000f00: 6f6e 5f6d 6173 6b2c 0a20 2020 2020 2020  on_mask,.       
+00000f10: 2020 2020 2020 2020 2072 6574 7572 6e5f           return_
+00000f20: 6f76 6572 666c 6f77 696e 675f 746f 6b65  overflowing_toke
+00000f30: 6e73 3d72 6574 7572 6e5f 6f76 6572 666c  ns=return_overfl
+00000f40: 6f77 696e 675f 746f 6b65 6e73 2c0a 2020  owing_tokens,.  
+00000f50: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00000f60: 7475 726e 5f73 7065 6369 616c 5f74 6f6b  turn_special_tok
+00000f70: 656e 735f 6d61 736b 3d72 6574 7572 6e5f  ens_mask=return_
+00000f80: 7370 6563 6961 6c5f 746f 6b65 6e73 5f6d  special_tokens_m
+00000f90: 6173 6b2c 0a20 2020 2020 2020 2020 2020  ask,.           
+00000fa0: 2020 2020 2072 6574 7572 6e5f 6f66 6673       return_offs
+00000fb0: 6574 735f 6d61 7070 696e 673d 7265 7475  ets_mapping=retu
+00000fc0: 726e 5f6f 6666 7365 7473 5f6d 6170 7069  rn_offsets_mappi
+00000fd0: 6e67 2c0a 2020 2020 2020 2020 2020 2020  ng,.            
+00000fe0: 2020 2020 7265 7475 726e 5f74 6f6b 656e      return_token
+00000ff0: 5f74 7970 655f 6964 733d 7265 7475 726e  _type_ids=return
+00001000: 5f74 6f6b 656e 5f74 7970 655f 6964 732c  _token_type_ids,
+00001010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00001020: 2072 6574 7572 6e5f 6c65 6e67 7468 3d72   return_length=r
+00001030: 6574 7572 6e5f 6c65 6e67 7468 2c0a 2020  eturn_length,.  
+00001040: 2020 2020 2020 2020 2020 2020 2020 7665                ve
+00001050: 7262 6f73 653d 7665 7262 6f73 652c 0a20  rbose=verbose,. 
+00001060: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00001070: 6574 7572 6e5f 7465 6e73 6f72 733d 7265  eturn_tensors=re
+00001080: 7475 726e 5f74 656e 736f 7273 2c0a 2020  turn_tensors,.  
+00001090: 2020 2020 2020 2020 2020 2020 2020 2a2a                **
+000010a0: 6b77 6172 6773 2c0a 2020 2020 2020 2020  kwargs,.        
+000010b0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+000010c0: 2020 7265 7475 726e 2074 6578 745f 656e    return text_en
+000010d0: 636f 6469 6e67 0a0a 2020 2020 2020 2020  coding..        
+000010e0: 2320 6164 6420 7069 7865 6c5f 7661 6c75  # add pixel_valu
+000010f0: 6573 0a20 2020 2020 2020 2065 6e63 6f64  es.        encod
+00001100: 696e 675f 696d 6167 655f 7072 6f63 6573  ing_image_proces
+00001110: 736f 7220 3d20 7365 6c66 2e69 6d61 6765  sor = self.image
+00001120: 5f70 726f 6365 7373 6f72 2869 6d61 6765  _processor(image
+00001130: 732c 2072 6574 7572 6e5f 7465 6e73 6f72  s, return_tensor
+00001140: 733d 7265 7475 726e 5f74 656e 736f 7273  s=return_tensors
+00001150: 290a 0a20 2020 2020 2020 2069 6620 7465  )..        if te
+00001160: 7874 2069 7320 6e6f 7420 4e6f 6e65 3a0a  xt is not None:.
+00001170: 2020 2020 2020 2020 2020 2020 7465 7874              text
+00001180: 5f65 6e63 6f64 696e 6720 3d20 7365 6c66  _encoding = self
+00001190: 2e74 6f6b 656e 697a 6572 280a 2020 2020  .tokenizer(.    
+000011a0: 2020 2020 2020 2020 2020 2020 7465 7874              text
+000011b0: 3d74 6578 742c 0a20 2020 2020 2020 2020  =text,.         
+000011c0: 2020 2020 2020 2061 6464 5f73 7065 6369         add_speci
+000011d0: 616c 5f74 6f6b 656e 733d 6164 645f 7370  al_tokens=add_sp
+000011e0: 6563 6961 6c5f 746f 6b65 6e73 2c0a 2020  ecial_tokens,.  
+000011f0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+00001200: 6464 696e 673d 7061 6464 696e 672c 0a20  dding=padding,. 
+00001210: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00001220: 7275 6e63 6174 696f 6e3d 7472 756e 6361  runcation=trunca
+00001230: 7469 6f6e 2c0a 2020 2020 2020 2020 2020  tion,.          
+00001240: 2020 2020 2020 6d61 785f 6c65 6e67 7468        max_length
+00001250: 3d6d 6178 5f6c 656e 6774 682c 0a20 2020  =max_length,.   
+00001260: 2020 2020 2020 2020 2020 2020 2073 7472               str
+00001270: 6964 653d 7374 7269 6465 2c0a 2020 2020  ide=stride,.    
+00001280: 2020 2020 2020 2020 2020 2020 7061 645f              pad_
+00001290: 746f 5f6d 756c 7469 706c 655f 6f66 3d70  to_multiple_of=p
+000012a0: 6164 5f74 6f5f 6d75 6c74 6970 6c65 5f6f  ad_to_multiple_o
+000012b0: 662c 0a20 2020 2020 2020 2020 2020 2020  f,.             
+000012c0: 2020 2072 6574 7572 6e5f 6174 7465 6e74     return_attent
+000012d0: 696f 6e5f 6d61 736b 3d72 6574 7572 6e5f  ion_mask=return_
+000012e0: 6174 7465 6e74 696f 6e5f 6d61 736b 2c0a  attention_mask,.
+000012f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001300: 7265 7475 726e 5f6f 7665 7266 6c6f 7769  return_overflowi
+00001310: 6e67 5f74 6f6b 656e 733d 7265 7475 726e  ng_tokens=return
+00001320: 5f6f 7665 7266 6c6f 7769 6e67 5f74 6f6b  _overflowing_tok
+00001330: 656e 732c 0a20 2020 2020 2020 2020 2020  ens,.           
+00001340: 2020 2020 2072 6574 7572 6e5f 7370 6563       return_spec
+00001350: 6961 6c5f 746f 6b65 6e73 5f6d 6173 6b3d  ial_tokens_mask=
+00001360: 7265 7475 726e 5f73 7065 6369 616c 5f74  return_special_t
+00001370: 6f6b 656e 735f 6d61 736b 2c0a 2020 2020  okens_mask,.    
+00001380: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00001390: 726e 5f6f 6666 7365 7473 5f6d 6170 7069  rn_offsets_mappi
+000013a0: 6e67 3d72 6574 7572 6e5f 6f66 6673 6574  ng=return_offset
+000013b0: 735f 6d61 7070 696e 672c 0a20 2020 2020  s_mapping,.     
+000013c0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+000013d0: 6e5f 746f 6b65 6e5f 7479 7065 5f69 6473  n_token_type_ids
+000013e0: 3d72 6574 7572 6e5f 746f 6b65 6e5f 7479  =return_token_ty
+000013f0: 7065 5f69 6473 2c0a 2020 2020 2020 2020  pe_ids,.        
+00001400: 2020 2020 2020 2020 7265 7475 726e 5f6c          return_l
+00001410: 656e 6774 683d 7265 7475 726e 5f6c 656e  ength=return_len
+00001420: 6774 682c 0a20 2020 2020 2020 2020 2020  gth,.           
+00001430: 2020 2020 2076 6572 626f 7365 3d76 6572       verbose=ver
+00001440: 626f 7365 2c0a 2020 2020 2020 2020 2020  bose,.          
+00001450: 2020 2020 2020 7265 7475 726e 5f74 656e        return_ten
+00001460: 736f 7273 3d72 6574 7572 6e5f 7465 6e73  sors=return_tens
+00001470: 6f72 732c 0a20 2020 2020 2020 2020 2020  ors,.           
+00001480: 2020 2020 202a 2a6b 7761 7267 732c 0a20       **kwargs,. 
+00001490: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+000014a0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000014b0: 2020 2020 2020 2074 6578 745f 656e 636f         text_enco
+000014c0: 6469 6e67 203d 204e 6f6e 650a 0a20 2020  ding = None..   
+000014d0: 2020 2020 2069 6620 7465 7874 5f65 6e63       if text_enc
+000014e0: 6f64 696e 6720 6973 206e 6f74 204e 6f6e  oding is not Non
+000014f0: 653a 0a20 2020 2020 2020 2020 2020 2065  e:.            e
+00001500: 6e63 6f64 696e 675f 696d 6167 655f 7072  ncoding_image_pr
+00001510: 6f63 6573 736f 722e 7570 6461 7465 2874  ocessor.update(t
+00001520: 6578 745f 656e 636f 6469 6e67 290a 0a20  ext_encoding).. 
+00001530: 2020 2020 2020 2072 6574 7572 6e20 656e         return en
+00001540: 636f 6469 6e67 5f69 6d61 6765 5f70 726f  coding_image_pro
+00001550: 6365 7373 6f72 0a0a 2020 2020 2320 436f  cessor..    # Co
+00001560: 7069 6564 2066 726f 6d20 7472 616e 7366  pied from transf
+00001570: 6f72 6d65 7273 2e6d 6f64 656c 732e 626c  ormers.models.bl
+00001580: 6970 2e70 726f 6365 7373 696e 675f 626c  ip.processing_bl
+00001590: 6970 2e42 6c69 7050 726f 6365 7373 6f72  ip.BlipProcessor
+000015a0: 2e62 6174 6368 5f64 6563 6f64 6520 7769  .batch_decode wi
+000015b0: 7468 2042 6572 7454 6f6b 656e 697a 6572  th BertTokenizer
+000015c0: 4661 7374 2d3e 5072 6554 7261 696e 6564  Fast->PreTrained
+000015d0: 546f 6b65 6e69 7a65 720a 2020 2020 6465  Tokenizer.    de
+000015e0: 6620 6261 7463 685f 6465 636f 6465 2873  f batch_decode(s
+000015f0: 656c 662c 202a 6172 6773 2c20 2a2a 6b77  elf, *args, **kw
+00001600: 6172 6773 293a 0a20 2020 2020 2020 2022  args):.        "
+00001610: 2222 0a20 2020 2020 2020 2054 6869 7320  "".        This 
+00001620: 6d65 7468 6f64 2066 6f72 7761 7264 7320  method forwards 
+00001630: 616c 6c20 6974 7320 6172 6775 6d65 6e74  all its argument
+00001640: 7320 746f 2050 7265 5472 6169 6e65 6454  s to PreTrainedT
+00001650: 6f6b 656e 697a 6572 2773 205b 607e 5072  okenizer's [`~Pr
+00001660: 6554 7261 696e 6564 546f 6b65 6e69 7a65  eTrainedTokenize
+00001670: 722e 6261 7463 685f 6465 636f 6465 605d  r.batch_decode`]
+00001680: 2e20 506c 6561 7365 0a20 2020 2020 2020  . Please.       
+00001690: 2072 6566 6572 2074 6f20 7468 6520 646f   refer to the do
+000016a0: 6373 7472 696e 6720 6f66 2074 6869 7320  cstring of this 
+000016b0: 6d65 7468 6f64 2066 6f72 206d 6f72 6520  method for more 
+000016c0: 696e 666f 726d 6174 696f 6e2e 0a20 2020  information..   
+000016d0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+000016e0: 2072 6574 7572 6e20 7365 6c66 2e74 6f6b   return self.tok
+000016f0: 656e 697a 6572 2e62 6174 6368 5f64 6563  enizer.batch_dec
+00001700: 6f64 6528 2a61 7267 732c 202a 2a6b 7761  ode(*args, **kwa
+00001710: 7267 7329 0a0a 2020 2020 2320 436f 7069  rgs)..    # Copi
+00001720: 6564 2066 726f 6d20 7472 616e 7366 6f72  ed from transfor
+00001730: 6d65 7273 2e6d 6f64 656c 732e 626c 6970  mers.models.blip
+00001740: 2e70 726f 6365 7373 696e 675f 626c 6970  .processing_blip
+00001750: 2e42 6c69 7050 726f 6365 7373 6f72 2e64  .BlipProcessor.d
+00001760: 6563 6f64 6520 7769 7468 2042 6572 7454  ecode with BertT
+00001770: 6f6b 656e 697a 6572 4661 7374 2d3e 5072  okenizerFast->Pr
+00001780: 6554 7261 696e 6564 546f 6b65 6e69 7a65  eTrainedTokenize
+00001790: 720a 2020 2020 6465 6620 6465 636f 6465  r.    def decode
+000017a0: 2873 656c 662c 202a 6172 6773 2c20 2a2a  (self, *args, **
+000017b0: 6b77 6172 6773 293a 0a20 2020 2020 2020  kwargs):.       
+000017c0: 2022 2222 0a20 2020 2020 2020 2054 6869   """.        Thi
+000017d0: 7320 6d65 7468 6f64 2066 6f72 7761 7264  s method forward
+000017e0: 7320 616c 6c20 6974 7320 6172 6775 6d65  s all its argume
+000017f0: 6e74 7320 746f 2050 7265 5472 6169 6e65  nts to PreTraine
+00001800: 6454 6f6b 656e 697a 6572 2773 205b 607e  dTokenizer's [`~
+00001810: 5072 6554 7261 696e 6564 546f 6b65 6e69  PreTrainedTokeni
+00001820: 7a65 722e 6465 636f 6465 605d 2e20 506c  zer.decode`]. Pl
+00001830: 6561 7365 2072 6566 6572 2074 6f0a 2020  ease refer to.  
+00001840: 2020 2020 2020 7468 6520 646f 6373 7472        the docstr
+00001850: 696e 6720 6f66 2074 6869 7320 6d65 7468  ing of this meth
+00001860: 6f64 2066 6f72 206d 6f72 6520 696e 666f  od for more info
+00001870: 726d 6174 696f 6e2e 0a20 2020 2020 2020  rmation..       
+00001880: 2022 2222 0a20 2020 2020 2020 2072 6574   """.        ret
+00001890: 7572 6e20 7365 6c66 2e74 6f6b 656e 697a  urn self.tokeniz
+000018a0: 6572 2e64 6563 6f64 6528 2a61 7267 732c  er.decode(*args,
+000018b0: 202a 2a6b 7761 7267 7329 0a0a 2020 2020   **kwargs)..    
+000018c0: 4070 726f 7065 7274 790a 2020 2020 2320  @property.    # 
+000018d0: 436f 7069 6564 2066 726f 6d20 7472 616e  Copied from tran
+000018e0: 7366 6f72 6d65 7273 2e6d 6f64 656c 732e  sformers.models.
+000018f0: 626c 6970 2e70 726f 6365 7373 696e 675f  blip.processing_
+00001900: 626c 6970 2e42 6c69 7050 726f 6365 7373  blip.BlipProcess
+00001910: 6f72 2e6d 6f64 656c 5f69 6e70 7574 5f6e  or.model_input_n
+00001920: 616d 6573 0a20 2020 2064 6566 206d 6f64  ames.    def mod
+00001930: 656c 5f69 6e70 7574 5f6e 616d 6573 2873  el_input_names(s
+00001940: 656c 6629 3a0a 2020 2020 2020 2020 746f  elf):.        to
+00001950: 6b65 6e69 7a65 725f 696e 7075 745f 6e61  kenizer_input_na
+00001960: 6d65 7320 3d20 7365 6c66 2e74 6f6b 656e  mes = self.token
+00001970: 697a 6572 2e6d 6f64 656c 5f69 6e70 7574  izer.model_input
+00001980: 5f6e 616d 6573 0a20 2020 2020 2020 2069  _names.        i
+00001990: 6d61 6765 5f70 726f 6365 7373 6f72 5f69  mage_processor_i
+000019a0: 6e70 7574 5f6e 616d 6573 203d 2073 656c  nput_names = sel
+000019b0: 662e 696d 6167 655f 7072 6f63 6573 736f  f.image_processo
+000019c0: 722e 6d6f 6465 6c5f 696e 7075 745f 6e61  r.model_input_na
+000019d0: 6d65 730a 2020 2020 2020 2020 7265 7475  mes.        retu
+000019e0: 726e 206c 6973 7428 6469 6374 2e66 726f  rn list(dict.fro
+000019f0: 6d6b 6579 7328 746f 6b65 6e69 7a65 725f  mkeys(tokenizer_
+00001a00: 696e 7075 745f 6e61 6d65 7320 2b20 696d  input_names + im
+00001a10: 6167 655f 7072 6f63 6573 736f 725f 696e  age_processor_in
+00001a20: 7075 745f 6e61 6d65 7329 290a 0a5f 5f61  put_names))..__a
+00001a30: 6c6c 5f5f 203d 205b 2742 6c69 7032 5072  ll__ = ['Blip2Pr
+00001a40: 6f63 6573 736f 7227 5d0a                 ocessor'].
```

## mindnlp/transformers/models/bridgetower/__init__.py

```diff
@@ -0,0 +1,74 @@
+00000000: 2320 436f 7079 7269 6768 7420 3230 3234  # Copyright 2024
+00000010: 2048 7561 7765 6920 5465 6368 6e6f 6c6f   Huawei Technolo
+00000020: 6769 6573 2043 6f2e 2c20 4c74 640a 230a  gies Co., Ltd.#.
+00000030: 2320 4c69 6365 6e73 6564 2075 6e64 6572  # Licensed under
+00000040: 2074 6865 2041 7061 6368 6520 4c69 6365   the Apache Lice
+00000050: 6e73 652c 2056 6572 7369 6f6e 2032 2e30  nse, Version 2.0
+00000060: 2028 7468 6520 224c 6963 656e 7365 2229   (the "License")
+00000070: 3b0a 2320 796f 7520 6d61 7920 6e6f 7420  ;.# you may not 
+00000080: 7573 6520 7468 6973 2066 696c 6520 6578  use this file ex
+00000090: 6365 7074 2069 6e20 636f 6d70 6c69 616e  cept in complian
+000000a0: 6365 2077 6974 6820 7468 6520 4c69 6365  ce with the Lice
+000000b0: 6e73 652e 0a23 2059 6f75 206d 6179 206f  nse..# You may o
+000000c0: 6274 6169 6e20 6120 636f 7079 206f 6620  btain a copy of 
+000000d0: 7468 6520 4c69 6365 6e73 6520 6174 0a23  the License at.#
+000000e0: 0a23 2068 7474 703a 2f2f 7777 772e 6170  .# http://www.ap
+000000f0: 6163 6865 2e6f 7267 2f6c 6963 656e 7365  ache.org/license
+00000100: 732f 4c49 4345 4e53 452d 322e 300a 230a  s/LICENSE-2.0.#.
+00000110: 2320 556e 6c65 7373 2072 6571 7569 7265  # Unless require
+00000120: 6420 6279 2061 7070 6c69 6361 626c 6520  d by applicable 
+00000130: 6c61 7720 6f72 2061 6772 6565 6420 746f  law or agreed to
+00000140: 2069 6e20 7772 6974 696e 672c 2073 6f66   in writing, sof
+00000150: 7477 6172 650a 2320 6469 7374 7269 6275  tware.# distribu
+00000160: 7465 6420 756e 6465 7220 7468 6520 4c69  ted under the Li
+00000170: 6365 6e73 6520 6973 2064 6973 7472 6962  cense is distrib
+00000180: 7574 6564 206f 6e20 616e 2022 4153 2049  uted on an "AS I
+00000190: 5322 2042 4153 4953 2c0a 2320 5749 5448  S" BASIS,.# WITH
+000001a0: 4f55 5420 5741 5252 414e 5449 4553 204f  OUT WARRANTIES O
+000001b0: 5220 434f 4e44 4954 494f 4e53 204f 4620  R CONDITIONS OF 
+000001c0: 414e 5920 4b49 4e44 2c20 6569 7468 6572  ANY KIND, either
+000001d0: 2065 7870 7265 7373 206f 7220 696d 706c   express or impl
+000001e0: 6965 642e 0a23 2053 6565 2074 6865 204c  ied..# See the L
+000001f0: 6963 656e 7365 2066 6f72 2074 6865 2073  icense for the s
+00000200: 7065 6369 6669 6320 6c61 6e67 7561 6765  pecific language
+00000210: 2067 6f76 6572 6e69 6e67 2070 6572 6d69   governing permi
+00000220: 7373 696f 6e73 2061 6e64 0a23 206c 696d  ssions and.# lim
+00000230: 6974 6174 696f 6e73 2075 6e64 6572 2074  itations under t
+00000240: 6865 204c 6963 656e 7365 2e0a 2320 3d3d  he License..# ==
+00000250: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00000260: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00000270: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00000280: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00000290: 3d3d 3d3d 3d3d 3d3d 3d3d 0a22 2222 0a42  ==========.""".B
+000002a0: 7269 6467 6554 6f77 6572 204d 6f64 656c  ridgeTower Model
+000002b0: 2e0a 2222 220a 6672 6f6d 202e 2069 6d70  ..""".from . imp
+000002c0: 6f72 7420 636f 6e66 6967 7572 6174 696f  ort configuratio
+000002d0: 6e5f 6272 6964 6765 746f 7765 722c 206d  n_bridgetower, m
+000002e0: 6f64 656c 696e 675f 6272 6964 6765 746f  odeling_bridgeto
+000002f0: 7765 722c 2069 6d61 6765 5f70 726f 6365  wer, image_proce
+00000300: 7373 696e 675f 6272 6964 6765 746f 7765  ssing_bridgetowe
+00000310: 722c 2070 726f 6365 7373 696e 675f 6272  r, processing_br
+00000320: 6964 6765 746f 7765 720a 6672 6f6d 202e  idgetower.from .
+00000330: 636f 6e66 6967 7572 6174 696f 6e5f 6272  configuration_br
+00000340: 6964 6765 746f 7765 7220 696d 706f 7274  idgetower import
+00000350: 202a 0a66 726f 6d20 2e6d 6f64 656c 696e   *.from .modelin
+00000360: 675f 6272 6964 6765 746f 7765 7220 696d  g_bridgetower im
+00000370: 706f 7274 202a 0a66 726f 6d20 2e69 6d61  port *.from .ima
+00000380: 6765 5f70 726f 6365 7373 696e 675f 6272  ge_processing_br
+00000390: 6964 6765 746f 7765 7220 696d 706f 7274  idgetower import
+000003a0: 202a 0a66 726f 6d20 2e70 726f 6365 7373   *.from .process
+000003b0: 696e 675f 6272 6964 6765 746f 7765 7220  ing_bridgetower 
+000003c0: 696d 706f 7274 202a 0a0a 5f5f 616c 6c5f  import *..__all_
+000003d0: 5f20 3d20 5b5d 0a5f 5f61 6c6c 5f5f 2e65  _ = [].__all__.e
+000003e0: 7874 656e 6428 636f 6e66 6967 7572 6174  xtend(configurat
+000003f0: 696f 6e5f 6272 6964 6765 746f 7765 722e  ion_bridgetower.
+00000400: 5f5f 616c 6c5f 5f29 0a5f 5f61 6c6c 5f5f  __all__).__all__
+00000410: 2e65 7874 656e 6428 6d6f 6465 6c69 6e67  .extend(modeling
+00000420: 5f62 7269 6467 6574 6f77 6572 2e5f 5f61  _bridgetower.__a
+00000430: 6c6c 5f5f 290a 5f5f 616c 6c5f 5f2e 6578  ll__).__all__.ex
+00000440: 7465 6e64 2869 6d61 6765 5f70 726f 6365  tend(image_proce
+00000450: 7373 696e 675f 6272 6964 6765 746f 7765  ssing_bridgetowe
+00000460: 722e 5f5f 616c 6c5f 5f29 0a5f 5f61 6c6c  r.__all__).__all
+00000470: 5f5f 2e65 7874 656e 6428 7072 6f63 6573  __.extend(proces
+00000480: 7369 6e67 5f62 7269 6467 6574 6f77 6572  sing_bridgetower
+00000490: 2e5f 5f61 6c6c 5f5f 290a                 .__all__).
```

## mindnlp/transformers/models/bridgetower/configuration_bridgetower.py

```diff
@@ -0,0 +1,1019 @@
+00000000: 2320 636f 6469 6e67 3d75 7466 2d38 0a23  # coding=utf-8.#
+00000010: 2043 6f70 7972 6967 6874 2032 3032 3320   Copyright 2023 
+00000020: 5468 6520 496e 7465 6c20 4c61 6273 2054  The Intel Labs T
+00000030: 6561 6d20 4175 7468 6f72 732c 2054 6865  eam Authors, The
+00000040: 204d 6963 726f 736f 6674 2052 6573 6561   Microsoft Resea
+00000050: 7263 6820 5465 616d 2041 7574 686f 7273  rch Team Authors
+00000060: 2061 6e64 2048 7567 6769 6e67 4661 6365   and HuggingFace
+00000070: 2049 6e63 2e20 7465 616d 2e20 416c 6c20   Inc. team. All 
+00000080: 7269 6768 7473 2072 6573 6572 7665 642e  rights reserved.
+00000090: 0a23 0a23 204c 6963 656e 7365 6420 756e  .#.# Licensed un
+000000a0: 6465 7220 7468 6520 4170 6163 6865 204c  der the Apache L
+000000b0: 6963 656e 7365 3d2c 2056 6572 7369 6f6e  icense=, Version
+000000c0: 2032 2e30 2028 7468 6520 224c 6963 656e   2.0 (the "Licen
+000000d0: 7365 2229 3b0a 2320 796f 7520 6d61 7920  se");.# you may 
+000000e0: 6e6f 7420 7573 6520 7468 6973 2066 696c  not use this fil
+000000f0: 6520 6578 6365 7074 2069 6e20 636f 6d70  e except in comp
+00000100: 6c69 616e 6365 2077 6974 6820 7468 6520  liance with the 
+00000110: 4c69 6365 6e73 652e 0a23 2059 6f75 206d  License..# You m
+00000120: 6179 206f 6274 6169 6e20 6120 636f 7079  ay obtain a copy
+00000130: 206f 6620 7468 6520 4c69 6365 6e73 6520   of the License 
+00000140: 6174 0a23 0a23 2020 2020 2068 7474 703a  at.#.#     http:
+00000150: 2f2f 7777 772e 6170 6163 6865 2e6f 7267  //www.apache.org
+00000160: 2f6c 6963 656e 7365 732f 4c49 4345 4e53  /licenses/LICENS
+00000170: 452d 322e 300a 230a 2320 556e 6c65 7373  E-2.0.#.# Unless
+00000180: 2072 6571 7569 7265 6420 6279 2061 7070   required by app
+00000190: 6c69 6361 626c 6520 6c61 7720 6f72 2061  licable law or a
+000001a0: 6772 6565 6420 746f 2069 6e20 7772 6974  greed to in writ
+000001b0: 696e 673d 2c20 736f 6674 7761 7265 0a23  ing=, software.#
+000001c0: 2064 6973 7472 6962 7574 6564 2075 6e64   distributed und
+000001d0: 6572 2074 6865 204c 6963 656e 7365 2069  er the License i
+000001e0: 7320 6469 7374 7269 6275 7465 6420 6f6e  s distributed on
+000001f0: 2061 6e20 2241 5320 4953 2220 4241 5349   an "AS IS" BASI
+00000200: 533d 2c0a 2320 5749 5448 4f55 5420 5741  S=,.# WITHOUT WA
+00000210: 5252 414e 5449 4553 204f 5220 434f 4e44  RRANTIES OR COND
+00000220: 4954 494f 4e53 204f 4620 414e 5920 4b49  ITIONS OF ANY KI
+00000230: 4e44 3d2c 2065 6974 6865 7220 6578 7072  ND=, either expr
+00000240: 6573 7320 6f72 2069 6d70 6c69 6564 2e0a  ess or implied..
+00000250: 2320 5365 6520 7468 6520 4c69 6365 6e73  # See the Licens
+00000260: 6520 666f 7220 7468 6520 7370 6563 6966  e for the specif
+00000270: 6963 206c 616e 6775 6167 6520 676f 7665  ic language gove
+00000280: 726e 696e 6720 7065 726d 6973 7369 6f6e  rning permission
+00000290: 7320 616e 640a 2320 6c69 6d69 7461 7469  s and.# limitati
+000002a0: 6f6e 7320 756e 6465 7220 7468 6520 4c69  ons under the Li
+000002b0: 6365 6e73 652e 0a22 2222 2042 7269 6467  cense..""" Bridg
+000002c0: 6554 6f77 6572 206d 6f64 656c 2063 6f6e  eTower model con
+000002d0: 6669 6775 7261 7469 6f6e 2222 220a 0a69  figuration"""..i
+000002e0: 6d70 6f72 7420 6f73 0a66 726f 6d20 7479  mport os.from ty
+000002f0: 7069 6e67 2069 6d70 6f72 7420 556e 696f  ping import Unio
+00000300: 6e0a 0a66 726f 6d20 2e2e 2e63 6f6e 6669  n..from ...confi
+00000310: 6775 7261 7469 6f6e 5f75 7469 6c73 2069  guration_utils i
+00000320: 6d70 6f72 7420 5072 6574 7261 696e 6564  mport Pretrained
+00000330: 436f 6e66 6967 0a66 726f 6d20 2e2e 2e2e  Config.from ....
+00000340: 7574 696c 7320 696d 706f 7274 206c 6f67  utils import log
+00000350: 6769 6e67 0a0a 0a6c 6f67 6765 7220 3d20  ging...logger = 
+00000360: 6c6f 6767 696e 672e 6765 745f 6c6f 6767  logging.get_logg
+00000370: 6572 285f 5f6e 616d 655f 5f29 0a0a 0a63  er(__name__)...c
+00000380: 6c61 7373 2042 7269 6467 6554 6f77 6572  lass BridgeTower
+00000390: 5669 7369 6f6e 436f 6e66 6967 2850 7265  VisionConfig(Pre
+000003a0: 7472 6169 6e65 6443 6f6e 6669 6729 3a0a  trainedConfig):.
+000003b0: 2020 2020 7222 2222 0a20 2020 2054 6869      r""".    Thi
+000003c0: 7320 6973 2074 6865 2063 6f6e 6669 6775  s is the configu
+000003d0: 7261 7469 6f6e 2063 6c61 7373 2074 6f20  ration class to 
+000003e0: 7374 6f72 6520 7468 6520 7669 7369 6f6e  store the vision
+000003f0: 2063 6f6e 6669 6775 7261 7469 6f6e 206f   configuration o
+00000400: 6620 6120 5b60 4272 6964 6765 546f 7765  f a [`BridgeTowe
+00000410: 724d 6f64 656c 605d 2e20 496e 7374 616e  rModel`]. Instan
+00000420: 7469 6174 696e 6720 610a 2020 2020 636f  tiating a.    co
+00000430: 6e66 6967 7572 6174 696f 6e20 7769 7468  nfiguration with
+00000440: 2074 6865 2064 6566 6175 6c74 7320 7769   the defaults wi
+00000450: 6c6c 2079 6965 6c64 2061 2073 696d 696c  ll yield a simil
+00000460: 6172 2063 6f6e 6669 6775 7261 7469 6f6e  ar configuration
+00000470: 2074 6f20 7468 6174 206f 6620 7468 6520   to that of the 
+00000480: 6272 6964 6765 746f 7765 722d 6261 7365  bridgetower-base
+00000490: 0a20 2020 205b 4272 6964 6765 546f 7765  .    [BridgeTowe
+000004a0: 722f 6272 6964 6765 746f 7765 722d 6261  r/bridgetower-ba
+000004b0: 7365 5d28 6874 7470 733a 2f2f 6875 6767  se](https://hugg
+000004c0: 696e 6766 6163 652e 636f 2f42 7269 6467  ingface.co/Bridg
+000004d0: 6554 6f77 6572 2f62 7269 6467 6574 6f77  eTower/bridgetow
+000004e0: 6572 2d62 6173 652f 2920 6172 6368 6974  er-base/) archit
+000004f0: 6563 7475 7265 2e0a 0a20 2020 2043 6f6e  ecture...    Con
+00000500: 6669 6775 7261 7469 6f6e 206f 626a 6563  figuration objec
+00000510: 7473 2069 6e68 6572 6974 2066 726f 6d20  ts inherit from 
+00000520: 5b60 5072 6574 7261 696e 6564 436f 6e66  [`PretrainedConf
+00000530: 6967 605d 2061 6e64 2063 616e 2062 6520  ig`] and can be 
+00000540: 7573 6564 2074 6f20 636f 6e74 726f 6c20  used to control 
+00000550: 7468 6520 6d6f 6465 6c20 6f75 7470 7574  the model output
+00000560: 732e 2052 6561 6420 7468 650a 2020 2020  s. Read the.    
+00000570: 646f 6375 6d65 6e74 6174 696f 6e20 6672  documentation fr
+00000580: 6f6d 205b 6050 7265 7472 6169 6e65 6443  om [`PretrainedC
+00000590: 6f6e 6669 6760 5d20 666f 7220 6d6f 7265  onfig`] for more
+000005a0: 2069 6e66 6f72 6d61 7469 6f6e 2e0a 0a20   information... 
+000005b0: 2020 2041 7267 733a 0a20 2020 2020 2020     Args:.       
+000005c0: 2068 6964 6465 6e5f 7369 7a65 2028 6069   hidden_size (`i
+000005d0: 6e74 602c 202a 6f70 7469 6f6e 616c 2a2c  nt`, *optional*,
+000005e0: 2064 6566 6175 6c74 7320 746f 2037 3638   defaults to 768
+000005f0: 293a 0a20 2020 2020 2020 2020 2020 2044  ):.            D
+00000600: 696d 656e 7369 6f6e 616c 6974 7920 6f66  imensionality of
+00000610: 2074 6865 2065 6e63 6f64 6572 206c 6179   the encoder lay
+00000620: 6572 7320 616e 6420 7468 6520 706f 6f6c  ers and the pool
+00000630: 6572 206c 6179 6572 2e0a 2020 2020 2020  er layer..      
+00000640: 2020 6e75 6d5f 6869 6464 656e 5f6c 6179    num_hidden_lay
+00000650: 6572 7320 2860 696e 7460 2c20 2a6f 7074  ers (`int`, *opt
+00000660: 696f 6e61 6c2a 2c20 6465 6661 756c 7473  ional*, defaults
+00000670: 2074 6f20 3132 293a 0a20 2020 2020 2020   to 12):.       
+00000680: 2020 2020 204e 756d 6265 7220 6f66 2068       Number of h
+00000690: 6964 6465 6e20 6c61 7965 7273 2069 6e20  idden layers in 
+000006a0: 7669 7375 616c 2065 6e63 6f64 6572 206d  visual encoder m
+000006b0: 6f64 656c 2e0a 2020 2020 2020 2020 7061  odel..        pa
+000006c0: 7463 685f 7369 7a65 2028 6069 6e74 602c  tch_size (`int`,
+000006d0: 202a 6f70 7469 6f6e 616c 2a2c 2064 6566   *optional*, def
+000006e0: 6175 6c74 7320 746f 2031 3629 3a0a 2020  aults to 16):.  
+000006f0: 2020 2020 2020 2020 2020 5468 6520 7369            The si
+00000700: 7a65 2028 7265 736f 6c75 7469 6f6e 2920  ze (resolution) 
+00000710: 6f66 2065 6163 6820 7061 7463 682e 0a20  of each patch.. 
+00000720: 2020 2020 2020 2069 6d61 6765 5f73 697a         image_siz
+00000730: 6520 2860 696e 7460 2c20 2a6f 7074 696f  e (`int`, *optio
+00000740: 6e61 6c2a 2c20 6465 6661 756c 7473 2074  nal*, defaults t
+00000750: 6f20 3238 3829 3a0a 2020 2020 2020 2020  o 288):.        
+00000760: 2020 2020 5468 6520 7369 7a65 2028 7265      The size (re
+00000770: 736f 6c75 7469 6f6e 2920 6f66 2065 6163  solution) of eac
+00000780: 6820 696d 6167 652e 0a20 2020 2020 2020  h image..       
+00000790: 2069 6e69 7469 616c 697a 6572 5f66 6163   initializer_fac
+000007a0: 746f 7220 2860 666c 6f61 7460 2c20 2a6f  tor (`float`, *o
+000007b0: 7074 696f 6e61 6c2a 2c20 6465 6661 756c  ptional*, defaul
+000007c0: 7473 2074 6f20 3129 3a0a 2020 2020 2020  ts to 1):.      
+000007d0: 2020 2020 2020 4120 6661 6374 6f72 2066        A factor f
+000007e0: 6f72 2069 6e69 7469 616c 697a 696e 6720  or initializing 
+000007f0: 616c 6c20 7765 6967 6874 206d 6174 7269  all weight matri
+00000800: 6365 7320 2873 686f 756c 6420 6265 206b  ces (should be k
+00000810: 6570 7420 746f 2031 2c20 7573 6564 2069  ept to 1, used i
+00000820: 6e74 6572 6e61 6c6c 7920 666f 7220 696e  nternally for in
+00000830: 6974 6961 6c69 7a61 7469 6f6e 0a20 2020  itialization.   
+00000840: 2020 2020 2020 2020 2074 6573 7469 6e67           testing
+00000850: 292e 0a20 2020 2020 2020 206c 6179 6572  )..        layer
+00000860: 5f6e 6f72 6d5f 6570 7320 2860 666c 6f61  _norm_eps (`floa
+00000870: 7460 2c20 2a6f 7074 696f 6e61 6c2a 2c20  t`, *optional*, 
+00000880: 6465 6661 756c 7473 2074 6f20 3165 2d30  defaults to 1e-0
+00000890: 3529 3a0a 2020 2020 2020 2020 2020 2020  5):.            
+000008a0: 5468 6520 6570 7369 6c6f 6e20 7573 6564  The epsilon used
+000008b0: 2062 7920 7468 6520 6c61 7965 7220 6e6f   by the layer no
+000008c0: 726d 616c 697a 6174 696f 6e20 6c61 7965  rmalization laye
+000008d0: 7273 2e0a 2020 2020 2020 2020 7374 6f70  rs..        stop
+000008e0: 5f67 7261 6469 656e 7420 2860 626f 6f6c  _gradient (`bool
+000008f0: 602c 202a 6f70 7469 6f6e 616c 2a2c 2064  `, *optional*, d
+00000900: 6566 6175 6c74 7320 746f 2060 4661 6c73  efaults to `Fals
+00000910: 6560 293a 0a20 2020 2020 2020 2020 2020  e`):.           
+00000920: 2057 6865 7468 6572 2074 6f20 7374 6f70   Whether to stop
+00000930: 2067 7261 6469 656e 7420 666f 7220 7472   gradient for tr
+00000940: 6169 6e69 6e67 2e0a 2020 2020 2020 2020  aining..        
+00000950: 7368 6172 655f 6c61 7965 726e 6f72 6d20  share_layernorm 
+00000960: 2860 626f 6f6c 602c 202a 6f70 7469 6f6e  (`bool`, *option
+00000970: 616c 2a2c 2064 6566 6175 6c74 7320 746f  al*, defaults to
+00000980: 2060 5472 7565 6029 3a0a 2020 2020 2020   `True`):.      
+00000990: 2020 2020 2020 5768 6574 6865 7220 4c61        Whether La
+000009a0: 7965 724e 6f72 6d20 6c61 7965 7273 2061  yerNorm layers a
+000009b0: 7265 2073 6861 7265 642e 0a20 2020 2020  re shared..     
+000009c0: 2020 2072 656d 6f76 655f 6c61 7374 5f6c     remove_last_l
+000009d0: 6179 6572 2028 6062 6f6f 6c60 2c20 2a6f  ayer (`bool`, *o
+000009e0: 7074 696f 6e61 6c2a 2c20 6465 6661 756c  ptional*, defaul
+000009f0: 7473 2074 6f20 6046 616c 7365 6029 3a0a  ts to `False`):.
+00000a00: 2020 2020 2020 2020 2020 2020 5768 6574              Whet
+00000a10: 6865 7220 746f 2072 656d 6f76 6520 7468  her to remove th
+00000a20: 6520 6c61 7374 206c 6179 6572 2066 726f  e last layer fro
+00000a30: 6d20 7468 6520 7669 7369 6f6e 2065 6e63  m the vision enc
+00000a40: 6f64 6572 2e0a 0a0a 2020 2020 4578 616d  oder....    Exam
+00000a50: 706c 653a 0a0a 2020 2020 6060 6070 7974  ple:..    ```pyt
+00000a60: 686f 6e0a 2020 2020 3e3e 3e20 6672 6f6d  hon.    >>> from
+00000a70: 2074 7261 6e73 666f 726d 6572 7320 696d   transformers im
+00000a80: 706f 7274 2042 7269 6467 6554 6f77 6572  port BridgeTower
+00000a90: 5669 7369 6f6e 436f 6e66 6967 0a0a 2020  VisionConfig..  
+00000aa0: 2020 3e3e 3e20 2320 496e 6974 6961 6c69    >>> # Initiali
+00000ab0: 7a69 6e67 2061 2042 7269 6467 6554 6f77  zing a BridgeTow
+00000ac0: 6572 2042 7269 6467 6554 6f77 6572 2f62  er BridgeTower/b
+00000ad0: 7269 6467 6574 6f77 6572 2d62 6173 6520  ridgetower-base 
+00000ae0: 7374 796c 6520 636f 6e66 6967 7572 6174  style configurat
+00000af0: 696f 6e20 666f 7220 7468 6520 7669 7369  ion for the visi
+00000b00: 6f6e 206d 6f64 656c 0a20 2020 203e 3e3e  on model.    >>>
+00000b10: 2063 6f6e 6669 6775 7261 7469 6f6e 203d   configuration =
+00000b20: 2042 7269 6467 6554 6f77 6572 5669 7369   BridgeTowerVisi
+00000b30: 6f6e 436f 6e66 6967 2829 0a0a 2020 2020  onConfig()..    
+00000b40: 3e3e 3e20 2320 4163 6365 7373 696e 6720  >>> # Accessing 
+00000b50: 7468 6520 636f 6e66 6967 7572 6174 696f  the configuratio
+00000b60: 6e0a 2020 2020 3e3e 3e20 636f 6e66 6967  n.    >>> config
+00000b70: 7572 6174 696f 6e0a 2020 2020 6060 6022  uration.    ```"
+00000b80: 2222 0a0a 2020 2020 6d6f 6465 6c5f 7479  ""..    model_ty
+00000b90: 7065 203d 2022 6272 6964 6765 746f 7765  pe = "bridgetowe
+00000ba0: 725f 7669 7369 6f6e 5f6d 6f64 656c 220a  r_vision_model".
+00000bb0: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+00000bc0: 5f28 0a20 2020 2020 2020 2073 656c 662c  _(.        self,
+00000bd0: 0a20 2020 2020 2020 2068 6964 6465 6e5f  .        hidden_
+00000be0: 7369 7a65 3d37 3638 2c0a 2020 2020 2020  size=768,.      
+00000bf0: 2020 6e75 6d5f 6869 6464 656e 5f6c 6179    num_hidden_lay
+00000c00: 6572 733d 3132 2c0a 2020 2020 2020 2020  ers=12,.        
+00000c10: 6e75 6d5f 6368 616e 6e65 6c73 3d33 2c0a  num_channels=3,.
+00000c20: 2020 2020 2020 2020 7061 7463 685f 7369          patch_si
+00000c30: 7a65 3d31 362c 0a20 2020 2020 2020 2069  ze=16,.        i
+00000c40: 6d61 6765 5f73 697a 653d 3238 382c 0a20  mage_size=288,. 
+00000c50: 2020 2020 2020 2069 6e69 7469 616c 697a         initializ
+00000c60: 6572 5f66 6163 746f 723d 312c 0a20 2020  er_factor=1,.   
+00000c70: 2020 2020 206c 6179 6572 5f6e 6f72 6d5f       layer_norm_
+00000c80: 6570 733d 3165 2d30 352c 0a20 2020 2020  eps=1e-05,.     
+00000c90: 2020 2073 746f 705f 6772 6164 6965 6e74     stop_gradient
+00000ca0: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
+00000cb0: 7368 6172 655f 6c61 7965 726e 6f72 6d3d  share_layernorm=
+00000cc0: 5472 7565 2c0a 2020 2020 2020 2020 7265  True,.        re
+00000cd0: 6d6f 7665 5f6c 6173 745f 6c61 7965 723d  move_last_layer=
+00000ce0: 4661 6c73 652c 0a20 2020 2020 2020 202a  False,.        *
+00000cf0: 2a6b 7761 7267 732c 0a20 2020 2029 3a0a  *kwargs,.    ):.
+00000d00: 2020 2020 2020 2020 7375 7065 7228 292e          super().
+00000d10: 5f5f 696e 6974 5f5f 282a 2a6b 7761 7267  __init__(**kwarg
+00000d20: 7329 0a20 2020 2020 2020 2073 656c 662e  s).        self.
+00000d30: 6869 6464 656e 5f73 697a 6520 3d20 6869  hidden_size = hi
+00000d40: 6464 656e 5f73 697a 650a 2020 2020 2020  dden_size.      
+00000d50: 2020 7365 6c66 2e6e 756d 5f68 6964 6465    self.num_hidde
+00000d60: 6e5f 6c61 7965 7273 203d 206e 756d 5f68  n_layers = num_h
+00000d70: 6964 6465 6e5f 6c61 7965 7273 0a20 2020  idden_layers.   
+00000d80: 2020 2020 2073 656c 662e 6e75 6d5f 6368       self.num_ch
+00000d90: 616e 6e65 6c73 203d 206e 756d 5f63 6861  annels = num_cha
+00000da0: 6e6e 656c 730a 2020 2020 2020 2020 7365  nnels.        se
+00000db0: 6c66 2e70 6174 6368 5f73 697a 6520 3d20  lf.patch_size = 
+00000dc0: 7061 7463 685f 7369 7a65 0a20 2020 2020  patch_size.     
+00000dd0: 2020 2073 656c 662e 696d 6167 655f 7369     self.image_si
+00000de0: 7a65 203d 2069 6d61 6765 5f73 697a 650a  ze = image_size.
+00000df0: 2020 2020 2020 2020 7365 6c66 2e69 6e69          self.ini
+00000e00: 7469 616c 697a 6572 5f66 6163 746f 7220  tializer_factor 
+00000e10: 3d20 696e 6974 6961 6c69 7a65 725f 6661  = initializer_fa
+00000e20: 6374 6f72 0a20 2020 2020 2020 2073 656c  ctor.        sel
+00000e30: 662e 6c61 7965 725f 6e6f 726d 5f65 7073  f.layer_norm_eps
+00000e40: 203d 206c 6179 6572 5f6e 6f72 6d5f 6570   = layer_norm_ep
+00000e50: 730a 2020 2020 2020 2020 7365 6c66 2e73  s.        self.s
+00000e60: 746f 705f 6772 6164 6965 6e74 203d 2073  top_gradient = s
+00000e70: 746f 705f 6772 6164 6965 6e74 0a20 2020  top_gradient.   
+00000e80: 2020 2020 2073 656c 662e 7368 6172 655f       self.share_
+00000e90: 6c61 7965 726e 6f72 6d20 3d20 7368 6172  layernorm = shar
+00000ea0: 655f 6c61 7965 726e 6f72 6d0a 2020 2020  e_layernorm.    
+00000eb0: 2020 2020 7365 6c66 2e72 656d 6f76 655f      self.remove_
+00000ec0: 6c61 7374 5f6c 6179 6572 203d 2072 656d  last_layer = rem
+00000ed0: 6f76 655f 6c61 7374 5f6c 6179 6572 0a0a  ove_last_layer..
+00000ee0: 2020 2020 4063 6c61 7373 6d65 7468 6f64      @classmethod
+00000ef0: 0a20 2020 2064 6566 2066 726f 6d5f 7072  .    def from_pr
+00000f00: 6574 7261 696e 6564 2863 6c73 2c20 7072  etrained(cls, pr
+00000f10: 6574 7261 696e 6564 5f6d 6f64 656c 5f6e  etrained_model_n
+00000f20: 616d 655f 6f72 5f70 6174 683a 2055 6e69  ame_or_path: Uni
+00000f30: 6f6e 5b73 7472 2c20 6f73 2e50 6174 684c  on[str, os.PathL
+00000f40: 696b 655d 2c20 2a2a 6b77 6172 6773 2920  ike], **kwargs) 
+00000f50: 2d3e 2022 5072 6574 7261 696e 6564 436f  -> "PretrainedCo
+00000f60: 6e66 6967 223a 0a20 2020 2020 2020 2063  nfig":.        c
+00000f70: 6f6e 6669 675f 6469 6374 2c20 6b77 6172  onfig_dict, kwar
+00000f80: 6773 203d 2063 6c73 2e67 6574 5f63 6f6e  gs = cls.get_con
+00000f90: 6669 675f 6469 6374 2870 7265 7472 6169  fig_dict(pretrai
+00000fa0: 6e65 645f 6d6f 6465 6c5f 6e61 6d65 5f6f  ned_model_name_o
+00000fb0: 725f 7061 7468 2c20 2a2a 6b77 6172 6773  r_path, **kwargs
+00000fc0: 290a 0a20 2020 2020 2020 2069 6620 636f  )..        if co
+00000fd0: 6e66 6967 5f64 6963 742e 6765 7428 226d  nfig_dict.get("m
+00000fe0: 6f64 656c 5f74 7970 6522 2920 3d3d 2022  odel_type") == "
+00000ff0: 6272 6964 6765 746f 7765 7222 3a0a 2020  bridgetower":.  
+00001000: 2020 2020 2020 2020 2020 636f 6e66 6967            config
+00001010: 5f64 6963 7420 3d20 636f 6e66 6967 5f64  _dict = config_d
+00001020: 6963 745b 2274 6578 745f 636f 6e66 6967  ict["text_config
+00001030: 225d 0a0a 2020 2020 2020 2020 6966 2022  "]..        if "
+00001040: 6d6f 6465 6c5f 7479 7065 2220 696e 2063  model_type" in c
+00001050: 6f6e 6669 675f 6469 6374 2061 6e64 2068  onfig_dict and h
+00001060: 6173 6174 7472 2863 6c73 2c20 226d 6f64  asattr(cls, "mod
+00001070: 656c 5f74 7970 6522 2920 616e 6420 636f  el_type") and co
+00001080: 6e66 6967 5f64 6963 745b 226d 6f64 656c  nfig_dict["model
+00001090: 5f74 7970 6522 5d20 213d 2063 6c73 2e6d  _type"] != cls.m
+000010a0: 6f64 656c 5f74 7970 653a 0a20 2020 2020  odel_type:.     
+000010b0: 2020 2020 2020 206c 6f67 6765 722e 7761         logger.wa
+000010c0: 726e 696e 6728 0a20 2020 2020 2020 2020  rning(.         
+000010d0: 2020 2020 2020 2066 2259 6f75 2061 7265         f"You are
+000010e0: 2075 7369 6e67 2061 206d 6f64 656c 206f   using a model o
+000010f0: 6620 7479 7065 207b 636f 6e66 6967 5f64  f type {config_d
+00001100: 6963 745b 276d 6f64 656c 5f74 7970 6527  ict['model_type'
+00001110: 5d7d 2074 6f20 696e 7374 616e 7469 6174  ]} to instantiat
+00001120: 6520 6120 6d6f 6465 6c20 6f66 2074 7970  e a model of typ
+00001130: 6520 220a 2020 2020 2020 2020 2020 2020  e ".            
+00001140: 2020 2020 6622 7b63 6c73 2e6d 6f64 656c      f"{cls.model
+00001150: 5f74 7970 657d 2e20 5468 6973 2069 7320  _type}. This is 
+00001160: 6e6f 7420 7375 7070 6f72 7465 6420 666f  not supported fo
+00001170: 7220 616c 6c20 636f 6e66 6967 7572 6174  r all configurat
+00001180: 696f 6e73 206f 6620 6d6f 6465 6c73 2061  ions of models a
+00001190: 6e64 2063 616e 2079 6965 6c64 2065 7272  nd can yield err
+000011a0: 6f72 732e 220a 2020 2020 2020 2020 2020  ors.".          
+000011b0: 2020 290a 0a20 2020 2020 2020 2072 6574    )..        ret
+000011c0: 7572 6e20 636c 732e 6672 6f6d 5f64 6963  urn cls.from_dic
+000011d0: 7428 636f 6e66 6967 5f64 6963 742c 202a  t(config_dict, *
+000011e0: 2a6b 7761 7267 7329 0a0a 0a63 6c61 7373  *kwargs)...class
+000011f0: 2042 7269 6467 6554 6f77 6572 5465 7874   BridgeTowerText
+00001200: 436f 6e66 6967 2850 7265 7472 6169 6e65  Config(Pretraine
+00001210: 6443 6f6e 6669 6729 3a0a 2020 2020 7222  dConfig):.    r"
+00001220: 2222 0a20 2020 2054 6869 7320 6973 2074  "".    This is t
+00001230: 6865 2063 6f6e 6669 6775 7261 7469 6f6e  he configuration
+00001240: 2063 6c61 7373 2074 6f20 7374 6f72 6520   class to store 
+00001250: 7468 6520 7465 7874 2063 6f6e 6669 6775  the text configu
+00001260: 7261 7469 6f6e 206f 6620 6120 5b60 4272  ration of a [`Br
+00001270: 6964 6765 546f 7765 724d 6f64 656c 605d  idgeTowerModel`]
+00001280: 2e20 5468 6520 6465 6661 756c 7420 7661  . The default va
+00001290: 6c75 6573 2068 6572 650a 2020 2020 6172  lues here.    ar
+000012a0: 6520 636f 7069 6564 2066 726f 6d20 526f  e copied from Ro
+000012b0: 4245 5254 612e 2049 6e73 7461 6e74 6961  BERTa. Instantia
+000012c0: 7469 6e67 2061 2063 6f6e 6669 6775 7261  ting a configura
+000012d0: 7469 6f6e 2077 6974 6820 7468 6520 6465  tion with the de
+000012e0: 6661 756c 7473 2077 696c 6c20 7969 656c  faults will yiel
+000012f0: 6420 6120 7369 6d69 6c61 7220 636f 6e66  d a similar conf
+00001300: 6967 7572 6174 696f 6e20 746f 2074 6861  iguration to tha
+00001310: 740a 2020 2020 6f66 2074 6865 2062 7269  t.    of the bri
+00001320: 6467 6574 6f77 6572 2d62 6173 6520 5b42  dgetower-base [B
+00001330: 7269 6465 6754 6f77 6572 2f62 7269 6467  ridegTower/bridg
+00001340: 6574 6f77 6572 2d62 6173 655d 2868 7474  etower-base](htt
+00001350: 7073 3a2f 2f68 7567 6769 6e67 6661 6365  ps://huggingface
+00001360: 2e63 6f2f 4272 6964 6765 546f 7765 722f  .co/BridgeTower/
+00001370: 6272 6964 6765 746f 7765 722d 6261 7365  bridgetower-base
+00001380: 2f29 0a20 2020 2061 7263 6869 7465 6374  /).    architect
+00001390: 7572 652e 0a0a 2020 2020 436f 6e66 6967  ure...    Config
+000013a0: 7572 6174 696f 6e20 6f62 6a65 6374 7320  uration objects 
+000013b0: 696e 6865 7269 7420 6672 6f6d 205b 6050  inherit from [`P
+000013c0: 7265 7472 6169 6e65 6443 6f6e 6669 6760  retrainedConfig`
+000013d0: 5d20 616e 6420 6361 6e20 6265 2075 7365  ] and can be use
+000013e0: 6420 746f 2063 6f6e 7472 6f6c 2074 6865  d to control the
+000013f0: 206d 6f64 656c 206f 7574 7075 7473 2e20   model outputs. 
+00001400: 5265 6164 2074 6865 0a20 2020 2064 6f63  Read the.    doc
+00001410: 756d 656e 7461 7469 6f6e 2066 726f 6d20  umentation from 
+00001420: 5b60 5072 6574 7261 696e 6564 436f 6e66  [`PretrainedConf
+00001430: 6967 605d 2066 6f72 206d 6f72 6520 696e  ig`] for more in
+00001440: 666f 726d 6174 696f 6e2e 0a0a 2020 2020  formation...    
+00001450: 4172 6773 3a0a 2020 2020 2020 2020 766f  Args:.        vo
+00001460: 6361 625f 7369 7a65 2028 6069 6e74 602c  cab_size (`int`,
+00001470: 202a 6f70 7469 6f6e 616c 2a2c 2064 6566   *optional*, def
+00001480: 6175 6c74 7320 746f 2035 3032 3635 293a  aults to 50265):
+00001490: 0a20 2020 2020 2020 2020 2020 2056 6f63  .            Voc
+000014a0: 6162 756c 6172 7920 7369 7a65 206f 6620  abulary size of 
+000014b0: 7468 6520 7465 7874 2070 6172 7420 6f66  the text part of
+000014c0: 2074 6865 206d 6f64 656c 2e20 4465 6669   the model. Defi
+000014d0: 6e65 7320 7468 6520 6e75 6d62 6572 206f  nes the number o
+000014e0: 6620 6469 6666 6572 656e 7420 746f 6b65  f different toke
+000014f0: 6e73 2074 6861 7420 6361 6e20 6265 0a20  ns that can be. 
+00001500: 2020 2020 2020 2020 2020 2072 6570 7265             repre
+00001510: 7365 6e74 6564 2062 7920 7468 6520 6069  sented by the `i
+00001520: 6e70 7574 735f 6964 7360 2070 6173 7365  nputs_ids` passe
+00001530: 6420 7768 656e 2063 616c 6c69 6e67 205b  d when calling [
+00001540: 6042 7269 6467 6554 6f77 6572 4d6f 6465  `BridgeTowerMode
+00001550: 6c60 5d2e 0a20 2020 2020 2020 2068 6964  l`]..        hid
+00001560: 6465 6e5f 7369 7a65 2028 6069 6e74 602c  den_size (`int`,
+00001570: 202a 6f70 7469 6f6e 616c 2a2c 2064 6566   *optional*, def
+00001580: 6175 6c74 7320 746f 2037 3638 293a 0a20  aults to 768):. 
+00001590: 2020 2020 2020 2020 2020 2044 696d 656e             Dimen
+000015a0: 7369 6f6e 616c 6974 7920 6f66 2074 6865  sionality of the
+000015b0: 2065 6e63 6f64 6572 206c 6179 6572 7320   encoder layers 
+000015c0: 616e 6420 7468 6520 706f 6f6c 6572 206c  and the pooler l
+000015d0: 6179 6572 2e0a 2020 2020 2020 2020 6e75  ayer..        nu
+000015e0: 6d5f 6869 6464 656e 5f6c 6179 6572 7320  m_hidden_layers 
+000015f0: 2860 696e 7460 2c20 2a6f 7074 696f 6e61  (`int`, *optiona
+00001600: 6c2a 2c20 6465 6661 756c 7473 2074 6f20  l*, defaults to 
+00001610: 3132 293a 0a20 2020 2020 2020 2020 2020  12):.           
+00001620: 204e 756d 6265 7220 6f66 2068 6964 6465   Number of hidde
+00001630: 6e20 6c61 7965 7273 2069 6e20 7468 6520  n layers in the 
+00001640: 5472 616e 7366 6f72 6d65 7220 656e 636f  Transformer enco
+00001650: 6465 722e 0a20 2020 2020 2020 206e 756d  der..        num
+00001660: 5f61 7474 656e 7469 6f6e 5f68 6561 6473  _attention_heads
+00001670: 2028 6069 6e74 602c 202a 6f70 7469 6f6e   (`int`, *option
+00001680: 616c 2a2c 2064 6566 6175 6c74 7320 746f  al*, defaults to
+00001690: 2031 3229 3a0a 2020 2020 2020 2020 2020   12):.          
+000016a0: 2020 4e75 6d62 6572 206f 6620 6174 7465    Number of atte
+000016b0: 6e74 696f 6e20 6865 6164 7320 666f 7220  ntion heads for 
+000016c0: 6561 6368 2061 7474 656e 7469 6f6e 206c  each attention l
+000016d0: 6179 6572 2069 6e20 7468 6520 5472 616e  ayer in the Tran
+000016e0: 7366 6f72 6d65 7220 656e 636f 6465 722e  sformer encoder.
+000016f0: 0a20 2020 2020 2020 2069 6e74 6572 6d65  .        interme
+00001700: 6469 6174 655f 7369 7a65 2028 6069 6e74  diate_size (`int
+00001710: 602c 202a 6f70 7469 6f6e 616c 2a2c 2064  `, *optional*, d
+00001720: 6566 6175 6c74 7320 746f 2033 3037 3229  efaults to 3072)
+00001730: 3a0a 2020 2020 2020 2020 2020 2020 4469  :.            Di
+00001740: 6d65 6e73 696f 6e61 6c69 7479 206f 6620  mensionality of 
+00001750: 7468 6520 2269 6e74 6572 6d65 6469 6174  the "intermediat
+00001760: 6522 2028 6f66 7465 6e20 6e61 6d65 6420  e" (often named 
+00001770: 6665 6564 2d66 6f72 7761 7264 2920 6c61  feed-forward) la
+00001780: 7965 7220 696e 2074 6865 2054 7261 6e73  yer in the Trans
+00001790: 666f 726d 6572 2065 6e63 6f64 6572 2e0a  former encoder..
+000017a0: 2020 2020 2020 2020 6869 6464 656e 5f61          hidden_a
+000017b0: 6374 2028 6073 7472 6020 6f72 2060 4361  ct (`str` or `Ca
+000017c0: 6c6c 6162 6c65 602c 202a 6f70 7469 6f6e  llable`, *option
+000017d0: 616c 2a2c 2064 6566 6175 6c74 7320 746f  al*, defaults to
+000017e0: 2060 2267 656c 7522 6029 3a0a 2020 2020   `"gelu"`):.    
+000017f0: 2020 2020 2020 2020 5468 6520 6e6f 6e2d          The non-
+00001800: 6c69 6e65 6172 2061 6374 6976 6174 696f  linear activatio
+00001810: 6e20 6675 6e63 7469 6f6e 2028 6675 6e63  n function (func
+00001820: 7469 6f6e 206f 7220 7374 7269 6e67 2920  tion or string) 
+00001830: 696e 2074 6865 2065 6e63 6f64 6572 2061  in the encoder a
+00001840: 6e64 2070 6f6f 6c65 722e 2049 6620 7374  nd pooler. If st
+00001850: 7269 6e67 2c20 6022 6765 6c75 2260 2c0a  ring, `"gelu"`,.
+00001860: 2020 2020 2020 2020 2020 2020 6022 7265              `"re
+00001870: 6c75 2260 2c20 6022 7369 6c75 2260 2061  lu"`, `"silu"` a
+00001880: 6e64 2060 2267 656c 755f 6e65 7722 6020  nd `"gelu_new"` 
+00001890: 6172 6520 7375 7070 6f72 7465 642e 0a20  are supported.. 
+000018a0: 2020 2020 2020 2068 6964 6465 6e5f 6472         hidden_dr
+000018b0: 6f70 6f75 745f 7072 6f62 2028 6066 6c6f  opout_prob (`flo
+000018c0: 6174 602c 202a 6f70 7469 6f6e 616c 2a2c  at`, *optional*,
+000018d0: 2064 6566 6175 6c74 7320 746f 2030 2e31   defaults to 0.1
+000018e0: 293a 0a20 2020 2020 2020 2020 2020 2054  ):.            T
+000018f0: 6865 2064 726f 706f 7574 2070 726f 6261  he dropout proba
+00001900: 6269 6c69 7479 2066 6f72 2061 6c6c 2066  bility for all f
+00001910: 756c 6c79 2063 6f6e 6e65 6374 6564 206c  ully connected l
+00001920: 6179 6572 7320 696e 2074 6865 2065 6d62  ayers in the emb
+00001930: 6564 6469 6e67 732c 2065 6e63 6f64 6572  eddings, encoder
+00001940: 2c20 616e 6420 706f 6f6c 6572 2e0a 2020  , and pooler..  
+00001950: 2020 2020 2020 6174 7465 6e74 696f 6e5f        attention_
+00001960: 7072 6f62 735f 6472 6f70 6f75 745f 7072  probs_dropout_pr
+00001970: 6f62 2028 6066 6c6f 6174 602c 202a 6f70  ob (`float`, *op
+00001980: 7469 6f6e 616c 2a2c 2064 6566 6175 6c74  tional*, default
+00001990: 7320 746f 2030 2e31 293a 0a20 2020 2020  s to 0.1):.     
+000019a0: 2020 2020 2020 2054 6865 2064 726f 706f         The dropo
+000019b0: 7574 2072 6174 696f 2066 6f72 2074 6865  ut ratio for the
+000019c0: 2061 7474 656e 7469 6f6e 2070 726f 6261   attention proba
+000019d0: 6269 6c69 7469 6573 2e0a 2020 2020 2020  bilities..      
+000019e0: 2020 6d61 785f 706f 7369 7469 6f6e 5f65    max_position_e
+000019f0: 6d62 6564 6469 6e67 7320 2860 696e 7460  mbeddings (`int`
+00001a00: 2c20 2a6f 7074 696f 6e61 6c2a 2c20 6465  , *optional*, de
+00001a10: 6661 756c 7473 2074 6f20 3531 3429 3a0a  faults to 514):.
+00001a20: 2020 2020 2020 2020 2020 2020 5468 6520              The 
+00001a30: 6d61 7869 6d75 6d20 7365 7175 656e 6365  maximum sequence
+00001a40: 206c 656e 6774 6820 7468 6174 2074 6869   length that thi
+00001a50: 7320 6d6f 6465 6c20 6d69 6768 7420 6576  s model might ev
+00001a60: 6572 2062 6520 7573 6564 2077 6974 682e  er be used with.
+00001a70: 2054 7970 6963 616c 6c79 2073 6574 2074   Typically set t
+00001a80: 6869 7320 746f 2073 6f6d 6574 6869 6e67  his to something
+00001a90: 206c 6172 6765 0a20 2020 2020 2020 2020   large.         
+00001aa0: 2020 206a 7573 7420 696e 2063 6173 6520     just in case 
+00001ab0: 2865 2e67 2e2c 2035 3132 206f 7220 3130  (e.g., 512 or 10
+00001ac0: 3234 206f 7220 3230 3438 292e 0a20 2020  24 or 2048)..   
+00001ad0: 2020 2020 2074 7970 655f 766f 6361 625f       type_vocab_
+00001ae0: 7369 7a65 2028 6069 6e74 602c 202a 6f70  size (`int`, *op
+00001af0: 7469 6f6e 616c 2a2c 2064 6566 6175 6c74  tional*, default
+00001b00: 7320 746f 2032 293a 0a20 2020 2020 2020  s to 2):.       
+00001b10: 2020 2020 2054 6865 2076 6f63 6162 756c       The vocabul
+00001b20: 6172 7920 7369 7a65 206f 6620 7468 6520  ary size of the 
+00001b30: 6074 6f6b 656e 5f74 7970 655f 6964 7360  `token_type_ids`
+00001b40: 2e0a 2020 2020 2020 2020 696e 6974 6961  ..        initia
+00001b50: 6c69 7a65 725f 6661 6374 6f72 2028 6066  lizer_factor (`f
+00001b60: 6c6f 6174 602c 202a 6f70 7469 6f6e 616c  loat`, *optional
+00001b70: 2a2c 2064 6566 6175 6c74 7320 746f 2031  *, defaults to 1
+00001b80: 293a 0a20 2020 2020 2020 2020 2020 2041  ):.            A
+00001b90: 2066 6163 746f 7220 666f 7220 696e 6974   factor for init
+00001ba0: 6961 6c69 7a69 6e67 2061 6c6c 2077 6569  ializing all wei
+00001bb0: 6768 7420 6d61 7472 6963 6573 2028 7368  ght matrices (sh
+00001bc0: 6f75 6c64 2062 6520 6b65 7074 2074 6f20  ould be kept to 
+00001bd0: 312c 2075 7365 6420 696e 7465 726e 616c  1, used internal
+00001be0: 6c79 2066 6f72 2069 6e69 7469 616c 697a  ly for initializ
+00001bf0: 6174 696f 6e0a 2020 2020 2020 2020 2020  ation.          
+00001c00: 2020 7465 7374 696e 6729 2e0a 2020 2020    testing)..    
+00001c10: 2020 2020 6c61 7965 725f 6e6f 726d 5f65      layer_norm_e
+00001c20: 7073 2028 6066 6c6f 6174 602c 202a 6f70  ps (`float`, *op
+00001c30: 7469 6f6e 616c 2a2c 2064 6566 6175 6c74  tional*, default
+00001c40: 7320 746f 2031 652d 3035 293a 0a20 2020  s to 1e-05):.   
+00001c50: 2020 2020 2020 2020 2054 6865 2065 7073           The eps
+00001c60: 696c 6f6e 2075 7365 6420 6279 2074 6865  ilon used by the
+00001c70: 206c 6179 6572 206e 6f72 6d61 6c69 7a61   layer normaliza
+00001c80: 7469 6f6e 206c 6179 6572 732e 0a20 2020  tion layers..   
+00001c90: 2020 2020 2070 6f73 6974 696f 6e5f 656d       position_em
+00001ca0: 6265 6464 696e 675f 7479 7065 2028 6073  bedding_type (`s
+00001cb0: 7472 602c 202a 6f70 7469 6f6e 616c 2a2c  tr`, *optional*,
+00001cc0: 2064 6566 6175 6c74 7320 746f 2060 2261   defaults to `"a
+00001cd0: 6273 6f6c 7574 6522 6029 3a0a 2020 2020  bsolute"`):.    
+00001ce0: 2020 2020 2020 2020 5479 7065 206f 6620          Type of 
+00001cf0: 706f 7369 7469 6f6e 2065 6d62 6564 6469  position embeddi
+00001d00: 6e67 2e20 4368 6f6f 7365 206f 6e65 206f  ng. Choose one o
+00001d10: 6620 6022 6162 736f 6c75 7465 2260 2c20  f `"absolute"`, 
+00001d20: 6022 7265 6c61 7469 7665 5f6b 6579 2260  `"relative_key"`
+00001d30: 2c20 6022 7265 6c61 7469 7665 5f6b 6579  , `"relative_key
+00001d40: 5f71 7565 7279 2260 2e20 466f 720a 2020  _query"`. For.  
+00001d50: 2020 2020 2020 2020 2020 706f 7369 7469            positi
+00001d60: 6f6e 616c 2065 6d62 6564 6469 6e67 7320  onal embeddings 
+00001d70: 7573 6520 6022 6162 736f 6c75 7465 2260  use `"absolute"`
+00001d80: 2e20 466f 7220 6d6f 7265 2069 6e66 6f72  . For more infor
+00001d90: 6d61 7469 6f6e 206f 6e20 6022 7265 6c61  mation on `"rela
+00001da0: 7469 7665 5f6b 6579 2260 2c20 706c 6561  tive_key"`, plea
+00001db0: 7365 2072 6566 6572 2074 6f0a 2020 2020  se refer to.    
+00001dc0: 2020 2020 2020 2020 5b53 656c 662d 4174          [Self-At
+00001dd0: 7465 6e74 696f 6e20 7769 7468 2052 656c  tention with Rel
+00001de0: 6174 6976 6520 506f 7369 7469 6f6e 2052  ative Position R
+00001df0: 6570 7265 7365 6e74 6174 696f 6e73 2028  epresentations (
+00001e00: 5368 6177 2065 7420 616c 2e29 5d28 6874  Shaw et al.)](ht
+00001e10: 7470 733a 2f2f 6172 7869 762e 6f72 672f  tps://arxiv.org/
+00001e20: 6162 732f 3138 3033 2e30 3231 3535 292e  abs/1803.02155).
+00001e30: 0a20 2020 2020 2020 2020 2020 2046 6f72  .            For
+00001e40: 206d 6f72 6520 696e 666f 726d 6174 696f   more informatio
+00001e50: 6e20 6f6e 2060 2272 656c 6174 6976 655f  n on `"relative_
+00001e60: 6b65 795f 7175 6572 7922 602c 2070 6c65  key_query"`, ple
+00001e70: 6173 6520 7265 6665 7220 746f 202a 4d65  ase refer to *Me
+00001e80: 7468 6f64 2034 2a20 696e 205b 496d 7072  thod 4* in [Impr
+00001e90: 6f76 6520 5472 616e 7366 6f72 6d65 7220  ove Transformer 
+00001ea0: 4d6f 6465 6c73 0a20 2020 2020 2020 2020  Models.         
+00001eb0: 2020 2077 6974 6820 4265 7474 6572 2052     with Better R
+00001ec0: 656c 6174 6976 6520 506f 7369 7469 6f6e  elative Position
+00001ed0: 2045 6d62 6564 6469 6e67 7320 2848 7561   Embeddings (Hua
+00001ee0: 6e67 2065 7420 616c 2e29 5d28 6874 7470  ng et al.)](http
+00001ef0: 733a 2f2f 6172 7869 762e 6f72 672f 6162  s://arxiv.org/ab
+00001f00: 732f 3230 3039 2e31 3336 3538 292e 0a20  s/2009.13658).. 
+00001f10: 2020 2020 2020 2069 735f 6465 636f 6465         is_decode
+00001f20: 7220 2860 626f 6f6c 602c 202a 6f70 7469  r (`bool`, *opti
+00001f30: 6f6e 616c 2a2c 2064 6566 6175 6c74 7320  onal*, defaults 
+00001f40: 746f 2060 4661 6c73 6560 293a 0a20 2020  to `False`):.   
+00001f50: 2020 2020 2020 2020 2057 6865 7468 6572           Whether
+00001f60: 2074 6865 206d 6f64 656c 2069 7320 7573   the model is us
+00001f70: 6564 2061 7320 6120 6465 636f 6465 7220  ed as a decoder 
+00001f80: 6f72 206e 6f74 2e20 4966 2060 4661 6c73  or not. If `Fals
+00001f90: 6560 2c20 7468 6520 6d6f 6465 6c20 6973  e`, the model is
+00001fa0: 2075 7365 6420 6173 2061 6e20 656e 636f   used as an enco
+00001fb0: 6465 722e 0a20 2020 2020 2020 2075 7365  der..        use
+00001fc0: 5f63 6163 6865 2028 6062 6f6f 6c60 2c20  _cache (`bool`, 
+00001fd0: 2a6f 7074 696f 6e61 6c2a 2c20 6465 6661  *optional*, defa
+00001fe0: 756c 7473 2074 6f20 6054 7275 6560 293a  ults to `True`):
+00001ff0: 0a20 2020 2020 2020 2020 2020 2057 6865  .            Whe
+00002000: 7468 6572 206f 7220 6e6f 7420 7468 6520  ther or not the 
+00002010: 6d6f 6465 6c20 7368 6f75 6c64 2072 6574  model should ret
+00002020: 7572 6e20 7468 6520 6c61 7374 206b 6579  urn the last key
+00002030: 2f76 616c 7565 7320 6174 7465 6e74 696f  /values attentio
+00002040: 6e73 2028 6e6f 7420 7573 6564 2062 7920  ns (not used by 
+00002050: 616c 6c20 6d6f 6465 6c73 292e 204f 6e6c  all models). Onl
+00002060: 790a 2020 2020 2020 2020 2020 2020 7265  y.            re
+00002070: 6c65 7661 6e74 2069 6620 6063 6f6e 6669  levant if `confi
+00002080: 672e 6973 5f64 6563 6f64 6572 3d54 7275  g.is_decoder=Tru
+00002090: 6560 2e0a 0a20 2020 2045 7861 6d70 6c65  e`...    Example
+000020a0: 3a0a 0a20 2020 2060 6060 7079 7468 6f6e  :..    ```python
+000020b0: 0a20 2020 203e 3e3e 2066 726f 6d20 7472  .    >>> from tr
+000020c0: 616e 7366 6f72 6d65 7273 2069 6d70 6f72  ansformers impor
+000020d0: 7420 4272 6964 6765 546f 7765 7254 6578  t BridgeTowerTex
+000020e0: 7443 6f6e 6669 670a 0a20 2020 203e 3e3e  tConfig..    >>>
+000020f0: 2023 2049 6e69 7469 616c 697a 696e 6720   # Initializing 
+00002100: 6120 4272 6964 6765 546f 7765 7220 4272  a BridgeTower Br
+00002110: 6964 6765 546f 7765 722f 6272 6964 6765  idgeTower/bridge
+00002120: 746f 7765 722d 6261 7365 2073 7479 6c65  tower-base style
+00002130: 2063 6f6e 6669 6775 7261 7469 6f6e 2066   configuration f
+00002140: 6f72 2074 6865 2074 6578 7420 6d6f 6465  or the text mode
+00002150: 6c0a 2020 2020 3e3e 3e20 636f 6e66 6967  l.    >>> config
+00002160: 7572 6174 696f 6e20 3d20 4272 6964 6765  uration = Bridge
+00002170: 546f 7765 7254 6578 7443 6f6e 6669 6728  TowerTextConfig(
+00002180: 290a 0a20 2020 203e 3e3e 2023 2041 6363  )..    >>> # Acc
+00002190: 6573 7369 6e67 2074 6865 2063 6f6e 6669  essing the confi
+000021a0: 6775 7261 7469 6f6e 0a20 2020 203e 3e3e  guration.    >>>
+000021b0: 2063 6f6e 6669 6775 7261 7469 6f6e 0a20   configuration. 
+000021c0: 2020 2060 6060 2222 220a 0a20 2020 206d     ```"""..    m
+000021d0: 6f64 656c 5f74 7970 6520 3d20 2262 7269  odel_type = "bri
+000021e0: 6467 6574 6f77 6572 5f74 6578 745f 6d6f  dgetower_text_mo
+000021f0: 6465 6c22 0a0a 2020 2020 6465 6620 5f5f  del"..    def __
+00002200: 696e 6974 5f5f 280a 2020 2020 2020 2020  init__(.        
+00002210: 7365 6c66 2c0a 2020 2020 2020 2020 766f  self,.        vo
+00002220: 6361 625f 7369 7a65 3d35 3032 3635 2c0a  cab_size=50265,.
+00002230: 2020 2020 2020 2020 6869 6464 656e 5f73          hidden_s
+00002240: 697a 653d 3736 382c 0a20 2020 2020 2020  ize=768,.       
+00002250: 206e 756d 5f68 6964 6465 6e5f 6c61 7965   num_hidden_laye
+00002260: 7273 3d31 322c 0a20 2020 2020 2020 206e  rs=12,.        n
+00002270: 756d 5f61 7474 656e 7469 6f6e 5f68 6561  um_attention_hea
+00002280: 6473 3d31 322c 0a20 2020 2020 2020 2069  ds=12,.        i
+00002290: 6e69 7469 616c 697a 6572 5f66 6163 746f  nitializer_facto
+000022a0: 723d 312c 0a20 2020 2020 2020 2069 6e74  r=1,.        int
+000022b0: 6572 6d65 6469 6174 655f 7369 7a65 3d33  ermediate_size=3
+000022c0: 3037 322c 0a20 2020 2020 2020 2068 6964  072,.        hid
+000022d0: 6465 6e5f 6163 743d 2267 656c 7522 2c0a  den_act="gelu",.
+000022e0: 2020 2020 2020 2020 6869 6464 656e 5f64          hidden_d
+000022f0: 726f 706f 7574 5f70 726f 623d 302e 312c  ropout_prob=0.1,
+00002300: 0a20 2020 2020 2020 2061 7474 656e 7469  .        attenti
+00002310: 6f6e 5f70 726f 6273 5f64 726f 706f 7574  on_probs_dropout
+00002320: 5f70 726f 623d 302e 312c 0a20 2020 2020  _prob=0.1,.     
+00002330: 2020 206d 6178 5f70 6f73 6974 696f 6e5f     max_position_
+00002340: 656d 6265 6464 696e 6773 3d35 3134 2c0a  embeddings=514,.
+00002350: 2020 2020 2020 2020 7479 7065 5f76 6f63          type_voc
+00002360: 6162 5f73 697a 653d 312c 0a20 2020 2020  ab_size=1,.     
+00002370: 2020 206c 6179 6572 5f6e 6f72 6d5f 6570     layer_norm_ep
+00002380: 733d 3165 2d30 352c 0a20 2020 2020 2020  s=1e-05,.       
+00002390: 2070 6164 5f74 6f6b 656e 5f69 643d 312c   pad_token_id=1,
+000023a0: 0a20 2020 2020 2020 2062 6f73 5f74 6f6b  .        bos_tok
+000023b0: 656e 5f69 643d 302c 0a20 2020 2020 2020  en_id=0,.       
+000023c0: 2065 6f73 5f74 6f6b 656e 5f69 643d 322c   eos_token_id=2,
+000023d0: 0a20 2020 2020 2020 2070 6f73 6974 696f  .        positio
+000023e0: 6e5f 656d 6265 6464 696e 675f 7479 7065  n_embedding_type
+000023f0: 3d22 6162 736f 6c75 7465 222c 0a20 2020  ="absolute",.   
+00002400: 2020 2020 2075 7365 5f63 6163 6865 3d54       use_cache=T
+00002410: 7275 652c 0a20 2020 2020 2020 202a 2a6b  rue,.        **k
+00002420: 7761 7267 732c 0a20 2020 2029 3a0a 2020  wargs,.    ):.  
+00002430: 2020 2020 2020 7375 7065 7228 292e 5f5f        super().__
+00002440: 696e 6974 5f5f 282a 2a6b 7761 7267 7329  init__(**kwargs)
+00002450: 0a0a 2020 2020 2020 2020 7365 6c66 2e76  ..        self.v
+00002460: 6f63 6162 5f73 697a 6520 3d20 766f 6361  ocab_size = voca
+00002470: 625f 7369 7a65 0a20 2020 2020 2020 2073  b_size.        s
+00002480: 656c 662e 6869 6464 656e 5f73 697a 6520  elf.hidden_size 
+00002490: 3d20 6869 6464 656e 5f73 697a 650a 2020  = hidden_size.  
+000024a0: 2020 2020 2020 7365 6c66 2e6e 756d 5f68        self.num_h
+000024b0: 6964 6465 6e5f 6c61 7965 7273 203d 206e  idden_layers = n
+000024c0: 756d 5f68 6964 6465 6e5f 6c61 7965 7273  um_hidden_layers
+000024d0: 0a20 2020 2020 2020 2073 656c 662e 6e75  .        self.nu
+000024e0: 6d5f 6174 7465 6e74 696f 6e5f 6865 6164  m_attention_head
+000024f0: 7320 3d20 6e75 6d5f 6174 7465 6e74 696f  s = num_attentio
+00002500: 6e5f 6865 6164 730a 2020 2020 2020 2020  n_heads.        
+00002510: 7365 6c66 2e68 6964 6465 6e5f 6163 7420  self.hidden_act 
+00002520: 3d20 6869 6464 656e 5f61 6374 0a20 2020  = hidden_act.   
+00002530: 2020 2020 2073 656c 662e 696e 6974 6961       self.initia
+00002540: 6c69 7a65 725f 6661 6374 6f72 203d 2069  lizer_factor = i
+00002550: 6e69 7469 616c 697a 6572 5f66 6163 746f  nitializer_facto
+00002560: 720a 2020 2020 2020 2020 7365 6c66 2e69  r.        self.i
+00002570: 6e74 6572 6d65 6469 6174 655f 7369 7a65  ntermediate_size
+00002580: 203d 2069 6e74 6572 6d65 6469 6174 655f   = intermediate_
+00002590: 7369 7a65 0a20 2020 2020 2020 2073 656c  size.        sel
+000025a0: 662e 6869 6464 656e 5f64 726f 706f 7574  f.hidden_dropout
+000025b0: 5f70 726f 6220 3d20 6869 6464 656e 5f64  _prob = hidden_d
+000025c0: 726f 706f 7574 5f70 726f 620a 2020 2020  ropout_prob.    
+000025d0: 2020 2020 7365 6c66 2e61 7474 656e 7469      self.attenti
+000025e0: 6f6e 5f70 726f 6273 5f64 726f 706f 7574  on_probs_dropout
+000025f0: 5f70 726f 6220 3d20 6174 7465 6e74 696f  _prob = attentio
+00002600: 6e5f 7072 6f62 735f 6472 6f70 6f75 745f  n_probs_dropout_
+00002610: 7072 6f62 0a20 2020 2020 2020 2073 656c  prob.        sel
+00002620: 662e 6d61 785f 706f 7369 7469 6f6e 5f65  f.max_position_e
+00002630: 6d62 6564 6469 6e67 7320 3d20 6d61 785f  mbeddings = max_
+00002640: 706f 7369 7469 6f6e 5f65 6d62 6564 6469  position_embeddi
+00002650: 6e67 730a 2020 2020 2020 2020 7365 6c66  ngs.        self
+00002660: 2e74 7970 655f 766f 6361 625f 7369 7a65  .type_vocab_size
+00002670: 203d 2074 7970 655f 766f 6361 625f 7369   = type_vocab_si
+00002680: 7a65 0a20 2020 2020 2020 2073 656c 662e  ze.        self.
+00002690: 6c61 7965 725f 6e6f 726d 5f65 7073 203d  layer_norm_eps =
+000026a0: 206c 6179 6572 5f6e 6f72 6d5f 6570 730a   layer_norm_eps.
+000026b0: 2020 2020 2020 2020 7365 6c66 2e70 6f73          self.pos
+000026c0: 6974 696f 6e5f 656d 6265 6464 696e 675f  ition_embedding_
+000026d0: 7479 7065 203d 2070 6f73 6974 696f 6e5f  type = position_
+000026e0: 656d 6265 6464 696e 675f 7479 7065 0a20  embedding_type. 
+000026f0: 2020 2020 2020 2073 656c 662e 7573 655f         self.use_
+00002700: 6361 6368 6520 3d20 7573 655f 6361 6368  cache = use_cach
+00002710: 650a 2020 2020 2020 2020 7365 6c66 2e70  e.        self.p
+00002720: 6164 5f74 6f6b 656e 5f69 6420 3d20 7061  ad_token_id = pa
+00002730: 645f 746f 6b65 6e5f 6964 0a20 2020 2020  d_token_id.     
+00002740: 2020 2073 656c 662e 626f 735f 746f 6b65     self.bos_toke
+00002750: 6e5f 6964 203d 2062 6f73 5f74 6f6b 656e  n_id = bos_token
+00002760: 5f69 640a 2020 2020 2020 2020 7365 6c66  _id.        self
+00002770: 2e65 6f73 5f74 6f6b 656e 5f69 6420 3d20  .eos_token_id = 
+00002780: 656f 735f 746f 6b65 6e5f 6964 0a0a 2020  eos_token_id..  
+00002790: 2020 4063 6c61 7373 6d65 7468 6f64 0a20    @classmethod. 
+000027a0: 2020 2064 6566 2066 726f 6d5f 7072 6574     def from_pret
+000027b0: 7261 696e 6564 2863 6c73 2c20 7072 6574  rained(cls, pret
+000027c0: 7261 696e 6564 5f6d 6f64 656c 5f6e 616d  rained_model_nam
+000027d0: 655f 6f72 5f70 6174 683a 2055 6e69 6f6e  e_or_path: Union
+000027e0: 5b73 7472 2c20 6f73 2e50 6174 684c 696b  [str, os.PathLik
+000027f0: 655d 2c20 2a2a 6b77 6172 6773 2920 2d3e  e], **kwargs) ->
+00002800: 2022 5072 6574 7261 696e 6564 436f 6e66   "PretrainedConf
+00002810: 6967 223a 0a20 2020 2020 2020 2063 6f6e  ig":.        con
+00002820: 6669 675f 6469 6374 2c20 6b77 6172 6773  fig_dict, kwargs
+00002830: 203d 2063 6c73 2e67 6574 5f63 6f6e 6669   = cls.get_confi
+00002840: 675f 6469 6374 2870 7265 7472 6169 6e65  g_dict(pretraine
+00002850: 645f 6d6f 6465 6c5f 6e61 6d65 5f6f 725f  d_model_name_or_
+00002860: 7061 7468 2c20 2a2a 6b77 6172 6773 290a  path, **kwargs).
+00002870: 0a20 2020 2020 2020 2069 6620 636f 6e66  .        if conf
+00002880: 6967 5f64 6963 742e 6765 7428 226d 6f64  ig_dict.get("mod
+00002890: 656c 5f74 7970 6522 2920 3d3d 2022 6272  el_type") == "br
+000028a0: 6964 6765 746f 7765 7222 3a0a 2020 2020  idgetower":.    
+000028b0: 2020 2020 2020 2020 636f 6e66 6967 5f64          config_d
+000028c0: 6963 7420 3d20 636f 6e66 6967 5f64 6963  ict = config_dic
+000028d0: 745b 2274 6578 745f 636f 6e66 6967 225d  t["text_config"]
+000028e0: 0a0a 2020 2020 2020 2020 6966 2022 6d6f  ..        if "mo
+000028f0: 6465 6c5f 7479 7065 2220 696e 2063 6f6e  del_type" in con
+00002900: 6669 675f 6469 6374 2061 6e64 2068 6173  fig_dict and has
+00002910: 6174 7472 2863 6c73 2c20 226d 6f64 656c  attr(cls, "model
+00002920: 5f74 7970 6522 2920 616e 6420 636f 6e66  _type") and conf
+00002930: 6967 5f64 6963 745b 226d 6f64 656c 5f74  ig_dict["model_t
+00002940: 7970 6522 5d20 213d 2063 6c73 2e6d 6f64  ype"] != cls.mod
+00002950: 656c 5f74 7970 653a 0a20 2020 2020 2020  el_type:.       
+00002960: 2020 2020 206c 6f67 6765 722e 7761 726e       logger.warn
+00002970: 696e 6728 0a20 2020 2020 2020 2020 2020  ing(.           
+00002980: 2020 2020 2066 2259 6f75 2061 7265 2075       f"You are u
+00002990: 7369 6e67 2061 206d 6f64 656c 206f 6620  sing a model of 
+000029a0: 7479 7065 207b 636f 6e66 6967 5f64 6963  type {config_dic
+000029b0: 745b 276d 6f64 656c 5f74 7970 6527 5d7d  t['model_type']}
+000029c0: 2074 6f20 696e 7374 616e 7469 6174 6520   to instantiate 
+000029d0: 6120 6d6f 6465 6c20 6f66 2074 7970 6520  a model of type 
+000029e0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+000029f0: 2020 6622 7b63 6c73 2e6d 6f64 656c 5f74    f"{cls.model_t
+00002a00: 7970 657d 2e20 5468 6973 2069 7320 6e6f  ype}. This is no
+00002a10: 7420 7375 7070 6f72 7465 6420 666f 7220  t supported for 
+00002a20: 616c 6c20 636f 6e66 6967 7572 6174 696f  all configuratio
+00002a30: 6e73 206f 6620 6d6f 6465 6c73 2061 6e64  ns of models and
+00002a40: 2063 616e 2079 6965 6c64 2065 7272 6f72   can yield error
+00002a50: 732e 220a 2020 2020 2020 2020 2020 2020  s.".            
+00002a60: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+00002a70: 6e20 636c 732e 6672 6f6d 5f64 6963 7428  n cls.from_dict(
+00002a80: 636f 6e66 6967 5f64 6963 742c 202a 2a6b  config_dict, **k
+00002a90: 7761 7267 7329 0a0a 0a63 6c61 7373 2042  wargs)...class B
+00002aa0: 7269 6467 6554 6f77 6572 436f 6e66 6967  ridgeTowerConfig
+00002ab0: 2850 7265 7472 6169 6e65 6443 6f6e 6669  (PretrainedConfi
+00002ac0: 6729 3a0a 2020 2020 7222 2222 0a20 2020  g):.    r""".   
+00002ad0: 2054 6869 7320 6973 2074 6865 2063 6f6e   This is the con
+00002ae0: 6669 6775 7261 7469 6f6e 2063 6c61 7373  figuration class
+00002af0: 2074 6f20 7374 6f72 6520 7468 6520 636f   to store the co
+00002b00: 6e66 6967 7572 6174 696f 6e20 6f66 2061  nfiguration of a
+00002b10: 205b 6042 7269 6467 6554 6f77 6572 4d6f   [`BridgeTowerMo
+00002b20: 6465 6c60 5d2e 2049 7420 6973 2075 7365  del`]. It is use
+00002b30: 6420 746f 2069 6e73 7461 6e74 6961 7465  d to instantiate
+00002b40: 2061 0a20 2020 2042 7269 6467 6554 6f77   a.    BridgeTow
+00002b50: 6572 206d 6f64 656c 2061 6363 6f72 6469  er model accordi
+00002b60: 6e67 2074 6f20 7468 6520 7370 6563 6966  ng to the specif
+00002b70: 6965 6420 6172 6775 6d65 6e74 732c 2064  ied arguments, d
+00002b80: 6566 696e 696e 6720 7468 6520 6d6f 6465  efining the mode
+00002b90: 6c20 6172 6368 6974 6563 7475 7265 2e20  l architecture. 
+00002ba0: 496e 7374 616e 7469 6174 696e 6720 610a  Instantiating a.
+00002bb0: 2020 2020 636f 6e66 6967 7572 6174 696f      configuratio
+00002bc0: 6e20 7769 7468 2074 6865 2064 6566 6175  n with the defau
+00002bd0: 6c74 7320 7769 6c6c 2079 6965 6c64 2061  lts will yield a
+00002be0: 2073 696d 696c 6172 2063 6f6e 6669 6775   similar configu
+00002bf0: 7261 7469 6f6e 2074 6f20 7468 6174 206f  ration to that o
+00002c00: 6620 7468 6520 6272 6964 6765 746f 7765  f the bridgetowe
+00002c10: 722d 6261 7365 0a20 2020 205b 4272 6964  r-base.    [Brid
+00002c20: 6765 546f 7765 722f 6272 6964 6765 746f  geTower/bridgeto
+00002c30: 7765 722d 6261 7365 5d28 6874 7470 733a  wer-base](https:
+00002c40: 2f2f 6875 6767 696e 6766 6163 652e 636f  //huggingface.co
+00002c50: 2f42 7269 6467 6554 6f77 6572 2f62 7269  /BridgeTower/bri
+00002c60: 6467 6574 6f77 6572 2d62 6173 652f 2920  dgetower-base/) 
+00002c70: 6172 6368 6974 6563 7475 7265 2e0a 0a20  architecture... 
+00002c80: 2020 2043 6f6e 6669 6775 7261 7469 6f6e     Configuration
+00002c90: 206f 626a 6563 7473 2069 6e68 6572 6974   objects inherit
+00002ca0: 2066 726f 6d20 5b60 5072 6574 7261 696e   from [`Pretrain
+00002cb0: 6564 436f 6e66 6967 605d 2061 6e64 2063  edConfig`] and c
+00002cc0: 616e 2062 6520 7573 6564 2074 6f20 636f  an be used to co
+00002cd0: 6e74 726f 6c20 7468 6520 6d6f 6465 6c20  ntrol the model 
+00002ce0: 6f75 7470 7574 732e 2052 6561 6420 7468  outputs. Read th
+00002cf0: 650a 2020 2020 646f 6375 6d65 6e74 6174  e.    documentat
+00002d00: 696f 6e20 6672 6f6d 205b 6050 7265 7472  ion from [`Pretr
+00002d10: 6169 6e65 6443 6f6e 6669 6760 5d20 666f  ainedConfig`] fo
+00002d20: 7220 6d6f 7265 2069 6e66 6f72 6d61 7469  r more informati
+00002d30: 6f6e 2e0a 0a20 2020 2041 7267 733a 0a20  on...    Args:. 
+00002d40: 2020 2020 2020 2073 6861 7265 5f63 726f         share_cro
+00002d50: 7373 5f6d 6f64 616c 5f74 7261 6e73 666f  ss_modal_transfo
+00002d60: 726d 6572 5f6c 6179 6572 7320 2860 626f  rmer_layers (`bo
+00002d70: 6f6c 602c 202a 6f70 7469 6f6e 616c 2a2c  ol`, *optional*,
+00002d80: 2064 6566 6175 6c74 7320 746f 2060 5472   defaults to `Tr
+00002d90: 7565 6029 3a0a 2020 2020 2020 2020 2020  ue`):.          
+00002da0: 2020 5768 6574 6865 7220 6372 6f73 7320    Whether cross 
+00002db0: 6d6f 6461 6c20 7472 616e 7366 6f72 6d65  modal transforme
+00002dc0: 7220 6c61 7965 7273 2061 7265 2073 6861  r layers are sha
+00002dd0: 7265 642e 0a20 2020 2020 2020 2068 6964  red..        hid
+00002de0: 6465 6e5f 6163 7420 2860 7374 7260 206f  den_act (`str` o
+00002df0: 7220 6066 756e 6374 696f 6e60 2c20 2a6f  r `function`, *o
+00002e00: 7074 696f 6e61 6c2a 2c20 6465 6661 756c  ptional*, defaul
+00002e10: 7473 2074 6f20 6022 6765 6c75 2260 293a  ts to `"gelu"`):
+00002e20: 0a20 2020 2020 2020 2020 2020 2054 6865  .            The
+00002e30: 206e 6f6e 2d6c 696e 6561 7220 6163 7469   non-linear acti
+00002e40: 7661 7469 6f6e 2066 756e 6374 696f 6e20  vation function 
+00002e50: 2866 756e 6374 696f 6e20 6f72 2073 7472  (function or str
+00002e60: 696e 6729 2069 6e20 7468 6520 656e 636f  ing) in the enco
+00002e70: 6465 7220 616e 6420 706f 6f6c 6572 2e0a  der and pooler..
+00002e80: 2020 2020 2020 2020 6869 6464 656e 5f73          hidden_s
+00002e90: 697a 6520 2860 696e 7460 2c20 2a6f 7074  ize (`int`, *opt
+00002ea0: 696f 6e61 6c2a 2c20 6465 6661 756c 7473  ional*, defaults
+00002eb0: 2074 6f20 3736 3829 3a0a 2020 2020 2020   to 768):.      
+00002ec0: 2020 2020 2020 4469 6d65 6e73 696f 6e61        Dimensiona
+00002ed0: 6c69 7479 206f 6620 7468 6520 656e 636f  lity of the enco
+00002ee0: 6465 7220 6c61 7965 7273 2061 6e64 2074  der layers and t
+00002ef0: 6865 2070 6f6f 6c65 7220 6c61 7965 722e  he pooler layer.
+00002f00: 0a20 2020 2020 2020 2069 6e69 7469 616c  .        initial
+00002f10: 697a 6572 5f66 6163 746f 7220 2860 666c  izer_factor (`fl
+00002f20: 6f61 7460 2c20 2a6f 7074 696f 6e61 6c2a  oat`, *optional*
+00002f30: 2c20 6465 6661 756c 7473 2074 6f20 3129  , defaults to 1)
+00002f40: 3a0a 2020 2020 2020 2020 2020 2020 4120  :.            A 
+00002f50: 6661 6374 6f72 2066 6f72 2069 6e69 7469  factor for initi
+00002f60: 616c 697a 696e 6720 616c 6c20 7765 6967  alizing all weig
+00002f70: 6874 206d 6174 7269 6365 7320 2873 686f  ht matrices (sho
+00002f80: 756c 6420 6265 206b 6570 7420 746f 2031  uld be kept to 1
+00002f90: 2c20 7573 6564 2069 6e74 6572 6e61 6c6c  , used internall
+00002fa0: 7920 666f 7220 696e 6974 6961 6c69 7a61  y for initializa
+00002fb0: 7469 6f6e 0a20 2020 2020 2020 2020 2020  tion.           
+00002fc0: 2074 6573 7469 6e67 292e 0a20 2020 2020   testing)..     
+00002fd0: 2020 206c 6179 6572 5f6e 6f72 6d5f 6570     layer_norm_ep
+00002fe0: 7320 2860 666c 6f61 7460 2c20 2a6f 7074  s (`float`, *opt
+00002ff0: 696f 6e61 6c2a 2c20 6465 6661 756c 7473  ional*, defaults
+00003000: 2074 6f20 3165 2d30 3529 3a0a 2020 2020   to 1e-05):.    
+00003010: 2020 2020 2020 2020 5468 6520 6570 7369          The epsi
+00003020: 6c6f 6e20 7573 6564 2062 7920 7468 6520  lon used by the 
+00003030: 6c61 7965 7220 6e6f 726d 616c 697a 6174  layer normalizat
+00003040: 696f 6e20 6c61 7965 7273 2e0a 2020 2020  ion layers..    
+00003050: 2020 2020 7368 6172 655f 6c69 6e6b 5f74      share_link_t
+00003060: 6f77 6572 5f6c 6179 6572 7320 2860 626f  ower_layers (`bo
+00003070: 6f6c 602c 202a 6f70 7469 6f6e 616c 2a2c  ol`, *optional*,
+00003080: 2064 6566 6175 6c74 7320 746f 2060 4661   defaults to `Fa
+00003090: 6c73 6560 293a 0a20 2020 2020 2020 2020  lse`):.         
+000030a0: 2020 2057 6865 7468 6572 2074 6865 2062     Whether the b
+000030b0: 7269 6465 2f6c 696e 6b20 746f 7765 7220  ride/link tower 
+000030c0: 6c61 7965 7273 2061 7265 2073 6861 7265  layers are share
+000030d0: 642e 0a20 2020 2020 2020 206c 696e 6b5f  d..        link_
+000030e0: 746f 7765 725f 7479 7065 2028 6073 7472  tower_type (`str
+000030f0: 602c 202a 6f70 7469 6f6e 616c 2a2c 2064  `, *optional*, d
+00003100: 6566 6175 6c74 7320 746f 2060 2261 6464  efaults to `"add
+00003110: 2260 293a 0a20 2020 2020 2020 2020 2020  "`):.           
+00003120: 2054 7970 6520 6f66 2074 6865 2062 7269   Type of the bri
+00003130: 6467 652f 6c69 6e6b 206c 6179 6572 2e0a  dge/link layer..
+00003140: 2020 2020 2020 2020 6e75 6d5f 6174 7465          num_atte
+00003150: 6e74 696f 6e5f 6865 6164 7320 2860 696e  ntion_heads (`in
+00003160: 7460 2c20 2a6f 7074 696f 6e61 6c2a 2c20  t`, *optional*, 
+00003170: 6465 6661 756c 7473 2074 6f20 3132 293a  defaults to 12):
+00003180: 0a20 2020 2020 2020 2020 2020 204e 756d  .            Num
+00003190: 6265 7220 6f66 2061 7474 656e 7469 6f6e  ber of attention
+000031a0: 2068 6561 6473 2066 6f72 2065 6163 6820   heads for each 
+000031b0: 6174 7465 6e74 696f 6e20 6c61 7965 7220  attention layer 
+000031c0: 696e 2074 6865 2054 7261 6e73 666f 726d  in the Transform
+000031d0: 6572 2065 6e63 6f64 6572 2e0a 2020 2020  er encoder..    
+000031e0: 2020 2020 6e75 6d5f 6869 6464 656e 5f6c      num_hidden_l
+000031f0: 6179 6572 7320 2860 696e 7460 2c20 2a6f  ayers (`int`, *o
+00003200: 7074 696f 6e61 6c2a 2c20 6465 6661 756c  ptional*, defaul
+00003210: 7473 2074 6f20 3629 3a0a 2020 2020 2020  ts to 6):.      
+00003220: 2020 2020 2020 4e75 6d62 6572 206f 6620        Number of 
+00003230: 6869 6464 656e 206c 6179 6572 7320 696e  hidden layers in
+00003240: 2074 6865 2054 7261 6e73 666f 726d 6572   the Transformer
+00003250: 2065 6e63 6f64 6572 2e0a 2020 2020 2020   encoder..      
+00003260: 2020 7469 655f 776f 7264 5f65 6d62 6564    tie_word_embed
+00003270: 6469 6e67 7320 2860 626f 6f6c 602c 202a  dings (`bool`, *
+00003280: 6f70 7469 6f6e 616c 2a2c 2064 6566 6175  optional*, defau
+00003290: 6c74 7320 746f 2060 4661 6c73 6560 293a  lts to `False`):
+000032a0: 0a20 2020 2020 2020 2020 2020 2057 6865  .            Whe
+000032b0: 7468 6572 2074 6f20 7469 6520 696e 7075  ther to tie inpu
+000032c0: 7420 616e 6420 6f75 7470 7574 2065 6d62  t and output emb
+000032d0: 6564 6469 6e67 732e 0a20 2020 2020 2020  eddings..       
+000032e0: 2069 6e69 745f 6c61 7965 726e 6f72 6d5f   init_layernorm_
+000032f0: 6672 6f6d 5f76 6973 696f 6e5f 656e 636f  from_vision_enco
+00003300: 6465 7220 2860 626f 6f6c 602c 202a 6f70  der (`bool`, *op
+00003310: 7469 6f6e 616c 2a2c 2064 6566 6175 6c74  tional*, default
+00003320: 7320 746f 2060 4661 6c73 6560 293a 0a20  s to `False`):. 
+00003330: 2020 2020 2020 2020 2020 2057 6865 7468             Wheth
+00003340: 6572 2074 6f20 696e 6974 204c 6179 6572  er to init Layer
+00003350: 4e6f 726d 2066 726f 6d20 7468 6520 7669  Norm from the vi
+00003360: 7369 6f6e 2065 6e63 6f64 6572 2e0a 2020  sion encoder..  
+00003370: 2020 2020 2020 7465 7874 5f63 6f6e 6669        text_confi
+00003380: 6720 2860 6469 6374 602c 202a 6f70 7469  g (`dict`, *opti
+00003390: 6f6e 616c 2a29 3a0a 2020 2020 2020 2020  onal*):.        
+000033a0: 2020 2020 4469 6374 696f 6e61 7279 206f      Dictionary o
+000033b0: 6620 636f 6e66 6967 7572 6174 696f 6e20  f configuration 
+000033c0: 6f70 7469 6f6e 7320 7573 6564 2074 6f20  options used to 
+000033d0: 696e 6974 6961 6c69 7a65 205b 6042 7269  initialize [`Bri
+000033e0: 6467 6554 6f77 6572 5465 7874 436f 6e66  dgeTowerTextConf
+000033f0: 6967 605d 2e0a 2020 2020 2020 2020 7669  ig`]..        vi
+00003400: 7369 6f6e 5f63 6f6e 6669 6720 2860 6469  sion_config (`di
+00003410: 6374 602c 202a 6f70 7469 6f6e 616c 2a29  ct`, *optional*)
+00003420: 3a0a 2020 2020 2020 2020 2020 2020 4469  :.            Di
+00003430: 6374 696f 6e61 7279 206f 6620 636f 6e66  ctionary of conf
+00003440: 6967 7572 6174 696f 6e20 6f70 7469 6f6e  iguration option
+00003450: 7320 7573 6564 2074 6f20 696e 6974 6961  s used to initia
+00003460: 6c69 7a65 205b 6042 7269 6467 6554 6f77  lize [`BridgeTow
+00003470: 6572 5669 7369 6f6e 436f 6e66 6967 605d  erVisionConfig`]
+00003480: 2e0a 0a20 2020 2045 7861 6d70 6c65 3a0a  ...    Example:.
+00003490: 0a20 2020 2060 6060 7079 7468 6f6e 0a20  .    ```python. 
+000034a0: 2020 203e 3e3e 2066 726f 6d20 7472 616e     >>> from tran
+000034b0: 7366 6f72 6d65 7273 2069 6d70 6f72 7420  sformers import 
+000034c0: 4272 6964 6765 546f 7765 724d 6f64 656c  BridgeTowerModel
+000034d0: 2c20 4272 6964 6765 546f 7765 7243 6f6e  , BridgeTowerCon
+000034e0: 6669 670a 0a20 2020 203e 3e3e 2023 2049  fig..    >>> # I
+000034f0: 6e69 7469 616c 697a 696e 6720 6120 4272  nitializing a Br
+00003500: 6964 6765 546f 7765 7220 4272 6964 6765  idgeTower Bridge
+00003510: 546f 7765 722f 6272 6964 6765 746f 7765  Tower/bridgetowe
+00003520: 722d 6261 7365 2073 7479 6c65 2063 6f6e  r-base style con
+00003530: 6669 6775 7261 7469 6f6e 0a20 2020 203e  figuration.    >
+00003540: 3e3e 2063 6f6e 6669 6775 7261 7469 6f6e  >> configuration
+00003550: 203d 2042 7269 6467 6554 6f77 6572 436f   = BridgeTowerCo
+00003560: 6e66 6967 2829 0a0a 2020 2020 3e3e 3e20  nfig()..    >>> 
+00003570: 2320 496e 6974 6961 6c69 7a69 6e67 2061  # Initializing a
+00003580: 206d 6f64 656c 2066 726f 6d20 7468 6520   model from the 
+00003590: 4272 6964 6765 546f 7765 722f 6272 6964  BridgeTower/brid
+000035a0: 6765 746f 7765 722d 6261 7365 2073 7479  getower-base sty
+000035b0: 6c65 2063 6f6e 6669 6775 7261 7469 6f6e  le configuration
+000035c0: 0a20 2020 203e 3e3e 206d 6f64 656c 203d  .    >>> model =
+000035d0: 2042 7269 6467 6554 6f77 6572 4d6f 6465   BridgeTowerMode
+000035e0: 6c28 636f 6e66 6967 7572 6174 696f 6e29  l(configuration)
+000035f0: 0a0a 2020 2020 3e3e 3e20 2320 4163 6365  ..    >>> # Acce
+00003600: 7373 696e 6720 7468 6520 6d6f 6465 6c20  ssing the model 
+00003610: 636f 6e66 6967 7572 6174 696f 6e0a 2020  configuration.  
+00003620: 2020 3e3e 3e20 636f 6e66 6967 7572 6174    >>> configurat
+00003630: 696f 6e20 3d20 6d6f 6465 6c2e 636f 6e66  ion = model.conf
+00003640: 6967 0a20 2020 2060 6060 2222 220a 0a20  ig.    ```""".. 
+00003650: 2020 206d 6f64 656c 5f74 7970 6520 3d20     model_type = 
+00003660: 2262 7269 6467 6574 6f77 6572 220a 0a20  "bridgetower".. 
+00003670: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
+00003680: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+00003690: 2020 2020 2020 2073 6861 7265 5f63 726f         share_cro
+000036a0: 7373 5f6d 6f64 616c 5f74 7261 6e73 666f  ss_modal_transfo
+000036b0: 726d 6572 5f6c 6179 6572 733d 5472 7565  rmer_layers=True
+000036c0: 2c0a 2020 2020 2020 2020 6869 6464 656e  ,.        hidden
+000036d0: 5f61 6374 3d22 6765 6c75 222c 0a20 2020  _act="gelu",.   
+000036e0: 2020 2020 2068 6964 6465 6e5f 7369 7a65       hidden_size
+000036f0: 3d37 3638 2c0a 2020 2020 2020 2020 696e  =768,.        in
+00003700: 6974 6961 6c69 7a65 725f 6661 6374 6f72  itializer_factor
+00003710: 3d31 2c0a 2020 2020 2020 2020 6c61 7965  =1,.        laye
+00003720: 725f 6e6f 726d 5f65 7073 3d31 652d 3035  r_norm_eps=1e-05
+00003730: 2c0a 2020 2020 2020 2020 7368 6172 655f  ,.        share_
+00003740: 6c69 6e6b 5f74 6f77 6572 5f6c 6179 6572  link_tower_layer
+00003750: 733d 4661 6c73 652c 0a20 2020 2020 2020  s=False,.       
+00003760: 206c 696e 6b5f 746f 7765 725f 7479 7065   link_tower_type
+00003770: 3d22 6164 6422 2c0a 2020 2020 2020 2020  ="add",.        
+00003780: 6e75 6d5f 6174 7465 6e74 696f 6e5f 6865  num_attention_he
+00003790: 6164 733d 3132 2c0a 2020 2020 2020 2020  ads=12,.        
+000037a0: 6e75 6d5f 6869 6464 656e 5f6c 6179 6572  num_hidden_layer
+000037b0: 733d 362c 0a20 2020 2020 2020 2074 6965  s=6,.        tie
+000037c0: 5f77 6f72 645f 656d 6265 6464 696e 6773  _word_embeddings
+000037d0: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
+000037e0: 696e 6974 5f6c 6179 6572 6e6f 726d 5f66  init_layernorm_f
+000037f0: 726f 6d5f 7669 7369 6f6e 5f65 6e63 6f64  rom_vision_encod
+00003800: 6572 3d46 616c 7365 2c0a 2020 2020 2020  er=False,.      
+00003810: 2020 7465 7874 5f63 6f6e 6669 673d 4e6f    text_config=No
+00003820: 6e65 2c0a 2020 2020 2020 2020 7669 7369  ne,.        visi
+00003830: 6f6e 5f63 6f6e 6669 673d 4e6f 6e65 2c0a  on_config=None,.
+00003840: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
+00003850: 2c0a 2020 2020 293a 0a20 2020 2020 2020  ,.    ):.       
+00003860: 2023 2054 4f44 4f3a 2072 656d 6f76 6520   # TODO: remove 
+00003870: 7468 6973 206f 6e63 6520 7468 6520 4875  this once the Hu
+00003880: 6220 6669 6c65 7320 6172 6520 7570 6461  b files are upda
+00003890: 7465 642e 0a20 2020 2020 2020 205f 203d  ted..        _ =
+000038a0: 206b 7761 7267 732e 706f 7028 2274 6578   kwargs.pop("tex
+000038b0: 745f 636f 6e66 6967 5f64 6963 7422 2c20  t_config_dict", 
+000038c0: 4e6f 6e65 290a 2020 2020 2020 2020 5f20  None).        _ 
+000038d0: 3d20 6b77 6172 6773 2e70 6f70 2822 7669  = kwargs.pop("vi
+000038e0: 7369 6f6e 5f63 6f6e 6669 675f 6469 6374  sion_config_dict
+000038f0: 222c 204e 6f6e 6529 0a0a 2020 2020 2020  ", None)..      
+00003900: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
+00003910: 5f5f 282a 2a6b 7761 7267 7329 0a20 2020  __(**kwargs).   
+00003920: 2020 2020 2073 656c 662e 7368 6172 655f       self.share_
+00003930: 6372 6f73 735f 6d6f 6461 6c5f 7472 616e  cross_modal_tran
+00003940: 7366 6f72 6d65 725f 6c61 7965 7273 203d  sformer_layers =
+00003950: 2073 6861 7265 5f63 726f 7373 5f6d 6f64   share_cross_mod
+00003960: 616c 5f74 7261 6e73 666f 726d 6572 5f6c  al_transformer_l
+00003970: 6179 6572 730a 2020 2020 2020 2020 7365  ayers.        se
+00003980: 6c66 2e68 6964 6465 6e5f 6163 7420 3d20  lf.hidden_act = 
+00003990: 6869 6464 656e 5f61 6374 0a20 2020 2020  hidden_act.     
+000039a0: 2020 2073 656c 662e 6869 6464 656e 5f73     self.hidden_s
+000039b0: 697a 6520 3d20 6869 6464 656e 5f73 697a  ize = hidden_siz
+000039c0: 650a 2020 2020 2020 2020 7365 6c66 2e69  e.        self.i
+000039d0: 6e69 7469 616c 697a 6572 5f66 6163 746f  nitializer_facto
+000039e0: 7220 3d20 696e 6974 6961 6c69 7a65 725f  r = initializer_
+000039f0: 6661 6374 6f72 0a20 2020 2020 2020 2073  factor.        s
+00003a00: 656c 662e 6c61 7965 725f 6e6f 726d 5f65  elf.layer_norm_e
+00003a10: 7073 203d 206c 6179 6572 5f6e 6f72 6d5f  ps = layer_norm_
+00003a20: 6570 730a 2020 2020 2020 2020 7365 6c66  eps.        self
+00003a30: 2e73 6861 7265 5f6c 696e 6b5f 746f 7765  .share_link_towe
+00003a40: 725f 6c61 7965 7273 203d 2073 6861 7265  r_layers = share
+00003a50: 5f6c 696e 6b5f 746f 7765 725f 6c61 7965  _link_tower_laye
+00003a60: 7273 0a20 2020 2020 2020 2073 656c 662e  rs.        self.
+00003a70: 6c69 6e6b 5f74 6f77 6572 5f74 7970 6520  link_tower_type 
+00003a80: 3d20 6c69 6e6b 5f74 6f77 6572 5f74 7970  = link_tower_typ
+00003a90: 650a 2020 2020 2020 2020 7365 6c66 2e6e  e.        self.n
+00003aa0: 756d 5f61 7474 656e 7469 6f6e 5f68 6561  um_attention_hea
+00003ab0: 6473 203d 206e 756d 5f61 7474 656e 7469  ds = num_attenti
+00003ac0: 6f6e 5f68 6561 6473 0a20 2020 2020 2020  on_heads.       
+00003ad0: 2073 656c 662e 6e75 6d5f 6869 6464 656e   self.num_hidden
+00003ae0: 5f6c 6179 6572 7320 3d20 6e75 6d5f 6869  _layers = num_hi
+00003af0: 6464 656e 5f6c 6179 6572 730a 2020 2020  dden_layers.    
+00003b00: 2020 2020 7365 6c66 2e74 6965 5f77 6f72      self.tie_wor
+00003b10: 645f 656d 6265 6464 696e 6773 203d 2074  d_embeddings = t
+00003b20: 6965 5f77 6f72 645f 656d 6265 6464 696e  ie_word_embeddin
+00003b30: 6773 0a20 2020 2020 2020 2073 656c 662e  gs.        self.
+00003b40: 696e 6974 5f6c 6179 6572 6e6f 726d 5f66  init_layernorm_f
+00003b50: 726f 6d5f 7669 7369 6f6e 5f65 6e63 6f64  rom_vision_encod
+00003b60: 6572 203d 2069 6e69 745f 6c61 7965 726e  er = init_layern
+00003b70: 6f72 6d5f 6672 6f6d 5f76 6973 696f 6e5f  orm_from_vision_
+00003b80: 656e 636f 6465 720a 0a20 2020 2020 2020  encoder..       
+00003b90: 2069 6620 7465 7874 5f63 6f6e 6669 6720   if text_config 
+00003ba0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00003bb0: 2020 2020 2074 6578 745f 636f 6e66 6967       text_config
+00003bc0: 203d 207b 7d0a 2020 2020 2020 2020 2020   = {}.          
+00003bd0: 2020 6c6f 6767 6572 2e69 6e66 6f28 2260    logger.info("`
+00003be0: 7465 7874 5f63 6f6e 6669 6760 2069 7320  text_config` is 
+00003bf0: 604e 6f6e 6560 2e20 496e 6974 6961 6c69  `None`. Initiali
+00003c00: 7a69 6e67 2074 6865 2060 4272 6964 6765  zing the `Bridge
+00003c10: 546f 7765 7254 6578 7443 6f6e 6669 6760  TowerTextConfig`
+00003c20: 2077 6974 6820 6465 6661 756c 7420 7661   with default va
+00003c30: 6c75 6573 2e22 290a 0a20 2020 2020 2020  lues.")..       
+00003c40: 2069 6620 7669 7369 6f6e 5f63 6f6e 6669   if vision_confi
+00003c50: 6720 6973 204e 6f6e 653a 0a20 2020 2020  g is None:.     
+00003c60: 2020 2020 2020 2076 6973 696f 6e5f 636f         vision_co
+00003c70: 6e66 6967 203d 207b 7d0a 2020 2020 2020  nfig = {}.      
+00003c80: 2020 2020 2020 6c6f 6767 6572 2e69 6e66        logger.inf
+00003c90: 6f28 2260 7669 7369 6f6e 5f63 6f6e 6669  o("`vision_confi
+00003ca0: 6760 2069 7320 604e 6f6e 6560 2e20 496e  g` is `None`. In
+00003cb0: 6974 6961 6c69 7a69 6e67 2074 6865 2060  itializing the `
+00003cc0: 4272 6964 6765 546f 7765 7256 6973 696f  BridgeTowerVisio
+00003cd0: 6e43 6f6e 6669 6760 2077 6974 6820 6465  nConfig` with de
+00003ce0: 6661 756c 7420 7661 6c75 6573 2e22 290a  fault values.").
+00003cf0: 0a20 2020 2020 2020 2073 656c 662e 7465  .        self.te
+00003d00: 7874 5f63 6f6e 6669 6720 3d20 4272 6964  xt_config = Brid
+00003d10: 6765 546f 7765 7254 6578 7443 6f6e 6669  geTowerTextConfi
+00003d20: 6728 2a2a 7465 7874 5f63 6f6e 6669 6729  g(**text_config)
+00003d30: 0a20 2020 2020 2020 2073 656c 662e 7669  .        self.vi
+00003d40: 7369 6f6e 5f63 6f6e 6669 6720 3d20 4272  sion_config = Br
+00003d50: 6964 6765 546f 7765 7256 6973 696f 6e43  idgeTowerVisionC
+00003d60: 6f6e 6669 6728 2a2a 7669 7369 6f6e 5f63  onfig(**vision_c
+00003d70: 6f6e 6669 6729 0a0a 2020 2020 4063 6c61  onfig)..    @cla
+00003d80: 7373 6d65 7468 6f64 0a20 2020 2064 6566  ssmethod.    def
+00003d90: 2066 726f 6d5f 7465 7874 5f76 6973 696f   from_text_visio
+00003da0: 6e5f 636f 6e66 6967 7328 0a20 2020 2020  n_configs(.     
+00003db0: 2020 2063 6c73 2c20 7465 7874 5f63 6f6e     cls, text_con
+00003dc0: 6669 673a 2042 7269 6467 6554 6f77 6572  fig: BridgeTower
+00003dd0: 5465 7874 436f 6e66 6967 2c20 7669 7369  TextConfig, visi
+00003de0: 6f6e 5f63 6f6e 6669 673a 2042 7269 6467  on_config: Bridg
+00003df0: 6554 6f77 6572 5669 7369 6f6e 436f 6e66  eTowerVisionConf
+00003e00: 6967 2c20 2a2a 6b77 6172 6773 0a20 2020  ig, **kwargs.   
+00003e10: 2029 3a0a 2020 2020 2020 2020 7222 2222   ):.        r"""
+00003e20: 0a20 2020 2020 2020 2049 6e73 7461 6e74  .        Instant
+00003e30: 6961 7465 2061 205b 6042 7269 6467 6554  iate a [`BridgeT
+00003e40: 6f77 6572 436f 6e66 6967 605d 2028 6f72  owerConfig`] (or
+00003e50: 2061 2064 6572 6976 6564 2063 6c61 7373   a derived class
+00003e60: 2920 6672 6f6d 2042 7269 6467 6554 6f77  ) from BridgeTow
+00003e70: 6572 2074 6578 7420 6d6f 6465 6c20 636f  er text model co
+00003e80: 6e66 6967 7572 6174 696f 6e2e 2052 6574  nfiguration. Ret
+00003e90: 7572 6e73 3a0a 2020 2020 2020 2020 2020  urns:.          
+00003ea0: 2020 5b60 4272 6964 6765 546f 7765 7243    [`BridgeTowerC
+00003eb0: 6f6e 6669 6760 5d3a 2041 6e20 696e 7374  onfig`]: An inst
+00003ec0: 616e 6365 206f 6620 6120 636f 6e66 6967  ance of a config
+00003ed0: 7572 6174 696f 6e20 6f62 6a65 6374 0a20  uration object. 
+00003ee0: 2020 2020 2020 2022 2222 0a0a 2020 2020         """..    
+00003ef0: 2020 2020 7265 7475 726e 2063 6c73 2874      return cls(t
+00003f00: 6578 745f 636f 6e66 6967 3d74 6578 745f  ext_config=text_
+00003f10: 636f 6e66 6967 2e74 6f5f 6469 6374 2829  config.to_dict()
+00003f20: 2c20 7669 7369 6f6e 5f63 6f6e 6669 673d  , vision_config=
+00003f30: 7669 7369 6f6e 5f63 6f6e 6669 672e 746f  vision_config.to
+00003f40: 5f64 6963 7428 292c 202a 2a6b 7761 7267  _dict(), **kwarg
+00003f50: 7329 0a0a 5f5f 616c 6c5f 5f20 3d20 5b27  s)..__all__ = ['
+00003f60: 4272 6964 6765 546f 7765 7243 6f6e 6669  BridgeTowerConfi
+00003f70: 6727 2c20 2742 7269 6467 6554 6f77 6572  g', 'BridgeTower
+00003f80: 5465 7874 436f 6e66 6967 272c 2027 4272  TextConfig', 'Br
+00003f90: 6964 6765 546f 7765 7256 6973 696f 6e43  idgeTowerVisionC
+00003fa0: 6f6e 6669 6727 5d0a                      onfig'].
```

## mindnlp/transformers/models/bridgetower/image_processing_bridgetower.py

```diff
@@ -0,0 +1,1683 @@
+00000000: 2320 636f 6469 6e67 3d75 7466 2d38 0a23  # coding=utf-8.#
+00000010: 2043 6f70 7972 6967 6874 2032 3032 3320   Copyright 2023 
+00000020: 5468 6520 496e 7465 6c20 4c61 6273 2054  The Intel Labs T
+00000030: 6561 6d20 4175 7468 6f72 732c 2054 6865  eam Authors, The
+00000040: 204d 6963 726f 736f 6674 2052 6573 6561   Microsoft Resea
+00000050: 7263 6820 5465 616d 2041 7574 686f 7273  rch Team Authors
+00000060: 2061 6e64 2048 7567 6769 6e67 4661 6365   and HuggingFace
+00000070: 2049 6e63 2e20 7465 616d 2e20 416c 6c20   Inc. team. All 
+00000080: 7269 6768 7473 2072 6573 6572 7665 642e  rights reserved.
+00000090: 0a23 0a23 204c 6963 656e 7365 6420 756e  .#.# Licensed un
+000000a0: 6465 7220 7468 6520 4170 6163 6865 204c  der the Apache L
+000000b0: 6963 656e 7365 2c20 5665 7273 696f 6e20  icense, Version 
+000000c0: 322e 3020 2874 6865 2022 4c69 6365 6e73  2.0 (the "Licens
+000000d0: 6522 293b 0a23 2079 6f75 206d 6179 206e  e");.# you may n
+000000e0: 6f74 2075 7365 2074 6869 7320 6669 6c65  ot use this file
+000000f0: 2065 7863 6570 7420 696e 2063 6f6d 706c   except in compl
+00000100: 6961 6e63 6520 7769 7468 2074 6865 204c  iance with the L
+00000110: 6963 656e 7365 2e0a 2320 596f 7520 6d61  icense..# You ma
+00000120: 7920 6f62 7461 696e 2061 2063 6f70 7920  y obtain a copy 
+00000130: 6f66 2074 6865 204c 6963 656e 7365 2061  of the License a
+00000140: 740a 230a 2320 2020 2020 6874 7470 3a2f  t.#.#     http:/
+00000150: 2f77 7777 2e61 7061 6368 652e 6f72 672f  /www.apache.org/
+00000160: 6c69 6365 6e73 6573 2f4c 4943 454e 5345  licenses/LICENSE
+00000170: 2d32 2e30 0a23 0a23 2055 6e6c 6573 7320  -2.0.#.# Unless 
+00000180: 7265 7175 6972 6564 2062 7920 6170 706c  required by appl
+00000190: 6963 6162 6c65 206c 6177 206f 7220 6167  icable law or ag
+000001a0: 7265 6564 2074 6f20 696e 2077 7269 7469  reed to in writi
+000001b0: 6e67 2c20 736f 6674 7761 7265 0a23 2064  ng, software.# d
+000001c0: 6973 7472 6962 7574 6564 2075 6e64 6572  istributed under
+000001d0: 2074 6865 204c 6963 656e 7365 2069 7320   the License is 
+000001e0: 6469 7374 7269 6275 7465 6420 6f6e 2061  distributed on a
+000001f0: 6e20 2241 5320 4953 2220 4241 5349 532c  n "AS IS" BASIS,
+00000200: 0a23 2057 4954 484f 5554 2057 4152 5241  .# WITHOUT WARRA
+00000210: 4e54 4945 5320 4f52 2043 4f4e 4449 5449  NTIES OR CONDITI
+00000220: 4f4e 5320 4f46 2041 4e59 204b 494e 442c  ONS OF ANY KIND,
+00000230: 2065 6974 6865 7220 6578 7072 6573 7320   either express 
+00000240: 6f72 2069 6d70 6c69 6564 2e0a 2320 5365  or implied..# Se
+00000250: 6520 7468 6520 4c69 6365 6e73 6520 666f  e the License fo
+00000260: 7220 7468 6520 7370 6563 6966 6963 206c  r the specific l
+00000270: 616e 6775 6167 6520 676f 7665 726e 696e  anguage governin
+00000280: 6720 7065 726d 6973 7369 6f6e 7320 616e  g permissions an
+00000290: 640a 2320 6c69 6d69 7461 7469 6f6e 7320  d.# limitations 
+000002a0: 756e 6465 7220 7468 6520 4c69 6365 6e73  under the Licens
+000002b0: 652e 0a22 2222 496d 6167 6520 7072 6f63  e.."""Image proc
+000002c0: 6573 736f 7220 636c 6173 7320 666f 7220  essor class for 
+000002d0: 4272 6964 6765 546f 7765 722e 2222 220a  BridgeTower.""".
+000002e0: 0a66 726f 6d20 7479 7069 6e67 2069 6d70  .from typing imp
+000002f0: 6f72 7420 416e 792c 2044 6963 742c 2049  ort Any, Dict, I
+00000300: 7465 7261 626c 652c 204c 6973 742c 204f  terable, List, O
+00000310: 7074 696f 6e61 6c2c 2054 7570 6c65 2c20  ptional, Tuple, 
+00000320: 556e 696f 6e0a 0a69 6d70 6f72 7420 6e75  Union..import nu
+00000330: 6d70 7920 6173 206e 700a 0a66 726f 6d20  mpy as np..from 
+00000340: 6d69 6e64 6e6c 702e 636f 6e66 6967 7320  mindnlp.configs 
+00000350: 696d 706f 7274 204f 5045 4e41 495f 434c  import OPENAI_CL
+00000360: 4950 5f4d 4541 4e2c 204f 5045 4e41 495f  IP_MEAN, OPENAI_
+00000370: 434c 4950 5f53 5444 0a66 726f 6d20 2e2e  CLIP_STD.from ..
+00000380: 2e69 6d61 6765 5f70 726f 6365 7373 696e  .image_processin
+00000390: 675f 7574 696c 7320 696d 706f 7274 2042  g_utils import B
+000003a0: 6173 6549 6d61 6765 5072 6f63 6573 736f  aseImageProcesso
+000003b0: 722c 2042 6174 6368 4665 6174 7572 652c  r, BatchFeature,
+000003c0: 2067 6574 5f73 697a 655f 6469 6374 0a66   get_size_dict.f
+000003d0: 726f 6d20 2e2e 2e69 6d61 6765 5f74 7261  rom ...image_tra
+000003e0: 6e73 666f 726d 7320 696d 706f 7274 2050  nsforms import P
+000003f0: 6164 6469 6e67 4d6f 6465 2c20 6365 6e74  addingMode, cent
+00000400: 6572 5f63 726f 702c 2070 6164 2c20 7265  er_crop, pad, re
+00000410: 7369 7a65 2c20 746f 5f63 6861 6e6e 656c  size, to_channel
+00000420: 5f64 696d 656e 7369 6f6e 5f66 6f72 6d61  _dimension_forma
+00000430: 740a 6672 6f6d 202e 2e2e 696d 6167 655f  t.from ...image_
+00000440: 7574 696c 7320 696d 706f 7274 2028 0a20  utils import (. 
+00000450: 2020 2043 6861 6e6e 656c 4469 6d65 6e73     ChannelDimens
+00000460: 696f 6e2c 0a20 2020 2049 6d61 6765 496e  ion,.    ImageIn
+00000470: 7075 742c 0a20 2020 2050 494c 496d 6167  put,.    PILImag
+00000480: 6552 6573 616d 706c 696e 672c 0a20 2020  eResampling,.   
+00000490: 2067 6574 5f69 6d61 6765 5f73 697a 652c   get_image_size,
+000004a0: 0a20 2020 2069 6e66 6572 5f63 6861 6e6e  .    infer_chann
+000004b0: 656c 5f64 696d 656e 7369 6f6e 5f66 6f72  el_dimension_for
+000004c0: 6d61 742c 0a20 2020 2069 735f 6261 7463  mat,.    is_batc
+000004d0: 6865 642c 0a20 2020 2069 735f 7363 616c  hed,.    is_scal
+000004e0: 6564 5f69 6d61 6765 2c0a 2020 2020 746f  ed_image,.    to
+000004f0: 5f6e 756d 7079 5f61 7272 6179 2c0a 2020  _numpy_array,.  
+00000500: 2020 7661 6c69 645f 696d 6167 6573 2c0a    valid_images,.
+00000510: 2020 2020 7661 6c69 6461 7465 5f6b 7761      validate_kwa
+00000520: 7267 732c 0a20 2020 2076 616c 6964 6174  rgs,.    validat
+00000530: 655f 7072 6570 726f 6365 7373 5f61 7267  e_preprocess_arg
+00000540: 756d 656e 7473 2c0a 290a 6672 6f6d 202e  uments,.).from .
+00000550: 2e2e 2e75 7469 6c73 2069 6d70 6f72 7420  ...utils import 
+00000560: 5465 6e73 6f72 5479 7065 2c20 6973 5f76  TensorType, is_v
+00000570: 6973 696f 6e5f 6176 6169 6c61 626c 652c  ision_available,
+00000580: 206c 6f67 6769 6e67 0a0a 0a69 6620 6973   logging...if is
+00000590: 5f76 6973 696f 6e5f 6176 6169 6c61 626c  _vision_availabl
+000005a0: 6528 293a 0a20 2020 2069 6d70 6f72 7420  e():.    import 
+000005b0: 5049 4c0a 0a6c 6f67 6765 7220 3d20 6c6f  PIL..logger = lo
+000005c0: 6767 696e 672e 6765 745f 6c6f 6767 6572  gging.get_logger
+000005d0: 285f 5f6e 616d 655f 5f29 0a0a 0a23 2043  (__name__)...# C
+000005e0: 6f70 6965 6420 6672 6f6d 2074 7261 6e73  opied from trans
+000005f0: 666f 726d 6572 732e 6d6f 6465 6c73 2e76  formers.models.v
+00000600: 696c 742e 696d 6167 655f 7072 6f63 6573  ilt.image_proces
+00000610: 7369 6e67 5f76 696c 742e 6d61 785f 6163  sing_vilt.max_ac
+00000620: 726f 7373 5f69 6e64 6963 6573 0a64 6566  ross_indices.def
+00000630: 206d 6178 5f61 6372 6f73 735f 696e 6469   max_across_indi
+00000640: 6365 7328 7661 6c75 6573 3a20 4974 6572  ces(values: Iter
+00000650: 6162 6c65 5b41 6e79 5d29 202d 3e20 4c69  able[Any]) -> Li
+00000660: 7374 5b41 6e79 5d3a 0a20 2020 2022 2222  st[Any]:.    """
+00000670: 0a20 2020 2052 6574 7572 6e20 7468 6520  .    Return the 
+00000680: 6d61 7869 6d75 6d20 7661 6c75 6520 6163  maximum value ac
+00000690: 726f 7373 2061 6c6c 2069 6e64 6963 6573  ross all indices
+000006a0: 206f 6620 616e 2069 7465 7261 626c 6520   of an iterable 
+000006b0: 6f66 2076 616c 7565 732e 0a20 2020 2022  of values..    "
+000006c0: 2222 0a20 2020 2072 6574 7572 6e20 5b6d  "".    return [m
+000006d0: 6178 2876 616c 7565 735f 6929 2066 6f72  ax(values_i) for
+000006e0: 2076 616c 7565 735f 6920 696e 207a 6970   values_i in zip
+000006f0: 282a 7661 6c75 6573 295d 0a0a 0a23 2043  (*values)]...# C
+00000700: 6f70 6965 6420 6672 6f6d 2074 7261 6e73  opied from trans
+00000710: 666f 726d 6572 732e 6d6f 6465 6c73 2e76  formers.models.v
+00000720: 696c 742e 696d 6167 655f 7072 6f63 6573  ilt.image_proces
+00000730: 7369 6e67 5f76 696c 742e 6d61 6b65 5f70  sing_vilt.make_p
+00000740: 6978 656c 5f6d 6173 6b0a 6465 6620 6d61  ixel_mask.def ma
+00000750: 6b65 5f70 6978 656c 5f6d 6173 6b28 0a20  ke_pixel_mask(. 
+00000760: 2020 2069 6d61 6765 3a20 6e70 2e6e 6461     image: np.nda
+00000770: 7272 6179 2c20 6f75 7470 7574 5f73 697a  rray, output_siz
+00000780: 653a 2054 7570 6c65 5b69 6e74 2c20 696e  e: Tuple[int, in
+00000790: 745d 2c20 696e 7075 745f 6461 7461 5f66  t], input_data_f
+000007a0: 6f72 6d61 743a 204f 7074 696f 6e61 6c5b  ormat: Optional[
+000007b0: 556e 696f 6e5b 7374 722c 2043 6861 6e6e  Union[str, Chann
+000007c0: 656c 4469 6d65 6e73 696f 6e5d 5d20 3d20  elDimension]] = 
+000007d0: 4e6f 6e65 0a29 202d 3e20 6e70 2e6e 6461  None.) -> np.nda
+000007e0: 7272 6179 3a0a 2020 2020 2222 220a 2020  rray:.    """.  
+000007f0: 2020 4d61 6b65 2061 2070 6978 656c 206d    Make a pixel m
+00000800: 6173 6b20 666f 7220 7468 6520 696d 6167  ask for the imag
+00000810: 652c 2077 6865 7265 2031 2069 6e64 6963  e, where 1 indic
+00000820: 6174 6573 2061 2076 616c 6964 2070 6978  ates a valid pix
+00000830: 656c 2061 6e64 2030 2069 6e64 6963 6174  el and 0 indicat
+00000840: 6573 2070 6164 6469 6e67 2e0a 0a20 2020  es padding...   
+00000850: 2041 7267 733a 0a20 2020 2020 2020 2069   Args:.        i
+00000860: 6d61 6765 2028 606e 702e 6e64 6172 7261  mage (`np.ndarra
+00000870: 7960 293a 0a20 2020 2020 2020 2020 2020  y`):.           
+00000880: 2049 6d61 6765 2074 6f20 6d61 6b65 2074   Image to make t
+00000890: 6865 2070 6978 656c 206d 6173 6b20 666f  he pixel mask fo
+000008a0: 722e 0a20 2020 2020 2020 206f 7574 7075  r..        outpu
+000008b0: 745f 7369 7a65 2028 6054 7570 6c65 5b69  t_size (`Tuple[i
+000008c0: 6e74 2c20 696e 745d 6029 3a0a 2020 2020  nt, int]`):.    
+000008d0: 2020 2020 2020 2020 4f75 7470 7574 2073          Output s
+000008e0: 697a 6520 6f66 2074 6865 206d 6173 6b2e  ize of the mask.
+000008f0: 0a20 2020 2022 2222 0a20 2020 2069 6e70  .    """.    inp
+00000900: 7574 5f68 6569 6768 742c 2069 6e70 7574  ut_height, input
+00000910: 5f77 6964 7468 203d 2067 6574 5f69 6d61  _width = get_ima
+00000920: 6765 5f73 697a 6528 696d 6167 652c 2063  ge_size(image, c
+00000930: 6861 6e6e 656c 5f64 696d 3d69 6e70 7574  hannel_dim=input
+00000940: 5f64 6174 615f 666f 726d 6174 290a 2020  _data_format).  
+00000950: 2020 6d61 736b 203d 206e 702e 7a65 726f    mask = np.zero
+00000960: 7328 6f75 7470 7574 5f73 697a 652c 2064  s(output_size, d
+00000970: 7479 7065 3d6e 702e 696e 7436 3429 0a20  type=np.int64). 
+00000980: 2020 206d 6173 6b5b 3a69 6e70 7574 5f68     mask[:input_h
+00000990: 6569 6768 742c 203a 696e 7075 745f 7769  eight, :input_wi
+000009a0: 6474 685d 203d 2031 0a20 2020 2072 6574  dth] = 1.    ret
+000009b0: 7572 6e20 6d61 736b 0a0a 0a23 2043 6f70  urn mask...# Cop
+000009c0: 6965 6420 6672 6f6d 2074 7261 6e73 666f  ied from transfo
+000009d0: 726d 6572 732e 6d6f 6465 6c73 2e76 696c  rmers.models.vil
+000009e0: 742e 696d 6167 655f 7072 6f63 6573 7369  t.image_processi
+000009f0: 6e67 5f76 696c 742e 6765 745f 6d61 785f  ng_vilt.get_max_
+00000a00: 6865 6967 6874 5f77 6964 7468 0a64 6566  height_width.def
+00000a10: 2067 6574 5f6d 6178 5f68 6569 6768 745f   get_max_height_
+00000a20: 7769 6474 6828 0a20 2020 2069 6d61 6765  width(.    image
+00000a30: 733a 204c 6973 745b 6e70 2e6e 6461 7272  s: List[np.ndarr
+00000a40: 6179 5d2c 2069 6e70 7574 5f64 6174 615f  ay], input_data_
+00000a50: 666f 726d 6174 3a20 4f70 7469 6f6e 616c  format: Optional
+00000a60: 5b55 6e69 6f6e 5b73 7472 2c20 4368 616e  [Union[str, Chan
+00000a70: 6e65 6c44 696d 656e 7369 6f6e 5d5d 203d  nelDimension]] =
+00000a80: 204e 6f6e 650a 2920 2d3e 204c 6973 745b   None.) -> List[
+00000a90: 696e 745d 3a0a 2020 2020 2222 220a 2020  int]:.    """.  
+00000aa0: 2020 4765 7420 7468 6520 6d61 7869 6d75    Get the maximu
+00000ab0: 6d20 6865 6967 6874 2061 6e64 2077 6964  m height and wid
+00000ac0: 7468 2061 6372 6f73 7320 616c 6c20 696d  th across all im
+00000ad0: 6167 6573 2069 6e20 6120 6261 7463 682e  ages in a batch.
+00000ae0: 0a20 2020 2022 2222 0a20 2020 2069 6620  .    """.    if 
+00000af0: 696e 7075 745f 6461 7461 5f66 6f72 6d61  input_data_forma
+00000b00: 7420 6973 204e 6f6e 653a 0a20 2020 2020  t is None:.     
+00000b10: 2020 2069 6e70 7574 5f64 6174 615f 666f     input_data_fo
+00000b20: 726d 6174 203d 2069 6e66 6572 5f63 6861  rmat = infer_cha
+00000b30: 6e6e 656c 5f64 696d 656e 7369 6f6e 5f66  nnel_dimension_f
+00000b40: 6f72 6d61 7428 696d 6167 6573 5b30 5d29  ormat(images[0])
+00000b50: 0a0a 2020 2020 6966 2069 6e70 7574 5f64  ..    if input_d
+00000b60: 6174 615f 666f 726d 6174 203d 3d20 4368  ata_format == Ch
+00000b70: 616e 6e65 6c44 696d 656e 7369 6f6e 2e46  annelDimension.F
+00000b80: 4952 5354 3a0a 2020 2020 2020 2020 5f2c  IRST:.        _,
+00000b90: 206d 6178 5f68 6569 6768 742c 206d 6178   max_height, max
+00000ba0: 5f77 6964 7468 203d 206d 6178 5f61 6372  _width = max_acr
+00000bb0: 6f73 735f 696e 6469 6365 7328 5b69 6d67  oss_indices([img
+00000bc0: 2e73 6861 7065 2066 6f72 2069 6d67 2069  .shape for img i
+00000bd0: 6e20 696d 6167 6573 5d29 0a20 2020 2065  n images]).    e
+00000be0: 6c69 6620 696e 7075 745f 6461 7461 5f66  lif input_data_f
+00000bf0: 6f72 6d61 7420 3d3d 2043 6861 6e6e 656c  ormat == Channel
+00000c00: 4469 6d65 6e73 696f 6e2e 4c41 5354 3a0a  Dimension.LAST:.
+00000c10: 2020 2020 2020 2020 6d61 785f 6865 6967          max_heig
+00000c20: 6874 2c20 6d61 785f 7769 6474 682c 205f  ht, max_width, _
+00000c30: 203d 206d 6178 5f61 6372 6f73 735f 696e   = max_across_in
+00000c40: 6469 6365 7328 5b69 6d67 2e73 6861 7065  dices([img.shape
+00000c50: 2066 6f72 2069 6d67 2069 6e20 696d 6167   for img in imag
+00000c60: 6573 5d29 0a20 2020 2065 6c73 653a 0a20  es]).    else:. 
+00000c70: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+00000c80: 7565 4572 726f 7228 6622 496e 7661 6c69  ueError(f"Invali
+00000c90: 6420 6368 616e 6e65 6c20 6469 6d65 6e73  d channel dimens
+00000ca0: 696f 6e20 666f 726d 6174 3a20 7b69 6e70  ion format: {inp
+00000cb0: 7574 5f64 6174 615f 666f 726d 6174 7d22  ut_data_format}"
+00000cc0: 290a 2020 2020 7265 7475 726e 2028 6d61  ).    return (ma
+00000cd0: 785f 6865 6967 6874 2c20 6d61 785f 7769  x_height, max_wi
+00000ce0: 6474 6829 0a0a 0a23 2043 6f70 6965 6420  dth)...# Copied 
+00000cf0: 6672 6f6d 2074 7261 6e73 666f 726d 6572  from transformer
+00000d00: 732e 6d6f 6465 6c73 2e76 696c 742e 696d  s.models.vilt.im
+00000d10: 6167 655f 7072 6f63 6573 7369 6e67 5f76  age_processing_v
+00000d20: 696c 742e 6765 745f 7265 7369 7a65 5f6f  ilt.get_resize_o
+00000d30: 7574 7075 745f 696d 6167 655f 7369 7a65  utput_image_size
+00000d40: 0a64 6566 2067 6574 5f72 6573 697a 655f  .def get_resize_
+00000d50: 6f75 7470 7574 5f69 6d61 6765 5f73 697a  output_image_siz
+00000d60: 6528 0a20 2020 2069 6e70 7574 5f69 6d61  e(.    input_ima
+00000d70: 6765 3a20 6e70 2e6e 6461 7272 6179 2c0a  ge: np.ndarray,.
+00000d80: 2020 2020 7368 6f72 7465 723a 2069 6e74      shorter: int
+00000d90: 203d 2038 3030 2c0a 2020 2020 6c6f 6e67   = 800,.    long
+00000da0: 6572 3a20 696e 7420 3d20 3133 3333 2c0a  er: int = 1333,.
+00000db0: 2020 2020 7369 7a65 5f64 6976 6973 6f72      size_divisor
+00000dc0: 3a20 696e 7420 3d20 3332 2c0a 2020 2020  : int = 32,.    
+00000dd0: 696e 7075 745f 6461 7461 5f66 6f72 6d61  input_data_forma
+00000de0: 743a 204f 7074 696f 6e61 6c5b 556e 696f  t: Optional[Unio
+00000df0: 6e5b 7374 722c 2043 6861 6e6e 656c 4469  n[str, ChannelDi
+00000e00: 6d65 6e73 696f 6e5d 5d20 3d20 4e6f 6e65  mension]] = None
+00000e10: 2c0a 2920 2d3e 2054 7570 6c65 5b69 6e74  ,.) -> Tuple[int
+00000e20: 2c20 696e 745d 3a0a 2020 2020 696e 7075  , int]:.    inpu
+00000e30: 745f 6865 6967 6874 2c20 696e 7075 745f  t_height, input_
+00000e40: 7769 6474 6820 3d20 6765 745f 696d 6167  width = get_imag
+00000e50: 655f 7369 7a65 2869 6e70 7574 5f69 6d61  e_size(input_ima
+00000e60: 6765 2c20 696e 7075 745f 6461 7461 5f66  ge, input_data_f
+00000e70: 6f72 6d61 7429 0a20 2020 206d 696e 5f73  ormat).    min_s
+00000e80: 697a 652c 206d 6178 5f73 697a 6520 3d20  ize, max_size = 
+00000e90: 7368 6f72 7465 722c 206c 6f6e 6765 720a  shorter, longer.
+00000ea0: 0a20 2020 2073 6361 6c65 203d 206d 696e  .    scale = min
+00000eb0: 5f73 697a 6520 2f20 6d69 6e28 696e 7075  _size / min(inpu
+00000ec0: 745f 6865 6967 6874 2c20 696e 7075 745f  t_height, input_
+00000ed0: 7769 6474 6829 0a0a 2020 2020 6966 2069  width)..    if i
+00000ee0: 6e70 7574 5f68 6569 6768 7420 3c20 696e  nput_height < in
+00000ef0: 7075 745f 7769 6474 683a 0a20 2020 2020  put_width:.     
+00000f00: 2020 206e 6577 5f68 6569 6768 7420 3d20     new_height = 
+00000f10: 6d69 6e5f 7369 7a65 0a20 2020 2020 2020  min_size.       
+00000f20: 206e 6577 5f77 6964 7468 203d 2073 6361   new_width = sca
+00000f30: 6c65 202a 2069 6e70 7574 5f77 6964 7468  le * input_width
+00000f40: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+00000f50: 2020 206e 6577 5f68 6569 6768 7420 3d20     new_height = 
+00000f60: 7363 616c 6520 2a20 696e 7075 745f 6865  scale * input_he
+00000f70: 6967 6874 0a20 2020 2020 2020 206e 6577  ight.        new
+00000f80: 5f77 6964 7468 203d 206d 696e 5f73 697a  _width = min_siz
+00000f90: 650a 0a20 2020 2069 6620 6d61 7828 6e65  e..    if max(ne
+00000fa0: 775f 6865 6967 6874 2c20 6e65 775f 7769  w_height, new_wi
+00000fb0: 6474 6829 203e 206d 6178 5f73 697a 653a  dth) > max_size:
+00000fc0: 0a20 2020 2020 2020 2073 6361 6c65 203d  .        scale =
+00000fd0: 206d 6178 5f73 697a 6520 2f20 6d61 7828   max_size / max(
+00000fe0: 6e65 775f 6865 6967 6874 2c20 6e65 775f  new_height, new_
+00000ff0: 7769 6474 6829 0a20 2020 2020 2020 206e  width).        n
+00001000: 6577 5f68 6569 6768 7420 3d20 7363 616c  ew_height = scal
+00001010: 6520 2a20 6e65 775f 6865 6967 6874 0a20  e * new_height. 
+00001020: 2020 2020 2020 206e 6577 5f77 6964 7468         new_width
+00001030: 203d 2073 6361 6c65 202a 206e 6577 5f77   = scale * new_w
+00001040: 6964 7468 0a0a 2020 2020 6e65 775f 6865  idth..    new_he
+00001050: 6967 6874 2c20 6e65 775f 7769 6474 6820  ight, new_width 
+00001060: 3d20 696e 7428 6e65 775f 6865 6967 6874  = int(new_height
+00001070: 202b 2030 2e35 292c 2069 6e74 286e 6577   + 0.5), int(new
+00001080: 5f77 6964 7468 202b 2030 2e35 290a 2020  _width + 0.5).  
+00001090: 2020 6e65 775f 6865 6967 6874 203d 206e    new_height = n
+000010a0: 6577 5f68 6569 6768 7420 2f2f 2073 697a  ew_height // siz
+000010b0: 655f 6469 7669 736f 7220 2a20 7369 7a65  e_divisor * size
+000010c0: 5f64 6976 6973 6f72 0a20 2020 206e 6577  _divisor.    new
+000010d0: 5f77 6964 7468 203d 206e 6577 5f77 6964  _width = new_wid
+000010e0: 7468 202f 2f20 7369 7a65 5f64 6976 6973  th // size_divis
+000010f0: 6f72 202a 2073 697a 655f 6469 7669 736f  or * size_diviso
+00001100: 720a 0a20 2020 2072 6574 7572 6e20 6e65  r..    return ne
+00001110: 775f 6865 6967 6874 2c20 6e65 775f 7769  w_height, new_wi
+00001120: 6474 680a 0a0a 636c 6173 7320 4272 6964  dth...class Brid
+00001130: 6765 546f 7765 7249 6d61 6765 5072 6f63  geTowerImageProc
+00001140: 6573 736f 7228 4261 7365 496d 6167 6550  essor(BaseImageP
+00001150: 726f 6365 7373 6f72 293a 0a20 2020 2072  rocessor):.    r
+00001160: 2222 220a 2020 2020 436f 6e73 7472 7563  """.    Construc
+00001170: 7473 2061 2042 7269 6467 6554 6f77 6572  ts a BridgeTower
+00001180: 2069 6d61 6765 2070 726f 6365 7373 6f72   image processor
+00001190: 2e0a 0a20 2020 2041 7267 733a 0a20 2020  ...    Args:.   
+000011a0: 2020 2020 2064 6f5f 7265 7369 7a65 2028       do_resize (
+000011b0: 6062 6f6f 6c60 2c20 2a6f 7074 696f 6e61  `bool`, *optiona
+000011c0: 6c2a 2c20 6465 6661 756c 7473 2074 6f20  l*, defaults to 
+000011d0: 6054 7275 6560 293a 0a20 2020 2020 2020  `True`):.       
+000011e0: 2020 2020 2057 6865 7468 6572 2074 6f20       Whether to 
+000011f0: 7265 7369 7a65 2074 6865 2069 6d61 6765  resize the image
+00001200: 2773 2028 6865 6967 6874 2c20 7769 6474  's (height, widt
+00001210: 6829 2064 696d 656e 7369 6f6e 7320 746f  h) dimensions to
+00001220: 2074 6865 2073 7065 6369 6669 6564 2060   the specified `
+00001230: 7369 7a65 602e 2043 616e 2062 6520 6f76  size`. Can be ov
+00001240: 6572 7269 6464 656e 2062 7920 7468 650a  erridden by the.
+00001250: 2020 2020 2020 2020 2020 2020 6064 6f5f              `do_
+00001260: 7265 7369 7a65 6020 7061 7261 6d65 7465  resize` paramete
+00001270: 7220 696e 2074 6865 2060 7072 6570 726f  r in the `prepro
+00001280: 6365 7373 6020 6d65 7468 6f64 2e0a 2020  cess` method..  
+00001290: 2020 2020 2020 7369 7a65 2028 6044 6963        size (`Dic
+000012a0: 745b 7374 722c 2069 6e74 5d60 202a 6f70  t[str, int]` *op
+000012b0: 7469 6f6e 616c 2a2c 2064 6566 6175 6c74  tional*, default
+000012c0: 7320 746f 2060 7b27 7368 6f72 7465 7374  s to `{'shortest
+000012d0: 5f65 6467 6527 3a20 3238 387d 6029 3a0a  _edge': 288}`):.
+000012e0: 2020 2020 2020 2020 2020 2020 5265 7369              Resi
+000012f0: 7a65 2074 6865 2073 686f 7274 6572 2073  ze the shorter s
+00001300: 6964 6520 6f66 2074 6865 2069 6e70 7574  ide of the input
+00001310: 2074 6f20 6073 697a 655b 2273 686f 7274   to `size["short
+00001320: 6573 745f 6564 6765 225d 602e 2054 6865  est_edge"]`. The
+00001330: 206c 6f6e 6765 7220 7369 6465 2077 696c   longer side wil
+00001340: 6c20 6265 206c 696d 6974 6564 2074 6f20  l be limited to 
+00001350: 756e 6465 720a 2020 2020 2020 2020 2020  under.          
+00001360: 2020 6069 6e74 2828 3133 3333 202f 2038    `int((1333 / 8
+00001370: 3030 2920 2a20 7369 7a65 5b22 7368 6f72  00) * size["shor
+00001380: 7465 7374 5f65 6467 6522 5d29 6020 7768  test_edge"])` wh
+00001390: 696c 6520 7072 6573 6572 7669 6e67 2074  ile preserving t
+000013a0: 6865 2061 7370 6563 7420 7261 7469 6f2e  he aspect ratio.
+000013b0: 204f 6e6c 7920 6861 7320 616e 2065 6666   Only has an eff
+000013c0: 6563 7420 6966 0a20 2020 2020 2020 2020  ect if.         
+000013d0: 2020 2060 646f 5f72 6573 697a 6560 2069     `do_resize` i
+000013e0: 7320 7365 7420 746f 2060 5472 7565 602e  s set to `True`.
+000013f0: 2043 616e 2062 6520 6f76 6572 7269 6464   Can be overridd
+00001400: 656e 2062 7920 7468 6520 6073 697a 6560  en by the `size`
+00001410: 2070 6172 616d 6574 6572 2069 6e20 7468   parameter in th
+00001420: 6520 6070 7265 7072 6f63 6573 7360 206d  e `preprocess` m
+00001430: 6574 686f 642e 0a20 2020 2020 2020 2073  ethod..        s
+00001440: 697a 655f 6469 7669 736f 7220 2860 696e  ize_divisor (`in
+00001450: 7460 2c20 2a6f 7074 696f 6e61 6c2a 2c20  t`, *optional*, 
+00001460: 6465 6661 756c 7473 2074 6f20 3332 293a  defaults to 32):
+00001470: 0a20 2020 2020 2020 2020 2020 2054 6865  .            The
+00001480: 2073 697a 6520 6279 2077 6869 6368 2074   size by which t
+00001490: 6f20 6d61 6b65 2073 7572 6520 626f 7468  o make sure both
+000014a0: 2074 6865 2068 6569 6768 7420 616e 6420   the height and 
+000014b0: 7769 6474 6820 6361 6e20 6265 2064 6976  width can be div
+000014c0: 6964 6564 2e20 4f6e 6c79 2068 6173 2061  ided. Only has a
+000014d0: 6e20 6566 6665 6374 2069 6620 6064 6f5f  n effect if `do_
+000014e0: 7265 7369 7a65 600a 2020 2020 2020 2020  resize`.        
+000014f0: 2020 2020 6973 2073 6574 2074 6f20 6054      is set to `T
+00001500: 7275 6560 2e20 4361 6e20 6265 206f 7665  rue`. Can be ove
+00001510: 7272 6964 6465 6e20 6279 2074 6865 2060  rridden by the `
+00001520: 7369 7a65 5f64 6976 6973 6f72 6020 7061  size_divisor` pa
+00001530: 7261 6d65 7465 7220 696e 2074 6865 2060  rameter in the `
+00001540: 7072 6570 726f 6365 7373 6020 6d65 7468  preprocess` meth
+00001550: 6f64 2e0a 2020 2020 2020 2020 7265 7361  od..        resa
+00001560: 6d70 6c65 2028 6050 494c 496d 6167 6552  mple (`PILImageR
+00001570: 6573 616d 706c 696e 6760 2c20 2a6f 7074  esampling`, *opt
+00001580: 696f 6e61 6c2a 2c20 6465 6661 756c 7473  ional*, defaults
+00001590: 2074 6f20 6052 6573 616d 706c 696e 672e   to `Resampling.
+000015a0: 4249 4355 4249 4360 293a 0a20 2020 2020  BICUBIC`):.     
+000015b0: 2020 2020 2020 2052 6573 616d 706c 696e         Resamplin
+000015c0: 6720 6669 6c74 6572 2074 6f20 7573 6520  g filter to use 
+000015d0: 6966 2072 6573 697a 696e 6720 7468 6520  if resizing the 
+000015e0: 696d 6167 652e 204f 6e6c 7920 6861 7320  image. Only has 
+000015f0: 616e 2065 6666 6563 7420 6966 2060 646f  an effect if `do
+00001600: 5f72 6573 697a 6560 2069 7320 7365 7420  _resize` is set 
+00001610: 746f 2060 5472 7565 602e 2043 616e 2062  to `True`. Can b
+00001620: 650a 2020 2020 2020 2020 2020 2020 6f76  e.            ov
+00001630: 6572 7269 6464 656e 2062 7920 7468 6520  erridden by the 
+00001640: 6072 6573 616d 706c 6560 2070 6172 616d  `resample` param
+00001650: 6574 6572 2069 6e20 7468 6520 6070 7265  eter in the `pre
+00001660: 7072 6f63 6573 7360 206d 6574 686f 642e  process` method.
+00001670: 0a20 2020 2020 2020 2064 6f5f 7265 7363  .        do_resc
+00001680: 616c 6520 2860 626f 6f6c 602c 202a 6f70  ale (`bool`, *op
+00001690: 7469 6f6e 616c 2a2c 2064 6566 6175 6c74  tional*, default
+000016a0: 7320 746f 2060 5472 7565 6029 3a0a 2020  s to `True`):.  
+000016b0: 2020 2020 2020 2020 2020 5768 6574 6865            Whethe
+000016c0: 7220 746f 2072 6573 6361 6c65 2074 6865  r to rescale the
+000016d0: 2069 6d61 6765 2062 7920 7468 6520 7370   image by the sp
+000016e0: 6563 6966 6965 6420 7363 616c 6520 6072  ecified scale `r
+000016f0: 6573 6361 6c65 5f66 6163 746f 7260 2e20  escale_factor`. 
+00001700: 4361 6e20 6265 206f 7665 7272 6964 6465  Can be overridde
+00001710: 6e20 6279 2074 6865 2060 646f 5f72 6573  n by the `do_res
+00001720: 6361 6c65 600a 2020 2020 2020 2020 2020  cale`.          
+00001730: 2020 7061 7261 6d65 7465 7220 696e 2074    parameter in t
+00001740: 6865 2060 7072 6570 726f 6365 7373 6020  he `preprocess` 
+00001750: 6d65 7468 6f64 2e0a 2020 2020 2020 2020  method..        
+00001760: 7265 7363 616c 655f 6661 6374 6f72 2028  rescale_factor (
+00001770: 6069 6e74 6020 6f72 2060 666c 6f61 7460  `int` or `float`
+00001780: 2c20 2a6f 7074 696f 6e61 6c2a 2c20 6465  , *optional*, de
+00001790: 6661 756c 7473 2074 6f20 6031 2f32 3535  faults to `1/255
+000017a0: 6029 3a0a 2020 2020 2020 2020 2020 2020  `):.            
+000017b0: 5363 616c 6520 6661 6374 6f72 2074 6f20  Scale factor to 
+000017c0: 7573 6520 6966 2072 6573 6361 6c69 6e67  use if rescaling
+000017d0: 2074 6865 2069 6d61 6765 2e20 4f6e 6c79   the image. Only
+000017e0: 2068 6173 2061 6e20 6566 6665 6374 2069   has an effect i
+000017f0: 6620 6064 6f5f 7265 7363 616c 6560 2069  f `do_rescale` i
+00001800: 7320 7365 7420 746f 2060 5472 7565 602e  s set to `True`.
+00001810: 2043 616e 2062 650a 2020 2020 2020 2020   Can be.        
+00001820: 2020 2020 6f76 6572 7269 6464 656e 2062      overridden b
+00001830: 7920 7468 6520 6072 6573 6361 6c65 5f66  y the `rescale_f
+00001840: 6163 746f 7260 2070 6172 616d 6574 6572  actor` parameter
+00001850: 2069 6e20 7468 6520 6070 7265 7072 6f63   in the `preproc
+00001860: 6573 7360 206d 6574 686f 642e 0a20 2020  ess` method..   
+00001870: 2020 2020 2064 6f5f 6e6f 726d 616c 697a       do_normaliz
+00001880: 6520 2860 626f 6f6c 602c 202a 6f70 7469  e (`bool`, *opti
+00001890: 6f6e 616c 2a2c 2064 6566 6175 6c74 7320  onal*, defaults 
+000018a0: 746f 2060 5472 7565 6029 3a0a 2020 2020  to `True`):.    
+000018b0: 2020 2020 2020 2020 5768 6574 6865 7220          Whether 
+000018c0: 746f 206e 6f72 6d61 6c69 7a65 2074 6865  to normalize the
+000018d0: 2069 6d61 6765 2e20 4361 6e20 6265 206f   image. Can be o
+000018e0: 7665 7272 6964 6465 6e20 6279 2074 6865  verridden by the
+000018f0: 2060 646f 5f6e 6f72 6d61 6c69 7a65 6020   `do_normalize` 
+00001900: 7061 7261 6d65 7465 7220 696e 2074 6865  parameter in the
+00001910: 2060 7072 6570 726f 6365 7373 600a 2020   `preprocess`.  
+00001920: 2020 2020 2020 2020 2020 6d65 7468 6f64            method
+00001930: 2e20 4361 6e20 6265 206f 7665 7272 6964  . Can be overrid
+00001940: 6465 6e20 6279 2074 6865 2060 646f 5f6e  den by the `do_n
+00001950: 6f72 6d61 6c69 7a65 6020 7061 7261 6d65  ormalize` parame
+00001960: 7465 7220 696e 2074 6865 2060 7072 6570  ter in the `prep
+00001970: 726f 6365 7373 6020 6d65 7468 6f64 2e0a  rocess` method..
+00001980: 2020 2020 2020 2020 696d 6167 655f 6d65          image_me
+00001990: 616e 2028 6066 6c6f 6174 6020 6f72 2060  an (`float` or `
+000019a0: 4c69 7374 5b66 6c6f 6174 5d60 2c20 2a6f  List[float]`, *o
+000019b0: 7074 696f 6e61 6c2a 2c20 6465 6661 756c  ptional*, defaul
+000019c0: 7473 2074 6f20 6049 4d41 4745 4e45 545f  ts to `IMAGENET_
+000019d0: 5354 414e 4441 5244 5f4d 4541 4e60 293a  STANDARD_MEAN`):
+000019e0: 0a20 2020 2020 2020 2020 2020 204d 6561  .            Mea
+000019f0: 6e20 746f 2075 7365 2069 6620 6e6f 726d  n to use if norm
+00001a00: 616c 697a 696e 6720 7468 6520 696d 6167  alizing the imag
+00001a10: 652e 2054 6869 7320 6973 2061 2066 6c6f  e. This is a flo
+00001a20: 6174 206f 7220 6c69 7374 206f 6620 666c  at or list of fl
+00001a30: 6f61 7473 2074 6865 206c 656e 6774 6820  oats the length 
+00001a40: 6f66 2074 6865 206e 756d 6265 7220 6f66  of the number of
+00001a50: 0a20 2020 2020 2020 2020 2020 2063 6861  .            cha
+00001a60: 6e6e 656c 7320 696e 2074 6865 2069 6d61  nnels in the ima
+00001a70: 6765 2e20 4361 6e20 6265 206f 7665 7272  ge. Can be overr
+00001a80: 6964 6465 6e20 6279 2074 6865 2060 696d  idden by the `im
+00001a90: 6167 655f 6d65 616e 6020 7061 7261 6d65  age_mean` parame
+00001aa0: 7465 7220 696e 2074 6865 2060 7072 6570  ter in the `prep
+00001ab0: 726f 6365 7373 6020 6d65 7468 6f64 2e20  rocess` method. 
+00001ac0: 4361 6e20 6265 0a20 2020 2020 2020 2020  Can be.         
+00001ad0: 2020 206f 7665 7272 6964 6465 6e20 6279     overridden by
+00001ae0: 2074 6865 2060 696d 6167 655f 6d65 616e   the `image_mean
+00001af0: 6020 7061 7261 6d65 7465 7220 696e 2074  ` parameter in t
+00001b00: 6865 2060 7072 6570 726f 6365 7373 6020  he `preprocess` 
+00001b10: 6d65 7468 6f64 2e0a 2020 2020 2020 2020  method..        
+00001b20: 696d 6167 655f 7374 6420 2860 666c 6f61  image_std (`floa
+00001b30: 7460 206f 7220 604c 6973 745b 666c 6f61  t` or `List[floa
+00001b40: 745d 602c 202a 6f70 7469 6f6e 616c 2a2c  t]`, *optional*,
+00001b50: 2064 6566 6175 6c74 7320 746f 2060 494d   defaults to `IM
+00001b60: 4147 454e 4554 5f53 5441 4e44 4152 445f  AGENET_STANDARD_
+00001b70: 5354 4460 293a 0a20 2020 2020 2020 2020  STD`):.         
+00001b80: 2020 2053 7461 6e64 6172 6420 6465 7669     Standard devi
+00001b90: 6174 696f 6e20 746f 2075 7365 2069 6620  ation to use if 
+00001ba0: 6e6f 726d 616c 697a 696e 6720 7468 6520  normalizing the 
+00001bb0: 696d 6167 652e 2054 6869 7320 6973 2061  image. This is a
+00001bc0: 2066 6c6f 6174 206f 7220 6c69 7374 206f   float or list o
+00001bd0: 6620 666c 6f61 7473 2074 6865 206c 656e  f floats the len
+00001be0: 6774 6820 6f66 2074 6865 0a20 2020 2020  gth of the.     
+00001bf0: 2020 2020 2020 206e 756d 6265 7220 6f66         number of
+00001c00: 2063 6861 6e6e 656c 7320 696e 2074 6865   channels in the
+00001c10: 2069 6d61 6765 2e20 4361 6e20 6265 206f   image. Can be o
+00001c20: 7665 7272 6964 6465 6e20 6279 2074 6865  verridden by the
+00001c30: 2060 696d 6167 655f 7374 6460 2070 6172   `image_std` par
+00001c40: 616d 6574 6572 2069 6e20 7468 6520 6070  ameter in the `p
+00001c50: 7265 7072 6f63 6573 7360 206d 6574 686f  reprocess` metho
+00001c60: 642e 0a20 2020 2020 2020 2020 2020 2043  d..            C
+00001c70: 616e 2062 6520 6f76 6572 7269 6464 656e  an be overridden
+00001c80: 2062 7920 7468 6520 6069 6d61 6765 5f73   by the `image_s
+00001c90: 7464 6020 7061 7261 6d65 7465 7220 696e  td` parameter in
+00001ca0: 2074 6865 2060 7072 6570 726f 6365 7373   the `preprocess
+00001cb0: 6020 6d65 7468 6f64 2e0a 2020 2020 2020  ` method..      
+00001cc0: 2020 646f 5f63 656e 7465 725f 6372 6f70    do_center_crop
+00001cd0: 2028 6062 6f6f 6c60 2c20 2a6f 7074 696f   (`bool`, *optio
+00001ce0: 6e61 6c2a 2c20 6465 6661 756c 7473 2074  nal*, defaults t
+00001cf0: 6f20 6054 7275 6560 293a 0a20 2020 2020  o `True`):.     
+00001d00: 2020 2020 2020 2057 6865 7468 6572 2074         Whether t
+00001d10: 6f20 6365 6e74 6572 2063 726f 7020 7468  o center crop th
+00001d20: 6520 696d 6167 652e 2043 616e 2062 6520  e image. Can be 
+00001d30: 6f76 6572 7269 6464 656e 2062 7920 7468  overridden by th
+00001d40: 6520 6064 6f5f 6365 6e74 6572 5f63 726f  e `do_center_cro
+00001d50: 7060 2070 6172 616d 6574 6572 2069 6e20  p` parameter in 
+00001d60: 7468 6520 6070 7265 7072 6f63 6573 7360  the `preprocess`
+00001d70: 0a20 2020 2020 2020 2020 2020 206d 6574  .            met
+00001d80: 686f 642e 0a20 2020 2020 2020 2063 726f  hod..        cro
+00001d90: 705f 7369 7a65 2028 6044 6963 745b 7374  p_size (`Dict[st
+00001da0: 722c 2069 6e74 5d60 2c20 2a6f 7074 696f  r, int]`, *optio
+00001db0: 6e61 6c2a 293a 0a20 2020 2020 2020 2020  nal*):.         
+00001dc0: 2020 2044 6573 6972 6564 206f 7574 7075     Desired outpu
+00001dd0: 7420 7369 7a65 2077 6865 6e20 6170 706c  t size when appl
+00001de0: 7969 6e67 2063 656e 7465 722d 6372 6f70  ying center-crop
+00001df0: 7069 6e67 2e20 4f6e 6c79 2068 6173 2061  ping. Only has a
+00001e00: 6e20 6566 6665 6374 2069 6620 6064 6f5f  n effect if `do_
+00001e10: 6365 6e74 6572 5f63 726f 7060 2069 7320  center_crop` is 
+00001e20: 7365 7420 746f 2060 5472 7565 602e 0a20  set to `True`.. 
+00001e30: 2020 2020 2020 2020 2020 2043 616e 2062             Can b
+00001e40: 6520 6f76 6572 7269 6464 656e 2062 7920  e overridden by 
+00001e50: 7468 6520 6063 726f 705f 7369 7a65 6020  the `crop_size` 
+00001e60: 7061 7261 6d65 7465 7220 696e 2074 6865  parameter in the
+00001e70: 2060 7072 6570 726f 6365 7373 6020 6d65   `preprocess` me
+00001e80: 7468 6f64 2e20 4966 2075 6e73 6574 2064  thod. If unset d
+00001e90: 6566 6175 6c74 7320 746f 2060 7369 7a65  efaults to `size
+00001ea0: 602c 0a20 2020 2020 2020 2064 6f5f 7061  `,.        do_pa
+00001eb0: 6420 2860 626f 6f6c 602c 202a 6f70 7469  d (`bool`, *opti
+00001ec0: 6f6e 616c 2a2c 2064 6566 6175 6c74 7320  onal*, defaults 
+00001ed0: 746f 2060 5472 7565 6029 3a0a 2020 2020  to `True`):.    
+00001ee0: 2020 2020 2020 2020 5768 6574 6865 7220          Whether 
+00001ef0: 746f 2070 6164 2074 6865 2069 6d61 6765  to pad the image
+00001f00: 2074 6f20 7468 6520 6028 6d61 785f 6865   to the `(max_he
+00001f10: 6967 6874 2c20 6d61 785f 7769 6474 6829  ight, max_width)
+00001f20: 6020 6f66 2074 6865 2069 6d61 6765 7320  ` of the images 
+00001f30: 696e 2074 6865 2062 6174 6368 2e20 4361  in the batch. Ca
+00001f40: 6e20 6265 206f 7665 7272 6964 6465 6e20  n be overridden 
+00001f50: 6279 0a20 2020 2020 2020 2020 2020 2074  by.            t
+00001f60: 6865 2060 646f 5f70 6164 6020 7061 7261  he `do_pad` para
+00001f70: 6d65 7465 7220 696e 2074 6865 2060 7072  meter in the `pr
+00001f80: 6570 726f 6365 7373 6020 6d65 7468 6f64  eprocess` method
+00001f90: 2e0a 2020 2020 2222 220a 0a20 2020 206d  ..    """..    m
+00001fa0: 6f64 656c 5f69 6e70 7574 5f6e 616d 6573  odel_input_names
+00001fb0: 203d 205b 2270 6978 656c 5f76 616c 7565   = ["pixel_value
+00001fc0: 7322 5d0a 0a20 2020 2064 6566 205f 5f69  s"]..    def __i
+00001fd0: 6e69 745f 5f28 0a20 2020 2020 2020 2073  nit__(.        s
+00001fe0: 656c 662c 0a20 2020 2020 2020 2064 6f5f  elf,.        do_
+00001ff0: 7265 7369 7a65 3a20 626f 6f6c 203d 2054  resize: bool = T
+00002000: 7275 652c 0a20 2020 2020 2020 2073 697a  rue,.        siz
+00002010: 653a 2044 6963 745b 7374 722c 2069 6e74  e: Dict[str, int
+00002020: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+00002030: 2020 7369 7a65 5f64 6976 6973 6f72 3a20    size_divisor: 
+00002040: 696e 7420 3d20 3332 2c0a 2020 2020 2020  int = 32,.      
+00002050: 2020 7265 7361 6d70 6c65 3a20 5049 4c49    resample: PILI
+00002060: 6d61 6765 5265 7361 6d70 6c69 6e67 203d  mageResampling =
+00002070: 2050 494c 496d 6167 6552 6573 616d 706c   PILImageResampl
+00002080: 696e 672e 4249 4355 4249 432c 0a20 2020  ing.BICUBIC,.   
+00002090: 2020 2020 2064 6f5f 7265 7363 616c 653a       do_rescale:
+000020a0: 2062 6f6f 6c20 3d20 5472 7565 2c0a 2020   bool = True,.  
+000020b0: 2020 2020 2020 7265 7363 616c 655f 6661        rescale_fa
+000020c0: 6374 6f72 3a20 556e 696f 6e5b 696e 742c  ctor: Union[int,
+000020d0: 2066 6c6f 6174 5d20 3d20 3120 2f20 3235   float] = 1 / 25
+000020e0: 352c 0a20 2020 2020 2020 2064 6f5f 6e6f  5,.        do_no
+000020f0: 726d 616c 697a 653a 2062 6f6f 6c20 3d20  rmalize: bool = 
+00002100: 5472 7565 2c0a 2020 2020 2020 2020 696d  True,.        im
+00002110: 6167 655f 6d65 616e 3a20 4f70 7469 6f6e  age_mean: Option
+00002120: 616c 5b55 6e69 6f6e 5b66 6c6f 6174 2c20  al[Union[float, 
+00002130: 4c69 7374 5b66 6c6f 6174 5d5d 5d20 3d20  List[float]]] = 
+00002140: 4e6f 6e65 2c0a 2020 2020 2020 2020 696d  None,.        im
+00002150: 6167 655f 7374 643a 204f 7074 696f 6e61  age_std: Optiona
+00002160: 6c5b 556e 696f 6e5b 666c 6f61 742c 204c  l[Union[float, L
+00002170: 6973 745b 666c 6f61 745d 5d5d 203d 204e  ist[float]]] = N
+00002180: 6f6e 652c 0a20 2020 2020 2020 2064 6f5f  one,.        do_
+00002190: 6365 6e74 6572 5f63 726f 703a 2062 6f6f  center_crop: boo
+000021a0: 6c20 3d20 5472 7565 2c0a 2020 2020 2020  l = True,.      
+000021b0: 2020 6372 6f70 5f73 697a 653a 2044 6963    crop_size: Dic
+000021c0: 745b 7374 722c 2069 6e74 5d20 3d20 4e6f  t[str, int] = No
+000021d0: 6e65 2c0a 2020 2020 2020 2020 646f 5f70  ne,.        do_p
+000021e0: 6164 3a20 626f 6f6c 203d 2054 7275 652c  ad: bool = True,
+000021f0: 0a20 2020 2020 2020 202a 2a6b 7761 7267  .        **kwarg
+00002200: 732c 0a20 2020 2029 202d 3e20 4e6f 6e65  s,.    ) -> None
+00002210: 3a0a 2020 2020 2020 2020 6966 2022 7061  :.        if "pa
+00002220: 645f 616e 645f 7265 7475 726e 5f70 6978  d_and_return_pix
+00002230: 656c 5f6d 6173 6b22 2069 6e20 6b77 6172  el_mask" in kwar
+00002240: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
+00002250: 646f 5f70 6164 203d 206b 7761 7267 732e  do_pad = kwargs.
+00002260: 706f 7028 2270 6164 5f61 6e64 5f72 6574  pop("pad_and_ret
+00002270: 7572 6e5f 7069 7865 6c5f 6d61 736b 2229  urn_pixel_mask")
+00002280: 0a0a 2020 2020 2020 2020 7375 7065 7228  ..        super(
+00002290: 292e 5f5f 696e 6974 5f5f 282a 2a6b 7761  ).__init__(**kwa
+000022a0: 7267 7329 0a20 2020 2020 2020 2073 697a  rgs).        siz
+000022b0: 6520 3d20 7369 7a65 2069 6620 7369 7a65  e = size if size
+000022c0: 2069 7320 6e6f 7420 4e6f 6e65 2065 6c73   is not None els
+000022d0: 6520 7b22 7368 6f72 7465 7374 5f65 6467  e {"shortest_edg
+000022e0: 6522 3a20 3238 387d 0a20 2020 2020 2020  e": 288}.       
+000022f0: 2073 697a 6520 3d20 6765 745f 7369 7a65   size = get_size
+00002300: 5f64 6963 7428 7369 7a65 2c20 6465 6661  _dict(size, defa
+00002310: 756c 745f 746f 5f73 7175 6172 653d 4661  ult_to_square=Fa
+00002320: 6c73 6529 0a0a 2020 2020 2020 2020 7365  lse)..        se
+00002330: 6c66 2e64 6f5f 7265 7369 7a65 203d 2064  lf.do_resize = d
+00002340: 6f5f 7265 7369 7a65 0a20 2020 2020 2020  o_resize.       
+00002350: 2073 656c 662e 7369 7a65 203d 2073 697a   self.size = siz
+00002360: 650a 2020 2020 2020 2020 7365 6c66 2e73  e.        self.s
+00002370: 697a 655f 6469 7669 736f 7220 3d20 7369  ize_divisor = si
+00002380: 7a65 5f64 6976 6973 6f72 0a20 2020 2020  ze_divisor.     
+00002390: 2020 2073 656c 662e 7265 7361 6d70 6c65     self.resample
+000023a0: 203d 2072 6573 616d 706c 650a 2020 2020   = resample.    
+000023b0: 2020 2020 7365 6c66 2e64 6f5f 7265 7363      self.do_resc
+000023c0: 616c 6520 3d20 646f 5f72 6573 6361 6c65  ale = do_rescale
+000023d0: 0a20 2020 2020 2020 2073 656c 662e 7265  .        self.re
+000023e0: 7363 616c 655f 6661 6374 6f72 203d 2072  scale_factor = r
+000023f0: 6573 6361 6c65 5f66 6163 746f 720a 2020  escale_factor.  
+00002400: 2020 2020 2020 7365 6c66 2e64 6f5f 6e6f        self.do_no
+00002410: 726d 616c 697a 6520 3d20 646f 5f6e 6f72  rmalize = do_nor
+00002420: 6d61 6c69 7a65 0a20 2020 2020 2020 2073  malize.        s
+00002430: 656c 662e 696d 6167 655f 6d65 616e 203d  elf.image_mean =
+00002440: 2069 6d61 6765 5f6d 6561 6e20 6966 2069   image_mean if i
+00002450: 6d61 6765 5f6d 6561 6e20 6973 206e 6f74  mage_mean is not
+00002460: 204e 6f6e 6520 656c 7365 204f 5045 4e41   None else OPENA
+00002470: 495f 434c 4950 5f4d 4541 4e0a 2020 2020  I_CLIP_MEAN.    
+00002480: 2020 2020 7365 6c66 2e69 6d61 6765 5f73      self.image_s
+00002490: 7464 203d 2069 6d61 6765 5f73 7464 2069  td = image_std i
+000024a0: 6620 696d 6167 655f 7374 6420 6973 206e  f image_std is n
+000024b0: 6f74 204e 6f6e 6520 656c 7365 204f 5045  ot None else OPE
+000024c0: 4e41 495f 434c 4950 5f53 5444 0a20 2020  NAI_CLIP_STD.   
+000024d0: 2020 2020 2073 656c 662e 646f 5f70 6164       self.do_pad
+000024e0: 203d 2064 6f5f 7061 640a 2020 2020 2020   = do_pad.      
+000024f0: 2020 7365 6c66 2e64 6f5f 6365 6e74 6572    self.do_center
+00002500: 5f63 726f 7020 3d20 646f 5f63 656e 7465  _crop = do_cente
+00002510: 725f 6372 6f70 0a20 2020 2020 2020 2073  r_crop.        s
+00002520: 656c 662e 6372 6f70 5f73 697a 6520 3d20  elf.crop_size = 
+00002530: 6372 6f70 5f73 697a 650a 2020 2020 2020  crop_size.      
+00002540: 2020 7365 6c66 2e5f 7661 6c69 645f 7072    self._valid_pr
+00002550: 6f63 6573 736f 725f 6b65 7973 203d 205b  ocessor_keys = [
+00002560: 0a20 2020 2020 2020 2020 2020 2022 696d  .            "im
+00002570: 6167 6573 222c 0a20 2020 2020 2020 2020  ages",.         
+00002580: 2020 2022 646f 5f72 6573 697a 6522 2c0a     "do_resize",.
+00002590: 2020 2020 2020 2020 2020 2020 2273 697a              "siz
+000025a0: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
+000025b0: 2273 697a 655f 6469 7669 736f 7222 2c0a  "size_divisor",.
+000025c0: 2020 2020 2020 2020 2020 2020 2272 6573              "res
+000025d0: 616d 706c 6522 2c0a 2020 2020 2020 2020  ample",.        
+000025e0: 2020 2020 2264 6f5f 7265 7363 616c 6522      "do_rescale"
+000025f0: 2c0a 2020 2020 2020 2020 2020 2020 2272  ,.            "r
+00002600: 6573 6361 6c65 5f66 6163 746f 7222 2c0a  escale_factor",.
+00002610: 2020 2020 2020 2020 2020 2020 2264 6f5f              "do_
+00002620: 6e6f 726d 616c 697a 6522 2c0a 2020 2020  normalize",.    
+00002630: 2020 2020 2020 2020 2269 6d61 6765 5f6d          "image_m
+00002640: 6561 6e22 2c0a 2020 2020 2020 2020 2020  ean",.          
+00002650: 2020 2269 6d61 6765 5f73 7464 222c 0a20    "image_std",. 
+00002660: 2020 2020 2020 2020 2020 2022 646f 5f70             "do_p
+00002670: 6164 222c 0a20 2020 2020 2020 2020 2020  ad",.           
+00002680: 2022 646f 5f63 656e 7465 725f 6372 6f70   "do_center_crop
+00002690: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
+000026a0: 6372 6f70 5f73 697a 6522 2c0a 2020 2020  crop_size",.    
+000026b0: 2020 2020 2020 2020 2272 6574 7572 6e5f          "return_
+000026c0: 7465 6e73 6f72 7322 2c0a 2020 2020 2020  tensors",.      
+000026d0: 2020 2020 2020 2264 6174 615f 666f 726d        "data_form
+000026e0: 6174 222c 0a20 2020 2020 2020 2020 2020  at",.           
+000026f0: 2022 696e 7075 745f 6461 7461 5f66 6f72   "input_data_for
+00002700: 6d61 7422 2c0a 2020 2020 2020 2020 5d0a  mat",.        ].
+00002710: 0a20 2020 2023 2043 6f70 6965 6420 6672  .    # Copied fr
+00002720: 6f6d 2074 7261 6e73 666f 726d 6572 732e  om transformers.
+00002730: 6d6f 6465 6c73 2e76 696c 742e 696d 6167  models.vilt.imag
+00002740: 655f 7072 6f63 6573 7369 6e67 5f76 696c  e_processing_vil
+00002750: 742e 5669 6c74 496d 6167 6550 726f 6365  t.ViltImageProce
+00002760: 7373 6f72 2e72 6573 697a 650a 2020 2020  ssor.resize.    
+00002770: 6465 6620 7265 7369 7a65 280a 2020 2020  def resize(.    
+00002780: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+00002790: 2020 696d 6167 653a 206e 702e 6e64 6172    image: np.ndar
+000027a0: 7261 792c 0a20 2020 2020 2020 2073 697a  ray,.        siz
+000027b0: 653a 2044 6963 745b 7374 722c 2069 6e74  e: Dict[str, int
+000027c0: 5d2c 0a20 2020 2020 2020 2073 697a 655f  ],.        size_
+000027d0: 6469 7669 736f 723a 2069 6e74 203d 2033  divisor: int = 3
+000027e0: 322c 0a20 2020 2020 2020 2072 6573 616d  2,.        resam
+000027f0: 706c 653a 2050 494c 496d 6167 6552 6573  ple: PILImageRes
+00002800: 616d 706c 696e 6720 3d20 5049 4c49 6d61  ampling = PILIma
+00002810: 6765 5265 7361 6d70 6c69 6e67 2e42 4943  geResampling.BIC
+00002820: 5542 4943 2c0a 2020 2020 2020 2020 6461  UBIC,.        da
+00002830: 7461 5f66 6f72 6d61 743a 204f 7074 696f  ta_format: Optio
+00002840: 6e61 6c5b 556e 696f 6e5b 7374 722c 2043  nal[Union[str, C
+00002850: 6861 6e6e 656c 4469 6d65 6e73 696f 6e5d  hannelDimension]
+00002860: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+00002870: 2020 696e 7075 745f 6461 7461 5f66 6f72    input_data_for
+00002880: 6d61 743a 204f 7074 696f 6e61 6c5b 556e  mat: Optional[Un
+00002890: 696f 6e5b 7374 722c 2043 6861 6e6e 656c  ion[str, Channel
+000028a0: 4469 6d65 6e73 696f 6e5d 5d20 3d20 4e6f  Dimension]] = No
+000028b0: 6e65 2c0a 2020 2020 2020 2020 2a2a 6b77  ne,.        **kw
+000028c0: 6172 6773 2c0a 2020 2020 2920 2d3e 206e  args,.    ) -> n
+000028d0: 702e 6e64 6172 7261 793a 0a20 2020 2020  p.ndarray:.     
+000028e0: 2020 2022 2222 0a20 2020 2020 2020 2052     """.        R
+000028f0: 6573 697a 6520 616e 2069 6d61 6765 2e0a  esize an image..
+00002900: 0a20 2020 2020 2020 2052 6573 697a 6573  .        Resizes
+00002910: 2074 6865 2073 686f 7274 6572 2073 6964   the shorter sid
+00002920: 6520 6f66 2074 6865 2069 6d61 6765 2074  e of the image t
+00002930: 6f20 6073 697a 655b 2273 686f 7274 6573  o `size["shortes
+00002940: 745f 6564 6765 225d 6020 7768 696c 6520  t_edge"]` while 
+00002950: 7072 6573 6572 7669 6e67 2074 6865 2061  preserving the a
+00002960: 7370 6563 7420 7261 7469 6f2e 2049 6620  spect ratio. If 
+00002970: 7468 650a 2020 2020 2020 2020 6c6f 6e67  the.        long
+00002980: 6572 2073 6964 6520 6973 206c 6172 6765  er side is large
+00002990: 7220 7468 616e 2074 6865 206d 6178 2073  r than the max s
+000029a0: 697a 6520 6028 696e 7428 6073 697a 655b  ize `(int(`size[
+000029b0: 2273 686f 7274 6573 745f 6564 6765 225d  "shortest_edge"]
+000029c0: 6020 2a20 3133 3333 202f 2038 3030 2929  ` * 1333 / 800))
+000029d0: 602c 2074 6865 206c 6f6e 6765 7220 7369  `, the longer si
+000029e0: 6465 2069 7320 7468 656e 0a20 2020 2020  de is then.     
+000029f0: 2020 2072 6573 697a 6564 2074 6f20 7468     resized to th
+00002a00: 6520 6d61 7820 7369 7a65 2077 6869 6c65  e max size while
+00002a10: 2070 7265 7365 7276 696e 6720 7468 6520   preserving the 
+00002a20: 6173 7065 6374 2072 6174 696f 2e0a 0a20  aspect ratio... 
+00002a30: 2020 2020 2020 2041 7267 733a 0a20 2020         Args:.   
+00002a40: 2020 2020 2020 2020 2069 6d61 6765 2028           image (
+00002a50: 606e 702e 6e64 6172 7261 7960 293a 0a20  `np.ndarray`):. 
+00002a60: 2020 2020 2020 2020 2020 2020 2020 2049                 I
+00002a70: 6d61 6765 2074 6f20 7265 7369 7a65 2e0a  mage to resize..
+00002a80: 2020 2020 2020 2020 2020 2020 7369 7a65              size
+00002a90: 2028 6044 6963 745b 7374 722c 2069 6e74   (`Dict[str, int
+00002aa0: 5d60 293a 0a20 2020 2020 2020 2020 2020  ]`):.           
+00002ab0: 2020 2020 2043 6f6e 7472 6f6c 7320 7468       Controls th
+00002ac0: 6520 7369 7a65 206f 6620 7468 6520 6f75  e size of the ou
+00002ad0: 7470 7574 2069 6d61 6765 2e20 5368 6f75  tput image. Shou
+00002ae0: 6c64 2062 6520 6f66 2074 6865 2066 6f72  ld be of the for
+00002af0: 6d20 607b 2273 686f 7274 6573 745f 6564  m `{"shortest_ed
+00002b00: 6765 223a 2069 6e74 7d60 2e0a 2020 2020  ge": int}`..    
+00002b10: 2020 2020 2020 2020 7369 7a65 5f64 6976          size_div
+00002b20: 6973 6f72 2028 6069 6e74 602c 2064 6566  isor (`int`, def
+00002b30: 6175 6c74 7320 746f 2033 3229 3a0a 2020  aults to 32):.  
+00002b40: 2020 2020 2020 2020 2020 2020 2020 5468                Th
+00002b50: 6520 696d 6167 6520 6973 2072 6573 697a  e image is resiz
+00002b60: 6564 2074 6f20 6120 7369 7a65 2074 6861  ed to a size tha
+00002b70: 7420 6973 2061 206d 756c 7469 706c 6520  t is a multiple 
+00002b80: 6f66 2074 6869 7320 7661 6c75 652e 0a20  of this value.. 
+00002b90: 2020 2020 2020 2020 2020 2072 6573 616d             resam
+00002ba0: 706c 6520 2860 5049 4c49 6d61 6765 5265  ple (`PILImageRe
+00002bb0: 7361 6d70 6c69 6e67 6020 6669 6c74 6572  sampling` filter
+00002bc0: 2c20 2a6f 7074 696f 6e61 6c2a 2c20 6465  , *optional*, de
+00002bd0: 6661 756c 7473 2074 6f20 6050 494c 496d  faults to `PILIm
+00002be0: 6167 6552 6573 616d 706c 696e 672e 4249  ageResampling.BI
+00002bf0: 4355 4249 4360 293a 0a20 2020 2020 2020  CUBIC`):.       
+00002c00: 2020 2020 2020 2020 2052 6573 616d 706c           Resampl
+00002c10: 696e 6720 6669 6c74 6572 2074 6f20 7573  ing filter to us
+00002c20: 6520 7768 656e 2072 6573 6969 7a69 6e67  e when resiizing
+00002c30: 2074 6865 2069 6d61 6765 2e0a 2020 2020   the image..    
+00002c40: 2020 2020 2020 2020 6461 7461 5f66 6f72          data_for
+00002c50: 6d61 7420 2860 7374 7260 206f 7220 6043  mat (`str` or `C
+00002c60: 6861 6e6e 656c 4469 6d65 6e73 696f 6e60  hannelDimension`
+00002c70: 2c20 2a6f 7074 696f 6e61 6c2a 293a 0a20  , *optional*):. 
+00002c80: 2020 2020 2020 2020 2020 2020 2020 2054                 T
+00002c90: 6865 2063 6861 6e6e 656c 2064 696d 656e  he channel dimen
+00002ca0: 7369 6f6e 2066 6f72 6d61 7420 6f66 2074  sion format of t
+00002cb0: 6865 2069 6d61 6765 2e20 4966 206e 6f74  he image. If not
+00002cc0: 2070 726f 7669 6465 642c 2069 7420 7769   provided, it wi
+00002cd0: 6c6c 2062 6520 7468 6520 7361 6d65 2061  ll be the same a
+00002ce0: 7320 7468 6520 696e 7075 7420 696d 6167  s the input imag
+00002cf0: 652e 0a20 2020 2020 2020 2020 2020 2069  e..            i
+00002d00: 6e70 7574 5f64 6174 615f 666f 726d 6174  nput_data_format
+00002d10: 2028 6073 7472 6020 6f72 2060 4368 616e   (`str` or `Chan
+00002d20: 6e65 6c44 696d 656e 7369 6f6e 602c 202a  nelDimension`, *
+00002d30: 6f70 7469 6f6e 616c 2a29 3a0a 2020 2020  optional*):.    
+00002d40: 2020 2020 2020 2020 2020 2020 5468 6520              The 
+00002d50: 6368 616e 6e65 6c20 6469 6d65 6e73 696f  channel dimensio
+00002d60: 6e20 666f 726d 6174 206f 6620 7468 6520  n format of the 
+00002d70: 696e 7075 7420 696d 6167 652e 2049 6620  input image. If 
+00002d80: 6e6f 7420 7072 6f76 6964 6564 2c20 6974  not provided, it
+00002d90: 2077 696c 6c20 6265 2069 6e66 6572 7265   will be inferre
+00002da0: 642e 0a20 2020 2020 2020 2022 2222 0a20  d..        """. 
+00002db0: 2020 2020 2020 2073 697a 6520 3d20 6765         size = ge
+00002dc0: 745f 7369 7a65 5f64 6963 7428 7369 7a65  t_size_dict(size
+00002dd0: 2c20 6465 6661 756c 745f 746f 5f73 7175  , default_to_squ
+00002de0: 6172 653d 4661 6c73 6529 0a20 2020 2020  are=False).     
+00002df0: 2020 2069 6620 2273 686f 7274 6573 745f     if "shortest_
+00002e00: 6564 6765 2220 6e6f 7420 696e 2073 697a  edge" not in siz
+00002e10: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+00002e20: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
+00002e30: 6622 5468 6520 6073 697a 6560 2064 6963  f"The `size` dic
+00002e40: 7469 6f6e 6172 7920 6d75 7374 2063 6f6e  tionary must con
+00002e50: 7461 696e 2074 6865 206b 6579 2060 7368  tain the key `sh
+00002e60: 6f72 7465 7374 5f65 6467 6560 2e20 476f  ortest_edge`. Go
+00002e70: 7420 7b73 697a 652e 6b65 7973 2829 7d22  t {size.keys()}"
+00002e80: 290a 2020 2020 2020 2020 7368 6f72 7465  ).        shorte
+00002e90: 7220 3d20 7369 7a65 5b22 7368 6f72 7465  r = size["shorte
+00002ea0: 7374 5f65 6467 6522 5d0a 2020 2020 2020  st_edge"].      
+00002eb0: 2020 6c6f 6e67 6572 203d 2069 6e74 2831    longer = int(1
+00002ec0: 3333 3320 2f20 3830 3020 2a20 7368 6f72  333 / 800 * shor
+00002ed0: 7465 7229 0a20 2020 2020 2020 206f 7574  ter).        out
+00002ee0: 7075 745f 7369 7a65 203d 2067 6574 5f72  put_size = get_r
+00002ef0: 6573 697a 655f 6f75 7470 7574 5f69 6d61  esize_output_ima
+00002f00: 6765 5f73 697a 6528 0a20 2020 2020 2020  ge_size(.       
+00002f10: 2020 2020 2069 6d61 6765 2c20 7368 6f72       image, shor
+00002f20: 7465 723d 7368 6f72 7465 722c 206c 6f6e  ter=shorter, lon
+00002f30: 6765 723d 6c6f 6e67 6572 2c20 7369 7a65  ger=longer, size
+00002f40: 5f64 6976 6973 6f72 3d73 697a 655f 6469  _divisor=size_di
+00002f50: 7669 736f 722c 2069 6e70 7574 5f64 6174  visor, input_dat
+00002f60: 615f 666f 726d 6174 3d69 6e70 7574 5f64  a_format=input_d
+00002f70: 6174 615f 666f 726d 6174 0a20 2020 2020  ata_format.     
+00002f80: 2020 2029 0a20 2020 2020 2020 2072 6574     ).        ret
+00002f90: 7572 6e20 7265 7369 7a65 280a 2020 2020  urn resize(.    
+00002fa0: 2020 2020 2020 2020 696d 6167 652c 0a20          image,. 
+00002fb0: 2020 2020 2020 2020 2020 2073 697a 653d             size=
+00002fc0: 6f75 7470 7574 5f73 697a 652c 0a20 2020  output_size,.   
+00002fd0: 2020 2020 2020 2020 2072 6573 616d 706c           resampl
+00002fe0: 653d 7265 7361 6d70 6c65 2c0a 2020 2020  e=resample,.    
+00002ff0: 2020 2020 2020 2020 6461 7461 5f66 6f72          data_for
+00003000: 6d61 743d 6461 7461 5f66 6f72 6d61 742c  mat=data_format,
+00003010: 0a20 2020 2020 2020 2020 2020 2069 6e70  .            inp
+00003020: 7574 5f64 6174 615f 666f 726d 6174 3d69  ut_data_format=i
+00003030: 6e70 7574 5f64 6174 615f 666f 726d 6174  nput_data_format
+00003040: 2c0a 2020 2020 2020 2020 2020 2020 2a2a  ,.            **
+00003050: 6b77 6172 6773 2c0a 2020 2020 2020 2020  kwargs,.        
+00003060: 290a 0a20 2020 2064 6566 2063 656e 7465  )..    def cente
+00003070: 725f 6372 6f70 280a 2020 2020 2020 2020  r_crop(.        
+00003080: 7365 6c66 2c0a 2020 2020 2020 2020 696d  self,.        im
+00003090: 6167 653a 206e 702e 6e64 6172 7261 792c  age: np.ndarray,
+000030a0: 0a20 2020 2020 2020 2073 697a 653a 2044  .        size: D
+000030b0: 6963 745b 7374 722c 2069 6e74 5d2c 0a20  ict[str, int],. 
+000030c0: 2020 2020 2020 2064 6174 615f 666f 726d         data_form
+000030d0: 6174 3a20 4f70 7469 6f6e 616c 5b55 6e69  at: Optional[Uni
+000030e0: 6f6e 5b73 7472 2c20 4368 616e 6e65 6c44  on[str, ChannelD
+000030f0: 696d 656e 7369 6f6e 5d5d 203d 204e 6f6e  imension]] = Non
+00003100: 652c 0a20 2020 2020 2020 2069 6e70 7574  e,.        input
+00003110: 5f64 6174 615f 666f 726d 6174 3a20 4f70  _data_format: Op
+00003120: 7469 6f6e 616c 5b55 6e69 6f6e 5b73 7472  tional[Union[str
+00003130: 2c20 4368 616e 6e65 6c44 696d 656e 7369  , ChannelDimensi
+00003140: 6f6e 5d5d 203d 204e 6f6e 652c 0a20 2020  on]] = None,.   
+00003150: 2020 2020 202a 2a6b 7761 7267 732c 0a20       **kwargs,. 
+00003160: 2020 2029 202d 3e20 6e70 2e6e 6461 7272     ) -> np.ndarr
+00003170: 6179 3a0a 2020 2020 2020 2020 2222 220a  ay:.        """.
+00003180: 2020 2020 2020 2020 4365 6e74 6572 2063          Center c
+00003190: 726f 7020 616e 2069 6d61 6765 2074 6f20  rop an image to 
+000031a0: 6028 7369 7a65 5b22 6865 6967 6874 225d  `(size["height"]
+000031b0: 2c20 7369 7a65 5b22 7769 6474 6822 5d29  , size["width"])
+000031c0: 602e 2049 6620 7468 6520 696e 7075 7420  `. If the input 
+000031d0: 7369 7a65 2069 7320 736d 616c 6c65 7220  size is smaller 
+000031e0: 7468 616e 2060 6372 6f70 5f73 697a 6560  than `crop_size`
+000031f0: 2061 6c6f 6e67 0a20 2020 2020 2020 2061   along.        a
+00003200: 6e79 2065 6467 652c 2074 6865 2069 6d61  ny edge, the ima
+00003210: 6765 2069 7320 7061 6464 6564 2077 6974  ge is padded wit
+00003220: 6820 3027 7320 616e 6420 7468 656e 2063  h 0's and then c
+00003230: 656e 7465 7220 6372 6f70 7065 642e 0a0a  enter cropped...
+00003240: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
+00003250: 2020 2020 2020 2020 2020 696d 6167 6520            image 
+00003260: 2860 6e70 2e6e 6461 7272 6179 6029 3a0a  (`np.ndarray`):.
+00003270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003280: 496d 6167 6520 746f 2063 656e 7465 7220  Image to center 
+00003290: 6372 6f70 2e0a 2020 2020 2020 2020 2020  crop..          
+000032a0: 2020 7369 7a65 2028 6044 6963 745b 7374    size (`Dict[st
+000032b0: 722c 2069 6e74 5d60 293a 0a20 2020 2020  r, int]`):.     
+000032c0: 2020 2020 2020 2020 2020 2053 697a 6520             Size 
+000032d0: 6f66 2074 6865 206f 7574 7075 7420 696d  of the output im
+000032e0: 6167 6520 696e 2074 6865 2066 6f72 6d20  age in the form 
+000032f0: 607b 2268 6569 6768 7422 3a20 682c 2022  `{"height": h, "
+00003300: 7769 6474 6822 3a20 777d 602e 0a20 2020  width": w}`..   
+00003310: 2020 2020 2020 2020 2064 6174 615f 666f           data_fo
+00003320: 726d 6174 2028 6073 7472 6020 6f72 2060  rmat (`str` or `
+00003330: 4368 616e 6e65 6c44 696d 656e 7369 6f6e  ChannelDimension
+00003340: 602c 202a 6f70 7469 6f6e 616c 2a29 3a0a  `, *optional*):.
+00003350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003360: 5468 6520 6368 616e 6e65 6c20 6469 6d65  The channel dime
+00003370: 6e73 696f 6e20 666f 726d 6174 206f 6620  nsion format of 
+00003380: 7468 6520 696d 6167 652e 2049 6620 6e6f  the image. If no
+00003390: 7420 7072 6f76 6964 6564 2c20 6974 2077  t provided, it w
+000033a0: 696c 6c20 6265 2074 6865 2073 616d 6520  ill be the same 
+000033b0: 6173 2074 6865 2069 6e70 7574 2069 6d61  as the input ima
+000033c0: 6765 2e0a 2020 2020 2020 2020 2020 2020  ge..            
+000033d0: 696e 7075 745f 6461 7461 5f66 6f72 6d61  input_data_forma
+000033e0: 7420 2860 4368 616e 6e65 6c44 696d 656e  t (`ChannelDimen
+000033f0: 7369 6f6e 6020 6f72 2060 7374 7260 2c20  sion` or `str`, 
+00003400: 2a6f 7074 696f 6e61 6c2a 293a 0a20 2020  *optional*):.   
+00003410: 2020 2020 2020 2020 2020 2020 2054 6865               The
+00003420: 2063 6861 6e6e 656c 2064 696d 656e 7369   channel dimensi
+00003430: 6f6e 2066 6f72 6d61 7420 6f66 2074 6865  on format of the
+00003440: 2069 6e70 7574 2069 6d61 6765 2e20 4966   input image. If
+00003450: 206e 6f74 2070 726f 7669 6465 642c 2069   not provided, i
+00003460: 7420 7769 6c6c 2062 6520 696e 6665 7272  t will be inferr
+00003470: 6564 2066 726f 6d20 7468 6520 696e 7075  ed from the inpu
+00003480: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
+00003490: 2020 696d 6167 652e 0a20 2020 2020 2020    image..       
+000034a0: 2022 2222 0a20 2020 2020 2020 206f 7574   """.        out
+000034b0: 7075 745f 7369 7a65 203d 2073 697a 655b  put_size = size[
+000034c0: 2273 686f 7274 6573 745f 6564 6765 225d  "shortest_edge"]
+000034d0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000034e0: 6365 6e74 6572 5f63 726f 7028 0a20 2020  center_crop(.   
+000034f0: 2020 2020 2020 2020 2069 6d61 6765 2c0a           image,.
+00003500: 2020 2020 2020 2020 2020 2020 7369 7a65              size
+00003510: 3d28 6f75 7470 7574 5f73 697a 652c 206f  =(output_size, o
+00003520: 7574 7075 745f 7369 7a65 292c 0a20 2020  utput_size),.   
+00003530: 2020 2020 2020 2020 2064 6174 615f 666f           data_fo
+00003540: 726d 6174 3d64 6174 615f 666f 726d 6174  rmat=data_format
+00003550: 2c0a 2020 2020 2020 2020 2020 2020 696e  ,.            in
+00003560: 7075 745f 6461 7461 5f66 6f72 6d61 743d  put_data_format=
+00003570: 696e 7075 745f 6461 7461 5f66 6f72 6d61  input_data_forma
+00003580: 742c 0a20 2020 2020 2020 2020 2020 202a  t,.            *
+00003590: 2a6b 7761 7267 732c 0a20 2020 2020 2020  *kwargs,.       
+000035a0: 2029 0a0a 2020 2020 2320 436f 7069 6564   )..    # Copied
+000035b0: 2066 726f 6d20 7472 616e 7366 6f72 6d65   from transforme
+000035c0: 7273 2e6d 6f64 656c 732e 7669 6c74 2e69  rs.models.vilt.i
+000035d0: 6d61 6765 5f70 726f 6365 7373 696e 675f  mage_processing_
+000035e0: 7669 6c74 2e56 696c 7449 6d61 6765 5072  vilt.ViltImagePr
+000035f0: 6f63 6573 736f 722e 5f70 6164 5f69 6d61  ocessor._pad_ima
+00003600: 6765 0a20 2020 2064 6566 205f 7061 645f  ge.    def _pad_
+00003610: 696d 6167 6528 0a20 2020 2020 2020 2073  image(.        s
+00003620: 656c 662c 0a20 2020 2020 2020 2069 6d61  elf,.        ima
+00003630: 6765 3a20 6e70 2e6e 6461 7272 6179 2c0a  ge: np.ndarray,.
+00003640: 2020 2020 2020 2020 6f75 7470 7574 5f73          output_s
+00003650: 697a 653a 2054 7570 6c65 5b69 6e74 2c20  ize: Tuple[int, 
+00003660: 696e 745d 2c0a 2020 2020 2020 2020 636f  int],.        co
+00003670: 6e73 7461 6e74 5f76 616c 7565 733a 2055  nstant_values: U
+00003680: 6e69 6f6e 5b66 6c6f 6174 2c20 4974 6572  nion[float, Iter
+00003690: 6162 6c65 5b66 6c6f 6174 5d5d 203d 2030  able[float]] = 0
+000036a0: 2c0a 2020 2020 2020 2020 6461 7461 5f66  ,.        data_f
+000036b0: 6f72 6d61 743a 204f 7074 696f 6e61 6c5b  ormat: Optional[
+000036c0: 4368 616e 6e65 6c44 696d 656e 7369 6f6e  ChannelDimension
+000036d0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+000036e0: 2020 696e 7075 745f 6461 7461 5f66 6f72    input_data_for
+000036f0: 6d61 743a 204f 7074 696f 6e61 6c5b 556e  mat: Optional[Un
+00003700: 696f 6e5b 7374 722c 2043 6861 6e6e 656c  ion[str, Channel
+00003710: 4469 6d65 6e73 696f 6e5d 5d20 3d20 4e6f  Dimension]] = No
+00003720: 6e65 2c0a 2020 2020 2920 2d3e 206e 702e  ne,.    ) -> np.
+00003730: 6e64 6172 7261 793a 0a20 2020 2020 2020  ndarray:.       
+00003740: 2022 2222 0a20 2020 2020 2020 2050 6164   """.        Pad
+00003750: 2061 6e20 696d 6167 6520 7769 7468 207a   an image with z
+00003760: 6572 6f73 2074 6f20 7468 6520 6769 7665  eros to the give
+00003770: 6e20 7369 7a65 2e0a 2020 2020 2020 2020  n size..        
+00003780: 2222 220a 2020 2020 2020 2020 696e 7075  """.        inpu
+00003790: 745f 6865 6967 6874 2c20 696e 7075 745f  t_height, input_
+000037a0: 7769 6474 6820 3d20 6765 745f 696d 6167  width = get_imag
+000037b0: 655f 7369 7a65 2869 6d61 6765 2c20 6368  e_size(image, ch
+000037c0: 616e 6e65 6c5f 6469 6d3d 696e 7075 745f  annel_dim=input_
+000037d0: 6461 7461 5f66 6f72 6d61 7429 0a20 2020  data_format).   
+000037e0: 2020 2020 206f 7574 7075 745f 6865 6967       output_heig
+000037f0: 6874 2c20 6f75 7470 7574 5f77 6964 7468  ht, output_width
+00003800: 203d 206f 7574 7075 745f 7369 7a65 0a0a   = output_size..
+00003810: 2020 2020 2020 2020 7061 645f 626f 7474          pad_bott
+00003820: 6f6d 203d 206f 7574 7075 745f 6865 6967  om = output_heig
+00003830: 6874 202d 2069 6e70 7574 5f68 6569 6768  ht - input_heigh
+00003840: 740a 2020 2020 2020 2020 7061 645f 7269  t.        pad_ri
+00003850: 6768 7420 3d20 6f75 7470 7574 5f77 6964  ght = output_wid
+00003860: 7468 202d 2069 6e70 7574 5f77 6964 7468  th - input_width
+00003870: 0a20 2020 2020 2020 2070 6164 6469 6e67  .        padding
+00003880: 203d 2028 2830 2c20 7061 645f 626f 7474   = ((0, pad_bott
+00003890: 6f6d 292c 2028 302c 2070 6164 5f72 6967  om), (0, pad_rig
+000038a0: 6874 2929 0a20 2020 2020 2020 2070 6164  ht)).        pad
+000038b0: 6465 645f 696d 6167 6520 3d20 7061 6428  ded_image = pad(
+000038c0: 0a20 2020 2020 2020 2020 2020 2069 6d61  .            ima
+000038d0: 6765 2c0a 2020 2020 2020 2020 2020 2020  ge,.            
+000038e0: 7061 6464 696e 672c 0a20 2020 2020 2020  padding,.       
+000038f0: 2020 2020 206d 6f64 653d 5061 6464 696e       mode=Paddin
+00003900: 674d 6f64 652e 434f 4e53 5441 4e54 2c0a  gMode.CONSTANT,.
+00003910: 2020 2020 2020 2020 2020 2020 636f 6e73              cons
+00003920: 7461 6e74 5f76 616c 7565 733d 636f 6e73  tant_values=cons
+00003930: 7461 6e74 5f76 616c 7565 732c 0a20 2020  tant_values,.   
+00003940: 2020 2020 2020 2020 2064 6174 615f 666f           data_fo
+00003950: 726d 6174 3d64 6174 615f 666f 726d 6174  rmat=data_format
+00003960: 2c0a 2020 2020 2020 2020 2020 2020 696e  ,.            in
+00003970: 7075 745f 6461 7461 5f66 6f72 6d61 743d  put_data_format=
+00003980: 696e 7075 745f 6461 7461 5f66 6f72 6d61  input_data_forma
+00003990: 742c 0a20 2020 2020 2020 2029 0a20 2020  t,.        ).   
+000039a0: 2020 2020 2072 6574 7572 6e20 7061 6464       return padd
+000039b0: 6564 5f69 6d61 6765 0a0a 2020 2020 2320  ed_image..    # 
+000039c0: 436f 7069 6564 2066 726f 6d20 7472 616e  Copied from tran
+000039d0: 7366 6f72 6d65 7273 2e6d 6f64 656c 732e  sformers.models.
+000039e0: 7669 6c74 2e69 6d61 6765 5f70 726f 6365  vilt.image_proce
+000039f0: 7373 696e 675f 7669 6c74 2e56 696c 7449  ssing_vilt.ViltI
+00003a00: 6d61 6765 5072 6f63 6573 736f 722e 7061  mageProcessor.pa
+00003a10: 640a 2020 2020 6465 6620 7061 6428 0a20  d.    def pad(. 
+00003a20: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+00003a30: 2020 2020 2069 6d61 6765 733a 204c 6973       images: Lis
+00003a40: 745b 6e70 2e6e 6461 7272 6179 5d2c 0a20  t[np.ndarray],. 
+00003a50: 2020 2020 2020 2063 6f6e 7374 616e 745f         constant_
+00003a60: 7661 6c75 6573 3a20 556e 696f 6e5b 666c  values: Union[fl
+00003a70: 6f61 742c 2049 7465 7261 626c 655b 666c  oat, Iterable[fl
+00003a80: 6f61 745d 5d20 3d20 302c 0a20 2020 2020  oat]] = 0,.     
+00003a90: 2020 2072 6574 7572 6e5f 7069 7865 6c5f     return_pixel_
+00003aa0: 6d61 736b 3a20 626f 6f6c 203d 2054 7275  mask: bool = Tru
+00003ab0: 652c 0a20 2020 2020 2020 2072 6574 7572  e,.        retur
+00003ac0: 6e5f 7465 6e73 6f72 733a 204f 7074 696f  n_tensors: Optio
+00003ad0: 6e61 6c5b 556e 696f 6e5b 7374 722c 2054  nal[Union[str, T
+00003ae0: 656e 736f 7254 7970 655d 5d20 3d20 4e6f  ensorType]] = No
+00003af0: 6e65 2c0a 2020 2020 2020 2020 6461 7461  ne,.        data
+00003b00: 5f66 6f72 6d61 743a 204f 7074 696f 6e61  _format: Optiona
+00003b10: 6c5b 4368 616e 6e65 6c44 696d 656e 7369  l[ChannelDimensi
+00003b20: 6f6e 5d20 3d20 4e6f 6e65 2c0a 2020 2020  on] = None,.    
+00003b30: 2020 2020 696e 7075 745f 6461 7461 5f66      input_data_f
+00003b40: 6f72 6d61 743a 204f 7074 696f 6e61 6c5b  ormat: Optional[
+00003b50: 556e 696f 6e5b 7374 722c 2043 6861 6e6e  Union[str, Chann
+00003b60: 656c 4469 6d65 6e73 696f 6e5d 5d20 3d20  elDimension]] = 
+00003b70: 4e6f 6e65 2c0a 2020 2020 2920 2d3e 2042  None,.    ) -> B
+00003b80: 6174 6368 4665 6174 7572 653a 0a20 2020  atchFeature:.   
+00003b90: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00003ba0: 2050 6164 7320 6120 6261 7463 6820 6f66   Pads a batch of
+00003bb0: 2069 6d61 6765 7320 746f 2074 6865 2062   images to the b
+00003bc0: 6f74 746f 6d20 616e 6420 7269 6768 7420  ottom and right 
+00003bd0: 6f66 2074 6865 2069 6d61 6765 2077 6974  of the image wit
+00003be0: 6820 7a65 726f 7320 746f 2074 6865 2073  h zeros to the s
+00003bf0: 697a 6520 6f66 206c 6172 6765 7374 2068  ize of largest h
+00003c00: 6569 6768 7420 616e 6420 7769 6474 680a  eight and width.
+00003c10: 2020 2020 2020 2020 696e 2074 6865 2062          in the b
+00003c20: 6174 6368 2061 6e64 206f 7074 696f 6e61  atch and optiona
+00003c30: 6c6c 7920 7265 7475 726e 7320 7468 6569  lly returns thei
+00003c40: 7220 636f 7272 6573 706f 6e64 696e 6720  r corresponding 
+00003c50: 7069 7865 6c20 6d61 736b 2e0a 0a20 2020  pixel mask...   
+00003c60: 2020 2020 2041 7267 733a 0a20 2020 2020       Args:.     
+00003c70: 2020 2020 2020 2069 6d61 6765 2028 606e         image (`n
+00003c80: 702e 6e64 6172 7261 7960 293a 0a20 2020  p.ndarray`):.   
+00003c90: 2020 2020 2020 2020 2020 2020 2049 6d61               Ima
+00003ca0: 6765 2074 6f20 7061 642e 0a20 2020 2020  ge to pad..     
+00003cb0: 2020 2020 2020 2063 6f6e 7374 616e 745f         constant_
+00003cc0: 7661 6c75 6573 2028 6066 6c6f 6174 6020  values (`float` 
+00003cd0: 6f72 2060 4974 6572 6162 6c65 5b66 6c6f  or `Iterable[flo
+00003ce0: 6174 5d60 2c20 2a6f 7074 696f 6e61 6c2a  at]`, *optional*
+00003cf0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00003d00: 2020 2054 6865 2076 616c 7565 2074 6f20     The value to 
+00003d10: 7573 6520 666f 7220 7468 6520 7061 6464  use for the padd
+00003d20: 696e 6720 6966 2060 6d6f 6465 6020 6973  ing if `mode` is
+00003d30: 2060 2263 6f6e 7374 616e 7422 602e 0a20   `"constant"`.. 
+00003d40: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00003d50: 6e5f 7069 7865 6c5f 6d61 736b 2028 6062  n_pixel_mask (`b
+00003d60: 6f6f 6c60 2c20 2a6f 7074 696f 6e61 6c2a  ool`, *optional*
+00003d70: 2c20 6465 6661 756c 7473 2074 6f20 6054  , defaults to `T
+00003d80: 7275 6560 293a 0a20 2020 2020 2020 2020  rue`):.         
+00003d90: 2020 2020 2020 2057 6865 7468 6572 2074         Whether t
+00003da0: 6f20 7265 7475 726e 2061 2070 6978 656c  o return a pixel
+00003db0: 206d 6173 6b2e 0a20 2020 2020 2020 2020   mask..         
+00003dc0: 2020 2072 6574 7572 6e5f 7465 6e73 6f72     return_tensor
+00003dd0: 7320 2860 7374 7260 206f 7220 6054 656e  s (`str` or `Ten
+00003de0: 736f 7254 7970 6560 2c20 2a6f 7074 696f  sorType`, *optio
+00003df0: 6e61 6c2a 293a 0a20 2020 2020 2020 2020  nal*):.         
+00003e00: 2020 2020 2020 2054 6865 2074 7970 6520         The type 
+00003e10: 6f66 2074 656e 736f 7273 2074 6f20 7265  of tensors to re
+00003e20: 7475 726e 2e20 4361 6e20 6265 206f 6e65  turn. Can be one
+00003e30: 206f 663a 0a20 2020 2020 2020 2020 2020   of:.           
+00003e40: 2020 2020 2020 2020 202d 2055 6e73 6574           - Unset
+00003e50: 3a20 5265 7475 726e 2061 206c 6973 7420  : Return a list 
+00003e60: 6f66 2060 6e70 2e6e 6461 7272 6179 602e  of `np.ndarray`.
+00003e70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003e80: 2020 2020 202d 2060 5465 6e73 6f72 5479       - `TensorTy
+00003e90: 7065 2e54 454e 534f 5246 4c4f 5760 206f  pe.TENSORFLOW` o
+00003ea0: 7220 6027 7466 2760 3a20 5265 7475 726e  r `'tf'`: Return
+00003eb0: 2061 2062 6174 6368 206f 6620 7479 7065   a batch of type
+00003ec0: 2060 7466 2e54 656e 736f 7260 2e0a 2020   `tf.Tensor`..  
+00003ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003ee0: 2020 2d20 6054 656e 736f 7254 7970 652e    - `TensorType.
+00003ef0: 5059 544f 5243 4860 206f 7220 6027 7074  PYTORCH` or `'pt
+00003f00: 2760 3a20 5265 7475 726e 2061 2062 6174  '`: Return a bat
+00003f10: 6368 206f 6620 7479 7065 2060 746f 7263  ch of type `torc
+00003f20: 682e 5465 6e73 6f72 602e 0a20 2020 2020  h.Tensor`..     
+00003f30: 2020 2020 2020 2020 2020 2020 2020 202d                 -
+00003f40: 2060 5465 6e73 6f72 5479 7065 2e4e 554d   `TensorType.NUM
+00003f50: 5059 6020 6f72 2060 276e 7027 603a 2052  PY` or `'np'`: R
+00003f60: 6574 7572 6e20 6120 6261 7463 6820 6f66  eturn a batch of
+00003f70: 2074 7970 6520 606e 702e 6e64 6172 7261   type `np.ndarra
+00003f80: 7960 2e0a 2020 2020 2020 2020 2020 2020  y`..            
+00003f90: 2020 2020 2020 2020 2d20 6054 656e 736f          - `Tenso
+00003fa0: 7254 7970 652e 4a41 5860 206f 7220 6027  rType.JAX` or `'
+00003fb0: 6a61 7827 603a 2052 6574 7572 6e20 6120  jax'`: Return a 
+00003fc0: 6261 7463 6820 6f66 2074 7970 6520 606a  batch of type `j
+00003fd0: 6178 2e6e 756d 7079 2e6e 6461 7272 6179  ax.numpy.ndarray
+00003fe0: 602e 0a20 2020 2020 2020 2020 2020 2064  `..            d
+00003ff0: 6174 615f 666f 726d 6174 2028 6073 7472  ata_format (`str
+00004000: 6020 6f72 2060 4368 616e 6e65 6c44 696d  ` or `ChannelDim
+00004010: 656e 7369 6f6e 602c 202a 6f70 7469 6f6e  ension`, *option
+00004020: 616c 2a29 3a0a 2020 2020 2020 2020 2020  al*):.          
+00004030: 2020 2020 2020 5468 6520 6368 616e 6e65        The channe
+00004040: 6c20 6469 6d65 6e73 696f 6e20 666f 726d  l dimension form
+00004050: 6174 206f 6620 7468 6520 696d 6167 652e  at of the image.
+00004060: 2049 6620 6e6f 7420 7072 6f76 6964 6564   If not provided
+00004070: 2c20 6974 2077 696c 6c20 6265 2074 6865  , it will be the
+00004080: 2073 616d 6520 6173 2074 6865 2069 6e70   same as the inp
+00004090: 7574 2069 6d61 6765 2e0a 2020 2020 2020  ut image..      
+000040a0: 2020 2020 2020 696e 7075 745f 6461 7461        input_data
+000040b0: 5f66 6f72 6d61 7420 2860 4368 616e 6e65  _format (`Channe
+000040c0: 6c44 696d 656e 7369 6f6e 6020 6f72 2060  lDimension` or `
+000040d0: 7374 7260 2c20 2a6f 7074 696f 6e61 6c2a  str`, *optional*
+000040e0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000040f0: 2020 2054 6865 2063 6861 6e6e 656c 2064     The channel d
+00004100: 696d 656e 7369 6f6e 2066 6f72 6d61 7420  imension format 
+00004110: 6f66 2074 6865 2069 6e70 7574 2069 6d61  of the input ima
+00004120: 6765 2e20 4966 206e 6f74 2070 726f 7669  ge. If not provi
+00004130: 6465 642c 2069 7420 7769 6c6c 2062 6520  ded, it will be 
+00004140: 696e 6665 7272 6564 2e0a 2020 2020 2020  inferred..      
+00004150: 2020 2222 220a 2020 2020 2020 2020 7061    """.        pa
+00004160: 645f 7369 7a65 203d 2067 6574 5f6d 6178  d_size = get_max
+00004170: 5f68 6569 6768 745f 7769 6474 6828 696d  _height_width(im
+00004180: 6167 6573 2c20 696e 7075 745f 6461 7461  ages, input_data
+00004190: 5f66 6f72 6d61 743d 696e 7075 745f 6461  _format=input_da
+000041a0: 7461 5f66 6f72 6d61 7429 0a0a 2020 2020  ta_format)..    
+000041b0: 2020 2020 7061 6464 6564 5f69 6d61 6765      padded_image
+000041c0: 7320 3d20 5b0a 2020 2020 2020 2020 2020  s = [.          
+000041d0: 2020 7365 6c66 2e5f 7061 645f 696d 6167    self._pad_imag
+000041e0: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+000041f0: 2020 2069 6d61 6765 2c0a 2020 2020 2020     image,.      
+00004200: 2020 2020 2020 2020 2020 7061 645f 7369            pad_si
+00004210: 7a65 2c0a 2020 2020 2020 2020 2020 2020  ze,.            
+00004220: 2020 2020 636f 6e73 7461 6e74 5f76 616c      constant_val
+00004230: 7565 733d 636f 6e73 7461 6e74 5f76 616c  ues=constant_val
+00004240: 7565 732c 0a20 2020 2020 2020 2020 2020  ues,.           
+00004250: 2020 2020 2064 6174 615f 666f 726d 6174       data_format
+00004260: 3d64 6174 615f 666f 726d 6174 2c0a 2020  =data_format,.  
+00004270: 2020 2020 2020 2020 2020 2020 2020 696e                in
+00004280: 7075 745f 6461 7461 5f66 6f72 6d61 743d  put_data_format=
+00004290: 696e 7075 745f 6461 7461 5f66 6f72 6d61  input_data_forma
+000042a0: 742c 0a20 2020 2020 2020 2020 2020 2029  t,.            )
+000042b0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+000042c0: 2069 6d61 6765 2069 6e20 696d 6167 6573   image in images
+000042d0: 0a20 2020 2020 2020 205d 0a20 2020 2020  .        ].     
+000042e0: 2020 2064 6174 6120 3d20 7b22 7069 7865     data = {"pixe
+000042f0: 6c5f 7661 6c75 6573 223a 2070 6164 6465  l_values": padde
+00004300: 645f 696d 6167 6573 7d0a 0a20 2020 2020  d_images}..     
+00004310: 2020 2069 6620 7265 7475 726e 5f70 6978     if return_pix
+00004320: 656c 5f6d 6173 6b3a 0a20 2020 2020 2020  el_mask:.       
+00004330: 2020 2020 206d 6173 6b73 203d 205b 0a20       masks = [. 
+00004340: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00004350: 616b 655f 7069 7865 6c5f 6d61 736b 2869  ake_pixel_mask(i
+00004360: 6d61 6765 3d69 6d61 6765 2c20 6f75 7470  mage=image, outp
+00004370: 7574 5f73 697a 653d 7061 645f 7369 7a65  ut_size=pad_size
+00004380: 2c20 696e 7075 745f 6461 7461 5f66 6f72  , input_data_for
+00004390: 6d61 743d 696e 7075 745f 6461 7461 5f66  mat=input_data_f
+000043a0: 6f72 6d61 7429 0a20 2020 2020 2020 2020  ormat).         
+000043b0: 2020 2020 2020 2066 6f72 2069 6d61 6765         for image
+000043c0: 2069 6e20 696d 6167 6573 0a20 2020 2020   in images.     
+000043d0: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
+000043e0: 2020 2020 2064 6174 615b 2270 6978 656c       data["pixel
+000043f0: 5f6d 6173 6b22 5d20 3d20 6d61 736b 730a  _mask"] = masks.
+00004400: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00004410: 4261 7463 6846 6561 7475 7265 2864 6174  BatchFeature(dat
+00004420: 613d 6461 7461 2c20 7465 6e73 6f72 5f74  a=data, tensor_t
+00004430: 7970 653d 7265 7475 726e 5f74 656e 736f  ype=return_tenso
+00004440: 7273 290a 0a20 2020 2064 6566 2070 7265  rs)..    def pre
+00004450: 7072 6f63 6573 7328 0a20 2020 2020 2020  process(.       
+00004460: 2073 656c 662c 0a20 2020 2020 2020 2069   self,.        i
+00004470: 6d61 6765 733a 2049 6d61 6765 496e 7075  mages: ImageInpu
+00004480: 742c 0a20 2020 2020 2020 2064 6f5f 7265  t,.        do_re
+00004490: 7369 7a65 3a20 4f70 7469 6f6e 616c 5b62  size: Optional[b
+000044a0: 6f6f 6c5d 203d 204e 6f6e 652c 0a20 2020  ool] = None,.   
+000044b0: 2020 2020 2073 697a 653a 204f 7074 696f       size: Optio
+000044c0: 6e61 6c5b 4469 6374 5b73 7472 2c20 696e  nal[Dict[str, in
+000044d0: 745d 5d20 3d20 4e6f 6e65 2c0a 2020 2020  t]] = None,.    
+000044e0: 2020 2020 7369 7a65 5f64 6976 6973 6f72      size_divisor
+000044f0: 3a20 4f70 7469 6f6e 616c 5b69 6e74 5d20  : Optional[int] 
+00004500: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00004510: 7265 7361 6d70 6c65 3a20 5049 4c49 6d61  resample: PILIma
+00004520: 6765 5265 7361 6d70 6c69 6e67 203d 204e  geResampling = N
+00004530: 6f6e 652c 0a20 2020 2020 2020 2064 6f5f  one,.        do_
+00004540: 7265 7363 616c 653a 204f 7074 696f 6e61  rescale: Optiona
+00004550: 6c5b 626f 6f6c 5d20 3d20 4e6f 6e65 2c0a  l[bool] = None,.
+00004560: 2020 2020 2020 2020 7265 7363 616c 655f          rescale_
+00004570: 6661 6374 6f72 3a20 4f70 7469 6f6e 616c  factor: Optional
+00004580: 5b66 6c6f 6174 5d20 3d20 4e6f 6e65 2c0a  [float] = None,.
+00004590: 2020 2020 2020 2020 646f 5f6e 6f72 6d61          do_norma
+000045a0: 6c69 7a65 3a20 4f70 7469 6f6e 616c 5b62  lize: Optional[b
+000045b0: 6f6f 6c5d 203d 204e 6f6e 652c 0a20 2020  ool] = None,.   
+000045c0: 2020 2020 2069 6d61 6765 5f6d 6561 6e3a       image_mean:
+000045d0: 204f 7074 696f 6e61 6c5b 556e 696f 6e5b   Optional[Union[
+000045e0: 666c 6f61 742c 204c 6973 745b 666c 6f61  float, List[floa
+000045f0: 745d 5d5d 203d 204e 6f6e 652c 0a20 2020  t]]] = None,.   
+00004600: 2020 2020 2069 6d61 6765 5f73 7464 3a20       image_std: 
+00004610: 4f70 7469 6f6e 616c 5b55 6e69 6f6e 5b66  Optional[Union[f
+00004620: 6c6f 6174 2c20 4c69 7374 5b66 6c6f 6174  loat, List[float
+00004630: 5d5d 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ]]] = None,.    
+00004640: 2020 2020 646f 5f70 6164 3a20 4f70 7469      do_pad: Opti
+00004650: 6f6e 616c 5b62 6f6f 6c5d 203d 204e 6f6e  onal[bool] = Non
+00004660: 652c 0a20 2020 2020 2020 2064 6f5f 6365  e,.        do_ce
+00004670: 6e74 6572 5f63 726f 703a 204f 7074 696f  nter_crop: Optio
+00004680: 6e61 6c5b 626f 6f6c 5d20 3d20 4e6f 6e65  nal[bool] = None
+00004690: 2c0a 2020 2020 2020 2020 6372 6f70 5f73  ,.        crop_s
+000046a0: 697a 653a 2044 6963 745b 7374 722c 2069  ize: Dict[str, i
+000046b0: 6e74 5d20 3d20 4e6f 6e65 2c0a 2020 2020  nt] = None,.    
+000046c0: 2020 2020 7265 7475 726e 5f74 656e 736f      return_tenso
+000046d0: 7273 3a20 4f70 7469 6f6e 616c 5b55 6e69  rs: Optional[Uni
+000046e0: 6f6e 5b73 7472 2c20 5465 6e73 6f72 5479  on[str, TensorTy
+000046f0: 7065 5d5d 203d 204e 6f6e 652c 0a20 2020  pe]] = None,.   
+00004700: 2020 2020 2064 6174 615f 666f 726d 6174       data_format
+00004710: 3a20 4368 616e 6e65 6c44 696d 656e 7369  : ChannelDimensi
+00004720: 6f6e 203d 2043 6861 6e6e 656c 4469 6d65  on = ChannelDime
+00004730: 6e73 696f 6e2e 4649 5253 542c 0a20 2020  nsion.FIRST,.   
+00004740: 2020 2020 2069 6e70 7574 5f64 6174 615f       input_data_
+00004750: 666f 726d 6174 3a20 4f70 7469 6f6e 616c  format: Optional
+00004760: 5b55 6e69 6f6e 5b73 7472 2c20 4368 616e  [Union[str, Chan
+00004770: 6e65 6c44 696d 656e 7369 6f6e 5d5d 203d  nelDimension]] =
+00004780: 204e 6f6e 652c 0a20 2020 2020 2020 202a   None,.        *
+00004790: 2a6b 7761 7267 732c 0a20 2020 2029 202d  *kwargs,.    ) -
+000047a0: 3e20 5049 4c2e 496d 6167 652e 496d 6167  > PIL.Image.Imag
+000047b0: 653a 0a20 2020 2020 2020 2022 2222 0a20  e:.        """. 
+000047c0: 2020 2020 2020 2050 7265 7072 6f63 6573         Preproces
+000047d0: 7320 616e 2069 6d61 6765 206f 7220 6261  s an image or ba
+000047e0: 7463 6820 6f66 2069 6d61 6765 732e 0a0a  tch of images...
+000047f0: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
+00004800: 2020 2020 2020 2020 2020 696d 6167 6573            images
+00004810: 2028 6049 6d61 6765 496e 7075 7460 293a   (`ImageInput`):
+00004820: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00004830: 2049 6d61 6765 2074 6f20 7072 6570 726f   Image to prepro
+00004840: 6365 7373 2e20 4578 7065 6374 7320 6120  cess. Expects a 
+00004850: 7369 6e67 6c65 206f 7220 6261 7463 6820  single or batch 
+00004860: 6f66 2069 6d61 6765 7320 7769 7468 2070  of images with p
+00004870: 6978 656c 2076 616c 7565 7320 7261 6e67  ixel values rang
+00004880: 696e 6720 6672 6f6d 2030 2074 6f20 3235  ing from 0 to 25
+00004890: 352e 2049 660a 2020 2020 2020 2020 2020  5. If.          
+000048a0: 2020 2020 2020 7061 7373 696e 6720 696e        passing in
+000048b0: 2069 6d61 6765 7320 7769 7468 2070 6978   images with pix
+000048c0: 656c 2076 616c 7565 7320 6265 7477 6565  el values betwee
+000048d0: 6e20 3020 616e 6420 312c 2073 6574 2060  n 0 and 1, set `
+000048e0: 646f 5f72 6573 6361 6c65 3d46 616c 7365  do_rescale=False
+000048f0: 602e 0a20 2020 2020 2020 2020 2020 2064  `..            d
+00004900: 6f5f 7265 7369 7a65 2028 6062 6f6f 6c60  o_resize (`bool`
+00004910: 2c20 2a6f 7074 696f 6e61 6c2a 2c20 6465  , *optional*, de
+00004920: 6661 756c 7473 2074 6f20 6073 656c 662e  faults to `self.
+00004930: 646f 5f72 6573 697a 6560 293a 0a20 2020  do_resize`):.   
+00004940: 2020 2020 2020 2020 2020 2020 2057 6865               Whe
+00004950: 7468 6572 2074 6f20 7265 7369 7a65 2074  ther to resize t
+00004960: 6865 2069 6d61 6765 2e0a 2020 2020 2020  he image..      
+00004970: 2020 2020 2020 7369 7a65 2028 6044 6963        size (`Dic
+00004980: 745b 7374 722c 2069 6e74 5d60 2c20 2a6f  t[str, int]`, *o
+00004990: 7074 696f 6e61 6c2a 2c20 6465 6661 756c  ptional*, defaul
+000049a0: 7473 2074 6f20 6073 656c 662e 7369 7a65  ts to `self.size
+000049b0: 6029 3a0a 2020 2020 2020 2020 2020 2020  `):.            
+000049c0: 2020 2020 436f 6e74 726f 6c73 2074 6865      Controls the
+000049d0: 2073 697a 6520 6f66 2074 6865 2069 6d61   size of the ima
+000049e0: 6765 2061 6674 6572 2060 7265 7369 7a65  ge after `resize
+000049f0: 602e 2054 6865 2073 686f 7274 6573 7420  `. The shortest 
+00004a00: 6564 6765 206f 6620 7468 6520 696d 6167  edge of the imag
+00004a10: 6520 6973 2072 6573 697a 6564 2074 6f0a  e is resized to.
+00004a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004a30: 6073 697a 655b 2273 686f 7274 6573 745f  `size["shortest_
+00004a40: 6564 6765 225d 6020 7768 696c 7374 2070  edge"]` whilst p
+00004a50: 7265 7365 7276 696e 6720 7468 6520 6173  reserving the as
+00004a60: 7065 6374 2072 6174 696f 2e20 4966 2074  pect ratio. If t
+00004a70: 6865 206c 6f6e 6765 7374 2065 6467 6520  he longest edge 
+00004a80: 6f66 2074 6869 7320 7265 7369 7a65 6420  of this resized 
+00004a90: 696d 6167 650a 2020 2020 2020 2020 2020  image.          
+00004aa0: 2020 2020 2020 6973 203e 2060 696e 7428        is > `int(
+00004ab0: 7369 7a65 5b22 7368 6f72 7465 7374 5f65  size["shortest_e
+00004ac0: 6467 6522 5d20 2a20 2831 3333 3320 2f20  dge"] * (1333 / 
+00004ad0: 3830 3029 2960 2c20 7468 656e 2074 6865  800))`, then the
+00004ae0: 2069 6d61 6765 2069 7320 7265 7369 7a65   image is resize
+00004af0: 6420 6167 6169 6e20 746f 206d 616b 6520  d again to make 
+00004b00: 7468 6520 6c6f 6e67 6573 740a 2020 2020  the longest.    
+00004b10: 2020 2020 2020 2020 2020 2020 6564 6765              edge
+00004b20: 2065 7175 616c 2074 6f20 6069 6e74 2873   equal to `int(s
+00004b30: 697a 655b 2273 686f 7274 6573 745f 6564  ize["shortest_ed
+00004b40: 6765 225d 202a 2028 3133 3333 202f 2038  ge"] * (1333 / 8
+00004b50: 3030 2929 602e 0a20 2020 2020 2020 2020  00))`..         
+00004b60: 2020 2073 697a 655f 6469 7669 736f 7220     size_divisor 
+00004b70: 2860 696e 7460 2c20 2a6f 7074 696f 6e61  (`int`, *optiona
+00004b80: 6c2a 2c20 6465 6661 756c 7473 2074 6f20  l*, defaults to 
+00004b90: 6073 656c 662e 7369 7a65 5f64 6976 6973  `self.size_divis
+00004ba0: 6f72 6029 3a0a 2020 2020 2020 2020 2020  or`):.          
+00004bb0: 2020 2020 2020 5468 6520 696d 6167 6520        The image 
+00004bc0: 6973 2072 6573 697a 6564 2074 6f20 6120  is resized to a 
+00004bd0: 7369 7a65 2074 6861 7420 6973 2061 206d  size that is a m
+00004be0: 756c 7469 706c 6520 6f66 2074 6869 7320  ultiple of this 
+00004bf0: 7661 6c75 652e 0a20 2020 2020 2020 2020  value..         
+00004c00: 2020 2072 6573 616d 706c 6520 2860 5049     resample (`PI
+00004c10: 4c49 6d61 6765 5265 7361 6d70 6c69 6e67  LImageResampling
+00004c20: 602c 202a 6f70 7469 6f6e 616c 2a2c 2064  `, *optional*, d
+00004c30: 6566 6175 6c74 7320 746f 2060 7365 6c66  efaults to `self
+00004c40: 2e72 6573 616d 706c 6560 293a 0a20 2020  .resample`):.   
+00004c50: 2020 2020 2020 2020 2020 2020 2052 6573               Res
+00004c60: 616d 706c 696e 6720 6669 6c74 6572 2074  ampling filter t
+00004c70: 6f20 7573 6520 6966 2072 6573 697a 696e  o use if resizin
+00004c80: 6720 7468 6520 696d 6167 652e 204f 6e6c  g the image. Onl
+00004c90: 7920 6861 7320 616e 2065 6666 6563 7420  y has an effect 
+00004ca0: 6966 2060 646f 5f72 6573 697a 6560 2069  if `do_resize` i
+00004cb0: 7320 7365 7420 746f 2060 5472 7565 602e  s set to `True`.
+00004cc0: 0a20 2020 2020 2020 2020 2020 2064 6f5f  .            do_
+00004cd0: 7265 7363 616c 6520 2860 626f 6f6c 602c  rescale (`bool`,
+00004ce0: 202a 6f70 7469 6f6e 616c 2a2c 2064 6566   *optional*, def
+00004cf0: 6175 6c74 7320 746f 2060 7365 6c66 2e64  aults to `self.d
+00004d00: 6f5f 7265 7363 616c 6560 293a 0a20 2020  o_rescale`):.   
+00004d10: 2020 2020 2020 2020 2020 2020 2057 6865               Whe
+00004d20: 7468 6572 2074 6f20 7265 7363 616c 6520  ther to rescale 
+00004d30: 7468 6520 696d 6167 6520 7661 6c75 6573  the image values
+00004d40: 2062 6574 7765 656e 205b 3020 2d20 315d   between [0 - 1]
+00004d50: 2e0a 2020 2020 2020 2020 2020 2020 7265  ..            re
+00004d60: 7363 616c 655f 6661 6374 6f72 2028 6066  scale_factor (`f
+00004d70: 6c6f 6174 602c 202a 6f70 7469 6f6e 616c  loat`, *optional
+00004d80: 2a2c 2064 6566 6175 6c74 7320 746f 2060  *, defaults to `
+00004d90: 7365 6c66 2e72 6573 6361 6c65 5f66 6163  self.rescale_fac
+00004da0: 746f 7260 293a 0a20 2020 2020 2020 2020  tor`):.         
+00004db0: 2020 2020 2020 2052 6573 6361 6c65 2066         Rescale f
+00004dc0: 6163 746f 7220 746f 2072 6573 6361 6c65  actor to rescale
+00004dd0: 2074 6865 2069 6d61 6765 2062 7920 6966   the image by if
+00004de0: 2060 646f 5f72 6573 6361 6c65 6020 6973   `do_rescale` is
+00004df0: 2073 6574 2074 6f20 6054 7275 6560 2e0a   set to `True`..
+00004e00: 2020 2020 2020 2020 2020 2020 646f 5f6e              do_n
+00004e10: 6f72 6d61 6c69 7a65 2028 6062 6f6f 6c60  ormalize (`bool`
+00004e20: 2c20 2a6f 7074 696f 6e61 6c2a 2c20 6465  , *optional*, de
+00004e30: 6661 756c 7473 2074 6f20 6073 656c 662e  faults to `self.
+00004e40: 646f 5f6e 6f72 6d61 6c69 7a65 6029 3a0a  do_normalize`):.
+00004e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00004e60: 5768 6574 6865 7220 746f 206e 6f72 6d61  Whether to norma
+00004e70: 6c69 7a65 2074 6865 2069 6d61 6765 2e0a  lize the image..
+00004e80: 2020 2020 2020 2020 2020 2020 696d 6167              imag
+00004e90: 655f 6d65 616e 2028 6066 6c6f 6174 6020  e_mean (`float` 
+00004ea0: 6f72 2060 4c69 7374 5b66 6c6f 6174 5d60  or `List[float]`
+00004eb0: 2c20 2a6f 7074 696f 6e61 6c2a 2c20 6465  , *optional*, de
+00004ec0: 6661 756c 7473 2074 6f20 6073 656c 662e  faults to `self.
+00004ed0: 696d 6167 655f 6d65 616e 6029 3a0a 2020  image_mean`):.  
+00004ee0: 2020 2020 2020 2020 2020 2020 2020 496d                Im
+00004ef0: 6167 6520 6d65 616e 2074 6f20 6e6f 726d  age mean to norm
+00004f00: 616c 697a 6520 7468 6520 696d 6167 6520  alize the image 
+00004f10: 6279 2069 6620 6064 6f5f 6e6f 726d 616c  by if `do_normal
+00004f20: 697a 6560 2069 7320 7365 7420 746f 2060  ize` is set to `
+00004f30: 5472 7565 602e 0a20 2020 2020 2020 2020  True`..         
+00004f40: 2020 2069 6d61 6765 5f73 7464 2028 6066     image_std (`f
+00004f50: 6c6f 6174 6020 6f72 2060 4c69 7374 5b66  loat` or `List[f
+00004f60: 6c6f 6174 5d60 2c20 2a6f 7074 696f 6e61  loat]`, *optiona
+00004f70: 6c2a 2c20 6465 6661 756c 7473 2074 6f20  l*, defaults to 
+00004f80: 6073 656c 662e 696d 6167 655f 7374 6460  `self.image_std`
+00004f90: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00004fa0: 2020 2049 6d61 6765 2073 7461 6e64 6172     Image standar
+00004fb0: 6420 6465 7669 6174 696f 6e20 746f 206e  d deviation to n
+00004fc0: 6f72 6d61 6c69 7a65 2074 6865 2069 6d61  ormalize the ima
+00004fd0: 6765 2062 7920 6966 2060 646f 5f6e 6f72  ge by if `do_nor
+00004fe0: 6d61 6c69 7a65 6020 6973 2073 6574 2074  malize` is set t
+00004ff0: 6f20 6054 7275 6560 2e0a 2020 2020 2020  o `True`..      
+00005000: 2020 2020 2020 646f 5f70 6164 2028 6062        do_pad (`b
+00005010: 6f6f 6c60 2c20 2a6f 7074 696f 6e61 6c2a  ool`, *optional*
+00005020: 2c20 6465 6661 756c 7473 2074 6f20 6073  , defaults to `s
+00005030: 656c 662e 646f 5f70 6164 6029 3a0a 2020  elf.do_pad`):.  
+00005040: 2020 2020 2020 2020 2020 2020 2020 5768                Wh
+00005050: 6574 6865 7220 746f 2070 6164 2074 6865  ether to pad the
+00005060: 2069 6d61 6765 2074 6f20 7468 6520 286d   image to the (m
+00005070: 6178 5f68 6569 6768 742c 206d 6178 5f77  ax_height, max_w
+00005080: 6964 7468 2920 696e 2074 6865 2062 6174  idth) in the bat
+00005090: 6368 2e20 4966 2060 5472 7565 602c 2061  ch. If `True`, a
+000050a0: 2070 6978 656c 206d 6173 6b20 6973 2061   pixel mask is a
+000050b0: 6c73 6f0a 2020 2020 2020 2020 2020 2020  lso.            
+000050c0: 2020 2020 6372 6561 7465 6420 616e 6420      created and 
+000050d0: 7265 7475 726e 6564 2e0a 2020 2020 2020  returned..      
+000050e0: 2020 2020 2020 646f 5f63 656e 7465 725f        do_center_
+000050f0: 6372 6f70 2028 6062 6f6f 6c60 2c20 2a6f  crop (`bool`, *o
+00005100: 7074 696f 6e61 6c2a 2c20 6465 6661 756c  ptional*, defaul
+00005110: 7473 2074 6f20 6073 656c 662e 646f 5f63  ts to `self.do_c
+00005120: 656e 7465 725f 6372 6f70 6029 3a0a 2020  enter_crop`):.  
+00005130: 2020 2020 2020 2020 2020 2020 2020 5768                Wh
+00005140: 6574 6865 7220 746f 2063 656e 7465 7220  ether to center 
+00005150: 6372 6f70 2074 6865 2069 6d61 6765 2e20  crop the image. 
+00005160: 4966 2074 6865 2069 6e70 7574 2073 697a  If the input siz
+00005170: 6520 6973 2073 6d61 6c6c 6572 2074 6861  e is smaller tha
+00005180: 6e20 6063 726f 705f 7369 7a65 6020 616c  n `crop_size` al
+00005190: 6f6e 6720 616e 7920 6564 6765 2c20 7468  ong any edge, th
+000051a0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+000051b0: 2020 696d 6167 6520 6973 2070 6164 6465    image is padde
+000051c0: 6420 7769 7468 2030 2773 2061 6e64 2074  d with 0's and t
+000051d0: 6865 6e20 6365 6e74 6572 2063 726f 7070  hen center cropp
+000051e0: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+000051f0: 6372 6f70 5f73 697a 6520 2860 4469 6374  crop_size (`Dict
+00005200: 5b73 7472 2c20 696e 745d 602c 202a 6f70  [str, int]`, *op
+00005210: 7469 6f6e 616c 2a2c 2064 6566 6175 6c74  tional*, default
+00005220: 7320 746f 2060 7365 6c66 2e63 726f 705f  s to `self.crop_
+00005230: 7369 7a65 6029 3a0a 2020 2020 2020 2020  size`):.        
+00005240: 2020 2020 2020 2020 5369 7a65 206f 6620          Size of 
+00005250: 7468 6520 696d 6167 6520 6166 7465 7220  the image after 
+00005260: 6365 6e74 6572 2063 726f 702e 2049 6620  center crop. If 
+00005270: 6f6e 6520 6564 6765 2074 6865 2069 6d61  one edge the ima
+00005280: 6765 2069 7320 736d 616c 6c65 7220 7468  ge is smaller th
+00005290: 616e 2060 6372 6f70 5f73 697a 6560 2c20  an `crop_size`, 
+000052a0: 6974 2077 696c 6c20 6265 0a20 2020 2020  it will be.     
+000052b0: 2020 2020 2020 2020 2020 2070 6164 6465             padde
+000052c0: 6420 7769 7468 207a 6572 6f73 2061 6e64  d with zeros and
+000052d0: 2074 6865 6e20 6372 6f70 7065 640a 2020   then cropped.  
+000052e0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000052f0: 5f74 656e 736f 7273 2028 6073 7472 6020  _tensors (`str` 
+00005300: 6f72 2060 5465 6e73 6f72 5479 7065 602c  or `TensorType`,
+00005310: 202a 6f70 7469 6f6e 616c 2a29 3a0a 2020   *optional*):.  
+00005320: 2020 2020 2020 2020 2020 2020 2020 5468                Th
+00005330: 6520 7479 7065 206f 6620 7465 6e73 6f72  e type of tensor
+00005340: 7320 746f 2072 6574 7572 6e2e 2043 616e  s to return. Can
+00005350: 2062 6520 6f6e 6520 6f66 3a0a 2020 2020   be one of:.    
+00005360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005370: 2d20 556e 7365 743a 2052 6574 7572 6e20  - Unset: Return 
+00005380: 6120 6c69 7374 206f 6620 606e 702e 6e64  a list of `np.nd
+00005390: 6172 7261 7960 2e0a 2020 2020 2020 2020  array`..        
+000053a0: 2020 2020 2020 2020 2020 2020 2d20 6054              - `T
+000053b0: 656e 736f 7254 7970 652e 5445 4e53 4f52  ensorType.TENSOR
+000053c0: 464c 4f57 6020 6f72 2060 2774 6627 603a  FLOW` or `'tf'`:
+000053d0: 2052 6574 7572 6e20 6120 6261 7463 6820   Return a batch 
+000053e0: 6f66 2074 7970 6520 6074 662e 5465 6e73  of type `tf.Tens
+000053f0: 6f72 602e 0a20 2020 2020 2020 2020 2020  or`..           
+00005400: 2020 2020 2020 2020 202d 2060 5465 6e73           - `Tens
+00005410: 6f72 5479 7065 2e50 5954 4f52 4348 6020  orType.PYTORCH` 
+00005420: 6f72 2060 2770 7427 603a 2052 6574 7572  or `'pt'`: Retur
+00005430: 6e20 6120 6261 7463 6820 6f66 2074 7970  n a batch of typ
+00005440: 6520 6074 6f72 6368 2e54 656e 736f 7260  e `torch.Tensor`
+00005450: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00005460: 2020 2020 2020 2d20 6054 656e 736f 7254        - `TensorT
+00005470: 7970 652e 4e55 4d50 5960 206f 7220 6027  ype.NUMPY` or `'
+00005480: 6e70 2760 3a20 5265 7475 726e 2061 2062  np'`: Return a b
+00005490: 6174 6368 206f 6620 7479 7065 2060 6e70  atch of type `np
+000054a0: 2e6e 6461 7272 6179 602e 0a20 2020 2020  .ndarray`..     
+000054b0: 2020 2020 2020 2020 2020 2020 2020 202d                 -
+000054c0: 2060 5465 6e73 6f72 5479 7065 2e4a 4158   `TensorType.JAX
+000054d0: 6020 6f72 2060 276a 6178 2760 3a20 5265  ` or `'jax'`: Re
+000054e0: 7475 726e 2061 2062 6174 6368 206f 6620  turn a batch of 
+000054f0: 7479 7065 2060 6a61 782e 6e75 6d70 792e  type `jax.numpy.
+00005500: 6e64 6172 7261 7960 2e0a 2020 2020 2020  ndarray`..      
+00005510: 2020 2020 2020 6461 7461 5f66 6f72 6d61        data_forma
+00005520: 7420 2860 4368 616e 6e65 6c44 696d 656e  t (`ChannelDimen
+00005530: 7369 6f6e 6020 6f72 2060 7374 7260 2c20  sion` or `str`, 
+00005540: 2a6f 7074 696f 6e61 6c2a 2c20 6465 6661  *optional*, defa
+00005550: 756c 7473 2074 6f20 6043 6861 6e6e 656c  ults to `Channel
+00005560: 4469 6d65 6e73 696f 6e2e 4649 5253 5460  Dimension.FIRST`
+00005570: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00005580: 2020 2054 6865 2063 6861 6e6e 656c 2064     The channel d
+00005590: 696d 656e 7369 6f6e 2066 6f72 6d61 7420  imension format 
+000055a0: 666f 7220 7468 6520 6f75 7470 7574 2069  for the output i
+000055b0: 6d61 6765 2e20 4361 6e20 6265 206f 6e65  mage. Can be one
+000055c0: 206f 663a 0a20 2020 2020 2020 2020 2020   of:.           
+000055d0: 2020 2020 202d 2060 2263 6861 6e6e 656c       - `"channel
+000055e0: 735f 6669 7273 7422 6020 6f72 2060 4368  s_first"` or `Ch
+000055f0: 616e 6e65 6c44 696d 656e 7369 6f6e 2e46  annelDimension.F
+00005600: 4952 5354 603a 2069 6d61 6765 2069 6e20  IRST`: image in 
+00005610: 286e 756d 5f63 6861 6e6e 656c 732c 2068  (num_channels, h
+00005620: 6569 6768 742c 2077 6964 7468 2920 666f  eight, width) fo
+00005630: 726d 6174 2e0a 2020 2020 2020 2020 2020  rmat..          
+00005640: 2020 2020 2020 2d20 6022 6368 616e 6e65        - `"channe
+00005650: 6c73 5f6c 6173 7422 6020 6f72 2060 4368  ls_last"` or `Ch
+00005660: 616e 6e65 6c44 696d 656e 7369 6f6e 2e4c  annelDimension.L
+00005670: 4153 5460 3a20 696d 6167 6520 696e 2028  AST`: image in (
+00005680: 6865 6967 6874 2c20 7769 6474 682c 206e  height, width, n
+00005690: 756d 5f63 6861 6e6e 656c 7329 2066 6f72  um_channels) for
+000056a0: 6d61 742e 0a20 2020 2020 2020 2020 2020  mat..           
+000056b0: 2020 2020 202d 2055 6e73 6574 3a20 5573       - Unset: Us
+000056c0: 6520 7468 6520 6368 616e 6e65 6c20 6469  e the channel di
+000056d0: 6d65 6e73 696f 6e20 666f 726d 6174 206f  mension format o
+000056e0: 6620 7468 6520 696e 7075 7420 696d 6167  f the input imag
+000056f0: 652e 0a20 2020 2020 2020 2020 2020 2069  e..            i
+00005700: 6e70 7574 5f64 6174 615f 666f 726d 6174  nput_data_format
+00005710: 2028 6043 6861 6e6e 656c 4469 6d65 6e73   (`ChannelDimens
+00005720: 696f 6e60 206f 7220 6073 7472 602c 202a  ion` or `str`, *
+00005730: 6f70 7469 6f6e 616c 2a29 3a0a 2020 2020  optional*):.    
+00005740: 2020 2020 2020 2020 2020 2020 5468 6520              The 
+00005750: 6368 616e 6e65 6c20 6469 6d65 6e73 696f  channel dimensio
+00005760: 6e20 666f 726d 6174 2066 6f72 2074 6865  n format for the
+00005770: 2069 6e70 7574 2069 6d61 6765 2e20 4966   input image. If
+00005780: 2075 6e73 6574 2c20 7468 6520 6368 616e   unset, the chan
+00005790: 6e65 6c20 6469 6d65 6e73 696f 6e20 666f  nel dimension fo
+000057a0: 726d 6174 2069 7320 696e 6665 7272 6564  rmat is inferred
+000057b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000057c0: 2066 726f 6d20 7468 6520 696e 7075 7420   from the input 
+000057d0: 696d 6167 652e 2043 616e 2062 6520 6f6e  image. Can be on
+000057e0: 6520 6f66 3a0a 2020 2020 2020 2020 2020  e of:.          
+000057f0: 2020 2020 2020 2d20 6022 6368 616e 6e65        - `"channe
+00005800: 6c73 5f66 6972 7374 2260 206f 7220 6043  ls_first"` or `C
+00005810: 6861 6e6e 656c 4469 6d65 6e73 696f 6e2e  hannelDimension.
+00005820: 4649 5253 5460 3a20 696d 6167 6520 696e  FIRST`: image in
+00005830: 2028 6e75 6d5f 6368 616e 6e65 6c73 2c20   (num_channels, 
+00005840: 6865 6967 6874 2c20 7769 6474 6829 2066  height, width) f
+00005850: 6f72 6d61 742e 0a20 2020 2020 2020 2020  ormat..         
+00005860: 2020 2020 2020 202d 2060 2263 6861 6e6e         - `"chann
+00005870: 656c 735f 6c61 7374 2260 206f 7220 6043  els_last"` or `C
+00005880: 6861 6e6e 656c 4469 6d65 6e73 696f 6e2e  hannelDimension.
+00005890: 4c41 5354 603a 2069 6d61 6765 2069 6e20  LAST`: image in 
+000058a0: 2868 6569 6768 742c 2077 6964 7468 2c20  (height, width, 
+000058b0: 6e75 6d5f 6368 616e 6e65 6c73 2920 666f  num_channels) fo
+000058c0: 726d 6174 2e0a 2020 2020 2020 2020 2020  rmat..          
+000058d0: 2020 2020 2020 2d20 6022 6e6f 6e65 2260        - `"none"`
+000058e0: 206f 7220 6043 6861 6e6e 656c 4469 6d65   or `ChannelDime
+000058f0: 6e73 696f 6e2e 4e4f 4e45 603a 2069 6d61  nsion.NONE`: ima
+00005900: 6765 2069 6e20 2868 6569 6768 742c 2077  ge in (height, w
+00005910: 6964 7468 2920 666f 726d 6174 2e0a 2020  idth) format..  
+00005920: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00005930: 2020 646f 5f72 6573 697a 6520 3d20 646f    do_resize = do
+00005940: 5f72 6573 697a 6520 6966 2064 6f5f 7265  _resize if do_re
+00005950: 7369 7a65 2069 7320 6e6f 7420 4e6f 6e65  size is not None
+00005960: 2065 6c73 6520 7365 6c66 2e64 6f5f 7265   else self.do_re
+00005970: 7369 7a65 0a20 2020 2020 2020 2073 697a  size.        siz
+00005980: 655f 6469 7669 736f 7220 3d20 7369 7a65  e_divisor = size
+00005990: 5f64 6976 6973 6f72 2069 6620 7369 7a65  _divisor if size
+000059a0: 5f64 6976 6973 6f72 2069 7320 6e6f 7420  _divisor is not 
+000059b0: 4e6f 6e65 2065 6c73 6520 7365 6c66 2e73  None else self.s
+000059c0: 697a 655f 6469 7669 736f 720a 2020 2020  ize_divisor.    
+000059d0: 2020 2020 7265 7361 6d70 6c65 203d 2072      resample = r
+000059e0: 6573 616d 706c 6520 6966 2072 6573 616d  esample if resam
+000059f0: 706c 6520 6973 206e 6f74 204e 6f6e 6520  ple is not None 
+00005a00: 656c 7365 2073 656c 662e 7265 7361 6d70  else self.resamp
+00005a10: 6c65 0a20 2020 2020 2020 2064 6f5f 7265  le.        do_re
+00005a20: 7363 616c 6520 3d20 646f 5f72 6573 6361  scale = do_resca
+00005a30: 6c65 2069 6620 646f 5f72 6573 6361 6c65  le if do_rescale
+00005a40: 2069 7320 6e6f 7420 4e6f 6e65 2065 6c73   is not None els
+00005a50: 6520 7365 6c66 2e64 6f5f 7265 7363 616c  e self.do_rescal
+00005a60: 650a 2020 2020 2020 2020 7265 7363 616c  e.        rescal
+00005a70: 655f 6661 6374 6f72 203d 2072 6573 6361  e_factor = resca
+00005a80: 6c65 5f66 6163 746f 7220 6966 2072 6573  le_factor if res
+00005a90: 6361 6c65 5f66 6163 746f 7220 6973 206e  cale_factor is n
+00005aa0: 6f74 204e 6f6e 6520 656c 7365 2073 656c  ot None else sel
+00005ab0: 662e 7265 7363 616c 655f 6661 6374 6f72  f.rescale_factor
+00005ac0: 0a20 2020 2020 2020 2064 6f5f 6e6f 726d  .        do_norm
+00005ad0: 616c 697a 6520 3d20 646f 5f6e 6f72 6d61  alize = do_norma
+00005ae0: 6c69 7a65 2069 6620 646f 5f6e 6f72 6d61  lize if do_norma
+00005af0: 6c69 7a65 2069 7320 6e6f 7420 4e6f 6e65  lize is not None
+00005b00: 2065 6c73 6520 7365 6c66 2e64 6f5f 6e6f   else self.do_no
+00005b10: 726d 616c 697a 650a 2020 2020 2020 2020  rmalize.        
+00005b20: 696d 6167 655f 6d65 616e 203d 2069 6d61  image_mean = ima
+00005b30: 6765 5f6d 6561 6e20 6966 2069 6d61 6765  ge_mean if image
+00005b40: 5f6d 6561 6e20 6973 206e 6f74 204e 6f6e  _mean is not Non
+00005b50: 6520 656c 7365 2073 656c 662e 696d 6167  e else self.imag
+00005b60: 655f 6d65 616e 0a20 2020 2020 2020 2069  e_mean.        i
+00005b70: 6d61 6765 5f73 7464 203d 2069 6d61 6765  mage_std = image
+00005b80: 5f73 7464 2069 6620 696d 6167 655f 7374  _std if image_st
+00005b90: 6420 6973 206e 6f74 204e 6f6e 6520 656c  d is not None el
+00005ba0: 7365 2073 656c 662e 696d 6167 655f 7374  se self.image_st
+00005bb0: 640a 2020 2020 2020 2020 646f 5f70 6164  d.        do_pad
+00005bc0: 203d 2064 6f5f 7061 6420 6966 2064 6f5f   = do_pad if do_
+00005bd0: 7061 6420 6973 206e 6f74 204e 6f6e 6520  pad is not None 
+00005be0: 656c 7365 2073 656c 662e 646f 5f70 6164  else self.do_pad
+00005bf0: 0a20 2020 2020 2020 2064 6f5f 6365 6e74  .        do_cent
+00005c00: 6572 5f63 726f 7020 6966 2064 6f5f 6365  er_crop if do_ce
+00005c10: 6e74 6572 5f63 726f 7020 6973 206e 6f74  nter_crop is not
+00005c20: 204e 6f6e 6520 656c 7365 2073 656c 662e   None else self.
+00005c30: 646f 5f63 656e 7465 725f 6372 6f70 2023  do_center_crop #
+00005c40: 2070 796c 696e 743a 2064 6973 6162 6c65   pylint: disable
+00005c50: 3d70 6f69 6e74 6c65 7373 2d73 7461 7465  =pointless-state
+00005c60: 6d65 6e74 0a20 2020 2020 2020 2023 2046  ment.        # F
+00005c70: 6f72 2062 6163 6b77 6172 6473 2063 6f6d  or backwards com
+00005c80: 7061 7469 6269 6c69 7479 2e20 496e 6974  patibility. Init
+00005c90: 6961 6c20 7665 7273 696f 6e20 6f66 2074  ial version of t
+00005ca0: 6869 7320 7072 6f63 6573 736f 7220 7761  his processor wa
+00005cb0: 7320 6372 6f70 7069 6e67 2074 6f20 7468  s cropping to th
+00005cc0: 6520 2273 697a 6522 2061 7267 756d 656e  e "size" argumen
+00005cd0: 742c 2077 6869 6368 0a20 2020 2020 2020  t, which.       
+00005ce0: 2023 2069 7420 7368 6f75 6c64 2064 6566   # it should def
+00005cf0: 6175 6c74 2074 6f20 6966 2063 726f 705f  ault to if crop_
+00005d00: 7369 7a65 2069 7320 756e 6465 6669 6e65  size is undefine
+00005d10: 642e 0a20 2020 2020 2020 2063 726f 705f  d..        crop_
+00005d20: 7369 7a65 203d 2028 0a20 2020 2020 2020  size = (.       
+00005d30: 2020 2020 2063 726f 705f 7369 7a65 2069       crop_size i
+00005d40: 6620 6372 6f70 5f73 697a 6520 6973 206e  f crop_size is n
+00005d50: 6f74 204e 6f6e 6520 656c 7365 2028 7365  ot None else (se
+00005d60: 6c66 2e63 726f 705f 7369 7a65 2069 6620  lf.crop_size if 
+00005d70: 7365 6c66 2e63 726f 705f 7369 7a65 2069  self.crop_size i
+00005d80: 7320 6e6f 7420 4e6f 6e65 2065 6c73 6520  s not None else 
+00005d90: 7365 6c66 2e73 697a 6529 0a20 2020 2020  self.size).     
+00005da0: 2020 2029 0a0a 2020 2020 2020 2020 7369     )..        si
+00005db0: 7a65 203d 2073 697a 6520 6966 2073 697a  ze = size if siz
+00005dc0: 6520 6973 206e 6f74 204e 6f6e 6520 656c  e is not None el
+00005dd0: 7365 2073 656c 662e 7369 7a65 0a20 2020  se self.size.   
+00005de0: 2020 2020 2073 697a 6520 3d20 6765 745f       size = get_
+00005df0: 7369 7a65 5f64 6963 7428 7369 7a65 2c20  size_dict(size, 
+00005e00: 6465 6661 756c 745f 746f 5f73 7175 6172  default_to_squar
+00005e10: 653d 4661 6c73 6529 0a0a 2020 2020 2020  e=False)..      
+00005e20: 2020 7661 6c69 6461 7465 5f6b 7761 7267    validate_kwarg
+00005e30: 7328 6361 7074 7572 6564 5f6b 7761 7267  s(captured_kwarg
+00005e40: 733d 6b77 6172 6773 2e6b 6579 7328 292c  s=kwargs.keys(),
+00005e50: 2076 616c 6964 5f70 726f 6365 7373 6f72   valid_processor
+00005e60: 5f6b 6579 733d 7365 6c66 2e5f 7661 6c69  _keys=self._vali
+00005e70: 645f 7072 6f63 6573 736f 725f 6b65 7973  d_processor_keys
+00005e80: 290a 0a20 2020 2020 2020 2069 6620 6e6f  )..        if no
+00005e90: 7420 6973 5f62 6174 6368 6564 2869 6d61  t is_batched(ima
+00005ea0: 6765 7329 3a0a 2020 2020 2020 2020 2020  ges):.          
+00005eb0: 2020 696d 6167 6573 203d 205b 696d 6167    images = [imag
+00005ec0: 6573 5d0a 0a20 2020 2020 2020 2069 6620  es]..        if 
+00005ed0: 6e6f 7420 7661 6c69 645f 696d 6167 6573  not valid_images
+00005ee0: 2869 6d61 6765 7329 3a0a 2020 2020 2020  (images):.      
+00005ef0: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
+00005f00: 6545 7272 6f72 280a 2020 2020 2020 2020  eError(.        
+00005f10: 2020 2020 2020 2020 2249 6e76 616c 6964          "Invalid
+00005f20: 2069 6d61 6765 2074 7970 652e 204d 7573   image type. Mus
+00005f30: 7420 6265 206f 6620 7479 7065 2050 494c  t be of type PIL
+00005f40: 2e49 6d61 6765 2e49 6d61 6765 2c20 6e75  .Image.Image, nu
+00005f50: 6d70 792e 6e64 6172 7261 792c 2022 0a20  mpy.ndarray, ". 
+00005f60: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00005f70: 746f 7263 682e 5465 6e73 6f72 2c20 7466  torch.Tensor, tf
+00005f80: 2e54 656e 736f 7220 6f72 206a 6178 2e6e  .Tensor or jax.n
+00005f90: 6461 7272 6179 2e22 0a20 2020 2020 2020  darray.".       
+00005fa0: 2020 2020 2029 0a20 2020 2020 2020 2023       ).        #
+00005fb0: 2048 6572 652c 2063 726f 705f 7369 7a65   Here, crop_size
+00005fc0: 2069 7320 7573 6564 206f 6e6c 7920 6966   is used only if
+00005fd0: 2069 7420 6973 2073 6574 2c20 656c 7365   it is set, else
+00005fe0: 2073 697a 6520 7769 6c6c 2062 6520 7573   size will be us
+00005ff0: 6564 2e0a 2020 2020 2020 2020 7661 6c69  ed..        vali
+00006000: 6461 7465 5f70 7265 7072 6f63 6573 735f  date_preprocess_
+00006010: 6172 6775 6d65 6e74 7328 0a20 2020 2020  arguments(.     
+00006020: 2020 2020 2020 2064 6f5f 7265 7363 616c         do_rescal
+00006030: 653d 646f 5f72 6573 6361 6c65 2c0a 2020  e=do_rescale,.  
+00006040: 2020 2020 2020 2020 2020 7265 7363 616c            rescal
+00006050: 655f 6661 6374 6f72 3d72 6573 6361 6c65  e_factor=rescale
+00006060: 5f66 6163 746f 722c 0a20 2020 2020 2020  _factor,.       
+00006070: 2020 2020 2064 6f5f 6e6f 726d 616c 697a       do_normaliz
+00006080: 653d 646f 5f6e 6f72 6d61 6c69 7a65 2c0a  e=do_normalize,.
+00006090: 2020 2020 2020 2020 2020 2020 696d 6167              imag
+000060a0: 655f 6d65 616e 3d69 6d61 6765 5f6d 6561  e_mean=image_mea
+000060b0: 6e2c 0a20 2020 2020 2020 2020 2020 2069  n,.            i
+000060c0: 6d61 6765 5f73 7464 3d69 6d61 6765 5f73  mage_std=image_s
+000060d0: 7464 2c0a 2020 2020 2020 2020 2020 2020  td,.            
+000060e0: 646f 5f70 6164 3d64 6f5f 7061 642c 0a20  do_pad=do_pad,. 
+000060f0: 2020 2020 2020 2020 2020 2073 697a 655f             size_
+00006100: 6469 7669 7369 6269 6c69 7479 3d73 697a  divisibility=siz
+00006110: 655f 6469 7669 736f 722c 0a20 2020 2020  e_divisor,.     
+00006120: 2020 2020 2020 2064 6f5f 6365 6e74 6572         do_center
+00006130: 5f63 726f 703d 646f 5f63 656e 7465 725f  _crop=do_center_
+00006140: 6372 6f70 2c0a 2020 2020 2020 2020 2020  crop,.          
+00006150: 2020 6372 6f70 5f73 697a 653d 6372 6f70    crop_size=crop
+00006160: 5f73 697a 652c 0a20 2020 2020 2020 2020  _size,.         
+00006170: 2020 2064 6f5f 7265 7369 7a65 3d64 6f5f     do_resize=do_
+00006180: 7265 7369 7a65 2c0a 2020 2020 2020 2020  resize,.        
+00006190: 2020 2020 7369 7a65 3d73 697a 652c 0a20      size=size,. 
+000061a0: 2020 2020 2020 2020 2020 2072 6573 616d             resam
+000061b0: 706c 653d 7265 7361 6d70 6c65 2c0a 2020  ple=resample,.  
+000061c0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000061d0: 2320 416c 6c20 7472 616e 7366 6f72 6d61  # All transforma
+000061e0: 7469 6f6e 7320 6578 7065 6374 206e 756d  tions expect num
+000061f0: 7079 2061 7272 6179 732e 0a20 2020 2020  py arrays..     
+00006200: 2020 2069 6d61 6765 7320 3d20 5b74 6f5f     images = [to_
+00006210: 6e75 6d70 795f 6172 7261 7928 696d 6167  numpy_array(imag
+00006220: 6529 2066 6f72 2069 6d61 6765 2069 6e20  e) for image in 
+00006230: 696d 6167 6573 5d0a 0a20 2020 2020 2020  images]..       
+00006240: 2069 6620 6973 5f73 6361 6c65 645f 696d   if is_scaled_im
+00006250: 6167 6528 696d 6167 6573 5b30 5d29 2061  age(images[0]) a
+00006260: 6e64 2064 6f5f 7265 7363 616c 653a 0a20  nd do_rescale:. 
+00006270: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+00006280: 722e 7761 726e 696e 675f 6f6e 6365 280a  r.warning_once(.
+00006290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000062a0: 2249 7420 6c6f 6f6b 7320 6c69 6b65 2079  "It looks like y
+000062b0: 6f75 2061 7265 2074 7279 696e 6720 746f  ou are trying to
+000062c0: 2072 6573 6361 6c65 2061 6c72 6561 6479   rescale already
+000062d0: 2072 6573 6361 6c65 6420 696d 6167 6573   rescaled images
+000062e0: 2e20 4966 2074 6865 2069 6e70 7574 220a  . If the input".
+000062f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006300: 2220 696d 6167 6573 2068 6176 6520 7069  " images have pi
+00006310: 7865 6c20 7661 6c75 6573 2062 6574 7765  xel values betwe
+00006320: 656e 2030 2061 6e64 2031 2c20 7365 7420  en 0 and 1, set 
+00006330: 6064 6f5f 7265 7363 616c 653d 4661 6c73  `do_rescale=Fals
+00006340: 6560 2074 6f20 6176 6f69 6420 7265 7363  e` to avoid resc
+00006350: 616c 696e 6720 7468 656d 2061 6761 696e  aling them again
+00006360: 2e22 0a20 2020 2020 2020 2020 2020 2029  .".            )
+00006370: 0a0a 2020 2020 2020 2020 6966 2064 6f5f  ..        if do_
+00006380: 7265 7369 7a65 3a0a 2020 2020 2020 2020  resize:.        
+00006390: 2020 2020 696d 6167 6573 203d 205b 0a20      images = [. 
+000063a0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000063b0: 656c 662e 7265 7369 7a65 280a 2020 2020  elf.resize(.    
+000063c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000063d0: 696d 6167 653d 696d 6167 652c 0a20 2020  image=image,.   
+000063e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000063f0: 2073 697a 653d 7369 7a65 2c0a 2020 2020   size=size,.    
+00006400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006410: 7369 7a65 5f64 6976 6973 6f72 3d73 697a  size_divisor=siz
+00006420: 655f 6469 7669 736f 722c 0a20 2020 2020  e_divisor,.     
+00006430: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00006440: 6573 616d 706c 653d 7265 7361 6d70 6c65  esample=resample
+00006450: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00006460: 2020 2020 2020 696e 7075 745f 6461 7461        input_data
+00006470: 5f66 6f72 6d61 743d 696e 7075 745f 6461  _format=input_da
+00006480: 7461 5f66 6f72 6d61 742c 0a20 2020 2020  ta_format,.     
+00006490: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+000064a0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+000064b0: 2069 6d61 6765 2069 6e20 696d 6167 6573   image in images
+000064c0: 0a20 2020 2020 2020 2020 2020 205d 0a0a  .            ]..
+000064d0: 2020 2020 2020 2020 6966 2064 6f5f 6365          if do_ce
+000064e0: 6e74 6572 5f63 726f 703a 0a20 2020 2020  nter_crop:.     
+000064f0: 2020 2020 2020 2069 6d61 6765 7320 3d20         images = 
+00006500: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+00006510: 2020 7365 6c66 2e63 656e 7465 725f 6372    self.center_cr
+00006520: 6f70 2869 6d61 6765 3d69 6d61 6765 2c20  op(image=image, 
+00006530: 7369 7a65 3d63 726f 705f 7369 7a65 2c20  size=crop_size, 
+00006540: 696e 7075 745f 6461 7461 5f66 6f72 6d61  input_data_forma
+00006550: 743d 696e 7075 745f 6461 7461 5f66 6f72  t=input_data_for
+00006560: 6d61 7429 2066 6f72 2069 6d61 6765 2069  mat) for image i
+00006570: 6e20 696d 6167 6573 0a20 2020 2020 2020  n images.       
+00006580: 2020 2020 205d 0a0a 2020 2020 2020 2020       ]..        
+00006590: 6966 2064 6f5f 7265 7363 616c 653a 0a20  if do_rescale:. 
+000065a0: 2020 2020 2020 2020 2020 2069 6d61 6765             image
+000065b0: 7320 3d20 5b0a 2020 2020 2020 2020 2020  s = [.          
+000065c0: 2020 2020 2020 7365 6c66 2e72 6573 6361        self.resca
+000065d0: 6c65 2869 6d61 6765 3d69 6d61 6765 2c20  le(image=image, 
+000065e0: 7363 616c 653d 7265 7363 616c 655f 6661  scale=rescale_fa
+000065f0: 6374 6f72 2c20 696e 7075 745f 6461 7461  ctor, input_data
+00006600: 5f66 6f72 6d61 743d 696e 7075 745f 6461  _format=input_da
+00006610: 7461 5f66 6f72 6d61 7429 0a20 2020 2020  ta_format).     
+00006620: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
+00006630: 6d61 6765 2069 6e20 696d 6167 6573 0a20  mage in images. 
+00006640: 2020 2020 2020 2020 2020 205d 0a0a 2020             ]..  
+00006650: 2020 2020 2020 6966 2064 6f5f 6e6f 726d        if do_norm
+00006660: 616c 697a 653a 0a20 2020 2020 2020 2020  alize:.         
+00006670: 2020 2069 6d61 6765 7320 3d20 5b0a 2020     images = [.  
+00006680: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00006690: 6c66 2e6e 6f72 6d61 6c69 7a65 2869 6d61  lf.normalize(ima
+000066a0: 6765 3d69 6d61 6765 2c20 6d65 616e 3d69  ge=image, mean=i
+000066b0: 6d61 6765 5f6d 6561 6e2c 2073 7464 3d69  mage_mean, std=i
+000066c0: 6d61 6765 5f73 7464 2c20 696e 7075 745f  mage_std, input_
+000066d0: 6461 7461 5f66 6f72 6d61 743d 696e 7075  data_format=inpu
+000066e0: 745f 6461 7461 5f66 6f72 6d61 7429 0a20  t_data_format). 
+000066f0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00006700: 6f72 2069 6d61 6765 2069 6e20 696d 6167  or image in imag
+00006710: 6573 0a20 2020 2020 2020 2020 2020 205d  es.            ]
+00006720: 0a0a 2020 2020 2020 2020 696d 6167 6573  ..        images
+00006730: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
+00006740: 2074 6f5f 6368 616e 6e65 6c5f 6469 6d65   to_channel_dime
+00006750: 6e73 696f 6e5f 666f 726d 6174 2869 6d61  nsion_format(ima
+00006760: 6765 2c20 6461 7461 5f66 6f72 6d61 742c  ge, data_format,
+00006770: 2069 6e70 7574 5f63 6861 6e6e 656c 5f64   input_channel_d
+00006780: 696d 3d69 6e70 7574 5f64 6174 615f 666f  im=input_data_fo
+00006790: 726d 6174 2920 666f 7220 696d 6167 6520  rmat) for image 
+000067a0: 696e 2069 6d61 6765 730a 2020 2020 2020  in images.      
+000067b0: 2020 5d0a 0a20 2020 2020 2020 2069 6620    ]..        if 
+000067c0: 646f 5f70 6164 3a0a 2020 2020 2020 2020  do_pad:.        
+000067d0: 2020 2020 656e 636f 6465 645f 6f75 7470      encoded_outp
+000067e0: 7574 7320 3d20 7365 6c66 2e70 6164 280a  uts = self.pad(.
+000067f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006800: 696d 6167 6573 2c20 7265 7475 726e 5f70  images, return_p
+00006810: 6978 656c 5f6d 6173 6b3d 5472 7565 2c20  ixel_mask=True, 
+00006820: 7265 7475 726e 5f74 656e 736f 7273 3d72  return_tensors=r
+00006830: 6574 7572 6e5f 7465 6e73 6f72 732c 2069  eturn_tensors, i
+00006840: 6e70 7574 5f64 6174 615f 666f 726d 6174  nput_data_format
+00006850: 3d64 6174 615f 666f 726d 6174 0a20 2020  =data_format.   
+00006860: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00006870: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00006880: 2020 2020 2065 6e63 6f64 6564 5f6f 7574       encoded_out
+00006890: 7075 7473 203d 2042 6174 6368 4665 6174  puts = BatchFeat
+000068a0: 7572 6528 6461 7461 3d7b 2270 6978 656c  ure(data={"pixel
+000068b0: 5f76 616c 7565 7322 3a20 696d 6167 6573  _values": images
+000068c0: 7d2c 2074 656e 736f 725f 7479 7065 3d72  }, tensor_type=r
+000068d0: 6574 7572 6e5f 7465 6e73 6f72 7329 0a0a  eturn_tensors)..
+000068e0: 2020 2020 2020 2020 7265 7475 726e 2065          return e
+000068f0: 6e63 6f64 6564 5f6f 7574 7075 7473 0a0a  ncoded_outputs..
+00006900: 5f5f 616c 6c5f 5f20 3d20 5b27 4272 6964  __all__ = ['Brid
+00006910: 6765 546f 7765 7249 6d61 6765 5072 6f63  geTowerImageProc
+00006920: 6573 736f 7227 5d0a                      essor'].
```

## mindnlp/transformers/models/bridgetower/modeling_bridgetower.py

```diff
@@ -0,0 +1,5099 @@
+00000000: 2320 636f 6469 6e67 3d75 7466 2d38 0a23  # coding=utf-8.#
+00000010: 2043 6f70 7972 6967 6874 2032 3032 3320   Copyright 2023 
+00000020: 5468 6520 496e 7465 6c20 4c61 6273 2054  The Intel Labs T
+00000030: 6561 6d20 4175 7468 6f72 732c 2054 6865  eam Authors, The
+00000040: 204d 6963 726f 736f 6674 2052 6573 6561   Microsoft Resea
+00000050: 7263 6820 5465 616d 2041 7574 686f 7273  rch Team Authors
+00000060: 2061 6e64 2048 7567 6769 6e67 4661 6365   and HuggingFace
+00000070: 2049 6e63 2e20 7465 616d 2e20 416c 6c20   Inc. team. All 
+00000080: 7269 6768 7473 2072 6573 6572 7665 642e  rights reserved.
+00000090: 0a23 0a23 204c 6963 656e 7365 6420 756e  .#.# Licensed un
+000000a0: 6465 7220 7468 6520 4170 6163 6865 204c  der the Apache L
+000000b0: 6963 656e 7365 2c20 5665 7273 696f 6e20  icense, Version 
+000000c0: 322e 3020 2874 6865 2022 4c69 6365 6e73  2.0 (the "Licens
+000000d0: 6522 293b 0a23 2079 6f75 206d 6179 206e  e");.# you may n
+000000e0: 6f74 2075 7365 2074 6869 7320 6669 6c65  ot use this file
+000000f0: 2065 7863 6570 7420 696e 2063 6f6d 706c   except in compl
+00000100: 6961 6e63 6520 7769 7468 2074 6865 204c  iance with the L
+00000110: 6963 656e 7365 2e0a 2320 596f 7520 6d61  icense..# You ma
+00000120: 7920 6f62 7461 696e 2061 2063 6f70 7920  y obtain a copy 
+00000130: 6f66 2074 6865 204c 6963 656e 7365 2061  of the License a
+00000140: 740a 230a 2320 2020 2020 6874 7470 3a2f  t.#.#     http:/
+00000150: 2f77 7777 2e61 7061 6368 652e 6f72 672f  /www.apache.org/
+00000160: 6c69 6365 6e73 6573 2f4c 4943 454e 5345  licenses/LICENSE
+00000170: 2d32 2e30 0a23 0a23 2055 6e6c 6573 7320  -2.0.#.# Unless 
+00000180: 7265 7175 6972 6564 2062 7920 6170 706c  required by appl
+00000190: 6963 6162 6c65 206c 6177 206f 7220 6167  icable law or ag
+000001a0: 7265 6564 2074 6f20 696e 2077 7269 7469  reed to in writi
+000001b0: 6e67 2c20 736f 6674 7761 7265 0a23 2064  ng, software.# d
+000001c0: 6973 7472 6962 7574 6564 2075 6e64 6572  istributed under
+000001d0: 2074 6865 204c 6963 656e 7365 2069 7320   the License is 
+000001e0: 6469 7374 7269 6275 7465 6420 6f6e 2061  distributed on a
+000001f0: 6e20 2241 5320 4953 2220 4241 5349 532c  n "AS IS" BASIS,
+00000200: 0a23 2057 4954 484f 5554 2057 4152 5241  .# WITHOUT WARRA
+00000210: 4e54 4945 5320 4f52 2043 4f4e 4449 5449  NTIES OR CONDITI
+00000220: 4f4e 5320 4f46 2041 4e59 204b 494e 442c  ONS OF ANY KIND,
+00000230: 2065 6974 6865 7220 6578 7072 6573 7320   either express 
+00000240: 6f72 2069 6d70 6c69 6564 2e0a 2320 5365  or implied..# Se
+00000250: 6520 7468 6520 4c69 6365 6e73 6520 666f  e the License fo
+00000260: 7220 7468 6520 7370 6563 6966 6963 206c  r the specific l
+00000270: 616e 6775 6167 6520 676f 7665 726e 696e  anguage governin
+00000280: 6720 7065 726d 6973 7369 6f6e 7320 616e  g permissions an
+00000290: 640a 2320 6c69 6d69 7461 7469 6f6e 7320  d.# limitations 
+000002a0: 756e 6465 7220 7468 6520 4c69 6365 6e73  under the Licens
+000002b0: 652e 0a22 2222 4d69 6e64 5370 6f72 6520  e.."""MindSpore 
+000002c0: 4272 6964 6765 546f 7765 7220 4d6f 6465  BridgeTower Mode
+000002d0: 6c22 2222 0a69 6d70 6f72 7420 6d61 7468  l""".import math
+000002e0: 0a66 726f 6d20 636f 6c6c 6563 7469 6f6e  .from collection
+000002f0: 7320 696d 706f 7274 204f 7264 6572 6564  s import Ordered
+00000300: 4469 6374 0a66 726f 6d20 6461 7461 636c  Dict.from datacl
+00000310: 6173 7365 7320 696d 706f 7274 2064 6174  asses import dat
+00000320: 6163 6c61 7373 0a66 726f 6d20 7479 7069  aclass.from typi
+00000330: 6e67 2069 6d70 6f72 7420 4c69 7374 2c20  ng import List, 
+00000340: 4f70 7469 6f6e 616c 2c20 5475 706c 652c  Optional, Tuple,
+00000350: 2055 6e69 6f6e 0a0a 696d 706f 7274 206d   Union..import m
+00000360: 696e 6473 706f 7265 0a66 726f 6d20 6d69  indspore.from mi
+00000370: 6e64 7370 6f72 6520 696d 706f 7274 206e  ndspore import n
+00000380: 6e2c 206f 7073 2c20 5061 7261 6d65 7465  n, ops, Paramete
+00000390: 720a 6672 6f6d 206d 696e 6473 706f 7265  r.from mindspore
+000003a0: 2e63 6f6d 6d6f 6e2e 696e 6974 6961 6c69  .common.initiali
+000003b0: 7a65 7220 696d 706f 7274 204e 6f72 6d61  zer import Norma
+000003c0: 6c0a 0a66 726f 6d20 6d69 6e64 6e6c 702e  l..from mindnlp.
+000003d0: 6d6f 6475 6c65 732e 6675 6e63 7469 6f6e  modules.function
+000003e0: 616c 2069 6d70 6f72 7420 6e6f 726d 616c  al import normal
+000003f0: 697a 650a 6672 6f6d 202e 2e2e 6163 7469  ize.from ...acti
+00000400: 7661 7469 6f6e 7320 696d 706f 7274 2041  vations import A
+00000410: 4354 3246 4e2c 2051 7569 636b 4745 4c55  CT2FN, QuickGELU
+00000420: 4163 7469 7661 7469 6f6e 0a66 726f 6d20  Activation.from 
+00000430: 2e2e 2e6d 6f64 656c 696e 675f 6f75 7470  ...modeling_outp
+00000440: 7574 7320 696d 706f 7274 2028 0a20 2020  uts import (.   
+00000450: 2042 6173 654d 6f64 656c 4f75 7470 7574   BaseModelOutput
+00000460: 5769 7468 5061 7374 416e 6443 726f 7373  WithPastAndCross
+00000470: 4174 7465 6e74 696f 6e73 2c0a 2020 2020  Attentions,.    
+00000480: 4261 7365 4d6f 6465 6c4f 7574 7075 7457  BaseModelOutputW
+00000490: 6974 6850 6f6f 6c69 6e67 416e 6443 726f  ithPoolingAndCro
+000004a0: 7373 4174 7465 6e74 696f 6e73 2c0a 2020  ssAttentions,.  
+000004b0: 2020 4d61 736b 6564 4c4d 4f75 7470 7574    MaskedLMOutput
+000004c0: 2c0a 2020 2020 4d6f 6465 6c4f 7574 7075  ,.    ModelOutpu
+000004d0: 742c 0a20 2020 2053 6571 7565 6e63 6543  t,.    SequenceC
+000004e0: 6c61 7373 6966 6965 724f 7574 7075 742c  lassifierOutput,
+000004f0: 0a29 0a66 726f 6d20 2e2e 2e6d 6f64 656c  .).from ...model
+00000500: 696e 675f 7574 696c 7320 696d 706f 7274  ing_utils import
+00000510: 2050 7265 5472 6169 6e65 644d 6f64 656c   PreTrainedModel
+00000520: 0a66 726f 6d20 2e2e 2e6d 735f 7574 696c  .from ...ms_util
+00000530: 7320 696d 706f 7274 2066 696e 645f 7072  s import find_pr
+00000540: 756e 6561 626c 655f 6865 6164 735f 616e  uneable_heads_an
+00000550: 645f 696e 6469 6365 732c 2070 7275 6e65  d_indices, prune
+00000560: 5f6c 696e 6561 725f 6c61 7965 722c 2061  _linear_layer, a
+00000570: 7070 6c79 5f63 6875 6e6b 696e 675f 746f  pply_chunking_to
+00000580: 5f66 6f72 7761 7264 0a66 726f 6d20 2e2e  _forward.from ..
+00000590: 2e2e 7574 696c 7320 696d 706f 7274 206c  ..utils import l
+000005a0: 6f67 6769 6e67 0a66 726f 6d20 2e63 6f6e  ogging.from .con
+000005b0: 6669 6775 7261 7469 6f6e 5f62 7269 6467  figuration_bridg
+000005c0: 6574 6f77 6572 2069 6d70 6f72 7420 4272  etower import Br
+000005d0: 6964 6765 546f 7765 7243 6f6e 6669 672c  idgeTowerConfig,
+000005e0: 2042 7269 6467 6554 6f77 6572 5465 7874   BridgeTowerText
+000005f0: 436f 6e66 6967 2c20 4272 6964 6765 546f  Config, BridgeTo
+00000600: 7765 7256 6973 696f 6e43 6f6e 6669 670a  werVisionConfig.
+00000610: 0a0a 6c6f 6767 6572 203d 206c 6f67 6769  ..logger = loggi
+00000620: 6e67 2e67 6574 5f6c 6f67 6765 7228 5f5f  ng.get_logger(__
+00000630: 6e61 6d65 5f5f 290a 0a5f 434f 4e46 4947  name__).._CONFIG
+00000640: 5f46 4f52 5f44 4f43 203d 2022 4272 6964  _FOR_DOC = "Brid
+00000650: 6765 546f 7765 7243 6f6e 6669 6722 0a5f  geTowerConfig"._
+00000660: 4348 4543 4b50 4f49 4e54 5f46 4f52 5f44  CHECKPOINT_FOR_D
+00000670: 4f43 203d 2022 4272 6964 6765 546f 7765  OC = "BridgeTowe
+00000680: 722f 6272 6964 6765 746f 7765 722d 6261  r/bridgetower-ba
+00000690: 7365 220a 5f54 4f4b 454e 495a 4552 5f46  se"._TOKENIZER_F
+000006a0: 4f52 5f44 4f43 203d 2022 526f 6265 7274  OR_DOC = "Robert
+000006b0: 6154 6f6b 656e 697a 6572 220a 0a0a 4064  aTokenizer"...@d
+000006c0: 6174 6163 6c61 7373 0a63 6c61 7373 2042  ataclass.class B
+000006d0: 7269 6467 6554 6f77 6572 4d6f 6465 6c4f  ridgeTowerModelO
+000006e0: 7574 7075 7428 4d6f 6465 6c4f 7574 7075  utput(ModelOutpu
+000006f0: 7429 3a0a 2020 2020 2222 220a 2020 2020  t):.    """.    
+00000700: 4f75 7470 7574 2074 7970 6520 6f66 205b  Output type of [
+00000710: 6042 7269 6467 6554 6f77 6572 4d6f 6465  `BridgeTowerMode
+00000720: 6c60 5d2e 0a0a 2020 2020 4172 6773 3a0a  l`]...    Args:.
+00000730: 2020 2020 2020 2020 7465 7874 5f66 6561          text_fea
+00000740: 7475 7265 7320 2860 6d69 6e64 7370 6f72  tures (`mindspor
+00000750: 652e 5465 6e73 6f72 6020 6f66 2073 6861  e.Tensor` of sha
+00000760: 7065 2060 2862 6174 6368 5f73 697a 652c  pe `(batch_size,
+00000770: 2074 6578 745f 7365 7175 656e 6365 5f6c   text_sequence_l
+00000780: 656e 6774 682c 2068 6964 6465 6e5f 7369  ength, hidden_si
+00000790: 7a65 2960 293a 0a20 2020 2020 2020 2020  ze)`):.         
+000007a0: 2020 2053 6571 7565 6e63 6520 6f66 2068     Sequence of h
+000007b0: 6964 6465 6e2d 7374 6174 6573 2061 7420  idden-states at 
+000007c0: 7468 6520 7465 7874 206f 7574 7075 7420  the text output 
+000007d0: 6f66 2074 6865 206c 6173 7420 6c61 7965  of the last laye
+000007e0: 7220 6f66 2074 6865 206d 6f64 656c 2e0a  r of the model..
+000007f0: 2020 2020 2020 2020 696d 6167 655f 6665          image_fe
+00000800: 6174 7572 6573 2028 606d 696e 6473 706f  atures (`mindspo
+00000810: 7265 2e54 656e 736f 7260 206f 6620 7368  re.Tensor` of sh
+00000820: 6170 6520 6028 6261 7463 685f 7369 7a65  ape `(batch_size
+00000830: 2c20 696d 6167 655f 7365 7175 656e 6365  , image_sequence
+00000840: 5f6c 656e 6774 682c 2068 6964 6465 6e5f  _length, hidden_
+00000850: 7369 7a65 2960 293a 0a20 2020 2020 2020  size)`):.       
+00000860: 2020 2020 2053 6571 7565 6e63 6520 6f66       Sequence of
+00000870: 2068 6964 6465 6e2d 7374 6174 6573 2061   hidden-states a
+00000880: 7420 7468 6520 696d 6167 6520 6f75 7470  t the image outp
+00000890: 7574 206f 6620 7468 6520 6c61 7374 206c  ut of the last l
+000008a0: 6179 6572 206f 6620 7468 6520 6d6f 6465  ayer of the mode
+000008b0: 6c2e 0a20 2020 2020 2020 2070 6f6f 6c65  l..        poole
+000008c0: 725f 6f75 7470 7574 2028 606d 696e 6473  r_output (`minds
+000008d0: 706f 7265 2e54 656e 736f 7260 206f 6620  pore.Tensor` of 
+000008e0: 7368 6170 6520 6028 6261 7463 685f 7369  shape `(batch_si
+000008f0: 7a65 2c20 6869 6464 656e 5f73 697a 6520  ze, hidden_size 
+00000900: 7820 3229 6029 3a0a 2020 2020 2020 2020  x 2)`):.        
+00000910: 2020 2020 436f 6e63 6174 656e 6174 696f      Concatenatio
+00000920: 6e20 6f66 206c 6173 7420 6c61 7965 7220  n of last layer 
+00000930: 6869 6464 656e 2d73 7461 7465 206f 6620  hidden-state of 
+00000940: 7468 6520 6669 7273 7420 746f 6b65 6e20  the first token 
+00000950: 6f66 2074 6865 2074 6578 7420 616e 6420  of the text and 
+00000960: 696d 6167 6520 7365 7175 656e 6365 2028  image sequence (
+00000970: 636c 6173 7369 6669 6361 7469 6f6e 0a20  classification. 
+00000980: 2020 2020 2020 2020 2020 2074 6f6b 656e             token
+00000990: 292c 2072 6573 7065 6374 6976 656c 792c  ), respectively,
+000009a0: 2061 6674 6572 2066 7572 7468 6572 2070   after further p
+000009b0: 726f 6365 7373 696e 6720 7468 726f 7567  rocessing throug
+000009c0: 6820 6c61 7965 7273 2075 7365 6420 666f  h layers used fo
+000009d0: 7220 6175 7869 6c69 6172 7920 7072 6574  r auxiliary pret
+000009e0: 7261 696e 696e 6720 7461 736b 732e 0a20  raining tasks.. 
+000009f0: 2020 2020 2020 2068 6964 6465 6e5f 7374         hidden_st
+00000a00: 6174 6573 2028 6074 7570 6c65 286d 696e  ates (`tuple(min
+00000a10: 6473 706f 7265 2e54 656e 736f 7229 602c  dspore.Tensor)`,
+00000a20: 202a 6f70 7469 6f6e 616c 2a2c 2072 6574   *optional*, ret
+00000a30: 7572 6e65 6420 7768 656e 2060 6f75 7470  urned when `outp
+00000a40: 7574 5f68 6964 6465 6e5f 7374 6174 6573  ut_hidden_states
+00000a50: 3d54 7275 6560 2069 7320 7061 7373 6564  =True` is passed
+00000a60: 206f 7220 7768 656e 2060 636f 6e66 6967   or when `config
+00000a70: 2e6f 7574 7075 745f 6869 6464 656e 5f73  .output_hidden_s
+00000a80: 7461 7465 733d 5472 7565 6029 3a0a 2020  tates=True`):.  
+00000a90: 2020 2020 2020 2020 2020 5475 706c 6520            Tuple 
+00000aa0: 6f66 2060 6d69 6e64 7370 6f72 652e 5465  of `mindspore.Te
+00000ab0: 6e73 6f72 6020 286f 6e65 2066 6f72 2074  nsor` (one for t
+00000ac0: 6865 206f 7574 7075 7420 6f66 2074 6865  he output of the
+00000ad0: 2065 6d62 6564 6469 6e67 732c 2069 6620   embeddings, if 
+00000ae0: 7468 6520 6d6f 6465 6c20 6861 7320 616e  the model has an
+00000af0: 2065 6d62 6564 6469 6e67 206c 6179 6572   embedding layer
+00000b00: 2c20 2b0a 2020 2020 2020 2020 2020 2020  , +.            
+00000b10: 6f6e 6520 666f 7220 7468 6520 6f75 7470  one for the outp
+00000b20: 7574 206f 6620 6561 6368 206c 6179 6572  ut of each layer
+00000b30: 2920 6f66 2073 6861 7065 2060 2862 6174  ) of shape `(bat
+00000b40: 6368 5f73 697a 652c 2073 6571 7565 6e63  ch_size, sequenc
+00000b50: 655f 6c65 6e67 7468 2c20 6869 6464 656e  e_length, hidden
+00000b60: 5f73 697a 6529 602e 2048 6964 6465 6e2d  _size)`. Hidden-
+00000b70: 7374 6174 6573 206f 660a 2020 2020 2020  states of.      
+00000b80: 2020 2020 2020 7468 6520 6d6f 6465 6c20        the model 
+00000b90: 6174 2074 6865 206f 7574 7075 7420 6f66  at the output of
+00000ba0: 2065 6163 6820 6c61 7965 7220 706c 7573   each layer plus
+00000bb0: 2074 6865 206f 7074 696f 6e61 6c20 696e   the optional in
+00000bc0: 6974 6961 6c20 656d 6265 6464 696e 6720  itial embedding 
+00000bd0: 6f75 7470 7574 732e 0a20 2020 2020 2020  outputs..       
+00000be0: 2061 7474 656e 7469 6f6e 7320 2860 7475   attentions (`tu
+00000bf0: 706c 6528 6d69 6e64 7370 6f72 652e 5465  ple(mindspore.Te
+00000c00: 6e73 6f72 2960 2c20 2a6f 7074 696f 6e61  nsor)`, *optiona
+00000c10: 6c2a 2c20 7265 7475 726e 6564 2077 6865  l*, returned whe
+00000c20: 6e20 606f 7574 7075 745f 6174 7465 6e74  n `output_attent
+00000c30: 696f 6e73 3d54 7275 6560 2069 7320 7061  ions=True` is pa
+00000c40: 7373 6564 206f 7220 7768 656e 2060 636f  ssed or when `co
+00000c50: 6e66 6967 2e6f 7574 7075 745f 6174 7465  nfig.output_atte
+00000c60: 6e74 696f 6e73 3d54 7275 6560 293a 0a20  ntions=True`):. 
+00000c70: 2020 2020 2020 2020 2020 2054 7570 6c65             Tuple
+00000c80: 206f 6620 606d 696e 6473 706f 7265 2e54   of `mindspore.T
+00000c90: 656e 736f 7260 2028 6f6e 6520 666f 7220  ensor` (one for 
+00000ca0: 6561 6368 206c 6179 6572 2920 6f66 2073  each layer) of s
+00000cb0: 6861 7065 2060 2862 6174 6368 5f73 697a  hape `(batch_siz
+00000cc0: 652c 206e 756d 5f68 6561 6473 2c20 7365  e, num_heads, se
+00000cd0: 7175 656e 6365 5f6c 656e 6774 682c 0a20  quence_length,. 
+00000ce0: 2020 2020 2020 2020 2020 2073 6571 7565             seque
+00000cf0: 6e63 655f 6c65 6e67 7468 2960 2e0a 0a20  nce_length)`... 
+00000d00: 2020 2020 2020 2020 2020 2041 7474 656e             Atten
+00000d10: 7469 6f6e 7320 7765 6967 6874 7320 6166  tions weights af
+00000d20: 7465 7220 7468 6520 6174 7465 6e74 696f  ter the attentio
+00000d30: 6e20 736f 6674 6d61 782c 2075 7365 6420  n softmax, used 
+00000d40: 746f 2063 6f6d 7075 7465 2074 6865 2077  to compute the w
+00000d50: 6569 6768 7465 6420 6176 6572 6167 6520  eighted average 
+00000d60: 696e 2074 6865 2073 656c 662d 6174 7465  in the self-atte
+00000d70: 6e74 696f 6e0a 2020 2020 2020 2020 2020  ntion.          
+00000d80: 2020 6865 6164 732e 0a20 2020 2022 2222    heads..    """
+00000d90: 0a0a 2020 2020 7465 7874 5f66 6561 7475  ..    text_featu
+00000da0: 7265 733a 206d 696e 6473 706f 7265 2e54  res: mindspore.T
+00000db0: 656e 736f 7220 3d20 4e6f 6e65 0a20 2020  ensor = None.   
+00000dc0: 2069 6d61 6765 5f66 6561 7475 7265 733a   image_features:
+00000dd0: 206d 696e 6473 706f 7265 2e54 656e 736f   mindspore.Tenso
+00000de0: 7220 3d20 4e6f 6e65 0a20 2020 2070 6f6f  r = None.    poo
+00000df0: 6c65 725f 6f75 7470 7574 3a20 6d69 6e64  ler_output: mind
+00000e00: 7370 6f72 652e 5465 6e73 6f72 203d 204e  spore.Tensor = N
+00000e10: 6f6e 650a 2020 2020 6869 6464 656e 5f73  one.    hidden_s
+00000e20: 7461 7465 733a 204f 7074 696f 6e61 6c5b  tates: Optional[
+00000e30: 5475 706c 655b 6d69 6e64 7370 6f72 652e  Tuple[mindspore.
+00000e40: 5465 6e73 6f72 5d5d 203d 204e 6f6e 650a  Tensor]] = None.
+00000e50: 2020 2020 6174 7465 6e74 696f 6e73 3a20      attentions: 
+00000e60: 4f70 7469 6f6e 616c 5b54 7570 6c65 5b6d  Optional[Tuple[m
+00000e70: 696e 6473 706f 7265 2e54 656e 736f 725d  indspore.Tensor]
+00000e80: 5d20 3d20 4e6f 6e65 0a0a 0a40 6461 7461  ] = None...@data
+00000e90: 636c 6173 730a 636c 6173 7320 4272 6964  class.class Brid
+00000ea0: 6765 546f 7765 7243 6f6e 7472 6173 7469  geTowerContrasti
+00000eb0: 7665 4f75 7470 7574 284d 6f64 656c 4f75  veOutput(ModelOu
+00000ec0: 7470 7574 293a 0a20 2020 2022 2222 0a20  tput):.    """. 
+00000ed0: 2020 204f 7574 7075 7420 7479 7065 206f     Output type o
+00000ee0: 6620 5b27 4272 6964 6765 546f 7765 7246  f ['BridgeTowerF
+00000ef0: 6f72 436f 6e74 7261 7374 6976 654c 6561  orContrastiveLea
+00000f00: 726e 696e 6727 5d0a 0a20 2020 2041 7267  rning']..    Arg
+00000f10: 733a 0a20 2020 2020 2020 206c 6f73 7320  s:.        loss 
+00000f20: 2860 6d69 6e64 7370 6f72 652e 5465 6e73  (`mindspore.Tens
+00000f30: 6f72 6020 6f66 2073 6861 7065 2060 2831  or` of shape `(1
+00000f40: 2c29 602c 202a 6f70 7469 6f6e 616c 2a2c  ,)`, *optional*,
+00000f50: 2072 6574 7572 6e65 6420 7768 656e 2060   returned when `
+00000f60: 7265 7475 726e 5f6c 6f73 7360 2069 7320  return_loss` is 
+00000f70: 6054 7275 6560 3a0a 2020 2020 2020 2020  `True`:.        
+00000f80: 2020 2020 496d 6167 652d 7465 7874 2063      Image-text c
+00000f90: 6f6e 7472 6173 7469 7665 206c 6f73 732e  ontrastive loss.
+00000fa0: 0a20 2020 2020 2020 206c 6f67 6974 7320  .        logits 
+00000fb0: 2860 6d69 6e64 7370 6f72 652e 5465 6e73  (`mindspore.Tens
+00000fc0: 6f72 6020 6f66 2073 6861 7065 2060 2862  or` of shape `(b
+00000fd0: 6174 6368 5f73 697a 652c 2073 6571 7565  atch_size, seque
+00000fe0: 6e63 655f 6c65 6e67 7468 2c20 636f 6e66  nce_length, conf
+00000ff0: 6967 2e76 6f63 6162 5f73 697a 6529 6029  ig.vocab_size)`)
+00001000: 3a0a 2020 2020 2020 2020 2020 2020 5072  :.            Pr
+00001010: 6564 6963 7469 6f6e 2073 636f 7265 7320  ediction scores 
+00001020: 6f66 2074 6865 206c 616e 6775 6167 6520  of the language 
+00001030: 6d6f 6465 6c69 6e67 2068 6561 6420 2873  modeling head (s
+00001040: 636f 7265 7320 666f 7220 6561 6368 2076  cores for each v
+00001050: 6f63 6162 756c 6172 7920 746f 6b65 6e20  ocabulary token 
+00001060: 6265 666f 7265 2053 6f66 744d 6178 292e  before SoftMax).
+00001070: 0a20 2020 2020 2020 2074 6578 745f 656d  .        text_em
+00001080: 6265 6473 2028 606d 696e 6473 706f 7265  beds (`mindspore
+00001090: 2e54 656e 736f 7229 602c 202a 6f70 7469  .Tensor)`, *opti
+000010a0: 6f6e 616c 2a2c 2072 6574 7572 6e65 6420  onal*, returned 
+000010b0: 7768 656e 206d 6f64 656c 2069 7320 696e  when model is in
+000010c0: 6974 6961 6c69 7a65 6420 7769 7468 2060  itialized with `
+000010d0: 7769 7468 5f70 726f 6a65 6374 696f 6e3d  with_projection=
+000010e0: 5472 7565 6029 3a0a 2020 2020 2020 2020  True`):.        
+000010f0: 2020 2020 5468 6520 7465 7874 2065 6d62      The text emb
+00001100: 6564 6469 6e67 7320 6f62 7461 696e 6564  eddings obtained
+00001110: 2062 7920 6170 706c 7969 6e67 2074 6865   by applying the
+00001120: 2070 726f 6a65 6374 696f 6e20 6c61 7965   projection laye
+00001130: 7220 746f 2074 6865 2070 6f6f 6c65 725f  r to the pooler_
+00001140: 6f75 7470 7574 2e0a 2020 2020 2020 2020  output..        
+00001150: 696d 6167 655f 656d 6265 6473 2028 606d  image_embeds (`m
+00001160: 696e 6473 706f 7265 2e54 656e 736f 7229  indspore.Tensor)
+00001170: 602c 202a 6f70 7469 6f6e 616c 2a2c 2072  `, *optional*, r
+00001180: 6574 7572 6e65 6420 7768 656e 206d 6f64  eturned when mod
+00001190: 656c 2069 7320 696e 6974 6961 6c69 7a65  el is initialize
+000011a0: 6420 7769 7468 2060 7769 7468 5f70 726f  d with `with_pro
+000011b0: 6a65 6374 696f 6e3d 5472 7565 6029 3a0a  jection=True`):.
+000011c0: 2020 2020 2020 2020 2020 2020 5468 6520              The 
+000011d0: 696d 6167 6520 656d 6265 6464 696e 6773  image embeddings
+000011e0: 206f 6274 6169 6e65 6420 6279 2061 7070   obtained by app
+000011f0: 6c79 696e 6720 7468 6520 7072 6f6a 6563  lying the projec
+00001200: 7469 6f6e 206c 6179 6572 2074 6f20 7468  tion layer to th
+00001210: 6520 706f 6f6c 6572 5f6f 7574 7075 742e  e pooler_output.
+00001220: 0a20 2020 2020 2020 2063 726f 7373 5f65  .        cross_e
+00001230: 6d62 6564 7320 2028 606d 696e 6473 706f  mbeds  (`mindspo
+00001240: 7265 2e54 656e 736f 7229 602c 202a 6f70  re.Tensor)`, *op
+00001250: 7469 6f6e 616c 2a2c 2072 6574 7572 6e65  tional*, returne
+00001260: 6420 7768 656e 206d 6f64 656c 2069 7320  d when model is 
+00001270: 696e 6974 6961 6c69 7a65 6420 7769 7468  initialized with
+00001280: 2060 7769 7468 5f70 726f 6a65 6374 696f   `with_projectio
+00001290: 6e3d 5472 7565 6029 3a0a 2020 2020 2020  n=True`):.      
+000012a0: 2020 2020 2020 5468 6520 7465 7874 2d69        The text-i
+000012b0: 6d61 6765 2063 726f 7373 2d6d 6f64 616c  mage cross-modal
+000012c0: 2065 6d62 6564 6469 6e67 7320 6f62 7461   embeddings obta
+000012d0: 696e 6564 2062 7920 6170 706c 7969 6e67  ined by applying
+000012e0: 2074 6865 2070 726f 6a65 6374 696f 6e20   the projection 
+000012f0: 6c61 7965 7220 746f 2074 6865 2070 6f6f  layer to the poo
+00001300: 6c65 725f 6f75 7470 7574 2e0a 2020 2020  ler_output..    
+00001310: 2020 2020 6869 6464 656e 5f73 7461 7465      hidden_state
+00001320: 7320 2860 7475 706c 6528 6d69 6e64 7370  s (`tuple(mindsp
+00001330: 6f72 652e 5465 6e73 6f72 2960 2c20 2a6f  ore.Tensor)`, *o
+00001340: 7074 696f 6e61 6c2a 2c20 7265 7475 726e  ptional*, return
+00001350: 6564 2077 6865 6e20 606f 7574 7075 745f  ed when `output_
+00001360: 6869 6464 656e 5f73 7461 7465 733d 5472  hidden_states=Tr
+00001370: 7565 6020 6973 2070 6173 7365 6420 6f72  ue` is passed or
+00001380: 2077 6865 6e20 6063 6f6e 6669 672e 6f75   when `config.ou
+00001390: 7470 7574 5f68 6964 6465 6e5f 7374 6174  tput_hidden_stat
+000013a0: 6573 3d54 7275 6560 293a 0a20 2020 2020  es=True`):.     
+000013b0: 2020 2020 2020 2054 7570 6c65 206f 6620         Tuple of 
+000013c0: 606d 696e 6473 706f 7265 2e54 656e 736f  `mindspore.Tenso
+000013d0: 7260 2028 6f6e 6520 666f 7220 7468 6520  r` (one for the 
+000013e0: 6f75 7470 7574 206f 6620 7468 6520 656d  output of the em
+000013f0: 6265 6464 696e 6773 2c20 6966 2074 6865  beddings, if the
+00001400: 206d 6f64 656c 2068 6173 2061 6e20 656d   model has an em
+00001410: 6265 6464 696e 6720 6c61 7965 722c 202b  bedding layer, +
+00001420: 0a20 2020 2020 2020 2020 2020 206f 6e65  .            one
+00001430: 2066 6f72 2074 6865 206f 7574 7075 7420   for the output 
+00001440: 6f66 2065 6163 6820 6c61 7965 7229 206f  of each layer) o
+00001450: 6620 7368 6170 6520 6028 6261 7463 685f  f shape `(batch_
+00001460: 7369 7a65 2c20 7365 7175 656e 6365 5f6c  size, sequence_l
+00001470: 656e 6774 682c 2068 6964 6465 6e5f 7369  ength, hidden_si
+00001480: 7a65 2960 2e20 4869 6464 656e 2d73 7461  ze)`. Hidden-sta
+00001490: 7465 7320 6f66 0a20 2020 2020 2020 2020  tes of.         
+000014a0: 2020 2074 6865 206d 6f64 656c 2061 7420     the model at 
+000014b0: 7468 6520 6f75 7470 7574 206f 6620 6561  the output of ea
+000014c0: 6368 206c 6179 6572 2070 6c75 7320 7468  ch layer plus th
+000014d0: 6520 6f70 7469 6f6e 616c 2069 6e69 7469  e optional initi
+000014e0: 616c 2065 6d62 6564 6469 6e67 206f 7574  al embedding out
+000014f0: 7075 7473 2e0a 2020 2020 2020 2020 6174  puts..        at
+00001500: 7465 6e74 696f 6e73 2028 6074 7570 6c65  tentions (`tuple
+00001510: 286d 696e 6473 706f 7265 2e54 656e 736f  (mindspore.Tenso
+00001520: 7229 602c 202a 6f70 7469 6f6e 616c 2a2c  r)`, *optional*,
+00001530: 2072 6574 7572 6e65 6420 7768 656e 2060   returned when `
+00001540: 6f75 7470 7574 5f61 7474 656e 7469 6f6e  output_attention
+00001550: 733d 5472 7565 6020 6973 2070 6173 7365  s=True` is passe
+00001560: 6420 6f72 2077 6865 6e20 6063 6f6e 6669  d or when `confi
+00001570: 672e 6f75 7470 7574 5f61 7474 656e 7469  g.output_attenti
+00001580: 6f6e 733d 5472 7565 6029 3a0a 2020 2020  ons=True`):.    
+00001590: 2020 2020 2020 2020 5475 706c 6520 6f66          Tuple of
+000015a0: 2060 6d69 6e64 7370 6f72 652e 5465 6e73   `mindspore.Tens
+000015b0: 6f72 6020 286f 6e65 2066 6f72 2065 6163  or` (one for eac
+000015c0: 6820 6c61 7965 7229 206f 6620 7368 6170  h layer) of shap
+000015d0: 6520 6028 6261 7463 685f 7369 7a65 2c20  e `(batch_size, 
+000015e0: 6e75 6d5f 6865 6164 732c 2073 6571 7565  num_heads, seque
+000015f0: 6e63 655f 6c65 6e67 7468 2c0a 2020 2020  nce_length,.    
+00001600: 2020 2020 2020 2020 7365 7175 656e 6365          sequence
+00001610: 5f6c 656e 6774 6829 602e 0a20 2020 2022  _length)`..    "
+00001620: 2222 0a0a 2020 2020 6c6f 7373 3a20 4f70  ""..    loss: Op
+00001630: 7469 6f6e 616c 5b6d 696e 6473 706f 7265  tional[mindspore
+00001640: 2e54 656e 736f 725d 203d 204e 6f6e 650a  .Tensor] = None.
+00001650: 2020 2020 6c6f 6769 7473 3a20 6d69 6e64      logits: mind
+00001660: 7370 6f72 652e 5465 6e73 6f72 203d 204e  spore.Tensor = N
+00001670: 6f6e 650a 2020 2020 7465 7874 5f65 6d62  one.    text_emb
+00001680: 6564 733a 204f 7074 696f 6e61 6c5b 5475  eds: Optional[Tu
+00001690: 706c 655b 6d69 6e64 7370 6f72 652e 5465  ple[mindspore.Te
+000016a0: 6e73 6f72 5d5d 203d 204e 6f6e 650a 2020  nsor]] = None.  
+000016b0: 2020 696d 6167 655f 656d 6265 6473 3a20    image_embeds: 
+000016c0: 4f70 7469 6f6e 616c 5b54 7570 6c65 5b6d  Optional[Tuple[m
+000016d0: 696e 6473 706f 7265 2e54 656e 736f 725d  indspore.Tensor]
+000016e0: 5d20 3d20 4e6f 6e65 0a20 2020 2063 726f  ] = None.    cro
+000016f0: 7373 5f65 6d62 6564 733a 204f 7074 696f  ss_embeds: Optio
+00001700: 6e61 6c5b 5475 706c 655b 6d69 6e64 7370  nal[Tuple[mindsp
+00001710: 6f72 652e 5465 6e73 6f72 5d5d 203d 204e  ore.Tensor]] = N
+00001720: 6f6e 650a 2020 2020 6869 6464 656e 5f73  one.    hidden_s
+00001730: 7461 7465 733a 204f 7074 696f 6e61 6c5b  tates: Optional[
+00001740: 5475 706c 655b 6d69 6e64 7370 6f72 652e  Tuple[mindspore.
+00001750: 5465 6e73 6f72 5d5d 203d 204e 6f6e 650a  Tensor]] = None.
+00001760: 2020 2020 6174 7465 6e74 696f 6e73 3a20      attentions: 
+00001770: 4f70 7469 6f6e 616c 5b54 7570 6c65 5b6d  Optional[Tuple[m
+00001780: 696e 6473 706f 7265 2e54 656e 736f 725d  indspore.Tensor]
+00001790: 5d20 3d20 4e6f 6e65 0a0a 0a63 6c61 7373  ] = None...class
+000017a0: 2042 7269 6467 6554 6f77 6572 5265 7369   BridgeTowerResi
+000017b0: 6475 616c 4174 7465 6e74 696f 6e28 6e6e  dualAttention(nn
+000017c0: 2e43 656c 6c29 3a0a 2020 2020 6465 6620  .Cell):.    def 
+000017d0: 5f5f 696e 6974 5f5f 2873 656c 662c 2063  __init__(self, c
+000017e0: 6f6e 6669 6729 3a0a 2020 2020 2020 2020  onfig):.        
+000017f0: 7375 7065 7228 292e 5f5f 696e 6974 5f5f  super().__init__
+00001800: 2829 0a0a 2020 2020 2020 2020 7365 6c66  ()..        self
+00001810: 2e61 7474 6e20 3d20 6e6e 2e4d 756c 7469  .attn = nn.Multi
+00001820: 6865 6164 4174 7465 6e74 696f 6e28 636f  headAttention(co
+00001830: 6e66 6967 2e68 6964 6465 6e5f 7369 7a65  nfig.hidden_size
+00001840: 2c20 636f 6e66 6967 2e68 6964 6465 6e5f  , config.hidden_
+00001850: 7369 7a65 202f 2f20 3634 290a 2020 2020  size // 64).    
+00001860: 2020 2020 7365 6c66 2e6c 6e5f 3120 3d20      self.ln_1 = 
+00001870: 6e6e 2e4c 6179 6572 4e6f 726d 2863 6f6e  nn.LayerNorm(con
+00001880: 6669 672e 6869 6464 656e 5f73 697a 652c  fig.hidden_size,
+00001890: 2065 7073 696c 6f6e 3d63 6f6e 6669 672e   epsilon=config.
+000018a0: 6c61 7965 725f 6e6f 726d 5f65 7073 290a  layer_norm_eps).
+000018b0: 2020 2020 2020 2020 7365 6c66 2e6d 6c70          self.mlp
+000018c0: 203d 206e 6e2e 4365 6c6c 4469 6374 280a   = nn.CellDict(.
+000018d0: 2020 2020 2020 2020 2020 2020 4f72 6465              Orde
+000018e0: 7265 6444 6963 7428 0a20 2020 2020 2020  redDict(.       
+000018f0: 2020 2020 2020 2020 205b 0a20 2020 2020           [.     
+00001900: 2020 2020 2020 2020 2020 2020 2020 2028                 (
+00001910: 2263 5f66 6322 2c20 6e6e 2e44 656e 7365  "c_fc", nn.Dense
+00001920: 2863 6f6e 6669 672e 6869 6464 656e 5f73  (config.hidden_s
+00001930: 697a 652c 2063 6f6e 6669 672e 6869 6464  ize, config.hidd
+00001940: 656e 5f73 697a 6520 2a20 3429 292c 0a20  en_size * 4)),. 
+00001950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001960: 2020 2028 2267 656c 7522 2c20 5175 6963     ("gelu", Quic
+00001970: 6b47 454c 5541 6374 6976 6174 696f 6e28  kGELUActivation(
+00001980: 2929 2c0a 2020 2020 2020 2020 2020 2020  )),.            
+00001990: 2020 2020 2020 2020 2822 635f 7072 6f6a          ("c_proj
+000019a0: 222c 206e 6e2e 4465 6e73 6528 636f 6e66  ", nn.Dense(conf
+000019b0: 6967 2e68 6964 6465 6e5f 7369 7a65 202a  ig.hidden_size *
+000019c0: 2034 2c20 636f 6e66 6967 2e68 6964 6465   4, config.hidde
+000019d0: 6e5f 7369 7a65 2929 2c0a 2020 2020 2020  n_size)),.      
+000019e0: 2020 2020 2020 2020 2020 5d0a 2020 2020            ].    
+000019f0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00001a00: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
+00001a10: 2e6c 6e5f 3220 3d20 6e6e 2e4c 6179 6572  .ln_2 = nn.Layer
+00001a20: 4e6f 726d 2863 6f6e 6669 672e 6869 6464  Norm(config.hidd
+00001a30: 656e 5f73 697a 652c 2065 7073 696c 6f6e  en_size, epsilon
+00001a40: 3d63 6f6e 6669 672e 6c61 7965 725f 6e6f  =config.layer_no
+00001a50: 726d 5f65 7073 290a 2020 2020 2020 2020  rm_eps).        
+00001a60: 7365 6c66 2e61 7474 6e5f 6d61 736b 203d  self.attn_mask =
+00001a70: 204e 6f6e 650a 0a20 2020 2064 6566 2061   None..    def a
+00001a80: 7474 656e 7469 6f6e 2873 656c 662c 2068  ttention(self, h
+00001a90: 6964 6465 6e5f 7374 6174 653a 206d 696e  idden_state: min
+00001aa0: 6473 706f 7265 2e54 656e 736f 722c 2061  dspore.Tensor, a
+00001ab0: 7474 656e 7469 6f6e 5f6d 6173 6b3a 206d  ttention_mask: m
+00001ac0: 696e 6473 706f 7265 2e54 656e 736f 7229  indspore.Tensor)
+00001ad0: 3a0a 2020 2020 2020 2020 6966 2061 7474  :.        if att
+00001ae0: 656e 7469 6f6e 5f6d 6173 6b20 6973 206e  ention_mask is n
+00001af0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00001b00: 2020 2020 2061 7474 656e 7469 6f6e 5f6d       attention_m
+00001b10: 6173 6b20 3d20 6174 7465 6e74 696f 6e5f  ask = attention_
+00001b20: 6d61 736b 2e74 6f28 6474 7970 653d 6d69  mask.to(dtype=mi
+00001b30: 6e64 7370 6f72 652e 626f 6f6c 5f29 0a20  ndspore.bool_). 
+00001b40: 2020 2020 2020 2073 656c 662e 6174 746e         self.attn
+00001b50: 5f6d 6173 6b20 3d20 280a 2020 2020 2020  _mask = (.      
+00001b60: 2020 2020 2020 7365 6c66 2e61 7474 6e5f        self.attn_
+00001b70: 6d61 736b 2e74 6f28 6474 7970 653d 6869  mask.to(dtype=hi
+00001b80: 6464 656e 5f73 7461 7465 2e64 7479 7065  dden_state.dtype
+00001b90: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+00001ba0: 2073 656c 662e 6174 746e 5f6d 6173 6b20   self.attn_mask 
+00001bb0: 6973 206e 6f74 204e 6f6e 650a 2020 2020  is not None.    
+00001bc0: 2020 2020 2020 2020 656c 7365 204e 6f6e          else Non
+00001bd0: 650a 2020 2020 2020 2020 290a 2020 2020  e.        ).    
+00001be0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+00001bf0: 6174 746e 280a 2020 2020 2020 2020 2020  attn(.          
+00001c00: 2020 6869 6464 656e 5f73 7461 7465 2c0a    hidden_state,.
+00001c10: 2020 2020 2020 2020 2020 2020 6869 6464              hidd
+00001c20: 656e 5f73 7461 7465 2c0a 2020 2020 2020  en_state,.      
+00001c30: 2020 2020 2020 6869 6464 656e 5f73 7461        hidden_sta
+00001c40: 7465 2c0a 2020 2020 2020 2020 2020 2020  te,.            
+00001c50: 6e65 6564 5f77 6569 6768 7473 3d46 616c  need_weights=Fal
+00001c60: 7365 2c0a 2020 2020 2020 2020 2020 2020  se,.            
+00001c70: 6174 746e 5f6d 6173 6b3d 7365 6c66 2e61  attn_mask=self.a
+00001c80: 7474 6e5f 6d61 736b 2c0a 2020 2020 2020  ttn_mask,.      
+00001c90: 2020 2020 2020 6b65 795f 7061 6464 696e        key_paddin
+00001ca0: 675f 6d61 736b 3d61 7474 656e 7469 6f6e  g_mask=attention
+00001cb0: 5f6d 6173 6b2c 0a20 2020 2020 2020 2029  _mask,.        )
+00001cc0: 5b30 5d0a 0a20 2020 2064 6566 2063 6f6e  [0]..    def con
+00001cd0: 7374 7275 6374 2873 656c 662c 2068 6964  struct(self, hid
+00001ce0: 6465 6e5f 7374 6174 653a 206d 696e 6473  den_state: minds
+00001cf0: 706f 7265 2e54 656e 736f 722c 2061 7474  pore.Tensor, att
+00001d00: 656e 7469 6f6e 5f6d 6173 6b3a 206d 696e  ention_mask: min
+00001d10: 6473 706f 7265 2e54 656e 736f 7220 3d20  dspore.Tensor = 
+00001d20: 4e6f 6e65 293a 0a20 2020 2020 2020 2072  None):.        r
+00001d30: 6573 6964 7561 6c5f 7374 6174 6520 3d20  esidual_state = 
+00001d40: 6869 6464 656e 5f73 7461 7465 202b 2073  hidden_state + s
+00001d50: 656c 662e 6174 7465 6e74 696f 6e28 7365  elf.attention(se
+00001d60: 6c66 2e6c 6e5f 3128 6869 6464 656e 5f73  lf.ln_1(hidden_s
+00001d70: 7461 7465 292c 2061 7474 656e 7469 6f6e  tate), attention
+00001d80: 5f6d 6173 6b29 0a20 2020 2020 2020 2068  _mask).        h
+00001d90: 6964 6465 6e5f 7374 6174 6520 3d20 7365  idden_state = se
+00001da0: 6c66 2e6c 6e5f 3228 7265 7369 6475 616c  lf.ln_2(residual
+00001db0: 5f73 7461 7465 290a 2020 2020 2020 2020  _state).        
+00001dc0: 666f 7220 5f2c 206c 6179 6572 2069 6e20  for _, layer in 
+00001dd0: 7365 6c66 2e6d 6c70 2e69 7465 6d73 2829  self.mlp.items()
+00001de0: 3a0a 2020 2020 2020 2020 2020 2020 6869  :.            hi
+00001df0: 6464 656e 5f73 7461 7465 203d 206c 6179  dden_state = lay
+00001e00: 6572 2868 6964 6465 6e5f 7374 6174 6529  er(hidden_state)
+00001e10: 0a20 2020 2020 2020 2068 6964 6465 6e5f  .        hidden_
+00001e20: 7374 6174 6520 3d20 7265 7369 6475 616c  state = residual
+00001e30: 5f73 7461 7465 202b 2068 6964 6465 6e5f  _state + hidden_
+00001e40: 7374 6174 650a 2020 2020 2020 2020 7265  state.        re
+00001e50: 7475 726e 2068 6964 6465 6e5f 7374 6174  turn hidden_stat
+00001e60: 650a 0a0a 636c 6173 7320 4272 6964 6765  e...class Bridge
+00001e70: 546f 7765 7254 7261 6e73 666f 726d 6572  TowerTransformer
+00001e80: 286e 6e2e 4365 6c6c 293a 0a20 2020 2064  (nn.Cell):.    d
+00001e90: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
+00001ea0: 2c20 636f 6e66 6967 293a 0a20 2020 2020  , config):.     
+00001eb0: 2020 2073 7570 6572 2829 2e5f 5f69 6e69     super().__ini
+00001ec0: 745f 5f28 290a 2020 2020 2020 2020 7365  t__().        se
+00001ed0: 6c66 2e68 6964 6465 6e5f 7369 7a65 203d  lf.hidden_size =
+00001ee0: 2063 6f6e 6669 672e 6869 6464 656e 5f73   config.hidden_s
+00001ef0: 697a 650a 2020 2020 2020 2020 7365 6c66  ize.        self
+00001f00: 2e6e 756d 5f68 6964 6465 6e5f 6c61 7965  .num_hidden_laye
+00001f10: 7273 203d 2063 6f6e 6669 672e 6e75 6d5f  rs = config.num_
+00001f20: 6869 6464 656e 5f6c 6179 6572 730a 2020  hidden_layers.  
+00001f30: 2020 2020 2020 6966 2063 6f6e 6669 672e        if config.
+00001f40: 7265 6d6f 7665 5f6c 6173 745f 6c61 7965  remove_last_laye
+00001f50: 723a 0a20 2020 2020 2020 2020 2020 2073  r:.            s
+00001f60: 656c 662e 7265 7362 6c6f 636b 7320 3d20  elf.resblocks = 
+00001f70: 6e6e 2e43 656c 6c4c 6973 7428 0a20 2020  nn.CellList(.   
+00001f80: 2020 2020 2020 2020 2020 2020 205b 4272               [Br
+00001f90: 6964 6765 546f 7765 7252 6573 6964 7561  idgeTowerResidua
+00001fa0: 6c41 7474 656e 7469 6f6e 2863 6f6e 6669  lAttention(confi
+00001fb0: 6729 2066 6f72 205f 2069 6e20 7261 6e67  g) for _ in rang
+00001fc0: 6528 7365 6c66 2e6e 756d 5f68 6964 6465  e(self.num_hidde
+00001fd0: 6e5f 6c61 7965 7273 202d 2031 295d 0a20  n_layers - 1)]. 
+00001fe0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00001ff0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00002000: 2020 2020 2020 2073 656c 662e 7265 7362         self.resb
+00002010: 6c6f 636b 7320 3d20 6e6e 2e43 656c 6c4c  locks = nn.CellL
+00002020: 6973 7428 0a20 2020 2020 2020 2020 2020  ist(.           
+00002030: 2020 2020 205b 4272 6964 6765 546f 7765       [BridgeTowe
+00002040: 7252 6573 6964 7561 6c41 7474 656e 7469  rResidualAttenti
+00002050: 6f6e 2863 6f6e 6669 6729 2066 6f72 205f  on(config) for _
+00002060: 2069 6e20 7261 6e67 6528 7365 6c66 2e6e   in range(self.n
+00002070: 756d 5f68 6964 6465 6e5f 6c61 7965 7273  um_hidden_layers
+00002080: 295d 0a20 2020 2020 2020 2020 2020 2029  )].            )
+00002090: 0a20 2020 2020 2020 2073 656c 662e 7374  .        self.st
+000020a0: 6f70 5f67 7261 6469 656e 7420 3d20 636f  op_gradient = co
+000020b0: 6e66 6967 2e73 746f 705f 6772 6164 6965  nfig.stop_gradie
+000020c0: 6e74 0a0a 2020 2020 6465 6620 636f 6e73  nt..    def cons
+000020d0: 7472 7563 7428 7365 6c66 2c20 6869 6464  truct(self, hidd
+000020e0: 656e 5f73 7461 7465 3a20 6d69 6e64 7370  en_state: mindsp
+000020f0: 6f72 652e 5465 6e73 6f72 2c20 6174 7465  ore.Tensor, atte
+00002100: 6e74 696f 6e5f 6d61 736b 3a20 4f70 7469  ntion_mask: Opti
+00002110: 6f6e 616c 5b6d 696e 6473 706f 7265 2e54  onal[mindspore.T
+00002120: 656e 736f 725d 203d 204e 6f6e 6529 3a0a  ensor] = None):.
+00002130: 2020 2020 2020 2020 6869 6464 656e 5f73          hidden_s
+00002140: 7461 7465 7320 3d20 5b5d 0a20 2020 2020  tates = [].     
+00002150: 2020 2066 6f72 2062 6c6f 636b 2069 6e20     for block in 
+00002160: 7365 6c66 2e72 6573 626c 6f63 6b73 3a0a  self.resblocks:.
+00002170: 2020 2020 2020 2020 2020 2020 6869 6464              hidd
+00002180: 656e 5f73 7461 7465 203d 2062 6c6f 636b  en_state = block
+00002190: 2868 6964 6465 6e5f 7374 6174 652c 2061  (hidden_state, a
+000021a0: 7474 656e 7469 6f6e 5f6d 6173 6b29 0a20  ttention_mask). 
+000021b0: 2020 2020 2020 2020 2020 2069 6620 7365             if se
+000021c0: 6c66 2e73 746f 705f 6772 6164 6965 6e74  lf.stop_gradient
+000021d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000021e0: 2020 6869 6464 656e 5f73 7461 7465 732e    hidden_states.
+000021f0: 6170 7065 6e64 286f 7073 2e73 746f 705f  append(ops.stop_
+00002200: 6772 6164 6965 6e74 2868 6964 6465 6e5f  gradient(hidden_
+00002210: 7374 6174 6529 290a 2020 2020 2020 2020  state)).        
+00002220: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00002230: 2020 2020 2020 2020 2020 6869 6464 656e            hidden
+00002240: 5f73 7461 7465 732e 6170 7065 6e64 2868  _states.append(h
+00002250: 6964 6465 6e5f 7374 6174 6529 0a20 2020  idden_state).   
+00002260: 2020 2020 2072 6574 7572 6e20 6869 6464       return hidd
+00002270: 656e 5f73 7461 7465 730a 0a0a 2320 436f  en_states...# Co
+00002280: 7069 6564 2066 726f 6d20 7472 616e 7366  pied from transf
+00002290: 6f72 6d65 7273 2e6d 6f64 656c 732e 636c  ormers.models.cl
+000022a0: 6970 2e6d 6f64 656c 696e 675f 636c 6970  ip.modeling_clip
+000022b0: 2e43 4c49 5056 6973 696f 6e45 6d62 6564  .CLIPVisionEmbed
+000022c0: 6469 6e67 7320 7769 7468 2043 4c49 502d  dings with CLIP-
+000022d0: 3e42 7269 6467 6554 6f77 6572 0a63 6c61  >BridgeTower.cla
+000022e0: 7373 2042 7269 6467 6554 6f77 6572 5669  ss BridgeTowerVi
+000022f0: 7369 6f6e 456d 6265 6464 696e 6773 286e  sionEmbeddings(n
+00002300: 6e2e 4365 6c6c 293a 0a20 2020 2064 6566  n.Cell):.    def
+00002310: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
+00002320: 636f 6e66 6967 3a20 4272 6964 6765 546f  config: BridgeTo
+00002330: 7765 7256 6973 696f 6e43 6f6e 6669 6729  werVisionConfig)
+00002340: 3a0a 2020 2020 2020 2020 7375 7065 7228  :.        super(
+00002350: 292e 5f5f 696e 6974 5f5f 2829 0a20 2020  ).__init__().   
+00002360: 2020 2020 2073 656c 662e 636f 6e66 6967       self.config
+00002370: 203d 2063 6f6e 6669 670a 2020 2020 2020   = config.      
+00002380: 2020 7365 6c66 2e65 6d62 6564 5f64 696d    self.embed_dim
+00002390: 203d 2063 6f6e 6669 672e 6869 6464 656e   = config.hidden
+000023a0: 5f73 697a 650a 2020 2020 2020 2020 7365  _size.        se
+000023b0: 6c66 2e69 6d61 6765 5f73 697a 6520 3d20  lf.image_size = 
+000023c0: 636f 6e66 6967 2e69 6d61 6765 5f73 697a  config.image_siz
+000023d0: 650a 2020 2020 2020 2020 7365 6c66 2e70  e.        self.p
+000023e0: 6174 6368 5f73 697a 6520 3d20 636f 6e66  atch_size = conf
+000023f0: 6967 2e70 6174 6368 5f73 697a 650a 0a20  ig.patch_size.. 
+00002400: 2020 2020 2020 2073 656c 662e 636c 6173         self.clas
+00002410: 735f 656d 6265 6464 696e 6720 3d20 5061  s_embedding = Pa
+00002420: 7261 6d65 7465 7228 6f70 732e 7261 6e64  rameter(ops.rand
+00002430: 6e28 7365 6c66 2e65 6d62 6564 5f64 696d  n(self.embed_dim
+00002440: 2929 0a0a 2020 2020 2020 2020 7365 6c66  ))..        self
+00002450: 2e70 6174 6368 5f65 6d62 6564 6469 6e67  .patch_embedding
+00002460: 203d 206e 6e2e 436f 6e76 3264 280a 2020   = nn.Conv2d(.  
+00002470: 2020 2020 2020 2020 2020 696e 5f63 6861            in_cha
+00002480: 6e6e 656c 733d 636f 6e66 6967 2e6e 756d  nnels=config.num
+00002490: 5f63 6861 6e6e 656c 732c 0a20 2020 2020  _channels,.     
+000024a0: 2020 2020 2020 206f 7574 5f63 6861 6e6e         out_chann
+000024b0: 656c 733d 7365 6c66 2e65 6d62 6564 5f64  els=self.embed_d
+000024c0: 696d 2c0a 2020 2020 2020 2020 2020 2020  im,.            
+000024d0: 6b65 726e 656c 5f73 697a 653d 7365 6c66  kernel_size=self
+000024e0: 2e70 6174 6368 5f73 697a 652c 0a20 2020  .patch_size,.   
+000024f0: 2020 2020 2020 2020 2073 7472 6964 653d           stride=
+00002500: 7365 6c66 2e70 6174 6368 5f73 697a 652c  self.patch_size,
+00002510: 0a20 2020 2020 2020 2020 2020 2068 6173  .            has
+00002520: 5f62 6961 733d 4661 6c73 652c 0a20 2020  _bias=False,.   
+00002530: 2020 2020 2020 2020 2070 6164 5f6d 6f64           pad_mod
+00002540: 653d 2776 616c 6964 270a 2020 2020 2020  e='valid'.      
+00002550: 2020 290a 0a20 2020 2020 2020 2073 656c    )..        sel
+00002560: 662e 6e75 6d5f 7061 7463 6865 7320 3d20  f.num_patches = 
+00002570: 2873 656c 662e 696d 6167 655f 7369 7a65  (self.image_size
+00002580: 202f 2f20 7365 6c66 2e70 6174 6368 5f73   // self.patch_s
+00002590: 697a 6529 202a 2a20 320a 2020 2020 2020  ize) ** 2.      
+000025a0: 2020 7365 6c66 2e6e 756d 5f70 6f73 6974    self.num_posit
+000025b0: 696f 6e73 203d 2073 656c 662e 6e75 6d5f  ions = self.num_
+000025c0: 7061 7463 6865 7320 2b20 310a 2020 2020  patches + 1.    
+000025d0: 2020 2020 7365 6c66 2e70 6f73 6974 696f      self.positio
+000025e0: 6e5f 656d 6265 6464 696e 6720 3d20 6e6e  n_embedding = nn
+000025f0: 2e45 6d62 6564 6469 6e67 2873 656c 662e  .Embedding(self.
+00002600: 6e75 6d5f 706f 7369 7469 6f6e 732c 2073  num_positions, s
+00002610: 656c 662e 656d 6265 645f 6469 6d29 0a20  elf.embed_dim). 
+00002620: 2020 2020 2020 2073 656c 662e 706f 7369         self.posi
+00002630: 7469 6f6e 5f69 6473 203d 206f 7073 2e61  tion_ids = ops.a
+00002640: 7261 6e67 6528 7365 6c66 2e6e 756d 5f70  range(self.num_p
+00002650: 6f73 6974 696f 6e73 292e 6578 7061 6e64  ositions).expand
+00002660: 2828 312c 202d 3129 290a 0a20 2020 2064  ((1, -1))..    d
+00002670: 6566 2063 6f6e 7374 7275 6374 2873 656c  ef construct(sel
+00002680: 662c 2070 6978 656c 5f76 616c 7565 733a  f, pixel_values:
+00002690: 206d 696e 6473 706f 7265 2e54 656e 736f   mindspore.Tenso
+000026a0: 7229 202d 3e20 6d69 6e64 7370 6f72 652e  r) -> mindspore.
+000026b0: 5465 6e73 6f72 3a0a 2020 2020 2020 2020  Tensor:.        
+000026c0: 6261 7463 685f 7369 7a65 203d 2070 6978  batch_size = pix
+000026d0: 656c 5f76 616c 7565 732e 7368 6170 655b  el_values.shape[
+000026e0: 305d 0a20 2020 2020 2020 2074 6172 6765  0].        targe
+000026f0: 745f 6474 7970 6520 3d20 7365 6c66 2e70  t_dtype = self.p
+00002700: 6174 6368 5f65 6d62 6564 6469 6e67 2e77  atch_embedding.w
+00002710: 6569 6768 742e 6474 7970 650a 2020 2020  eight.dtype.    
+00002720: 2020 2020 7061 7463 685f 656d 6265 6473      patch_embeds
+00002730: 203d 2073 656c 662e 7061 7463 685f 656d   = self.patch_em
+00002740: 6265 6464 696e 6728 7069 7865 6c5f 7661  bedding(pixel_va
+00002750: 6c75 6573 2e74 6f28 6474 7970 653d 7461  lues.to(dtype=ta
+00002760: 7267 6574 5f64 7479 7065 2929 2020 2320  rget_dtype))  # 
+00002770: 7368 6170 6520 3d20 5b2a 2c20 7769 6474  shape = [*, widt
+00002780: 682c 2067 7269 642c 2067 7269 645d 0a20  h, grid, grid]. 
+00002790: 2020 2020 2020 2070 6174 6368 5f65 6d62         patch_emb
+000027a0: 6564 7320 3d20 7061 7463 685f 656d 6265  eds = patch_embe
+000027b0: 6473 2e66 6c61 7474 656e 2873 7461 7274  ds.flatten(start
+000027c0: 5f64 696d 3d32 292e 7377 6170 6178 6573  _dim=2).swapaxes
+000027d0: 2831 2c20 3229 0a0a 2020 2020 2020 2020  (1, 2)..        
+000027e0: 636c 6173 735f 656d 6265 6473 203d 2073  class_embeds = s
+000027f0: 656c 662e 636c 6173 735f 656d 6265 6464  elf.class_embedd
+00002800: 696e 672e 6578 7061 6e64 2862 6174 6368  ing.expand(batch
+00002810: 5f73 697a 652c 2031 2c20 2d31 290a 2020  _size, 1, -1).  
+00002820: 2020 2020 2020 656d 6265 6464 696e 6773        embeddings
+00002830: 203d 206f 7073 2e63 6174 285b 636c 6173   = ops.cat([clas
+00002840: 735f 656d 6265 6473 2c20 7061 7463 685f  s_embeds, patch_
+00002850: 656d 6265 6473 5d2c 2061 7869 733d 3129  embeds], axis=1)
+00002860: 0a20 2020 2020 2020 2065 6d62 6564 6469  .        embeddi
+00002870: 6e67 7320 3d20 656d 6265 6464 696e 6773  ngs = embeddings
+00002880: 202b 2073 656c 662e 706f 7369 7469 6f6e   + self.position
+00002890: 5f65 6d62 6564 6469 6e67 2873 656c 662e  _embedding(self.
+000028a0: 706f 7369 7469 6f6e 5f69 6473 290a 2020  position_ids).  
+000028b0: 2020 2020 2020 7265 7475 726e 2065 6d62        return emb
+000028c0: 6564 6469 6e67 730a 0a0a 636c 6173 7320  eddings...class 
+000028d0: 4272 6964 6765 546f 7765 7256 6973 696f  BridgeTowerVisio
+000028e0: 6e54 7261 6e73 666f 726d 6572 286e 6e2e  nTransformer(nn.
+000028f0: 4365 6c6c 293a 0a20 2020 2064 6566 205f  Cell):.    def _
+00002900: 5f69 6e69 745f 5f28 7365 6c66 2c20 636f  _init__(self, co
+00002910: 6e66 6967 293a 0a20 2020 2020 2020 2073  nfig):.        s
+00002920: 7570 6572 2829 2e5f 5f69 6e69 745f 5f28  uper().__init__(
+00002930: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+00002940: 656d 6265 6464 696e 6773 203d 2042 7269  embeddings = Bri
+00002950: 6467 6554 6f77 6572 5669 7369 6f6e 456d  dgeTowerVisionEm
+00002960: 6265 6464 696e 6773 2863 6f6e 6669 6729  beddings(config)
+00002970: 0a20 2020 2020 2020 2073 656c 662e 6c6e  .        self.ln
+00002980: 5f70 7265 203d 206e 6e2e 4c61 7965 724e  _pre = nn.LayerN
+00002990: 6f72 6d28 636f 6e66 6967 2e68 6964 6465  orm(config.hidde
+000029a0: 6e5f 7369 7a65 2c20 6570 7369 6c6f 6e3d  n_size, epsilon=
+000029b0: 636f 6e66 6967 2e6c 6179 6572 5f6e 6f72  config.layer_nor
+000029c0: 6d5f 6570 7329 0a20 2020 2020 2020 2073  m_eps).        s
+000029d0: 656c 662e 7472 616e 7366 6f72 6d65 7220  elf.transformer 
+000029e0: 3d20 4272 6964 6765 546f 7765 7254 7261  = BridgeTowerTra
+000029f0: 6e73 666f 726d 6572 2863 6f6e 6669 6729  nsformer(config)
+00002a00: 0a20 2020 2020 2020 2073 656c 662e 6c6e  .        self.ln
+00002a10: 5f70 6f73 7420 3d20 6e6e 2e4c 6179 6572  _post = nn.Layer
+00002a20: 4e6f 726d 2863 6f6e 6669 672e 6869 6464  Norm(config.hidd
+00002a30: 656e 5f73 697a 652c 2065 7073 696c 6f6e  en_size, epsilon
+00002a40: 3d63 6f6e 6669 672e 6c61 7965 725f 6e6f  =config.layer_no
+00002a50: 726d 5f65 7073 290a 2020 2020 2020 2020  rm_eps).        
+00002a60: 7365 6c66 2e73 6861 7265 5f6c 6179 6572  self.share_layer
+00002a70: 6e6f 726d 203d 2063 6f6e 6669 672e 7368  norm = config.sh
+00002a80: 6172 655f 6c61 7965 726e 6f72 6d0a 2020  are_layernorm.  
+00002a90: 2020 2020 2020 6966 206e 6f74 2063 6f6e        if not con
+00002aa0: 6669 672e 7368 6172 655f 6c61 7965 726e  fig.share_layern
+00002ab0: 6f72 6d3a 0a20 2020 2020 2020 2020 2020  orm:.           
+00002ac0: 2073 656c 662e 6c6e 5f73 6570 6172 6174   self.ln_separat
+00002ad0: 6520 3d20 6e6e 2e43 656c 6c4c 6973 7428  e = nn.CellList(
+00002ae0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00002af0: 205b 6e6e 2e4c 6179 6572 4e6f 726d 2863   [nn.LayerNorm(c
+00002b00: 6f6e 6669 672e 6869 6464 656e 5f73 697a  onfig.hidden_siz
+00002b10: 652c 2065 7073 696c 6f6e 3d63 6f6e 6669  e, epsilon=confi
+00002b20: 672e 6c61 7965 725f 6e6f 726d 5f65 7073  g.layer_norm_eps
+00002b30: 2920 666f 7220 5f20 696e 2072 616e 6765  ) for _ in range
+00002b40: 2863 6f6e 6669 672e 6e75 6d5f 6869 6464  (config.num_hidd
+00002b50: 656e 5f6c 6179 6572 7329 5d0a 2020 2020  en_layers)].    
+00002b60: 2020 2020 2020 2020 290a 0a20 2020 2064          )..    d
+00002b70: 6566 2063 6f6e 7374 7275 6374 2873 656c  ef construct(sel
+00002b80: 662c 2070 6978 656c 5f76 616c 7565 733a  f, pixel_values:
+00002b90: 206d 696e 6473 706f 7265 2e54 656e 736f   mindspore.Tenso
+00002ba0: 722c 2061 7474 656e 7469 6f6e 5f6d 6173  r, attention_mas
+00002bb0: 6b29 3a0a 2020 2020 2020 2020 6869 6464  k):.        hidd
+00002bc0: 656e 5f73 7461 7465 7320 3d20 7365 6c66  en_states = self
+00002bd0: 2e65 6d62 6564 6469 6e67 7328 7069 7865  .embeddings(pixe
+00002be0: 6c5f 7661 6c75 6573 290a 2020 2020 2020  l_values).      
+00002bf0: 2020 6869 6464 656e 5f73 7461 7465 7320    hidden_states 
+00002c00: 3d20 7365 6c66 2e6c 6e5f 7072 6528 6869  = self.ln_pre(hi
+00002c10: 6464 656e 5f73 7461 7465 7329 0a20 2020  dden_states).   
+00002c20: 2020 2020 2023 204e 4c44 202d 3e20 4c4e       # NLD -> LN
+00002c30: 440a 2020 2020 2020 2020 6869 6464 656e  D.        hidden
+00002c40: 5f73 7461 7465 7320 3d20 6869 6464 656e  _states = hidden
+00002c50: 5f73 7461 7465 732e 7065 726d 7574 6528  _states.permute(
+00002c60: 312c 2030 2c20 3229 0a0a 2020 2020 2020  1, 0, 2)..      
+00002c70: 2020 6869 6464 656e 5f73 7461 7465 7320    hidden_states 
+00002c80: 3d20 7365 6c66 2e74 7261 6e73 666f 726d  = self.transform
+00002c90: 6572 2868 6964 6465 6e5f 7374 6174 6573  er(hidden_states
+00002ca0: 2c20 6174 7465 6e74 696f 6e5f 6d61 736b  , attention_mask
+00002cb0: 290a 2020 2020 2020 2020 2320 7368 6170  ).        # shap
+00002cc0: 6520 3d20 5b6e 756d 5f68 6964 6465 6e5f  e = [num_hidden_
+00002cd0: 6c61 7965 7273 2c20 6869 6464 656e 5f73  layers, hidden_s
+00002ce0: 697a 652c 202a 2c20 6772 6964 202a 2a20  ize, *, grid ** 
+00002cf0: 325d 0a20 2020 2020 2020 2068 6964 6465  2].        hidde
+00002d00: 6e5f 7374 6174 6573 203d 206f 7073 2e73  n_states = ops.s
+00002d10: 7461 636b 2868 6964 6465 6e5f 7374 6174  tack(hidden_stat
+00002d20: 6573 2c20 6178 6973 3d30 290a 2020 2020  es, axis=0).    
+00002d30: 2020 2020 2320 7368 6170 6520 3d20 5b6e      # shape = [n
+00002d40: 756d 5f68 6964 6465 6e5f 6c61 7965 7273  um_hidden_layers
+00002d50: 2c20 2a2c 2068 6964 6465 6e5f 7369 7a65  , *, hidden_size
+00002d60: 2c20 6772 6964 202a 2a20 325d 0a20 2020  , grid ** 2].   
+00002d70: 2020 2020 2068 6964 6465 6e5f 7374 6174       hidden_stat
+00002d80: 6573 203d 2068 6964 6465 6e5f 7374 6174  es = hidden_stat
+00002d90: 6573 2e70 6572 6d75 7465 2830 2c20 322c  es.permute(0, 2,
+00002da0: 2031 2c20 3329 0a20 2020 2020 2020 2069   1, 3).        i
+00002db0: 6620 7365 6c66 2e73 6861 7265 5f6c 6179  f self.share_lay
+00002dc0: 6572 6e6f 726d 3a0a 2020 2020 2020 2020  ernorm:.        
+00002dd0: 2020 2020 6869 6464 656e 5f73 7461 7465      hidden_state
+00002de0: 7320 3d20 7365 6c66 2e6c 6e5f 706f 7374  s = self.ln_post
+00002df0: 2868 6964 6465 6e5f 7374 6174 6573 290a  (hidden_states).
+00002e00: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00002e10: 2020 2020 2020 2020 2020 6869 6464 656e            hidden
+00002e20: 5f73 7461 7465 735f 7374 6163 6b20 3d20  _states_stack = 
+00002e30: 5b5d 0a20 2020 2020 2020 2020 2020 2066  [].            f
+00002e40: 6f72 2068 6964 6465 6e5f 7374 6174 6573  or hidden_states
+00002e50: 2c20 6c6e 2069 6e20 7a69 7028 6869 6464  , ln in zip(hidd
+00002e60: 656e 5f73 7461 7465 732c 2073 656c 662e  en_states, self.
+00002e70: 6c6e 5f73 6570 6172 6174 6529 3a0a 2020  ln_separate):.  
+00002e80: 2020 2020 2020 2020 2020 2020 2020 6869                hi
+00002e90: 6464 656e 5f73 7461 7465 7320 3d20 6c6e  dden_states = ln
+00002ea0: 2868 6964 6465 6e5f 7374 6174 6573 290a  (hidden_states).
+00002eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002ec0: 6869 6464 656e 5f73 7461 7465 735f 7374  hidden_states_st
+00002ed0: 6163 6b2e 6170 7065 6e64 2868 6964 6465  ack.append(hidde
+00002ee0: 6e5f 7374 6174 6573 290a 2020 2020 2020  n_states).      
+00002ef0: 2020 2020 2020 2320 7368 6170 6520 3d20        # shape = 
+00002f00: 5b6e 756d 5f68 6964 6465 6e5f 6c61 7965  [num_hidden_laye
+00002f10: 7273 2c20 2a2c 2068 6964 6465 6e5f 7369  rs, *, hidden_si
+00002f20: 7a65 2c20 6772 6964 202a 2a20 325d 0a20  ze, grid ** 2]. 
+00002f30: 2020 2020 2020 2020 2020 2068 6964 6465             hidde
+00002f40: 6e5f 7374 6174 6573 203d 206f 7073 2e73  n_states = ops.s
+00002f50: 7461 636b 2868 6964 6465 6e5f 7374 6174  tack(hidden_stat
+00002f60: 6573 5f73 7461 636b 2c20 6178 6973 3d30  es_stack, axis=0
+00002f70: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00002f80: 2068 6964 6465 6e5f 7374 6174 6573 0a0a   hidden_states..
+00002f90: 2020 2020 6465 6620 636f 6e73 7472 7563      def construc
+00002fa0: 745f 7072 6528 7365 6c66 2c20 7069 7865  t_pre(self, pixe
+00002fb0: 6c5f 7661 6c75 6573 3a20 6d69 6e64 7370  l_values: mindsp
+00002fc0: 6f72 652e 5465 6e73 6f72 293a 0a20 2020  ore.Tensor):.   
+00002fd0: 2020 2020 2068 6964 6465 6e5f 7374 6174       hidden_stat
+00002fe0: 6573 203d 2073 656c 662e 656d 6265 6464  es = self.embedd
+00002ff0: 696e 6773 2870 6978 656c 5f76 616c 7565  ings(pixel_value
+00003000: 7329 0a20 2020 2020 2020 2068 6964 6465  s).        hidde
+00003010: 6e5f 7374 6174 6573 203d 2073 656c 662e  n_states = self.
+00003020: 6c6e 5f70 7265 2868 6964 6465 6e5f 7374  ln_pre(hidden_st
+00003030: 6174 6573 290a 2020 2020 2020 2020 2320  ates).        # 
+00003040: 4e4c 4420 2d3e 204c 4e44 0a20 2020 2020  NLD -> LND.     
+00003050: 2020 2068 6964 6465 6e5f 7374 6174 6573     hidden_states
+00003060: 203d 2068 6964 6465 6e5f 7374 6174 6573   = hidden_states
+00003070: 2e70 6572 6d75 7465 2831 2c20 302c 2032  .permute(1, 0, 2
+00003080: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00003090: 2068 6964 6465 6e5f 7374 6174 6573 0a0a   hidden_states..
+000030a0: 2020 2020 6465 6620 636f 6e73 7472 7563      def construc
+000030b0: 745f 706f 7374 2873 656c 662c 2068 6964  t_post(self, hid
+000030c0: 6465 6e5f 7374 6174 653a 206d 696e 6473  den_state: minds
+000030d0: 706f 7265 2e54 656e 736f 7229 3a0a 2020  pore.Tensor):.  
+000030e0: 2020 2020 2020 7669 7375 616c 5f6f 7574        visual_out
+000030f0: 7075 745f 706f 7374 203d 2068 6964 6465  put_post = hidde
+00003100: 6e5f 7374 6174 652e 7065 726d 7574 6528  n_state.permute(
+00003110: 312c 2030 2c20 3229 0a20 2020 2020 2020  1, 0, 2).       
+00003120: 2076 6973 7561 6c5f 6f75 7470 7574 5f70   visual_output_p
+00003130: 6f73 7420 3d20 7365 6c66 2e6c 6e5f 706f  ost = self.ln_po
+00003140: 7374 2876 6973 7561 6c5f 6f75 7470 7574  st(visual_output
+00003150: 5f70 6f73 7429 0a20 2020 2020 2020 2072  _post).        r
+00003160: 6574 7572 6e20 7669 7375 616c 5f6f 7574  eturn visual_out
+00003170: 7075 745f 706f 7374 0a0a 0a63 6c61 7373  put_post...class
+00003180: 2042 7269 6467 6554 6f77 6572 4c69 6e6b   BridgeTowerLink
+00003190: 546f 7765 7228 6e6e 2e43 656c 6c29 3a0a  Tower(nn.Cell):.
+000031a0: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
+000031b0: 2873 656c 662c 2063 6f6e 6669 6729 3a0a  (self, config):.
+000031c0: 2020 2020 2020 2020 7375 7065 7228 292e          super().
+000031d0: 5f5f 696e 6974 5f5f 2829 0a20 2020 2020  __init__().     
+000031e0: 2020 2073 656c 662e 6c69 6e6b 5f74 6f77     self.link_tow
+000031f0: 6572 5f74 7970 6520 3d20 636f 6e66 6967  er_type = config
+00003200: 2e6c 696e 6b5f 746f 7765 725f 7479 7065  .link_tower_type
+00003210: 0a20 2020 2020 2020 2073 656c 662e 6869  .        self.hi
+00003220: 6464 656e 5f73 697a 6520 3d20 636f 6e66  dden_size = conf
+00003230: 6967 2e68 6964 6465 6e5f 7369 7a65 0a20  ig.hidden_size. 
+00003240: 2020 2020 2020 2069 6620 636f 6e66 6967         if config
+00003250: 2e6c 696e 6b5f 746f 7765 725f 7479 7065  .link_tower_type
+00003260: 2069 6e20 5b22 6164 6422 2c20 2273 6361   in ["add", "sca
+00003270: 6c65 645f 6164 6422 2c20 2269 6e74 6572  led_add", "inter
+00003280: 706f 6c61 7465 225d 3a0a 2020 2020 2020  polate"]:.      
+00003290: 2020 2020 2020 6966 2063 6f6e 6669 672e        if config.
+000032a0: 6c69 6e6b 5f74 6f77 6572 5f74 7970 6520  link_tower_type 
+000032b0: 3d3d 2022 7363 616c 6564 5f61 6464 223a  == "scaled_add":
+000032c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000032d0: 2073 656c 662e 7363 616c 6564 5f66 6163   self.scaled_fac
+000032e0: 746f 7220 3d20 5061 7261 6d65 7465 7228  tor = Parameter(
+000032f0: 6d69 6e64 7370 6f72 652e 7465 6e73 6f72  mindspore.tensor
+00003300: 2831 2e30 2929 0a20 2020 2020 2020 2020  (1.0)).         
+00003310: 2020 2065 6c69 6620 636f 6e66 6967 2e6c     elif config.l
+00003320: 696e 6b5f 746f 7765 725f 7479 7065 203d  ink_tower_type =
+00003330: 3d20 2269 6e74 6572 706f 6c61 7465 223a  = "interpolate":
+00003340: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003350: 2073 656c 662e 6265 7461 203d 2050 6172   self.beta = Par
+00003360: 616d 6574 6572 286d 696e 6473 706f 7265  ameter(mindspore
+00003370: 2e74 656e 736f 7228 302e 3529 290a 2020  .tensor(0.5)).  
+00003380: 2020 2020 2020 2020 2020 7365 6c66 2e4c            self.L
+00003390: 6179 6572 4e6f 726d 203d 206e 6e2e 4c61  ayerNorm = nn.La
+000033a0: 7965 724e 6f72 6d28 7365 6c66 2e68 6964  yerNorm(self.hid
+000033b0: 6465 6e5f 7369 7a65 2c20 6570 7369 6c6f  den_size, epsilo
+000033c0: 6e3d 636f 6e66 6967 2e6c 6179 6572 5f6e  n=config.layer_n
+000033d0: 6f72 6d5f 6570 7329 0a20 2020 2020 2020  orm_eps).       
+000033e0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000033f0: 2020 2072 6169 7365 204e 6f74 496d 706c     raise NotImpl
+00003400: 656d 656e 7465 6445 7272 6f72 2866 226c  ementedError(f"l
+00003410: 696e 6b5f 746f 7765 725f 7479 7065 207b  ink_tower_type {
+00003420: 636f 6e66 6967 2e6c 696e 6b5f 746f 7765  config.link_towe
+00003430: 725f 7479 7065 7d20 6973 206e 6f74 2069  r_type} is not i
+00003440: 6d70 6c65 6d65 6e74 6564 2229 0a0a 2020  mplemented")..  
+00003450: 2020 6465 6620 636f 6e73 7472 7563 7428    def construct(
+00003460: 7365 6c66 2c20 6869 6464 656e 5f73 7461  self, hidden_sta
+00003470: 7465 732c 2063 726f 7373 5f6d 6f64 616c  tes, cross_modal
+00003480: 5f68 6964 6465 6e5f 7374 6174 6573 2c20  _hidden_states, 
+00003490: 6174 7465 6e74 696f 6e5f 6d61 736b 293a  attention_mask):
+000034a0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+000034b0: 2e6c 696e 6b5f 746f 7765 725f 7479 7065  .link_tower_type
+000034c0: 203d 3d20 2261 6464 223a 0a20 2020 2020   == "add":.     
+000034d0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+000034e0: 6c66 2e4c 6179 6572 4e6f 726d 2868 6964  lf.LayerNorm(hid
+000034f0: 6465 6e5f 7374 6174 6573 202b 2063 726f  den_states + cro
+00003500: 7373 5f6d 6f64 616c 5f68 6964 6465 6e5f  ss_modal_hidden_
+00003510: 7374 6174 6573 290a 2020 2020 2020 2020  states).        
+00003520: 656c 6966 2073 656c 662e 6c69 6e6b 5f74  elif self.link_t
+00003530: 6f77 6572 5f74 7970 6520 3d3d 2022 7363  ower_type == "sc
+00003540: 616c 6564 5f61 6464 223a 0a20 2020 2020  aled_add":.     
+00003550: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+00003560: 6c66 2e4c 6179 6572 4e6f 726d 2868 6964  lf.LayerNorm(hid
+00003570: 6465 6e5f 7374 6174 6573 202a 2073 656c  den_states * sel
+00003580: 662e 7363 616c 6564 5f66 6163 746f 7220  f.scaled_factor 
+00003590: 2b20 6372 6f73 735f 6d6f 6461 6c5f 6869  + cross_modal_hi
+000035a0: 6464 656e 5f73 7461 7465 7329 0a20 2020  dden_states).   
+000035b0: 2020 2020 2065 6c69 6620 7365 6c66 2e6c       elif self.l
+000035c0: 696e 6b5f 746f 7765 725f 7479 7065 203d  ink_tower_type =
+000035d0: 3d20 2269 6e74 6572 706f 6c61 7465 223a  = "interpolate":
+000035e0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+000035f0: 7572 6e20 7365 6c66 2e4c 6179 6572 4e6f  urn self.LayerNo
+00003600: 726d 2868 6964 6465 6e5f 7374 6174 6573  rm(hidden_states
+00003610: 202a 2028 3120 2d20 7365 6c66 2e62 6574   * (1 - self.bet
+00003620: 6129 202b 2063 726f 7373 5f6d 6f64 616c  a) + cross_modal
+00003630: 5f68 6964 6465 6e5f 7374 6174 6573 202a  _hidden_states *
+00003640: 2073 656c 662e 6265 7461 290a 2020 2020   self.beta).    
+00003650: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00003660: 2020 2020 2020 7261 6973 6520 4e6f 7449        raise NotI
+00003670: 6d70 6c65 6d65 6e74 6564 4572 726f 7228  mplementedError(
+00003680: 6622 6c69 6e6b 5f74 6f77 6572 5f74 7970  f"link_tower_typ
+00003690: 6520 7b73 656c 662e 6c69 6e6b 5f74 6f77  e {self.link_tow
+000036a0: 6572 5f74 7970 657d 2069 7320 6e6f 7420  er_type} is not 
+000036b0: 696d 706c 656d 656e 7465 6422 290a 0a0a  implemented")...
+000036c0: 2320 436f 7069 6564 2066 726f 6d20 7472  # Copied from tr
+000036d0: 616e 7366 6f72 6d65 7273 2e6d 6f64 656c  ansformers.model
+000036e0: 732e 6265 7274 2e6d 6f64 656c 696e 675f  s.bert.modeling_
+000036f0: 6265 7274 2e42 6572 7453 656c 664f 7574  bert.BertSelfOut
+00003700: 7075 7420 7769 7468 2042 6572 742d 3e42  put with Bert->B
+00003710: 7269 6467 6554 6f77 6572 0a63 6c61 7373  ridgeTower.class
+00003720: 2042 7269 6467 6554 6f77 6572 5365 6c66   BridgeTowerSelf
+00003730: 4f75 7470 7574 286e 6e2e 4365 6c6c 293a  Output(nn.Cell):
+00003740: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+00003750: 5f28 7365 6c66 2c20 636f 6e66 6967 293a  _(self, config):
+00003760: 0a20 2020 2020 2020 2073 7570 6572 2829  .        super()
+00003770: 2e5f 5f69 6e69 745f 5f28 290a 2020 2020  .__init__().    
+00003780: 2020 2020 7365 6c66 2e64 656e 7365 203d      self.dense =
+00003790: 206e 6e2e 4465 6e73 6528 636f 6e66 6967   nn.Dense(config
+000037a0: 2e68 6964 6465 6e5f 7369 7a65 2c20 636f  .hidden_size, co
+000037b0: 6e66 6967 2e68 6964 6465 6e5f 7369 7a65  nfig.hidden_size
+000037c0: 290a 2020 2020 2020 2020 7365 6c66 2e4c  ).        self.L
+000037d0: 6179 6572 4e6f 726d 203d 206e 6e2e 4c61  ayerNorm = nn.La
+000037e0: 7965 724e 6f72 6d28 636f 6e66 6967 2e68  yerNorm(config.h
+000037f0: 6964 6465 6e5f 7369 7a65 2c20 6570 7369  idden_size, epsi
+00003800: 6c6f 6e3d 636f 6e66 6967 2e6c 6179 6572  lon=config.layer
+00003810: 5f6e 6f72 6d5f 6570 7329 0a20 2020 2020  _norm_eps).     
+00003820: 2020 2073 656c 662e 6472 6f70 6f75 7420     self.dropout 
+00003830: 3d20 6e6e 2e44 726f 706f 7574 2870 3d63  = nn.Dropout(p=c
+00003840: 6f6e 6669 672e 6869 6464 656e 5f64 726f  onfig.hidden_dro
+00003850: 706f 7574 5f70 726f 6229 0a0a 2020 2020  pout_prob)..    
+00003860: 6465 6620 636f 6e73 7472 7563 7428 7365  def construct(se
+00003870: 6c66 2c20 6869 6464 656e 5f73 7461 7465  lf, hidden_state
+00003880: 733a 206d 696e 6473 706f 7265 2e54 656e  s: mindspore.Ten
+00003890: 736f 722c 2069 6e70 7574 5f74 656e 736f  sor, input_tenso
+000038a0: 723a 206d 696e 6473 706f 7265 2e54 656e  r: mindspore.Ten
+000038b0: 736f 7229 202d 3e20 6d69 6e64 7370 6f72  sor) -> mindspor
+000038c0: 652e 5465 6e73 6f72 3a0a 2020 2020 2020  e.Tensor:.      
+000038d0: 2020 6869 6464 656e 5f73 7461 7465 7320    hidden_states 
+000038e0: 3d20 7365 6c66 2e64 656e 7365 2868 6964  = self.dense(hid
+000038f0: 6465 6e5f 7374 6174 6573 290a 2020 2020  den_states).    
+00003900: 2020 2020 6869 6464 656e 5f73 7461 7465      hidden_state
+00003910: 7320 3d20 7365 6c66 2e64 726f 706f 7574  s = self.dropout
+00003920: 2868 6964 6465 6e5f 7374 6174 6573 290a  (hidden_states).
+00003930: 2020 2020 2020 2020 6869 6464 656e 5f73          hidden_s
+00003940: 7461 7465 7320 3d20 7365 6c66 2e4c 6179  tates = self.Lay
+00003950: 6572 4e6f 726d 2868 6964 6465 6e5f 7374  erNorm(hidden_st
+00003960: 6174 6573 202b 2069 6e70 7574 5f74 656e  ates + input_ten
+00003970: 736f 7229 0a20 2020 2020 2020 2072 6574  sor).        ret
+00003980: 7572 6e20 6869 6464 656e 5f73 7461 7465  urn hidden_state
+00003990: 730a 0a0a 2320 436f 7069 6564 2066 726f  s...# Copied fro
+000039a0: 6d20 7472 616e 7366 6f72 6d65 7273 2e6d  m transformers.m
+000039b0: 6f64 656c 732e 6265 7274 2e6d 6f64 656c  odels.bert.model
+000039c0: 696e 675f 6265 7274 2e42 6572 7449 6e74  ing_bert.BertInt
+000039d0: 6572 6d65 6469 6174 6520 7769 7468 2042  ermediate with B
+000039e0: 6572 742d 3e42 7269 6467 6554 6f77 6572  ert->BridgeTower
+000039f0: 0a63 6c61 7373 2042 7269 6467 6554 6f77  .class BridgeTow
+00003a00: 6572 496e 7465 726d 6564 6961 7465 286e  erIntermediate(n
+00003a10: 6e2e 4365 6c6c 293a 0a20 2020 2064 6566  n.Cell):.    def
+00003a20: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
+00003a30: 636f 6e66 6967 293a 0a20 2020 2020 2020  config):.       
+00003a40: 2073 7570 6572 2829 2e5f 5f69 6e69 745f   super().__init_
+00003a50: 5f28 290a 2020 2020 2020 2020 7365 6c66  _().        self
+00003a60: 2e64 656e 7365 203d 206e 6e2e 4465 6e73  .dense = nn.Dens
+00003a70: 6528 636f 6e66 6967 2e68 6964 6465 6e5f  e(config.hidden_
+00003a80: 7369 7a65 2c20 636f 6e66 6967 2e69 6e74  size, config.int
+00003a90: 6572 6d65 6469 6174 655f 7369 7a65 290a  ermediate_size).
+00003aa0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+00003ab0: 7461 6e63 6528 636f 6e66 6967 2e68 6964  tance(config.hid
+00003ac0: 6465 6e5f 6163 742c 2073 7472 293a 0a20  den_act, str):. 
+00003ad0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00003ae0: 696e 7465 726d 6564 6961 7465 5f61 6374  intermediate_act
+00003af0: 5f66 6e20 3d20 4143 5432 464e 5b63 6f6e  _fn = ACT2FN[con
+00003b00: 6669 672e 6869 6464 656e 5f61 6374 5d0a  fig.hidden_act].
+00003b10: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00003b20: 2020 2020 2020 2020 2020 7365 6c66 2e69            self.i
+00003b30: 6e74 6572 6d65 6469 6174 655f 6163 745f  ntermediate_act_
+00003b40: 666e 203d 2063 6f6e 6669 672e 6869 6464  fn = config.hidd
+00003b50: 656e 5f61 6374 0a0a 2020 2020 6465 6620  en_act..    def 
+00003b60: 636f 6e73 7472 7563 7428 7365 6c66 2c20  construct(self, 
+00003b70: 6869 6464 656e 5f73 7461 7465 733a 206d  hidden_states: m
+00003b80: 696e 6473 706f 7265 2e54 656e 736f 7229  indspore.Tensor)
+00003b90: 202d 3e20 6d69 6e64 7370 6f72 652e 5465   -> mindspore.Te
+00003ba0: 6e73 6f72 3a0a 2020 2020 2020 2020 6869  nsor:.        hi
+00003bb0: 6464 656e 5f73 7461 7465 7320 3d20 7365  dden_states = se
+00003bc0: 6c66 2e64 656e 7365 2868 6964 6465 6e5f  lf.dense(hidden_
+00003bd0: 7374 6174 6573 290a 2020 2020 2020 2020  states).        
+00003be0: 6869 6464 656e 5f73 7461 7465 7320 3d20  hidden_states = 
+00003bf0: 7365 6c66 2e69 6e74 6572 6d65 6469 6174  self.intermediat
+00003c00: 655f 6163 745f 666e 2868 6964 6465 6e5f  e_act_fn(hidden_
+00003c10: 7374 6174 6573 290a 2020 2020 2020 2020  states).        
+00003c20: 7265 7475 726e 2068 6964 6465 6e5f 7374  return hidden_st
+00003c30: 6174 6573 0a0a 0a23 2043 6f70 6965 6420  ates...# Copied 
+00003c40: 6672 6f6d 2074 7261 6e73 666f 726d 6572  from transformer
+00003c50: 732e 6d6f 6465 6c73 2e62 6572 742e 6d6f  s.models.bert.mo
+00003c60: 6465 6c69 6e67 5f62 6572 742e 4265 7274  deling_bert.Bert
+00003c70: 4f75 7470 7574 2077 6974 6820 4265 7274  Output with Bert
+00003c80: 2d3e 4272 6964 6765 546f 7765 720a 636c  ->BridgeTower.cl
+00003c90: 6173 7320 4272 6964 6765 546f 7765 724f  ass BridgeTowerO
+00003ca0: 7574 7075 7428 6e6e 2e43 656c 6c29 3a0a  utput(nn.Cell):.
+00003cb0: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
+00003cc0: 2873 656c 662c 2063 6f6e 6669 6729 3a0a  (self, config):.
+00003cd0: 2020 2020 2020 2020 7375 7065 7228 292e          super().
+00003ce0: 5f5f 696e 6974 5f5f 2829 0a20 2020 2020  __init__().     
+00003cf0: 2020 2073 656c 662e 6465 6e73 6520 3d20     self.dense = 
+00003d00: 6e6e 2e44 656e 7365 2863 6f6e 6669 672e  nn.Dense(config.
+00003d10: 696e 7465 726d 6564 6961 7465 5f73 697a  intermediate_siz
+00003d20: 652c 2063 6f6e 6669 672e 6869 6464 656e  e, config.hidden
+00003d30: 5f73 697a 6529 0a20 2020 2020 2020 2073  _size).        s
+00003d40: 656c 662e 4c61 7965 724e 6f72 6d20 3d20  elf.LayerNorm = 
+00003d50: 6e6e 2e4c 6179 6572 4e6f 726d 2863 6f6e  nn.LayerNorm(con
+00003d60: 6669 672e 6869 6464 656e 5f73 697a 652c  fig.hidden_size,
+00003d70: 2065 7073 696c 6f6e 3d63 6f6e 6669 672e   epsilon=config.
+00003d80: 6c61 7965 725f 6e6f 726d 5f65 7073 290a  layer_norm_eps).
+00003d90: 2020 2020 2020 2020 7365 6c66 2e64 726f          self.dro
+00003da0: 706f 7574 203d 206e 6e2e 4472 6f70 6f75  pout = nn.Dropou
+00003db0: 7428 703d 636f 6e66 6967 2e68 6964 6465  t(p=config.hidde
+00003dc0: 6e5f 6472 6f70 6f75 745f 7072 6f62 290a  n_dropout_prob).
+00003dd0: 0a20 2020 2064 6566 2063 6f6e 7374 7275  .    def constru
+00003de0: 6374 2873 656c 662c 2068 6964 6465 6e5f  ct(self, hidden_
+00003df0: 7374 6174 6573 3a20 6d69 6e64 7370 6f72  states: mindspor
+00003e00: 652e 5465 6e73 6f72 2c20 696e 7075 745f  e.Tensor, input_
+00003e10: 7465 6e73 6f72 3a20 6d69 6e64 7370 6f72  tensor: mindspor
+00003e20: 652e 5465 6e73 6f72 2920 2d3e 206d 696e  e.Tensor) -> min
+00003e30: 6473 706f 7265 2e54 656e 736f 723a 0a20  dspore.Tensor:. 
+00003e40: 2020 2020 2020 2068 6964 6465 6e5f 7374         hidden_st
+00003e50: 6174 6573 203d 2073 656c 662e 6465 6e73  ates = self.dens
+00003e60: 6528 6869 6464 656e 5f73 7461 7465 7329  e(hidden_states)
+00003e70: 0a20 2020 2020 2020 2068 6964 6465 6e5f  .        hidden_
+00003e80: 7374 6174 6573 203d 2073 656c 662e 6472  states = self.dr
+00003e90: 6f70 6f75 7428 6869 6464 656e 5f73 7461  opout(hidden_sta
+00003ea0: 7465 7329 0a20 2020 2020 2020 2068 6964  tes).        hid
+00003eb0: 6465 6e5f 7374 6174 6573 203d 2073 656c  den_states = sel
+00003ec0: 662e 4c61 7965 724e 6f72 6d28 6869 6464  f.LayerNorm(hidd
+00003ed0: 656e 5f73 7461 7465 7320 2b20 696e 7075  en_states + inpu
+00003ee0: 745f 7465 6e73 6f72 290a 2020 2020 2020  t_tensor).      
+00003ef0: 2020 7265 7475 726e 2068 6964 6465 6e5f    return hidden_
+00003f00: 7374 6174 6573 0a0a 0a23 2043 6f70 6965  states...# Copie
+00003f10: 6420 6672 6f6d 2074 7261 6e73 666f 726d  d from transform
+00003f20: 6572 732e 6d6f 6465 6c73 2e62 6572 742e  ers.models.bert.
+00003f30: 6d6f 6465 6c69 6e67 5f62 6572 742e 4265  modeling_bert.Be
+00003f40: 7274 506f 6f6c 6572 2077 6974 6820 4265  rtPooler with Be
+00003f50: 7274 2d3e 4272 6964 6765 546f 7765 720a  rt->BridgeTower.
+00003f60: 636c 6173 7320 4272 6964 6765 546f 7765  class BridgeTowe
+00003f70: 7250 6f6f 6c65 7228 6e6e 2e43 656c 6c29  rPooler(nn.Cell)
+00003f80: 3a0a 2020 2020 6465 6620 5f5f 696e 6974  :.    def __init
+00003f90: 5f5f 2873 656c 662c 2063 6f6e 6669 6729  __(self, config)
+00003fa0: 3a0a 2020 2020 2020 2020 7375 7065 7228  :.        super(
+00003fb0: 292e 5f5f 696e 6974 5f5f 2829 0a20 2020  ).__init__().   
+00003fc0: 2020 2020 2073 656c 662e 6465 6e73 6520       self.dense 
+00003fd0: 3d20 6e6e 2e44 656e 7365 2863 6f6e 6669  = nn.Dense(confi
+00003fe0: 672e 6869 6464 656e 5f73 697a 652c 2063  g.hidden_size, c
+00003ff0: 6f6e 6669 672e 6869 6464 656e 5f73 697a  onfig.hidden_siz
+00004000: 6529 0a20 2020 2020 2020 2073 656c 662e  e).        self.
+00004010: 6163 7469 7661 7469 6f6e 203d 206e 6e2e  activation = nn.
+00004020: 5461 6e68 2829 0a0a 2020 2020 6465 6620  Tanh()..    def 
+00004030: 636f 6e73 7472 7563 7428 7365 6c66 2c20  construct(self, 
+00004040: 6869 6464 656e 5f73 7461 7465 733a 206d  hidden_states: m
+00004050: 696e 6473 706f 7265 2e54 656e 736f 7229  indspore.Tensor)
+00004060: 202d 3e20 6d69 6e64 7370 6f72 652e 5465   -> mindspore.Te
+00004070: 6e73 6f72 3a0a 2020 2020 2020 2020 2320  nsor:.        # 
+00004080: 5765 2022 706f 6f6c 2220 7468 6520 6d6f  We "pool" the mo
+00004090: 6465 6c20 6279 2073 696d 706c 7920 7461  del by simply ta
+000040a0: 6b69 6e67 2074 6865 2068 6964 6465 6e20  king the hidden 
+000040b0: 7374 6174 6520 636f 7272 6573 706f 6e64  state correspond
+000040c0: 696e 670a 2020 2020 2020 2020 2320 746f  ing.        # to
+000040d0: 2074 6865 2066 6972 7374 2074 6f6b 656e   the first token
+000040e0: 2e0a 2020 2020 2020 2020 6669 7273 745f  ..        first_
+000040f0: 746f 6b65 6e5f 7465 6e73 6f72 203d 2068  token_tensor = h
+00004100: 6964 6465 6e5f 7374 6174 6573 5b3a 2c20  idden_states[:, 
+00004110: 305d 0a20 2020 2020 2020 2070 6f6f 6c65  0].        poole
+00004120: 645f 6f75 7470 7574 203d 2073 656c 662e  d_output = self.
+00004130: 6465 6e73 6528 6669 7273 745f 746f 6b65  dense(first_toke
+00004140: 6e5f 7465 6e73 6f72 290a 2020 2020 2020  n_tensor).      
+00004150: 2020 706f 6f6c 6564 5f6f 7574 7075 7420    pooled_output 
+00004160: 3d20 7365 6c66 2e61 6374 6976 6174 696f  = self.activatio
+00004170: 6e28 706f 6f6c 6564 5f6f 7574 7075 7429  n(pooled_output)
+00004180: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00004190: 706f 6f6c 6564 5f6f 7574 7075 740a 0a0a  pooled_output...
+000041a0: 2320 436f 7069 6564 2066 726f 6d20 7472  # Copied from tr
+000041b0: 616e 7366 6f72 6d65 7273 2e6d 6f64 656c  ansformers.model
+000041c0: 732e 726f 6265 7274 612e 6d6f 6465 6c69  s.roberta.modeli
+000041d0: 6e67 5f72 6f62 6572 7461 2e52 6f62 6572  ng_roberta.Rober
+000041e0: 7461 5365 6c66 4174 7465 6e74 696f 6e20  taSelfAttention 
+000041f0: 7769 7468 2052 6f62 6572 7461 2d3e 4272  with Roberta->Br
+00004200: 6964 6765 546f 7765 720a 636c 6173 7320  idgeTower.class 
+00004210: 4272 6964 6765 546f 7765 7253 656c 6641  BridgeTowerSelfA
+00004220: 7474 656e 7469 6f6e 286e 6e2e 4365 6c6c  ttention(nn.Cell
+00004230: 293a 0a20 2020 2064 6566 205f 5f69 6e69  ):.    def __ini
+00004240: 745f 5f28 7365 6c66 2c20 636f 6e66 6967  t__(self, config
+00004250: 2c20 706f 7369 7469 6f6e 5f65 6d62 6564  , position_embed
+00004260: 6469 6e67 5f74 7970 653d 4e6f 6e65 293a  ding_type=None):
+00004270: 0a20 2020 2020 2020 2073 7570 6572 2829  .        super()
+00004280: 2e5f 5f69 6e69 745f 5f28 290a 2020 2020  .__init__().    
+00004290: 2020 2020 6966 2063 6f6e 6669 672e 6869      if config.hi
+000042a0: 6464 656e 5f73 697a 6520 2520 636f 6e66  dden_size % conf
+000042b0: 6967 2e6e 756d 5f61 7474 656e 7469 6f6e  ig.num_attention
+000042c0: 5f68 6561 6473 2021 3d20 3020 616e 6420  _heads != 0 and 
+000042d0: 6e6f 7420 6861 7361 7474 7228 636f 6e66  not hasattr(conf
+000042e0: 6967 2c20 2265 6d62 6564 6469 6e67 5f73  ig, "embedding_s
+000042f0: 697a 6522 293a 0a20 2020 2020 2020 2020  ize"):.         
+00004300: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+00004310: 726f 7228 0a20 2020 2020 2020 2020 2020  ror(.           
+00004320: 2020 2020 2066 2254 6865 2068 6964 6465       f"The hidde
+00004330: 6e20 7369 7a65 2028 7b63 6f6e 6669 672e  n size ({config.
+00004340: 6869 6464 656e 5f73 697a 657d 2920 6973  hidden_size}) is
+00004350: 206e 6f74 2061 206d 756c 7469 706c 6520   not a multiple 
+00004360: 6f66 2074 6865 206e 756d 6265 7220 6f66  of the number of
+00004370: 2061 7474 656e 7469 6f6e 2022 0a20 2020   attention ".   
+00004380: 2020 2020 2020 2020 2020 2020 2066 2268               f"h
+00004390: 6561 6473 2028 7b63 6f6e 6669 672e 6e75  eads ({config.nu
+000043a0: 6d5f 6174 7465 6e74 696f 6e5f 6865 6164  m_attention_head
+000043b0: 737d 2922 0a20 2020 2020 2020 2020 2020  s})".           
+000043c0: 2029 0a0a 2020 2020 2020 2020 7365 6c66   )..        self
+000043d0: 2e6e 756d 5f61 7474 656e 7469 6f6e 5f68  .num_attention_h
+000043e0: 6561 6473 203d 2063 6f6e 6669 672e 6e75  eads = config.nu
+000043f0: 6d5f 6174 7465 6e74 696f 6e5f 6865 6164  m_attention_head
+00004400: 730a 2020 2020 2020 2020 7365 6c66 2e61  s.        self.a
+00004410: 7474 656e 7469 6f6e 5f68 6561 645f 7369  ttention_head_si
+00004420: 7a65 203d 2069 6e74 2863 6f6e 6669 672e  ze = int(config.
+00004430: 6869 6464 656e 5f73 697a 6520 2f20 636f  hidden_size / co
+00004440: 6e66 6967 2e6e 756d 5f61 7474 656e 7469  nfig.num_attenti
+00004450: 6f6e 5f68 6561 6473 290a 2020 2020 2020  on_heads).      
+00004460: 2020 7365 6c66 2e61 6c6c 5f68 6561 645f    self.all_head_
+00004470: 7369 7a65 203d 2073 656c 662e 6e75 6d5f  size = self.num_
+00004480: 6174 7465 6e74 696f 6e5f 6865 6164 7320  attention_heads 
+00004490: 2a20 7365 6c66 2e61 7474 656e 7469 6f6e  * self.attention
+000044a0: 5f68 6561 645f 7369 7a65 0a0a 2020 2020  _head_size..    
+000044b0: 2020 2020 7365 6c66 2e71 7565 7279 203d      self.query =
+000044c0: 206e 6e2e 4465 6e73 6528 636f 6e66 6967   nn.Dense(config
+000044d0: 2e68 6964 6465 6e5f 7369 7a65 2c20 7365  .hidden_size, se
+000044e0: 6c66 2e61 6c6c 5f68 6561 645f 7369 7a65  lf.all_head_size
+000044f0: 290a 2020 2020 2020 2020 7365 6c66 2e6b  ).        self.k
+00004500: 6579 203d 206e 6e2e 4465 6e73 6528 636f  ey = nn.Dense(co
+00004510: 6e66 6967 2e68 6964 6465 6e5f 7369 7a65  nfig.hidden_size
+00004520: 2c20 7365 6c66 2e61 6c6c 5f68 6561 645f  , self.all_head_
+00004530: 7369 7a65 290a 2020 2020 2020 2020 7365  size).        se
+00004540: 6c66 2e76 616c 7565 203d 206e 6e2e 4465  lf.value = nn.De
+00004550: 6e73 6528 636f 6e66 6967 2e68 6964 6465  nse(config.hidde
+00004560: 6e5f 7369 7a65 2c20 7365 6c66 2e61 6c6c  n_size, self.all
+00004570: 5f68 6561 645f 7369 7a65 290a 0a20 2020  _head_size)..   
+00004580: 2020 2020 2073 656c 662e 6472 6f70 6f75       self.dropou
+00004590: 7420 3d20 6e6e 2e44 726f 706f 7574 2870  t = nn.Dropout(p
+000045a0: 3d63 6f6e 6669 672e 6174 7465 6e74 696f  =config.attentio
+000045b0: 6e5f 7072 6f62 735f 6472 6f70 6f75 745f  n_probs_dropout_
+000045c0: 7072 6f62 290a 2020 2020 2020 2020 7365  prob).        se
+000045d0: 6c66 2e70 6f73 6974 696f 6e5f 656d 6265  lf.position_embe
+000045e0: 6464 696e 675f 7479 7065 203d 2070 6f73  dding_type = pos
+000045f0: 6974 696f 6e5f 656d 6265 6464 696e 675f  ition_embedding_
+00004600: 7479 7065 206f 7220 6765 7461 7474 7228  type or getattr(
+00004610: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+00004620: 6669 672c 2022 706f 7369 7469 6f6e 5f65  fig, "position_e
+00004630: 6d62 6564 6469 6e67 5f74 7970 6522 2c20  mbedding_type", 
+00004640: 2261 6273 6f6c 7574 6522 0a20 2020 2020  "absolute".     
+00004650: 2020 2029 0a20 2020 2020 2020 2069 6620     ).        if 
+00004660: 7365 6c66 2e70 6f73 6974 696f 6e5f 656d  self.position_em
+00004670: 6265 6464 696e 675f 7479 7065 2069 6e20  bedding_type in 
+00004680: 2827 7265 6c61 7469 7665 5f6b 6579 272c  ('relative_key',
+00004690: 2027 7265 6c61 7469 7665 5f6b 6579 5f71   'relative_key_q
+000046a0: 7565 7279 2729 3a0a 2020 2020 2020 2020  uery'):.        
+000046b0: 2020 2020 7365 6c66 2e6d 6178 5f70 6f73      self.max_pos
+000046c0: 6974 696f 6e5f 656d 6265 6464 696e 6773  ition_embeddings
+000046d0: 203d 2063 6f6e 6669 672e 6d61 785f 706f   = config.max_po
+000046e0: 7369 7469 6f6e 5f65 6d62 6564 6469 6e67  sition_embedding
+000046f0: 730a 2020 2020 2020 2020 2020 2020 7365  s.            se
+00004700: 6c66 2e64 6973 7461 6e63 655f 656d 6265  lf.distance_embe
+00004710: 6464 696e 6720 3d20 6e6e 2e45 6d62 6564  dding = nn.Embed
+00004720: 6469 6e67 2832 202a 2063 6f6e 6669 672e  ding(2 * config.
+00004730: 6d61 785f 706f 7369 7469 6f6e 5f65 6d62  max_position_emb
+00004740: 6564 6469 6e67 7320 2d20 312c 2073 656c  eddings - 1, sel
+00004750: 662e 6174 7465 6e74 696f 6e5f 6865 6164  f.attention_head
+00004760: 5f73 697a 6529 0a0a 2020 2020 2020 2020  _size)..        
+00004770: 7365 6c66 2e69 735f 6465 636f 6465 7220  self.is_decoder 
+00004780: 3d20 636f 6e66 6967 2e69 735f 6465 636f  = config.is_deco
+00004790: 6465 720a 0a20 2020 2064 6566 2073 7761  der..    def swa
+000047a0: 7061 7865 735f 666f 725f 7363 6f72 6573  paxes_for_scores
+000047b0: 2873 656c 662c 2078 3a20 6d69 6e64 7370  (self, x: mindsp
+000047c0: 6f72 652e 5465 6e73 6f72 2920 2d3e 206d  ore.Tensor) -> m
+000047d0: 696e 6473 706f 7265 2e54 656e 736f 723a  indspore.Tensor:
+000047e0: 0a20 2020 2020 2020 206e 6577 5f78 5f73  .        new_x_s
+000047f0: 6861 7065 203d 2078 2e73 6861 7065 5b3a  hape = x.shape[:
+00004800: 2d31 5d20 2b20 2873 656c 662e 6e75 6d5f  -1] + (self.num_
+00004810: 6174 7465 6e74 696f 6e5f 6865 6164 732c  attention_heads,
+00004820: 2073 656c 662e 6174 7465 6e74 696f 6e5f   self.attention_
+00004830: 6865 6164 5f73 697a 6529 0a20 2020 2020  head_size).     
+00004840: 2020 2078 203d 2078 2e76 6965 7728 6e65     x = x.view(ne
+00004850: 775f 785f 7368 6170 6529 0a20 2020 2020  w_x_shape).     
+00004860: 2020 2072 6574 7572 6e20 782e 7065 726d     return x.perm
+00004870: 7574 6528 302c 2032 2c20 312c 2033 290a  ute(0, 2, 1, 3).
+00004880: 0a20 2020 2064 6566 2063 6f6e 7374 7275  .    def constru
+00004890: 6374 280a 2020 2020 2020 2020 7365 6c66  ct(.        self
+000048a0: 2c0a 2020 2020 2020 2020 6869 6464 656e  ,.        hidden
+000048b0: 5f73 7461 7465 733a 206d 696e 6473 706f  _states: mindspo
+000048c0: 7265 2e54 656e 736f 722c 0a20 2020 2020  re.Tensor,.     
+000048d0: 2020 2061 7474 656e 7469 6f6e 5f6d 6173     attention_mas
+000048e0: 6b3a 204f 7074 696f 6e61 6c5b 6d69 6e64  k: Optional[mind
+000048f0: 7370 6f72 652e 5465 6e73 6f72 5d20 3d20  spore.Tensor] = 
+00004900: 4e6f 6e65 2c0a 2020 2020 2020 2020 6865  None,.        he
+00004910: 6164 5f6d 6173 6b3a 204f 7074 696f 6e61  ad_mask: Optiona
+00004920: 6c5b 6d69 6e64 7370 6f72 652e 5465 6e73  l[mindspore.Tens
+00004930: 6f72 5d20 3d20 4e6f 6e65 2c0a 2020 2020  or] = None,.    
+00004940: 2020 2020 656e 636f 6465 725f 6869 6464      encoder_hidd
+00004950: 656e 5f73 7461 7465 733a 204f 7074 696f  en_states: Optio
+00004960: 6e61 6c5b 6d69 6e64 7370 6f72 652e 5465  nal[mindspore.Te
+00004970: 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a 2020  nsor] = None,.  
+00004980: 2020 2020 2020 656e 636f 6465 725f 6174        encoder_at
+00004990: 7465 6e74 696f 6e5f 6d61 736b 3a20 4f70  tention_mask: Op
+000049a0: 7469 6f6e 616c 5b6d 696e 6473 706f 7265  tional[mindspore
+000049b0: 2e54 656e 736f 725d 203d 204e 6f6e 652c  .Tensor] = None,
+000049c0: 0a20 2020 2020 2020 2070 6173 745f 6b65  .        past_ke
+000049d0: 795f 7661 6c75 653a 204f 7074 696f 6e61  y_value: Optiona
+000049e0: 6c5b 5475 706c 655b 5475 706c 655b 6d69  l[Tuple[Tuple[mi
+000049f0: 6e64 7370 6f72 652e 5465 6e73 6f72 5d5d  ndspore.Tensor]]
+00004a00: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+00004a10: 2020 6f75 7470 7574 5f61 7474 656e 7469    output_attenti
+00004a20: 6f6e 733a 204f 7074 696f 6e61 6c5b 626f  ons: Optional[bo
+00004a30: 6f6c 5d20 3d20 4661 6c73 652c 0a20 2020  ol] = False,.   
+00004a40: 2029 202d 3e20 5475 706c 655b 6d69 6e64   ) -> Tuple[mind
+00004a50: 7370 6f72 652e 5465 6e73 6f72 5d3a 0a20  spore.Tensor]:. 
+00004a60: 2020 2020 2020 206d 6978 6564 5f71 7565         mixed_que
+00004a70: 7279 5f6c 6179 6572 203d 2073 656c 662e  ry_layer = self.
+00004a80: 7175 6572 7928 6869 6464 656e 5f73 7461  query(hidden_sta
+00004a90: 7465 7329 0a0a 2020 2020 2020 2020 2320  tes)..        # 
+00004aa0: 4966 2074 6869 7320 6973 2069 6e73 7461  If this is insta
+00004ab0: 6e74 6961 7465 6420 6173 2061 2063 726f  ntiated as a cro
+00004ac0: 7373 2d61 7474 656e 7469 6f6e 206d 6f64  ss-attention mod
+00004ad0: 756c 652c 2074 6865 206b 6579 730a 2020  ule, the keys.  
+00004ae0: 2020 2020 2020 2320 616e 6420 7661 6c75        # and valu
+00004af0: 6573 2063 6f6d 6520 6672 6f6d 2061 6e20  es come from an 
+00004b00: 656e 636f 6465 723b 2074 6865 2061 7474  encoder; the att
+00004b10: 656e 7469 6f6e 206d 6173 6b20 6e65 6564  ention mask need
+00004b20: 7320 746f 2062 650a 2020 2020 2020 2020  s to be.        
+00004b30: 2320 7375 6368 2074 6861 7420 7468 6520  # such that the 
+00004b40: 656e 636f 6465 7227 7320 7061 6464 696e  encoder's paddin
+00004b50: 6720 746f 6b65 6e73 2061 7265 206e 6f74  g tokens are not
+00004b60: 2061 7474 656e 6465 6420 746f 2e0a 2020   attended to..  
+00004b70: 2020 2020 2020 6973 5f63 726f 7373 5f61        is_cross_a
+00004b80: 7474 656e 7469 6f6e 203d 2065 6e63 6f64  ttention = encod
+00004b90: 6572 5f68 6964 6465 6e5f 7374 6174 6573  er_hidden_states
+00004ba0: 2069 7320 6e6f 7420 4e6f 6e65 0a0a 2020   is not None..  
+00004bb0: 2020 2020 2020 6966 2069 735f 6372 6f73        if is_cros
+00004bc0: 735f 6174 7465 6e74 696f 6e20 616e 6420  s_attention and 
+00004bd0: 7061 7374 5f6b 6579 5f76 616c 7565 2069  past_key_value i
+00004be0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00004bf0: 2020 2020 2020 2020 2320 7265 7573 6520          # reuse 
+00004c00: 6b2c 762c 2063 726f 7373 5f61 7474 656e  k,v, cross_atten
+00004c10: 7469 6f6e 730a 2020 2020 2020 2020 2020  tions.          
+00004c20: 2020 6b65 795f 6c61 7965 7220 3d20 7061    key_layer = pa
+00004c30: 7374 5f6b 6579 5f76 616c 7565 5b30 5d0a  st_key_value[0].
+00004c40: 2020 2020 2020 2020 2020 2020 7661 6c75              valu
+00004c50: 655f 6c61 7965 7220 3d20 7061 7374 5f6b  e_layer = past_k
+00004c60: 6579 5f76 616c 7565 5b31 5d0a 2020 2020  ey_value[1].    
+00004c70: 2020 2020 2020 2020 6174 7465 6e74 696f          attentio
+00004c80: 6e5f 6d61 736b 203d 2065 6e63 6f64 6572  n_mask = encoder
+00004c90: 5f61 7474 656e 7469 6f6e 5f6d 6173 6b0a  _attention_mask.
+00004ca0: 2020 2020 2020 2020 656c 6966 2069 735f          elif is_
+00004cb0: 6372 6f73 735f 6174 7465 6e74 696f 6e3a  cross_attention:
+00004cc0: 0a20 2020 2020 2020 2020 2020 206b 6579  .            key
+00004cd0: 5f6c 6179 6572 203d 2073 656c 662e 7377  _layer = self.sw
+00004ce0: 6170 6178 6573 5f66 6f72 5f73 636f 7265  apaxes_for_score
+00004cf0: 7328 7365 6c66 2e6b 6579 2865 6e63 6f64  s(self.key(encod
+00004d00: 6572 5f68 6964 6465 6e5f 7374 6174 6573  er_hidden_states
+00004d10: 2929 0a20 2020 2020 2020 2020 2020 2076  )).            v
+00004d20: 616c 7565 5f6c 6179 6572 203d 2073 656c  alue_layer = sel
+00004d30: 662e 7377 6170 6178 6573 5f66 6f72 5f73  f.swapaxes_for_s
+00004d40: 636f 7265 7328 7365 6c66 2e76 616c 7565  cores(self.value
+00004d50: 2865 6e63 6f64 6572 5f68 6964 6465 6e5f  (encoder_hidden_
+00004d60: 7374 6174 6573 2929 0a20 2020 2020 2020  states)).       
+00004d70: 2020 2020 2061 7474 656e 7469 6f6e 5f6d       attention_m
+00004d80: 6173 6b20 3d20 656e 636f 6465 725f 6174  ask = encoder_at
+00004d90: 7465 6e74 696f 6e5f 6d61 736b 0a20 2020  tention_mask.   
+00004da0: 2020 2020 2065 6c69 6620 7061 7374 5f6b       elif past_k
+00004db0: 6579 5f76 616c 7565 2069 7320 6e6f 7420  ey_value is not 
+00004dc0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00004dd0: 2020 6b65 795f 6c61 7965 7220 3d20 7365    key_layer = se
+00004de0: 6c66 2e73 7761 7061 7865 735f 666f 725f  lf.swapaxes_for_
+00004df0: 7363 6f72 6573 2873 656c 662e 6b65 7928  scores(self.key(
+00004e00: 6869 6464 656e 5f73 7461 7465 7329 290a  hidden_states)).
+00004e10: 2020 2020 2020 2020 2020 2020 7661 6c75              valu
+00004e20: 655f 6c61 7965 7220 3d20 7365 6c66 2e73  e_layer = self.s
+00004e30: 7761 7061 7865 735f 666f 725f 7363 6f72  wapaxes_for_scor
+00004e40: 6573 2873 656c 662e 7661 6c75 6528 6869  es(self.value(hi
+00004e50: 6464 656e 5f73 7461 7465 7329 290a 2020  dden_states)).  
+00004e60: 2020 2020 2020 2020 2020 6b65 795f 6c61            key_la
+00004e70: 7965 7220 3d20 6f70 732e 6361 7428 5b70  yer = ops.cat([p
+00004e80: 6173 745f 6b65 795f 7661 6c75 655b 305d  ast_key_value[0]
+00004e90: 2c20 6b65 795f 6c61 7965 725d 2c20 6178  , key_layer], ax
+00004ea0: 6973 3d32 290a 2020 2020 2020 2020 2020  is=2).          
+00004eb0: 2020 7661 6c75 655f 6c61 7965 7220 3d20    value_layer = 
+00004ec0: 6f70 732e 6361 7428 5b70 6173 745f 6b65  ops.cat([past_ke
+00004ed0: 795f 7661 6c75 655b 315d 2c20 7661 6c75  y_value[1], valu
+00004ee0: 655f 6c61 7965 725d 2c20 6178 6973 3d32  e_layer], axis=2
+00004ef0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+00004f00: 2020 2020 2020 2020 2020 2020 6b65 795f              key_
+00004f10: 6c61 7965 7220 3d20 7365 6c66 2e73 7761  layer = self.swa
+00004f20: 7061 7865 735f 666f 725f 7363 6f72 6573  paxes_for_scores
+00004f30: 2873 656c 662e 6b65 7928 6869 6464 656e  (self.key(hidden
+00004f40: 5f73 7461 7465 7329 290a 2020 2020 2020  _states)).      
+00004f50: 2020 2020 2020 7661 6c75 655f 6c61 7965        value_laye
+00004f60: 7220 3d20 7365 6c66 2e73 7761 7061 7865  r = self.swapaxe
+00004f70: 735f 666f 725f 7363 6f72 6573 2873 656c  s_for_scores(sel
+00004f80: 662e 7661 6c75 6528 6869 6464 656e 5f73  f.value(hidden_s
+00004f90: 7461 7465 7329 290a 0a20 2020 2020 2020  tates))..       
+00004fa0: 2071 7565 7279 5f6c 6179 6572 203d 2073   query_layer = s
+00004fb0: 656c 662e 7377 6170 6178 6573 5f66 6f72  elf.swapaxes_for
+00004fc0: 5f73 636f 7265 7328 6d69 7865 645f 7175  _scores(mixed_qu
+00004fd0: 6572 795f 6c61 7965 7229 0a0a 2020 2020  ery_layer)..    
+00004fe0: 2020 2020 7573 655f 6361 6368 6520 3d20      use_cache = 
+00004ff0: 7061 7374 5f6b 6579 5f76 616c 7565 2069  past_key_value i
+00005000: 7320 6e6f 7420 4e6f 6e65 0a20 2020 2020  s not None.     
+00005010: 2020 2069 6620 7365 6c66 2e69 735f 6465     if self.is_de
+00005020: 636f 6465 723a 0a20 2020 2020 2020 2020  coder:.         
+00005030: 2020 2023 2069 6620 6372 6f73 735f 6174     # if cross_at
+00005040: 7465 6e74 696f 6e20 7361 7665 2054 7570  tention save Tup
+00005050: 6c65 286d 696e 6473 706f 7265 2e54 656e  le(mindspore.Ten
+00005060: 736f 722c 206d 696e 6473 706f 7265 2e54  sor, mindspore.T
+00005070: 656e 736f 7229 206f 6620 616c 6c20 6372  ensor) of all cr
+00005080: 6f73 7320 6174 7465 6e74 696f 6e20 6b65  oss attention ke
+00005090: 792f 7661 6c75 655f 7374 6174 6573 2e0a  y/value_states..
+000050a0: 2020 2020 2020 2020 2020 2020 2320 4675              # Fu
+000050b0: 7274 6865 7220 6361 6c6c 7320 746f 2063  rther calls to c
+000050c0: 726f 7373 5f61 7474 656e 7469 6f6e 206c  ross_attention l
+000050d0: 6179 6572 2063 616e 2074 6865 6e20 7265  ayer can then re
+000050e0: 7573 6520 616c 6c20 6372 6f73 732d 6174  use all cross-at
+000050f0: 7465 6e74 696f 6e0a 2020 2020 2020 2020  tention.        
+00005100: 2020 2020 2320 6b65 792f 7661 6c75 655f      # key/value_
+00005110: 7374 6174 6573 2028 6669 7273 7420 2269  states (first "i
+00005120: 6622 2063 6173 6529 0a20 2020 2020 2020  f" case).       
+00005130: 2020 2020 2023 2069 6620 756e 692d 6469       # if uni-di
+00005140: 7265 6374 696f 6e61 6c20 7365 6c66 2d61  rectional self-a
+00005150: 7474 656e 7469 6f6e 2028 6465 636f 6465  ttention (decode
+00005160: 7229 2073 6176 6520 5475 706c 6528 6d69  r) save Tuple(mi
+00005170: 6e64 7370 6f72 652e 5465 6e73 6f72 2c20  ndspore.Tensor, 
+00005180: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+00005190: 2920 6f66 0a20 2020 2020 2020 2020 2020  ) of.           
+000051a0: 2023 2061 6c6c 2070 7265 7669 6f75 7320   # all previous 
+000051b0: 6465 636f 6465 7220 6b65 792f 7661 6c75  decoder key/valu
+000051c0: 655f 7374 6174 6573 2e20 4675 7274 6865  e_states. Furthe
+000051d0: 7220 6361 6c6c 7320 746f 2075 6e69 2d64  r calls to uni-d
+000051e0: 6972 6563 7469 6f6e 616c 2073 656c 662d  irectional self-
+000051f0: 6174 7465 6e74 696f 6e0a 2020 2020 2020  attention.      
+00005200: 2020 2020 2020 2320 6361 6e20 636f 6e63        # can conc
+00005210: 6174 2070 7265 7669 6f75 7320 6465 636f  at previous deco
+00005220: 6465 7220 6b65 792f 7661 6c75 655f 7374  der key/value_st
+00005230: 6174 6573 2074 6f20 6375 7272 656e 7420  ates to current 
+00005240: 7072 6f6a 6563 7465 6420 6b65 792f 7661  projected key/va
+00005250: 6c75 655f 7374 6174 6573 2028 7468 6972  lue_states (thir
+00005260: 6420 2265 6c69 6622 2063 6173 6529 0a20  d "elif" case). 
+00005270: 2020 2020 2020 2020 2020 2023 2069 6620             # if 
+00005280: 656e 636f 6465 7220 6269 2d64 6972 6563  encoder bi-direc
+00005290: 7469 6f6e 616c 2073 656c 662d 6174 7465  tional self-atte
+000052a0: 6e74 696f 6e20 6070 6173 745f 6b65 795f  ntion `past_key_
+000052b0: 7661 6c75 6560 2069 7320 616c 7761 7973  value` is always
+000052c0: 2060 4e6f 6e65 600a 2020 2020 2020 2020   `None`.        
+000052d0: 2020 2020 7061 7374 5f6b 6579 5f76 616c      past_key_val
+000052e0: 7565 203d 2028 6b65 795f 6c61 7965 722c  ue = (key_layer,
+000052f0: 2076 616c 7565 5f6c 6179 6572 290a 0a20   value_layer).. 
+00005300: 2020 2020 2020 2023 2054 616b 6520 7468         # Take th
+00005310: 6520 646f 7420 7072 6f64 7563 7420 6265  e dot product be
+00005320: 7477 6565 6e20 2271 7565 7279 2220 616e  tween "query" an
+00005330: 6420 226b 6579 2220 746f 2067 6574 2074  d "key" to get t
+00005340: 6865 2072 6177 2061 7474 656e 7469 6f6e  he raw attention
+00005350: 2073 636f 7265 732e 0a20 2020 2020 2020   scores..       
+00005360: 2061 7474 656e 7469 6f6e 5f73 636f 7265   attention_score
+00005370: 7320 3d20 6f70 732e 6d61 746d 756c 2871  s = ops.matmul(q
+00005380: 7565 7279 5f6c 6179 6572 2c20 6b65 795f  uery_layer, key_
+00005390: 6c61 7965 722e 7377 6170 6178 6573 282d  layer.swapaxes(-
+000053a0: 312c 202d 3229 290a 0a20 2020 2020 2020  1, -2))..       
+000053b0: 2069 6620 7365 6c66 2e70 6f73 6974 696f   if self.positio
+000053c0: 6e5f 656d 6265 6464 696e 675f 7479 7065  n_embedding_type
+000053d0: 2069 6e20 2827 7265 6c61 7469 7665 5f6b   in ('relative_k
+000053e0: 6579 272c 2027 7265 6c61 7469 7665 5f6b  ey', 'relative_k
+000053f0: 6579 5f71 7565 7279 2729 3a0a 2020 2020  ey_query'):.    
+00005400: 2020 2020 2020 2020 7175 6572 795f 6c65          query_le
+00005410: 6e67 7468 2c20 6b65 795f 6c65 6e67 7468  ngth, key_length
+00005420: 203d 2071 7565 7279 5f6c 6179 6572 2e73   = query_layer.s
+00005430: 6861 7065 5b32 5d2c 206b 6579 5f6c 6179  hape[2], key_lay
+00005440: 6572 2e73 6861 7065 5b32 5d0a 2020 2020  er.shape[2].    
+00005450: 2020 2020 2020 2020 6966 2075 7365 5f63          if use_c
+00005460: 6163 6865 3a0a 2020 2020 2020 2020 2020  ache:.          
+00005470: 2020 2020 2020 706f 7369 7469 6f6e 5f69        position_i
+00005480: 6473 5f6c 203d 206d 696e 6473 706f 7265  ds_l = mindspore
+00005490: 2e74 656e 736f 7228 6b65 795f 6c65 6e67  .tensor(key_leng
+000054a0: 7468 202d 2031 2c20 6474 7970 653d 6d69  th - 1, dtype=mi
+000054b0: 6e64 7370 6f72 652e 696e 7436 3429 2e76  ndspore.int64).v
+000054c0: 6965 7728 0a20 2020 2020 2020 2020 2020  iew(.           
+000054d0: 2020 2020 2020 2020 202d 312c 2031 0a20           -1, 1. 
+000054e0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+000054f0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00005500: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00005510: 2020 2070 6f73 6974 696f 6e5f 6964 735f     position_ids_
+00005520: 6c20 3d20 6f70 732e 6172 616e 6765 2871  l = ops.arange(q
+00005530: 7565 7279 5f6c 656e 6774 682c 2064 7479  uery_length, dty
+00005540: 7065 3d6d 696e 6473 706f 7265 2e69 6e74  pe=mindspore.int
+00005550: 3634 292e 7669 6577 282d 312c 2031 290a  64).view(-1, 1).
+00005560: 2020 2020 2020 2020 2020 2020 706f 7369              posi
+00005570: 7469 6f6e 5f69 6473 5f72 203d 206f 7073  tion_ids_r = ops
+00005580: 2e61 7261 6e67 6528 6b65 795f 6c65 6e67  .arange(key_leng
+00005590: 7468 2c20 6474 7970 653d 6d69 6e64 7370  th, dtype=mindsp
+000055a0: 6f72 652e 696e 7436 3429 2e76 6965 7728  ore.int64).view(
+000055b0: 312c 202d 3129 0a20 2020 2020 2020 2020  1, -1).         
+000055c0: 2020 2064 6973 7461 6e63 6520 3d20 706f     distance = po
+000055d0: 7369 7469 6f6e 5f69 6473 5f6c 202d 2070  sition_ids_l - p
+000055e0: 6f73 6974 696f 6e5f 6964 735f 720a 0a20  osition_ids_r.. 
+000055f0: 2020 2020 2020 2020 2020 2070 6f73 6974             posit
+00005600: 696f 6e61 6c5f 656d 6265 6464 696e 6720  ional_embedding 
+00005610: 3d20 7365 6c66 2e64 6973 7461 6e63 655f  = self.distance_
+00005620: 656d 6265 6464 696e 6728 6469 7374 616e  embedding(distan
+00005630: 6365 202b 2073 656c 662e 6d61 785f 706f  ce + self.max_po
+00005640: 7369 7469 6f6e 5f65 6d62 6564 6469 6e67  sition_embedding
+00005650: 7320 2d20 3129 0a20 2020 2020 2020 2020  s - 1).         
+00005660: 2020 2070 6f73 6974 696f 6e61 6c5f 656d     positional_em
+00005670: 6265 6464 696e 6720 3d20 706f 7369 7469  bedding = positi
+00005680: 6f6e 616c 5f65 6d62 6564 6469 6e67 2e74  onal_embedding.t
+00005690: 6f28 6474 7970 653d 7175 6572 795f 6c61  o(dtype=query_la
+000056a0: 7965 722e 6474 7970 6529 2020 2320 6670  yer.dtype)  # fp
+000056b0: 3136 2063 6f6d 7061 7469 6269 6c69 7479  16 compatibility
+000056c0: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+000056d0: 2073 656c 662e 706f 7369 7469 6f6e 5f65   self.position_e
+000056e0: 6d62 6564 6469 6e67 5f74 7970 6520 3d3d  mbedding_type ==
+000056f0: 2022 7265 6c61 7469 7665 5f6b 6579 223a   "relative_key":
+00005700: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005710: 2072 656c 6174 6976 655f 706f 7369 7469   relative_positi
+00005720: 6f6e 5f73 636f 7265 7320 3d20 6f70 732e  on_scores = ops.
+00005730: 6569 6e73 756d 2822 6268 6c64 2c6c 7264  einsum("bhld,lrd
+00005740: 2d3e 6268 6c72 222c 2071 7565 7279 5f6c  ->bhlr", query_l
+00005750: 6179 6572 2c20 706f 7369 7469 6f6e 616c  ayer, positional
+00005760: 5f65 6d62 6564 6469 6e67 290a 2020 2020  _embedding).    
+00005770: 2020 2020 2020 2020 2020 2020 6174 7465              atte
+00005780: 6e74 696f 6e5f 7363 6f72 6573 203d 2061  ntion_scores = a
+00005790: 7474 656e 7469 6f6e 5f73 636f 7265 7320  ttention_scores 
+000057a0: 2b20 7265 6c61 7469 7665 5f70 6f73 6974  + relative_posit
+000057b0: 696f 6e5f 7363 6f72 6573 0a20 2020 2020  ion_scores.     
+000057c0: 2020 2020 2020 2065 6c69 6620 7365 6c66         elif self
+000057d0: 2e70 6f73 6974 696f 6e5f 656d 6265 6464  .position_embedd
+000057e0: 696e 675f 7479 7065 203d 3d20 2272 656c  ing_type == "rel
+000057f0: 6174 6976 655f 6b65 795f 7175 6572 7922  ative_key_query"
+00005800: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00005810: 2020 7265 6c61 7469 7665 5f70 6f73 6974    relative_posit
+00005820: 696f 6e5f 7363 6f72 6573 5f71 7565 7279  ion_scores_query
+00005830: 203d 206f 7073 2e65 696e 7375 6d28 2262   = ops.einsum("b
+00005840: 686c 642c 6c72 642d 3e62 686c 7222 2c20  hld,lrd->bhlr", 
+00005850: 7175 6572 795f 6c61 7965 722c 2070 6f73  query_layer, pos
+00005860: 6974 696f 6e61 6c5f 656d 6265 6464 696e  itional_embeddin
+00005870: 6729 0a20 2020 2020 2020 2020 2020 2020  g).             
+00005880: 2020 2072 656c 6174 6976 655f 706f 7369     relative_posi
+00005890: 7469 6f6e 5f73 636f 7265 735f 6b65 7920  tion_scores_key 
+000058a0: 3d20 6f70 732e 6569 6e73 756d 2822 6268  = ops.einsum("bh
+000058b0: 7264 2c6c 7264 2d3e 6268 6c72 222c 206b  rd,lrd->bhlr", k
+000058c0: 6579 5f6c 6179 6572 2c20 706f 7369 7469  ey_layer, positi
+000058d0: 6f6e 616c 5f65 6d62 6564 6469 6e67 290a  onal_embedding).
+000058e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000058f0: 6174 7465 6e74 696f 6e5f 7363 6f72 6573  attention_scores
+00005900: 203d 2061 7474 656e 7469 6f6e 5f73 636f   = attention_sco
+00005910: 7265 7320 2b20 7265 6c61 7469 7665 5f70  res + relative_p
+00005920: 6f73 6974 696f 6e5f 7363 6f72 6573 5f71  osition_scores_q
+00005930: 7565 7279 202b 2072 656c 6174 6976 655f  uery + relative_
+00005940: 706f 7369 7469 6f6e 5f73 636f 7265 735f  position_scores_
+00005950: 6b65 790a 0a20 2020 2020 2020 2061 7474  key..        att
+00005960: 656e 7469 6f6e 5f73 636f 7265 7320 3d20  ention_scores = 
+00005970: 6174 7465 6e74 696f 6e5f 7363 6f72 6573  attention_scores
+00005980: 202f 206d 6174 682e 7371 7274 2873 656c   / math.sqrt(sel
+00005990: 662e 6174 7465 6e74 696f 6e5f 6865 6164  f.attention_head
+000059a0: 5f73 697a 6529 0a20 2020 2020 2020 2069  _size).        i
+000059b0: 6620 6174 7465 6e74 696f 6e5f 6d61 736b  f attention_mask
+000059c0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+000059d0: 2020 2020 2020 2020 2020 2320 4170 706c            # Appl
+000059e0: 7920 7468 6520 6174 7465 6e74 696f 6e20  y the attention 
+000059f0: 6d61 736b 2069 7320 2870 7265 636f 6d70  mask is (precomp
+00005a00: 7574 6564 2066 6f72 2061 6c6c 206c 6179  uted for all lay
+00005a10: 6572 7320 696e 2042 7269 6467 6554 6f77  ers in BridgeTow
+00005a20: 6572 4d6f 6465 6c20 666f 7277 6172 6428  erModel forward(
+00005a30: 2920 6675 6e63 7469 6f6e 290a 2020 2020  ) function).    
+00005a40: 2020 2020 2020 2020 6174 7465 6e74 696f          attentio
+00005a50: 6e5f 7363 6f72 6573 203d 2061 7474 656e  n_scores = atten
+00005a60: 7469 6f6e 5f73 636f 7265 7320 2b20 6174  tion_scores + at
+00005a70: 7465 6e74 696f 6e5f 6d61 736b 0a0a 2020  tention_mask..  
+00005a80: 2020 2020 2020 2320 4e6f 726d 616c 697a        # Normaliz
+00005a90: 6520 7468 6520 6174 7465 6e74 696f 6e20  e the attention 
+00005aa0: 7363 6f72 6573 2074 6f20 7072 6f62 6162  scores to probab
+00005ab0: 696c 6974 6965 732e 0a20 2020 2020 2020  ilities..       
+00005ac0: 2061 7474 656e 7469 6f6e 5f70 726f 6273   attention_probs
+00005ad0: 203d 206f 7073 2e73 6f66 746d 6178 2861   = ops.softmax(a
+00005ae0: 7474 656e 7469 6f6e 5f73 636f 7265 732c  ttention_scores,
+00005af0: 2061 7869 733d 2d31 290a 0a20 2020 2020   axis=-1)..     
+00005b00: 2020 2023 2054 6869 7320 6973 2061 6374     # This is act
+00005b10: 7561 6c6c 7920 6472 6f70 7069 6e67 206f  ually dropping o
+00005b20: 7574 2065 6e74 6972 6520 746f 6b65 6e73  ut entire tokens
+00005b30: 2074 6f20 6174 7465 6e64 2074 6f2c 2077   to attend to, w
+00005b40: 6869 6368 206d 6967 6874 0a20 2020 2020  hich might.     
+00005b50: 2020 2023 2073 6565 6d20 6120 6269 7420     # seem a bit 
+00005b60: 756e 7573 7561 6c2c 2062 7574 2069 7320  unusual, but is 
+00005b70: 7461 6b65 6e20 6672 6f6d 2074 6865 206f  taken from the o
+00005b80: 7269 6769 6e61 6c20 5472 616e 7366 6f72  riginal Transfor
+00005b90: 6d65 7220 7061 7065 722e 0a20 2020 2020  mer paper..     
+00005ba0: 2020 2061 7474 656e 7469 6f6e 5f70 726f     attention_pro
+00005bb0: 6273 203d 2073 656c 662e 6472 6f70 6f75  bs = self.dropou
+00005bc0: 7428 6174 7465 6e74 696f 6e5f 7072 6f62  t(attention_prob
+00005bd0: 7329 0a0a 2020 2020 2020 2020 2320 4d61  s)..        # Ma
+00005be0: 736b 2068 6561 6473 2069 6620 7765 2077  sk heads if we w
+00005bf0: 616e 7420 746f 0a20 2020 2020 2020 2069  ant to.        i
+00005c00: 6620 6865 6164 5f6d 6173 6b20 6973 206e  f head_mask is n
+00005c10: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00005c20: 2020 2020 2061 7474 656e 7469 6f6e 5f70       attention_p
+00005c30: 726f 6273 203d 2061 7474 656e 7469 6f6e  robs = attention
+00005c40: 5f70 726f 6273 202a 2068 6561 645f 6d61  _probs * head_ma
+00005c50: 736b 0a0a 2020 2020 2020 2020 636f 6e74  sk..        cont
+00005c60: 6578 745f 6c61 7965 7220 3d20 6f70 732e  ext_layer = ops.
+00005c70: 6d61 746d 756c 2861 7474 656e 7469 6f6e  matmul(attention
+00005c80: 5f70 726f 6273 2c20 7661 6c75 655f 6c61  _probs, value_la
+00005c90: 7965 7229 0a0a 2020 2020 2020 2020 636f  yer)..        co
+00005ca0: 6e74 6578 745f 6c61 7965 7220 3d20 636f  ntext_layer = co
+00005cb0: 6e74 6578 745f 6c61 7965 722e 7065 726d  ntext_layer.perm
+00005cc0: 7574 6528 302c 2032 2c20 312c 2033 290a  ute(0, 2, 1, 3).
+00005cd0: 2020 2020 2020 2020 6e65 775f 636f 6e74          new_cont
+00005ce0: 6578 745f 6c61 7965 725f 7368 6170 6520  ext_layer_shape 
+00005cf0: 3d20 636f 6e74 6578 745f 6c61 7965 722e  = context_layer.
+00005d00: 7368 6170 655b 3a2d 325d 202b 2028 7365  shape[:-2] + (se
+00005d10: 6c66 2e61 6c6c 5f68 6561 645f 7369 7a65  lf.all_head_size
+00005d20: 2c29 0a20 2020 2020 2020 2063 6f6e 7465  ,).        conte
+00005d30: 7874 5f6c 6179 6572 203d 2063 6f6e 7465  xt_layer = conte
+00005d40: 7874 5f6c 6179 6572 2e76 6965 7728 6e65  xt_layer.view(ne
+00005d50: 775f 636f 6e74 6578 745f 6c61 7965 725f  w_context_layer_
+00005d60: 7368 6170 6529 0a0a 2020 2020 2020 2020  shape)..        
+00005d70: 6f75 7470 7574 7320 3d20 2863 6f6e 7465  outputs = (conte
+00005d80: 7874 5f6c 6179 6572 2c20 6174 7465 6e74  xt_layer, attent
+00005d90: 696f 6e5f 7072 6f62 7329 2069 6620 6f75  ion_probs) if ou
+00005da0: 7470 7574 5f61 7474 656e 7469 6f6e 7320  tput_attentions 
+00005db0: 656c 7365 2028 636f 6e74 6578 745f 6c61  else (context_la
+00005dc0: 7965 722c 290a 0a20 2020 2020 2020 2069  yer,)..        i
+00005dd0: 6620 7365 6c66 2e69 735f 6465 636f 6465  f self.is_decode
+00005de0: 723a 0a20 2020 2020 2020 2020 2020 206f  r:.            o
+00005df0: 7574 7075 7473 203d 206f 7574 7075 7473  utputs = outputs
+00005e00: 202b 2028 7061 7374 5f6b 6579 5f76 616c   + (past_key_val
+00005e10: 7565 2c29 0a20 2020 2020 2020 2072 6574  ue,).        ret
+00005e20: 7572 6e20 6f75 7470 7574 730a 0a0a 2320  urn outputs...# 
+00005e30: 436f 7069 6564 2066 726f 6d20 7472 616e  Copied from tran
+00005e40: 7366 6f72 6d65 7273 2e6d 6f64 656c 732e  sformers.models.
+00005e50: 6265 7274 2e6d 6f64 656c 696e 675f 6265  bert.modeling_be
+00005e60: 7274 2e42 6572 7441 7474 656e 7469 6f6e  rt.BertAttention
+00005e70: 2077 6974 6820 4265 7274 2d3e 4272 6964   with Bert->Brid
+00005e80: 6765 546f 7765 720a 636c 6173 7320 4272  geTower.class Br
+00005e90: 6964 6765 546f 7765 7241 7474 656e 7469  idgeTowerAttenti
+00005ea0: 6f6e 286e 6e2e 4365 6c6c 293a 0a20 2020  on(nn.Cell):.   
+00005eb0: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
+00005ec0: 6c66 2c20 636f 6e66 6967 2c20 706f 7369  lf, config, posi
+00005ed0: 7469 6f6e 5f65 6d62 6564 6469 6e67 5f74  tion_embedding_t
+00005ee0: 7970 653d 4e6f 6e65 293a 0a20 2020 2020  ype=None):.     
+00005ef0: 2020 2073 7570 6572 2829 2e5f 5f69 6e69     super().__ini
+00005f00: 745f 5f28 290a 2020 2020 2020 2020 7365  t__().        se
+00005f10: 6c66 2e73 656c 6620 3d20 4272 6964 6765  lf.self = Bridge
+00005f20: 546f 7765 7253 656c 6641 7474 656e 7469  TowerSelfAttenti
+00005f30: 6f6e 2863 6f6e 6669 672c 2070 6f73 6974  on(config, posit
+00005f40: 696f 6e5f 656d 6265 6464 696e 675f 7479  ion_embedding_ty
+00005f50: 7065 3d70 6f73 6974 696f 6e5f 656d 6265  pe=position_embe
+00005f60: 6464 696e 675f 7479 7065 290a 2020 2020  dding_type).    
+00005f70: 2020 2020 7365 6c66 2e6f 7574 7075 7420      self.output 
+00005f80: 3d20 4272 6964 6765 546f 7765 7253 656c  = BridgeTowerSel
+00005f90: 664f 7574 7075 7428 636f 6e66 6967 290a  fOutput(config).
+00005fa0: 2020 2020 2020 2020 7365 6c66 2e70 7275          self.pru
+00005fb0: 6e65 645f 6865 6164 7320 3d20 7365 7428  ned_heads = set(
+00005fc0: 290a 0a20 2020 2064 6566 2070 7275 6e65  )..    def prune
+00005fd0: 5f68 6561 6473 2873 656c 662c 2068 6561  _heads(self, hea
+00005fe0: 6473 293a 0a20 2020 2020 2020 2069 6620  ds):.        if 
+00005ff0: 6c65 6e28 6865 6164 7329 203d 3d20 303a  len(heads) == 0:
+00006000: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00006010: 7572 6e0a 2020 2020 2020 2020 6865 6164  urn.        head
+00006020: 732c 2069 6e64 6578 203d 2066 696e 645f  s, index = find_
+00006030: 7072 756e 6561 626c 655f 6865 6164 735f  pruneable_heads_
+00006040: 616e 645f 696e 6469 6365 7328 0a20 2020  and_indices(.   
+00006050: 2020 2020 2020 2020 2068 6561 6473 2c20           heads, 
+00006060: 7365 6c66 2e73 656c 662e 6e75 6d5f 6174  self.self.num_at
+00006070: 7465 6e74 696f 6e5f 6865 6164 732c 2073  tention_heads, s
+00006080: 656c 662e 7365 6c66 2e61 7474 656e 7469  elf.self.attenti
+00006090: 6f6e 5f68 6561 645f 7369 7a65 2c20 7365  on_head_size, se
+000060a0: 6c66 2e70 7275 6e65 645f 6865 6164 730a  lf.pruned_heads.
+000060b0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+000060c0: 2020 2023 2050 7275 6e65 206c 696e 6561     # Prune linea
+000060d0: 7220 6c61 7965 7273 0a20 2020 2020 2020  r layers.       
+000060e0: 2073 656c 662e 7365 6c66 2e71 7565 7279   self.self.query
+000060f0: 203d 2070 7275 6e65 5f6c 696e 6561 725f   = prune_linear_
+00006100: 6c61 7965 7228 7365 6c66 2e73 656c 662e  layer(self.self.
+00006110: 7175 6572 792c 2069 6e64 6578 290a 2020  query, index).  
+00006120: 2020 2020 2020 7365 6c66 2e73 656c 662e        self.self.
+00006130: 6b65 7920 3d20 7072 756e 655f 6c69 6e65  key = prune_line
+00006140: 6172 5f6c 6179 6572 2873 656c 662e 7365  ar_layer(self.se
+00006150: 6c66 2e6b 6579 2c20 696e 6465 7829 0a20  lf.key, index). 
+00006160: 2020 2020 2020 2073 656c 662e 7365 6c66         self.self
+00006170: 2e76 616c 7565 203d 2070 7275 6e65 5f6c  .value = prune_l
+00006180: 696e 6561 725f 6c61 7965 7228 7365 6c66  inear_layer(self
+00006190: 2e73 656c 662e 7661 6c75 652c 2069 6e64  .self.value, ind
+000061a0: 6578 290a 2020 2020 2020 2020 7365 6c66  ex).        self
+000061b0: 2e6f 7574 7075 742e 6465 6e73 6520 3d20  .output.dense = 
+000061c0: 7072 756e 655f 6c69 6e65 6172 5f6c 6179  prune_linear_lay
+000061d0: 6572 2873 656c 662e 6f75 7470 7574 2e64  er(self.output.d
+000061e0: 656e 7365 2c20 696e 6465 782c 2061 7869  ense, index, axi
+000061f0: 733d 3129 0a0a 2020 2020 2020 2020 2320  s=1)..        # 
+00006200: 5570 6461 7465 2068 7970 6572 2070 6172  Update hyper par
+00006210: 616d 7320 616e 6420 7374 6f72 6520 7072  ams and store pr
+00006220: 756e 6564 2068 6561 6473 0a20 2020 2020  uned heads.     
+00006230: 2020 2073 656c 662e 7365 6c66 2e6e 756d     self.self.num
+00006240: 5f61 7474 656e 7469 6f6e 5f68 6561 6473  _attention_heads
+00006250: 203d 2073 656c 662e 7365 6c66 2e6e 756d   = self.self.num
+00006260: 5f61 7474 656e 7469 6f6e 5f68 6561 6473  _attention_heads
+00006270: 202d 206c 656e 2868 6561 6473 290a 2020   - len(heads).  
+00006280: 2020 2020 2020 7365 6c66 2e73 656c 662e        self.self.
+00006290: 616c 6c5f 6865 6164 5f73 697a 6520 3d20  all_head_size = 
+000062a0: 7365 6c66 2e73 656c 662e 6174 7465 6e74  self.self.attent
+000062b0: 696f 6e5f 6865 6164 5f73 697a 6520 2a20  ion_head_size * 
+000062c0: 7365 6c66 2e73 656c 662e 6e75 6d5f 6174  self.self.num_at
+000062d0: 7465 6e74 696f 6e5f 6865 6164 730a 2020  tention_heads.  
+000062e0: 2020 2020 2020 7365 6c66 2e70 7275 6e65        self.prune
+000062f0: 645f 6865 6164 7320 3d20 7365 6c66 2e70  d_heads = self.p
+00006300: 7275 6e65 645f 6865 6164 732e 756e 696f  runed_heads.unio
+00006310: 6e28 6865 6164 7329 0a0a 2020 2020 6465  n(heads)..    de
+00006320: 6620 636f 6e73 7472 7563 7428 0a20 2020  f construct(.   
+00006330: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+00006340: 2020 2068 6964 6465 6e5f 7374 6174 6573     hidden_states
+00006350: 3a20 6d69 6e64 7370 6f72 652e 5465 6e73  : mindspore.Tens
+00006360: 6f72 2c0a 2020 2020 2020 2020 6174 7465  or,.        atte
+00006370: 6e74 696f 6e5f 6d61 736b 3a20 4f70 7469  ntion_mask: Opti
+00006380: 6f6e 616c 5b6d 696e 6473 706f 7265 2e54  onal[mindspore.T
+00006390: 656e 736f 725d 203d 204e 6f6e 652c 0a20  ensor] = None,. 
+000063a0: 2020 2020 2020 2068 6561 645f 6d61 736b         head_mask
+000063b0: 3a20 4f70 7469 6f6e 616c 5b6d 696e 6473  : Optional[minds
+000063c0: 706f 7265 2e54 656e 736f 725d 203d 204e  pore.Tensor] = N
+000063d0: 6f6e 652c 0a20 2020 2020 2020 2065 6e63  one,.        enc
+000063e0: 6f64 6572 5f68 6964 6465 6e5f 7374 6174  oder_hidden_stat
+000063f0: 6573 3a20 4f70 7469 6f6e 616c 5b6d 696e  es: Optional[min
+00006400: 6473 706f 7265 2e54 656e 736f 725d 203d  dspore.Tensor] =
+00006410: 204e 6f6e 652c 0a20 2020 2020 2020 2065   None,.        e
+00006420: 6e63 6f64 6572 5f61 7474 656e 7469 6f6e  ncoder_attention
+00006430: 5f6d 6173 6b3a 204f 7074 696f 6e61 6c5b  _mask: Optional[
+00006440: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+00006450: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+00006460: 2020 7061 7374 5f6b 6579 5f76 616c 7565    past_key_value
+00006470: 3a20 4f70 7469 6f6e 616c 5b54 7570 6c65  : Optional[Tuple
+00006480: 5b54 7570 6c65 5b6d 696e 6473 706f 7265  [Tuple[mindspore
+00006490: 2e54 656e 736f 725d 5d5d 203d 204e 6f6e  .Tensor]]] = Non
+000064a0: 652c 0a20 2020 2020 2020 206f 7574 7075  e,.        outpu
+000064b0: 745f 6174 7465 6e74 696f 6e73 3a20 4f70  t_attentions: Op
+000064c0: 7469 6f6e 616c 5b62 6f6f 6c5d 203d 2046  tional[bool] = F
+000064d0: 616c 7365 2c0a 2020 2020 2920 2d3e 2054  alse,.    ) -> T
+000064e0: 7570 6c65 5b6d 696e 6473 706f 7265 2e54  uple[mindspore.T
+000064f0: 656e 736f 725d 3a0a 2020 2020 2020 2020  ensor]:.        
+00006500: 7365 6c66 5f6f 7574 7075 7473 203d 2073  self_outputs = s
+00006510: 656c 662e 7365 6c66 280a 2020 2020 2020  elf.self(.      
+00006520: 2020 2020 2020 6869 6464 656e 5f73 7461        hidden_sta
+00006530: 7465 732c 0a20 2020 2020 2020 2020 2020  tes,.           
+00006540: 2061 7474 656e 7469 6f6e 5f6d 6173 6b2c   attention_mask,
+00006550: 0a20 2020 2020 2020 2020 2020 2068 6561  .            hea
+00006560: 645f 6d61 736b 2c0a 2020 2020 2020 2020  d_mask,.        
+00006570: 2020 2020 656e 636f 6465 725f 6869 6464      encoder_hidd
+00006580: 656e 5f73 7461 7465 732c 0a20 2020 2020  en_states,.     
+00006590: 2020 2020 2020 2065 6e63 6f64 6572 5f61         encoder_a
+000065a0: 7474 656e 7469 6f6e 5f6d 6173 6b2c 0a20  ttention_mask,. 
+000065b0: 2020 2020 2020 2020 2020 2070 6173 745f             past_
+000065c0: 6b65 795f 7661 6c75 652c 0a20 2020 2020  key_value,.     
+000065d0: 2020 2020 2020 206f 7574 7075 745f 6174         output_at
+000065e0: 7465 6e74 696f 6e73 2c0a 2020 2020 2020  tentions,.      
+000065f0: 2020 290a 2020 2020 2020 2020 6174 7465    ).        atte
+00006600: 6e74 696f 6e5f 6f75 7470 7574 203d 2073  ntion_output = s
+00006610: 656c 662e 6f75 7470 7574 2873 656c 665f  elf.output(self_
+00006620: 6f75 7470 7574 735b 305d 2c20 6869 6464  outputs[0], hidd
+00006630: 656e 5f73 7461 7465 7329 0a20 2020 2020  en_states).     
+00006640: 2020 206f 7574 7075 7473 203d 2028 6174     outputs = (at
+00006650: 7465 6e74 696f 6e5f 6f75 7470 7574 2c29  tention_output,)
+00006660: 202b 2073 656c 665f 6f75 7470 7574 735b   + self_outputs[
+00006670: 313a 5d20 2023 2061 6464 2061 7474 656e  1:]  # add atten
+00006680: 7469 6f6e 7320 6966 2077 6520 6f75 7470  tions if we outp
+00006690: 7574 2074 6865 6d0a 2020 2020 2020 2020  ut them.        
+000066a0: 7265 7475 726e 206f 7574 7075 7473 0a0a  return outputs..
+000066b0: 0a63 6c61 7373 2042 7269 6467 6554 6f77  .class BridgeTow
+000066c0: 6572 4265 7274 4372 6f73 734c 6179 6572  erBertCrossLayer
+000066d0: 286e 6e2e 4365 6c6c 293a 0a20 2020 2064  (nn.Cell):.    d
+000066e0: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
+000066f0: 2c20 636f 6e66 6967 293a 0a20 2020 2020  , config):.     
+00006700: 2020 2073 7570 6572 2829 2e5f 5f69 6e69     super().__ini
+00006710: 745f 5f28 290a 2020 2020 2020 2020 7365  t__().        se
+00006720: 6c66 2e63 6875 6e6b 5f73 697a 655f 6665  lf.chunk_size_fe
+00006730: 6564 5f66 6f72 7761 7264 203d 2063 6f6e  ed_forward = con
+00006740: 6669 672e 6368 756e 6b5f 7369 7a65 5f66  fig.chunk_size_f
+00006750: 6565 645f 666f 7277 6172 640a 2020 2020  eed_forward.    
+00006760: 2020 2020 7365 6c66 2e73 6571 5f6c 656e      self.seq_len
+00006770: 5f64 696d 203d 2031 0a20 2020 2020 2020  _dim = 1.       
+00006780: 2073 656c 662e 6174 7465 6e74 696f 6e20   self.attention 
+00006790: 3d20 4272 6964 6765 546f 7765 7241 7474  = BridgeTowerAtt
+000067a0: 656e 7469 6f6e 2863 6f6e 6669 6729 0a20  ention(config). 
+000067b0: 2020 2020 2020 2073 656c 662e 6973 5f64         self.is_d
+000067c0: 6563 6f64 6572 203d 2063 6f6e 6669 672e  ecoder = config.
+000067d0: 6973 5f64 6563 6f64 6572 0a20 2020 2020  is_decoder.     
+000067e0: 2020 2073 656c 662e 6164 645f 6372 6f73     self.add_cros
+000067f0: 735f 6174 7465 6e74 696f 6e20 3d20 636f  s_attention = co
+00006800: 6e66 6967 2e61 6464 5f63 726f 7373 5f61  nfig.add_cross_a
+00006810: 7474 656e 7469 6f6e 0a20 2020 2020 2020  ttention.       
+00006820: 2073 656c 662e 6372 6f73 7361 7474 656e   self.crossatten
+00006830: 7469 6f6e 203d 2042 7269 6467 6554 6f77  tion = BridgeTow
+00006840: 6572 4174 7465 6e74 696f 6e28 636f 6e66  erAttention(conf
+00006850: 6967 290a 2020 2020 2020 2020 7365 6c66  ig).        self
+00006860: 2e69 6e74 6572 6d65 6469 6174 6520 3d20  .intermediate = 
+00006870: 4272 6964 6765 546f 7765 7249 6e74 6572  BridgeTowerInter
+00006880: 6d65 6469 6174 6528 636f 6e66 6967 290a  mediate(config).
+00006890: 2020 2020 2020 2020 7365 6c66 2e6f 7574          self.out
+000068a0: 7075 7420 3d20 4272 6964 6765 546f 7765  put = BridgeTowe
+000068b0: 724f 7574 7075 7428 636f 6e66 6967 290a  rOutput(config).
+000068c0: 0a20 2020 2064 6566 2063 6f6e 7374 7275  .    def constru
+000068d0: 6374 280a 2020 2020 2020 2020 7365 6c66  ct(.        self
+000068e0: 2c0a 2020 2020 2020 2020 6869 6464 656e  ,.        hidden
+000068f0: 5f73 7461 7465 732c 0a20 2020 2020 2020  _states,.       
+00006900: 2065 6e63 6f64 6572 5f68 6964 6465 6e5f   encoder_hidden_
+00006910: 7374 6174 6573 2c0a 2020 2020 2020 2020  states,.        
+00006920: 6174 7465 6e74 696f 6e5f 6d61 736b 3d4e  attention_mask=N
+00006930: 6f6e 652c 0a20 2020 2020 2020 2068 6561  one,.        hea
+00006940: 645f 6d61 736b 3d4e 6f6e 652c 0a20 2020  d_mask=None,.   
+00006950: 2020 2020 2065 6e63 6f64 6572 5f61 7474       encoder_att
+00006960: 656e 7469 6f6e 5f6d 6173 6b3d 4e6f 6e65  ention_mask=None
+00006970: 2c0a 2020 2020 2020 2020 7061 7374 5f6b  ,.        past_k
+00006980: 6579 5f76 616c 7565 3d4e 6f6e 652c 0a20  ey_value=None,. 
+00006990: 2020 2020 2020 206f 7574 7075 745f 6174         output_at
+000069a0: 7465 6e74 696f 6e73 3d46 616c 7365 2c0a  tentions=False,.
+000069b0: 2020 2020 293a 0a20 2020 2020 2020 2023      ):.        #
+000069c0: 2064 6563 6f64 6572 2075 6e69 2d64 6972   decoder uni-dir
+000069d0: 6563 7469 6f6e 616c 2073 656c 662d 6174  ectional self-at
+000069e0: 7465 6e74 696f 6e20 6361 6368 6564 206b  tention cached k
+000069f0: 6579 2f76 616c 7565 7320 7475 706c 6520  ey/values tuple 
+00006a00: 6973 2061 7420 706f 7369 7469 6f6e 7320  is at positions 
+00006a10: 312c 320a 2020 2020 2020 2020 7365 6c66  1,2.        self
+00006a20: 5f61 7474 656e 7469 6f6e 5f6f 7574 7075  _attention_outpu
+00006a30: 7473 203d 2073 656c 662e 6174 7465 6e74  ts = self.attent
+00006a40: 696f 6e28 0a20 2020 2020 2020 2020 2020  ion(.           
+00006a50: 2068 6964 6465 6e5f 7374 6174 6573 2c0a   hidden_states,.
+00006a60: 2020 2020 2020 2020 2020 2020 6174 7465              atte
+00006a70: 6e74 696f 6e5f 6d61 736b 3d61 7474 656e  ntion_mask=atten
+00006a80: 7469 6f6e 5f6d 6173 6b2c 0a20 2020 2020  tion_mask,.     
+00006a90: 2020 2020 2020 2068 6561 645f 6d61 736b         head_mask
+00006aa0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2020  =None,.         
+00006ab0: 2020 206f 7574 7075 745f 6174 7465 6e74     output_attent
+00006ac0: 696f 6e73 3d6f 7574 7075 745f 6174 7465  ions=output_atte
+00006ad0: 6e74 696f 6e73 2c0a 2020 2020 2020 2020  ntions,.        
+00006ae0: 2020 2020 7061 7374 5f6b 6579 5f76 616c      past_key_val
+00006af0: 7565 3d4e 6f6e 652c 0a20 2020 2020 2020  ue=None,.       
+00006b00: 2029 0a20 2020 2020 2020 2061 7474 656e   ).        atten
+00006b10: 7469 6f6e 5f6f 7574 7075 7420 3d20 7365  tion_output = se
+00006b20: 6c66 5f61 7474 656e 7469 6f6e 5f6f 7574  lf_attention_out
+00006b30: 7075 7473 5b30 5d0a 0a20 2020 2020 2020  puts[0]..       
+00006b40: 2023 2069 6620 6465 636f 6465 722c 2074   # if decoder, t
+00006b50: 6865 206c 6173 7420 6f75 7470 7574 2069  he last output i
+00006b60: 7320 7475 706c 6520 6f66 2073 656c 662d  s tuple of self-
+00006b70: 6174 746e 2063 6163 6865 0a20 2020 2020  attn cache.     
+00006b80: 2020 2023 2061 6464 2073 656c 6620 6174     # add self at
+00006b90: 7465 6e74 696f 6e73 2069 6620 7765 206f  tentions if we o
+00006ba0: 7574 7075 7420 6174 7465 6e74 696f 6e20  utput attention 
+00006bb0: 7765 6967 6874 730a 2020 2020 2020 2020  weights.        
+00006bc0: 6f75 7470 7574 7320 3d20 7365 6c66 5f61  outputs = self_a
+00006bd0: 7474 656e 7469 6f6e 5f6f 7574 7075 7473  ttention_outputs
+00006be0: 5b31 3a5d 0a0a 2020 2020 2020 2020 6372  [1:]..        cr
+00006bf0: 6f73 735f 6174 7465 6e74 696f 6e5f 6f75  oss_attention_ou
+00006c00: 7470 7574 7320 3d20 7365 6c66 2e63 726f  tputs = self.cro
+00006c10: 7373 6174 7465 6e74 696f 6e28 0a20 2020  ssattention(.   
+00006c20: 2020 2020 2020 2020 2061 7474 656e 7469           attenti
+00006c30: 6f6e 5f6f 7574 7075 742c 0a20 2020 2020  on_output,.     
+00006c40: 2020 2020 2020 2061 7474 656e 7469 6f6e         attention
+00006c50: 5f6d 6173 6b3d 6174 7465 6e74 696f 6e5f  _mask=attention_
+00006c60: 6d61 736b 2c0a 2020 2020 2020 2020 2020  mask,.          
+00006c70: 2020 6865 6164 5f6d 6173 6b3d 6865 6164    head_mask=head
+00006c80: 5f6d 6173 6b2c 0a20 2020 2020 2020 2020  _mask,.         
+00006c90: 2020 2065 6e63 6f64 6572 5f68 6964 6465     encoder_hidde
+00006ca0: 6e5f 7374 6174 6573 3d65 6e63 6f64 6572  n_states=encoder
+00006cb0: 5f68 6964 6465 6e5f 7374 6174 6573 2c0a  _hidden_states,.
+00006cc0: 2020 2020 2020 2020 2020 2020 656e 636f              enco
+00006cd0: 6465 725f 6174 7465 6e74 696f 6e5f 6d61  der_attention_ma
+00006ce0: 736b 3d65 6e63 6f64 6572 5f61 7474 656e  sk=encoder_atten
+00006cf0: 7469 6f6e 5f6d 6173 6b2c 0a20 2020 2020  tion_mask,.     
+00006d00: 2020 2020 2020 2070 6173 745f 6b65 795f         past_key_
+00006d10: 7661 6c75 653d 7061 7374 5f6b 6579 5f76  value=past_key_v
+00006d20: 616c 7565 2c0a 2020 2020 2020 2020 2020  alue,.          
+00006d30: 2020 6f75 7470 7574 5f61 7474 656e 7469    output_attenti
+00006d40: 6f6e 733d 6f75 7470 7574 5f61 7474 656e  ons=output_atten
+00006d50: 7469 6f6e 732c 0a20 2020 2020 2020 2029  tions,.        )
+00006d60: 0a20 2020 2020 2020 2061 7474 656e 7469  .        attenti
+00006d70: 6f6e 5f6f 7574 7075 7420 3d20 6372 6f73  on_output = cros
+00006d80: 735f 6174 7465 6e74 696f 6e5f 6f75 7470  s_attention_outp
+00006d90: 7574 735b 305d 0a20 2020 2020 2020 2023  uts[0].        #
+00006da0: 2061 6464 2063 726f 7373 2061 7474 656e   add cross atten
+00006db0: 7469 6f6e 7320 6966 2077 6520 6f75 7470  tions if we outp
+00006dc0: 7574 2061 7474 656e 7469 6f6e 2077 6569  ut attention wei
+00006dd0: 6768 7473 0a20 2020 2020 2020 206f 7574  ghts.        out
+00006de0: 7075 7473 203d 206f 7574 7075 7473 202b  puts = outputs +
+00006df0: 2063 726f 7373 5f61 7474 656e 7469 6f6e   cross_attention
+00006e00: 5f6f 7574 7075 7473 5b31 3a2d 315d 0a0a  _outputs[1:-1]..
+00006e10: 2020 2020 2020 2020 6c61 7965 725f 6f75          layer_ou
+00006e20: 7470 7574 203d 2061 7070 6c79 5f63 6875  tput = apply_chu
+00006e30: 6e6b 696e 675f 746f 5f66 6f72 7761 7264  nking_to_forward
+00006e40: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
+00006e50: 6c66 2e66 6565 645f 666f 7277 6172 645f  lf.feed_forward_
+00006e60: 6368 756e 6b2c 2073 656c 662e 6368 756e  chunk, self.chun
+00006e70: 6b5f 7369 7a65 5f66 6565 645f 666f 7277  k_size_feed_forw
+00006e80: 6172 642c 2073 656c 662e 7365 715f 6c65  ard, self.seq_le
+00006e90: 6e5f 6469 6d2c 2061 7474 656e 7469 6f6e  n_dim, attention
+00006ea0: 5f6f 7574 7075 740a 2020 2020 2020 2020  _output.        
+00006eb0: 290a 2020 2020 2020 2020 6f75 7470 7574  ).        output
+00006ec0: 7320 3d20 286c 6179 6572 5f6f 7574 7075  s = (layer_outpu
+00006ed0: 742c 2920 2b20 6f75 7470 7574 730a 0a20  t,) + outputs.. 
+00006ee0: 2020 2020 2020 2072 6574 7572 6e20 6f75         return ou
+00006ef0: 7470 7574 730a 0a20 2020 2064 6566 2066  tputs..    def f
+00006f00: 6565 645f 666f 7277 6172 645f 6368 756e  eed_forward_chun
+00006f10: 6b28 7365 6c66 2c20 6174 7465 6e74 696f  k(self, attentio
+00006f20: 6e5f 6f75 7470 7574 293a 0a20 2020 2020  n_output):.     
+00006f30: 2020 2069 6e74 6572 6d65 6469 6174 655f     intermediate_
+00006f40: 6f75 7470 7574 203d 2073 656c 662e 696e  output = self.in
+00006f50: 7465 726d 6564 6961 7465 2861 7474 656e  termediate(atten
+00006f60: 7469 6f6e 5f6f 7574 7075 7429 0a20 2020  tion_output).   
+00006f70: 2020 2020 206c 6179 6572 5f6f 7574 7075       layer_outpu
+00006f80: 7420 3d20 7365 6c66 2e6f 7574 7075 7428  t = self.output(
+00006f90: 696e 7465 726d 6564 6961 7465 5f6f 7574  intermediate_out
+00006fa0: 7075 742c 2061 7474 656e 7469 6f6e 5f6f  put, attention_o
+00006fb0: 7574 7075 7429 0a20 2020 2020 2020 2072  utput).        r
+00006fc0: 6574 7572 6e20 6c61 7965 725f 6f75 7470  eturn layer_outp
+00006fd0: 7574 0a0a 0a63 6c61 7373 2042 7269 6467  ut...class Bridg
+00006fe0: 6554 6f77 6572 5465 7874 4c61 7965 7228  eTowerTextLayer(
+00006ff0: 6e6e 2e43 656c 6c29 3a0a 2020 2020 6465  nn.Cell):.    de
+00007000: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
+00007010: 2063 6f6e 6669 6729 3a0a 2020 2020 2020   config):.      
+00007020: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
+00007030: 5f5f 2829 0a20 2020 2020 2020 2073 656c  __().        sel
+00007040: 662e 6368 756e 6b5f 7369 7a65 5f66 6565  f.chunk_size_fee
+00007050: 645f 666f 7277 6172 6420 3d20 636f 6e66  d_forward = conf
+00007060: 6967 2e63 6875 6e6b 5f73 697a 655f 6665  ig.chunk_size_fe
+00007070: 6564 5f66 6f72 7761 7264 0a20 2020 2020  ed_forward.     
+00007080: 2020 2073 656c 662e 7365 715f 6c65 6e5f     self.seq_len_
+00007090: 6469 6d20 3d20 310a 2020 2020 2020 2020  dim = 1.        
+000070a0: 7365 6c66 2e61 7474 656e 7469 6f6e 203d  self.attention =
+000070b0: 2042 7269 6467 6554 6f77 6572 4174 7465   BridgeTowerAtte
+000070c0: 6e74 696f 6e28 636f 6e66 6967 290a 2020  ntion(config).  
+000070d0: 2020 2020 2020 7365 6c66 2e69 735f 6465        self.is_de
+000070e0: 636f 6465 7220 3d20 636f 6e66 6967 2e69  coder = config.i
+000070f0: 735f 6465 636f 6465 720a 2020 2020 2020  s_decoder.      
+00007100: 2020 7365 6c66 2e61 6464 5f63 726f 7373    self.add_cross
+00007110: 5f61 7474 656e 7469 6f6e 203d 2063 6f6e  _attention = con
+00007120: 6669 672e 6164 645f 6372 6f73 735f 6174  fig.add_cross_at
+00007130: 7465 6e74 696f 6e0a 2020 2020 2020 2020  tention.        
+00007140: 6966 2073 656c 662e 6164 645f 6372 6f73  if self.add_cros
+00007150: 735f 6174 7465 6e74 696f 6e3a 0a20 2020  s_attention:.   
+00007160: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+00007170: 7365 6c66 2e69 735f 6465 636f 6465 723a  self.is_decoder:
+00007180: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007190: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+000071a0: 7228 6622 7b73 656c 667d 2073 686f 756c  r(f"{self} shoul
+000071b0: 6420 6265 2075 7365 6420 6173 2061 2064  d be used as a d
+000071c0: 6563 6f64 6572 206d 6f64 656c 2069 6620  ecoder model if 
+000071d0: 6372 6f73 7320 6174 7465 6e74 696f 6e20  cross attention 
+000071e0: 6973 2061 6464 6564 2229 0a20 2020 2020  is added").     
+000071f0: 2020 2020 2020 2073 656c 662e 6372 6f73         self.cros
+00007200: 7361 7474 656e 7469 6f6e 203d 2042 7269  sattention = Bri
+00007210: 6467 6554 6f77 6572 4174 7465 6e74 696f  dgeTowerAttentio
+00007220: 6e28 636f 6e66 6967 2c20 706f 7369 7469  n(config, positi
+00007230: 6f6e 5f65 6d62 6564 6469 6e67 5f74 7970  on_embedding_typ
+00007240: 653d 2261 6273 6f6c 7574 6522 290a 2020  e="absolute").  
+00007250: 2020 2020 2020 7365 6c66 2e69 6e74 6572        self.inter
+00007260: 6d65 6469 6174 6520 3d20 4272 6964 6765  mediate = Bridge
+00007270: 546f 7765 7249 6e74 6572 6d65 6469 6174  TowerIntermediat
+00007280: 6528 636f 6e66 6967 290a 2020 2020 2020  e(config).      
+00007290: 2020 7365 6c66 2e6f 7574 7075 7420 3d20    self.output = 
+000072a0: 4272 6964 6765 546f 7765 724f 7574 7075  BridgeTowerOutpu
+000072b0: 7428 636f 6e66 6967 290a 0a20 2020 2064  t(config)..    d
+000072c0: 6566 2063 6f6e 7374 7275 6374 280a 2020  ef construct(.  
+000072d0: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+000072e0: 2020 2020 6869 6464 656e 5f73 7461 7465      hidden_state
+000072f0: 733a 206d 696e 6473 706f 7265 2e54 656e  s: mindspore.Ten
+00007300: 736f 722c 0a20 2020 2020 2020 2061 7474  sor,.        att
+00007310: 656e 7469 6f6e 5f6d 6173 6b3a 204f 7074  ention_mask: Opt
+00007320: 696f 6e61 6c5b 6d69 6e64 7370 6f72 652e  ional[mindspore.
+00007330: 5465 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a  Tensor] = None,.
+00007340: 2020 2020 2020 2020 6865 6164 5f6d 6173          head_mas
+00007350: 6b3a 204f 7074 696f 6e61 6c5b 6d69 6e64  k: Optional[mind
+00007360: 7370 6f72 652e 5465 6e73 6f72 5d20 3d20  spore.Tensor] = 
+00007370: 4e6f 6e65 2c0a 2020 2020 2020 2020 656e  None,.        en
+00007380: 636f 6465 725f 6869 6464 656e 5f73 7461  coder_hidden_sta
+00007390: 7465 733a 204f 7074 696f 6e61 6c5b 6d69  tes: Optional[mi
+000073a0: 6e64 7370 6f72 652e 5465 6e73 6f72 5d20  ndspore.Tensor] 
+000073b0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+000073c0: 656e 636f 6465 725f 6174 7465 6e74 696f  encoder_attentio
+000073d0: 6e5f 6d61 736b 3a20 4f70 7469 6f6e 616c  n_mask: Optional
+000073e0: 5b6d 696e 6473 706f 7265 2e54 656e 736f  [mindspore.Tenso
+000073f0: 725d 203d 204e 6f6e 652c 0a20 2020 2020  r] = None,.     
+00007400: 2020 2070 6173 745f 6b65 795f 7661 6c75     past_key_valu
+00007410: 653a 204f 7074 696f 6e61 6c5b 5475 706c  e: Optional[Tupl
+00007420: 655b 5475 706c 655b 6d69 6e64 7370 6f72  e[Tuple[mindspor
+00007430: 652e 5465 6e73 6f72 5d5d 5d20 3d20 4e6f  e.Tensor]]] = No
+00007440: 6e65 2c0a 2020 2020 2020 2020 6f75 7470  ne,.        outp
+00007450: 7574 5f61 7474 656e 7469 6f6e 733a 204f  ut_attentions: O
+00007460: 7074 696f 6e61 6c5b 626f 6f6c 5d20 3d20  ptional[bool] = 
+00007470: 4661 6c73 652c 0a20 2020 2029 202d 3e20  False,.    ) -> 
+00007480: 5475 706c 655b 6d69 6e64 7370 6f72 652e  Tuple[mindspore.
+00007490: 5465 6e73 6f72 5d3a 0a20 2020 2020 2020  Tensor]:.       
+000074a0: 2023 2064 6563 6f64 6572 2075 6e69 2d64   # decoder uni-d
+000074b0: 6972 6563 7469 6f6e 616c 2073 656c 662d  irectional self-
+000074c0: 6174 7465 6e74 696f 6e20 6361 6368 6564  attention cached
+000074d0: 206b 6579 2f76 616c 7565 7320 7475 706c   key/values tupl
+000074e0: 6520 6973 2061 7420 706f 7369 7469 6f6e  e is at position
+000074f0: 7320 312c 320a 2020 2020 2020 2020 7365  s 1,2.        se
+00007500: 6c66 5f61 7474 6e5f 7061 7374 5f6b 6579  lf_attn_past_key
+00007510: 5f76 616c 7565 203d 2070 6173 745f 6b65  _value = past_ke
+00007520: 795f 7661 6c75 655b 3a32 5d20 6966 2070  y_value[:2] if p
+00007530: 6173 745f 6b65 795f 7661 6c75 6520 6973  ast_key_value is
+00007540: 206e 6f74 204e 6f6e 6520 656c 7365 204e   not None else N
+00007550: 6f6e 650a 2020 2020 2020 2020 7365 6c66  one.        self
+00007560: 5f61 7474 656e 7469 6f6e 5f6f 7574 7075  _attention_outpu
+00007570: 7473 203d 2073 656c 662e 6174 7465 6e74  ts = self.attent
+00007580: 696f 6e28 0a20 2020 2020 2020 2020 2020  ion(.           
+00007590: 2068 6964 6465 6e5f 7374 6174 6573 2c0a   hidden_states,.
+000075a0: 2020 2020 2020 2020 2020 2020 6174 7465              atte
+000075b0: 6e74 696f 6e5f 6d61 736b 2c0a 2020 2020  ntion_mask,.    
+000075c0: 2020 2020 2020 2020 6865 6164 5f6d 6173          head_mas
+000075d0: 6b2c 0a20 2020 2020 2020 2020 2020 206f  k,.            o
+000075e0: 7574 7075 745f 6174 7465 6e74 696f 6e73  utput_attentions
+000075f0: 3d6f 7574 7075 745f 6174 7465 6e74 696f  =output_attentio
+00007600: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
+00007610: 7061 7374 5f6b 6579 5f76 616c 7565 3d73  past_key_value=s
+00007620: 656c 665f 6174 746e 5f70 6173 745f 6b65  elf_attn_past_ke
+00007630: 795f 7661 6c75 652c 0a20 2020 2020 2020  y_value,.       
+00007640: 2029 0a20 2020 2020 2020 2061 7474 656e   ).        atten
+00007650: 7469 6f6e 5f6f 7574 7075 7420 3d20 7365  tion_output = se
+00007660: 6c66 5f61 7474 656e 7469 6f6e 5f6f 7574  lf_attention_out
+00007670: 7075 7473 5b30 5d0a 0a20 2020 2020 2020  puts[0]..       
+00007680: 2023 2069 6620 6465 636f 6465 722c 2074   # if decoder, t
+00007690: 6865 206c 6173 7420 6f75 7470 7574 2069  he last output i
+000076a0: 7320 7475 706c 6520 6f66 2073 656c 662d  s tuple of self-
+000076b0: 6174 746e 2063 6163 6865 0a20 2020 2020  attn cache.     
+000076c0: 2020 2069 6620 7365 6c66 2e69 735f 6465     if self.is_de
+000076d0: 636f 6465 723a 0a20 2020 2020 2020 2020  coder:.         
+000076e0: 2020 206f 7574 7075 7473 203d 2073 656c     outputs = sel
+000076f0: 665f 6174 7465 6e74 696f 6e5f 6f75 7470  f_attention_outp
+00007700: 7574 735b 313a 2d31 5d0a 2020 2020 2020  uts[1:-1].      
+00007710: 2020 2020 2020 7072 6573 656e 745f 6b65        present_ke
+00007720: 795f 7661 6c75 6520 3d20 7365 6c66 5f61  y_value = self_a
+00007730: 7474 656e 7469 6f6e 5f6f 7574 7075 7473  ttention_outputs
+00007740: 5b2d 315d 0a20 2020 2020 2020 2065 6c73  [-1].        els
+00007750: 653a 0a20 2020 2020 2020 2020 2020 206f  e:.            o
+00007760: 7574 7075 7473 203d 2073 656c 665f 6174  utputs = self_at
+00007770: 7465 6e74 696f 6e5f 6f75 7470 7574 735b  tention_outputs[
+00007780: 313a 5d20 2023 2061 6464 2073 656c 6620  1:]  # add self 
+00007790: 6174 7465 6e74 696f 6e73 2069 6620 7765  attentions if we
+000077a0: 206f 7574 7075 7420 6174 7465 6e74 696f   output attentio
+000077b0: 6e20 7765 6967 6874 730a 0a20 2020 2020  n weights..     
+000077c0: 2020 2063 726f 7373 5f61 7474 6e5f 7072     cross_attn_pr
+000077d0: 6573 656e 745f 6b65 795f 7661 6c75 6520  esent_key_value 
+000077e0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2069  = None.        i
+000077f0: 6620 7365 6c66 2e69 735f 6465 636f 6465  f self.is_decode
+00007800: 7220 616e 6420 656e 636f 6465 725f 6869  r and encoder_hi
+00007810: 6464 656e 5f73 7461 7465 7320 6973 206e  dden_states is n
+00007820: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
+00007830: 2020 2020 2069 6620 6e6f 7420 6861 7361       if not hasa
+00007840: 7474 7228 7365 6c66 2c20 2263 726f 7373  ttr(self, "cross
+00007850: 6174 7465 6e74 696f 6e22 293a 0a20 2020  attention"):.   
+00007860: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+00007870: 7365 2056 616c 7565 4572 726f 7228 0a20  se ValueError(. 
+00007880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007890: 2020 2066 2249 6620 6065 6e63 6f64 6572     f"If `encoder
+000078a0: 5f68 6964 6465 6e5f 7374 6174 6573 6020  _hidden_states` 
+000078b0: 6172 6520 7061 7373 6564 2c20 7b73 656c  are passed, {sel
+000078c0: 667d 2068 6173 2074 6f20 6265 2069 6e73  f} has to be ins
+000078d0: 7461 6e74 6961 7465 6420 7769 7468 2063  tantiated with c
+000078e0: 726f 7373 2d61 7474 656e 7469 6f6e 206c  ross-attention l
+000078f0: 6179 6572 7322 0a20 2020 2020 2020 2020  ayers".         
+00007900: 2020 2020 2020 2020 2020 2022 2062 7920             " by 
+00007910: 7365 7474 696e 6720 6063 6f6e 6669 672e  setting `config.
+00007920: 6164 645f 6372 6f73 735f 6174 7465 6e74  add_cross_attent
+00007930: 696f 6e3d 5472 7565 6022 0a20 2020 2020  ion=True`".     
+00007940: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00007950: 2020 2020 2020 2020 2020 2320 6372 6f73            # cros
+00007960: 735f 6174 746e 2063 6163 6865 6420 6b65  s_attn cached ke
+00007970: 792f 7661 6c75 6573 2074 7570 6c65 2069  y/values tuple i
+00007980: 7320 6174 2070 6f73 6974 696f 6e73 2033  s at positions 3
+00007990: 2c34 206f 6620 7061 7374 5f6b 6579 5f76  ,4 of past_key_v
+000079a0: 616c 7565 2074 7570 6c65 0a20 2020 2020  alue tuple.     
+000079b0: 2020 2020 2020 2063 726f 7373 5f61 7474         cross_att
+000079c0: 6e5f 7061 7374 5f6b 6579 5f76 616c 7565  n_past_key_value
+000079d0: 203d 2070 6173 745f 6b65 795f 7661 6c75   = past_key_valu
+000079e0: 655b 2d32 3a5d 2069 6620 7061 7374 5f6b  e[-2:] if past_k
+000079f0: 6579 5f76 616c 7565 2069 7320 6e6f 7420  ey_value is not 
+00007a00: 4e6f 6e65 2065 6c73 6520 4e6f 6e65 0a20  None else None. 
+00007a10: 2020 2020 2020 2020 2020 2063 726f 7373             cross
+00007a20: 5f61 7474 656e 7469 6f6e 5f6f 7574 7075  _attention_outpu
+00007a30: 7473 203d 2073 656c 662e 6372 6f73 7361  ts = self.crossa
+00007a40: 7474 656e 7469 6f6e 280a 2020 2020 2020  ttention(.      
+00007a50: 2020 2020 2020 2020 2020 6174 7465 6e74            attent
+00007a60: 696f 6e5f 6f75 7470 7574 2c0a 2020 2020  ion_output,.    
+00007a70: 2020 2020 2020 2020 2020 2020 6174 7465              atte
+00007a80: 6e74 696f 6e5f 6d61 736b 2c0a 2020 2020  ntion_mask,.    
+00007a90: 2020 2020 2020 2020 2020 2020 6865 6164              head
+00007aa0: 5f6d 6173 6b2c 0a20 2020 2020 2020 2020  _mask,.         
+00007ab0: 2020 2020 2020 2065 6e63 6f64 6572 5f68         encoder_h
+00007ac0: 6964 6465 6e5f 7374 6174 6573 2c0a 2020  idden_states,.  
+00007ad0: 2020 2020 2020 2020 2020 2020 2020 656e                en
+00007ae0: 636f 6465 725f 6174 7465 6e74 696f 6e5f  coder_attention_
+00007af0: 6d61 736b 2c0a 2020 2020 2020 2020 2020  mask,.          
+00007b00: 2020 2020 2020 6372 6f73 735f 6174 746e        cross_attn
+00007b10: 5f70 6173 745f 6b65 795f 7661 6c75 652c  _past_key_value,
+00007b20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007b30: 206f 7574 7075 745f 6174 7465 6e74 696f   output_attentio
+00007b40: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
+00007b50: 290a 2020 2020 2020 2020 2020 2020 6174  ).            at
+00007b60: 7465 6e74 696f 6e5f 6f75 7470 7574 203d  tention_output =
+00007b70: 2063 726f 7373 5f61 7474 656e 7469 6f6e   cross_attention
+00007b80: 5f6f 7574 7075 7473 5b30 5d0a 2020 2020  _outputs[0].    
+00007b90: 2020 2020 2020 2020 6f75 7470 7574 7320          outputs 
+00007ba0: 3d20 6f75 7470 7574 7320 2b20 6372 6f73  = outputs + cros
+00007bb0: 735f 6174 7465 6e74 696f 6e5f 6f75 7470  s_attention_outp
+00007bc0: 7574 735b 313a 2d31 5d20 2023 2061 6464  uts[1:-1]  # add
+00007bd0: 2063 726f 7373 2061 7474 656e 7469 6f6e   cross attention
+00007be0: 7320 6966 2077 6520 6f75 7470 7574 2061  s if we output a
+00007bf0: 7474 656e 7469 6f6e 2077 6569 6768 7473  ttention weights
+00007c00: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+00007c10: 6164 6420 6372 6f73 732d 6174 746e 2063  add cross-attn c
+00007c20: 6163 6865 2074 6f20 706f 7369 7469 6f6e  ache to position
+00007c30: 7320 332c 3420 6f66 2070 7265 7365 6e74  s 3,4 of present
+00007c40: 5f6b 6579 5f76 616c 7565 2074 7570 6c65  _key_value tuple
+00007c50: 0a20 2020 2020 2020 2020 2020 2063 726f  .            cro
+00007c60: 7373 5f61 7474 6e5f 7072 6573 656e 745f  ss_attn_present_
+00007c70: 6b65 795f 7661 6c75 6520 3d20 6372 6f73  key_value = cros
+00007c80: 735f 6174 7465 6e74 696f 6e5f 6f75 7470  s_attention_outp
+00007c90: 7574 735b 2d31 5d0a 2020 2020 2020 2020  uts[-1].        
+00007ca0: 2020 2020 7072 6573 656e 745f 6b65 795f      present_key_
+00007cb0: 7661 6c75 6520 3d20 7072 6573 656e 745f  value = present_
+00007cc0: 6b65 795f 7661 6c75 6520 2b20 6372 6f73  key_value + cros
+00007cd0: 735f 6174 746e 5f70 7265 7365 6e74 5f6b  s_attn_present_k
+00007ce0: 6579 5f76 616c 7565 0a0a 2020 2020 2020  ey_value..      
+00007cf0: 2020 6c61 7965 725f 6f75 7470 7574 203d    layer_output =
+00007d00: 2061 7070 6c79 5f63 6875 6e6b 696e 675f   apply_chunking_
+00007d10: 746f 5f66 6f72 7761 7264 280a 2020 2020  to_forward(.    
+00007d20: 2020 2020 2020 2020 7365 6c66 2e66 6565          self.fee
+00007d30: 645f 666f 7277 6172 645f 6368 756e 6b2c  d_forward_chunk,
+00007d40: 2073 656c 662e 6368 756e 6b5f 7369 7a65   self.chunk_size
+00007d50: 5f66 6565 645f 666f 7277 6172 642c 2073  _feed_forward, s
+00007d60: 656c 662e 7365 715f 6c65 6e5f 6469 6d2c  elf.seq_len_dim,
+00007d70: 2061 7474 656e 7469 6f6e 5f6f 7574 7075   attention_outpu
+00007d80: 740a 2020 2020 2020 2020 290a 2020 2020  t.        ).    
+00007d90: 2020 2020 6f75 7470 7574 7320 3d20 286c      outputs = (l
+00007da0: 6179 6572 5f6f 7574 7075 742c 2920 2b20  ayer_output,) + 
+00007db0: 6f75 7470 7574 730a 0a20 2020 2020 2020  outputs..       
+00007dc0: 2023 2069 6620 6465 636f 6465 722c 2072   # if decoder, r
+00007dd0: 6574 7572 6e20 7468 6520 6174 746e 206b  eturn the attn k
+00007de0: 6579 2f76 616c 7565 7320 6173 2074 6865  ey/values as the
+00007df0: 206c 6173 7420 6f75 7470 7574 0a20 2020   last output.   
+00007e00: 2020 2020 2069 6620 7365 6c66 2e69 735f       if self.is_
+00007e10: 6465 636f 6465 723a 0a20 2020 2020 2020  decoder:.       
+00007e20: 2020 2020 206f 7574 7075 7473 203d 206f       outputs = o
+00007e30: 7574 7075 7473 202b 2028 7072 6573 656e  utputs + (presen
+00007e40: 745f 6b65 795f 7661 6c75 652c 290a 0a20  t_key_value,).. 
+00007e50: 2020 2020 2020 2072 6574 7572 6e20 6f75         return ou
+00007e60: 7470 7574 730a 0a20 2020 2064 6566 2066  tputs..    def f
+00007e70: 6565 645f 666f 7277 6172 645f 6368 756e  eed_forward_chun
+00007e80: 6b28 7365 6c66 2c20 6174 7465 6e74 696f  k(self, attentio
+00007e90: 6e5f 6f75 7470 7574 293a 0a20 2020 2020  n_output):.     
+00007ea0: 2020 2069 6e74 6572 6d65 6469 6174 655f     intermediate_
+00007eb0: 6f75 7470 7574 203d 2073 656c 662e 696e  output = self.in
+00007ec0: 7465 726d 6564 6961 7465 2861 7474 656e  termediate(atten
+00007ed0: 7469 6f6e 5f6f 7574 7075 7429 0a20 2020  tion_output).   
+00007ee0: 2020 2020 206c 6179 6572 5f6f 7574 7075       layer_outpu
+00007ef0: 7420 3d20 7365 6c66 2e6f 7574 7075 7428  t = self.output(
+00007f00: 696e 7465 726d 6564 6961 7465 5f6f 7574  intermediate_out
+00007f10: 7075 742c 2061 7474 656e 7469 6f6e 5f6f  put, attention_o
+00007f20: 7574 7075 7429 0a20 2020 2020 2020 2072  utput).        r
+00007f30: 6574 7572 6e20 6c61 7965 725f 6f75 7470  eturn layer_outp
+00007f40: 7574 0a0a 0a23 2043 6f70 6965 6420 6672  ut...# Copied fr
+00007f50: 6f6d 2074 7261 6e73 666f 726d 6572 732e  om transformers.
+00007f60: 6d6f 6465 6c73 2e72 6f62 6572 7461 2e6d  models.roberta.m
+00007f70: 6f64 656c 696e 675f 726f 6265 7274 612e  odeling_roberta.
+00007f80: 526f 6265 7274 6145 6e63 6f64 6572 2077  RobertaEncoder w
+00007f90: 6974 6820 526f 6265 7274 612d 3e42 7269  ith Roberta->Bri
+00007fa0: 6467 6554 6f77 6572 5465 7874 0a63 6c61  dgeTowerText.cla
+00007fb0: 7373 2042 7269 6467 6554 6f77 6572 5465  ss BridgeTowerTe
+00007fc0: 7874 456e 636f 6465 7228 6e6e 2e43 656c  xtEncoder(nn.Cel
+00007fd0: 6c29 3a0a 2020 2020 6465 6620 5f5f 696e  l):.    def __in
+00007fe0: 6974 5f5f 2873 656c 662c 2063 6f6e 6669  it__(self, confi
+00007ff0: 6729 3a0a 2020 2020 2020 2020 7375 7065  g):.        supe
+00008000: 7228 292e 5f5f 696e 6974 5f5f 2829 0a20  r().__init__(). 
+00008010: 2020 2020 2020 2073 656c 662e 636f 6e66         self.conf
+00008020: 6967 203d 2063 6f6e 6669 670a 2020 2020  ig = config.    
+00008030: 2020 2020 7365 6c66 2e6c 6179 6572 203d      self.layer =
+00008040: 206e 6e2e 4365 6c6c 4c69 7374 285b 4272   nn.CellList([Br
+00008050: 6964 6765 546f 7765 7254 6578 744c 6179  idgeTowerTextLay
+00008060: 6572 2863 6f6e 6669 6729 2066 6f72 205f  er(config) for _
+00008070: 2069 6e20 7261 6e67 6528 636f 6e66 6967   in range(config
+00008080: 2e6e 756d 5f68 6964 6465 6e5f 6c61 7965  .num_hidden_laye
+00008090: 7273 295d 290a 2020 2020 2020 2020 7365  rs)]).        se
+000080a0: 6c66 2e67 7261 6469 656e 745f 6368 6563  lf.gradient_chec
+000080b0: 6b70 6f69 6e74 696e 6720 3d20 4661 6c73  kpointing = Fals
+000080c0: 650a 0a20 2020 2064 6566 2063 6f6e 7374  e..    def const
+000080d0: 7275 6374 280a 2020 2020 2020 2020 7365  ruct(.        se
+000080e0: 6c66 2c0a 2020 2020 2020 2020 6869 6464  lf,.        hidd
+000080f0: 656e 5f73 7461 7465 733a 206d 696e 6473  en_states: minds
+00008100: 706f 7265 2e54 656e 736f 722c 0a20 2020  pore.Tensor,.   
+00008110: 2020 2020 2061 7474 656e 7469 6f6e 5f6d       attention_m
+00008120: 6173 6b3a 204f 7074 696f 6e61 6c5b 6d69  ask: Optional[mi
+00008130: 6e64 7370 6f72 652e 5465 6e73 6f72 5d20  ndspore.Tensor] 
+00008140: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00008150: 6865 6164 5f6d 6173 6b3a 204f 7074 696f  head_mask: Optio
+00008160: 6e61 6c5b 6d69 6e64 7370 6f72 652e 5465  nal[mindspore.Te
+00008170: 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a 2020  nsor] = None,.  
+00008180: 2020 2020 2020 656e 636f 6465 725f 6869        encoder_hi
+00008190: 6464 656e 5f73 7461 7465 733a 204f 7074  dden_states: Opt
+000081a0: 696f 6e61 6c5b 6d69 6e64 7370 6f72 652e  ional[mindspore.
+000081b0: 5465 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a  Tensor] = None,.
+000081c0: 2020 2020 2020 2020 656e 636f 6465 725f          encoder_
+000081d0: 6174 7465 6e74 696f 6e5f 6d61 736b 3a20  attention_mask: 
+000081e0: 4f70 7469 6f6e 616c 5b6d 696e 6473 706f  Optional[mindspo
+000081f0: 7265 2e54 656e 736f 725d 203d 204e 6f6e  re.Tensor] = Non
+00008200: 652c 0a20 2020 2020 2020 2070 6173 745f  e,.        past_
+00008210: 6b65 795f 7661 6c75 6573 3a20 4f70 7469  key_values: Opti
+00008220: 6f6e 616c 5b54 7570 6c65 5b54 7570 6c65  onal[Tuple[Tuple
+00008230: 5b6d 696e 6473 706f 7265 2e54 656e 736f  [mindspore.Tenso
+00008240: 725d 5d5d 203d 204e 6f6e 652c 0a20 2020  r]]] = None,.   
+00008250: 2020 2020 2075 7365 5f63 6163 6865 3a20       use_cache: 
+00008260: 4f70 7469 6f6e 616c 5b62 6f6f 6c5d 203d  Optional[bool] =
+00008270: 204e 6f6e 652c 0a20 2020 2020 2020 206f   None,.        o
+00008280: 7574 7075 745f 6174 7465 6e74 696f 6e73  utput_attentions
+00008290: 3a20 4f70 7469 6f6e 616c 5b62 6f6f 6c5d  : Optional[bool]
+000082a0: 203d 2046 616c 7365 2c0a 2020 2020 2020   = False,.      
+000082b0: 2020 6f75 7470 7574 5f68 6964 6465 6e5f    output_hidden_
+000082c0: 7374 6174 6573 3a20 4f70 7469 6f6e 616c  states: Optional
+000082d0: 5b62 6f6f 6c5d 203d 2046 616c 7365 2c0a  [bool] = False,.
+000082e0: 2020 2020 2020 2020 7265 7475 726e 5f64          return_d
+000082f0: 6963 743a 204f 7074 696f 6e61 6c5b 626f  ict: Optional[bo
+00008300: 6f6c 5d20 3d20 5472 7565 2c0a 2020 2020  ol] = True,.    
+00008310: 2920 2d3e 2055 6e69 6f6e 5b54 7570 6c65  ) -> Union[Tuple
+00008320: 5b6d 696e 6473 706f 7265 2e54 656e 736f  [mindspore.Tenso
+00008330: 725d 2c20 4261 7365 4d6f 6465 6c4f 7574  r], BaseModelOut
+00008340: 7075 7457 6974 6850 6173 7441 6e64 4372  putWithPastAndCr
+00008350: 6f73 7341 7474 656e 7469 6f6e 735d 3a0a  ossAttentions]:.
+00008360: 2020 2020 2020 2020 616c 6c5f 6869 6464          all_hidd
+00008370: 656e 5f73 7461 7465 7320 3d20 2829 2069  en_states = () i
+00008380: 6620 6f75 7470 7574 5f68 6964 6465 6e5f  f output_hidden_
+00008390: 7374 6174 6573 2065 6c73 6520 4e6f 6e65  states else None
+000083a0: 0a20 2020 2020 2020 2061 6c6c 5f73 656c  .        all_sel
+000083b0: 665f 6174 7465 6e74 696f 6e73 203d 2028  f_attentions = (
+000083c0: 2920 6966 206f 7574 7075 745f 6174 7465  ) if output_atte
+000083d0: 6e74 696f 6e73 2065 6c73 6520 4e6f 6e65  ntions else None
+000083e0: 0a20 2020 2020 2020 2061 6c6c 5f63 726f  .        all_cro
+000083f0: 7373 5f61 7474 656e 7469 6f6e 7320 3d20  ss_attentions = 
+00008400: 2829 2069 6620 6f75 7470 7574 5f61 7474  () if output_att
+00008410: 656e 7469 6f6e 7320 616e 6420 7365 6c66  entions and self
+00008420: 2e63 6f6e 6669 672e 6164 645f 6372 6f73  .config.add_cros
+00008430: 735f 6174 7465 6e74 696f 6e20 656c 7365  s_attention else
+00008440: 204e 6f6e 650a 0a20 2020 2020 2020 2069   None..        i
+00008450: 6620 7365 6c66 2e67 7261 6469 656e 745f  f self.gradient_
+00008460: 6368 6563 6b70 6f69 6e74 696e 6720 616e  checkpointing an
+00008470: 6420 7365 6c66 2e74 7261 696e 696e 673a  d self.training:
+00008480: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00008490: 7573 655f 6361 6368 653a 0a20 2020 2020  use_cache:.     
+000084a0: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+000084b0: 722e 7761 726e 696e 675f 6f6e 6365 280a  r.warning_once(.
+000084c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000084d0: 2020 2020 2260 7573 655f 6361 6368 653d      "`use_cache=
+000084e0: 5472 7565 6020 6973 2069 6e63 6f6d 7061  True` is incompa
+000084f0: 7469 626c 6520 7769 7468 2067 7261 6469  tible with gradi
+00008500: 656e 7420 6368 6563 6b70 6f69 6e74 696e  ent checkpointin
+00008510: 672e 2053 6574 7469 6e67 2060 7573 655f  g. Setting `use_
+00008520: 6361 6368 653d 4661 6c73 6560 2e2e 2e22  cache=False`..."
+00008530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008540: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00008550: 2020 2075 7365 5f63 6163 6865 203d 2046     use_cache = F
+00008560: 616c 7365 0a0a 2020 2020 2020 2020 6e65  alse..        ne
+00008570: 7874 5f64 6563 6f64 6572 5f63 6163 6865  xt_decoder_cache
+00008580: 203d 2028 2920 6966 2075 7365 5f63 6163   = () if use_cac
+00008590: 6865 2065 6c73 6520 4e6f 6e65 0a20 2020  he else None.   
+000085a0: 2020 2020 2066 6f72 2069 2c20 6c61 7965       for i, laye
+000085b0: 725f 6d6f 6475 6c65 2069 6e20 656e 756d  r_module in enum
+000085c0: 6572 6174 6528 7365 6c66 2e6c 6179 6572  erate(self.layer
+000085d0: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
+000085e0: 6620 6f75 7470 7574 5f68 6964 6465 6e5f  f output_hidden_
+000085f0: 7374 6174 6573 3a0a 2020 2020 2020 2020  states:.        
+00008600: 2020 2020 2020 2020 616c 6c5f 6869 6464          all_hidd
+00008610: 656e 5f73 7461 7465 7320 3d20 616c 6c5f  en_states = all_
+00008620: 6869 6464 656e 5f73 7461 7465 7320 2b20  hidden_states + 
+00008630: 2868 6964 6465 6e5f 7374 6174 6573 2c29  (hidden_states,)
+00008640: 0a0a 2020 2020 2020 2020 2020 2020 6c61  ..            la
+00008650: 7965 725f 6865 6164 5f6d 6173 6b20 3d20  yer_head_mask = 
+00008660: 6865 6164 5f6d 6173 6b5b 695d 2069 6620  head_mask[i] if 
+00008670: 6865 6164 5f6d 6173 6b20 6973 206e 6f74  head_mask is not
+00008680: 204e 6f6e 6520 656c 7365 204e 6f6e 650a   None else None.
+00008690: 2020 2020 2020 2020 2020 2020 7061 7374              past
+000086a0: 5f6b 6579 5f76 616c 7565 203d 2070 6173  _key_value = pas
+000086b0: 745f 6b65 795f 7661 6c75 6573 5b69 5d20  t_key_values[i] 
+000086c0: 6966 2070 6173 745f 6b65 795f 7661 6c75  if past_key_valu
+000086d0: 6573 2069 7320 6e6f 7420 4e6f 6e65 2065  es is not None e
+000086e0: 6c73 6520 4e6f 6e65 0a0a 2020 2020 2020  lse None..      
+000086f0: 2020 2020 2020 6966 2073 656c 662e 6772        if self.gr
+00008700: 6164 6965 6e74 5f63 6865 636b 706f 696e  adient_checkpoin
+00008710: 7469 6e67 2061 6e64 2073 656c 662e 7472  ting and self.tr
+00008720: 6169 6e69 6e67 3a0a 2020 2020 2020 2020  aining:.        
+00008730: 2020 2020 2020 2020 6c61 7965 725f 6f75          layer_ou
+00008740: 7470 7574 7320 3d20 7365 6c66 2e5f 6772  tputs = self._gr
+00008750: 6164 6965 6e74 5f63 6865 636b 706f 696e  adient_checkpoin
+00008760: 7469 6e67 5f66 756e 6328 0a20 2020 2020  ting_func(.     
+00008770: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00008780: 6179 6572 5f6d 6f64 756c 652e 5f5f 6361  ayer_module.__ca
+00008790: 6c6c 5f5f 2c0a 2020 2020 2020 2020 2020  ll__,.          
+000087a0: 2020 2020 2020 2020 2020 6869 6464 656e            hidden
+000087b0: 5f73 7461 7465 732c 0a20 2020 2020 2020  _states,.       
+000087c0: 2020 2020 2020 2020 2020 2020 2061 7474               att
+000087d0: 656e 7469 6f6e 5f6d 6173 6b2c 0a20 2020  ention_mask,.   
+000087e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000087f0: 206c 6179 6572 5f68 6561 645f 6d61 736b   layer_head_mask
+00008800: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00008810: 2020 2020 2020 656e 636f 6465 725f 6869        encoder_hi
+00008820: 6464 656e 5f73 7461 7465 732c 0a20 2020  dden_states,.   
+00008830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008840: 2065 6e63 6f64 6572 5f61 7474 656e 7469   encoder_attenti
+00008850: 6f6e 5f6d 6173 6b2c 0a20 2020 2020 2020  on_mask,.       
+00008860: 2020 2020 2020 2020 2020 2020 2070 6173               pas
+00008870: 745f 6b65 795f 7661 6c75 652c 0a20 2020  t_key_value,.   
+00008880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008890: 206f 7574 7075 745f 6174 7465 6e74 696f   output_attentio
+000088a0: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
+000088b0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+000088c0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000088d0: 2020 2020 2020 2020 6c61 7965 725f 6f75          layer_ou
+000088e0: 7470 7574 7320 3d20 6c61 7965 725f 6d6f  tputs = layer_mo
+000088f0: 6475 6c65 280a 2020 2020 2020 2020 2020  dule(.          
+00008900: 2020 2020 2020 2020 2020 6869 6464 656e            hidden
+00008910: 5f73 7461 7465 732c 0a20 2020 2020 2020  _states,.       
+00008920: 2020 2020 2020 2020 2020 2020 2061 7474               att
+00008930: 656e 7469 6f6e 5f6d 6173 6b2c 0a20 2020  ention_mask,.   
+00008940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008950: 206c 6179 6572 5f68 6561 645f 6d61 736b   layer_head_mask
+00008960: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00008970: 2020 2020 2020 656e 636f 6465 725f 6869        encoder_hi
+00008980: 6464 656e 5f73 7461 7465 732c 0a20 2020  dden_states,.   
+00008990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000089a0: 2065 6e63 6f64 6572 5f61 7474 656e 7469   encoder_attenti
+000089b0: 6f6e 5f6d 6173 6b2c 0a20 2020 2020 2020  on_mask,.       
+000089c0: 2020 2020 2020 2020 2020 2020 2070 6173               pas
+000089d0: 745f 6b65 795f 7661 6c75 652c 0a20 2020  t_key_value,.   
+000089e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000089f0: 206f 7574 7075 745f 6174 7465 6e74 696f   output_attentio
+00008a00: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
+00008a10: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+00008a20: 2020 2068 6964 6465 6e5f 7374 6174 6573     hidden_states
+00008a30: 203d 206c 6179 6572 5f6f 7574 7075 7473   = layer_outputs
+00008a40: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
+00008a50: 6966 2075 7365 5f63 6163 6865 3a0a 2020  if use_cache:.  
+00008a60: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
+00008a70: 7874 5f64 6563 6f64 6572 5f63 6163 6865  xt_decoder_cache
+00008a80: 202b 3d20 286c 6179 6572 5f6f 7574 7075   += (layer_outpu
+00008a90: 7473 5b2d 315d 2c29 0a20 2020 2020 2020  ts[-1],).       
+00008aa0: 2020 2020 2069 6620 6f75 7470 7574 5f61       if output_a
+00008ab0: 7474 656e 7469 6f6e 733a 0a20 2020 2020  ttentions:.     
+00008ac0: 2020 2020 2020 2020 2020 2061 6c6c 5f73             all_s
+00008ad0: 656c 665f 6174 7465 6e74 696f 6e73 203d  elf_attentions =
+00008ae0: 2061 6c6c 5f73 656c 665f 6174 7465 6e74   all_self_attent
+00008af0: 696f 6e73 202b 2028 6c61 7965 725f 6f75  ions + (layer_ou
+00008b00: 7470 7574 735b 315d 2c29 0a20 2020 2020  tputs[1],).     
+00008b10: 2020 2020 2020 2020 2020 2069 6620 7365             if se
+00008b20: 6c66 2e63 6f6e 6669 672e 6164 645f 6372  lf.config.add_cr
+00008b30: 6f73 735f 6174 7465 6e74 696f 6e3a 0a20  oss_attention:. 
+00008b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008b50: 2020 2061 6c6c 5f63 726f 7373 5f61 7474     all_cross_att
+00008b60: 656e 7469 6f6e 7320 3d20 616c 6c5f 6372  entions = all_cr
+00008b70: 6f73 735f 6174 7465 6e74 696f 6e73 202b  oss_attentions +
+00008b80: 2028 6c61 7965 725f 6f75 7470 7574 735b   (layer_outputs[
+00008b90: 325d 2c29 0a0a 2020 2020 2020 2020 6966  2],)..        if
+00008ba0: 206f 7574 7075 745f 6869 6464 656e 5f73   output_hidden_s
+00008bb0: 7461 7465 733a 0a20 2020 2020 2020 2020  tates:.         
+00008bc0: 2020 2061 6c6c 5f68 6964 6465 6e5f 7374     all_hidden_st
+00008bd0: 6174 6573 203d 2061 6c6c 5f68 6964 6465  ates = all_hidde
+00008be0: 6e5f 7374 6174 6573 202b 2028 6869 6464  n_states + (hidd
+00008bf0: 656e 5f73 7461 7465 732c 290a 0a20 2020  en_states,)..   
+00008c00: 2020 2020 2069 6620 6e6f 7420 7265 7475       if not retu
+00008c10: 726e 5f64 6963 743a 0a20 2020 2020 2020  rn_dict:.       
+00008c20: 2020 2020 2072 6574 7572 6e20 7475 706c       return tupl
+00008c30: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+00008c40: 2020 2076 0a20 2020 2020 2020 2020 2020     v.           
+00008c50: 2020 2020 2066 6f72 2076 2069 6e20 5b0a       for v in [.
+00008c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008c70: 2020 2020 6869 6464 656e 5f73 7461 7465      hidden_state
+00008c80: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+00008c90: 2020 2020 2020 206e 6578 745f 6465 636f         next_deco
+00008ca0: 6465 725f 6361 6368 652c 0a20 2020 2020  der_cache,.     
+00008cb0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00008cc0: 6c6c 5f68 6964 6465 6e5f 7374 6174 6573  ll_hidden_states
+00008cd0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00008ce0: 2020 2020 2020 616c 6c5f 7365 6c66 5f61        all_self_a
+00008cf0: 7474 656e 7469 6f6e 732c 0a20 2020 2020  ttentions,.     
+00008d00: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00008d10: 6c6c 5f63 726f 7373 5f61 7474 656e 7469  ll_cross_attenti
+00008d20: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
+00008d30: 2020 2020 205d 0a20 2020 2020 2020 2020       ].         
+00008d40: 2020 2020 2020 2069 6620 7620 6973 206e         if v is n
+00008d50: 6f74 204e 6f6e 650a 2020 2020 2020 2020  ot None.        
+00008d60: 2020 2020 290a 2020 2020 2020 2020 7265      ).        re
+00008d70: 7475 726e 2042 6173 654d 6f64 656c 4f75  turn BaseModelOu
+00008d80: 7470 7574 5769 7468 5061 7374 416e 6443  tputWithPastAndC
+00008d90: 726f 7373 4174 7465 6e74 696f 6e73 280a  rossAttentions(.
+00008da0: 2020 2020 2020 2020 2020 2020 6c61 7374              last
+00008db0: 5f68 6964 6465 6e5f 7374 6174 653d 6869  _hidden_state=hi
+00008dc0: 6464 656e 5f73 7461 7465 732c 0a20 2020  dden_states,.   
+00008dd0: 2020 2020 2020 2020 2070 6173 745f 6b65           past_ke
+00008de0: 795f 7661 6c75 6573 3d6e 6578 745f 6465  y_values=next_de
+00008df0: 636f 6465 725f 6361 6368 652c 0a20 2020  coder_cache,.   
+00008e00: 2020 2020 2020 2020 2068 6964 6465 6e5f           hidden_
+00008e10: 7374 6174 6573 3d61 6c6c 5f68 6964 6465  states=all_hidde
+00008e20: 6e5f 7374 6174 6573 2c0a 2020 2020 2020  n_states,.      
+00008e30: 2020 2020 2020 6174 7465 6e74 696f 6e73        attentions
+00008e40: 3d61 6c6c 5f73 656c 665f 6174 7465 6e74  =all_self_attent
+00008e50: 696f 6e73 2c0a 2020 2020 2020 2020 2020  ions,.          
+00008e60: 2020 6372 6f73 735f 6174 7465 6e74 696f    cross_attentio
+00008e70: 6e73 3d61 6c6c 5f63 726f 7373 5f61 7474  ns=all_cross_att
+00008e80: 656e 7469 6f6e 732c 0a20 2020 2020 2020  entions,.       
+00008e90: 2029 0a0a 0a23 2043 6f70 6965 6420 6672   )...# Copied fr
+00008ea0: 6f6d 2074 7261 6e73 666f 726d 6572 732e  om transformers.
+00008eb0: 6d6f 6465 6c73 2e72 6f62 6572 7461 2e6d  models.roberta.m
+00008ec0: 6f64 656c 696e 675f 726f 6265 7274 612e  odeling_roberta.
+00008ed0: 526f 6265 7274 6145 6d62 6564 6469 6e67  RobertaEmbedding
+00008ee0: 7320 7769 7468 2052 6f62 6572 7461 2d3e  s with Roberta->
+00008ef0: 4272 6964 6765 546f 7765 7254 6578 740a  BridgeTowerText.
+00008f00: 636c 6173 7320 4272 6964 6765 546f 7765  class BridgeTowe
+00008f10: 7254 6578 7445 6d62 6564 6469 6e67 7328  rTextEmbeddings(
+00008f20: 6e6e 2e43 656c 6c29 3a0a 2020 2020 2222  nn.Cell):.    ""
+00008f30: 220a 2020 2020 5361 6d65 2061 7320 4265  ".    Same as Be
+00008f40: 7274 456d 6265 6464 696e 6773 2077 6974  rtEmbeddings wit
+00008f50: 6820 6120 7469 6e79 2074 7765 616b 2066  h a tiny tweak f
+00008f60: 6f72 2070 6f73 6974 696f 6e61 6c20 656d  or positional em
+00008f70: 6265 6464 696e 6773 2069 6e64 6578 696e  beddings indexin
+00008f80: 672e 0a20 2020 2022 2222 0a0a 2020 2020  g..    """..    
+00008f90: 2320 436f 7069 6564 2066 726f 6d20 7472  # Copied from tr
+00008fa0: 616e 7366 6f72 6d65 7273 2e6d 6f64 656c  ansformers.model
+00008fb0: 732e 6265 7274 2e6d 6f64 656c 696e 675f  s.bert.modeling_
+00008fc0: 6265 7274 2e42 6572 7445 6d62 6564 6469  bert.BertEmbeddi
+00008fd0: 6e67 732e 5f5f 696e 6974 5f5f 0a20 2020  ngs.__init__.   
+00008fe0: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
+00008ff0: 6c66 2c20 636f 6e66 6967 293a 0a20 2020  lf, config):.   
+00009000: 2020 2020 2073 7570 6572 2829 2e5f 5f69       super().__i
+00009010: 6e69 745f 5f28 290a 2020 2020 2020 2020  nit__().        
+00009020: 7365 6c66 2e77 6f72 645f 656d 6265 6464  self.word_embedd
+00009030: 696e 6773 203d 206e 6e2e 456d 6265 6464  ings = nn.Embedd
+00009040: 696e 6728 636f 6e66 6967 2e76 6f63 6162  ing(config.vocab
+00009050: 5f73 697a 652c 2063 6f6e 6669 672e 6869  _size, config.hi
+00009060: 6464 656e 5f73 697a 652c 2070 6164 6469  dden_size, paddi
+00009070: 6e67 5f69 6478 3d63 6f6e 6669 672e 7061  ng_idx=config.pa
+00009080: 645f 746f 6b65 6e5f 6964 290a 2020 2020  d_token_id).    
+00009090: 2020 2020 7365 6c66 2e70 6f73 6974 696f      self.positio
+000090a0: 6e5f 656d 6265 6464 696e 6773 203d 206e  n_embeddings = n
+000090b0: 6e2e 456d 6265 6464 696e 6728 636f 6e66  n.Embedding(conf
+000090c0: 6967 2e6d 6178 5f70 6f73 6974 696f 6e5f  ig.max_position_
+000090d0: 656d 6265 6464 696e 6773 2c20 636f 6e66  embeddings, conf
+000090e0: 6967 2e68 6964 6465 6e5f 7369 7a65 290a  ig.hidden_size).
+000090f0: 2020 2020 2020 2020 7365 6c66 2e74 6f6b          self.tok
+00009100: 656e 5f74 7970 655f 656d 6265 6464 696e  en_type_embeddin
+00009110: 6773 203d 206e 6e2e 456d 6265 6464 696e  gs = nn.Embeddin
+00009120: 6728 636f 6e66 6967 2e74 7970 655f 766f  g(config.type_vo
+00009130: 6361 625f 7369 7a65 2c20 636f 6e66 6967  cab_size, config
+00009140: 2e68 6964 6465 6e5f 7369 7a65 290a 0a20  .hidden_size).. 
+00009150: 2020 2020 2020 2023 2073 656c 662e 4c61         # self.La
+00009160: 7965 724e 6f72 6d20 6973 206e 6f74 2073  yerNorm is not s
+00009170: 6e61 6b65 2d63 6173 6564 2074 6f20 7374  nake-cased to st
+00009180: 6963 6b20 7769 7468 2054 656e 736f 7246  ick with TensorF
+00009190: 6c6f 7720 6d6f 6465 6c20 7661 7269 6162  low model variab
+000091a0: 6c65 206e 616d 6520 616e 6420 6265 2061  le name and be a
+000091b0: 626c 6520 746f 206c 6f61 640a 2020 2020  ble to load.    
+000091c0: 2020 2020 2320 616e 7920 5465 6e73 6f72      # any Tensor
+000091d0: 466c 6f77 2063 6865 636b 706f 696e 7420  Flow checkpoint 
+000091e0: 6669 6c65 0a20 2020 2020 2020 2073 656c  file.        sel
+000091f0: 662e 4c61 7965 724e 6f72 6d20 3d20 6e6e  f.LayerNorm = nn
+00009200: 2e4c 6179 6572 4e6f 726d 2863 6f6e 6669  .LayerNorm(confi
+00009210: 672e 6869 6464 656e 5f73 697a 652c 2065  g.hidden_size, e
+00009220: 7073 696c 6f6e 3d63 6f6e 6669 672e 6c61  psilon=config.la
+00009230: 7965 725f 6e6f 726d 5f65 7073 290a 2020  yer_norm_eps).  
+00009240: 2020 2020 2020 7365 6c66 2e64 726f 706f        self.dropo
+00009250: 7574 203d 206e 6e2e 4472 6f70 6f75 7428  ut = nn.Dropout(
+00009260: 703d 636f 6e66 6967 2e68 6964 6465 6e5f  p=config.hidden_
+00009270: 6472 6f70 6f75 745f 7072 6f62 290a 2020  dropout_prob).  
+00009280: 2020 2020 2020 2320 706f 7369 7469 6f6e        # position
+00009290: 5f69 6473 2028 312c 206c 656e 2070 6f73  _ids (1, len pos
+000092a0: 6974 696f 6e20 656d 6229 2069 7320 636f  ition emb) is co
+000092b0: 6e74 6967 756f 7573 2069 6e20 6d65 6d6f  ntiguous in memo
+000092c0: 7279 2061 6e64 2065 7870 6f72 7465 6420  ry and exported 
+000092d0: 7768 656e 2073 6572 6961 6c69 7a65 640a  when serialized.
+000092e0: 2020 2020 2020 2020 7365 6c66 2e70 6f73          self.pos
+000092f0: 6974 696f 6e5f 656d 6265 6464 696e 675f  ition_embedding_
+00009300: 7479 7065 203d 2067 6574 6174 7472 2863  type = getattr(c
+00009310: 6f6e 6669 672c 2022 706f 7369 7469 6f6e  onfig, "position
+00009320: 5f65 6d62 6564 6469 6e67 5f74 7970 6522  _embedding_type"
+00009330: 2c20 2261 6273 6f6c 7574 6522 290a 2020  , "absolute").  
+00009340: 2020 2020 2020 7365 6c66 2e70 6f73 6974        self.posit
+00009350: 696f 6e5f 6964 7320 3d20 6f70 732e 6172  ion_ids = ops.ar
+00009360: 616e 6765 2863 6f6e 6669 672e 6d61 785f  ange(config.max_
+00009370: 706f 7369 7469 6f6e 5f65 6d62 6564 6469  position_embeddi
+00009380: 6e67 7329 2e65 7870 616e 6428 2831 2c20  ngs).expand((1, 
+00009390: 2d31 2929 0a20 2020 2020 2020 2073 656c  -1)).        sel
+000093a0: 662e 746f 6b65 6e5f 7479 7065 5f69 6473  f.token_type_ids
+000093b0: 203d 206f 7073 2e7a 6572 6f73 2873 656c   = ops.zeros(sel
+000093c0: 662e 706f 7369 7469 6f6e 5f69 6473 2e73  f.position_ids.s
+000093d0: 6861 7065 2c20 6474 7970 653d 6d69 6e64  hape, dtype=mind
+000093e0: 7370 6f72 652e 696e 7436 3429 0a0a 2020  spore.int64)..  
+000093f0: 2020 2020 2020 2320 456e 6420 636f 7079        # End copy
+00009400: 0a20 2020 2020 2020 2073 656c 662e 7061  .        self.pa
+00009410: 6464 696e 675f 6964 7820 3d20 636f 6e66  dding_idx = conf
+00009420: 6967 2e70 6164 5f74 6f6b 656e 5f69 640a  ig.pad_token_id.
+00009430: 2020 2020 2020 2020 7365 6c66 2e70 6f73          self.pos
+00009440: 6974 696f 6e5f 656d 6265 6464 696e 6773  ition_embeddings
+00009450: 203d 206e 6e2e 456d 6265 6464 696e 6728   = nn.Embedding(
+00009460: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
+00009470: 6669 672e 6d61 785f 706f 7369 7469 6f6e  fig.max_position
+00009480: 5f65 6d62 6564 6469 6e67 732c 2063 6f6e  _embeddings, con
+00009490: 6669 672e 6869 6464 656e 5f73 697a 652c  fig.hidden_size,
+000094a0: 2070 6164 6469 6e67 5f69 6478 3d73 656c   padding_idx=sel
+000094b0: 662e 7061 6464 696e 675f 6964 780a 2020  f.padding_idx.  
+000094c0: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
+000094d0: 2063 6f6e 7374 7275 6374 280a 2020 2020   construct(.    
+000094e0: 2020 2020 7365 6c66 2c20 696e 7075 745f      self, input_
+000094f0: 6964 733d 4e6f 6e65 2c20 746f 6b65 6e5f  ids=None, token_
+00009500: 7479 7065 5f69 6473 3d4e 6f6e 652c 2070  type_ids=None, p
+00009510: 6f73 6974 696f 6e5f 6964 733d 4e6f 6e65  osition_ids=None
+00009520: 2c20 696e 7075 7473 5f65 6d62 6564 733d  , inputs_embeds=
+00009530: 4e6f 6e65 2c20 7061 7374 5f6b 6579 5f76  None, past_key_v
+00009540: 616c 7565 735f 6c65 6e67 7468 3d30 0a20  alues_length=0. 
+00009550: 2020 2029 3a0a 2020 2020 2020 2020 6966     ):.        if
+00009560: 2070 6f73 6974 696f 6e5f 6964 7320 6973   position_ids is
+00009570: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00009580: 2020 2069 6620 696e 7075 745f 6964 7320     if input_ids 
+00009590: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+000095a0: 2020 2020 2020 2020 2020 2020 2023 2043               # C
+000095b0: 7265 6174 6520 7468 6520 706f 7369 7469  reate the positi
+000095c0: 6f6e 2069 6473 2066 726f 6d20 7468 6520  on ids from the 
+000095d0: 696e 7075 7420 746f 6b65 6e20 6964 732e  input token ids.
+000095e0: 2041 6e79 2070 6164 6465 6420 746f 6b65   Any padded toke
+000095f0: 6e73 2072 656d 6169 6e20 7061 6464 6564  ns remain padded
+00009600: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00009610: 2020 706f 7369 7469 6f6e 5f69 6473 203d    position_ids =
+00009620: 2063 7265 6174 655f 706f 7369 7469 6f6e   create_position
+00009630: 5f69 6473 5f66 726f 6d5f 696e 7075 745f  _ids_from_input_
+00009640: 6964 7328 696e 7075 745f 6964 732c 2073  ids(input_ids, s
+00009650: 656c 662e 7061 6464 696e 675f 6964 782c  elf.padding_idx,
+00009660: 2070 6173 745f 6b65 795f 7661 6c75 6573   past_key_values
+00009670: 5f6c 656e 6774 6829 0a20 2020 2020 2020  _length).       
+00009680: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00009690: 2020 2020 2020 2020 2020 2070 6f73 6974             posit
+000096a0: 696f 6e5f 6964 7320 3d20 7365 6c66 2e63  ion_ids = self.c
+000096b0: 7265 6174 655f 706f 7369 7469 6f6e 5f69  reate_position_i
+000096c0: 6473 5f66 726f 6d5f 696e 7075 7473 5f65  ds_from_inputs_e
+000096d0: 6d62 6564 7328 696e 7075 7473 5f65 6d62  mbeds(inputs_emb
+000096e0: 6564 7329 0a0a 2020 2020 2020 2020 6966  eds)..        if
+000096f0: 2069 6e70 7574 5f69 6473 2069 7320 6e6f   input_ids is no
+00009700: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00009710: 2020 2020 696e 7075 745f 7368 6170 6520      input_shape 
+00009720: 3d20 696e 7075 745f 6964 732e 7368 6170  = input_ids.shap
+00009730: 650a 2020 2020 2020 2020 656c 7365 3a0a  e.        else:.
+00009740: 2020 2020 2020 2020 2020 2020 696e 7075              inpu
+00009750: 745f 7368 6170 6520 3d20 696e 7075 7473  t_shape = inputs
+00009760: 5f65 6d62 6564 732e 7368 6170 655b 3a2d  _embeds.shape[:-
+00009770: 315d 0a0a 2020 2020 2020 2020 7365 715f  1]..        seq_
+00009780: 6c65 6e67 7468 203d 2069 6e70 7574 5f73  length = input_s
+00009790: 6861 7065 5b31 5d0a 0a20 2020 2020 2020  hape[1]..       
+000097a0: 2023 2053 6574 7469 6e67 2074 6865 2074   # Setting the t
+000097b0: 6f6b 656e 5f74 7970 655f 6964 7320 746f  oken_type_ids to
+000097c0: 2074 6865 2072 6567 6973 7465 7265 6420   the registered 
+000097d0: 6275 6666 6572 2069 6e20 636f 6e73 7472  buffer in constr
+000097e0: 7563 746f 7220 7768 6572 6520 6974 2069  uctor where it i
+000097f0: 7320 616c 6c20 7a65 726f 732c 2077 6869  s all zeros, whi
+00009800: 6368 2075 7375 616c 6c79 206f 6363 7572  ch usually occur
+00009810: 730a 2020 2020 2020 2020 2320 7768 656e  s.        # when
+00009820: 2069 7473 2061 7574 6f2d 6765 6e65 7261   its auto-genera
+00009830: 7465 642c 2072 6567 6973 7465 7265 6420  ted, registered 
+00009840: 6275 6666 6572 2068 656c 7073 2075 7365  buffer helps use
+00009850: 7273 2077 6865 6e20 7472 6163 696e 6720  rs when tracing 
+00009860: 7468 6520 6d6f 6465 6c20 7769 7468 6f75  the model withou
+00009870: 7420 7061 7373 696e 6720 746f 6b65 6e5f  t passing token_
+00009880: 7479 7065 5f69 6473 2c20 736f 6c76 6573  type_ids, solves
+00009890: 0a20 2020 2020 2020 2023 2069 7373 7565  .        # issue
+000098a0: 2023 3536 3634 0a20 2020 2020 2020 2069   #5664.        i
+000098b0: 6620 746f 6b65 6e5f 7479 7065 5f69 6473  f token_type_ids
+000098c0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+000098d0: 2020 2020 2020 6966 2068 6173 6174 7472        if hasattr
+000098e0: 2873 656c 662c 2022 746f 6b65 6e5f 7479  (self, "token_ty
+000098f0: 7065 5f69 6473 2229 3a0a 2020 2020 2020  pe_ids"):.      
+00009900: 2020 2020 2020 2020 2020 6275 6666 6572            buffer
+00009910: 6564 5f74 6f6b 656e 5f74 7970 655f 6964  ed_token_type_id
+00009920: 7320 3d20 7365 6c66 2e74 6f6b 656e 5f74  s = self.token_t
+00009930: 7970 655f 6964 735b 3a2c 203a 7365 715f  ype_ids[:, :seq_
+00009940: 6c65 6e67 7468 5d0a 2020 2020 2020 2020  length].        
+00009950: 2020 2020 2020 2020 6275 6666 6572 6564          buffered
+00009960: 5f74 6f6b 656e 5f74 7970 655f 6964 735f  _token_type_ids_
+00009970: 6578 7061 6e64 6564 203d 2062 7566 6665  expanded = buffe
+00009980: 7265 645f 746f 6b65 6e5f 7479 7065 5f69  red_token_type_i
+00009990: 6473 2e65 7870 616e 6428 696e 7075 745f  ds.expand(input_
+000099a0: 7368 6170 655b 305d 2c20 7365 715f 6c65  shape[0], seq_le
+000099b0: 6e67 7468 290a 2020 2020 2020 2020 2020  ngth).          
+000099c0: 2020 2020 2020 746f 6b65 6e5f 7479 7065        token_type
+000099d0: 5f69 6473 203d 2062 7566 6665 7265 645f  _ids = buffered_
+000099e0: 746f 6b65 6e5f 7479 7065 5f69 6473 5f65  token_type_ids_e
+000099f0: 7870 616e 6465 640a 2020 2020 2020 2020  xpanded.        
+00009a00: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00009a10: 2020 2020 2020 2020 2020 746f 6b65 6e5f            token_
+00009a20: 7479 7065 5f69 6473 203d 206f 7073 2e7a  type_ids = ops.z
+00009a30: 6572 6f73 2869 6e70 7574 5f73 6861 7065  eros(input_shape
+00009a40: 2c20 6474 7970 653d 6d69 6e64 7370 6f72  , dtype=mindspor
+00009a50: 652e 696e 7436 3429 0a0a 2020 2020 2020  e.int64)..      
+00009a60: 2020 6966 2069 6e70 7574 735f 656d 6265    if inputs_embe
+00009a70: 6473 2069 7320 4e6f 6e65 3a0a 2020 2020  ds is None:.    
+00009a80: 2020 2020 2020 2020 696e 7075 7473 5f65          inputs_e
+00009a90: 6d62 6564 7320 3d20 7365 6c66 2e77 6f72  mbeds = self.wor
+00009aa0: 645f 656d 6265 6464 696e 6773 2869 6e70  d_embeddings(inp
+00009ab0: 7574 5f69 6473 290a 2020 2020 2020 2020  ut_ids).        
+00009ac0: 746f 6b65 6e5f 7479 7065 5f65 6d62 6564  token_type_embed
+00009ad0: 6469 6e67 7320 3d20 7365 6c66 2e74 6f6b  dings = self.tok
+00009ae0: 656e 5f74 7970 655f 656d 6265 6464 696e  en_type_embeddin
+00009af0: 6773 2874 6f6b 656e 5f74 7970 655f 6964  gs(token_type_id
+00009b00: 7329 0a0a 2020 2020 2020 2020 656d 6265  s)..        embe
+00009b10: 6464 696e 6773 203d 2069 6e70 7574 735f  ddings = inputs_
+00009b20: 656d 6265 6473 202b 2074 6f6b 656e 5f74  embeds + token_t
+00009b30: 7970 655f 656d 6265 6464 696e 6773 0a20  ype_embeddings. 
+00009b40: 2020 2020 2020 2069 6620 7365 6c66 2e70         if self.p
+00009b50: 6f73 6974 696f 6e5f 656d 6265 6464 696e  osition_embeddin
+00009b60: 675f 7479 7065 203d 3d20 2261 6273 6f6c  g_type == "absol
+00009b70: 7574 6522 3a0a 2020 2020 2020 2020 2020  ute":.          
+00009b80: 2020 706f 7369 7469 6f6e 5f65 6d62 6564    position_embed
+00009b90: 6469 6e67 7320 3d20 7365 6c66 2e70 6f73  dings = self.pos
+00009ba0: 6974 696f 6e5f 656d 6265 6464 696e 6773  ition_embeddings
+00009bb0: 2870 6f73 6974 696f 6e5f 6964 7329 0a20  (position_ids). 
+00009bc0: 2020 2020 2020 2020 2020 2065 6d62 6564             embed
+00009bd0: 6469 6e67 7320 2b3d 2070 6f73 6974 696f  dings += positio
+00009be0: 6e5f 656d 6265 6464 696e 6773 0a20 2020  n_embeddings.   
+00009bf0: 2020 2020 2065 6d62 6564 6469 6e67 7320       embeddings 
+00009c00: 3d20 7365 6c66 2e4c 6179 6572 4e6f 726d  = self.LayerNorm
+00009c10: 2865 6d62 6564 6469 6e67 7329 0a20 2020  (embeddings).   
+00009c20: 2020 2020 2065 6d62 6564 6469 6e67 7320       embeddings 
+00009c30: 3d20 7365 6c66 2e64 726f 706f 7574 2865  = self.dropout(e
+00009c40: 6d62 6564 6469 6e67 7329 0a20 2020 2020  mbeddings).     
+00009c50: 2020 2072 6574 7572 6e20 656d 6265 6464     return embedd
+00009c60: 696e 6773 0a0a 2020 2020 6465 6620 6372  ings..    def cr
+00009c70: 6561 7465 5f70 6f73 6974 696f 6e5f 6964  eate_position_id
+00009c80: 735f 6672 6f6d 5f69 6e70 7574 735f 656d  s_from_inputs_em
+00009c90: 6265 6473 2873 656c 662c 2069 6e70 7574  beds(self, input
+00009ca0: 735f 656d 6265 6473 293a 0a20 2020 2020  s_embeds):.     
+00009cb0: 2020 2022 2222 0a20 2020 2020 2020 2057     """.        W
+00009cc0: 6520 6172 6520 7072 6f76 6964 6564 2065  e are provided e
+00009cd0: 6d62 6564 6469 6e67 7320 6469 7265 6374  mbeddings direct
+00009ce0: 6c79 2e20 5765 2063 616e 6e6f 7420 696e  ly. We cannot in
+00009cf0: 6665 7220 7768 6963 6820 6172 6520 7061  fer which are pa
+00009d00: 6464 6564 2073 6f20 6a75 7374 2067 656e  dded so just gen
+00009d10: 6572 6174 6520 7365 7175 656e 7469 616c  erate sequential
+00009d20: 2070 6f73 6974 696f 6e20 6964 732e 0a0a   position ids...
+00009d30: 2020 2020 2020 2020 4172 6773 3a0a 2020          Args:.  
+00009d40: 2020 2020 2020 2020 2020 696e 7075 7473            inputs
+00009d50: 5f65 6d62 6564 733a 206d 696e 6473 706f  _embeds: mindspo
+00009d60: 7265 2e54 656e 736f 720a 0a20 2020 2020  re.Tensor..     
+00009d70: 2020 2052 6574 7572 6e73 3a20 6d69 6e64     Returns: mind
+00009d80: 7370 6f72 652e 5465 6e73 6f72 0a20 2020  spore.Tensor.   
+00009d90: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00009da0: 2069 6e70 7574 5f73 6861 7065 203d 2069   input_shape = i
+00009db0: 6e70 7574 735f 656d 6265 6473 2e73 6861  nputs_embeds.sha
+00009dc0: 7065 5b3a 2d31 5d0a 2020 2020 2020 2020  pe[:-1].        
+00009dd0: 7365 7175 656e 6365 5f6c 656e 6774 6820  sequence_length 
+00009de0: 3d20 696e 7075 745f 7368 6170 655b 315d  = input_shape[1]
+00009df0: 0a0a 2020 2020 2020 2020 706f 7369 7469  ..        positi
+00009e00: 6f6e 5f69 6473 203d 206f 7073 2e61 7261  on_ids = ops.ara
+00009e10: 6e67 6528 0a20 2020 2020 2020 2020 2020  nge(.           
+00009e20: 2073 656c 662e 7061 6464 696e 675f 6964   self.padding_id
+00009e30: 7820 2b20 312c 2073 6571 7565 6e63 655f  x + 1, sequence_
+00009e40: 6c65 6e67 7468 202b 2073 656c 662e 7061  length + self.pa
+00009e50: 6464 696e 675f 6964 7820 2b20 312c 2064  dding_idx + 1, d
+00009e60: 7479 7065 3d6d 696e 6473 706f 7265 2e69  type=mindspore.i
+00009e70: 6e74 3634 0a20 2020 2020 2020 2029 0a20  nt64.        ). 
+00009e80: 2020 2020 2020 2072 6574 7572 6e20 706f         return po
+00009e90: 7369 7469 6f6e 5f69 6473 2e75 6e73 7175  sition_ids.unsqu
+00009ea0: 6565 7a65 2830 292e 6578 7061 6e64 2869  eeze(0).expand(i
+00009eb0: 6e70 7574 5f73 6861 7065 290a 0a0a 2320  nput_shape)...# 
+00009ec0: 436f 7069 6564 2066 726f 6d20 7472 616e  Copied from tran
+00009ed0: 7366 6f72 6d65 7273 2e6d 6f64 656c 732e  sformers.models.
+00009ee0: 726f 6265 7274 612e 6d6f 6465 6c69 6e67  roberta.modeling
+00009ef0: 5f72 6f62 6572 7461 2e63 7265 6174 655f  _roberta.create_
+00009f00: 706f 7369 7469 6f6e 5f69 6473 5f66 726f  position_ids_fro
+00009f10: 6d5f 696e 7075 745f 6964 730a 6465 6620  m_input_ids.def 
+00009f20: 6372 6561 7465 5f70 6f73 6974 696f 6e5f  create_position_
+00009f30: 6964 735f 6672 6f6d 5f69 6e70 7574 5f69  ids_from_input_i
+00009f40: 6473 2869 6e70 7574 5f69 6473 2c20 7061  ds(input_ids, pa
+00009f50: 6464 696e 675f 6964 782c 2070 6173 745f  dding_idx, past_
+00009f60: 6b65 795f 7661 6c75 6573 5f6c 656e 6774  key_values_lengt
+00009f70: 683d 3029 3a0a 2020 2020 2222 220a 2020  h=0):.    """.  
+00009f80: 2020 5265 706c 6163 6520 6e6f 6e2d 7061    Replace non-pa
+00009f90: 6464 696e 6720 7379 6d62 6f6c 7320 7769  dding symbols wi
+00009fa0: 7468 2074 6865 6972 2070 6f73 6974 696f  th their positio
+00009fb0: 6e20 6e75 6d62 6572 732e 2050 6f73 6974  n numbers. Posit
+00009fc0: 696f 6e20 6e75 6d62 6572 7320 6265 6769  ion numbers begi
+00009fd0: 6e20 6174 2070 6164 6469 6e67 5f69 6478  n at padding_idx
+00009fe0: 2b31 2e20 5061 6464 696e 6720 7379 6d62  +1. Padding symb
+00009ff0: 6f6c 730a 2020 2020 6172 6520 6967 6e6f  ols.    are igno
+0000a000: 7265 642e 2054 6869 7320 6973 206d 6f64  red. This is mod
+0000a010: 6966 6965 6420 6672 6f6d 2066 6169 7273  ified from fairs
+0000a020: 6571 2773 2060 7574 696c 732e 6d61 6b65  eq's `utils.make
+0000a030: 5f70 6f73 6974 696f 6e73 602e 0a0a 2020  _positions`...  
+0000a040: 2020 4172 6773 3a0a 2020 2020 2020 2020    Args:.        
+0000a050: 783a 206d 696e 6473 706f 7265 2e54 656e  x: mindspore.Ten
+0000a060: 736f 7220 783a 0a0a 2020 2020 5265 7475  sor x:..    Retu
+0000a070: 726e 733a 206d 696e 6473 706f 7265 2e54  rns: mindspore.T
+0000a080: 656e 736f 720a 2020 2020 2222 220a 2020  ensor.    """.  
+0000a090: 2020 2320 5468 6520 7365 7269 6573 206f    # The series o
+0000a0a0: 6620 6361 7374 7320 616e 6420 7479 7065  f casts and type
+0000a0b0: 2d63 6f6e 7665 7273 696f 6e73 2068 6572  -conversions her
+0000a0c0: 6520 6172 6520 6361 7265 6675 6c6c 7920  e are carefully 
+0000a0d0: 6261 6c61 6e63 6564 2074 6f20 626f 7468  balanced to both
+0000a0e0: 2077 6f72 6b20 7769 7468 204f 4e4e 5820   work with ONNX 
+0000a0f0: 6578 706f 7274 2061 6e64 2058 4c41 2e0a  export and XLA..
+0000a100: 2020 2020 6d61 736b 203d 2069 6e70 7574      mask = input
+0000a110: 5f69 6473 2e6e 6528 7061 6464 696e 675f  _ids.ne(padding_
+0000a120: 6964 7829 2e69 6e74 2829 0a20 2020 2069  idx).int().    i
+0000a130: 6e63 7265 6d65 6e74 616c 5f69 6e64 6963  ncremental_indic
+0000a140: 6573 203d 2028 6f70 732e 6375 6d73 756d  es = (ops.cumsum
+0000a150: 286d 6173 6b2c 2061 7869 733d 3129 2e74  (mask, axis=1).t
+0000a160: 7970 655f 6173 286d 6173 6b29 202b 2070  ype_as(mask) + p
+0000a170: 6173 745f 6b65 795f 7661 6c75 6573 5f6c  ast_key_values_l
+0000a180: 656e 6774 6829 202a 206d 6173 6b0a 2020  ength) * mask.  
+0000a190: 2020 7265 7475 726e 2069 6e63 7265 6d65    return increme
+0000a1a0: 6e74 616c 5f69 6e64 6963 6573 2e6c 6f6e  ntal_indices.lon
+0000a1b0: 6728 2920 2b20 7061 6464 696e 675f 6964  g() + padding_id
+0000a1c0: 780a 0a0a 636c 6173 7320 4272 6964 6765  x...class Bridge
+0000a1d0: 546f 7765 7250 7265 5472 6169 6e65 644d  TowerPreTrainedM
+0000a1e0: 6f64 656c 2850 7265 5472 6169 6e65 644d  odel(PreTrainedM
+0000a1f0: 6f64 656c 293a 0a20 2020 2022 2222 0a20  odel):.    """. 
+0000a200: 2020 2041 6e20 6162 7374 7261 6374 2063     An abstract c
+0000a210: 6c61 7373 2074 6f20 6861 6e64 6c65 2077  lass to handle w
+0000a220: 6569 6768 7473 2069 6e69 7469 616c 697a  eights initializ
+0000a230: 6174 696f 6e20 616e 6420 6120 7369 6d70  ation and a simp
+0000a240: 6c65 2069 6e74 6572 6661 6365 2066 6f72  le interface for
+0000a250: 2064 6f77 6e6c 6f61 6469 6e67 2061 6e64   downloading and
+0000a260: 206c 6f61 6469 6e67 2070 7265 7472 6169   loading pretrai
+0000a270: 6e65 640a 2020 2020 6d6f 6465 6c73 2e0a  ned.    models..
+0000a280: 2020 2020 2222 220a 0a20 2020 2063 6f6e      """..    con
+0000a290: 6669 675f 636c 6173 7320 3d20 4272 6964  fig_class = Brid
+0000a2a0: 6765 546f 7765 7243 6f6e 6669 670a 2020  geTowerConfig.  
+0000a2b0: 2020 6261 7365 5f6d 6f64 656c 5f70 7265    base_model_pre
+0000a2c0: 6669 7820 3d20 2262 7269 6467 6574 6f77  fix = "bridgetow
+0000a2d0: 6572 220a 2020 2020 7375 7070 6f72 7473  er".    supports
+0000a2e0: 5f67 7261 6469 656e 745f 6368 6563 6b70  _gradient_checkp
+0000a2f0: 6f69 6e74 696e 6720 3d20 4661 6c73 650a  ointing = False.
+0000a300: 2020 2020 5f6e 6f5f 7370 6c69 745f 6d6f      _no_split_mo
+0000a310: 6475 6c65 7320 3d20 5b22 4272 6964 6765  dules = ["Bridge
+0000a320: 546f 7765 7253 656c 6641 7474 656e 7469  TowerSelfAttenti
+0000a330: 6f6e 222c 2022 4272 6964 6765 546f 7765  on", "BridgeTowe
+0000a340: 7252 6573 6964 7561 6c41 7474 656e 7469  rResidualAttenti
+0000a350: 6f6e 225d 0a20 2020 205f 736b 6970 5f6b  on"].    _skip_k
+0000a360: 6579 735f 6465 7669 6365 5f70 6c61 6365  eys_device_place
+0000a370: 6d65 6e74 203d 2022 7061 7374 5f6b 6579  ment = "past_key
+0000a380: 5f76 616c 7565 7322 0a0a 2020 2020 6465  _values"..    de
+0000a390: 6620 5f69 6e69 745f 7765 6967 6874 7328  f _init_weights(
+0000a3a0: 7365 6c66 2c20 6365 6c6c 293a 0a20 2020  self, cell):.   
+0000a3b0: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+0000a3c0: 6365 2863 656c 6c2c 2042 7269 6467 6554  ce(cell, BridgeT
+0000a3d0: 6f77 6572 5669 7369 6f6e 4d6f 6465 6c29  owerVisionModel)
+0000a3e0: 3a0a 2020 2020 2020 2020 2020 2020 7072  :.            pr
+0000a3f0: 6f6a 5f73 7464 203d 2028 6365 6c6c 2e76  oj_std = (cell.v
+0000a400: 6973 7561 6c2e 7472 616e 7366 6f72 6d65  isual.transforme
+0000a410: 722e 6869 6464 656e 5f73 697a 652a 2a2d  r.hidden_size**-
+0000a420: 302e 3529 202a 2028 0a20 2020 2020 2020  0.5) * (.       
+0000a430: 2020 2020 2020 2020 2028 3220 2a20 6365           (2 * ce
+0000a440: 6c6c 2e76 6973 7561 6c2e 7472 616e 7366  ll.visual.transf
+0000a450: 6f72 6d65 722e 6e75 6d5f 6869 6464 656e  ormer.num_hidden
+0000a460: 5f6c 6179 6572 7329 202a 2a20 2d30 2e35  _layers) ** -0.5
+0000a470: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0000a480: 2020 2020 2020 2020 2020 2061 7474 6e5f             attn_
+0000a490: 7374 6420 3d20 6365 6c6c 2e76 6973 7561  std = cell.visua
+0000a4a0: 6c2e 7472 616e 7366 6f72 6d65 722e 6869  l.transformer.hi
+0000a4b0: 6464 656e 5f73 697a 652a 2a2d 302e 350a  dden_size**-0.5.
+0000a4c0: 2020 2020 2020 2020 2020 2020 6663 5f73              fc_s
+0000a4d0: 7464 203d 2028 3220 2a20 6365 6c6c 2e76  td = (2 * cell.v
+0000a4e0: 6973 7561 6c2e 7472 616e 7366 6f72 6d65  isual.transforme
+0000a4f0: 722e 6869 6464 656e 5f73 697a 6529 202a  r.hidden_size) *
+0000a500: 2a20 2d30 2e35 0a20 2020 2020 2020 2020  * -0.5.         
+0000a510: 2020 2066 6f72 2062 6c6f 636b 2069 6e20     for block in 
+0000a520: 6365 6c6c 2e76 6973 7561 6c2e 7472 616e  cell.visual.tran
+0000a530: 7366 6f72 6d65 722e 7265 7362 6c6f 636b  sformer.resblock
+0000a540: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0000a550: 2020 2062 6c6f 636b 2e61 7474 6e2e 696e     block.attn.in
+0000a560: 5f70 726f 6a5f 7765 6967 6874 2e69 6e69  _proj_weight.ini
+0000a570: 7469 616c 697a 6528 4e6f 726d 616c 2861  tialize(Normal(a
+0000a580: 7474 6e5f 7374 6420 2a20 7365 6c66 2e63  ttn_std * self.c
+0000a590: 6f6e 6669 672e 696e 6974 6961 6c69 7a65  onfig.initialize
+0000a5a0: 725f 6661 6374 6f72 2929 0a20 2020 2020  r_factor)).     
+0000a5b0: 2020 2020 2020 2020 2020 2062 6c6f 636b             block
+0000a5c0: 2e61 7474 6e2e 6f75 745f 7072 6f6a 2e77  .attn.out_proj.w
+0000a5d0: 6569 6768 742e 696e 6974 6961 6c69 7a65  eight.initialize
+0000a5e0: 284e 6f72 6d61 6c28 7072 6f6a 5f73 7464  (Normal(proj_std
+0000a5f0: 202a 2073 656c 662e 636f 6e66 6967 2e69   * self.config.i
+0000a600: 6e69 7469 616c 697a 6572 5f66 6163 746f  nitializer_facto
+0000a610: 7229 290a 2020 2020 2020 2020 2020 2020  r)).            
+0000a620: 2020 2020 626c 6f63 6b2e 6d6c 702e 635f      block.mlp.c_
+0000a630: 6663 2e77 6569 6768 742e 696e 6974 6961  fc.weight.initia
+0000a640: 6c69 7a65 284e 6f72 6d61 6c28 6663 5f73  lize(Normal(fc_s
+0000a650: 7464 202a 2073 656c 662e 636f 6e66 6967  td * self.config
+0000a660: 2e69 6e69 7469 616c 697a 6572 5f66 6163  .initializer_fac
+0000a670: 746f 7229 290a 2020 2020 2020 2020 2020  tor)).          
+0000a680: 2020 2020 2020 626c 6f63 6b2e 6d6c 702e        block.mlp.
+0000a690: 635f 7072 6f6a 2e77 6569 6768 742e 696e  c_proj.weight.in
+0000a6a0: 6974 6961 6c69 7a65 284e 6f72 6d61 6c28  itialize(Normal(
+0000a6b0: 7072 6f6a 5f73 7464 202a 2073 656c 662e  proj_std * self.
+0000a6c0: 636f 6e66 6967 2e69 6e69 7469 616c 697a  config.initializ
+0000a6d0: 6572 5f66 6163 746f 7229 290a 0a20 2020  er_factor))..   
+0000a6e0: 2020 2020 2020 2020 2063 656c 6c2e 7669           cell.vi
+0000a6f0: 7375 616c 2e65 6d62 6564 6469 6e67 732e  sual.embeddings.
+0000a700: 636c 6173 735f 656d 6265 6464 696e 672e  class_embedding.
+0000a710: 696e 6974 6961 6c69 7a65 284e 6f72 6d61  initialize(Norma
+0000a720: 6c28 6174 746e 5f73 7464 202a 2073 656c  l(attn_std * sel
+0000a730: 662e 636f 6e66 6967 2e69 6e69 7469 616c  f.config.initial
+0000a740: 697a 6572 5f66 6163 746f 7229 290a 2020  izer_factor)).  
+0000a750: 2020 2020 2020 2020 2020 6365 6c6c 2e76            cell.v
+0000a760: 6973 7561 6c2e 656d 6265 6464 696e 6773  isual.embeddings
+0000a770: 2e70 6f73 6974 696f 6e5f 656d 6265 6464  .position_embedd
+0000a780: 696e 672e 7765 6967 6874 2e69 6e69 7469  ing.weight.initi
+0000a790: 616c 697a 6528 4e6f 726d 616c 2861 7474  alize(Normal(att
+0000a7a0: 6e5f 7374 6420 2a20 7365 6c66 2e63 6f6e  n_std * self.con
+0000a7b0: 6669 672e 696e 6974 6961 6c69 7a65 725f  fig.initializer_
+0000a7c0: 6661 6374 6f72 2929 0a20 2020 2020 2020  factor)).       
+0000a7d0: 2065 6c69 6620 6973 696e 7374 616e 6365   elif isinstance
+0000a7e0: 2863 656c 6c2c 2028 6e6e 2e44 656e 7365  (cell, (nn.Dense
+0000a7f0: 2c20 6e6e 2e43 6f6e 7632 642c 206e 6e2e  , nn.Conv2d, nn.
+0000a800: 456d 6265 6464 696e 6729 293a 0a20 2020  Embedding)):.   
+0000a810: 2020 2020 2020 2020 2063 656c 6c2e 7765           cell.we
+0000a820: 6967 6874 2e69 6e69 7469 616c 697a 6528  ight.initialize(
+0000a830: 4e6f 726d 616c 2830 2e30 3520 2a20 7365  Normal(0.05 * se
+0000a840: 6c66 2e63 6f6e 6669 672e 696e 6974 6961  lf.config.initia
+0000a850: 6c69 7a65 725f 6661 6374 6f72 2929 0a20  lizer_factor)). 
+0000a860: 2020 2020 2020 2065 6c69 6620 6973 696e         elif isin
+0000a870: 7374 616e 6365 2863 656c 6c2c 206e 6e2e  stance(cell, nn.
+0000a880: 4c61 7965 724e 6f72 6d29 3a0a 2020 2020  LayerNorm):.    
+0000a890: 2020 2020 2020 2020 6365 6c6c 2e62 6961          cell.bia
+0000a8a0: 732e 696e 6974 6961 6c69 7a65 2827 7a65  s.initialize('ze
+0000a8b0: 726f 7327 290a 2020 2020 2020 2020 2020  ros').          
+0000a8c0: 2020 6365 6c6c 2e77 6569 6768 742e 696e    cell.weight.in
+0000a8d0: 6974 6961 6c69 7a65 2827 6f6e 6573 2729  itialize('ones')
+0000a8e0: 0a0a 2020 2020 2020 2020 6966 2027 4465  ..        if 'De
+0000a8f0: 6e73 6527 2069 6e20 7374 7228 7479 7065  nse' in str(type
+0000a900: 2863 656c 6c29 2920 616e 6420 6365 6c6c  (cell)) and cell
+0000a910: 2e62 6961 7320 6973 206e 6f74 204e 6f6e  .bias is not Non
+0000a920: 653a 0a20 2020 2020 2020 2020 2020 2063  e:.            c
+0000a930: 656c 6c2e 6269 6173 2e69 6e69 7469 616c  ell.bias.initial
+0000a940: 697a 6528 277a 6572 6f73 2729 0a0a 0a63  ize('zeros')...c
+0000a950: 6c61 7373 2042 7269 6467 6554 6f77 6572  lass BridgeTower
+0000a960: 5669 7369 6f6e 4d6f 6465 6c28 4272 6964  VisionModel(Brid
+0000a970: 6765 546f 7765 7250 7265 5472 6169 6e65  geTowerPreTraine
+0000a980: 644d 6f64 656c 293a 0a20 2020 2063 6f6e  dModel):.    con
+0000a990: 6669 675f 636c 6173 7320 3d20 4272 6964  fig_class = Brid
+0000a9a0: 6765 546f 7765 7256 6973 696f 6e43 6f6e  geTowerVisionCon
+0000a9b0: 6669 670a 0a20 2020 2064 6566 205f 5f69  fig..    def __i
+0000a9c0: 6e69 745f 5f28 7365 6c66 2c20 636f 6e66  nit__(self, conf
+0000a9d0: 6967 293a 0a20 2020 2020 2020 2073 7570  ig):.        sup
+0000a9e0: 6572 2829 2e5f 5f69 6e69 745f 5f28 636f  er().__init__(co
+0000a9f0: 6e66 6967 290a 2020 2020 2020 2020 7365  nfig).        se
+0000aa00: 6c66 2e76 6973 7561 6c20 3d20 4272 6964  lf.visual = Brid
+0000aa10: 6765 546f 7765 7256 6973 696f 6e54 7261  geTowerVisionTra
+0000aa20: 6e73 666f 726d 6572 2863 6f6e 6669 6729  nsformer(config)
+0000aa30: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
+0000aa40: 2020 2020 6465 6620 6474 7970 6528 7365      def dtype(se
+0000aa50: 6c66 293a 0a20 2020 2020 2020 2072 6574  lf):.        ret
+0000aa60: 7572 6e20 7365 6c66 2e76 6973 7561 6c2e  urn self.visual.
+0000aa70: 656d 6265 6464 696e 6773 2e70 6174 6368  embeddings.patch
+0000aa80: 5f65 6d62 6564 6469 6e67 2e77 6569 6768  _embedding.weigh
+0000aa90: 742e 6474 7970 650a 0a20 2020 2064 6566  t.dtype..    def
+0000aaa0: 2063 6f6e 7374 7275 6374 2873 656c 662c   construct(self,
+0000aab0: 2069 6d61 6765 2c20 696d 6167 655f 6d61   image, image_ma
+0000aac0: 736b 3d4e 6f6e 6529 3a0a 2020 2020 2020  sk=None):.      
+0000aad0: 2020 7265 7475 726e 2073 656c 662e 7669    return self.vi
+0000aae0: 7375 616c 2869 6d61 6765 2e74 7970 6528  sual(image.type(
+0000aaf0: 7365 6c66 2e64 7479 7065 292c 2069 6d61  self.dtype), ima
+0000ab00: 6765 5f6d 6173 6b29 0a0a 0a63 6c61 7373  ge_mask)...class
+0000ab10: 2042 7269 6467 6554 6f77 6572 5465 7874   BridgeTowerText
+0000ab20: 4d6f 6465 6c28 4272 6964 6765 546f 7765  Model(BridgeTowe
+0000ab30: 7250 7265 5472 6169 6e65 644d 6f64 656c  rPreTrainedModel
+0000ab40: 293a 0a20 2020 2022 2222 0a0a 2020 2020  ):.    """..    
+0000ab50: 5468 6520 6d6f 6465 6c20 6361 6e20 6265  The model can be
+0000ab60: 6861 7665 2061 7320 616e 2065 6e63 6f64  have as an encod
+0000ab70: 6572 2028 7769 7468 206f 6e6c 7920 7365  er (with only se
+0000ab80: 6c66 2d61 7474 656e 7469 6f6e 2920 6173  lf-attention) as
+0000ab90: 2077 656c 6c20 6173 2061 2064 6563 6f64   well as a decod
+0000aba0: 6572 2c20 696e 2077 6869 6368 2063 6173  er, in which cas
+0000abb0: 6520 6120 6c61 7965 7220 6f66 0a20 2020  e a layer of.   
+0000abc0: 2063 726f 7373 2d61 7474 656e 7469 6f6e   cross-attention
+0000abd0: 2069 7320 6164 6465 6420 6265 7477 6565   is added betwee
+0000abe0: 6e20 7468 6520 7365 6c66 2d61 7474 656e  n the self-atten
+0000abf0: 7469 6f6e 206c 6179 6572 732c 2066 6f6c  tion layers, fol
+0000ac00: 6c6f 7769 6e67 2074 6865 2061 7263 6869  lowing the archi
+0000ac10: 7465 6374 7572 6520 6465 7363 7269 6265  tecture describe
+0000ac20: 6420 696e 202a 4174 7465 6e74 696f 6e20  d in *Attention 
+0000ac30: 6973 0a20 2020 2061 6c6c 2079 6f75 206e  is.    all you n
+0000ac40: 6565 642a 5f20 6279 2041 7368 6973 6820  eed*_ by Ashish 
+0000ac50: 5661 7377 616e 692c 204e 6f61 6d20 5368  Vaswani, Noam Sh
+0000ac60: 617a 6565 722c 204e 696b 6920 5061 726d  azeer, Niki Parm
+0000ac70: 6172 2c20 4a61 6b6f 6220 5573 7a6b 6f72  ar, Jakob Uszkor
+0000ac80: 6569 742c 204c 6c69 6f6e 204a 6f6e 6573  eit, Llion Jones
+0000ac90: 2c20 4169 6461 6e20 4e2e 2047 6f6d 657a  , Aidan N. Gomez
+0000aca0: 2c20 4c75 6b61 737a 0a20 2020 204b 6169  , Lukasz.    Kai
+0000acb0: 7365 7220 616e 6420 496c 6c69 6120 506f  ser and Illia Po
+0000acc0: 6c6f 7375 6b68 696e 2e0a 0a20 2020 2054  losukhin...    T
+0000acd0: 6f20 6265 6861 7665 2061 7320 616e 2064  o behave as an d
+0000ace0: 6563 6f64 6572 2074 6865 206d 6f64 656c  ecoder the model
+0000acf0: 206e 6565 6473 2074 6f20 6265 2069 6e69   needs to be ini
+0000ad00: 7469 616c 697a 6564 2077 6974 6820 7468  tialized with th
+0000ad10: 6520 6069 735f 6465 636f 6465 7260 2061  e `is_decoder` a
+0000ad20: 7267 756d 656e 7420 6f66 2074 6865 2063  rgument of the c
+0000ad30: 6f6e 6669 6775 7261 7469 6f6e 2073 6574  onfiguration set
+0000ad40: 0a20 2020 2074 6f20 6054 7275 6560 2e20  .    to `True`. 
+0000ad50: 546f 2062 6520 7573 6564 2069 6e20 6120  To be used in a 
+0000ad60: 5365 7132 5365 7120 6d6f 6465 6c2c 2074  Seq2Seq model, t
+0000ad70: 6865 206d 6f64 656c 206e 6565 6473 2074  he model needs t
+0000ad80: 6f20 696e 6974 6961 6c69 7a65 6420 7769  o initialized wi
+0000ad90: 7468 2062 6f74 6820 6069 735f 6465 636f  th both `is_deco
+0000ada0: 6465 7260 2061 7267 756d 656e 7420 616e  der` argument an
+0000adb0: 640a 2020 2020 6061 6464 5f63 726f 7373  d.    `add_cross
+0000adc0: 5f61 7474 656e 7469 6f6e 6020 7365 7420  _attention` set 
+0000add0: 746f 2060 5472 7565 603b 2061 6e20 6065  to `True`; an `e
+0000ade0: 6e63 6f64 6572 5f68 6964 6465 6e5f 7374  ncoder_hidden_st
+0000adf0: 6174 6573 6020 6973 2074 6865 6e20 6578  ates` is then ex
+0000ae00: 7065 6374 6564 2061 7320 616e 2069 6e70  pected as an inp
+0000ae10: 7574 2074 6f20 7468 6520 666f 7277 6172  ut to the forwar
+0000ae20: 6420 7061 7373 2e0a 0a20 2020 202e 2e20  d pass...    .. 
+0000ae30: 5f2a 4174 7465 6e74 696f 6e20 6973 2061  _*Attention is a
+0000ae40: 6c6c 2079 6f75 206e 6565 642a 3a20 6874  ll you need*: ht
+0000ae50: 7470 733a 2f2f 6172 7869 762e 6f72 672f  tps://arxiv.org/
+0000ae60: 6162 732f 3137 3036 2e30 3337 3632 0a0a  abs/1706.03762..
+0000ae70: 2020 2020 2222 220a 0a20 2020 2063 6f6e      """..    con
+0000ae80: 6669 675f 636c 6173 7320 3d20 4272 6964  fig_class = Brid
+0000ae90: 6765 546f 7765 7254 6578 7443 6f6e 6669  geTowerTextConfi
+0000aea0: 670a 0a20 2020 2064 6566 205f 5f69 6e69  g..    def __ini
+0000aeb0: 745f 5f28 7365 6c66 2c20 636f 6e66 6967  t__(self, config
+0000aec0: 2c20 6164 645f 706f 6f6c 696e 675f 6c61  , add_pooling_la
+0000aed0: 7965 723d 5472 7565 293a 0a20 2020 2020  yer=True):.     
+0000aee0: 2020 2073 7570 6572 2829 2e5f 5f69 6e69     super().__ini
+0000aef0: 745f 5f28 636f 6e66 6967 290a 2020 2020  t__(config).    
+0000af00: 2020 2020 7365 6c66 2e63 6f6e 6669 6720      self.config 
+0000af10: 3d20 636f 6e66 6967 0a0a 2020 2020 2020  = config..      
+0000af20: 2020 7365 6c66 2e65 6d62 6564 6469 6e67    self.embedding
+0000af30: 7320 3d20 4272 6964 6765 546f 7765 7254  s = BridgeTowerT
+0000af40: 6578 7445 6d62 6564 6469 6e67 7328 636f  extEmbeddings(co
+0000af50: 6e66 6967 290a 2020 2020 2020 2020 7365  nfig).        se
+0000af60: 6c66 2e65 6e63 6f64 6572 203d 2042 7269  lf.encoder = Bri
+0000af70: 6467 6554 6f77 6572 5465 7874 456e 636f  dgeTowerTextEnco
+0000af80: 6465 7228 636f 6e66 6967 290a 0a20 2020  der(config)..   
+0000af90: 2020 2020 2073 656c 662e 706f 6f6c 6572       self.pooler
+0000afa0: 203d 2042 7269 6467 6554 6f77 6572 506f   = BridgeTowerPo
+0000afb0: 6f6c 6572 2863 6f6e 6669 6729 2069 6620  oler(config) if 
+0000afc0: 6164 645f 706f 6f6c 696e 675f 6c61 7965  add_pooling_laye
+0000afd0: 7220 656c 7365 204e 6f6e 650a 0a20 2020  r else None..   
+0000afe0: 2020 2020 2023 2049 6e69 7469 616c 697a       # Initializ
+0000aff0: 6520 7765 6967 6874 7320 616e 6420 6170  e weights and ap
+0000b000: 706c 7920 6669 6e61 6c20 7072 6f63 6573  ply final proces
+0000b010: 7369 6e67 0a20 2020 2020 2020 2073 656c  sing.        sel
+0000b020: 662e 706f 7374 5f69 6e69 7428 290a 0a20  f.post_init().. 
+0000b030: 2020 2064 6566 2067 6574 5f69 6e70 7574     def get_input
+0000b040: 5f65 6d62 6564 6469 6e67 7328 7365 6c66  _embeddings(self
+0000b050: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+0000b060: 6e20 7365 6c66 2e65 6d62 6564 6469 6e67  n self.embedding
+0000b070: 732e 776f 7264 5f65 6d62 6564 6469 6e67  s.word_embedding
+0000b080: 730a 0a20 2020 2064 6566 2073 6574 5f69  s..    def set_i
+0000b090: 6e70 7574 5f65 6d62 6564 6469 6e67 7328  nput_embeddings(
+0000b0a0: 7365 6c66 2c20 7661 6c75 6529 3a0a 2020  self, value):.  
+0000b0b0: 2020 2020 2020 7365 6c66 2e65 6d62 6564        self.embed
+0000b0c0: 6469 6e67 732e 776f 7264 5f65 6d62 6564  dings.word_embed
+0000b0d0: 6469 6e67 7320 3d20 7661 6c75 650a 0a20  dings = value.. 
+0000b0e0: 2020 2064 6566 205f 7072 756e 655f 6865     def _prune_he
+0000b0f0: 6164 7328 7365 6c66 2c20 6865 6164 735f  ads(self, heads_
+0000b100: 746f 5f70 7275 6e65 293a 0a20 2020 2020  to_prune):.     
+0000b110: 2020 2022 2222 0a20 2020 2020 2020 2050     """.        P
+0000b120: 7275 6e65 7320 6865 6164 7320 6f66 2074  runes heads of t
+0000b130: 6865 206d 6f64 656c 2e20 6865 6164 735f  he model. heads_
+0000b140: 746f 5f70 7275 6e65 3a20 6469 6374 206f  to_prune: dict o
+0000b150: 6620 7b6c 6179 6572 5f6e 756d 3a20 6c69  f {layer_num: li
+0000b160: 7374 206f 6620 6865 6164 7320 746f 2070  st of heads to p
+0000b170: 7275 6e65 2069 6e20 7468 6973 206c 6179  rune in this lay
+0000b180: 6572 7d20 5365 6520 6261 7365 0a20 2020  er} See base.   
+0000b190: 2020 2020 2063 6c61 7373 2050 7265 5472       class PreTr
+0000b1a0: 6169 6e65 644d 6f64 656c 0a20 2020 2020  ainedModel.     
+0000b1b0: 2020 2022 2222 0a20 2020 2020 2020 2066     """.        f
+0000b1c0: 6f72 206c 6179 6572 2c20 6865 6164 7320  or layer, heads 
+0000b1d0: 696e 2068 6561 6473 5f74 6f5f 7072 756e  in heads_to_prun
+0000b1e0: 652e 6974 656d 7328 293a 0a20 2020 2020  e.items():.     
+0000b1f0: 2020 2020 2020 2073 656c 662e 656e 636f         self.enco
+0000b200: 6465 722e 6c61 7965 725b 6c61 7965 725d  der.layer[layer]
+0000b210: 2e61 7474 656e 7469 6f6e 2e70 7275 6e65  .attention.prune
+0000b220: 5f68 6561 6473 2868 6561 6473 290a 0a20  _heads(heads).. 
+0000b230: 2020 2023 2043 6f70 6965 6420 6672 6f6d     # Copied from
+0000b240: 2074 7261 6e73 666f 726d 6572 732e 6d6f   transformers.mo
+0000b250: 6465 6c73 2e72 6f62 6572 7461 2e6d 6f64  dels.roberta.mod
+0000b260: 656c 696e 675f 726f 6265 7274 612e 526f  eling_roberta.Ro
+0000b270: 6265 7274 614d 6f64 656c 2e66 6f72 7761  bertaModel.forwa
+0000b280: 7264 0a20 2020 2064 6566 2063 6f6e 7374  rd.    def const
+0000b290: 7275 6374 280a 2020 2020 2020 2020 7365  ruct(.        se
+0000b2a0: 6c66 2c0a 2020 2020 2020 2020 696e 7075  lf,.        inpu
+0000b2b0: 745f 6964 733a 204f 7074 696f 6e61 6c5b  t_ids: Optional[
+0000b2c0: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+0000b2d0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+0000b2e0: 2020 6174 7465 6e74 696f 6e5f 6d61 736b    attention_mask
+0000b2f0: 3a20 4f70 7469 6f6e 616c 5b6d 696e 6473  : Optional[minds
+0000b300: 706f 7265 2e54 656e 736f 725d 203d 204e  pore.Tensor] = N
+0000b310: 6f6e 652c 0a20 2020 2020 2020 2074 6f6b  one,.        tok
+0000b320: 656e 5f74 7970 655f 6964 733a 204f 7074  en_type_ids: Opt
+0000b330: 696f 6e61 6c5b 6d69 6e64 7370 6f72 652e  ional[mindspore.
+0000b340: 5465 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a  Tensor] = None,.
+0000b350: 2020 2020 2020 2020 706f 7369 7469 6f6e          position
+0000b360: 5f69 6473 3a20 4f70 7469 6f6e 616c 5b6d  _ids: Optional[m
+0000b370: 696e 6473 706f 7265 2e54 656e 736f 725d  indspore.Tensor]
+0000b380: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+0000b390: 2068 6561 645f 6d61 736b 3a20 4f70 7469   head_mask: Opti
+0000b3a0: 6f6e 616c 5b6d 696e 6473 706f 7265 2e54  onal[mindspore.T
+0000b3b0: 656e 736f 725d 203d 204e 6f6e 652c 0a20  ensor] = None,. 
+0000b3c0: 2020 2020 2020 2069 6e70 7574 735f 656d         inputs_em
+0000b3d0: 6265 6473 3a20 4f70 7469 6f6e 616c 5b6d  beds: Optional[m
+0000b3e0: 696e 6473 706f 7265 2e54 656e 736f 725d  indspore.Tensor]
+0000b3f0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+0000b400: 2065 6e63 6f64 6572 5f68 6964 6465 6e5f   encoder_hidden_
+0000b410: 7374 6174 6573 3a20 4f70 7469 6f6e 616c  states: Optional
+0000b420: 5b6d 696e 6473 706f 7265 2e54 656e 736f  [mindspore.Tenso
+0000b430: 725d 203d 204e 6f6e 652c 0a20 2020 2020  r] = None,.     
+0000b440: 2020 2065 6e63 6f64 6572 5f61 7474 656e     encoder_atten
+0000b450: 7469 6f6e 5f6d 6173 6b3a 204f 7074 696f  tion_mask: Optio
+0000b460: 6e61 6c5b 6d69 6e64 7370 6f72 652e 5465  nal[mindspore.Te
+0000b470: 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a 2020  nsor] = None,.  
+0000b480: 2020 2020 2020 7061 7374 5f6b 6579 5f76        past_key_v
+0000b490: 616c 7565 733a 204f 7074 696f 6e61 6c5b  alues: Optional[
+0000b4a0: 4c69 7374 5b6d 696e 6473 706f 7265 2e54  List[mindspore.T
+0000b4b0: 656e 736f 725d 5d20 3d20 4e6f 6e65 2c0a  ensor]] = None,.
+0000b4c0: 2020 2020 2020 2020 7573 655f 6361 6368          use_cach
+0000b4d0: 653a 204f 7074 696f 6e61 6c5b 626f 6f6c  e: Optional[bool
+0000b4e0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+0000b4f0: 2020 6f75 7470 7574 5f61 7474 656e 7469    output_attenti
+0000b500: 6f6e 733a 204f 7074 696f 6e61 6c5b 626f  ons: Optional[bo
+0000b510: 6f6c 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ol] = None,.    
+0000b520: 2020 2020 6f75 7470 7574 5f68 6964 6465      output_hidde
+0000b530: 6e5f 7374 6174 6573 3a20 4f70 7469 6f6e  n_states: Option
+0000b540: 616c 5b62 6f6f 6c5d 203d 204e 6f6e 652c  al[bool] = None,
+0000b550: 0a20 2020 2020 2020 2072 6574 7572 6e5f  .        return_
+0000b560: 6469 6374 3a20 4f70 7469 6f6e 616c 5b62  dict: Optional[b
+0000b570: 6f6f 6c5d 203d 204e 6f6e 652c 0a20 2020  ool] = None,.   
+0000b580: 2029 202d 3e20 556e 696f 6e5b 5475 706c   ) -> Union[Tupl
+0000b590: 655b 6d69 6e64 7370 6f72 652e 5465 6e73  e[mindspore.Tens
+0000b5a0: 6f72 5d2c 2042 6173 654d 6f64 656c 4f75  or], BaseModelOu
+0000b5b0: 7470 7574 5769 7468 506f 6f6c 696e 6741  tputWithPoolingA
+0000b5c0: 6e64 4372 6f73 7341 7474 656e 7469 6f6e  ndCrossAttention
+0000b5d0: 735d 3a0a 2020 2020 2020 2020 7222 2222  s]:.        r"""
+0000b5e0: 0a20 2020 2020 2020 2065 6e63 6f64 6572  .        encoder
+0000b5f0: 5f68 6964 6465 6e5f 7374 6174 6573 2020  _hidden_states  
+0000b600: 2860 6d69 6e64 7370 6f72 652e 5465 6e73  (`mindspore.Tens
+0000b610: 6f72 6020 6f66 2073 6861 7065 2060 2862  or` of shape `(b
+0000b620: 6174 6368 5f73 697a 652c 2073 6571 7565  atch_size, seque
+0000b630: 6e63 655f 6c65 6e67 7468 2c20 6869 6464  nce_length, hidd
+0000b640: 656e 5f73 697a 6529 602c 202a 6f70 7469  en_size)`, *opti
+0000b650: 6f6e 616c 2a29 3a0a 2020 2020 2020 2020  onal*):.        
+0000b660: 2020 2020 5365 7175 656e 6365 206f 6620      Sequence of 
+0000b670: 6869 6464 656e 2d73 7461 7465 7320 6174  hidden-states at
+0000b680: 2074 6865 206f 7574 7075 7420 6f66 2074   the output of t
+0000b690: 6865 206c 6173 7420 6c61 7965 7220 6f66  he last layer of
+0000b6a0: 2074 6865 2065 6e63 6f64 6572 2e20 5573   the encoder. Us
+0000b6b0: 6564 2069 6e20 7468 6520 6372 6f73 732d  ed in the cross-
+0000b6c0: 6174 7465 6e74 696f 6e20 6966 0a20 2020  attention if.   
+0000b6d0: 2020 2020 2020 2020 2074 6865 206d 6f64           the mod
+0000b6e0: 656c 2069 7320 636f 6e66 6967 7572 6564  el is configured
+0000b6f0: 2061 7320 6120 6465 636f 6465 722e 0a20   as a decoder.. 
+0000b700: 2020 2020 2020 2065 6e63 6f64 6572 5f61         encoder_a
+0000b710: 7474 656e 7469 6f6e 5f6d 6173 6b20 2860  ttention_mask (`
+0000b720: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+0000b730: 6020 6f66 2073 6861 7065 2060 2862 6174  ` of shape `(bat
+0000b740: 6368 5f73 697a 652c 2073 6571 7565 6e63  ch_size, sequenc
+0000b750: 655f 6c65 6e67 7468 2960 2c20 2a6f 7074  e_length)`, *opt
+0000b760: 696f 6e61 6c2a 293a 0a20 2020 2020 2020  ional*):.       
+0000b770: 2020 2020 204d 6173 6b20 746f 2061 766f       Mask to avo
+0000b780: 6964 2070 6572 666f 726d 696e 6720 6174  id performing at
+0000b790: 7465 6e74 696f 6e20 6f6e 2074 6865 2070  tention on the p
+0000b7a0: 6164 6469 6e67 2074 6f6b 656e 2069 6e64  adding token ind
+0000b7b0: 6963 6573 206f 6620 7468 6520 656e 636f  ices of the enco
+0000b7c0: 6465 7220 696e 7075 742e 2054 6869 7320  der input. This 
+0000b7d0: 6d61 736b 2069 7320 7573 6564 2069 6e0a  mask is used in.
+0000b7e0: 2020 2020 2020 2020 2020 2020 7468 6520              the 
+0000b7f0: 6372 6f73 732d 6174 7465 6e74 696f 6e20  cross-attention 
+0000b800: 6966 2074 6865 206d 6f64 656c 2069 7320  if the model is 
+0000b810: 636f 6e66 6967 7572 6564 2061 7320 6120  configured as a 
+0000b820: 6465 636f 6465 722e 204d 6173 6b20 7661  decoder. Mask va
+0000b830: 6c75 6573 2073 656c 6563 7465 6420 696e  lues selected in
+0000b840: 2060 5b30 2c20 315d 603a 0a0a 2020 2020   `[0, 1]`:..    
+0000b850: 2020 2020 2020 2020 2d20 3120 666f 7220          - 1 for 
+0000b860: 746f 6b65 6e73 2074 6861 7420 6172 6520  tokens that are 
+0000b870: 2a2a 6e6f 7420 6d61 736b 6564 2a2a 2c0a  **not masked**,.
+0000b880: 2020 2020 2020 2020 2020 2020 2d20 3020              - 0 
+0000b890: 666f 7220 746f 6b65 6e73 2074 6861 7420  for tokens that 
+0000b8a0: 6172 6520 2a2a 6d61 736b 6564 2a2a 2e0a  are **masked**..
+0000b8b0: 2020 2020 2020 2020 7061 7374 5f6b 6579          past_key
+0000b8c0: 5f76 616c 7565 7320 2860 7475 706c 6528  _values (`tuple(
+0000b8d0: 7475 706c 6528 6d69 6e64 7370 6f72 652e  tuple(mindspore.
+0000b8e0: 5465 6e73 6f72 2929 6020 6f66 206c 656e  Tensor))` of len
+0000b8f0: 6774 6820 6063 6f6e 6669 672e 6e5f 6c61  gth `config.n_la
+0000b900: 7965 7273 6020 7769 7468 2065 6163 6820  yers` with each 
+0000b910: 7475 706c 6520 6861 7669 6e67 2034 2074  tuple having 4 t
+0000b920: 656e 736f 7273 206f 6620 7368 6170 6520  ensors of shape 
+0000b930: 6028 6261 7463 685f 7369 7a65 2c20 6e75  `(batch_size, nu
+0000b940: 6d5f 6865 6164 732c 2073 6571 7565 6e63  m_heads, sequenc
+0000b950: 655f 6c65 6e67 7468 202d 2031 2c20 656d  e_length - 1, em
+0000b960: 6265 645f 7369 7a65 5f70 6572 5f68 6561  bed_size_per_hea
+0000b970: 6429 6029 3a0a 2020 2020 2020 2020 2020  d)`):.          
+0000b980: 2020 436f 6e74 6169 6e73 2070 7265 636f    Contains preco
+0000b990: 6d70 7574 6564 206b 6579 2061 6e64 2076  mputed key and v
+0000b9a0: 616c 7565 2068 6964 6465 6e20 7374 6174  alue hidden stat
+0000b9b0: 6573 206f 6620 7468 6520 6174 7465 6e74  es of the attent
+0000b9c0: 696f 6e20 626c 6f63 6b73 2e20 4361 6e20  ion blocks. Can 
+0000b9d0: 6265 2075 7365 6420 746f 2073 7065 6564  be used to speed
+0000b9e0: 2075 7020 6465 636f 6469 6e67 2e0a 0a20   up decoding... 
+0000b9f0: 2020 2020 2020 2020 2020 2049 6620 6070             If `p
+0000ba00: 6173 745f 6b65 795f 7661 6c75 6573 6020  ast_key_values` 
+0000ba10: 6172 6520 7573 6564 2c20 7468 6520 7573  are used, the us
+0000ba20: 6572 2063 616e 206f 7074 696f 6e61 6c6c  er can optionall
+0000ba30: 7920 696e 7075 7420 6f6e 6c79 2074 6865  y input only the
+0000ba40: 206c 6173 7420 6064 6563 6f64 6572 5f69   last `decoder_i
+0000ba50: 6e70 7574 5f69 6473 6020 2874 686f 7365  nput_ids` (those
+0000ba60: 2074 6861 740a 2020 2020 2020 2020 2020   that.          
+0000ba70: 2020 646f 6e27 7420 6861 7665 2074 6865    don't have the
+0000ba80: 6972 2070 6173 7420 6b65 7920 7661 6c75  ir past key valu
+0000ba90: 6520 7374 6174 6573 2067 6976 656e 2074  e states given t
+0000baa0: 6f20 7468 6973 206d 6f64 656c 2920 6f66  o this model) of
+0000bab0: 2073 6861 7065 2060 2862 6174 6368 5f73   shape `(batch_s
+0000bac0: 697a 652c 2031 2960 2069 6e73 7465 6164  ize, 1)` instead
+0000bad0: 206f 6620 616c 6c0a 2020 2020 2020 2020   of all.        
+0000bae0: 2020 2020 6064 6563 6f64 6572 5f69 6e70      `decoder_inp
+0000baf0: 7574 5f69 6473 6020 6f66 2073 6861 7065  ut_ids` of shape
+0000bb00: 2060 2862 6174 6368 5f73 697a 652c 2073   `(batch_size, s
+0000bb10: 6571 7565 6e63 655f 6c65 6e67 7468 2960  equence_length)`
+0000bb20: 2e0a 2020 2020 2020 2020 7573 655f 6361  ..        use_ca
+0000bb30: 6368 6520 2860 626f 6f6c 602c 202a 6f70  che (`bool`, *op
+0000bb40: 7469 6f6e 616c 2a29 3a0a 2020 2020 2020  tional*):.      
+0000bb50: 2020 2020 2020 4966 2073 6574 2074 6f20        If set to 
+0000bb60: 6054 7275 6560 2c20 6070 6173 745f 6b65  `True`, `past_ke
+0000bb70: 795f 7661 6c75 6573 6020 6b65 7920 7661  y_values` key va
+0000bb80: 6c75 6520 7374 6174 6573 2061 7265 2072  lue states are r
+0000bb90: 6574 7572 6e65 6420 616e 6420 6361 6e20  eturned and can 
+0000bba0: 6265 2075 7365 6420 746f 2073 7065 6564  be used to speed
+0000bbb0: 2075 7020 6465 636f 6469 6e67 2028 7365   up decoding (se
+0000bbc0: 650a 2020 2020 2020 2020 2020 2020 6070  e.            `p
+0000bbd0: 6173 745f 6b65 795f 7661 6c75 6573 6029  ast_key_values`)
+0000bbe0: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+0000bbf0: 2020 2020 2020 6f75 7470 7574 5f61 7474        output_att
+0000bc00: 656e 7469 6f6e 7320 3d20 6f75 7470 7574  entions = output
+0000bc10: 5f61 7474 656e 7469 6f6e 7320 6966 206f  _attentions if o
+0000bc20: 7574 7075 745f 6174 7465 6e74 696f 6e73  utput_attentions
+0000bc30: 2069 7320 6e6f 7420 4e6f 6e65 2065 6c73   is not None els
+0000bc40: 6520 7365 6c66 2e63 6f6e 6669 672e 6f75  e self.config.ou
+0000bc50: 7470 7574 5f61 7474 656e 7469 6f6e 730a  tput_attentions.
+0000bc60: 2020 2020 2020 2020 6f75 7470 7574 5f68          output_h
+0000bc70: 6964 6465 6e5f 7374 6174 6573 203d 2028  idden_states = (
+0000bc80: 0a20 2020 2020 2020 2020 2020 206f 7574  .            out
+0000bc90: 7075 745f 6869 6464 656e 5f73 7461 7465  put_hidden_state
+0000bca0: 7320 6966 206f 7574 7075 745f 6869 6464  s if output_hidd
+0000bcb0: 656e 5f73 7461 7465 7320 6973 206e 6f74  en_states is not
+0000bcc0: 204e 6f6e 6520 656c 7365 2073 656c 662e   None else self.
+0000bcd0: 636f 6e66 6967 2e6f 7574 7075 745f 6869  config.output_hi
+0000bce0: 6464 656e 5f73 7461 7465 730a 2020 2020  dden_states.    
+0000bcf0: 2020 2020 290a 2020 2020 2020 2020 7265      ).        re
+0000bd00: 7475 726e 5f64 6963 7420 3d20 7265 7475  turn_dict = retu
+0000bd10: 726e 5f64 6963 7420 6966 2072 6574 7572  rn_dict if retur
+0000bd20: 6e5f 6469 6374 2069 7320 6e6f 7420 4e6f  n_dict is not No
+0000bd30: 6e65 2065 6c73 6520 7365 6c66 2e63 6f6e  ne else self.con
+0000bd40: 6669 672e 7573 655f 7265 7475 726e 5f64  fig.use_return_d
+0000bd50: 6963 740a 0a20 2020 2020 2020 2069 6620  ict..        if 
+0000bd60: 7365 6c66 2e63 6f6e 6669 672e 6973 5f64  self.config.is_d
+0000bd70: 6563 6f64 6572 3a0a 2020 2020 2020 2020  ecoder:.        
+0000bd80: 2020 2020 7573 655f 6361 6368 6520 3d20      use_cache = 
+0000bd90: 7573 655f 6361 6368 6520 6966 2075 7365  use_cache if use
+0000bda0: 5f63 6163 6865 2069 7320 6e6f 7420 4e6f  _cache is not No
+0000bdb0: 6e65 2065 6c73 6520 7365 6c66 2e63 6f6e  ne else self.con
+0000bdc0: 6669 672e 7573 655f 6361 6368 650a 2020  fig.use_cache.  
+0000bdd0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0000bde0: 2020 2020 2020 2020 7573 655f 6361 6368          use_cach
+0000bdf0: 6520 3d20 4661 6c73 650a 0a20 2020 2020  e = False..     
+0000be00: 2020 2069 6620 696e 7075 745f 6964 7320     if input_ids 
+0000be10: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
+0000be20: 696e 7075 7473 5f65 6d62 6564 7320 6973  inputs_embeds is
+0000be30: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+0000be40: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+0000be50: 7565 4572 726f 7228 2259 6f75 2063 616e  ueError("You can
+0000be60: 6e6f 7420 7370 6563 6966 7920 626f 7468  not specify both
+0000be70: 2069 6e70 7574 5f69 6473 2061 6e64 2069   input_ids and i
+0000be80: 6e70 7574 735f 656d 6265 6473 2061 7420  nputs_embeds at 
+0000be90: 7468 6520 7361 6d65 2074 696d 6522 290a  the same time").
+0000bea0: 2020 2020 2020 2020 656c 6966 2069 6e70          elif inp
+0000beb0: 7574 5f69 6473 2069 7320 6e6f 7420 4e6f  ut_ids is not No
+0000bec0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0000bed0: 7365 6c66 2e77 6172 6e5f 6966 5f70 6164  self.warn_if_pad
+0000bee0: 6469 6e67 5f61 6e64 5f6e 6f5f 6174 7465  ding_and_no_atte
+0000bef0: 6e74 696f 6e5f 6d61 736b 2869 6e70 7574  ntion_mask(input
+0000bf00: 5f69 6473 2c20 6174 7465 6e74 696f 6e5f  _ids, attention_
+0000bf10: 6d61 736b 290a 2020 2020 2020 2020 2020  mask).          
+0000bf20: 2020 696e 7075 745f 7368 6170 6520 3d20    input_shape = 
+0000bf30: 696e 7075 745f 6964 732e 7368 6170 650a  input_ids.shape.
+0000bf40: 2020 2020 2020 2020 656c 6966 2069 6e70          elif inp
+0000bf50: 7574 735f 656d 6265 6473 2069 7320 6e6f  uts_embeds is no
+0000bf60: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+0000bf70: 2020 2020 696e 7075 745f 7368 6170 6520      input_shape 
+0000bf80: 3d20 696e 7075 7473 5f65 6d62 6564 732e  = inputs_embeds.
+0000bf90: 7368 6170 655b 3a2d 315d 0a20 2020 2020  shape[:-1].     
+0000bfa0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0000bfb0: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+0000bfc0: 4572 726f 7228 2259 6f75 2068 6176 6520  Error("You have 
+0000bfd0: 746f 2073 7065 6369 6679 2065 6974 6865  to specify eithe
+0000bfe0: 7220 696e 7075 745f 6964 7320 6f72 2069  r input_ids or i
+0000bff0: 6e70 7574 735f 656d 6265 6473 2229 0a0a  nputs_embeds")..
+0000c000: 2020 2020 2020 2020 6261 7463 685f 7369          batch_si
+0000c010: 7a65 2c20 7365 715f 6c65 6e67 7468 203d  ze, seq_length =
+0000c020: 2069 6e70 7574 5f73 6861 7065 0a0a 2020   input_shape..  
+0000c030: 2020 2020 2020 2320 7061 7374 5f6b 6579        # past_key
+0000c040: 5f76 616c 7565 735f 6c65 6e67 7468 0a20  _values_length. 
+0000c050: 2020 2020 2020 2070 6173 745f 6b65 795f         past_key_
+0000c060: 7661 6c75 6573 5f6c 656e 6774 6820 3d20  values_length = 
+0000c070: 7061 7374 5f6b 6579 5f76 616c 7565 735b  past_key_values[
+0000c080: 305d 5b30 5d2e 7368 6170 655b 325d 2069  0][0].shape[2] i
+0000c090: 6620 7061 7374 5f6b 6579 5f76 616c 7565  f past_key_value
+0000c0a0: 7320 6973 206e 6f74 204e 6f6e 6520 656c  s is not None el
+0000c0b0: 7365 2030 0a0a 2020 2020 2020 2020 6966  se 0..        if
+0000c0c0: 2061 7474 656e 7469 6f6e 5f6d 6173 6b20   attention_mask 
+0000c0d0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+0000c0e0: 2020 2020 2061 7474 656e 7469 6f6e 5f6d       attention_m
+0000c0f0: 6173 6b20 3d20 6f70 732e 6f6e 6573 2828  ask = ops.ones((
+0000c100: 2862 6174 6368 5f73 697a 652c 2073 6571  (batch_size, seq
+0000c110: 5f6c 656e 6774 6820 2b20 7061 7374 5f6b  _length + past_k
+0000c120: 6579 5f76 616c 7565 735f 6c65 6e67 7468  ey_values_length
+0000c130: 2929 290a 0a20 2020 2020 2020 2069 6620  )))..        if 
+0000c140: 746f 6b65 6e5f 7479 7065 5f69 6473 2069  token_type_ids i
+0000c150: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0000c160: 2020 2020 6966 2068 6173 6174 7472 2873      if hasattr(s
+0000c170: 656c 662e 656d 6265 6464 696e 6773 2c20  elf.embeddings, 
+0000c180: 2274 6f6b 656e 5f74 7970 655f 6964 7322  "token_type_ids"
+0000c190: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0000c1a0: 2020 2062 7566 6665 7265 645f 746f 6b65     buffered_toke
+0000c1b0: 6e5f 7479 7065 5f69 6473 203d 2073 656c  n_type_ids = sel
+0000c1c0: 662e 656d 6265 6464 696e 6773 2e74 6f6b  f.embeddings.tok
+0000c1d0: 656e 5f74 7970 655f 6964 735b 3a2c 203a  en_type_ids[:, :
+0000c1e0: 7365 715f 6c65 6e67 7468 5d0a 2020 2020  seq_length].    
+0000c1f0: 2020 2020 2020 2020 2020 2020 6275 6666              buff
+0000c200: 6572 6564 5f74 6f6b 656e 5f74 7970 655f  ered_token_type_
+0000c210: 6964 735f 6578 7061 6e64 6564 203d 2062  ids_expanded = b
+0000c220: 7566 6665 7265 645f 746f 6b65 6e5f 7479  uffered_token_ty
+0000c230: 7065 5f69 6473 2e65 7870 616e 6428 6261  pe_ids.expand(ba
+0000c240: 7463 685f 7369 7a65 2c20 7365 715f 6c65  tch_size, seq_le
+0000c250: 6e67 7468 290a 2020 2020 2020 2020 2020  ngth).          
+0000c260: 2020 2020 2020 746f 6b65 6e5f 7479 7065        token_type
+0000c270: 5f69 6473 203d 2062 7566 6665 7265 645f  _ids = buffered_
+0000c280: 746f 6b65 6e5f 7479 7065 5f69 6473 5f65  token_type_ids_e
+0000c290: 7870 616e 6465 640a 2020 2020 2020 2020  xpanded.        
+0000c2a0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+0000c2b0: 2020 2020 2020 2020 2020 746f 6b65 6e5f            token_
+0000c2c0: 7479 7065 5f69 6473 203d 206f 7073 2e7a  type_ids = ops.z
+0000c2d0: 6572 6f73 2869 6e70 7574 5f73 6861 7065  eros(input_shape
+0000c2e0: 2c20 6474 7970 653d 6d69 6e64 7370 6f72  , dtype=mindspor
+0000c2f0: 652e 696e 7436 3429 0a0a 2020 2020 2020  e.int64)..      
+0000c300: 2020 2320 5765 2063 616e 2070 726f 7669    # We can provi
+0000c310: 6465 2061 2073 656c 662d 6174 7465 6e74  de a self-attent
+0000c320: 696f 6e20 6d61 736b 206f 6620 6469 6d65  ion mask of dime
+0000c330: 6e73 696f 6e73 205b 6261 7463 685f 7369  nsions [batch_si
+0000c340: 7a65 2c20 6672 6f6d 5f73 6571 5f6c 656e  ze, from_seq_len
+0000c350: 6774 682c 2074 6f5f 7365 715f 6c65 6e67  gth, to_seq_leng
+0000c360: 7468 5d0a 2020 2020 2020 2020 2320 6f75  th].        # ou
+0000c370: 7273 656c 7665 7320 696e 2077 6869 6368  rselves in which
+0000c380: 2063 6173 6520 7765 206a 7573 7420 6e65   case we just ne
+0000c390: 6564 2074 6f20 6d61 6b65 2069 7420 6272  ed to make it br
+0000c3a0: 6f61 6463 6173 7461 626c 6520 746f 2061  oadcastable to a
+0000c3b0: 6c6c 2068 6561 6473 2e0a 2020 2020 2020  ll heads..      
+0000c3c0: 2020 6578 7465 6e64 6564 5f61 7474 656e    extended_atten
+0000c3d0: 7469 6f6e 5f6d 6173 6b3a 206d 696e 6473  tion_mask: minds
+0000c3e0: 706f 7265 2e54 656e 736f 7220 3d20 7365  pore.Tensor = se
+0000c3f0: 6c66 2e67 6574 5f65 7874 656e 6465 645f  lf.get_extended_
+0000c400: 6174 7465 6e74 696f 6e5f 6d61 736b 2861  attention_mask(a
+0000c410: 7474 656e 7469 6f6e 5f6d 6173 6b2c 2069  ttention_mask, i
+0000c420: 6e70 7574 5f73 6861 7065 290a 0a20 2020  nput_shape)..   
+0000c430: 2020 2020 2023 2049 6620 6120 3244 206f       # If a 2D o
+0000c440: 7220 3344 2061 7474 656e 7469 6f6e 206d  r 3D attention m
+0000c450: 6173 6b20 6973 2070 726f 7669 6465 6420  ask is provided 
+0000c460: 666f 7220 7468 6520 6372 6f73 732d 6174  for the cross-at
+0000c470: 7465 6e74 696f 6e0a 2020 2020 2020 2020  tention.        
+0000c480: 2320 7765 206e 6565 6420 746f 206d 616b  # we need to mak
+0000c490: 6520 6272 6f61 6463 6173 7461 626c 6520  e broadcastable 
+0000c4a0: 746f 205b 6261 7463 685f 7369 7a65 2c20  to [batch_size, 
+0000c4b0: 6e75 6d5f 6865 6164 732c 2073 6571 5f6c  num_heads, seq_l
+0000c4c0: 656e 6774 682c 2073 6571 5f6c 656e 6774  ength, seq_lengt
+0000c4d0: 685d 0a20 2020 2020 2020 2069 6620 7365  h].        if se
+0000c4e0: 6c66 2e63 6f6e 6669 672e 6973 5f64 6563  lf.config.is_dec
+0000c4f0: 6f64 6572 2061 6e64 2065 6e63 6f64 6572  oder and encoder
+0000c500: 5f68 6964 6465 6e5f 7374 6174 6573 2069  _hidden_states i
+0000c510: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+0000c520: 2020 2020 2020 2020 656e 636f 6465 725f          encoder_
+0000c530: 6261 7463 685f 7369 7a65 2c20 656e 636f  batch_size, enco
+0000c540: 6465 725f 7365 7175 656e 6365 5f6c 656e  der_sequence_len
+0000c550: 6774 682c 205f 203d 2065 6e63 6f64 6572  gth, _ = encoder
+0000c560: 5f68 6964 6465 6e5f 7374 6174 6573 2e73  _hidden_states.s
+0000c570: 6861 7065 0a20 2020 2020 2020 2020 2020  hape.           
+0000c580: 2065 6e63 6f64 6572 5f68 6964 6465 6e5f   encoder_hidden_
+0000c590: 7368 6170 6520 3d20 2865 6e63 6f64 6572  shape = (encoder
+0000c5a0: 5f62 6174 6368 5f73 697a 652c 2065 6e63  _batch_size, enc
+0000c5b0: 6f64 6572 5f73 6571 7565 6e63 655f 6c65  oder_sequence_le
+0000c5c0: 6e67 7468 290a 2020 2020 2020 2020 2020  ngth).          
+0000c5d0: 2020 6966 2065 6e63 6f64 6572 5f61 7474    if encoder_att
+0000c5e0: 656e 7469 6f6e 5f6d 6173 6b20 6973 204e  ention_mask is N
+0000c5f0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+0000c600: 2020 2020 2065 6e63 6f64 6572 5f61 7474       encoder_att
+0000c610: 656e 7469 6f6e 5f6d 6173 6b20 3d20 6f70  ention_mask = op
+0000c620: 732e 6f6e 6573 2865 6e63 6f64 6572 5f68  s.ones(encoder_h
+0000c630: 6964 6465 6e5f 7368 6170 6529 0a20 2020  idden_shape).   
+0000c640: 2020 2020 2020 2020 2065 6e63 6f64 6572           encoder
+0000c650: 5f65 7874 656e 6465 645f 6174 7465 6e74  _extended_attent
+0000c660: 696f 6e5f 6d61 736b 203d 2073 656c 662e  ion_mask = self.
+0000c670: 696e 7665 7274 5f61 7474 656e 7469 6f6e  invert_attention
+0000c680: 5f6d 6173 6b28 656e 636f 6465 725f 6174  _mask(encoder_at
+0000c690: 7465 6e74 696f 6e5f 6d61 736b 290a 2020  tention_mask).  
+0000c6a0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0000c6b0: 2020 2020 2020 2020 656e 636f 6465 725f          encoder_
+0000c6c0: 6578 7465 6e64 6564 5f61 7474 656e 7469  extended_attenti
+0000c6d0: 6f6e 5f6d 6173 6b20 3d20 4e6f 6e65 0a0a  on_mask = None..
+0000c6e0: 2020 2020 2020 2020 2320 5072 6570 6172          # Prepar
+0000c6f0: 6520 6865 6164 206d 6173 6b20 6966 206e  e head mask if n
+0000c700: 6565 6465 640a 2020 2020 2020 2020 2320  eeded.        # 
+0000c710: 312e 3020 696e 2068 6561 645f 6d61 736b  1.0 in head_mask
+0000c720: 2069 6e64 6963 6174 6520 7765 206b 6565   indicate we kee
+0000c730: 7020 7468 6520 6865 6164 0a20 2020 2020  p the head.     
+0000c740: 2020 2023 2061 7474 656e 7469 6f6e 5f70     # attention_p
+0000c750: 726f 6273 2068 6173 2073 6861 7065 2062  robs has shape b
+0000c760: 737a 2078 206e 5f68 6561 6473 2078 204e  sz x n_heads x N
+0000c770: 2078 204e 0a20 2020 2020 2020 2023 2069   x N.        # i
+0000c780: 6e70 7574 2068 6561 645f 6d61 736b 2068  nput head_mask h
+0000c790: 6173 2073 6861 7065 205b 6e75 6d5f 6865  as shape [num_he
+0000c7a0: 6164 735d 206f 7220 5b6e 756d 5f68 6964  ads] or [num_hid
+0000c7b0: 6465 6e5f 6c61 7965 7273 2078 206e 756d  den_layers x num
+0000c7c0: 5f68 6561 6473 5d0a 2020 2020 2020 2020  _heads].        
+0000c7d0: 2320 616e 6420 6865 6164 5f6d 6173 6b20  # and head_mask 
+0000c7e0: 6973 2063 6f6e 7665 7274 6564 2074 6f20  is converted to 
+0000c7f0: 7368 6170 6520 5b6e 756d 5f68 6964 6465  shape [num_hidde
+0000c800: 6e5f 6c61 7965 7273 2078 2062 6174 6368  n_layers x batch
+0000c810: 2078 206e 756d 5f68 6561 6473 2078 2073   x num_heads x s
+0000c820: 6571 5f6c 656e 6774 6820 7820 7365 715f  eq_length x seq_
+0000c830: 6c65 6e67 7468 5d0a 2020 2020 2020 2020  length].        
+0000c840: 6865 6164 5f6d 6173 6b20 3d20 7365 6c66  head_mask = self
+0000c850: 2e67 6574 5f68 6561 645f 6d61 736b 2868  .get_head_mask(h
+0000c860: 6561 645f 6d61 736b 2c20 7365 6c66 2e63  ead_mask, self.c
+0000c870: 6f6e 6669 672e 6e75 6d5f 6869 6464 656e  onfig.num_hidden
+0000c880: 5f6c 6179 6572 7329 0a0a 2020 2020 2020  _layers)..      
+0000c890: 2020 656d 6265 6464 696e 675f 6f75 7470    embedding_outp
+0000c8a0: 7574 203d 2073 656c 662e 656d 6265 6464  ut = self.embedd
+0000c8b0: 696e 6773 280a 2020 2020 2020 2020 2020  ings(.          
+0000c8c0: 2020 696e 7075 745f 6964 733d 696e 7075    input_ids=inpu
+0000c8d0: 745f 6964 732c 0a20 2020 2020 2020 2020  t_ids,.         
+0000c8e0: 2020 2070 6f73 6974 696f 6e5f 6964 733d     position_ids=
+0000c8f0: 706f 7369 7469 6f6e 5f69 6473 2c0a 2020  position_ids,.  
+0000c900: 2020 2020 2020 2020 2020 746f 6b65 6e5f            token_
+0000c910: 7479 7065 5f69 6473 3d74 6f6b 656e 5f74  type_ids=token_t
+0000c920: 7970 655f 6964 732c 0a20 2020 2020 2020  ype_ids,.       
+0000c930: 2020 2020 2069 6e70 7574 735f 656d 6265       inputs_embe
+0000c940: 6473 3d69 6e70 7574 735f 656d 6265 6473  ds=inputs_embeds
+0000c950: 2c0a 2020 2020 2020 2020 2020 2020 7061  ,.            pa
+0000c960: 7374 5f6b 6579 5f76 616c 7565 735f 6c65  st_key_values_le
+0000c970: 6e67 7468 3d70 6173 745f 6b65 795f 7661  ngth=past_key_va
+0000c980: 6c75 6573 5f6c 656e 6774 682c 0a20 2020  lues_length,.   
+0000c990: 2020 2020 2029 0a20 2020 2020 2020 2065       ).        e
+0000c9a0: 6e63 6f64 6572 5f6f 7574 7075 7473 203d  ncoder_outputs =
+0000c9b0: 2073 656c 662e 656e 636f 6465 7228 0a20   self.encoder(. 
+0000c9c0: 2020 2020 2020 2020 2020 2065 6d62 6564             embed
+0000c9d0: 6469 6e67 5f6f 7574 7075 742c 0a20 2020  ding_output,.   
+0000c9e0: 2020 2020 2020 2020 2061 7474 656e 7469           attenti
+0000c9f0: 6f6e 5f6d 6173 6b3d 6578 7465 6e64 6564  on_mask=extended
+0000ca00: 5f61 7474 656e 7469 6f6e 5f6d 6173 6b2c  _attention_mask,
+0000ca10: 0a20 2020 2020 2020 2020 2020 2068 6561  .            hea
+0000ca20: 645f 6d61 736b 3d68 6561 645f 6d61 736b  d_mask=head_mask
+0000ca30: 2c0a 2020 2020 2020 2020 2020 2020 656e  ,.            en
+0000ca40: 636f 6465 725f 6869 6464 656e 5f73 7461  coder_hidden_sta
+0000ca50: 7465 733d 656e 636f 6465 725f 6869 6464  tes=encoder_hidd
+0000ca60: 656e 5f73 7461 7465 732c 0a20 2020 2020  en_states,.     
+0000ca70: 2020 2020 2020 2065 6e63 6f64 6572 5f61         encoder_a
+0000ca80: 7474 656e 7469 6f6e 5f6d 6173 6b3d 656e  ttention_mask=en
+0000ca90: 636f 6465 725f 6578 7465 6e64 6564 5f61  coder_extended_a
+0000caa0: 7474 656e 7469 6f6e 5f6d 6173 6b2c 0a20  ttention_mask,. 
+0000cab0: 2020 2020 2020 2020 2020 2070 6173 745f             past_
+0000cac0: 6b65 795f 7661 6c75 6573 3d70 6173 745f  key_values=past_
+0000cad0: 6b65 795f 7661 6c75 6573 2c0a 2020 2020  key_values,.    
+0000cae0: 2020 2020 2020 2020 7573 655f 6361 6368          use_cach
+0000caf0: 653d 7573 655f 6361 6368 652c 0a20 2020  e=use_cache,.   
+0000cb00: 2020 2020 2020 2020 206f 7574 7075 745f           output_
+0000cb10: 6174 7465 6e74 696f 6e73 3d6f 7574 7075  attentions=outpu
+0000cb20: 745f 6174 7465 6e74 696f 6e73 2c0a 2020  t_attentions,.  
+0000cb30: 2020 2020 2020 2020 2020 6f75 7470 7574            output
+0000cb40: 5f68 6964 6465 6e5f 7374 6174 6573 3d6f  _hidden_states=o
+0000cb50: 7574 7075 745f 6869 6464 656e 5f73 7461  utput_hidden_sta
+0000cb60: 7465 732c 0a20 2020 2020 2020 2020 2020  tes,.           
+0000cb70: 2072 6574 7572 6e5f 6469 6374 3d72 6574   return_dict=ret
+0000cb80: 7572 6e5f 6469 6374 2c0a 2020 2020 2020  urn_dict,.      
+0000cb90: 2020 290a 2020 2020 2020 2020 7365 7175    ).        sequ
+0000cba0: 656e 6365 5f6f 7574 7075 7420 3d20 656e  ence_output = en
+0000cbb0: 636f 6465 725f 6f75 7470 7574 735b 305d  coder_outputs[0]
+0000cbc0: 0a20 2020 2020 2020 2070 6f6f 6c65 645f  .        pooled_
+0000cbd0: 6f75 7470 7574 203d 2073 656c 662e 706f  output = self.po
+0000cbe0: 6f6c 6572 2873 6571 7565 6e63 655f 6f75  oler(sequence_ou
+0000cbf0: 7470 7574 2920 6966 2073 656c 662e 706f  tput) if self.po
+0000cc00: 6f6c 6572 2069 7320 6e6f 7420 4e6f 6e65  oler is not None
+0000cc10: 2065 6c73 6520 4e6f 6e65 0a0a 2020 2020   else None..    
+0000cc20: 2020 2020 6966 206e 6f74 2072 6574 7572      if not retur
+0000cc30: 6e5f 6469 6374 3a0a 2020 2020 2020 2020  n_dict:.        
+0000cc40: 2020 2020 7265 7475 726e 2028 7365 7175      return (sequ
+0000cc50: 656e 6365 5f6f 7574 7075 742c 2070 6f6f  ence_output, poo
+0000cc60: 6c65 645f 6f75 7470 7574 2920 2b20 656e  led_output) + en
+0000cc70: 636f 6465 725f 6f75 7470 7574 735b 313a  coder_outputs[1:
+0000cc80: 5d0a 0a20 2020 2020 2020 2072 6574 7572  ]..        retur
+0000cc90: 6e20 4261 7365 4d6f 6465 6c4f 7574 7075  n BaseModelOutpu
+0000cca0: 7457 6974 6850 6f6f 6c69 6e67 416e 6443  tWithPoolingAndC
+0000ccb0: 726f 7373 4174 7465 6e74 696f 6e73 280a  rossAttentions(.
+0000ccc0: 2020 2020 2020 2020 2020 2020 6c61 7374              last
+0000ccd0: 5f68 6964 6465 6e5f 7374 6174 653d 7365  _hidden_state=se
+0000cce0: 7175 656e 6365 5f6f 7574 7075 742c 0a20  quence_output,. 
+0000ccf0: 2020 2020 2020 2020 2020 2070 6f6f 6c65             poole
+0000cd00: 725f 6f75 7470 7574 3d70 6f6f 6c65 645f  r_output=pooled_
+0000cd10: 6f75 7470 7574 2c0a 2020 2020 2020 2020  output,.        
+0000cd20: 2020 2020 7061 7374 5f6b 6579 5f76 616c      past_key_val
+0000cd30: 7565 733d 656e 636f 6465 725f 6f75 7470  ues=encoder_outp
+0000cd40: 7574 732e 7061 7374 5f6b 6579 5f76 616c  uts.past_key_val
+0000cd50: 7565 732c 0a20 2020 2020 2020 2020 2020  ues,.           
+0000cd60: 2068 6964 6465 6e5f 7374 6174 6573 3d65   hidden_states=e
+0000cd70: 6e63 6f64 6572 5f6f 7574 7075 7473 2e68  ncoder_outputs.h
+0000cd80: 6964 6465 6e5f 7374 6174 6573 2c0a 2020  idden_states,.  
+0000cd90: 2020 2020 2020 2020 2020 6174 7465 6e74            attent
+0000cda0: 696f 6e73 3d65 6e63 6f64 6572 5f6f 7574  ions=encoder_out
+0000cdb0: 7075 7473 2e61 7474 656e 7469 6f6e 732c  puts.attentions,
+0000cdc0: 0a20 2020 2020 2020 2020 2020 2063 726f  .            cro
+0000cdd0: 7373 5f61 7474 656e 7469 6f6e 733d 656e  ss_attentions=en
+0000cde0: 636f 6465 725f 6f75 7470 7574 732e 6372  coder_outputs.cr
+0000cdf0: 6f73 735f 6174 7465 6e74 696f 6e73 2c0a  oss_attentions,.
+0000ce00: 2020 2020 2020 2020 290a 0a0a 636c 6173          )...clas
+0000ce10: 7320 4272 6964 6765 546f 7765 724d 6f64  s BridgeTowerMod
+0000ce20: 656c 2842 7269 6467 6554 6f77 6572 5072  el(BridgeTowerPr
+0000ce30: 6554 7261 696e 6564 4d6f 6465 6c29 3a0a  eTrainedModel):.
+0000ce40: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
+0000ce50: 2873 656c 662c 2063 6f6e 6669 6729 3a0a  (self, config):.
+0000ce60: 2020 2020 2020 2020 7375 7065 7228 292e          super().
+0000ce70: 5f5f 696e 6974 5f5f 2863 6f6e 6669 6729  __init__(config)
+0000ce80: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
+0000ce90: 6e66 6967 203d 2063 6f6e 6669 670a 2020  nfig = config.  
+0000cea0: 2020 2020 2020 7669 7369 6f6e 5f63 6f6e        vision_con
+0000ceb0: 6669 6720 3d20 636f 6e66 6967 2e76 6973  fig = config.vis
+0000cec0: 696f 6e5f 636f 6e66 6967 0a20 2020 2020  ion_config.     
+0000ced0: 2020 2074 6578 745f 636f 6e66 6967 203d     text_config =
+0000cee0: 2063 6f6e 6669 672e 7465 7874 5f63 6f6e   config.text_con
+0000cef0: 6669 670a 0a20 2020 2020 2020 2069 6620  fig..        if 
+0000cf00: 636f 6e66 6967 2e73 6861 7265 5f63 726f  config.share_cro
+0000cf10: 7373 5f6d 6f64 616c 5f74 7261 6e73 666f  ss_modal_transfo
+0000cf20: 726d 6572 5f6c 6179 6572 733a 0a20 2020  rmer_layers:.   
+0000cf30: 2020 2020 2020 2020 2073 656c 662e 6372           self.cr
+0000cf40: 6f73 735f 6d6f 6461 6c5f 7465 7874 5f74  oss_modal_text_t
+0000cf50: 7261 6e73 666f 726d 203d 206e 6e2e 4465  ransform = nn.De
+0000cf60: 6e73 6528 7465 7874 5f63 6f6e 6669 672e  nse(text_config.
+0000cf70: 6869 6464 656e 5f73 697a 652c 2063 6f6e  hidden_size, con
+0000cf80: 6669 672e 6869 6464 656e 5f73 697a 6529  fig.hidden_size)
+0000cf90: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0000cfa0: 662e 6372 6f73 735f 6d6f 6461 6c5f 696d  f.cross_modal_im
+0000cfb0: 6167 655f 7472 616e 7366 6f72 6d20 3d20  age_transform = 
+0000cfc0: 6e6e 2e44 656e 7365 2876 6973 696f 6e5f  nn.Dense(vision_
+0000cfd0: 636f 6e66 6967 2e68 6964 6465 6e5f 7369  config.hidden_si
+0000cfe0: 7a65 2c20 636f 6e66 6967 2e68 6964 6465  ze, config.hidde
+0000cff0: 6e5f 7369 7a65 290a 2020 2020 2020 2020  n_size).        
+0000d000: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0000d010: 2020 7365 6c66 2e63 726f 7373 5f6d 6f64    self.cross_mod
+0000d020: 616c 5f74 6578 745f 7472 616e 7366 6f72  al_text_transfor
+0000d030: 6d20 3d20 6e6e 2e43 656c 6c4c 6973 7428  m = nn.CellList(
+0000d040: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d050: 205b 6e6e 2e44 656e 7365 2874 6578 745f   [nn.Dense(text_
+0000d060: 636f 6e66 6967 2e68 6964 6465 6e5f 7369  config.hidden_si
+0000d070: 7a65 2c20 636f 6e66 6967 2e68 6964 6465  ze, config.hidde
+0000d080: 6e5f 7369 7a65 2920 666f 7220 5f20 696e  n_size) for _ in
+0000d090: 2072 616e 6765 2863 6f6e 6669 672e 6e75   range(config.nu
+0000d0a0: 6d5f 6869 6464 656e 5f6c 6179 6572 7329  m_hidden_layers)
+0000d0b0: 5d0a 2020 2020 2020 2020 2020 2020 290a  ].            ).
+0000d0c0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000d0d0: 2e63 726f 7373 5f6d 6f64 616c 5f69 6d61  .cross_modal_ima
+0000d0e0: 6765 5f74 7261 6e73 666f 726d 203d 206e  ge_transform = n
+0000d0f0: 6e2e 4365 6c6c 4c69 7374 280a 2020 2020  n.CellList(.    
+0000d100: 2020 2020 2020 2020 2020 2020 5b6e 6e2e              [nn.
+0000d110: 4465 6e73 6528 7669 7369 6f6e 5f63 6f6e  Dense(vision_con
+0000d120: 6669 672e 6869 6464 656e 5f73 697a 652c  fig.hidden_size,
+0000d130: 2063 6f6e 6669 672e 6869 6464 656e 5f73   config.hidden_s
+0000d140: 697a 6529 2066 6f72 205f 2069 6e20 7261  ize) for _ in ra
+0000d150: 6e67 6528 636f 6e66 6967 2e6e 756d 5f68  nge(config.num_h
+0000d160: 6964 6465 6e5f 6c61 7965 7273 295d 0a20  idden_layers)]. 
+0000d170: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+0000d180: 2020 2020 2020 7365 6c66 2e74 6f6b 656e        self.token
+0000d190: 5f74 7970 655f 656d 6265 6464 696e 6773  _type_embeddings
+0000d1a0: 203d 206e 6e2e 456d 6265 6464 696e 6728   = nn.Embedding(
+0000d1b0: 322c 2063 6f6e 6669 672e 6869 6464 656e  2, config.hidden
+0000d1c0: 5f73 697a 6529 0a0a 2020 2020 2020 2020  _size)..        
+0000d1d0: 7365 6c66 2e76 6973 696f 6e5f 6d6f 6465  self.vision_mode
+0000d1e0: 6c20 3d20 4272 6964 6765 546f 7765 7256  l = BridgeTowerV
+0000d1f0: 6973 696f 6e4d 6f64 656c 2876 6973 696f  isionModel(visio
+0000d200: 6e5f 636f 6e66 6967 290a 0a20 2020 2020  n_config)..     
+0000d210: 2020 2073 656c 662e 7465 7874 5f6d 6f64     self.text_mod
+0000d220: 656c 203d 2042 7269 6467 6554 6f77 6572  el = BridgeTower
+0000d230: 5465 7874 4d6f 6465 6c28 7465 7874 5f63  TextModel(text_c
+0000d240: 6f6e 6669 6729 0a0a 2020 2020 2020 2020  onfig)..        
+0000d250: 6966 206e 6f74 2076 6973 696f 6e5f 636f  if not vision_co
+0000d260: 6e66 6967 2e73 6861 7265 5f6c 6179 6572  nfig.share_layer
+0000d270: 6e6f 726d 2061 6e64 2063 6f6e 6669 672e  norm and config.
+0000d280: 696e 6974 5f6c 6179 6572 6e6f 726d 5f66  init_layernorm_f
+0000d290: 726f 6d5f 7669 7369 6f6e 5f65 6e63 6f64  rom_vision_encod
+0000d2a0: 6572 3a0a 2020 2020 2020 2020 2020 2020  er:.            
+0000d2b0: 666f 7220 6c6e 2069 6e20 7365 6c66 2e76  for ln in self.v
+0000d2c0: 6973 696f 6e5f 6d6f 6465 6c2e 7669 7375  ision_model.visu
+0000d2d0: 616c 2e63 726f 7373 5f6d 6f64 616c 5f6c  al.cross_modal_l
+0000d2e0: 6e5f 7365 7061 7261 7465 3a0a 2020 2020  n_separate:.    
+0000d2f0: 2020 2020 2020 2020 2020 2020 6c6e 2e77              ln.w
+0000d300: 6569 6768 742e 6461 7461 203d 2073 656c  eight.data = sel
+0000d310: 662e 7669 7369 6f6e 5f6d 6f64 656c 2e76  f.vision_model.v
+0000d320: 6973 7561 6c2e 6c6e 5f70 6f73 742e 7765  isual.ln_post.we
+0000d330: 6967 6874 2e64 6174 610a 2020 2020 2020  ight.data.      
+0000d340: 2020 2020 2020 2020 2020 6c6e 2e62 6961            ln.bia
+0000d350: 732e 6461 7461 203d 2073 656c 662e 7669  s.data = self.vi
+0000d360: 7369 6f6e 5f6d 6f64 656c 2e76 6973 7561  sion_model.visua
+0000d370: 6c2e 6c6e 5f70 6f73 742e 6269 6173 2e64  l.ln_post.bias.d
+0000d380: 6174 610a 0a20 2020 2020 2020 2073 656c  ata..        sel
+0000d390: 662e 6372 6f73 735f 6d6f 6461 6c5f 696d  f.cross_modal_im
+0000d3a0: 6167 655f 6c61 7965 7273 203d 206e 6e2e  age_layers = nn.
+0000d3b0: 4365 6c6c 4c69 7374 280a 2020 2020 2020  CellList(.      
+0000d3c0: 2020 2020 2020 5b42 7269 6467 6554 6f77        [BridgeTow
+0000d3d0: 6572 4265 7274 4372 6f73 734c 6179 6572  erBertCrossLayer
+0000d3e0: 2874 6578 745f 636f 6e66 6967 2920 666f  (text_config) fo
+0000d3f0: 7220 5f20 696e 2072 616e 6765 2863 6f6e  r _ in range(con
+0000d400: 6669 672e 6e75 6d5f 6869 6464 656e 5f6c  fig.num_hidden_l
+0000d410: 6179 6572 7329 5d0a 2020 2020 2020 2020  ayers)].        
+0000d420: 290a 2020 2020 2020 2020 7365 6c66 2e63  ).        self.c
+0000d430: 726f 7373 5f6d 6f64 616c 5f74 6578 745f  ross_modal_text_
+0000d440: 6c61 7965 7273 203d 206e 6e2e 4365 6c6c  layers = nn.Cell
+0000d450: 4c69 7374 280a 2020 2020 2020 2020 2020  List(.          
+0000d460: 2020 5b42 7269 6467 6554 6f77 6572 4265    [BridgeTowerBe
+0000d470: 7274 4372 6f73 734c 6179 6572 2874 6578  rtCrossLayer(tex
+0000d480: 745f 636f 6e66 6967 2920 666f 7220 5f20  t_config) for _ 
+0000d490: 696e 2072 616e 6765 2863 6f6e 6669 672e  in range(config.
+0000d4a0: 6e75 6d5f 6869 6464 656e 5f6c 6179 6572  num_hidden_layer
+0000d4b0: 7329 5d0a 2020 2020 2020 2020 290a 0a20  s)].        ).. 
+0000d4c0: 2020 2020 2020 2023 2043 6c61 7373 2074         # Class t
+0000d4d0: 6f6b 656e 203d 3e20 4c69 6e65 6172 203d  oken => Linear =
+0000d4e0: 3e20 5461 6e68 0a20 2020 2020 2020 2073  > Tanh.        s
+0000d4f0: 656c 662e 6372 6f73 735f 6d6f 6461 6c5f  elf.cross_modal_
+0000d500: 696d 6167 655f 706f 6f6c 6572 203d 2042  image_pooler = B
+0000d510: 7269 6467 6554 6f77 6572 506f 6f6c 6572  ridgeTowerPooler
+0000d520: 2863 6f6e 6669 6729 0a20 2020 2020 2020  (config).       
+0000d530: 2073 656c 662e 6372 6f73 735f 6d6f 6461   self.cross_moda
+0000d540: 6c5f 7465 7874 5f70 6f6f 6c65 7220 3d20  l_text_pooler = 
+0000d550: 4272 6964 6765 546f 7765 7250 6f6f 6c65  BridgeTowerPoole
+0000d560: 7228 636f 6e66 6967 290a 0a20 2020 2020  r(config)..     
+0000d570: 2020 2023 2049 6e69 7469 616c 697a 6520     # Initialize 
+0000d580: 4272 6964 6765 546f 7765 7220 436f 6d70  BridgeTower Comp
+0000d590: 6f6e 656e 7473 0a20 2020 2020 2020 2073  onents.        s
+0000d5a0: 656c 662e 6372 6f73 735f 6d6f 6461 6c5f  elf.cross_modal_
+0000d5b0: 7465 7874 5f6c 6179 6572 6e6f 726d 203d  text_layernorm =
+0000d5c0: 206e 6e2e 4c61 7965 724e 6f72 6d28 636f   nn.LayerNorm(co
+0000d5d0: 6e66 6967 2e68 6964 6465 6e5f 7369 7a65  nfig.hidden_size
+0000d5e0: 2c20 6570 7369 6c6f 6e3d 636f 6e66 6967  , epsilon=config
+0000d5f0: 2e6c 6179 6572 5f6e 6f72 6d5f 6570 7329  .layer_norm_eps)
+0000d600: 0a20 2020 2020 2020 2073 656c 662e 6372  .        self.cr
+0000d610: 6f73 735f 6d6f 6461 6c5f 696d 6167 655f  oss_modal_image_
+0000d620: 6c61 7965 726e 6f72 6d20 3d20 6e6e 2e4c  layernorm = nn.L
+0000d630: 6179 6572 4e6f 726d 2863 6f6e 6669 672e  ayerNorm(config.
+0000d640: 6869 6464 656e 5f73 697a 652c 2065 7073  hidden_size, eps
+0000d650: 696c 6f6e 3d63 6f6e 6669 672e 6c61 7965  ilon=config.laye
+0000d660: 725f 6e6f 726d 5f65 7073 290a 0a20 2020  r_norm_eps)..   
+0000d670: 2020 2020 2069 6620 636f 6e66 6967 2e73       if config.s
+0000d680: 6861 7265 5f6c 696e 6b5f 746f 7765 725f  hare_link_tower_
+0000d690: 6c61 7965 7273 3a0a 2020 2020 2020 2020  layers:.        
+0000d6a0: 2020 2020 7365 6c66 2e63 726f 7373 5f6d      self.cross_m
+0000d6b0: 6f64 616c 5f74 6578 745f 6c69 6e6b 5f74  odal_text_link_t
+0000d6c0: 6f77 6572 203d 2042 7269 6467 6554 6f77  ower = BridgeTow
+0000d6d0: 6572 4c69 6e6b 546f 7765 7228 636f 6e66  erLinkTower(conf
+0000d6e0: 6967 290a 2020 2020 2020 2020 2020 2020  ig).            
+0000d6f0: 7365 6c66 2e63 726f 7373 5f6d 6f64 616c  self.cross_modal
+0000d700: 5f69 6d61 6765 5f6c 696e 6b5f 746f 7765  _image_link_towe
+0000d710: 7220 3d20 4272 6964 6765 546f 7765 724c  r = BridgeTowerL
+0000d720: 696e 6b54 6f77 6572 2863 6f6e 6669 6729  inkTower(config)
+0000d730: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0000d740: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000d750: 6372 6f73 735f 6d6f 6461 6c5f 7465 7874  cross_modal_text
+0000d760: 5f6c 696e 6b5f 746f 7765 7220 3d20 6e6e  _link_tower = nn
+0000d770: 2e43 656c 6c4c 6973 7428 0a20 2020 2020  .CellList(.     
+0000d780: 2020 2020 2020 2020 2020 205b 4272 6964             [Brid
+0000d790: 6765 546f 7765 724c 696e 6b54 6f77 6572  geTowerLinkTower
+0000d7a0: 2863 6f6e 6669 6729 2066 6f72 205f 2069  (config) for _ i
+0000d7b0: 6e20 7261 6e67 6528 636f 6e66 6967 2e6e  n range(config.n
+0000d7c0: 756d 5f68 6964 6465 6e5f 6c61 7965 7273  um_hidden_layers
+0000d7d0: 202d 2031 295d 0a20 2020 2020 2020 2020   - 1)].         
+0000d7e0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0000d7f0: 2073 656c 662e 6372 6f73 735f 6d6f 6461   self.cross_moda
+0000d800: 6c5f 696d 6167 655f 6c69 6e6b 5f74 6f77  l_image_link_tow
+0000d810: 6572 203d 206e 6e2e 4365 6c6c 4c69 7374  er = nn.CellList
+0000d820: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000d830: 2020 5b42 7269 6467 6554 6f77 6572 4c69    [BridgeTowerLi
+0000d840: 6e6b 546f 7765 7228 636f 6e66 6967 2920  nkTower(config) 
+0000d850: 666f 7220 5f20 696e 2072 616e 6765 2863  for _ in range(c
+0000d860: 6f6e 6669 672e 6e75 6d5f 6869 6464 656e  onfig.num_hidden
+0000d870: 5f6c 6179 6572 7320 2d20 3129 5d0a 2020  _layers - 1)].  
+0000d880: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+0000d890: 2020 2020 2073 656c 662e 706f 7374 5f69       self.post_i
+0000d8a0: 6e69 7428 290a 0a20 2020 2064 6566 2067  nit()..    def g
+0000d8b0: 6574 5f69 6e70 7574 5f65 6d62 6564 6469  et_input_embeddi
+0000d8c0: 6e67 7328 7365 6c66 293a 0a20 2020 2020  ngs(self):.     
+0000d8d0: 2020 2072 6574 7572 6e20 7365 6c66 2e74     return self.t
+0000d8e0: 6578 745f 6d6f 6465 6c2e 6765 745f 696e  ext_model.get_in
+0000d8f0: 7075 745f 656d 6265 6464 696e 6773 2829  put_embeddings()
+0000d900: 0a0a 2020 2020 6465 6620 7365 745f 696e  ..    def set_in
+0000d910: 7075 745f 656d 6265 6464 696e 6773 2873  put_embeddings(s
+0000d920: 656c 662c 2076 616c 7565 293a 0a20 2020  elf, value):.   
+0000d930: 2020 2020 2073 656c 662e 7465 7874 5f6d       self.text_m
+0000d940: 6f64 656c 2e73 6574 5f69 6e70 7574 5f65  odel.set_input_e
+0000d950: 6d62 6564 6469 6e67 7328 7661 6c75 6529  mbeddings(value)
+0000d960: 0a0a 2020 2020 6465 6620 636f 6e73 7472  ..    def constr
+0000d970: 7563 7428 0a20 2020 2020 2020 2073 656c  uct(.        sel
+0000d980: 662c 0a20 2020 2020 2020 2069 6e70 7574  f,.        input
+0000d990: 5f69 6473 3a20 4f70 7469 6f6e 616c 5b6d  _ids: Optional[m
+0000d9a0: 696e 6473 706f 7265 2e54 656e 736f 725d  indspore.Tensor]
+0000d9b0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+0000d9c0: 2061 7474 656e 7469 6f6e 5f6d 6173 6b3a   attention_mask:
+0000d9d0: 204f 7074 696f 6e61 6c5b 6d69 6e64 7370   Optional[mindsp
+0000d9e0: 6f72 652e 5465 6e73 6f72 5d20 3d20 4e6f  ore.Tensor] = No
+0000d9f0: 6e65 2c0a 2020 2020 2020 2020 746f 6b65  ne,.        toke
+0000da00: 6e5f 7479 7065 5f69 6473 3a20 4f70 7469  n_type_ids: Opti
+0000da10: 6f6e 616c 5b6d 696e 6473 706f 7265 2e54  onal[mindspore.T
+0000da20: 656e 736f 725d 203d 204e 6f6e 652c 0a20  ensor] = None,. 
+0000da30: 2020 2020 2020 2070 6978 656c 5f76 616c         pixel_val
+0000da40: 7565 733a 204f 7074 696f 6e61 6c5b 6d69  ues: Optional[mi
+0000da50: 6e64 7370 6f72 652e 5465 6e73 6f72 5d20  ndspore.Tensor] 
+0000da60: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+0000da70: 7069 7865 6c5f 6d61 736b 3a20 4f70 7469  pixel_mask: Opti
+0000da80: 6f6e 616c 5b6d 696e 6473 706f 7265 2e54  onal[mindspore.T
+0000da90: 656e 736f 725d 203d 204e 6f6e 652c 0a20  ensor] = None,. 
+0000daa0: 2020 2020 2020 2068 6561 645f 6d61 736b         head_mask
+0000dab0: 3a20 4f70 7469 6f6e 616c 5b6d 696e 6473  : Optional[minds
+0000dac0: 706f 7265 2e54 656e 736f 725d 203d 204e  pore.Tensor] = N
+0000dad0: 6f6e 652c 0a20 2020 2020 2020 2069 6e70  one,.        inp
+0000dae0: 7574 735f 656d 6265 6473 3a20 4f70 7469  uts_embeds: Opti
+0000daf0: 6f6e 616c 5b6d 696e 6473 706f 7265 2e54  onal[mindspore.T
+0000db00: 656e 736f 725d 203d 204e 6f6e 652c 0a20  ensor] = None,. 
+0000db10: 2020 2020 2020 2069 6d61 6765 5f65 6d62         image_emb
+0000db20: 6564 733a 204f 7074 696f 6e61 6c5b 6d69  eds: Optional[mi
+0000db30: 6e64 7370 6f72 652e 5465 6e73 6f72 5d20  ndspore.Tensor] 
+0000db40: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+0000db50: 696d 6167 655f 746f 6b65 6e5f 7479 7065  image_token_type
+0000db60: 5f69 6478 3a20 4f70 7469 6f6e 616c 5b69  _idx: Optional[i
+0000db70: 6e74 5d20 3d20 4e6f 6e65 2c0a 2020 2020  nt] = None,.    
+0000db80: 2020 2020 6f75 7470 7574 5f61 7474 656e      output_atten
+0000db90: 7469 6f6e 733a 204f 7074 696f 6e61 6c5b  tions: Optional[
+0000dba0: 626f 6f6c 5d20 3d20 4e6f 6e65 2c0a 2020  bool] = None,.  
+0000dbb0: 2020 2020 2020 6f75 7470 7574 5f68 6964        output_hid
+0000dbc0: 6465 6e5f 7374 6174 6573 3a20 4f70 7469  den_states: Opti
+0000dbd0: 6f6e 616c 5b62 6f6f 6c5d 203d 204e 6f6e  onal[bool] = Non
+0000dbe0: 652c 0a20 2020 2020 2020 2072 6574 7572  e,.        retur
+0000dbf0: 6e5f 6469 6374 3a20 4f70 7469 6f6e 616c  n_dict: Optional
+0000dc00: 5b62 6f6f 6c5d 203d 204e 6f6e 652c 0a20  [bool] = None,. 
+0000dc10: 2020 2020 2020 206c 6162 656c 733a 204f         labels: O
+0000dc20: 7074 696f 6e61 6c5b 6d69 6e64 7370 6f72  ptional[mindspor
+0000dc30: 652e 5465 6e73 6f72 5d20 3d20 4e6f 6e65  e.Tensor] = None
+0000dc40: 2c0a 2020 2020 2920 2d3e 2055 6e69 6f6e  ,.    ) -> Union
+0000dc50: 5b54 7570 6c65 5b6d 696e 6473 706f 7265  [Tuple[mindspore
+0000dc60: 2e54 656e 736f 725d 2c20 4272 6964 6765  .Tensor], Bridge
+0000dc70: 546f 7765 724d 6f64 656c 4f75 7470 7574  TowerModelOutput
+0000dc80: 5d3a 0a20 2020 2020 2020 2072 2222 220a  ]:.        r""".
+0000dc90: 2020 2020 2020 2020 6f75 7470 7574 5f68          output_h
+0000dca0: 6964 6465 6e5f 7374 6174 6573 2028 6062  idden_states (`b
+0000dcb0: 6f6f 6c60 2c20 2a6f 7074 696f 6e61 6c2a  ool`, *optional*
+0000dcc0: 293a 0a20 2020 2020 2020 2020 2020 2049  ):.            I
+0000dcd0: 6620 7365 7420 746f 2060 5472 7565 602c  f set to `True`,
+0000dce0: 2068 6964 6465 6e20 7374 6174 6573 2061   hidden states a
+0000dcf0: 7265 2072 6574 7572 6e65 6420 6173 2061  re returned as a
+0000dd00: 206c 6973 7420 636f 6e74 6169 6e69 6e67   list containing
+0000dd10: 2074 6865 2068 6964 6465 6e20 7374 6174   the hidden stat
+0000dd20: 6573 206f 6620 7465 7874 2c20 696d 6167  es of text, imag
+0000dd30: 652c 2061 6e64 0a20 2020 2020 2020 2020  e, and.         
+0000dd40: 2020 2063 726f 7373 2d6d 6f64 616c 2063     cross-modal c
+0000dd50: 6f6d 706f 6e65 6e74 7320 7265 7370 6563  omponents respec
+0000dd60: 7469 7665 6c79 2e20 692e 652e 2060 2868  tively. i.e. `(h
+0000dd70: 6964 6465 6e5f 7374 6174 6573 5f74 6578  idden_states_tex
+0000dd80: 742c 2068 6964 6465 6e5f 7374 6174 6573  t, hidden_states
+0000dd90: 5f69 6d61 6765 2c0a 2020 2020 2020 2020  _image,.        
+0000dda0: 2020 2020 6869 6464 656e 5f73 7461 7465      hidden_state
+0000ddb0: 735f 6372 6f73 735f 6d6f 6461 6c29 6020  s_cross_modal)` 
+0000ddc0: 7768 6572 6520 6561 6368 2065 6c65 6d65  where each eleme
+0000ddd0: 6e74 2069 7320 6120 6c69 7374 206f 6620  nt is a list of 
+0000dde0: 7468 6520 6869 6464 656e 2073 7461 7465  the hidden state
+0000ddf0: 7320 6f66 2074 6865 2063 6f72 7265 7370  s of the corresp
+0000de00: 6f6e 6469 6e67 0a20 2020 2020 2020 2020  onding.         
+0000de10: 2020 206d 6f64 616c 6974 792e 2060 6869     modality. `hi
+0000de20: 6464 656e 5f73 7461 7465 735f 7478 742f  dden_states_txt/
+0000de30: 696d 6760 2061 7265 2061 206c 6973 7420  img` are a list 
+0000de40: 6f66 2074 656e 736f 7273 2063 6f72 7265  of tensors corre
+0000de50: 7370 6f6e 6469 6e67 2074 6f20 756e 696d  sponding to unim
+0000de60: 6f64 616c 2068 6964 6465 6e20 7374 6174  odal hidden stat
+0000de70: 6573 2061 6e64 0a20 2020 2020 2020 2020  es and.         
+0000de80: 2020 2060 6869 6464 656e 5f73 7461 7465     `hidden_state
+0000de90: 735f 6372 6f73 735f 6d6f 6461 6c60 2069  s_cross_modal` i
+0000dea0: 7320 6120 6c69 7374 206f 6620 7475 706c  s a list of tupl
+0000deb0: 6573 2063 6f6e 7461 696e 696e 6720 6063  es containing `c
+0000dec0: 726f 7373 5f6d 6f64 616c 5f74 6578 745f  ross_modal_text_
+0000ded0: 6869 6464 656e 5f73 7461 7465 7360 2061  hidden_states` a
+0000dee0: 6e64 0a20 2020 2020 2020 2020 2020 2060  nd.            `
+0000def0: 6372 6f73 735f 6d6f 6461 6c5f 696d 6167  cross_modal_imag
+0000df00: 655f 6869 6464 656e 5f73 7461 7465 7360  e_hidden_states`
+0000df10: 206f 6620 6561 6368 2062 7264 6967 6520   of each brdige 
+0000df20: 6c61 7965 722e 0a20 2020 2020 2020 206c  layer..        l
+0000df30: 6162 656c 7320 2860 6d69 6e64 7370 6f72  abels (`mindspor
+0000df40: 652e 5465 6e73 6f72 6020 6f66 2073 6861  e.Tensor` of sha
+0000df50: 7065 2060 2862 6174 6368 5f73 697a 652c  pe `(batch_size,
+0000df60: 2960 2c20 2a6f 7074 696f 6e61 6c2a 293a  )`, *optional*):
+0000df70: 0a20 2020 2020 2020 2020 2020 204c 6162  .            Lab
+0000df80: 656c 7320 6172 6520 6375 7272 656e 746c  els are currentl
+0000df90: 7920 6e6f 7420 7375 7070 6f72 7465 642e  y not supported.
+0000dfa0: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
+0000dfb0: 3a0a 0a20 2020 2020 2020 2045 7861 6d70  :..        Examp
+0000dfc0: 6c65 733a 0a0a 2020 2020 2020 2020 6060  les:..        ``
+0000dfd0: 6070 7974 686f 6e0a 2020 2020 2020 2020  `python.        
+0000dfe0: 3e3e 3e20 6672 6f6d 2074 7261 6e73 666f  >>> from transfo
+0000dff0: 726d 6572 7320 696d 706f 7274 2042 7269  rmers import Bri
+0000e000: 6467 6554 6f77 6572 5072 6f63 6573 736f  dgeTowerProcesso
+0000e010: 722c 2042 7269 6467 6554 6f77 6572 4d6f  r, BridgeTowerMo
+0000e020: 6465 6c0a 2020 2020 2020 2020 3e3e 3e20  del.        >>> 
+0000e030: 6672 6f6d 2050 494c 2069 6d70 6f72 7420  from PIL import 
+0000e040: 496d 6167 650a 2020 2020 2020 2020 3e3e  Image.        >>
+0000e050: 3e20 696d 706f 7274 2072 6571 7565 7374  > import request
+0000e060: 730a 0a20 2020 2020 2020 203e 3e3e 2023  s..        >>> #
+0000e070: 2070 7265 7061 7265 2069 6d61 6765 2061   prepare image a
+0000e080: 6e64 2074 6578 740a 2020 2020 2020 2020  nd text.        
+0000e090: 3e3e 3e20 7572 6c20 3d20 2268 7474 703a  >>> url = "http:
+0000e0a0: 2f2f 696d 6167 6573 2e63 6f63 6f64 6174  //images.cocodat
+0000e0b0: 6173 6574 2e6f 7267 2f76 616c 3230 3137  aset.org/val2017
+0000e0c0: 2f30 3030 3030 3030 3339 3736 392e 6a70  /000000039769.jp
+0000e0d0: 6722 0a20 2020 2020 2020 203e 3e3e 2069  g".        >>> i
+0000e0e0: 6d61 6765 203d 2049 6d61 6765 2e6f 7065  mage = Image.ope
+0000e0f0: 6e28 7265 7175 6573 7473 2e67 6574 2875  n(requests.get(u
+0000e100: 726c 2c20 7374 7265 616d 3d54 7275 6529  rl, stream=True)
+0000e110: 2e72 6177 290a 2020 2020 2020 2020 3e3e  .raw).        >>
+0000e120: 3e20 7465 7874 203d 2022 6865 6c6c 6f20  > text = "hello 
+0000e130: 776f 726c 6422 0a20 2020 2020 2020 203e  world".        >
+0000e140: 3e3e 2070 726f 6365 7373 6f72 203d 2042  >> processor = B
+0000e150: 7269 6467 6554 6f77 6572 5072 6f63 6573  ridgeTowerProces
+0000e160: 736f 722e 6672 6f6d 5f70 7265 7472 6169  sor.from_pretrai
+0000e170: 6e65 6428 2242 7269 6467 6554 6f77 6572  ned("BridgeTower
+0000e180: 2f62 7269 6467 6574 6f77 6572 2d62 6173  /bridgetower-bas
+0000e190: 6522 290a 2020 2020 2020 2020 3e3e 3e20  e").        >>> 
+0000e1a0: 6d6f 6465 6c20 3d20 4272 6964 6765 546f  model = BridgeTo
+0000e1b0: 7765 724d 6f64 656c 2e66 726f 6d5f 7072  werModel.from_pr
+0000e1c0: 6574 7261 696e 6564 2822 4272 6964 6765  etrained("Bridge
+0000e1d0: 546f 7765 722f 6272 6964 6765 746f 7765  Tower/bridgetowe
+0000e1e0: 722d 6261 7365 2229 0a0a 2020 2020 2020  r-base")..      
+0000e1f0: 2020 3e3e 3e20 696e 7075 7473 203d 2070    >>> inputs = p
+0000e200: 726f 6365 7373 6f72 2869 6d61 6765 2c20  rocessor(image, 
+0000e210: 7465 7874 2c20 7265 7475 726e 5f74 656e  text, return_ten
+0000e220: 736f 7273 3d22 7074 2229 0a20 2020 2020  sors="pt").     
+0000e230: 2020 203e 3e3e 206f 7574 7075 7473 203d     >>> outputs =
+0000e240: 206d 6f64 656c 282a 2a69 6e70 7574 7329   model(**inputs)
+0000e250: 0a20 2020 2020 2020 203e 3e3e 206f 7574  .        >>> out
+0000e260: 7075 7473 2e6b 6579 7328 290a 2020 2020  puts.keys().    
+0000e270: 2020 2020 6f64 6963 745f 6b65 7973 285b      odict_keys([
+0000e280: 2774 6578 745f 6665 6174 7572 6573 272c  'text_features',
+0000e290: 2027 696d 6167 655f 6665 6174 7572 6573   'image_features
+0000e2a0: 272c 2027 706f 6f6c 6572 5f6f 7574 7075  ', 'pooler_outpu
+0000e2b0: 7427 5d29 0a20 2020 2020 2020 2060 6060  t']).        ```
+0000e2c0: 2222 220a 2020 2020 2020 2020 6f75 7470  """.        outp
+0000e2d0: 7574 5f61 7474 656e 7469 6f6e 7320 3d20  ut_attentions = 
+0000e2e0: 6f75 7470 7574 5f61 7474 656e 7469 6f6e  output_attention
+0000e2f0: 7320 6966 206f 7574 7075 745f 6174 7465  s if output_atte
+0000e300: 6e74 696f 6e73 2069 7320 6e6f 7420 4e6f  ntions is not No
+0000e310: 6e65 2065 6c73 6520 7365 6c66 2e63 6f6e  ne else self.con
+0000e320: 6669 672e 6f75 7470 7574 5f61 7474 656e  fig.output_atten
+0000e330: 7469 6f6e 730a 2020 2020 2020 2020 6f75  tions.        ou
+0000e340: 7470 7574 5f68 6964 6465 6e5f 7374 6174  tput_hidden_stat
+0000e350: 6573 203d 2028 0a20 2020 2020 2020 2020  es = (.         
+0000e360: 2020 206f 7574 7075 745f 6869 6464 656e     output_hidden
+0000e370: 5f73 7461 7465 7320 6966 206f 7574 7075  _states if outpu
+0000e380: 745f 6869 6464 656e 5f73 7461 7465 7320  t_hidden_states 
+0000e390: 6973 206e 6f74 204e 6f6e 6520 656c 7365  is not None else
+0000e3a0: 2073 656c 662e 636f 6e66 6967 2e6f 7574   self.config.out
+0000e3b0: 7075 745f 6869 6464 656e 5f73 7461 7465  put_hidden_state
+0000e3c0: 730a 2020 2020 2020 2020 290a 2020 2020  s.        ).    
+0000e3d0: 2020 2020 616c 6c5f 6869 6464 656e 5f73      all_hidden_s
+0000e3e0: 7461 7465 735f 7465 7874 203d 2028 2920  tates_text = () 
+0000e3f0: 6966 206f 7574 7075 745f 6869 6464 656e  if output_hidden
+0000e400: 5f73 7461 7465 7320 656c 7365 204e 6f6e  _states else Non
+0000e410: 650a 2020 2020 2020 2020 616c 6c5f 6869  e.        all_hi
+0000e420: 6464 656e 5f73 7461 7465 735f 696d 6167  dden_states_imag
+0000e430: 6520 3d20 2829 2069 6620 6f75 7470 7574  e = () if output
+0000e440: 5f68 6964 6465 6e5f 7374 6174 6573 2065  _hidden_states e
+0000e450: 6c73 6520 4e6f 6e65 0a20 2020 2020 2020  lse None.       
+0000e460: 2061 6c6c 5f68 6964 6465 6e5f 7374 6174   all_hidden_stat
+0000e470: 6573 5f63 726f 7373 203d 2028 2920 6966  es_cross = () if
+0000e480: 206f 7574 7075 745f 6869 6464 656e 5f73   output_hidden_s
+0000e490: 7461 7465 7320 656c 7365 204e 6f6e 650a  tates else None.
+0000e4a0: 2020 2020 2020 2020 616c 6c5f 6869 6464          all_hidd
+0000e4b0: 656e 5f73 7461 7465 7320 3d20 2829 2069  en_states = () i
+0000e4c0: 6620 6f75 7470 7574 5f68 6964 6465 6e5f  f output_hidden_
+0000e4d0: 7374 6174 6573 2065 6c73 6520 4e6f 6e65  states else None
+0000e4e0: 0a20 2020 2020 2020 2061 6c6c 5f73 656c  .        all_sel
+0000e4f0: 665f 6174 7465 6e74 696f 6e73 203d 2028  f_attentions = (
+0000e500: 2920 6966 206f 7574 7075 745f 6174 7465  ) if output_atte
+0000e510: 6e74 696f 6e73 2065 6c73 6520 4e6f 6e65  ntions else None
+0000e520: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
+0000e530: 5f64 6963 7420 3d20 7265 7475 726e 5f64  _dict = return_d
+0000e540: 6963 7420 6966 2072 6574 7572 6e5f 6469  ict if return_di
+0000e550: 6374 2069 7320 6e6f 7420 4e6f 6e65 2065  ct is not None e
+0000e560: 6c73 6520 7365 6c66 2e63 6f6e 6669 672e  lse self.config.
+0000e570: 7573 655f 7265 7475 726e 5f64 6963 740a  use_return_dict.
+0000e580: 2020 2020 2020 2020 696d 6167 655f 746f          image_to
+0000e590: 6b65 6e5f 7479 7065 5f69 6478 203d 2069  ken_type_idx = i
+0000e5a0: 6d61 6765 5f74 6f6b 656e 5f74 7970 655f  mage_token_type_
+0000e5b0: 6964 7820 6966 2069 6d61 6765 5f74 6f6b  idx if image_tok
+0000e5c0: 656e 5f74 7970 655f 6964 7820 656c 7365  en_type_idx else
+0000e5d0: 2031 0a20 2020 2020 2020 2069 6e70 7574   1.        input
+0000e5e0: 5f73 6861 7065 203d 2069 6e70 7574 5f69  _shape = input_i
+0000e5f0: 6473 2e73 6861 7065 0a20 2020 2020 2020  ds.shape.       
+0000e600: 2074 6578 745f 656d 6265 6473 203d 2073   text_embeds = s
+0000e610: 656c 662e 7465 7874 5f6d 6f64 656c 2e65  elf.text_model.e
+0000e620: 6d62 6564 6469 6e67 7328 696e 7075 745f  mbeddings(input_
+0000e630: 6964 733d 696e 7075 745f 6964 7329 0a0a  ids=input_ids)..
+0000e640: 2020 2020 2020 2020 6966 206f 7574 7075          if outpu
+0000e650: 745f 6869 6464 656e 5f73 7461 7465 733a  t_hidden_states:
+0000e660: 0a20 2020 2020 2020 2020 2020 2061 6c6c  .            all
+0000e670: 5f68 6964 6465 6e5f 7374 6174 6573 5f74  _hidden_states_t
+0000e680: 6578 7420 2b3d 2028 7465 7874 5f65 6d62  ext += (text_emb
+0000e690: 6564 732c 290a 0a20 2020 2020 2020 2069  eds,)..        i
+0000e6a0: 6620 6174 7465 6e74 696f 6e5f 6d61 736b  f attention_mask
+0000e6b0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0000e6c0: 2020 2020 2020 6174 7465 6e74 696f 6e5f        attention_
+0000e6d0: 6d61 736b 203d 206f 7073 2e6f 6e65 7328  mask = ops.ones(
+0000e6e0: 696e 7075 745f 7368 6170 652c 2064 7479  input_shape, dty
+0000e6f0: 7065 3d6d 696e 6473 706f 7265 2e69 6e74  pe=mindspore.int
+0000e700: 3634 290a 2020 2020 2020 2020 6578 7465  64).        exte
+0000e710: 6e64 5f74 6578 745f 6d61 736b 7320 3d20  nd_text_masks = 
+0000e720: 7365 6c66 2e74 6578 745f 6d6f 6465 6c2e  self.text_model.
+0000e730: 6765 745f 6578 7465 6e64 6564 5f61 7474  get_extended_att
+0000e740: 656e 7469 6f6e 5f6d 6173 6b28 6174 7465  ention_mask(atte
+0000e750: 6e74 696f 6e5f 6d61 736b 2c20 696e 7075  ntion_mask, inpu
+0000e760: 745f 7368 6170 6529 0a0a 2020 2020 2020  t_shape)..      
+0000e770: 2020 2320 5468 6520 7370 6c69 745f 696e    # The split_in
+0000e780: 6465 7820 6465 7465 726d 696e 6573 2068  dex determines h
+0000e790: 6f77 206d 616e 7920 6c61 7965 7273 206f  ow many layers o
+0000e7a0: 6620 7468 6520 756e 692d 6d6f 6461 6c20  f the uni-modal 
+0000e7b0: 656e 636f 6465 7220 6172 6520 6170 706c  encoder are appl
+0000e7c0: 6965 6420 6265 666f 7265 2074 6865 2063  ied before the c
+0000e7d0: 726f 7373 2d6d 6f64 616c 2065 6e63 6f64  ross-modal encod
+0000e7e0: 6572 0a20 2020 2020 2020 2073 706c 6974  er.        split
+0000e7f0: 5f69 6e64 6578 203d 206c 656e 2873 656c  _index = len(sel
+0000e800: 662e 7465 7874 5f6d 6f64 656c 2e65 6e63  f.text_model.enc
+0000e810: 6f64 6572 2e6c 6179 6572 2920 2d20 7365  oder.layer) - se
+0000e820: 6c66 2e63 6f6e 6669 672e 6e75 6d5f 6869  lf.config.num_hi
+0000e830: 6464 656e 5f6c 6179 6572 7320 2b20 310a  dden_layers + 1.
+0000e840: 0a20 2020 2020 2020 2023 2052 756e 2074  .        # Run t
+0000e850: 6865 2066 6972 7374 2027 7370 6c69 745f  he first 'split_
+0000e860: 696e 6465 7827 206c 6179 6572 7320 6f66  index' layers of
+0000e870: 2074 6865 2074 6578 7475 616c 2065 6e63   the textual enc
+0000e880: 6f64 6572 0a20 2020 2020 2020 2066 6f72  oder.        for
+0000e890: 206c 6179 6572 2069 6e20 7365 6c66 2e74   layer in self.t
+0000e8a0: 6578 745f 6d6f 6465 6c2e 656e 636f 6465  ext_model.encode
+0000e8b0: 722e 6c61 7965 725b 3a73 706c 6974 5f69  r.layer[:split_i
+0000e8c0: 6e64 6578 5d3a 0a20 2020 2020 2020 2020  ndex]:.         
+0000e8d0: 2020 2074 6578 745f 656d 6265 6473 203d     text_embeds =
+0000e8e0: 206c 6179 6572 2874 6578 745f 656d 6265   layer(text_embe
+0000e8f0: 6473 2c20 6578 7465 6e64 5f74 6578 745f  ds, extend_text_
+0000e900: 6d61 736b 7329 5b30 5d0a 0a20 2020 2020  masks)[0]..     
+0000e910: 2020 2020 2020 2069 6620 6f75 7470 7574         if output
+0000e920: 5f68 6964 6465 6e5f 7374 6174 6573 3a0a  _hidden_states:.
+0000e930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e940: 616c 6c5f 6869 6464 656e 5f73 7461 7465  all_hidden_state
+0000e950: 735f 7465 7874 202b 3d20 2874 6578 745f  s_text += (text_
+0000e960: 656d 6265 6473 2c29 0a0a 2020 2020 2020  embeds,)..      
+0000e970: 2020 6966 2069 6d61 6765 5f65 6d62 6564    if image_embed
+0000e980: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
+0000e990: 2020 2020 2020 2069 6d61 6765 5f65 6d62         image_emb
+0000e9a0: 6564 7320 3d20 7365 6c66 2e76 6973 696f  eds = self.visio
+0000e9b0: 6e5f 6d6f 6465 6c2e 7669 7375 616c 2e63  n_model.visual.c
+0000e9c0: 6f6e 7374 7275 6374 5f70 7265 2870 6978  onstruct_pre(pix
+0000e9d0: 656c 5f76 616c 7565 732e 7479 7065 2873  el_values.type(s
+0000e9e0: 656c 662e 7669 7369 6f6e 5f6d 6f64 656c  elf.vision_model
+0000e9f0: 2e64 7479 7065 2929 0a20 2020 2020 2020  .dtype)).       
+0000ea00: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0000ea10: 2020 2023 2050 6572 6d75 7465 2061 7320     # Permute as 
+0000ea20: 4272 6964 6765 546f 7765 7252 6573 6964  BridgeTowerResid
+0000ea30: 7561 6c41 7474 656e 7469 6f6e 2068 6173  ualAttention has
+0000ea40: 2062 6174 6368 5f66 6972 7374 3d54 7275   batch_first=Tru
+0000ea50: 650a 2020 2020 2020 2020 2020 2020 696d  e.            im
+0000ea60: 6167 655f 656d 6265 6473 203d 2069 6d61  age_embeds = ima
+0000ea70: 6765 5f65 6d62 6564 732e 7065 726d 7574  ge_embeds.permut
+0000ea80: 6528 312c 2030 2c20 3229 0a0a 2020 2020  e(1, 0, 2)..    
+0000ea90: 2020 2020 6966 206f 7574 7075 745f 6869      if output_hi
+0000eaa0: 6464 656e 5f73 7461 7465 733a 0a20 2020  dden_states:.   
+0000eab0: 2020 2020 2020 2020 2061 6c6c 5f68 6964           all_hid
+0000eac0: 6465 6e5f 7374 6174 6573 5f69 6d61 6765  den_states_image
+0000ead0: 202b 3d20 2869 6d61 6765 5f65 6d62 6564   += (image_embed
+0000eae0: 732c 290a 0a20 2020 2020 2020 2023 2052  s,)..        # R
+0000eaf0: 756e 2074 6865 2066 6972 7374 2027 7370  un the first 'sp
+0000eb00: 6c69 745f 696e 6465 7827 206c 6179 6572  lit_index' layer
+0000eb10: 7320 6f66 2074 6865 2076 6973 7561 6c20  s of the visual 
+0000eb20: 656e 636f 6465 720a 2020 2020 2020 2020  encoder.        
+0000eb30: 666f 7220 626c 6f63 6b20 696e 2073 656c  for block in sel
+0000eb40: 662e 7669 7369 6f6e 5f6d 6f64 656c 2e76  f.vision_model.v
+0000eb50: 6973 7561 6c2e 7472 616e 7366 6f72 6d65  isual.transforme
+0000eb60: 722e 7265 7362 6c6f 636b 735b 3a73 706c  r.resblocks[:spl
+0000eb70: 6974 5f69 6e64 6578 5d3a 0a20 2020 2020  it_index]:.     
+0000eb80: 2020 2020 2020 2069 6d61 6765 5f65 6d62         image_emb
+0000eb90: 6564 7320 3d20 626c 6f63 6b28 696d 6167  eds = block(imag
+0000eba0: 655f 656d 6265 6473 290a 2020 2020 2020  e_embeds).      
+0000ebb0: 2020 2020 2020 6966 206f 7574 7075 745f        if output_
+0000ebc0: 6869 6464 656e 5f73 7461 7465 733a 0a20  hidden_states:. 
+0000ebd0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0000ebe0: 6c6c 5f68 6964 6465 6e5f 7374 6174 6573  ll_hidden_states
+0000ebf0: 5f69 6d61 6765 202b 3d20 2869 6d61 6765  _image += (image
+0000ec00: 5f65 6d62 6564 732c 290a 0a20 2020 2020  _embeds,)..     
+0000ec10: 2020 2069 6d61 6765 5f65 6d62 6564 735f     image_embeds_
+0000ec20: 7769 7468 5f6c 6e20 3d20 7365 6c66 2e76  with_ln = self.v
+0000ec30: 6973 696f 6e5f 6d6f 6465 6c2e 7669 7375  ision_model.visu
+0000ec40: 616c 2e63 6f6e 7374 7275 6374 5f70 6f73  al.construct_pos
+0000ec50: 7428 696d 6167 655f 656d 6265 6473 2e74  t(image_embeds.t
+0000ec60: 7970 6528 7365 6c66 2e76 6973 696f 6e5f  ype(self.vision_
+0000ec70: 6d6f 6465 6c2e 6474 7970 6529 290a 0a20  model.dtype)).. 
+0000ec80: 2020 2020 2020 2023 2066 6972 7374 206c         # first l
+0000ec90: 6179 6572 2069 7320 6120 7370 6563 6961  ayer is a specia
+0000eca0: 6c20 6361 7365 2062 6563 6175 7365 2077  l case because w
+0000ecb0: 6520 646f 6e27 7420 6861 7665 2074 6865  e don't have the
+0000ecc0: 206f 7574 7075 7420 6672 6f6d 2074 6865   output from the
+0000ecd0: 2063 726f 7373 2d65 6e63 6f64 6572 2079   cross-encoder y
+0000ece0: 6574 0a20 2020 2020 2020 2063 726f 7373  et.        cross
+0000ecf0: 5f6d 6f64 616c 5f74 6578 7420 3d20 7365  _modal_text = se
+0000ed00: 6c66 2e63 726f 7373 5f6d 6f64 616c 5f74  lf.cross_modal_t
+0000ed10: 6578 745f 7472 616e 7366 6f72 6d28 7465  ext_transform(te
+0000ed20: 7874 5f65 6d62 6564 7329 0a0a 2020 2020  xt_embeds)..    
+0000ed30: 2020 2020 7465 7874 5f74 6f6b 656e 5f74      text_token_t
+0000ed40: 7970 655f 656d 6265 6464 696e 6773 203d  ype_embeddings =
+0000ed50: 2073 656c 662e 746f 6b65 6e5f 7479 7065   self.token_type
+0000ed60: 5f65 6d62 6564 6469 6e67 7328 0a20 2020  _embeddings(.   
+0000ed70: 2020 2020 2020 2020 206f 7073 2e7a 6572           ops.zer
+0000ed80: 6f73 2831 2c20 6474 7970 653d 6d69 6e64  os(1, dtype=mind
+0000ed90: 7370 6f72 652e 696e 7436 3429 0a20 2020  spore.int64).   
+0000eda0: 2020 2020 2029 2e65 7870 616e 645f 6173       ).expand_as
+0000edb0: 2863 726f 7373 5f6d 6f64 616c 5f74 6578  (cross_modal_tex
+0000edc0: 7429 0a0a 2020 2020 2020 2020 6372 6f73  t)..        cros
+0000edd0: 735f 6d6f 6461 6c5f 7465 7874 203d 2073  s_modal_text = s
+0000ede0: 656c 662e 6372 6f73 735f 6d6f 6461 6c5f  elf.cross_modal_
+0000edf0: 7465 7874 5f6c 6179 6572 6e6f 726d 2863  text_layernorm(c
+0000ee00: 726f 7373 5f6d 6f64 616c 5f74 6578 7420  ross_modal_text 
+0000ee10: 2b20 7465 7874 5f74 6f6b 656e 5f74 7970  + text_token_typ
+0000ee20: 655f 656d 6265 6464 696e 6773 290a 0a20  e_embeddings).. 
+0000ee30: 2020 2020 2020 2069 6d61 6765 5f65 6d62         image_emb
+0000ee40: 6564 735f 7769 7468 5f6c 6e20 3d20 7365  eds_with_ln = se
+0000ee50: 6c66 2e63 726f 7373 5f6d 6f64 616c 5f69  lf.cross_modal_i
+0000ee60: 6d61 6765 5f74 7261 6e73 666f 726d 2869  mage_transform(i
+0000ee70: 6d61 6765 5f65 6d62 6564 735f 7769 7468  mage_embeds_with
+0000ee80: 5f6c 6e29 0a20 2020 2020 2020 2069 6d61  _ln).        ima
+0000ee90: 6765 5f74 6f6b 656e 5f74 7970 655f 656d  ge_token_type_em
+0000eea0: 6265 6464 696e 6773 203d 2073 656c 662e  beddings = self.
+0000eeb0: 746f 6b65 6e5f 7479 7065 5f65 6d62 6564  token_type_embed
+0000eec0: 6469 6e67 7328 0a20 2020 2020 2020 2020  dings(.         
+0000eed0: 2020 206f 7073 2e66 756c 6c28 2831 2c29     ops.full((1,)
+0000eee0: 2c20 696d 6167 655f 746f 6b65 6e5f 7479  , image_token_ty
+0000eef0: 7065 5f69 6478 2c20 6474 7970 653d 6d69  pe_idx, dtype=mi
+0000ef00: 6e64 7370 6f72 652e 696e 7436 3429 0a20  ndspore.int64). 
+0000ef10: 2020 2020 2020 2029 2e65 7870 616e 645f         ).expand_
+0000ef20: 6173 2869 6d61 6765 5f65 6d62 6564 735f  as(image_embeds_
+0000ef30: 7769 7468 5f6c 6e29 0a0a 2020 2020 2020  with_ln)..      
+0000ef40: 2020 696d 6167 655f 656d 6265 6473 5f77    image_embeds_w
+0000ef50: 6974 685f 6c6e 203d 2069 6d61 6765 5f65  ith_ln = image_e
+0000ef60: 6d62 6564 735f 7769 7468 5f6c 6e20 2b20  mbeds_with_ln + 
+0000ef70: 696d 6167 655f 746f 6b65 6e5f 7479 7065  image_token_type
+0000ef80: 5f65 6d62 6564 6469 6e67 730a 2020 2020  _embeddings.    
+0000ef90: 2020 2020 6372 6f73 735f 6d6f 6461 6c5f      cross_modal_
+0000efa0: 696d 6167 6520 3d20 7365 6c66 2e63 726f  image = self.cro
+0000efb0: 7373 5f6d 6f64 616c 5f69 6d61 6765 5f6c  ss_modal_image_l
+0000efc0: 6179 6572 6e6f 726d 2869 6d61 6765 5f65  ayernorm(image_e
+0000efd0: 6d62 6564 735f 7769 7468 5f6c 6e29 0a0a  mbeds_with_ln)..
+0000efe0: 2020 2020 2020 2020 7069 7865 6c5f 6d61          pixel_ma
+0000eff0: 736b 203d 206f 7073 2e6f 6e65 7328 0a20  sk = ops.ones(. 
+0000f000: 2020 2020 2020 2020 2020 2028 6372 6f73             (cros
+0000f010: 735f 6d6f 6461 6c5f 696d 6167 652e 7368  s_modal_image.sh
+0000f020: 6170 655b 305d 2c20 6372 6f73 735f 6d6f  ape[0], cross_mo
+0000f030: 6461 6c5f 696d 6167 652e 7368 6170 655b  dal_image.shape[
+0000f040: 315d 292c 0a20 2020 2020 2020 2020 2020  1]),.           
+0000f050: 2064 7479 7065 3d6d 696e 6473 706f 7265   dtype=mindspore
+0000f060: 2e69 6e74 3634 2c0a 2020 2020 2020 2020  .int64,.        
+0000f070: 290a 2020 2020 2020 2020 6578 7465 6e64  ).        extend
+0000f080: 5f69 6d61 6765 5f6d 6173 6b73 203d 2073  _image_masks = s
+0000f090: 656c 662e 7465 7874 5f6d 6f64 656c 2e67  elf.text_model.g
+0000f0a0: 6574 5f65 7874 656e 6465 645f 6174 7465  et_extended_atte
+0000f0b0: 6e74 696f 6e5f 6d61 736b 2870 6978 656c  ntion_mask(pixel
+0000f0c0: 5f6d 6173 6b2c 2070 6978 656c 5f6d 6173  _mask, pixel_mas
+0000f0d0: 6b2e 7368 6170 6529 0a0a 2020 2020 2020  k.shape)..      
+0000f0e0: 2020 6c61 7965 725f 6f75 7470 7574 735f    layer_outputs_
+0000f0f0: 7465 7874 203d 2073 656c 662e 6372 6f73  text = self.cros
+0000f100: 735f 6d6f 6461 6c5f 7465 7874 5f6c 6179  s_modal_text_lay
+0000f110: 6572 735b 305d 280a 2020 2020 2020 2020  ers[0](.        
+0000f120: 2020 2020 6372 6f73 735f 6d6f 6461 6c5f      cross_modal_
+0000f130: 7465 7874 2c0a 2020 2020 2020 2020 2020  text,.          
+0000f140: 2020 6372 6f73 735f 6d6f 6461 6c5f 696d    cross_modal_im
+0000f150: 6167 652c 0a20 2020 2020 2020 2020 2020  age,.           
+0000f160: 2061 7474 656e 7469 6f6e 5f6d 6173 6b3d   attention_mask=
+0000f170: 6578 7465 6e64 5f74 6578 745f 6d61 736b  extend_text_mask
+0000f180: 732c 0a20 2020 2020 2020 2020 2020 2065  s,.            e
+0000f190: 6e63 6f64 6572 5f61 7474 656e 7469 6f6e  ncoder_attention
+0000f1a0: 5f6d 6173 6b3d 6578 7465 6e64 5f69 6d61  _mask=extend_ima
+0000f1b0: 6765 5f6d 6173 6b73 2c0a 2020 2020 2020  ge_masks,.      
+0000f1c0: 2020 2020 2020 6f75 7470 7574 5f61 7474        output_att
+0000f1d0: 656e 7469 6f6e 733d 6f75 7470 7574 5f61  entions=output_a
+0000f1e0: 7474 656e 7469 6f6e 732c 0a20 2020 2020  ttentions,.     
+0000f1f0: 2020 2029 0a20 2020 2020 2020 2063 726f     ).        cro
+0000f200: 7373 5f74 6578 745f 6665 6174 7572 6573  ss_text_features
+0000f210: 203d 206c 6179 6572 5f6f 7574 7075 7473   = layer_outputs
+0000f220: 5f74 6578 745b 305d 0a0a 2020 2020 2020  _text[0]..      
+0000f230: 2020 6c61 7965 725f 6f75 7470 7574 735f    layer_outputs_
+0000f240: 696d 6167 6520 3d20 7365 6c66 2e63 726f  image = self.cro
+0000f250: 7373 5f6d 6f64 616c 5f69 6d61 6765 5f6c  ss_modal_image_l
+0000f260: 6179 6572 735b 305d 280a 2020 2020 2020  ayers[0](.      
+0000f270: 2020 2020 2020 6372 6f73 735f 6d6f 6461        cross_moda
+0000f280: 6c5f 696d 6167 652c 0a20 2020 2020 2020  l_image,.       
+0000f290: 2020 2020 2063 726f 7373 5f6d 6f64 616c       cross_modal
+0000f2a0: 5f74 6578 742c 0a20 2020 2020 2020 2020  _text,.         
+0000f2b0: 2020 2061 7474 656e 7469 6f6e 5f6d 6173     attention_mas
+0000f2c0: 6b3d 6578 7465 6e64 5f69 6d61 6765 5f6d  k=extend_image_m
+0000f2d0: 6173 6b73 2c0a 2020 2020 2020 2020 2020  asks,.          
+0000f2e0: 2020 656e 636f 6465 725f 6174 7465 6e74    encoder_attent
+0000f2f0: 696f 6e5f 6d61 736b 3d65 7874 656e 645f  ion_mask=extend_
+0000f300: 7465 7874 5f6d 6173 6b73 2c0a 2020 2020  text_masks,.    
+0000f310: 2020 2020 2020 2020 6f75 7470 7574 5f61          output_a
+0000f320: 7474 656e 7469 6f6e 733d 6f75 7470 7574  ttentions=output
+0000f330: 5f61 7474 656e 7469 6f6e 732c 0a20 2020  _attentions,.   
+0000f340: 2020 2020 2029 0a20 2020 2020 2020 2063       ).        c
+0000f350: 726f 7373 5f69 6d61 6765 5f66 6561 7475  ross_image_featu
+0000f360: 7265 7320 3d20 6c61 7965 725f 6f75 7470  res = layer_outp
+0000f370: 7574 735f 696d 6167 655b 305d 0a0a 2020  uts_image[0]..  
+0000f380: 2020 2020 2020 6966 206f 7574 7075 745f        if output_
+0000f390: 6869 6464 656e 5f73 7461 7465 733a 0a20  hidden_states:. 
+0000f3a0: 2020 2020 2020 2020 2020 2061 6c6c 5f68             all_h
+0000f3b0: 6964 6465 6e5f 7374 6174 6573 5f63 726f  idden_states_cro
+0000f3c0: 7373 202b 3d20 2828 6372 6f73 735f 7465  ss += ((cross_te
+0000f3d0: 7874 5f66 6561 7475 7265 732c 2063 726f  xt_features, cro
+0000f3e0: 7373 5f69 6d61 6765 5f66 6561 7475 7265  ss_image_feature
+0000f3f0: 7329 2c29 0a0a 2020 2020 2020 2020 6966  s),)..        if
+0000f400: 206f 7574 7075 745f 6174 7465 6e74 696f   output_attentio
+0000f410: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
+0000f420: 616c 6c5f 7365 6c66 5f61 7474 656e 7469  all_self_attenti
+0000f430: 6f6e 7320 2b3d 2028 286c 6179 6572 5f6f  ons += ((layer_o
+0000f440: 7574 7075 7473 5f74 6578 745b 315d 2c20  utputs_text[1], 
+0000f450: 6c61 7965 725f 6f75 7470 7574 735f 696d  layer_outputs_im
+0000f460: 6167 655b 315d 292c 290a 0a20 2020 2020  age[1]),)..     
+0000f470: 2020 206c 696e 6b5f 6c61 7965 725f 696e     link_layer_in
+0000f480: 6465 7820 3d20 300a 0a20 2020 2020 2020  dex = 0..       
+0000f490: 2023 2020 4561 6368 206f 6620 7468 6520   #  Each of the 
+0000f4a0: 746f 7020 3620 6c61 7965 7273 206f 6620  top 6 layers of 
+0000f4b0: 7468 6520 7669 7375 616c 2061 6e64 2074  the visual and t
+0000f4c0: 6578 7475 616c 2065 6e63 6f64 6572 7320  extual encoders 
+0000f4d0: 285b 7370 6c69 745f 696e 6465 783a 5d29  ([split_index:])
+0000f4e0: 2069 7320 636f 6e6e 6563 7465 6420 746f   is connected to
+0000f4f0: 2065 6163 6820 6c61 7965 7220 6f66 0a20   each layer of. 
+0000f500: 2020 2020 2020 2023 2020 7468 6520 6372         #  the cr
+0000f510: 6f73 732d 6d6f 6461 6c20 656e 636f 6465  oss-modal encode
+0000f520: 7220 7669 6120 6272 6964 6765 206c 6179  r via bridge lay
+0000f530: 6572 732c 2077 6869 6368 2062 7269 6e67  ers, which bring
+0000f540: 7320 626f 7474 6f6d 2d75 7020 616c 6967  s bottom-up alig
+0000f550: 6e6d 656e 7420 616e 6420 6675 7369 6f6e  nment and fusion
+0000f560: 2074 6f20 7468 6520 6372 6f73 732d 6d6f   to the cross-mo
+0000f570: 6461 6c20 656e 636f 6465 722e 0a20 2020  dal encoder..   
+0000f580: 2020 2020 2066 6f72 2069 2069 6e20 7261       for i in ra
+0000f590: 6e67 6528 7370 6c69 745f 696e 6465 782c  nge(split_index,
+0000f5a0: 206c 656e 2873 656c 662e 7465 7874 5f6d   len(self.text_m
+0000f5b0: 6f64 656c 2e65 6e63 6f64 6572 2e6c 6179  odel.encoder.lay
+0000f5c0: 6572 2929 3a0a 2020 2020 2020 2020 2020  er)):.          
+0000f5d0: 2020 7465 7874 5f65 6d62 6564 7320 3d20    text_embeds = 
+0000f5e0: 7365 6c66 2e74 6578 745f 6d6f 6465 6c2e  self.text_model.
+0000f5f0: 656e 636f 6465 722e 6c61 7965 725b 695d  encoder.layer[i]
+0000f600: 2874 6578 745f 656d 6265 6473 2c20 6578  (text_embeds, ex
+0000f610: 7465 6e64 5f74 6578 745f 6d61 736b 7329  tend_text_masks)
+0000f620: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
+0000f630: 696d 6167 655f 656d 6265 6473 203d 2073  image_embeds = s
+0000f640: 656c 662e 7669 7369 6f6e 5f6d 6f64 656c  elf.vision_model
+0000f650: 2e76 6973 7561 6c2e 7472 616e 7366 6f72  .visual.transfor
+0000f660: 6d65 722e 7265 7362 6c6f 636b 735b 695d  mer.resblocks[i]
+0000f670: 2869 6d61 6765 5f65 6d62 6564 7329 2e74  (image_embeds).t
+0000f680: 7970 6528 0a20 2020 2020 2020 2020 2020  ype(.           
+0000f690: 2020 2020 2073 656c 662e 7669 7369 6f6e       self.vision
+0000f6a0: 5f6d 6f64 656c 2e64 7479 7065 0a20 2020  _model.dtype.   
+0000f6b0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0000f6c0: 2020 2020 2020 2069 6d61 6765 5f65 6d62         image_emb
+0000f6d0: 6564 735f 7769 7468 5f6c 6e20 3d20 280a  eds_with_ln = (.
+0000f6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f6f0: 7365 6c66 2e63 726f 7373 5f6d 6f64 616c  self.cross_modal
+0000f700: 5f69 6d61 6765 5f74 7261 6e73 666f 726d  _image_transform
+0000f710: 2873 656c 662e 7669 7369 6f6e 5f6d 6f64  (self.vision_mod
+0000f720: 656c 2e76 6973 7561 6c2e 636f 6e73 7472  el.visual.constr
+0000f730: 7563 745f 706f 7374 2869 6d61 6765 5f65  uct_post(image_e
+0000f740: 6d62 6564 7329 290a 2020 2020 2020 2020  mbeds)).        
+0000f750: 2020 2020 2020 2020 2b20 696d 6167 655f          + image_
+0000f760: 746f 6b65 6e5f 7479 7065 5f65 6d62 6564  token_type_embed
+0000f770: 6469 6e67 730a 2020 2020 2020 2020 2020  dings.          
+0000f780: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+0000f790: 2074 6578 745f 6c69 6e6b 5f74 6f77 6572   text_link_tower
+0000f7a0: 203d 2073 656c 662e 6372 6f73 735f 6d6f   = self.cross_mo
+0000f7b0: 6461 6c5f 7465 7874 5f6c 696e 6b5f 746f  dal_text_link_to
+0000f7c0: 7765 725b 6c69 6e6b 5f6c 6179 6572 5f69  wer[link_layer_i
+0000f7d0: 6e64 6578 5d0a 2020 2020 2020 2020 2020  ndex].          
+0000f7e0: 2020 696d 6167 655f 6c69 6e6b 5f74 6f77    image_link_tow
+0000f7f0: 6572 203d 2073 656c 662e 6372 6f73 735f  er = self.cross_
+0000f800: 6d6f 6461 6c5f 696d 6167 655f 6c69 6e6b  modal_image_link
+0000f810: 5f74 6f77 6572 5b6c 696e 6b5f 6c61 7965  _tower[link_laye
+0000f820: 725f 696e 6465 785d 0a0a 2020 2020 2020  r_index]..      
+0000f830: 2020 2020 2020 2320 4272 6964 6765 206c        # Bridge l
+0000f840: 6179 6572 7320 666f 7220 7465 7874 7561  ayers for textua
+0000f850: 6c20 616e 6420 7669 7375 616c 2065 6e63  l and visual enc
+0000f860: 6f64 6572 730a 2020 2020 2020 2020 2020  oders.          
+0000f870: 2020 6372 6f73 735f 7465 7874 5f66 6561    cross_text_fea
+0000f880: 7475 7265 735f 203d 2074 6578 745f 6c69  tures_ = text_li
+0000f890: 6e6b 5f74 6f77 6572 280a 2020 2020 2020  nk_tower(.      
+0000f8a0: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
+0000f8b0: 726f 7373 5f6d 6f64 616c 5f74 6578 745f  ross_modal_text_
+0000f8c0: 7472 616e 7366 6f72 6d28 7465 7874 5f65  transform(text_e
+0000f8d0: 6d62 6564 7329 202b 2074 6578 745f 746f  mbeds) + text_to
+0000f8e0: 6b65 6e5f 7479 7065 5f65 6d62 6564 6469  ken_type_embeddi
+0000f8f0: 6e67 732c 0a20 2020 2020 2020 2020 2020  ngs,.           
+0000f900: 2020 2020 2063 726f 7373 5f74 6578 745f       cross_text_
+0000f910: 6665 6174 7572 6573 2c0a 2020 2020 2020  features,.      
+0000f920: 2020 2020 2020 2020 2020 6578 7465 6e64            extend
+0000f930: 5f74 6578 745f 6d61 736b 732c 0a20 2020  _text_masks,.   
+0000f940: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0000f950: 2020 2020 2020 2063 726f 7373 5f69 6d61         cross_ima
+0000f960: 6765 5f66 6561 7475 7265 735f 203d 2069  ge_features_ = i
+0000f970: 6d61 6765 5f6c 696e 6b5f 746f 7765 7228  mage_link_tower(
+0000f980: 696d 6167 655f 656d 6265 6473 5f77 6974  image_embeds_wit
+0000f990: 685f 6c6e 2c20 6372 6f73 735f 696d 6167  h_ln, cross_imag
+0000f9a0: 655f 6665 6174 7572 6573 2c20 6578 7465  e_features, exte
+0000f9b0: 6e64 5f69 6d61 6765 5f6d 6173 6b73 290a  nd_image_masks).
+0000f9c0: 0a20 2020 2020 2020 2020 2020 2023 2043  .            # C
+0000f9d0: 726f 7373 2d6d 6f64 616c 2065 6e63 6f64  ross-modal encod
+0000f9e0: 6572 2076 6961 2062 7269 6467 6520 6c61  er via bridge la
+0000f9f0: 7965 7273 206f 6620 7465 7874 7561 6c20  yers of textual 
+0000fa00: 616e 6420 7669 7375 616c 2065 6e63 6f64  and visual encod
+0000fa10: 6572 730a 2020 2020 2020 2020 2020 2020  ers.            
+0000fa20: 6c61 7965 725f 6f75 7470 7574 735f 7465  layer_outputs_te
+0000fa30: 7874 203d 2073 656c 662e 6372 6f73 735f  xt = self.cross_
+0000fa40: 6d6f 6461 6c5f 7465 7874 5f6c 6179 6572  modal_text_layer
+0000fa50: 735b 6c69 6e6b 5f6c 6179 6572 5f69 6e64  s[link_layer_ind
+0000fa60: 6578 202b 2031 5d28 0a20 2020 2020 2020  ex + 1](.       
+0000fa70: 2020 2020 2020 2020 2063 726f 7373 5f74           cross_t
+0000fa80: 6578 745f 6665 6174 7572 6573 5f2c 0a20  ext_features_,. 
+0000fa90: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0000faa0: 726f 7373 5f69 6d61 6765 5f66 6561 7475  ross_image_featu
+0000fab0: 7265 735f 2c0a 2020 2020 2020 2020 2020  res_,.          
+0000fac0: 2020 2020 2020 6174 7465 6e74 696f 6e5f        attention_
+0000fad0: 6d61 736b 3d65 7874 656e 645f 7465 7874  mask=extend_text
+0000fae0: 5f6d 6173 6b73 2c0a 2020 2020 2020 2020  _masks,.        
+0000faf0: 2020 2020 2020 2020 656e 636f 6465 725f          encoder_
+0000fb00: 6174 7465 6e74 696f 6e5f 6d61 736b 3d65  attention_mask=e
+0000fb10: 7874 656e 645f 696d 6167 655f 6d61 736b  xtend_image_mask
+0000fb20: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+0000fb30: 2020 206f 7574 7075 745f 6174 7465 6e74     output_attent
+0000fb40: 696f 6e73 3d6f 7574 7075 745f 6174 7465  ions=output_atte
+0000fb50: 6e74 696f 6e73 2c0a 2020 2020 2020 2020  ntions,.        
+0000fb60: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0000fb70: 2020 6372 6f73 735f 7465 7874 5f66 6561    cross_text_fea
+0000fb80: 7475 7265 7320 3d20 6c61 7965 725f 6f75  tures = layer_ou
+0000fb90: 7470 7574 735f 7465 7874 5b30 5d0a 0a20  tputs_text[0].. 
+0000fba0: 2020 2020 2020 2020 2020 206c 6179 6572             layer
+0000fbb0: 5f6f 7574 7075 7473 5f69 6d61 6765 203d  _outputs_image =
+0000fbc0: 2073 656c 662e 6372 6f73 735f 6d6f 6461   self.cross_moda
+0000fbd0: 6c5f 696d 6167 655f 6c61 7965 7273 5b6c  l_image_layers[l
+0000fbe0: 696e 6b5f 6c61 7965 725f 696e 6465 7820  ink_layer_index 
+0000fbf0: 2b20 315d 280a 2020 2020 2020 2020 2020  + 1](.          
+0000fc00: 2020 2020 2020 6372 6f73 735f 696d 6167        cross_imag
+0000fc10: 655f 6665 6174 7572 6573 5f2c 0a20 2020  e_features_,.   
+0000fc20: 2020 2020 2020 2020 2020 2020 2063 726f               cro
+0000fc30: 7373 5f74 6578 745f 6665 6174 7572 6573  ss_text_features
+0000fc40: 5f2c 0a20 2020 2020 2020 2020 2020 2020  _,.             
+0000fc50: 2020 2061 7474 656e 7469 6f6e 5f6d 6173     attention_mas
+0000fc60: 6b3d 6578 7465 6e64 5f69 6d61 6765 5f6d  k=extend_image_m
+0000fc70: 6173 6b73 2c0a 2020 2020 2020 2020 2020  asks,.          
+0000fc80: 2020 2020 2020 656e 636f 6465 725f 6174        encoder_at
+0000fc90: 7465 6e74 696f 6e5f 6d61 736b 3d65 7874  tention_mask=ext
+0000fca0: 656e 645f 7465 7874 5f6d 6173 6b73 2c0a  end_text_masks,.
+0000fcb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fcc0: 6f75 7470 7574 5f61 7474 656e 7469 6f6e  output_attention
+0000fcd0: 733d 6f75 7470 7574 5f61 7474 656e 7469  s=output_attenti
+0000fce0: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
+0000fcf0: 2029 0a20 2020 2020 2020 2020 2020 2063   ).            c
+0000fd00: 726f 7373 5f69 6d61 6765 5f66 6561 7475  ross_image_featu
+0000fd10: 7265 7320 3d20 6c61 7965 725f 6f75 7470  res = layer_outp
+0000fd20: 7574 735f 696d 6167 655b 305d 0a0a 2020  uts_image[0]..  
+0000fd30: 2020 2020 2020 2020 2020 6c69 6e6b 5f6c            link_l
+0000fd40: 6179 6572 5f69 6e64 6578 202b 3d20 310a  ayer_index += 1.
+0000fd50: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0000fd60: 6f75 7470 7574 5f68 6964 6465 6e5f 7374  output_hidden_st
+0000fd70: 6174 6573 3a0a 2020 2020 2020 2020 2020  ates:.          
+0000fd80: 2020 2020 2020 616c 6c5f 6869 6464 656e        all_hidden
+0000fd90: 5f73 7461 7465 735f 7465 7874 202b 3d20  _states_text += 
+0000fda0: 2874 6578 745f 656d 6265 6473 2c29 0a20  (text_embeds,). 
+0000fdb0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0000fdc0: 6c6c 5f68 6964 6465 6e5f 7374 6174 6573  ll_hidden_states
+0000fdd0: 5f69 6d61 6765 202b 3d20 2869 6d61 6765  _image += (image
+0000fde0: 5f65 6d62 6564 732c 290a 2020 2020 2020  _embeds,).      
+0000fdf0: 2020 2020 2020 2020 2020 616c 6c5f 6869            all_hi
+0000fe00: 6464 656e 5f73 7461 7465 735f 6372 6f73  dden_states_cros
+0000fe10: 7320 2b3d 2028 2863 726f 7373 5f74 6578  s += ((cross_tex
+0000fe20: 745f 6665 6174 7572 6573 2c20 6372 6f73  t_features, cros
+0000fe30: 735f 696d 6167 655f 6665 6174 7572 6573  s_image_features
+0000fe40: 292c 290a 0a20 2020 2020 2020 2020 2020  ),)..           
+0000fe50: 2069 6620 6f75 7470 7574 5f61 7474 656e   if output_atten
+0000fe60: 7469 6f6e 733a 0a20 2020 2020 2020 2020  tions:.         
+0000fe70: 2020 2020 2020 2061 6c6c 5f73 656c 665f         all_self_
+0000fe80: 6174 7465 6e74 696f 6e73 202b 3d20 2828  attentions += ((
+0000fe90: 6c61 7965 725f 6f75 7470 7574 735f 7465  layer_outputs_te
+0000fea0: 7874 5b31 5d2c 206c 6179 6572 5f6f 7574  xt[1], layer_out
+0000feb0: 7075 7473 5f69 6d61 6765 5b31 5d29 2c29  puts_image[1]),)
+0000fec0: 0a0a 2020 2020 2020 2020 2320 2043 6f6e  ..        #  Con
+0000fed0: 6361 7465 6e61 7465 2074 6865 2063 6c73  catenate the cls
+0000fee0: 2074 6f6b 656e 206f 6620 7468 6520 7465   token of the te
+0000fef0: 7874 2061 6e64 2069 6d61 6765 2066 6561  xt and image fea
+0000ff00: 7475 7265 7320 746f 2067 6574 2074 6865  tures to get the
+0000ff10: 2066 696e 616c 2072 6570 7265 7374 6174   final represtat
+0000ff20: 696f 6e0a 2020 2020 2020 2020 7465 7874  ion.        text
+0000ff30: 5f66 6561 7475 7265 732c 2069 6d61 6765  _features, image
+0000ff40: 5f66 6561 7475 7265 7320 3d20 6372 6f73  _features = cros
+0000ff50: 735f 7465 7874 5f66 6561 7475 7265 732c  s_text_features,
+0000ff60: 2063 726f 7373 5f69 6d61 6765 5f66 6561   cross_image_fea
+0000ff70: 7475 7265 730a 2020 2020 2020 2020 636c  tures.        cl
+0000ff80: 735f 6665 6174 7572 6573 203d 2073 656c  s_features = sel
+0000ff90: 662e 6765 745f 636c 735f 6665 6174 7572  f.get_cls_featur
+0000ffa0: 6573 2874 6578 745f 6665 6174 7572 6573  es(text_features
+0000ffb0: 2c20 696d 6167 655f 6665 6174 7572 6573  , image_features
+0000ffc0: 290a 0a20 2020 2020 2020 2069 6620 6f75  )..        if ou
+0000ffd0: 7470 7574 5f68 6964 6465 6e5f 7374 6174  tput_hidden_stat
+0000ffe0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+0000fff0: 616c 6c5f 6869 6464 656e 5f73 7461 7465  all_hidden_state
+00010000: 7320 3d20 2861 6c6c 5f68 6964 6465 6e5f  s = (all_hidden_
+00010010: 7374 6174 6573 5f74 6578 742c 2061 6c6c  states_text, all
+00010020: 5f68 6964 6465 6e5f 7374 6174 6573 5f69  _hidden_states_i
+00010030: 6d61 6765 2c20 616c 6c5f 6869 6464 656e  mage, all_hidden
+00010040: 5f73 7461 7465 735f 6372 6f73 7329 0a0a  _states_cross)..
+00010050: 2020 2020 2020 2020 6966 206e 6f74 2072          if not r
+00010060: 6574 7572 6e5f 6469 6374 3a0a 2020 2020  eturn_dict:.    
+00010070: 2020 2020 2020 2020 7265 7475 726e 2074          return t
+00010080: 7570 6c65 280a 2020 2020 2020 2020 2020  uple(.          
+00010090: 2020 2020 2020 760a 2020 2020 2020 2020        v.        
+000100a0: 2020 2020 2020 2020 666f 7220 7620 696e          for v in
+000100b0: 205b 7465 7874 5f66 6561 7475 7265 732c   [text_features,
+000100c0: 2069 6d61 6765 5f66 6561 7475 7265 732c   image_features,
+000100d0: 2063 6c73 5f66 6561 7475 7265 732c 2061   cls_features, a
+000100e0: 6c6c 5f68 6964 6465 6e5f 7374 6174 6573  ll_hidden_states
+000100f0: 2c20 616c 6c5f 7365 6c66 5f61 7474 656e  , all_self_atten
+00010100: 7469 6f6e 735d 0a20 2020 2020 2020 2020  tions].         
+00010110: 2020 2020 2020 2069 6620 7620 6973 206e         if v is n
+00010120: 6f74 204e 6f6e 650a 2020 2020 2020 2020  ot None.        
+00010130: 2020 2020 290a 0a20 2020 2020 2020 2072      )..        r
+00010140: 6574 7572 6e20 4272 6964 6765 546f 7765  eturn BridgeTowe
+00010150: 724d 6f64 656c 4f75 7470 7574 280a 2020  rModelOutput(.  
+00010160: 2020 2020 2020 2020 2020 7465 7874 5f66            text_f
+00010170: 6561 7475 7265 733d 7465 7874 5f66 6561  eatures=text_fea
+00010180: 7475 7265 732c 0a20 2020 2020 2020 2020  tures,.         
+00010190: 2020 2069 6d61 6765 5f66 6561 7475 7265     image_feature
+000101a0: 733d 696d 6167 655f 6665 6174 7572 6573  s=image_features
+000101b0: 2c0a 2020 2020 2020 2020 2020 2020 706f  ,.            po
+000101c0: 6f6c 6572 5f6f 7574 7075 743d 636c 735f  oler_output=cls_
+000101d0: 6665 6174 7572 6573 2c0a 2020 2020 2020  features,.      
+000101e0: 2020 2020 2020 6869 6464 656e 5f73 7461        hidden_sta
+000101f0: 7465 733d 616c 6c5f 6869 6464 656e 5f73  tes=all_hidden_s
+00010200: 7461 7465 732c 0a20 2020 2020 2020 2020  tates,.         
+00010210: 2020 2061 7474 656e 7469 6f6e 733d 616c     attentions=al
+00010220: 6c5f 7365 6c66 5f61 7474 656e 7469 6f6e  l_self_attention
+00010230: 732c 0a20 2020 2020 2020 2029 0a0a 2020  s,.        )..  
+00010240: 2020 6465 6620 6765 745f 636c 735f 6665    def get_cls_fe
+00010250: 6174 7572 6573 2873 656c 662c 2074 6578  atures(self, tex
+00010260: 745f 6665 6174 7572 6573 2c20 696d 6167  t_features, imag
+00010270: 655f 6665 6174 7572 6573 293a 0a20 2020  e_features):.   
+00010280: 2020 2020 2063 6c73 5f66 6561 7475 7265       cls_feature
+00010290: 735f 7465 7874 203d 2073 656c 662e 6372  s_text = self.cr
+000102a0: 6f73 735f 6d6f 6461 6c5f 7465 7874 5f70  oss_modal_text_p
+000102b0: 6f6f 6c65 7228 7465 7874 5f66 6561 7475  ooler(text_featu
+000102c0: 7265 7329 0a20 2020 2020 2020 2063 6c73  res).        cls
+000102d0: 5f66 6561 7475 7265 735f 696d 6167 6520  _features_image 
+000102e0: 3d20 7365 6c66 2e63 726f 7373 5f6d 6f64  = self.cross_mod
+000102f0: 616c 5f69 6d61 6765 5f70 6f6f 6c65 7228  al_image_pooler(
+00010300: 696d 6167 655f 6665 6174 7572 6573 290a  image_features).
+00010310: 2020 2020 2020 2020 7265 7475 726e 206f          return o
+00010320: 7073 2e63 6174 285b 636c 735f 6665 6174  ps.cat([cls_feat
+00010330: 7572 6573 5f74 6578 742c 2063 6c73 5f66  ures_text, cls_f
+00010340: 6561 7475 7265 735f 696d 6167 655d 2c20  eatures_image], 
+00010350: 6178 6973 3d2d 3129 0a0a 0a23 2043 6f70  axis=-1)...# Cop
+00010360: 6965 6420 6672 6f6d 2074 7261 6e73 666f  ied from transfo
+00010370: 726d 6572 732e 6d6f 6465 6c73 2e76 696c  rmers.models.vil
+00010380: 742e 6d6f 6465 6c69 6e67 5f76 696c 742e  t.modeling_vilt.
+00010390: 5669 6c74 5072 6564 6963 7469 6f6e 4865  ViltPredictionHe
+000103a0: 6164 5472 616e 7366 6f72 6d20 7769 7468  adTransform with
+000103b0: 2056 696c 742d 3e42 7269 6467 6554 6f77   Vilt->BridgeTow
+000103c0: 6572 0a63 6c61 7373 2042 7269 6467 6554  er.class BridgeT
+000103d0: 6f77 6572 5072 6564 6963 7469 6f6e 4865  owerPredictionHe
+000103e0: 6164 5472 616e 7366 6f72 6d28 6e6e 2e43  adTransform(nn.C
+000103f0: 656c 6c29 3a0a 2020 2020 6465 6620 5f5f  ell):.    def __
+00010400: 696e 6974 5f5f 2873 656c 662c 2063 6f6e  init__(self, con
+00010410: 6669 6729 3a0a 2020 2020 2020 2020 7375  fig):.        su
+00010420: 7065 7228 292e 5f5f 696e 6974 5f5f 2829  per().__init__()
+00010430: 0a20 2020 2020 2020 2073 656c 662e 6465  .        self.de
+00010440: 6e73 6520 3d20 6e6e 2e44 656e 7365 2863  nse = nn.Dense(c
+00010450: 6f6e 6669 672e 6869 6464 656e 5f73 697a  onfig.hidden_siz
+00010460: 652c 2063 6f6e 6669 672e 6869 6464 656e  e, config.hidden
+00010470: 5f73 697a 6529 0a20 2020 2020 2020 2069  _size).        i
+00010480: 6620 6973 696e 7374 616e 6365 2863 6f6e  f isinstance(con
+00010490: 6669 672e 6869 6464 656e 5f61 6374 2c20  fig.hidden_act, 
+000104a0: 7374 7229 3a0a 2020 2020 2020 2020 2020  str):.          
+000104b0: 2020 7365 6c66 2e74 7261 6e73 666f 726d    self.transform
+000104c0: 5f61 6374 5f66 6e20 3d20 4143 5432 464e  _act_fn = ACT2FN
+000104d0: 5b63 6f6e 6669 672e 6869 6464 656e 5f61  [config.hidden_a
+000104e0: 6374 5d0a 2020 2020 2020 2020 656c 7365  ct].        else
+000104f0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00010500: 6c66 2e74 7261 6e73 666f 726d 5f61 6374  lf.transform_act
+00010510: 5f66 6e20 3d20 636f 6e66 6967 2e68 6964  _fn = config.hid
+00010520: 6465 6e5f 6163 740a 2020 2020 2020 2020  den_act.        
+00010530: 7365 6c66 2e4c 6179 6572 4e6f 726d 203d  self.LayerNorm =
+00010540: 206e 6e2e 4c61 7965 724e 6f72 6d28 636f   nn.LayerNorm(co
+00010550: 6e66 6967 2e68 6964 6465 6e5f 7369 7a65  nfig.hidden_size
+00010560: 2c20 6570 7369 6c6f 6e3d 636f 6e66 6967  , epsilon=config
+00010570: 2e6c 6179 6572 5f6e 6f72 6d5f 6570 7329  .layer_norm_eps)
+00010580: 0a0a 2020 2020 6465 6620 636f 6e73 7472  ..    def constr
+00010590: 7563 7428 7365 6c66 2c20 6869 6464 656e  uct(self, hidden
+000105a0: 5f73 7461 7465 7329 3a0a 2020 2020 2020  _states):.      
+000105b0: 2020 6869 6464 656e 5f73 7461 7465 7320    hidden_states 
+000105c0: 3d20 7365 6c66 2e64 656e 7365 2868 6964  = self.dense(hid
+000105d0: 6465 6e5f 7374 6174 6573 290a 2020 2020  den_states).    
+000105e0: 2020 2020 6869 6464 656e 5f73 7461 7465      hidden_state
+000105f0: 7320 3d20 7365 6c66 2e74 7261 6e73 666f  s = self.transfo
+00010600: 726d 5f61 6374 5f66 6e28 6869 6464 656e  rm_act_fn(hidden
+00010610: 5f73 7461 7465 7329 0a20 2020 2020 2020  _states).       
+00010620: 2068 6964 6465 6e5f 7374 6174 6573 203d   hidden_states =
+00010630: 2073 656c 662e 4c61 7965 724e 6f72 6d28   self.LayerNorm(
+00010640: 6869 6464 656e 5f73 7461 7465 7329 0a20  hidden_states). 
+00010650: 2020 2020 2020 2072 6574 7572 6e20 6869         return hi
+00010660: 6464 656e 5f73 7461 7465 730a 0a0a 636c  dden_states...cl
+00010670: 6173 7320 4272 6964 6765 546f 7765 724d  ass BridgeTowerM
+00010680: 4c4d 4865 6164 286e 6e2e 4365 6c6c 293a  LMHead(nn.Cell):
+00010690: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+000106a0: 5f28 7365 6c66 2c20 636f 6e66 6967 2c20  _(self, config, 
+000106b0: 7765 6967 6874 3d4e 6f6e 6529 3a0a 2020  weight=None):.  
+000106c0: 2020 2020 2020 7375 7065 7228 292e 5f5f        super().__
+000106d0: 696e 6974 5f5f 2829 0a20 2020 2020 2020  init__().       
+000106e0: 2073 656c 662e 636f 6e66 6967 203d 2063   self.config = c
+000106f0: 6f6e 6669 670a 2020 2020 2020 2020 7365  onfig.        se
+00010700: 6c66 2e74 7261 6e73 666f 726d 203d 2042  lf.transform = B
+00010710: 7269 6467 6554 6f77 6572 5072 6564 6963  ridgeTowerPredic
+00010720: 7469 6f6e 4865 6164 5472 616e 7366 6f72  tionHeadTransfor
+00010730: 6d28 636f 6e66 6967 290a 2020 2020 2020  m(config).      
+00010740: 2020 7365 6c66 2e64 6563 6f64 6572 203d    self.decoder =
+00010750: 206e 6e2e 4465 6e73 6528 636f 6e66 6967   nn.Dense(config
+00010760: 2e68 6964 6465 6e5f 7369 7a65 2c20 636f  .hidden_size, co
+00010770: 6e66 6967 2e74 6578 745f 636f 6e66 6967  nfig.text_config
+00010780: 2e76 6f63 6162 5f73 697a 652c 2068 6173  .vocab_size, has
+00010790: 5f62 6961 733d 4661 6c73 6529 0a20 2020  _bias=False).   
+000107a0: 2020 2020 2073 656c 662e 6269 6173 203d       self.bias =
+000107b0: 2050 6172 616d 6574 6572 286f 7073 2e7a   Parameter(ops.z
+000107c0: 6572 6f73 2863 6f6e 6669 672e 7465 7874  eros(config.text
+000107d0: 5f63 6f6e 6669 672e 766f 6361 625f 7369  _config.vocab_si
+000107e0: 7a65 2929 0a20 2020 2020 2020 2069 6620  ze)).        if 
+000107f0: 7765 6967 6874 2069 7320 6e6f 7420 4e6f  weight is not No
+00010800: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00010810: 7365 6c66 2e64 6563 6f64 6572 2e77 6569  self.decoder.wei
+00010820: 6768 7420 3d20 7765 6967 6874 0a0a 2020  ght = weight..  
+00010830: 2020 6465 6620 636f 6e73 7472 7563 7428    def construct(
+00010840: 7365 6c66 2c20 7829 3a0a 2020 2020 2020  self, x):.      
+00010850: 2020 6d6c 6d5f 7363 6f72 6520 3d20 7365    mlm_score = se
+00010860: 6c66 2e74 7261 6e73 666f 726d 2878 290a  lf.transform(x).
+00010870: 2020 2020 2020 2020 6d6c 6d5f 7363 6f72          mlm_scor
+00010880: 6520 3d20 7365 6c66 2e64 6563 6f64 6572  e = self.decoder
+00010890: 286d 6c6d 5f73 636f 7265 2920 2b20 7365  (mlm_score) + se
+000108a0: 6c66 2e62 6961 730a 2020 2020 2020 2020  lf.bias.        
+000108b0: 7265 7475 726e 206d 6c6d 5f73 636f 7265  return mlm_score
+000108c0: 0a0a 0a63 6c61 7373 2042 7269 6467 6554  ...class BridgeT
+000108d0: 6f77 6572 4954 4d48 6561 6428 6e6e 2e43  owerITMHead(nn.C
+000108e0: 656c 6c29 3a0a 2020 2020 6465 6620 5f5f  ell):.    def __
+000108f0: 696e 6974 5f5f 2873 656c 662c 2068 6964  init__(self, hid
+00010900: 6465 6e5f 7369 7a65 293a 0a20 2020 2020  den_size):.     
+00010910: 2020 2073 7570 6572 2829 2e5f 5f69 6e69     super().__ini
+00010920: 745f 5f28 290a 2020 2020 2020 2020 7365  t__().        se
+00010930: 6c66 2e66 6320 3d20 6e6e 2e44 656e 7365  lf.fc = nn.Dense
+00010940: 2868 6964 6465 6e5f 7369 7a65 2c20 3229  (hidden_size, 2)
+00010950: 0a0a 2020 2020 6465 6620 636f 6e73 7472  ..    def constr
+00010960: 7563 7428 7365 6c66 2c20 7829 3a0a 2020  uct(self, x):.  
+00010970: 2020 2020 2020 6974 6d5f 7363 6f72 6520        itm_score 
+00010980: 3d20 7365 6c66 2e66 6328 7829 0a20 2020  = self.fc(x).   
+00010990: 2020 2020 2072 6574 7572 6e20 6974 6d5f       return itm_
+000109a0: 7363 6f72 650a 0a0a 636c 6173 7320 4272  score...class Br
+000109b0: 6964 6765 546f 7765 7246 6f72 4d61 736b  idgeTowerForMask
+000109c0: 6564 4c4d 2842 7269 6467 6554 6f77 6572  edLM(BridgeTower
+000109d0: 5072 6554 7261 696e 6564 4d6f 6465 6c29  PreTrainedModel)
+000109e0: 3a0a 2020 2020 5f74 6965 645f 7765 6967  :.    _tied_weig
+000109f0: 6874 735f 6b65 7973 203d 205b 226d 6c6d  hts_keys = ["mlm
+00010a00: 5f73 636f 7265 2e64 6563 6f64 6572 2e77  _score.decoder.w
+00010a10: 6569 6768 7422 5d0a 0a20 2020 2064 6566  eight"]..    def
+00010a20: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
+00010a30: 636f 6e66 6967 293a 0a20 2020 2020 2020  config):.       
+00010a40: 2073 7570 6572 2829 2e5f 5f69 6e69 745f   super().__init_
+00010a50: 5f28 636f 6e66 6967 290a 0a20 2020 2020  _(config)..     
+00010a60: 2020 2073 656c 662e 6272 6964 6765 746f     self.bridgeto
+00010a70: 7765 7220 3d20 4272 6964 6765 546f 7765  wer = BridgeTowe
+00010a80: 724d 6f64 656c 2863 6f6e 6669 6729 0a20  rModel(config). 
+00010a90: 2020 2020 2020 2073 656c 662e 6d6c 6d5f         self.mlm_
+00010aa0: 7363 6f72 6520 3d20 4272 6964 6765 546f  score = BridgeTo
+00010ab0: 7765 724d 4c4d 4865 6164 2863 6f6e 6669  werMLMHead(confi
+00010ac0: 6729 0a0a 2020 2020 2020 2020 2320 496e  g)..        # In
+00010ad0: 6974 6961 6c69 7a65 2077 6569 6768 7473  itialize weights
+00010ae0: 2061 6e64 2061 7070 6c79 2066 696e 616c   and apply final
+00010af0: 2070 726f 6365 7373 696e 670a 2020 2020   processing.    
+00010b00: 2020 2020 7365 6c66 2e70 6f73 745f 696e      self.post_in
+00010b10: 6974 2829 0a0a 2020 2020 6465 6620 6765  it()..    def ge
+00010b20: 745f 6f75 7470 7574 5f65 6d62 6564 6469  t_output_embeddi
+00010b30: 6e67 7328 7365 6c66 293a 0a20 2020 2020  ngs(self):.     
+00010b40: 2020 2072 6574 7572 6e20 7365 6c66 2e6d     return self.m
+00010b50: 6c6d 5f73 636f 7265 2e64 6563 6f64 6572  lm_score.decoder
+00010b60: 0a0a 2020 2020 6465 6620 7365 745f 6f75  ..    def set_ou
+00010b70: 7470 7574 5f65 6d62 6564 6469 6e67 7328  tput_embeddings(
+00010b80: 7365 6c66 2c20 6e65 775f 656d 6265 6464  self, new_embedd
+00010b90: 696e 6773 293a 0a20 2020 2020 2020 2073  ings):.        s
+00010ba0: 656c 662e 6d6c 6d5f 7363 6f72 652e 6465  elf.mlm_score.de
+00010bb0: 636f 6465 7220 3d20 6e65 775f 656d 6265  coder = new_embe
+00010bc0: 6464 696e 6773 0a0a 2020 2020 6465 6620  ddings..    def 
+00010bd0: 636f 6e73 7472 7563 7428 0a20 2020 2020  construct(.     
+00010be0: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+00010bf0: 2069 6e70 7574 5f69 6473 3a20 4f70 7469   input_ids: Opti
+00010c00: 6f6e 616c 5b6d 696e 6473 706f 7265 2e54  onal[mindspore.T
+00010c10: 656e 736f 725d 203d 204e 6f6e 652c 0a20  ensor] = None,. 
+00010c20: 2020 2020 2020 2061 7474 656e 7469 6f6e         attention
+00010c30: 5f6d 6173 6b3a 204f 7074 696f 6e61 6c5b  _mask: Optional[
+00010c40: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+00010c50: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+00010c60: 2020 746f 6b65 6e5f 7479 7065 5f69 6473    token_type_ids
+00010c70: 3a20 4f70 7469 6f6e 616c 5b6d 696e 6473  : Optional[minds
+00010c80: 706f 7265 2e54 656e 736f 725d 203d 204e  pore.Tensor] = N
+00010c90: 6f6e 652c 0a20 2020 2020 2020 2070 6978  one,.        pix
+00010ca0: 656c 5f76 616c 7565 733a 204f 7074 696f  el_values: Optio
+00010cb0: 6e61 6c5b 6d69 6e64 7370 6f72 652e 5465  nal[mindspore.Te
+00010cc0: 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a 2020  nsor] = None,.  
+00010cd0: 2020 2020 2020 7069 7865 6c5f 6d61 736b        pixel_mask
+00010ce0: 3a20 4f70 7469 6f6e 616c 5b6d 696e 6473  : Optional[minds
+00010cf0: 706f 7265 2e54 656e 736f 725d 203d 204e  pore.Tensor] = N
+00010d00: 6f6e 652c 0a20 2020 2020 2020 2068 6561  one,.        hea
+00010d10: 645f 6d61 736b 3a20 4f70 7469 6f6e 616c  d_mask: Optional
+00010d20: 5b6d 696e 6473 706f 7265 2e54 656e 736f  [mindspore.Tenso
+00010d30: 725d 203d 204e 6f6e 652c 0a20 2020 2020  r] = None,.     
+00010d40: 2020 2069 6e70 7574 735f 656d 6265 6473     inputs_embeds
+00010d50: 3a20 4f70 7469 6f6e 616c 5b6d 696e 6473  : Optional[minds
+00010d60: 706f 7265 2e54 656e 736f 725d 203d 204e  pore.Tensor] = N
+00010d70: 6f6e 652c 0a20 2020 2020 2020 2069 6d61  one,.        ima
+00010d80: 6765 5f65 6d62 6564 733a 204f 7074 696f  ge_embeds: Optio
+00010d90: 6e61 6c5b 6d69 6e64 7370 6f72 652e 5465  nal[mindspore.Te
+00010da0: 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a 2020  nsor] = None,.  
+00010db0: 2020 2020 2020 6f75 7470 7574 5f61 7474        output_att
+00010dc0: 656e 7469 6f6e 733a 204f 7074 696f 6e61  entions: Optiona
+00010dd0: 6c5b 626f 6f6c 5d20 3d20 4e6f 6e65 2c0a  l[bool] = None,.
+00010de0: 2020 2020 2020 2020 6f75 7470 7574 5f68          output_h
+00010df0: 6964 6465 6e5f 7374 6174 6573 3a20 4f70  idden_states: Op
+00010e00: 7469 6f6e 616c 5b62 6f6f 6c5d 203d 204e  tional[bool] = N
+00010e10: 6f6e 652c 0a20 2020 2020 2020 2072 6574  one,.        ret
+00010e20: 7572 6e5f 6469 6374 3a20 4f70 7469 6f6e  urn_dict: Option
+00010e30: 616c 5b62 6f6f 6c5d 203d 204e 6f6e 652c  al[bool] = None,
+00010e40: 0a20 2020 2020 2020 206c 6162 656c 733a  .        labels:
+00010e50: 204f 7074 696f 6e61 6c5b 6d69 6e64 7370   Optional[mindsp
+00010e60: 6f72 652e 5465 6e73 6f72 5d20 3d20 4e6f  ore.Tensor] = No
+00010e70: 6e65 2c0a 2020 2020 2920 2d3e 2055 6e69  ne,.    ) -> Uni
+00010e80: 6f6e 5b4d 6173 6b65 644c 4d4f 7574 7075  on[MaskedLMOutpu
+00010e90: 742c 2054 7570 6c65 5b6d 696e 6473 706f  t, Tuple[mindspo
+00010ea0: 7265 2e54 656e 736f 725d 5d3a 0a20 2020  re.Tensor]]:.   
+00010eb0: 2020 2020 2072 2222 220a 2020 2020 2020       r""".      
+00010ec0: 2020 6c61 6265 6c73 2028 606d 696e 6473    labels (`minds
+00010ed0: 706f 7265 2e54 656e 736f 7260 206f 6620  pore.Tensor` of 
+00010ee0: 7368 6170 6520 6028 6261 7463 685f 7369  shape `(batch_si
+00010ef0: 7a65 2c20 7365 7175 656e 6365 5f6c 656e  ze, sequence_len
+00010f00: 6774 6829 602c 202a 6f70 7469 6f6e 616c  gth)`, *optional
+00010f10: 2a29 3a0a 2020 2020 2020 2020 2020 2020  *):.            
+00010f20: 4c61 6265 6c73 2066 6f72 2063 6f6d 7075  Labels for compu
+00010f30: 7469 6e67 2074 6865 206d 6173 6b65 6420  ting the masked 
+00010f40: 6c61 6e67 7561 6765 206d 6f64 656c 696e  language modelin
+00010f50: 6720 6c6f 7373 2e20 496e 6469 6365 7320  g loss. Indices 
+00010f60: 7368 6f75 6c64 2062 6520 696e 2060 5b2d  should be in `[-
+00010f70: 3130 302c 2030 2c20 2e2e 2e2c 0a20 2020  100, 0, ...,.   
+00010f80: 2020 2020 2020 2020 2063 6f6e 6669 672e           config.
+00010f90: 766f 6361 625f 7369 7a65 5d60 2028 7365  vocab_size]` (se
+00010fa0: 6520 6069 6e70 7574 5f69 6473 6020 646f  e `input_ids` do
+00010fb0: 6373 7472 696e 6729 2054 6f6b 656e 7320  cstring) Tokens 
+00010fc0: 7769 7468 2069 6e64 6963 6573 2073 6574  with indices set
+00010fd0: 2074 6f20 602d 3130 3060 2061 7265 2069   to `-100` are i
+00010fe0: 676e 6f72 6564 2028 6d61 736b 6564 292c  gnored (masked),
+00010ff0: 2074 6865 0a20 2020 2020 2020 2020 2020   the.           
+00011000: 206c 6f73 7320 6973 206f 6e6c 7920 636f   loss is only co
+00011010: 6d70 7574 6564 2066 6f72 2074 6865 2074  mputed for the t
+00011020: 6f6b 656e 7320 7769 7468 206c 6162 656c  okens with label
+00011030: 7320 696e 2060 5b30 2c20 2e2e 2e2c 2063  s in `[0, ..., c
+00011040: 6f6e 6669 672e 766f 6361 625f 7369 7a65  onfig.vocab_size
+00011050: 5d60 0a20 2020 2020 2020 2052 6574 7572  ]`.        Retur
+00011060: 6e73 3a0a 0a20 2020 2020 2020 2045 7861  ns:..        Exa
+00011070: 6d70 6c65 733a 0a0a 2020 2020 2020 2020  mples:..        
+00011080: 6060 6070 7974 686f 6e0a 2020 2020 2020  ```python.      
+00011090: 2020 3e3e 3e20 6672 6f6d 2074 7261 6e73    >>> from trans
+000110a0: 666f 726d 6572 7320 696d 706f 7274 2042  formers import B
+000110b0: 7269 6467 6554 6f77 6572 5072 6f63 6573  ridgeTowerProces
+000110c0: 736f 722c 2042 7269 6467 6554 6f77 6572  sor, BridgeTower
+000110d0: 466f 724d 6173 6b65 644c 4d0a 2020 2020  ForMaskedLM.    
+000110e0: 2020 2020 3e3e 3e20 6672 6f6d 2050 494c      >>> from PIL
+000110f0: 2069 6d70 6f72 7420 496d 6167 650a 2020   import Image.  
+00011100: 2020 2020 2020 3e3e 3e20 696d 706f 7274        >>> import
+00011110: 2072 6571 7565 7374 730a 0a20 2020 2020   requests..     
+00011120: 2020 203e 3e3e 2075 726c 203d 2022 6874     >>> url = "ht
+00011130: 7470 3a2f 2f69 6d61 6765 732e 636f 636f  tp://images.coco
+00011140: 6461 7461 7365 742e 6f72 672f 7661 6c32  dataset.org/val2
+00011150: 3031 372f 3030 3030 3030 3336 3039 3433  017/000000360943
+00011160: 2e6a 7067 220a 2020 2020 2020 2020 3e3e  .jpg".        >>
+00011170: 3e20 696d 6167 6520 3d20 496d 6167 652e  > image = Image.
+00011180: 6f70 656e 2872 6571 7565 7374 732e 6765  open(requests.ge
+00011190: 7428 7572 6c2c 2073 7472 6561 6d3d 5472  t(url, stream=Tr
+000111a0: 7565 292e 7261 7729 2e63 6f6e 7665 7274  ue).raw).convert
+000111b0: 2822 5247 4222 290a 2020 2020 2020 2020  ("RGB").        
+000111c0: 3e3e 3e20 7465 7874 203d 2022 6120 3c6d  >>> text = "a <m
+000111d0: 6173 6b3e 206c 6f6f 6b69 6e67 206f 7574  ask> looking out
+000111e0: 206f 6620 7468 6520 7769 6e64 6f77 220a   of the window".
+000111f0: 0a20 2020 2020 2020 203e 3e3e 2070 726f  .        >>> pro
+00011200: 6365 7373 6f72 203d 2042 7269 6467 6554  cessor = BridgeT
+00011210: 6f77 6572 5072 6f63 6573 736f 722e 6672  owerProcessor.fr
+00011220: 6f6d 5f70 7265 7472 6169 6e65 6428 2242  om_pretrained("B
+00011230: 7269 6467 6554 6f77 6572 2f62 7269 6467  ridgeTower/bridg
+00011240: 6574 6f77 6572 2d62 6173 652d 6974 6d2d  etower-base-itm-
+00011250: 6d6c 6d22 290a 2020 2020 2020 2020 3e3e  mlm").        >>
+00011260: 3e20 6d6f 6465 6c20 3d20 4272 6964 6765  > model = Bridge
+00011270: 546f 7765 7246 6f72 4d61 736b 6564 4c4d  TowerForMaskedLM
+00011280: 2e66 726f 6d5f 7072 6574 7261 696e 6564  .from_pretrained
+00011290: 2822 4272 6964 6765 546f 7765 722f 6272  ("BridgeTower/br
+000112a0: 6964 6765 746f 7765 722d 6261 7365 2d69  idgetower-base-i
+000112b0: 746d 2d6d 6c6d 2229 0a0a 2020 2020 2020  tm-mlm")..      
+000112c0: 2020 3e3e 3e20 2320 7072 6570 6172 6520    >>> # prepare 
+000112d0: 696e 7075 7473 0a20 2020 2020 2020 203e  inputs.        >
+000112e0: 3e3e 2065 6e63 6f64 696e 6720 3d20 7072  >> encoding = pr
+000112f0: 6f63 6573 736f 7228 696d 6167 652c 2074  ocessor(image, t
+00011300: 6578 742c 2072 6574 7572 6e5f 7465 6e73  ext, return_tens
+00011310: 6f72 733d 2270 7422 290a 0a20 2020 2020  ors="pt")..     
+00011320: 2020 203e 3e3e 2023 2066 6f72 7761 7264     >>> # forward
+00011330: 2070 6173 730a 2020 2020 2020 2020 3e3e   pass.        >>
+00011340: 3e20 6f75 7470 7574 7320 3d20 6d6f 6465  > outputs = mode
+00011350: 6c28 2a2a 656e 636f 6469 6e67 290a 0a20  l(**encoding).. 
+00011360: 2020 2020 2020 203e 3e3e 2072 6573 756c         >>> resul
+00011370: 7473 203d 2070 726f 6365 7373 6f72 2e64  ts = processor.d
+00011380: 6563 6f64 6528 6f75 7470 7574 732e 6c6f  ecode(outputs.lo
+00011390: 6769 7473 2e61 7267 6d61 7828 6469 6d3d  gits.argmax(dim=
+000113a0: 2d31 292e 7371 7565 657a 6528 3029 2e74  -1).squeeze(0).t
+000113b0: 6f6c 6973 7428 2929 0a0a 2020 2020 2020  olist())..      
+000113c0: 2020 3e3e 3e20 7072 696e 7428 7265 7375    >>> print(resu
+000113d0: 6c74 7329 0a20 2020 2020 2020 202e 6120  lts).        .a 
+000113e0: 6361 7420 6c6f 6f6b 696e 6720 6f75 7420  cat looking out 
+000113f0: 6f66 2074 6865 2077 696e 646f 772e 0a20  of the window.. 
+00011400: 2020 2020 2020 2060 6060 2222 220a 2020         ```""".  
+00011410: 2020 2020 2020 7265 7475 726e 5f64 6963        return_dic
+00011420: 7420 3d20 7265 7475 726e 5f64 6963 7420  t = return_dict 
+00011430: 6966 2072 6574 7572 6e5f 6469 6374 2069  if return_dict i
+00011440: 7320 6e6f 7420 4e6f 6e65 2065 6c73 6520  s not None else 
+00011450: 7365 6c66 2e63 6f6e 6669 672e 7573 655f  self.config.use_
+00011460: 7265 7475 726e 5f64 6963 740a 2020 2020  return_dict.    
+00011470: 2020 2020 6f75 7470 7574 7320 3d20 7365      outputs = se
+00011480: 6c66 2e62 7269 6467 6574 6f77 6572 280a  lf.bridgetower(.
+00011490: 2020 2020 2020 2020 2020 2020 696e 7075              inpu
+000114a0: 745f 6964 732c 0a20 2020 2020 2020 2020  t_ids,.         
+000114b0: 2020 2061 7474 656e 7469 6f6e 5f6d 6173     attention_mas
+000114c0: 6b3d 6174 7465 6e74 696f 6e5f 6d61 736b  k=attention_mask
+000114d0: 2c0a 2020 2020 2020 2020 2020 2020 746f  ,.            to
+000114e0: 6b65 6e5f 7479 7065 5f69 6473 3d74 6f6b  ken_type_ids=tok
+000114f0: 656e 5f74 7970 655f 6964 732c 0a20 2020  en_type_ids,.   
+00011500: 2020 2020 2020 2020 2070 6978 656c 5f76           pixel_v
+00011510: 616c 7565 733d 7069 7865 6c5f 7661 6c75  alues=pixel_valu
+00011520: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+00011530: 7069 7865 6c5f 6d61 736b 3d70 6978 656c  pixel_mask=pixel
+00011540: 5f6d 6173 6b2c 0a20 2020 2020 2020 2020  _mask,.         
+00011550: 2020 2068 6561 645f 6d61 736b 3d68 6561     head_mask=hea
+00011560: 645f 6d61 736b 2c0a 2020 2020 2020 2020  d_mask,.        
+00011570: 2020 2020 696e 7075 7473 5f65 6d62 6564      inputs_embed
+00011580: 733d 696e 7075 7473 5f65 6d62 6564 732c  s=inputs_embeds,
+00011590: 0a20 2020 2020 2020 2020 2020 2069 6d61  .            ima
+000115a0: 6765 5f65 6d62 6564 733d 696d 6167 655f  ge_embeds=image_
+000115b0: 656d 6265 6473 2c0a 2020 2020 2020 2020  embeds,.        
+000115c0: 2020 2020 6f75 7470 7574 5f61 7474 656e      output_atten
+000115d0: 7469 6f6e 733d 6f75 7470 7574 5f61 7474  tions=output_att
+000115e0: 656e 7469 6f6e 732c 0a20 2020 2020 2020  entions,.       
+000115f0: 2020 2020 206f 7574 7075 745f 6869 6464       output_hidd
+00011600: 656e 5f73 7461 7465 733d 6f75 7470 7574  en_states=output
+00011610: 5f68 6964 6465 6e5f 7374 6174 6573 2c0a  _hidden_states,.
+00011620: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00011630: 726e 5f64 6963 743d 7265 7475 726e 5f64  rn_dict=return_d
+00011640: 6963 742c 0a20 2020 2020 2020 2029 0a0a  ict,.        )..
+00011650: 2020 2020 2020 2020 6d6c 6d5f 6c6f 6769          mlm_logi
+00011660: 7473 203d 2073 656c 662e 6d6c 6d5f 7363  ts = self.mlm_sc
+00011670: 6f72 6528 6f75 7470 7574 732e 7465 7874  ore(outputs.text
+00011680: 5f66 6561 7475 7265 7320 6966 2072 6574  _features if ret
+00011690: 7572 6e5f 6469 6374 2065 6c73 6520 6f75  urn_dict else ou
+000116a0: 7470 7574 735b 305d 290a 2020 2020 2020  tputs[0]).      
+000116b0: 2020 6d61 736b 6564 5f6c 6d5f 6c6f 7373    masked_lm_loss
+000116c0: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+000116d0: 6966 206c 6162 656c 7320 6973 206e 6f74  if labels is not
+000116e0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+000116f0: 2020 206d 6173 6b65 645f 6c6d 5f6c 6f73     masked_lm_los
+00011700: 7320 3d20 6f70 732e 6372 6f73 735f 656e  s = ops.cross_en
+00011710: 7472 6f70 7928 6d6c 6d5f 6c6f 6769 7473  tropy(mlm_logits
+00011720: 2e76 6965 7728 2d31 2c20 7365 6c66 2e63  .view(-1, self.c
+00011730: 6f6e 6669 672e 7465 7874 5f63 6f6e 6669  onfig.text_confi
+00011740: 672e 766f 6361 625f 7369 7a65 292c 206c  g.vocab_size), l
+00011750: 6162 656c 732e 7669 6577 282d 3129 290a  abels.view(-1)).
+00011760: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+00011770: 7265 7475 726e 5f64 6963 743a 0a20 2020  return_dict:.   
+00011780: 2020 2020 2020 2020 206f 7574 7075 7420           output 
+00011790: 3d20 7475 706c 6528 6d6c 6d5f 6c6f 6769  = tuple(mlm_logi
+000117a0: 7473 290a 2020 2020 2020 2020 2020 2020  ts).            
+000117b0: 7265 7475 726e 2028 286d 6173 6b65 645f  return ((masked_
+000117c0: 6c6d 5f6c 6f73 732c 2920 2b20 6f75 7470  lm_loss,) + outp
+000117d0: 7574 2920 6966 206d 6173 6b65 645f 6c6d  ut) if masked_lm
+000117e0: 5f6c 6f73 7320 6973 206e 6f74 204e 6f6e  _loss is not Non
+000117f0: 6520 656c 7365 206f 7574 7075 740a 0a20  e else output.. 
+00011800: 2020 2020 2020 2072 6574 7572 6e20 4d61         return Ma
+00011810: 736b 6564 4c4d 4f75 7470 7574 280a 2020  skedLMOutput(.  
+00011820: 2020 2020 2020 2020 2020 6c6f 7373 3d6d            loss=m
+00011830: 6173 6b65 645f 6c6d 5f6c 6f73 732c 0a20  asked_lm_loss,. 
+00011840: 2020 2020 2020 2020 2020 206c 6f67 6974             logit
+00011850: 733d 6d6c 6d5f 6c6f 6769 7473 2c0a 2020  s=mlm_logits,.  
+00011860: 2020 2020 2020 2020 2020 6869 6464 656e            hidden
+00011870: 5f73 7461 7465 733d 6f75 7470 7574 732e  _states=outputs.
+00011880: 6869 6464 656e 5f73 7461 7465 732c 0a20  hidden_states,. 
+00011890: 2020 2020 2020 2020 2020 2061 7474 656e             atten
+000118a0: 7469 6f6e 733d 6f75 7470 7574 732e 6174  tions=outputs.at
+000118b0: 7465 6e74 696f 6e73 2c0a 2020 2020 2020  tentions,.      
+000118c0: 2020 290a 0a0a 636c 6173 7320 4272 6964    )...class Brid
+000118d0: 6765 546f 7765 7246 6f72 496d 6167 6541  geTowerForImageA
+000118e0: 6e64 5465 7874 5265 7472 6965 7661 6c28  ndTextRetrieval(
+000118f0: 4272 6964 6765 546f 7765 7250 7265 5472  BridgeTowerPreTr
+00011900: 6169 6e65 644d 6f64 656c 293a 0a20 2020  ainedModel):.   
+00011910: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
+00011920: 6c66 2c20 636f 6e66 6967 293a 0a20 2020  lf, config):.   
+00011930: 2020 2020 2073 7570 6572 2829 2e5f 5f69       super().__i
+00011940: 6e69 745f 5f28 636f 6e66 6967 290a 0a20  nit__(config).. 
+00011950: 2020 2020 2020 2073 656c 662e 6272 6964         self.brid
+00011960: 6765 746f 7765 7220 3d20 4272 6964 6765  getower = Bridge
+00011970: 546f 7765 724d 6f64 656c 2863 6f6e 6669  TowerModel(confi
+00011980: 6729 0a0a 2020 2020 2020 2020 7365 6c66  g)..        self
+00011990: 2e69 746d 5f73 636f 7265 203d 2042 7269  .itm_score = Bri
+000119a0: 6467 6554 6f77 6572 4954 4d48 6561 6428  dgeTowerITMHead(
+000119b0: 636f 6e66 6967 2e68 6964 6465 6e5f 7369  config.hidden_si
+000119c0: 7a65 202a 2032 290a 0a20 2020 2020 2020  ze * 2)..       
+000119d0: 2023 2049 6e69 7469 616c 697a 6520 7765   # Initialize we
+000119e0: 6967 6874 7320 616e 6420 6170 706c 7920  ights and apply 
+000119f0: 6669 6e61 6c20 7072 6f63 6573 7369 6e67  final processing
+00011a00: 0a20 2020 2020 2020 2073 656c 662e 706f  .        self.po
+00011a10: 7374 5f69 6e69 7428 290a 0a20 2020 2064  st_init()..    d
+00011a20: 6566 2063 6f6e 7374 7275 6374 280a 2020  ef construct(.  
+00011a30: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+00011a40: 2020 2020 696e 7075 745f 6964 733a 204f      input_ids: O
+00011a50: 7074 696f 6e61 6c5b 6d69 6e64 7370 6f72  ptional[mindspor
+00011a60: 652e 5465 6e73 6f72 5d20 3d20 4e6f 6e65  e.Tensor] = None
+00011a70: 2c0a 2020 2020 2020 2020 6174 7465 6e74  ,.        attent
+00011a80: 696f 6e5f 6d61 736b 3a20 4f70 7469 6f6e  ion_mask: Option
+00011a90: 616c 5b6d 696e 6473 706f 7265 2e54 656e  al[mindspore.Ten
+00011aa0: 736f 725d 203d 204e 6f6e 652c 0a20 2020  sor] = None,.   
+00011ab0: 2020 2020 2074 6f6b 656e 5f74 7970 655f       token_type_
+00011ac0: 6964 733a 204f 7074 696f 6e61 6c5b 6d69  ids: Optional[mi
+00011ad0: 6e64 7370 6f72 652e 5465 6e73 6f72 5d20  ndspore.Tensor] 
+00011ae0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00011af0: 7069 7865 6c5f 7661 6c75 6573 3a20 4f70  pixel_values: Op
+00011b00: 7469 6f6e 616c 5b6d 696e 6473 706f 7265  tional[mindspore
+00011b10: 2e54 656e 736f 725d 203d 204e 6f6e 652c  .Tensor] = None,
+00011b20: 0a20 2020 2020 2020 2070 6978 656c 5f6d  .        pixel_m
+00011b30: 6173 6b3a 204f 7074 696f 6e61 6c5b 6d69  ask: Optional[mi
+00011b40: 6e64 7370 6f72 652e 5465 6e73 6f72 5d20  ndspore.Tensor] 
+00011b50: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00011b60: 6865 6164 5f6d 6173 6b3a 204f 7074 696f  head_mask: Optio
+00011b70: 6e61 6c5b 6d69 6e64 7370 6f72 652e 5465  nal[mindspore.Te
+00011b80: 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a 2020  nsor] = None,.  
+00011b90: 2020 2020 2020 696e 7075 7473 5f65 6d62        inputs_emb
+00011ba0: 6564 733a 204f 7074 696f 6e61 6c5b 6d69  eds: Optional[mi
+00011bb0: 6e64 7370 6f72 652e 5465 6e73 6f72 5d20  ndspore.Tensor] 
+00011bc0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00011bd0: 696d 6167 655f 656d 6265 6473 3a20 4f70  image_embeds: Op
+00011be0: 7469 6f6e 616c 5b6d 696e 6473 706f 7265  tional[mindspore
+00011bf0: 2e54 656e 736f 725d 203d 204e 6f6e 652c  .Tensor] = None,
+00011c00: 0a20 2020 2020 2020 206f 7574 7075 745f  .        output_
+00011c10: 6174 7465 6e74 696f 6e73 3a20 4f70 7469  attentions: Opti
+00011c20: 6f6e 616c 5b62 6f6f 6c5d 203d 204e 6f6e  onal[bool] = Non
+00011c30: 652c 0a20 2020 2020 2020 206f 7574 7075  e,.        outpu
+00011c40: 745f 6869 6464 656e 5f73 7461 7465 733a  t_hidden_states:
+00011c50: 204f 7074 696f 6e61 6c5b 626f 6f6c 5d20   Optional[bool] 
+00011c60: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00011c70: 7265 7475 726e 5f64 6963 743a 204f 7074  return_dict: Opt
+00011c80: 696f 6e61 6c5b 626f 6f6c 5d20 3d20 4e6f  ional[bool] = No
+00011c90: 6e65 2c0a 2020 2020 2020 2020 6c61 6265  ne,.        labe
+00011ca0: 6c73 3a20 4f70 7469 6f6e 616c 5b6d 696e  ls: Optional[min
+00011cb0: 6473 706f 7265 2e54 656e 736f 725d 203d  dspore.Tensor] =
+00011cc0: 204e 6f6e 652c 0a20 2020 2029 202d 3e20   None,.    ) -> 
+00011cd0: 556e 696f 6e5b 5365 7175 656e 6365 436c  Union[SequenceCl
+00011ce0: 6173 7369 6669 6572 4f75 7470 7574 2c20  assifierOutput, 
+00011cf0: 5475 706c 655b 6d69 6e64 7370 6f72 652e  Tuple[mindspore.
+00011d00: 5465 6e73 6f72 5d5d 3a0a 2020 2020 2020  Tensor]]:.      
+00011d10: 2020 7222 2222 0a20 2020 2020 2020 206c    r""".        l
+00011d20: 6162 656c 7320 2860 6d69 6e64 7370 6f72  abels (`mindspor
+00011d30: 652e 5465 6e73 6f72 6020 6f66 2073 6861  e.Tensor` of sha
+00011d40: 7065 2060 2862 6174 6368 5f73 697a 652c  pe `(batch_size,
+00011d50: 2031 2960 2c20 2a6f 7074 696f 6e61 6c2a   1)`, *optional*
+00011d60: 293a 0a20 2020 2020 2020 2020 2020 204c  ):.            L
+00011d70: 6162 656c 7320 666f 7220 636f 6d70 7574  abels for comput
+00011d80: 696e 6720 7468 6520 696d 6167 652d 7465  ing the image-te
+00011d90: 7874 206d 6174 6368 696e 6720 6c6f 7373  xt matching loss
+00011da0: 2e20 3020 6d65 616e 7320 7468 6520 7061  . 0 means the pa
+00011db0: 6972 7320 646f 6e27 7420 6d61 7463 6820  irs don't match 
+00011dc0: 616e 6420 3120 6d65 616e 7320 7468 6579  and 1 means they
+00011dd0: 206d 6174 6368 2e0a 2020 2020 2020 2020   match..        
+00011de0: 2020 2020 5468 6520 7061 6972 7320 7769      The pairs wi
+00011df0: 7468 2030 2077 696c 6c20 6265 2073 6b69  th 0 will be ski
+00011e00: 7070 6564 2066 6f72 2063 616c 6375 6c61  pped for calcula
+00011e10: 7469 6f6e 2e0a 2020 2020 2020 2020 5265  tion..        Re
+00011e20: 7475 726e 733a 0a0a 2020 2020 2020 2020  turns:..        
+00011e30: 4578 616d 706c 6573 3a0a 0a20 2020 2020  Examples:..     
+00011e40: 2020 2060 6060 7079 7468 6f6e 0a20 2020     ```python.   
+00011e50: 2020 2020 203e 3e3e 2066 726f 6d20 7472       >>> from tr
+00011e60: 616e 7366 6f72 6d65 7273 2069 6d70 6f72  ansformers impor
+00011e70: 7420 4272 6964 6765 546f 7765 7250 726f  t BridgeTowerPro
+00011e80: 6365 7373 6f72 2c20 4272 6964 6765 546f  cessor, BridgeTo
+00011e90: 7765 7246 6f72 496d 6167 6541 6e64 5465  werForImageAndTe
+00011ea0: 7874 5265 7472 6965 7661 6c0a 2020 2020  xtRetrieval.    
+00011eb0: 2020 2020 3e3e 3e20 696d 706f 7274 2072      >>> import r
+00011ec0: 6571 7565 7374 730a 2020 2020 2020 2020  equests.        
+00011ed0: 3e3e 3e20 6672 6f6d 2050 494c 2069 6d70  >>> from PIL imp
+00011ee0: 6f72 7420 496d 6167 650a 0a20 2020 2020  ort Image..     
+00011ef0: 2020 203e 3e3e 2075 726c 203d 2022 6874     >>> url = "ht
+00011f00: 7470 3a2f 2f69 6d61 6765 732e 636f 636f  tp://images.coco
+00011f10: 6461 7461 7365 742e 6f72 672f 7661 6c32  dataset.org/val2
+00011f20: 3031 372f 3030 3030 3030 3033 3937 3639  017/000000039769
+00011f30: 2e6a 7067 220a 2020 2020 2020 2020 3e3e  .jpg".        >>
+00011f40: 3e20 696d 6167 6520 3d20 496d 6167 652e  > image = Image.
+00011f50: 6f70 656e 2872 6571 7565 7374 732e 6765  open(requests.ge
+00011f60: 7428 7572 6c2c 2073 7472 6561 6d3d 5472  t(url, stream=Tr
+00011f70: 7565 292e 7261 7729 0a20 2020 2020 2020  ue).raw).       
+00011f80: 203e 3e3e 2074 6578 7473 203d 205b 2241   >>> texts = ["A
+00011f90: 6e20 696d 6167 6520 6f66 2074 776f 2063  n image of two c
+00011fa0: 6174 7320 6368 696c 6c69 6e67 206f 6e20  ats chilling on 
+00011fb0: 6120 636f 7563 6822 2c20 2241 2066 6f6f  a couch", "A foo
+00011fc0: 7462 616c 6c20 706c 6179 6572 2073 636f  tball player sco
+00011fd0: 7269 6e67 2061 2067 6f61 6c22 5d0a 0a20  ring a goal"].. 
+00011fe0: 2020 2020 2020 203e 3e3e 2070 726f 6365         >>> proce
+00011ff0: 7373 6f72 203d 2042 7269 6467 6554 6f77  ssor = BridgeTow
+00012000: 6572 5072 6f63 6573 736f 722e 6672 6f6d  erProcessor.from
+00012010: 5f70 7265 7472 6169 6e65 6428 2242 7269  _pretrained("Bri
+00012020: 6467 6554 6f77 6572 2f62 7269 6467 6574  dgeTower/bridget
+00012030: 6f77 6572 2d62 6173 652d 6974 6d2d 6d6c  ower-base-itm-ml
+00012040: 6d22 290a 2020 2020 2020 2020 3e3e 3e20  m").        >>> 
+00012050: 6d6f 6465 6c20 3d20 4272 6964 6765 546f  model = BridgeTo
+00012060: 7765 7246 6f72 496d 6167 6541 6e64 5465  werForImageAndTe
+00012070: 7874 5265 7472 6965 7661 6c2e 6672 6f6d  xtRetrieval.from
+00012080: 5f70 7265 7472 6169 6e65 6428 2242 7269  _pretrained("Bri
+00012090: 6467 6554 6f77 6572 2f62 7269 6467 6574  dgeTower/bridget
+000120a0: 6f77 6572 2d62 6173 652d 6974 6d2d 6d6c  ower-base-itm-ml
+000120b0: 6d22 290a 0a20 2020 2020 2020 203e 3e3e  m")..        >>>
+000120c0: 2023 2066 6f72 7761 7264 2070 6173 730a   # forward pass.
+000120d0: 2020 2020 2020 2020 3e3e 3e20 7363 6f72          >>> scor
+000120e0: 6573 203d 2064 6963 7428 290a 2020 2020  es = dict().    
+000120f0: 2020 2020 3e3e 3e20 666f 7220 7465 7874      >>> for text
+00012100: 2069 6e20 7465 7874 733a 0a20 2020 2020   in texts:.     
+00012110: 2020 202e 2e2e 2020 2020 2023 2070 7265     ...     # pre
+00012120: 7061 7265 2069 6e70 7574 730a 2020 2020  pare inputs.    
+00012130: 2020 2020 2e2e 2e20 2020 2020 656e 636f      ...     enco
+00012140: 6469 6e67 203d 2070 726f 6365 7373 6f72  ding = processor
+00012150: 2869 6d61 6765 2c20 7465 7874 2c20 7265  (image, text, re
+00012160: 7475 726e 5f74 656e 736f 7273 3d22 7074  turn_tensors="pt
+00012170: 2229 0a20 2020 2020 2020 202e 2e2e 2020  ").        ...  
+00012180: 2020 206f 7574 7075 7473 203d 206d 6f64     outputs = mod
+00012190: 656c 282a 2a65 6e63 6f64 696e 6729 0a20  el(**encoding). 
+000121a0: 2020 2020 2020 202e 2e2e 2020 2020 2073         ...     s
+000121b0: 636f 7265 735b 7465 7874 5d20 3d20 6f75  cores[text] = ou
+000121c0: 7470 7574 732e 6c6f 6769 7473 5b30 2c20  tputs.logits[0, 
+000121d0: 315d 2e69 7465 6d28 290a 2020 2020 2020  1].item().      
+000121e0: 2020 6060 6022 2222 0a20 2020 2020 2020    ```""".       
+000121f0: 2072 6574 7572 6e5f 6469 6374 203d 2072   return_dict = r
+00012200: 6574 7572 6e5f 6469 6374 2069 6620 7265  eturn_dict if re
+00012210: 7475 726e 5f64 6963 7420 6973 206e 6f74  turn_dict is not
+00012220: 204e 6f6e 6520 656c 7365 2073 656c 662e   None else self.
+00012230: 636f 6e66 6967 2e75 7365 5f72 6574 7572  config.use_retur
+00012240: 6e5f 6469 6374 0a0a 2020 2020 2020 2020  n_dict..        
+00012250: 6f75 7470 7574 7320 3d20 7365 6c66 2e62  outputs = self.b
+00012260: 7269 6467 6574 6f77 6572 280a 2020 2020  ridgetower(.    
+00012270: 2020 2020 2020 2020 696e 7075 745f 6964          input_id
+00012280: 732c 0a20 2020 2020 2020 2020 2020 2061  s,.            a
+00012290: 7474 656e 7469 6f6e 5f6d 6173 6b3d 6174  ttention_mask=at
+000122a0: 7465 6e74 696f 6e5f 6d61 736b 2c0a 2020  tention_mask,.  
+000122b0: 2020 2020 2020 2020 2020 746f 6b65 6e5f            token_
+000122c0: 7479 7065 5f69 6473 3d74 6f6b 656e 5f74  type_ids=token_t
+000122d0: 7970 655f 6964 732c 0a20 2020 2020 2020  ype_ids,.       
+000122e0: 2020 2020 2070 6978 656c 5f76 616c 7565       pixel_value
+000122f0: 733d 7069 7865 6c5f 7661 6c75 6573 2c0a  s=pixel_values,.
+00012300: 2020 2020 2020 2020 2020 2020 7069 7865              pixe
+00012310: 6c5f 6d61 736b 3d70 6978 656c 5f6d 6173  l_mask=pixel_mas
+00012320: 6b2c 0a20 2020 2020 2020 2020 2020 2068  k,.            h
+00012330: 6561 645f 6d61 736b 3d68 6561 645f 6d61  ead_mask=head_ma
+00012340: 736b 2c0a 2020 2020 2020 2020 2020 2020  sk,.            
+00012350: 696e 7075 7473 5f65 6d62 6564 733d 696e  inputs_embeds=in
+00012360: 7075 7473 5f65 6d62 6564 732c 0a20 2020  puts_embeds,.   
+00012370: 2020 2020 2020 2020 2069 6d61 6765 5f65           image_e
+00012380: 6d62 6564 733d 696d 6167 655f 656d 6265  mbeds=image_embe
+00012390: 6473 2c0a 2020 2020 2020 2020 2020 2020  ds,.            
+000123a0: 6f75 7470 7574 5f61 7474 656e 7469 6f6e  output_attention
+000123b0: 733d 6f75 7470 7574 5f61 7474 656e 7469  s=output_attenti
+000123c0: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
+000123d0: 206f 7574 7075 745f 6869 6464 656e 5f73   output_hidden_s
+000123e0: 7461 7465 733d 6f75 7470 7574 5f68 6964  tates=output_hid
+000123f0: 6465 6e5f 7374 6174 6573 2c0a 2020 2020  den_states,.    
+00012400: 2020 2020 2020 2020 7265 7475 726e 5f64          return_d
+00012410: 6963 743d 7265 7475 726e 5f64 6963 742c  ict=return_dict,
+00012420: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00012430: 2020 2020 706f 6f6c 6572 5f6f 7574 7075      pooler_outpu
+00012440: 7420 3d20 6f75 7470 7574 732e 706f 6f6c  t = outputs.pool
+00012450: 6572 5f6f 7574 7075 7420 6966 2072 6574  er_output if ret
+00012460: 7572 6e5f 6469 6374 2065 6c73 6520 6f75  urn_dict else ou
+00012470: 7470 7574 735b 325d 0a0a 2020 2020 2020  tputs[2]..      
+00012480: 2020 6c6f 6769 7473 203d 2073 656c 662e    logits = self.
+00012490: 6974 6d5f 7363 6f72 6528 706f 6f6c 6572  itm_score(pooler
+000124a0: 5f6f 7574 7075 7429 0a0a 2020 2020 2020  _output)..      
+000124b0: 2020 6974 6d5f 6c6f 7373 203d 204e 6f6e    itm_loss = Non
+000124c0: 650a 2020 2020 2020 2020 6966 206c 6162  e.        if lab
+000124d0: 656c 7320 6973 206e 6f74 204e 6f6e 653a  els is not None:
+000124e0: 0a20 2020 2020 2020 2020 2020 2069 746d  .            itm
+000124f0: 5f6c 6f73 7320 3d20 6f70 732e 6372 6f73  _loss = ops.cros
+00012500: 735f 656e 7472 6f70 7928 6c6f 6769 7473  s_entropy(logits
+00012510: 2c20 6c61 6265 6c73 290a 0a20 2020 2020  , labels)..     
+00012520: 2020 2069 6620 6e6f 7420 7265 7475 726e     if not return
+00012530: 5f64 6963 743a 0a20 2020 2020 2020 2020  _dict:.         
+00012540: 2020 206f 7574 7075 7420 3d20 7475 706c     output = tupl
+00012550: 6528 6c6f 6769 7473 290a 2020 2020 2020  e(logits).      
+00012560: 2020 2020 2020 7265 7475 726e 2028 2869        return ((i
+00012570: 746d 5f6c 6f73 732c 2920 2b20 6f75 7470  tm_loss,) + outp
+00012580: 7574 2920 6966 2069 746d 5f6c 6f73 7320  ut) if itm_loss 
+00012590: 6973 206e 6f74 204e 6f6e 6520 656c 7365  is not None else
+000125a0: 206f 7574 7075 740a 0a20 2020 2020 2020   output..       
+000125b0: 2072 6574 7572 6e20 5365 7175 656e 6365   return Sequence
+000125c0: 436c 6173 7369 6669 6572 4f75 7470 7574  ClassifierOutput
+000125d0: 280a 2020 2020 2020 2020 2020 2020 6c6f  (.            lo
+000125e0: 7373 3d69 746d 5f6c 6f73 732c 0a20 2020  ss=itm_loss,.   
+000125f0: 2020 2020 2020 2020 206c 6f67 6974 733d           logits=
+00012600: 6c6f 6769 7473 2c0a 2020 2020 2020 2020  logits,.        
+00012610: 2020 2020 6869 6464 656e 5f73 7461 7465      hidden_state
+00012620: 733d 6f75 7470 7574 732e 6869 6464 656e  s=outputs.hidden
+00012630: 5f73 7461 7465 732c 0a20 2020 2020 2020  _states,.       
+00012640: 2020 2020 2061 7474 656e 7469 6f6e 733d       attentions=
+00012650: 6f75 7470 7574 732e 6174 7465 6e74 696f  outputs.attentio
+00012660: 6e73 2c0a 2020 2020 2020 2020 290a 0a0a  ns,.        )...
+00012670: 636c 6173 7320 4272 6964 6765 546f 7765  class BridgeTowe
+00012680: 7243 6f6e 7472 6173 7469 7665 4865 6164  rContrastiveHead
+00012690: 286e 6e2e 4365 6c6c 293a 0a20 2020 2064  (nn.Cell):.    d
+000126a0: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
+000126b0: 2c20 6869 6464 656e 5f73 697a 652c 2065  , hidden_size, e
+000126c0: 6d62 6564 5f73 697a 6529 3a0a 2020 2020  mbed_size):.    
+000126d0: 2020 2020 7375 7065 7228 292e 5f5f 696e      super().__in
+000126e0: 6974 5f5f 2829 0a20 2020 2020 2020 2073  it__().        s
+000126f0: 656c 662e 6663 203d 206e 6e2e 4465 6e73  elf.fc = nn.Dens
+00012700: 6528 6869 6464 656e 5f73 697a 652c 2065  e(hidden_size, e
+00012710: 6d62 6564 5f73 697a 6529 0a0a 2020 2020  mbed_size)..    
+00012720: 6465 6620 636f 6e73 7472 7563 7428 7365  def construct(se
+00012730: 6c66 2c20 7829 3a0a 2020 2020 2020 2020  lf, x):.        
+00012740: 7820 3d20 7365 6c66 2e66 6328 7829 0a20  x = self.fc(x). 
+00012750: 2020 2020 2020 2072 6574 7572 6e20 780a         return x.
+00012760: 0a0a 636c 6173 7320 4272 6964 6765 546f  ..class BridgeTo
+00012770: 7765 7246 6f72 436f 6e74 7261 7374 6976  werForContrastiv
+00012780: 654c 6561 726e 696e 6728 4272 6964 6765  eLearning(Bridge
+00012790: 546f 7765 7250 7265 5472 6169 6e65 644d  TowerPreTrainedM
+000127a0: 6f64 656c 293a 0a20 2020 2064 6566 205f  odel):.    def _
+000127b0: 5f69 6e69 745f 5f28 7365 6c66 2c20 636f  _init__(self, co
+000127c0: 6e66 6967 293a 0a20 2020 2020 2020 2073  nfig):.        s
+000127d0: 7570 6572 2829 2e5f 5f69 6e69 745f 5f28  uper().__init__(
+000127e0: 636f 6e66 6967 290a 0a20 2020 2020 2020  config)..       
+000127f0: 2073 656c 662e 6272 6964 6765 746f 7765   self.bridgetowe
+00012800: 7220 3d20 4272 6964 6765 546f 7765 724d  r = BridgeTowerM
+00012810: 6f64 656c 2863 6f6e 6669 6729 0a0a 2020  odel(config)..  
+00012820: 2020 2020 2020 7365 6c66 2e69 7463 5f74        self.itc_t
+00012830: 6578 745f 6865 6164 203d 2042 7269 6467  ext_head = Bridg
+00012840: 6554 6f77 6572 436f 6e74 7261 7374 6976  eTowerContrastiv
+00012850: 6548 6561 6428 636f 6e66 6967 2e68 6964  eHead(config.hid
+00012860: 6465 6e5f 7369 7a65 2c20 636f 6e66 6967  den_size, config
+00012870: 2e63 6f6e 7472 6173 7469 7665 5f68 6964  .contrastive_hid
+00012880: 6465 6e5f 7369 7a65 290a 2020 2020 2020  den_size).      
+00012890: 2020 7365 6c66 2e69 7463 5f69 6d61 6765    self.itc_image
+000128a0: 5f68 6561 6420 3d20 4272 6964 6765 546f  _head = BridgeTo
+000128b0: 7765 7243 6f6e 7472 6173 7469 7665 4865  werContrastiveHe
+000128c0: 6164 2863 6f6e 6669 672e 6869 6464 656e  ad(config.hidden
+000128d0: 5f73 697a 652c 2063 6f6e 6669 672e 636f  _size, config.co
+000128e0: 6e74 7261 7374 6976 655f 6869 6464 656e  ntrastive_hidden
+000128f0: 5f73 697a 6529 0a20 2020 2020 2020 2073  _size).        s
+00012900: 656c 662e 6974 635f 6372 6f73 735f 6d6f  elf.itc_cross_mo
+00012910: 6461 6c5f 6865 6164 203d 2042 7269 6467  dal_head = Bridg
+00012920: 6554 6f77 6572 436f 6e74 7261 7374 6976  eTowerContrastiv
+00012930: 6548 6561 6428 636f 6e66 6967 2e68 6964  eHead(config.hid
+00012940: 6465 6e5f 7369 7a65 202a 2032 2c20 636f  den_size * 2, co
+00012950: 6e66 6967 2e63 6f6e 7472 6173 7469 7665  nfig.contrastive
+00012960: 5f68 6964 6465 6e5f 7369 7a65 290a 0a20  _hidden_size).. 
+00012970: 2020 2020 2020 2073 656c 662e 6c6f 6769         self.logi
+00012980: 745f 7363 616c 6520 3d20 5061 7261 6d65  t_scale = Parame
+00012990: 7465 7228 6d69 6e64 7370 6f72 652e 7465  ter(mindspore.te
+000129a0: 6e73 6f72 2873 656c 662e 636f 6e66 6967  nsor(self.config
+000129b0: 2e6c 6f67 6974 5f73 6361 6c65 5f69 6e69  .logit_scale_ini
+000129c0: 745f 7661 6c75 6529 290a 2020 2020 2020  t_value)).      
+000129d0: 2020 2320 496e 6974 6961 6c69 7a65 2077    # Initialize w
+000129e0: 6569 6768 7473 2061 6e64 2061 7070 6c79  eights and apply
+000129f0: 2066 696e 616c 2070 726f 6365 7373 696e   final processin
+00012a00: 670a 2020 2020 2020 2020 7365 6c66 2e70  g.        self.p
+00012a10: 6f73 745f 696e 6974 2829 0a0a 2020 2020  ost_init()..    
+00012a20: 6465 6620 636f 6e73 7472 7563 7428 0a20  def construct(. 
+00012a30: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+00012a40: 2020 2020 2069 6e70 7574 5f69 6473 3a20       input_ids: 
+00012a50: 4f70 7469 6f6e 616c 5b6d 696e 6473 706f  Optional[mindspo
+00012a60: 7265 2e54 656e 736f 725d 203d 204e 6f6e  re.Tensor] = Non
+00012a70: 652c 0a20 2020 2020 2020 2061 7474 656e  e,.        atten
+00012a80: 7469 6f6e 5f6d 6173 6b3a 204f 7074 696f  tion_mask: Optio
+00012a90: 6e61 6c5b 6d69 6e64 7370 6f72 652e 5465  nal[mindspore.Te
+00012aa0: 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a 2020  nsor] = None,.  
+00012ab0: 2020 2020 2020 746f 6b65 6e5f 7479 7065        token_type
+00012ac0: 5f69 6473 3a20 4f70 7469 6f6e 616c 5b6d  _ids: Optional[m
+00012ad0: 696e 6473 706f 7265 2e54 656e 736f 725d  indspore.Tensor]
+00012ae0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00012af0: 2070 6978 656c 5f76 616c 7565 733a 204f   pixel_values: O
+00012b00: 7074 696f 6e61 6c5b 6d69 6e64 7370 6f72  ptional[mindspor
+00012b10: 652e 5465 6e73 6f72 5d20 3d20 4e6f 6e65  e.Tensor] = None
+00012b20: 2c0a 2020 2020 2020 2020 7069 7865 6c5f  ,.        pixel_
+00012b30: 6d61 736b 3a20 4f70 7469 6f6e 616c 5b6d  mask: Optional[m
+00012b40: 696e 6473 706f 7265 2e54 656e 736f 725d  indspore.Tensor]
+00012b50: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00012b60: 2068 6561 645f 6d61 736b 3a20 4f70 7469   head_mask: Opti
+00012b70: 6f6e 616c 5b6d 696e 6473 706f 7265 2e54  onal[mindspore.T
+00012b80: 656e 736f 725d 203d 204e 6f6e 652c 0a20  ensor] = None,. 
+00012b90: 2020 2020 2020 2069 6e70 7574 735f 656d         inputs_em
+00012ba0: 6265 6473 3a20 4f70 7469 6f6e 616c 5b6d  beds: Optional[m
+00012bb0: 696e 6473 706f 7265 2e54 656e 736f 725d  indspore.Tensor]
+00012bc0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00012bd0: 2069 6d61 6765 5f65 6d62 6564 733a 204f   image_embeds: O
+00012be0: 7074 696f 6e61 6c5b 6d69 6e64 7370 6f72  ptional[mindspor
+00012bf0: 652e 5465 6e73 6f72 5d20 3d20 4e6f 6e65  e.Tensor] = None
+00012c00: 2c0a 2020 2020 2020 2020 6f75 7470 7574  ,.        output
+00012c10: 5f61 7474 656e 7469 6f6e 733a 204f 7074  _attentions: Opt
+00012c20: 696f 6e61 6c5b 626f 6f6c 5d20 3d20 4e6f  ional[bool] = No
+00012c30: 6e65 2c0a 2020 2020 2020 2020 6f75 7470  ne,.        outp
+00012c40: 7574 5f68 6964 6465 6e5f 7374 6174 6573  ut_hidden_states
+00012c50: 3a20 4f70 7469 6f6e 616c 5b62 6f6f 6c5d  : Optional[bool]
+00012c60: 203d 2054 7275 652c 0a20 2020 2020 2020   = True,.       
+00012c70: 2072 6574 7572 6e5f 6469 6374 3a20 4f70   return_dict: Op
+00012c80: 7469 6f6e 616c 5b62 6f6f 6c5d 203d 204e  tional[bool] = N
+00012c90: 6f6e 652c 0a20 2020 2020 2020 2072 6574  one,.        ret
+00012ca0: 7572 6e5f 6c6f 7373 3a20 4f70 7469 6f6e  urn_loss: Option
+00012cb0: 616c 5b62 6f6f 6c5d 203d 204e 6f6e 652c  al[bool] = None,
+00012cc0: 0a20 2020 2029 202d 3e20 556e 696f 6e5b  .    ) -> Union[
+00012cd0: 4272 6964 6765 546f 7765 7243 6f6e 7472  BridgeTowerContr
+00012ce0: 6173 7469 7665 4f75 7470 7574 2c20 5475  astiveOutput, Tu
+00012cf0: 706c 655b 6d69 6e64 7370 6f72 652e 5465  ple[mindspore.Te
+00012d00: 6e73 6f72 5d5d 3a0a 2020 2020 2020 2020  nsor]]:.        
+00012d10: 7222 2222 0a20 2020 2020 2020 2072 6574  r""".        ret
+00012d20: 7572 6e5f 6c6f 7373 2028 6062 6f6f 6c60  urn_loss (`bool`
+00012d30: 2c20 2a6f 7074 696f 6e61 6c2a 293a 0a20  , *optional*):. 
+00012d40: 2020 2020 2020 2020 2020 2057 6865 7468             Wheth
+00012d50: 6572 206f 7220 6e6f 7420 746f 2072 6574  er or not to ret
+00012d60: 7572 6e20 7468 6520 636f 6e74 7261 7374  urn the contrast
+00012d70: 6976 6520 6c6f 7373 2e0a 2020 2020 2020  ive loss..      
+00012d80: 2020 5265 7475 726e 733a 0a0a 2020 2020    Returns:..    
+00012d90: 2020 2020 4578 616d 706c 6573 3a0a 0a20      Examples:.. 
+00012da0: 2020 2020 2020 2060 6060 7079 7468 6f6e         ```python
+00012db0: 0a20 2020 2020 2020 203e 3e3e 2066 726f  .        >>> fro
+00012dc0: 6d20 7472 616e 7366 6f72 6d65 7273 2069  m transformers i
+00012dd0: 6d70 6f72 7420 4272 6964 6765 546f 7765  mport BridgeTowe
+00012de0: 7250 726f 6365 7373 6f72 2c20 4272 6964  rProcessor, Brid
+00012df0: 6765 546f 7765 7246 6f72 436f 6e74 7261  geTowerForContra
+00012e00: 7374 6976 654c 6561 726e 696e 670a 2020  stiveLearning.  
+00012e10: 2020 2020 2020 3e3e 3e20 696d 706f 7274        >>> import
+00012e20: 2072 6571 7565 7374 730a 2020 2020 2020   requests.      
+00012e30: 2020 3e3e 3e20 6672 6f6d 2050 494c 2069    >>> from PIL i
+00012e40: 6d70 6f72 7420 496d 6167 650a 2020 2020  mport Image.    
+00012e50: 2020 2020 3e3e 3e20 696d 706f 7274 2074      >>> import t
+00012e60: 6f72 6368 0a0a 2020 2020 2020 2020 3e3e  orch..        >>
+00012e70: 3e20 696d 6167 655f 7572 6c73 203d 205b  > image_urls = [
+00012e80: 0a20 2020 2020 2020 202e 2e2e 2020 2020  .        ...    
+00012e90: 2022 6874 7470 733a 2f2f 6661 726d 342e   "https://farm4.
+00012ea0: 7374 6174 6963 666c 6963 6b72 2e63 6f6d  staticflickr.com
+00012eb0: 2f33 3339 352f 3334 3238 3237 3834 3135  /3395/3428278415
+00012ec0: 5f38 3163 3365 3237 6631 355f 7a2e 6a70  _81c3e27f15_z.jp
+00012ed0: 6722 2c0a 2020 2020 2020 2020 2e2e 2e20  g",.        ... 
+00012ee0: 2020 2020 2268 7474 703a 2f2f 696d 6167      "http://imag
+00012ef0: 6573 2e63 6f63 6f64 6174 6173 6574 2e6f  es.cocodataset.o
+00012f00: 7267 2f76 616c 3230 3137 2f30 3030 3030  rg/val2017/00000
+00012f10: 3030 3339 3736 392e 6a70 6722 2c0a 2020  0039769.jpg",.  
+00012f20: 2020 2020 2020 2e2e 2e20 5d0a 2020 2020        ... ].    
+00012f30: 2020 2020 3e3e 3e20 7465 7874 7320 3d20      >>> texts = 
+00012f40: 5b22 7477 6f20 646f 6773 2069 6e20 6120  ["two dogs in a 
+00012f50: 6361 7222 2c20 2274 776f 2063 6174 7320  car", "two cats 
+00012f60: 736c 6565 7069 6e67 206f 6e20 6120 636f  sleeping on a co
+00012f70: 7563 6822 5d0a 2020 2020 2020 2020 3e3e  uch"].        >>
+00012f80: 3e20 696d 6167 6573 203d 205b 496d 6167  > images = [Imag
+00012f90: 652e 6f70 656e 2872 6571 7565 7374 732e  e.open(requests.
+00012fa0: 6765 7428 7572 6c2c 2073 7472 6561 6d3d  get(url, stream=
+00012fb0: 5472 7565 292e 7261 7729 2066 6f72 2075  True).raw) for u
+00012fc0: 726c 2069 6e20 696d 6167 655f 7572 6c73  rl in image_urls
+00012fd0: 5d0a 0a20 2020 2020 2020 203e 3e3e 2070  ]..        >>> p
+00012fe0: 726f 6365 7373 6f72 203d 2042 7269 6467  rocessor = Bridg
+00012ff0: 6554 6f77 6572 5072 6f63 6573 736f 722e  eTowerProcessor.
+00013000: 6672 6f6d 5f70 7265 7472 6169 6e65 6428  from_pretrained(
+00013010: 2242 7269 6467 6554 6f77 6572 2f62 7269  "BridgeTower/bri
+00013020: 6467 6574 6f77 6572 2d6c 6172 6765 2d69  dgetower-large-i
+00013030: 746d 2d6d 6c6d 2d69 7463 2229 0a20 2020  tm-mlm-itc").   
+00013040: 2020 2020 203e 3e3e 206d 6f64 656c 203d       >>> model =
+00013050: 2042 7269 6467 6554 6f77 6572 466f 7243   BridgeTowerForC
+00013060: 6f6e 7472 6173 7469 7665 4c65 6172 6e69  ontrastiveLearni
+00013070: 6e67 2e66 726f 6d5f 7072 6574 7261 696e  ng.from_pretrain
+00013080: 6564 2822 4272 6964 6765 546f 7765 722f  ed("BridgeTower/
+00013090: 6272 6964 6765 746f 7765 722d 6c61 7267  bridgetower-larg
+000130a0: 652d 6974 6d2d 6d6c 6d2d 6974 6322 290a  e-itm-mlm-itc").
+000130b0: 0a20 2020 2020 2020 203e 3e3e 2069 6e70  .        >>> inp
+000130c0: 7574 7320 3d20 7072 6f63 6573 736f 7228  uts = processor(
+000130d0: 696d 6167 6573 2c20 7465 7874 732c 2070  images, texts, p
+000130e0: 6164 6469 6e67 3d54 7275 652c 2072 6574  adding=True, ret
+000130f0: 7572 6e5f 7465 6e73 6f72 733d 2270 7422  urn_tensors="pt"
+00013100: 290a 2020 2020 2020 2020 3e3e 3e20 6c6f  ).        >>> lo
+00013110: 7373 203d 206d 6f64 656c 282a 2a69 6e70  ss = model(**inp
+00013120: 7574 732c 2072 6574 7572 6e5f 6c6f 7373  uts, return_loss
+00013130: 3d54 7275 6529 2e6c 6f73 730a 0a20 2020  =True).loss..   
+00013140: 2020 2020 203e 3e3e 2069 6e70 7574 7320       >>> inputs 
+00013150: 3d20 7072 6f63 6573 736f 7228 696d 6167  = processor(imag
+00013160: 6573 2c20 7465 7874 735b 3a3a 2d31 5d2c  es, texts[::-1],
+00013170: 2070 6164 6469 6e67 3d54 7275 652c 2072   padding=True, r
+00013180: 6574 7572 6e5f 7465 6e73 6f72 733d 2270  eturn_tensors="p
+00013190: 7422 290a 2020 2020 2020 2020 3e3e 3e20  t").        >>> 
+000131a0: 6c6f 7373 5f73 7761 7070 6564 203d 206d  loss_swapped = m
+000131b0: 6f64 656c 282a 2a69 6e70 7574 732c 2072  odel(**inputs, r
+000131c0: 6574 7572 6e5f 6c6f 7373 3d54 7275 6529  eturn_loss=True)
+000131d0: 2e6c 6f73 730a 0a20 2020 2020 2020 203e  .loss..        >
+000131e0: 3e3e 2070 7269 6e74 2822 4c6f 7373 222c  >> print("Loss",
+000131f0: 2072 6f75 6e64 286c 6f73 732e 6974 656d   round(loss.item
+00013200: 2829 2c20 3429 290a 2020 2020 2020 2020  (), 4)).        
+00013210: 4c6f 7373 2030 2e30 3031 390a 0a20 2020  Loss 0.0019..   
+00013220: 2020 2020 203e 3e3e 2070 7269 6e74 2822       >>> print("
+00013230: 4c6f 7373 2077 6974 6820 7377 6170 7065  Loss with swappe
+00013240: 6420 696d 6167 6573 222c 2072 6f75 6e64  d images", round
+00013250: 286c 6f73 735f 7377 6170 7065 642e 6974  (loss_swapped.it
+00013260: 656d 2829 2c20 3429 290a 2020 2020 2020  em(), 4)).      
+00013270: 2020 4c6f 7373 2077 6974 6820 7377 6170    Loss with swap
+00013280: 7065 6420 696d 6167 6573 2032 2e31 3236  ped images 2.126
+00013290: 0a20 2020 2020 2020 2060 6060 2222 220a  .        ```""".
+000132a0: 2020 2020 2020 2020 7265 7475 726e 5f64          return_d
+000132b0: 6963 7420 3d20 7265 7475 726e 5f64 6963  ict = return_dic
+000132c0: 7420 6966 2072 6574 7572 6e5f 6469 6374  t if return_dict
+000132d0: 2069 7320 6e6f 7420 4e6f 6e65 2065 6c73   is not None els
+000132e0: 6520 7365 6c66 2e63 6f6e 6669 672e 7573  e self.config.us
+000132f0: 655f 7265 7475 726e 5f64 6963 740a 0a20  e_return_dict.. 
+00013300: 2020 2020 2020 206f 7574 7075 7473 203d         outputs =
+00013310: 2073 656c 662e 6272 6964 6765 746f 7765   self.bridgetowe
+00013320: 7228 0a20 2020 2020 2020 2020 2020 2069  r(.            i
+00013330: 6e70 7574 5f69 6473 2c0a 2020 2020 2020  nput_ids,.      
+00013340: 2020 2020 2020 6174 7465 6e74 696f 6e5f        attention_
+00013350: 6d61 736b 3d61 7474 656e 7469 6f6e 5f6d  mask=attention_m
+00013360: 6173 6b2c 0a20 2020 2020 2020 2020 2020  ask,.           
+00013370: 2074 6f6b 656e 5f74 7970 655f 6964 733d   token_type_ids=
+00013380: 746f 6b65 6e5f 7479 7065 5f69 6473 2c0a  token_type_ids,.
+00013390: 2020 2020 2020 2020 2020 2020 7069 7865              pixe
+000133a0: 6c5f 7661 6c75 6573 3d70 6978 656c 5f76  l_values=pixel_v
+000133b0: 616c 7565 732c 0a20 2020 2020 2020 2020  alues,.         
+000133c0: 2020 2070 6978 656c 5f6d 6173 6b3d 7069     pixel_mask=pi
+000133d0: 7865 6c5f 6d61 736b 2c0a 2020 2020 2020  xel_mask,.      
+000133e0: 2020 2020 2020 6865 6164 5f6d 6173 6b3d        head_mask=
+000133f0: 6865 6164 5f6d 6173 6b2c 0a20 2020 2020  head_mask,.     
+00013400: 2020 2020 2020 2069 6e70 7574 735f 656d         inputs_em
+00013410: 6265 6473 3d69 6e70 7574 735f 656d 6265  beds=inputs_embe
+00013420: 6473 2c0a 2020 2020 2020 2020 2020 2020  ds,.            
+00013430: 696d 6167 655f 656d 6265 6473 3d69 6d61  image_embeds=ima
+00013440: 6765 5f65 6d62 6564 732c 0a20 2020 2020  ge_embeds,.     
+00013450: 2020 2020 2020 206f 7574 7075 745f 6174         output_at
+00013460: 7465 6e74 696f 6e73 3d6f 7574 7075 745f  tentions=output_
+00013470: 6174 7465 6e74 696f 6e73 2c0a 2020 2020  attentions,.    
+00013480: 2020 2020 2020 2020 6f75 7470 7574 5f68          output_h
+00013490: 6964 6465 6e5f 7374 6174 6573 3d54 7275  idden_states=Tru
+000134a0: 652c 0a20 2020 2020 2020 2020 2020 2072  e,.            r
+000134b0: 6574 7572 6e5f 6469 6374 3d72 6574 7572  eturn_dict=retur
+000134c0: 6e5f 6469 6374 2c0a 2020 2020 2020 2020  n_dict,.        
+000134d0: 290a 0a20 2020 2020 2020 2070 6f6f 6c65  )..        poole
+000134e0: 725f 6f75 7470 7574 203d 206f 7574 7075  r_output = outpu
+000134f0: 7473 2e70 6f6f 6c65 725f 6f75 7470 7574  ts.pooler_output
+00013500: 2069 6620 7265 7475 726e 5f64 6963 7420   if return_dict 
+00013510: 656c 7365 206f 7574 7075 7473 5b32 5d0a  else outputs[2].
+00013520: 2020 2020 2020 2020 6869 6464 656e 5f73          hidden_s
+00013530: 7461 7465 735f 7478 742c 2068 6964 6465  tates_txt, hidde
+00013540: 6e5f 7374 6174 6573 5f69 6d67 2c20 6869  n_states_img, hi
+00013550: 6464 656e 5f73 7461 7465 735f 6372 6f73  dden_states_cros
+00013560: 735f 6d6f 6461 6c20 3d20 280a 2020 2020  s_modal = (.    
+00013570: 2020 2020 2020 2020 6f75 7470 7574 732e          outputs.
+00013580: 6869 6464 656e 5f73 7461 7465 7320 6966  hidden_states if
+00013590: 2072 6574 7572 6e5f 6469 6374 2065 6c73   return_dict els
+000135a0: 6520 6f75 7470 7574 735b 335d 0a20 2020  e outputs[3].   
+000135b0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+000135c0: 7465 7874 5f65 6d62 6564 7320 3d20 6869  text_embeds = hi
+000135d0: 6464 656e 5f73 7461 7465 735f 7478 745b  dden_states_txt[
+000135e0: 2d31 5d0a 2020 2020 2020 2020 696d 6167  -1].        imag
+000135f0: 655f 656d 6265 6473 203d 2068 6964 6465  e_embeds = hidde
+00013600: 6e5f 7374 6174 6573 5f69 6d67 5b2d 315d  n_states_img[-1]
+00013610: 0a0a 2020 2020 2020 2020 696d 6167 655f  ..        image_
+00013620: 656d 6265 6473 5f77 6974 685f 6c6e 203d  embeds_with_ln =
+00013630: 2073 656c 662e 6272 6964 6765 746f 7765   self.bridgetowe
+00013640: 722e 7669 7369 6f6e 5f6d 6f64 656c 2e76  r.vision_model.v
+00013650: 6973 7561 6c2e 636f 6e73 7472 7563 745f  isual.construct_
+00013660: 706f 7374 2869 6d61 6765 5f65 6d62 6564  post(image_embed
+00013670: 7329 0a20 2020 2020 2020 2069 6d61 6765  s).        image
+00013680: 5f74 6f6b 656e 5f74 7970 655f 656d 6265  _token_type_embe
+00013690: 6464 696e 6773 203d 2073 656c 662e 6272  ddings = self.br
+000136a0: 6964 6765 746f 7765 722e 746f 6b65 6e5f  idgetower.token_
+000136b0: 7479 7065 5f65 6d62 6564 6469 6e67 7328  type_embeddings(
+000136c0: 0a20 2020 2020 2020 2020 2020 206f 7073  .            ops
+000136d0: 2e66 756c 6c28 2831 2c29 2c20 312c 2064  .full((1,), 1, d
+000136e0: 7479 7065 3d6d 696e 6473 706f 7265 2e69  type=mindspore.i
+000136f0: 6e74 3634 290a 2020 2020 2020 2020 292e  nt64).        ).
+00013700: 6578 7061 6e64 5f61 7328 696d 6167 655f  expand_as(image_
+00013710: 656d 6265 6473 5f77 6974 685f 6c6e 290a  embeds_with_ln).
+00013720: 0a20 2020 2020 2020 2069 6d61 6765 5f65  .        image_e
+00013730: 6d62 6564 7320 3d20 7365 6c66 2e62 7269  mbeds = self.bri
+00013740: 6467 6574 6f77 6572 2e63 726f 7373 5f6d  dgetower.cross_m
+00013750: 6f64 616c 5f69 6d61 6765 5f74 7261 6e73  odal_image_trans
+00013760: 666f 726d 2869 6d61 6765 5f65 6d62 6564  form(image_embed
+00013770: 735f 7769 7468 5f6c 6e29 202b 2069 6d61  s_with_ln) + ima
+00013780: 6765 5f74 6f6b 656e 5f74 7970 655f 656d  ge_token_type_em
+00013790: 6265 6464 696e 6773 0a0a 2020 2020 2020  beddings..      
+000137a0: 2020 2320 6e6f 726d 616c 697a 6564 2066    # normalized f
+000137b0: 6561 7475 7265 730a 2020 2020 2020 2020  eatures.        
+000137c0: 7465 7874 5f65 6d62 6564 7320 3d20 6e6f  text_embeds = no
+000137d0: 726d 616c 697a 6528 7365 6c66 2e69 7463  rmalize(self.itc
+000137e0: 5f74 6578 745f 6865 6164 2874 6578 745f  _text_head(text_
+000137f0: 656d 6265 6473 5b3a 2c20 302c 203a 5d29  embeds[:, 0, :])
+00013800: 2c20 6469 6d3d 2d31 2c20 703d 3229 0a20  , dim=-1, p=2). 
+00013810: 2020 2020 2020 2069 6d61 6765 5f65 6d62         image_emb
+00013820: 6564 7320 3d20 6e6f 726d 616c 697a 6528  eds = normalize(
+00013830: 7365 6c66 2e69 7463 5f69 6d61 6765 5f68  self.itc_image_h
+00013840: 6561 6428 696d 6167 655f 656d 6265 6473  ead(image_embeds
+00013850: 5b3a 2c20 302c 203a 5d29 2c20 6469 6d3d  [:, 0, :]), dim=
+00013860: 2d31 2c20 703d 3229 0a20 2020 2020 2020  -1, p=2).       
+00013870: 2063 726f 7373 5f65 6d62 6564 7320 3d20   cross_embeds = 
+00013880: 6e6f 726d 616c 697a 6528 7365 6c66 2e69  normalize(self.i
+00013890: 7463 5f63 726f 7373 5f6d 6f64 616c 5f68  tc_cross_modal_h
+000138a0: 6561 6428 706f 6f6c 6572 5f6f 7574 7075  ead(pooler_outpu
+000138b0: 7429 2c20 6469 6d3d 2d31 2c20 703d 3229  t), dim=-1, p=2)
+000138c0: 0a20 2020 2020 2020 206c 6f67 6974 7320  .        logits 
+000138d0: 3d20 6f70 732e 7374 6163 6b28 5b74 6578  = ops.stack([tex
+000138e0: 745f 656d 6265 6473 2c20 696d 6167 655f  t_embeds, image_
+000138f0: 656d 6265 6473 2c20 6372 6f73 735f 656d  embeds, cross_em
+00013900: 6265 6473 5d2c 2061 7869 733d 2d32 290a  beds], axis=-2).
+00013910: 0a20 2020 2020 2020 206c 6f67 6974 5f73  .        logit_s
+00013920: 6361 6c65 203d 2073 656c 662e 6c6f 6769  cale = self.logi
+00013930: 745f 7363 616c 652e 6578 7028 290a 2020  t_scale.exp().  
+00013940: 2020 2020 2020 6c6f 6769 7473 5f74 6578        logits_tex
+00013950: 745f 746f 5f69 6d61 6765 203d 206f 7073  t_to_image = ops
+00013960: 2e6d 6174 6d75 6c28 7465 7874 5f65 6d62  .matmul(text_emb
+00013970: 6564 732c 2069 6d61 6765 5f65 6d62 6564  eds, image_embed
+00013980: 732e 7428 2929 202a 206c 6f67 6974 5f73  s.t()) * logit_s
+00013990: 6361 6c65 0a20 2020 2020 2020 206c 6f67  cale.        log
+000139a0: 6974 735f 7465 7874 5f74 6f5f 6372 6f73  its_text_to_cros
+000139b0: 7320 3d20 6f70 732e 6d61 746d 756c 2874  s = ops.matmul(t
+000139c0: 6578 745f 656d 6265 6473 2c20 6372 6f73  ext_embeds, cros
+000139d0: 735f 656d 6265 6473 2e74 2829 2920 2a20  s_embeds.t()) * 
+000139e0: 6c6f 6769 745f 7363 616c 650a 2020 2020  logit_scale.    
+000139f0: 2020 2020 6c6f 6769 7473 5f69 6d61 6765      logits_image
+00013a00: 5f74 6f5f 6372 6f73 7320 3d20 6f70 732e  _to_cross = ops.
+00013a10: 6d61 746d 756c 2869 6d61 6765 5f65 6d62  matmul(image_emb
+00013a20: 6564 732c 2063 726f 7373 5f65 6d62 6564  eds, cross_embed
+00013a30: 732e 7428 2929 202a 206c 6f67 6974 5f73  s.t()) * logit_s
+00013a40: 6361 6c65 0a0a 2020 2020 2020 2020 6974  cale..        it
+00013a50: 635f 6c6f 7373 203d 204e 6f6e 650a 0a20  c_loss = None.. 
+00013a60: 2020 2020 2020 2069 6620 7265 7475 726e         if return
+00013a70: 5f6c 6f73 733a 0a20 2020 2020 2020 2020  _loss:.         
+00013a80: 2020 206c 6162 656c 7320 3d20 6f70 732e     labels = ops.
+00013a90: 6172 616e 6765 286c 656e 286c 6f67 6974  arange(len(logit
+00013aa0: 7329 290a 2020 2020 2020 2020 2020 2020  s)).            
+00013ab0: 7465 7874 5f74 6f5f 696d 6167 655f 6c6f  text_to_image_lo
+00013ac0: 7373 203d 206f 7073 2e63 726f 7373 5f65  ss = ops.cross_e
+00013ad0: 6e74 726f 7079 286c 6f67 6974 735f 7465  ntropy(logits_te
+00013ae0: 7874 5f74 6f5f 696d 6167 652c 206c 6162  xt_to_image, lab
+00013af0: 656c 7329 0a20 2020 2020 2020 2020 2020  els).           
+00013b00: 2074 6578 745f 746f 5f63 726f 7373 5f6c   text_to_cross_l
+00013b10: 6f73 7320 3d20 6f70 732e 6372 6f73 735f  oss = ops.cross_
+00013b20: 656e 7472 6f70 7928 6c6f 6769 7473 5f74  entropy(logits_t
+00013b30: 6578 745f 746f 5f63 726f 7373 2c20 6c61  ext_to_cross, la
+00013b40: 6265 6c73 290a 2020 2020 2020 2020 2020  bels).          
+00013b50: 2020 696d 6167 655f 746f 5f63 726f 7373    image_to_cross
+00013b60: 5f6c 6f73 7320 3d20 6f70 732e 6372 6f73  _loss = ops.cros
+00013b70: 735f 656e 7472 6f70 7928 6c6f 6769 7473  s_entropy(logits
+00013b80: 5f69 6d61 6765 5f74 6f5f 6372 6f73 732c  _image_to_cross,
+00013b90: 206c 6162 656c 7329 0a20 2020 2020 2020   labels).       
+00013ba0: 2020 2020 2069 7463 5f6c 6f73 7320 3d20       itc_loss = 
+00013bb0: 2874 6578 745f 746f 5f69 6d61 6765 5f6c  (text_to_image_l
+00013bc0: 6f73 7320 2b20 7465 7874 5f74 6f5f 6372  oss + text_to_cr
+00013bd0: 6f73 735f 6c6f 7373 202b 2069 6d61 6765  oss_loss + image
+00013be0: 5f74 6f5f 6372 6f73 735f 6c6f 7373 2920  _to_cross_loss) 
+00013bf0: 2f20 332e 300a 0a20 2020 2020 2020 2069  / 3.0..        i
+00013c00: 6620 6e6f 7420 7265 7475 726e 5f64 6963  f not return_dic
+00013c10: 743a 0a20 2020 2020 2020 2020 2020 206f  t:.            o
+00013c20: 7574 7075 7420 3d20 286c 6f67 6974 732c  utput = (logits,
+00013c30: 2074 6578 745f 656d 6265 6473 2c20 696d   text_embeds, im
+00013c40: 6167 655f 656d 6265 6473 2c20 6372 6f73  age_embeds, cros
+00013c50: 735f 656d 6265 6473 2920 2b20 6f75 7470  s_embeds) + outp
+00013c60: 7574 735b 333a 5d0a 2020 2020 2020 2020  uts[3:].        
+00013c70: 2020 2020 7265 7475 726e 2028 2869 7463      return ((itc
+00013c80: 5f6c 6f73 732c 2920 2b20 6f75 7470 7574  _loss,) + output
+00013c90: 2920 6966 2069 7463 5f6c 6f73 7320 6973  ) if itc_loss is
+00013ca0: 206e 6f74 204e 6f6e 6520 656c 7365 206f   not None else o
+00013cb0: 7574 7075 740a 0a20 2020 2020 2020 2072  utput..        r
+00013cc0: 6574 7572 6e20 4272 6964 6765 546f 7765  eturn BridgeTowe
+00013cd0: 7243 6f6e 7472 6173 7469 7665 4f75 7470  rContrastiveOutp
+00013ce0: 7574 280a 2020 2020 2020 2020 2020 2020  ut(.            
+00013cf0: 6c6f 7373 3d69 7463 5f6c 6f73 732c 0a20  loss=itc_loss,. 
+00013d00: 2020 2020 2020 2020 2020 206c 6f67 6974             logit
+00013d10: 733d 6c6f 6769 7473 2c0a 2020 2020 2020  s=logits,.      
+00013d20: 2020 2020 2020 7465 7874 5f65 6d62 6564        text_embed
+00013d30: 733d 7465 7874 5f65 6d62 6564 732c 0a20  s=text_embeds,. 
+00013d40: 2020 2020 2020 2020 2020 2069 6d61 6765             image
+00013d50: 5f65 6d62 6564 733d 696d 6167 655f 656d  _embeds=image_em
+00013d60: 6265 6473 2c0a 2020 2020 2020 2020 2020  beds,.          
+00013d70: 2020 6372 6f73 735f 656d 6265 6473 3d63    cross_embeds=c
+00013d80: 726f 7373 5f65 6d62 6564 732c 0a20 2020  ross_embeds,.   
+00013d90: 2020 2020 2020 2020 2068 6964 6465 6e5f           hidden_
+00013da0: 7374 6174 6573 3d6f 7574 7075 7473 2e68  states=outputs.h
+00013db0: 6964 6465 6e5f 7374 6174 6573 2c0a 2020  idden_states,.  
+00013dc0: 2020 2020 2020 2020 2020 6174 7465 6e74            attent
+00013dd0: 696f 6e73 3d6f 7574 7075 7473 2e61 7474  ions=outputs.att
+00013de0: 656e 7469 6f6e 732c 0a20 2020 2020 2020  entions,.       
+00013df0: 2029 0a0a 5f5f 616c 6c5f 5f20 3d20 5b0a   )..__all__ = [.
+00013e00: 2020 2020 2242 7269 6467 6554 6f77 6572      "BridgeTower
+00013e10: 466f 7243 6f6e 7472 6173 7469 7665 4c65  ForContrastiveLe
+00013e20: 6172 6e69 6e67 222c 0a20 2020 2022 4272  arning",.    "Br
+00013e30: 6964 6765 546f 7765 7246 6f72 496d 6167  idgeTowerForImag
+00013e40: 6541 6e64 5465 7874 5265 7472 6965 7661  eAndTextRetrieva
+00013e50: 6c22 2c0a 2020 2020 2242 7269 6467 6554  l",.    "BridgeT
+00013e60: 6f77 6572 466f 724d 6173 6b65 644c 4d22  owerForMaskedLM"
+00013e70: 2c0a 2020 2020 2242 7269 6467 6554 6f77  ,.    "BridgeTow
+00013e80: 6572 4d6f 6465 6c22 2c0a 2020 2020 2242  erModel",.    "B
+00013e90: 7269 6467 6554 6f77 6572 5072 6554 7261  ridgeTowerPreTra
+00013ea0: 696e 6564 4d6f 6465 6c22 2c0a 5d0a       inedModel",.].
```

## mindnlp/transformers/models/bridgetower/processing_bridgetower.py

```diff
@@ -0,0 +1,319 @@
+00000000: 2320 636f 6469 6e67 3d75 7466 2d38 0a23  # coding=utf-8.#
+00000010: 2043 6f70 7972 6967 6874 2032 3032 3320   Copyright 2023 
+00000020: 5468 6520 496e 7465 6c20 4c61 6273 2054  The Intel Labs T
+00000030: 6561 6d20 4175 7468 6f72 732c 2054 6865  eam Authors, The
+00000040: 204d 6963 726f 736f 6674 2052 6573 6561   Microsoft Resea
+00000050: 7263 6820 5465 616d 2041 7574 686f 7273  rch Team Authors
+00000060: 2061 6e64 2048 7567 6769 6e67 4661 6365   and HuggingFace
+00000070: 2049 6e63 2e20 7465 616d 2e20 416c 6c20   Inc. team. All 
+00000080: 7269 6768 7473 2072 6573 6572 7665 642e  rights reserved.
+00000090: 0a23 0a23 204c 6963 656e 7365 6420 756e  .#.# Licensed un
+000000a0: 6465 7220 7468 6520 4170 6163 6865 204c  der the Apache L
+000000b0: 6963 656e 7365 2c20 5665 7273 696f 6e20  icense, Version 
+000000c0: 322e 3020 2874 6865 2022 4c69 6365 6e73  2.0 (the "Licens
+000000d0: 6522 293b 0a23 2079 6f75 206d 6179 206e  e");.# you may n
+000000e0: 6f74 2075 7365 2074 6869 7320 6669 6c65  ot use this file
+000000f0: 2065 7863 6570 7420 696e 2063 6f6d 706c   except in compl
+00000100: 6961 6e63 6520 7769 7468 2074 6865 204c  iance with the L
+00000110: 6963 656e 7365 2e0a 2320 596f 7520 6d61  icense..# You ma
+00000120: 7920 6f62 7461 696e 2061 2063 6f70 7920  y obtain a copy 
+00000130: 6f66 2074 6865 204c 6963 656e 7365 2061  of the License a
+00000140: 740a 230a 2320 2020 2020 6874 7470 3a2f  t.#.#     http:/
+00000150: 2f77 7777 2e61 7061 6368 652e 6f72 672f  /www.apache.org/
+00000160: 6c69 6365 6e73 6573 2f4c 4943 454e 5345  licenses/LICENSE
+00000170: 2d32 2e30 0a23 0a23 2055 6e6c 6573 7320  -2.0.#.# Unless 
+00000180: 7265 7175 6972 6564 2062 7920 6170 706c  required by appl
+00000190: 6963 6162 6c65 206c 6177 206f 7220 6167  icable law or ag
+000001a0: 7265 6564 2074 6f20 696e 2077 7269 7469  reed to in writi
+000001b0: 6e67 2c20 736f 6674 7761 7265 0a23 2064  ng, software.# d
+000001c0: 6973 7472 6962 7574 6564 2075 6e64 6572  istributed under
+000001d0: 2074 6865 204c 6963 656e 7365 2069 7320   the License is 
+000001e0: 6469 7374 7269 6275 7465 6420 6f6e 2061  distributed on a
+000001f0: 6e20 2241 5320 4953 2220 4241 5349 532c  n "AS IS" BASIS,
+00000200: 0a23 2057 4954 484f 5554 2057 4152 5241  .# WITHOUT WARRA
+00000210: 4e54 4945 5320 4f52 2043 4f4e 4449 5449  NTIES OR CONDITI
+00000220: 4f4e 5320 4f46 2041 4e59 204b 494e 442c  ONS OF ANY KIND,
+00000230: 2065 6974 6865 7220 6578 7072 6573 7320   either express 
+00000240: 6f72 2069 6d70 6c69 6564 2e0a 2320 5365  or implied..# Se
+00000250: 6520 7468 6520 4c69 6365 6e73 6520 666f  e the License fo
+00000260: 7220 7468 6520 7370 6563 6966 6963 206c  r the specific l
+00000270: 616e 6775 6167 6520 676f 7665 726e 696e  anguage governin
+00000280: 6720 7065 726d 6973 7369 6f6e 7320 616e  g permissions an
+00000290: 640a 2320 6c69 6d69 7461 7469 6f6e 7320  d.# limitations 
+000002a0: 756e 6465 7220 7468 6520 4c69 6365 6e73  under the Licens
+000002b0: 652e 0a22 2222 0a50 726f 6365 7373 6f72  e..""".Processor
+000002c0: 2063 6c61 7373 2066 6f72 2042 7269 6467   class for Bridg
+000002d0: 6554 6f77 6572 2e0a 2222 220a 0a66 726f  eTower.."""..fro
+000002e0: 6d20 7479 7069 6e67 2069 6d70 6f72 7420  m typing import 
+000002f0: 4c69 7374 2c20 4f70 7469 6f6e 616c 2c20  List, Optional, 
+00000300: 556e 696f 6e0a 0a66 726f 6d20 2e2e 2e70  Union..from ...p
+00000310: 726f 6365 7373 696e 675f 7574 696c 7320  rocessing_utils 
+00000320: 696d 706f 7274 2050 726f 6365 7373 6f72  import Processor
+00000330: 4d69 7869 6e0a 6672 6f6d 202e 2e2e 746f  Mixin.from ...to
+00000340: 6b65 6e69 7a61 7469 6f6e 5f75 7469 6c73  kenization_utils
+00000350: 5f62 6173 6520 696d 706f 7274 2042 6174  _base import Bat
+00000360: 6368 456e 636f 6469 6e67 2c20 5061 6464  chEncoding, Padd
+00000370: 696e 6753 7472 6174 6567 792c 2050 7265  ingStrategy, Pre
+00000380: 546f 6b65 6e69 7a65 6449 6e70 7574 2c20  TokenizedInput, 
+00000390: 5465 7874 496e 7075 742c 2054 7275 6e63  TextInput, Trunc
+000003a0: 6174 696f 6e53 7472 6174 6567 790a 6672  ationStrategy.fr
+000003b0: 6f6d 202e 2e2e 2e75 7469 6c73 2069 6d70  om ....utils imp
+000003c0: 6f72 7420 5465 6e73 6f72 5479 7065 0a0a  ort TensorType..
+000003d0: 0a63 6c61 7373 2042 7269 6467 6554 6f77  .class BridgeTow
+000003e0: 6572 5072 6f63 6573 736f 7228 5072 6f63  erProcessor(Proc
+000003f0: 6573 736f 724d 6978 696e 293a 0a20 2020  essorMixin):.   
+00000400: 2072 2222 220a 2020 2020 436f 6e73 7472   r""".    Constr
+00000410: 7563 7473 2061 2042 7269 6467 6554 6f77  ucts a BridgeTow
+00000420: 6572 2070 726f 6365 7373 6f72 2077 6869  er processor whi
+00000430: 6368 2077 7261 7073 2061 2052 6f62 6572  ch wraps a Rober
+00000440: 7461 2074 6f6b 656e 697a 6572 2061 6e64  ta tokenizer and
+00000450: 2042 7269 6467 6554 6f77 6572 2069 6d61   BridgeTower ima
+00000460: 6765 2070 726f 6365 7373 6f72 2069 6e74  ge processor int
+00000470: 6f20 6120 7369 6e67 6c65 0a20 2020 2070  o a single.    p
+00000480: 726f 6365 7373 6f72 2e0a 0a20 2020 205b  rocessor...    [
+00000490: 6042 7269 6467 6554 6f77 6572 5072 6f63  `BridgeTowerProc
+000004a0: 6573 736f 7260 5d20 6f66 6665 7273 2061  essor`] offers a
+000004b0: 6c6c 2074 6865 2066 756e 6374 696f 6e61  ll the functiona
+000004c0: 6c69 7469 6573 206f 6620 5b60 4272 6964  lities of [`Brid
+000004d0: 6765 546f 7765 7249 6d61 6765 5072 6f63  geTowerImageProc
+000004e0: 6573 736f 7260 5d20 616e 640a 2020 2020  essor`] and.    
+000004f0: 5b60 526f 6265 7274 6154 6f6b 656e 697a  [`RobertaTokeniz
+00000500: 6572 4661 7374 605d 2e20 5365 6520 7468  erFast`]. See th
+00000510: 6520 646f 6373 7472 696e 6720 6f66 205b  e docstring of [
+00000520: 607e 4272 6964 6765 546f 7765 7250 726f  `~BridgeTowerPro
+00000530: 6365 7373 6f72 2e5f 5f63 616c 6c5f 5f60  cessor.__call__`
+00000540: 5d20 616e 640a 2020 2020 5b60 7e42 7269  ] and.    [`~Bri
+00000550: 6467 6554 6f77 6572 5072 6f63 6573 736f  dgeTowerProcesso
+00000560: 722e 6465 636f 6465 605d 2066 6f72 206d  r.decode`] for m
+00000570: 6f72 6520 696e 666f 726d 6174 696f 6e2e  ore information.
+00000580: 0a0a 2020 2020 4172 6773 3a0a 2020 2020  ..    Args:.    
+00000590: 2020 2020 696d 6167 655f 7072 6f63 6573      image_proces
+000005a0: 736f 7220 2860 4272 6964 6765 546f 7765  sor (`BridgeTowe
+000005b0: 7249 6d61 6765 5072 6f63 6573 736f 7260  rImageProcessor`
+000005c0: 293a 0a20 2020 2020 2020 2020 2020 2041  ):.            A
+000005d0: 6e20 696e 7374 616e 6365 206f 6620 5b60  n instance of [`
+000005e0: 4272 6964 6765 546f 7765 7249 6d61 6765  BridgeTowerImage
+000005f0: 5072 6f63 6573 736f 7260 5d2e 2054 6865  Processor`]. The
+00000600: 2069 6d61 6765 2070 726f 6365 7373 6f72   image processor
+00000610: 2069 7320 6120 7265 7175 6972 6564 2069   is a required i
+00000620: 6e70 7574 2e0a 2020 2020 2020 2020 746f  nput..        to
+00000630: 6b65 6e69 7a65 7220 2860 526f 6265 7274  kenizer (`Robert
+00000640: 6154 6f6b 656e 697a 6572 4661 7374 6029  aTokenizerFast`)
+00000650: 3a0a 2020 2020 2020 2020 2020 2020 416e  :.            An
+00000660: 2069 6e73 7461 6e63 6520 6f66 205b 2752   instance of ['R
+00000670: 6f62 6572 7461 546f 6b65 6e69 7a65 7246  obertaTokenizerF
+00000680: 6173 7460 5d2e 2054 6865 2074 6f6b 656e  ast`]. The token
+00000690: 697a 6572 2069 7320 6120 7265 7175 6972  izer is a requir
+000006a0: 6564 2069 6e70 7574 2e0a 2020 2020 2222  ed input..    ""
+000006b0: 220a 0a20 2020 2061 7474 7269 6275 7465  "..    attribute
+000006c0: 7320 3d20 5b22 696d 6167 655f 7072 6f63  s = ["image_proc
+000006d0: 6573 736f 7222 2c20 2274 6f6b 656e 697a  essor", "tokeniz
+000006e0: 6572 225d 0a20 2020 2069 6d61 6765 5f70  er"].    image_p
+000006f0: 726f 6365 7373 6f72 5f63 6c61 7373 203d  rocessor_class =
+00000700: 2022 4272 6964 6765 546f 7765 7249 6d61   "BridgeTowerIma
+00000710: 6765 5072 6f63 6573 736f 7222 0a20 2020  geProcessor".   
+00000720: 2074 6f6b 656e 697a 6572 5f63 6c61 7373   tokenizer_class
+00000730: 203d 2028 2252 6f62 6572 7461 546f 6b65   = ("RobertaToke
+00000740: 6e69 7a65 7222 2c20 2252 6f62 6572 7461  nizer", "Roberta
+00000750: 546f 6b65 6e69 7a65 7246 6173 7422 290a  TokenizerFast").
+00000760: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+00000770: 5f28 7365 6c66 2c20 696d 6167 655f 7072  _(self, image_pr
+00000780: 6f63 6573 736f 722c 2074 6f6b 656e 697a  ocessor, tokeniz
+00000790: 6572 293a 0a20 2020 2020 2020 2073 7570  er):.        sup
+000007a0: 6572 2829 2e5f 5f69 6e69 745f 5f28 696d  er().__init__(im
+000007b0: 6167 655f 7072 6f63 6573 736f 722c 2074  age_processor, t
+000007c0: 6f6b 656e 697a 6572 290a 0a20 2020 2064  okenizer)..    d
+000007d0: 6566 205f 5f63 616c 6c5f 5f28 0a20 2020  ef __call__(.   
+000007e0: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+000007f0: 2020 2069 6d61 6765 732c 0a20 2020 2020     images,.     
+00000800: 2020 2074 6578 743a 2055 6e69 6f6e 5b54     text: Union[T
+00000810: 6578 7449 6e70 7574 2c20 5072 6554 6f6b  extInput, PreTok
+00000820: 656e 697a 6564 496e 7075 742c 204c 6973  enizedInput, Lis
+00000830: 745b 5465 7874 496e 7075 745d 2c20 4c69  t[TextInput], Li
+00000840: 7374 5b50 7265 546f 6b65 6e69 7a65 6449  st[PreTokenizedI
+00000850: 6e70 7574 5d5d 203d 204e 6f6e 652c 0a20  nput]] = None,. 
+00000860: 2020 2020 2020 2061 6464 5f73 7065 6369         add_speci
+00000870: 616c 5f74 6f6b 656e 733a 2062 6f6f 6c20  al_tokens: bool 
+00000880: 3d20 5472 7565 2c0a 2020 2020 2020 2020  = True,.        
+00000890: 7061 6464 696e 673a 2055 6e69 6f6e 5b62  padding: Union[b
+000008a0: 6f6f 6c2c 2073 7472 2c20 5061 6464 696e  ool, str, Paddin
+000008b0: 6753 7472 6174 6567 795d 203d 2046 616c  gStrategy] = Fal
+000008c0: 7365 2c0a 2020 2020 2020 2020 7472 756e  se,.        trun
+000008d0: 6361 7469 6f6e 3a20 556e 696f 6e5b 626f  cation: Union[bo
+000008e0: 6f6c 2c20 7374 722c 2054 7275 6e63 6174  ol, str, Truncat
+000008f0: 696f 6e53 7472 6174 6567 795d 203d 204e  ionStrategy] = N
+00000900: 6f6e 652c 0a20 2020 2020 2020 206d 6178  one,.        max
+00000910: 5f6c 656e 6774 683a 204f 7074 696f 6e61  _length: Optiona
+00000920: 6c5b 696e 745d 203d 204e 6f6e 652c 0a20  l[int] = None,. 
+00000930: 2020 2020 2020 2073 7472 6964 653a 2069         stride: i
+00000940: 6e74 203d 2030 2c0a 2020 2020 2020 2020  nt = 0,.        
+00000950: 7061 645f 746f 5f6d 756c 7469 706c 655f  pad_to_multiple_
+00000960: 6f66 3a20 4f70 7469 6f6e 616c 5b69 6e74  of: Optional[int
+00000970: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+00000980: 2020 7265 7475 726e 5f74 6f6b 656e 5f74    return_token_t
+00000990: 7970 655f 6964 733a 204f 7074 696f 6e61  ype_ids: Optiona
+000009a0: 6c5b 626f 6f6c 5d20 3d20 4e6f 6e65 2c0a  l[bool] = None,.
+000009b0: 2020 2020 2020 2020 7265 7475 726e 5f61          return_a
+000009c0: 7474 656e 7469 6f6e 5f6d 6173 6b3a 204f  ttention_mask: O
+000009d0: 7074 696f 6e61 6c5b 626f 6f6c 5d20 3d20  ptional[bool] = 
+000009e0: 4e6f 6e65 2c0a 2020 2020 2020 2020 7265  None,.        re
+000009f0: 7475 726e 5f6f 7665 7266 6c6f 7769 6e67  turn_overflowing
+00000a00: 5f74 6f6b 656e 733a 2062 6f6f 6c20 3d20  _tokens: bool = 
+00000a10: 4661 6c73 652c 0a20 2020 2020 2020 2072  False,.        r
+00000a20: 6574 7572 6e5f 7370 6563 6961 6c5f 746f  eturn_special_to
+00000a30: 6b65 6e73 5f6d 6173 6b3a 2062 6f6f 6c20  kens_mask: bool 
+00000a40: 3d20 4661 6c73 652c 0a20 2020 2020 2020  = False,.       
+00000a50: 2072 6574 7572 6e5f 6f66 6673 6574 735f   return_offsets_
+00000a60: 6d61 7070 696e 673a 2062 6f6f 6c20 3d20  mapping: bool = 
+00000a70: 4661 6c73 652c 0a20 2020 2020 2020 2072  False,.        r
+00000a80: 6574 7572 6e5f 6c65 6e67 7468 3a20 626f  eturn_length: bo
+00000a90: 6f6c 203d 2046 616c 7365 2c0a 2020 2020  ol = False,.    
+00000aa0: 2020 2020 7665 7262 6f73 653a 2062 6f6f      verbose: boo
+00000ab0: 6c20 3d20 5472 7565 2c0a 2020 2020 2020  l = True,.      
+00000ac0: 2020 7265 7475 726e 5f74 656e 736f 7273    return_tensors
+00000ad0: 3a20 4f70 7469 6f6e 616c 5b55 6e69 6f6e  : Optional[Union
+00000ae0: 5b73 7472 2c20 5465 6e73 6f72 5479 7065  [str, TensorType
+00000af0: 5d5d 203d 204e 6f6e 652c 0a20 2020 2020  ]] = None,.     
+00000b00: 2020 202a 2a6b 7761 7267 732c 0a20 2020     **kwargs,.   
+00000b10: 2029 202d 3e20 4261 7463 6845 6e63 6f64   ) -> BatchEncod
+00000b20: 696e 673a 0a20 2020 2020 2020 2022 2222  ing:.        """
+00000b30: 0a20 2020 2020 2020 2054 6869 7320 6d65  .        This me
+00000b40: 7468 6f64 2075 7365 7320 5b60 4272 6964  thod uses [`Brid
+00000b50: 6765 546f 7765 7249 6d61 6765 5072 6f63  geTowerImageProc
+00000b60: 6573 736f 722e 5f5f 6361 6c6c 5f5f 605d  essor.__call__`]
+00000b70: 206d 6574 686f 6420 746f 2070 7265 7061   method to prepa
+00000b80: 7265 2069 6d61 6765 2873 2920 666f 7220  re image(s) for 
+00000b90: 7468 6520 6d6f 6465 6c2c 2061 6e64 0a20  the model, and. 
+00000ba0: 2020 2020 2020 205b 6052 6f62 6572 7461         [`Roberta
+00000bb0: 546f 6b65 6e69 7a65 7246 6173 742e 5f5f  TokenizerFast.__
+00000bc0: 6361 6c6c 5f5f 605d 2074 6f20 7072 6570  call__`] to prep
+00000bd0: 6172 6520 7465 7874 2066 6f72 2074 6865  are text for the
+00000be0: 206d 6f64 656c 2e0a 0a20 2020 2020 2020   model...       
+00000bf0: 2050 6c65 6173 6520 7265 6665 7220 746f   Please refer to
+00000c00: 2074 6865 2064 6f63 7374 7269 6e67 206f   the docstring o
+00000c10: 6620 7468 6520 6162 6f76 6520 7477 6f20  f the above two 
+00000c20: 6d65 7468 6f64 7320 666f 7220 6d6f 7265  methods for more
+00000c30: 2069 6e66 6f72 6d61 7469 6f6e 2e0a 2020   information..  
+00000c40: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00000c50: 2020 656e 636f 6469 6e67 203d 2073 656c    encoding = sel
+00000c60: 662e 746f 6b65 6e69 7a65 7228 0a20 2020  f.tokenizer(.   
+00000c70: 2020 2020 2020 2020 2074 6578 743d 7465           text=te
+00000c80: 7874 2c0a 2020 2020 2020 2020 2020 2020  xt,.            
+00000c90: 6164 645f 7370 6563 6961 6c5f 746f 6b65  add_special_toke
+00000ca0: 6e73 3d61 6464 5f73 7065 6369 616c 5f74  ns=add_special_t
+00000cb0: 6f6b 656e 732c 0a20 2020 2020 2020 2020  okens,.         
+00000cc0: 2020 2070 6164 6469 6e67 3d70 6164 6469     padding=paddi
+00000cd0: 6e67 2c0a 2020 2020 2020 2020 2020 2020  ng,.            
+00000ce0: 7472 756e 6361 7469 6f6e 3d74 7275 6e63  truncation=trunc
+00000cf0: 6174 696f 6e2c 0a20 2020 2020 2020 2020  ation,.         
+00000d00: 2020 206d 6178 5f6c 656e 6774 683d 6d61     max_length=ma
+00000d10: 785f 6c65 6e67 7468 2c0a 2020 2020 2020  x_length,.      
+00000d20: 2020 2020 2020 7374 7269 6465 3d73 7472        stride=str
+00000d30: 6964 652c 0a20 2020 2020 2020 2020 2020  ide,.           
+00000d40: 2070 6164 5f74 6f5f 6d75 6c74 6970 6c65   pad_to_multiple
+00000d50: 5f6f 663d 7061 645f 746f 5f6d 756c 7469  _of=pad_to_multi
+00000d60: 706c 655f 6f66 2c0a 2020 2020 2020 2020  ple_of,.        
+00000d70: 2020 2020 7265 7475 726e 5f74 6f6b 656e      return_token
+00000d80: 5f74 7970 655f 6964 733d 7265 7475 726e  _type_ids=return
+00000d90: 5f74 6f6b 656e 5f74 7970 655f 6964 732c  _token_type_ids,
+00000da0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00000db0: 7572 6e5f 6174 7465 6e74 696f 6e5f 6d61  urn_attention_ma
+00000dc0: 736b 3d72 6574 7572 6e5f 6174 7465 6e74  sk=return_attent
+00000dd0: 696f 6e5f 6d61 736b 2c0a 2020 2020 2020  ion_mask,.      
+00000de0: 2020 2020 2020 7265 7475 726e 5f6f 7665        return_ove
+00000df0: 7266 6c6f 7769 6e67 5f74 6f6b 656e 733d  rflowing_tokens=
+00000e00: 7265 7475 726e 5f6f 7665 7266 6c6f 7769  return_overflowi
+00000e10: 6e67 5f74 6f6b 656e 732c 0a20 2020 2020  ng_tokens,.     
+00000e20: 2020 2020 2020 2072 6574 7572 6e5f 7370         return_sp
+00000e30: 6563 6961 6c5f 746f 6b65 6e73 5f6d 6173  ecial_tokens_mas
+00000e40: 6b3d 7265 7475 726e 5f73 7065 6369 616c  k=return_special
+00000e50: 5f74 6f6b 656e 735f 6d61 736b 2c0a 2020  _tokens_mask,.  
+00000e60: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00000e70: 5f6f 6666 7365 7473 5f6d 6170 7069 6e67  _offsets_mapping
+00000e80: 3d72 6574 7572 6e5f 6f66 6673 6574 735f  =return_offsets_
+00000e90: 6d61 7070 696e 672c 0a20 2020 2020 2020  mapping,.       
+00000ea0: 2020 2020 2072 6574 7572 6e5f 6c65 6e67       return_leng
+00000eb0: 7468 3d72 6574 7572 6e5f 6c65 6e67 7468  th=return_length
+00000ec0: 2c0a 2020 2020 2020 2020 2020 2020 7665  ,.            ve
+00000ed0: 7262 6f73 653d 7665 7262 6f73 652c 0a20  rbose=verbose,. 
+00000ee0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00000ef0: 6e5f 7465 6e73 6f72 733d 7265 7475 726e  n_tensors=return
+00000f00: 5f74 656e 736f 7273 2c0a 2020 2020 2020  _tensors,.      
+00000f10: 2020 2020 2020 2a2a 6b77 6172 6773 2c0a        **kwargs,.
+00000f20: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00000f30: 2020 2320 6164 6420 7069 7865 6c5f 7661    # add pixel_va
+00000f40: 6c75 6573 202b 2070 6978 656c 5f6d 6173  lues + pixel_mas
+00000f50: 6b0a 2020 2020 2020 2020 656e 636f 6469  k.        encodi
+00000f60: 6e67 5f69 6d61 6765 5f70 726f 6365 7373  ng_image_process
+00000f70: 6f72 203d 2073 656c 662e 696d 6167 655f  or = self.image_
+00000f80: 7072 6f63 6573 736f 7228 0a20 2020 2020  processor(.     
+00000f90: 2020 2020 2020 2069 6d61 6765 732c 2072         images, r
+00000fa0: 6574 7572 6e5f 7465 6e73 6f72 733d 7265  eturn_tensors=re
+00000fb0: 7475 726e 5f74 656e 736f 7273 2c20 646f  turn_tensors, do
+00000fc0: 5f6e 6f72 6d61 6c69 7a65 3d54 7275 652c  _normalize=True,
+00000fd0: 2064 6f5f 6365 6e74 6572 5f63 726f 703d   do_center_crop=
+00000fe0: 5472 7565 2c20 2a2a 6b77 6172 6773 0a20  True, **kwargs. 
+00000ff0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00001000: 2065 6e63 6f64 696e 672e 7570 6461 7465   encoding.update
+00001010: 2865 6e63 6f64 696e 675f 696d 6167 655f  (encoding_image_
+00001020: 7072 6f63 6573 736f 7229 0a0a 2020 2020  processor)..    
+00001030: 2020 2020 7265 7475 726e 2065 6e63 6f64      return encod
+00001040: 696e 670a 0a20 2020 2064 6566 2062 6174  ing..    def bat
+00001050: 6368 5f64 6563 6f64 6528 7365 6c66 2c20  ch_decode(self, 
+00001060: 2a61 7267 732c 202a 2a6b 7761 7267 7329  *args, **kwargs)
+00001070: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+00001080: 2020 2020 2020 5468 6973 206d 6574 686f        This metho
+00001090: 6420 666f 7277 6172 6473 2061 6c6c 2069  d forwards all i
+000010a0: 7473 2061 7267 756d 656e 7473 2074 6f20  ts arguments to 
+000010b0: 526f 6265 7274 6154 6f6b 656e 697a 6572  RobertaTokenizer
+000010c0: 4661 7374 2773 205b 607e 5072 6554 7261  Fast's [`~PreTra
+000010d0: 696e 6564 546f 6b65 6e69 7a65 722e 6261  inedTokenizer.ba
+000010e0: 7463 685f 6465 636f 6465 605d 2e20 506c  tch_decode`]. Pl
+000010f0: 6561 7365 0a20 2020 2020 2020 2072 6566  ease.        ref
+00001100: 6572 2074 6f20 7468 6520 646f 6373 7472  er to the docstr
+00001110: 696e 6720 6f66 2074 6869 7320 6d65 7468  ing of this meth
+00001120: 6f64 2066 6f72 206d 6f72 6520 696e 666f  od for more info
+00001130: 726d 6174 696f 6e2e 0a20 2020 2020 2020  rmation..       
+00001140: 2022 2222 0a20 2020 2020 2020 2072 6574   """.        ret
+00001150: 7572 6e20 7365 6c66 2e74 6f6b 656e 697a  urn self.tokeniz
+00001160: 6572 2e62 6174 6368 5f64 6563 6f64 6528  er.batch_decode(
+00001170: 2a61 7267 732c 202a 2a6b 7761 7267 7329  *args, **kwargs)
+00001180: 0a0a 2020 2020 6465 6620 6465 636f 6465  ..    def decode
+00001190: 2873 656c 662c 202a 6172 6773 2c20 2a2a  (self, *args, **
+000011a0: 6b77 6172 6773 293a 0a20 2020 2020 2020  kwargs):.       
+000011b0: 2022 2222 0a20 2020 2020 2020 2054 6869   """.        Thi
+000011c0: 7320 6d65 7468 6f64 2066 6f72 7761 7264  s method forward
+000011d0: 7320 616c 6c20 6974 7320 6172 6775 6d65  s all its argume
+000011e0: 6e74 7320 746f 2052 6f62 6572 7461 546f  nts to RobertaTo
+000011f0: 6b65 6e69 7a65 7246 6173 7427 7320 5b60  kenizerFast's [`
+00001200: 7e50 7265 5472 6169 6e65 6454 6f6b 656e  ~PreTrainedToken
+00001210: 697a 6572 2e64 6563 6f64 6560 5d2e 2050  izer.decode`]. P
+00001220: 6c65 6173 6520 7265 6665 720a 2020 2020  lease refer.    
+00001230: 2020 2020 746f 2074 6865 2064 6f63 7374      to the docst
+00001240: 7269 6e67 206f 6620 7468 6973 206d 6574  ring of this met
+00001250: 686f 6420 666f 7220 6d6f 7265 2069 6e66  hod for more inf
+00001260: 6f72 6d61 7469 6f6e 2e0a 2020 2020 2020  ormation..      
+00001270: 2020 2222 220a 2020 2020 2020 2020 7265    """.        re
+00001280: 7475 726e 2073 656c 662e 746f 6b65 6e69  turn self.tokeni
+00001290: 7a65 722e 6465 636f 6465 282a 6172 6773  zer.decode(*args
+000012a0: 2c20 2a2a 6b77 6172 6773 290a 0a20 2020  , **kwargs)..   
+000012b0: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
+000012c0: 6566 206d 6f64 656c 5f69 6e70 7574 5f6e  ef model_input_n
+000012d0: 616d 6573 2873 656c 6629 3a0a 2020 2020  ames(self):.    
+000012e0: 2020 2020 746f 6b65 6e69 7a65 725f 696e      tokenizer_in
+000012f0: 7075 745f 6e61 6d65 7320 3d20 7365 6c66  put_names = self
+00001300: 2e74 6f6b 656e 697a 6572 2e6d 6f64 656c  .tokenizer.model
+00001310: 5f69 6e70 7574 5f6e 616d 6573 0a20 2020  _input_names.   
+00001320: 2020 2020 2069 6d61 6765 5f70 726f 6365       image_proce
+00001330: 7373 6f72 5f69 6e70 7574 5f6e 616d 6573  ssor_input_names
+00001340: 203d 2073 656c 662e 696d 6167 655f 7072   = self.image_pr
+00001350: 6f63 6573 736f 722e 6d6f 6465 6c5f 696e  ocessor.model_in
+00001360: 7075 745f 6e61 6d65 730a 2020 2020 2020  put_names.      
+00001370: 2020 7265 7475 726e 206c 6973 7428 6469    return list(di
+00001380: 6374 2e66 726f 6d6b 6579 7328 746f 6b65  ct.fromkeys(toke
+00001390: 6e69 7a65 725f 696e 7075 745f 6e61 6d65  nizer_input_name
+000013a0: 7320 2b20 696d 6167 655f 7072 6f63 6573  s + image_proces
+000013b0: 736f 725f 696e 7075 745f 6e61 6d65 7329  sor_input_names)
+000013c0: 290a 0a5f 5f61 6c6c 5f5f 203d 205b 2742  )..__all__ = ['B
+000013d0: 7269 6467 6554 6f77 6572 5072 6f63 6573  ridgeTowerProces
+000013e0: 736f 7227 5d0a                           sor'].
```

## mindnlp/transformers/models/bros/__init__.py

```diff
@@ -0,0 +1,62 @@
+00000000: 2320 436f 7079 7269 6768 7420 3230 3234  # Copyright 2024
+00000010: 2048 7561 7765 6920 5465 6368 6e6f 6c6f   Huawei Technolo
+00000020: 6769 6573 2043 6f2e 2c20 4c74 640a 230a  gies Co., Ltd.#.
+00000030: 2320 4c69 6365 6e73 6564 2075 6e64 6572  # Licensed under
+00000040: 2074 6865 2041 7061 6368 6520 4c69 6365   the Apache Lice
+00000050: 6e73 652c 2056 6572 7369 6f6e 2032 2e30  nse, Version 2.0
+00000060: 2028 7468 6520 224c 6963 656e 7365 2229   (the "License")
+00000070: 3b0a 2320 796f 7520 6d61 7920 6e6f 7420  ;.# you may not 
+00000080: 7573 6520 7468 6973 2066 696c 6520 6578  use this file ex
+00000090: 6365 7074 2069 6e20 636f 6d70 6c69 616e  cept in complian
+000000a0: 6365 2077 6974 6820 7468 6520 4c69 6365  ce with the Lice
+000000b0: 6e73 652e 0a23 2059 6f75 206d 6179 206f  nse..# You may o
+000000c0: 6274 6169 6e20 6120 636f 7079 206f 6620  btain a copy of 
+000000d0: 7468 6520 4c69 6365 6e73 6520 6174 0a23  the License at.#
+000000e0: 0a23 2068 7474 703a 2f2f 7777 772e 6170  .# http://www.ap
+000000f0: 6163 6865 2e6f 7267 2f6c 6963 656e 7365  ache.org/license
+00000100: 732f 4c49 4345 4e53 452d 322e 300a 230a  s/LICENSE-2.0.#.
+00000110: 2320 556e 6c65 7373 2072 6571 7569 7265  # Unless require
+00000120: 6420 6279 2061 7070 6c69 6361 626c 6520  d by applicable 
+00000130: 6c61 7720 6f72 2061 6772 6565 6420 746f  law or agreed to
+00000140: 2069 6e20 7772 6974 696e 672c 2073 6f66   in writing, sof
+00000150: 7477 6172 650a 2320 6469 7374 7269 6275  tware.# distribu
+00000160: 7465 6420 756e 6465 7220 7468 6520 4c69  ted under the Li
+00000170: 6365 6e73 6520 6973 2064 6973 7472 6962  cense is distrib
+00000180: 7574 6564 206f 6e20 616e 2022 4153 2049  uted on an "AS I
+00000190: 5322 2042 4153 4953 2c0a 2320 5749 5448  S" BASIS,.# WITH
+000001a0: 4f55 5420 5741 5252 414e 5449 4553 204f  OUT WARRANTIES O
+000001b0: 5220 434f 4e44 4954 494f 4e53 204f 4620  R CONDITIONS OF 
+000001c0: 414e 5920 4b49 4e44 2c20 6569 7468 6572  ANY KIND, either
+000001d0: 2065 7870 7265 7373 206f 7220 696d 706c   express or impl
+000001e0: 6965 642e 0a23 2053 6565 2074 6865 204c  ied..# See the L
+000001f0: 6963 656e 7365 2066 6f72 2074 6865 2073  icense for the s
+00000200: 7065 6369 6669 6320 6c61 6e67 7561 6765  pecific language
+00000210: 2067 6f76 6572 6e69 6e67 2070 6572 6d69   governing permi
+00000220: 7373 696f 6e73 2061 6e64 0a23 206c 696d  ssions and.# lim
+00000230: 6974 6174 696f 6e73 2075 6e64 6572 2074  itations under t
+00000240: 6865 204c 6963 656e 7365 2e0a 2320 3d3d  he License..# ==
+00000250: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00000260: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00000270: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00000280: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00000290: 3d3d 3d3d 3d3d 3d3d 3d3d 0a22 2222 0a42  ==========.""".B
+000002a0: 726f 7320 4d6f 6465 6c2e 0a22 2222 0a66  ros Model..""".f
+000002b0: 726f 6d20 2e20 696d 706f 7274 2063 6f6e  rom . import con
+000002c0: 6669 6775 7261 7469 6f6e 5f62 726f 732c  figuration_bros,
+000002d0: 206d 6f64 656c 696e 675f 6272 6f73 2c20   modeling_bros, 
+000002e0: 7072 6f63 6573 7369 6e67 5f62 726f 730a  processing_bros.
+000002f0: 6672 6f6d 202e 636f 6e66 6967 7572 6174  from .configurat
+00000300: 696f 6e5f 6272 6f73 2069 6d70 6f72 7420  ion_bros import 
+00000310: 2a0a 6672 6f6d 202e 6d6f 6465 6c69 6e67  *.from .modeling
+00000320: 5f62 726f 7320 696d 706f 7274 202a 0a66  _bros import *.f
+00000330: 726f 6d20 2e70 726f 6365 7373 696e 675f  rom .processing_
+00000340: 6272 6f73 2069 6d70 6f72 7420 2a0a 0a5f  bros import *.._
+00000350: 5f61 6c6c 5f5f 203d 205b 5d0a 5f5f 616c  _all__ = [].__al
+00000360: 6c5f 5f2e 6578 7465 6e64 2863 6f6e 6669  l__.extend(confi
+00000370: 6775 7261 7469 6f6e 5f62 726f 732e 5f5f  guration_bros.__
+00000380: 616c 6c5f 5f29 0a5f 5f61 6c6c 5f5f 2e65  all__).__all__.e
+00000390: 7874 656e 6428 6d6f 6465 6c69 6e67 5f62  xtend(modeling_b
+000003a0: 726f 732e 5f5f 616c 6c5f 5f29 0a5f 5f61  ros.__all__).__a
+000003b0: 6c6c 5f5f 2e65 7874 656e 6428 7072 6f63  ll__.extend(proc
+000003c0: 6573 7369 6e67 5f62 726f 732e 5f5f 616c  essing_bros.__al
+000003d0: 6c5f 5f29 0a                             l__).
```

## mindnlp/transformers/models/bros/configuration_bros.py

```diff
@@ -0,0 +1,402 @@
+00000000: 2320 636f 6469 6e67 3d75 7466 2d38 0a23  # coding=utf-8.#
+00000010: 2043 6f70 7972 6967 6874 2032 3032 332d   Copyright 2023-
+00000020: 7072 6573 656e 7420 4e41 5645 5220 436f  present NAVER Co
+00000030: 7270 2c20 5468 6520 4d69 6372 6f73 6f66  rp, The Microsof
+00000040: 7420 5265 7365 6172 6368 2041 7369 6120  t Research Asia 
+00000050: 4c61 796f 7574 4c4d 2054 6561 6d20 4175  LayoutLM Team Au
+00000060: 7468 6f72 7320 616e 6420 7468 6520 4875  thors and the Hu
+00000070: 6767 696e 6746 6163 6520 496e 632e 2074  ggingFace Inc. t
+00000080: 6561 6d2e 0a23 0a23 204c 6963 656e 7365  eam..#.# License
+00000090: 6420 756e 6465 7220 7468 6520 4170 6163  d under the Apac
+000000a0: 6865 204c 6963 656e 7365 2c20 5665 7273  he License, Vers
+000000b0: 696f 6e20 322e 3020 2874 6865 2022 4c69  ion 2.0 (the "Li
+000000c0: 6365 6e73 6522 293b 0a23 2079 6f75 206d  cense");.# you m
+000000d0: 6179 206e 6f74 2075 7365 2074 6869 7320  ay not use this 
+000000e0: 6669 6c65 2065 7863 6570 7420 696e 2063  file except in c
+000000f0: 6f6d 706c 6961 6e63 6520 7769 7468 2074  ompliance with t
+00000100: 6865 204c 6963 656e 7365 2e0a 2320 596f  he License..# Yo
+00000110: 7520 6d61 7920 6f62 7461 696e 2061 2063  u may obtain a c
+00000120: 6f70 7920 6f66 2074 6865 204c 6963 656e  opy of the Licen
+00000130: 7365 2061 740a 230a 2320 2020 2020 6874  se at.#.#     ht
+00000140: 7470 3a2f 2f77 7777 2e61 7061 6368 652e  tp://www.apache.
+00000150: 6f72 672f 6c69 6365 6e73 6573 2f4c 4943  org/licenses/LIC
+00000160: 454e 5345 2d32 2e30 0a23 0a23 2055 6e6c  ENSE-2.0.#.# Unl
+00000170: 6573 7320 7265 7175 6972 6564 2062 7920  ess required by 
+00000180: 6170 706c 6963 6162 6c65 206c 6177 206f  applicable law o
+00000190: 7220 6167 7265 6564 2074 6f20 696e 2077  r agreed to in w
+000001a0: 7269 7469 6e67 2c20 736f 6674 7761 7265  riting, software
+000001b0: 0a23 2064 6973 7472 6962 7574 6564 2075  .# distributed u
+000001c0: 6e64 6572 2074 6865 204c 6963 656e 7365  nder the License
+000001d0: 2069 7320 6469 7374 7269 6275 7465 6420   is distributed 
+000001e0: 6f6e 2061 6e20 2241 5320 4953 2220 4241  on an "AS IS" BA
+000001f0: 5349 532c 0a23 2057 4954 484f 5554 2057  SIS,.# WITHOUT W
+00000200: 4152 5241 4e54 4945 5320 4f52 2043 4f4e  ARRANTIES OR CON
+00000210: 4449 5449 4f4e 5320 4f46 2041 4e59 204b  DITIONS OF ANY K
+00000220: 494e 442c 2065 6974 6865 7220 6578 7072  IND, either expr
+00000230: 6573 7320 6f72 2069 6d70 6c69 6564 2e0a  ess or implied..
+00000240: 2320 5365 6520 7468 6520 4c69 6365 6e73  # See the Licens
+00000250: 6520 666f 7220 7468 6520 7370 6563 6966  e for the specif
+00000260: 6963 206c 616e 6775 6167 6520 676f 7665  ic language gove
+00000270: 726e 696e 6720 7065 726d 6973 7369 6f6e  rning permission
+00000280: 7320 616e 640a 2320 6c69 6d69 7461 7469  s and.# limitati
+00000290: 6f6e 7320 756e 6465 7220 7468 6520 4c69  ons under the Li
+000002a0: 6365 6e73 652e 0a22 2222 2042 726f 7320  cense..""" Bros 
+000002b0: 6d6f 6465 6c20 636f 6e66 6967 7572 6174  model configurat
+000002c0: 696f 6e22 2222 0a0a 6672 6f6d 202e 2e2e  ion"""..from ...
+000002d0: 636f 6e66 6967 7572 6174 696f 6e5f 7574  configuration_ut
+000002e0: 696c 7320 696d 706f 7274 2050 7265 7472  ils import Pretr
+000002f0: 6169 6e65 6443 6f6e 6669 670a 6672 6f6d  ainedConfig.from
+00000300: 202e 2e2e 2e75 7469 6c73 2069 6d70 6f72   ....utils impor
+00000310: 7420 6c6f 6767 696e 670a 0a0a 6c6f 6767  t logging...logg
+00000320: 6572 203d 206c 6f67 6769 6e67 2e67 6574  er = logging.get
+00000330: 5f6c 6f67 6765 7228 5f5f 6e61 6d65 5f5f  _logger(__name__
+00000340: 290a 0a0a 636c 6173 7320 4272 6f73 436f  )...class BrosCo
+00000350: 6e66 6967 2850 7265 7472 6169 6e65 6443  nfig(PretrainedC
+00000360: 6f6e 6669 6729 3a0a 2020 2020 7222 2222  onfig):.    r"""
+00000370: 0a20 2020 2054 6869 7320 6973 2074 6865  .    This is the
+00000380: 2063 6f6e 6669 6775 7261 7469 6f6e 2063   configuration c
+00000390: 6c61 7373 2074 6f20 7374 6f72 6520 7468  lass to store th
+000003a0: 6520 636f 6e66 6967 7572 6174 696f 6e20  e configuration 
+000003b0: 6f66 2061 205b 6042 726f 734d 6f64 656c  of a [`BrosModel
+000003c0: 605d 206f 7220 6120 5b60 5446 4272 6f73  `] or a [`TFBros
+000003d0: 4d6f 6465 6c60 5d2e 2049 7420 6973 2075  Model`]. It is u
+000003e0: 7365 6420 746f 0a20 2020 2069 6e73 7461  sed to.    insta
+000003f0: 6e74 6961 7465 2061 2042 726f 7320 6d6f  ntiate a Bros mo
+00000400: 6465 6c20 6163 636f 7264 696e 6720 746f  del according to
+00000410: 2074 6865 2073 7065 6369 6669 6564 2061   the specified a
+00000420: 7267 756d 656e 7473 2c20 6465 6669 6e69  rguments, defini
+00000430: 6e67 2074 6865 206d 6f64 656c 2061 7263  ng the model arc
+00000440: 6869 7465 6374 7572 652e 2049 6e73 7461  hitecture. Insta
+00000450: 6e74 6961 7469 6e67 2061 0a20 2020 2063  ntiating a.    c
+00000460: 6f6e 6669 6775 7261 7469 6f6e 2077 6974  onfiguration wit
+00000470: 6820 7468 6520 6465 6661 756c 7473 2077  h the defaults w
+00000480: 696c 6c20 7969 656c 6420 6120 7369 6d69  ill yield a simi
+00000490: 6c61 7220 636f 6e66 6967 7572 6174 696f  lar configuratio
+000004a0: 6e20 746f 2074 6861 7420 6f66 2074 6865  n to that of the
+000004b0: 2042 726f 730a 2020 2020 5b6a 696e 686f   Bros.    [jinho
+000004c0: 3833 3435 2f62 726f 732d 6261 7365 2d75  8345/bros-base-u
+000004d0: 6e63 6173 6564 5d28 6874 7470 733a 2f2f  ncased](https://
+000004e0: 6875 6767 696e 6766 6163 652e 636f 2f6a  huggingface.co/j
+000004f0: 696e 686f 3833 3435 2f62 726f 732d 6261  inho8345/bros-ba
+00000500: 7365 2d75 6e63 6173 6564 2920 6172 6368  se-uncased) arch
+00000510: 6974 6563 7475 7265 2e0a 0a20 2020 2043  itecture...    C
+00000520: 6f6e 6669 6775 7261 7469 6f6e 206f 626a  onfiguration obj
+00000530: 6563 7473 2069 6e68 6572 6974 2066 726f  ects inherit fro
+00000540: 6d20 5b60 5072 6574 7261 696e 6564 436f  m [`PretrainedCo
+00000550: 6e66 6967 605d 2061 6e64 2063 616e 2062  nfig`] and can b
+00000560: 6520 7573 6564 2074 6f20 636f 6e74 726f  e used to contro
+00000570: 6c20 7468 6520 6d6f 6465 6c20 6f75 7470  l the model outp
+00000580: 7574 732e 2052 6561 6420 7468 650a 2020  uts. Read the.  
+00000590: 2020 646f 6375 6d65 6e74 6174 696f 6e20    documentation 
+000005a0: 6672 6f6d 205b 6050 7265 7472 6169 6e65  from [`Pretraine
+000005b0: 6443 6f6e 6669 6760 5d20 666f 7220 6d6f  dConfig`] for mo
+000005c0: 7265 2069 6e66 6f72 6d61 7469 6f6e 2e0a  re information..
+000005d0: 0a20 2020 2041 7267 733a 0a20 2020 2020  .    Args:.     
+000005e0: 2020 2076 6f63 6162 5f73 697a 6520 2860     vocab_size (`
+000005f0: 696e 7460 2c20 2a6f 7074 696f 6e61 6c2a  int`, *optional*
+00000600: 2c20 6465 6661 756c 7473 2074 6f20 3330  , defaults to 30
+00000610: 3532 3229 3a0a 2020 2020 2020 2020 2020  522):.          
+00000620: 2020 566f 6361 6275 6c61 7279 2073 697a    Vocabulary siz
+00000630: 6520 6f66 2074 6865 2042 726f 7320 6d6f  e of the Bros mo
+00000640: 6465 6c2e 2044 6566 696e 6573 2074 6865  del. Defines the
+00000650: 206e 756d 6265 7220 6f66 2064 6966 6665   number of diffe
+00000660: 7265 6e74 2074 6f6b 656e 7320 7468 6174  rent tokens that
+00000670: 2063 616e 2062 6520 7265 7072 6573 656e   can be represen
+00000680: 7465 6420 6279 2074 6865 0a20 2020 2020  ted by the.     
+00000690: 2020 2020 2020 2060 696e 7075 7473 5f69         `inputs_i
+000006a0: 6473 6020 7061 7373 6564 2077 6865 6e20  ds` passed when 
+000006b0: 6361 6c6c 696e 6720 5b60 4272 6f73 4d6f  calling [`BrosMo
+000006c0: 6465 6c60 5d20 6f72 205b 6054 4642 726f  del`] or [`TFBro
+000006d0: 734d 6f64 656c 605d 2e0a 2020 2020 2020  sModel`]..      
+000006e0: 2020 6869 6464 656e 5f73 697a 6520 2860    hidden_size (`
+000006f0: 696e 7460 2c20 2a6f 7074 696f 6e61 6c2a  int`, *optional*
+00000700: 2c20 6465 6661 756c 7473 2074 6f20 3736  , defaults to 76
+00000710: 3829 3a0a 2020 2020 2020 2020 2020 2020  8):.            
+00000720: 4469 6d65 6e73 696f 6e61 6c69 7479 206f  Dimensionality o
+00000730: 6620 7468 6520 656e 636f 6465 7220 6c61  f the encoder la
+00000740: 7965 7273 2061 6e64 2074 6865 2070 6f6f  yers and the poo
+00000750: 6c65 7220 6c61 7965 722e 0a20 2020 2020  ler layer..     
+00000760: 2020 206e 756d 5f68 6964 6465 6e5f 6c61     num_hidden_la
+00000770: 7965 7273 2028 6069 6e74 602c 202a 6f70  yers (`int`, *op
+00000780: 7469 6f6e 616c 2a2c 2064 6566 6175 6c74  tional*, default
+00000790: 7320 746f 2031 3229 3a0a 2020 2020 2020  s to 12):.      
+000007a0: 2020 2020 2020 4e75 6d62 6572 206f 6620        Number of 
+000007b0: 6869 6464 656e 206c 6179 6572 7320 696e  hidden layers in
+000007c0: 2074 6865 2054 7261 6e73 666f 726d 6572   the Transformer
+000007d0: 2065 6e63 6f64 6572 2e0a 2020 2020 2020   encoder..      
+000007e0: 2020 6e75 6d5f 6174 7465 6e74 696f 6e5f    num_attention_
+000007f0: 6865 6164 7320 2860 696e 7460 2c20 2a6f  heads (`int`, *o
+00000800: 7074 696f 6e61 6c2a 2c20 6465 6661 756c  ptional*, defaul
+00000810: 7473 2074 6f20 3132 293a 0a20 2020 2020  ts to 12):.     
+00000820: 2020 2020 2020 204e 756d 6265 7220 6f66         Number of
+00000830: 2061 7474 656e 7469 6f6e 2068 6561 6473   attention heads
+00000840: 2066 6f72 2065 6163 6820 6174 7465 6e74   for each attent
+00000850: 696f 6e20 6c61 7965 7220 696e 2074 6865  ion layer in the
+00000860: 2054 7261 6e73 666f 726d 6572 2065 6e63   Transformer enc
+00000870: 6f64 6572 2e0a 2020 2020 2020 2020 696e  oder..        in
+00000880: 7465 726d 6564 6961 7465 5f73 697a 6520  termediate_size 
+00000890: 2860 696e 7460 2c20 2a6f 7074 696f 6e61  (`int`, *optiona
+000008a0: 6c2a 2c20 6465 6661 756c 7473 2074 6f20  l*, defaults to 
+000008b0: 3330 3732 293a 0a20 2020 2020 2020 2020  3072):.         
+000008c0: 2020 2044 696d 656e 7369 6f6e 616c 6974     Dimensionalit
+000008d0: 7920 6f66 2074 6865 2022 696e 7465 726d  y of the "interm
+000008e0: 6564 6961 7465 2220 286f 6674 656e 206e  ediate" (often n
+000008f0: 616d 6564 2066 6565 642d 666f 7277 6172  amed feed-forwar
+00000900: 6429 206c 6179 6572 2069 6e20 7468 6520  d) layer in the 
+00000910: 5472 616e 7366 6f72 6d65 7220 656e 636f  Transformer enco
+00000920: 6465 722e 0a20 2020 2020 2020 2068 6964  der..        hid
+00000930: 6465 6e5f 6163 7420 2860 7374 7260 206f  den_act (`str` o
+00000940: 7220 6043 616c 6c61 626c 6560 2c20 2a6f  r `Callable`, *o
+00000950: 7074 696f 6e61 6c2a 2c20 6465 6661 756c  ptional*, defaul
+00000960: 7473 2074 6f20 6022 6765 6c75 2260 293a  ts to `"gelu"`):
+00000970: 0a20 2020 2020 2020 2020 2020 2054 6865  .            The
+00000980: 206e 6f6e 2d6c 696e 6561 7220 6163 7469   non-linear acti
+00000990: 7661 7469 6f6e 2066 756e 6374 696f 6e20  vation function 
+000009a0: 2866 756e 6374 696f 6e20 6f72 2073 7472  (function or str
+000009b0: 696e 6729 2069 6e20 7468 6520 656e 636f  ing) in the enco
+000009c0: 6465 7220 616e 6420 706f 6f6c 6572 2e20  der and pooler. 
+000009d0: 4966 2073 7472 696e 672c 2060 2267 656c  If string, `"gel
+000009e0: 7522 602c 0a20 2020 2020 2020 2020 2020  u"`,.           
+000009f0: 2060 2272 656c 7522 602c 2060 2273 696c   `"relu"`, `"sil
+00000a00: 7522 6020 616e 6420 6022 6765 6c75 5f6e  u"` and `"gelu_n
+00000a10: 6577 2260 2061 7265 2073 7570 706f 7274  ew"` are support
+00000a20: 6564 2e0a 2020 2020 2020 2020 6869 6464  ed..        hidd
+00000a30: 656e 5f64 726f 706f 7574 5f70 726f 6220  en_dropout_prob 
+00000a40: 2860 666c 6f61 7460 2c20 2a6f 7074 696f  (`float`, *optio
+00000a50: 6e61 6c2a 2c20 6465 6661 756c 7473 2074  nal*, defaults t
+00000a60: 6f20 302e 3129 3a0a 2020 2020 2020 2020  o 0.1):.        
+00000a70: 2020 2020 5468 6520 6472 6f70 6f75 7420      The dropout 
+00000a80: 7072 6f62 6162 696c 6974 7920 666f 7220  probability for 
+00000a90: 616c 6c20 6675 6c6c 7920 636f 6e6e 6563  all fully connec
+00000aa0: 7465 6420 6c61 7965 7273 2069 6e20 7468  ted layers in th
+00000ab0: 6520 656d 6265 6464 696e 6773 2c20 656e  e embeddings, en
+00000ac0: 636f 6465 722c 2061 6e64 2070 6f6f 6c65  coder, and poole
+00000ad0: 722e 0a20 2020 2020 2020 2061 7474 656e  r..        atten
+00000ae0: 7469 6f6e 5f70 726f 6273 5f64 726f 706f  tion_probs_dropo
+00000af0: 7574 5f70 726f 6220 2860 666c 6f61 7460  ut_prob (`float`
+00000b00: 2c20 2a6f 7074 696f 6e61 6c2a 2c20 6465  , *optional*, de
+00000b10: 6661 756c 7473 2074 6f20 302e 3129 3a0a  faults to 0.1):.
+00000b20: 2020 2020 2020 2020 2020 2020 5468 6520              The 
+00000b30: 6472 6f70 6f75 7420 7261 7469 6f20 666f  dropout ratio fo
+00000b40: 7220 7468 6520 6174 7465 6e74 696f 6e20  r the attention 
+00000b50: 7072 6f62 6162 696c 6974 6965 732e 0a20  probabilities.. 
+00000b60: 2020 2020 2020 206d 6178 5f70 6f73 6974         max_posit
+00000b70: 696f 6e5f 656d 6265 6464 696e 6773 2028  ion_embeddings (
+00000b80: 6069 6e74 602c 202a 6f70 7469 6f6e 616c  `int`, *optional
+00000b90: 2a2c 2064 6566 6175 6c74 7320 746f 2035  *, defaults to 5
+00000ba0: 3132 293a 0a20 2020 2020 2020 2020 2020  12):.           
+00000bb0: 2054 6865 206d 6178 696d 756d 2073 6571   The maximum seq
+00000bc0: 7565 6e63 6520 6c65 6e67 7468 2074 6861  uence length tha
+00000bd0: 7420 7468 6973 206d 6f64 656c 206d 6967  t this model mig
+00000be0: 6874 2065 7665 7220 6265 2075 7365 6420  ht ever be used 
+00000bf0: 7769 7468 2e20 5479 7069 6361 6c6c 7920  with. Typically 
+00000c00: 7365 7420 7468 6973 2074 6f20 736f 6d65  set this to some
+00000c10: 7468 696e 6720 6c61 7267 650a 2020 2020  thing large.    
+00000c20: 2020 2020 2020 2020 6a75 7374 2069 6e20          just in 
+00000c30: 6361 7365 2028 652e 672e 2c20 3531 3220  case (e.g., 512 
+00000c40: 6f72 2031 3032 3420 6f72 2032 3034 3829  or 1024 or 2048)
+00000c50: 2e0a 2020 2020 2020 2020 7479 7065 5f76  ..        type_v
+00000c60: 6f63 6162 5f73 697a 6520 2860 696e 7460  ocab_size (`int`
+00000c70: 2c20 2a6f 7074 696f 6e61 6c2a 2c20 6465  , *optional*, de
+00000c80: 6661 756c 7473 2074 6f20 3229 3a0a 2020  faults to 2):.  
+00000c90: 2020 2020 2020 2020 2020 5468 6520 766f            The vo
+00000ca0: 6361 6275 6c61 7279 2073 697a 6520 6f66  cabulary size of
+00000cb0: 2074 6865 2060 746f 6b65 6e5f 7479 7065   the `token_type
+00000cc0: 5f69 6473 6020 7061 7373 6564 2077 6865  _ids` passed whe
+00000cd0: 6e20 6361 6c6c 696e 6720 5b60 4272 6f73  n calling [`Bros
+00000ce0: 4d6f 6465 6c60 5d20 6f72 205b 6054 4642  Model`] or [`TFB
+00000cf0: 726f 734d 6f64 656c 605d 2e0a 2020 2020  rosModel`]..    
+00000d00: 2020 2020 696e 6974 6961 6c69 7a65 725f      initializer_
+00000d10: 7261 6e67 6520 2860 666c 6f61 7460 2c20  range (`float`, 
+00000d20: 2a6f 7074 696f 6e61 6c2a 2c20 6465 6661  *optional*, defa
+00000d30: 756c 7473 2074 6f20 302e 3032 293a 0a20  ults to 0.02):. 
+00000d40: 2020 2020 2020 2020 2020 2054 6865 2073             The s
+00000d50: 7461 6e64 6172 6420 6465 7669 6174 696f  tandard deviatio
+00000d60: 6e20 6f66 2074 6865 2074 7275 6e63 6174  n of the truncat
+00000d70: 6564 5f6e 6f72 6d61 6c5f 696e 6974 6961  ed_normal_initia
+00000d80: 6c69 7a65 7220 666f 7220 696e 6974 6961  lizer for initia
+00000d90: 6c69 7a69 6e67 2061 6c6c 2077 6569 6768  lizing all weigh
+00000da0: 7420 6d61 7472 6963 6573 2e0a 2020 2020  t matrices..    
+00000db0: 2020 2020 6c61 7965 725f 6e6f 726d 5f65      layer_norm_e
+00000dc0: 7073 2028 6066 6c6f 6174 602c 202a 6f70  ps (`float`, *op
+00000dd0: 7469 6f6e 616c 2a2c 2064 6566 6175 6c74  tional*, default
+00000de0: 7320 746f 2031 652d 3132 293a 0a20 2020  s to 1e-12):.   
+00000df0: 2020 2020 2020 2020 2054 6865 2065 7073           The eps
+00000e00: 696c 6f6e 2075 7365 6420 6279 2074 6865  ilon used by the
+00000e10: 206c 6179 6572 206e 6f72 6d61 6c69 7a61   layer normaliza
+00000e20: 7469 6f6e 206c 6179 6572 732e 0a20 2020  tion layers..   
+00000e30: 2020 2020 2070 6164 5f74 6f6b 656e 5f69       pad_token_i
+00000e40: 6420 2860 696e 7460 2c20 2a6f 7074 696f  d (`int`, *optio
+00000e50: 6e61 6c2a 2c20 6465 6661 756c 7473 2074  nal*, defaults t
+00000e60: 6f20 3029 3a0a 2020 2020 2020 2020 2020  o 0):.          
+00000e70: 2020 5468 6520 696e 6465 7820 6f66 2074    The index of t
+00000e80: 6865 2070 6164 6469 6e67 2074 6f6b 656e  he padding token
+00000e90: 2069 6e20 7468 6520 746f 6b65 6e20 766f   in the token vo
+00000ea0: 6361 6275 6c61 7279 2e0a 2020 2020 2020  cabulary..      
+00000eb0: 2020 6469 6d5f 6262 6f78 2028 6069 6e74    dim_bbox (`int
+00000ec0: 602c 202a 6f70 7469 6f6e 616c 2a2c 2064  `, *optional*, d
+00000ed0: 6566 6175 6c74 7320 746f 2038 293a 0a20  efaults to 8):. 
+00000ee0: 2020 2020 2020 2020 2020 2054 6865 2064             The d
+00000ef0: 696d 656e 7369 6f6e 206f 6620 7468 6520  imension of the 
+00000f00: 626f 756e 6469 6e67 2062 6f78 2063 6f6f  bounding box coo
+00000f10: 7264 696e 6174 6573 2e20 2878 302c 2079  rdinates. (x0, y
+00000f20: 312c 2078 312c 2079 302c 2078 312c 2079  1, x1, y0, x1, y
+00000f30: 312c 2078 302c 2079 3129 0a20 2020 2020  1, x0, y1).     
+00000f40: 2020 2062 626f 785f 7363 616c 6520 2860     bbox_scale (`
+00000f50: 666c 6f61 7460 2c20 2a6f 7074 696f 6e61  float`, *optiona
+00000f60: 6c2a 2c20 6465 6661 756c 7473 2074 6f20  l*, defaults to 
+00000f70: 3130 302e 3029 3a0a 2020 2020 2020 2020  100.0):.        
+00000f80: 2020 2020 5468 6520 7363 616c 6520 6661      The scale fa
+00000f90: 6374 6f72 206f 6620 7468 6520 626f 756e  ctor of the boun
+00000fa0: 6469 6e67 2062 6f78 2063 6f6f 7264 696e  ding box coordin
+00000fb0: 6174 6573 2e0a 2020 2020 2020 2020 6e5f  ates..        n_
+00000fc0: 7265 6c61 7469 6f6e 7320 2860 696e 7460  relations (`int`
+00000fd0: 2c20 2a6f 7074 696f 6e61 6c2a 2c20 6465  , *optional*, de
+00000fe0: 6661 756c 7473 2074 6f20 3129 3a0a 2020  faults to 1):.  
+00000ff0: 2020 2020 2020 2020 2020 5468 6520 6e75            The nu
+00001000: 6d62 6572 206f 6620 7265 6c61 7469 6f6e  mber of relation
+00001010: 7320 666f 7220 5370 6164 6545 4528 656e  s for SpadeEE(en
+00001020: 7469 7479 2065 7874 7261 6374 696f 6e29  tity extraction)
+00001030: 2c20 5370 6164 6545 4c28 656e 7469 7479  , SpadeEL(entity
+00001040: 206c 696e 6b69 6e67 2920 6865 6164 2e0a   linking) head..
+00001050: 2020 2020 2020 2020 636c 6173 7369 6669          classifi
+00001060: 6572 5f64 726f 706f 7574 5f70 726f 6220  er_dropout_prob 
+00001070: 2860 666c 6f61 7460 2c20 2a6f 7074 696f  (`float`, *optio
+00001080: 6e61 6c2a 2c20 6465 6661 756c 7473 2074  nal*, defaults t
+00001090: 6f20 302e 3129 3a0a 2020 2020 2020 2020  o 0.1):.        
+000010a0: 2020 2020 5468 6520 6472 6f70 6f75 7420      The dropout 
+000010b0: 7261 7469 6f20 666f 7220 7468 6520 636c  ratio for the cl
+000010c0: 6173 7369 6669 6572 2068 6561 642e 0a0a  assifier head...
+000010d0: 0a20 2020 2045 7861 6d70 6c65 733a 0a0a  .    Examples:..
+000010e0: 2020 2020 6060 6070 7974 686f 6e0a 2020      ```python.  
+000010f0: 2020 3e3e 3e20 6672 6f6d 2074 7261 6e73    >>> from trans
+00001100: 666f 726d 6572 7320 696d 706f 7274 2042  formers import B
+00001110: 726f 7343 6f6e 6669 672c 2042 726f 734d  rosConfig, BrosM
+00001120: 6f64 656c 0a0a 2020 2020 3e3e 3e20 2320  odel..    >>> # 
+00001130: 496e 6974 6961 6c69 7a69 6e67 2061 2042  Initializing a B
+00001140: 524f 5320 6a69 6e68 6f38 3334 352f 6272  ROS jinho8345/br
+00001150: 6f73 2d62 6173 652d 756e 6361 7365 6420  os-base-uncased 
+00001160: 7374 796c 6520 636f 6e66 6967 7572 6174  style configurat
+00001170: 696f 6e0a 2020 2020 3e3e 3e20 636f 6e66  ion.    >>> conf
+00001180: 6967 7572 6174 696f 6e20 3d20 4272 6f73  iguration = Bros
+00001190: 436f 6e66 6967 2829 0a0a 2020 2020 3e3e  Config()..    >>
+000011a0: 3e20 2320 496e 6974 6961 6c69 7a69 6e67  > # Initializing
+000011b0: 2061 206d 6f64 656c 2066 726f 6d20 7468   a model from th
+000011c0: 6520 6a69 6e68 6f38 3334 352f 6272 6f73  e jinho8345/bros
+000011d0: 2d62 6173 652d 756e 6361 7365 6420 7374  -base-uncased st
+000011e0: 796c 6520 636f 6e66 6967 7572 6174 696f  yle configuratio
+000011f0: 6e0a 2020 2020 3e3e 3e20 6d6f 6465 6c20  n.    >>> model 
+00001200: 3d20 4272 6f73 4d6f 6465 6c28 636f 6e66  = BrosModel(conf
+00001210: 6967 7572 6174 696f 6e29 0a0a 2020 2020  iguration)..    
+00001220: 3e3e 3e20 2320 4163 6365 7373 696e 6720  >>> # Accessing 
+00001230: 7468 6520 6d6f 6465 6c20 636f 6e66 6967  the model config
+00001240: 7572 6174 696f 6e0a 2020 2020 3e3e 3e20  uration.    >>> 
+00001250: 636f 6e66 6967 7572 6174 696f 6e20 3d20  configuration = 
+00001260: 6d6f 6465 6c2e 636f 6e66 6967 0a20 2020  model.config.   
+00001270: 2060 6060 2222 220a 0a20 2020 206d 6f64   ```"""..    mod
+00001280: 656c 5f74 7970 6520 3d20 2262 726f 7322  el_type = "bros"
+00001290: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
+000012a0: 5f5f 280a 2020 2020 2020 2020 7365 6c66  __(.        self
+000012b0: 2c0a 2020 2020 2020 2020 766f 6361 625f  ,.        vocab_
+000012c0: 7369 7a65 3d33 3035 3232 2c0a 2020 2020  size=30522,.    
+000012d0: 2020 2020 6869 6464 656e 5f73 697a 653d      hidden_size=
+000012e0: 3736 382c 0a20 2020 2020 2020 206e 756d  768,.        num
+000012f0: 5f68 6964 6465 6e5f 6c61 7965 7273 3d31  _hidden_layers=1
+00001300: 322c 0a20 2020 2020 2020 206e 756d 5f61  2,.        num_a
+00001310: 7474 656e 7469 6f6e 5f68 6561 6473 3d31  ttention_heads=1
+00001320: 322c 0a20 2020 2020 2020 2069 6e74 6572  2,.        inter
+00001330: 6d65 6469 6174 655f 7369 7a65 3d33 3037  mediate_size=307
+00001340: 322c 0a20 2020 2020 2020 2068 6964 6465  2,.        hidde
+00001350: 6e5f 6163 743d 2267 656c 7522 2c0a 2020  n_act="gelu",.  
+00001360: 2020 2020 2020 6869 6464 656e 5f64 726f        hidden_dro
+00001370: 706f 7574 5f70 726f 623d 302e 312c 0a20  pout_prob=0.1,. 
+00001380: 2020 2020 2020 2061 7474 656e 7469 6f6e         attention
+00001390: 5f70 726f 6273 5f64 726f 706f 7574 5f70  _probs_dropout_p
+000013a0: 726f 623d 302e 312c 0a20 2020 2020 2020  rob=0.1,.       
+000013b0: 206d 6178 5f70 6f73 6974 696f 6e5f 656d   max_position_em
+000013c0: 6265 6464 696e 6773 3d35 3132 2c0a 2020  beddings=512,.  
+000013d0: 2020 2020 2020 7479 7065 5f76 6f63 6162        type_vocab
+000013e0: 5f73 697a 653d 322c 0a20 2020 2020 2020  _size=2,.       
+000013f0: 2069 6e69 7469 616c 697a 6572 5f72 616e   initializer_ran
+00001400: 6765 3d30 2e30 322c 0a20 2020 2020 2020  ge=0.02,.       
+00001410: 206c 6179 6572 5f6e 6f72 6d5f 6570 733d   layer_norm_eps=
+00001420: 3165 2d31 322c 0a20 2020 2020 2020 2070  1e-12,.        p
+00001430: 6164 5f74 6f6b 656e 5f69 643d 302c 0a20  ad_token_id=0,. 
+00001440: 2020 2020 2020 2064 696d 5f62 626f 783d         dim_bbox=
+00001450: 382c 0a20 2020 2020 2020 2062 626f 785f  8,.        bbox_
+00001460: 7363 616c 653d 3130 302e 302c 0a20 2020  scale=100.0,.   
+00001470: 2020 2020 206e 5f72 656c 6174 696f 6e73       n_relations
+00001480: 3d31 2c0a 2020 2020 2020 2020 636c 6173  =1,.        clas
+00001490: 7369 6669 6572 5f64 726f 706f 7574 5f70  sifier_dropout_p
+000014a0: 726f 623d 302e 312c 0a20 2020 2020 2020  rob=0.1,.       
+000014b0: 202a 2a6b 7761 7267 732c 0a20 2020 2029   **kwargs,.    )
+000014c0: 3a0a 2020 2020 2020 2020 7375 7065 7228  :.        super(
+000014d0: 292e 5f5f 696e 6974 5f5f 280a 2020 2020  ).__init__(.    
+000014e0: 2020 2020 2020 2020 766f 6361 625f 7369          vocab_si
+000014f0: 7a65 3d76 6f63 6162 5f73 697a 652c 0a20  ze=vocab_size,. 
+00001500: 2020 2020 2020 2020 2020 2068 6964 6465             hidde
+00001510: 6e5f 7369 7a65 3d68 6964 6465 6e5f 7369  n_size=hidden_si
+00001520: 7a65 2c0a 2020 2020 2020 2020 2020 2020  ze,.            
+00001530: 6e75 6d5f 6869 6464 656e 5f6c 6179 6572  num_hidden_layer
+00001540: 733d 6e75 6d5f 6869 6464 656e 5f6c 6179  s=num_hidden_lay
+00001550: 6572 732c 0a20 2020 2020 2020 2020 2020  ers,.           
+00001560: 206e 756d 5f61 7474 656e 7469 6f6e 5f68   num_attention_h
+00001570: 6561 6473 3d6e 756d 5f61 7474 656e 7469  eads=num_attenti
+00001580: 6f6e 5f68 6561 6473 2c0a 2020 2020 2020  on_heads,.      
+00001590: 2020 2020 2020 696e 7465 726d 6564 6961        intermedia
+000015a0: 7465 5f73 697a 653d 696e 7465 726d 6564  te_size=intermed
+000015b0: 6961 7465 5f73 697a 652c 0a20 2020 2020  iate_size,.     
+000015c0: 2020 2020 2020 2068 6964 6465 6e5f 6163         hidden_ac
+000015d0: 743d 6869 6464 656e 5f61 6374 2c0a 2020  t=hidden_act,.  
+000015e0: 2020 2020 2020 2020 2020 6869 6464 656e            hidden
+000015f0: 5f64 726f 706f 7574 5f70 726f 623d 6869  _dropout_prob=hi
+00001600: 6464 656e 5f64 726f 706f 7574 5f70 726f  dden_dropout_pro
+00001610: 622c 0a20 2020 2020 2020 2020 2020 2061  b,.            a
+00001620: 7474 656e 7469 6f6e 5f70 726f 6273 5f64  ttention_probs_d
+00001630: 726f 706f 7574 5f70 726f 623d 6174 7465  ropout_prob=atte
+00001640: 6e74 696f 6e5f 7072 6f62 735f 6472 6f70  ntion_probs_drop
+00001650: 6f75 745f 7072 6f62 2c0a 2020 2020 2020  out_prob,.      
+00001660: 2020 2020 2020 6d61 785f 706f 7369 7469        max_positi
+00001670: 6f6e 5f65 6d62 6564 6469 6e67 733d 6d61  on_embeddings=ma
+00001680: 785f 706f 7369 7469 6f6e 5f65 6d62 6564  x_position_embed
+00001690: 6469 6e67 732c 0a20 2020 2020 2020 2020  dings,.         
+000016a0: 2020 2074 7970 655f 766f 6361 625f 7369     type_vocab_si
+000016b0: 7a65 3d74 7970 655f 766f 6361 625f 7369  ze=type_vocab_si
+000016c0: 7a65 2c0a 2020 2020 2020 2020 2020 2020  ze,.            
+000016d0: 696e 6974 6961 6c69 7a65 725f 7261 6e67  initializer_rang
+000016e0: 653d 696e 6974 6961 6c69 7a65 725f 7261  e=initializer_ra
+000016f0: 6e67 652c 0a20 2020 2020 2020 2020 2020  nge,.           
+00001700: 206c 6179 6572 5f6e 6f72 6d5f 6570 733d   layer_norm_eps=
+00001710: 6c61 7965 725f 6e6f 726d 5f65 7073 2c0a  layer_norm_eps,.
+00001720: 2020 2020 2020 2020 2020 2020 7061 645f              pad_
+00001730: 746f 6b65 6e5f 6964 3d70 6164 5f74 6f6b  token_id=pad_tok
+00001740: 656e 5f69 642c 0a20 2020 2020 2020 2020  en_id,.         
+00001750: 2020 202a 2a6b 7761 7267 732c 0a20 2020     **kwargs,.   
+00001760: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00001770: 7365 6c66 2e64 696d 5f62 626f 7820 3d20  self.dim_bbox = 
+00001780: 6469 6d5f 6262 6f78 0a20 2020 2020 2020  dim_bbox.       
+00001790: 2073 656c 662e 6262 6f78 5f73 6361 6c65   self.bbox_scale
+000017a0: 203d 2062 626f 785f 7363 616c 650a 2020   = bbox_scale.  
+000017b0: 2020 2020 2020 7365 6c66 2e6e 5f72 656c        self.n_rel
+000017c0: 6174 696f 6e73 203d 206e 5f72 656c 6174  ations = n_relat
+000017d0: 696f 6e73 0a20 2020 2020 2020 2073 656c  ions.        sel
+000017e0: 662e 6469 6d5f 6262 6f78 5f73 696e 7573  f.dim_bbox_sinus
+000017f0: 6f69 645f 656d 625f 3264 203d 2073 656c  oid_emb_2d = sel
+00001800: 662e 6869 6464 656e 5f73 697a 6520 2f2f  f.hidden_size //
+00001810: 2034 0a20 2020 2020 2020 2073 656c 662e   4.        self.
+00001820: 6469 6d5f 6262 6f78 5f73 696e 7573 6f69  dim_bbox_sinusoi
+00001830: 645f 656d 625f 3164 203d 2073 656c 662e  d_emb_1d = self.
+00001840: 6469 6d5f 6262 6f78 5f73 696e 7573 6f69  dim_bbox_sinusoi
+00001850: 645f 656d 625f 3264 202f 2f20 7365 6c66  d_emb_2d // self
+00001860: 2e64 696d 5f62 626f 780a 2020 2020 2020  .dim_bbox.      
+00001870: 2020 7365 6c66 2e64 696d 5f62 626f 785f    self.dim_bbox_
+00001880: 7072 6f6a 6563 7469 6f6e 203d 2073 656c  projection = sel
+00001890: 662e 6869 6464 656e 5f73 697a 6520 2f2f  f.hidden_size //
+000018a0: 2073 656c 662e 6e75 6d5f 6174 7465 6e74   self.num_attent
+000018b0: 696f 6e5f 6865 6164 730a 2020 2020 2020  ion_heads.      
+000018c0: 2020 7365 6c66 2e63 6c61 7373 6966 6965    self.classifie
+000018d0: 725f 6472 6f70 6f75 745f 7072 6f62 203d  r_dropout_prob =
+000018e0: 2063 6c61 7373 6966 6965 725f 6472 6f70   classifier_drop
+000018f0: 6f75 745f 7072 6f62 0a0a 5f5f 616c 6c5f  out_prob..__all_
+00001900: 5f20 3d20 5b27 4272 6f73 436f 6e66 6967  _ = ['BrosConfig
+00001910: 275d 0a                                  '].
```

## mindnlp/transformers/models/bros/modeling_bros.py

```diff
@@ -0,0 +1,3221 @@
+00000000: 2320 636f 6469 6e67 3d75 7466 2d38 0a23  # coding=utf-8.#
+00000010: 2043 6f70 7972 6967 6874 2032 3032 332d   Copyright 2023-
+00000020: 7072 6573 656e 7420 4e41 5645 5220 436f  present NAVER Co
+00000030: 7270 2c20 5468 6520 4d69 6372 6f73 6f66  rp, The Microsof
+00000040: 7420 5265 7365 6172 6368 2041 7369 6120  t Research Asia 
+00000050: 4c61 796f 7574 4c4d 2054 6561 6d20 4175  LayoutLM Team Au
+00000060: 7468 6f72 7320 616e 6420 7468 6520 4875  thors and the Hu
+00000070: 6767 696e 6746 6163 6520 496e 632e 2074  ggingFace Inc. t
+00000080: 6561 6d2e 0a23 0a23 204c 6963 656e 7365  eam..#.# License
+00000090: 6420 756e 6465 7220 7468 6520 4170 6163  d under the Apac
+000000a0: 6865 204c 6963 656e 7365 2c20 5665 7273  he License, Vers
+000000b0: 696f 6e20 322e 3020 2874 6865 2022 4c69  ion 2.0 (the "Li
+000000c0: 6365 6e73 6522 293b 0a23 2079 6f75 206d  cense");.# you m
+000000d0: 6179 206e 6f74 2075 7365 2074 6869 7320  ay not use this 
+000000e0: 6669 6c65 2065 7863 6570 7420 696e 2063  file except in c
+000000f0: 6f6d 706c 6961 6e63 6520 7769 7468 2074  ompliance with t
+00000100: 6865 204c 6963 656e 7365 2e0a 2320 596f  he License..# Yo
+00000110: 7520 6d61 7920 6f62 7461 696e 2061 2063  u may obtain a c
+00000120: 6f70 7920 6f66 2074 6865 204c 6963 656e  opy of the Licen
+00000130: 7365 2061 740a 230a 2320 2020 2020 6874  se at.#.#     ht
+00000140: 7470 3a2f 2f77 7777 2e61 7061 6368 652e  tp://www.apache.
+00000150: 6f72 672f 6c69 6365 6e73 6573 2f4c 4943  org/licenses/LIC
+00000160: 454e 5345 2d32 2e30 0a23 0a23 2055 6e6c  ENSE-2.0.#.# Unl
+00000170: 6573 7320 7265 7175 6972 6564 2062 7920  ess required by 
+00000180: 6170 706c 6963 6162 6c65 206c 6177 206f  applicable law o
+00000190: 7220 6167 7265 6564 2074 6f20 696e 2077  r agreed to in w
+000001a0: 7269 7469 6e67 2c20 736f 6674 7761 7265  riting, software
+000001b0: 0a23 2064 6973 7472 6962 7574 6564 2075  .# distributed u
+000001c0: 6e64 6572 2074 6865 204c 6963 656e 7365  nder the License
+000001d0: 2069 7320 6469 7374 7269 6275 7465 6420   is distributed 
+000001e0: 6f6e 2061 6e20 2241 5320 4953 2220 4241  on an "AS IS" BA
+000001f0: 5349 532c 0a23 2057 4954 484f 5554 2057  SIS,.# WITHOUT W
+00000200: 4152 5241 4e54 4945 5320 4f52 2043 4f4e  ARRANTIES OR CON
+00000210: 4449 5449 4f4e 5320 4f46 2041 4e59 204b  DITIONS OF ANY K
+00000220: 494e 442c 2065 6974 6865 7220 6578 7072  IND, either expr
+00000230: 6573 7320 6f72 2069 6d70 6c69 6564 2e0a  ess or implied..
+00000240: 2320 5365 6520 7468 6520 4c69 6365 6e73  # See the Licens
+00000250: 6520 666f 7220 7468 6520 7370 6563 6966  e for the specif
+00000260: 6963 206c 616e 6775 6167 6520 676f 7665  ic language gove
+00000270: 726e 696e 6720 7065 726d 6973 7369 6f6e  rning permission
+00000280: 7320 616e 640a 2320 6c69 6d69 7461 7469  s and.# limitati
+00000290: 6f6e 7320 756e 6465 7220 7468 6520 4c69  ons under the Li
+000002a0: 6365 6e73 652e 0a22 2222 2050 7954 6f72  cense..""" PyTor
+000002b0: 6368 2042 726f 7320 6d6f 6465 6c2e 2222  ch Bros model.""
+000002c0: 220a 0a0a 696d 706f 7274 206d 6174 680a  "...import math.
+000002d0: 6672 6f6d 2064 6174 6163 6c61 7373 6573  from dataclasses
+000002e0: 2069 6d70 6f72 7420 6461 7461 636c 6173   import dataclas
+000002f0: 730a 6672 6f6d 2074 7970 696e 6720 696d  s.from typing im
+00000300: 706f 7274 204c 6973 742c 204f 7074 696f  port List, Optio
+00000310: 6e61 6c2c 2054 7570 6c65 2c20 556e 696f  nal, Tuple, Unio
+00000320: 6e0a 0a69 6d70 6f72 7420 6d69 6e64 7370  n..import mindsp
+00000330: 6f72 650a 6672 6f6d 206d 696e 6473 706f  ore.from mindspo
+00000340: 7265 2069 6d70 6f72 7420 6e6e 2c20 6f70  re import nn, op
+00000350: 732c 2050 6172 616d 6574 6572 0a66 726f  s, Parameter.fro
+00000360: 6d20 6d69 6e64 7370 6f72 652e 636f 6d6d  m mindspore.comm
+00000370: 6f6e 2e69 6e69 7469 616c 697a 6572 2069  on.initializer i
+00000380: 6d70 6f72 7420 4e6f 726d 616c 0a0a 6672  mport Normal..fr
+00000390: 6f6d 206d 696e 646e 6c70 2e6d 6f64 756c  om mindnlp.modul
+000003a0: 6573 2e66 756e 6374 696f 6e61 6c20 696d  es.functional im
+000003b0: 706f 7274 2066 696e 666f 0a66 726f 6d20  port finfo.from 
+000003c0: 2e2e 2e61 6374 6976 6174 696f 6e73 2069  ...activations i
+000003d0: 6d70 6f72 7420 4143 5432 464e 0a66 726f  mport ACT2FN.fro
+000003e0: 6d20 2e2e 2e6d 6f64 656c 696e 675f 6f75  m ...modeling_ou
+000003f0: 7470 7574 7320 696d 706f 7274 2028 0a20  tputs import (. 
+00000400: 2020 2042 6173 654d 6f64 656c 4f75 7470     BaseModelOutp
+00000410: 7574 5769 7468 5061 7374 416e 6443 726f  utWithPastAndCro
+00000420: 7373 4174 7465 6e74 696f 6e73 2c0a 2020  ssAttentions,.  
+00000430: 2020 4261 7365 4d6f 6465 6c4f 7574 7075    BaseModelOutpu
+00000440: 7457 6974 6850 6f6f 6c69 6e67 416e 6443  tWithPoolingAndC
+00000450: 726f 7373 4174 7465 6e74 696f 6e73 2c0a  rossAttentions,.
+00000460: 2020 2020 546f 6b65 6e43 6c61 7373 6966      TokenClassif
+00000470: 6965 724f 7574 7075 742c 0a29 0a66 726f  ierOutput,.).fro
+00000480: 6d20 2e2e 2e6d 6f64 656c 696e 675f 7574  m ...modeling_ut
+00000490: 696c 7320 696d 706f 7274 2050 7265 5472  ils import PreTr
+000004a0: 6169 6e65 644d 6f64 656c 0a66 726f 6d20  ainedModel.from 
+000004b0: 2e2e 2e6d 735f 7574 696c 7320 696d 706f  ...ms_utils impo
+000004c0: 7274 2061 7070 6c79 5f63 6875 6e6b 696e  rt apply_chunkin
+000004d0: 675f 746f 5f66 6f72 7761 7264 2c20 6669  g_to_forward, fi
+000004e0: 6e64 5f70 7275 6e65 6162 6c65 5f68 6561  nd_pruneable_hea
+000004f0: 6473 5f61 6e64 5f69 6e64 6963 6573 2c20  ds_and_indices, 
+00000500: 7072 756e 655f 6c69 6e65 6172 5f6c 6179  prune_linear_lay
+00000510: 6572 0a66 726f 6d20 2e2e 2e2e 7574 696c  er.from ....util
+00000520: 7320 696d 706f 7274 2028 0a20 2020 204d  s import (.    M
+00000530: 6f64 656c 4f75 7470 7574 2c0a 2020 2020  odelOutput,.    
+00000540: 6c6f 6767 696e 672c 0a29 0a66 726f 6d20  logging,.).from 
+00000550: 2e63 6f6e 6669 6775 7261 7469 6f6e 5f62  .configuration_b
+00000560: 726f 7320 696d 706f 7274 2042 726f 7343  ros import BrosC
+00000570: 6f6e 6669 670a 0a0a 6c6f 6767 6572 203d  onfig...logger =
+00000580: 206c 6f67 6769 6e67 2e67 6574 5f6c 6f67   logging.get_log
+00000590: 6765 7228 5f5f 6e61 6d65 5f5f 290a 0a5f  ger(__name__).._
+000005a0: 4348 4543 4b50 4f49 4e54 5f46 4f52 5f44  CHECKPOINT_FOR_D
+000005b0: 4f43 203d 2022 6a69 6e68 6f38 3334 352f  OC = "jinho8345/
+000005c0: 6272 6f73 2d62 6173 652d 756e 6361 7365  bros-base-uncase
+000005d0: 6422 0a5f 434f 4e46 4947 5f46 4f52 5f44  d"._CONFIG_FOR_D
+000005e0: 4f43 203d 2022 4272 6f73 436f 6e66 6967  OC = "BrosConfig
+000005f0: 220a 0a0a 4064 6174 6163 6c61 7373 0a63  "...@dataclass.c
+00000600: 6c61 7373 2042 726f 7353 7061 6465 4f75  lass BrosSpadeOu
+00000610: 7470 7574 284d 6f64 656c 4f75 7470 7574  tput(ModelOutput
+00000620: 293a 0a20 2020 2022 2222 0a20 2020 2042  ):.    """.    B
+00000630: 6173 6520 636c 6173 7320 666f 7220 6f75  ase class for ou
+00000640: 7470 7574 7320 6f66 2074 6f6b 656e 2063  tputs of token c
+00000650: 6c61 7373 6966 6963 6174 696f 6e20 6d6f  lassification mo
+00000660: 6465 6c73 2e0a 0a20 2020 2041 7267 733a  dels...    Args:
+00000670: 0a20 2020 2020 2020 206c 6f73 7320 2860  .        loss (`
+00000680: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+00000690: 6020 6f66 2073 6861 7065 2060 2831 2c29  ` of shape `(1,)
+000006a0: 602c 202a 6f70 7469 6f6e 616c 2a2c 2072  `, *optional*, r
+000006b0: 6574 7572 6e65 6420 7768 656e 2060 6c61  eturned when `la
+000006c0: 6265 6c73 6020 6973 2070 726f 7669 6465  bels` is provide
+000006d0: 6429 203a 0a20 2020 2020 2020 2020 2020  d) :.           
+000006e0: 2043 6c61 7373 6966 6963 6174 696f 6e20   Classification 
+000006f0: 6c6f 7373 2e0a 2020 2020 2020 2020 696e  loss..        in
+00000700: 6974 6961 6c5f 746f 6b65 6e5f 6c6f 6769  itial_token_logi
+00000710: 7473 2028 606d 696e 6473 706f 7265 2e54  ts (`mindspore.T
+00000720: 656e 736f 7260 206f 6620 7368 6170 6520  ensor` of shape 
+00000730: 6028 6261 7463 685f 7369 7a65 2c20 7365  `(batch_size, se
+00000740: 7175 656e 6365 5f6c 656e 6774 682c 2063  quence_length, c
+00000750: 6f6e 6669 672e 6e75 6d5f 6c61 6265 6c73  onfig.num_labels
+00000760: 2960 293a 0a20 2020 2020 2020 2020 2020  )`):.           
+00000770: 2043 6c61 7373 6966 6963 6174 696f 6e20   Classification 
+00000780: 7363 6f72 6573 2066 6f72 2065 6e74 6974  scores for entit
+00000790: 7920 696e 6974 6961 6c20 746f 6b65 6e73  y initial tokens
+000007a0: 2028 6265 666f 7265 2053 6f66 744d 6178   (before SoftMax
+000007b0: 292e 0a20 2020 2020 2020 2073 7562 7365  )..        subse
+000007c0: 7175 656e 745f 746f 6b65 6e5f 6c6f 6769  quent_token_logi
+000007d0: 7473 2028 606d 696e 6473 706f 7265 2e54  ts (`mindspore.T
+000007e0: 656e 736f 7260 206f 6620 7368 6170 6520  ensor` of shape 
+000007f0: 6028 6261 7463 685f 7369 7a65 2c20 7365  `(batch_size, se
+00000800: 7175 656e 6365 5f6c 656e 6774 682c 2073  quence_length, s
+00000810: 6571 7565 6e63 655f 6c65 6e67 7468 2b31  equence_length+1
+00000820: 2960 293a 0a20 2020 2020 2020 2020 2020  )`):.           
+00000830: 2043 6c61 7373 6966 6963 6174 696f 6e20   Classification 
+00000840: 7363 6f72 6573 2066 6f72 2065 6e74 6974  scores for entit
+00000850: 7920 7365 7175 656e 6365 2074 6f6b 656e  y sequence token
+00000860: 7320 2862 6566 6f72 6520 536f 6674 4d61  s (before SoftMa
+00000870: 7829 2e0a 2020 2020 2020 2020 6869 6464  x)..        hidd
+00000880: 656e 5f73 7461 7465 7320 2860 7475 706c  en_states (`tupl
+00000890: 6528 6d69 6e64 7370 6f72 652e 5465 6e73  e(mindspore.Tens
+000008a0: 6f72 2960 2c20 2a6f 7074 696f 6e61 6c2a  or)`, *optional*
+000008b0: 2c20 7265 7475 726e 6564 2077 6865 6e20  , returned when 
+000008c0: 606f 7574 7075 745f 6869 6464 656e 5f73  `output_hidden_s
+000008d0: 7461 7465 733d 5472 7565 6020 6973 2070  tates=True` is p
+000008e0: 6173 7365 6420 6f72 2077 6865 6e20 6063  assed or when `c
+000008f0: 6f6e 6669 672e 6f75 7470 7574 5f68 6964  onfig.output_hid
+00000900: 6465 6e5f 7374 6174 6573 3d54 7275 6560  den_states=True`
+00000910: 293a 0a20 2020 2020 2020 2020 2020 2054  ):.            T
+00000920: 7570 6c65 206f 6620 606d 696e 6473 706f  uple of `mindspo
+00000930: 7265 2e54 656e 736f 7260 2028 6f6e 6520  re.Tensor` (one 
+00000940: 666f 7220 7468 6520 6f75 7470 7574 206f  for the output o
+00000950: 6620 7468 6520 656d 6265 6464 696e 6773  f the embeddings
+00000960: 2c20 6966 2074 6865 206d 6f64 656c 2068  , if the model h
+00000970: 6173 2061 6e20 656d 6265 6464 696e 6720  as an embedding 
+00000980: 6c61 7965 722c 202b 0a20 2020 2020 2020  layer, +.       
+00000990: 2020 2020 206f 6e65 2066 6f72 2074 6865       one for the
+000009a0: 206f 7574 7075 7420 6f66 2065 6163 6820   output of each 
+000009b0: 6c61 7965 7229 206f 6620 7368 6170 6520  layer) of shape 
+000009c0: 6028 6261 7463 685f 7369 7a65 2c20 7365  `(batch_size, se
+000009d0: 7175 656e 6365 5f6c 656e 6774 682c 2068  quence_length, h
+000009e0: 6964 6465 6e5f 7369 7a65 2960 2e0a 0a20  idden_size)`... 
+000009f0: 2020 2020 2020 2020 2020 2048 6964 6465             Hidde
+00000a00: 6e2d 7374 6174 6573 206f 6620 7468 6520  n-states of the 
+00000a10: 6d6f 6465 6c20 6174 2074 6865 206f 7574  model at the out
+00000a20: 7075 7420 6f66 2065 6163 6820 6c61 7965  put of each laye
+00000a30: 7220 706c 7573 2074 6865 206f 7074 696f  r plus the optio
+00000a40: 6e61 6c20 696e 6974 6961 6c20 656d 6265  nal initial embe
+00000a50: 6464 696e 6720 6f75 7470 7574 732e 0a20  dding outputs.. 
+00000a60: 2020 2020 2020 2061 7474 656e 7469 6f6e         attention
+00000a70: 7320 2860 7475 706c 6528 6d69 6e64 7370  s (`tuple(mindsp
+00000a80: 6f72 652e 5465 6e73 6f72 2960 2c20 2a6f  ore.Tensor)`, *o
+00000a90: 7074 696f 6e61 6c2a 2c20 7265 7475 726e  ptional*, return
+00000aa0: 6564 2077 6865 6e20 606f 7574 7075 745f  ed when `output_
+00000ab0: 6174 7465 6e74 696f 6e73 3d54 7275 6560  attentions=True`
+00000ac0: 2069 7320 7061 7373 6564 206f 7220 7768   is passed or wh
+00000ad0: 656e 2060 636f 6e66 6967 2e6f 7574 7075  en `config.outpu
+00000ae0: 745f 6174 7465 6e74 696f 6e73 3d54 7275  t_attentions=Tru
+00000af0: 6560 293a 0a20 2020 2020 2020 2020 2020  e`):.           
+00000b00: 2054 7570 6c65 206f 6620 606d 696e 6473   Tuple of `minds
+00000b10: 706f 7265 2e54 656e 736f 7260 2028 6f6e  pore.Tensor` (on
+00000b20: 6520 666f 7220 6561 6368 206c 6179 6572  e for each layer
+00000b30: 2920 6f66 2073 6861 7065 2060 2862 6174  ) of shape `(bat
+00000b40: 6368 5f73 697a 652c 206e 756d 5f68 6561  ch_size, num_hea
+00000b50: 6473 2c20 7365 7175 656e 6365 5f6c 656e  ds, sequence_len
+00000b60: 6774 682c 0a20 2020 2020 2020 2020 2020  gth,.           
+00000b70: 2073 6571 7565 6e63 655f 6c65 6e67 7468   sequence_length
+00000b80: 2960 2e0a 0a20 2020 2020 2020 2020 2020  )`...           
+00000b90: 2041 7474 656e 7469 6f6e 7320 7765 6967   Attentions weig
+00000ba0: 6874 7320 6166 7465 7220 7468 6520 6174  hts after the at
+00000bb0: 7465 6e74 696f 6e20 736f 6674 6d61 782c  tention softmax,
+00000bc0: 2075 7365 6420 746f 2063 6f6d 7075 7465   used to compute
+00000bd0: 2074 6865 2077 6569 6768 7465 6420 6176   the weighted av
+00000be0: 6572 6167 6520 696e 2074 6865 2073 656c  erage in the sel
+00000bf0: 662d 6174 7465 6e74 696f 6e0a 2020 2020  f-attention.    
+00000c00: 2020 2020 2020 2020 6865 6164 732e 0a20          heads.. 
+00000c10: 2020 2022 2222 0a0a 2020 2020 6c6f 7373     """..    loss
+00000c20: 3a20 4f70 7469 6f6e 616c 5b6d 696e 6473  : Optional[minds
+00000c30: 706f 7265 2e54 656e 736f 725d 203d 204e  pore.Tensor] = N
+00000c40: 6f6e 650a 2020 2020 696e 6974 6961 6c5f  one.    initial_
+00000c50: 746f 6b65 6e5f 6c6f 6769 7473 3a20 6d69  token_logits: mi
+00000c60: 6e64 7370 6f72 652e 5465 6e73 6f72 203d  ndspore.Tensor =
+00000c70: 204e 6f6e 650a 2020 2020 7375 6273 6571   None.    subseq
+00000c80: 7565 6e74 5f74 6f6b 656e 5f6c 6f67 6974  uent_token_logit
+00000c90: 733a 206d 696e 6473 706f 7265 2e54 656e  s: mindspore.Ten
+00000ca0: 736f 7220 3d20 4e6f 6e65 0a20 2020 2068  sor = None.    h
+00000cb0: 6964 6465 6e5f 7374 6174 6573 3a20 4f70  idden_states: Op
+00000cc0: 7469 6f6e 616c 5b54 7570 6c65 5b6d 696e  tional[Tuple[min
+00000cd0: 6473 706f 7265 2e54 656e 736f 725d 5d20  dspore.Tensor]] 
+00000ce0: 3d20 4e6f 6e65 0a20 2020 2061 7474 656e  = None.    atten
+00000cf0: 7469 6f6e 733a 204f 7074 696f 6e61 6c5b  tions: Optional[
+00000d00: 5475 706c 655b 6d69 6e64 7370 6f72 652e  Tuple[mindspore.
+00000d10: 5465 6e73 6f72 5d5d 203d 204e 6f6e 650a  Tensor]] = None.
+00000d20: 0a0a 636c 6173 7320 4272 6f73 506f 7369  ..class BrosPosi
+00000d30: 7469 6f6e 616c 456d 6265 6464 696e 6731  tionalEmbedding1
+00000d40: 4428 6e6e 2e43 656c 6c29 3a0a 2020 2020  D(nn.Cell):.    
+00000d50: 2320 5265 6665 7265 6e63 653a 2068 7474  # Reference: htt
+00000d60: 7073 3a2f 2f67 6974 6875 622e 636f 6d2f  ps://github.com/
+00000d70: 6b69 6d69 796f 756e 672f 7472 616e 7366  kimiyoung/transf
+00000d80: 6f72 6d65 722d 786c 2f62 6c6f 622f 6d61  ormer-xl/blob/ma
+00000d90: 7374 6572 2f70 7974 6f72 6368 2f6d 656d  ster/pytorch/mem
+00000da0: 5f74 7261 6e73 666f 726d 6572 2e70 7923  _transformer.py#
+00000db0: 4c31 350a 0a20 2020 2064 6566 205f 5f69  L15..    def __i
+00000dc0: 6e69 745f 5f28 7365 6c66 2c20 636f 6e66  nit__(self, conf
+00000dd0: 6967 293a 0a20 2020 2020 2020 2073 7570  ig):.        sup
+00000de0: 6572 2842 726f 7350 6f73 6974 696f 6e61  er(BrosPositiona
+00000df0: 6c45 6d62 6564 6469 6e67 3144 2c20 7365  lEmbedding1D, se
+00000e00: 6c66 292e 5f5f 696e 6974 5f5f 2829 0a0a  lf).__init__()..
+00000e10: 2020 2020 2020 2020 7365 6c66 2e64 696d          self.dim
+00000e20: 5f62 626f 785f 7369 6e75 736f 6964 5f65  _bbox_sinusoid_e
+00000e30: 6d62 5f31 6420 3d20 636f 6e66 6967 2e64  mb_1d = config.d
+00000e40: 696d 5f62 626f 785f 7369 6e75 736f 6964  im_bbox_sinusoid
+00000e50: 5f65 6d62 5f31 640a 0a20 2020 2020 2020  _emb_1d..       
+00000e60: 2069 6e76 5f66 7265 7120 3d20 3120 2f20   inv_freq = 1 / 
+00000e70: 280a 2020 2020 2020 2020 2020 2020 3130  (.            10
+00000e80: 3030 3020 2a2a 2028 6f70 732e 6172 616e  000 ** (ops.aran
+00000e90: 6765 2830 2e30 2c20 7365 6c66 2e64 696d  ge(0.0, self.dim
+00000ea0: 5f62 626f 785f 7369 6e75 736f 6964 5f65  _bbox_sinusoid_e
+00000eb0: 6d62 5f31 642c 2032 2e30 2920 2f20 7365  mb_1d, 2.0) / se
+00000ec0: 6c66 2e64 696d 5f62 626f 785f 7369 6e75  lf.dim_bbox_sinu
+00000ed0: 736f 6964 5f65 6d62 5f31 6429 0a20 2020  soid_emb_1d).   
+00000ee0: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
+00000ef0: 656c 662e 696e 765f 6672 6571 203d 2069  elf.inv_freq = i
+00000f00: 6e76 5f66 7265 710a 0a20 2020 2064 6566  nv_freq..    def
+00000f10: 2063 6f6e 7374 7275 6374 2873 656c 662c   construct(self,
+00000f20: 2070 6f73 5f73 6571 3a20 6d69 6e64 7370   pos_seq: mindsp
+00000f30: 6f72 652e 5465 6e73 6f72 2920 2d3e 206d  ore.Tensor) -> m
+00000f40: 696e 6473 706f 7265 2e54 656e 736f 723a  indspore.Tensor:
+00000f50: 0a20 2020 2020 2020 2073 6571 5f73 697a  .        seq_siz
+00000f60: 6520 3d20 706f 735f 7365 712e 7368 6170  e = pos_seq.shap
+00000f70: 650a 2020 2020 2020 2020 6231 2c20 6232  e.        b1, b2
+00000f80: 2c20 6233 203d 2073 6571 5f73 697a 650a  , b3 = seq_size.
+00000f90: 2020 2020 2020 2020 7369 6e75 736f 6964          sinusoid
+00000fa0: 5f69 6e70 203d 2070 6f73 5f73 6571 2e76  _inp = pos_seq.v
+00000fb0: 6965 7728 6231 2c20 6232 2c20 6233 2c20  iew(b1, b2, b3, 
+00000fc0: 3129 202a 2073 656c 662e 696e 765f 6672  1) * self.inv_fr
+00000fd0: 6571 2e76 6965 7728 312c 2031 2c20 312c  eq.view(1, 1, 1,
+00000fe0: 2073 656c 662e 6469 6d5f 6262 6f78 5f73   self.dim_bbox_s
+00000ff0: 696e 7573 6f69 645f 656d 625f 3164 202f  inusoid_emb_1d /
+00001000: 2f20 3229 0a20 2020 2020 2020 2070 6f73  / 2).        pos
+00001010: 5f65 6d62 203d 206f 7073 2e63 6174 285b  _emb = ops.cat([
+00001020: 7369 6e75 736f 6964 5f69 6e70 2e73 696e  sinusoid_inp.sin
+00001030: 2829 2c20 7369 6e75 736f 6964 5f69 6e70  (), sinusoid_inp
+00001040: 2e63 6f73 2829 5d2c 2061 7869 733d 2d31  .cos()], axis=-1
+00001050: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00001060: 2070 6f73 5f65 6d62 0a0a 0a63 6c61 7373   pos_emb...class
+00001070: 2042 726f 7350 6f73 6974 696f 6e61 6c45   BrosPositionalE
+00001080: 6d62 6564 6469 6e67 3244 286e 6e2e 4365  mbedding2D(nn.Ce
+00001090: 6c6c 293a 0a20 2020 2064 6566 205f 5f69  ll):.    def __i
+000010a0: 6e69 745f 5f28 7365 6c66 2c20 636f 6e66  nit__(self, conf
+000010b0: 6967 293a 0a20 2020 2020 2020 2073 7570  ig):.        sup
+000010c0: 6572 2842 726f 7350 6f73 6974 696f 6e61  er(BrosPositiona
+000010d0: 6c45 6d62 6564 6469 6e67 3244 2c20 7365  lEmbedding2D, se
+000010e0: 6c66 292e 5f5f 696e 6974 5f5f 2829 0a0a  lf).__init__()..
+000010f0: 2020 2020 2020 2020 7365 6c66 2e64 696d          self.dim
+00001100: 5f62 626f 7820 3d20 636f 6e66 6967 2e64  _bbox = config.d
+00001110: 696d 5f62 626f 780a 2020 2020 2020 2020  im_bbox.        
+00001120: 7365 6c66 2e78 5f70 6f73 5f65 6d62 203d  self.x_pos_emb =
+00001130: 2042 726f 7350 6f73 6974 696f 6e61 6c45   BrosPositionalE
+00001140: 6d62 6564 6469 6e67 3144 2863 6f6e 6669  mbedding1D(confi
+00001150: 6729 0a20 2020 2020 2020 2073 656c 662e  g).        self.
+00001160: 795f 706f 735f 656d 6220 3d20 4272 6f73  y_pos_emb = Bros
+00001170: 506f 7369 7469 6f6e 616c 456d 6265 6464  PositionalEmbedd
+00001180: 696e 6731 4428 636f 6e66 6967 290a 0a20  ing1D(config).. 
+00001190: 2020 2064 6566 2063 6f6e 7374 7275 6374     def construct
+000011a0: 2873 656c 662c 2062 626f 783a 206d 696e  (self, bbox: min
+000011b0: 6473 706f 7265 2e54 656e 736f 7229 202d  dspore.Tensor) -
+000011c0: 3e20 6d69 6e64 7370 6f72 652e 5465 6e73  > mindspore.Tens
+000011d0: 6f72 3a0a 2020 2020 2020 2020 7374 6163  or:.        stac
+000011e0: 6b20 3d20 5b5d 0a20 2020 2020 2020 2066  k = [].        f
+000011f0: 6f72 2069 2069 6e20 7261 6e67 6528 7365  or i in range(se
+00001200: 6c66 2e64 696d 5f62 626f 7829 3a0a 2020  lf.dim_bbox):.  
+00001210: 2020 2020 2020 2020 2020 6966 2069 2025            if i %
+00001220: 2032 203d 3d20 303a 0a20 2020 2020 2020   2 == 0:.       
+00001230: 2020 2020 2020 2020 2073 7461 636b 2e61           stack.a
+00001240: 7070 656e 6428 7365 6c66 2e78 5f70 6f73  ppend(self.x_pos
+00001250: 5f65 6d62 2862 626f 785b 2e2e 2e2c 2069  _emb(bbox[..., i
+00001260: 5d29 290a 2020 2020 2020 2020 2020 2020  ])).            
+00001270: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00001280: 2020 2020 2020 7374 6163 6b2e 6170 7065        stack.appe
+00001290: 6e64 2873 656c 662e 795f 706f 735f 656d  nd(self.y_pos_em
+000012a0: 6228 6262 6f78 5b2e 2e2e 2c20 695d 2929  b(bbox[..., i]))
+000012b0: 0a20 2020 2020 2020 2062 626f 785f 706f  .        bbox_po
+000012c0: 735f 656d 6220 3d20 6f70 732e 6361 7428  s_emb = ops.cat(
+000012d0: 7374 6163 6b2c 2061 7869 733d 2d31 290a  stack, axis=-1).
+000012e0: 2020 2020 2020 2020 7265 7475 726e 2062          return b
+000012f0: 626f 785f 706f 735f 656d 620a 0a0a 636c  box_pos_emb...cl
+00001300: 6173 7320 4272 6f73 4262 6f78 456d 6265  ass BrosBboxEmbe
+00001310: 6464 696e 6773 286e 6e2e 4365 6c6c 293a  ddings(nn.Cell):
+00001320: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+00001330: 5f28 7365 6c66 2c20 636f 6e66 6967 293a  _(self, config):
+00001340: 0a20 2020 2020 2020 2073 7570 6572 2842  .        super(B
+00001350: 726f 7342 626f 7845 6d62 6564 6469 6e67  rosBboxEmbedding
+00001360: 732c 2073 656c 6629 2e5f 5f69 6e69 745f  s, self).__init_
+00001370: 5f28 290a 2020 2020 2020 2020 7365 6c66  _().        self
+00001380: 2e62 626f 785f 7369 6e75 736f 6964 5f65  .bbox_sinusoid_e
+00001390: 6d62 203d 2042 726f 7350 6f73 6974 696f  mb = BrosPositio
+000013a0: 6e61 6c45 6d62 6564 6469 6e67 3244 2863  nalEmbedding2D(c
+000013b0: 6f6e 6669 6729 0a20 2020 2020 2020 2073  onfig).        s
+000013c0: 656c 662e 6262 6f78 5f70 726f 6a65 6374  elf.bbox_project
+000013d0: 696f 6e20 3d20 6e6e 2e44 656e 7365 2863  ion = nn.Dense(c
+000013e0: 6f6e 6669 672e 6469 6d5f 6262 6f78 5f73  onfig.dim_bbox_s
+000013f0: 696e 7573 6f69 645f 656d 625f 3264 2c20  inusoid_emb_2d, 
+00001400: 636f 6e66 6967 2e64 696d 5f62 626f 785f  config.dim_bbox_
+00001410: 7072 6f6a 6563 7469 6f6e 2c20 6861 735f  projection, has_
+00001420: 6269 6173 3d46 616c 7365 290a 0a20 2020  bias=False)..   
+00001430: 2064 6566 2063 6f6e 7374 7275 6374 2873   def construct(s
+00001440: 656c 662c 2062 626f 783a 206d 696e 6473  elf, bbox: minds
+00001450: 706f 7265 2e54 656e 736f 7229 3a0a 2020  pore.Tensor):.  
+00001460: 2020 2020 2020 6262 6f78 5f74 203d 2062        bbox_t = b
+00001470: 626f 782e 7377 6170 6178 6573 2830 2c20  box.swapaxes(0, 
+00001480: 3129 0a20 2020 2020 2020 2062 626f 785f  1).        bbox_
+00001490: 706f 7320 3d20 6262 6f78 5f74 5b4e 6f6e  pos = bbox_t[Non
+000014a0: 652c 203a 2c20 3a2c 203a 5d20 2d20 6262  e, :, :, :] - bb
+000014b0: 6f78 5f74 5b3a 2c20 4e6f 6e65 2c20 3a2c  ox_t[:, None, :,
+000014c0: 203a 5d0a 2020 2020 2020 2020 6262 6f78   :].        bbox
+000014d0: 5f70 6f73 5f65 6d62 203d 2073 656c 662e  _pos_emb = self.
+000014e0: 6262 6f78 5f73 696e 7573 6f69 645f 656d  bbox_sinusoid_em
+000014f0: 6228 6262 6f78 5f70 6f73 290a 2020 2020  b(bbox_pos).    
+00001500: 2020 2020 6262 6f78 5f70 6f73 5f65 6d62      bbox_pos_emb
+00001510: 203d 2073 656c 662e 6262 6f78 5f70 726f   = self.bbox_pro
+00001520: 6a65 6374 696f 6e28 6262 6f78 5f70 6f73  jection(bbox_pos
+00001530: 5f65 6d62 290a 0a20 2020 2020 2020 2072  _emb)..        r
+00001540: 6574 7572 6e20 6262 6f78 5f70 6f73 5f65  eturn bbox_pos_e
+00001550: 6d62 0a0a 0a63 6c61 7373 2042 726f 7354  mb...class BrosT
+00001560: 6578 7445 6d62 6564 6469 6e67 7328 6e6e  extEmbeddings(nn
+00001570: 2e43 656c 6c29 3a0a 2020 2020 2222 2243  .Cell):.    """C
+00001580: 6f6e 7374 7275 6374 2074 6865 2065 6d62  onstruct the emb
+00001590: 6564 6469 6e67 7320 6672 6f6d 2077 6f72  eddings from wor
+000015a0: 642c 2070 6f73 6974 696f 6e20 616e 6420  d, position and 
+000015b0: 746f 6b65 6e5f 7479 7065 2065 6d62 6564  token_type embed
+000015c0: 6469 6e67 732e 2222 220a 0a20 2020 2064  dings."""..    d
+000015d0: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
+000015e0: 2c20 636f 6e66 6967 293a 0a20 2020 2020  , config):.     
+000015f0: 2020 2073 7570 6572 2829 2e5f 5f69 6e69     super().__ini
+00001600: 745f 5f28 290a 0a20 2020 2020 2020 2073  t__()..        s
+00001610: 656c 662e 776f 7264 5f65 6d62 6564 6469  elf.word_embeddi
+00001620: 6e67 7320 3d20 6e6e 2e45 6d62 6564 6469  ngs = nn.Embeddi
+00001630: 6e67 2863 6f6e 6669 672e 766f 6361 625f  ng(config.vocab_
+00001640: 7369 7a65 2c20 636f 6e66 6967 2e68 6964  size, config.hid
+00001650: 6465 6e5f 7369 7a65 2c20 7061 6464 696e  den_size, paddin
+00001660: 675f 6964 783d 636f 6e66 6967 2e70 6164  g_idx=config.pad
+00001670: 5f74 6f6b 656e 5f69 6429 0a20 2020 2020  _token_id).     
+00001680: 2020 2073 656c 662e 706f 7369 7469 6f6e     self.position
+00001690: 5f65 6d62 6564 6469 6e67 7320 3d20 6e6e  _embeddings = nn
+000016a0: 2e45 6d62 6564 6469 6e67 2863 6f6e 6669  .Embedding(confi
+000016b0: 672e 6d61 785f 706f 7369 7469 6f6e 5f65  g.max_position_e
+000016c0: 6d62 6564 6469 6e67 732c 2063 6f6e 6669  mbeddings, confi
+000016d0: 672e 6869 6464 656e 5f73 697a 6529 0a20  g.hidden_size). 
+000016e0: 2020 2020 2020 2073 656c 662e 746f 6b65         self.toke
+000016f0: 6e5f 7479 7065 5f65 6d62 6564 6469 6e67  n_type_embedding
+00001700: 7320 3d20 6e6e 2e45 6d62 6564 6469 6e67  s = nn.Embedding
+00001710: 2863 6f6e 6669 672e 7479 7065 5f76 6f63  (config.type_voc
+00001720: 6162 5f73 697a 652c 2063 6f6e 6669 672e  ab_size, config.
+00001730: 6869 6464 656e 5f73 697a 6529 0a0a 2020  hidden_size)..  
+00001740: 2020 2020 2020 2320 7365 6c66 2e4c 6179        # self.Lay
+00001750: 6572 4e6f 726d 2069 7320 6e6f 7420 736e  erNorm is not sn
+00001760: 616b 652d 6361 7365 6420 746f 2073 7469  ake-cased to sti
+00001770: 636b 2077 6974 6820 5465 6e73 6f72 466c  ck with TensorFl
+00001780: 6f77 206d 6f64 656c 2076 6172 6961 626c  ow model variabl
+00001790: 6520 6e61 6d65 2061 6e64 2062 6520 6162  e name and be ab
+000017a0: 6c65 2074 6f20 6c6f 6164 0a20 2020 2020  le to load.     
+000017b0: 2020 2023 2061 6e79 2054 656e 736f 7246     # any TensorF
+000017c0: 6c6f 7720 6368 6563 6b70 6f69 6e74 2066  low checkpoint f
+000017d0: 696c 650a 2020 2020 2020 2020 7365 6c66  ile.        self
+000017e0: 2e4c 6179 6572 4e6f 726d 203d 206e 6e2e  .LayerNorm = nn.
+000017f0: 4c61 7965 724e 6f72 6d28 636f 6e66 6967  LayerNorm(config
+00001800: 2e68 6964 6465 6e5f 7369 7a65 2c20 6570  .hidden_size, ep
+00001810: 7369 6c6f 6e3d 636f 6e66 6967 2e6c 6179  silon=config.lay
+00001820: 6572 5f6e 6f72 6d5f 6570 7329 0a20 2020  er_norm_eps).   
+00001830: 2020 2020 2073 656c 662e 6472 6f70 6f75       self.dropou
+00001840: 7420 3d20 6e6e 2e44 726f 706f 7574 2870  t = nn.Dropout(p
+00001850: 3d63 6f6e 6669 672e 6869 6464 656e 5f64  =config.hidden_d
+00001860: 726f 706f 7574 5f70 726f 6229 0a20 2020  ropout_prob).   
+00001870: 2020 2020 2023 2070 6f73 6974 696f 6e5f       # position_
+00001880: 6964 7320 2831 2c20 6c65 6e20 706f 7369  ids (1, len posi
+00001890: 7469 6f6e 2065 6d62 2920 6973 2063 6f6e  tion emb) is con
+000018a0: 7469 6775 6f75 7320 696e 206d 656d 6f72  tiguous in memor
+000018b0: 7920 616e 6420 6578 706f 7274 6564 2077  y and exported w
+000018c0: 6865 6e20 7365 7269 616c 697a 6564 0a20  hen serialized. 
+000018d0: 2020 2020 2020 2073 656c 662e 706f 7369         self.posi
+000018e0: 7469 6f6e 5f65 6d62 6564 6469 6e67 5f74  tion_embedding_t
+000018f0: 7970 6520 3d20 6765 7461 7474 7228 636f  ype = getattr(co
+00001900: 6e66 6967 2c20 2270 6f73 6974 696f 6e5f  nfig, "position_
+00001910: 656d 6265 6464 696e 675f 7479 7065 222c  embedding_type",
+00001920: 2022 6162 736f 6c75 7465 2229 0a20 2020   "absolute").   
+00001930: 2020 2020 2073 656c 662e 706f 7369 7469       self.positi
+00001940: 6f6e 5f69 6473 203d 206f 7073 2e61 7261  on_ids = ops.ara
+00001950: 6e67 6528 636f 6e66 6967 2e6d 6178 5f70  nge(config.max_p
+00001960: 6f73 6974 696f 6e5f 656d 6265 6464 696e  osition_embeddin
+00001970: 6773 292e 7265 7368 6170 6528 312c 202d  gs).reshape(1, -
+00001980: 3129 0a20 2020 2020 2020 2073 656c 662e  1).        self.
+00001990: 746f 6b65 6e5f 7479 7065 5f69 6473 203d  token_type_ids =
+000019a0: 206f 7073 2e7a 6572 6f73 2873 656c 662e   ops.zeros(self.
+000019b0: 706f 7369 7469 6f6e 5f69 6473 2e73 6861  position_ids.sha
+000019c0: 7065 2c20 6474 7970 653d 6d69 6e64 7370  pe, dtype=mindsp
+000019d0: 6f72 652e 696e 7436 3429 0a0a 2020 2020  ore.int64)..    
+000019e0: 6465 6620 636f 6e73 7472 7563 7428 0a20  def construct(. 
+000019f0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+00001a00: 2020 2020 2069 6e70 7574 5f69 6473 3a20       input_ids: 
+00001a10: 4f70 7469 6f6e 616c 5b6d 696e 6473 706f  Optional[mindspo
+00001a20: 7265 2e54 656e 736f 725d 203d 204e 6f6e  re.Tensor] = Non
+00001a30: 652c 0a20 2020 2020 2020 2074 6f6b 656e  e,.        token
+00001a40: 5f74 7970 655f 6964 733a 204f 7074 696f  _type_ids: Optio
+00001a50: 6e61 6c5b 6d69 6e64 7370 6f72 652e 5465  nal[mindspore.Te
+00001a60: 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a 2020  nsor] = None,.  
+00001a70: 2020 2020 2020 706f 7369 7469 6f6e 5f69        position_i
+00001a80: 6473 3a20 4f70 7469 6f6e 616c 5b6d 696e  ds: Optional[min
+00001a90: 6473 706f 7265 2e54 656e 736f 725d 203d  dspore.Tensor] =
+00001aa0: 204e 6f6e 652c 0a20 2020 2020 2020 2069   None,.        i
+00001ab0: 6e70 7574 735f 656d 6265 6473 3a20 4f70  nputs_embeds: Op
+00001ac0: 7469 6f6e 616c 5b6d 696e 6473 706f 7265  tional[mindspore
+00001ad0: 2e54 656e 736f 725d 203d 204e 6f6e 652c  .Tensor] = None,
+00001ae0: 0a20 2020 2020 2020 2070 6173 745f 6b65  .        past_ke
+00001af0: 795f 7661 6c75 6573 5f6c 656e 6774 683a  y_values_length:
+00001b00: 2069 6e74 203d 2030 2c0a 2020 2020 2920   int = 0,.    ) 
+00001b10: 2d3e 206d 696e 6473 706f 7265 2e54 656e  -> mindspore.Ten
+00001b20: 736f 723a 0a20 2020 2020 2020 2069 6620  sor:.        if 
+00001b30: 696e 7075 745f 6964 7320 6973 206e 6f74  input_ids is not
+00001b40: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00001b50: 2020 2069 6e70 7574 5f73 6861 7065 203d     input_shape =
+00001b60: 2069 6e70 7574 5f69 6473 2e73 6861 7065   input_ids.shape
+00001b70: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00001b80: 2020 2020 2020 2020 2020 2069 6e70 7574             input
+00001b90: 5f73 6861 7065 203d 2069 6e70 7574 735f  _shape = inputs_
+00001ba0: 656d 6265 6473 2e73 6861 7065 5b3a 2d31  embeds.shape[:-1
+00001bb0: 5d0a 0a20 2020 2020 2020 2073 6571 5f6c  ]..        seq_l
+00001bc0: 656e 6774 6820 3d20 696e 7075 745f 7368  ength = input_sh
+00001bd0: 6170 655b 315d 0a0a 2020 2020 2020 2020  ape[1]..        
+00001be0: 6966 2070 6f73 6974 696f 6e5f 6964 7320  if position_ids 
+00001bf0: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00001c00: 2020 2020 2070 6f73 6974 696f 6e5f 6964       position_id
+00001c10: 7320 3d20 7365 6c66 2e70 6f73 6974 696f  s = self.positio
+00001c20: 6e5f 6964 735b 3a2c 2070 6173 745f 6b65  n_ids[:, past_ke
+00001c30: 795f 7661 6c75 6573 5f6c 656e 6774 6820  y_values_length 
+00001c40: 3a20 7365 715f 6c65 6e67 7468 202b 2070  : seq_length + p
+00001c50: 6173 745f 6b65 795f 7661 6c75 6573 5f6c  ast_key_values_l
+00001c60: 656e 6774 685d 0a0a 2020 2020 2020 2020  ength]..        
+00001c70: 6966 2074 6f6b 656e 5f74 7970 655f 6964  if token_type_id
+00001c80: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
+00001c90: 2020 2020 2020 2069 6620 6861 7361 7474         if hasatt
+00001ca0: 7228 7365 6c66 2c20 2274 6f6b 656e 5f74  r(self, "token_t
+00001cb0: 7970 655f 6964 7322 293a 0a20 2020 2020  ype_ids"):.     
+00001cc0: 2020 2020 2020 2020 2020 2062 7566 6665             buffe
+00001cd0: 7265 645f 746f 6b65 6e5f 7479 7065 5f69  red_token_type_i
+00001ce0: 6473 203d 2073 656c 662e 746f 6b65 6e5f  ds = self.token_
+00001cf0: 7479 7065 5f69 6473 5b3a 2c20 3a73 6571  type_ids[:, :seq
+00001d00: 5f6c 656e 6774 685d 0a20 2020 2020 2020  _length].       
+00001d10: 2020 2020 2020 2020 2062 7566 6665 7265           buffere
+00001d20: 645f 746f 6b65 6e5f 7479 7065 5f69 6473  d_token_type_ids
+00001d30: 5f65 7870 616e 6465 6420 3d20 6275 6666  _expanded = buff
+00001d40: 6572 6564 5f74 6f6b 656e 5f74 7970 655f  ered_token_type_
+00001d50: 6964 732e 6578 7061 6e64 2869 6e70 7574  ids.expand(input
+00001d60: 5f73 6861 7065 5b30 5d2c 2073 6571 5f6c  _shape[0], seq_l
+00001d70: 656e 6774 6829 0a20 2020 2020 2020 2020  ength).         
+00001d80: 2020 2020 2020 2074 6f6b 656e 5f74 7970         token_typ
+00001d90: 655f 6964 7320 3d20 6275 6666 6572 6564  e_ids = buffered
+00001da0: 5f74 6f6b 656e 5f74 7970 655f 6964 735f  _token_type_ids_
+00001db0: 6578 7061 6e64 6564 0a20 2020 2020 2020  expanded.       
+00001dc0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00001dd0: 2020 2020 2020 2020 2020 2074 6f6b 656e             token
+00001de0: 5f74 7970 655f 6964 7320 3d20 6f70 732e  _type_ids = ops.
+00001df0: 7a65 726f 7328 696e 7075 745f 7368 6170  zeros(input_shap
+00001e00: 652c 2064 7479 7065 3d6d 696e 6473 706f  e, dtype=mindspo
+00001e10: 7265 2e69 6e74 3634 290a 0a20 2020 2020  re.int64)..     
+00001e20: 2020 2069 6620 696e 7075 7473 5f65 6d62     if inputs_emb
+00001e30: 6564 7320 6973 204e 6f6e 653a 0a20 2020  eds is None:.   
+00001e40: 2020 2020 2020 2020 2069 6e70 7574 735f           inputs_
+00001e50: 656d 6265 6473 203d 2073 656c 662e 776f  embeds = self.wo
+00001e60: 7264 5f65 6d62 6564 6469 6e67 7328 696e  rd_embeddings(in
+00001e70: 7075 745f 6964 7329 0a20 2020 2020 2020  put_ids).       
+00001e80: 2074 6f6b 656e 5f74 7970 655f 656d 6265   token_type_embe
+00001e90: 6464 696e 6773 203d 2073 656c 662e 746f  ddings = self.to
+00001ea0: 6b65 6e5f 7479 7065 5f65 6d62 6564 6469  ken_type_embeddi
+00001eb0: 6e67 7328 746f 6b65 6e5f 7479 7065 5f69  ngs(token_type_i
+00001ec0: 6473 290a 0a20 2020 2020 2020 2065 6d62  ds)..        emb
+00001ed0: 6564 6469 6e67 7320 3d20 696e 7075 7473  eddings = inputs
+00001ee0: 5f65 6d62 6564 7320 2b20 746f 6b65 6e5f  _embeds + token_
+00001ef0: 7479 7065 5f65 6d62 6564 6469 6e67 730a  type_embeddings.
+00001f00: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00001f10: 706f 7369 7469 6f6e 5f65 6d62 6564 6469  position_embeddi
+00001f20: 6e67 5f74 7970 6520 3d3d 2022 6162 736f  ng_type == "abso
+00001f30: 6c75 7465 223a 0a20 2020 2020 2020 2020  lute":.         
+00001f40: 2020 2070 6f73 6974 696f 6e5f 656d 6265     position_embe
+00001f50: 6464 696e 6773 203d 2073 656c 662e 706f  ddings = self.po
+00001f60: 7369 7469 6f6e 5f65 6d62 6564 6469 6e67  sition_embedding
+00001f70: 7328 706f 7369 7469 6f6e 5f69 6473 290a  s(position_ids).
+00001f80: 2020 2020 2020 2020 2020 2020 656d 6265              embe
+00001f90: 6464 696e 6773 202b 3d20 706f 7369 7469  ddings += positi
+00001fa0: 6f6e 5f65 6d62 6564 6469 6e67 730a 2020  on_embeddings.  
+00001fb0: 2020 2020 2020 656d 6265 6464 696e 6773        embeddings
+00001fc0: 203d 2073 656c 662e 4c61 7965 724e 6f72   = self.LayerNor
+00001fd0: 6d28 656d 6265 6464 696e 6773 290a 2020  m(embeddings).  
+00001fe0: 2020 2020 2020 656d 6265 6464 696e 6773        embeddings
+00001ff0: 203d 2073 656c 662e 6472 6f70 6f75 7428   = self.dropout(
+00002000: 656d 6265 6464 696e 6773 290a 2020 2020  embeddings).    
+00002010: 2020 2020 7265 7475 726e 2065 6d62 6564      return embed
+00002020: 6469 6e67 730a 0a0a 636c 6173 7320 4272  dings...class Br
+00002030: 6f73 5365 6c66 4174 7465 6e74 696f 6e28  osSelfAttention(
+00002040: 6e6e 2e43 656c 6c29 3a0a 2020 2020 6465  nn.Cell):.    de
+00002050: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
+00002060: 2063 6f6e 6669 6729 3a0a 2020 2020 2020   config):.      
+00002070: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
+00002080: 5f5f 2829 0a20 2020 2020 2020 2069 6620  __().        if 
+00002090: 636f 6e66 6967 2e68 6964 6465 6e5f 7369  config.hidden_si
+000020a0: 7a65 2025 2063 6f6e 6669 672e 6e75 6d5f  ze % config.num_
+000020b0: 6174 7465 6e74 696f 6e5f 6865 6164 7320  attention_heads 
+000020c0: 213d 2030 2061 6e64 206e 6f74 2068 6173  != 0 and not has
+000020d0: 6174 7472 2863 6f6e 6669 672c 2022 656d  attr(config, "em
+000020e0: 6265 6464 696e 675f 7369 7a65 2229 3a0a  bedding_size"):.
+000020f0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00002100: 6520 5661 6c75 6545 7272 6f72 280a 2020  e ValueError(.  
+00002110: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+00002120: 5468 6520 6869 6464 656e 2073 697a 6520  The hidden size 
+00002130: 287b 636f 6e66 6967 2e68 6964 6465 6e5f  ({config.hidden_
+00002140: 7369 7a65 7d29 2069 7320 6e6f 7420 6120  size}) is not a 
+00002150: 6d75 6c74 6970 6c65 206f 6620 7468 6520  multiple of the 
+00002160: 6e75 6d62 6572 206f 6620 6174 7465 6e74  number of attent
+00002170: 696f 6e20 220a 2020 2020 2020 2020 2020  ion ".          
+00002180: 2020 2020 2020 6622 6865 6164 7320 287b        f"heads ({
+00002190: 636f 6e66 6967 2e6e 756d 5f61 7474 656e  config.num_atten
+000021a0: 7469 6f6e 5f68 6561 6473 7d29 220a 2020  tion_heads})".  
+000021b0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+000021c0: 2020 2020 2073 656c 662e 6e75 6d5f 6174       self.num_at
+000021d0: 7465 6e74 696f 6e5f 6865 6164 7320 3d20  tention_heads = 
+000021e0: 636f 6e66 6967 2e6e 756d 5f61 7474 656e  config.num_atten
+000021f0: 7469 6f6e 5f68 6561 6473 0a20 2020 2020  tion_heads.     
+00002200: 2020 2073 656c 662e 6174 7465 6e74 696f     self.attentio
+00002210: 6e5f 6865 6164 5f73 697a 6520 3d20 696e  n_head_size = in
+00002220: 7428 636f 6e66 6967 2e68 6964 6465 6e5f  t(config.hidden_
+00002230: 7369 7a65 202f 2063 6f6e 6669 672e 6e75  size / config.nu
+00002240: 6d5f 6174 7465 6e74 696f 6e5f 6865 6164  m_attention_head
+00002250: 7329 0a20 2020 2020 2020 2073 656c 662e  s).        self.
+00002260: 616c 6c5f 6865 6164 5f73 697a 6520 3d20  all_head_size = 
+00002270: 7365 6c66 2e6e 756d 5f61 7474 656e 7469  self.num_attenti
+00002280: 6f6e 5f68 6561 6473 202a 2073 656c 662e  on_heads * self.
+00002290: 6174 7465 6e74 696f 6e5f 6865 6164 5f73  attention_head_s
+000022a0: 697a 650a 0a20 2020 2020 2020 2073 656c  ize..        sel
+000022b0: 662e 7175 6572 7920 3d20 6e6e 2e44 656e  f.query = nn.Den
+000022c0: 7365 2863 6f6e 6669 672e 6869 6464 656e  se(config.hidden
+000022d0: 5f73 697a 652c 2073 656c 662e 616c 6c5f  _size, self.all_
+000022e0: 6865 6164 5f73 697a 6529 0a20 2020 2020  head_size).     
+000022f0: 2020 2073 656c 662e 6b65 7920 3d20 6e6e     self.key = nn
+00002300: 2e44 656e 7365 2863 6f6e 6669 672e 6869  .Dense(config.hi
+00002310: 6464 656e 5f73 697a 652c 2073 656c 662e  dden_size, self.
+00002320: 616c 6c5f 6865 6164 5f73 697a 6529 0a20  all_head_size). 
+00002330: 2020 2020 2020 2073 656c 662e 7661 6c75         self.valu
+00002340: 6520 3d20 6e6e 2e44 656e 7365 2863 6f6e  e = nn.Dense(con
+00002350: 6669 672e 6869 6464 656e 5f73 697a 652c  fig.hidden_size,
+00002360: 2073 656c 662e 616c 6c5f 6865 6164 5f73   self.all_head_s
+00002370: 697a 6529 0a0a 2020 2020 2020 2020 7365  ize)..        se
+00002380: 6c66 2e64 726f 706f 7574 203d 206e 6e2e  lf.dropout = nn.
+00002390: 4472 6f70 6f75 7428 703d 636f 6e66 6967  Dropout(p=config
+000023a0: 2e61 7474 656e 7469 6f6e 5f70 726f 6273  .attention_probs
+000023b0: 5f64 726f 706f 7574 5f70 726f 6229 0a20  _dropout_prob). 
+000023c0: 2020 2020 2020 2073 656c 662e 706f 7369         self.posi
+000023d0: 7469 6f6e 5f65 6d62 6564 6469 6e67 5f74  tion_embedding_t
+000023e0: 7970 6520 3d20 6765 7461 7474 7228 636f  ype = getattr(co
+000023f0: 6e66 6967 2c20 2270 6f73 6974 696f 6e5f  nfig, "position_
+00002400: 656d 6265 6464 696e 675f 7479 7065 222c  embedding_type",
+00002410: 2022 6162 736f 6c75 7465 2229 0a20 2020   "absolute").   
+00002420: 2020 2020 2069 6620 7365 6c66 2e70 6f73       if self.pos
+00002430: 6974 696f 6e5f 656d 6265 6464 696e 675f  ition_embedding_
+00002440: 7479 7065 2069 6e20 2827 7265 6c61 7469  type in ('relati
+00002450: 7665 5f6b 6579 272c 2027 7265 6c61 7469  ve_key', 'relati
+00002460: 7665 5f6b 6579 5f71 7565 7279 2729 3a0a  ve_key_query'):.
+00002470: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00002480: 2e6d 6178 5f70 6f73 6974 696f 6e5f 656d  .max_position_em
+00002490: 6265 6464 696e 6773 203d 2063 6f6e 6669  beddings = confi
+000024a0: 672e 6d61 785f 706f 7369 7469 6f6e 5f65  g.max_position_e
+000024b0: 6d62 6564 6469 6e67 730a 2020 2020 2020  mbeddings.      
+000024c0: 2020 2020 2020 7365 6c66 2e64 6973 7461        self.dista
+000024d0: 6e63 655f 656d 6265 6464 696e 6720 3d20  nce_embedding = 
+000024e0: 6e6e 2e45 6d62 6564 6469 6e67 2832 202a  nn.Embedding(2 *
+000024f0: 2063 6f6e 6669 672e 6d61 785f 706f 7369   config.max_posi
+00002500: 7469 6f6e 5f65 6d62 6564 6469 6e67 7320  tion_embeddings 
+00002510: 2d20 312c 2073 656c 662e 6174 7465 6e74  - 1, self.attent
+00002520: 696f 6e5f 6865 6164 5f73 697a 6529 0a0a  ion_head_size)..
+00002530: 2020 2020 2020 2020 7365 6c66 2e69 735f          self.is_
+00002540: 6465 636f 6465 7220 3d20 636f 6e66 6967  decoder = config
+00002550: 2e69 735f 6465 636f 6465 720a 0a20 2020  .is_decoder..   
+00002560: 2064 6566 2073 7761 7061 7865 735f 666f   def swapaxes_fo
+00002570: 725f 7363 6f72 6573 2873 656c 662c 2078  r_scores(self, x
+00002580: 3a20 6d69 6e64 7370 6f72 652e 5465 6e73  : mindspore.Tens
+00002590: 6f72 293a 0a20 2020 2020 2020 206e 6577  or):.        new
+000025a0: 5f78 5f73 6861 7065 203d 2078 2e73 6861  _x_shape = x.sha
+000025b0: 7065 5b3a 2d31 5d20 2b20 280a 2020 2020  pe[:-1] + (.    
+000025c0: 2020 2020 2020 2020 7365 6c66 2e6e 756d          self.num
+000025d0: 5f61 7474 656e 7469 6f6e 5f68 6561 6473  _attention_heads
+000025e0: 2c0a 2020 2020 2020 2020 2020 2020 7365  ,.            se
+000025f0: 6c66 2e61 7474 656e 7469 6f6e 5f68 6561  lf.attention_hea
+00002600: 645f 7369 7a65 2c0a 2020 2020 2020 2020  d_size,.        
+00002610: 290a 2020 2020 2020 2020 7820 3d20 782e  ).        x = x.
+00002620: 7669 6577 282a 6e65 775f 785f 7368 6170  view(*new_x_shap
+00002630: 6529 0a20 2020 2020 2020 2072 6574 7572  e).        retur
+00002640: 6e20 782e 7065 726d 7574 6528 302c 2032  n x.permute(0, 2
+00002650: 2c20 312c 2033 290a 0a20 2020 2064 6566  , 1, 3)..    def
+00002660: 2063 6f6e 7374 7275 6374 280a 2020 2020   construct(.    
+00002670: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+00002680: 2020 6869 6464 656e 5f73 7461 7465 733a    hidden_states:
+00002690: 206d 696e 6473 706f 7265 2e54 656e 736f   mindspore.Tenso
+000026a0: 722c 0a20 2020 2020 2020 2062 626f 785f  r,.        bbox_
+000026b0: 706f 735f 656d 623a 206d 696e 6473 706f  pos_emb: mindspo
+000026c0: 7265 2e54 656e 736f 722c 0a20 2020 2020  re.Tensor,.     
+000026d0: 2020 2061 7474 656e 7469 6f6e 5f6d 6173     attention_mas
+000026e0: 6b3a 204f 7074 696f 6e61 6c5b 6d69 6e64  k: Optional[mind
+000026f0: 7370 6f72 652e 5465 6e73 6f72 5d20 3d20  spore.Tensor] = 
+00002700: 4e6f 6e65 2c0a 2020 2020 2020 2020 6865  None,.        he
+00002710: 6164 5f6d 6173 6b3a 204f 7074 696f 6e61  ad_mask: Optiona
+00002720: 6c5b 6d69 6e64 7370 6f72 652e 5465 6e73  l[mindspore.Tens
+00002730: 6f72 5d20 3d20 4e6f 6e65 2c0a 2020 2020  or] = None,.    
+00002740: 2020 2020 656e 636f 6465 725f 6869 6464      encoder_hidd
+00002750: 656e 5f73 7461 7465 733a 204f 7074 696f  en_states: Optio
+00002760: 6e61 6c5b 6d69 6e64 7370 6f72 652e 5465  nal[mindspore.Te
+00002770: 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a 2020  nsor] = None,.  
+00002780: 2020 2020 2020 656e 636f 6465 725f 6174        encoder_at
+00002790: 7465 6e74 696f 6e5f 6d61 736b 3a20 4f70  tention_mask: Op
+000027a0: 7469 6f6e 616c 5b6d 696e 6473 706f 7265  tional[mindspore
+000027b0: 2e54 656e 736f 725d 203d 204e 6f6e 652c  .Tensor] = None,
+000027c0: 0a20 2020 2020 2020 2070 6173 745f 6b65  .        past_ke
+000027d0: 795f 7661 6c75 653a 204f 7074 696f 6e61  y_value: Optiona
+000027e0: 6c5b 5475 706c 655b 5475 706c 655b 6d69  l[Tuple[Tuple[mi
+000027f0: 6e64 7370 6f72 652e 5465 6e73 6f72 5d5d  ndspore.Tensor]]
+00002800: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+00002810: 2020 6f75 7470 7574 5f61 7474 656e 7469    output_attenti
+00002820: 6f6e 733a 204f 7074 696f 6e61 6c5b 6d69  ons: Optional[mi
+00002830: 6e64 7370 6f72 652e 5465 6e73 6f72 5d20  ndspore.Tensor] 
+00002840: 3d20 4661 6c73 652c 0a20 2020 2029 202d  = False,.    ) -
+00002850: 3e20 5475 706c 655b 6d69 6e64 7370 6f72  > Tuple[mindspor
+00002860: 652e 5465 6e73 6f72 5d3a 0a20 2020 2020  e.Tensor]:.     
+00002870: 2020 206d 6978 6564 5f71 7565 7279 5f6c     mixed_query_l
+00002880: 6179 6572 203d 2073 656c 662e 7175 6572  ayer = self.quer
+00002890: 7928 6869 6464 656e 5f73 7461 7465 7329  y(hidden_states)
+000028a0: 0a0a 2020 2020 2020 2020 2320 4966 2074  ..        # If t
+000028b0: 6869 7320 6973 2069 6e73 7461 6e74 6961  his is instantia
+000028c0: 7465 6420 6173 2061 2063 726f 7373 2d61  ted as a cross-a
+000028d0: 7474 656e 7469 6f6e 206d 6f64 756c 652c  ttention module,
+000028e0: 2074 6865 206b 6579 730a 2020 2020 2020   the keys.      
+000028f0: 2020 2320 616e 6420 7661 6c75 6573 2063    # and values c
+00002900: 6f6d 6520 6672 6f6d 2061 6e20 656e 636f  ome from an enco
+00002910: 6465 723b 2074 6865 2061 7474 656e 7469  der; the attenti
+00002920: 6f6e 206d 6173 6b20 6e65 6564 7320 746f  on mask needs to
+00002930: 2062 650a 2020 2020 2020 2020 2320 7375   be.        # su
+00002940: 6368 2074 6861 7420 7468 6520 656e 636f  ch that the enco
+00002950: 6465 7227 7320 7061 6464 696e 6720 746f  der's padding to
+00002960: 6b65 6e73 2061 7265 206e 6f74 2061 7474  kens are not att
+00002970: 656e 6465 6420 746f 2e0a 2020 2020 2020  ended to..      
+00002980: 2020 6973 5f63 726f 7373 5f61 7474 656e    is_cross_atten
+00002990: 7469 6f6e 203d 2065 6e63 6f64 6572 5f68  tion = encoder_h
+000029a0: 6964 6465 6e5f 7374 6174 6573 2069 7320  idden_states is 
+000029b0: 6e6f 7420 4e6f 6e65 0a0a 2020 2020 2020  not None..      
+000029c0: 2020 6966 2069 735f 6372 6f73 735f 6174    if is_cross_at
+000029d0: 7465 6e74 696f 6e20 616e 6420 7061 7374  tention and past
+000029e0: 5f6b 6579 5f76 616c 7565 2069 7320 6e6f  _key_value is no
+000029f0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00002a00: 2020 2020 2320 7265 7573 6520 6b2c 762c      # reuse k,v,
+00002a10: 2063 726f 7373 5f61 7474 656e 7469 6f6e   cross_attention
+00002a20: 730a 2020 2020 2020 2020 2020 2020 6b65  s.            ke
+00002a30: 795f 6c61 7965 7220 3d20 7061 7374 5f6b  y_layer = past_k
+00002a40: 6579 5f76 616c 7565 5b30 5d0a 2020 2020  ey_value[0].    
+00002a50: 2020 2020 2020 2020 7661 6c75 655f 6c61          value_la
+00002a60: 7965 7220 3d20 7061 7374 5f6b 6579 5f76  yer = past_key_v
+00002a70: 616c 7565 5b31 5d0a 2020 2020 2020 2020  alue[1].        
+00002a80: 2020 2020 6174 7465 6e74 696f 6e5f 6d61      attention_ma
+00002a90: 736b 203d 2065 6e63 6f64 6572 5f61 7474  sk = encoder_att
+00002aa0: 656e 7469 6f6e 5f6d 6173 6b0a 2020 2020  ention_mask.    
+00002ab0: 2020 2020 656c 6966 2069 735f 6372 6f73      elif is_cros
+00002ac0: 735f 6174 7465 6e74 696f 6e3a 0a20 2020  s_attention:.   
+00002ad0: 2020 2020 2020 2020 206b 6579 5f6c 6179           key_lay
+00002ae0: 6572 203d 2073 656c 662e 7377 6170 6178  er = self.swapax
+00002af0: 6573 5f66 6f72 5f73 636f 7265 7328 7365  es_for_scores(se
+00002b00: 6c66 2e6b 6579 2865 6e63 6f64 6572 5f68  lf.key(encoder_h
+00002b10: 6964 6465 6e5f 7374 6174 6573 2929 0a20  idden_states)). 
+00002b20: 2020 2020 2020 2020 2020 2076 616c 7565             value
+00002b30: 5f6c 6179 6572 203d 2073 656c 662e 7377  _layer = self.sw
+00002b40: 6170 6178 6573 5f66 6f72 5f73 636f 7265  apaxes_for_score
+00002b50: 7328 7365 6c66 2e76 616c 7565 2865 6e63  s(self.value(enc
+00002b60: 6f64 6572 5f68 6964 6465 6e5f 7374 6174  oder_hidden_stat
+00002b70: 6573 2929 0a20 2020 2020 2020 2020 2020  es)).           
+00002b80: 2061 7474 656e 7469 6f6e 5f6d 6173 6b20   attention_mask 
+00002b90: 3d20 656e 636f 6465 725f 6174 7465 6e74  = encoder_attent
+00002ba0: 696f 6e5f 6d61 736b 0a20 2020 2020 2020  ion_mask.       
+00002bb0: 2065 6c69 6620 7061 7374 5f6b 6579 5f76   elif past_key_v
+00002bc0: 616c 7565 2069 7320 6e6f 7420 4e6f 6e65  alue is not None
+00002bd0: 3a0a 2020 2020 2020 2020 2020 2020 6b65  :.            ke
+00002be0: 795f 6c61 7965 7220 3d20 7365 6c66 2e73  y_layer = self.s
+00002bf0: 7761 7061 7865 735f 666f 725f 7363 6f72  wapaxes_for_scor
+00002c00: 6573 2873 656c 662e 6b65 7928 6869 6464  es(self.key(hidd
+00002c10: 656e 5f73 7461 7465 7329 290a 2020 2020  en_states)).    
+00002c20: 2020 2020 2020 2020 7661 6c75 655f 6c61          value_la
+00002c30: 7965 7220 3d20 7365 6c66 2e73 7761 7061  yer = self.swapa
+00002c40: 7865 735f 666f 725f 7363 6f72 6573 2873  xes_for_scores(s
+00002c50: 656c 662e 7661 6c75 6528 6869 6464 656e  elf.value(hidden
+00002c60: 5f73 7461 7465 7329 290a 2020 2020 2020  _states)).      
+00002c70: 2020 2020 2020 6b65 795f 6c61 7965 7220        key_layer 
+00002c80: 3d20 6f70 732e 6361 7428 5b70 6173 745f  = ops.cat([past_
+00002c90: 6b65 795f 7661 6c75 655b 305d 2c20 6b65  key_value[0], ke
+00002ca0: 795f 6c61 7965 725d 2c20 6178 6973 3d32  y_layer], axis=2
+00002cb0: 290a 2020 2020 2020 2020 2020 2020 7661  ).            va
+00002cc0: 6c75 655f 6c61 7965 7220 3d20 6f70 732e  lue_layer = ops.
+00002cd0: 6361 7428 5b70 6173 745f 6b65 795f 7661  cat([past_key_va
+00002ce0: 6c75 655b 315d 2c20 7661 6c75 655f 6c61  lue[1], value_la
+00002cf0: 7965 725d 2c20 6178 6973 3d32 290a 2020  yer], axis=2).  
+00002d00: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00002d10: 2020 2020 2020 2020 6b65 795f 6c61 7965          key_laye
+00002d20: 7220 3d20 7365 6c66 2e73 7761 7061 7865  r = self.swapaxe
+00002d30: 735f 666f 725f 7363 6f72 6573 2873 656c  s_for_scores(sel
+00002d40: 662e 6b65 7928 6869 6464 656e 5f73 7461  f.key(hidden_sta
+00002d50: 7465 7329 290a 2020 2020 2020 2020 2020  tes)).          
+00002d60: 2020 7661 6c75 655f 6c61 7965 7220 3d20    value_layer = 
+00002d70: 7365 6c66 2e73 7761 7061 7865 735f 666f  self.swapaxes_fo
+00002d80: 725f 7363 6f72 6573 2873 656c 662e 7661  r_scores(self.va
+00002d90: 6c75 6528 6869 6464 656e 5f73 7461 7465  lue(hidden_state
+00002da0: 7329 290a 0a20 2020 2020 2020 2071 7565  s))..        que
+00002db0: 7279 5f6c 6179 6572 203d 2073 656c 662e  ry_layer = self.
+00002dc0: 7377 6170 6178 6573 5f66 6f72 5f73 636f  swapaxes_for_sco
+00002dd0: 7265 7328 6d69 7865 645f 7175 6572 795f  res(mixed_query_
+00002de0: 6c61 7965 7229 0a0a 2020 2020 2020 2020  layer)..        
+00002df0: 6966 2073 656c 662e 6973 5f64 6563 6f64  if self.is_decod
+00002e00: 6572 3a0a 2020 2020 2020 2020 2020 2020  er:.            
+00002e10: 2320 6966 2063 726f 7373 5f61 7474 656e  # if cross_atten
+00002e20: 7469 6f6e 2073 6176 6520 5475 706c 6528  tion save Tuple(
+00002e30: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+00002e40: 2c20 6d69 6e64 7370 6f72 652e 5465 6e73  , mindspore.Tens
+00002e50: 6f72 2920 6f66 2061 6c6c 2063 726f 7373  or) of all cross
+00002e60: 2061 7474 656e 7469 6f6e 206b 6579 2f76   attention key/v
+00002e70: 616c 7565 5f73 7461 7465 732e 0a20 2020  alue_states..   
+00002e80: 2020 2020 2020 2020 2023 2046 7572 7468           # Furth
+00002e90: 6572 2063 616c 6c73 2074 6f20 6372 6f73  er calls to cros
+00002ea0: 735f 6174 7465 6e74 696f 6e20 6c61 7965  s_attention laye
+00002eb0: 7220 6361 6e20 7468 656e 2072 6575 7365  r can then reuse
+00002ec0: 2061 6c6c 2063 726f 7373 2d61 7474 656e   all cross-atten
+00002ed0: 7469 6f6e 0a20 2020 2020 2020 2020 2020  tion.           
+00002ee0: 2023 206b 6579 2f76 616c 7565 5f73 7461   # key/value_sta
+00002ef0: 7465 7320 2866 6972 7374 2022 6966 2220  tes (first "if" 
+00002f00: 6361 7365 290a 2020 2020 2020 2020 2020  case).          
+00002f10: 2020 2320 6966 2075 6e69 2d64 6972 6563    # if uni-direc
+00002f20: 7469 6f6e 616c 2073 656c 662d 6174 7465  tional self-atte
+00002f30: 6e74 696f 6e20 2864 6563 6f64 6572 2920  ntion (decoder) 
+00002f40: 7361 7665 2054 7570 6c65 286d 696e 6473  save Tuple(minds
+00002f50: 706f 7265 2e54 656e 736f 722c 206d 696e  pore.Tensor, min
+00002f60: 6473 706f 7265 2e54 656e 736f 7229 206f  dspore.Tensor) o
+00002f70: 660a 2020 2020 2020 2020 2020 2020 2320  f.            # 
+00002f80: 616c 6c20 7072 6576 696f 7573 2064 6563  all previous dec
+00002f90: 6f64 6572 206b 6579 2f76 616c 7565 5f73  oder key/value_s
+00002fa0: 7461 7465 732e 2046 7572 7468 6572 2063  tates. Further c
+00002fb0: 616c 6c73 2074 6f20 756e 692d 6469 7265  alls to uni-dire
+00002fc0: 6374 696f 6e61 6c20 7365 6c66 2d61 7474  ctional self-att
+00002fd0: 656e 7469 6f6e 0a20 2020 2020 2020 2020  ention.         
+00002fe0: 2020 2023 2063 616e 2063 6f6e 6361 7420     # can concat 
+00002ff0: 7072 6576 696f 7573 2064 6563 6f64 6572  previous decoder
+00003000: 206b 6579 2f76 616c 7565 5f73 7461 7465   key/value_state
+00003010: 7320 746f 2063 7572 7265 6e74 2070 726f  s to current pro
+00003020: 6a65 6374 6564 206b 6579 2f76 616c 7565  jected key/value
+00003030: 5f73 7461 7465 7320 2874 6869 7264 2022  _states (third "
+00003040: 656c 6966 2220 6361 7365 290a 2020 2020  elif" case).    
+00003050: 2020 2020 2020 2020 2320 6966 2065 6e63          # if enc
+00003060: 6f64 6572 2062 692d 6469 7265 6374 696f  oder bi-directio
+00003070: 6e61 6c20 7365 6c66 2d61 7474 656e 7469  nal self-attenti
+00003080: 6f6e 2060 7061 7374 5f6b 6579 5f76 616c  on `past_key_val
+00003090: 7565 6020 6973 2061 6c77 6179 7320 604e  ue` is always `N
+000030a0: 6f6e 6560 0a20 2020 2020 2020 2020 2020  one`.           
+000030b0: 2070 6173 745f 6b65 795f 7661 6c75 6520   past_key_value 
+000030c0: 3d20 286b 6579 5f6c 6179 6572 2c20 7661  = (key_layer, va
+000030d0: 6c75 655f 6c61 7965 7229 0a0a 2020 2020  lue_layer)..    
+000030e0: 2020 2020 2320 5461 6b65 2074 6865 2064      # Take the d
+000030f0: 6f74 2070 726f 6475 6374 2062 6574 7765  ot product betwe
+00003100: 656e 2022 7175 6572 7922 2061 6e64 2022  en "query" and "
+00003110: 6b65 7922 2074 6f20 6765 7420 7468 6520  key" to get the 
+00003120: 7261 7720 6174 7465 6e74 696f 6e20 7363  raw attention sc
+00003130: 6f72 6573 2e0a 2020 2020 2020 2020 6174  ores..        at
+00003140: 7465 6e74 696f 6e5f 7363 6f72 6573 203d  tention_scores =
+00003150: 206f 7073 2e6d 6174 6d75 6c28 7175 6572   ops.matmul(quer
+00003160: 795f 6c61 7965 722c 206b 6579 5f6c 6179  y_layer, key_lay
+00003170: 6572 2e73 7761 7061 7865 7328 2d31 2c20  er.swapaxes(-1, 
+00003180: 2d32 2929 0a0a 2020 2020 2020 2020 6966  -2))..        if
+00003190: 2073 656c 662e 706f 7369 7469 6f6e 5f65   self.position_e
+000031a0: 6d62 6564 6469 6e67 5f74 7970 6520 696e  mbedding_type in
+000031b0: 2028 2772 656c 6174 6976 655f 6b65 7927   ('relative_key'
+000031c0: 2c20 2772 656c 6174 6976 655f 6b65 795f  , 'relative_key_
+000031d0: 7175 6572 7927 293a 0a20 2020 2020 2020  query'):.       
+000031e0: 2020 2020 2073 6571 5f6c 656e 6774 6820       seq_length 
+000031f0: 3d20 6869 6464 656e 5f73 7461 7465 732e  = hidden_states.
+00003200: 7368 6170 655b 315d 0a20 2020 2020 2020  shape[1].       
+00003210: 2020 2020 2070 6f73 6974 696f 6e5f 6964       position_id
+00003220: 735f 6c20 3d20 6f70 732e 6172 616e 6765  s_l = ops.arange
+00003230: 2873 6571 5f6c 656e 6774 682c 2064 7479  (seq_length, dty
+00003240: 7065 3d6d 696e 6473 706f 7265 2e69 6e74  pe=mindspore.int
+00003250: 3634 292e 7669 6577 282d 312c 2031 290a  64).view(-1, 1).
+00003260: 2020 2020 2020 2020 2020 2020 706f 7369              posi
+00003270: 7469 6f6e 5f69 6473 5f72 203d 206f 7073  tion_ids_r = ops
+00003280: 2e61 7261 6e67 6528 7365 715f 6c65 6e67  .arange(seq_leng
+00003290: 7468 2c20 6474 7970 653d 6d69 6e64 7370  th, dtype=mindsp
+000032a0: 6f72 652e 696e 7436 3429 2e76 6965 7728  ore.int64).view(
+000032b0: 312c 202d 3129 0a20 2020 2020 2020 2020  1, -1).         
+000032c0: 2020 2064 6973 7461 6e63 6520 3d20 706f     distance = po
+000032d0: 7369 7469 6f6e 5f69 6473 5f6c 202d 2070  sition_ids_l - p
+000032e0: 6f73 6974 696f 6e5f 6964 735f 720a 2020  osition_ids_r.  
+000032f0: 2020 2020 2020 2020 2020 706f 7369 7469            positi
+00003300: 6f6e 616c 5f65 6d62 6564 6469 6e67 203d  onal_embedding =
+00003310: 2073 656c 662e 6469 7374 616e 6365 5f65   self.distance_e
+00003320: 6d62 6564 6469 6e67 2864 6973 7461 6e63  mbedding(distanc
+00003330: 6520 2b20 7365 6c66 2e6d 6178 5f70 6f73  e + self.max_pos
+00003340: 6974 696f 6e5f 656d 6265 6464 696e 6773  ition_embeddings
+00003350: 202d 2031 290a 2020 2020 2020 2020 2020   - 1).          
+00003360: 2020 706f 7369 7469 6f6e 616c 5f65 6d62    positional_emb
+00003370: 6564 6469 6e67 203d 2070 6f73 6974 696f  edding = positio
+00003380: 6e61 6c5f 656d 6265 6464 696e 672e 746f  nal_embedding.to
+00003390: 2864 7479 7065 3d71 7565 7279 5f6c 6179  (dtype=query_lay
+000033a0: 6572 2e64 7479 7065 2920 2023 2066 7031  er.dtype)  # fp1
+000033b0: 3620 636f 6d70 6174 6962 696c 6974 790a  6 compatibility.
+000033c0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000033d0: 7365 6c66 2e70 6f73 6974 696f 6e5f 656d  self.position_em
+000033e0: 6265 6464 696e 675f 7479 7065 203d 3d20  bedding_type == 
+000033f0: 2272 656c 6174 6976 655f 6b65 7922 3a0a  "relative_key":.
+00003400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003410: 7265 6c61 7469 7665 5f70 6f73 6974 696f  relative_positio
+00003420: 6e5f 7363 6f72 6573 203d 206f 7073 2e65  n_scores = ops.e
+00003430: 696e 7375 6d28 2262 686c 642c 6c72 642d  insum("bhld,lrd-
+00003440: 3e62 686c 7222 2c20 7175 6572 795f 6c61  >bhlr", query_la
+00003450: 7965 722c 2070 6f73 6974 696f 6e61 6c5f  yer, positional_
+00003460: 656d 6265 6464 696e 6729 0a20 2020 2020  embedding).     
+00003470: 2020 2020 2020 2020 2020 2061 7474 656e             atten
+00003480: 7469 6f6e 5f73 636f 7265 7320 3d20 6174  tion_scores = at
+00003490: 7465 6e74 696f 6e5f 7363 6f72 6573 202b  tention_scores +
+000034a0: 2072 656c 6174 6976 655f 706f 7369 7469   relative_positi
+000034b0: 6f6e 5f73 636f 7265 730a 2020 2020 2020  on_scores.      
+000034c0: 2020 2020 2020 656c 6966 2073 656c 662e        elif self.
+000034d0: 706f 7369 7469 6f6e 5f65 6d62 6564 6469  position_embeddi
+000034e0: 6e67 5f74 7970 6520 3d3d 2022 7265 6c61  ng_type == "rela
+000034f0: 7469 7665 5f6b 6579 5f71 7565 7279 223a  tive_key_query":
+00003500: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003510: 2072 656c 6174 6976 655f 706f 7369 7469   relative_positi
+00003520: 6f6e 5f73 636f 7265 735f 7175 6572 7920  on_scores_query 
+00003530: 3d20 6f70 732e 6569 6e73 756d 2822 6268  = ops.einsum("bh
+00003540: 6c64 2c6c 7264 2d3e 6268 6c72 222c 2071  ld,lrd->bhlr", q
+00003550: 7565 7279 5f6c 6179 6572 2c20 706f 7369  uery_layer, posi
+00003560: 7469 6f6e 616c 5f65 6d62 6564 6469 6e67  tional_embedding
+00003570: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00003580: 2020 7265 6c61 7469 7665 5f70 6f73 6974    relative_posit
+00003590: 696f 6e5f 7363 6f72 6573 5f6b 6579 203d  ion_scores_key =
+000035a0: 206f 7073 2e65 696e 7375 6d28 2262 6872   ops.einsum("bhr
+000035b0: 642c 6c72 642d 3e62 686c 7222 2c20 6b65  d,lrd->bhlr", ke
+000035c0: 795f 6c61 7965 722c 2070 6f73 6974 696f  y_layer, positio
+000035d0: 6e61 6c5f 656d 6265 6464 696e 6729 0a0a  nal_embedding)..
+000035e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000035f0: 6174 7465 6e74 696f 6e5f 7363 6f72 6573  attention_scores
+00003600: 203d 2061 7474 656e 7469 6f6e 5f73 636f   = attention_sco
+00003610: 7265 7320 2b20 7265 6c61 7469 7665 5f70  res + relative_p
+00003620: 6f73 6974 696f 6e5f 7363 6f72 6573 5f71  osition_scores_q
+00003630: 7565 7279 202b 2072 656c 6174 6976 655f  uery + relative_
+00003640: 706f 7369 7469 6f6e 5f73 636f 7265 735f  position_scores_
+00003650: 6b65 790a 0a20 2020 2020 2020 2023 2062  key..        # b
+00003660: 626f 7820 706f 7369 7469 6f6e 616c 2065  box positional e
+00003670: 6e63 6f64 696e 670a 2020 2020 2020 2020  ncoding.        
+00003680: 6261 7463 685f 7369 7a65 2c20 6e5f 6865  batch_size, n_he
+00003690: 6164 2c20 7365 715f 6c65 6e67 7468 2c20  ad, seq_length, 
+000036a0: 645f 6865 6164 203d 2071 7565 7279 5f6c  d_head = query_l
+000036b0: 6179 6572 2e73 6861 7065 0a20 2020 2020  ayer.shape.     
+000036c0: 2020 2062 626f 785f 706f 735f 656d 6220     bbox_pos_emb 
+000036d0: 3d20 6262 6f78 5f70 6f73 5f65 6d62 2e76  = bbox_pos_emb.v
+000036e0: 6965 7728 7365 715f 6c65 6e67 7468 2c20  iew(seq_length, 
+000036f0: 7365 715f 6c65 6e67 7468 2c20 6261 7463  seq_length, batc
+00003700: 685f 7369 7a65 2c20 645f 6865 6164 290a  h_size, d_head).
+00003710: 2020 2020 2020 2020 6262 6f78 5f70 6f73          bbox_pos
+00003720: 5f65 6d62 203d 2062 626f 785f 706f 735f  _emb = bbox_pos_
+00003730: 656d 622e 7065 726d 7574 6528 5b32 2c20  emb.permute([2, 
+00003740: 302c 2031 2c20 335d 290a 2020 2020 2020  0, 1, 3]).      
+00003750: 2020 6262 6f78 5f70 6f73 5f73 636f 7265    bbox_pos_score
+00003760: 7320 3d20 6f70 732e 6569 6e73 756d 2822  s = ops.einsum("
+00003770: 626e 6964 2c62 696a 642d 3e62 6e69 6a22  bnid,bijd->bnij"
+00003780: 2c20 2871 7565 7279 5f6c 6179 6572 2c20  , (query_layer, 
+00003790: 6262 6f78 5f70 6f73 5f65 6d62 2929 0a0a  bbox_pos_emb))..
+000037a0: 2020 2020 2020 2020 6174 7465 6e74 696f          attentio
+000037b0: 6e5f 7363 6f72 6573 203d 2061 7474 656e  n_scores = atten
+000037c0: 7469 6f6e 5f73 636f 7265 7320 2b20 6262  tion_scores + bb
+000037d0: 6f78 5f70 6f73 5f73 636f 7265 730a 0a20  ox_pos_scores.. 
+000037e0: 2020 2020 2020 2061 7474 656e 7469 6f6e         attention
+000037f0: 5f73 636f 7265 7320 3d20 6174 7465 6e74  _scores = attent
+00003800: 696f 6e5f 7363 6f72 6573 202f 206d 6174  ion_scores / mat
+00003810: 682e 7371 7274 2873 656c 662e 6174 7465  h.sqrt(self.atte
+00003820: 6e74 696f 6e5f 6865 6164 5f73 697a 6529  ntion_head_size)
+00003830: 0a20 2020 2020 2020 2069 6620 6174 7465  .        if atte
+00003840: 6e74 696f 6e5f 6d61 736b 2069 7320 6e6f  ntion_mask is no
+00003850: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00003860: 2020 2020 2320 4170 706c 7920 7468 6520      # Apply the 
+00003870: 6174 7465 6e74 696f 6e20 6d61 736b 2069  attention mask i
+00003880: 7320 2870 7265 636f 6d70 7574 6564 2066  s (precomputed f
+00003890: 6f72 2061 6c6c 206c 6179 6572 7320 696e  or all layers in
+000038a0: 2042 726f 734d 6f64 656c 2066 6f72 7761   BrosModel forwa
+000038b0: 7264 2829 2066 756e 6374 696f 6e29 0a20  rd() function). 
+000038c0: 2020 2020 2020 2020 2020 2061 7474 656e             atten
+000038d0: 7469 6f6e 5f73 636f 7265 7320 3d20 6174  tion_scores = at
+000038e0: 7465 6e74 696f 6e5f 7363 6f72 6573 202b  tention_scores +
+000038f0: 2061 7474 656e 7469 6f6e 5f6d 6173 6b0a   attention_mask.
+00003900: 0a20 2020 2020 2020 2023 204e 6f72 6d61  .        # Norma
+00003910: 6c69 7a65 2074 6865 2061 7474 656e 7469  lize the attenti
+00003920: 6f6e 2073 636f 7265 7320 746f 2070 726f  on scores to pro
+00003930: 6261 6269 6c69 7469 6573 2e0a 2020 2020  babilities..    
+00003940: 2020 2020 6174 7465 6e74 696f 6e5f 7072      attention_pr
+00003950: 6f62 7320 3d20 6f70 732e 736f 6674 6d61  obs = ops.softma
+00003960: 7828 6174 7465 6e74 696f 6e5f 7363 6f72  x(attention_scor
+00003970: 6573 2c20 6178 6973 3d2d 3129 0a0a 2020  es, axis=-1)..  
+00003980: 2020 2020 2020 2320 5468 6973 2069 7320        # This is 
+00003990: 6163 7475 616c 6c79 2064 726f 7070 696e  actually droppin
+000039a0: 6720 6f75 7420 656e 7469 7265 2074 6f6b  g out entire tok
+000039b0: 656e 7320 746f 2061 7474 656e 6420 746f  ens to attend to
+000039c0: 2c20 7768 6963 6820 6d69 6768 740a 2020  , which might.  
+000039d0: 2020 2020 2020 2320 7365 656d 2061 2062        # seem a b
+000039e0: 6974 2075 6e75 7375 616c 2c20 6275 7420  it unusual, but 
+000039f0: 6973 2074 616b 656e 2066 726f 6d20 7468  is taken from th
+00003a00: 6520 6f72 6967 696e 616c 2054 7261 6e73  e original Trans
+00003a10: 666f 726d 6572 2070 6170 6572 2e0a 2020  former paper..  
+00003a20: 2020 2020 2020 6174 7465 6e74 696f 6e5f        attention_
+00003a30: 7072 6f62 7320 3d20 7365 6c66 2e64 726f  probs = self.dro
+00003a40: 706f 7574 2861 7474 656e 7469 6f6e 5f70  pout(attention_p
+00003a50: 726f 6273 290a 0a20 2020 2020 2020 2023  robs)..        #
+00003a60: 204d 6173 6b20 6865 6164 7320 6966 2077   Mask heads if w
+00003a70: 6520 7761 6e74 2074 6f0a 2020 2020 2020  e want to.      
+00003a80: 2020 6966 2068 6561 645f 6d61 736b 2069    if head_mask i
+00003a90: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00003aa0: 2020 2020 2020 2020 6174 7465 6e74 696f          attentio
+00003ab0: 6e5f 7072 6f62 7320 3d20 6174 7465 6e74  n_probs = attent
+00003ac0: 696f 6e5f 7072 6f62 7320 2a20 6865 6164  ion_probs * head
+00003ad0: 5f6d 6173 6b0a 0a20 2020 2020 2020 2063  _mask..        c
+00003ae0: 6f6e 7465 7874 5f6c 6179 6572 203d 206f  ontext_layer = o
+00003af0: 7073 2e6d 6174 6d75 6c28 6174 7465 6e74  ps.matmul(attent
+00003b00: 696f 6e5f 7072 6f62 732c 2076 616c 7565  ion_probs, value
+00003b10: 5f6c 6179 6572 290a 0a20 2020 2020 2020  _layer)..       
+00003b20: 2063 6f6e 7465 7874 5f6c 6179 6572 203d   context_layer =
+00003b30: 2063 6f6e 7465 7874 5f6c 6179 6572 2e70   context_layer.p
+00003b40: 6572 6d75 7465 2830 2c20 322c 2031 2c20  ermute(0, 2, 1, 
+00003b50: 3329 0a20 2020 2020 2020 206e 6577 5f63  3).        new_c
+00003b60: 6f6e 7465 7874 5f6c 6179 6572 5f73 6861  ontext_layer_sha
+00003b70: 7065 203d 2063 6f6e 7465 7874 5f6c 6179  pe = context_lay
+00003b80: 6572 2e73 6861 7065 5b3a 2d32 5d20 2b20  er.shape[:-2] + 
+00003b90: 2873 656c 662e 616c 6c5f 6865 6164 5f73  (self.all_head_s
+00003ba0: 697a 652c 290a 2020 2020 2020 2020 636f  ize,).        co
+00003bb0: 6e74 6578 745f 6c61 7965 7220 3d20 636f  ntext_layer = co
+00003bc0: 6e74 6578 745f 6c61 7965 722e 7669 6577  ntext_layer.view
+00003bd0: 282a 6e65 775f 636f 6e74 6578 745f 6c61  (*new_context_la
+00003be0: 7965 725f 7368 6170 6529 0a0a 2020 2020  yer_shape)..    
+00003bf0: 2020 2020 6f75 7470 7574 7320 3d20 2863      outputs = (c
+00003c00: 6f6e 7465 7874 5f6c 6179 6572 2c20 6174  ontext_layer, at
+00003c10: 7465 6e74 696f 6e5f 7072 6f62 7329 2069  tention_probs) i
+00003c20: 6620 6f75 7470 7574 5f61 7474 656e 7469  f output_attenti
+00003c30: 6f6e 7320 656c 7365 2028 636f 6e74 6578  ons else (contex
+00003c40: 745f 6c61 7965 722c 290a 0a20 2020 2020  t_layer,)..     
+00003c50: 2020 2069 6620 7365 6c66 2e69 735f 6465     if self.is_de
+00003c60: 636f 6465 723a 0a20 2020 2020 2020 2020  coder:.         
+00003c70: 2020 206f 7574 7075 7473 203d 206f 7574     outputs = out
+00003c80: 7075 7473 202b 2028 7061 7374 5f6b 6579  puts + (past_key
+00003c90: 5f76 616c 7565 2c29 0a20 2020 2020 2020  _value,).       
+00003ca0: 2072 6574 7572 6e20 6f75 7470 7574 730a   return outputs.
+00003cb0: 0a0a 2320 436f 7069 6564 2066 726f 6d20  ..# Copied from 
+00003cc0: 7472 616e 7366 6f72 6d65 7273 2e6d 6f64  transformers.mod
+00003cd0: 656c 732e 6265 7274 2e6d 6f64 656c 696e  els.bert.modelin
+00003ce0: 675f 6265 7274 2e42 6572 7453 656c 664f  g_bert.BertSelfO
+00003cf0: 7574 7075 7420 7769 7468 2042 6572 742d  utput with Bert-
+00003d00: 3e42 726f 730a 636c 6173 7320 4272 6f73  >Bros.class Bros
+00003d10: 5365 6c66 4f75 7470 7574 286e 6e2e 4365  SelfOutput(nn.Ce
+00003d20: 6c6c 293a 0a20 2020 2064 6566 205f 5f69  ll):.    def __i
+00003d30: 6e69 745f 5f28 7365 6c66 2c20 636f 6e66  nit__(self, conf
+00003d40: 6967 293a 0a20 2020 2020 2020 2073 7570  ig):.        sup
+00003d50: 6572 2829 2e5f 5f69 6e69 745f 5f28 290a  er().__init__().
+00003d60: 2020 2020 2020 2020 7365 6c66 2e64 656e          self.den
+00003d70: 7365 203d 206e 6e2e 4465 6e73 6528 636f  se = nn.Dense(co
+00003d80: 6e66 6967 2e68 6964 6465 6e5f 7369 7a65  nfig.hidden_size
+00003d90: 2c20 636f 6e66 6967 2e68 6964 6465 6e5f  , config.hidden_
+00003da0: 7369 7a65 290a 2020 2020 2020 2020 7365  size).        se
+00003db0: 6c66 2e4c 6179 6572 4e6f 726d 203d 206e  lf.LayerNorm = n
+00003dc0: 6e2e 4c61 7965 724e 6f72 6d28 636f 6e66  n.LayerNorm(conf
+00003dd0: 6967 2e68 6964 6465 6e5f 7369 7a65 2c20  ig.hidden_size, 
+00003de0: 6570 7369 6c6f 6e3d 636f 6e66 6967 2e6c  epsilon=config.l
+00003df0: 6179 6572 5f6e 6f72 6d5f 6570 7329 0a20  ayer_norm_eps). 
+00003e00: 2020 2020 2020 2073 656c 662e 6472 6f70         self.drop
+00003e10: 6f75 7420 3d20 6e6e 2e44 726f 706f 7574  out = nn.Dropout
+00003e20: 2870 3d63 6f6e 6669 672e 6869 6464 656e  (p=config.hidden
+00003e30: 5f64 726f 706f 7574 5f70 726f 6229 0a0a  _dropout_prob)..
+00003e40: 2020 2020 6465 6620 636f 6e73 7472 7563      def construc
+00003e50: 7428 7365 6c66 2c20 6869 6464 656e 5f73  t(self, hidden_s
+00003e60: 7461 7465 733a 206d 696e 6473 706f 7265  tates: mindspore
+00003e70: 2e54 656e 736f 722c 2069 6e70 7574 5f74  .Tensor, input_t
+00003e80: 656e 736f 723a 206d 696e 6473 706f 7265  ensor: mindspore
+00003e90: 2e54 656e 736f 7229 202d 3e20 6d69 6e64  .Tensor) -> mind
+00003ea0: 7370 6f72 652e 5465 6e73 6f72 3a0a 2020  spore.Tensor:.  
+00003eb0: 2020 2020 2020 6869 6464 656e 5f73 7461        hidden_sta
+00003ec0: 7465 7320 3d20 7365 6c66 2e64 656e 7365  tes = self.dense
+00003ed0: 2868 6964 6465 6e5f 7374 6174 6573 290a  (hidden_states).
+00003ee0: 2020 2020 2020 2020 6869 6464 656e 5f73          hidden_s
+00003ef0: 7461 7465 7320 3d20 7365 6c66 2e64 726f  tates = self.dro
+00003f00: 706f 7574 2868 6964 6465 6e5f 7374 6174  pout(hidden_stat
+00003f10: 6573 290a 2020 2020 2020 2020 6869 6464  es).        hidd
+00003f20: 656e 5f73 7461 7465 7320 3d20 7365 6c66  en_states = self
+00003f30: 2e4c 6179 6572 4e6f 726d 2868 6964 6465  .LayerNorm(hidde
+00003f40: 6e5f 7374 6174 6573 202b 2069 6e70 7574  n_states + input
+00003f50: 5f74 656e 736f 7229 0a20 2020 2020 2020  _tensor).       
+00003f60: 2072 6574 7572 6e20 6869 6464 656e 5f73   return hidden_s
+00003f70: 7461 7465 730a 0a0a 636c 6173 7320 4272  tates...class Br
+00003f80: 6f73 4174 7465 6e74 696f 6e28 6e6e 2e43  osAttention(nn.C
+00003f90: 656c 6c29 3a0a 2020 2020 6465 6620 5f5f  ell):.    def __
+00003fa0: 696e 6974 5f5f 2873 656c 662c 2063 6f6e  init__(self, con
+00003fb0: 6669 6729 3a0a 2020 2020 2020 2020 7375  fig):.        su
+00003fc0: 7065 7228 292e 5f5f 696e 6974 5f5f 2829  per().__init__()
+00003fd0: 0a20 2020 2020 2020 2073 656c 662e 7365  .        self.se
+00003fe0: 6c66 203d 2042 726f 7353 656c 6641 7474  lf = BrosSelfAtt
+00003ff0: 656e 7469 6f6e 2863 6f6e 6669 6729 0a20  ention(config). 
+00004000: 2020 2020 2020 2073 656c 662e 6f75 7470         self.outp
+00004010: 7574 203d 2042 726f 7353 656c 664f 7574  ut = BrosSelfOut
+00004020: 7075 7428 636f 6e66 6967 290a 2020 2020  put(config).    
+00004030: 2020 2020 7365 6c66 2e70 7275 6e65 645f      self.pruned_
+00004040: 6865 6164 7320 3d20 7365 7428 290a 0a20  heads = set().. 
+00004050: 2020 2064 6566 2070 7275 6e65 5f68 6561     def prune_hea
+00004060: 6473 2873 656c 662c 2068 6561 6473 293a  ds(self, heads):
+00004070: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
+00004080: 6865 6164 7329 203d 3d20 303a 0a20 2020  heads) == 0:.   
+00004090: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
+000040a0: 2020 2020 2020 2020 6865 6164 732c 2069          heads, i
+000040b0: 6e64 6578 203d 2066 696e 645f 7072 756e  ndex = find_prun
+000040c0: 6561 626c 655f 6865 6164 735f 616e 645f  eable_heads_and_
+000040d0: 696e 6469 6365 7328 0a20 2020 2020 2020  indices(.       
+000040e0: 2020 2020 2068 6561 6473 2c0a 2020 2020       heads,.    
+000040f0: 2020 2020 2020 2020 7365 6c66 2e73 656c          self.sel
+00004100: 662e 6e75 6d5f 6174 7465 6e74 696f 6e5f  f.num_attention_
+00004110: 6865 6164 732c 0a20 2020 2020 2020 2020  heads,.         
+00004120: 2020 2073 656c 662e 7365 6c66 2e61 7474     self.self.att
+00004130: 656e 7469 6f6e 5f68 6561 645f 7369 7a65  ention_head_size
+00004140: 2c0a 2020 2020 2020 2020 2020 2020 7365  ,.            se
+00004150: 6c66 2e70 7275 6e65 645f 6865 6164 732c  lf.pruned_heads,
+00004160: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00004170: 2020 2020 2320 5072 756e 6520 6c69 6e65      # Prune line
+00004180: 6172 206c 6179 6572 730a 2020 2020 2020  ar layers.      
+00004190: 2020 7365 6c66 2e73 656c 662e 7175 6572    self.self.quer
+000041a0: 7920 3d20 7072 756e 655f 6c69 6e65 6172  y = prune_linear
+000041b0: 5f6c 6179 6572 2873 656c 662e 7365 6c66  _layer(self.self
+000041c0: 2e71 7565 7279 2c20 696e 6465 7829 0a20  .query, index). 
+000041d0: 2020 2020 2020 2073 656c 662e 7365 6c66         self.self
+000041e0: 2e6b 6579 203d 2070 7275 6e65 5f6c 696e  .key = prune_lin
+000041f0: 6561 725f 6c61 7965 7228 7365 6c66 2e73  ear_layer(self.s
+00004200: 656c 662e 6b65 792c 2069 6e64 6578 290a  elf.key, index).
+00004210: 2020 2020 2020 2020 7365 6c66 2e73 656c          self.sel
+00004220: 662e 7661 6c75 6520 3d20 7072 756e 655f  f.value = prune_
+00004230: 6c69 6e65 6172 5f6c 6179 6572 2873 656c  linear_layer(sel
+00004240: 662e 7365 6c66 2e76 616c 7565 2c20 696e  f.self.value, in
+00004250: 6465 7829 0a20 2020 2020 2020 2073 656c  dex).        sel
+00004260: 662e 6f75 7470 7574 2e64 656e 7365 203d  f.output.dense =
+00004270: 2070 7275 6e65 5f6c 696e 6561 725f 6c61   prune_linear_la
+00004280: 7965 7228 7365 6c66 2e6f 7574 7075 742e  yer(self.output.
+00004290: 6465 6e73 652c 2069 6e64 6578 2c20 6178  dense, index, ax
+000042a0: 6973 3d31 290a 0a20 2020 2020 2020 2023  is=1)..        #
+000042b0: 2055 7064 6174 6520 6879 7065 7220 7061   Update hyper pa
+000042c0: 7261 6d73 2061 6e64 2073 746f 7265 2070  rams and store p
+000042d0: 7275 6e65 6420 6865 6164 730a 2020 2020  runed heads.    
+000042e0: 2020 2020 7365 6c66 2e73 656c 662e 6e75      self.self.nu
+000042f0: 6d5f 6174 7465 6e74 696f 6e5f 6865 6164  m_attention_head
+00004300: 7320 3d20 7365 6c66 2e73 656c 662e 6e75  s = self.self.nu
+00004310: 6d5f 6174 7465 6e74 696f 6e5f 6865 6164  m_attention_head
+00004320: 7320 2d20 6c65 6e28 6865 6164 7329 0a20  s - len(heads). 
+00004330: 2020 2020 2020 2073 656c 662e 7365 6c66         self.self
+00004340: 2e61 6c6c 5f68 6561 645f 7369 7a65 203d  .all_head_size =
+00004350: 2073 656c 662e 7365 6c66 2e61 7474 656e   self.self.atten
+00004360: 7469 6f6e 5f68 6561 645f 7369 7a65 202a  tion_head_size *
+00004370: 2073 656c 662e 7365 6c66 2e6e 756d 5f61   self.self.num_a
+00004380: 7474 656e 7469 6f6e 5f68 6561 6473 0a20  ttention_heads. 
+00004390: 2020 2020 2020 2073 656c 662e 7072 756e         self.prun
+000043a0: 6564 5f68 6561 6473 203d 2073 656c 662e  ed_heads = self.
+000043b0: 7072 756e 6564 5f68 6561 6473 2e75 6e69  pruned_heads.uni
+000043c0: 6f6e 2868 6561 6473 290a 0a20 2020 2064  on(heads)..    d
+000043d0: 6566 2063 6f6e 7374 7275 6374 280a 2020  ef construct(.  
+000043e0: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+000043f0: 2020 2020 6869 6464 656e 5f73 7461 7465      hidden_state
+00004400: 733a 206d 696e 6473 706f 7265 2e54 656e  s: mindspore.Ten
+00004410: 736f 722c 0a20 2020 2020 2020 2062 626f  sor,.        bbo
+00004420: 785f 706f 735f 656d 623a 206d 696e 6473  x_pos_emb: minds
+00004430: 706f 7265 2e54 656e 736f 722c 0a20 2020  pore.Tensor,.   
+00004440: 2020 2020 2061 7474 656e 7469 6f6e 5f6d       attention_m
+00004450: 6173 6b3a 204f 7074 696f 6e61 6c5b 6d69  ask: Optional[mi
+00004460: 6e64 7370 6f72 652e 5465 6e73 6f72 5d20  ndspore.Tensor] 
+00004470: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00004480: 6865 6164 5f6d 6173 6b3a 204f 7074 696f  head_mask: Optio
+00004490: 6e61 6c5b 6d69 6e64 7370 6f72 652e 5465  nal[mindspore.Te
+000044a0: 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a 2020  nsor] = None,.  
+000044b0: 2020 2020 2020 656e 636f 6465 725f 6869        encoder_hi
+000044c0: 6464 656e 5f73 7461 7465 733a 204f 7074  dden_states: Opt
+000044d0: 696f 6e61 6c5b 6d69 6e64 7370 6f72 652e  ional[mindspore.
+000044e0: 5465 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a  Tensor] = None,.
+000044f0: 2020 2020 2020 2020 656e 636f 6465 725f          encoder_
+00004500: 6174 7465 6e74 696f 6e5f 6d61 736b 3a20  attention_mask: 
+00004510: 4f70 7469 6f6e 616c 5b6d 696e 6473 706f  Optional[mindspo
+00004520: 7265 2e54 656e 736f 725d 203d 204e 6f6e  re.Tensor] = Non
+00004530: 652c 0a20 2020 2020 2020 2070 6173 745f  e,.        past_
+00004540: 6b65 795f 7661 6c75 653a 204f 7074 696f  key_value: Optio
+00004550: 6e61 6c5b 5475 706c 655b 5475 706c 655b  nal[Tuple[Tuple[
+00004560: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+00004570: 5d5d 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ]]] = None,.    
+00004580: 2020 2020 6f75 7470 7574 5f61 7474 656e      output_atten
+00004590: 7469 6f6e 733a 204f 7074 696f 6e61 6c5b  tions: Optional[
+000045a0: 626f 6f6c 5d20 3d20 4661 6c73 652c 0a20  bool] = False,. 
+000045b0: 2020 2029 202d 3e20 5475 706c 655b 6d69     ) -> Tuple[mi
+000045c0: 6e64 7370 6f72 652e 5465 6e73 6f72 5d3a  ndspore.Tensor]:
+000045d0: 0a20 2020 2020 2020 2073 656c 665f 6f75  .        self_ou
+000045e0: 7470 7574 7320 3d20 7365 6c66 2e73 656c  tputs = self.sel
+000045f0: 6628 0a20 2020 2020 2020 2020 2020 2068  f(.            h
+00004600: 6964 6465 6e5f 7374 6174 6573 3d68 6964  idden_states=hid
+00004610: 6465 6e5f 7374 6174 6573 2c0a 2020 2020  den_states,.    
+00004620: 2020 2020 2020 2020 6262 6f78 5f70 6f73          bbox_pos
+00004630: 5f65 6d62 3d62 626f 785f 706f 735f 656d  _emb=bbox_pos_em
+00004640: 622c 0a20 2020 2020 2020 2020 2020 2061  b,.            a
+00004650: 7474 656e 7469 6f6e 5f6d 6173 6b3d 6174  ttention_mask=at
+00004660: 7465 6e74 696f 6e5f 6d61 736b 2c0a 2020  tention_mask,.  
+00004670: 2020 2020 2020 2020 2020 6865 6164 5f6d            head_m
+00004680: 6173 6b3d 6865 6164 5f6d 6173 6b2c 0a20  ask=head_mask,. 
+00004690: 2020 2020 2020 2020 2020 2065 6e63 6f64             encod
+000046a0: 6572 5f68 6964 6465 6e5f 7374 6174 6573  er_hidden_states
+000046b0: 3d65 6e63 6f64 6572 5f68 6964 6465 6e5f  =encoder_hidden_
+000046c0: 7374 6174 6573 2c0a 2020 2020 2020 2020  states,.        
+000046d0: 2020 2020 656e 636f 6465 725f 6174 7465      encoder_atte
+000046e0: 6e74 696f 6e5f 6d61 736b 3d65 6e63 6f64  ntion_mask=encod
+000046f0: 6572 5f61 7474 656e 7469 6f6e 5f6d 6173  er_attention_mas
+00004700: 6b2c 0a20 2020 2020 2020 2020 2020 2070  k,.            p
+00004710: 6173 745f 6b65 795f 7661 6c75 653d 7061  ast_key_value=pa
+00004720: 7374 5f6b 6579 5f76 616c 7565 2c0a 2020  st_key_value,.  
+00004730: 2020 2020 2020 2020 2020 6f75 7470 7574            output
+00004740: 5f61 7474 656e 7469 6f6e 733d 6f75 7470  _attentions=outp
+00004750: 7574 5f61 7474 656e 7469 6f6e 732c 0a20  ut_attentions,. 
+00004760: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00004770: 2061 7474 656e 7469 6f6e 5f6f 7574 7075   attention_outpu
+00004780: 7420 3d20 7365 6c66 2e6f 7574 7075 7428  t = self.output(
+00004790: 7365 6c66 5f6f 7574 7075 7473 5b30 5d2c  self_outputs[0],
+000047a0: 2068 6964 6465 6e5f 7374 6174 6573 290a   hidden_states).
+000047b0: 2020 2020 2020 2020 6f75 7470 7574 7320          outputs 
+000047c0: 3d20 2861 7474 656e 7469 6f6e 5f6f 7574  = (attention_out
+000047d0: 7075 742c 2920 2b20 7365 6c66 5f6f 7574  put,) + self_out
+000047e0: 7075 7473 5b31 3a5d 2020 2320 6164 6420  puts[1:]  # add 
+000047f0: 6174 7465 6e74 696f 6e73 2069 6620 7765  attentions if we
+00004800: 206f 7574 7075 7420 7468 656d 0a20 2020   output them.   
+00004810: 2020 2020 2072 6574 7572 6e20 6f75 7470       return outp
+00004820: 7574 730a 0a0a 2320 436f 7069 6564 2066  uts...# Copied f
+00004830: 726f 6d20 7472 616e 7366 6f72 6d65 7273  rom transformers
+00004840: 2e6d 6f64 656c 732e 6265 7274 2e6d 6f64  .models.bert.mod
+00004850: 656c 696e 675f 6265 7274 2e42 6572 7449  eling_bert.BertI
+00004860: 6e74 6572 6d65 6469 6174 6520 7769 7468  ntermediate with
+00004870: 2042 6572 742d 3e42 726f 730a 636c 6173   Bert->Bros.clas
+00004880: 7320 4272 6f73 496e 7465 726d 6564 6961  s BrosIntermedia
+00004890: 7465 286e 6e2e 4365 6c6c 293a 0a20 2020  te(nn.Cell):.   
+000048a0: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
+000048b0: 6c66 2c20 636f 6e66 6967 293a 0a20 2020  lf, config):.   
+000048c0: 2020 2020 2073 7570 6572 2829 2e5f 5f69       super().__i
+000048d0: 6e69 745f 5f28 290a 2020 2020 2020 2020  nit__().        
+000048e0: 7365 6c66 2e64 656e 7365 203d 206e 6e2e  self.dense = nn.
+000048f0: 4465 6e73 6528 636f 6e66 6967 2e68 6964  Dense(config.hid
+00004900: 6465 6e5f 7369 7a65 2c20 636f 6e66 6967  den_size, config
+00004910: 2e69 6e74 6572 6d65 6469 6174 655f 7369  .intermediate_si
+00004920: 7a65 290a 2020 2020 2020 2020 6966 2069  ze).        if i
+00004930: 7369 6e73 7461 6e63 6528 636f 6e66 6967  sinstance(config
+00004940: 2e68 6964 6465 6e5f 6163 742c 2073 7472  .hidden_act, str
+00004950: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
+00004960: 656c 662e 696e 7465 726d 6564 6961 7465  elf.intermediate
+00004970: 5f61 6374 5f66 6e20 3d20 4143 5432 464e  _act_fn = ACT2FN
+00004980: 5b63 6f6e 6669 672e 6869 6464 656e 5f61  [config.hidden_a
+00004990: 6374 5d0a 2020 2020 2020 2020 656c 7365  ct].        else
+000049a0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+000049b0: 6c66 2e69 6e74 6572 6d65 6469 6174 655f  lf.intermediate_
+000049c0: 6163 745f 666e 203d 2063 6f6e 6669 672e  act_fn = config.
+000049d0: 6869 6464 656e 5f61 6374 0a0a 2020 2020  hidden_act..    
+000049e0: 6465 6620 636f 6e73 7472 7563 7428 7365  def construct(se
+000049f0: 6c66 2c20 6869 6464 656e 5f73 7461 7465  lf, hidden_state
+00004a00: 733a 206d 696e 6473 706f 7265 2e54 656e  s: mindspore.Ten
+00004a10: 736f 7229 202d 3e20 6d69 6e64 7370 6f72  sor) -> mindspor
+00004a20: 652e 5465 6e73 6f72 3a0a 2020 2020 2020  e.Tensor:.      
+00004a30: 2020 6869 6464 656e 5f73 7461 7465 7320    hidden_states 
+00004a40: 3d20 7365 6c66 2e64 656e 7365 2868 6964  = self.dense(hid
+00004a50: 6465 6e5f 7374 6174 6573 290a 2020 2020  den_states).    
+00004a60: 2020 2020 6869 6464 656e 5f73 7461 7465      hidden_state
+00004a70: 7320 3d20 7365 6c66 2e69 6e74 6572 6d65  s = self.interme
+00004a80: 6469 6174 655f 6163 745f 666e 2868 6964  diate_act_fn(hid
+00004a90: 6465 6e5f 7374 6174 6573 290a 2020 2020  den_states).    
+00004aa0: 2020 2020 7265 7475 726e 2068 6964 6465      return hidde
+00004ab0: 6e5f 7374 6174 6573 0a0a 0a63 6c61 7373  n_states...class
+00004ac0: 2042 726f 734f 7574 7075 7428 6e6e 2e43   BrosOutput(nn.C
+00004ad0: 656c 6c29 3a0a 2020 2020 6465 6620 5f5f  ell):.    def __
+00004ae0: 696e 6974 5f5f 2873 656c 662c 2063 6f6e  init__(self, con
+00004af0: 6669 6729 3a0a 2020 2020 2020 2020 7375  fig):.        su
+00004b00: 7065 7228 292e 5f5f 696e 6974 5f5f 2829  per().__init__()
+00004b10: 0a20 2020 2020 2020 2073 656c 662e 6465  .        self.de
+00004b20: 6e73 6520 3d20 6e6e 2e44 656e 7365 2863  nse = nn.Dense(c
+00004b30: 6f6e 6669 672e 696e 7465 726d 6564 6961  onfig.intermedia
+00004b40: 7465 5f73 697a 652c 2063 6f6e 6669 672e  te_size, config.
+00004b50: 6869 6464 656e 5f73 697a 6529 0a20 2020  hidden_size).   
+00004b60: 2020 2020 2073 656c 662e 4c61 7965 724e       self.LayerN
+00004b70: 6f72 6d20 3d20 6e6e 2e4c 6179 6572 4e6f  orm = nn.LayerNo
+00004b80: 726d 2863 6f6e 6669 672e 6869 6464 656e  rm(config.hidden
+00004b90: 5f73 697a 652c 2065 7073 696c 6f6e 3d63  _size, epsilon=c
+00004ba0: 6f6e 6669 672e 6c61 7965 725f 6e6f 726d  onfig.layer_norm
+00004bb0: 5f65 7073 290a 2020 2020 2020 2020 7365  _eps).        se
+00004bc0: 6c66 2e64 726f 706f 7574 203d 206e 6e2e  lf.dropout = nn.
+00004bd0: 4472 6f70 6f75 7428 703d 636f 6e66 6967  Dropout(p=config
+00004be0: 2e68 6964 6465 6e5f 6472 6f70 6f75 745f  .hidden_dropout_
+00004bf0: 7072 6f62 290a 0a20 2020 2064 6566 2063  prob)..    def c
+00004c00: 6f6e 7374 7275 6374 2873 656c 662c 2068  onstruct(self, h
+00004c10: 6964 6465 6e5f 7374 6174 6573 3a20 6d69  idden_states: mi
+00004c20: 6e64 7370 6f72 652e 5465 6e73 6f72 2c20  ndspore.Tensor, 
+00004c30: 696e 7075 745f 7465 6e73 6f72 3a20 6d69  input_tensor: mi
+00004c40: 6e64 7370 6f72 652e 5465 6e73 6f72 2920  ndspore.Tensor) 
+00004c50: 2d3e 206d 696e 6473 706f 7265 2e54 656e  -> mindspore.Ten
+00004c60: 736f 723a 0a20 2020 2020 2020 2068 6964  sor:.        hid
+00004c70: 6465 6e5f 7374 6174 6573 203d 2073 656c  den_states = sel
+00004c80: 662e 6465 6e73 6528 6869 6464 656e 5f73  f.dense(hidden_s
+00004c90: 7461 7465 7329 0a20 2020 2020 2020 2068  tates).        h
+00004ca0: 6964 6465 6e5f 7374 6174 6573 203d 2073  idden_states = s
+00004cb0: 656c 662e 6472 6f70 6f75 7428 6869 6464  elf.dropout(hidd
+00004cc0: 656e 5f73 7461 7465 7329 0a20 2020 2020  en_states).     
+00004cd0: 2020 2068 6964 6465 6e5f 7374 6174 6573     hidden_states
+00004ce0: 203d 2073 656c 662e 4c61 7965 724e 6f72   = self.LayerNor
+00004cf0: 6d28 6869 6464 656e 5f73 7461 7465 7320  m(hidden_states 
+00004d00: 2b20 696e 7075 745f 7465 6e73 6f72 290a  + input_tensor).
+00004d10: 2020 2020 2020 2020 7265 7475 726e 2068          return h
+00004d20: 6964 6465 6e5f 7374 6174 6573 0a0a 0a63  idden_states...c
+00004d30: 6c61 7373 2042 726f 734c 6179 6572 286e  lass BrosLayer(n
+00004d40: 6e2e 4365 6c6c 293a 0a20 2020 2064 6566  n.Cell):.    def
+00004d50: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
+00004d60: 636f 6e66 6967 293a 0a20 2020 2020 2020  config):.       
+00004d70: 2073 7570 6572 2829 2e5f 5f69 6e69 745f   super().__init_
+00004d80: 5f28 290a 2020 2020 2020 2020 7365 6c66  _().        self
+00004d90: 2e63 6875 6e6b 5f73 697a 655f 6665 6564  .chunk_size_feed
+00004da0: 5f66 6f72 7761 7264 203d 2063 6f6e 6669  _forward = confi
+00004db0: 672e 6368 756e 6b5f 7369 7a65 5f66 6565  g.chunk_size_fee
+00004dc0: 645f 666f 7277 6172 640a 2020 2020 2020  d_forward.      
+00004dd0: 2020 7365 6c66 2e73 6571 5f6c 656e 5f64    self.seq_len_d
+00004de0: 696d 203d 2031 0a20 2020 2020 2020 2073  im = 1.        s
+00004df0: 656c 662e 6174 7465 6e74 696f 6e20 3d20  elf.attention = 
+00004e00: 4272 6f73 4174 7465 6e74 696f 6e28 636f  BrosAttention(co
+00004e10: 6e66 6967 290a 2020 2020 2020 2020 7365  nfig).        se
+00004e20: 6c66 2e69 735f 6465 636f 6465 7220 3d20  lf.is_decoder = 
+00004e30: 636f 6e66 6967 2e69 735f 6465 636f 6465  config.is_decode
+00004e40: 720a 2020 2020 2020 2020 7365 6c66 2e61  r.        self.a
+00004e50: 6464 5f63 726f 7373 5f61 7474 656e 7469  dd_cross_attenti
+00004e60: 6f6e 203d 2063 6f6e 6669 672e 6164 645f  on = config.add_
+00004e70: 6372 6f73 735f 6174 7465 6e74 696f 6e0a  cross_attention.
+00004e80: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00004e90: 6164 645f 6372 6f73 735f 6174 7465 6e74  add_cross_attent
+00004ea0: 696f 6e3a 0a20 2020 2020 2020 2020 2020  ion:.           
+00004eb0: 2069 6620 6e6f 7420 7365 6c66 2e69 735f   if not self.is_
+00004ec0: 6465 636f 6465 723a 0a20 2020 2020 2020  decoder:.       
+00004ed0: 2020 2020 2020 2020 2072 6169 7365 2045           raise E
+00004ee0: 7863 6570 7469 6f6e 2866 227b 7365 6c66  xception(f"{self
+00004ef0: 7d20 7368 6f75 6c64 2062 6520 7573 6564  } should be used
+00004f00: 2061 7320 6120 6465 636f 6465 7220 6d6f   as a decoder mo
+00004f10: 6465 6c20 6966 2063 726f 7373 2061 7474  del if cross att
+00004f20: 656e 7469 6f6e 2069 7320 6164 6465 6422  ention is added"
+00004f30: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+00004f40: 6c66 2e63 726f 7373 6174 7465 6e74 696f  lf.crossattentio
+00004f50: 6e20 3d20 4272 6f73 4174 7465 6e74 696f  n = BrosAttentio
+00004f60: 6e28 636f 6e66 6967 290a 2020 2020 2020  n(config).      
+00004f70: 2020 7365 6c66 2e69 6e74 6572 6d65 6469    self.intermedi
+00004f80: 6174 6520 3d20 4272 6f73 496e 7465 726d  ate = BrosInterm
+00004f90: 6564 6961 7465 2863 6f6e 6669 6729 0a20  ediate(config). 
+00004fa0: 2020 2020 2020 2073 656c 662e 6f75 7470         self.outp
+00004fb0: 7574 203d 2042 726f 734f 7574 7075 7428  ut = BrosOutput(
+00004fc0: 636f 6e66 6967 290a 0a20 2020 2064 6566  config)..    def
+00004fd0: 2063 6f6e 7374 7275 6374 280a 2020 2020   construct(.    
+00004fe0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+00004ff0: 2020 6869 6464 656e 5f73 7461 7465 733a    hidden_states:
+00005000: 206d 696e 6473 706f 7265 2e54 656e 736f   mindspore.Tenso
+00005010: 722c 0a20 2020 2020 2020 2062 626f 785f  r,.        bbox_
+00005020: 706f 735f 656d 623a 206d 696e 6473 706f  pos_emb: mindspo
+00005030: 7265 2e54 656e 736f 722c 0a20 2020 2020  re.Tensor,.     
+00005040: 2020 2061 7474 656e 7469 6f6e 5f6d 6173     attention_mas
+00005050: 6b3a 204f 7074 696f 6e61 6c5b 6d69 6e64  k: Optional[mind
+00005060: 7370 6f72 652e 5465 6e73 6f72 5d20 3d20  spore.Tensor] = 
+00005070: 4e6f 6e65 2c0a 2020 2020 2020 2020 6865  None,.        he
+00005080: 6164 5f6d 6173 6b3a 204f 7074 696f 6e61  ad_mask: Optiona
+00005090: 6c5b 6d69 6e64 7370 6f72 652e 5465 6e73  l[mindspore.Tens
+000050a0: 6f72 5d20 3d20 4e6f 6e65 2c0a 2020 2020  or] = None,.    
+000050b0: 2020 2020 656e 636f 6465 725f 6869 6464      encoder_hidd
+000050c0: 656e 5f73 7461 7465 733a 204f 7074 696f  en_states: Optio
+000050d0: 6e61 6c5b 6d69 6e64 7370 6f72 652e 5465  nal[mindspore.Te
+000050e0: 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a 2020  nsor] = None,.  
+000050f0: 2020 2020 2020 656e 636f 6465 725f 6174        encoder_at
+00005100: 7465 6e74 696f 6e5f 6d61 736b 3a20 4f70  tention_mask: Op
+00005110: 7469 6f6e 616c 5b6d 696e 6473 706f 7265  tional[mindspore
+00005120: 2e54 656e 736f 725d 203d 204e 6f6e 652c  .Tensor] = None,
+00005130: 0a20 2020 2020 2020 2070 6173 745f 6b65  .        past_ke
+00005140: 795f 7661 6c75 653a 204f 7074 696f 6e61  y_value: Optiona
+00005150: 6c5b 5475 706c 655b 5475 706c 655b 6d69  l[Tuple[Tuple[mi
+00005160: 6e64 7370 6f72 652e 5465 6e73 6f72 5d5d  ndspore.Tensor]]
+00005170: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+00005180: 2020 6f75 7470 7574 5f61 7474 656e 7469    output_attenti
+00005190: 6f6e 733a 204f 7074 696f 6e61 6c5b 626f  ons: Optional[bo
+000051a0: 6f6c 5d20 3d20 4661 6c73 652c 0a20 2020  ol] = False,.   
+000051b0: 2029 202d 3e20 5475 706c 655b 6d69 6e64   ) -> Tuple[mind
+000051c0: 7370 6f72 652e 5465 6e73 6f72 5d3a 0a20  spore.Tensor]:. 
+000051d0: 2020 2020 2020 2023 2064 6563 6f64 6572         # decoder
+000051e0: 2075 6e69 2d64 6972 6563 7469 6f6e 616c   uni-directional
+000051f0: 2073 656c 662d 6174 7465 6e74 696f 6e20   self-attention 
+00005200: 6361 6368 6564 206b 6579 2f76 616c 7565  cached key/value
+00005210: 7320 7475 706c 6520 6973 2061 7420 706f  s tuple is at po
+00005220: 7369 7469 6f6e 7320 312c 320a 2020 2020  sitions 1,2.    
+00005230: 2020 2020 7365 6c66 5f61 7474 6e5f 7061      self_attn_pa
+00005240: 7374 5f6b 6579 5f76 616c 7565 203d 2070  st_key_value = p
+00005250: 6173 745f 6b65 795f 7661 6c75 655b 3a32  ast_key_value[:2
+00005260: 5d20 6966 2070 6173 745f 6b65 795f 7661  ] if past_key_va
+00005270: 6c75 6520 6973 206e 6f74 204e 6f6e 6520  lue is not None 
+00005280: 656c 7365 204e 6f6e 650a 2020 2020 2020  else None.      
+00005290: 2020 7365 6c66 5f61 7474 656e 7469 6f6e    self_attention
+000052a0: 5f6f 7574 7075 7473 203d 2073 656c 662e  _outputs = self.
+000052b0: 6174 7465 6e74 696f 6e28 0a20 2020 2020  attention(.     
+000052c0: 2020 2020 2020 2068 6964 6465 6e5f 7374         hidden_st
+000052d0: 6174 6573 2c0a 2020 2020 2020 2020 2020  ates,.          
+000052e0: 2020 6262 6f78 5f70 6f73 5f65 6d62 3d62    bbox_pos_emb=b
+000052f0: 626f 785f 706f 735f 656d 622c 0a20 2020  box_pos_emb,.   
+00005300: 2020 2020 2020 2020 2061 7474 656e 7469           attenti
+00005310: 6f6e 5f6d 6173 6b3d 6174 7465 6e74 696f  on_mask=attentio
+00005320: 6e5f 6d61 736b 2c0a 2020 2020 2020 2020  n_mask,.        
+00005330: 2020 2020 6865 6164 5f6d 6173 6b3d 6865      head_mask=he
+00005340: 6164 5f6d 6173 6b2c 0a20 2020 2020 2020  ad_mask,.       
+00005350: 2020 2020 206f 7574 7075 745f 6174 7465       output_atte
+00005360: 6e74 696f 6e73 3d6f 7574 7075 745f 6174  ntions=output_at
+00005370: 7465 6e74 696f 6e73 2c0a 2020 2020 2020  tentions,.      
+00005380: 2020 2020 2020 7061 7374 5f6b 6579 5f76        past_key_v
+00005390: 616c 7565 3d73 656c 665f 6174 746e 5f70  alue=self_attn_p
+000053a0: 6173 745f 6b65 795f 7661 6c75 652c 0a20  ast_key_value,. 
+000053b0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+000053c0: 2061 7474 656e 7469 6f6e 5f6f 7574 7075   attention_outpu
+000053d0: 7420 3d20 7365 6c66 5f61 7474 656e 7469  t = self_attenti
+000053e0: 6f6e 5f6f 7574 7075 7473 5b30 5d0a 0a20  on_outputs[0].. 
+000053f0: 2020 2020 2020 2023 2069 6620 6465 636f         # if deco
+00005400: 6465 722c 2074 6865 206c 6173 7420 6f75  der, the last ou
+00005410: 7470 7574 2069 7320 7475 706c 6520 6f66  tput is tuple of
+00005420: 2073 656c 662d 6174 746e 2063 6163 6865   self-attn cache
+00005430: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+00005440: 2e69 735f 6465 636f 6465 723a 0a20 2020  .is_decoder:.   
+00005450: 2020 2020 2020 2020 206f 7574 7075 7473           outputs
+00005460: 203d 2073 656c 665f 6174 7465 6e74 696f   = self_attentio
+00005470: 6e5f 6f75 7470 7574 735b 313a 2d31 5d0a  n_outputs[1:-1].
+00005480: 2020 2020 2020 2020 2020 2020 7072 6573              pres
+00005490: 656e 745f 6b65 795f 7661 6c75 6520 3d20  ent_key_value = 
+000054a0: 7365 6c66 5f61 7474 656e 7469 6f6e 5f6f  self_attention_o
+000054b0: 7574 7075 7473 5b2d 315d 0a20 2020 2020  utputs[-1].     
+000054c0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000054d0: 2020 2020 206f 7574 7075 7473 203d 2073       outputs = s
+000054e0: 656c 665f 6174 7465 6e74 696f 6e5f 6f75  elf_attention_ou
+000054f0: 7470 7574 735b 313a 5d20 2023 2061 6464  tputs[1:]  # add
+00005500: 2073 656c 6620 6174 7465 6e74 696f 6e73   self attentions
+00005510: 2069 6620 7765 206f 7574 7075 7420 6174   if we output at
+00005520: 7465 6e74 696f 6e20 7765 6967 6874 730a  tention weights.
+00005530: 0a20 2020 2020 2020 2063 726f 7373 5f61  .        cross_a
+00005540: 7474 6e5f 7072 6573 656e 745f 6b65 795f  ttn_present_key_
+00005550: 7661 6c75 6520 3d20 4e6f 6e65 0a20 2020  value = None.   
+00005560: 2020 2020 2069 6620 7365 6c66 2e69 735f       if self.is_
+00005570: 6465 636f 6465 7220 616e 6420 656e 636f  decoder and enco
+00005580: 6465 725f 6869 6464 656e 5f73 7461 7465  der_hidden_state
+00005590: 7320 6973 206e 6f74 204e 6f6e 653a 0a20  s is not None:. 
+000055a0: 2020 2020 2020 2020 2020 2069 6620 6861             if ha
+000055b0: 7361 7474 7228 7365 6c66 2c20 2263 726f  sattr(self, "cro
+000055c0: 7373 6174 7465 6e74 696f 6e22 293a 0a20  ssattention"):. 
+000055d0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000055e0: 6169 7365 2045 7863 6570 7469 6f6e 280a  aise Exception(.
+000055f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005600: 2020 2020 6622 4966 2060 656e 636f 6465      f"If `encode
+00005610: 725f 6869 6464 656e 5f73 7461 7465 7360  r_hidden_states`
+00005620: 2061 7265 2070 6173 7365 642c 207b 7365   are passed, {se
+00005630: 6c66 7d20 6861 7320 746f 2062 6520 696e  lf} has to be in
+00005640: 7374 616e 7469 6174 6564 2077 6974 6820  stantiated with 
+00005650: 6372 6f73 732d 6174 7465 6e74 696f 6e20  cross-attention 
+00005660: 6c61 7965 7273 2062 7920 7365 7474 696e  layers by settin
+00005670: 6720 6063 6f6e 6669 672e 6164 645f 6372  g `config.add_cr
+00005680: 6f73 735f 6174 7465 6e74 696f 6e3d 5472  oss_attention=Tr
+00005690: 7565 6022 0a20 2020 2020 2020 2020 2020  ue`".           
+000056a0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+000056b0: 2020 2020 2320 6372 6f73 735f 6174 746e      # cross_attn
+000056c0: 2063 6163 6865 6420 6b65 792f 7661 6c75   cached key/valu
+000056d0: 6573 2074 7570 6c65 2069 7320 6174 2070  es tuple is at p
+000056e0: 6f73 6974 696f 6e73 2033 2c34 206f 6620  ositions 3,4 of 
+000056f0: 7061 7374 5f6b 6579 5f76 616c 7565 2074  past_key_value t
+00005700: 7570 6c65 0a20 2020 2020 2020 2020 2020  uple.           
+00005710: 2063 726f 7373 5f61 7474 6e5f 7061 7374   cross_attn_past
+00005720: 5f6b 6579 5f76 616c 7565 203d 2070 6173  _key_value = pas
+00005730: 745f 6b65 795f 7661 6c75 655b 2d32 3a5d  t_key_value[-2:]
+00005740: 2069 6620 7061 7374 5f6b 6579 5f76 616c   if past_key_val
+00005750: 7565 2069 7320 6e6f 7420 4e6f 6e65 2065  ue is not None e
+00005760: 6c73 6520 4e6f 6e65 0a20 2020 2020 2020  lse None.       
+00005770: 2020 2020 2063 726f 7373 5f61 7474 656e       cross_atten
+00005780: 7469 6f6e 5f6f 7574 7075 7473 203d 2073  tion_outputs = s
+00005790: 656c 662e 6372 6f73 7361 7474 656e 7469  elf.crossattenti
+000057a0: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
+000057b0: 2020 2020 6174 7465 6e74 696f 6e5f 6f75      attention_ou
+000057c0: 7470 7574 2c0a 2020 2020 2020 2020 2020  tput,.          
+000057d0: 2020 2020 2020 6174 7465 6e74 696f 6e5f        attention_
+000057e0: 6d61 736b 2c0a 2020 2020 2020 2020 2020  mask,.          
+000057f0: 2020 2020 2020 6865 6164 5f6d 6173 6b2c        head_mask,
+00005800: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005810: 2065 6e63 6f64 6572 5f68 6964 6465 6e5f   encoder_hidden_
+00005820: 7374 6174 6573 2c0a 2020 2020 2020 2020  states,.        
+00005830: 2020 2020 2020 2020 656e 636f 6465 725f          encoder_
+00005840: 6174 7465 6e74 696f 6e5f 6d61 736b 2c0a  attention_mask,.
+00005850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005860: 6372 6f73 735f 6174 746e 5f70 6173 745f  cross_attn_past_
+00005870: 6b65 795f 7661 6c75 652c 0a20 2020 2020  key_value,.     
+00005880: 2020 2020 2020 2020 2020 206f 7574 7075             outpu
+00005890: 745f 6174 7465 6e74 696f 6e73 2c0a 2020  t_attentions,.  
+000058a0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+000058b0: 2020 2020 2020 2020 6174 7465 6e74 696f          attentio
+000058c0: 6e5f 6f75 7470 7574 203d 2063 726f 7373  n_output = cross
+000058d0: 5f61 7474 656e 7469 6f6e 5f6f 7574 7075  _attention_outpu
+000058e0: 7473 5b30 5d0a 2020 2020 2020 2020 2020  ts[0].          
+000058f0: 2020 6f75 7470 7574 7320 3d20 6f75 7470    outputs = outp
+00005900: 7574 7320 2b20 6372 6f73 735f 6174 7465  uts + cross_atte
+00005910: 6e74 696f 6e5f 6f75 7470 7574 735b 313a  ntion_outputs[1:
+00005920: 2d31 5d20 2023 2061 6464 2063 726f 7373  -1]  # add cross
+00005930: 2061 7474 656e 7469 6f6e 7320 6966 2077   attentions if w
+00005940: 6520 6f75 7470 7574 2061 7474 656e 7469  e output attenti
+00005950: 6f6e 2077 6569 6768 7473 0a0a 2020 2020  on weights..    
+00005960: 2020 2020 2020 2020 2320 6164 6420 6372          # add cr
+00005970: 6f73 732d 6174 746e 2063 6163 6865 2074  oss-attn cache t
+00005980: 6f20 706f 7369 7469 6f6e 7320 332c 3420  o positions 3,4 
+00005990: 6f66 2070 7265 7365 6e74 5f6b 6579 5f76  of present_key_v
+000059a0: 616c 7565 2074 7570 6c65 0a20 2020 2020  alue tuple.     
+000059b0: 2020 2020 2020 2063 726f 7373 5f61 7474         cross_att
+000059c0: 6e5f 7072 6573 656e 745f 6b65 795f 7661  n_present_key_va
+000059d0: 6c75 6520 3d20 6372 6f73 735f 6174 7465  lue = cross_atte
+000059e0: 6e74 696f 6e5f 6f75 7470 7574 735b 2d31  ntion_outputs[-1
+000059f0: 5d0a 2020 2020 2020 2020 2020 2020 7072  ].            pr
+00005a00: 6573 656e 745f 6b65 795f 7661 6c75 6520  esent_key_value 
+00005a10: 3d20 7072 6573 656e 745f 6b65 795f 7661  = present_key_va
+00005a20: 6c75 6520 2b20 6372 6f73 735f 6174 746e  lue + cross_attn
+00005a30: 5f70 7265 7365 6e74 5f6b 6579 5f76 616c  _present_key_val
+00005a40: 7565 0a0a 2020 2020 2020 2020 6c61 7965  ue..        laye
+00005a50: 725f 6f75 7470 7574 203d 2061 7070 6c79  r_output = apply
+00005a60: 5f63 6875 6e6b 696e 675f 746f 5f66 6f72  _chunking_to_for
+00005a70: 7761 7264 280a 2020 2020 2020 2020 2020  ward(.          
+00005a80: 2020 7365 6c66 2e66 6565 645f 666f 7277    self.feed_forw
+00005a90: 6172 645f 6368 756e 6b2c 0a20 2020 2020  ard_chunk,.     
+00005aa0: 2020 2020 2020 2073 656c 662e 6368 756e         self.chun
+00005ab0: 6b5f 7369 7a65 5f66 6565 645f 666f 7277  k_size_feed_forw
+00005ac0: 6172 642c 0a20 2020 2020 2020 2020 2020  ard,.           
+00005ad0: 2073 656c 662e 7365 715f 6c65 6e5f 6469   self.seq_len_di
+00005ae0: 6d2c 0a20 2020 2020 2020 2020 2020 2061  m,.            a
+00005af0: 7474 656e 7469 6f6e 5f6f 7574 7075 742c  ttention_output,
+00005b00: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00005b10: 2020 206f 7574 7075 7473 203d 2028 6c61     outputs = (la
+00005b20: 7965 725f 6f75 7470 7574 2c29 202b 206f  yer_output,) + o
+00005b30: 7574 7075 7473 0a0a 2020 2020 2020 2020  utputs..        
+00005b40: 2320 6966 2064 6563 6f64 6572 2c20 7265  # if decoder, re
+00005b50: 7475 726e 2074 6865 2061 7474 6e20 6b65  turn the attn ke
+00005b60: 792f 7661 6c75 6573 2061 7320 7468 6520  y/values as the 
+00005b70: 6c61 7374 206f 7574 7075 740a 2020 2020  last output.    
+00005b80: 2020 2020 6966 2073 656c 662e 6973 5f64      if self.is_d
+00005b90: 6563 6f64 6572 3a0a 2020 2020 2020 2020  ecoder:.        
+00005ba0: 2020 2020 6f75 7470 7574 7320 3d20 6f75      outputs = ou
+00005bb0: 7470 7574 7320 2b20 2870 7265 7365 6e74  tputs + (present
+00005bc0: 5f6b 6579 5f76 616c 7565 2c29 0a0a 2020  _key_value,)..  
+00005bd0: 2020 2020 2020 7265 7475 726e 206f 7574        return out
+00005be0: 7075 7473 0a0a 2020 2020 6465 6620 6665  puts..    def fe
+00005bf0: 6564 5f66 6f72 7761 7264 5f63 6875 6e6b  ed_forward_chunk
+00005c00: 2873 656c 662c 2061 7474 656e 7469 6f6e  (self, attention
+00005c10: 5f6f 7574 7075 7429 3a0a 2020 2020 2020  _output):.      
+00005c20: 2020 696e 7465 726d 6564 6961 7465 5f6f    intermediate_o
+00005c30: 7574 7075 7420 3d20 7365 6c66 2e69 6e74  utput = self.int
+00005c40: 6572 6d65 6469 6174 6528 6174 7465 6e74  ermediate(attent
+00005c50: 696f 6e5f 6f75 7470 7574 290a 2020 2020  ion_output).    
+00005c60: 2020 2020 6c61 7965 725f 6f75 7470 7574      layer_output
+00005c70: 203d 2073 656c 662e 6f75 7470 7574 2869   = self.output(i
+00005c80: 6e74 6572 6d65 6469 6174 655f 6f75 7470  ntermediate_outp
+00005c90: 7574 2c20 6174 7465 6e74 696f 6e5f 6f75  ut, attention_ou
+00005ca0: 7470 7574 290a 2020 2020 2020 2020 7265  tput).        re
+00005cb0: 7475 726e 206c 6179 6572 5f6f 7574 7075  turn layer_outpu
+00005cc0: 740a 0a0a 636c 6173 7320 4272 6f73 456e  t...class BrosEn
+00005cd0: 636f 6465 7228 6e6e 2e43 656c 6c29 3a0a  coder(nn.Cell):.
+00005ce0: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
+00005cf0: 2873 656c 662c 2063 6f6e 6669 6729 3a0a  (self, config):.
+00005d00: 2020 2020 2020 2020 7375 7065 7228 292e          super().
+00005d10: 5f5f 696e 6974 5f5f 2829 0a20 2020 2020  __init__().     
+00005d20: 2020 2073 656c 662e 636f 6e66 6967 203d     self.config =
+00005d30: 2063 6f6e 6669 670a 2020 2020 2020 2020   config.        
+00005d40: 7365 6c66 2e6c 6179 6572 203d 206e 6e2e  self.layer = nn.
+00005d50: 4365 6c6c 4c69 7374 285b 4272 6f73 4c61  CellList([BrosLa
+00005d60: 7965 7228 636f 6e66 6967 2920 666f 7220  yer(config) for 
+00005d70: 5f20 696e 2072 616e 6765 2863 6f6e 6669  _ in range(confi
+00005d80: 672e 6e75 6d5f 6869 6464 656e 5f6c 6179  g.num_hidden_lay
+00005d90: 6572 7329 5d29 0a0a 2020 2020 6465 6620  ers)])..    def 
+00005da0: 636f 6e73 7472 7563 7428 0a20 2020 2020  construct(.     
+00005db0: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+00005dc0: 2068 6964 6465 6e5f 7374 6174 6573 3a20   hidden_states: 
+00005dd0: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+00005de0: 2c0a 2020 2020 2020 2020 6262 6f78 5f70  ,.        bbox_p
+00005df0: 6f73 5f65 6d62 3a20 6d69 6e64 7370 6f72  os_emb: mindspor
+00005e00: 652e 5465 6e73 6f72 2c0a 2020 2020 2020  e.Tensor,.      
+00005e10: 2020 6174 7465 6e74 696f 6e5f 6d61 736b    attention_mask
+00005e20: 3a20 4f70 7469 6f6e 616c 5b6d 696e 6473  : Optional[minds
+00005e30: 706f 7265 2e54 656e 736f 725d 203d 204e  pore.Tensor] = N
+00005e40: 6f6e 652c 0a20 2020 2020 2020 2068 6561  one,.        hea
+00005e50: 645f 6d61 736b 3a20 4f70 7469 6f6e 616c  d_mask: Optional
+00005e60: 5b6d 696e 6473 706f 7265 2e54 656e 736f  [mindspore.Tenso
+00005e70: 725d 203d 204e 6f6e 652c 0a20 2020 2020  r] = None,.     
+00005e80: 2020 2065 6e63 6f64 6572 5f68 6964 6465     encoder_hidde
+00005e90: 6e5f 7374 6174 6573 3a20 4f70 7469 6f6e  n_states: Option
+00005ea0: 616c 5b6d 696e 6473 706f 7265 2e54 656e  al[mindspore.Ten
+00005eb0: 736f 725d 203d 204e 6f6e 652c 0a20 2020  sor] = None,.   
+00005ec0: 2020 2020 2065 6e63 6f64 6572 5f61 7474       encoder_att
+00005ed0: 656e 7469 6f6e 5f6d 6173 6b3a 204f 7074  ention_mask: Opt
+00005ee0: 696f 6e61 6c5b 6d69 6e64 7370 6f72 652e  ional[mindspore.
+00005ef0: 5465 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a  Tensor] = None,.
+00005f00: 2020 2020 2020 2020 7061 7374 5f6b 6579          past_key
+00005f10: 5f76 616c 7565 733a 204f 7074 696f 6e61  _values: Optiona
+00005f20: 6c5b 5475 706c 655b 5475 706c 655b 6d69  l[Tuple[Tuple[mi
+00005f30: 6e64 7370 6f72 652e 5465 6e73 6f72 5d5d  ndspore.Tensor]]
+00005f40: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+00005f50: 2020 7573 655f 6361 6368 653a 204f 7074    use_cache: Opt
+00005f60: 696f 6e61 6c5b 626f 6f6c 5d20 3d20 4e6f  ional[bool] = No
+00005f70: 6e65 2c0a 2020 2020 2020 2020 6f75 7470  ne,.        outp
+00005f80: 7574 5f61 7474 656e 7469 6f6e 733a 204f  ut_attentions: O
+00005f90: 7074 696f 6e61 6c5b 626f 6f6c 5d20 3d20  ptional[bool] = 
+00005fa0: 4661 6c73 652c 0a20 2020 2020 2020 206f  False,.        o
+00005fb0: 7574 7075 745f 6869 6464 656e 5f73 7461  utput_hidden_sta
+00005fc0: 7465 733a 204f 7074 696f 6e61 6c5b 626f  tes: Optional[bo
+00005fd0: 6f6c 5d20 3d20 4661 6c73 652c 0a20 2020  ol] = False,.   
+00005fe0: 2020 2020 2072 6574 7572 6e5f 6469 6374       return_dict
+00005ff0: 3a20 4f70 7469 6f6e 616c 5b62 6f6f 6c5d  : Optional[bool]
+00006000: 203d 2054 7275 652c 0a20 2020 2029 202d   = True,.    ) -
+00006010: 3e20 556e 696f 6e5b 5475 706c 655b 6d69  > Union[Tuple[mi
+00006020: 6e64 7370 6f72 652e 5465 6e73 6f72 5d2c  ndspore.Tensor],
+00006030: 2042 6173 654d 6f64 656c 4f75 7470 7574   BaseModelOutput
+00006040: 5769 7468 5061 7374 416e 6443 726f 7373  WithPastAndCross
+00006050: 4174 7465 6e74 696f 6e73 5d3a 0a20 2020  Attentions]:.   
+00006060: 2020 2020 2061 6c6c 5f68 6964 6465 6e5f       all_hidden_
+00006070: 7374 6174 6573 203d 2028 2920 6966 206f  states = () if o
+00006080: 7574 7075 745f 6869 6464 656e 5f73 7461  utput_hidden_sta
+00006090: 7465 7320 656c 7365 204e 6f6e 650a 2020  tes else None.  
+000060a0: 2020 2020 2020 616c 6c5f 7365 6c66 5f61        all_self_a
+000060b0: 7474 656e 7469 6f6e 7320 3d20 2829 2069  ttentions = () i
+000060c0: 6620 6f75 7470 7574 5f61 7474 656e 7469  f output_attenti
+000060d0: 6f6e 7320 656c 7365 204e 6f6e 650a 2020  ons else None.  
+000060e0: 2020 2020 2020 616c 6c5f 6372 6f73 735f        all_cross_
+000060f0: 6174 7465 6e74 696f 6e73 203d 2028 2920  attentions = () 
+00006100: 6966 206f 7574 7075 745f 6174 7465 6e74  if output_attent
+00006110: 696f 6e73 2061 6e64 2073 656c 662e 636f  ions and self.co
+00006120: 6e66 6967 2e61 6464 5f63 726f 7373 5f61  nfig.add_cross_a
+00006130: 7474 656e 7469 6f6e 2065 6c73 6520 4e6f  ttention else No
+00006140: 6e65 0a0a 2020 2020 2020 2020 6e65 7874  ne..        next
+00006150: 5f64 6563 6f64 6572 5f63 6163 6865 203d  _decoder_cache =
+00006160: 2028 2920 6966 2075 7365 5f63 6163 6865   () if use_cache
+00006170: 2065 6c73 6520 4e6f 6e65 0a20 2020 2020   else None.     
+00006180: 2020 2066 6f72 2069 2c20 6c61 7965 725f     for i, layer_
+00006190: 6d6f 6475 6c65 2069 6e20 656e 756d 6572  module in enumer
+000061a0: 6174 6528 7365 6c66 2e6c 6179 6572 293a  ate(self.layer):
+000061b0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000061c0: 6f75 7470 7574 5f68 6964 6465 6e5f 7374  output_hidden_st
+000061d0: 6174 6573 3a0a 2020 2020 2020 2020 2020  ates:.          
+000061e0: 2020 2020 2020 616c 6c5f 6869 6464 656e        all_hidden
+000061f0: 5f73 7461 7465 7320 3d20 616c 6c5f 6869  _states = all_hi
+00006200: 6464 656e 5f73 7461 7465 7320 2b20 2868  dden_states + (h
+00006210: 6964 6465 6e5f 7374 6174 6573 2c29 0a0a  idden_states,)..
+00006220: 2020 2020 2020 2020 2020 2020 6c61 7965              laye
+00006230: 725f 6865 6164 5f6d 6173 6b20 3d20 6865  r_head_mask = he
+00006240: 6164 5f6d 6173 6b5b 695d 2069 6620 6865  ad_mask[i] if he
+00006250: 6164 5f6d 6173 6b20 6973 206e 6f74 204e  ad_mask is not N
+00006260: 6f6e 6520 656c 7365 204e 6f6e 650a 2020  one else None.  
+00006270: 2020 2020 2020 2020 2020 7061 7374 5f6b            past_k
+00006280: 6579 5f76 616c 7565 203d 2070 6173 745f  ey_value = past_
+00006290: 6b65 795f 7661 6c75 6573 5b69 5d20 6966  key_values[i] if
+000062a0: 2070 6173 745f 6b65 795f 7661 6c75 6573   past_key_values
+000062b0: 2069 7320 6e6f 7420 4e6f 6e65 2065 6c73   is not None els
+000062c0: 6520 4e6f 6e65 0a0a 2020 2020 2020 2020  e None..        
+000062d0: 2020 2020 6966 2067 6574 6174 7472 2873      if getattr(s
+000062e0: 656c 662e 636f 6e66 6967 2c20 2267 7261  elf.config, "gra
+000062f0: 6469 656e 745f 6368 6563 6b70 6f69 6e74  dient_checkpoint
+00006300: 696e 6722 2c20 4661 6c73 6529 2061 6e64  ing", False) and
+00006310: 2073 656c 662e 7472 6169 6e69 6e67 3a0a   self.training:.
+00006320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006330: 6966 2075 7365 5f63 6163 6865 3a0a 2020  if use_cache:.  
+00006340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006350: 2020 6c6f 6767 6572 2e77 6172 6e69 6e67    logger.warning
+00006360: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00006370: 2020 2020 2020 2020 2020 2260 7573 655f            "`use_
+00006380: 6361 6368 653d 5472 7565 6020 6973 2069  cache=True` is i
+00006390: 6e63 6f6d 7061 7469 626c 6520 7769 7468  ncompatible with
+000063a0: 2060 636f 6e66 6967 2e67 7261 6469 656e   `config.gradien
+000063b0: 745f 6368 6563 6b70 6f69 6e74 696e 673d  t_checkpointing=
+000063c0: 5472 7565 602e 2053 6574 7469 6e67 2022  True`. Setting "
+000063d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000063e0: 2020 2020 2020 2020 2022 6075 7365 5f63           "`use_c
+000063f0: 6163 6865 3d46 616c 7365 602e 2e2e 220a  ache=False`...".
+00006400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006410: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00006420: 2020 2020 2020 2020 2020 7573 655f 6361            use_ca
+00006430: 6368 6520 3d20 4661 6c73 650a 2020 2020  che = False.    
+00006440: 2020 2020 2020 2020 2020 2020 6c61 7965              laye
+00006450: 725f 6f75 7470 7574 7320 3d20 7365 6c66  r_outputs = self
+00006460: 2e5f 6772 6164 6965 6e74 5f63 6865 636b  ._gradient_check
+00006470: 706f 696e 7469 6e67 5f66 756e 6328 0a20  pointing_func(. 
+00006480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006490: 2020 206c 6179 6572 5f6d 6f64 756c 652e     layer_module.
+000064a0: 5f5f 6361 6c6c 5f5f 2c0a 2020 2020 2020  __call__,.      
+000064b0: 2020 2020 2020 2020 2020 2020 2020 6869                hi
+000064c0: 6464 656e 5f73 7461 7465 732c 0a20 2020  dden_states,.   
+000064d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000064e0: 2062 626f 785f 706f 735f 656d 622c 0a20   bbox_pos_emb,. 
+000064f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006500: 2020 2061 7474 656e 7469 6f6e 5f6d 6173     attention_mas
+00006510: 6b2c 0a20 2020 2020 2020 2020 2020 2020  k,.             
+00006520: 2020 2020 2020 206c 6179 6572 5f68 6561         layer_hea
+00006530: 645f 6d61 736b 2c0a 2020 2020 2020 2020  d_mask,.        
+00006540: 2020 2020 2020 2020 2020 2020 656e 636f              enco
+00006550: 6465 725f 6869 6464 656e 5f73 7461 7465  der_hidden_state
+00006560: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+00006570: 2020 2020 2020 2065 6e63 6f64 6572 5f61         encoder_a
+00006580: 7474 656e 7469 6f6e 5f6d 6173 6b2c 0a20  ttention_mask,. 
+00006590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000065a0: 2020 206f 7574 7075 745f 6174 7465 6e74     output_attent
+000065b0: 696f 6e73 2c0a 2020 2020 2020 2020 2020  ions,.          
+000065c0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000065d0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000065e0: 2020 2020 2020 2020 2020 6c61 7965 725f            layer_
+000065f0: 6f75 7470 7574 7320 3d20 6c61 7965 725f  outputs = layer_
+00006600: 6d6f 6475 6c65 280a 2020 2020 2020 2020  module(.        
+00006610: 2020 2020 2020 2020 2020 2020 6869 6464              hidd
+00006620: 656e 5f73 7461 7465 733d 6869 6464 656e  en_states=hidden
+00006630: 5f73 7461 7465 732c 0a20 2020 2020 2020  _states,.       
+00006640: 2020 2020 2020 2020 2020 2020 2062 626f               bbo
+00006650: 785f 706f 735f 656d 623d 6262 6f78 5f70  x_pos_emb=bbox_p
+00006660: 6f73 5f65 6d62 2c0a 2020 2020 2020 2020  os_emb,.        
+00006670: 2020 2020 2020 2020 2020 2020 6174 7465              atte
+00006680: 6e74 696f 6e5f 6d61 736b 3d61 7474 656e  ntion_mask=atten
+00006690: 7469 6f6e 5f6d 6173 6b2c 0a20 2020 2020  tion_mask,.     
+000066a0: 2020 2020 2020 2020 2020 2020 2020 2068                 h
+000066b0: 6561 645f 6d61 736b 3d6c 6179 6572 5f68  ead_mask=layer_h
+000066c0: 6561 645f 6d61 736b 2c0a 2020 2020 2020  ead_mask,.      
+000066d0: 2020 2020 2020 2020 2020 2020 2020 656e                en
+000066e0: 636f 6465 725f 6869 6464 656e 5f73 7461  coder_hidden_sta
+000066f0: 7465 733d 656e 636f 6465 725f 6869 6464  tes=encoder_hidd
+00006700: 656e 5f73 7461 7465 732c 0a20 2020 2020  en_states,.     
+00006710: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00006720: 6e63 6f64 6572 5f61 7474 656e 7469 6f6e  ncoder_attention
+00006730: 5f6d 6173 6b3d 656e 636f 6465 725f 6174  _mask=encoder_at
+00006740: 7465 6e74 696f 6e5f 6d61 736b 2c0a 2020  tention_mask,.  
+00006750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006760: 2020 7061 7374 5f6b 6579 5f76 616c 7565    past_key_value
+00006770: 3d70 6173 745f 6b65 795f 7661 6c75 652c  =past_key_value,
+00006780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006790: 2020 2020 206f 7574 7075 745f 6174 7465       output_atte
+000067a0: 6e74 696f 6e73 3d6f 7574 7075 745f 6174  ntions=output_at
+000067b0: 7465 6e74 696f 6e73 2c0a 2020 2020 2020  tentions,.      
+000067c0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+000067d0: 2020 2020 2020 2020 2068 6964 6465 6e5f           hidden_
+000067e0: 7374 6174 6573 203d 206c 6179 6572 5f6f  states = layer_o
+000067f0: 7574 7075 7473 5b30 5d0a 2020 2020 2020  utputs[0].      
+00006800: 2020 2020 2020 6966 2075 7365 5f63 6163        if use_cac
+00006810: 6865 3a0a 2020 2020 2020 2020 2020 2020  he:.            
+00006820: 2020 2020 6e65 7874 5f64 6563 6f64 6572      next_decoder
+00006830: 5f63 6163 6865 202b 3d20 286c 6179 6572  _cache += (layer
+00006840: 5f6f 7574 7075 7473 5b2d 315d 2c29 0a20  _outputs[-1],). 
+00006850: 2020 2020 2020 2020 2020 2069 6620 6f75             if ou
+00006860: 7470 7574 5f61 7474 656e 7469 6f6e 733a  tput_attentions:
+00006870: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006880: 2061 6c6c 5f73 656c 665f 6174 7465 6e74   all_self_attent
+00006890: 696f 6e73 203d 2061 6c6c 5f73 656c 665f  ions = all_self_
+000068a0: 6174 7465 6e74 696f 6e73 202b 2028 6c61  attentions + (la
+000068b0: 7965 725f 6f75 7470 7574 735b 315d 2c29  yer_outputs[1],)
+000068c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000068d0: 2069 6620 7365 6c66 2e63 6f6e 6669 672e   if self.config.
+000068e0: 6164 645f 6372 6f73 735f 6174 7465 6e74  add_cross_attent
+000068f0: 696f 6e3a 0a20 2020 2020 2020 2020 2020  ion:.           
+00006900: 2020 2020 2020 2020 2061 6c6c 5f63 726f           all_cro
+00006910: 7373 5f61 7474 656e 7469 6f6e 7320 3d20  ss_attentions = 
+00006920: 616c 6c5f 6372 6f73 735f 6174 7465 6e74  all_cross_attent
+00006930: 696f 6e73 202b 2028 6c61 7965 725f 6f75  ions + (layer_ou
+00006940: 7470 7574 735b 325d 2c29 0a0a 2020 2020  tputs[2],)..    
+00006950: 2020 2020 6966 206f 7574 7075 745f 6869      if output_hi
+00006960: 6464 656e 5f73 7461 7465 733a 0a20 2020  dden_states:.   
+00006970: 2020 2020 2020 2020 2061 6c6c 5f68 6964           all_hid
+00006980: 6465 6e5f 7374 6174 6573 203d 2061 6c6c  den_states = all
+00006990: 5f68 6964 6465 6e5f 7374 6174 6573 202b  _hidden_states +
+000069a0: 2028 6869 6464 656e 5f73 7461 7465 732c   (hidden_states,
+000069b0: 290a 0a20 2020 2020 2020 2069 6620 6e6f  )..        if no
+000069c0: 7420 7265 7475 726e 5f64 6963 743a 0a20  t return_dict:. 
+000069d0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+000069e0: 6e20 7475 706c 6528 0a20 2020 2020 2020  n tuple(.       
+000069f0: 2020 2020 2020 2020 2076 0a20 2020 2020           v.     
+00006a00: 2020 2020 2020 2020 2020 2066 6f72 2076             for v
+00006a10: 2069 6e20 5b0a 2020 2020 2020 2020 2020   in [.          
+00006a20: 2020 2020 2020 2020 2020 6869 6464 656e            hidden
+00006a30: 5f73 7461 7465 732c 0a20 2020 2020 2020  _states,.       
+00006a40: 2020 2020 2020 2020 2020 2020 206e 6578               nex
+00006a50: 745f 6465 636f 6465 725f 6361 6368 652c  t_decoder_cache,
+00006a60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006a70: 2020 2020 2061 6c6c 5f68 6964 6465 6e5f       all_hidden_
+00006a80: 7374 6174 6573 2c0a 2020 2020 2020 2020  states,.        
+00006a90: 2020 2020 2020 2020 2020 2020 616c 6c5f              all_
+00006aa0: 7365 6c66 5f61 7474 656e 7469 6f6e 732c  self_attentions,
+00006ab0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00006ac0: 2020 2020 2061 6c6c 5f63 726f 7373 5f61       all_cross_a
+00006ad0: 7474 656e 7469 6f6e 732c 0a20 2020 2020  ttentions,.     
+00006ae0: 2020 2020 2020 2020 2020 205d 0a20 2020             ].   
+00006af0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00006b00: 7620 6973 206e 6f74 204e 6f6e 650a 2020  v is not None.  
+00006b10: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00006b20: 2020 2020 7265 7475 726e 2042 6173 654d      return BaseM
+00006b30: 6f64 656c 4f75 7470 7574 5769 7468 5061  odelOutputWithPa
+00006b40: 7374 416e 6443 726f 7373 4174 7465 6e74  stAndCrossAttent
+00006b50: 696f 6e73 280a 2020 2020 2020 2020 2020  ions(.          
+00006b60: 2020 6c61 7374 5f68 6964 6465 6e5f 7374    last_hidden_st
+00006b70: 6174 653d 6869 6464 656e 5f73 7461 7465  ate=hidden_state
+00006b80: 732c 0a20 2020 2020 2020 2020 2020 2070  s,.            p
+00006b90: 6173 745f 6b65 795f 7661 6c75 6573 3d6e  ast_key_values=n
+00006ba0: 6578 745f 6465 636f 6465 725f 6361 6368  ext_decoder_cach
+00006bb0: 652c 0a20 2020 2020 2020 2020 2020 2068  e,.            h
+00006bc0: 6964 6465 6e5f 7374 6174 6573 3d61 6c6c  idden_states=all
+00006bd0: 5f68 6964 6465 6e5f 7374 6174 6573 2c0a  _hidden_states,.
+00006be0: 2020 2020 2020 2020 2020 2020 6174 7465              atte
+00006bf0: 6e74 696f 6e73 3d61 6c6c 5f73 656c 665f  ntions=all_self_
+00006c00: 6174 7465 6e74 696f 6e73 2c0a 2020 2020  attentions,.    
+00006c10: 2020 2020 2020 2020 6372 6f73 735f 6174          cross_at
+00006c20: 7465 6e74 696f 6e73 3d61 6c6c 5f63 726f  tentions=all_cro
+00006c30: 7373 5f61 7474 656e 7469 6f6e 732c 0a20  ss_attentions,. 
+00006c40: 2020 2020 2020 2029 0a0a 0a23 2043 6f70         )...# Cop
+00006c50: 6965 6420 6672 6f6d 2074 7261 6e73 666f  ied from transfo
+00006c60: 726d 6572 732e 6d6f 6465 6c73 2e62 6572  rmers.models.ber
+00006c70: 742e 6d6f 6465 6c69 6e67 5f62 6572 742e  t.modeling_bert.
+00006c80: 4265 7274 506f 6f6c 6572 2077 6974 6820  BertPooler with 
+00006c90: 4265 7274 2d3e 4272 6f73 0a63 6c61 7373  Bert->Bros.class
+00006ca0: 2042 726f 7350 6f6f 6c65 7228 6e6e 2e43   BrosPooler(nn.C
+00006cb0: 656c 6c29 3a0a 2020 2020 6465 6620 5f5f  ell):.    def __
+00006cc0: 696e 6974 5f5f 2873 656c 662c 2063 6f6e  init__(self, con
+00006cd0: 6669 6729 3a0a 2020 2020 2020 2020 7375  fig):.        su
+00006ce0: 7065 7228 292e 5f5f 696e 6974 5f5f 2829  per().__init__()
+00006cf0: 0a20 2020 2020 2020 2073 656c 662e 6465  .        self.de
+00006d00: 6e73 6520 3d20 6e6e 2e44 656e 7365 2863  nse = nn.Dense(c
+00006d10: 6f6e 6669 672e 6869 6464 656e 5f73 697a  onfig.hidden_siz
+00006d20: 652c 2063 6f6e 6669 672e 6869 6464 656e  e, config.hidden
+00006d30: 5f73 697a 6529 0a20 2020 2020 2020 2073  _size).        s
+00006d40: 656c 662e 6163 7469 7661 7469 6f6e 203d  elf.activation =
+00006d50: 206e 6e2e 5461 6e68 2829 0a0a 2020 2020   nn.Tanh()..    
+00006d60: 6465 6620 636f 6e73 7472 7563 7428 7365  def construct(se
+00006d70: 6c66 2c20 6869 6464 656e 5f73 7461 7465  lf, hidden_state
+00006d80: 733a 206d 696e 6473 706f 7265 2e54 656e  s: mindspore.Ten
+00006d90: 736f 7229 202d 3e20 6d69 6e64 7370 6f72  sor) -> mindspor
+00006da0: 652e 5465 6e73 6f72 3a0a 2020 2020 2020  e.Tensor:.      
+00006db0: 2020 2320 5765 2022 706f 6f6c 2220 7468    # We "pool" th
+00006dc0: 6520 6d6f 6465 6c20 6279 2073 696d 706c  e model by simpl
+00006dd0: 7920 7461 6b69 6e67 2074 6865 2068 6964  y taking the hid
+00006de0: 6465 6e20 7374 6174 6520 636f 7272 6573  den state corres
+00006df0: 706f 6e64 696e 670a 2020 2020 2020 2020  ponding.        
+00006e00: 2320 746f 2074 6865 2066 6972 7374 2074  # to the first t
+00006e10: 6f6b 656e 2e0a 2020 2020 2020 2020 6669  oken..        fi
+00006e20: 7273 745f 746f 6b65 6e5f 7465 6e73 6f72  rst_token_tensor
+00006e30: 203d 2068 6964 6465 6e5f 7374 6174 6573   = hidden_states
+00006e40: 5b3a 2c20 305d 0a20 2020 2020 2020 2070  [:, 0].        p
+00006e50: 6f6f 6c65 645f 6f75 7470 7574 203d 2073  ooled_output = s
+00006e60: 656c 662e 6465 6e73 6528 6669 7273 745f  elf.dense(first_
+00006e70: 746f 6b65 6e5f 7465 6e73 6f72 290a 2020  token_tensor).  
+00006e80: 2020 2020 2020 706f 6f6c 6564 5f6f 7574        pooled_out
+00006e90: 7075 7420 3d20 7365 6c66 2e61 6374 6976  put = self.activ
+00006ea0: 6174 696f 6e28 706f 6f6c 6564 5f6f 7574  ation(pooled_out
+00006eb0: 7075 7429 0a20 2020 2020 2020 2072 6574  put).        ret
+00006ec0: 7572 6e20 706f 6f6c 6564 5f6f 7574 7075  urn pooled_outpu
+00006ed0: 740a 0a0a 636c 6173 7320 4272 6f73 5265  t...class BrosRe
+00006ee0: 6c61 7469 6f6e 4578 7472 6163 746f 7228  lationExtractor(
+00006ef0: 6e6e 2e43 656c 6c29 3a0a 2020 2020 6465  nn.Cell):.    de
+00006f00: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
+00006f10: 2063 6f6e 6669 6729 3a0a 2020 2020 2020   config):.      
+00006f20: 2020 7375 7065 7228 292e 5f5f 696e 6974    super().__init
+00006f30: 5f5f 2829 0a20 2020 2020 2020 2073 656c  __().        sel
+00006f40: 662e 6e5f 7265 6c61 7469 6f6e 7320 3d20  f.n_relations = 
+00006f50: 636f 6e66 6967 2e6e 5f72 656c 6174 696f  config.n_relatio
+00006f60: 6e73 0a20 2020 2020 2020 2073 656c 662e  ns.        self.
+00006f70: 6261 636b 626f 6e65 5f68 6964 6465 6e5f  backbone_hidden_
+00006f80: 7369 7a65 203d 2063 6f6e 6669 672e 6869  size = config.hi
+00006f90: 6464 656e 5f73 697a 650a 2020 2020 2020  dden_size.      
+00006fa0: 2020 7365 6c66 2e68 6561 645f 6869 6464    self.head_hidd
+00006fb0: 656e 5f73 697a 6520 3d20 636f 6e66 6967  en_size = config
+00006fc0: 2e68 6964 6465 6e5f 7369 7a65 0a20 2020  .hidden_size.   
+00006fd0: 2020 2020 2073 656c 662e 636c 6173 7369       self.classi
+00006fe0: 6669 6572 5f64 726f 706f 7574 5f70 726f  fier_dropout_pro
+00006ff0: 6220 3d20 636f 6e66 6967 2e63 6c61 7373  b = config.class
+00007000: 6966 6965 725f 6472 6f70 6f75 745f 7072  ifier_dropout_pr
+00007010: 6f62 0a0a 2020 2020 2020 2020 7365 6c66  ob..        self
+00007020: 2e64 726f 7020 3d20 6e6e 2e44 726f 706f  .drop = nn.Dropo
+00007030: 7574 2870 3d73 656c 662e 636c 6173 7369  ut(p=self.classi
+00007040: 6669 6572 5f64 726f 706f 7574 5f70 726f  fier_dropout_pro
+00007050: 6229 0a20 2020 2020 2020 2073 656c 662e  b).        self.
+00007060: 7175 6572 7920 3d20 6e6e 2e44 656e 7365  query = nn.Dense
+00007070: 2873 656c 662e 6261 636b 626f 6e65 5f68  (self.backbone_h
+00007080: 6964 6465 6e5f 7369 7a65 2c20 7365 6c66  idden_size, self
+00007090: 2e6e 5f72 656c 6174 696f 6e73 202a 2073  .n_relations * s
+000070a0: 656c 662e 6865 6164 5f68 6964 6465 6e5f  elf.head_hidden_
+000070b0: 7369 7a65 290a 0a20 2020 2020 2020 2073  size)..        s
+000070c0: 656c 662e 6b65 7920 3d20 6e6e 2e44 656e  elf.key = nn.Den
+000070d0: 7365 2873 656c 662e 6261 636b 626f 6e65  se(self.backbone
+000070e0: 5f68 6964 6465 6e5f 7369 7a65 2c20 7365  _hidden_size, se
+000070f0: 6c66 2e6e 5f72 656c 6174 696f 6e73 202a  lf.n_relations *
+00007100: 2073 656c 662e 6865 6164 5f68 6964 6465   self.head_hidde
+00007110: 6e5f 7369 7a65 290a 0a20 2020 2020 2020  n_size)..       
+00007120: 2073 656c 662e 6475 6d6d 795f 6e6f 6465   self.dummy_node
+00007130: 203d 2050 6172 616d 6574 6572 286f 7073   = Parameter(ops
+00007140: 2e7a 6572 6f73 2831 2c20 7365 6c66 2e62  .zeros(1, self.b
+00007150: 6163 6b62 6f6e 655f 6869 6464 656e 5f73  ackbone_hidden_s
+00007160: 697a 6529 290a 0a20 2020 2064 6566 2063  ize))..    def c
+00007170: 6f6e 7374 7275 6374 2873 656c 662c 2071  onstruct(self, q
+00007180: 7565 7279 5f6c 6179 6572 3a20 6d69 6e64  uery_layer: mind
+00007190: 7370 6f72 652e 5465 6e73 6f72 2c20 6b65  spore.Tensor, ke
+000071a0: 795f 6c61 7965 723a 206d 696e 6473 706f  y_layer: mindspo
+000071b0: 7265 2e54 656e 736f 7229 3a0a 2020 2020  re.Tensor):.    
+000071c0: 2020 2020 7175 6572 795f 6c61 7965 7220      query_layer 
+000071d0: 3d20 7365 6c66 2e71 7565 7279 2873 656c  = self.query(sel
+000071e0: 662e 6472 6f70 2871 7565 7279 5f6c 6179  f.drop(query_lay
+000071f0: 6572 2929 0a0a 2020 2020 2020 2020 6475  er))..        du
+00007200: 6d6d 795f 7665 6320 3d20 7365 6c66 2e64  mmy_vec = self.d
+00007210: 756d 6d79 5f6e 6f64 652e 756e 7371 7565  ummy_node.unsque
+00007220: 657a 6528 3029 2e72 6570 6561 7428 312c  eze(0).repeat(1,
+00007230: 206b 6579 5f6c 6179 6572 2e73 6861 7065   key_layer.shape
+00007240: 5b31 5d2c 2031 290a 2020 2020 2020 2020  [1], 1).        
+00007250: 6b65 795f 6c61 7965 7220 3d20 6f70 732e  key_layer = ops.
+00007260: 6361 7428 5b6b 6579 5f6c 6179 6572 2c20  cat([key_layer, 
+00007270: 6475 6d6d 795f 7665 635d 2c20 6178 6973  dummy_vec], axis
+00007280: 3d30 290a 2020 2020 2020 2020 6b65 795f  =0).        key_
+00007290: 6c61 7965 7220 3d20 7365 6c66 2e6b 6579  layer = self.key
+000072a0: 2873 656c 662e 6472 6f70 286b 6579 5f6c  (self.drop(key_l
+000072b0: 6179 6572 2929 0a0a 2020 2020 2020 2020  ayer))..        
+000072c0: 7175 6572 795f 6c61 7965 7220 3d20 7175  query_layer = qu
+000072d0: 6572 795f 6c61 7965 722e 7669 6577 280a  ery_layer.view(.
+000072e0: 2020 2020 2020 2020 2020 2020 7175 6572              quer
+000072f0: 795f 6c61 7965 722e 7368 6170 655b 305d  y_layer.shape[0]
+00007300: 2c20 7175 6572 795f 6c61 7965 722e 7368  , query_layer.sh
+00007310: 6170 655b 315d 2c20 7365 6c66 2e6e 5f72  ape[1], self.n_r
+00007320: 656c 6174 696f 6e73 2c20 7365 6c66 2e68  elations, self.h
+00007330: 6561 645f 6869 6464 656e 5f73 697a 650a  ead_hidden_size.
+00007340: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00007350: 2020 6b65 795f 6c61 7965 7220 3d20 6b65    key_layer = ke
+00007360: 795f 6c61 7965 722e 7669 6577 286b 6579  y_layer.view(key
+00007370: 5f6c 6179 6572 2e73 6861 7065 5b30 5d2c  _layer.shape[0],
+00007380: 206b 6579 5f6c 6179 6572 2e73 6861 7065   key_layer.shape
+00007390: 5b31 5d2c 2073 656c 662e 6e5f 7265 6c61  [1], self.n_rela
+000073a0: 7469 6f6e 732c 2073 656c 662e 6865 6164  tions, self.head
+000073b0: 5f68 6964 6465 6e5f 7369 7a65 290a 0a20  _hidden_size).. 
+000073c0: 2020 2020 2020 2072 656c 6174 696f 6e5f         relation_
+000073d0: 7363 6f72 6520 3d20 6f70 732e 6d61 746d  score = ops.matm
+000073e0: 756c 280a 2020 2020 2020 2020 2020 2020  ul(.            
+000073f0: 7175 6572 795f 6c61 7965 722e 7065 726d  query_layer.perm
+00007400: 7574 6528 322c 2031 2c20 302c 2033 292c  ute(2, 1, 0, 3),
+00007410: 206b 6579 5f6c 6179 6572 2e70 6572 6d75   key_layer.permu
+00007420: 7465 2832 2c20 312c 2033 2c20 3029 0a20  te(2, 1, 3, 0). 
+00007430: 2020 2020 2020 2029 2020 2320 6571 7569         )  # equi
+00007440: 7661 6c65 6e74 2074 6f20 6f70 732e 6569  valent to ops.ei
+00007450: 6e73 756d 2822 6962 6e64 2c6a 626e 642d  nsum("ibnd,jbnd-
+00007460: 3e6e 6269 6a22 2c20 2871 7565 7279 5f6c  >nbij", (query_l
+00007470: 6179 6572 2c20 6b65 795f 6c61 7965 7229  ayer, key_layer)
+00007480: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+00007490: 6e20 7265 6c61 7469 6f6e 5f73 636f 7265  n relation_score
+000074a0: 0a0a 0a63 6c61 7373 2042 726f 7350 7265  ...class BrosPre
+000074b0: 5472 6169 6e65 644d 6f64 656c 2850 7265  TrainedModel(Pre
+000074c0: 5472 6169 6e65 644d 6f64 656c 293a 0a20  TrainedModel):. 
+000074d0: 2020 2022 2222 0a20 2020 2041 6e20 6162     """.    An ab
+000074e0: 7374 7261 6374 2063 6c61 7373 2074 6f20  stract class to 
+000074f0: 6861 6e64 6c65 2077 6569 6768 7473 2069  handle weights i
+00007500: 6e69 7469 616c 697a 6174 696f 6e20 616e  nitialization an
+00007510: 6420 6120 7369 6d70 6c65 2069 6e74 6572  d a simple inter
+00007520: 6661 6365 2066 6f72 2064 6f77 6e6c 6f61  face for downloa
+00007530: 6469 6e67 2061 6e64 206c 6f61 6469 6e67  ding and loading
+00007540: 2070 7265 7472 6169 6e65 640a 2020 2020   pretrained.    
+00007550: 6d6f 6465 6c73 2e0a 2020 2020 2222 220a  models..    """.
+00007560: 0a20 2020 2063 6f6e 6669 675f 636c 6173  .    config_clas
+00007570: 7320 3d20 4272 6f73 436f 6e66 6967 0a20  s = BrosConfig. 
+00007580: 2020 2062 6173 655f 6d6f 6465 6c5f 7072     base_model_pr
+00007590: 6566 6978 203d 2022 6272 6f73 220a 0a20  efix = "bros".. 
+000075a0: 2020 2064 6566 205f 696e 6974 5f77 6569     def _init_wei
+000075b0: 6768 7473 2873 656c 662c 2063 656c 6c29  ghts(self, cell)
+000075c0: 3a0a 2020 2020 2020 2020 2222 2249 6e69  :.        """Ini
+000075d0: 7469 616c 697a 6520 7468 6520 7765 6967  tialize the weig
+000075e0: 6874 7322 2222 0a20 2020 2020 2020 2069  hts""".        i
+000075f0: 6620 6973 696e 7374 616e 6365 2863 656c  f isinstance(cel
+00007600: 6c2c 206e 6e2e 4465 6e73 6529 3a0a 2020  l, nn.Dense):.  
+00007610: 2020 2020 2020 2020 2020 2320 536c 6967            # Slig
+00007620: 6874 6c79 2064 6966 6665 7265 6e74 2066  htly different f
+00007630: 726f 6d20 7468 6520 5446 2076 6572 7369  rom the TF versi
+00007640: 6f6e 2077 6869 6368 2075 7365 7320 7472  on which uses tr
+00007650: 756e 6361 7465 645f 6e6f 726d 616c 2066  uncated_normal f
+00007660: 6f72 2069 6e69 7469 616c 697a 6174 696f  or initializatio
+00007670: 6e0a 2020 2020 2020 2020 2020 2020 2320  n.            # 
+00007680: 6366 2068 7474 7073 3a2f 2f67 6974 6875  cf https://githu
+00007690: 622e 636f 6d2f 7079 746f 7263 682f 7079  b.com/pytorch/py
+000076a0: 746f 7263 682f 7075 6c6c 2f35 3631 370a  torch/pull/5617.
+000076b0: 2020 2020 2020 2020 2020 2020 6365 6c6c              cell
+000076c0: 2e77 6569 6768 742e 696e 6974 6961 6c69  .weight.initiali
+000076d0: 7a65 284e 6f72 6d61 6c28 7365 6c66 2e63  ze(Normal(self.c
+000076e0: 6f6e 6669 672e 696e 6974 6961 6c69 7a65  onfig.initialize
+000076f0: 725f 7261 6e67 6529 290a 2020 2020 2020  r_range)).      
+00007700: 2020 2020 2020 6966 2063 656c 6c2e 6269        if cell.bi
+00007710: 6173 2069 7320 6e6f 7420 4e6f 6e65 3a0a  as is not None:.
+00007720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007730: 6365 6c6c 2e62 6961 732e 696e 6974 6961  cell.bias.initia
+00007740: 6c69 7a65 2827 7a65 726f 7327 290a 2020  lize('zeros').  
+00007750: 2020 2020 2020 656c 6966 2069 7369 6e73        elif isins
+00007760: 7461 6e63 6528 6365 6c6c 2c20 6e6e 2e45  tance(cell, nn.E
+00007770: 6d62 6564 6469 6e67 293a 0a20 2020 2020  mbedding):.     
+00007780: 2020 2020 2020 2063 656c 6c2e 7765 6967         cell.weig
+00007790: 6874 2e69 6e69 7469 616c 697a 6528 4e6f  ht.initialize(No
+000077a0: 726d 616c 2873 656c 662e 636f 6e66 6967  rmal(self.config
+000077b0: 2e69 6e69 7469 616c 697a 6572 5f72 616e  .initializer_ran
+000077c0: 6765 2929 0a20 2020 2020 2020 2020 2020  ge)).           
+000077d0: 2069 6620 6365 6c6c 2e70 6164 6469 6e67   if cell.padding
+000077e0: 5f69 6478 2069 7320 6e6f 7420 4e6f 6e65  _idx is not None
+000077f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00007800: 2020 6365 6c6c 2e77 6569 6768 745b 6365    cell.weight[ce
+00007810: 6c6c 2e70 6164 6469 6e67 5f69 6478 5d20  ll.padding_idx] 
+00007820: 3d20 300a 2020 2020 2020 2020 656c 6966  = 0.        elif
+00007830: 2069 7369 6e73 7461 6e63 6528 6365 6c6c   isinstance(cell
+00007840: 2c20 6e6e 2e4c 6179 6572 4e6f 726d 293a  , nn.LayerNorm):
+00007850: 0a20 2020 2020 2020 2020 2020 2063 656c  .            cel
+00007860: 6c2e 6269 6173 2e69 6e69 7469 616c 697a  l.bias.initializ
+00007870: 6528 277a 6572 6f73 2729 0a20 2020 2020  e('zeros').     
+00007880: 2020 2020 2020 2063 656c 6c2e 7765 6967         cell.weig
+00007890: 6874 2e69 6e69 7469 616c 697a 6528 276f  ht.initialize('o
+000078a0: 6e65 7327 290a 0a0a 636c 6173 7320 4272  nes')...class Br
+000078b0: 6f73 4d6f 6465 6c28 4272 6f73 5072 6554  osModel(BrosPreT
+000078c0: 7261 696e 6564 4d6f 6465 6c29 3a0a 2020  rainedModel):.  
+000078d0: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
+000078e0: 656c 662c 2063 6f6e 6669 672c 2061 6464  elf, config, add
+000078f0: 5f70 6f6f 6c69 6e67 5f6c 6179 6572 3d54  _pooling_layer=T
+00007900: 7275 6529 3a0a 2020 2020 2020 2020 7375  rue):.        su
+00007910: 7065 7228 292e 5f5f 696e 6974 5f5f 2863  per().__init__(c
+00007920: 6f6e 6669 6729 0a20 2020 2020 2020 2073  onfig).        s
+00007930: 656c 662e 636f 6e66 6967 203d 2063 6f6e  elf.config = con
+00007940: 6669 670a 0a20 2020 2020 2020 2073 656c  fig..        sel
+00007950: 662e 656d 6265 6464 696e 6773 203d 2042  f.embeddings = B
+00007960: 726f 7354 6578 7445 6d62 6564 6469 6e67  rosTextEmbedding
+00007970: 7328 636f 6e66 6967 290a 2020 2020 2020  s(config).      
+00007980: 2020 7365 6c66 2e62 626f 785f 656d 6265    self.bbox_embe
+00007990: 6464 696e 6773 203d 2042 726f 7342 626f  ddings = BrosBbo
+000079a0: 7845 6d62 6564 6469 6e67 7328 636f 6e66  xEmbeddings(conf
+000079b0: 6967 290a 2020 2020 2020 2020 7365 6c66  ig).        self
+000079c0: 2e65 6e63 6f64 6572 203d 2042 726f 7345  .encoder = BrosE
+000079d0: 6e63 6f64 6572 2863 6f6e 6669 6729 0a0a  ncoder(config)..
+000079e0: 2020 2020 2020 2020 7365 6c66 2e70 6f6f          self.poo
+000079f0: 6c65 7220 3d20 4272 6f73 506f 6f6c 6572  ler = BrosPooler
+00007a00: 2863 6f6e 6669 6729 2069 6620 6164 645f  (config) if add_
+00007a10: 706f 6f6c 696e 675f 6c61 7965 7220 656c  pooling_layer el
+00007a20: 7365 204e 6f6e 650a 0a20 2020 2020 2020  se None..       
+00007a30: 2073 656c 662e 696e 6974 5f77 6569 6768   self.init_weigh
+00007a40: 7473 2829 0a0a 2020 2020 6465 6620 6765  ts()..    def ge
+00007a50: 745f 696e 7075 745f 656d 6265 6464 696e  t_input_embeddin
+00007a60: 6773 2873 656c 6629 3a0a 2020 2020 2020  gs(self):.      
+00007a70: 2020 7265 7475 726e 2073 656c 662e 656d    return self.em
+00007a80: 6265 6464 696e 6773 2e77 6f72 645f 656d  beddings.word_em
+00007a90: 6265 6464 696e 6773 0a0a 2020 2020 6465  beddings..    de
+00007aa0: 6620 7365 745f 696e 7075 745f 656d 6265  f set_input_embe
+00007ab0: 6464 696e 6773 2873 656c 662c 2076 616c  ddings(self, val
+00007ac0: 7565 293a 0a20 2020 2020 2020 2073 656c  ue):.        sel
+00007ad0: 662e 656d 6265 6464 696e 6773 2e77 6f72  f.embeddings.wor
+00007ae0: 645f 656d 6265 6464 696e 6773 203d 2076  d_embeddings = v
+00007af0: 616c 7565 0a0a 2020 2020 6465 6620 5f70  alue..    def _p
+00007b00: 7275 6e65 5f68 6561 6473 2873 656c 662c  rune_heads(self,
+00007b10: 2068 6561 6473 5f74 6f5f 7072 756e 6529   heads_to_prune)
+00007b20: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+00007b30: 2020 2020 2020 5072 756e 6573 2068 6561        Prunes hea
+00007b40: 6473 206f 6620 7468 6520 6d6f 6465 6c2e  ds of the model.
+00007b50: 2068 6561 6473 5f74 6f5f 7072 756e 653a   heads_to_prune:
+00007b60: 2064 6963 7420 6f66 207b 6c61 7965 725f   dict of {layer_
+00007b70: 6e75 6d3a 206c 6973 7420 6f66 2068 6561  num: list of hea
+00007b80: 6473 2074 6f20 7072 756e 6520 696e 2074  ds to prune in t
+00007b90: 6869 7320 6c61 7965 727d 2053 6565 2062  his layer} See b
+00007ba0: 6173 650a 2020 2020 2020 2020 636c 6173  ase.        clas
+00007bb0: 7320 5072 6554 7261 696e 6564 4d6f 6465  s PreTrainedMode
+00007bc0: 6c0a 2020 2020 2020 2020 2222 220a 2020  l.        """.  
+00007bd0: 2020 2020 2020 666f 7220 6c61 7965 722c        for layer,
+00007be0: 2068 6561 6473 2069 6e20 6865 6164 735f   heads in heads_
+00007bf0: 746f 5f70 7275 6e65 2e69 7465 6d73 2829  to_prune.items()
+00007c00: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00007c10: 6c66 2e65 6e63 6f64 6572 2e6c 6179 6572  lf.encoder.layer
+00007c20: 5b6c 6179 6572 5d2e 6174 7465 6e74 696f  [layer].attentio
+00007c30: 6e2e 7072 756e 655f 6865 6164 7328 6865  n.prune_heads(he
+00007c40: 6164 7329 0a0a 2020 2020 6465 6620 636f  ads)..    def co
+00007c50: 6e73 7472 7563 7428 0a20 2020 2020 2020  nstruct(.       
+00007c60: 2073 656c 662c 0a20 2020 2020 2020 2069   self,.        i
+00007c70: 6e70 7574 5f69 6473 3a20 4f70 7469 6f6e  nput_ids: Option
+00007c80: 616c 5b6d 696e 6473 706f 7265 2e54 656e  al[mindspore.Ten
+00007c90: 736f 725d 203d 204e 6f6e 652c 0a20 2020  sor] = None,.   
+00007ca0: 2020 2020 2062 626f 783a 204f 7074 696f       bbox: Optio
+00007cb0: 6e61 6c5b 6d69 6e64 7370 6f72 652e 5465  nal[mindspore.Te
+00007cc0: 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a 2020  nsor] = None,.  
+00007cd0: 2020 2020 2020 6174 7465 6e74 696f 6e5f        attention_
+00007ce0: 6d61 736b 3a20 4f70 7469 6f6e 616c 5b6d  mask: Optional[m
+00007cf0: 696e 6473 706f 7265 2e54 656e 736f 725d  indspore.Tensor]
+00007d00: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00007d10: 2074 6f6b 656e 5f74 7970 655f 6964 733a   token_type_ids:
+00007d20: 204f 7074 696f 6e61 6c5b 6d69 6e64 7370   Optional[mindsp
+00007d30: 6f72 652e 5465 6e73 6f72 5d20 3d20 4e6f  ore.Tensor] = No
+00007d40: 6e65 2c0a 2020 2020 2020 2020 706f 7369  ne,.        posi
+00007d50: 7469 6f6e 5f69 6473 3a20 4f70 7469 6f6e  tion_ids: Option
+00007d60: 616c 5b6d 696e 6473 706f 7265 2e54 656e  al[mindspore.Ten
+00007d70: 736f 725d 203d 204e 6f6e 652c 0a20 2020  sor] = None,.   
+00007d80: 2020 2020 2068 6561 645f 6d61 736b 3a20       head_mask: 
+00007d90: 4f70 7469 6f6e 616c 5b6d 696e 6473 706f  Optional[mindspo
+00007da0: 7265 2e54 656e 736f 725d 203d 204e 6f6e  re.Tensor] = Non
+00007db0: 652c 0a20 2020 2020 2020 2069 6e70 7574  e,.        input
+00007dc0: 735f 656d 6265 6473 3a20 4f70 7469 6f6e  s_embeds: Option
+00007dd0: 616c 5b6d 696e 6473 706f 7265 2e54 656e  al[mindspore.Ten
+00007de0: 736f 725d 203d 204e 6f6e 652c 0a20 2020  sor] = None,.   
+00007df0: 2020 2020 2065 6e63 6f64 6572 5f68 6964       encoder_hid
+00007e00: 6465 6e5f 7374 6174 6573 3a20 4f70 7469  den_states: Opti
+00007e10: 6f6e 616c 5b6d 696e 6473 706f 7265 2e54  onal[mindspore.T
+00007e20: 656e 736f 725d 203d 204e 6f6e 652c 0a20  ensor] = None,. 
+00007e30: 2020 2020 2020 2065 6e63 6f64 6572 5f61         encoder_a
+00007e40: 7474 656e 7469 6f6e 5f6d 6173 6b3a 204f  ttention_mask: O
+00007e50: 7074 696f 6e61 6c5b 6d69 6e64 7370 6f72  ptional[mindspor
+00007e60: 652e 5465 6e73 6f72 5d20 3d20 4e6f 6e65  e.Tensor] = None
+00007e70: 2c0a 2020 2020 2020 2020 7061 7374 5f6b  ,.        past_k
+00007e80: 6579 5f76 616c 7565 733a 204f 7074 696f  ey_values: Optio
+00007e90: 6e61 6c5b 4c69 7374 5b6d 696e 6473 706f  nal[List[mindspo
+00007ea0: 7265 2e54 656e 736f 725d 5d20 3d20 4e6f  re.Tensor]] = No
+00007eb0: 6e65 2c0a 2020 2020 2020 2020 7573 655f  ne,.        use_
+00007ec0: 6361 6368 653a 204f 7074 696f 6e61 6c5b  cache: Optional[
+00007ed0: 626f 6f6c 5d20 3d20 4e6f 6e65 2c0a 2020  bool] = None,.  
+00007ee0: 2020 2020 2020 6f75 7470 7574 5f61 7474        output_att
+00007ef0: 656e 7469 6f6e 733a 204f 7074 696f 6e61  entions: Optiona
+00007f00: 6c5b 626f 6f6c 5d20 3d20 4e6f 6e65 2c0a  l[bool] = None,.
+00007f10: 2020 2020 2020 2020 6f75 7470 7574 5f68          output_h
+00007f20: 6964 6465 6e5f 7374 6174 6573 3a20 4f70  idden_states: Op
+00007f30: 7469 6f6e 616c 5b62 6f6f 6c5d 203d 204e  tional[bool] = N
+00007f40: 6f6e 652c 0a20 2020 2020 2020 2072 6574  one,.        ret
+00007f50: 7572 6e5f 6469 6374 3a20 4f70 7469 6f6e  urn_dict: Option
+00007f60: 616c 5b62 6f6f 6c5d 203d 204e 6f6e 652c  al[bool] = None,
+00007f70: 0a20 2020 2029 202d 3e20 556e 696f 6e5b  .    ) -> Union[
+00007f80: 5475 706c 655b 6d69 6e64 7370 6f72 652e  Tuple[mindspore.
+00007f90: 5465 6e73 6f72 5d2c 2042 6173 654d 6f64  Tensor], BaseMod
+00007fa0: 656c 4f75 7470 7574 5769 7468 506f 6f6c  elOutputWithPool
+00007fb0: 696e 6741 6e64 4372 6f73 7341 7474 656e  ingAndCrossAtten
+00007fc0: 7469 6f6e 735d 3a0a 2020 2020 2020 2020  tions]:.        
+00007fd0: 7222 2222 0a20 2020 2020 2020 2052 6574  r""".        Ret
+00007fe0: 7572 6e73 3a0a 0a20 2020 2020 2020 2045  urns:..        E
+00007ff0: 7861 6d70 6c65 733a 0a0a 2020 2020 2020  xamples:..      
+00008000: 2020 6060 6070 7974 686f 6e0a 2020 2020    ```python.    
+00008010: 2020 2020 3e3e 3e20 696d 706f 7274 2074      >>> import t
+00008020: 6f72 6368 0a20 2020 2020 2020 203e 3e3e  orch.        >>>
+00008030: 2066 726f 6d20 7472 616e 7366 6f72 6d65   from transforme
+00008040: 7273 2069 6d70 6f72 7420 4272 6f73 5072  rs import BrosPr
+00008050: 6f63 6573 736f 722c 2042 726f 734d 6f64  ocessor, BrosMod
+00008060: 656c 0a0a 2020 2020 2020 2020 3e3e 3e20  el..        >>> 
+00008070: 7072 6f63 6573 736f 7220 3d20 4272 6f73  processor = Bros
+00008080: 5072 6f63 6573 736f 722e 6672 6f6d 5f70  Processor.from_p
+00008090: 7265 7472 6169 6e65 6428 226a 696e 686f  retrained("jinho
+000080a0: 3833 3435 2f62 726f 732d 6261 7365 2d75  8345/bros-base-u
+000080b0: 6e63 6173 6564 2229 0a0a 2020 2020 2020  ncased")..      
+000080c0: 2020 3e3e 3e20 6d6f 6465 6c20 3d20 4272    >>> model = Br
+000080d0: 6f73 4d6f 6465 6c2e 6672 6f6d 5f70 7265  osModel.from_pre
+000080e0: 7472 6169 6e65 6428 226a 696e 686f 3833  trained("jinho83
+000080f0: 3435 2f62 726f 732d 6261 7365 2d75 6e63  45/bros-base-unc
+00008100: 6173 6564 2229 0a0a 2020 2020 2020 2020  ased")..        
+00008110: 3e3e 3e20 656e 636f 6469 6e67 203d 2070  >>> encoding = p
+00008120: 726f 6365 7373 6f72 2822 4865 6c6c 6f2c  rocessor("Hello,
+00008130: 206d 7920 646f 6720 6973 2063 7574 6522   my dog is cute"
+00008140: 2c20 6164 645f 7370 6563 6961 6c5f 746f  , add_special_to
+00008150: 6b65 6e73 3d46 616c 7365 2c20 7265 7475  kens=False, retu
+00008160: 726e 5f74 656e 736f 7273 3d22 7074 2229  rn_tensors="pt")
+00008170: 0a20 2020 2020 2020 203e 3e3e 2062 626f  .        >>> bbo
+00008180: 7820 3d20 746f 7263 682e 7465 6e73 6f72  x = torch.tensor
+00008190: 285b 5b5b 302c 2030 2c20 312c 2031 5d5d  ([[[0, 0, 1, 1]]
+000081a0: 5d29 2e72 6570 6561 7428 312c 2065 6e63  ]).repeat(1, enc
+000081b0: 6f64 696e 675b 2269 6e70 7574 5f69 6473  oding["input_ids
+000081c0: 225d 2e73 6861 7065 5b2d 315d 2c20 3129  "].shape[-1], 1)
+000081d0: 0a20 2020 2020 2020 203e 3e3e 2065 6e63  .        >>> enc
+000081e0: 6f64 696e 675b 2262 626f 7822 5d20 3d20  oding["bbox"] = 
+000081f0: 6262 6f78 0a0a 2020 2020 2020 2020 3e3e  bbox..        >>
+00008200: 3e20 6f75 7470 7574 7320 3d20 6d6f 6465  > outputs = mode
+00008210: 6c28 2a2a 656e 636f 6469 6e67 290a 2020  l(**encoding).  
+00008220: 2020 2020 2020 3e3e 3e20 6c61 7374 5f68        >>> last_h
+00008230: 6964 6465 6e5f 7374 6174 6573 203d 206f  idden_states = o
+00008240: 7574 7075 7473 2e6c 6173 745f 6869 6464  utputs.last_hidd
+00008250: 656e 5f73 7461 7465 0a20 2020 2020 2020  en_state.       
+00008260: 2060 6060 2222 220a 2020 2020 2020 2020   ```""".        
+00008270: 6f75 7470 7574 5f61 7474 656e 7469 6f6e  output_attention
+00008280: 7320 3d20 6f75 7470 7574 5f61 7474 656e  s = output_atten
+00008290: 7469 6f6e 7320 6966 206f 7574 7075 745f  tions if output_
+000082a0: 6174 7465 6e74 696f 6e73 2069 7320 6e6f  attentions is no
+000082b0: 7420 4e6f 6e65 2065 6c73 6520 7365 6c66  t None else self
+000082c0: 2e63 6f6e 6669 672e 6f75 7470 7574 5f61  .config.output_a
+000082d0: 7474 656e 7469 6f6e 730a 2020 2020 2020  ttentions.      
+000082e0: 2020 6f75 7470 7574 5f68 6964 6465 6e5f    output_hidden_
+000082f0: 7374 6174 6573 203d 2028 0a20 2020 2020  states = (.     
+00008300: 2020 2020 2020 206f 7574 7075 745f 6869         output_hi
+00008310: 6464 656e 5f73 7461 7465 7320 6966 206f  dden_states if o
+00008320: 7574 7075 745f 6869 6464 656e 5f73 7461  utput_hidden_sta
+00008330: 7465 7320 6973 206e 6f74 204e 6f6e 6520  tes is not None 
+00008340: 656c 7365 2073 656c 662e 636f 6e66 6967  else self.config
+00008350: 2e6f 7574 7075 745f 6869 6464 656e 5f73  .output_hidden_s
+00008360: 7461 7465 730a 2020 2020 2020 2020 290a  tates.        ).
+00008370: 2020 2020 2020 2020 7265 7475 726e 5f64          return_d
+00008380: 6963 7420 3d20 7265 7475 726e 5f64 6963  ict = return_dic
+00008390: 7420 6966 2072 6574 7572 6e5f 6469 6374  t if return_dict
+000083a0: 2069 7320 6e6f 7420 4e6f 6e65 2065 6c73   is not None els
+000083b0: 6520 7365 6c66 2e63 6f6e 6669 672e 7573  e self.config.us
+000083c0: 655f 7265 7475 726e 5f64 6963 740a 0a20  e_return_dict.. 
+000083d0: 2020 2020 2020 2069 6620 7365 6c66 2e63         if self.c
+000083e0: 6f6e 6669 672e 6973 5f64 6563 6f64 6572  onfig.is_decoder
+000083f0: 3a0a 2020 2020 2020 2020 2020 2020 7573  :.            us
+00008400: 655f 6361 6368 6520 3d20 7573 655f 6361  e_cache = use_ca
+00008410: 6368 6520 6966 2075 7365 5f63 6163 6865  che if use_cache
+00008420: 2069 7320 6e6f 7420 4e6f 6e65 2065 6c73   is not None els
+00008430: 6520 7365 6c66 2e63 6f6e 6669 672e 7573  e self.config.us
+00008440: 655f 6361 6368 650a 2020 2020 2020 2020  e_cache.        
+00008450: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00008460: 2020 7573 655f 6361 6368 6520 3d20 4661    use_cache = Fa
+00008470: 6c73 650a 0a20 2020 2020 2020 2069 6620  lse..        if 
+00008480: 696e 7075 745f 6964 7320 6973 206e 6f74  input_ids is not
+00008490: 204e 6f6e 6520 616e 6420 696e 7075 7473   None and inputs
+000084a0: 5f65 6d62 6564 7320 6973 206e 6f74 204e  _embeds is not N
+000084b0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+000084c0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
+000084d0: 7228 2259 6f75 2063 616e 6e6f 7420 7370  r("You cannot sp
+000084e0: 6563 6966 7920 626f 7468 2069 6e70 7574  ecify both input
+000084f0: 5f69 6473 2061 6e64 2069 6e70 7574 735f  _ids and inputs_
+00008500: 656d 6265 6473 2061 7420 7468 6520 7361  embeds at the sa
+00008510: 6d65 2074 696d 6522 290a 2020 2020 2020  me time").      
+00008520: 2020 656c 6966 2069 6e70 7574 5f69 6473    elif input_ids
+00008530: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00008540: 2020 2020 2020 2020 2020 696e 7075 745f            input_
+00008550: 7368 6170 6520 3d20 696e 7075 745f 6964  shape = input_id
+00008560: 732e 7368 6170 650a 2020 2020 2020 2020  s.shape.        
+00008570: 656c 6966 2069 6e70 7574 735f 656d 6265  elif inputs_embe
+00008580: 6473 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ds is not None:.
+00008590: 2020 2020 2020 2020 2020 2020 696e 7075              inpu
+000085a0: 745f 7368 6170 6520 3d20 696e 7075 7473  t_shape = inputs
+000085b0: 5f65 6d62 6564 732e 7368 6170 655b 3a2d  _embeds.shape[:-
+000085c0: 315d 0a20 2020 2020 2020 2065 6c73 653a  1].        else:
+000085d0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+000085e0: 7365 2056 616c 7565 4572 726f 7228 2259  se ValueError("Y
+000085f0: 6f75 2068 6176 6520 746f 2073 7065 6369  ou have to speci
+00008600: 6679 2065 6974 6865 7220 696e 7075 745f  fy either input_
+00008610: 6964 7320 6f72 2069 6e70 7574 735f 656d  ids or inputs_em
+00008620: 6265 6473 2229 0a0a 2020 2020 2020 2020  beds")..        
+00008630: 6966 2062 626f 7820 6973 204e 6f6e 653a  if bbox is None:
+00008640: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+00008650: 7365 2056 616c 7565 4572 726f 7228 2259  se ValueError("Y
+00008660: 6f75 2068 6176 6520 746f 2073 7065 6369  ou have to speci
+00008670: 6679 2062 626f 7822 290a 0a20 2020 2020  fy bbox")..     
+00008680: 2020 2062 6174 6368 5f73 697a 652c 2073     batch_size, s
+00008690: 6571 5f6c 656e 6774 6820 3d20 696e 7075  eq_length = inpu
+000086a0: 745f 7368 6170 650a 0a20 2020 2020 2020  t_shape..       
+000086b0: 2023 2070 6173 745f 6b65 795f 7661 6c75   # past_key_valu
+000086c0: 6573 5f6c 656e 6774 680a 2020 2020 2020  es_length.      
+000086d0: 2020 7061 7374 5f6b 6579 5f76 616c 7565    past_key_value
+000086e0: 735f 6c65 6e67 7468 203d 2070 6173 745f  s_length = past_
+000086f0: 6b65 795f 7661 6c75 6573 5b30 5d5b 305d  key_values[0][0]
+00008700: 2e73 6861 7065 5b32 5d20 6966 2070 6173  .shape[2] if pas
+00008710: 745f 6b65 795f 7661 6c75 6573 2069 7320  t_key_values is 
+00008720: 6e6f 7420 4e6f 6e65 2065 6c73 6520 300a  not None else 0.
+00008730: 0a20 2020 2020 2020 2069 6620 6174 7465  .        if atte
+00008740: 6e74 696f 6e5f 6d61 736b 2069 7320 4e6f  ntion_mask is No
+00008750: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00008760: 6174 7465 6e74 696f 6e5f 6d61 736b 203d  attention_mask =
+00008770: 206f 7073 2e6f 6e65 7328 696e 7075 745f   ops.ones(input_
+00008780: 7368 6170 6529 0a0a 2020 2020 2020 2020  shape)..        
+00008790: 6966 2074 6f6b 656e 5f74 7970 655f 6964  if token_type_id
+000087a0: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
+000087b0: 2020 2020 2020 2069 6620 6861 7361 7474         if hasatt
+000087c0: 7228 7365 6c66 2e65 6d62 6564 6469 6e67  r(self.embedding
+000087d0: 732c 2022 746f 6b65 6e5f 7479 7065 5f69  s, "token_type_i
+000087e0: 6473 2229 3a0a 2020 2020 2020 2020 2020  ds"):.          
+000087f0: 2020 2020 2020 6275 6666 6572 6564 5f74        buffered_t
+00008800: 6f6b 656e 5f74 7970 655f 6964 7320 3d20  oken_type_ids = 
+00008810: 7365 6c66 2e65 6d62 6564 6469 6e67 732e  self.embeddings.
+00008820: 746f 6b65 6e5f 7479 7065 5f69 6473 5b3a  token_type_ids[:
+00008830: 2c20 3a73 6571 5f6c 656e 6774 685d 0a20  , :seq_length]. 
+00008840: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+00008850: 7566 6665 7265 645f 746f 6b65 6e5f 7479  uffered_token_ty
+00008860: 7065 5f69 6473 5f65 7870 616e 6465 6420  pe_ids_expanded 
+00008870: 3d20 6275 6666 6572 6564 5f74 6f6b 656e  = buffered_token
+00008880: 5f74 7970 655f 6964 732e 6578 7061 6e64  _type_ids.expand
+00008890: 2862 6174 6368 5f73 697a 652c 2073 6571  (batch_size, seq
+000088a0: 5f6c 656e 6774 6829 0a20 2020 2020 2020  _length).       
+000088b0: 2020 2020 2020 2020 2074 6f6b 656e 5f74           token_t
+000088c0: 7970 655f 6964 7320 3d20 6275 6666 6572  ype_ids = buffer
+000088d0: 6564 5f74 6f6b 656e 5f74 7970 655f 6964  ed_token_type_id
+000088e0: 735f 6578 7061 6e64 6564 0a20 2020 2020  s_expanded.     
+000088f0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00008900: 2020 2020 2020 2020 2020 2020 2074 6f6b               tok
+00008910: 656e 5f74 7970 655f 6964 7320 3d20 6f70  en_type_ids = op
+00008920: 732e 7a65 726f 7328 696e 7075 745f 7368  s.zeros(input_sh
+00008930: 6170 652c 2064 7479 7065 3d6d 696e 6473  ape, dtype=minds
+00008940: 706f 7265 2e69 6e74 3634 290a 0a20 2020  pore.int64)..   
+00008950: 2020 2020 2023 2057 6520 6361 6e20 7072       # We can pr
+00008960: 6f76 6964 6520 6120 7365 6c66 2d61 7474  ovide a self-att
+00008970: 656e 7469 6f6e 206d 6173 6b20 6f66 2064  ention mask of d
+00008980: 696d 656e 7369 6f6e 7320 5b62 6174 6368  imensions [batch
+00008990: 5f73 697a 652c 2066 726f 6d5f 7365 715f  _size, from_seq_
+000089a0: 6c65 6e67 7468 2c20 746f 5f73 6571 5f6c  length, to_seq_l
+000089b0: 656e 6774 685d 0a20 2020 2020 2020 2023  ength].        #
+000089c0: 206f 7572 7365 6c76 6573 2069 6e20 7768   ourselves in wh
+000089d0: 6963 6820 6361 7365 2077 6520 6a75 7374  ich case we just
+000089e0: 206e 6565 6420 746f 206d 616b 6520 6974   need to make it
+000089f0: 2062 726f 6164 6361 7374 6162 6c65 2074   broadcastable t
+00008a00: 6f20 616c 6c20 6865 6164 732e 0a20 2020  o all heads..   
+00008a10: 2020 2020 2065 7874 656e 6465 645f 6174       extended_at
+00008a20: 7465 6e74 696f 6e5f 6d61 736b 3a20 6d69  tention_mask: mi
+00008a30: 6e64 7370 6f72 652e 5465 6e73 6f72 203d  ndspore.Tensor =
+00008a40: 2073 656c 662e 6765 745f 6578 7465 6e64   self.get_extend
+00008a50: 6564 5f61 7474 656e 7469 6f6e 5f6d 6173  ed_attention_mas
+00008a60: 6b28 6174 7465 6e74 696f 6e5f 6d61 736b  k(attention_mask
+00008a70: 2c20 696e 7075 745f 7368 6170 6529 0a0a  , input_shape)..
+00008a80: 2020 2020 2020 2020 2320 4966 2061 2032          # If a 2
+00008a90: 4420 6f72 2033 4420 6174 7465 6e74 696f  D or 3D attentio
+00008aa0: 6e20 6d61 736b 2069 7320 7072 6f76 6964  n mask is provid
+00008ab0: 6564 2066 6f72 2074 6865 2063 726f 7373  ed for the cross
+00008ac0: 2d61 7474 656e 7469 6f6e 0a20 2020 2020  -attention.     
+00008ad0: 2020 2023 2077 6520 6e65 6564 2074 6f20     # we need to 
+00008ae0: 6d61 6b65 2062 726f 6164 6361 7374 6162  make broadcastab
+00008af0: 6c65 2074 6f20 5b62 6174 6368 5f73 697a  le to [batch_siz
+00008b00: 652c 206e 756d 5f68 6561 6473 2c20 7365  e, num_heads, se
+00008b10: 715f 6c65 6e67 7468 2c20 7365 715f 6c65  q_length, seq_le
+00008b20: 6e67 7468 5d0a 2020 2020 2020 2020 6966  ngth].        if
+00008b30: 2073 656c 662e 636f 6e66 6967 2e69 735f   self.config.is_
+00008b40: 6465 636f 6465 7220 616e 6420 656e 636f  decoder and enco
+00008b50: 6465 725f 6869 6464 656e 5f73 7461 7465  der_hidden_state
+00008b60: 7320 6973 206e 6f74 204e 6f6e 653a 0a20  s is not None:. 
+00008b70: 2020 2020 2020 2020 2020 2065 6e63 6f64             encod
+00008b80: 6572 5f62 6174 6368 5f73 697a 652c 2065  er_batch_size, e
+00008b90: 6e63 6f64 6572 5f73 6571 7565 6e63 655f  ncoder_sequence_
+00008ba0: 6c65 6e67 7468 2c20 5f20 3d20 656e 636f  length, _ = enco
+00008bb0: 6465 725f 6869 6464 656e 5f73 7461 7465  der_hidden_state
+00008bc0: 732e 7368 6170 650a 2020 2020 2020 2020  s.shape.        
+00008bd0: 2020 2020 656e 636f 6465 725f 6869 6464      encoder_hidd
+00008be0: 656e 5f73 6861 7065 203d 2028 656e 636f  en_shape = (enco
+00008bf0: 6465 725f 6261 7463 685f 7369 7a65 2c20  der_batch_size, 
+00008c00: 656e 636f 6465 725f 7365 7175 656e 6365  encoder_sequence
+00008c10: 5f6c 656e 6774 6829 0a20 2020 2020 2020  _length).       
+00008c20: 2020 2020 2069 6620 656e 636f 6465 725f       if encoder_
+00008c30: 6174 7465 6e74 696f 6e5f 6d61 736b 2069  attention_mask i
+00008c40: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+00008c50: 2020 2020 2020 2020 656e 636f 6465 725f          encoder_
+00008c60: 6174 7465 6e74 696f 6e5f 6d61 736b 203d  attention_mask =
+00008c70: 206f 7073 2e6f 6e65 7328 656e 636f 6465   ops.ones(encode
+00008c80: 725f 6869 6464 656e 5f73 6861 7065 290a  r_hidden_shape).
+00008c90: 2020 2020 2020 2020 2020 2020 656e 636f              enco
+00008ca0: 6465 725f 6578 7465 6e64 6564 5f61 7474  der_extended_att
+00008cb0: 656e 7469 6f6e 5f6d 6173 6b20 3d20 7365  ention_mask = se
+00008cc0: 6c66 2e69 6e76 6572 745f 6174 7465 6e74  lf.invert_attent
+00008cd0: 696f 6e5f 6d61 736b 2865 6e63 6f64 6572  ion_mask(encoder
+00008ce0: 5f61 7474 656e 7469 6f6e 5f6d 6173 6b29  _attention_mask)
+00008cf0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00008d00: 2020 2020 2020 2020 2020 2065 6e63 6f64             encod
+00008d10: 6572 5f65 7874 656e 6465 645f 6174 7465  er_extended_atte
+00008d20: 6e74 696f 6e5f 6d61 736b 203d 204e 6f6e  ntion_mask = Non
+00008d30: 650a 0a20 2020 2020 2020 2023 2050 7265  e..        # Pre
+00008d40: 7061 7265 2068 6561 6420 6d61 736b 2069  pare head mask i
+00008d50: 6620 6e65 6564 6564 0a20 2020 2020 2020  f needed.       
+00008d60: 2023 2031 2e30 2069 6e20 6865 6164 5f6d   # 1.0 in head_m
+00008d70: 6173 6b20 696e 6469 6361 7465 2077 6520  ask indicate we 
+00008d80: 6b65 6570 2074 6865 2068 6561 640a 2020  keep the head.  
+00008d90: 2020 2020 2020 2320 6174 7465 6e74 696f        # attentio
+00008da0: 6e5f 7072 6f62 7320 6861 7320 7368 6170  n_probs has shap
+00008db0: 6520 6273 7a20 7820 6e5f 6865 6164 7320  e bsz x n_heads 
+00008dc0: 7820 4e20 7820 4e0a 2020 2020 2020 2020  x N x N.        
+00008dd0: 2320 696e 7075 7420 6865 6164 5f6d 6173  # input head_mas
+00008de0: 6b20 6861 7320 7368 6170 6520 5b6e 756d  k has shape [num
+00008df0: 5f68 6561 6473 5d20 6f72 205b 6e75 6d5f  _heads] or [num_
+00008e00: 6869 6464 656e 5f6c 6179 6572 7320 7820  hidden_layers x 
+00008e10: 6e75 6d5f 6865 6164 735d 0a20 2020 2020  num_heads].     
+00008e20: 2020 2023 2061 6e64 2068 6561 645f 6d61     # and head_ma
+00008e30: 736b 2069 7320 636f 6e76 6572 7465 6420  sk is converted 
+00008e40: 746f 2073 6861 7065 205b 6e75 6d5f 6869  to shape [num_hi
+00008e50: 6464 656e 5f6c 6179 6572 7320 7820 6261  dden_layers x ba
+00008e60: 7463 6820 7820 6e75 6d5f 6865 6164 7320  tch x num_heads 
+00008e70: 7820 7365 715f 6c65 6e67 7468 2078 2073  x seq_length x s
+00008e80: 6571 5f6c 656e 6774 685d 0a20 2020 2020  eq_length].     
+00008e90: 2020 2068 6561 645f 6d61 736b 203d 2073     head_mask = s
+00008ea0: 656c 662e 6765 745f 6865 6164 5f6d 6173  elf.get_head_mas
+00008eb0: 6b28 6865 6164 5f6d 6173 6b2c 2073 656c  k(head_mask, sel
+00008ec0: 662e 636f 6e66 6967 2e6e 756d 5f68 6964  f.config.num_hid
+00008ed0: 6465 6e5f 6c61 7965 7273 290a 0a20 2020  den_layers)..   
+00008ee0: 2020 2020 2065 6d62 6564 6469 6e67 5f6f       embedding_o
+00008ef0: 7574 7075 7420 3d20 7365 6c66 2e65 6d62  utput = self.emb
+00008f00: 6564 6469 6e67 7328 0a20 2020 2020 2020  eddings(.       
+00008f10: 2020 2020 2069 6e70 7574 5f69 6473 3d69       input_ids=i
+00008f20: 6e70 7574 5f69 6473 2c0a 2020 2020 2020  nput_ids,.      
+00008f30: 2020 2020 2020 706f 7369 7469 6f6e 5f69        position_i
+00008f40: 6473 3d70 6f73 6974 696f 6e5f 6964 732c  ds=position_ids,
+00008f50: 0a20 2020 2020 2020 2020 2020 2074 6f6b  .            tok
+00008f60: 656e 5f74 7970 655f 6964 733d 746f 6b65  en_type_ids=toke
+00008f70: 6e5f 7479 7065 5f69 6473 2c0a 2020 2020  n_type_ids,.    
+00008f80: 2020 2020 2020 2020 696e 7075 7473 5f65          inputs_e
+00008f90: 6d62 6564 733d 696e 7075 7473 5f65 6d62  mbeds=inputs_emb
+00008fa0: 6564 732c 0a20 2020 2020 2020 2020 2020  eds,.           
+00008fb0: 2070 6173 745f 6b65 795f 7661 6c75 6573   past_key_values
+00008fc0: 5f6c 656e 6774 683d 7061 7374 5f6b 6579  _length=past_key
+00008fd0: 5f76 616c 7565 735f 6c65 6e67 7468 2c0a  _values_length,.
+00008fe0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00008ff0: 2020 2023 2069 6620 6262 6f78 2068 6173     # if bbox has
+00009000: 2032 2070 6f69 6e74 7320 2834 2066 6c6f   2 points (4 flo
+00009010: 6174 2074 656e 736f 7273 2920 7065 7220  at tensors) per 
+00009020: 746f 6b65 6e2c 2063 6f6e 7665 7274 2069  token, convert i
+00009030: 7420 746f 2034 2070 6f69 6e74 7320 2838  t to 4 points (8
+00009040: 2066 6c6f 6174 2074 656e 736f 7273 2920   float tensors) 
+00009050: 7065 7220 746f 6b65 6e0a 2020 2020 2020  per token.      
+00009060: 2020 6966 2062 626f 782e 7368 6170 655b    if bbox.shape[
+00009070: 2d31 5d20 3d3d 2034 3a0a 2020 2020 2020  -1] == 4:.      
+00009080: 2020 2020 2020 6262 6f78 203d 2062 626f        bbox = bbo
+00009090: 785b 3a2c 203a 2c20 5b30 2c20 312c 2032  x[:, :, [0, 1, 2
+000090a0: 2c20 312c 2032 2c20 332c 2030 2c20 335d  , 1, 2, 3, 0, 3]
+000090b0: 5d0a 2020 2020 2020 2020 7363 616c 6564  ].        scaled
+000090c0: 5f62 626f 7820 3d20 6262 6f78 202a 2073  _bbox = bbox * s
+000090d0: 656c 662e 636f 6e66 6967 2e62 626f 785f  elf.config.bbox_
+000090e0: 7363 616c 650a 2020 2020 2020 2020 6262  scale.        bb
+000090f0: 6f78 5f70 6f73 6974 696f 6e5f 656d 6265  ox_position_embe
+00009100: 6464 696e 6773 203d 2073 656c 662e 6262  ddings = self.bb
+00009110: 6f78 5f65 6d62 6564 6469 6e67 7328 7363  ox_embeddings(sc
+00009120: 616c 6564 5f62 626f 7829 0a0a 2020 2020  aled_bbox)..    
+00009130: 2020 2020 656e 636f 6465 725f 6f75 7470      encoder_outp
+00009140: 7574 7320 3d20 7365 6c66 2e65 6e63 6f64  uts = self.encod
+00009150: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
+00009160: 656d 6265 6464 696e 675f 6f75 7470 7574  embedding_output
+00009170: 2c0a 2020 2020 2020 2020 2020 2020 6262  ,.            bb
+00009180: 6f78 5f70 6f73 5f65 6d62 3d62 626f 785f  ox_pos_emb=bbox_
+00009190: 706f 7369 7469 6f6e 5f65 6d62 6564 6469  position_embeddi
+000091a0: 6e67 732c 0a20 2020 2020 2020 2020 2020  ngs,.           
+000091b0: 2061 7474 656e 7469 6f6e 5f6d 6173 6b3d   attention_mask=
+000091c0: 6578 7465 6e64 6564 5f61 7474 656e 7469  extended_attenti
+000091d0: 6f6e 5f6d 6173 6b2c 0a20 2020 2020 2020  on_mask,.       
+000091e0: 2020 2020 2068 6561 645f 6d61 736b 3d68       head_mask=h
+000091f0: 6561 645f 6d61 736b 2c0a 2020 2020 2020  ead_mask,.      
+00009200: 2020 2020 2020 656e 636f 6465 725f 6869        encoder_hi
+00009210: 6464 656e 5f73 7461 7465 733d 656e 636f  dden_states=enco
+00009220: 6465 725f 6869 6464 656e 5f73 7461 7465  der_hidden_state
+00009230: 732c 0a20 2020 2020 2020 2020 2020 2065  s,.            e
+00009240: 6e63 6f64 6572 5f61 7474 656e 7469 6f6e  ncoder_attention
+00009250: 5f6d 6173 6b3d 656e 636f 6465 725f 6578  _mask=encoder_ex
+00009260: 7465 6e64 6564 5f61 7474 656e 7469 6f6e  tended_attention
+00009270: 5f6d 6173 6b2c 0a20 2020 2020 2020 2020  _mask,.         
+00009280: 2020 2070 6173 745f 6b65 795f 7661 6c75     past_key_valu
+00009290: 6573 3d70 6173 745f 6b65 795f 7661 6c75  es=past_key_valu
+000092a0: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+000092b0: 7573 655f 6361 6368 653d 7573 655f 6361  use_cache=use_ca
+000092c0: 6368 652c 0a20 2020 2020 2020 2020 2020  che,.           
+000092d0: 206f 7574 7075 745f 6174 7465 6e74 696f   output_attentio
+000092e0: 6e73 3d6f 7574 7075 745f 6174 7465 6e74  ns=output_attent
+000092f0: 696f 6e73 2c0a 2020 2020 2020 2020 2020  ions,.          
+00009300: 2020 6f75 7470 7574 5f68 6964 6465 6e5f    output_hidden_
+00009310: 7374 6174 6573 3d6f 7574 7075 745f 6869  states=output_hi
+00009320: 6464 656e 5f73 7461 7465 732c 0a20 2020  dden_states,.   
+00009330: 2020 2020 2020 2020 2072 6574 7572 6e5f           return_
+00009340: 6469 6374 3d72 6574 7572 6e5f 6469 6374  dict=return_dict
+00009350: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
+00009360: 2020 2020 7365 7175 656e 6365 5f6f 7574      sequence_out
+00009370: 7075 7420 3d20 656e 636f 6465 725f 6f75  put = encoder_ou
+00009380: 7470 7574 735b 305d 0a20 2020 2020 2020  tputs[0].       
+00009390: 2070 6f6f 6c65 645f 6f75 7470 7574 203d   pooled_output =
+000093a0: 2073 656c 662e 706f 6f6c 6572 2873 6571   self.pooler(seq
+000093b0: 7565 6e63 655f 6f75 7470 7574 2920 6966  uence_output) if
+000093c0: 2073 656c 662e 706f 6f6c 6572 2069 7320   self.pooler is 
+000093d0: 6e6f 7420 4e6f 6e65 2065 6c73 6520 4e6f  not None else No
+000093e0: 6e65 0a0a 2020 2020 2020 2020 6966 206e  ne..        if n
+000093f0: 6f74 2072 6574 7572 6e5f 6469 6374 3a0a  ot return_dict:.
+00009400: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00009410: 726e 2028 7365 7175 656e 6365 5f6f 7574  rn (sequence_out
+00009420: 7075 742c 2070 6f6f 6c65 645f 6f75 7470  put, pooled_outp
+00009430: 7574 2920 2b20 656e 636f 6465 725f 6f75  ut) + encoder_ou
+00009440: 7470 7574 735b 313a 5d0a 0a20 2020 2020  tputs[1:]..     
+00009450: 2020 2072 6574 7572 6e20 4261 7365 4d6f     return BaseMo
+00009460: 6465 6c4f 7574 7075 7457 6974 6850 6f6f  delOutputWithPoo
+00009470: 6c69 6e67 416e 6443 726f 7373 4174 7465  lingAndCrossAtte
+00009480: 6e74 696f 6e73 280a 2020 2020 2020 2020  ntions(.        
+00009490: 2020 2020 6c61 7374 5f68 6964 6465 6e5f      last_hidden_
+000094a0: 7374 6174 653d 7365 7175 656e 6365 5f6f  state=sequence_o
+000094b0: 7574 7075 742c 0a20 2020 2020 2020 2020  utput,.         
+000094c0: 2020 2070 6f6f 6c65 725f 6f75 7470 7574     pooler_output
+000094d0: 3d70 6f6f 6c65 645f 6f75 7470 7574 2c0a  =pooled_output,.
+000094e0: 2020 2020 2020 2020 2020 2020 7061 7374              past
+000094f0: 5f6b 6579 5f76 616c 7565 733d 656e 636f  _key_values=enco
+00009500: 6465 725f 6f75 7470 7574 732e 7061 7374  der_outputs.past
+00009510: 5f6b 6579 5f76 616c 7565 732c 0a20 2020  _key_values,.   
+00009520: 2020 2020 2020 2020 2068 6964 6465 6e5f           hidden_
+00009530: 7374 6174 6573 3d65 6e63 6f64 6572 5f6f  states=encoder_o
+00009540: 7574 7075 7473 2e68 6964 6465 6e5f 7374  utputs.hidden_st
+00009550: 6174 6573 2c0a 2020 2020 2020 2020 2020  ates,.          
+00009560: 2020 6174 7465 6e74 696f 6e73 3d65 6e63    attentions=enc
+00009570: 6f64 6572 5f6f 7574 7075 7473 2e61 7474  oder_outputs.att
+00009580: 656e 7469 6f6e 732c 0a20 2020 2020 2020  entions,.       
+00009590: 2020 2020 2063 726f 7373 5f61 7474 656e       cross_atten
+000095a0: 7469 6f6e 733d 656e 636f 6465 725f 6f75  tions=encoder_ou
+000095b0: 7470 7574 732e 6372 6f73 735f 6174 7465  tputs.cross_atte
+000095c0: 6e74 696f 6e73 2c0a 2020 2020 2020 2020  ntions,.        
+000095d0: 290a 0a0a 636c 6173 7320 4272 6f73 466f  )...class BrosFo
+000095e0: 7254 6f6b 656e 436c 6173 7369 6669 6361  rTokenClassifica
+000095f0: 7469 6f6e 2842 726f 7350 7265 5472 6169  tion(BrosPreTrai
+00009600: 6e65 644d 6f64 656c 293a 0a20 2020 205f  nedModel):.    _
+00009610: 6b65 7973 5f74 6f5f 6967 6e6f 7265 5f6f  keys_to_ignore_o
+00009620: 6e5f 6c6f 6164 5f75 6e65 7870 6563 7465  n_load_unexpecte
+00009630: 6420 3d20 5b72 2270 6f6f 6c65 7222 5d0a  d = [r"pooler"].
+00009640: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+00009650: 5f28 7365 6c66 2c20 636f 6e66 6967 293a  _(self, config):
+00009660: 0a20 2020 2020 2020 2073 7570 6572 2829  .        super()
+00009670: 2e5f 5f69 6e69 745f 5f28 636f 6e66 6967  .__init__(config
+00009680: 290a 2020 2020 2020 2020 7365 6c66 2e6e  ).        self.n
+00009690: 756d 5f6c 6162 656c 7320 3d20 636f 6e66  um_labels = conf
+000096a0: 6967 2e6e 756d 5f6c 6162 656c 730a 0a20  ig.num_labels.. 
+000096b0: 2020 2020 2020 2073 656c 662e 6272 6f73         self.bros
+000096c0: 203d 2042 726f 734d 6f64 656c 2863 6f6e   = BrosModel(con
+000096d0: 6669 6729 0a20 2020 2020 2020 2063 6c61  fig).        cla
+000096e0: 7373 6966 6965 725f 6472 6f70 6f75 7420  ssifier_dropout 
+000096f0: 3d20 280a 2020 2020 2020 2020 2020 2020  = (.            
+00009700: 636f 6e66 6967 2e63 6c61 7373 6966 6965  config.classifie
+00009710: 725f 6472 6f70 6f75 7420 6966 2068 6173  r_dropout if has
+00009720: 6174 7472 2863 6f6e 6669 672c 2022 636c  attr(config, "cl
+00009730: 6173 7369 6669 6572 5f64 726f 706f 7574  assifier_dropout
+00009740: 2229 2065 6c73 6520 636f 6e66 6967 2e68  ") else config.h
+00009750: 6964 6465 6e5f 6472 6f70 6f75 745f 7072  idden_dropout_pr
+00009760: 6f62 0a20 2020 2020 2020 2029 0a20 2020  ob.        ).   
+00009770: 2020 2020 2073 656c 662e 6472 6f70 6f75       self.dropou
+00009780: 7420 3d20 6e6e 2e44 726f 706f 7574 2870  t = nn.Dropout(p
+00009790: 3d63 6c61 7373 6966 6965 725f 6472 6f70  =classifier_drop
+000097a0: 6f75 7429 0a20 2020 2020 2020 2073 656c  out).        sel
+000097b0: 662e 636c 6173 7369 6669 6572 203d 206e  f.classifier = n
+000097c0: 6e2e 4465 6e73 6528 636f 6e66 6967 2e68  n.Dense(config.h
+000097d0: 6964 6465 6e5f 7369 7a65 2c20 636f 6e66  idden_size, conf
+000097e0: 6967 2e6e 756d 5f6c 6162 656c 7329 0a0a  ig.num_labels)..
+000097f0: 2020 2020 2020 2020 7365 6c66 2e69 6e69          self.ini
+00009800: 745f 7765 6967 6874 7328 290a 0a20 2020  t_weights()..   
+00009810: 2064 6566 2063 6f6e 7374 7275 6374 280a   def construct(.
+00009820: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+00009830: 2020 2020 2020 696e 7075 745f 6964 733a        input_ids:
+00009840: 204f 7074 696f 6e61 6c5b 6d69 6e64 7370   Optional[mindsp
+00009850: 6f72 652e 5465 6e73 6f72 5d20 3d20 4e6f  ore.Tensor] = No
+00009860: 6e65 2c0a 2020 2020 2020 2020 6262 6f78  ne,.        bbox
+00009870: 3a20 4f70 7469 6f6e 616c 5b6d 696e 6473  : Optional[minds
+00009880: 706f 7265 2e54 656e 736f 725d 203d 204e  pore.Tensor] = N
+00009890: 6f6e 652c 0a20 2020 2020 2020 2061 7474  one,.        att
+000098a0: 656e 7469 6f6e 5f6d 6173 6b3a 204f 7074  ention_mask: Opt
+000098b0: 696f 6e61 6c5b 6d69 6e64 7370 6f72 652e  ional[mindspore.
+000098c0: 5465 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a  Tensor] = None,.
+000098d0: 2020 2020 2020 2020 6262 6f78 5f66 6972          bbox_fir
+000098e0: 7374 5f74 6f6b 656e 5f6d 6173 6b3a 204f  st_token_mask: O
+000098f0: 7074 696f 6e61 6c5b 6d69 6e64 7370 6f72  ptional[mindspor
+00009900: 652e 5465 6e73 6f72 5d20 3d20 4e6f 6e65  e.Tensor] = None
+00009910: 2c0a 2020 2020 2020 2020 746f 6b65 6e5f  ,.        token_
+00009920: 7479 7065 5f69 6473 3a20 4f70 7469 6f6e  type_ids: Option
+00009930: 616c 5b6d 696e 6473 706f 7265 2e54 656e  al[mindspore.Ten
+00009940: 736f 725d 203d 204e 6f6e 652c 0a20 2020  sor] = None,.   
+00009950: 2020 2020 2070 6f73 6974 696f 6e5f 6964       position_id
+00009960: 733a 204f 7074 696f 6e61 6c5b 6d69 6e64  s: Optional[mind
+00009970: 7370 6f72 652e 5465 6e73 6f72 5d20 3d20  spore.Tensor] = 
+00009980: 4e6f 6e65 2c0a 2020 2020 2020 2020 6865  None,.        he
+00009990: 6164 5f6d 6173 6b3a 204f 7074 696f 6e61  ad_mask: Optiona
+000099a0: 6c5b 6d69 6e64 7370 6f72 652e 5465 6e73  l[mindspore.Tens
+000099b0: 6f72 5d20 3d20 4e6f 6e65 2c0a 2020 2020  or] = None,.    
+000099c0: 2020 2020 696e 7075 7473 5f65 6d62 6564      inputs_embed
+000099d0: 733a 204f 7074 696f 6e61 6c5b 6d69 6e64  s: Optional[mind
+000099e0: 7370 6f72 652e 5465 6e73 6f72 5d20 3d20  spore.Tensor] = 
+000099f0: 4e6f 6e65 2c0a 2020 2020 2020 2020 6c61  None,.        la
+00009a00: 6265 6c73 3a20 4f70 7469 6f6e 616c 5b6d  bels: Optional[m
+00009a10: 696e 6473 706f 7265 2e54 656e 736f 725d  indspore.Tensor]
+00009a20: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00009a30: 206f 7574 7075 745f 6174 7465 6e74 696f   output_attentio
+00009a40: 6e73 3a20 4f70 7469 6f6e 616c 5b62 6f6f  ns: Optional[boo
+00009a50: 6c5d 203d 204e 6f6e 652c 0a20 2020 2020  l] = None,.     
+00009a60: 2020 206f 7574 7075 745f 6869 6464 656e     output_hidden
+00009a70: 5f73 7461 7465 733a 204f 7074 696f 6e61  _states: Optiona
+00009a80: 6c5b 626f 6f6c 5d20 3d20 4e6f 6e65 2c0a  l[bool] = None,.
+00009a90: 2020 2020 2020 2020 7265 7475 726e 5f64          return_d
+00009aa0: 6963 743a 204f 7074 696f 6e61 6c5b 626f  ict: Optional[bo
+00009ab0: 6f6c 5d20 3d20 4e6f 6e65 2c0a 2020 2020  ol] = None,.    
+00009ac0: 2920 2d3e 2055 6e69 6f6e 5b54 7570 6c65  ) -> Union[Tuple
+00009ad0: 5b6d 696e 6473 706f 7265 2e54 656e 736f  [mindspore.Tenso
+00009ae0: 725d 2c20 546f 6b65 6e43 6c61 7373 6966  r], TokenClassif
+00009af0: 6965 724f 7574 7075 745d 3a0a 2020 2020  ierOutput]:.    
+00009b00: 2020 2020 7222 2222 0a0a 2020 2020 2020      r"""..      
+00009b10: 2020 5265 7475 726e 733a 0a0a 2020 2020    Returns:..    
+00009b20: 2020 2020 4578 616d 706c 6573 3a0a 0a20      Examples:.. 
+00009b30: 2020 2020 2020 2060 6060 7079 7468 6f6e         ```python
+00009b40: 0a20 2020 2020 2020 203e 3e3e 2069 6d70  .        >>> imp
+00009b50: 6f72 7420 746f 7263 680a 2020 2020 2020  ort torch.      
+00009b60: 2020 3e3e 3e20 6672 6f6d 2074 7261 6e73    >>> from trans
+00009b70: 666f 726d 6572 7320 696d 706f 7274 2042  formers import B
+00009b80: 726f 7350 726f 6365 7373 6f72 2c20 4272  rosProcessor, Br
+00009b90: 6f73 466f 7254 6f6b 656e 436c 6173 7369  osForTokenClassi
+00009ba0: 6669 6361 7469 6f6e 0a0a 2020 2020 2020  fication..      
+00009bb0: 2020 3e3e 3e20 7072 6f63 6573 736f 7220    >>> processor 
+00009bc0: 3d20 4272 6f73 5072 6f63 6573 736f 722e  = BrosProcessor.
+00009bd0: 6672 6f6d 5f70 7265 7472 6169 6e65 6428  from_pretrained(
+00009be0: 226a 696e 686f 3833 3435 2f62 726f 732d  "jinho8345/bros-
+00009bf0: 6261 7365 2d75 6e63 6173 6564 2229 0a0a  base-uncased")..
+00009c00: 2020 2020 2020 2020 3e3e 3e20 6d6f 6465          >>> mode
+00009c10: 6c20 3d20 4272 6f73 466f 7254 6f6b 656e  l = BrosForToken
+00009c20: 436c 6173 7369 6669 6361 7469 6f6e 2e66  Classification.f
+00009c30: 726f 6d5f 7072 6574 7261 696e 6564 2822  rom_pretrained("
+00009c40: 6a69 6e68 6f38 3334 352f 6272 6f73 2d62  jinho8345/bros-b
+00009c50: 6173 652d 756e 6361 7365 6422 290a 0a20  ase-uncased").. 
+00009c60: 2020 2020 2020 203e 3e3e 2065 6e63 6f64         >>> encod
+00009c70: 696e 6720 3d20 7072 6f63 6573 736f 7228  ing = processor(
+00009c80: 2248 656c 6c6f 2c20 6d79 2064 6f67 2069  "Hello, my dog i
+00009c90: 7320 6375 7465 222c 2061 6464 5f73 7065  s cute", add_spe
+00009ca0: 6369 616c 5f74 6f6b 656e 733d 4661 6c73  cial_tokens=Fals
+00009cb0: 652c 2072 6574 7572 6e5f 7465 6e73 6f72  e, return_tensor
+00009cc0: 733d 2270 7422 290a 2020 2020 2020 2020  s="pt").        
+00009cd0: 3e3e 3e20 6262 6f78 203d 2074 6f72 6368  >>> bbox = torch
+00009ce0: 2e74 656e 736f 7228 5b5b 5b30 2c20 302c  .tensor([[[0, 0,
+00009cf0: 2031 2c20 315d 5d5d 292e 7265 7065 6174   1, 1]]]).repeat
+00009d00: 2831 2c20 656e 636f 6469 6e67 5b22 696e  (1, encoding["in
+00009d10: 7075 745f 6964 7322 5d2e 7368 6170 655b  put_ids"].shape[
+00009d20: 2d31 5d2c 2031 290a 2020 2020 2020 2020  -1], 1).        
+00009d30: 3e3e 3e20 656e 636f 6469 6e67 5b22 6262  >>> encoding["bb
+00009d40: 6f78 225d 203d 2062 626f 780a 0a20 2020  ox"] = bbox..   
+00009d50: 2020 2020 203e 3e3e 206f 7574 7075 7473       >>> outputs
+00009d60: 203d 206d 6f64 656c 282a 2a65 6e63 6f64   = model(**encod
+00009d70: 696e 6729 0a20 2020 2020 2020 2060 6060  ing).        ```
+00009d80: 2222 220a 0a20 2020 2020 2020 2072 6574  """..        ret
+00009d90: 7572 6e5f 6469 6374 203d 2072 6574 7572  urn_dict = retur
+00009da0: 6e5f 6469 6374 2069 6620 7265 7475 726e  n_dict if return
+00009db0: 5f64 6963 7420 6973 206e 6f74 204e 6f6e  _dict is not Non
+00009dc0: 6520 656c 7365 2073 656c 662e 636f 6e66  e else self.conf
+00009dd0: 6967 2e75 7365 5f72 6574 7572 6e5f 6469  ig.use_return_di
+00009de0: 6374 0a0a 2020 2020 2020 2020 6f75 7470  ct..        outp
+00009df0: 7574 7320 3d20 7365 6c66 2e62 726f 7328  uts = self.bros(
+00009e00: 0a20 2020 2020 2020 2020 2020 2069 6e70  .            inp
+00009e10: 7574 5f69 6473 2c0a 2020 2020 2020 2020  ut_ids,.        
+00009e20: 2020 2020 6262 6f78 3d62 626f 782c 0a20      bbox=bbox,. 
+00009e30: 2020 2020 2020 2020 2020 2061 7474 656e             atten
+00009e40: 7469 6f6e 5f6d 6173 6b3d 6174 7465 6e74  tion_mask=attent
+00009e50: 696f 6e5f 6d61 736b 2c0a 2020 2020 2020  ion_mask,.      
+00009e60: 2020 2020 2020 746f 6b65 6e5f 7479 7065        token_type
+00009e70: 5f69 6473 3d74 6f6b 656e 5f74 7970 655f  _ids=token_type_
+00009e80: 6964 732c 0a20 2020 2020 2020 2020 2020  ids,.           
+00009e90: 2070 6f73 6974 696f 6e5f 6964 733d 706f   position_ids=po
+00009ea0: 7369 7469 6f6e 5f69 6473 2c0a 2020 2020  sition_ids,.    
+00009eb0: 2020 2020 2020 2020 6865 6164 5f6d 6173          head_mas
+00009ec0: 6b3d 6865 6164 5f6d 6173 6b2c 0a20 2020  k=head_mask,.   
+00009ed0: 2020 2020 2020 2020 2069 6e70 7574 735f           inputs_
+00009ee0: 656d 6265 6473 3d69 6e70 7574 735f 656d  embeds=inputs_em
+00009ef0: 6265 6473 2c0a 2020 2020 2020 2020 2020  beds,.          
+00009f00: 2020 6f75 7470 7574 5f61 7474 656e 7469    output_attenti
+00009f10: 6f6e 733d 6f75 7470 7574 5f61 7474 656e  ons=output_atten
+00009f20: 7469 6f6e 732c 0a20 2020 2020 2020 2020  tions,.         
+00009f30: 2020 206f 7574 7075 745f 6869 6464 656e     output_hidden
+00009f40: 5f73 7461 7465 733d 6f75 7470 7574 5f68  _states=output_h
+00009f50: 6964 6465 6e5f 7374 6174 6573 2c0a 2020  idden_states,.  
+00009f60: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00009f70: 5f64 6963 743d 7265 7475 726e 5f64 6963  _dict=return_dic
+00009f80: 742c 0a20 2020 2020 2020 2029 0a0a 2020  t,.        )..  
+00009f90: 2020 2020 2020 7365 7175 656e 6365 5f6f        sequence_o
+00009fa0: 7574 7075 7420 3d20 6f75 7470 7574 735b  utput = outputs[
+00009fb0: 305d 0a0a 2020 2020 2020 2020 7365 7175  0]..        sequ
+00009fc0: 656e 6365 5f6f 7574 7075 7420 3d20 7365  ence_output = se
+00009fd0: 6c66 2e64 726f 706f 7574 2873 6571 7565  lf.dropout(seque
+00009fe0: 6e63 655f 6f75 7470 7574 290a 2020 2020  nce_output).    
+00009ff0: 2020 2020 6c6f 6769 7473 203d 2073 656c      logits = sel
+0000a000: 662e 636c 6173 7369 6669 6572 2873 6571  f.classifier(seq
+0000a010: 7565 6e63 655f 6f75 7470 7574 290a 0a20  uence_output).. 
+0000a020: 2020 2020 2020 206c 6f73 7320 3d20 4e6f         loss = No
+0000a030: 6e65 0a20 2020 2020 2020 2069 6620 6c61  ne.        if la
+0000a040: 6265 6c73 2069 7320 6e6f 7420 4e6f 6e65  bels is not None
+0000a050: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+0000a060: 2062 626f 785f 6669 7273 745f 746f 6b65   bbox_first_toke
+0000a070: 6e5f 6d61 736b 2069 7320 6e6f 7420 4e6f  n_mask is not No
+0000a080: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0000a090: 2020 2020 6262 6f78 5f66 6972 7374 5f74      bbox_first_t
+0000a0a0: 6f6b 656e 5f6d 6173 6b20 3d20 6262 6f78  oken_mask = bbox
+0000a0b0: 5f66 6972 7374 5f74 6f6b 656e 5f6d 6173  _first_token_mas
+0000a0c0: 6b2e 7669 6577 282d 3129 0a20 2020 2020  k.view(-1).     
+0000a0d0: 2020 2020 2020 2020 2020 206c 6f73 7320             loss 
+0000a0e0: 3d20 6f70 732e 6372 6f73 735f 656e 7472  = ops.cross_entr
+0000a0f0: 6f70 7928 0a20 2020 2020 2020 2020 2020  opy(.           
+0000a100: 2020 2020 2020 2020 206c 6f67 6974 732e           logits.
+0000a110: 7669 6577 282d 312c 2073 656c 662e 6e75  view(-1, self.nu
+0000a120: 6d5f 6c61 6265 6c73 295b 6262 6f78 5f66  m_labels)[bbox_f
+0000a130: 6972 7374 5f74 6f6b 656e 5f6d 6173 6b5d  irst_token_mask]
+0000a140: 2c20 6c61 6265 6c73 2e76 6965 7728 2d31  , labels.view(-1
+0000a150: 295b 6262 6f78 5f66 6972 7374 5f74 6f6b  )[bbox_first_tok
+0000a160: 656e 5f6d 6173 6b5d 0a20 2020 2020 2020  en_mask].       
+0000a170: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0000a180: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0000a190: 2020 2020 2020 2020 2020 2020 206c 6f73               los
+0000a1a0: 7320 3d20 6f70 732e 6372 6f73 735f 656e  s = ops.cross_en
+0000a1b0: 7472 6f70 7928 6c6f 6769 7473 2e76 6965  tropy(logits.vie
+0000a1c0: 7728 2d31 2c20 7365 6c66 2e6e 756d 5f6c  w(-1, self.num_l
+0000a1d0: 6162 656c 7329 2c20 6c61 6265 6c73 2e76  abels), labels.v
+0000a1e0: 6965 7728 2d31 2929 0a0a 2020 2020 2020  iew(-1))..      
+0000a1f0: 2020 6966 206e 6f74 2072 6574 7572 6e5f    if not return_
+0000a200: 6469 6374 3a0a 2020 2020 2020 2020 2020  dict:.          
+0000a210: 2020 6f75 7470 7574 203d 2028 6c6f 6769    output = (logi
+0000a220: 7473 2c29 202b 206f 7574 7075 7473 5b32  ts,) + outputs[2
+0000a230: 3a5d 0a20 2020 2020 2020 2020 2020 2072  :].            r
+0000a240: 6574 7572 6e20 2828 6c6f 7373 2c29 202b  eturn ((loss,) +
+0000a250: 206f 7574 7075 7429 2069 6620 6c6f 7373   output) if loss
+0000a260: 2069 7320 6e6f 7420 4e6f 6e65 2065 6c73   is not None els
+0000a270: 6520 6f75 7470 7574 0a0a 2020 2020 2020  e output..      
+0000a280: 2020 7265 7475 726e 2054 6f6b 656e 436c    return TokenCl
+0000a290: 6173 7369 6669 6572 4f75 7470 7574 280a  assifierOutput(.
+0000a2a0: 2020 2020 2020 2020 2020 2020 6c6f 7373              loss
+0000a2b0: 3d6c 6f73 732c 0a20 2020 2020 2020 2020  =loss,.         
+0000a2c0: 2020 206c 6f67 6974 733d 6c6f 6769 7473     logits=logits
+0000a2d0: 2c0a 2020 2020 2020 2020 2020 2020 6869  ,.            hi
+0000a2e0: 6464 656e 5f73 7461 7465 733d 6f75 7470  dden_states=outp
+0000a2f0: 7574 732e 6869 6464 656e 5f73 7461 7465  uts.hidden_state
+0000a300: 732c 0a20 2020 2020 2020 2020 2020 2061  s,.            a
+0000a310: 7474 656e 7469 6f6e 733d 6f75 7470 7574  ttentions=output
+0000a320: 732e 6174 7465 6e74 696f 6e73 2c0a 2020  s.attentions,.  
+0000a330: 2020 2020 2020 290a 0a0a 636c 6173 7320        )...class 
+0000a340: 4272 6f73 5370 6164 6545 4546 6f72 546f  BrosSpadeEEForTo
+0000a350: 6b65 6e43 6c61 7373 6966 6963 6174 696f  kenClassificatio
+0000a360: 6e28 4272 6f73 5072 6554 7261 696e 6564  n(BrosPreTrained
+0000a370: 4d6f 6465 6c29 3a0a 2020 2020 5f6b 6579  Model):.    _key
+0000a380: 735f 746f 5f69 676e 6f72 655f 6f6e 5f6c  s_to_ignore_on_l
+0000a390: 6f61 645f 756e 6578 7065 6374 6564 203d  oad_unexpected =
+0000a3a0: 205b 7222 706f 6f6c 6572 225d 0a0a 2020   [r"pooler"]..  
+0000a3b0: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
+0000a3c0: 656c 662c 2063 6f6e 6669 6729 3a0a 2020  elf, config):.  
+0000a3d0: 2020 2020 2020 7375 7065 7228 292e 5f5f        super().__
+0000a3e0: 696e 6974 5f5f 2863 6f6e 6669 6729 0a20  init__(config). 
+0000a3f0: 2020 2020 2020 2073 656c 662e 636f 6e66         self.conf
+0000a400: 6967 203d 2063 6f6e 6669 670a 2020 2020  ig = config.    
+0000a410: 2020 2020 7365 6c66 2e6e 756d 5f6c 6162      self.num_lab
+0000a420: 656c 7320 3d20 636f 6e66 6967 2e6e 756d  els = config.num
+0000a430: 5f6c 6162 656c 730a 2020 2020 2020 2020  _labels.        
+0000a440: 7365 6c66 2e6e 5f72 656c 6174 696f 6e73  self.n_relations
+0000a450: 203d 2063 6f6e 6669 672e 6e5f 7265 6c61   = config.n_rela
+0000a460: 7469 6f6e 730a 2020 2020 2020 2020 7365  tions.        se
+0000a470: 6c66 2e62 6163 6b62 6f6e 655f 6869 6464  lf.backbone_hidd
+0000a480: 656e 5f73 697a 6520 3d20 636f 6e66 6967  en_size = config
+0000a490: 2e68 6964 6465 6e5f 7369 7a65 0a0a 2020  .hidden_size..  
+0000a4a0: 2020 2020 2020 7365 6c66 2e62 726f 7320        self.bros 
+0000a4b0: 3d20 4272 6f73 4d6f 6465 6c28 636f 6e66  = BrosModel(conf
+0000a4c0: 6967 290a 2020 2020 2020 2020 636c 6173  ig).        clas
+0000a4d0: 7369 6669 6572 5f64 726f 706f 7574 203d  sifier_dropout =
+0000a4e0: 2028 0a20 2020 2020 2020 2020 2020 2063   (.            c
+0000a4f0: 6f6e 6669 672e 636c 6173 7369 6669 6572  onfig.classifier
+0000a500: 5f64 726f 706f 7574 2069 6620 6861 7361  _dropout if hasa
+0000a510: 7474 7228 636f 6e66 6967 2c20 2263 6c61  ttr(config, "cla
+0000a520: 7373 6966 6965 725f 6472 6f70 6f75 7422  ssifier_dropout"
+0000a530: 2920 656c 7365 2063 6f6e 6669 672e 6869  ) else config.hi
+0000a540: 6464 656e 5f64 726f 706f 7574 5f70 726f  dden_dropout_pro
+0000a550: 620a 2020 2020 2020 2020 290a 0a20 2020  b.        )..   
+0000a560: 2020 2020 2023 2049 6e69 7469 616c 2074       # Initial t
+0000a570: 6f6b 656e 2063 6c61 7373 6966 6963 6174  oken classificat
+0000a580: 696f 6e20 666f 7220 456e 7469 7479 2045  ion for Entity E
+0000a590: 7874 7261 6374 696f 6e20 284e 4552 290a  xtraction (NER).
+0000a5a0: 2020 2020 2020 2020 7365 6c66 2e69 6e69          self.ini
+0000a5b0: 7469 616c 5f74 6f6b 656e 5f63 6c61 7373  tial_token_class
+0000a5c0: 6966 6965 7220 3d20 6e6e 2e53 6571 7565  ifier = nn.Seque
+0000a5d0: 6e74 6961 6c43 656c 6c28 0a20 2020 2020  ntialCell(.     
+0000a5e0: 2020 2020 2020 206e 6e2e 4472 6f70 6f75         nn.Dropou
+0000a5f0: 7428 703d 636c 6173 7369 6669 6572 5f64  t(p=classifier_d
+0000a600: 726f 706f 7574 292c 0a20 2020 2020 2020  ropout),.       
+0000a610: 2020 2020 206e 6e2e 4465 6e73 6528 636f       nn.Dense(co
+0000a620: 6e66 6967 2e68 6964 6465 6e5f 7369 7a65  nfig.hidden_size
+0000a630: 2c20 636f 6e66 6967 2e68 6964 6465 6e5f  , config.hidden_
+0000a640: 7369 7a65 292c 0a20 2020 2020 2020 2020  size),.         
+0000a650: 2020 206e 6e2e 4472 6f70 6f75 7428 703d     nn.Dropout(p=
+0000a660: 636c 6173 7369 6669 6572 5f64 726f 706f  classifier_dropo
+0000a670: 7574 292c 0a20 2020 2020 2020 2020 2020  ut),.           
+0000a680: 206e 6e2e 4465 6e73 6528 636f 6e66 6967   nn.Dense(config
+0000a690: 2e68 6964 6465 6e5f 7369 7a65 2c20 636f  .hidden_size, co
+0000a6a0: 6e66 6967 2e6e 756d 5f6c 6162 656c 7329  nfig.num_labels)
+0000a6b0: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
+0000a6c0: 2020 2020 2023 2053 7562 7365 7175 656e       # Subsequen
+0000a6d0: 7420 746f 6b65 6e20 636c 6173 7369 6669  t token classifi
+0000a6e0: 6361 7469 6f6e 2066 6f72 2045 6e74 6974  cation for Entit
+0000a6f0: 7920 4578 7472 6163 7469 6f6e 2028 4e45  y Extraction (NE
+0000a700: 5229 0a20 2020 2020 2020 2073 656c 662e  R).        self.
+0000a710: 7375 6273 6571 7565 6e74 5f74 6f6b 656e  subsequent_token
+0000a720: 5f63 6c61 7373 6966 6965 7220 3d20 4272  _classifier = Br
+0000a730: 6f73 5265 6c61 7469 6f6e 4578 7472 6163  osRelationExtrac
+0000a740: 746f 7228 636f 6e66 6967 290a 0a20 2020  tor(config)..   
+0000a750: 2020 2020 2073 656c 662e 696e 6974 5f77       self.init_w
+0000a760: 6569 6768 7473 2829 0a0a 2020 2020 6465  eights()..    de
+0000a770: 6620 636f 6e73 7472 7563 7428 0a20 2020  f construct(.   
+0000a780: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+0000a790: 2020 2069 6e70 7574 5f69 6473 3a20 4f70     input_ids: Op
+0000a7a0: 7469 6f6e 616c 5b6d 696e 6473 706f 7265  tional[mindspore
+0000a7b0: 2e54 656e 736f 725d 203d 204e 6f6e 652c  .Tensor] = None,
+0000a7c0: 0a20 2020 2020 2020 2062 626f 783a 204f  .        bbox: O
+0000a7d0: 7074 696f 6e61 6c5b 6d69 6e64 7370 6f72  ptional[mindspor
+0000a7e0: 652e 5465 6e73 6f72 5d20 3d20 4e6f 6e65  e.Tensor] = None
+0000a7f0: 2c0a 2020 2020 2020 2020 6174 7465 6e74  ,.        attent
+0000a800: 696f 6e5f 6d61 736b 3a20 4f70 7469 6f6e  ion_mask: Option
+0000a810: 616c 5b6d 696e 6473 706f 7265 2e54 656e  al[mindspore.Ten
+0000a820: 736f 725d 203d 204e 6f6e 652c 0a20 2020  sor] = None,.   
+0000a830: 2020 2020 2062 626f 785f 6669 7273 745f       bbox_first_
+0000a840: 746f 6b65 6e5f 6d61 736b 3a20 4f70 7469  token_mask: Opti
+0000a850: 6f6e 616c 5b6d 696e 6473 706f 7265 2e54  onal[mindspore.T
+0000a860: 656e 736f 725d 203d 204e 6f6e 652c 0a20  ensor] = None,. 
+0000a870: 2020 2020 2020 2074 6f6b 656e 5f74 7970         token_typ
+0000a880: 655f 6964 733a 204f 7074 696f 6e61 6c5b  e_ids: Optional[
+0000a890: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+0000a8a0: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+0000a8b0: 2020 706f 7369 7469 6f6e 5f69 6473 3a20    position_ids: 
+0000a8c0: 4f70 7469 6f6e 616c 5b6d 696e 6473 706f  Optional[mindspo
+0000a8d0: 7265 2e54 656e 736f 725d 203d 204e 6f6e  re.Tensor] = Non
+0000a8e0: 652c 0a20 2020 2020 2020 2068 6561 645f  e,.        head_
+0000a8f0: 6d61 736b 3a20 4f70 7469 6f6e 616c 5b6d  mask: Optional[m
+0000a900: 696e 6473 706f 7265 2e54 656e 736f 725d  indspore.Tensor]
+0000a910: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+0000a920: 2069 6e70 7574 735f 656d 6265 6473 3a20   inputs_embeds: 
+0000a930: 4f70 7469 6f6e 616c 5b6d 696e 6473 706f  Optional[mindspo
+0000a940: 7265 2e54 656e 736f 725d 203d 204e 6f6e  re.Tensor] = Non
+0000a950: 652c 0a20 2020 2020 2020 2069 6e69 7469  e,.        initi
+0000a960: 616c 5f74 6f6b 656e 5f6c 6162 656c 733a  al_token_labels:
+0000a970: 204f 7074 696f 6e61 6c5b 6d69 6e64 7370   Optional[mindsp
+0000a980: 6f72 652e 5465 6e73 6f72 5d20 3d20 4e6f  ore.Tensor] = No
+0000a990: 6e65 2c0a 2020 2020 2020 2020 7375 6273  ne,.        subs
+0000a9a0: 6571 7565 6e74 5f74 6f6b 656e 5f6c 6162  equent_token_lab
+0000a9b0: 656c 733a 204f 7074 696f 6e61 6c5b 6d69  els: Optional[mi
+0000a9c0: 6e64 7370 6f72 652e 5465 6e73 6f72 5d20  ndspore.Tensor] 
+0000a9d0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+0000a9e0: 6f75 7470 7574 5f61 7474 656e 7469 6f6e  output_attention
+0000a9f0: 733a 204f 7074 696f 6e61 6c5b 626f 6f6c  s: Optional[bool
+0000aa00: 5d20 3d20 4e6f 6e65 2c0a 2020 2020 2020  ] = None,.      
+0000aa10: 2020 6f75 7470 7574 5f68 6964 6465 6e5f    output_hidden_
+0000aa20: 7374 6174 6573 3a20 4f70 7469 6f6e 616c  states: Optional
+0000aa30: 5b62 6f6f 6c5d 203d 204e 6f6e 652c 0a20  [bool] = None,. 
+0000aa40: 2020 2020 2020 2072 6574 7572 6e5f 6469         return_di
+0000aa50: 6374 3a20 4f70 7469 6f6e 616c 5b62 6f6f  ct: Optional[boo
+0000aa60: 6c5d 203d 204e 6f6e 652c 0a20 2020 2029  l] = None,.    )
+0000aa70: 202d 3e20 556e 696f 6e5b 5475 706c 655b   -> Union[Tuple[
+0000aa80: 6d69 6e64 7370 6f72 652e 5465 6e73 6f72  mindspore.Tensor
+0000aa90: 5d2c 2042 726f 7353 7061 6465 4f75 7470  ], BrosSpadeOutp
+0000aaa0: 7574 5d3a 0a20 2020 2020 2020 2072 2222  ut]:.        r""
+0000aab0: 220a 2020 2020 2020 2020 5265 7475 726e  ".        Return
+0000aac0: 733a 0a0a 2020 2020 2020 2020 4578 616d  s:..        Exam
+0000aad0: 706c 6573 3a0a 0a20 2020 2020 2020 2060  ples:..        `
+0000aae0: 6060 7079 7468 6f6e 0a20 2020 2020 2020  ``python.       
+0000aaf0: 203e 3e3e 2069 6d70 6f72 7420 746f 7263   >>> import torc
+0000ab00: 680a 2020 2020 2020 2020 3e3e 3e20 6672  h.        >>> fr
+0000ab10: 6f6d 2074 7261 6e73 666f 726d 6572 7320  om transformers 
+0000ab20: 696d 706f 7274 2042 726f 7350 726f 6365  import BrosProce
+0000ab30: 7373 6f72 2c20 4272 6f73 5370 6164 6545  ssor, BrosSpadeE
+0000ab40: 4546 6f72 546f 6b65 6e43 6c61 7373 6966  EForTokenClassif
+0000ab50: 6963 6174 696f 6e0a 0a20 2020 2020 2020  ication..       
+0000ab60: 203e 3e3e 2070 726f 6365 7373 6f72 203d   >>> processor =
+0000ab70: 2042 726f 7350 726f 6365 7373 6f72 2e66   BrosProcessor.f
+0000ab80: 726f 6d5f 7072 6574 7261 696e 6564 2822  rom_pretrained("
+0000ab90: 6a69 6e68 6f38 3334 352f 6272 6f73 2d62  jinho8345/bros-b
+0000aba0: 6173 652d 756e 6361 7365 6422 290a 0a20  ase-uncased").. 
+0000abb0: 2020 2020 2020 203e 3e3e 206d 6f64 656c         >>> model
+0000abc0: 203d 2042 726f 7353 7061 6465 4545 466f   = BrosSpadeEEFo
+0000abd0: 7254 6f6b 656e 436c 6173 7369 6669 6361  rTokenClassifica
+0000abe0: 7469 6f6e 2e66 726f 6d5f 7072 6574 7261  tion.from_pretra
+0000abf0: 696e 6564 2822 6a69 6e68 6f38 3334 352f  ined("jinho8345/
+0000ac00: 6272 6f73 2d62 6173 652d 756e 6361 7365  bros-base-uncase
+0000ac10: 6422 290a 0a20 2020 2020 2020 203e 3e3e  d")..        >>>
+0000ac20: 2065 6e63 6f64 696e 6720 3d20 7072 6f63   encoding = proc
+0000ac30: 6573 736f 7228 2248 656c 6c6f 2c20 6d79  essor("Hello, my
+0000ac40: 2064 6f67 2069 7320 6375 7465 222c 2061   dog is cute", a
+0000ac50: 6464 5f73 7065 6369 616c 5f74 6f6b 656e  dd_special_token
+0000ac60: 733d 4661 6c73 652c 2072 6574 7572 6e5f  s=False, return_
+0000ac70: 7465 6e73 6f72 733d 2270 7422 290a 2020  tensors="pt").  
+0000ac80: 2020 2020 2020 3e3e 3e20 6262 6f78 203d        >>> bbox =
+0000ac90: 2074 6f72 6368 2e74 656e 736f 7228 5b5b   torch.tensor([[
+0000aca0: 5b30 2c20 302c 2031 2c20 315d 5d5d 292e  [0, 0, 1, 1]]]).
+0000acb0: 7265 7065 6174 2831 2c20 656e 636f 6469  repeat(1, encodi
+0000acc0: 6e67 5b22 696e 7075 745f 6964 7322 5d2e  ng["input_ids"].
+0000acd0: 7368 6170 655b 2d31 5d2c 2031 290a 2020  shape[-1], 1).  
+0000ace0: 2020 2020 2020 3e3e 3e20 656e 636f 6469        >>> encodi
+0000acf0: 6e67 5b22 6262 6f78 225d 203d 2062 626f  ng["bbox"] = bbo
+0000ad00: 780a 0a20 2020 2020 2020 203e 3e3e 206f  x..        >>> o
+0000ad10: 7574 7075 7473 203d 206d 6f64 656c 282a  utputs = model(*
+0000ad20: 2a65 6e63 6f64 696e 6729 0a20 2020 2020  *encoding).     
+0000ad30: 2020 2060 6060 2222 220a 0a20 2020 2020     ```"""..     
+0000ad40: 2020 2072 6574 7572 6e5f 6469 6374 203d     return_dict =
+0000ad50: 2072 6574 7572 6e5f 6469 6374 2069 6620   return_dict if 
+0000ad60: 7265 7475 726e 5f64 6963 7420 6973 206e  return_dict is n
+0000ad70: 6f74 204e 6f6e 6520 656c 7365 2073 656c  ot None else sel
+0000ad80: 662e 636f 6e66 6967 2e75 7365 5f72 6574  f.config.use_ret
+0000ad90: 7572 6e5f 6469 6374 0a0a 2020 2020 2020  urn_dict..      
+0000ada0: 2020 6f75 7470 7574 7320 3d20 7365 6c66    outputs = self
+0000adb0: 2e62 726f 7328 0a20 2020 2020 2020 2020  .bros(.         
+0000adc0: 2020 2069 6e70 7574 5f69 6473 3d69 6e70     input_ids=inp
+0000add0: 7574 5f69 6473 2c0a 2020 2020 2020 2020  ut_ids,.        
+0000ade0: 2020 2020 6262 6f78 3d62 626f 782c 0a20      bbox=bbox,. 
+0000adf0: 2020 2020 2020 2020 2020 2061 7474 656e             atten
+0000ae00: 7469 6f6e 5f6d 6173 6b3d 6174 7465 6e74  tion_mask=attent
+0000ae10: 696f 6e5f 6d61 736b 2c0a 2020 2020 2020  ion_mask,.      
+0000ae20: 2020 2020 2020 746f 6b65 6e5f 7479 7065        token_type
+0000ae30: 5f69 6473 3d74 6f6b 656e 5f74 7970 655f  _ids=token_type_
+0000ae40: 6964 732c 0a20 2020 2020 2020 2020 2020  ids,.           
+0000ae50: 2070 6f73 6974 696f 6e5f 6964 733d 706f   position_ids=po
+0000ae60: 7369 7469 6f6e 5f69 6473 2c0a 2020 2020  sition_ids,.    
+0000ae70: 2020 2020 2020 2020 6865 6164 5f6d 6173          head_mas
+0000ae80: 6b3d 6865 6164 5f6d 6173 6b2c 0a20 2020  k=head_mask,.   
+0000ae90: 2020 2020 2020 2020 2069 6e70 7574 735f           inputs_
+0000aea0: 656d 6265 6473 3d69 6e70 7574 735f 656d  embeds=inputs_em
+0000aeb0: 6265 6473 2c0a 2020 2020 2020 2020 2020  beds,.          
+0000aec0: 2020 6f75 7470 7574 5f61 7474 656e 7469    output_attenti
+0000aed0: 6f6e 733d 6f75 7470 7574 5f61 7474 656e  ons=output_atten
+0000aee0: 7469 6f6e 732c 0a20 2020 2020 2020 2020  tions,.         
+0000aef0: 2020 206f 7574 7075 745f 6869 6464 656e     output_hidden
+0000af00: 5f73 7461 7465 733d 6f75 7470 7574 5f68  _states=output_h
+0000af10: 6964 6465 6e5f 7374 6174 6573 2c0a 2020  idden_states,.  
+0000af20: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000af30: 5f64 6963 743d 7265 7475 726e 5f64 6963  _dict=return_dic
+0000af40: 742c 0a20 2020 2020 2020 2029 0a0a 2020  t,.        )..  
+0000af50: 2020 2020 2020 6c61 7374 5f68 6964 6465        last_hidde
+0000af60: 6e5f 7374 6174 6573 203d 206f 7574 7075  n_states = outpu
+0000af70: 7473 5b30 5d0a 2020 2020 2020 2020 6c61  ts[0].        la
+0000af80: 7374 5f68 6964 6465 6e5f 7374 6174 6573  st_hidden_states
+0000af90: 203d 206c 6173 745f 6869 6464 656e 5f73   = last_hidden_s
+0000afa0: 7461 7465 732e 7377 6170 6178 6573 2830  tates.swapaxes(0
+0000afb0: 2c20 3129 0a20 2020 2020 2020 2069 6e69  , 1).        ini
+0000afc0: 7469 616c 5f74 6f6b 656e 5f6c 6f67 6974  tial_token_logit
+0000afd0: 7320 3d20 7365 6c66 2e69 6e69 7469 616c  s = self.initial
+0000afe0: 5f74 6f6b 656e 5f63 6c61 7373 6966 6965  _token_classifie
+0000aff0: 7228 6c61 7374 5f68 6964 6465 6e5f 7374  r(last_hidden_st
+0000b000: 6174 6573 292e 7377 6170 6178 6573 2830  ates).swapaxes(0
+0000b010: 2c20 3129 0a20 2020 2020 2020 2073 7562  , 1).        sub
+0000b020: 7365 7175 656e 745f 746f 6b65 6e5f 6c6f  sequent_token_lo
+0000b030: 6769 7473 203d 2073 656c 662e 7375 6273  gits = self.subs
+0000b040: 6571 7565 6e74 5f74 6f6b 656e 5f63 6c61  equent_token_cla
+0000b050: 7373 6966 6965 7228 6c61 7374 5f68 6964  ssifier(last_hid
+0000b060: 6465 6e5f 7374 6174 6573 2c20 6c61 7374  den_states, last
+0000b070: 5f68 6964 6465 6e5f 7374 6174 6573 292e  _hidden_states).
+0000b080: 7371 7565 657a 6528 3029 0a0a 2020 2020  squeeze(0)..    
+0000b090: 2020 2020 2320 6d61 6b65 2073 7562 7365      # make subse
+0000b0a0: 7175 656e 7420 746f 6b65 6e20 2873 6571  quent token (seq
+0000b0b0: 7565 6e63 6520 746f 6b65 6e20 636c 6173  uence token clas
+0000b0c0: 7369 6669 6361 7469 6f6e 2920 6d61 736b  sification) mask
+0000b0d0: 0a20 2020 2020 2020 2069 6e76 5f61 7474  .        inv_att
+0000b0e0: 656e 7469 6f6e 5f6d 6173 6b20 3d20 3120  ention_mask = 1 
+0000b0f0: 2d20 6174 7465 6e74 696f 6e5f 6d61 736b  - attention_mask
+0000b100: 0a20 2020 2020 2020 2062 6174 6368 5f73  .        batch_s
+0000b110: 697a 652c 206d 6178 5f73 6571 5f6c 656e  ize, max_seq_len
+0000b120: 6774 6820 3d20 696e 765f 6174 7465 6e74  gth = inv_attent
+0000b130: 696f 6e5f 6d61 736b 2e73 6861 7065 0a20  ion_mask.shape. 
+0000b140: 2020 2020 2020 2069 6e76 616c 6964 5f74         invalid_t
+0000b150: 6f6b 656e 5f6d 6173 6b20 3d20 6f70 732e  oken_mask = ops.
+0000b160: 6361 7428 5b69 6e76 5f61 7474 656e 7469  cat([inv_attenti
+0000b170: 6f6e 5f6d 6173 6b2c 206f 7073 2e7a 6572  on_mask, ops.zer
+0000b180: 6f73 2828 6261 7463 685f 7369 7a65 2c20  os((batch_size, 
+0000b190: 3129 292e 6173 7479 7065 2869 6e76 5f61  1)).astype(inv_a
+0000b1a0: 7474 656e 7469 6f6e 5f6d 6173 6b2e 6474  ttention_mask.dt
+0000b1b0: 7970 6529 5d2c 2061 7869 733d 3129 2e62  ype)], axis=1).b
+0000b1c0: 6f6f 6c28 290a 2020 2020 2020 2020 7375  ool().        su
+0000b1d0: 6273 6571 7565 6e74 5f74 6f6b 656e 5f6c  bsequent_token_l
+0000b1e0: 6f67 6974 7320 3d20 7375 6273 6571 7565  ogits = subseque
+0000b1f0: 6e74 5f74 6f6b 656e 5f6c 6f67 6974 732e  nt_token_logits.
+0000b200: 6d61 736b 6564 5f66 696c 6c28 0a20 2020  masked_fill(.   
+0000b210: 2020 2020 2020 2020 2069 6e76 616c 6964           invalid
+0000b220: 5f74 6f6b 656e 5f6d 6173 6b5b 3a2c 204e  _token_mask[:, N
+0000b230: 6f6e 652c 203a 5d2c 2066 696e 666f 2873  one, :], finfo(s
+0000b240: 7562 7365 7175 656e 745f 746f 6b65 6e5f  ubsequent_token_
+0000b250: 6c6f 6769 7473 2e64 7479 7065 2c20 276d  logits.dtype, 'm
+0000b260: 696e 2729 0a20 2020 2020 2020 2029 0a20  in').        ). 
+0000b270: 2020 2020 2020 2073 656c 665f 746f 6b65         self_toke
+0000b280: 6e5f 6d61 736b 203d 206f 7073 2e65 7965  n_mask = ops.eye
+0000b290: 286d 6178 5f73 6571 5f6c 656e 6774 682c  (max_seq_length,
+0000b2a0: 206d 6178 5f73 6571 5f6c 656e 6774 6820   max_seq_length 
+0000b2b0: 2b20 3129 2e62 6f6f 6c28 290a 2020 2020  + 1).bool().    
+0000b2c0: 2020 2020 7375 6273 6571 7565 6e74 5f74      subsequent_t
+0000b2d0: 6f6b 656e 5f6c 6f67 6974 7320 3d20 7375  oken_logits = su
+0000b2e0: 6273 6571 7565 6e74 5f74 6f6b 656e 5f6c  bsequent_token_l
+0000b2f0: 6f67 6974 732e 6d61 736b 6564 5f66 696c  ogits.masked_fil
+0000b300: 6c28 0a20 2020 2020 2020 2020 2020 2073  l(.            s
+0000b310: 656c 665f 746f 6b65 6e5f 6d61 736b 5b4e  elf_token_mask[N
+0000b320: 6f6e 652c 203a 2c20 3a5d 2c20 6669 6e66  one, :, :], finf
+0000b330: 6f28 7375 6273 6571 7565 6e74 5f74 6f6b  o(subsequent_tok
+0000b340: 656e 5f6c 6f67 6974 732e 6474 7970 652c  en_logits.dtype,
+0000b350: 2027 6d69 6e27 290a 2020 2020 2020 2020   'min').        
+0000b360: 290a 2020 2020 2020 2020 7375 6273 6571  ).        subseq
+0000b370: 7565 6e74 5f74 6f6b 656e 5f6d 6173 6b20  uent_token_mask 
+0000b380: 3d20 6174 7465 6e74 696f 6e5f 6d61 736b  = attention_mask
+0000b390: 2e76 6965 7728 2d31 292e 626f 6f6c 2829  .view(-1).bool()
+0000b3a0: 0a0a 2020 2020 2020 2020 6c6f 7373 203d  ..        loss =
+0000b3b0: 204e 6f6e 650a 2020 2020 2020 2020 6966   None.        if
+0000b3c0: 2069 6e69 7469 616c 5f74 6f6b 656e 5f6c   initial_token_l
+0000b3d0: 6162 656c 7320 6973 206e 6f74 204e 6f6e  abels is not Non
+0000b3e0: 6520 616e 6420 7375 6273 6571 7565 6e74  e and subsequent
+0000b3f0: 5f74 6f6b 656e 5f6c 6162 656c 7320 6973  _token_labels is
+0000b400: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+0000b410: 2020 2020 2020 2023 2067 6574 2069 6e69         # get ini
+0000b420: 7469 616c 2074 6f6b 656e 206c 6f73 730a  tial token loss.
+0000b430: 2020 2020 2020 2020 2020 2020 696e 6974              init
+0000b440: 6961 6c5f 746f 6b65 6e5f 6c61 6265 6c73  ial_token_labels
+0000b450: 203d 2069 6e69 7469 616c 5f74 6f6b 656e   = initial_token
+0000b460: 5f6c 6162 656c 732e 7669 6577 282d 3129  _labels.view(-1)
+0000b470: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0000b480: 6262 6f78 5f66 6972 7374 5f74 6f6b 656e  bbox_first_token
+0000b490: 5f6d 6173 6b20 6973 206e 6f74 204e 6f6e  _mask is not Non
+0000b4a0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0000b4b0: 2020 2062 626f 785f 6669 7273 745f 746f     bbox_first_to
+0000b4c0: 6b65 6e5f 6d61 736b 203d 2062 626f 785f  ken_mask = bbox_
+0000b4d0: 6669 7273 745f 746f 6b65 6e5f 6d61 736b  first_token_mask
+0000b4e0: 2e76 6965 7728 2d31 290a 2020 2020 2020  .view(-1).      
+0000b4f0: 2020 2020 2020 2020 2020 696e 6974 6961            initia
+0000b500: 6c5f 746f 6b65 6e5f 6c6f 7373 203d 206f  l_token_loss = o
+0000b510: 7073 2e63 726f 7373 5f65 6e74 726f 7079  ps.cross_entropy
+0000b520: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0000b530: 2020 2020 2020 696e 6974 6961 6c5f 746f        initial_to
+0000b540: 6b65 6e5f 6c6f 6769 7473 2e76 6965 7728  ken_logits.view(
+0000b550: 2d31 2c20 7365 6c66 2e6e 756d 5f6c 6162  -1, self.num_lab
+0000b560: 656c 7329 5b62 626f 785f 6669 7273 745f  els)[bbox_first_
+0000b570: 746f 6b65 6e5f 6d61 736b 5d2c 0a20 2020  token_mask],.   
+0000b580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b590: 2069 6e69 7469 616c 5f74 6f6b 656e 5f6c   initial_token_l
+0000b5a0: 6162 656c 735b 6262 6f78 5f66 6972 7374  abels[bbox_first
+0000b5b0: 5f74 6f6b 656e 5f6d 6173 6b5d 2c0a 2020  _token_mask],.  
+0000b5c0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0000b5d0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0000b5e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000b5f0: 2020 696e 6974 6961 6c5f 746f 6b65 6e5f    initial_token_
+0000b600: 6c6f 7373 203d 206f 7073 2e63 726f 7373  loss = ops.cross
+0000b610: 5f65 6e74 726f 7079 2869 6e69 7469 616c  _entropy(initial
+0000b620: 5f74 6f6b 656e 5f6c 6f67 6974 732e 7669  _token_logits.vi
+0000b630: 6577 282d 312c 2073 656c 662e 6e75 6d5f  ew(-1, self.num_
+0000b640: 6c61 6265 6c73 292c 2069 6e69 7469 616c  labels), initial
+0000b650: 5f74 6f6b 656e 5f6c 6162 656c 7329 0a0a  _token_labels)..
+0000b660: 2020 2020 2020 2020 2020 2020 7375 6273              subs
+0000b670: 6571 7565 6e74 5f74 6f6b 656e 5f6c 6162  equent_token_lab
+0000b680: 656c 7320 3d20 7375 6273 6571 7565 6e74  els = subsequent
+0000b690: 5f74 6f6b 656e 5f6c 6162 656c 732e 7669  _token_labels.vi
+0000b6a0: 6577 282d 3129 0a20 2020 2020 2020 2020  ew(-1).         
+0000b6b0: 2020 2073 7562 7365 7175 656e 745f 746f     subsequent_to
+0000b6c0: 6b65 6e5f 6c6f 7373 203d 206f 7073 2e63  ken_loss = ops.c
+0000b6d0: 726f 7373 5f65 6e74 726f 7079 280a 2020  ross_entropy(.  
+0000b6e0: 2020 2020 2020 2020 2020 2020 2020 7375                su
+0000b6f0: 6273 6571 7565 6e74 5f74 6f6b 656e 5f6c  bsequent_token_l
+0000b700: 6f67 6974 732e 7669 6577 282d 312c 206d  ogits.view(-1, m
+0000b710: 6178 5f73 6571 5f6c 656e 6774 6820 2b20  ax_seq_length + 
+0000b720: 3129 5b73 7562 7365 7175 656e 745f 746f  1)[subsequent_to
+0000b730: 6b65 6e5f 6d61 736b 5d2c 0a20 2020 2020  ken_mask],.     
+0000b740: 2020 2020 2020 2020 2020 2073 7562 7365             subse
+0000b750: 7175 656e 745f 746f 6b65 6e5f 6c61 6265  quent_token_labe
+0000b760: 6c73 5b73 7562 7365 7175 656e 745f 746f  ls[subsequent_to
+0000b770: 6b65 6e5f 6d61 736b 5d2c 0a20 2020 2020  ken_mask],.     
+0000b780: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+0000b790: 2020 2020 2020 6c6f 7373 203d 2069 6e69        loss = ini
+0000b7a0: 7469 616c 5f74 6f6b 656e 5f6c 6f73 7320  tial_token_loss 
+0000b7b0: 2b20 7375 6273 6571 7565 6e74 5f74 6f6b  + subsequent_tok
+0000b7c0: 656e 5f6c 6f73 730a 0a20 2020 2020 2020  en_loss..       
+0000b7d0: 2069 6620 6e6f 7420 7265 7475 726e 5f64   if not return_d
+0000b7e0: 6963 743a 0a20 2020 2020 2020 2020 2020  ict:.           
+0000b7f0: 206f 7574 7075 7420 3d20 2869 6e69 7469   output = (initi
+0000b800: 616c 5f74 6f6b 656e 5f6c 6f67 6974 732c  al_token_logits,
+0000b810: 2073 7562 7365 7175 656e 745f 746f 6b65   subsequent_toke
+0000b820: 6e5f 6c6f 6769 7473 2920 2b20 6f75 7470  n_logits) + outp
+0000b830: 7574 735b 323a 5d0a 2020 2020 2020 2020  uts[2:].        
+0000b840: 2020 2020 7265 7475 726e 2028 286c 6f73      return ((los
+0000b850: 732c 2920 2b20 6f75 7470 7574 2920 6966  s,) + output) if
+0000b860: 206c 6f73 7320 6973 206e 6f74 204e 6f6e   loss is not Non
+0000b870: 6520 656c 7365 206f 7574 7075 740a 0a20  e else output.. 
+0000b880: 2020 2020 2020 2072 6574 7572 6e20 4272         return Br
+0000b890: 6f73 5370 6164 654f 7574 7075 7428 0a20  osSpadeOutput(. 
+0000b8a0: 2020 2020 2020 2020 2020 206c 6f73 733d             loss=
+0000b8b0: 6c6f 7373 2c0a 2020 2020 2020 2020 2020  loss,.          
+0000b8c0: 2020 696e 6974 6961 6c5f 746f 6b65 6e5f    initial_token_
+0000b8d0: 6c6f 6769 7473 3d69 6e69 7469 616c 5f74  logits=initial_t
+0000b8e0: 6f6b 656e 5f6c 6f67 6974 732c 0a20 2020  oken_logits,.   
+0000b8f0: 2020 2020 2020 2020 2073 7562 7365 7175           subsequ
+0000b900: 656e 745f 746f 6b65 6e5f 6c6f 6769 7473  ent_token_logits
+0000b910: 3d73 7562 7365 7175 656e 745f 746f 6b65  =subsequent_toke
+0000b920: 6e5f 6c6f 6769 7473 2c0a 2020 2020 2020  n_logits,.      
+0000b930: 2020 2020 2020 6869 6464 656e 5f73 7461        hidden_sta
+0000b940: 7465 733d 6f75 7470 7574 732e 6869 6464  tes=outputs.hidd
+0000b950: 656e 5f73 7461 7465 732c 0a20 2020 2020  en_states,.     
+0000b960: 2020 2020 2020 2061 7474 656e 7469 6f6e         attention
+0000b970: 733d 6f75 7470 7574 732e 6174 7465 6e74  s=outputs.attent
+0000b980: 696f 6e73 2c0a 2020 2020 2020 2020 290a  ions,.        ).
+0000b990: 0a0a 0a63 6c61 7373 2042 726f 7353 7061  ...class BrosSpa
+0000b9a0: 6465 454c 466f 7254 6f6b 656e 436c 6173  deELForTokenClas
+0000b9b0: 7369 6669 6361 7469 6f6e 2842 726f 7350  sification(BrosP
+0000b9c0: 7265 5472 6169 6e65 644d 6f64 656c 293a  reTrainedModel):
+0000b9d0: 0a20 2020 205f 6b65 7973 5f74 6f5f 6967  .    _keys_to_ig
+0000b9e0: 6e6f 7265 5f6f 6e5f 6c6f 6164 5f75 6e65  nore_on_load_une
+0000b9f0: 7870 6563 7465 6420 3d20 5b72 2270 6f6f  xpected = [r"poo
+0000ba00: 6c65 7222 5d0a 0a20 2020 2064 6566 205f  ler"]..    def _
+0000ba10: 5f69 6e69 745f 5f28 7365 6c66 2c20 636f  _init__(self, co
+0000ba20: 6e66 6967 293a 0a20 2020 2020 2020 2073  nfig):.        s
+0000ba30: 7570 6572 2829 2e5f 5f69 6e69 745f 5f28  uper().__init__(
+0000ba40: 636f 6e66 6967 290a 2020 2020 2020 2020  config).        
+0000ba50: 7365 6c66 2e63 6f6e 6669 6720 3d20 636f  self.config = co
+0000ba60: 6e66 6967 0a20 2020 2020 2020 2073 656c  nfig.        sel
+0000ba70: 662e 6e75 6d5f 6c61 6265 6c73 203d 2063  f.num_labels = c
+0000ba80: 6f6e 6669 672e 6e75 6d5f 6c61 6265 6c73  onfig.num_labels
+0000ba90: 0a20 2020 2020 2020 2073 656c 662e 6e5f  .        self.n_
+0000baa0: 7265 6c61 7469 6f6e 7320 3d20 636f 6e66  relations = conf
+0000bab0: 6967 2e6e 5f72 656c 6174 696f 6e73 0a20  ig.n_relations. 
+0000bac0: 2020 2020 2020 2073 656c 662e 6261 636b         self.back
+0000bad0: 626f 6e65 5f68 6964 6465 6e5f 7369 7a65  bone_hidden_size
+0000bae0: 203d 2063 6f6e 6669 672e 6869 6464 656e   = config.hidden
+0000baf0: 5f73 697a 650a 0a20 2020 2020 2020 2073  _size..        s
+0000bb00: 656c 662e 6272 6f73 203d 2042 726f 734d  elf.bros = BrosM
+0000bb10: 6f64 656c 2863 6f6e 6669 6729 0a20 2020  odel(config).   
+0000bb20: 2020 2020 2023 2028 636f 6e66 6967 2e63       # (config.c
+0000bb30: 6c61 7373 6966 6965 725f 6472 6f70 6f75  lassifier_dropou
+0000bb40: 7420 6966 2068 6173 6174 7472 2863 6f6e  t if hasattr(con
+0000bb50: 6669 672c 2022 636c 6173 7369 6669 6572  fig, "classifier
+0000bb60: 5f64 726f 706f 7574 2229 2065 6c73 6520  _dropout") else 
+0000bb70: 636f 6e66 6967 2e68 6964 6465 6e5f 6472  config.hidden_dr
+0000bb80: 6f70 6f75 745f 7072 6f62 290a 0a20 2020  opout_prob)..   
+0000bb90: 2020 2020 2073 656c 662e 656e 7469 7479       self.entity
+0000bba0: 5f6c 696e 6b65 7220 3d20 4272 6f73 5265  _linker = BrosRe
+0000bbb0: 6c61 7469 6f6e 4578 7472 6163 746f 7228  lationExtractor(
+0000bbc0: 636f 6e66 6967 290a 0a20 2020 2020 2020  config)..       
+0000bbd0: 2073 656c 662e 696e 6974 5f77 6569 6768   self.init_weigh
+0000bbe0: 7473 2829 0a0a 2020 2020 6465 6620 636f  ts()..    def co
+0000bbf0: 6e73 7472 7563 7428 0a20 2020 2020 2020  nstruct(.       
+0000bc00: 2073 656c 662c 0a20 2020 2020 2020 2069   self,.        i
+0000bc10: 6e70 7574 5f69 6473 3a20 4f70 7469 6f6e  nput_ids: Option
+0000bc20: 616c 5b6d 696e 6473 706f 7265 2e54 656e  al[mindspore.Ten
+0000bc30: 736f 725d 203d 204e 6f6e 652c 0a20 2020  sor] = None,.   
+0000bc40: 2020 2020 2062 626f 783a 204f 7074 696f       bbox: Optio
+0000bc50: 6e61 6c5b 6d69 6e64 7370 6f72 652e 5465  nal[mindspore.Te
+0000bc60: 6e73 6f72 5d20 3d20 4e6f 6e65 2c0a 2020  nsor] = None,.  
+0000bc70: 2020 2020 2020 6174 7465 6e74 696f 6e5f        attention_
+0000bc80: 6d61 736b 3a20 4f70 7469 6f6e 616c 5b6d  mask: Optional[m
+0000bc90: 696e 6473 706f 7265 2e54 656e 736f 725d  indspore.Tensor]
+0000bca0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+0000bcb0: 2062 626f 785f 6669 7273 745f 746f 6b65   bbox_first_toke
+0000bcc0: 6e5f 6d61 736b 3a20 4f70 7469 6f6e 616c  n_mask: Optional
+0000bcd0: 5b6d 696e 6473 706f 7265 2e54 656e 736f  [mindspore.Tenso
+0000bce0: 725d 203d 204e 6f6e 652c 0a20 2020 2020  r] = None,.     
+0000bcf0: 2020 2074 6f6b 656e 5f74 7970 655f 6964     token_type_id
+0000bd00: 733a 204f 7074 696f 6e61 6c5b 6d69 6e64  s: Optional[mind
+0000bd10: 7370 6f72 652e 5465 6e73 6f72 5d20 3d20  spore.Tensor] = 
+0000bd20: 4e6f 6e65 2c0a 2020 2020 2020 2020 706f  None,.        po
+0000bd30: 7369 7469 6f6e 5f69 6473 3a20 4f70 7469  sition_ids: Opti
+0000bd40: 6f6e 616c 5b6d 696e 6473 706f 7265 2e54  onal[mindspore.T
+0000bd50: 656e 736f 725d 203d 204e 6f6e 652c 0a20  ensor] = None,. 
+0000bd60: 2020 2020 2020 2068 6561 645f 6d61 736b         head_mask
+0000bd70: 3a20 4f70 7469 6f6e 616c 5b6d 696e 6473  : Optional[minds
+0000bd80: 706f 7265 2e54 656e 736f 725d 203d 204e  pore.Tensor] = N
+0000bd90: 6f6e 652c 0a20 2020 2020 2020 2069 6e70  one,.        inp
+0000bda0: 7574 735f 656d 6265 6473 3a20 4f70 7469  uts_embeds: Opti
+0000bdb0: 6f6e 616c 5b6d 696e 6473 706f 7265 2e54  onal[mindspore.T
+0000bdc0: 656e 736f 725d 203d 204e 6f6e 652c 0a20  ensor] = None,. 
+0000bdd0: 2020 2020 2020 206c 6162 656c 733a 204f         labels: O
+0000bde0: 7074 696f 6e61 6c5b 6d69 6e64 7370 6f72  ptional[mindspor
+0000bdf0: 652e 5465 6e73 6f72 5d20 3d20 4e6f 6e65  e.Tensor] = None
+0000be00: 2c0a 2020 2020 2020 2020 6f75 7470 7574  ,.        output
+0000be10: 5f61 7474 656e 7469 6f6e 733a 204f 7074  _attentions: Opt
+0000be20: 696f 6e61 6c5b 626f 6f6c 5d20 3d20 4e6f  ional[bool] = No
+0000be30: 6e65 2c0a 2020 2020 2020 2020 6f75 7470  ne,.        outp
+0000be40: 7574 5f68 6964 6465 6e5f 7374 6174 6573  ut_hidden_states
+0000be50: 3a20 4f70 7469 6f6e 616c 5b62 6f6f 6c5d  : Optional[bool]
+0000be60: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+0000be70: 2072 6574 7572 6e5f 6469 6374 3a20 4f70   return_dict: Op
+0000be80: 7469 6f6e 616c 5b62 6f6f 6c5d 203d 204e  tional[bool] = N
+0000be90: 6f6e 652c 0a20 2020 2029 202d 3e20 556e  one,.    ) -> Un
+0000bea0: 696f 6e5b 5475 706c 655b 6d69 6e64 7370  ion[Tuple[mindsp
+0000beb0: 6f72 652e 5465 6e73 6f72 5d2c 2054 6f6b  ore.Tensor], Tok
+0000bec0: 656e 436c 6173 7369 6669 6572 4f75 7470  enClassifierOutp
+0000bed0: 7574 5d3a 0a20 2020 2020 2020 2072 2222  ut]:.        r""
+0000bee0: 220a 2020 2020 2020 2020 5265 7475 726e  ".        Return
+0000bef0: 733a 0a0a 2020 2020 2020 2020 4578 616d  s:..        Exam
+0000bf00: 706c 6573 3a0a 0a20 2020 2020 2020 2060  ples:..        `
+0000bf10: 6060 7079 7468 6f6e 0a20 2020 2020 2020  ``python.       
+0000bf20: 203e 3e3e 2069 6d70 6f72 7420 746f 7263   >>> import torc
+0000bf30: 680a 2020 2020 2020 2020 3e3e 3e20 6672  h.        >>> fr
+0000bf40: 6f6d 2074 7261 6e73 666f 726d 6572 7320  om transformers 
+0000bf50: 696d 706f 7274 2042 726f 7350 726f 6365  import BrosProce
+0000bf60: 7373 6f72 2c20 4272 6f73 5370 6164 6545  ssor, BrosSpadeE
+0000bf70: 4c46 6f72 546f 6b65 6e43 6c61 7373 6966  LForTokenClassif
+0000bf80: 6963 6174 696f 6e0a 0a20 2020 2020 2020  ication..       
+0000bf90: 203e 3e3e 2070 726f 6365 7373 6f72 203d   >>> processor =
+0000bfa0: 2042 726f 7350 726f 6365 7373 6f72 2e66   BrosProcessor.f
+0000bfb0: 726f 6d5f 7072 6574 7261 696e 6564 2822  rom_pretrained("
+0000bfc0: 6a69 6e68 6f38 3334 352f 6272 6f73 2d62  jinho8345/bros-b
+0000bfd0: 6173 652d 756e 6361 7365 6422 290a 0a20  ase-uncased").. 
+0000bfe0: 2020 2020 2020 203e 3e3e 206d 6f64 656c         >>> model
+0000bff0: 203d 2042 726f 7353 7061 6465 454c 466f   = BrosSpadeELFo
+0000c000: 7254 6f6b 656e 436c 6173 7369 6669 6361  rTokenClassifica
+0000c010: 7469 6f6e 2e66 726f 6d5f 7072 6574 7261  tion.from_pretra
+0000c020: 696e 6564 2822 6a69 6e68 6f38 3334 352f  ined("jinho8345/
+0000c030: 6272 6f73 2d62 6173 652d 756e 6361 7365  bros-base-uncase
+0000c040: 6422 290a 0a20 2020 2020 2020 203e 3e3e  d")..        >>>
+0000c050: 2065 6e63 6f64 696e 6720 3d20 7072 6f63   encoding = proc
+0000c060: 6573 736f 7228 2248 656c 6c6f 2c20 6d79  essor("Hello, my
+0000c070: 2064 6f67 2069 7320 6375 7465 222c 2061   dog is cute", a
+0000c080: 6464 5f73 7065 6369 616c 5f74 6f6b 656e  dd_special_token
+0000c090: 733d 4661 6c73 652c 2072 6574 7572 6e5f  s=False, return_
+0000c0a0: 7465 6e73 6f72 733d 2270 7422 290a 2020  tensors="pt").  
+0000c0b0: 2020 2020 2020 3e3e 3e20 6262 6f78 203d        >>> bbox =
+0000c0c0: 2074 6f72 6368 2e74 656e 736f 7228 5b5b   torch.tensor([[
+0000c0d0: 5b30 2c20 302c 2031 2c20 315d 5d5d 292e  [0, 0, 1, 1]]]).
+0000c0e0: 7265 7065 6174 2831 2c20 656e 636f 6469  repeat(1, encodi
+0000c0f0: 6e67 5b22 696e 7075 745f 6964 7322 5d2e  ng["input_ids"].
+0000c100: 7368 6170 655b 2d31 5d2c 2031 290a 2020  shape[-1], 1).  
+0000c110: 2020 2020 2020 3e3e 3e20 656e 636f 6469        >>> encodi
+0000c120: 6e67 5b22 6262 6f78 225d 203d 2062 626f  ng["bbox"] = bbo
+0000c130: 780a 0a20 2020 2020 2020 203e 3e3e 206f  x..        >>> o
+0000c140: 7574 7075 7473 203d 206d 6f64 656c 282a  utputs = model(*
+0000c150: 2a65 6e63 6f64 696e 6729 0a20 2020 2020  *encoding).     
+0000c160: 2020 2060 6060 2222 220a 2020 2020 2020     ```""".      
+0000c170: 2020 7265 7475 726e 5f64 6963 7420 3d20    return_dict = 
+0000c180: 7265 7475 726e 5f64 6963 7420 6966 2072  return_dict if r
+0000c190: 6574 7572 6e5f 6469 6374 2069 7320 6e6f  eturn_dict is no
+0000c1a0: 7420 4e6f 6e65 2065 6c73 6520 7365 6c66  t None else self
+0000c1b0: 2e63 6f6e 6669 672e 7573 655f 7265 7475  .config.use_retu
+0000c1c0: 726e 5f64 6963 740a 0a20 2020 2020 2020  rn_dict..       
+0000c1d0: 206f 7574 7075 7473 203d 2073 656c 662e   outputs = self.
+0000c1e0: 6272 6f73 280a 2020 2020 2020 2020 2020  bros(.          
+0000c1f0: 2020 696e 7075 745f 6964 733d 696e 7075    input_ids=inpu
+0000c200: 745f 6964 732c 0a20 2020 2020 2020 2020  t_ids,.         
+0000c210: 2020 2062 626f 783d 6262 6f78 2c0a 2020     bbox=bbox,.  
+0000c220: 2020 2020 2020 2020 2020 6174 7465 6e74            attent
+0000c230: 696f 6e5f 6d61 736b 3d61 7474 656e 7469  ion_mask=attenti
+0000c240: 6f6e 5f6d 6173 6b2c 0a20 2020 2020 2020  on_mask,.       
+0000c250: 2020 2020 2074 6f6b 656e 5f74 7970 655f       token_type_
+0000c260: 6964 733d 746f 6b65 6e5f 7479 7065 5f69  ids=token_type_i
+0000c270: 6473 2c0a 2020 2020 2020 2020 2020 2020  ds,.            
+0000c280: 706f 7369 7469 6f6e 5f69 6473 3d70 6f73  position_ids=pos
+0000c290: 6974 696f 6e5f 6964 732c 0a20 2020 2020  ition_ids,.     
+0000c2a0: 2020 2020 2020 2068 6561 645f 6d61 736b         head_mask
+0000c2b0: 3d68 6561 645f 6d61 736b 2c0a 2020 2020  =head_mask,.    
+0000c2c0: 2020 2020 2020 2020 696e 7075 7473 5f65          inputs_e
+0000c2d0: 6d62 6564 733d 696e 7075 7473 5f65 6d62  mbeds=inputs_emb
+0000c2e0: 6564 732c 0a20 2020 2020 2020 2020 2020  eds,.           
+0000c2f0: 206f 7574 7075 745f 6174 7465 6e74 696f   output_attentio
+0000c300: 6e73 3d6f 7574 7075 745f 6174 7465 6e74  ns=output_attent
+0000c310: 696f 6e73 2c0a 2020 2020 2020 2020 2020  ions,.          
+0000c320: 2020 6f75 7470 7574 5f68 6964 6465 6e5f    output_hidden_
+0000c330: 7374 6174 6573 3d6f 7574 7075 745f 6869  states=output_hi
+0000c340: 6464 656e 5f73 7461 7465 732c 0a20 2020  dden_states,.   
+0000c350: 2020 2020 2020 2020 2072 6574 7572 6e5f           return_
+0000c360: 6469 6374 3d72 6574 7572 6e5f 6469 6374  dict=return_dict
+0000c370: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
+0000c380: 2020 2020 206c 6173 745f 6869 6464 656e       last_hidden
+0000c390: 5f73 7461 7465 7320 3d20 6f75 7470 7574  _states = output
+0000c3a0: 735b 305d 0a20 2020 2020 2020 206c 6173  s[0].        las
+0000c3b0: 745f 6869 6464 656e 5f73 7461 7465 7320  t_hidden_states 
+0000c3c0: 3d20 6c61 7374 5f68 6964 6465 6e5f 7374  = last_hidden_st
+0000c3d0: 6174 6573 2e73 7761 7061 7865 7328 302c  ates.swapaxes(0,
+0000c3e0: 2031 290a 0a20 2020 2020 2020 206c 6f67   1)..        log
+0000c3f0: 6974 7320 3d20 7365 6c66 2e65 6e74 6974  its = self.entit
+0000c400: 795f 6c69 6e6b 6572 286c 6173 745f 6869  y_linker(last_hi
+0000c410: 6464 656e 5f73 7461 7465 732c 206c 6173  dden_states, las
+0000c420: 745f 6869 6464 656e 5f73 7461 7465 7329  t_hidden_states)
+0000c430: 2e73 7175 6565 7a65 2830 290a 0a20 2020  .squeeze(0)..   
+0000c440: 2020 2020 206c 6f73 7320 3d20 4e6f 6e65       loss = None
+0000c450: 0a20 2020 2020 2020 2069 6620 6c61 6265  .        if labe
+0000c460: 6c73 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ls is not None:.
+0000c470: 2020 2020 2020 2020 2020 2020 6261 7463              batc
+0000c480: 685f 7369 7a65 2c20 6d61 785f 7365 715f  h_size, max_seq_
+0000c490: 6c65 6e67 7468 203d 2061 7474 656e 7469  length = attenti
+0000c4a0: 6f6e 5f6d 6173 6b2e 7368 6170 650a 0a20  on_mask.shape.. 
+0000c4b0: 2020 2020 2020 2020 2020 2073 656c 665f             self_
+0000c4c0: 746f 6b65 6e5f 6d61 736b 203d 206f 7073  token_mask = ops
+0000c4d0: 2e65 7965 286d 6178 5f73 6571 5f6c 656e  .eye(max_seq_len
+0000c4e0: 6774 682c 206d 6178 5f73 6571 5f6c 656e  gth, max_seq_len
+0000c4f0: 6774 6820 2b20 3129 2e62 6f6f 6c28 290a  gth + 1).bool().
+0000c500: 0a20 2020 2020 2020 2020 2020 206d 6173  .            mas
+0000c510: 6b20 3d20 6262 6f78 5f66 6972 7374 5f74  k = bbox_first_t
+0000c520: 6f6b 656e 5f6d 6173 6b2e 7669 6577 282d  oken_mask.view(-
+0000c530: 3129 0a20 2020 2020 2020 2020 2020 2062  1).            b
+0000c540: 626f 785f 6669 7273 745f 746f 6b65 6e5f  box_first_token_
+0000c550: 6d61 736b 203d 206f 7073 2e63 6174 280a  mask = ops.cat(.
+0000c560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c570: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+0000c580: 2020 2020 2020 7e62 626f 785f 6669 7273        ~bbox_firs
+0000c590: 745f 746f 6b65 6e5f 6d61 736b 2c0a 2020  t_token_mask,.  
+0000c5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000c5b0: 2020 6f70 732e 7a65 726f 7328 2862 6174    ops.zeros((bat
+0000c5c0: 6368 5f73 697a 652c 2031 292c 2064 7479  ch_size, 1), dty
+0000c5d0: 7065 3d6d 696e 6473 706f 7265 2e62 6f6f  pe=mindspore.boo
+0000c5e0: 6c5f 292c 0a20 2020 2020 2020 2020 2020  l_),.           
+0000c5f0: 2020 2020 205d 2c0a 2020 2020 2020 2020       ],.        
+0000c600: 2020 2020 2020 2020 6178 6973 3d31 2c0a          axis=1,.
+0000c610: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0000c620: 2020 2020 2020 2020 2020 6c6f 6769 7473            logits
+0000c630: 203d 206c 6f67 6974 732e 6d61 736b 6564   = logits.masked
+0000c640: 5f66 696c 6c28 6262 6f78 5f66 6972 7374  _fill(bbox_first
+0000c650: 5f74 6f6b 656e 5f6d 6173 6b5b 3a2c 204e  _token_mask[:, N
+0000c660: 6f6e 652c 203a 5d2c 2066 696e 666f 286c  one, :], finfo(l
+0000c670: 6f67 6974 732e 6474 7970 652c 2027 6d69  ogits.dtype, 'mi
+0000c680: 6e27 2929 0a20 2020 2020 2020 2020 2020  n')).           
+0000c690: 206c 6f67 6974 7320 3d20 6c6f 6769 7473   logits = logits
+0000c6a0: 2e6d 6173 6b65 645f 6669 6c6c 2873 656c  .masked_fill(sel
+0000c6b0: 665f 746f 6b65 6e5f 6d61 736b 5b4e 6f6e  f_token_mask[Non
+0000c6c0: 652c 203a 2c20 3a5d 2c20 6669 6e66 6f28  e, :, :], finfo(
+0000c6d0: 6c6f 6769 7473 2e64 7479 7065 2c20 276d  logits.dtype, 'm
+0000c6e0: 696e 2729 290a 0a20 2020 2020 2020 2020  in'))..         
+0000c6f0: 2020 206c 6f73 7320 3d20 6f70 732e 6372     loss = ops.cr
+0000c700: 6f73 735f 656e 7472 6f70 7928 6c6f 6769  oss_entropy(logi
+0000c710: 7473 2e76 6965 7728 2d31 2c20 6d61 785f  ts.view(-1, max_
+0000c720: 7365 715f 6c65 6e67 7468 202b 2031 295b  seq_length + 1)[
+0000c730: 6d61 736b 5d2c 206c 6162 656c 732e 7669  mask], labels.vi
+0000c740: 6577 282d 3129 5b6d 6173 6b5d 290a 0a20  ew(-1)[mask]).. 
+0000c750: 2020 2020 2020 2069 6620 6e6f 7420 7265         if not re
+0000c760: 7475 726e 5f64 6963 743a 0a20 2020 2020  turn_dict:.     
+0000c770: 2020 2020 2020 206f 7574 7075 7420 3d20         output = 
+0000c780: 286c 6f67 6974 732c 2920 2b20 6f75 7470  (logits,) + outp
+0000c790: 7574 735b 323a 5d0a 2020 2020 2020 2020  uts[2:].        
+0000c7a0: 2020 2020 7265 7475 726e 2028 286c 6f73      return ((los
+0000c7b0: 732c 2920 2b20 6f75 7470 7574 2920 6966  s,) + output) if
+0000c7c0: 206c 6f73 7320 6973 206e 6f74 204e 6f6e   loss is not Non
+0000c7d0: 6520 656c 7365 206f 7574 7075 740a 0a20  e else output.. 
+0000c7e0: 2020 2020 2020 2072 6574 7572 6e20 546f         return To
+0000c7f0: 6b65 6e43 6c61 7373 6966 6965 724f 7574  kenClassifierOut
+0000c800: 7075 7428 0a20 2020 2020 2020 2020 2020  put(.           
+0000c810: 206c 6f73 733d 6c6f 7373 2c0a 2020 2020   loss=loss,.    
+0000c820: 2020 2020 2020 2020 6c6f 6769 7473 3d6c          logits=l
+0000c830: 6f67 6974 732c 0a20 2020 2020 2020 2020  ogits,.         
+0000c840: 2020 2068 6964 6465 6e5f 7374 6174 6573     hidden_states
+0000c850: 3d6f 7574 7075 7473 2e68 6964 6465 6e5f  =outputs.hidden_
+0000c860: 7374 6174 6573 2c0a 2020 2020 2020 2020  states,.        
+0000c870: 2020 2020 6174 7465 6e74 696f 6e73 3d6f      attentions=o
+0000c880: 7574 7075 7473 2e61 7474 656e 7469 6f6e  utputs.attention
+0000c890: 732c 0a20 2020 2020 2020 2029 0a0a 5f5f  s,.        )..__
+0000c8a0: 616c 6c5f 5f20 3d20 5b0a 2020 2020 2242  all__ = [.    "B
+0000c8b0: 726f 7350 7265 5472 6169 6e65 644d 6f64  rosPreTrainedMod
+0000c8c0: 656c 222c 0a20 2020 2022 4272 6f73 4d6f  el",.    "BrosMo
+0000c8d0: 6465 6c22 2c0a 2020 2020 2242 726f 7346  del",.    "BrosF
+0000c8e0: 6f72 546f 6b65 6e43 6c61 7373 6966 6963  orTokenClassific
+0000c8f0: 6174 696f 6e22 2c0a 2020 2020 2242 726f  ation",.    "Bro
+0000c900: 7353 7061 6465 4545 466f 7254 6f6b 656e  sSpadeEEForToken
+0000c910: 436c 6173 7369 6669 6361 7469 6f6e 222c  Classification",
+0000c920: 0a20 2020 2022 4272 6f73 5370 6164 6545  .    "BrosSpadeE
+0000c930: 4c46 6f72 546f 6b65 6e43 6c61 7373 6966  LForTokenClassif
+0000c940: 6963 6174 696f 6e22 2c0a 5d0a            ication",.].
```

## mindnlp/transformers/models/bros/processing_bros.py

```diff
@@ -0,0 +1,264 @@
+00000000: 2320 636f 6469 6e67 3d75 7466 2d38 0a23  # coding=utf-8.#
+00000010: 2043 6f70 7972 6967 6874 2032 3032 3320   Copyright 2023 
+00000020: 5468 6520 4875 6767 696e 6746 6163 6520  The HuggingFace 
+00000030: 496e 632e 2074 6561 6d2e 0a23 0a23 204c  Inc. team..#.# L
+00000040: 6963 656e 7365 6420 756e 6465 7220 7468  icensed under th
+00000050: 6520 4170 6163 6865 204c 6963 656e 7365  e Apache License
+00000060: 2c20 5665 7273 696f 6e20 322e 3020 2874  , Version 2.0 (t
+00000070: 6865 2022 4c69 6365 6e73 6522 293b 0a23  he "License");.#
+00000080: 2079 6f75 206d 6179 206e 6f74 2075 7365   you may not use
+00000090: 2074 6869 7320 6669 6c65 2065 7863 6570   this file excep
+000000a0: 7420 696e 2063 6f6d 706c 6961 6e63 6520  t in compliance 
+000000b0: 7769 7468 2074 6865 204c 6963 656e 7365  with the License
+000000c0: 2e0a 2320 596f 7520 6d61 7920 6f62 7461  ..# You may obta
+000000d0: 696e 2061 2063 6f70 7920 6f66 2074 6865  in a copy of the
+000000e0: 204c 6963 656e 7365 2061 740a 230a 2320   License at.#.# 
+000000f0: 2020 2020 6874 7470 3a2f 2f77 7777 2e61      http://www.a
+00000100: 7061 6368 652e 6f72 672f 6c69 6365 6e73  pache.org/licens
+00000110: 6573 2f4c 4943 454e 5345 2d32 2e30 0a23  es/LICENSE-2.0.#
+00000120: 0a23 2055 6e6c 6573 7320 7265 7175 6972  .# Unless requir
+00000130: 6564 2062 7920 6170 706c 6963 6162 6c65  ed by applicable
+00000140: 206c 6177 206f 7220 6167 7265 6564 2074   law or agreed t
+00000150: 6f20 696e 2077 7269 7469 6e67 2c20 736f  o in writing, so
+00000160: 6674 7761 7265 0a23 2064 6973 7472 6962  ftware.# distrib
+00000170: 7574 6564 2075 6e64 6572 2074 6865 204c  uted under the L
+00000180: 6963 656e 7365 2069 7320 6469 7374 7269  icense is distri
+00000190: 6275 7465 6420 6f6e 2061 6e20 2241 5320  buted on an "AS 
+000001a0: 4953 2220 4241 5349 532c 0a23 2057 4954  IS" BASIS,.# WIT
+000001b0: 484f 5554 2057 4152 5241 4e54 4945 5320  HOUT WARRANTIES 
+000001c0: 4f52 2043 4f4e 4449 5449 4f4e 5320 4f46  OR CONDITIONS OF
+000001d0: 2041 4e59 204b 494e 442c 2065 6974 6865   ANY KIND, eithe
+000001e0: 7220 6578 7072 6573 7320 6f72 2069 6d70  r express or imp
+000001f0: 6c69 6564 2e0a 2320 5365 6520 7468 6520  lied..# See the 
+00000200: 4c69 6365 6e73 6520 666f 7220 7468 6520  License for the 
+00000210: 7370 6563 6966 6963 206c 616e 6775 6167  specific languag
+00000220: 6520 676f 7665 726e 696e 6720 7065 726d  e governing perm
+00000230: 6973 7369 6f6e 7320 616e 640a 2320 6c69  issions and.# li
+00000240: 6d69 7461 7469 6f6e 7320 756e 6465 7220  mitations under 
+00000250: 7468 6520 4c69 6365 6e73 652e 0a22 2222  the License.."""
+00000260: 0a50 726f 6365 7373 6f72 2063 6c61 7373  .Processor class
+00000270: 2066 6f72 2042 726f 732e 0a22 2222 0a0a   for Bros.."""..
+00000280: 6672 6f6d 2074 7970 696e 6720 696d 706f  from typing impo
+00000290: 7274 204c 6973 742c 204f 7074 696f 6e61  rt List, Optiona
+000002a0: 6c2c 2055 6e69 6f6e 0a0a 6672 6f6d 202e  l, Union..from .
+000002b0: 2e2e 7072 6f63 6573 7369 6e67 5f75 7469  ..processing_uti
+000002c0: 6c73 2069 6d70 6f72 7420 5072 6f63 6573  ls import Proces
+000002d0: 736f 724d 6978 696e 0a66 726f 6d20 2e2e  sorMixin.from ..
+000002e0: 2e74 6f6b 656e 697a 6174 696f 6e5f 7574  .tokenization_ut
+000002f0: 696c 735f 6261 7365 2069 6d70 6f72 7420  ils_base import 
+00000300: 4261 7463 6845 6e63 6f64 696e 672c 2050  BatchEncoding, P
+00000310: 6164 6469 6e67 5374 7261 7465 6779 2c20  addingStrategy, 
+00000320: 5072 6554 6f6b 656e 697a 6564 496e 7075  PreTokenizedInpu
+00000330: 742c 2054 6578 7449 6e70 7574 2c20 5472  t, TextInput, Tr
+00000340: 756e 6361 7469 6f6e 5374 7261 7465 6779  uncationStrategy
+00000350: 0a66 726f 6d20 2e2e 2e2e 7574 696c 7320  .from ....utils 
+00000360: 696d 706f 7274 2054 656e 736f 7254 7970  import TensorTyp
+00000370: 650a 0a0a 636c 6173 7320 4272 6f73 5072  e...class BrosPr
+00000380: 6f63 6573 736f 7228 5072 6f63 6573 736f  ocessor(Processo
+00000390: 724d 6978 696e 293a 0a20 2020 2072 2222  rMixin):.    r""
+000003a0: 220a 2020 2020 436f 6e73 7472 7563 7473  ".    Constructs
+000003b0: 2061 2042 726f 7320 7072 6f63 6573 736f   a Bros processo
+000003c0: 7220 7768 6963 6820 7772 6170 7320 6120  r which wraps a 
+000003d0: 4245 5254 2074 6f6b 656e 697a 6572 2e0a  BERT tokenizer..
+000003e0: 0a20 2020 205b 6042 726f 7350 726f 6365  .    [`BrosProce
+000003f0: 7373 6f72 605d 206f 6666 6572 7320 616c  ssor`] offers al
+00000400: 6c20 7468 6520 6675 6e63 7469 6f6e 616c  l the functional
+00000410: 6974 6965 7320 6f66 205b 6042 6572 7454  ities of [`BertT
+00000420: 6f6b 656e 697a 6572 4661 7374 605d 2e20  okenizerFast`]. 
+00000430: 5365 6520 7468 6520 646f 6373 7472 696e  See the docstrin
+00000440: 6720 6f66 0a20 2020 205b 607e 4272 6f73  g of.    [`~Bros
+00000450: 5072 6f63 6573 736f 722e 5f5f 6361 6c6c  Processor.__call
+00000460: 5f5f 605d 2061 6e64 205b 607e 4272 6f73  __`] and [`~Bros
+00000470: 5072 6f63 6573 736f 722e 6465 636f 6465  Processor.decode
+00000480: 605d 2066 6f72 206d 6f72 6520 696e 666f  `] for more info
+00000490: 726d 6174 696f 6e2e 0a0a 2020 2020 4172  rmation...    Ar
+000004a0: 6773 3a0a 2020 2020 2020 2020 746f 6b65  gs:.        toke
+000004b0: 6e69 7a65 7220 2860 4265 7274 546f 6b65  nizer (`BertToke
+000004c0: 6e69 7a65 7246 6173 7460 2c20 2a6f 7074  nizerFast`, *opt
+000004d0: 696f 6e61 6c2a 293a 0a20 2020 2020 2020  ional*):.       
+000004e0: 2020 2020 2041 6e20 696e 7374 616e 6365       An instance
+000004f0: 206f 6620 5b27 4265 7274 546f 6b65 6e69   of ['BertTokeni
+00000500: 7a65 7246 6173 7460 5d2e 2054 6865 2074  zerFast`]. The t
+00000510: 6f6b 656e 697a 6572 2069 7320 6120 7265  okenizer is a re
+00000520: 7175 6972 6564 2069 6e70 7574 2e0a 2020  quired input..  
+00000530: 2020 2222 220a 0a20 2020 2061 7474 7269    """..    attri
+00000540: 6275 7465 7320 3d20 5b22 746f 6b65 6e69  butes = ["tokeni
+00000550: 7a65 7222 5d0a 2020 2020 746f 6b65 6e69  zer"].    tokeni
+00000560: 7a65 725f 636c 6173 7320 3d20 2822 4265  zer_class = ("Be
+00000570: 7274 546f 6b65 6e69 7a65 7222 2c20 2242  rtTokenizer", "B
+00000580: 6572 7454 6f6b 656e 697a 6572 4661 7374  ertTokenizerFast
+00000590: 2229 0a0a 2020 2020 6465 6620 5f5f 696e  ")..    def __in
+000005a0: 6974 5f5f 2873 656c 662c 2074 6f6b 656e  it__(self, token
+000005b0: 697a 6572 3d4e 6f6e 652c 202a 2a6b 7761  izer=None, **kwa
+000005c0: 7267 7329 3a0a 2020 2020 2020 2020 6966  rgs):.        if
+000005d0: 2074 6f6b 656e 697a 6572 2069 7320 4e6f   tokenizer is No
+000005e0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+000005f0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
+00000600: 2822 596f 7520 6e65 6564 2074 6f20 7370  ("You need to sp
+00000610: 6563 6966 7920 6120 6074 6f6b 656e 697a  ecify a `tokeniz
+00000620: 6572 602e 2229 0a0a 2020 2020 2020 2020  er`.")..        
+00000630: 7375 7065 7228 292e 5f5f 696e 6974 5f5f  super().__init__
+00000640: 2874 6f6b 656e 697a 6572 290a 0a20 2020  (tokenizer)..   
+00000650: 2064 6566 205f 5f63 616c 6c5f 5f28 0a20   def __call__(. 
+00000660: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+00000670: 2020 2020 2074 6578 743a 2055 6e69 6f6e       text: Union
+00000680: 5b54 6578 7449 6e70 7574 2c20 5072 6554  [TextInput, PreT
+00000690: 6f6b 656e 697a 6564 496e 7075 742c 204c  okenizedInput, L
+000006a0: 6973 745b 5465 7874 496e 7075 745d 2c20  ist[TextInput], 
+000006b0: 4c69 7374 5b50 7265 546f 6b65 6e69 7a65  List[PreTokenize
+000006c0: 6449 6e70 7574 5d5d 203d 204e 6f6e 652c  dInput]] = None,
+000006d0: 0a20 2020 2020 2020 2061 6464 5f73 7065  .        add_spe
+000006e0: 6369 616c 5f74 6f6b 656e 733a 2062 6f6f  cial_tokens: boo
+000006f0: 6c20 3d20 5472 7565 2c0a 2020 2020 2020  l = True,.      
+00000700: 2020 7061 6464 696e 673a 2055 6e69 6f6e    padding: Union
+00000710: 5b62 6f6f 6c2c 2073 7472 2c20 5061 6464  [bool, str, Padd
+00000720: 696e 6753 7472 6174 6567 795d 203d 2046  ingStrategy] = F
+00000730: 616c 7365 2c0a 2020 2020 2020 2020 7472  alse,.        tr
+00000740: 756e 6361 7469 6f6e 3a20 556e 696f 6e5b  uncation: Union[
+00000750: 626f 6f6c 2c20 7374 722c 2054 7275 6e63  bool, str, Trunc
+00000760: 6174 696f 6e53 7472 6174 6567 795d 203d  ationStrategy] =
+00000770: 204e 6f6e 652c 0a20 2020 2020 2020 206d   None,.        m
+00000780: 6178 5f6c 656e 6774 683a 204f 7074 696f  ax_length: Optio
+00000790: 6e61 6c5b 696e 745d 203d 204e 6f6e 652c  nal[int] = None,
+000007a0: 0a20 2020 2020 2020 2073 7472 6964 653a  .        stride:
+000007b0: 2069 6e74 203d 2030 2c0a 2020 2020 2020   int = 0,.      
+000007c0: 2020 7061 645f 746f 5f6d 756c 7469 706c    pad_to_multipl
+000007d0: 655f 6f66 3a20 4f70 7469 6f6e 616c 5b69  e_of: Optional[i
+000007e0: 6e74 5d20 3d20 4e6f 6e65 2c0a 2020 2020  nt] = None,.    
+000007f0: 2020 2020 7265 7475 726e 5f74 6f6b 656e      return_token
+00000800: 5f74 7970 655f 6964 733a 204f 7074 696f  _type_ids: Optio
+00000810: 6e61 6c5b 626f 6f6c 5d20 3d20 4e6f 6e65  nal[bool] = None
+00000820: 2c0a 2020 2020 2020 2020 7265 7475 726e  ,.        return
+00000830: 5f61 7474 656e 7469 6f6e 5f6d 6173 6b3a  _attention_mask:
+00000840: 204f 7074 696f 6e61 6c5b 626f 6f6c 5d20   Optional[bool] 
+00000850: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00000860: 7265 7475 726e 5f6f 7665 7266 6c6f 7769  return_overflowi
+00000870: 6e67 5f74 6f6b 656e 733a 2062 6f6f 6c20  ng_tokens: bool 
+00000880: 3d20 4661 6c73 652c 0a20 2020 2020 2020  = False,.       
+00000890: 2072 6574 7572 6e5f 7370 6563 6961 6c5f   return_special_
+000008a0: 746f 6b65 6e73 5f6d 6173 6b3a 2062 6f6f  tokens_mask: boo
+000008b0: 6c20 3d20 4661 6c73 652c 0a20 2020 2020  l = False,.     
+000008c0: 2020 2072 6574 7572 6e5f 6f66 6673 6574     return_offset
+000008d0: 735f 6d61 7070 696e 673a 2062 6f6f 6c20  s_mapping: bool 
+000008e0: 3d20 4661 6c73 652c 0a20 2020 2020 2020  = False,.       
+000008f0: 2072 6574 7572 6e5f 6c65 6e67 7468 3a20   return_length: 
+00000900: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
+00000910: 2020 2020 2020 7665 7262 6f73 653a 2062        verbose: b
+00000920: 6f6f 6c20 3d20 5472 7565 2c0a 2020 2020  ool = True,.    
+00000930: 2020 2020 7265 7475 726e 5f74 656e 736f      return_tenso
+00000940: 7273 3a20 4f70 7469 6f6e 616c 5b55 6e69  rs: Optional[Uni
+00000950: 6f6e 5b73 7472 2c20 5465 6e73 6f72 5479  on[str, TensorTy
+00000960: 7065 5d5d 203d 204e 6f6e 652c 0a20 2020  pe]] = None,.   
+00000970: 2020 2020 202a 2a6b 7761 7267 732c 0a20       **kwargs,. 
+00000980: 2020 2029 202d 3e20 4261 7463 6845 6e63     ) -> BatchEnc
+00000990: 6f64 696e 673a 0a20 2020 2020 2020 2022  oding:.        "
+000009a0: 2222 0a20 2020 2020 2020 2054 6869 7320  "".        This 
+000009b0: 6d65 7468 6f64 2075 7365 7320 5b60 4265  method uses [`Be
+000009c0: 7274 546f 6b65 6e69 7a65 7246 6173 742e  rtTokenizerFast.
+000009d0: 5f5f 6361 6c6c 5f5f 605d 2074 6f20 7072  __call__`] to pr
+000009e0: 6570 6172 6520 7465 7874 2066 6f72 2074  epare text for t
+000009f0: 6865 206d 6f64 656c 2e0a 0a20 2020 2020  he model...     
+00000a00: 2020 2050 6c65 6173 6520 7265 6665 7220     Please refer 
+00000a10: 746f 2074 6865 2064 6f63 7374 7269 6e67  to the docstring
+00000a20: 206f 6620 7468 6520 6162 6f76 6520 7477   of the above tw
+00000a30: 6f20 6d65 7468 6f64 7320 666f 7220 6d6f  o methods for mo
+00000a40: 7265 2069 6e66 6f72 6d61 7469 6f6e 2e0a  re information..
+00000a50: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00000a60: 2020 2020 656e 636f 6469 6e67 203d 2073      encoding = s
+00000a70: 656c 662e 746f 6b65 6e69 7a65 7228 0a20  elf.tokenizer(. 
+00000a80: 2020 2020 2020 2020 2020 2074 6578 743d             text=
+00000a90: 7465 7874 2c0a 2020 2020 2020 2020 2020  text,.          
+00000aa0: 2020 6164 645f 7370 6563 6961 6c5f 746f    add_special_to
+00000ab0: 6b65 6e73 3d61 6464 5f73 7065 6369 616c  kens=add_special
+00000ac0: 5f74 6f6b 656e 732c 0a20 2020 2020 2020  _tokens,.       
+00000ad0: 2020 2020 2070 6164 6469 6e67 3d70 6164       padding=pad
+00000ae0: 6469 6e67 2c0a 2020 2020 2020 2020 2020  ding,.          
+00000af0: 2020 7472 756e 6361 7469 6f6e 3d74 7275    truncation=tru
+00000b00: 6e63 6174 696f 6e2c 0a20 2020 2020 2020  ncation,.       
+00000b10: 2020 2020 206d 6178 5f6c 656e 6774 683d       max_length=
+00000b20: 6d61 785f 6c65 6e67 7468 2c0a 2020 2020  max_length,.    
+00000b30: 2020 2020 2020 2020 7374 7269 6465 3d73          stride=s
+00000b40: 7472 6964 652c 0a20 2020 2020 2020 2020  tride,.         
+00000b50: 2020 2070 6164 5f74 6f5f 6d75 6c74 6970     pad_to_multip
+00000b60: 6c65 5f6f 663d 7061 645f 746f 5f6d 756c  le_of=pad_to_mul
+00000b70: 7469 706c 655f 6f66 2c0a 2020 2020 2020  tiple_of,.      
+00000b80: 2020 2020 2020 7265 7475 726e 5f74 6f6b        return_tok
+00000b90: 656e 5f74 7970 655f 6964 733d 7265 7475  en_type_ids=retu
+00000ba0: 726e 5f74 6f6b 656e 5f74 7970 655f 6964  rn_token_type_id
+00000bb0: 732c 0a20 2020 2020 2020 2020 2020 2072  s,.            r
+00000bc0: 6574 7572 6e5f 6174 7465 6e74 696f 6e5f  eturn_attention_
+00000bd0: 6d61 736b 3d72 6574 7572 6e5f 6174 7465  mask=return_atte
+00000be0: 6e74 696f 6e5f 6d61 736b 2c0a 2020 2020  ntion_mask,.    
+00000bf0: 2020 2020 2020 2020 7265 7475 726e 5f6f          return_o
+00000c00: 7665 7266 6c6f 7769 6e67 5f74 6f6b 656e  verflowing_token
+00000c10: 733d 7265 7475 726e 5f6f 7665 7266 6c6f  s=return_overflo
+00000c20: 7769 6e67 5f74 6f6b 656e 732c 0a20 2020  wing_tokens,.   
+00000c30: 2020 2020 2020 2020 2072 6574 7572 6e5f           return_
+00000c40: 7370 6563 6961 6c5f 746f 6b65 6e73 5f6d  special_tokens_m
+00000c50: 6173 6b3d 7265 7475 726e 5f73 7065 6369  ask=return_speci
+00000c60: 616c 5f74 6f6b 656e 735f 6d61 736b 2c0a  al_tokens_mask,.
+00000c70: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00000c80: 726e 5f6f 6666 7365 7473 5f6d 6170 7069  rn_offsets_mappi
+00000c90: 6e67 3d72 6574 7572 6e5f 6f66 6673 6574  ng=return_offset
+00000ca0: 735f 6d61 7070 696e 672c 0a20 2020 2020  s_mapping,.     
+00000cb0: 2020 2020 2020 2072 6574 7572 6e5f 6c65         return_le
+00000cc0: 6e67 7468 3d72 6574 7572 6e5f 6c65 6e67  ngth=return_leng
+00000cd0: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
+00000ce0: 7665 7262 6f73 653d 7665 7262 6f73 652c  verbose=verbose,
+00000cf0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00000d00: 7572 6e5f 7465 6e73 6f72 733d 7265 7475  urn_tensors=retu
+00000d10: 726e 5f74 656e 736f 7273 2c0a 2020 2020  rn_tensors,.    
+00000d20: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
+00000d30: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
+00000d40: 2020 2020 2072 6574 7572 6e20 656e 636f       return enco
+00000d50: 6469 6e67 0a0a 2020 2020 6465 6620 6261  ding..    def ba
+00000d60: 7463 685f 6465 636f 6465 2873 656c 662c  tch_decode(self,
+00000d70: 202a 6172 6773 2c20 2a2a 6b77 6172 6773   *args, **kwargs
+00000d80: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
+00000d90: 2020 2020 2020 2054 6869 7320 6d65 7468         This meth
+00000da0: 6f64 2066 6f72 7761 7264 7320 616c 6c20  od forwards all 
+00000db0: 6974 7320 6172 6775 6d65 6e74 7320 746f  its arguments to
+00000dc0: 2042 6572 7454 6f6b 656e 697a 6572 4661   BertTokenizerFa
+00000dd0: 7374 2773 205b 607e 5072 6554 7261 696e  st's [`~PreTrain
+00000de0: 6564 546f 6b65 6e69 7a65 722e 6261 7463  edTokenizer.batc
+00000df0: 685f 6465 636f 6465 605d 2e20 506c 6561  h_decode`]. Plea
+00000e00: 7365 0a20 2020 2020 2020 2072 6566 6572  se.        refer
+00000e10: 2074 6f20 7468 6520 646f 6373 7472 696e   to the docstrin
+00000e20: 6720 6f66 2074 6869 7320 6d65 7468 6f64  g of this method
+00000e30: 2066 6f72 206d 6f72 6520 696e 666f 726d   for more inform
+00000e40: 6174 696f 6e2e 0a20 2020 2020 2020 2022  ation..        "
+00000e50: 2222 0a20 2020 2020 2020 2072 6574 7572  "".        retur
+00000e60: 6e20 7365 6c66 2e74 6f6b 656e 697a 6572  n self.tokenizer
+00000e70: 2e62 6174 6368 5f64 6563 6f64 6528 2a61  .batch_decode(*a
+00000e80: 7267 732c 202a 2a6b 7761 7267 7329 0a0a  rgs, **kwargs)..
+00000e90: 2020 2020 6465 6620 6465 636f 6465 2873      def decode(s
+00000ea0: 656c 662c 202a 6172 6773 2c20 2a2a 6b77  elf, *args, **kw
+00000eb0: 6172 6773 293a 0a20 2020 2020 2020 2022  args):.        "
+00000ec0: 2222 0a20 2020 2020 2020 2054 6869 7320  "".        This 
+00000ed0: 6d65 7468 6f64 2066 6f72 7761 7264 7320  method forwards 
+00000ee0: 616c 6c20 6974 7320 6172 6775 6d65 6e74  all its argument
+00000ef0: 7320 746f 2042 6572 7454 6f6b 656e 697a  s to BertTokeniz
+00000f00: 6572 4661 7374 2773 205b 607e 5072 6554  erFast's [`~PreT
+00000f10: 7261 696e 6564 546f 6b65 6e69 7a65 722e  rainedTokenizer.
+00000f20: 6465 636f 6465 605d 2e20 506c 6561 7365  decode`]. Please
+00000f30: 2072 6566 6572 2074 6f0a 2020 2020 2020   refer to.      
+00000f40: 2020 7468 6520 646f 6373 7472 696e 6720    the docstring 
+00000f50: 6f66 2074 6869 7320 6d65 7468 6f64 2066  of this method f
+00000f60: 6f72 206d 6f72 6520 696e 666f 726d 6174  or more informat
+00000f70: 696f 6e2e 0a20 2020 2020 2020 2022 2222  ion..        """
+00000f80: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00000f90: 7365 6c66 2e74 6f6b 656e 697a 6572 2e64  self.tokenizer.d
+00000fa0: 6563 6f64 6528 2a61 7267 732c 202a 2a6b  ecode(*args, **k
+00000fb0: 7761 7267 7329 0a0a 2020 2020 4070 726f  wargs)..    @pro
+00000fc0: 7065 7274 790a 2020 2020 6465 6620 6d6f  perty.    def mo
+00000fd0: 6465 6c5f 696e 7075 745f 6e61 6d65 7328  del_input_names(
+00000fe0: 7365 6c66 293a 0a20 2020 2020 2020 2074  self):.        t
+00000ff0: 6f6b 656e 697a 6572 5f69 6e70 7574 5f6e  okenizer_input_n
+00001000: 616d 6573 203d 2073 656c 662e 746f 6b65  ames = self.toke
+00001010: 6e69 7a65 722e 6d6f 6465 6c5f 696e 7075  nizer.model_inpu
+00001020: 745f 6e61 6d65 730a 2020 2020 2020 2020  t_names.        
+00001030: 7265 7475 726e 206c 6973 7428 6469 6374  return list(dict
+00001040: 2e66 726f 6d6b 6579 7328 746f 6b65 6e69  .fromkeys(tokeni
+00001050: 7a65 725f 696e 7075 745f 6e61 6d65 7329  zer_input_names)
+00001060: 290a 0a5f 5f61 6c6c 5f5f 203d 205b 2742  )..__all__ = ['B
+00001070: 726f 7350 726f 6365 7373 6f72 275d 0a    rosProcessor'].
```

## mindnlp/transformers/models/convbert/__init__.py

```diff
@@ -11,7 +11,18 @@
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
 # ============================================================================
 """
 ConvBert Model.
 """
+from . import convbert, convbert_config, convbert_tokenizer, convbert_tokenizer_fast
+from .convbert import *
+from .convbert_config import *
+from .convbert_tokenizer import *
+from .convbert_tokenizer_fast import *
+
+__all__ = []
+__all__.extend(convbert.__all__)
+__all__.extend(convbert_config.__all__)
+__all__.extend(convbert_tokenizer.__all__)
+__all__.extend(convbert_tokenizer_fast.__all__)
```

## mindnlp/transformers/models/rwkv/modeling_rwkv.py

```diff
@@ -63,15 +63,15 @@
     device_target = mindspore.get_context('device_target')
     if device_target != 'GPU':
         raise RuntimeError('WKV operator only support GPU currently.')
 
     logger.info(f"Loading CUDA kernel for RWKV at context length of {context_length}.")
 
     from ...kernel_utils import compile_kernel
-    so_path = compile_kernel(Tmax=context_length)
+    so_path = compile_kernel(kernel_name="wkv", Tmax=context_length)
     wkv_op = ops.Custom(
         str(so_path) + ':' + func_name,
         out_shape=WKV_SHAPE_INFER[func_name],
         out_dtype=WKV_DTYPE_INFER[func_name],
         func_type='aot'
     )
     wkv_op.add_prim_attr('primitive_target', device_target)
```

## mindnlp/transformers/models/t5/modeling_t5.py

```diff
@@ -40,15 +40,14 @@
     Seq2SeqQuestionAnsweringModelOutput,
     Seq2SeqSequenceClassifierOutput,
 )
 from ...modeling_utils import PreTrainedModel
 from ...ms_utils import ALL_LAYERNORM_LAYERS, find_pruneable_heads_and_indices, prune_linear_layer
 from .configuration_t5 import T5Config
 
-
 logger = logging.get_logger(__name__)
 
 ####################################################
 # This dict contains ids and associated url
 # for the pretrained weights provided with the models
 ####################################################
 T5_PRETRAINED_MODEL_ARCHIVE_LIST = [
@@ -365,15 +364,14 @@
         outputs = (attn_output,) + (present_key_value_state,) + (position_bias,)
 
         if output_attentions:
             outputs = outputs + (attn_weights,)
         return outputs
 
 
-
 class T5LayerSelfAttention(nn.Cell):
     """T5LayerSelfAttention"""
     def __init__(self, config, has_relative_attention_bias=False):
         super().__init__()
         self.SelfAttention = T5Attention(config, has_relative_attention_bias=has_relative_attention_bias)
         self.layer_norm = T5LayerNorm(config.d_model, eps=config.layer_norm_epsilon)
         self.dropout = nn.Dropout(p=config.dropout_rate)
@@ -742,14 +740,15 @@
         return_dict = return_dict if return_dict is not None else self.config.use_return_dict
 
         if input_ids is not None and inputs_embeds is not None:
             err_msg_prefix = "decoder_" if self.is_decoder else ""
             raise ValueError(
                 f"You cannot specify both {err_msg_prefix}input_ids and {err_msg_prefix}inputs_embeds at the same time"
             )
+
         if input_ids is not None:
             input_shape = input_ids.shape
             input_ids = input_ids.view(-1, input_shape[-1])
         elif inputs_embeds is not None:
             input_shape = inputs_embeds.shape[:-1]
         else:
             err_msg_prefix = "decoder_" if self.is_decoder else ""
@@ -862,24 +861,24 @@
                     present_key_value_states,
                     all_hidden_states,
                     all_attentions,
                     all_cross_attentions,
                 ]
                 if v is not None
             )
+
         return BaseModelOutputWithPastAndCrossAttentions(
             last_hidden_state=hidden_states,
             past_key_values=present_key_value_states,
             hidden_states=all_hidden_states,
             attentions=all_attentions,
             cross_attentions=all_cross_attentions,
         )
 
 
-
 class T5Model(T5PreTrainedModel):
     """T5Model"""
     _keys_to_ignore_on_load_unexpected = [
         "decoder.block.0.layer.1.EncDecAttention.relative_attention_bias.weight",
     ]
     _tied_weights_keys = ["encoder.embed_tokens.weight", "decoder.embed_tokens.weight"]
```

## mindnlp/utils/serialization.py

```diff
@@ -269,14 +269,18 @@
 class FakeParameter:
     storage: np.ndarray = None
     storage_offset: int = None
     size: tuple = None
     stride: tuple = None
     requires_grad: bool = None
 
+@dataclass
+class FakeStorage:
+    storage: np.ndarray = None
+
 def _rebuild_tensor_legacy(storage, storage_offset, size, stride, requires_grad, backward_hooks, metadata=None):
     return FakeParameter(storage, storage_offset, size, stride, requires_grad)
 
 def _maybe_decode_ascii(bytes_str: Union[bytes, str]) -> str:
     # When using encoding='bytes' in Py3, some **internal** keys stored as
     # strings in Py2 are loaded as bytes. This function decodes them with
     # ascii encoding, one that Py3 uses by default.
@@ -381,15 +385,15 @@
             # Ignore containers that don't have any sources saved
             return data[0]
         if typename == 'storage':
             storage_type, root_key, location, numel, view_metadata = data
             location = _maybe_decode_ascii(location)
 
             if root_key not in deserialized_objects:
-                typed_storage = np.empty(numel, dtype_map[storage_type])
+                typed_storage = FakeStorage(np.empty(numel, dtype_map[storage_type]))
                 deserialized_objects[root_key] = typed_storage
             else:
                 typed_storage = deserialized_objects[root_key]
 
             if view_metadata is not None:
                 view_key, offset, view_size = view_metadata
                 if view_key not in deserialized_objects:
@@ -431,32 +435,30 @@
     if protocol_version != PROTOCOL_VERSION:
         raise RuntimeError(f"Invalid protocol version: {protocol_version}")
 
     _sys_info = pickle_module.load(f, **pickle_load_args)
     unpickler = UnpicklerWrapper(f, **pickle_load_args)
     unpickler.persistent_load = persistent_load
     result = unpickler.load()
-
     deserialized_storage_keys = pickle_module.load(f, **pickle_load_args)
 
     offset = f.tell() if f_should_read_directly else None
     for key in deserialized_storage_keys:
         assert key in deserialized_objects
-        typed_storage = deserialized_objects[key]
+        typed_storage = deserialized_objects[key].storage
         f.read(8) # trick for read
         array = np.frombuffer(f.read(typed_storage.nbytes), typed_storage.dtype)
-        typed_storage[:] = array
-        assert np.allclose(typed_storage, array)
+        deserialized_objects[key].storage = array
         if offset is not None:
             offset = f.tell()
 
     new_result = {}
     for k, v in result.items():
         num_elemets = reduce(operator.mul, v.size)
-        array = v.storage[v.storage_offset: v.storage_offset + num_elemets]
+        array = v.storage.storage[v.storage_offset: v.storage_offset + num_elemets]
         stride = v.stride
         size = v.size
         if stride is not None and len(stride) > 1 and stride[0] == 1 and stride[1] > 1:
             stride = tuple((s * 4 for s in stride))
             array = np.lib.stride_tricks.as_strided(array, size, stride)
         else:
             order = "C"
```

## mindnlp/utils/testing_utils.py

```diff
@@ -38,14 +38,15 @@
 from typing import Callable, Dict, Iterable, Iterator, List, Optional, Union
 from unittest import mock
 from unittest.mock import patch
 
 import urllib3
 import numpy as np
 
+import mindspore
 from mindnlp.utils import logging as mindnlp_logging
 
 from .import_utils import (
     is_pytest_available,
     is_mindspore_available,
     is_essentia_available,
     is_librosa_available,
@@ -166,14 +167,23 @@
     Decorator marking a test that requires MindSpore.
 
     These tests are skipped when MindSpore isn't installed.
 
     """
     return unittest.skipUnless(is_mindspore_available(), "test requires MindSpore")(test_case)
 
+def require_mindspore_gpu(test_case):
+    """Decorator marking a test that requires CUDA and MindSpore."""
+    return unittest.skipUnless(mindspore.get_context('device_target') == "GPU", "test requires CUDA")(test_case)
+
+def require_mindspore_npu(test_case):
+    """Decorator marking a test that requires CANN and MindSpore."""
+    return unittest.skipUnless(mindspore.get_context('device_target') == "Ascend", "test requires CANN")(test_case)
+
+
 def require_librosa(test_case):
     """
     Decorator marking a test that requires librosa
     """
     return unittest.skipUnless(is_librosa_available(), "test requires librosa")(test_case)
 
 def require_essentia(test_case):
```

## tests/ut/transformers/test_modeling_common.py

```diff
@@ -221,15 +221,15 @@
             # make sure we don't have nans
             out_2 = out2.asnumpy()
             out_2[np.isnan(out_2)] = 0
 
             out_1 = out1.asnumpy()
             out_1[np.isnan(out_1)] = 0
             max_diff = np.amax(np.abs(out_1 - out_2))
-            self.assertLessEqual(max_diff, 1e-5)
+            self.assertLessEqual(max_diff, 1e-4)
 
         for model_class in self.all_model_classes:
             model = model_class(config)
             model.set_train(False)
 
             first = model(**self._prepare_for_class(inputs_dict, model_class))[0]
             with tempfile.TemporaryDirectory() as tmpdirname:
```

## tests/ut/transformers/models/musicgen/test_modeling_musicgen.py

```diff
@@ -8,15 +8,15 @@
 #     http://www.apache.org/licenses/LICENSE-2.0
 #
 # Unless required by applicable law or agreed to in writing, software
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
-""" Testing suite for the PyTorch Musicgen model. """
+""" Testing suite for the MindSpore Musicgen model. """
 import copy
 import inspect
 import math
 import unittest
 
 import numpy as np
```

## tests/ut/transformers/models/opt/test_modeling_opt.py

```diff
@@ -348,15 +348,15 @@
     return mindspore.tensor(tok_lst, dtype=mindspore.int64)
 
 
 @require_mindspore
 class OPTModelIntegrationTests(unittest.TestCase):
     @slow
     def test_inference_no_head(self):
-        model = OPTModel.from_pretrained("facebook/opt-350m")
+        model = OPTModel.from_pretrained("facebook/opt-350m", ms_dtype=mindspore.float32)
         input_ids = _long_tensor([[0, 31414, 232, 328, 740, 1140, 12695, 69, 46078, 1588, 2]])
         output = model(input_ids=input_ids).last_hidden_state
 
         expected_shape = (1, 11, 512)
         self.assertEqual(output.shape, expected_shape)
         # expected value works for CPU, as well as GPU (with TF32 disabled)
         expected_slice = mindspore.tensor(
@@ -379,15 +379,15 @@
     def test_load_model(self):
         try:
             _ = OPTForCausalLM.from_pretrained(self.path_model)
         except BaseException:
             self.fail("Failed loading model")
 
     def test_logits(self):
-        model = OPTForCausalLM.from_pretrained(self.path_model)
+        model = OPTForCausalLM.from_pretrained(self.path_model, ms_dtype=mindspore.float32)
         model = model.set_train(False)
         tokenizer = GPT2Tokenizer.from_pretrained(self.path_model)
 
         prompts = [
             "Today is a beautiful day and I want to",
             "In the city of",
             "Paris is the capital of France and",
@@ -533,15 +533,15 @@
     def test_contrastive_search_opt(self):
         article = (
             "A chat between a curious human and the Statue of Liberty.\n\nHuman: What is your name?\nStatue: I am the "
             "Statue of Liberty.\nHuman: Where do you live?\nStatue: New York City.\nHuman: How long have you lived "
             "there?"
         )
 
-        opt_tokenizer = GPT2Tokenizer.from_pretrained("facebook/opt-1.3b")
+        opt_tokenizer = GPT2Tokenizer.from_pretrained("facebook/opt-1.3b", ms_dtype=mindspore.float32)
         opt_model = OPTForCausalLM.from_pretrained("facebook/opt-1.3b")
         input_ids = opt_tokenizer(article, return_tensors="ms").input_ids
 
         outputs = opt_model.generate(input_ids, penalty_alpha=0.6, top_k=5, max_length=256)
         generated_text = opt_tokenizer.batch_decode(outputs, skip_special_tokens=True)
 
         self.assertListEqual(
```

## tests/ut/transformers/pipelines/test_pipelines_document_question_answering.py

```diff
@@ -10,15 +10,15 @@
 # distributed under the License is distributed on an "AS IS" BASIS,
 # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing permissions and
 # limitations under the License.
 
 import unittest
 
-import mindspore
+import pytest
 
 from mindnlp.transformers import MODEL_FOR_DOCUMENT_QUESTION_ANSWERING_MAPPING, pipeline, AutoTokenizer
 from mindnlp.transformers.pipelines.document_question_answering import apply_tesseract
 
 from mindnlp.utils.testing_utils import is_pipeline_test, require_vision, slow, \
     nested_simplify, require_pytesseract
 
@@ -92,14 +92,15 @@
                 ]
             ]
             * 3,
         )
 
     @require_mindspore
     @require_pytesseract
+    @pytest.mark.skip
     def test_small_model_ms(self):
         dqa_pipeline = pipeline("document-question-answering", model="hf-internal-testing/tiny-random-layoutlmv2")
         image = INVOICE_URL
         question = "How many cats are there?"
 
         expected_output = [
             {"score": 0.0001, "answer": "oy 2312/2019", "start": 38, "end": 39},
```

## Comparing `mindnlp-0.2.3.dist-info/LICENSE` & `mindnlp-0.2.4.dist-info/LICENSE`

 * *Files identical despite different names*

## Comparing `mindnlp-0.2.3.dist-info/METADATA` & `mindnlp-0.2.4.dist-info/METADATA`

 * *Files 13% similar despite different names*

```diff
@@ -1,11 +1,11 @@
 Metadata-Version: 2.1
 Name: mindnlp
-Version: 0.2.3
-Summary: An open source natural language processing research tool box. Git version: [sha1]:5cfe18b, [branch]: (grafted, HEAD, tag: v0.2.3)
+Version: 0.2.4
+Summary: An open source natural language processing research tool box. Git version: [sha1]:caca912, [branch]: (HEAD -> clip, origin/clip)
 Home-page: https://github.com/mindlab-ai/mindnlp/tree/master/
 Author: MindSpore Team
 License: Apache 2.0
 Project-URL: Sources, https://github.com/mindlab-ai/mindnlp
 Project-URL: Issue Tracker, https://github.com/mindlab-ai/mindnlp/issues
 Classifier: License :: OSI Approved :: Apache Software License
 License-File: LICENSE
```

## Comparing `mindnlp-0.2.3.dist-info/RECORD` & `mindnlp-0.2.4.dist-info/RECORD`

 * *Files 7% similar despite different names*

```diff
@@ -1,10 +1,12 @@
 mindnlp/__init__.py,sha256=zN8WkA5xfrlykU1ubuW85EGUnb7R9dH5P4TACcQI17M,1162
 mindnlp/configs.py,sha256=gFz3hmr14cJZdpqvJZqaAasa3yFcwnCkg4KWueMjPQw,2170
-mindnlp/injection.py,sha256=FxxkEkYakVws4Ij1Rs0bEWhDt4qP9p2kj9pOWQgts24,37100
+mindnlp/injection.py,sha256=O3_H5tfhAAPGq7v5vjmVrkprFU3pugKQ7sGZ4d66jPI,37726
+mindnlp/readme.md,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
+mindnlp/_csrc/cuda/flash.cu,sha256=fuOhLHgN5m-BPVVmMqOZZd0nD4jTNywTZsx-NpCUJOc,5132
 mindnlp/_csrc/cuda/wkv.cu,sha256=Sbgw3Sd6mYoyy8M9DwtcW0CjDtq-d6FxvlskViSv7xA,7940
 mindnlp/_legacy/__init__.py,sha256=RPO-lfdXFzTdUTiIlkM0hjlVovkCspDhG7u5p9q1QR0,707
 mindnlp/_legacy/amp.py,sha256=5h55oV-Jw_Fab-vGc_AkX98aIGXa4ntDPUw0O6rgCcg,7978
 mindnlp/_legacy/functional.py,sha256=cVr4ugcow96nFQqlmHmXwFMe2AZ05prIoUa4xTWL9Pk,67590
 mindnlp/_legacy/initializer.py,sha256=GvBTOWfCoXZJw61x2rp_nB3bauw2j7-l5SYgPHGl7bg,2633
 mindnlp/_legacy/utils.py,sha256=L9lp1u3CNEsKdCMYzw2earOGQ4McGRv9Ap6YhInfEpg,3284
 mindnlp/_legacy/hypercomplex/__init__.py,sha256=OmaMN7P1RO8LK7QHvAYtwF5Aluaijv107v9uMH7TkvQ,883
@@ -33,14 +35,39 @@
 mindnlp/_legacy/hypercomplex/hypercomplex/_hc_conv_impl.py,sha256=xZSpRch6w7OOKxaA8IrdZB4oKaIusQ0pGwXQrZ9f9Ok,5893
 mindnlp/_legacy/hypercomplex/hypercomplex/_hc_dense_impl.py,sha256=jda1wqlGqTCw-u-XYD2G9QTA_zWdOjqOcFPJGoVOmWw,5140
 mindnlp/_legacy/hypercomplex/hypercomplex/hc_bn.py,sha256=PCnh_b2kDMMSD8W94sxtN5cbvmRnGudA7kV3i_hG5Fw,36029
 mindnlp/_legacy/hypercomplex/hypercomplex/hc_conv.py,sha256=GQ7-VBTcBvGxGkY4KpnMf6114AXxPFV2EX_rZMkx_O0,49241
 mindnlp/_legacy/hypercomplex/hypercomplex/hc_dense.py,sha256=wKXz8u7nwpjt76GDV9UnkLDGkiXkgnuc9gFUUZeLUzI,11082
 mindnlp/_legacy/hypercomplex/hypercomplex/hc_pool.py,sha256=7ccf1Mnjr0t6s7xHtMJS908eQo3JaxjwCxAPkPF4e9Y,44353
 mindnlp/_legacy/hypercomplex/hypercomplex/uniform_operator.py,sha256=g4Df6538nK54qO3VVuOKs9ltK3lDXpGxVixATWziHF0,1691
+mindnlp/_legacy/hypercomplex/tensor_decomposition/hypercomplex_td.py,sha256=iTIzMvgbARLgIqIF-1RBdvQXgyTLd0E6nFCpb8wXYRE,2915
+mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/algorithm/dual_svd.py,sha256=OW1VriE2bU3HZWw0iGzNb5IGfQnJDPHYohplbCKQzTY,4383
+mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/algorithm/qr.py,sha256=CXzG8YVCM55gA2bDaQTROmw17nXUlB_tsHBJFqUTMFQ,4886
+mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/algorithm/star_svd.py,sha256=LyMi4CNyuoznug3zC3UVRfQQI2IYMI5zUR_smuz6sNs,802
+mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/algorithm/svd.py,sha256=2cpAY7HE3HNDiB7rv-NYXoPIlXBKSnit2iFy5Sbp1Rg,3728
+mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/algorithm/t_svd.py,sha256=Ol7Vkj52zm88HohuSnbtsheM4hIsji7vSF2_B35kyhs,800
+mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/matrix.py,sha256=FKRizlMDkc57TL2L8lAiGHm58RhAAB6ehqvb-rfrrSE,6592
+mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/scalar.py,sha256=-owkKrFa9EGJ17pr1iFkaAaHTCBuq5FJZnyhjrUY46U,1431
+mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/scalar_visitor.py,sha256=usNdk7g1Dv6vCI69uGk4WhU8AsLgpnBGsdT9xDHlqR0,593
+mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/vector.py,sha256=XnC9iNifMmjWuzxbUEjmrNnG68KTXQbcl1dNlawQBSQ,4859
+mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/complex/_complex_algebra_impl.py,sha256=rHmlPdhyFg6pYwIDHsHW1KeHa0AZqjLsJe9p2SMAewg,3088
+mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/complex/complex_algebra_factory.py,sha256=jrwavQimWlaBMjNihevkmxfY3d24Ay0nSrtkeRbsGUE,894
+mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/dual/_dual_algebra_impl.py,sha256=Ztg46J9sTgl6LWtSGw1LfpMckEM4jSJNtjfiinyZ2yg,2640
+mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/dual/dual_algebra_factory.py,sha256=BYARgw14ePI0NYtRUXywxkHpHX4e3x0a-5YToGk8AqA,873
+mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/hypercomplex/_hc_math_obj_impl.py,sha256=VTpuGtd3nwLS04WuwJJ305pcVxLYsLLUFhKkXmHeJeY,594
+mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/hypercomplex/_hc_matrix_impl.py,sha256=rF_MT31x7dNGQfvywfNdICqPht0hEQuh8PPVlBVFvC4,456
+mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/hypercomplex/_hc_scalar_impl.py,sha256=aInHM4INYCLCZ1hVhriKnHXOIOv4NeMIAhFPLXVtcCQ,858
+mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/hypercomplex/_hc_vector_impl.py,sha256=BqdzlItny1Pq_nZ7ws2Sc1QGlr_gOEg2ZA6MYSx9_P8,481
+mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/hypercomplex/hc_algebra_factory.py,sha256=L7Qhga9yxPutzczjNoFDJYzzPVaJjaWatE_tKUVKmO0,653
+mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/hypercomplex/hc_matrix.py,sha256=RXl53f4hP1yEcQZ2EGkNxHJLufvn-ILz2JPGHoOoz2o,13424
+mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/hypercomplex/hc_scalar.py,sha256=vq7DzynVoMITWPFz-bsW6DD9hTxWRMD3pZLMMP23zm0,3020
+mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/hypercomplex/hc_vector.py,sha256=hf-Q2fEJ19ZhIX00TpXOFhvYAuwsxETIeDA3SV04gQk,9501
+mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/real/real_matrix.py,sha256=KLJNz1CZ7-yF2Tl901YNFZzwcl9Qnf1wnk68Pq-cFxY,6240
+mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/real/real_scalar.py,sha256=9jWJ8SoAIFm6ovzvfpK3rLMA6SPQ1CV48TuzapZrzeU,1650
+mindnlp/_legacy/hypercomplex/tensor_decomposition/linal/basics/real/real_vector.py,sha256=PpOGrYceiSbZ0ure1vao6LKiYQVeuVphQqAQKIX2PHM,4089
 mindnlp/_legacy/nn/__init__.py,sha256=k_nbrmE1VeUrnLdlpknWRlgXGM64HoE699t2y9FoY0s,1092
 mindnlp/_legacy/nn/dropout.py,sha256=N5rtog27z3KVYDlYfr1OFaJlThvoprbAiTGWY1V6NlI,3367
 mindnlp/_legacy/nn/half_op.py,sha256=QtJDhpj0EBgzCS0UhklQ7z0TbUd9FF8zGMLZQp8F9yQ,896
 mindnlp/_legacy/nn/transformer.py,sha256=hT0xpPfJZtBfpTvhzICpyNObZ7W76LixF-7oMc7mAz0,33081
 mindnlp/_legacy/ops/__init__.py,sha256=psCypTLtIAHU56ad6wbRKquJT6lqYgywmetFYfRsJPw,797
 mindnlp/_legacy/ops/parallel.py,sha256=SWcFYeNOa-9XN8A0IlUFMLLQ7xJz73RTGqbuuRP7MxI,1196
 mindnlp/_legacy/transforms/__init__.py,sha256=aj5PQDyvcYuBbNqh8aO2ps1i5MkWUJyXKlrCWfjDev4,872
@@ -64,18 +91,25 @@
 mindnlp/data/io/__init__.py,sha256=UfsVFnx2S5r1SMZ_OWCohz7nncoh3oyaXspgJ4d2LZU,736
 mindnlp/data/io/audio.py,sha256=M-0IXCsx-JP0RU8A1IoJZOq5IdNlv3wtaTaC7SRvjwM,34595
 mindnlp/data/processors/__init__.py,sha256=_c2YLOgkf0ONf07sFzphIUiggUjfR6iDc7oQHKOsT-0,768
 mindnlp/data/processors/squad.py,sha256=OPx6DLo4oM-zv5lM8wv_r3yUkyuqUKRTcdO7HVxjmoY,20407
 mindnlp/dataset/__init__.py,sha256=scyJLq-6z8vC1lxOL7lkCd73ZgokL_owgCMtq6-gNLQ,720
 mindnlp/dataset/load.py,sha256=NcWwtYE1LknWJZucyfiX26nQdincpWb9BKygLBGE-JU,13264
 mindnlp/dataset/utils.py,sha256=OLw6rwxpJmkWX11Hai1H2lF2ZwuLUNUWvf1i296g0cI,1921
-mindnlp/dataset/transforms/__init__.py,sha256=HZqJWIZAGBgehceDOp8vurh2pkvGskmP6uFKZZxEP1g,1150
+mindnlp/dataset/transforms/__init__.py,sha256=ib-XL8MQPr1fdmA7utmKp-yh1DDImBcW-WWxYyyTfwE,1211
 mindnlp/dataset/transforms/basic_tokenizer.py,sha256=EllLR6ee01UrMcJFY5Z8QhNTf8mUoRz8AeDPpdnZ8uM,9716
+mindnlp/dataset/transforms/jieba_tokenizer.py,sha256=cipFmFHH5XTOaiHHfRUVgOrbCdKjih7UfBIHA6vEsWQ,1608
 mindnlp/dataset/transforms/lookup.py,sha256=mzd8JtwJkCuzq-_wVqg2rFp5nVwisBXkrHOG7uyORnA,2508
 mindnlp/dataset/transforms/pad_transform.py,sha256=oEoCuo4ZBas16G07e5Fz9bGST0pgnYKbg1l_uXP86kM,2548
+mindnlp/diffusers/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
+mindnlp/diffusers/loaders/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
+mindnlp/diffusers/models/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
+mindnlp/diffusers/pipelines/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
+mindnlp/diffusers/schedulers/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
+mindnlp/diffusers/utils/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 mindnlp/engine/__init__.py,sha256=cFr_jRrFiqi15P1zKqazG1IQBeP_wETrSuz9v2leGGI,779
 mindnlp/engine/evaluator.py,sha256=xh8vOAzen6jkJZHhy_iSujauVWuSCIub4KZNp2Xv2JQ,8106
 mindnlp/engine/export.py,sha256=fGF3DEKz7LuStbtSsrzBKVCr7RozgnnHM_2jm4f4rJg,770
 mindnlp/engine/train_args.py,sha256=Y_csPQd4XAN5SziYEATatYenr7O40SwvJsSMzUm9yRM,807
 mindnlp/engine/utils.py,sha256=pNIDTw78s5IuWcs07idGv7VLbHOuQWcYWOuQLQ4nA5c,1125
 mindnlp/engine/callbacks/__init__.py,sha256=2e2ObWOpnFC56VYNI8qOLmdtJ27sCJLpbKTmTLF0KNY,927
 mindnlp/engine/callbacks/best_model_callback.py,sha256=jn0w-l2g9v_nt1JuNhQi8HGpD7dGm7_VrMD4xf955-0,5118
@@ -118,27 +152,28 @@
 mindnlp/metrics/utils.py,sha256=Pycmys4mwc8m6GpiIKoSvRZcpDWgBWDWHULIOz4buug,4407
 mindnlp/modules/__init__.py,sha256=F4kJ17bhyCauXK8KOULTNe0CZ_mX-p08QoWFp434Dks,2229
 mindnlp/modules/accumulator.py,sha256=ySal1DQovq2XS8jd4sjNmj9sbfXpFJQtEIJ1rR94O5M,1966
 mindnlp/modules/attentions.py,sha256=ROvYft2AjZ4LhXzwlUIIczSWzueW5Nu-ZeyofUE78eE,22547
 mindnlp/modules/crf.py,sha256=zBZ0opZ8XI1ngsWgmrWnBGyqGmJlTKbd9JaLsY6lb-U,13033
 mindnlp/modules/loss.py,sha256=1bNP98aScwV5vEGYw4sOQxbzvIUVuqWQ08k5xEHRxkY,6458
 mindnlp/modules/rnns.py,sha256=EmpSu6T6b6YsMIx0Oqr-KZmUVjRJiyE2PHbgYqZ4s2k,22885
-mindnlp/modules/weight_norm.py,sha256=IXn3Fky1tQItGnhXkSMK--R7cYVUQl1v8381MIzL9nc,7084
+mindnlp/modules/weight_norm.py,sha256=IlODsU6wfguwza_KQ7Wb3yFd2egZ-zUI3lqRNKysBvg,7136
 mindnlp/modules/custom/__init__.py,sha256=La-dV9qOD9ib2pV3ot47dOFSOxRtnCTYZajlpvF_LIo,702
 mindnlp/modules/decoder/__init__.py,sha256=PN_Jzr19TMpxirSH80MVovkxIl6TJa8HZ52PI9P7J28,773
 mindnlp/modules/decoder/rnn_decoder.py,sha256=EtcmbVPNq_G5uCmjd_etZRcIBZe_74Cwo3YiOBahX5Q,10869
 mindnlp/modules/embeddings/__init__.py,sha256=hO-yEUA5WdRhLgYbDZd49C5gvBYZwK1wfSNfE1xkgkE,801
 mindnlp/modules/embeddings/fasttext_embedding.py,sha256=SG-A0wxBFS7V_g5xmh1Q37oA3DRH_i3M70jByKPhChs,8276
 mindnlp/modules/embeddings/glove_embedding.py,sha256=5uvdRAHmhgOBb2FaxR-6MXMRP1mF84uH4qr_4-16Zao,8267
 mindnlp/modules/encoder/__init__.py,sha256=NIhFNJ4M-k_C7PKnCRNjdJmWc9ckn_TlNHWmtedbVQY,824
 mindnlp/modules/encoder/cnn_encoder.py,sha256=hikKCZvgwTUHqNg-6r1628d48_oM3XqrHH9P9ztFVBg,4712
 mindnlp/modules/encoder/rnn_encoder.py,sha256=r1P2sPjaxEvR44S5FmBeIkHwrY8lRZ53DVys6uwg44g,4145
-mindnlp/modules/functional/__init__.py,sha256=v9WJKvJI1CTKDwnAW14MQv2bu4lhQnWRs0pGF9HaC9o,762
+mindnlp/modules/functional/__init__.py,sha256=bfu-qacLFTeKRVSznfUsTcvBSW5jXLMGfm56g1YYvhQ,787
 mindnlp/modules/functional/graph_func.py,sha256=5e69qOeIlEhqxw0pKmS4MU2OOrMTYM1M77m0g0g7E6g,2705
 mindnlp/modules/functional/neural_network.py,sha256=Pf_MIFL-ZFf57tuPGCNQv-hW69bA7k5PjwyFjbPy0kw,985
+mindnlp/modules/functional/normalize.py,sha256=3atvFVH59AxPi2lo3h6lhdUIuVRJ2_Z7i8KLwL_a09g,838
 mindnlp/modules/functional/weight_norm.py,sha256=aKXYPxFkHFCwKqyew8xxL322Gsknh3T9dpY3QT7HdOQ,3298
 mindnlp/parallel/__init__.py,sha256=aUXrEICNTzyZLPD7IIs9J-neiRAJ47a7ypjni_0lqdU,846
 mindnlp/parallel/pipeline_parallel/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 mindnlp/parallel/tensor_parallel/__init__.py,sha256=qW1fLvXW8FyfP8ZNhY8llemXEds8sDNEf-l2UiSgjtw,818
 mindnlp/parallel/tensor_parallel/layers.py,sha256=pkfNDj-0ucrbdMYMoShqr7EZ1FJi8jh44bwJByv4oZ4,11750
 mindnlp/parallel/tensor_parallel/mappings.py,sha256=nErGGVRND7ssEX4gWwuzEaxBW36f-ImQZ-42cT4VSU0,4587
 mindnlp/parallel/tensor_parallel/utils.py,sha256=7j9VVlFJcS0BtoHdAsz8WnX7cB4POHrd3MwcecCRCPk,3369
@@ -149,44 +184,47 @@
 mindnlp/peft/tuners/__init__.py,sha256=X7H4NvAHmBkLIPMArfe72n1eCE1QsX212uImU7tytOY,738
 mindnlp/peft/tuners/lora.py,sha256=XvHzVD3vSUN49AlZxnNRwbxLezH9gAjnbUh9elA0JbM,37392
 mindnlp/peft/tuners/tuners_utils.py,sha256=RApfuINIoWSxqYP8fZrLl3piyzYqLJ2W5j6sMNPjILU,11619
 mindnlp/peft/utils/__init__.py,sha256=9Sj2W5-v3pMhc0iUV6PZnQLuDKgBHiPEs8LlotZY0hI,1756
 mindnlp/peft/utils/other.py,sha256=cO_Gq1AxqDavrriM3JGfWUaQQ6beoiCORxh33H0XQQU,11128
 mindnlp/peft/utils/peft_types.py,sha256=U5GcTifIt7-DvIkTO--3sAuWSflmguSR6v1G_9edq1U,1242
 mindnlp/peft/utils/save_and_load.py,sha256=vzFYbUz82I8B5LpsJR3jdwbT5Wb7mmrwKJlAYSAxjSY,5767
+mindnlp/text2vec/__init__.py,sha256=5txdPGVtJz_iMTM3C4yVCCo_1_SxQ-6Po7e8L1KmRPU,763
+mindnlp/text2vec/sentence_model.py,sha256=6oDeltBvsUmQqHigLGcAEYMf575a5KKc-5_AfRQ3C7g,8215
+mindnlp/text2vec/word2vec.py,sha256=HGygGq7Y34IlgJhu1rtRgrDWZkINyC5iW_OPJN_Bu6A,6109
 mindnlp/transformers/__init__.py,sha256=Qu8PvCl1bZ5IPo-_7BtrTxLWwHirS556wA6peJ-aQqQ,1287
-mindnlp/transformers/activations.py,sha256=qIR3iAM1of5UtmA4pbEza7QmO6SykYuriIfHIATtL1g,2295
-mindnlp/transformers/audio_utils.py,sha256=ybpOBfYABkSiV2Mv89xL66_bDhCI5GdYhHBrGVymiJQ,29318
+mindnlp/transformers/activations.py,sha256=vv5oOMKbxT-M03SHCe2Sd01BZ7Ll-IhHWWdCClygqT4,5438
+mindnlp/transformers/audio_utils.py,sha256=w3h2rxRXtFwtoyWBSKHwz7ifHgBjVwonswnNfOxDNsI,33460
 mindnlp/transformers/cache_utils.py,sha256=PwstaYZe7xNWZ_fu4wjNMdswBnavC9da3jeWM4HJMpY,20239
-mindnlp/transformers/configuration_utils.py,sha256=Gy4WeURRbkfn3hXnrFCvdVIGvBaR3jsE_RsgIHjpf94,35012
+mindnlp/transformers/configuration_utils.py,sha256=vivC604nF8ev15aGs4QluSL5LLO-igFQYjhVo3TWJI0,35706
 mindnlp/transformers/convert_slow_tokenizer.py,sha256=jhorBivmFT5WbTzzeds9xQ2FgOFl27XJ2rJeaCA5lH4,53285
 mindnlp/transformers/feature_extraction_sequence_utils.py,sha256=Imxuuu1Jrgq-Gfv4CdavzJcH4Feis1lHRKNvv1SXZpg,18222
-mindnlp/transformers/feature_extraction_utils.py,sha256=EaMly8_0bO15pRPC1vy2ZD4jZRKkR_O6kEq_9RusWj0,26672
+mindnlp/transformers/feature_extraction_utils.py,sha256=l_lxwuYqUsTWXRR_4ypFHMGv8Uh78_jqCQlYK4JntOc,26772
 mindnlp/transformers/image_processing_utils.py,sha256=1P-BO1Hp1hmKiWRs6HB79CkJkvWmCU1xQk5R5XlaMaE,33187
 mindnlp/transformers/image_transforms.py,sha256=XAPVvn5puJjymEsEDgtibTkVE-u7tEtVtmBC9foKbJA,32924
 mindnlp/transformers/image_utils.py,sha256=frXrghYl-qR-za86WKvV7vViW5SzSCU_mOTTMOR9meI,29937
-mindnlp/transformers/kernel_utils.py,sha256=czy8h9Q7RC_5rMUMMGDqEVTvDNQiJrNUgsLSe2nD6o8,2939
+mindnlp/transformers/kernel_utils.py,sha256=EbqQghbUjXweEY6jpaUpSuCu0h5Fuhz3pt6ilwRUdHQ,3025
 mindnlp/transformers/modeling_attn_mask_utils.py,sha256=A2OYYNl6CABjR-NGMWkqx-q1d_RLbxaPgBCD22rOJbg,10957
 mindnlp/transformers/modeling_outputs.py,sha256=EuYy4AB87Qu7U50OZLP61vDmoP1rkODjqjBXyiXi7Fg,111179
-mindnlp/transformers/modeling_utils.py,sha256=2ti5rEH9YsN5JuGD9Jry8Q3GnyJvqGoqdij1DBNdbi4,96544
+mindnlp/transformers/modeling_utils.py,sha256=9LsRLnXRnX4mNfnDlseJqdeFbpAB2j6vjagF4y04s88,96613
 mindnlp/transformers/ms_utils.py,sha256=N7IRToelae2hmwz83fcVg44D_JMwA9ZrEhHdUzl6AdU,8657
 mindnlp/transformers/processing_utils.py,sha256=FdONMo8FHR-imvIpFjK1rwzw7wxuH4mZ6jUERNC0E64,10219
 mindnlp/transformers/time_series_utils.py,sha256=Lq_FOUpKksA0JjkNqoSZ8zjrInHo-fnw-f1rWnQcuIk,6636
 mindnlp/transformers/tokenization_utils.py,sha256=7N7dtuhR0WP4I0_ARGkYZY8XEYPSgCVBS5i5wJNtrZs,44063
 mindnlp/transformers/tokenization_utils_base.py,sha256=5HpfBkwPAaDOLNHWpCPgsI7aiUPKGueS0ikm6FKrCq8,175003
 mindnlp/transformers/tokenization_utils_fast.py,sha256=iCnx9OddrLa2umbQ3KMHxmr7VotUbkrh4dMPzxrlgps,37089
 mindnlp/transformers/generation/__init__.py,sha256=b5_aMiadea3qZtn3gXN2WNLyBAGWJSPmv7HunK7T1Nk,829
 mindnlp/transformers/generation/beam_constraints.py,sha256=uqF7dR6m0sETAXRktv-tsnWubLRLAHWfMpiF-lCxlVw,19732
 mindnlp/transformers/generation/beam_search.py,sha256=22XZl1LNtKMilC7_HYuoO4hOf_7kYhF80s3ZAezLye0,43463
-mindnlp/transformers/generation/configuration_utils.py,sha256=yOsuIJ6cbiV76_AYAUMM4bnG80EA68KQw2Xrdt9AL-I,32032
+mindnlp/transformers/generation/configuration_utils.py,sha256=d35ZPNxywHVx75OeqaISmTFN_NqBKtsmn820toourLY,32343
 mindnlp/transformers/generation/logits_process.py,sha256=Am0_Bh-zz3wK6RyzGefCxDefP4dE5mI_p36W3vydJ_o,66891
 mindnlp/transformers/generation/stopping_criteria.py,sha256=ctgIzoyD3Njf8hZGwfM1HMrCxaaNRPvNJMtvGqB76gM,5067
 mindnlp/transformers/generation/streamers.py,sha256=nfNWWJrnInIDUklA7oX44R9V3Wak2ipHCULVwbT79_A,9287
-mindnlp/transformers/generation/utils.py,sha256=DMoMGDtOEOQeSbDRlA5ZShvqkFyA9JCSf7_9iZjQIqc,250613
-mindnlp/transformers/models/__init__.py,sha256=pid8CJPKpnlWJs5CBmbY1s2Fuq3RR0fTYqMEzjcieG4,6206
+mindnlp/transformers/generation/utils.py,sha256=f8k0RkIw2mOnRRUhhX5SCyLv3IgVQf-6M0q8dDIKBCs,252173
+mindnlp/transformers/models/__init__.py,sha256=nSvm60J2ciXj_jgY_MU-sCTl3B7iLYrrf_ADC6rrR14,7060
 mindnlp/transformers/models/albert/__init__.py,sha256=kvD7gpaI2cvbB9GcyoDciROxpWbnbk9-fF0QD9YfOy0,1120
 mindnlp/transformers/models/albert/configuration_albert.py,sha256=vqiWcAlgEShzjGy3qdmjM8C4Vwcj6B57_fpQeY9V-qE,8303
 mindnlp/transformers/models/albert/modeling_albert.py,sha256=Ipttkzs18lFxgyH3BFXqTvu-7WPpDpdUVdW0opn9ZRU,48840
 mindnlp/transformers/models/albert/tokenization_albert.py,sha256=S3tKRWcrOhazlQIpRK6u6puqF6Bz_lcROMWB9FOvTRE,15804
 mindnlp/transformers/models/albert/tokenization_albert_fast.py,sha256=yIM4e2czojHW0JBQoymgzbhpUEidWrrouSik4IkEOdA,11024
 mindnlp/transformers/models/align/__init__.py,sha256=EmzW8tqvGOMH5fO5mQLm_VZqDHdMEOQgaBug6LVc4c0,989
 mindnlp/transformers/models/align/configuration_align.py,sha256=c--Hgtcs46dk85NkSvbwLc312BqZi1xhRiPRpP2XK5g,18320
@@ -198,21 +236,21 @@
 mindnlp/transformers/models/altclip/processing_altclip.py,sha256=aib4leZrb2IqqUWkSs8e8yNORtx3H46S9j5TaQWETjg,6589
 mindnlp/transformers/models/audio_spectrogram_transformer/__init__.py,sha256=PG0vCiX0VI6m4EIIbY3ELzD9PxEwHF7amsMPoFpYfXw,1252
 mindnlp/transformers/models/audio_spectrogram_transformer/configuration_audio_spectrogram_transformer.py,sha256=2guyWTnmxhejYBmF442WqZIPAUMU58fO7HUJRSOZ_Do,5830
 mindnlp/transformers/models/audio_spectrogram_transformer/feature_extraction_audio_spectrogram_transformer.py,sha256=caBkZhXHWBjqsQjhcRTwAwex82tRWjk1LXQRipxG9io,9478
 mindnlp/transformers/models/audio_spectrogram_transformer/modeling_audio_spectrogram_transformer.py,sha256=Zabej1cLRJWgrCXxubYaF-rcC45rbuTjXpeyqnIuBNo,22723
 mindnlp/transformers/models/auto/__init__.py,sha256=fKMToR-STo2xkAYZtsC_GG8dDMSXu-ZJeM0JBUaYACc,6545
 mindnlp/transformers/models/auto/auto_factory.py,sha256=eMkT0aaz-MOQj8mfoeF3hHgMUK8dP1YDNMUk3uX_OPw,10729
-mindnlp/transformers/models/auto/configuration_auto.py,sha256=lT7ewD4iZT66UlU5fEJ4NFBA5P2VjBfzkrFGslMtf8s,40009
+mindnlp/transformers/models/auto/configuration_auto.py,sha256=VqxrL_XG3G7GOnsQCavO5amqdMa51sQsflRKCZJPp9E,40590
 mindnlp/transformers/models/auto/feature_extraction_auto.py,sha256=P7B2exnsLcIpVPnGQbIIn5atUiRZbDeSbK2XdX2DFzA,18666
 mindnlp/transformers/models/auto/image_processing_auto.py,sha256=WdYE546D6XXbtRu138vgNrYgzoHCE51JqVbDWqhbsrU,20881
-mindnlp/transformers/models/auto/modeling_auto.py,sha256=bheImzFQ3MS_zZA9-q9H4COPLbWvyrZYZUOBxFevDuk,40237
+mindnlp/transformers/models/auto/modeling_auto.py,sha256=hIeBeGHZub6hBOw98gqZ6G0h9Cx7QcRyHbIVCj6Ow0k,41547
 mindnlp/transformers/models/auto/modeling_graph_auto.py,sha256=jGgbSmmj1b51_HeHs-LX1067i_Zx8eOd1ZUPIV301G8,12314
 mindnlp/transformers/models/auto/processing_auto.py,sha256=q17nktmWTRcuVT87tBKZIDGx0-wtXnNipCEuvRArZlE,15357
-mindnlp/transformers/models/auto/tokenization_auto.py,sha256=PPle2buuj6xM4L47qoqmuTXzVjqPfUpCl6OeMqGZFNc,39369
+mindnlp/transformers/models/auto/tokenization_auto.py,sha256=Av1NcuX-CnS5ATDb3dmdQZYl5dJyo0JExhihT6pxZ3U,39882
 mindnlp/transformers/models/autoformer/__init__.py,sha256=Ar0f-8Bpn6TP3aUrQ5WTMyyEljWXgwMOZPhs9FwqTnE,935
 mindnlp/transformers/models/autoformer/configuration_autoformer.py,sha256=AsP3cPlPlc_jAveSkE-H9Nic3uKz3ozZcY3I1OPih14,12462
 mindnlp/transformers/models/autoformer/modeling_autoformer.py,sha256=XTJLmXghHmxdvKxkTR1H4ARbTxRZoAsl5GCldvA5rfA,97091
 mindnlp/transformers/models/baichuan/__init__.py,sha256=Xws2zEDi9pKhUg7bZ4zIaEVgaesEevEyF6iV45UBgmg,1028
 mindnlp/transformers/models/baichuan/configuration_baichuan.py,sha256=-MchRqVjs7rH25FoLtBh9QNdGCzsYdGR9unhyxiih6A,2461
 mindnlp/transformers/models/baichuan/modeling_baichuan.py,sha256=2-sgpj9NaCaZFYKVCKQsyv46iKM3Ji3-RdyVHKalbAQ,43284
 mindnlp/transformers/models/baichuan/tokenization_baichuan.py,sha256=lXrSixuRRGZ5_An0WKoaix4UejppaU16PHRQwZ8v5Z4,9639
@@ -255,56 +293,56 @@
 mindnlp/transformers/models/big_bird/__init__.py,sha256=9e3E2-vOedwKgSu7BZEJFy3Rb9OBmAV9KnFq2JWaVUE,1190
 mindnlp/transformers/models/big_bird/configuration_big_bird.py,sha256=yLVDzUAJTY31wcp56NUFMAnYOit8VqiRR5rUuppC3VE,7904
 mindnlp/transformers/models/big_bird/modeling_big_bird.py,sha256=KELpw8siJl_nEaMr_nNIIPoi9CG_jz3Yem5YTuDN-uw,131230
 mindnlp/transformers/models/big_bird/tokenization_big_bird.py,sha256=38nTEtwZpAgRwlD2Zh9jDR2tC6UR0_0vs3iHX7koVpA,15561
 mindnlp/transformers/models/big_bird/tokenization_big_bird_fast.py,sha256=xxOC6pely-fjOL4kL7CrFZRt76U-xZkc9dDMQHiXy4s,11973
 mindnlp/transformers/models/bigbird_pegasus/__init__.py,sha256=h0vJNEX-F-4E9oJ6BwTtLXldWwn6BUCiiR0a_fI9Tks,997
 mindnlp/transformers/models/bigbird_pegasus/configuration_bigbird_pegasus.py,sha256=HZRSfY1FZgJ_IkToYWSOlP2ncOr44vTKC3bPBbPyMLI,8577
-mindnlp/transformers/models/bigbird_pegasus/modeling_bigbird_pegasus.py,sha256=bmLeN2CTWweJog3b0e1-KFQGpLu5BVpVv5akEnSqDBE,134694
-mindnlp/transformers/models/biogpt/__init__.py,sha256=xke_SVQiLYQl5qES6dvlprA6QVtq42cdPtr3qemfmFA,1005
+mindnlp/transformers/models/bigbird_pegasus/modeling_bigbird_pegasus.py,sha256=3dcjB5qs8za4cqgccTr0hXjGFi95cPKKGZKXjpC202Y,134691
+mindnlp/transformers/models/biogpt/__init__.py,sha256=jzfar9P7hYKySKNYNxa7fBWrJvNq9as_-ST5tFXS0Xo,1007
 mindnlp/transformers/models/biogpt/configuration_biogpt.py,sha256=NbAre1ddPv1yxZCwnj3DJxcTJxYyfZQyTkjS0LUsoCA,6499
 mindnlp/transformers/models/biogpt/modeling_biogpt.py,sha256=JPq95S5Fa2xIQMN39fa6lHlSCJgKNSNHu-IIt61xbSM,34793
 mindnlp/transformers/models/biogpt/tokenization_biogpt.py,sha256=gjdHulzti_30uH-o_NKILxwLCWY9Ik-W1B7_rt1HJUQ,13838
-mindnlp/transformers/models/bit/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-mindnlp/transformers/models/bit/configuration_bit.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-mindnlp/transformers/models/bit/image_processing_bit.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-mindnlp/transformers/models/bit/modeling_bit.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-mindnlp/transformers/models/blenderbot/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-mindnlp/transformers/models/blenderbot/configuration_blenderbot.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-mindnlp/transformers/models/blenderbot/modeling_blenderbot.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-mindnlp/transformers/models/blenderbot/tokenization_blenderbot.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-mindnlp/transformers/models/blenderbot/tokenization_blenderbot_fast.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-mindnlp/transformers/models/blenderbot_small/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-mindnlp/transformers/models/blenderbot_small/configuration_blenderbot_small.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-mindnlp/transformers/models/blenderbot_small/modeling_blenderbot_small.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-mindnlp/transformers/models/blenderbot_small/tokenization_blenderbot_small.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-mindnlp/transformers/models/blenderbot_small/tokenization_blenderbot_small_fast.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-mindnlp/transformers/models/blip/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-mindnlp/transformers/models/blip/configuration_blip.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-mindnlp/transformers/models/blip/image_processing_blip.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-mindnlp/transformers/models/blip/modeling_blip.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-mindnlp/transformers/models/blip/modeling_blip_text.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-mindnlp/transformers/models/blip/processing_blip.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-mindnlp/transformers/models/blip_2/__init__.py,sha256=SkoKNmAp2TVkKyIchoJ3jCCD_sYMolG0DVjiQMty_IY,689
-mindnlp/transformers/models/blip_2/configuration_blip_2.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-mindnlp/transformers/models/blip_2/modeling_blip_2.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-mindnlp/transformers/models/blip_2/processing_blip_2.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
+mindnlp/transformers/models/bit/__init__.py,sha256=j3BxO5PLjCnJcs3HpLg8bqtF-A2uV3-MqynsRQxOrzk,989
+mindnlp/transformers/models/bit/configuration_bit.py,sha256=KzJeGU3lm8vAAb2cKBRpTK3wYRDNd07HwLettL_hFto,6297
+mindnlp/transformers/models/bit/image_processing_bit.py,sha256=SdlSYDfzNvInq4Hw0HcaNbSXfi3OKAmWgMoMSZbim3s,16448
+mindnlp/transformers/models/bit/modeling_bit.py,sha256=haNxYwXtOBfbK6xMrW_i_9YWxrRXKQnsGegZb-T26co,29567
+mindnlp/transformers/models/blenderbot/__init__.py,sha256=nVdCXAIJ28xukWT_2daVaiY-CzpQsvlFkTRbdJZ61qU,1174
+mindnlp/transformers/models/blenderbot/configuration_blenderbot.py,sha256=xiF6Dy6uNdiozP2e1Q0EWStbv_tVQazW5SXeVqI-QXM,7560
+mindnlp/transformers/models/blenderbot/modeling_blenderbot.py,sha256=6sZuUnmz0R8oKGBhUh9xvEP1VIVyQkgepQXXoPo7Trw,64667
+mindnlp/transformers/models/blenderbot/tokenization_blenderbot.py,sha256=fRxHPO20rfX_oGTZCWyaVpVsKRgK9KqsP51Q15ns8xI,19111
+mindnlp/transformers/models/blenderbot/tokenization_blenderbot_fast.py,sha256=fRxHPO20rfX_oGTZCWyaVpVsKRgK9KqsP51Q15ns8xI,19111
+mindnlp/transformers/models/blenderbot_small/__init__.py,sha256=c_85gqZjbyENwSRiFNnF4FQCMsAfM0w55PsD1Gi7sbQ,1252
+mindnlp/transformers/models/blenderbot_small/configuration_blenderbot_small.py,sha256=zqmfx-83kwECL8oWB2gG6KHJndLGGDJOh7xiH9gpRjI,7547
+mindnlp/transformers/models/blenderbot_small/modeling_blenderbot_small.py,sha256=fK2toVTjQgVTXL8sFMAp5DfXIvLo0GLJEm-yElitmVU,65461
+mindnlp/transformers/models/blenderbot_small/tokenization_blenderbot_small.py,sha256=olkEJlN2e_U_bRtV6r6q-SwenXGZFheGtPVJf7YThxg,9002
+mindnlp/transformers/models/blenderbot_small/tokenization_blenderbot_small_fast.py,sha256=hgT9Cg1NrNyskEVEiu1iouekT42G1BH-qtNxquod3J0,4354
+mindnlp/transformers/models/blip/__init__.py,sha256=koBSvzem50oYu4H0GhjNWoA43VeuTlBCtmdUxkvzLDQ,1087
+mindnlp/transformers/models/blip/configuration_blip.py,sha256=D7PPgTsDawVLRyP4Kjhdaa1xJnylWgjxiUIeH5_-3GY,16456
+mindnlp/transformers/models/blip/image_processing_blip.py,sha256=AvyM-kv1rTkrhenZo53d-YmSALHVlVrk4XcodONsc7U,15742
+mindnlp/transformers/models/blip/modeling_blip.py,sha256=2ByycHYTZ30V23UhiJo1Ll7D_BJK_oU0aPzbyMjwvIg,53787
+mindnlp/transformers/models/blip/modeling_blip_text.py,sha256=lc0cmdbg3nxpf8jyRcrXSb5fMPxV5mFW0N5Fe0daphE,43537
+mindnlp/transformers/models/blip/processing_blip.py,sha256=zQBr-Tzx6760S-XcheykV_FnH1G6KmDZwzvK8O561Es,6235
+mindnlp/transformers/models/blip_2/__init__.py,sha256=JrMNCok_UB8uF__6Eoi7S6b5suF74-LwXDfrq3nEJtw,1000
+mindnlp/transformers/models/blip_2/configuration_blip_2.py,sha256=i-luqRjDYwx045UIenmVyLd9JCtcxLeyJ8r39BYQFmY,16475
+mindnlp/transformers/models/blip_2/modeling_blip_2.py,sha256=CV09u9gDIgblkNSFhICayFStZQ-AlUjSZ-B89DoauRY,71527
+mindnlp/transformers/models/blip_2/processing_blip_2.py,sha256=_cnj8SxRRRPJpF87h6OeTDVeYHJSwXIJGCxFKQpqnS0,6730
 mindnlp/transformers/models/bloom/__init__.py,sha256=KeqbZRqYctjujsRqMTil9_rsg9ZhN4Pg8wiD9gy0Qxw,1012
 mindnlp/transformers/models/bloom/configuration_bloom.py,sha256=KbJLtCqVWpE2MRUMuqB_Jd8P_bFCmiY9zTn0Lz9nd6M,7089
 mindnlp/transformers/models/bloom/modeling_bloom.py,sha256=CoJVeQouScAztwuvWa1QQOh45dG6J25FVdCP1QD-atI,45166
 mindnlp/transformers/models/bloom/tokenization_bloom_fast.py,sha256=mR6Qx1Lg-ne1dEuAIlm2288ZjpbTO97GRaQo9Ih4daI,8034
-mindnlp/transformers/models/bridgetower/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-mindnlp/transformers/models/bridgetower/configuration_bridgetower.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-mindnlp/transformers/models/bridgetower/image_processing_bridgetower.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-mindnlp/transformers/models/bridgetower/modeling_bridgetower.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-mindnlp/transformers/models/bridgetower/processing_bridgetower.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-mindnlp/transformers/models/bros/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-mindnlp/transformers/models/bros/configuration_bros.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-mindnlp/transformers/models/bros/modeling_bros.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-mindnlp/transformers/models/bros/processing_bros.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
+mindnlp/transformers/models/bridgetower/__init__.py,sha256=cbfRs8DHZWMoP1HmjORk4xpFxVo0-E0NaRVvK5f69vE,1178
+mindnlp/transformers/models/bridgetower/configuration_bridgetower.py,sha256=6qQ3Pxob50_R04csDNpnfkNDOjmrczlNxFo4sFCaN-M,16296
+mindnlp/transformers/models/bridgetower/image_processing_bridgetower.py,sha256=9Nhc5JjPQV4T2wccvyKkq0vXbf-CBxkryZwcg8dLphc,26920
+mindnlp/transformers/models/bridgetower/modeling_bridgetower.py,sha256=S-zLMF9x1Y8s6idId5h5sjNQJT3b3oDcY7q6i0BBGCY,81582
+mindnlp/transformers/models/bridgetower/processing_bridgetower.py,sha256=KS3yewPazdzNqMYP-lTI4Pi4tQnOKgrQ2mkJ89ytbto,5094
+mindnlp/transformers/models/bros/__init__.py,sha256=FEtJcSApjcOpYyNlte52jU4ah1XY00bHeN-jKq-EvGs,981
+mindnlp/transformers/models/bros/configuration_bros.py,sha256=xn2ZNzHpyS8efUGAoB15Jdv7eL9-b95UBNCEVsONHK4,6419
+mindnlp/transformers/models/bros/modeling_bros.py,sha256=dwEXA1H6d8VQUwq90L5_AByfY8ez0tMAIw_-z6YvgEk,51532
+mindnlp/transformers/models/bros/processing_bros.py,sha256=rGLemBWPecLEAmJEy-b7aK2BcTKXVExQY9I9nqAoBw0,4223
 mindnlp/transformers/models/byt5/__init__.py,sha256=XEn_vKLiydUf9T1Gm6GuCKBOH7EW4FwdouPoWOJo1Oo,809
 mindnlp/transformers/models/byt5/tokenization_byt5.py,sha256=vv5KxKLY1l42vY-Qa-tDohuq-9r8zK5KUdmAW9JURkY,10025
 mindnlp/transformers/models/chatglm/__init__.py,sha256=1Bgff4lD3eBPAJF1RZXFhubA1pQytg8-L0fR5lNkvQA,1131
 mindnlp/transformers/models/chatglm/configuration_chatglm.py,sha256=QrzxCHRdPzRYJowFzcRlomz-CSnp5wGZ8xSZrvhMCvY,4956
 mindnlp/transformers/models/chatglm/modeling_chatglm.py,sha256=V8te9jL7jgVAV6ujg63P0b4pVc3zPtcvy3CofVknSvc,47697
 mindnlp/transformers/models/chatglm/modeling_graph_chatglm.py,sha256=oMg53htaUau488DmqzpI5V2hnWsS_tFxlNCUMuT8ruo,45162
 mindnlp/transformers/models/chatglm/tokenization_chatglm.py,sha256=XwJmVVTvNBJzN119cCQZT2KYQ685A4pyzT_BtHN_-Ck,17674
@@ -323,15 +361,19 @@
 mindnlp/transformers/models/clip/tokenization_clip.py,sha256=ByfdfLXXm4L9JAjbeWJ5OSRU8S2uPd45dBBc861Equs,21283
 mindnlp/transformers/models/clip/tokenization_clip_fast.py,sha256=d8jQNnEpMyuVXolZ5_rjEhxQU7YfmOxTWyP0DXRmyyE,7387
 mindnlp/transformers/models/codegen/__init__.py,sha256=LFcuhSJcria7XEpEiPiztQYpjmpeoYlOx1_OVFp5xN4,1239
 mindnlp/transformers/models/codegen/configuration_codegen.py,sha256=v_sCH5wjQDvsjblKcx84qxcxi3vi-92iXogTXGT3BFk,7710
 mindnlp/transformers/models/codegen/modeling_codegen.py,sha256=AW2myqA-VtHBXMJjriPL_X3xfze9Bvf_BLAvcAYG8uU,26987
 mindnlp/transformers/models/codegen/tokenization_codegen.py,sha256=_hRtr9UGMbVxmswsj7zDL6jngcv5Oy1UFpUqsHdoVm4,15302
 mindnlp/transformers/models/codegen/tokenization_codegen_fast.py,sha256=xE_wVf-zwGDaqVENYn4RU6aP2bQWdfK2VPUaISOvLTk,10395
-mindnlp/transformers/models/convbert/__init__.py,sha256=lQIFERwnbfoGSfcuVdbXXNgAIcOsvW3Sv-PjrUD8o6Q,691
+mindnlp/transformers/models/convbert/__init__.py,sha256=Iu5oTT0oUxggtzokfWhIbaS6d9NjsiWOlXVD433StB4,1082
+mindnlp/transformers/models/convbert/convbert.py,sha256=ZMvqx3dbq1s0upQSBSA3H7W5N5l-CnYZo_oH5LqNeC0,47131
+mindnlp/transformers/models/convbert/convbert_config.py,sha256=mh-aos4NRGwA5s8e1R-OFdYvVL4bKzqdu-4ud4w-yZU,3138
+mindnlp/transformers/models/convbert/convbert_tokenizer.py,sha256=Sj4tqPv5rpPEw3PL8_7AKXQrAFdSqR3BzfrZGVTRnH0,21854
+mindnlp/transformers/models/convbert/convbert_tokenizer_fast.py,sha256=7o_J7kWIWI9BAqkLtUOtRDPZhPM7jlazP2bQ31E1Cdo,8790
 mindnlp/transformers/models/cpm/__init__.py,sha256=pvKlCDjSWg9cKZ6S6H1Xs8sqlJp3vvIqsqn7IFP41iU,1013
 mindnlp/transformers/models/cpm/tokenization_cpm.py,sha256=t794D8DuhEHnlptM8wX0VYqkYij8etGY-4Sb5qy9DHU,15403
 mindnlp/transformers/models/cpm/tokenization_cpm_fast.py,sha256=7Rz4OfUCmkIMFhVA0Ek_IRoWrrmDxJy7UpHCQtK679w,10855
 mindnlp/transformers/models/cpmant/__init__.py,sha256=inHmfIXlqC803ewRm45j5ZrP49s3Qv8lZiqNcD8Y-Pg,1110
 mindnlp/transformers/models/cpmant/configuration_cpmant.py,sha256=oAh5wLZwRuWnsGHvAMy8wcaUhfByioRoLwf9ILxjwvE,5439
 mindnlp/transformers/models/cpmant/modeling_cpmant.py,sha256=tqmeb2uxb_6drgtBYW0NlwY8OSdswtGkKAN6VgJPCWE,35004
 mindnlp/transformers/models/cpmant/tokenization_cpmant.py,sha256=Ag5DQYU0u13JmkPly7-P6SBPxsqGASDUDpJD4pkkf1c,10166
@@ -419,14 +461,28 @@
 mindnlp/transformers/models/graphormer/collating_graphormer.py,sha256=EYQkdGVUm6Bq5X35dJkDuqF00GJva1uoxxtOe1x2n4M,7817
 mindnlp/transformers/models/graphormer/configuration_graphormer.py,sha256=gztddzaGpyzBYIJnaZ3wlWcuykiQdUdPN9XQWnyHnmA,10646
 mindnlp/transformers/models/graphormer/modeling_graphormer.py,sha256=7I2lhHUD_DiDWpcdBk0I8m-fi1JKwH0lkdA7TUY5cLs,37098
 mindnlp/transformers/models/graphormer/utils.py,sha256=Xc21HWFUu3Oe-fbrAZPVCJGGXSriovHXkrXVVIPA3w4,1555
 mindnlp/transformers/models/hubert/__init__.py,sha256=nglsln7YuK3sRM5QrilVQv-_xaFtEBS4Z7msKrcRFcc,1039
 mindnlp/transformers/models/hubert/configuration_hubert.py,sha256=mzXg5FTaetx3obaQhqeyER2ttqGKkwIsZBg7-8KNhsA,14985
 mindnlp/transformers/models/hubert/modeling_hubert.py,sha256=yRJR85JrAAjfgthM9KjsHX-Y7CplXMOp0-yWpfL0cT4,50925
+mindnlp/transformers/models/internlm/__init__.py,sha256=MFygH9Vxrgur1OB9VeDayoAldgxl00ux3Kh51InEPOY,1028
+mindnlp/transformers/models/internlm/configuration_internlm.py,sha256=kP6uKw0KTZf9Ucsyvr3ZNxppSlXJApnpwp62ebDFUXs,5010
+mindnlp/transformers/models/internlm/modeling_internlm.py,sha256=zUi3OQ5Cuu-uD0Y8x2Rv1QCSkKAVcr_H4CZ_D5LhQls,34104
+mindnlp/transformers/models/internlm/tokenization_internlm.py,sha256=m3FqvRYsAHaymsWBpqt43hhDvnvhalwMXsMgrPygOeM,9764
+mindnlp/transformers/models/jamba/__init__.py,sha256=n_kMo4uKZ7-bwN0ebnPEbsRWnQF892uzNrydjaSUL8I,900
+mindnlp/transformers/models/jamba/configuration_jamba.py,sha256=4qJZFGmV4gg8Ca4N9mmo7POxgPcatnQbC8O_RUtXaX8,11241
+mindnlp/transformers/models/jamba/modeling_jamba.py,sha256=y6XhZkm1KPmC-9h8mCQatWWPkrwHQVeFMkq8ryiu8Hs,65061
+mindnlp/transformers/models/jetmoe/__init__.py,sha256=7EBTWZbqM8lhRHjxmTJlo4ePcGAMPo4upvX3zCuhn0U,907
+mindnlp/transformers/models/jetmoe/configuration_jetmoe.py,sha256=0PatmRGjuDbpR__5-5Z-_X0lmvyBztSxoRncdqTtqW8,6280
+mindnlp/transformers/models/jetmoe/modeling_jetmoe.py,sha256=GLCRx-bNLMVyng932_-eGUJHLAagatDGf5cqGlPXNEE,42819
+mindnlp/transformers/models/jetmoe/utils/__init__.py,sha256=uWtdAguGkj0nI8JX8Y8o9zGAkDpdGAgzzYkDPx_lYv0,83
+mindnlp/transformers/models/jetmoe/utils/gate.py,sha256=b7BQruKCuy-smObt7py-FW--kIl0Mw0f0k2KJwvy414,4097
+mindnlp/transformers/models/jetmoe/utils/moe.py,sha256=VvPvi49aGKx7jNKSEBNr67k8MQKPWBCt-VJUZg4Pajg,9590
+mindnlp/transformers/models/jetmoe/utils/parallel_experts.py,sha256=FhXrBDA-zATHVOE_ewch1IWsJ4GyCdEfZbiuCdpy5gQ,3474
 mindnlp/transformers/models/layoutlm/__init__.py,sha256=j4NMb9Slo5Sh95L1Uy141gQze8Amcl3JyHJMiElIYL4,875
 mindnlp/transformers/models/layoutlm/configuration_layoutlm.py,sha256=1-jauOvOJ6FSujCYFHPD3rEJ8HExTu08Tgqbt2uFIYI,2450
 mindnlp/transformers/models/layoutlm/modeling_layoutlm.py,sha256=xljNynSqPD48Zk7oJ3knYeUtFclLpEfaQcVxytJfLqY,54421
 mindnlp/transformers/models/layoutlm/tokenization_layoutlm.py,sha256=fMyj05mNuYVgGn_UlpTF7hQR2G5C3-6Xpff6xmDsRFo,22005
 mindnlp/transformers/models/layoutlm/tokenization_layoutlm_fast.py,sha256=0r1i_kkveL3pdjbNX801Jf0CPxB8AYLvvbJR9c-BFno,9082
 mindnlp/transformers/models/layoutlmv2/__init__.py,sha256=XtNGs88xUP92E9t3aCU4nHkUQFFeWYfJ_0px_iN7eec,1365
 mindnlp/transformers/models/layoutlmv2/configuration_layoutlmv2.py,sha256=rww-TXZi0ISlW59YgK-8ajFfaABxSNVi7XEOSfsBVgc,13789
@@ -496,14 +552,19 @@
 mindnlp/transformers/models/mt5/__init__.py,sha256=h8w7lBquHC_xwuAVhC5d6WBZZCk2UL-wY1Yy0Rv8now,889
 mindnlp/transformers/models/mt5/configuration_mt5.py,sha256=9ZuBxldxcEJJ71WEiwdrx2mLNxJhNU0HS6BSeiLZEEo,6755
 mindnlp/transformers/models/mt5/modeling_mt5.py,sha256=rBAmjR1FIWC01CYCYAWn9LyGXAwjQibpX8fhj0dCcw8,81209
 mindnlp/transformers/models/musicgen/__init__.py,sha256=9wmRbv8p6xPKq3-kHmFyVqaedPTrB_zHvEwXSiUKotE,1025
 mindnlp/transformers/models/musicgen/configuration_musicgen.py,sha256=ENhNHSLRFmKUFtReJiNveFXiMu4b8Ht-3H4NrpBszdU,10700
 mindnlp/transformers/models/musicgen/modeling_musicgen.py,sha256=3fClvekkyNTlmlnUdiSBM5y05f8i_dyRwSgdfWO8ll8,110242
 mindnlp/transformers/models/musicgen/processing_musicgen.py,sha256=UFEzkU38C-MhDxiuzIwLK3s9pQtEhHp6OwyNAw5W3bM,5684
+mindnlp/transformers/models/musicgen_melody/__init__.py,sha256=nVyym9jyc4ys3XJ4w00JldwrzfOuV2A5cZDyDmVCXHk,1240
+mindnlp/transformers/models/musicgen_melody/configuration_musicgen_melody.py,sha256=_y8okHiHLYk4SNw3AhPDauxQ9IxlGDMU5KDlSX2eG80,11975
+mindnlp/transformers/models/musicgen_melody/feature_extraction_musicgen_melody.py,sha256=fLU-tCK1FlHF-W6krv04SGnUb4LOpKJ_d7c5k780wHI,15630
+mindnlp/transformers/models/musicgen_melody/modeling_musicgen_melody.py,sha256=2K6RAWadxkJiia0HdC_BirNrrTll6RL0tgh6knK-k4s,106734
+mindnlp/transformers/models/musicgen_melody/processing_musicgen_melody.py,sha256=IX8c1hYh6DHBHuQEm--ngHJXKooWHjbGRERr6oAMtrc,8653
 mindnlp/transformers/models/nezha/__init__.py,sha256=_PkPAyzLAz9gselRav5O46DRJEdVw8sN9-g_BrB_D6o,945
 mindnlp/transformers/models/nezha/nezha.py,sha256=W1bNLGgwpnhT9OvXvTiMLbw-00pTn3c37fdkwPLTTOA,47907
 mindnlp/transformers/models/nezha/nezha_config.py,sha256=O7mIAPzbQESMi06n4Pc59NE6i2TfhUIDPcZ-IIkH5T0,2431
 mindnlp/transformers/models/nezha/nezha_tokenizer.py,sha256=NaXJS5yVYSp5OYLb64eXEwHGOd-NLVVaq7EEPM1ONDU,2953
 mindnlp/transformers/models/opt/__init__.py,sha256=9hRJbyk3_rziUsPgFBO8BqgUDAfL0rjGOsFqwIeARpA,891
 mindnlp/transformers/models/opt/configuration_opt.py,sha256=Mtj7zDkDq2-bgiMmHCVOCn7VUUvNv9ANuQ73MaSWHgw,7373
 mindnlp/transformers/models/opt/modeling_opt.py,sha256=Si8x61l-I_uLbhFwR1uAciJ8iWS2JViiBJA38zoeI4A,47645
@@ -520,29 +581,32 @@
 mindnlp/transformers/models/pop2piano/processing_pop2piano.py,sha256=NTaPAYCArR2vkfmN2tse4TzJfcSi9OcMokTpCAOqexY,5589
 mindnlp/transformers/models/pop2piano/tokenization_pop2piano.py,sha256=ddr8rAIYIT0nnW58Rpb7kvvvFcKGUlTPQVhgvVCOdKY,32281
 mindnlp/transformers/models/qwen2/__init__.py,sha256=A1z40XNhUWVouukydmYIEMkJiQ5R8-VA6v2VMjmIYzw,1108
 mindnlp/transformers/models/qwen2/configuration_qwen2.py,sha256=f7Qok0UdEvrzqfBc_nK-NE85REI7UhxHxq0g4TLk494,6840
 mindnlp/transformers/models/qwen2/modeling_qwen2.py,sha256=SgyiwmyP7CSm6rVXJgy7eoHA1uFqk-X5GvFON3tJXf0,35438
 mindnlp/transformers/models/qwen2/tokenization_qwen2.py,sha256=wrmG5F6YhN3dhNYTct8n1P6g3qo-LjEkiKJXvSzTUF4,14338
 mindnlp/transformers/models/qwen2/tokenization_qwen2_fast.py,sha256=h0jX5cdJWAl65dRl_3fZrnY1cjFzqVrjYROAib1TL0w,5700
+mindnlp/transformers/models/qwen2_moe/__init__.py,sha256=cB_VA-pLaCUGOBa0pkT1LKTrL6kJwRyP1G7JaTwjq3A,927
+mindnlp/transformers/models/qwen2_moe/configuration_qwen2_moe.py,sha256=MPpvCyeIRawe4u38dERbcTH5qmFxmYMeTqk3XMhpXZA,8573
+mindnlp/transformers/models/qwen2_moe/modeling_qwen2_moe.py,sha256=j_SgqoVZHRz-GITnXV6RZNcRXFx9xhlQwVaH9D01RzM,45282
 mindnlp/transformers/models/reformer/__init__.py,sha256=JBrlkdAEhjZnqSzlb0Nj3UiRt4SvdO5KdI-r4c3P7yU,1148
 mindnlp/transformers/models/reformer/configuration_reformer.py,sha256=EcUSxvfhD8iyg7EP4wV08QwvT04zn0TxWAfaB2o1Dzg,13575
 mindnlp/transformers/models/reformer/modeling_reformer.py,sha256=n9FZ9p3UgLkMuTsJYtE5RySMW1eWGKC2cOnG-0LueJg,107482
 mindnlp/transformers/models/reformer/tokenization_reformer.py,sha256=aWODuAwaFX3ri0JbmuUB7iGhd1ozIEFxqg6IUhMYnnA,7289
 mindnlp/transformers/models/reformer/tokenization_reformer_fast.py,sha256=yE9t0rpSvJj8Gxu5luAqnllqzBQXAmDREqJg6pTnXSM,5004
 mindnlp/transformers/models/regnet/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 mindnlp/transformers/models/roberta/__init__.py,sha256=-1uT5s_1QvcBVwoIuzH5noh8Oqam58A-kjy-wR5yjFk,1133
 mindnlp/transformers/models/roberta/configuration_roberta.py,sha256=lRytCf4bsbixEKecY5I0YNQVEwHGk-U0g_VJk_HKDg4,2420
 mindnlp/transformers/models/roberta/modeling_graph_roberta.py,sha256=TaOJIrjGwIhMNjdr85m4sljIerCQCBXPKT7OuI-FYSI,12078
 mindnlp/transformers/models/roberta/modeling_roberta.py,sha256=5pDEbF56D9u-g41czcg5qM2qiUI9NyKWHEY3GcGqT1E,60971
 mindnlp/transformers/models/roberta/tokenization_roberta.py,sha256=sybkJ_yNIKtwp2U9R_A-CweayEPSLKaFHZSUM06XmUg,18177
 mindnlp/transformers/models/roberta/tokenization_roberta_fast.py,sha256=c8TYS3H45EJNOrf1_QtaxTlwVW4__5jLU6ZnjTJXFC4,13885
 mindnlp/transformers/models/rwkv/__init__.py,sha256=CBnS5dn5eB0mgBcvieMr7GQxArgiy-52btb6g81r5k0,995
 mindnlp/transformers/models/rwkv/configuration_rwkv.py,sha256=NpAYyaOA9hjJAoMSkZXRz60ktjc8GF2PFfniWfG47Lg,6303
-mindnlp/transformers/models/rwkv/modeling_rwkv.py,sha256=zLAPCV7TtgGZgcXtbPchgjR2qp8JjE-C6A1_3sh4Tmc,28862
+mindnlp/transformers/models/rwkv/modeling_rwkv.py,sha256=GKQjWxzpAXErvyHprCW64WMz2bQZ-aechPN8-BFcRPk,28881
 mindnlp/transformers/models/seamless_m4t/__init__.py,sha256=wrRuR7nef-nJIQ11iw25TJyexjmJ9cs7gslhgs3EdVw,1459
 mindnlp/transformers/models/seamless_m4t/configuration_seamless_m4t.py,sha256=c9srxtlsDzYks60TQYnHrK2KIVQmPSMalZZ7Nh7kCPk,23758
 mindnlp/transformers/models/seamless_m4t/feature_extraction_seamless_m4t.py,sha256=3RUmWcSJ-V36M6bsGh9NynfhFVZGy7ERG-kONR-9NhQ,13061
 mindnlp/transformers/models/seamless_m4t/modeling_seamless_m4t.py,sha256=ghzAbj8OL1mCDeXTZutM0cMc61HA3R7UfM_eU6iVooM,189385
 mindnlp/transformers/models/seamless_m4t/processing_seamless_m4t.py,sha256=rrcs8-mM1ryX-YrLEzTcBEwyHh23vGwv0lhYCJTerjY,5891
 mindnlp/transformers/models/seamless_m4t/tokenization_seamless_m4t.py,sha256=EjBcevEuM149D8RFk9Uzg5dXElhM8GkzaAlymG8McCg,25979
 mindnlp/transformers/models/seamless_m4t/tokenization_seamless_m4t_fast.py,sha256=8FMa3pyqY7-sfLFbCMJfK1GXyGKcvF3Pec-mdubCOZ0,20489
@@ -551,17 +615,18 @@
 mindnlp/transformers/models/seamless_m4t_v2/modeling_seamless_m4t_v2.py,sha256=4X8IJD4bj5jVKmafHWTgfa1kx3QanvjaphcKdTUrNss,211331
 mindnlp/transformers/models/starcoder2/__init__.py,sha256=UmUL0F8INx05ja3CIuZecYzsi3GpMUiVuFali50rQzA,934
 mindnlp/transformers/models/starcoder2/configuration_starcoder2.py,sha256=sLcdqFcpaE_PvgXPcJxyjiXOJhQKOav7JgM1CGLicP8,6919
 mindnlp/transformers/models/starcoder2/modeling_starcoder2.py,sha256=cTee3GkO-x_nPvVt2oiW4F6kMfeRGtTSgbGpKpHsVvI,36584
 mindnlp/transformers/models/t5/__init__.py,sha256=rCYTY2eSH1OB8f5feb4MoyVwyyDyq1qgMG-GqfMojYk,1171
 mindnlp/transformers/models/t5/chatyuan_tokenizer.py,sha256=mshANadj5d4B4XDeYPBYuxk_nN0J_Y7hdsDG2ZHl0-I,4419
 mindnlp/transformers/models/t5/configuration_t5.py,sha256=AQA-VvnksX6N0zFwM9qBP-JdvVQv8syqgQCddnVb3ZI,6772
-mindnlp/transformers/models/t5/modeling_t5.py,sha256=rFwNKpTuy6Vi3KW034Kjcr3ANveYG7vGhN3xXPgJjxA,70760
+mindnlp/transformers/models/t5/modeling_t5.py,sha256=zEWDVtRutUKsLWsJV8umlYUlz6WRfdF0Hn5eRVgQ3Ws,70759
 mindnlp/transformers/models/t5/tokenization_t5.py,sha256=Jh6Y25FoHsguu2t5I19KQxu6B8Coc0EIKKlE7_0mk8A,20403
 mindnlp/transformers/models/t5/tokenization_t5_fast.py,sha256=OYiqM4eQwKrICF5SXwZtgD0MtPZZkF2WMJPRssLZC90,10806
+mindnlp/transformers/models/table_transformer/__init__.py,sha256=pENDaP1fNav394vPX685cEL23ZbqSYV2l4wp_Yud0kY,694
 mindnlp/transformers/models/timesformer/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 mindnlp/transformers/models/tinybert/__init__.py,sha256=e3pPmmiTOu7_rHm_rJb8diDwW8pvQuv5feDcOjmR_bg,879
 mindnlp/transformers/models/tinybert/tinybert.py,sha256=3bhOQFWOp01sFGs1J5KqSCQnp8GHe8B1KFvOJ-bbuNU,25866
 mindnlp/transformers/models/tinybert/tinybert_config.py,sha256=509kbrtOtD_x02BXWoBzg5Ey7dNrg1klkeX8EN1Jg8Q,3520
 mindnlp/transformers/models/transformer/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 mindnlp/transformers/models/transformer/transformer.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 mindnlp/transformers/models/transformer/transformer_config.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
@@ -587,14 +652,19 @@
 mindnlp/transformers/models/xlm/modeling_xlm.py,sha256=Tv6HsmwkjoCZ_fjSKN1Rad0zrmMkw0QoR_mnJ5_D00Y,46629
 mindnlp/transformers/models/xlm/tokenization_xlm.py,sha256=6bqkoiJQvurtOtZzQ7G0RgJm5eKkghVk-5Cw9Ekqnuo,34991
 mindnlp/transformers/models/xlm_roberta/__init__.py,sha256=19WdzbQ85JEp76zYsqyq7629mKrtPZFk1h-9OdkvghE,1192
 mindnlp/transformers/models/xlm_roberta/configuration_xlm_roberta.py,sha256=zWack7GDUw-p_H_jvhtFyPYhS2RvniTU-0fvJAiVz0E,6980
 mindnlp/transformers/models/xlm_roberta/modeling_xlm_roberta.py,sha256=QjWiEK_mtbqu-sHFbn0q7rVoojaznGAnOxFBehyITog,63314
 mindnlp/transformers/models/xlm_roberta/tokenization_xlm_roberta.py,sha256=UCy_KMjTgBUzlDrx94Il8TtL7kQ8hCV2WnKVbsrp5Y4,14289
 mindnlp/transformers/models/xlm_roberta/tokenization_xlm_roberta_fast.py,sha256=4vGn2z6bOySEgXfhViM1QPthAc-tfOs4pHkJOCN3z0U,10433
+mindnlp/transformers/models/xlnet/__init__.py,sha256=u8gHvTfnYGl7gAHlr6kwZSoT4tihza8PoGdIBpOTSlY,1109
+mindnlp/transformers/models/xlnet/configuration_xlnet.py,sha256=Xq9aQYkwwbCFWzs_yBVi03lVG0yCk7UjfX38KDjxtVI,4735
+mindnlp/transformers/models/xlnet/modeling_xlnet.py,sha256=0si1Htl5IOaxM6A-4gmyBPNY24drEhZ9m26SfBo2pcE,85973
+mindnlp/transformers/models/xlnet/tokenization_xlnet.py,sha256=ZzFVVMz7W93XAtiSS4nPDZm-aT6WsL6tpg1rQjY-JUs,16395
+mindnlp/transformers/models/xlnet/tokenization_xlnet_fast.py,sha256=JEEfMSrnxbb9XzQRVooLW1oek63CgTuak0h8Nx6Kt9g,10222
 mindnlp/transformers/pipelines/__init__.py,sha256=f_l_LRhYEAZnvj39ulSyuSVUPIDHI0M-qavu9RBNIoY,26016
 mindnlp/transformers/pipelines/audio_utils.py,sha256=yDcbQLkIoZTQUuPXXuAPaIUQeFnIexJOqQe_DR-enig,9793
 mindnlp/transformers/pipelines/automatic_speech_recognition.py,sha256=e5C0iMGYB8V6y0zeWvwdkcw3A6FH_DEDuV0c27mhSeE,37518
 mindnlp/transformers/pipelines/base.py,sha256=bZV_FGWncZJry29bkhA5x-GIeurTNy8UVmi9EmdAuDU,35984
 mindnlp/transformers/pipelines/document_question_answering.py,sha256=5_Nim0IhGVUOjw2sdVEASmfNzmsAdPvU69s10uwe0Ls,27144
 mindnlp/transformers/pipelines/question_answering.py,sha256=UFDwjxbU_k1opZ6Ep5ifQxbhQpDjXSjRDdXSvVJMAZs,28511
 mindnlp/transformers/pipelines/text2text_generation.py,sha256=xbOlhrXcdm_6mG1N1tRr6nCMrVajbEXJJJOAHpf37zo,17651
@@ -608,32 +678,75 @@
 mindnlp/utils/download.py,sha256=c532Tso8Hc0gRsv6Vk1CbPjAAYxmxko9YCUMUpDLqfs,32202
 mindnlp/utils/errors.py,sha256=EL0gCowHpOXiei23tOTRMMbTOVEoxKW1-ZDIb7BGXhk,12029
 mindnlp/utils/generic.py,sha256=hyHbSGz5fxBy5Ur5kjYPpUGODEWatNpaxrvCGFq22QI,11747
 mindnlp/utils/import_utils.py,sha256=SJvtG0td-4M_s-ajBeCO7MiXsbKQoBFtGdqkBEmBTlA,14008
 mindnlp/utils/logging.py,sha256=podm3st4jOwTcQ7H1O2fuHvh93XNECauu11MaNXdFoE,11478
 mindnlp/utils/peft_utils.py,sha256=baZaj7HcDBkvCYK3A9cEpjjR07VexYEisFRbonmFBtg,4451
 mindnlp/utils/save.py,sha256=EtnCwtbFWfrBGtlPo1UK-F5IZinp98Pc8RhyGoR5T3A,1898
-mindnlp/utils/serialization.py,sha256=feVcb_dAVu5t_u-5avWZrBpIu0O-N3utP084G16cJ18,21524
-mindnlp/utils/testing_utils.py,sha256=dngsfYCfgERX2AXk7VTQOIZPPaHphiHx6_VLZ8_vmyI,49805
+mindnlp/utils/serialization.py,sha256=RLhILVf_CrRFJOjs-D2eDVABRyvRsgIQ5XM73BgmrZE,21582
+mindnlp/utils/testing_utils.py,sha256=xezyGUublDJSOQr97Zx86hDS08BHDpZiBudpISBM0T0,50268
 mindnlp/vocab/__init__.py,sha256=gs-jacpF3faHAH3SmDh9OqguGI14yVHHCFbKJI3vbi8,712
 mindnlp/vocab/vocab.py,sha256=DFK0c508tVTGjs1Tlc0BxN-VdULS-XLjTHm-2w3PG0E,11522
 mindnlp/workflow/__init__.py,sha256=xh07UUH2_UWGmuy8sGt__xC1pZqEGegnyjK17PKfHks,768
 mindnlp/workflow/utils.py,sha256=pAykV-PnUlQISmBFn-9HttI3mK77DU4Z8nUUGKL9VC4,5813
 mindnlp/workflow/work.py,sha256=Ukrvx7lYYZf2v2qPmPJ5Ug_mKAH7-hwQYLTMvqYLb1E,7577
 mindnlp/workflow/workflow.py,sha256=3Z6rq8tKdHL1j3ggzZ78U7YHQYRrBRC8ubZwxDRbpVQ,7103
 mindnlp/workflow/downstream/__init__.py,sha256=oSZxbB24ULf2vzEpwUrGU3Ufe1rBSVs9O4pY1HvU2Ug,757
 mindnlp/workflow/downstream/sentiment_analysis_model.py,sha256=2arUbL4sv96uybretuy8YZhUGyUxVp296eceNELUn7k,1557
 mindnlp/workflow/works/__init__.py,sha256=qRcg5U1kyjt91rsSTIEczV9h75jMONpFdlRDMC8H5G4,780
 mindnlp/workflow/works/classification.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 mindnlp/workflow/works/information_extraction.py,sha256=qu3woCpgaWgSLTjuPe5tNZUiaelv7AzjCS1gqb2iujk,26028
 mindnlp/workflow/works/ner.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 mindnlp/workflow/works/qa.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 mindnlp/workflow/works/sentiment_analysis.py,sha256=t6J1OV83_PYH6ZLwXi5-KnPkVAkhvjMVFC_LJq76ooQ,6032
+tests/README.md,sha256=7ko9b5GA-TbkaZ6KC4F1o6RAhVioX6p9yIfwq17VyxY,65
 tests/__init__.py,sha256=lwey9xjqqTeDK1QXjlJjsMNPpVGJsHa192sadlzh7vY,708
 tests/common.py,sha256=t8sKSFL-uq-6P8abw6vbqT6IGOKuUa3cW_DFe596ztI,147
+tests/pytest.ini,sha256=mwKd8Rw5A7TcFvEPZyIny2EN5a1ijYa3y2Y2NRL4u_A,129
+tests/fixtures/add_distilbert_like_config.json,sha256=7OalygSPuWJc1_jeWSm6ffSP6e1BqXovduWdUm0oBm8,504
+tests/fixtures/dummy-config.json,sha256=rAoPGa_mBX5B3J9exnOu2Cbt1TIvVf_cx_pWKoJdRcI,29
+tests/fixtures/dummy_feature_extractor_config.json,sha256=CSr4ZqiObQiBe8mDiRy8P0Q1xcPpa-maSW5FsqugMgU,101
+tests/fixtures/empty.txt,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
+tests/fixtures/input.txt,sha256=wKHIThBAG0BjPeoEcJki4Wt2IuJyMXzXdBRc0gmKGZM,52
+tests/fixtures/merges.txt,sha256=1MC_s0hAEZon430exLBJpm3I51vfI82CtO8OyCEb8QA,36
+tests/fixtures/preprocessor_config.json,sha256=twMYYFdVbijNESQlAQJPawUpHfFy764mtojqayOliwg,100
+tests/fixtures/sample_text.txt,sha256=UgWq-pCvsIQbJLBctGE0XjaSqF2OqAJ9iTWvED_VxhM,4394
+tests/fixtures/sample_text_no_unicode.txt,sha256=X3DKBj6or4bg6RhHjSDMempmgjpLB4xLWaA9-X-gBUE,4284
+tests/fixtures/spiece.model,sha256=_vsCtmemxcL-J2AtKOX7NCj2aricfW84jnyNRKAtAzY,760289
+tests/fixtures/test_entity_vocab.json,sha256=qlR-IoRgUgkJ3nMJoenEfn2hMxQFhbCg-g7bFJ1wyvA,76
+tests/fixtures/test_sentencepiece.model,sha256=jf0erkUiKBsbg56rh3p5G-_sehZjpByBTHfZyJx0jy0,253154
+tests/fixtures/test_sentencepiece_bpe.model,sha256=xN549dEe4JFBFl0x2n2tl-gJ3W7ntSoMvG12qXMCgoY,251527
+tests/fixtures/test_sentencepiece_bpe_char.model,sha256=f8xI8-Il9iexZB20EM6wyGSb0rDJguFQsD-L43KKtWA,238473
+tests/fixtures/test_sentencepiece_no_bos.model,sha256=bzr5fC57xR14HnRAqjPe7n9ILqyBnSP9JK-A57TOJkY,253134
+tests/fixtures/test_sentencepiece_with_bytefallback.model,sha256=xh7M5DNp_DurlWZGTw5x86113CMZparcKlYePjElAuM,270096
+tests/fixtures/vocab.json,sha256=7dBmkVu-INEOyc18aPhE6sXzWm00sAST2GDDYibElRw,228
+tests/fixtures/vocab.txt,sha256=hZD_VOmhXhbYhOY9GKbKh1sztsF1_-dsbgtVwvTcmp8,85
+tests/fixtures/tests_samples/.gitignore,sha256=gTH85GETNNiO8zZ8BZ5PTOAZlzTtucwxtGfu70Tb4uU,52
+tests/fixtures/tests_samples/COCO/000000039769.png,sha256=z288S--hSHMsdFPg3lr6sA9oJCdDX-rS2IsHqWFc2sI,694498
+tests/fixtures/tests_samples/COCO/coco_annotations.txt,sha256=WLXasf4Pi7SX5-TDY7tlNN7Qv9mIO9hEm-T8Eut2imM,4075
+tests/fixtures/tests_samples/COCO/coco_panoptic_annotations.txt,sha256=dqssr0ea90JJ3yr3nVaAaIMNLUu0krmgwGMD-2IYlaU,555
+tests/fixtures/tests_samples/COCO/coco_panoptic/000000039769.png,sha256=H-kPhvunQs6E6UcQo8EJU4BUS-5VvIJGNFLV9XRcTE0,8269
+tests/fixtures/tests_samples/GermEval/dev.txt,sha256=cu52g0mtyio5ZLSeWAYjqXDUjS1BePZpwGT0kmQwLJU,1718
+tests/fixtures/tests_samples/GermEval/labels.txt,sha256=t8fVkXdl_YbaRkvrlMTFaLs4mRCwc0oTSL8fcEKSnPg,218
+tests/fixtures/tests_samples/GermEval/train.txt,sha256=hrbCXqbemOYT5qh7nsuv8X9cWv-XSqlvrMGgZ37yGno,1779
+tests/fixtures/tests_samples/MRPC/dev.csv,sha256=RWZKRXC4o81DvmZR1heEJj1uUd7n1byM2aUD1qSfNoE,1354
+tests/fixtures/tests_samples/MRPC/dev.tsv,sha256=SqkXUw5tyIuoNgFiqPjOvb-lX2gHc7CB04TIKtr1Jok,1386
+tests/fixtures/tests_samples/MRPC/train.csv,sha256=RWZKRXC4o81DvmZR1heEJj1uUd7n1byM2aUD1qSfNoE,1354
+tests/fixtures/tests_samples/MRPC/train.tsv,sha256=SqkXUw5tyIuoNgFiqPjOvb-lX2gHc7CB04TIKtr1Jok,1386
+tests/fixtures/tests_samples/SQUAD/sample.json,sha256=F83am-XRiXLSg0d2c0NV_3rzcjCG_RPAZRg6BdvtRro,17233
+tests/fixtures/tests_samples/STS-B/dev.tsv,sha256=Mi3M0aZut7cc6nG4O6lOb1tG2SJji6pWuy5YIasIoVM,1126
+tests/fixtures/tests_samples/STS-B/train.tsv,sha256=1xSYqJDffO8n5Do40J85VWUj5B2jizgc39SohcgVzDg,1121
+tests/fixtures/tests_samples/conll/sample.json,sha256=Mf_53uEhd74JUHenSwIh8_kX4KB5rf0TnFo85vvvl9Y,3001
+tests/fixtures/tests_samples/swag/sample.json,sha256=njXm4XXdxYxVz7vJiucpkjBRs7VwhkW6lpxHbeeNnGc,3522
+tests/fixtures/tests_samples/wiki_text/wiki_00,sha256=qWGIX9pcn8TfFneaZ6cIyMstVJdmsj7Sn_oVQFQTwUc,79924
+tests/fixtures/tests_samples/wmt16/sample.json,sha256=PSH1usabsIumFlZv9BBrjkfFuEA4bVMEP_Qm8ZjHSrY,1423
+tests/fixtures/tests_samples/wmt_en_ro/test.json,sha256=cQ--FKyjLllS8WCvbJ541GZm_3-gdEHp6ZpPiUSpov4,27417
+tests/fixtures/tests_samples/wmt_en_ro/train.json,sha256=CzC4ogZSWGx8q0MTOxksuIJcQ6IGUEYs6-BvoHsjsjk,11234
+tests/fixtures/tests_samples/wmt_en_ro/val.json,sha256=rHKGPfMHUEba0OOab49H5Sm-OUtj_qeDGyQLlawG5xY,21699
+tests/fixtures/tests_samples/xsum/sample.json,sha256=2J_OT9Ea0CQH4VNS46-ab5Dv1TMnV2TVA5sy3FP1WaE,15601
 tests/st/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/st/test_bilstm_imdb.py,sha256=xRSKJkpI-fKDcA7YZZ2f8ipKPVN4HajdcgkNQbUvFCM,2834
 tests/st/test_longformer.py,sha256=2nOLV7RCRK8J85AinfcRxJlZB9LxHUm8zN_eECFp7Ao,2110
 tests/test_module/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/test_module/custom_configuration.py,sha256=7OqOEZxuJ2qshW25cPjz976chbK6hl_5zKr9G_JQ1gQ,387
 tests/test_module/custom_modeling.py,sha256=zhTelUtzaewXJPr3XpZO2Gn5as7TWsDllTAdC2tXCcc,777
 tests/test_module/custom_pipeline.py,sha256=ELI8p05HEFFdw35cQMUNp0g0r_99gU2DEWziU12jn9s,1117
@@ -654,14 +767,15 @@
 tests/ut/metrics/test_metrics_class.py,sha256=70z3xy9DQpahVTzQz6POD9GgVa6uvr5h56ikg57P_-0,32965
 tests/ut/metrics/test_metrics_fn.py,sha256=bGzR_dG3GuDgkTmvYk8jHqaSXjf37m_LViXpgCfgHrQ,19939
 tests/ut/modules/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/modules/test_crf.py,sha256=tB2srz7-ZHarCMtkC3J_yfoIJ89Yg5F1_7mMa-1HY4s,13357
 tests/ut/modules/test_decoder.py,sha256=MIsy98u8pgJjWi-VDe48GE7stXqBk541qebT9GdcPS8,5675
 tests/ut/modules/test_encoder.py,sha256=iFPDlI1log0sMdKzPg1G4pGguGXm_ggRE7UNxWgyl8M,4267
 tests/ut/modules/test_fasttext_embedding.py,sha256=RV9oJCcPGm1OGpIVKCdiy9MQEvJs73Zu6VbDpxpmFAw,1422
+tests/ut/modules/test_flashattention.py,sha256=YaVIrT43kDXh0SBveD-PEesWZPdN3E09CC8KVcoDYcw,3216
 tests/ut/modules/test_glove_embedding.py,sha256=ftppFF6AHXAdomdHbjGHu6_3nHFy_pqdbJX2dBU6wPA,1356
 tests/ut/modules/attentions/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/modules/attentions/test_additive_attention.py,sha256=2k4nNAwc014C0vYrPcgBpa8lx0PMKG6e-qdsmOF1NTQ,1809
 tests/ut/modules/attentions/test_binary_attention.py,sha256=5BN6g8m3E_4y6gF5tsZdpf8gehiHk_urdnpMd_wyUAE,1784
 tests/ut/modules/attentions/test_cosine_attention.py,sha256=4yVUditrbV2h8CX477ZbD7t2iUZU4_6lydyfUwKFEn0,1779
 tests/ut/modules/attentions/test_linear_attention.py,sha256=62VWsEEu2c4Gi9khgSZNmIoLAL3H9vAPuTcw_WUAWbE,1831
 tests/ut/modules/attentions/test_scaled_dot_attention.py,sha256=eaMHF5bRKq7G9NXxBsBQPKv7I0G2vA4U5qusIDUKlxA,1540
@@ -676,19 +790,24 @@
 tests/ut/modules/rnns/test_lstm.py,sha256=mhOECKJuGGunkCI0HsHgKPTODY26xgIY3apiEgzSFbM,5180
 tests/ut/modules/transformer/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/modules/transformer/test_multi_head_attention.py,sha256=QzrRd0bVaTZ5igMtLvWrbByTui0_WcHJqwJ7PXCm-rM,3775
 tests/ut/modules/transformer/test_transformer_encoder.py,sha256=zAgME-8psLPxg8BQtJitYYKxN9YCSb7XhRZbvUmqI0k,2187
 tests/ut/modules/transformer/test_transformer_encoder_layer.py,sha256=K-kmSIMo_woyQI8EeE6puu80WoVX4dcWcpk7O3jztOI,1434
 tests/ut/peft/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/peft/test_config.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
+tests/ut/text2vec/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
+tests/ut/text2vec/test_sbert_embeddings.py,sha256=8tQMVm2_OuttPfdZdCzQkr29k4wwY_iBtcli7aAY9TQ,2756
+tests/ut/text2vec/test_w2v_embeddings.py,sha256=CDM-UuhKSfYL2wbfA9qd7qyi7K1X_r2_uBZUcWqMgDI,2078
 tests/ut/transformers/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/transformers/test_backbone_common.py,sha256=txxEgoTMKhv-Dy7n9Xn4CmFHinn9uJcstgzGAxKHl6c,10140
 tests/ut/transformers/test_configuration_common.py,sha256=gvvrWUeo6bDrb1_SmoM1INjpXFaKk0lveeZmLCAlVsc,8097
-tests/ut/transformers/test_modeling_common.py,sha256=g8YzrFf9hUNN5FADVGXSARZ7tgT198Ulnp3HeuLkKWE,73183
+tests/ut/transformers/test_feature_extraction_common.py,sha256=kWbdOsVnhh1ASYqwUpL0nwmklXl-FyaDKNSI9xHSSVI,2231
+tests/ut/transformers/test_modeling_common.py,sha256=QxNaOVSiymQm5RzvJSb2AOWKHnqUR2-maUyWsbDPHKc,73183
 tests/ut/transformers/test_pipeline_mixin.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
+tests/ut/transformers/test_sequence_feature_extraction_common.py,sha256=vxiKuoq2UiL_kG_D_SeMgQw3KwwJTVWHSaxTd0br7U0,16663
 tests/ut/transformers/test_tokenization_common.py,sha256=XrAn3Ti7YjSyEVodbcJm3sCOzl9fm7EH7ugTFYnpq6o,206613
 tests/ut/transformers/generation/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/transformers/generation/test_framework_agnostic.py,sha256=MZ2dJM_D5Kwjgq8dZikZig2u6Ot--KQRbs04wyfFg5c,28522
 tests/ut/transformers/generation/test_utils.py,sha256=CodMjYzfrrxRSfiFaqCBuB2TdY8qaVUJYDH_BTWGoio,123394
 tests/ut/transformers/models/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/transformers/models/albert/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/transformers/models/albert/test_modeling_albert.py,sha256=ODQALKRaFylnsN7Cj9kas21NGgGVJ7xvgvgMgGphwv8,14176
@@ -720,23 +839,40 @@
 tests/ut/transformers/models/bert_generation/test_modeling_bert_generation.py,sha256=7B9UnefrGvnQz0hwnSv09NqoZl9fGH6G5qJjdEH0RJg,12696
 tests/ut/transformers/models/big_bird/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/transformers/models/big_bird/test_modeling_big_bird.py,sha256=j2Y0zQBNXR1jdN1nkjhC_rJSB9NmrLaXeLdMngE-4Bw,46579
 tests/ut/transformers/models/bigbird_pegasus/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/transformers/models/bigbird_pegasus/test_modeling_bigbird_pegasus.py,sha256=WqyrmoSEot1OyVSVYGahzQmuGslrsCGX4FDbahyIC_o,110760
 tests/ut/transformers/models/biogpt/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/transformers/models/biogpt/test_modeling_biogpt.py,sha256=L2ooSqEsaRy_NSwGYd54YLfhLldYwVoeKwDPP4g_Rh4,19717
+tests/ut/transformers/models/bit/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
+tests/ut/transformers/models/bit/test_modeling_bit.py,sha256=WuGSYsqwZWC_WESWg69OOOo70Iuww4iQVc72eSJFdFk,11755
+tests/ut/transformers/models/blenderbot/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
+tests/ut/transformers/models/blenderbot/test_modeling_blenderbot.py,sha256=pSqmI70eagau4SRLPLX8xAk21pSmLFk4LH05smDiSQw,22474
+tests/ut/transformers/models/blenderbot_small/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
+tests/ut/transformers/models/blenderbot_small/test_modeling_blenderbot_small.py,sha256=YE386zSgYi9EP7_r7JlboYSW57yaw0RU0_CsVQOnR9k,22787
+tests/ut/transformers/models/blip/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
+tests/ut/transformers/models/blip/test_modeling_blip.py,sha256=XhXG2qrxYZjZ_mm0DHrrSwkOq3WEISLA02WPJT9SgZg,42838
+tests/ut/transformers/models/blip/test_modeling_blip_text.py,sha256=ywqe9BjjE8UNiJbNzDSZ5mZUW1i97BElVwcYHohvRxg,6896
+tests/ut/transformers/models/blip_2/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
+tests/ut/transformers/models/blip_2/test_modeling_blip_2.py,sha256=-ZWNSF7EDtWi_dk5Xw2s4UBfE4CTdmkm-sX_zVASAWU,39138
 tests/ut/transformers/models/bloom/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/transformers/models/bloom/test_modeling_bloom.py,sha256=VqftlJT94ESm6lqIacbQvAidYuyysKg74aUo5j-Tfqk,35152
+tests/ut/transformers/models/bridgetower/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
+tests/ut/transformers/models/bridgetower/test_modeling_bridgetower.py,sha256=9ex0ainAcrDZ7J7u0pTbM754BzuPlpOEbaW9TNfmLcI,23014
+tests/ut/transformers/models/bros/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
+tests/ut/transformers/models/bros/test_modeling_bros.py,sha256=qSM0LvtOy2kxVsOtkk9yhM6hMGYKBdLie0W8GadKVE4,16094
 tests/ut/transformers/models/chatglm/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/transformers/models/chatglm/test_modeling_chatglm.py,sha256=ccIUgeWIOHUi8ILkrIupWpanUNpVnfmXr62dwplTbx8,13895
 tests/ut/transformers/models/chatglm/test_modeling_graph_chatglm.py,sha256=FYD3uXuxvbib86psxKqBMNQFeXuChNFGnwDZmjV6u6Y,13970
 tests/ut/transformers/models/clip/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/transformers/models/clip/test_modeling_clip.py,sha256=MJsXqSThGloO4Z5U6pQBFVE3Z1RJzBNw1qJh8ITXTtM,25666
 tests/ut/transformers/models/codegen/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/transformers/models/codegen/test_modeling_codegen.py,sha256=3DTQcST5zay01pU2rr6vBUKYUr_UKgcjrRBDNuYX-uo,23368
+tests/ut/transformers/models/convbert/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
+tests/ut/transformers/models/convbert/test_modeling_convbert.py,sha256=mZWx8gl7TNhtHZRSGwYMEtgIYjti1BTpIr9pduTHijM,19793
 tests/ut/transformers/models/cpmant/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/transformers/models/cpmant/test_modeling_cpmant.py,sha256=WPfF8Tg7v57RM22n8FbzpQnoAjHwNRkAjQVVN0tKhEg,9906
 tests/ut/transformers/models/cpmbee/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/transformers/models/cpmbee/test_modeling_cpmbee.py,sha256=uxzfNbGikpwmno2iE3KSVPu369VcHsqouRvzdwNcG4w,8443
 tests/ut/transformers/models/deberta/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/transformers/models/deberta/test_modeling_deberta.py,sha256=mFKfMkt7Ptc0SY3t77UwpF0y8HrPW_3FiZVCSBhhyvQ,12019
 tests/ut/transformers/models/encodec/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
@@ -763,14 +899,16 @@
 tests/ut/transformers/models/gpt_neox/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/transformers/models/gpt_neox/test_gpt_neox.py,sha256=r9YZH80NwCus3yNPxRWKpyR8uhO61nLY8gmGSR4I1Zc,16620
 tests/ut/transformers/models/graphormer/__init__.py,sha256=ayDtxj7vzQvwz3DHSpzZ9XTxA3_06Ib35TBWLTIr_Co,691
 tests/ut/transformers/models/graphormer/test_graphormer_cells.py,sha256=nnNYekGpS76JjWSeM53fTgpbQ1kmRYC59Ice7KDTcQM,6947
 tests/ut/transformers/models/graphormer/test_modeling_graphormer.py,sha256=cNBKMMP2C2csvD5vdveRwTLN7wTynkW221A5Z-i8nVc,65804
 tests/ut/transformers/models/hubert/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/transformers/models/hubert/test_modeling_hubert.py,sha256=NSGOr7pKSD4LzgkvIfgJqv3NrueiQU2eIqsvbGhkiWY,29210
+tests/ut/transformers/models/internlm/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
+tests/ut/transformers/models/internlm/test_modeling_internlm.py,sha256=83if4Eor_TFuyeB9ggR4wcaj6Lp4volyFPW9Kej_dZM,1601
 tests/ut/transformers/models/layoutlm/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/transformers/models/layoutlm/test_modeling_layoutlm.py,sha256=EQGuXCeuXeu5YV-3ddBmlUjNTO6_23aiwN-2H5K3gBY,17742
 tests/ut/transformers/models/layoutlmv2/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/transformers/models/layoutlmv2/test_modeling_layoutlmv2.py,sha256=T73YyoVlZZULRX_Pllo5i8Og0dNF_9K3ZY3Zfc1PJOo,28358
 tests/ut/transformers/models/llama/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/transformers/models/llama/test_modeling_llama.py,sha256=mSLZgKEsVbb3o6xQbYa5VG0CmrHKF4DBdDFLTK1ce8s,27045
 tests/ut/transformers/models/longformer/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
@@ -791,25 +929,31 @@
 tests/ut/transformers/models/mobilebert/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/transformers/models/mobilebert/test_mobilebert.py,sha256=f7Bth7WCncPadgDx8CXeO6zBAHGdm735om0SYbq47yU,12087
 tests/ut/transformers/models/moss/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/transformers/models/moss/test_modeling_moss.py,sha256=foFaNzkB8Xh3s_Hhxmj4Ob4RoqF5G_jHcInAY4d7REk,3681
 tests/ut/transformers/models/mt5/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/transformers/models/mt5/test_modeling_mt5.py,sha256=aCVi8rduOhn-5JzvvSBt0GgyMwn9rwU5CPpRDWMIO6k,2095
 tests/ut/transformers/models/musicgen/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-tests/ut/transformers/models/musicgen/test_modeling_musicgen.py,sha256=FuLeEd--_XvSLOLMwPFpfR24dF7kPXip22X82HU8r-I,45744
+tests/ut/transformers/models/musicgen/test_modeling_musicgen.py,sha256=oFzhHexhOfKXxvwjYD_4aaMmzBTwarEcoGzHIUg3U8M,45746
+tests/ut/transformers/models/musicgen_melody/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
+tests/ut/transformers/models/musicgen_melody/test_feature_extraction_musicgen_melody.py,sha256=wZvtFaECJO36ZW0I9w8uBW4x71AGwrzNgON7eti4w8k,9926
+tests/ut/transformers/models/musicgen_melody/test_modeling_musicgen_melody.py,sha256=QB5yHOOKbNTyuoDVq6X4PICKmjRfLED-Zegsx1vxokc,46150
+tests/ut/transformers/models/musicgen_melody/test_processor_musicgen_melody.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/transformers/models/nezha/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/transformers/models/nezha/test_modeling_nezha.py,sha256=U7UCXu4YOd8RT3iD8k9XvWTN3Hp_wbAsjeoeV9LjnAc,10126
 tests/ut/transformers/models/opt/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
-tests/ut/transformers/models/opt/test_modeling_opt.py,sha256=CeCjrvdb0ucYWte9t2iL3k0YYI7JP9Kopsc7dZIC1rQ,23041
+tests/ut/transformers/models/opt/test_modeling_opt.py,sha256=LO923ROHNf6TeN1OCPsw8V3QeXPbtcPzCETnxom7eyE,23125
 tests/ut/transformers/models/phi/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/transformers/models/phi/test_modeling_phi.py,sha256=eFR-QlBwwtlTB8mFtzVPcKX-Qg4PGSZOV4MXZFl_fVk,18965
 tests/ut/transformers/models/pop2piano/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/transformers/models/pop2piano/test_modeling_pop2piano.py,sha256=EvePTcU7D7Pt4Ee6uVn1JKfIDflE3QsnQDyKvvxs_YI,31317
 tests/ut/transformers/models/qwen2/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/transformers/models/qwen2/test_modeling_qwen2.py,sha256=VdRe5Q3IWydnCzEKOH9YVjTPyniUroTnz6H_Vx-9IUM,19480
+tests/ut/transformers/models/qwen2_moe/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
+tests/ut/transformers/models/qwen2_moe/test_modeling_qwen2_moe.py,sha256=e_eHCDEbyi8MootJfg6eDyng4kzo6qtAqjwJprHn3Bk,22239
 tests/ut/transformers/models/reformer/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/transformers/models/reformer/test_modeling_reformer.py,sha256=XZaA82pb49KWjvtx5dfnb6PpfOTArttEjf5P8BOIWpQ,43606
 tests/ut/transformers/models/roberta/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/transformers/models/roberta/test_modeling_roberta.py,sha256=TR_saviShLNur9UYnkZD5zuRVja5chC8ST7ECYXhE2M,22751
 tests/ut/transformers/models/rwkv/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/transformers/models/rwkv/test_modeling_rwkv.py,sha256=YlaBUd0rdkG85SXlUy6Pc34HqXMaei2dSLzNaqq5_Bc,17034
 tests/ut/transformers/models/seamless_m4t/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
@@ -830,25 +974,29 @@
 tests/ut/transformers/models/whisper/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/transformers/models/whisper/test_modeling_whisper.py,sha256=AcPz5rT1YIqSSCwF_pScW-z9Dph7YHWgKGuHzuMdq8A,77595
 tests/ut/transformers/models/xlm/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/transformers/models/xlm/test_modeling_xlm.py,sha256=Y9GZuTbDjIwi7Kp6on47NtVDBPxbkFcqolAKoROxzLs,19441
 tests/ut/transformers/models/xlm/test_tokenization_xlm.py,sha256=0ono8j4uLPxFXtfSy9EI5ibdELLQbLYF_s7C_1Rmbms,3300
 tests/ut/transformers/models/xlm_roberta/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/transformers/models/xlm_roberta/test_modeling_xlm_roberta.py,sha256=w6aiGWIah3nRr1TtF2VDdcl_hBfyaI0-vPqEhJDmNOw,2827
+tests/ut/transformers/models/xlnet/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
+tests/ut/transformers/models/xlnet/test_modeling_xlnet.py,sha256=n52pQ0ItsYPNYiO1zgbwls-pnN4E58EEQgVKWaCQMuE,28446
+tests/ut/transformers/models/xlnet/test_tokenization_xlnet.py,sha256=3UW4vUoOEiWluXj4Je8Pap4pQskutFOP7uSgfyqWCmc,12729
 tests/ut/transformers/pipelines/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/transformers/pipelines/test_pipelines_common.py,sha256=1Dl8xZEhGqFR0AJ7VITQ-zfFhf6Y6n0fTl23S_sGEWY,18027
-tests/ut/transformers/pipelines/test_pipelines_document_question_answering.py,sha256=7_z9B5M8JBZxx_89rJLMraeK8qzh6sXsdXF1yY_CAWo,12467
+tests/ut/transformers/pipelines/test_pipelines_document_question_answering.py,sha256=EkDtCyLlHJtGp59Af77yDaLkz3iCfz5Z9FIWT4-MVSc,12486
 tests/ut/transformers/pipelines/test_pipelines_question_answering.py,sha256=1yqGSZhgvLYxtT7t1Vu0Xa2FF0UQyk_noT8FNwpfCR4,25446
 tests/ut/transformers/pipelines/test_pipelines_text2text_generation.py,sha256=sMUS8KFuhOFVdcVNCMvARsCiVhmF5oNh6i3UIS7TE84,3661
 tests/ut/transformers/pipelines/test_pipelines_text_classification.py,sha256=-yPz84FUYWnsILGGdM12k6D8-ByGSGMhGqhxsVU9K_0,6805
 tests/ut/transformers/pipelines/test_pipelines_text_generation.py,sha256=1Ag3I_OezzmvjOldhnBVcZfJu9FyeIMtdTndGv3h794,13706
 tests/ut/transformers/pipelines/test_pipelines_zero_shot_classification.py,sha256=aR_vnyb08KzHYLopYJILAUVC_Ge3oVz2N7exSNTj4z0,11105
+tests/ut/utils/test_download.py,sha256=qwgNAeqs_KDBMS6xK4kKNssfLPkTk0G-q9IAZJMStss,1996
 tests/ut/vocab/__init__.py,sha256=47DEQpj8HBSa-_TImW-5JCeuQeRkm5NMpJWZG3hSuFU,0
 tests/ut/vocab/test_vocab.py,sha256=nNUuXh4xwHRSBXUCMcX24hHeuzYDuOB00jlNvvWcJKI,2076
 tests/ut/vocab/test_vocab_fasttext.py,sha256=ofhi_ruA_oGHqyZhJb1iFeFpHqKoAbpGyzeb9jdqfTg,1029
 tests/ut/vocab/test_vocab_glove.py,sha256=03WRCJDPdWcMazhbjJ88WBnlLCoRkuG5Qm5ccrsVICU,1238
-mindnlp-0.2.3.dist-info/LICENSE,sha256=xx0jnfkXJvxRnG63LTGOxlggYnIysveWIZ6H3PNdCrQ,11357
-mindnlp-0.2.3.dist-info/METADATA,sha256=0teuysXszBQB_TzWftDu-5iJiUhRtxThNZq8uMWGYQs,805
-mindnlp-0.2.3.dist-info/NOTICE,sha256=WMUrehXyktO2Y7n7-wX_4ODWQ6v0RNQqYNcpO8tdj-A,57
-mindnlp-0.2.3.dist-info/WHEEL,sha256=GJ7t_kWBFywbagK5eo9IoUwLW6oyOeTKmQ-9iHFVNxQ,92
-mindnlp-0.2.3.dist-info/top_level.txt,sha256=TxwFWW5fBi37a5G0OYTMGr42mW2sYvTk9hcQlhfuzaY,14
-mindnlp-0.2.3.dist-info/RECORD,,
+mindnlp-0.2.4.dist-info/LICENSE,sha256=xx0jnfkXJvxRnG63LTGOxlggYnIysveWIZ6H3PNdCrQ,11357
+mindnlp-0.2.4.dist-info/METADATA,sha256=XCCafZ2zs2ll_HbIxX1sp8GEQcgsttkPyIjZKhFdJlA,804
+mindnlp-0.2.4.dist-info/NOTICE,sha256=WMUrehXyktO2Y7n7-wX_4ODWQ6v0RNQqYNcpO8tdj-A,57
+mindnlp-0.2.4.dist-info/WHEEL,sha256=yQN5g4mg4AybRjkgi-9yy4iQEFibGQmlz78Pik5Or-A,92
+mindnlp-0.2.4.dist-info/top_level.txt,sha256=TxwFWW5fBi37a5G0OYTMGr42mW2sYvTk9hcQlhfuzaY,14
+mindnlp-0.2.4.dist-info/RECORD,,
```

